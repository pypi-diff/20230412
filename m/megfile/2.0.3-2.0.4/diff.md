# Comparing `tmp/megfile-2.0.3-py3-none-any.whl.zip` & `tmp/megfile-2.0.4-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,45 +1,45 @@
-Zip file size: 100567 bytes, number of entries: 43
--rw-rw-r--  2.0 unx     5378 b- defN 23-Mar-20 08:10 megfile/__init__.py
--rw-rw-r--  2.0 unx     9441 b- defN 23-Mar-01 05:34 megfile/cli.py
--rw-rw-r--  2.0 unx    11252 b- defN 23-Feb-17 06:43 megfile/errors.py
--rw-rw-r--  2.0 unx    11621 b- defN 23-Mar-22 03:57 megfile/fs.py
+Zip file size: 103731 bytes, number of entries: 43
+-rw-rw-r--  2.0 unx     5434 b- defN 23-Apr-12 07:41 megfile/__init__.py
+-rw-rw-r--  2.0 unx     9918 b- defN 23-Apr-12 07:41 megfile/cli.py
+-rw-rw-r--  2.0 unx    11584 b- defN 23-Apr-06 05:41 megfile/errors.py
+-rw-rw-r--  2.0 unx    11621 b- defN 23-Apr-12 05:04 megfile/fs.py
 -rw-rw-r--  2.0 unx    37313 b- defN 23-Mar-21 02:38 megfile/fs_path.py
--rw-rw-r--  2.0 unx     1852 b- defN 23-Mar-22 03:57 megfile/http.py
+-rw-rw-r--  2.0 unx     1852 b- defN 23-Apr-12 05:04 megfile/http.py
 -rw-rw-r--  2.0 unx     4483 b- defN 23-Feb-17 06:43 megfile/http_path.py
 -rw-rw-r--  2.0 unx     6181 b- defN 23-Mar-21 02:38 megfile/interfaces.py
 -rw-rw-r--  2.0 unx    28741 b- defN 23-Mar-22 03:51 megfile/pathlike.py
--rw-rw-r--  2.0 unx    12466 b- defN 23-Mar-22 03:57 megfile/s3.py
--rw-rw-r--  2.0 unx    77761 b- defN 23-Mar-22 03:52 megfile/s3_path.py
--rw-rw-r--  2.0 unx    11337 b- defN 23-Mar-22 03:57 megfile/sftp.py
--rw-rw-r--  2.0 unx    38016 b- defN 23-Mar-21 02:38 megfile/sftp_path.py
--rw-rw-r--  2.0 unx    27453 b- defN 23-Mar-22 06:15 megfile/smart.py
--rw-rw-r--  2.0 unx     6546 b- defN 23-Mar-22 03:52 megfile/smart_path.py
--rw-rw-r--  2.0 unx      521 b- defN 23-Mar-22 03:57 megfile/stdio.py
+-rw-rw-r--  2.0 unx    12456 b- defN 23-Apr-12 07:41 megfile/s3.py
+-rw-rw-r--  2.0 unx    84371 b- defN 23-Apr-12 07:41 megfile/s3_path.py
+-rw-rw-r--  2.0 unx    11369 b- defN 23-Apr-12 07:41 megfile/sftp.py
+-rw-rw-r--  2.0 unx    39883 b- defN 23-Apr-12 07:41 megfile/sftp_path.py
+-rw-rw-r--  2.0 unx    30409 b- defN 23-Apr-12 07:41 megfile/smart.py
+-rw-rw-r--  2.0 unx     6613 b- defN 23-Apr-06 05:41 megfile/smart_path.py
+-rw-rw-r--  2.0 unx      521 b- defN 23-Apr-12 05:04 megfile/stdio.py
 -rw-rw-r--  2.0 unx     2634 b- defN 23-Feb-17 06:43 megfile/stdio_path.py
--rw-rw-r--  2.0 unx       19 b- defN 23-Mar-22 06:36 megfile/version.py
+-rw-rw-r--  2.0 unx       19 b- defN 23-Apr-12 07:52 megfile/version.py
 -rw-rw-r--  2.0 unx        0 b- defN 23-Feb-17 06:43 megfile/lib/__init__.py
--rw-rw-r--  2.0 unx     4466 b- defN 23-Mar-22 03:57 megfile/lib/combine_reader.py
+-rw-rw-r--  2.0 unx     4466 b- defN 23-Apr-12 07:31 megfile/lib/combine_reader.py
 -rw-rw-r--  2.0 unx      228 b- defN 23-Feb-17 06:43 megfile/lib/compat.py
 -rw-rw-r--  2.0 unx     4054 b- defN 23-Feb-17 06:43 megfile/lib/fnmatch.py
 -rw-rw-r--  2.0 unx     9478 b- defN 23-Mar-01 05:34 megfile/lib/glob.py
 -rw-rw-r--  2.0 unx      929 b- defN 23-Feb-17 06:43 megfile/lib/joinpath.py
 -rw-rw-r--  2.0 unx     1801 b- defN 23-Feb-17 06:43 megfile/lib/lazy_handler.py
 -rw-rw-r--  2.0 unx     6934 b- defN 23-Feb-17 06:43 megfile/lib/s3_buffered_writer.py
 -rw-rw-r--  2.0 unx     1322 b- defN 23-Feb-17 06:43 megfile/lib/s3_cached_handler.py
 -rw-rw-r--  2.0 unx     6057 b- defN 23-Feb-17 06:43 megfile/lib/s3_limited_seekable_writer.py
 -rw-rw-r--  2.0 unx     3725 b- defN 23-Feb-17 06:43 megfile/lib/s3_memory_handler.py
 -rw-rw-r--  2.0 unx     3404 b- defN 23-Feb-17 06:43 megfile/lib/s3_pipe_handler.py
--rw-rw-r--  2.0 unx    14148 b- defN 23-Mar-03 07:46 megfile/lib/s3_prefetch_reader.py
--rw-rw-r--  2.0 unx     3638 b- defN 23-Mar-22 03:57 megfile/lib/s3_share_cache_reader.py
+-rw-rw-r--  2.0 unx    15053 b- defN 23-Apr-06 05:41 megfile/lib/s3_prefetch_reader.py
+-rw-rw-r--  2.0 unx     3791 b- defN 23-Apr-12 07:31 megfile/lib/s3_share_cache_reader.py
 -rw-rw-r--  2.0 unx     2569 b- defN 23-Feb-17 06:43 megfile/lib/shadow_handler.py
 -rw-rw-r--  2.0 unx     1930 b- defN 23-Feb-17 06:43 megfile/lib/stdio_handler.py
--rw-rw-r--  2.0 unx     9025 b- defN 23-Mar-20 05:14 megfile/utils/__init__.py
+-rw-rw-r--  2.0 unx     9025 b- defN 23-Apr-12 01:49 megfile/utils/__init__.py
 -rw-rw-r--  2.0 unx     2461 b- defN 23-Feb-17 06:43 megfile/utils/mutex.py
--rw-rw-r--  2.0 unx    11357 b- defN 23-Mar-22 06:36 megfile-2.0.3.dist-info/LICENSE
--rw-rw-r--  2.0 unx     1080 b- defN 23-Mar-22 06:36 megfile-2.0.3.dist-info/LICENSE.pyre
--rw-rw-r--  2.0 unx     9017 b- defN 23-Mar-22 06:36 megfile-2.0.3.dist-info/METADATA
--rw-rw-r--  2.0 unx       92 b- defN 23-Mar-22 06:36 megfile-2.0.3.dist-info/WHEEL
--rw-rw-r--  2.0 unx       50 b- defN 23-Mar-22 06:36 megfile-2.0.3.dist-info/entry_points.txt
--rw-rw-r--  2.0 unx        8 b- defN 23-Mar-22 06:36 megfile-2.0.3.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     3447 b- defN 23-Mar-22 06:36 megfile-2.0.3.dist-info/RECORD
-43 files, 394235 bytes uncompressed, 95169 bytes compressed:  75.9%
+-rw-rw-r--  2.0 unx    11357 b- defN 23-Apr-12 07:54 megfile-2.0.4.dist-info/LICENSE
+-rw-rw-r--  2.0 unx     1080 b- defN 23-Apr-12 07:54 megfile-2.0.4.dist-info/LICENSE.pyre
+-rw-rw-r--  2.0 unx    10140 b- defN 23-Apr-12 07:54 megfile-2.0.4.dist-info/METADATA
+-rw-rw-r--  2.0 unx       92 b- defN 23-Apr-12 07:54 megfile-2.0.4.dist-info/WHEEL
+-rw-rw-r--  2.0 unx       50 b- defN 23-Apr-12 07:54 megfile-2.0.4.dist-info/entry_points.txt
+-rw-rw-r--  2.0 unx        8 b- defN 23-Apr-12 07:54 megfile-2.0.4.dist-info/top_level.txt
+?rw-rw-r--  2.0 unx     3448 b- defN 23-Apr-12 07:54 megfile-2.0.4.dist-info/RECORD
+43 files, 408804 bytes uncompressed, 98333 bytes compressed:  75.9%
```

## zipnote {}

```diff
@@ -102,29 +102,29 @@
 
 Filename: megfile/utils/__init__.py
 Comment: 
 
 Filename: megfile/utils/mutex.py
 Comment: 
 
-Filename: megfile-2.0.3.dist-info/LICENSE
+Filename: megfile-2.0.4.dist-info/LICENSE
 Comment: 
 
-Filename: megfile-2.0.3.dist-info/LICENSE.pyre
+Filename: megfile-2.0.4.dist-info/LICENSE.pyre
 Comment: 
 
-Filename: megfile-2.0.3.dist-info/METADATA
+Filename: megfile-2.0.4.dist-info/METADATA
 Comment: 
 
-Filename: megfile-2.0.3.dist-info/WHEEL
+Filename: megfile-2.0.4.dist-info/WHEEL
 Comment: 
 
-Filename: megfile-2.0.3.dist-info/entry_points.txt
+Filename: megfile-2.0.4.dist-info/entry_points.txt
 Comment: 
 
-Filename: megfile-2.0.3.dist-info/top_level.txt
+Filename: megfile-2.0.4.dist-info/top_level.txt
 Comment: 
 
-Filename: megfile-2.0.3.dist-info/RECORD
+Filename: megfile-2.0.4.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## megfile/__init__.py

```diff
@@ -1,15 +1,15 @@
 from megfile.fs import fs_abspath, fs_access, fs_cwd, fs_exists, fs_expanduser, fs_getmd5, fs_getmtime, fs_getsize, fs_glob, fs_glob_stat, fs_home, fs_iglob, fs_isabs, fs_isdir, fs_isfile, fs_islink, fs_ismount, fs_listdir, fs_load_from, fs_lstat, fs_makedirs, fs_move, fs_readlink, fs_realpath, fs_relpath, fs_remove, fs_rename, fs_resolve, fs_save_as, fs_scan, fs_scan_stat, fs_scandir, fs_stat, fs_symlink, fs_sync, fs_unlink, fs_walk, is_fs
 from megfile.fs_path import FSPath
 from megfile.http_path import HttpPath, HttpsPath
-from megfile.s3 import is_s3, s3_access, s3_buffered_open, s3_cached_open, s3_copy, s3_download, s3_exists, s3_getmd5, s3_getmtime, s3_getsize, s3_glob, s3_glob_stat, s3_hasbucket, s3_iglob, s3_isdir, s3_isfile, s3_legacy_open, s3_listdir, s3_load_content, s3_load_from, s3_lstat, s3_makedirs, s3_memory_open, s3_move, s3_open, s3_path_join, s3_pipe_open, s3_prefetch_open, s3_readlink, s3_remove, s3_rename, s3_save_as, s3_scan, s3_scan_stat, s3_scandir, s3_stat, s3_symlink, s3_sync, s3_unlink, s3_upload, s3_walk
+from megfile.s3 import is_s3, s3_access, s3_buffered_open, s3_cached_open, s3_concat, s3_copy, s3_download, s3_exists, s3_getmd5, s3_getmtime, s3_getsize, s3_glob, s3_glob_stat, s3_hasbucket, s3_iglob, s3_isdir, s3_isfile, s3_listdir, s3_load_content, s3_load_from, s3_lstat, s3_makedirs, s3_memory_open, s3_move, s3_open, s3_path_join, s3_pipe_open, s3_prefetch_open, s3_readlink, s3_remove, s3_rename, s3_save_as, s3_scan, s3_scan_stat, s3_scandir, s3_stat, s3_symlink, s3_sync, s3_unlink, s3_upload, s3_walk
 from megfile.s3_path import S3Path
-from megfile.sftp import is_sftp, sftp_absolute, sftp_chmod, sftp_copy, sftp_exists, sftp_getmd5, sftp_getmtime, sftp_getsize, sftp_glob, sftp_glob_stat, sftp_iglob, sftp_isdir, sftp_isfile, sftp_islink, sftp_listdir, sftp_load_from, sftp_lstat, sftp_makedirs, sftp_move, sftp_open, sftp_path_join, sftp_readlink, sftp_realpath, sftp_remove, sftp_rename, sftp_resolve, sftp_rmdir, sftp_save_as, sftp_scan, sftp_scan_stat, sftp_scandir, sftp_stat, sftp_symlink, sftp_sync, sftp_unlink, sftp_walk
+from megfile.sftp import is_sftp, sftp_absolute, sftp_chmod, sftp_concat, sftp_copy, sftp_exists, sftp_getmd5, sftp_getmtime, sftp_getsize, sftp_glob, sftp_glob_stat, sftp_iglob, sftp_isdir, sftp_isfile, sftp_islink, sftp_listdir, sftp_load_from, sftp_lstat, sftp_makedirs, sftp_move, sftp_open, sftp_path_join, sftp_readlink, sftp_realpath, sftp_remove, sftp_rename, sftp_resolve, sftp_rmdir, sftp_save_as, sftp_scan, sftp_scan_stat, sftp_scandir, sftp_stat, sftp_symlink, sftp_sync, sftp_unlink, sftp_walk
 from megfile.sftp_path import SftpPath
-from megfile.smart import smart_access, smart_cache, smart_combine_open, smart_copy, smart_exists, smart_getmd5, smart_getmtime, smart_getsize, smart_glob, smart_glob_stat, smart_iglob, smart_isdir, smart_isfile, smart_islink, smart_listdir, smart_load_content, smart_load_from, smart_load_text, smart_lstat, smart_makedirs, smart_move, smart_open, smart_path_join, smart_readlink, smart_realpath, smart_remove, smart_rename, smart_save_as, smart_save_content, smart_save_text, smart_scan, smart_scan_stat, smart_scandir, smart_stat, smart_symlink, smart_sync, smart_touch, smart_unlink, smart_walk
+from megfile.smart import smart_access, smart_cache, smart_combine_open, smart_concat, smart_copy, smart_exists, smart_getmd5, smart_getmtime, smart_getsize, smart_glob, smart_glob_stat, smart_iglob, smart_isdir, smart_isfile, smart_islink, smart_listdir, smart_load_content, smart_load_from, smart_load_text, smart_lstat, smart_makedirs, smart_move, smart_open, smart_path_join, smart_readlink, smart_realpath, smart_remove, smart_rename, smart_save_as, smart_save_content, smart_save_text, smart_scan, smart_scan_stat, smart_scandir, smart_stat, smart_symlink, smart_sync, smart_touch, smart_unlink, smart_walk
 from megfile.smart_path import SmartPath
 from megfile.stdio_path import StdioPath
 from megfile.version import VERSION as __version__
 
 __all__ = [
     'is_fs',
     'is_s3',
@@ -49,14 +49,15 @@
     'smart_unlink',
     'smart_walk',
     'smart_cache',
     'smart_getmd5',
     'smart_symlink',
     'smart_readlink',
     'smart_lstat',
+    'smart_concat',
     's3_access',
     's3_buffered_open',
     's3_cached_open',
     's3_copy',
     's3_download',
     's3_exists',
     's3_getmd5',
@@ -64,15 +65,14 @@
     's3_getsize',
     's3_glob_stat',
     's3_glob',
     's3_hasbucket',
     's3_iglob',
     's3_isdir',
     's3_isfile',
-    's3_legacy_open',
     's3_listdir',
     's3_load_content',
     's3_load_from',
     's3_makedirs',
     's3_memory_open',
     's3_open',
     's3_path_join',
@@ -89,14 +89,15 @@
     's3_stat',
     's3_lstat',
     's3_unlink',
     's3_upload',
     's3_walk',
     's3_symlink',
     's3_readlink',
+    's3_concat',
     'fs_abspath',
     'fs_access',
     'fs_exists',
     'fs_getmtime',
     'fs_getsize',
     'fs_glob_stat',
     'fs_glob',
@@ -162,14 +163,15 @@
     'sftp_islink',
     'sftp_save_as',
     'sftp_open',
     'sftp_chmod',
     'sftp_rmdir',
     'sftp_copy',
     'sftp_sync',
+    'sftp_concat',
     'S3Path',
     'FSPath',
     'HttpPath',
     'HttpsPath',
     'StdioPath',
     'SmartPath',
     'SftpPath',
```

## megfile/cli.py

```diff
@@ -1,11 +1,12 @@
 import os
 import shutil
 import sys
 import time
+from concurrent.futures import ThreadPoolExecutor
 
 import click
 from tqdm import tqdm
 
 from megfile.interfaces import FileEntry
 from megfile.lib.glob import get_non_glob_dir, has_magic
 from megfile.smart import smart_copy, smart_getmd5, smart_getmtime, smart_getsize, smart_glob, smart_glob_stat, smart_isdir, smart_isfile, smart_makedirs, smart_move, smart_open, smart_path_join, smart_remove, smart_rename, smart_scan_stat, smart_scandir, smart_stat, smart_sync, smart_sync_with_progress, smart_touch, smart_unlink
@@ -117,18 +118,22 @@
         recursive: bool,
         no_target_directory: bool,
         progress_bar: bool,
 ):
     if smart_isdir(dst_path) and not no_target_directory:
         dst_path = smart_path_join(dst_path, os.path.basename(src_path))
     if recursive:
-        if progress_bar:
-            smart_sync_with_progress(src_path, dst_path, followlinks=True)
-        else:
-            smart_sync(src_path, dst_path, followlinks=True)
+        with ThreadPoolExecutor(max_workers=(os.cpu_count() or 1) *
+                                2) as executor:
+            if progress_bar:
+                smart_sync_with_progress(
+                    src_path, dst_path, followlinks=True, map_func=executor.map)
+            else:
+                smart_sync(
+                    src_path, dst_path, followlinks=True, map_func=executor.map)
     else:
         if progress_bar:
             file_size = smart_stat(src_path).size
             sbar = tqdm(total=file_size, unit='B', ascii=True, unit_scale=True)
 
             def callback(length: int):
                 sbar.update(length)
@@ -213,51 +218,56 @@
 
 @cli.command(
     short_help='Make source and dest identical, modifying destination only.')
 @click.argument('src_path')
 @click.argument('dst_path')
 @click.option('-g', '--progress-bar', is_flag=True, help='Show progress bar.')
 def sync(src_path: str, dst_path: str, progress_bar: bool):
-    if has_magic(src_path):
-        root_dir = get_non_glob_dir(src_path)
+    with ThreadPoolExecutor(max_workers=(os.cpu_count() or 1) * 2) as executor:
+        if has_magic(src_path):
+            root_dir = get_non_glob_dir(src_path)
+            path_stats = []
+            for dir_or_file in smart_glob(src_path, recursive=True,
+                                          missing_ok=True):
+                path_stats.extend(list(smart_scan_stat(dir_or_file)))
+
+            if progress_bar:
+                tbar = tqdm(total=len(path_stats), ascii=True)
+                sbar = tqdm(unit='B', ascii=True, unit_scale=True)
 
-        def sync_magic_path(src_file_path, callback=None):
-            content_path = os.path.relpath(src_file_path, start=root_dir)
-            dst_abs_file_path = smart_path_join(
-                dst_path, content_path.lstrip('/'))
-            smart_sync(
-                src_file_path,
-                dst_abs_file_path,
-                callback=callback,
-                followlinks=True)
+                def callback(_filename: str, length: int):
+                    sbar.update(length)
 
-        if progress_bar:
-            glob_paths = list(
-                smart_glob(src_path, recursive=True, missing_ok=True))
-            tbar = tqdm(total=len(glob_paths), ascii=True)
-            sbar = tqdm(unit='B', ascii=True, unit_scale=True)
+                def callback_after_copy_file(src_file_path, dst_file_path):
+                    tbar.update(1)
 
-            def callback(_filename: str, length: int):
-                sbar.update(length)
+                smart_sync(
+                    root_dir,
+                    dst_path,
+                    callback=callback,
+                    callback_after_copy_file=callback_after_copy_file,
+                    src_file_stats=path_stats,
+                    map_func=executor.map,
+                )
 
-            for src_file_path in glob_paths:
-                sync_magic_path(src_file_path, callback=callback)
-                tbar.update(1)
-            tbar.close()
-            sbar.close()
-        else:  # pragma: no cover
-            for src_file_path in smart_glob(src_path, recursive=True,
-                                            missing_ok=True):
-                sync_magic_path(src_file_path)
-
-    else:
-        if progress_bar:
-            smart_sync_with_progress(src_path, dst_path, followlinks=True)
+                tbar.close()
+                sbar.close()
+            else:  # pragma: no cover
+                smart_sync(
+                    root_dir,
+                    dst_path,
+                    src_file_stats=path_stats,
+                    map_func=executor.map,
+                )
         else:
-            smart_sync(src_path, dst_path, followlinks=True)
+            if progress_bar:
+                smart_sync_with_progress(src_path, dst_path, followlinks=True)
+            else:
+                smart_sync(
+                    src_path, dst_path, followlinks=True, map_func=executor.map)
 
 
 @cli.command(short_help="Make the path if it doesn't already exist.")
 @click.argument('path')
 def mkdir(path: str):
     smart_makedirs(path)
```

## megfile/errors.py

```diff
@@ -248,14 +248,18 @@
     pass
 
 
 class S3NameTooLongError(S3FileNotFoundError, PermissionError):
     pass
 
 
+class S3InvalidRangeError(S3Exception):
+    pass
+
+
 class S3UnknownError(S3Exception, UnknownError):
 
     def __init__(self, error: Exception, path: PathLike):
         super().__init__(error, path, 'endpoint: %r' % s3_endpoint_url())
 
 
 class HttpException(Exception):
@@ -311,14 +315,20 @@
                 'Permission denied: %r, code: %r, message: %r, endpoint: %r' %
                 (s3_url, code, message, s3_endpoint_url()))
         if code in ('InvalidAccessKeyId', 'SignatureDoesNotMatch'):
             message = client_error_message(s3_error)
             return S3ConfigError(
                 'Invalid configuration: %r, code: %r, message: %r, endpoint: %r'
                 % (s3_url, code, message, s3_endpoint_url()))
+        if code in ('InvalidRange'):
+            return S3InvalidRangeError(
+                'Index out of range: %r, code: %r, message: %r, endpoint: %r' %
+                (
+                    s3_url, code, client_error_message(s3_error),
+                    s3_endpoint_url()))
         return S3UnknownError(s3_error, s3_url)
     elif isinstance(s3_error, ParamValidationError):
         report = param_validation_error_report(s3_error)
         if 'Invalid bucket name' in report:
             return S3BucketNotFoundError('Invalid bucket name: %r' % s3_url)
         if 'Invalid length for parameter Key' in report:
             return S3FileNotFoundError(
```

## megfile/s3.py

```diff
@@ -1,23 +1,22 @@
 from typing import BinaryIO, Callable, Iterator, List, Optional, Tuple
 
 from megfile.interfaces import Access, FileEntry, PathLike, StatResult
-from megfile.s3_path import S3BufferedWriter, S3Cacher, S3LimitedSeekableWriter, S3Path, S3PrefetchReader, S3ShareCacheReader, get_endpoint_url, get_s3_client, get_s3_session, is_s3, parse_s3_url, s3_buffered_open, s3_cached_open, s3_download, s3_glob, s3_glob_stat, s3_iglob, s3_legacy_open, s3_load_content, s3_makedirs, s3_memory_open, s3_open, s3_path_join, s3_pipe_open, s3_prefetch_open, s3_readlink, s3_rename, s3_share_cache_open, s3_upload
+from megfile.s3_path import S3BufferedWriter, S3Cacher, S3LimitedSeekableWriter, S3Path, S3PrefetchReader, S3ShareCacheReader, get_endpoint_url, get_s3_client, get_s3_session, is_s3, parse_s3_url, s3_buffered_open, s3_cached_open, s3_concat, s3_download, s3_glob, s3_glob_stat, s3_iglob, s3_load_content, s3_makedirs, s3_memory_open, s3_open, s3_path_join, s3_pipe_open, s3_prefetch_open, s3_readlink, s3_rename, s3_share_cache_open, s3_upload
 
 __all__ = [
     'parse_s3_url',
     'get_endpoint_url',
     'get_s3_session',
     'get_s3_client',
     's3_path_join',
     'is_s3',
     's3_buffered_open',
     's3_cached_open',
     's3_download',
-    's3_legacy_open',
     's3_memory_open',
     's3_pipe_open',
     's3_prefetch_open',
     's3_share_cache_open',
     's3_open',
     'S3Cacher',
     'S3BufferedWriter',
@@ -29,14 +28,15 @@
     's3_load_content',
     's3_readlink',
     's3_glob',
     's3_glob_stat',
     's3_iglob',
     's3_rename',
     's3_makedirs',
+    's3_concat',
     's3_access',
     's3_exists',
     's3_getmtime',
     's3_getsize',
     's3_isdir',
     's3_isfile',
     's3_listdir',
```

## megfile/s3_path.py

```diff
@@ -1,4861 +1,5274 @@
 00000000: 696d 706f 7274 2068 6173 686c 6962 0a69  import hashlib.i
-00000010: 6d70 6f72 7420 696e 7370 6563 740a 696d  mport inspect.im
-00000020: 706f 7274 2069 6f0a 696d 706f 7274 206f  port io.import o
-00000030: 730a 696d 706f 7274 2072 650a 696d 706f  s.import re.impo
-00000040: 7274 2074 696d 650a 6672 6f6d 2066 756e  rt time.from fun
-00000050: 6374 6f6f 6c73 2069 6d70 6f72 7420 6c72  ctools import lr
-00000060: 755f 6361 6368 652c 2077 7261 7073 0a66  u_cache, wraps.f
-00000070: 726f 6d20 6c6f 6767 696e 6720 696d 706f  rom logging impo
-00000080: 7274 2067 6574 4c6f 6767 6572 2061 7320  rt getLogger as 
-00000090: 6765 745f 6c6f 6767 6572 0a66 726f 6d20  get_logger.from 
-000000a0: 7479 7069 6e67 2069 6d70 6f72 7420 494f  typing import IO
-000000b0: 2c20 416e 792c 2041 6e79 5374 722c 2042  , Any, AnyStr, B
-000000c0: 696e 6172 7949 4f2c 2043 616c 6c61 626c  inaryIO, Callabl
-000000d0: 652c 2044 6963 742c 2049 7465 7261 746f  e, Dict, Iterato
-000000e0: 722c 204c 6973 742c 204f 7074 696f 6e61  r, List, Optiona
-000000f0: 6c2c 2054 7570 6c65 2c20 556e 696f 6e0a  l, Tuple, Union.
-00000100: 6672 6f6d 2075 726c 6c69 622e 7061 7273  from urllib.pars
-00000110: 6520 696d 706f 7274 2075 726c 7370 6c69  e import urlspli
-00000120: 740a 0a69 6d70 6f72 7420 626f 746f 330a  t..import boto3.
-00000130: 696d 706f 7274 2062 6f74 6f63 6f72 650a  import botocore.
-00000140: 696d 706f 7274 2073 6d61 7274 5f6f 7065  import smart_ope
-00000150: 6e2e 7333 0a66 726f 6d20 626f 746f 636f  n.s3.from botoco
-00000160: 7265 2e61 7773 7265 7175 6573 7420 696d  re.awsrequest im
-00000170: 706f 7274 2041 5753 5265 7370 6f6e 7365  port AWSResponse
-00000180: 0a0a 6672 6f6d 206d 6567 6669 6c65 2e65  ..from megfile.e
-00000190: 7272 6f72 7320 696d 706f 7274 2053 3342  rrors import S3B
-000001a0: 7563 6b65 744e 6f74 466f 756e 6445 7272  ucketNotFoundErr
-000001b0: 6f72 2c20 5333 436f 6e66 6967 4572 726f  or, S3ConfigErro
-000001c0: 722c 2053 3346 696c 6545 7869 7374 7345  r, S3FileExistsE
-000001d0: 7272 6f72 2c20 5333 4669 6c65 4e6f 7446  rror, S3FileNotF
-000001e0: 6f75 6e64 4572 726f 722c 2053 3349 7341  oundError, S3IsA
-000001f0: 4469 7265 6374 6f72 7945 7272 6f72 2c20  DirectoryError, 
-00000200: 5333 4e61 6d65 546f 6f4c 6f6e 6745 7272  S3NameTooLongErr
-00000210: 6f72 2c20 5333 4e6f 7441 4469 7265 6374  or, S3NotADirect
-00000220: 6f72 7945 7272 6f72 2c20 5333 4e6f 7441  oryError, S3NotA
-00000230: 4c69 6e6b 4572 726f 722c 2053 3350 6572  LinkError, S3Per
-00000240: 6d69 7373 696f 6e45 7272 6f72 2c20 5333  missionError, S3
-00000250: 556e 6b6e 6f77 6e45 7272 6f72 2c20 556e  UnknownError, Un
-00000260: 7375 7070 6f72 7465 6445 7272 6f72 2c20  supportedError, 
-00000270: 5f63 7265 6174 655f 6d69 7373 696e 675f  _create_missing_
-00000280: 6f6b 5f67 656e 6572 6174 6f72 0a66 726f  ok_generator.fro
-00000290: 6d20 6d65 6766 696c 652e 6572 726f 7273  m megfile.errors
-000002a0: 2069 6d70 6f72 7420 5f6c 6f67 6765 7220   import _logger 
-000002b0: 6173 2065 7272 6f72 5f6c 6f67 6765 720a  as error_logger.
-000002c0: 6672 6f6d 206d 6567 6669 6c65 2e65 7272  from megfile.err
-000002d0: 6f72 7320 696d 706f 7274 2070 6174 6368  ors import patch
-000002e0: 5f6d 6574 686f 642c 2072 6169 7365 5f73  _method, raise_s
-000002f0: 335f 6572 726f 722c 2073 335f 6572 726f  3_error, s3_erro
-00000300: 725f 636f 6465 5f73 686f 756c 645f 7265  r_code_should_re
-00000310: 7472 792c 2073 335f 7368 6f75 6c64 5f72  try, s3_should_r
-00000320: 6574 7279 2c20 7472 616e 736c 6174 655f  etry, translate_
-00000330: 6673 5f65 7272 6f72 2c20 7472 616e 736c  fs_error, transl
-00000340: 6174 655f 7333 5f65 7272 6f72 0a66 726f  ate_s3_error.fro
-00000350: 6d20 6d65 6766 696c 652e 696e 7465 7266  m megfile.interf
-00000360: 6163 6573 2069 6d70 6f72 7420 4163 6365  aces import Acce
-00000370: 7373 2c20 436f 6e74 6578 7449 7465 7261  ss, ContextItera
-00000380: 746f 722c 2046 696c 6543 6163 6865 722c  tor, FileCacher,
-00000390: 2046 696c 6545 6e74 7279 2c20 5061 7468   FileEntry, Path
-000003a0: 4c69 6b65 2c20 5374 6174 5265 7375 6c74  Like, StatResult
-000003b0: 2c20 5552 4950 6174 680a 6672 6f6d 206d  , URIPath.from m
-000003c0: 6567 6669 6c65 2e6c 6962 2e63 6f6d 7061  egfile.lib.compa
-000003d0: 7420 696d 706f 7274 2066 7370 6174 680a  t import fspath.
-000003e0: 6672 6f6d 206d 6567 6669 6c65 2e6c 6962  from megfile.lib
-000003f0: 2e66 6e6d 6174 6368 2069 6d70 6f72 7420  .fnmatch import 
-00000400: 7472 616e 736c 6174 650a 6672 6f6d 206d  translate.from m
-00000410: 6567 6669 6c65 2e6c 6962 2e67 6c6f 6220  egfile.lib.glob 
-00000420: 696d 706f 7274 2068 6173 5f6d 6167 6963  import has_magic
-00000430: 2c20 6861 735f 6d61 6769 635f 6967 6e6f  , has_magic_igno
-00000440: 7265 5f62 7261 6365 2c20 756e 676c 6f62  re_brace, unglob
-00000450: 6c69 7a65 0a66 726f 6d20 6d65 6766 696c  lize.from megfil
-00000460: 652e 6c69 622e 6a6f 696e 7061 7468 2069  e.lib.joinpath i
-00000470: 6d70 6f72 7420 7572 695f 6a6f 696e 0a66  mport uri_join.f
-00000480: 726f 6d20 6d65 6766 696c 652e 6c69 622e  rom megfile.lib.
-00000490: 7333 5f62 7566 6665 7265 645f 7772 6974  s3_buffered_writ
-000004a0: 6572 2069 6d70 6f72 7420 4445 4641 554c  er import DEFAUL
-000004b0: 545f 4d41 585f 4255 4646 4552 5f53 495a  T_MAX_BUFFER_SIZ
-000004c0: 452c 2053 3342 7566 6665 7265 6457 7269  E, S3BufferedWri
-000004d0: 7465 720a 6672 6f6d 206d 6567 6669 6c65  ter.from megfile
-000004e0: 2e6c 6962 2e73 335f 6361 6368 6564 5f68  .lib.s3_cached_h
-000004f0: 616e 646c 6572 2069 6d70 6f72 7420 5333  andler import S3
-00000500: 4361 6368 6564 4861 6e64 6c65 720a 6672  CachedHandler.fr
-00000510: 6f6d 206d 6567 6669 6c65 2e6c 6962 2e73  om megfile.lib.s
-00000520: 335f 6c69 6d69 7465 645f 7365 656b 6162  3_limited_seekab
-00000530: 6c65 5f77 7269 7465 7220 696d 706f 7274  le_writer import
-00000540: 2053 334c 696d 6974 6564 5365 656b 6162   S3LimitedSeekab
-00000550: 6c65 5772 6974 6572 0a66 726f 6d20 6d65  leWriter.from me
-00000560: 6766 696c 652e 6c69 622e 7333 5f6d 656d  gfile.lib.s3_mem
-00000570: 6f72 795f 6861 6e64 6c65 7220 696d 706f  ory_handler impo
-00000580: 7274 2053 334d 656d 6f72 7948 616e 646c  rt S3MemoryHandl
-00000590: 6572 0a66 726f 6d20 6d65 6766 696c 652e  er.from megfile.
-000005a0: 6c69 622e 7333 5f70 6970 655f 6861 6e64  lib.s3_pipe_hand
-000005b0: 6c65 7220 696d 706f 7274 2053 3350 6970  ler import S3Pip
-000005c0: 6548 616e 646c 6572 0a66 726f 6d20 6d65  eHandler.from me
-000005d0: 6766 696c 652e 6c69 622e 7333 5f70 7265  gfile.lib.s3_pre
-000005e0: 6665 7463 685f 7265 6164 6572 2069 6d70  fetch_reader imp
-000005f0: 6f72 7420 4445 4641 554c 545f 424c 4f43  ort DEFAULT_BLOC
-00000600: 4b5f 5349 5a45 2c20 5333 5072 6566 6574  K_SIZE, S3Prefet
-00000610: 6368 5265 6164 6572 0a66 726f 6d20 6d65  chReader.from me
-00000620: 6766 696c 652e 6c69 622e 7333 5f73 6861  gfile.lib.s3_sha
-00000630: 7265 5f63 6163 6865 5f72 6561 6465 7220  re_cache_reader 
-00000640: 696d 706f 7274 2053 3353 6861 7265 4361  import S3ShareCa
-00000650: 6368 6552 6561 6465 720a 6672 6f6d 206d  cheReader.from m
-00000660: 6567 6669 6c65 2e73 6d61 7274 5f70 6174  egfile.smart_pat
-00000670: 6820 696d 706f 7274 2053 6d61 7274 5061  h import SmartPa
-00000680: 7468 0a66 726f 6d20 6d65 6766 696c 652e  th.from megfile.
-00000690: 7574 696c 7320 696d 706f 7274 2063 616c  utils import cal
-000006a0: 6375 6c61 7465 5f6d 6435 2c20 6765 6e65  culate_md5, gene
-000006b0: 7261 7465 5f63 6163 6865 5f70 6174 682c  rate_cache_path,
-000006c0: 2067 6574 5f62 696e 6172 795f 6d6f 6465   get_binary_mode
-000006d0: 2c20 6973 5f72 6561 6461 626c 652c 206e  , is_readable, n
-000006e0: 6563 6573 7361 7279 5f70 6172 616d 732c  ecessary_params,
-000006f0: 2074 6872 6561 645f 6c6f 6361 6c0a 0a5f   thread_local.._
-00000700: 5f61 6c6c 5f5f 203d 205b 0a20 2020 2027  _all__ = [.    '
-00000710: 5333 5061 7468 272c 0a20 2020 2027 7061  S3Path',.    'pa
-00000720: 7273 655f 7333 5f75 726c 272c 0a20 2020  rse_s3_url',.   
-00000730: 2027 6765 745f 656e 6470 6f69 6e74 5f75   'get_endpoint_u
-00000740: 726c 272c 0a20 2020 2027 6765 745f 7333  rl',.    'get_s3
-00000750: 5f73 6573 7369 6f6e 272c 0a20 2020 2027  _session',.    '
-00000760: 6765 745f 7333 5f63 6c69 656e 7427 2c0a  get_s3_client',.
-00000770: 2020 2020 2773 335f 7061 7468 5f6a 6f69      's3_path_joi
-00000780: 6e27 2c0a 2020 2020 2769 735f 7333 272c  n',.    'is_s3',
-00000790: 0a20 2020 2027 7333 5f62 7566 6665 7265  .    's3_buffere
-000007a0: 645f 6f70 656e 272c 0a20 2020 2027 7333  d_open',.    's3
-000007b0: 5f63 6163 6865 645f 6f70 656e 272c 0a20  _cached_open',. 
-000007c0: 2020 2027 7333 5f64 6f77 6e6c 6f61 6427     's3_download'
-000007d0: 2c0a 2020 2020 2773 335f 6c65 6761 6379  ,.    's3_legacy
-000007e0: 5f6f 7065 6e27 2c0a 2020 2020 2773 335f  _open',.    's3_
-000007f0: 6d65 6d6f 7279 5f6f 7065 6e27 2c0a 2020  memory_open',.  
-00000800: 2020 2773 335f 7069 7065 5f6f 7065 6e27    's3_pipe_open'
-00000810: 2c0a 2020 2020 2773 335f 7072 6566 6574  ,.    's3_prefet
-00000820: 6368 5f6f 7065 6e27 2c0a 2020 2020 2773  ch_open',.    's
-00000830: 335f 7368 6172 655f 6361 6368 655f 6f70  3_share_cache_op
-00000840: 656e 272c 0a20 2020 2027 7333 5f6f 7065  en',.    's3_ope
-00000850: 6e27 2c0a 2020 2020 2753 3343 6163 6865  n',.    'S3Cache
-00000860: 7227 2c0a 2020 2020 2753 3342 7566 6665  r',.    'S3Buffe
-00000870: 7265 6457 7269 7465 7227 2c0a 2020 2020  redWriter',.    
-00000880: 2753 334c 696d 6974 6564 5365 656b 6162  'S3LimitedSeekab
-00000890: 6c65 5772 6974 6572 272c 0a20 2020 2027  leWriter',.    '
-000008a0: 5333 5072 6566 6574 6368 5265 6164 6572  S3PrefetchReader
-000008b0: 272c 0a20 2020 2027 5333 5368 6172 6543  ',.    'S3ShareC
-000008c0: 6163 6865 5265 6164 6572 272c 0a20 2020  acheReader',.   
-000008d0: 2027 7333 5f75 706c 6f61 6427 2c0a 2020   's3_upload',.  
-000008e0: 2020 2773 335f 646f 776e 6c6f 6164 272c    's3_download',
-000008f0: 0a20 2020 2027 7333 5f6c 6f61 645f 636f  .    's3_load_co
-00000900: 6e74 656e 7427 2c0a 2020 2020 2773 335f  ntent',.    's3_
-00000910: 7265 6164 6c69 6e6b 272c 0a20 2020 2027  readlink',.    '
-00000920: 7333 5f67 6c6f 6227 2c0a 2020 2020 2773  s3_glob',.    's
-00000930: 335f 676c 6f62 5f73 7461 7427 2c0a 2020  3_glob_stat',.  
-00000940: 2020 2773 335f 6967 6c6f 6227 2c0a 2020    's3_iglob',.  
-00000950: 2020 2773 335f 7265 6e61 6d65 272c 0a20    's3_rename',. 
-00000960: 2020 2027 7333 5f6d 616b 6564 6972 7327     's3_makedirs'
-00000970: 2c0a 5d0a 5f6c 6f67 6765 7220 3d20 6765  ,.]._logger = ge
-00000980: 745f 6c6f 6767 6572 285f 5f6e 616d 655f  t_logger(__name_
-00000990: 5f29 0a63 6f6e 7465 6e74 5f6d 6435 5f68  _).content_md5_h
-000009a0: 6561 6465 7220 3d20 276d 6567 6669 6c65  eader = 'megfile
-000009b0: 2d63 6f6e 7465 6e74 2d6d 6435 270a 656e  -content-md5'.en
-000009c0: 6470 6f69 6e74 5f75 726c 203d 2027 6874  dpoint_url = 'ht
-000009d0: 7470 733a 2f2f 7333 2e61 6d61 7a6f 6e61  tps://s3.amazona
-000009e0: 7773 2e63 6f6d 270a 6d61 785f 706f 6f6c  ws.com'.max_pool
-000009f0: 5f63 6f6e 6e65 6374 696f 6e73 203d 2033  _connections = 3
-00000a00: 320a 6d61 785f 7265 7472 6965 7320 3d20  2.max_retries = 
-00000a10: 3130 0a6d 6178 5f6b 6579 7320 3d20 3130  10.max_keys = 10
-00000a20: 3030 0a0a 2320 4d6f 6e6b 6579 2070 6174  00..# Monkey pat
-00000a30: 6368 2066 6f72 2073 6d61 7274 5f6f 7065  ch for smart_ope
-00000a40: 6e0a 5f73 6d61 7274 5f6f 7065 6e5f 7061  n._smart_open_pa
-00000a50: 7261 6d65 7465 7273 203d 2069 6e73 7065  rameters = inspe
-00000a60: 6374 2e73 6967 6e61 7475 7265 2873 6d61  ct.signature(sma
-00000a70: 7274 5f6f 7065 6e2e 7333 2e6f 7065 6e29  rt_open.s3.open)
-00000a80: 2e70 6172 616d 6574 6572 730a 6966 2027  .parameters.if '
-00000a90: 7265 736f 7572 6365 5f6b 7761 7267 7327  resource_kwargs'
-00000aa0: 2069 6e20 5f73 6d61 7274 5f6f 7065 6e5f   in _smart_open_
-00000ab0: 7061 7261 6d65 7465 7273 3a0a 2020 2020  parameters:.    
-00000ac0: 2320 736d 6172 745f 6f70 656e 203e 3d20  # smart_open >= 
-00000ad0: 312e 382e 310a 2020 2020 6465 6620 5f73  1.8.1.    def _s
-00000ae0: 335f 6f70 656e 2862 7563 6b65 743a 2073  3_open(bucket: s
-00000af0: 7472 2c20 6b65 793a 2073 7472 2c20 6d6f  tr, key: str, mo
-00000b00: 6465 3a20 7374 7229 3a20 2023 2070 7261  de: str):  # pra
-00000b10: 676d 613a 206e 6f20 636f 7665 720a 2020  gma: no cover.  
-00000b20: 2020 2020 2020 7265 7475 726e 2073 6d61        return sma
-00000b30: 7274 5f6f 7065 6e2e 7333 2e6f 7065 6e28  rt_open.s3.open(
-00000b40: 0a20 2020 2020 2020 2020 2020 2062 7563  .            buc
-00000b50: 6b65 742c 0a20 2020 2020 2020 2020 2020  ket,.           
-00000b60: 206b 6579 2c0a 2020 2020 2020 2020 2020   key,.          
-00000b70: 2020 6d6f 6465 2c0a 2020 2020 2020 2020    mode,.        
-00000b80: 2020 2020 7365 7373 696f 6e3d 6765 745f      session=get_
-00000b90: 7333 5f73 6573 7369 6f6e 2829 2c0a 2020  s3_session(),.  
-00000ba0: 2020 2020 2020 2020 2020 7265 736f 7572            resour
-00000bb0: 6365 5f6b 7761 7267 733d 7b27 656e 6470  ce_kwargs={'endp
-00000bc0: 6f69 6e74 5f75 726c 273a 2067 6574 5f65  oint_url': get_e
-00000bd0: 6e64 706f 696e 745f 7572 6c28 297d 290a  ndpoint_url()}).
-00000be0: 0a65 6c69 6620 2763 6c69 656e 7427 2069  .elif 'client' i
-00000bf0: 6e20 5f73 6d61 7274 5f6f 7065 6e5f 7061  n _smart_open_pa
-00000c00: 7261 6d65 7465 7273 3a0a 2020 2020 2320  rameters:.    # 
-00000c10: 736d 6172 745f 6f70 656e 203e 3d20 352e  smart_open >= 5.
-00000c20: 302e 300a 2020 2020 6465 6620 5f73 335f  0.0.    def _s3_
-00000c30: 6f70 656e 2862 7563 6b65 743a 2073 7472  open(bucket: str
-00000c40: 2c20 6b65 793a 2073 7472 2c20 6d6f 6465  , key: str, mode
-00000c50: 3a20 7374 7229 3a0a 2020 2020 2020 2020  : str):.        
-00000c60: 7265 7475 726e 2073 6d61 7274 5f6f 7065  return smart_ope
-00000c70: 6e2e 7333 2e6f 7065 6e28 6275 636b 6574  n.s3.open(bucket
-00000c80: 2c20 6b65 792c 206d 6f64 652c 2063 6c69  , key, mode, cli
-00000c90: 656e 743d 6765 745f 7333 5f63 6c69 656e  ent=get_s3_clien
-00000ca0: 7428 2929 0a0a 656c 7365 3a0a 2020 2020  t())..else:.    
-00000cb0: 2320 736d 6172 745f 6f70 656e 203c 2031  # smart_open < 1
-00000cc0: 2e38 2e31 2c20 3e3d 2031 2e36 2e30 0a20  .8.1, >= 1.6.0. 
-00000cd0: 2020 2064 6566 205f 7333 5f6f 7065 6e28     def _s3_open(
-00000ce0: 6275 636b 6574 3a20 7374 722c 206b 6579  bucket: str, key
-00000cf0: 3a20 7374 722c 206d 6f64 653a 2073 7472  : str, mode: str
-00000d00: 293a 2020 2320 7072 6167 6d61 3a20 6e6f  ):  # pragma: no
-00000d10: 2063 6f76 6572 0a20 2020 2020 2020 2072   cover.        r
-00000d20: 6574 7572 6e20 736d 6172 745f 6f70 656e  eturn smart_open
-00000d30: 2e73 332e 6f70 656e 280a 2020 2020 2020  .s3.open(.      
-00000d40: 2020 2020 2020 6275 636b 6574 2c0a 2020        bucket,.  
-00000d50: 2020 2020 2020 2020 2020 6b65 792c 0a20            key,. 
-00000d60: 2020 2020 2020 2020 2020 206d 6f64 652c             mode,
-00000d70: 0a20 2020 2020 2020 2020 2020 2073 335f  .            s3_
-00000d80: 7365 7373 696f 6e3d 6765 745f 7333 5f73  session=get_s3_s
-00000d90: 6573 7369 6f6e 2829 2c0a 2020 2020 2020  ession(),.      
-00000da0: 2020 2020 2020 656e 6470 6f69 6e74 5f75        endpoint_u
-00000db0: 726c 3d67 6574 5f65 6e64 706f 696e 745f  rl=get_endpoint_
-00000dc0: 7572 6c28 2929 2020 2320 7479 7065 3a20  url())  # type: 
-00000dd0: 6967 6e6f 7265 0a0a 0a64 6566 205f 7061  ignore...def _pa
-00000de0: 7463 685f 6d61 6b65 5f72 6571 7565 7374  tch_make_request
-00000df0: 2863 6c69 656e 743a 2062 6f74 6f63 6f72  (client: botocor
-00000e00: 652e 636c 6965 6e74 2e42 6173 6543 6c69  e.client.BaseCli
-00000e10: 656e 7429 3a0a 0a20 2020 2064 6566 2061  ent):..    def a
-00000e20: 6674 6572 5f63 616c 6c62 6163 6b28 7265  fter_callback(re
-00000e30: 7375 6c74 3a20 5475 706c 655b 4157 5352  sult: Tuple[AWSR
-00000e40: 6573 706f 6e73 652c 2064 6963 745d 2c20  esponse, dict], 
-00000e50: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
-00000e60: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
-00000e70: 2069 7369 6e73 7461 6e63 6528 7265 7375   isinstance(resu
-00000e80: 6c74 2c20 7475 706c 6529 206f 7220 6c65  lt, tuple) or le
-00000e90: 6e28 7265 7375 6c74 2920 213d 2032 205c  n(result) != 2 \
-00000ea0: 0a20 2020 2020 2020 2020 2020 206f 7220  .            or 
-00000eb0: 6e6f 7420 6973 696e 7374 616e 6365 2872  not isinstance(r
-00000ec0: 6573 756c 745b 305d 2c20 4157 5352 6573  esult[0], AWSRes
-00000ed0: 706f 6e73 6529 206f 7220 6e6f 7420 6973  ponse) or not is
-00000ee0: 696e 7374 616e 6365 2872 6573 756c 745b  instance(result[
-00000ef0: 315d 2c20 6469 6374 293a 0a20 2020 2020  1], dict):.     
-00000f00: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-00000f10: 7375 6c74 0a20 2020 2020 2020 2068 7474  sult.        htt
-00000f20: 702c 2070 6172 7365 645f 7265 7370 6f6e  p, parsed_respon
-00000f30: 7365 203d 2072 6573 756c 740a 2020 2020  se = result.    
-00000f40: 2020 2020 6966 2068 7474 702e 7374 6174      if http.stat
-00000f50: 7573 5f63 6f64 6520 3e3d 2035 3030 3a0a  us_code >= 500:.
-00000f60: 2020 2020 2020 2020 2020 2020 6572 726f              erro
-00000f70: 725f 636f 6465 203d 2070 6172 7365 645f  r_code = parsed_
-00000f80: 7265 7370 6f6e 7365 2e67 6574 2822 4572  response.get("Er
-00000f90: 726f 7222 2c20 7b7d 292e 6765 7428 2243  ror", {}).get("C
-00000fa0: 6f64 6522 290a 2020 2020 2020 2020 2020  ode").          
-00000fb0: 2020 6f70 6572 6174 696f 6e5f 6d6f 6465    operation_mode
-00000fc0: 6c20 3d20 6b77 6172 6773 2e67 6574 2827  l = kwargs.get('
-00000fd0: 6f70 6572 6174 696f 6e5f 6d6f 6465 6c27  operation_model'
-00000fe0: 2920 6f72 2028 0a20 2020 2020 2020 2020  ) or (.         
-00000ff0: 2020 2020 2020 2061 7267 735b 305d 2069         args[0] i
-00001000: 6620 6172 6773 2065 6c73 6520 4e6f 6e65  f args else None
-00001010: 290a 2020 2020 2020 2020 2020 2020 6f70  ).            op
-00001020: 6572 6174 696f 6e5f 6e61 6d65 203d 206f  eration_name = o
-00001030: 7065 7261 7469 6f6e 5f6d 6f64 656c 2e6e  peration_model.n
-00001040: 616d 6520 6966 206f 7065 7261 7469 6f6e  ame if operation
-00001050: 5f6d 6f64 656c 2065 6c73 6520 2750 726f  _model else 'Pro
-00001060: 7879 4d65 7468 6f64 270a 2020 2020 2020  xyMethod'.      
-00001070: 2020 2020 2020 6572 726f 725f 636c 6173        error_clas
-00001080: 7320 3d20 636c 6965 6e74 2e65 7863 6570  s = client.excep
-00001090: 7469 6f6e 732e 6672 6f6d 5f63 6f64 6528  tions.from_code(
-000010a0: 6572 726f 725f 636f 6465 290a 2020 2020  error_code).    
-000010b0: 2020 2020 2020 2020 7261 6973 6520 6572          raise er
-000010c0: 726f 725f 636c 6173 7328 7061 7273 6564  ror_class(parsed
-000010d0: 5f72 6573 706f 6e73 652c 206f 7065 7261  _response, opera
-000010e0: 7469 6f6e 5f6e 616d 6529 0a20 2020 2020  tion_name).     
-000010f0: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
-00001100: 0a0a 2020 2020 6465 6620 7265 7472 795f  ..    def retry_
-00001110: 6361 6c6c 6261 636b 2865 7272 6f72 2c20  callback(error, 
-00001120: 6f70 6572 6174 696f 6e5f 6d6f 6465 6c2c  operation_model,
-00001130: 2072 6571 7565 7374 5f64 6963 742c 2072   request_dict, r
-00001140: 6571 7565 7374 5f63 6f6e 7465 7874 293a  equest_context):
-00001150: 0a20 2020 2020 2020 2069 6620 6572 726f  .        if erro
-00001160: 7220 6973 204e 6f6e 653a 2020 2320 7265  r is None:  # re
-00001170: 7472 7920 666f 7220 7468 6520 6669 7273  try for the firs
-00001180: 7420 7469 6d65 0a20 2020 2020 2020 2020  t time.         
-00001190: 2020 2065 7272 6f72 5f6c 6f67 6765 722e     error_logger.
-000011a0: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
-000011b0: 2020 2020 2020 2027 6661 696c 6564 2074         'failed t
-000011c0: 6f20 7072 6f63 6573 733a 2025 722c 2077  o process: %r, w
-000011d0: 6974 6820 7061 7261 6d65 7465 7273 3a20  ith parameters: 
-000011e0: 2573 272c 0a20 2020 2020 2020 2020 2020  %s',.           
-000011f0: 2020 2020 206f 7065 7261 7469 6f6e 5f6d       operation_m
-00001200: 6f64 656c 2e6e 616d 652c 2072 6571 7565  odel.name, reque
-00001210: 7374 5f64 6963 7429 0a20 2020 2020 2020  st_dict).       
-00001220: 2069 6620 6973 5f72 6561 6461 626c 6528   if is_readable(
-00001230: 7265 7175 6573 745f 6469 6374 5b27 626f  request_dict['bo
-00001240: 6479 275d 293a 0a20 2020 2020 2020 2020  dy']):.         
-00001250: 2020 2072 6571 7565 7374 5f64 6963 745b     request_dict[
-00001260: 2762 6f64 7927 5d2e 7365 656b 2830 290a  'body'].seek(0).
-00001270: 0a20 2020 2064 6566 2062 6566 6f72 655f  .    def before_
-00001280: 6361 6c6c 6261 636b 286f 7065 7261 7469  callback(operati
-00001290: 6f6e 5f6d 6f64 656c 2c20 7265 7175 6573  on_model, reques
-000012a0: 745f 6469 6374 2c20 7265 7175 6573 745f  t_dict, request_
-000012b0: 636f 6e74 6578 7429 3a0a 2020 2020 2020  context):.      
-000012c0: 2020 5f6c 6f67 6765 722e 6465 6275 6728    _logger.debug(
-000012d0: 0a20 2020 2020 2020 2020 2020 2027 7365  .            'se
-000012e0: 6e64 2073 3320 7265 7175 6573 743a 2025  nd s3 request: %
-000012f0: 722c 2077 6974 6820 7061 7261 6d65 7465  r, with paramete
-00001300: 7273 3a20 2573 272c 206f 7065 7261 7469  rs: %s', operati
-00001310: 6f6e 5f6d 6f64 656c 2e6e 616d 652c 0a20  on_model.name,. 
-00001320: 2020 2020 2020 2020 2020 2072 6571 7565             reque
-00001330: 7374 5f64 6963 7429 0a0a 2020 2020 636c  st_dict)..    cl
-00001340: 6965 6e74 2e5f 6d61 6b65 5f72 6571 7565  ient._make_reque
-00001350: 7374 203d 2070 6174 6368 5f6d 6574 686f  st = patch_metho
-00001360: 6428 0a20 2020 2020 2020 2063 6c69 656e  d(.        clien
-00001370: 742e 5f6d 616b 655f 7265 7175 6573 742c  t._make_request,
-00001380: 0a20 2020 2020 2020 206d 6178 5f72 6574  .        max_ret
-00001390: 7269 6573 3d6d 6178 5f72 6574 7269 6573  ries=max_retries
-000013a0: 2c0a 2020 2020 2020 2020 7368 6f75 6c64  ,.        should
-000013b0: 5f72 6574 7279 3d73 335f 7368 6f75 6c64  _retry=s3_should
-000013c0: 5f72 6574 7279 2c0a 2020 2020 2020 2020  _retry,.        
-000013d0: 6166 7465 725f 6361 6c6c 6261 636b 3d61  after_callback=a
-000013e0: 6674 6572 5f63 616c 6c62 6163 6b2c 0a20  fter_callback,. 
-000013f0: 2020 2020 2020 2062 6566 6f72 655f 6361         before_ca
-00001400: 6c6c 6261 636b 3d62 6566 6f72 655f 6361  llback=before_ca
-00001410: 6c6c 6261 636b 2c0a 2020 2020 2020 2020  llback,.        
-00001420: 7265 7472 795f 6361 6c6c 6261 636b 3d72  retry_callback=r
-00001430: 6574 7279 5f63 616c 6c62 6163 6b29 0a20  etry_callback). 
-00001440: 2020 2072 6574 7572 6e20 636c 6965 6e74     return client
-00001450: 0a0a 0a64 6566 2070 6172 7365 5f73 335f  ...def parse_s3_
-00001460: 7572 6c28 7333 5f75 726c 3a20 5061 7468  url(s3_url: Path
-00001470: 4c69 6b65 2920 2d3e 2054 7570 6c65 5b73  Like) -> Tuple[s
-00001480: 7472 2c20 7374 725d 3a0a 2020 2020 7333  tr, str]:.    s3
-00001490: 5f75 726c 203d 2066 7370 6174 6828 7333  _url = fspath(s3
-000014a0: 5f75 726c 290a 2020 2020 7333 5f73 6368  _url).    s3_sch
-000014b0: 656d 652c 2072 6967 6874 7061 7274 203d  eme, rightpart =
-000014c0: 2073 335f 7572 6c5b 3a35 5d2c 2073 335f   s3_url[:5], s3_
-000014d0: 7572 6c5b 353a 5d0a 2020 2020 6966 2073  url[5:].    if s
-000014e0: 335f 7363 6865 6d65 2021 3d20 2773 333a  3_scheme != 's3:
-000014f0: 2f2f 273a 0a20 2020 2020 2020 2072 6169  //':.        rai
-00001500: 7365 2056 616c 7565 4572 726f 7228 274e  se ValueError('N
-00001510: 6f74 2061 2073 3320 7572 6c3a 2025 7227  ot a s3 url: %r'
-00001520: 2025 2073 335f 7572 6c29 0a20 2020 2062   % s3_url).    b
-00001530: 7563 6b65 746d 6174 6368 203d 2072 652e  ucketmatch = re.
-00001540: 6d61 7463 6828 2728 2e2a 3f29 2f27 2c20  match('(.*?)/', 
-00001550: 7269 6768 7470 6172 7429 0a20 2020 2069  rightpart).    i
-00001560: 6620 6275 636b 6574 6d61 7463 6820 6973  f bucketmatch is
-00001570: 204e 6f6e 653a 0a20 2020 2020 2020 2062   None:.        b
-00001580: 7563 6b65 7420 3d20 7269 6768 7470 6172  ucket = rightpar
-00001590: 740a 2020 2020 2020 2020 7061 7468 203d  t.        path =
-000015a0: 2027 270a 2020 2020 656c 7365 3a0a 2020   ''.    else:.  
-000015b0: 2020 2020 2020 6275 636b 6574 203d 2062        bucket = b
-000015c0: 7563 6b65 746d 6174 6368 2e67 726f 7570  ucketmatch.group
-000015d0: 2831 290a 2020 2020 2020 2020 7061 7468  (1).        path
-000015e0: 203d 2072 6967 6874 7061 7274 5b6c 656e   = rightpart[len
-000015f0: 2862 7563 6b65 7429 202b 2031 3a5d 0a20  (bucket) + 1:]. 
-00001600: 2020 2072 6574 7572 6e20 6275 636b 6574     return bucket
-00001610: 2c20 7061 7468 0a0a 0a64 6566 2067 6574  , path...def get
-00001620: 5f73 636f 7065 645f 636f 6e66 6967 2829  _scoped_config()
-00001630: 202d 3e20 4469 6374 3a0a 2020 2020 7265   -> Dict:.    re
-00001640: 7475 726e 2067 6574 5f73 335f 7365 7373  turn get_s3_sess
-00001650: 696f 6e28 292e 5f73 6573 7369 6f6e 2e67  ion()._session.g
-00001660: 6574 5f73 636f 7065 645f 636f 6e66 6967  et_scoped_config
-00001670: 2829 0a0a 0a64 6566 2067 6574 5f65 6e64  ()...def get_end
-00001680: 706f 696e 745f 7572 6c28 2920 2d3e 2073  point_url() -> s
-00001690: 7472 3a0a 2020 2020 2727 2747 6574 2074  tr:.    '''Get t
-000016a0: 6865 2065 6e64 706f 696e 7420 7572 6c20  he endpoint url 
-000016b0: 6f66 2053 330a 0a20 2020 203a 7265 7475  of S3..    :retu
-000016c0: 726e 733a 2053 3320 656e 6470 6f69 6e74  rns: S3 endpoint
-000016d0: 2075 726c 0a20 2020 2027 2727 0a20 2020   url.    '''.   
-000016e0: 2061 7773 5f65 6e76 6972 6f6e 5f65 6e64   aws_environ_end
-000016f0: 706f 696e 745f 7572 6c20 3d20 6f73 2e65  point_url = os.e
-00001700: 6e76 6972 6f6e 2e67 6574 2827 4157 535f  nviron.get('AWS_
-00001710: 454e 4450 4f49 4e54 2729 0a20 2020 2069  ENDPOINT').    i
-00001720: 6620 6177 735f 656e 7669 726f 6e5f 656e  f aws_environ_en
-00001730: 6470 6f69 6e74 5f75 726c 3a0a 2020 2020  dpoint_url:.    
-00001740: 2020 2020 5f6c 6f67 6765 722e 696e 666f      _logger.info
-00001750: 2822 7573 696e 6720 4157 535f 454e 4450  ("using AWS_ENDP
-00001760: 4f49 4e54 3a20 2573 2220 2520 6177 735f  OINT: %s" % aws_
-00001770: 656e 7669 726f 6e5f 656e 6470 6f69 6e74  environ_endpoint
-00001780: 5f75 726c 290a 2020 2020 2020 2020 7265  _url).        re
-00001790: 7475 726e 2061 7773 5f65 6e76 6972 6f6e  turn aws_environ
-000017a0: 5f65 6e64 706f 696e 745f 7572 6c0a 2020  _endpoint_url.  
-000017b0: 2020 656e 7669 726f 6e5f 656e 6470 6f69    environ_endpoi
-000017c0: 6e74 5f75 726c 203d 206f 732e 656e 7669  nt_url = os.envi
-000017d0: 726f 6e2e 6765 7428 274f 5353 5f45 4e44  ron.get('OSS_END
-000017e0: 504f 494e 5427 290a 2020 2020 6966 2065  POINT').    if e
-000017f0: 6e76 6972 6f6e 5f65 6e64 706f 696e 745f  nviron_endpoint_
-00001800: 7572 6c3a 0a20 2020 2020 2020 205f 6c6f  url:.        _lo
-00001810: 6767 6572 2e69 6e66 6f28 2275 7369 6e67  gger.info("using
-00001820: 204f 5353 5f45 4e44 504f 494e 543a 2025   OSS_ENDPOINT: %
-00001830: 7322 2025 2065 6e76 6972 6f6e 5f65 6e64  s" % environ_end
-00001840: 706f 696e 745f 7572 6c29 0a20 2020 2020  point_url).     
-00001850: 2020 2072 6574 7572 6e20 656e 7669 726f     return enviro
-00001860: 6e5f 656e 6470 6f69 6e74 5f75 726c 0a20  n_endpoint_url. 
-00001870: 2020 2063 6f6e 6669 675f 656e 6470 6f69     config_endpoi
-00001880: 6e74 5f75 726c 203d 2067 6574 5f73 636f  nt_url = get_sco
-00001890: 7065 645f 636f 6e66 6967 2829 2e67 6574  ped_config().get
-000018a0: 2827 7333 272c 207b 7d29 2e67 6574 2827  ('s3', {}).get('
-000018b0: 656e 6470 6f69 6e74 5f75 726c 2729 0a20  endpoint_url'). 
-000018c0: 2020 2069 6620 636f 6e66 6967 5f65 6e64     if config_end
-000018d0: 706f 696e 745f 7572 6c3a 0a20 2020 2020  point_url:.     
-000018e0: 2020 205f 6c6f 6767 6572 2e69 6e66 6f28     _logger.info(
-000018f0: 0a20 2020 2020 2020 2020 2020 2022 7573  .            "us
-00001900: 696e 6720 7e2f 2e61 7773 2f63 6f6e 6669  ing ~/.aws/confi
-00001910: 673a 2065 6e64 706f 696e 745f 7572 6c3d  g: endpoint_url=
-00001920: 2573 2220 2520 636f 6e66 6967 5f65 6e64  %s" % config_end
-00001930: 706f 696e 745f 7572 6c29 0a20 2020 2020  point_url).     
-00001940: 2020 2072 6574 7572 6e20 636f 6e66 6967     return config
-00001950: 5f65 6e64 706f 696e 745f 7572 6c0a 2020  _endpoint_url.  
-00001960: 2020 7265 7475 726e 2065 6e64 706f 696e    return endpoin
-00001970: 745f 7572 6c0a 0a0a 6465 6620 6765 745f  t_url...def get_
-00001980: 7333 5f73 6573 7369 6f6e 2829 3a0a 2020  s3_session():.  
-00001990: 2020 2727 2747 6574 2053 3320 7365 7373    '''Get S3 sess
-000019a0: 696f 6e0a 0a20 2020 203a 7265 7475 726e  ion..    :return
-000019b0: 733a 2053 3320 7365 7373 696f 6e0a 2020  s: S3 session.  
-000019c0: 2020 2727 270a 2020 2020 7265 7475 726e    '''.    return
-000019d0: 2074 6872 6561 645f 6c6f 6361 6c28 2773   thread_local('s
-000019e0: 335f 7365 7373 696f 6e27 2c20 626f 746f  3_session', boto
-000019f0: 332e 7365 7373 696f 6e2e 5365 7373 696f  3.session.Sessio
-00001a00: 6e29 0a0a 0a64 6566 2067 6574 5f73 335f  n)...def get_s3_
-00001a10: 636c 6965 6e74 280a 2020 2020 2020 2020  client(.        
-00001a20: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
-00001a30: 5b62 6f74 6f63 6f72 652e 636f 6e66 6967  [botocore.config
-00001a40: 2e43 6f6e 6669 675d 203d 204e 6f6e 652c  .Config] = None,
-00001a50: 0a20 2020 2020 2020 2063 6163 6865 5f6b  .        cache_k
-00001a60: 6579 3a20 4f70 7469 6f6e 616c 5b73 7472  ey: Optional[str
-00001a70: 5d20 3d20 4e6f 6e65 293a 0a20 2020 2027  ] = None):.    '
-00001a80: 2727 4765 7420 5333 2063 6c69 656e 740a  ''Get S3 client.
-00001a90: 0a20 2020 203a 7265 7475 726e 733a 2053  .    :returns: S
-00001aa0: 3320 636c 6965 6e74 0a20 2020 2027 2727  3 client.    '''
-00001ab0: 0a20 2020 2069 6620 6361 6368 655f 6b65  .    if cache_ke
-00001ac0: 7920 6973 206e 6f74 204e 6f6e 653a 0a20  y is not None:. 
-00001ad0: 2020 2020 2020 2072 6574 7572 6e20 7468         return th
-00001ae0: 7265 6164 5f6c 6f63 616c 2863 6163 6865  read_local(cache
-00001af0: 5f6b 6579 2c20 6765 745f 7333 5f63 6c69  _key, get_s3_cli
-00001b00: 656e 742c 2063 6f6e 6669 6729 0a20 2020  ent, config).   
-00001b10: 2063 6c69 656e 7420 3d20 6765 745f 7333   client = get_s3
-00001b20: 5f73 6573 7369 6f6e 2829 2e63 6c69 656e  _session().clien
-00001b30: 7428 0a20 2020 2020 2020 2027 7333 272c  t(.        's3',
-00001b40: 2065 6e64 706f 696e 745f 7572 6c3d 6765   endpoint_url=ge
-00001b50: 745f 656e 6470 6f69 6e74 5f75 726c 2829  t_endpoint_url()
-00001b60: 2c20 636f 6e66 6967 3d63 6f6e 6669 6729  , config=config)
-00001b70: 0a20 2020 2063 6c69 656e 7420 3d20 5f70  .    client = _p
-00001b80: 6174 6368 5f6d 616b 655f 7265 7175 6573  atch_make_reques
-00001b90: 7428 636c 6965 6e74 290a 2020 2020 7265  t(client).    re
-00001ba0: 7475 726e 2063 6c69 656e 740a 0a0a 6465  turn client...de
-00001bb0: 6620 7333 5f70 6174 685f 6a6f 696e 2870  f s3_path_join(p
-00001bc0: 6174 683a 2050 6174 684c 696b 652c 202a  ath: PathLike, *
-00001bd0: 6f74 6865 725f 7061 7468 733a 2050 6174  other_paths: Pat
-00001be0: 684c 696b 6529 202d 3e20 7374 723a 0a20  hLike) -> str:. 
-00001bf0: 2020 2027 2727 0a20 2020 2043 6f6e 6361     '''.    Conca
-00001c00: 7420 3220 6f72 206d 6f72 6520 7061 7468  t 2 or more path
-00001c10: 2074 6f20 6120 636f 6d70 6c65 7465 2070   to a complete p
-00001c20: 6174 680a 0a20 2020 203a 7061 7261 6d20  ath..    :param 
-00001c30: 7061 7468 3a20 4769 7665 6e20 7061 7468  path: Given path
-00001c40: 0a20 2020 203a 7061 7261 6d20 6f74 6865  .    :param othe
-00001c50: 725f 7061 7468 733a 2050 6174 6873 2074  r_paths: Paths t
-00001c60: 6f20 6265 2063 6f6e 6361 7465 6e61 7465  o be concatenate
-00001c70: 640a 2020 2020 3a72 6574 7572 6e73 3a20  d.    :returns: 
-00001c80: 436f 6e63 6174 656e 6174 6564 2063 6f6d  Concatenated com
-00001c90: 706c 6574 6520 7061 7468 0a0a 2020 2020  plete path..    
-00001ca0: 2e2e 206e 6f74 6520 3a3a 0a0a 2020 2020  .. note ::..    
-00001cb0: 2020 2020 5468 6520 6469 6666 6572 656e      The differen
-00001cc0: 6365 2062 6574 7765 656e 2074 6869 7320  ce between this 
-00001cd0: 6675 6e63 7469 6f6e 2061 6e64 2060 606f  function and ``o
-00001ce0: 732e 7061 7468 2e6a 6f69 6e60 6020 6973  s.path.join`` is
-00001cf0: 2074 6861 7420 7468 6973 2066 756e 6374   that this funct
-00001d00: 696f 6e20 6967 6e6f 7265 7320 6c65 6674  ion ignores left
-00001d10: 2073 6964 6520 736c 6173 6820 2877 6869   side slash (whi
-00001d20: 6368 2069 6e64 6963 6174 6573 2061 6273  ch indicates abs
-00001d30: 6f6c 7574 6520 7061 7468 2920 696e 2060  olute path) in `
-00001d40: 606f 7468 6572 5f70 6174 6873 6060 2061  `other_paths`` a
-00001d50: 6e64 2077 696c 6c20 6469 7265 6374 6c79  nd will directly
-00001d60: 2063 6f6e 6361 742e 0a20 2020 2020 2020   concat..       
-00001d70: 2065 2e67 2e20 6f73 2e70 6174 682e 6a6f   e.g. os.path.jo
-00001d80: 696e 2827 2f70 6174 6827 2c20 2774 6f27  in('/path', 'to'
-00001d90: 2c20 272f 6669 6c65 2729 203d 3e20 272f  , '/file') => '/
-00001da0: 6669 6c65 272c 2062 7574 2073 335f 7061  file', but s3_pa
-00001db0: 7468 5f6a 6f69 6e28 272f 7061 7468 272c  th_join('/path',
-00001dc0: 2027 746f 272c 2027 2f66 696c 6527 2920   'to', '/file') 
-00001dd0: 3d3e 2027 2f70 6174 682f 746f 2f66 696c  => '/path/to/fil
-00001de0: 6527 0a20 2020 2027 2727 0a20 2020 2072  e'.    '''.    r
-00001df0: 6574 7572 6e20 7572 695f 6a6f 696e 2866  eturn uri_join(f
-00001e00: 7370 6174 6828 7061 7468 292c 202a 6d61  spath(path), *ma
-00001e10: 7028 6673 7061 7468 2c20 6f74 6865 725f  p(fspath, other_
-00001e20: 7061 7468 7329 290a 0a0a 6465 6620 5f6c  paths))...def _l
-00001e30: 6973 745f 616c 6c5f 6275 636b 6574 7328  ist_all_buckets(
-00001e40: 2920 2d3e 204c 6973 745b 7374 725d 3a0a  ) -> List[str]:.
-00001e50: 2020 2020 636c 6965 6e74 203d 2067 6574      client = get
-00001e60: 5f73 335f 636c 6965 6e74 2829 0a20 2020  _s3_client().   
-00001e70: 2072 6573 706f 6e73 6520 3d20 636c 6965   response = clie
-00001e80: 6e74 2e6c 6973 745f 6275 636b 6574 7328  nt.list_buckets(
-00001e90: 290a 2020 2020 7265 7475 726e 205b 636f  ).    return [co
-00001ea0: 6e74 656e 745b 274e 616d 6527 5d20 666f  ntent['Name'] fo
-00001eb0: 7220 636f 6e74 656e 7420 696e 2072 6573  r content in res
-00001ec0: 706f 6e73 655b 2742 7563 6b65 7473 275d  ponse['Buckets']
-00001ed0: 5d0a 0a0a 6465 6620 5f70 6172 7365 5f73  ]...def _parse_s
-00001ee0: 335f 7572 6c5f 6967 6e6f 7265 5f62 7261  3_url_ignore_bra
-00001ef0: 6365 2873 335f 7572 6c3a 2073 7472 2920  ce(s3_url: str) 
-00001f00: 2d3e 2054 7570 6c65 5b73 7472 2c20 7374  -> Tuple[str, st
-00001f10: 725d 3a0a 2020 2020 7333 5f75 726c 203d  r]:.    s3_url =
-00001f20: 2066 7370 6174 6828 7333 5f75 726c 290a   fspath(s3_url).
-00001f30: 2020 2020 7333 5f73 6368 656d 652c 2072      s3_scheme, r
-00001f40: 6967 6874 7061 7274 203d 2073 335f 7572  ightpart = s3_ur
-00001f50: 6c5b 3a35 5d2c 2073 335f 7572 6c5b 353a  l[:5], s3_url[5:
-00001f60: 5d0a 2020 2020 6966 2073 335f 7363 6865  ].    if s3_sche
-00001f70: 6d65 2021 3d20 2773 333a 2f2f 273a 0a20  me != 's3://':. 
-00001f80: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00001f90: 7565 4572 726f 7228 274e 6f74 2061 2073  ueError('Not a s
-00001fa0: 3320 7572 6c3a 2025 7227 2025 2073 335f  3 url: %r' % s3_
-00001fb0: 7572 6c29 0a20 2020 206c 6566 745f 6272  url).    left_br
-00001fc0: 6163 6520 3d20 4661 6c73 650a 2020 2020  ace = False.    
-00001fd0: 666f 7220 6375 7272 656e 745f 696e 6465  for current_inde
-00001fe0: 782c 2063 7572 7265 6e74 5f63 6861 7261  x, current_chara
-00001ff0: 6374 6572 2069 6e20 656e 756d 6572 6174  cter in enumerat
-00002000: 6528 7269 6768 7470 6172 7429 3a0a 2020  e(rightpart):.  
-00002010: 2020 2020 2020 6966 2063 7572 7265 6e74        if current
-00002020: 5f63 6861 7261 6374 6572 203d 3d20 222f  _character == "/
-00002030: 2220 616e 6420 6c65 6674 5f62 7261 6365  " and left_brace
-00002040: 2069 7320 4661 6c73 653a 0a20 2020 2020   is False:.     
-00002050: 2020 2020 2020 2072 6574 7572 6e20 7269         return ri
-00002060: 6768 7470 6172 745b 3a63 7572 7265 6e74  ghtpart[:current
-00002070: 5f69 6e64 6578 5d2c 2072 6967 6874 7061  _index], rightpa
-00002080: 7274 5b63 7572 7265 6e74 5f69 6e64 6578  rt[current_index
-00002090: 202b 2031 3a5d 0a20 2020 2020 2020 2065   + 1:].        e
-000020a0: 6c69 6620 6375 7272 656e 745f 6368 6172  lif current_char
-000020b0: 6163 7465 7220 3d3d 2022 7b22 3a0a 2020  acter == "{":.  
-000020c0: 2020 2020 2020 2020 2020 6c65 6674 5f62            left_b
-000020d0: 7261 6365 203d 2054 7275 650a 2020 2020  race = True.    
-000020e0: 2020 2020 656c 6966 2063 7572 7265 6e74      elif current
-000020f0: 5f63 6861 7261 6374 6572 203d 3d20 227d  _character == "}
-00002100: 223a 0a20 2020 2020 2020 2020 2020 206c  ":.            l
-00002110: 6566 745f 6272 6163 6520 3d20 4661 6c73  eft_brace = Fals
-00002120: 650a 2020 2020 7265 7475 726e 2072 6967  e.    return rig
-00002130: 6874 7061 7274 2c20 2222 0a0a 0a64 6566  htpart, ""...def
-00002140: 205f 6772 6f75 705f 7333 7061 7468 5f62   _group_s3path_b
-00002150: 795f 6275 636b 6574 2873 335f 7061 7468  y_bucket(s3_path
-00002160: 6e61 6d65 3a20 7374 7229 202d 3e20 4c69  name: str) -> Li
-00002170: 7374 5b73 7472 5d3a 0a20 2020 2062 7563  st[str]:.    buc
-00002180: 6b65 742c 206b 6579 203d 205f 7061 7273  ket, key = _pars
-00002190: 655f 7333 5f75 726c 5f69 676e 6f72 655f  e_s3_url_ignore_
-000021a0: 6272 6163 6528 7333 5f70 6174 686e 616d  brace(s3_pathnam
-000021b0: 6529 0a20 2020 2069 6620 6e6f 7420 6275  e).    if not bu
-000021c0: 636b 6574 3a0a 2020 2020 2020 2020 6966  cket:.        if
-000021d0: 206e 6f74 206b 6579 3a0a 2020 2020 2020   not key:.      
-000021e0: 2020 2020 2020 7261 6973 6520 556e 7375        raise Unsu
-000021f0: 7070 6f72 7465 6445 7272 6f72 2827 476c  pportedError('Gl
-00002200: 6f62 2077 686f 6c65 2073 3327 2c20 7333  ob whole s3', s3
-00002210: 5f70 6174 686e 616d 6529 0a20 2020 2020  _pathname).     
-00002220: 2020 2072 6169 7365 2053 3342 7563 6b65     raise S3Bucke
-00002230: 744e 6f74 466f 756e 6445 7272 6f72 2827  tNotFoundError('
-00002240: 456d 7074 7920 6275 636b 6574 206e 616d  Empty bucket nam
-00002250: 653a 2025 7227 2025 2073 335f 7061 7468  e: %r' % s3_path
-00002260: 6e61 6d65 290a 0a20 2020 2067 726f 7570  name)..    group
-00002270: 6564 5f70 6174 6820 3d20 5b5d 0a0a 2020  ed_path = []..  
-00002280: 2020 6465 6620 6765 6e65 7261 7465 5f73    def generate_s
-00002290: 335f 7061 7468 2862 7563 6b65 743a 2073  3_path(bucket: s
-000022a0: 7472 2c20 6b65 793a 2073 7472 2920 2d3e  tr, key: str) ->
-000022b0: 2073 7472 3a0a 2020 2020 2020 2020 6966   str:.        if
-000022c0: 206b 6579 3a0a 2020 2020 2020 2020 2020   key:.          
-000022d0: 2020 7265 7475 726e 2022 7333 3a2f 2f25    return "s3://%
-000022e0: 732f 2573 2220 2520 2862 7563 6b65 742c  s/%s" % (bucket,
-000022f0: 206b 6579 290a 2020 2020 2020 2020 7265   key).        re
-00002300: 7475 726e 2022 7333 3a2f 2f25 7325 7322  turn "s3://%s%s"
-00002310: 2025 2028 6275 636b 6574 2c20 222f 2220   % (bucket, "/" 
-00002320: 6966 2073 335f 7061 7468 6e61 6d65 2e65  if s3_pathname.e
-00002330: 6e64 7377 6974 6828 222f 2229 2065 6c73  ndswith("/") els
-00002340: 6520 2222 290a 0a20 2020 2061 6c6c 5f62  e "")..    all_b
-00002350: 7563 6b65 7420 3d20 6c72 755f 6361 6368  ucket = lru_cach
-00002360: 6528 6d61 7873 697a 653d 3129 285f 6c69  e(maxsize=1)(_li
-00002370: 7374 5f61 6c6c 5f62 7563 6b65 7473 290a  st_all_buckets).
-00002380: 2020 2020 666f 7220 6275 636b 6574 6e61      for bucketna
-00002390: 6d65 2069 6e20 756e 676c 6f62 6c69 7a65  me in ungloblize
-000023a0: 2862 7563 6b65 7429 3a0a 2020 2020 2020  (bucket):.      
-000023b0: 2020 6966 2068 6173 5f6d 6167 6963 2862    if has_magic(b
-000023c0: 7563 6b65 746e 616d 6529 3a0a 2020 2020  ucketname):.    
-000023d0: 2020 2020 2020 2020 7370 6c69 745f 6275          split_bu
-000023e0: 636b 6574 6e61 6d65 203d 2062 7563 6b65  cketname = bucke
-000023f0: 746e 616d 652e 7370 6c69 7428 222f 222c  tname.split("/",
-00002400: 2031 290a 2020 2020 2020 2020 2020 2020   1).            
-00002410: 7061 7468 5f70 6172 7420 3d20 4e6f 6e65  path_part = None
-00002420: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00002430: 6c65 6e28 7370 6c69 745f 6275 636b 6574  len(split_bucket
-00002440: 6e61 6d65 2920 3d3d 2032 3a0a 2020 2020  name) == 2:.    
-00002450: 2020 2020 2020 2020 2020 2020 6275 636b              buck
-00002460: 6574 6e61 6d65 2c20 7061 7468 5f70 6172  etname, path_par
-00002470: 7420 3d20 7370 6c69 745f 6275 636b 6574  t = split_bucket
-00002480: 6e61 6d65 0a20 2020 2020 2020 2020 2020  name.           
-00002490: 2070 6174 7465 726e 203d 2072 652e 636f   pattern = re.co
-000024a0: 6d70 696c 6528 7472 616e 736c 6174 6528  mpile(translate(
-000024b0: 7265 2e73 7562 2872 275c 2a7b 322c 7d27  re.sub(r'\*{2,}'
-000024c0: 2c20 272a 272c 2062 7563 6b65 746e 616d  , '*', bucketnam
-000024d0: 6529 2929 0a0a 2020 2020 2020 2020 2020  e)))..          
-000024e0: 2020 666f 7220 6275 636b 6574 2069 6e20    for bucket in 
-000024f0: 616c 6c5f 6275 636b 6574 2829 3a0a 2020  all_bucket():.  
-00002500: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00002510: 2070 6174 7465 726e 2e66 756c 6c6d 6174   pattern.fullmat
-00002520: 6368 2862 7563 6b65 7429 2069 7320 6e6f  ch(bucket) is no
-00002530: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00002540: 2020 2020 2020 2020 2020 2020 6966 2070              if p
-00002550: 6174 685f 7061 7274 2069 7320 6e6f 7420  ath_part is not 
-00002560: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00002570: 2020 2020 2020 2020 2020 2020 2020 6275                bu
-00002580: 636b 6574 203d 2022 2573 2f25 7322 2025  cket = "%s/%s" %
-00002590: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-000025a0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-000025b0: 7563 6b65 742c 2070 6174 685f 7061 7274  ucket, path_part
-000025c0: 2920 2023 2070 7261 676d 613a 206e 6f20  )  # pragma: no 
-000025d0: 636f 7665 720a 2020 2020 2020 2020 2020  cover.          
-000025e0: 2020 2020 2020 2020 2020 6772 6f75 7065            groupe
-000025f0: 645f 7061 7468 2e61 7070 656e 6428 6765  d_path.append(ge
-00002600: 6e65 7261 7465 5f73 335f 7061 7468 2862  nerate_s3_path(b
-00002610: 7563 6b65 742c 206b 6579 2929 0a20 2020  ucket, key)).   
-00002620: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00002630: 2020 2020 2020 2067 726f 7570 6564 5f70         grouped_p
-00002640: 6174 682e 6170 7065 6e64 2867 656e 6572  ath.append(gener
-00002650: 6174 655f 7333 5f70 6174 6828 6275 636b  ate_s3_path(buck
-00002660: 6574 6e61 6d65 2c20 6b65 7929 290a 0a20  etname, key)).. 
-00002670: 2020 2072 6574 7572 6e20 6772 6f75 7065     return groupe
-00002680: 645f 7061 7468 0a0a 0a64 6566 205f 7333  d_path...def _s3
-00002690: 5f73 706c 6974 5f6d 6167 6963 5f69 676e  _split_magic_ign
-000026a0: 6f72 655f 6272 6163 6528 7333 5f70 6174  ore_brace(s3_pat
-000026b0: 686e 616d 653a 2073 7472 2920 2d3e 2054  hname: str) -> T
-000026c0: 7570 6c65 5b73 7472 2c20 7374 725d 3a0a  uple[str, str]:.
-000026d0: 2020 2020 6966 206e 6f74 2073 335f 7061      if not s3_pa
-000026e0: 7468 6e61 6d65 3a0a 2020 2020 2020 2020  thname:.        
-000026f0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00002700: 2822 7333 5f70 6174 686e 616d 653a 2025  ("s3_pathname: %
-00002710: 7322 2c20 7333 5f70 6174 686e 616d 6529  s", s3_pathname)
-00002720: 0a0a 2020 2020 6861 735f 7072 6f74 6f63  ..    has_protoc
-00002730: 6f6c 203d 2046 616c 7365 0a20 2020 2069  ol = False.    i
-00002740: 6620 7333 5f70 6174 686e 616d 652e 7374  f s3_pathname.st
-00002750: 6172 7473 7769 7468 2822 7333 3a2f 2f22  artswith("s3://"
-00002760: 293a 0a20 2020 2020 2020 2068 6173 5f70  ):.        has_p
-00002770: 726f 746f 636f 6c20 3d20 5472 7565 0a20  rotocol = True. 
-00002780: 2020 2020 2020 2073 335f 7061 7468 6e61         s3_pathna
-00002790: 6d65 203d 2073 335f 7061 7468 6e61 6d65  me = s3_pathname
-000027a0: 5b35 3a5d 0a0a 2020 2020 6861 735f 6465  [5:]..    has_de
-000027b0: 6c69 6d69 7465 7220 3d20 4661 6c73 650a  limiter = False.
-000027c0: 2020 2020 6966 2073 335f 7061 7468 6e61      if s3_pathna
-000027d0: 6d65 2e65 6e64 7377 6974 6828 222f 2229  me.endswith("/")
-000027e0: 3a0a 2020 2020 2020 2020 6861 735f 6465  :.        has_de
-000027f0: 6c69 6d69 7465 7220 3d20 5472 7565 0a20  limiter = True. 
-00002800: 2020 2020 2020 2073 335f 7061 7468 6e61         s3_pathna
-00002810: 6d65 203d 2073 335f 7061 7468 6e61 6d65  me = s3_pathname
-00002820: 5b3a 2d31 5d0a 0a20 2020 206e 6f72 6d61  [:-1]..    norma
-00002830: 6c5f 7061 7274 7320 3d20 5b5d 0a20 2020  l_parts = [].   
-00002840: 206d 6167 6963 5f70 6172 7473 203d 205b   magic_parts = [
-00002850: 5d0a 2020 2020 6c65 6674 5f62 7261 6365  ].    left_brace
-00002860: 203d 2046 616c 7365 0a20 2020 206c 6566   = False.    lef
-00002870: 745f 696e 6465 7820 3d20 300a 2020 2020  t_index = 0.    
-00002880: 666f 7220 6375 7272 656e 745f 696e 6465  for current_inde
-00002890: 782c 2063 7572 7265 6e74 5f63 6861 7261  x, current_chara
-000028a0: 6374 6572 2069 6e20 656e 756d 6572 6174  cter in enumerat
-000028b0: 6528 7333 5f70 6174 686e 616d 6529 3a0a  e(s3_pathname):.
-000028c0: 2020 2020 2020 2020 6966 2063 7572 7265          if curre
-000028d0: 6e74 5f63 6861 7261 6374 6572 203d 3d20  nt_character == 
-000028e0: 222f 2220 616e 6420 6c65 6674 5f62 7261  "/" and left_bra
-000028f0: 6365 2069 7320 4661 6c73 653a 0a20 2020  ce is False:.   
-00002900: 2020 2020 2020 2020 2069 6620 6861 735f           if has_
-00002910: 6d61 6769 635f 6967 6e6f 7265 5f62 7261  magic_ignore_bra
-00002920: 6365 2873 335f 7061 7468 6e61 6d65 5b6c  ce(s3_pathname[l
-00002930: 6566 745f 696e 6465 783a 6375 7272 656e  eft_index:curren
-00002940: 745f 696e 6465 785d 293a 0a20 2020 2020  t_index]):.     
-00002950: 2020 2020 2020 2020 2020 206d 6167 6963             magic
-00002960: 5f70 6172 7473 2e61 7070 656e 6428 7333  _parts.append(s3
-00002970: 5f70 6174 686e 616d 655b 6c65 6674 5f69  _pathname[left_i
-00002980: 6e64 6578 3a63 7572 7265 6e74 5f69 6e64  ndex:current_ind
-00002990: 6578 5d29 0a20 2020 2020 2020 2020 2020  ex]).           
-000029a0: 2020 2020 2069 6620 7333 5f70 6174 686e       if s3_pathn
-000029b0: 616d 655b 6375 7272 656e 745f 696e 6465  ame[current_inde
-000029c0: 7820 2b20 313a 5d3a 0a20 2020 2020 2020  x + 1:]:.       
-000029d0: 2020 2020 2020 2020 2020 2020 206d 6167               mag
-000029e0: 6963 5f70 6172 7473 2e61 7070 656e 6428  ic_parts.append(
-000029f0: 7333 5f70 6174 686e 616d 655b 6375 7272  s3_pathname[curr
-00002a00: 656e 745f 696e 6465 7820 2b20 313a 5d29  ent_index + 1:])
-00002a10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002a20: 2020 2020 206c 6566 745f 696e 6465 7820       left_index 
-00002a30: 3d20 6c65 6e28 7333 5f70 6174 686e 616d  = len(s3_pathnam
-00002a40: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00002a50: 2020 2062 7265 616b 0a20 2020 2020 2020     break.       
-00002a60: 2020 2020 206e 6f72 6d61 6c5f 7061 7274       normal_part
-00002a70: 732e 6170 7065 6e64 2873 335f 7061 7468  s.append(s3_path
-00002a80: 6e61 6d65 5b6c 6566 745f 696e 6465 783a  name[left_index:
-00002a90: 6375 7272 656e 745f 696e 6465 785d 290a  current_index]).
-00002aa0: 2020 2020 2020 2020 2020 2020 6c65 6674              left
-00002ab0: 5f69 6e64 6578 203d 2063 7572 7265 6e74  _index = current
-00002ac0: 5f69 6e64 6578 202b 2031 0a20 2020 2020  _index + 1.     
-00002ad0: 2020 2065 6c69 6620 6375 7272 656e 745f     elif current_
-00002ae0: 6368 6172 6163 7465 7220 3d3d 2022 7b22  character == "{"
-00002af0: 3a0a 2020 2020 2020 2020 2020 2020 6c65  :.            le
-00002b00: 6674 5f62 7261 6365 203d 2054 7275 650a  ft_brace = True.
-00002b10: 2020 2020 2020 2020 656c 6966 2063 7572          elif cur
-00002b20: 7265 6e74 5f63 6861 7261 6374 6572 203d  rent_character =
-00002b30: 3d20 227d 223a 0a20 2020 2020 2020 2020  = "}":.         
-00002b40: 2020 206c 6566 745f 6272 6163 6520 3d20     left_brace = 
-00002b50: 4661 6c73 650a 2020 2020 6966 2073 335f  False.    if s3_
-00002b60: 7061 7468 6e61 6d65 5b6c 6566 745f 696e  pathname[left_in
-00002b70: 6465 783a 5d3a 0a20 2020 2020 2020 2069  dex:]:.        i
-00002b80: 6620 6861 735f 6d61 6769 635f 6967 6e6f  f has_magic_igno
-00002b90: 7265 5f62 7261 6365 2873 335f 7061 7468  re_brace(s3_path
-00002ba0: 6e61 6d65 5b6c 6566 745f 696e 6465 783a  name[left_index:
-00002bb0: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
-00002bc0: 6d61 6769 635f 7061 7274 732e 6170 7065  magic_parts.appe
-00002bd0: 6e64 2873 335f 7061 7468 6e61 6d65 5b6c  nd(s3_pathname[l
-00002be0: 6566 745f 696e 6465 783a 5d29 0a20 2020  eft_index:]).   
-00002bf0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00002c00: 2020 2020 2020 206e 6f72 6d61 6c5f 7061         normal_pa
-00002c10: 7274 732e 6170 7065 6e64 2873 335f 7061  rts.append(s3_pa
-00002c20: 7468 6e61 6d65 5b6c 6566 745f 696e 6465  thname[left_inde
-00002c30: 783a 5d29 0a0a 2020 2020 6966 2068 6173  x:])..    if has
-00002c40: 5f70 726f 746f 636f 6c20 616e 6420 6e6f  _protocol and no
-00002c50: 726d 616c 5f70 6172 7473 3a0a 2020 2020  rmal_parts:.    
-00002c60: 2020 2020 6e6f 726d 616c 5f70 6172 7473      normal_parts
-00002c70: 2e69 6e73 6572 7428 302c 2022 7333 3a2f  .insert(0, "s3:/
-00002c80: 2229 0a20 2020 2065 6c69 6620 6861 735f  ").    elif has_
-00002c90: 7072 6f74 6f63 6f6c 3a0a 2020 2020 2020  protocol:.      
-00002ca0: 2020 6d61 6769 635f 7061 7274 732e 696e    magic_parts.in
-00002cb0: 7365 7274 2830 2c20 2273 333a 2f22 290a  sert(0, "s3:/").
-00002cc0: 0a20 2020 2069 6620 6861 735f 6465 6c69  .    if has_deli
-00002cd0: 6d69 7465 7220 616e 6420 6d61 6769 635f  miter and magic_
-00002ce0: 7061 7274 733a 0a20 2020 2020 2020 206d  parts:.        m
-00002cf0: 6167 6963 5f70 6172 7473 2e61 7070 656e  agic_parts.appen
-00002d00: 6428 2222 290a 2020 2020 656c 6966 2068  d("").    elif h
-00002d10: 6173 5f64 656c 696d 6974 6572 3a0a 2020  as_delimiter:.  
-00002d20: 2020 2020 2020 6e6f 726d 616c 5f70 6172        normal_par
-00002d30: 7473 2e61 7070 656e 6428 2222 290a 0a20  ts.append("").. 
-00002d40: 2020 2072 6574 7572 6e20 222f 222e 6a6f     return "/".jo
-00002d50: 696e 286e 6f72 6d61 6c5f 7061 7274 7329  in(normal_parts)
-00002d60: 2c20 222f 222e 6a6f 696e 286d 6167 6963  , "/".join(magic
-00002d70: 5f70 6172 7473 290a 0a0a 6465 6620 5f67  _parts)...def _g
-00002d80: 726f 7570 5f73 3370 6174 685f 6279 5f70  roup_s3path_by_p
-00002d90: 7265 6669 7828 7333 5f70 6174 686e 616d  refix(s3_pathnam
-00002da0: 653a 2073 7472 2920 2d3e 204c 6973 745b  e: str) -> List[
-00002db0: 7374 725d 3a0a 0a20 2020 205f 2c20 6b65  str]:..    _, ke
-00002dc0: 7920 3d20 7061 7273 655f 7333 5f75 726c  y = parse_s3_url
-00002dd0: 2873 335f 7061 7468 6e61 6d65 290a 2020  (s3_pathname).  
-00002de0: 2020 6966 206e 6f74 206b 6579 3a0a 2020    if not key:.  
-00002df0: 2020 2020 2020 7265 7475 726e 2075 6e67        return ung
-00002e00: 6c6f 626c 697a 6528 7333 5f70 6174 686e  loblize(s3_pathn
-00002e10: 616d 6529 0a0a 2020 2020 746f 705f 6469  ame)..    top_di
-00002e20: 722c 206d 6167 6963 5f70 6172 7420 3d20  r, magic_part = 
-00002e30: 5f73 335f 7370 6c69 745f 6d61 6769 635f  _s3_split_magic_
-00002e40: 6967 6e6f 7265 5f62 7261 6365 2873 335f  ignore_brace(s3_
-00002e50: 7061 7468 6e61 6d65 290a 2020 2020 6966  pathname).    if
-00002e60: 206e 6f74 2074 6f70 5f64 6972 3a0a 2020   not top_dir:.  
-00002e70: 2020 2020 2020 7265 7475 726e 205b 6d61        return [ma
-00002e80: 6769 635f 7061 7274 5d0a 2020 2020 6772  gic_part].    gr
-00002e90: 6f75 7065 645f 7061 7468 203d 205b 5d0a  ouped_path = [].
-00002ea0: 2020 2020 666f 7220 7061 7468 6e61 6d65      for pathname
-00002eb0: 2069 6e20 756e 676c 6f62 6c69 7a65 2874   in ungloblize(t
-00002ec0: 6f70 5f64 6972 293a 0a20 2020 2020 2020  op_dir):.       
-00002ed0: 2069 6620 6d61 6769 635f 7061 7274 3a0a   if magic_part:.
-00002ee0: 2020 2020 2020 2020 2020 2020 7061 7468              path
-00002ef0: 6e61 6d65 203d 2022 2f22 2e6a 6f69 6e28  name = "/".join(
-00002f00: 5b70 6174 686e 616d 652c 206d 6167 6963  [pathname, magic
-00002f10: 5f70 6172 745d 290a 2020 2020 2020 2020  _part]).        
-00002f20: 6772 6f75 7065 645f 7061 7468 2e61 7070  grouped_path.app
-00002f30: 656e 6428 7061 7468 6e61 6d65 290a 2020  end(pathname).  
-00002f40: 2020 7265 7475 726e 2067 726f 7570 6564    return grouped
-00002f50: 5f70 6174 680a 0a0a 6465 6620 5f62 6563  _path...def _bec
-00002f60: 6f6d 655f 7072 6566 6978 2870 7265 6669  ome_prefix(prefi
-00002f70: 783a 2073 7472 2920 2d3e 2073 7472 3a0a  x: str) -> str:.
-00002f80: 2020 2020 6966 2070 7265 6669 7820 213d      if prefix !=
-00002f90: 2027 2720 616e 6420 6e6f 7420 7072 6566   '' and not pref
-00002fa0: 6978 2e65 6e64 7377 6974 6828 272f 2729  ix.endswith('/')
-00002fb0: 3a0a 2020 2020 2020 2020 7072 6566 6978  :.        prefix
-00002fc0: 202b 3d20 272f 270a 2020 2020 7265 7475   += '/'.    retu
-00002fd0: 726e 2070 7265 6669 780a 0a0a 6465 6620  rn prefix...def 
-00002fe0: 5f73 335f 7370 6c69 745f 6d61 6769 6328  _s3_split_magic(
-00002ff0: 7333 5f70 6174 686e 616d 653a 2073 7472  s3_pathname: str
-00003000: 2920 2d3e 2054 7570 6c65 5b73 7472 2c20  ) -> Tuple[str, 
-00003010: 7374 725d 3a0a 2020 2020 6966 206e 6f74  str]:.    if not
-00003020: 2068 6173 5f6d 6167 6963 2873 335f 7061   has_magic(s3_pa
-00003030: 7468 6e61 6d65 293a 0a20 2020 2020 2020  thname):.       
-00003040: 2072 6574 7572 6e20 7333 5f70 6174 686e   return s3_pathn
-00003050: 616d 652c 2027 270a 2020 2020 6465 6c69  ame, ''.    deli
-00003060: 6d69 7465 7220 3d20 272f 270a 2020 2020  miter = '/'.    
-00003070: 6e6f 726d 616c 5f70 6172 7473 203d 205b  normal_parts = [
-00003080: 5d0a 2020 2020 6d61 6769 635f 7061 7274  ].    magic_part
-00003090: 7320 3d20 5b5d 0a20 2020 2061 6c6c 5f70  s = [].    all_p
-000030a0: 6172 7473 203d 2073 335f 7061 7468 6e61  arts = s3_pathna
-000030b0: 6d65 2e73 706c 6974 2864 656c 696d 6974  me.split(delimit
-000030c0: 6572 290a 2020 2020 666f 7220 692c 2070  er).    for i, p
-000030d0: 6172 7420 696e 2065 6e75 6d65 7261 7465  art in enumerate
-000030e0: 2861 6c6c 5f70 6172 7473 293a 0a20 2020  (all_parts):.   
-000030f0: 2020 2020 2069 6620 6e6f 7420 6861 735f       if not has_
-00003100: 6d61 6769 6328 7061 7274 293a 0a20 2020  magic(part):.   
-00003110: 2020 2020 2020 2020 206e 6f72 6d61 6c5f           normal_
-00003120: 7061 7274 732e 6170 7065 6e64 2870 6172  parts.append(par
-00003130: 7429 0a20 2020 2020 2020 2065 6c73 653a  t).        else:
-00003140: 0a20 2020 2020 2020 2020 2020 206d 6167  .            mag
-00003150: 6963 5f70 6172 7473 203d 2061 6c6c 5f70  ic_parts = all_p
-00003160: 6172 7473 5b69 3a5d 0a20 2020 2020 2020  arts[i:].       
-00003170: 2020 2020 2062 7265 616b 0a20 2020 2072       break.    r
-00003180: 6574 7572 6e20 6465 6c69 6d69 7465 722e  eturn delimiter.
-00003190: 6a6f 696e 286e 6f72 6d61 6c5f 7061 7274  join(normal_part
-000031a0: 7329 2c20 6465 6c69 6d69 7465 722e 6a6f  s), delimiter.jo
-000031b0: 696e 286d 6167 6963 5f70 6172 7473 290a  in(magic_parts).
-000031c0: 0a0a 6465 6620 5f6c 6973 745f 6f62 6a65  ..def _list_obje
-000031d0: 6374 735f 7265 6375 7273 6976 6528 0a20  cts_recursive(. 
-000031e0: 2020 2020 2020 2073 335f 636c 6965 6e74         s3_client
-000031f0: 2c20 6275 636b 6574 3a20 7374 722c 2070  , bucket: str, p
-00003200: 7265 6669 783a 2073 7472 2c20 6465 6c69  refix: str, deli
-00003210: 6d69 7465 723a 2073 7472 203d 2027 2729  miter: str = '')
-00003220: 3a0a 0a20 2020 2072 6573 7020 3d20 7333  :..    resp = s3
-00003230: 5f63 6c69 656e 742e 6c69 7374 5f6f 626a  _client.list_obj
-00003240: 6563 7473 5f76 3228 0a20 2020 2020 2020  ects_v2(.       
-00003250: 2042 7563 6b65 743d 6275 636b 6574 2c20   Bucket=bucket, 
-00003260: 5072 6566 6978 3d70 7265 6669 782c 2044  Prefix=prefix, D
-00003270: 656c 696d 6974 6572 3d64 656c 696d 6974  elimiter=delimit
-00003280: 6572 2c20 4d61 784b 6579 733d 6d61 785f  er, MaxKeys=max_
-00003290: 6b65 7973 290a 0a20 2020 2077 6869 6c65  keys)..    while
-000032a0: 2054 7275 653a 0a20 2020 2020 2020 2079   True:.        y
-000032b0: 6965 6c64 2072 6573 700a 0a20 2020 2020  ield resp..     
-000032c0: 2020 2069 6620 6e6f 7420 7265 7370 5b27     if not resp['
-000032d0: 4973 5472 756e 6361 7465 6427 5d3a 0a20  IsTruncated']:. 
-000032e0: 2020 2020 2020 2020 2020 2062 7265 616b             break
-000032f0: 0a0a 2020 2020 2020 2020 7265 7370 203d  ..        resp =
-00003300: 2073 335f 636c 6965 6e74 2e6c 6973 745f   s3_client.list_
-00003310: 6f62 6a65 6374 735f 7632 280a 2020 2020  objects_v2(.    
-00003320: 2020 2020 2020 2020 4275 636b 6574 3d62          Bucket=b
-00003330: 7563 6b65 742c 0a20 2020 2020 2020 2020  ucket,.         
-00003340: 2020 2050 7265 6669 783d 7072 6566 6978     Prefix=prefix
-00003350: 2c0a 2020 2020 2020 2020 2020 2020 4465  ,.            De
-00003360: 6c69 6d69 7465 723d 6465 6c69 6d69 7465  limiter=delimite
-00003370: 722c 0a20 2020 2020 2020 2020 2020 2043  r,.            C
-00003380: 6f6e 7469 6e75 6174 696f 6e54 6f6b 656e  ontinuationToken
-00003390: 3d72 6573 705b 274e 6578 7443 6f6e 7469  =resp['NextConti
-000033a0: 6e75 6174 696f 6e54 6f6b 656e 275d 2c0a  nuationToken'],.
-000033b0: 2020 2020 2020 2020 2020 2020 4d61 784b              MaxK
-000033c0: 6579 733d 6d61 785f 6b65 7973 290a 0a0a  eys=max_keys)...
-000033d0: 6465 6620 5f6d 616b 655f 7374 6174 2863  def _make_stat(c
-000033e0: 6f6e 7465 6e74 3a20 4469 6374 5b73 7472  ontent: Dict[str
-000033f0: 2c20 416e 795d 293a 0a20 2020 2072 6574  , Any]):.    ret
-00003400: 7572 6e20 5374 6174 5265 7375 6c74 280a  urn StatResult(.
-00003410: 2020 2020 2020 2020 6973 6c6e 6b3d 636f          islnk=co
-00003420: 6e74 656e 742e 6765 7428 2769 736c 6e6b  ntent.get('islnk
-00003430: 272c 2046 616c 7365 292c 0a20 2020 2020  ', False),.     
-00003440: 2020 2073 697a 653d 636f 6e74 656e 745b     size=content[
-00003450: 2753 697a 6527 5d2c 0a20 2020 2020 2020  'Size'],.       
-00003460: 206d 7469 6d65 3d63 6f6e 7465 6e74 5b27   mtime=content['
-00003470: 4c61 7374 4d6f 6469 6669 6564 275d 2e74  LastModified'].t
-00003480: 696d 6573 7461 6d70 2829 2c0a 2020 2020  imestamp(),.    
-00003490: 2020 2020 6578 7472 613d 636f 6e74 656e      extra=conten
-000034a0: 742c 0a20 2020 2029 0a0a 0a64 6566 205f  t,.    )...def _
-000034b0: 7333 5f67 6c6f 625f 7374 6174 5f73 696e  s3_glob_stat_sin
-000034c0: 676c 655f 7061 7468 280a 2020 2020 2020  gle_path(.      
-000034d0: 2020 7333 5f70 6174 686e 616d 653a 2050    s3_pathname: P
-000034e0: 6174 684c 696b 652c 0a20 2020 2020 2020  athLike,.       
-000034f0: 2072 6563 7572 7369 7665 3a20 626f 6f6c   recursive: bool
-00003500: 203d 2054 7275 652c 0a20 2020 2020 2020   = True,.       
-00003510: 206d 6973 7369 6e67 5f6f 6b3a 2062 6f6f   missing_ok: boo
-00003520: 6c20 3d20 5472 7565 2c0a 2020 2020 2020  l = True,.      
-00003530: 2020 666f 6c6c 6f77 6c69 6e6b 733a 2062    followlinks: b
-00003540: 6f6f 6c20 3d20 4661 6c73 6529 202d 3e20  ool = False) -> 
-00003550: 4974 6572 6174 6f72 5b46 696c 6545 6e74  Iterator[FileEnt
-00003560: 7279 5d3a 0a20 2020 2069 6620 6e6f 7420  ry]:.    if not 
-00003570: 7265 6375 7273 6976 653a 0a20 2020 2020  recursive:.     
-00003580: 2020 2023 2049 6620 6e6f 7420 7265 6375     # If not recu
-00003590: 7273 6976 652c 2072 6570 6c61 6365 202a  rsive, replace *
-000035a0: 2a20 7769 7468 202a 0a20 2020 2020 2020  * with *.       
-000035b0: 2073 335f 7061 7468 6e61 6d65 203d 2072   s3_pathname = r
-000035c0: 652e 7375 6228 7227 5c2a 7b32 2c7d 272c  e.sub(r'\*{2,}',
-000035d0: 2027 2a27 2c20 7333 5f70 6174 686e 616d   '*', s3_pathnam
-000035e0: 6529 0a20 2020 2074 6f70 5f64 6972 2c20  e).    top_dir, 
-000035f0: 7769 6c64 6361 7264 5f70 6172 7420 3d20  wildcard_part = 
-00003600: 5f73 335f 7370 6c69 745f 6d61 6769 6328  _s3_split_magic(
-00003610: 7333 5f70 6174 686e 616d 6529 0a20 2020  s3_pathname).   
-00003620: 2073 6561 7263 685f 6469 7220 3d20 7769   search_dir = wi
-00003630: 6c64 6361 7264 5f70 6172 742e 656e 6473  ldcard_part.ends
-00003640: 7769 7468 2827 2f27 290a 0a20 2020 2064  with('/')..    d
-00003650: 6566 2073 686f 756c 645f 7265 6375 7273  ef should_recurs
-00003660: 6976 6528 7769 6c64 6361 7264 5f70 6172  ive(wildcard_par
-00003670: 743a 2073 7472 2920 2d3e 2062 6f6f 6c3a  t: str) -> bool:
-00003680: 0a20 2020 2020 2020 2069 6620 272a 2a27  .        if '**'
-00003690: 2069 6e20 7769 6c64 6361 7264 5f70 6172   in wildcard_par
-000036a0: 743a 0a20 2020 2020 2020 2020 2020 2072  t:.            r
-000036b0: 6574 7572 6e20 5472 7565 0a20 2020 2020  eturn True.     
-000036c0: 2020 2066 6f72 2065 7870 616e 6465 645f     for expanded_
-000036d0: 7061 7468 2069 6e20 756e 676c 6f62 6c69  path in unglobli
-000036e0: 7a65 2877 696c 6463 6172 645f 7061 7274  ze(wildcard_part
-000036f0: 293a 0a20 2020 2020 2020 2020 2020 2070  ):.            p
-00003700: 6172 7473 5f6c 656e 6774 6820 3d20 6c65  arts_length = le
-00003710: 6e28 6578 7061 6e64 6564 5f70 6174 682e  n(expanded_path.
-00003720: 7370 6c69 7428 272f 2729 290a 2020 2020  split('/')).    
-00003730: 2020 2020 2020 2020 6966 2070 6172 7473          if parts
-00003740: 5f6c 656e 6774 6820 2b20 7365 6172 6368  _length + search
-00003750: 5f64 6972 203e 3d20 323a 0a20 2020 2020  _dir >= 2:.     
-00003760: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00003770: 6e20 5472 7565 0a20 2020 2020 2020 2072  n True.        r
-00003780: 6574 7572 6e20 4661 6c73 650a 0a20 2020  eturn False..   
-00003790: 2064 6566 2063 7265 6174 655f 6765 6e65   def create_gene
-000037a0: 7261 746f 7228 5f73 335f 7061 7468 6e61  rator(_s3_pathna
-000037b0: 6d65 2920 2d3e 2049 7465 7261 746f 725b  me) -> Iterator[
-000037c0: 4669 6c65 456e 7472 795d 3a0a 2020 2020  FileEntry]:.    
-000037d0: 2020 2020 6966 206e 6f74 2053 3350 6174      if not S3Pat
-000037e0: 6828 746f 705f 6469 7229 2e65 7869 7374  h(top_dir).exist
-000037f0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00003800: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-00003810: 6966 206e 6f74 2068 6173 5f6d 6167 6963  if not has_magic
-00003820: 285f 7333 5f70 6174 686e 616d 6529 3a0a  (_s3_pathname):.
-00003830: 2020 2020 2020 2020 2020 2020 5f73 335f              _s3_
-00003840: 7061 7468 6e61 6d65 5f6f 626a 203d 2053  pathname_obj = S
-00003850: 3350 6174 6828 5f73 335f 7061 7468 6e61  3Path(_s3_pathna
-00003860: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-00003870: 6966 205f 7333 5f70 6174 686e 616d 655f  if _s3_pathname_
-00003880: 6f62 6a2e 6973 5f66 696c 6528 293a 0a20  obj.is_file():. 
-00003890: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000038a0: 7461 7420 3d20 5333 5061 7468 285f 7333  tat = S3Path(_s3
-000038b0: 5f70 6174 686e 616d 6529 2e73 7461 7428  _pathname).stat(
-000038c0: 666f 6c6c 6f77 5f73 796d 6c69 6e6b 733d  follow_symlinks=
-000038d0: 666f 6c6c 6f77 6c69 6e6b 7329 0a20 2020  followlinks).   
-000038e0: 2020 2020 2020 2020 2020 2020 2079 6965               yie
-000038f0: 6c64 2046 696c 6545 6e74 7279 280a 2020  ld FileEntry(.  
-00003900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003910: 2020 5f73 335f 7061 7468 6e61 6d65 5f6f    _s3_pathname_o
-00003920: 626a 2e6e 616d 652c 205f 7333 5f70 6174  bj.name, _s3_pat
-00003930: 686e 616d 655f 6f62 6a2e 7061 7468 2c20  hname_obj.path, 
-00003940: 7374 6174 290a 2020 2020 2020 2020 2020  stat).          
-00003950: 2020 6966 205f 7333 5f70 6174 686e 616d    if _s3_pathnam
-00003960: 655f 6f62 6a2e 6973 5f64 6972 2829 3a0a  e_obj.is_dir():.
-00003970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003980: 7969 656c 6420 4669 6c65 456e 7472 7928  yield FileEntry(
-00003990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000039a0: 2020 2020 205f 7333 5f70 6174 686e 616d       _s3_pathnam
-000039b0: 655f 6f62 6a2e 6e61 6d65 2c20 5f73 335f  e_obj.name, _s3_
-000039c0: 7061 7468 6e61 6d65 5f6f 626a 2e70 6174  pathname_obj.pat
-000039d0: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
-000039e0: 2020 2020 2020 2053 7461 7452 6573 756c         StatResul
-000039f0: 7428 6973 6469 723d 5472 7565 2929 0a20  t(isdir=True)). 
-00003a00: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00003a10: 6e0a 0a20 2020 2020 2020 2064 656c 696d  n..        delim
-00003a20: 6974 6572 203d 2027 270a 2020 2020 2020  iter = ''.      
-00003a30: 2020 6966 206e 6f74 2073 686f 756c 645f    if not should_
-00003a40: 7265 6375 7273 6976 6528 7769 6c64 6361  recursive(wildca
-00003a50: 7264 5f70 6172 7429 3a0a 2020 2020 2020  rd_part):.      
-00003a60: 2020 2020 2020 6465 6c69 6d69 7465 7220        delimiter 
-00003a70: 3d20 272f 270a 0a20 2020 2020 2020 2064  = '/'..        d
-00003a80: 6972 6e61 6d65 7320 3d20 7365 7428 290a  irnames = set().
-00003a90: 2020 2020 2020 2020 7061 7474 6572 6e20          pattern 
-00003aa0: 3d20 7265 2e63 6f6d 7069 6c65 2874 7261  = re.compile(tra
-00003ab0: 6e73 6c61 7465 285f 7333 5f70 6174 686e  nslate(_s3_pathn
-00003ac0: 616d 6529 290a 2020 2020 2020 2020 6275  ame)).        bu
-00003ad0: 636b 6574 2c20 6b65 7920 3d20 7061 7273  cket, key = pars
-00003ae0: 655f 7333 5f75 726c 2874 6f70 5f64 6972  e_s3_url(top_dir
-00003af0: 290a 2020 2020 2020 2020 7072 6566 6978  ).        prefix
-00003b00: 203d 205f 6265 636f 6d65 5f70 7265 6669   = _become_prefi
-00003b10: 7828 6b65 7929 0a20 2020 2020 2020 2063  x(key).        c
-00003b20: 6c69 656e 7420 3d20 6765 745f 7333 5f63  lient = get_s3_c
-00003b30: 6c69 656e 7428 290a 2020 2020 2020 2020  lient().        
-00003b40: 7769 7468 2072 6169 7365 5f73 335f 6572  with raise_s3_er
-00003b50: 726f 7228 5f73 335f 7061 7468 6e61 6d65  ror(_s3_pathname
-00003b60: 293a 0a20 2020 2020 2020 2020 2020 2066  ):.            f
-00003b70: 6f72 2072 6573 7020 696e 205f 6c69 7374  or resp in _list
-00003b80: 5f6f 626a 6563 7473 5f72 6563 7572 7369  _objects_recursi
-00003b90: 7665 2863 6c69 656e 742c 2062 7563 6b65  ve(client, bucke
-00003ba0: 742c 2070 7265 6669 782c 0a20 2020 2020  t, prefix,.     
-00003bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000010: 6d70 6f72 7420 696f 0a69 6d70 6f72 7420  mport io.import 
+00000020: 6f73 0a69 6d70 6f72 7420 7265 0a69 6d70  os.import re.imp
+00000030: 6f72 7420 7469 6d65 0a66 726f 6d20 636f  ort time.from co
+00000040: 6e63 7572 7265 6e74 2e66 7574 7572 6573  ncurrent.futures
+00000050: 2069 6d70 6f72 7420 5468 7265 6164 506f   import ThreadPo
+00000060: 6f6c 4578 6563 7574 6f72 0a66 726f 6d20  olExecutor.from 
+00000070: 6675 6e63 746f 6f6c 7320 696d 706f 7274  functools import
+00000080: 206c 7275 5f63 6163 6865 2c20 7772 6170   lru_cache, wrap
+00000090: 730a 6672 6f6d 206c 6f67 6769 6e67 2069  s.from logging i
+000000a0: 6d70 6f72 7420 6765 744c 6f67 6765 7220  mport getLogger 
+000000b0: 6173 2067 6574 5f6c 6f67 6765 720a 6672  as get_logger.fr
+000000c0: 6f6d 2074 7970 696e 6720 696d 706f 7274  om typing import
+000000d0: 2049 4f2c 2041 6e79 2c20 416e 7953 7472   IO, Any, AnyStr
+000000e0: 2c20 4269 6e61 7279 494f 2c20 4361 6c6c  , BinaryIO, Call
+000000f0: 6162 6c65 2c20 4469 6374 2c20 4974 6572  able, Dict, Iter
+00000100: 6174 6f72 2c20 4c69 7374 2c20 4f70 7469  ator, List, Opti
+00000110: 6f6e 616c 2c20 5475 706c 652c 2055 6e69  onal, Tuple, Uni
+00000120: 6f6e 0a66 726f 6d20 7572 6c6c 6962 2e70  on.from urllib.p
+00000130: 6172 7365 2069 6d70 6f72 7420 7572 6c73  arse import urls
+00000140: 706c 6974 0a0a 696d 706f 7274 2062 6f74  plit..import bot
+00000150: 6f33 0a69 6d70 6f72 7420 626f 746f 636f  o3.import botoco
+00000160: 7265 0a66 726f 6d20 626f 746f 636f 7265  re.from botocore
+00000170: 2e61 7773 7265 7175 6573 7420 696d 706f  .awsrequest impo
+00000180: 7274 2041 5753 5265 7370 6f6e 7365 0a0a  rt AWSResponse..
+00000190: 6672 6f6d 206d 6567 6669 6c65 2e65 7272  from megfile.err
+000001a0: 6f72 7320 696d 706f 7274 2053 3342 7563  ors import S3Buc
+000001b0: 6b65 744e 6f74 466f 756e 6445 7272 6f72  ketNotFoundError
+000001c0: 2c20 5333 436f 6e66 6967 4572 726f 722c  , S3ConfigError,
+000001d0: 2053 3346 696c 6545 7869 7374 7345 7272   S3FileExistsErr
+000001e0: 6f72 2c20 5333 4669 6c65 4e6f 7446 6f75  or, S3FileNotFou
+000001f0: 6e64 4572 726f 722c 2053 3349 7341 4469  ndError, S3IsADi
+00000200: 7265 6374 6f72 7945 7272 6f72 2c20 5333  rectoryError, S3
+00000210: 4e61 6d65 546f 6f4c 6f6e 6745 7272 6f72  NameTooLongError
+00000220: 2c20 5333 4e6f 7441 4469 7265 6374 6f72  , S3NotADirector
+00000230: 7945 7272 6f72 2c20 5333 4e6f 7441 4c69  yError, S3NotALi
+00000240: 6e6b 4572 726f 722c 2053 3350 6572 6d69  nkError, S3Permi
+00000250: 7373 696f 6e45 7272 6f72 2c20 5333 556e  ssionError, S3Un
+00000260: 6b6e 6f77 6e45 7272 6f72 2c20 556e 7375  knownError, Unsu
+00000270: 7070 6f72 7465 6445 7272 6f72 2c20 5f63  pportedError, _c
+00000280: 7265 6174 655f 6d69 7373 696e 675f 6f6b  reate_missing_ok
+00000290: 5f67 656e 6572 6174 6f72 0a66 726f 6d20  _generator.from 
+000002a0: 6d65 6766 696c 652e 6572 726f 7273 2069  megfile.errors i
+000002b0: 6d70 6f72 7420 5f6c 6f67 6765 7220 6173  mport _logger as
+000002c0: 2065 7272 6f72 5f6c 6f67 6765 720a 6672   error_logger.fr
+000002d0: 6f6d 206d 6567 6669 6c65 2e65 7272 6f72  om megfile.error
+000002e0: 7320 696d 706f 7274 2070 6174 6368 5f6d  s import patch_m
+000002f0: 6574 686f 642c 2072 6169 7365 5f73 335f  ethod, raise_s3_
+00000300: 6572 726f 722c 2073 335f 6572 726f 725f  error, s3_error_
+00000310: 636f 6465 5f73 686f 756c 645f 7265 7472  code_should_retr
+00000320: 792c 2073 335f 7368 6f75 6c64 5f72 6574  y, s3_should_ret
+00000330: 7279 2c20 7472 616e 736c 6174 655f 6673  ry, translate_fs
+00000340: 5f65 7272 6f72 2c20 7472 616e 736c 6174  _error, translat
+00000350: 655f 7333 5f65 7272 6f72 0a66 726f 6d20  e_s3_error.from 
+00000360: 6d65 6766 696c 652e 696e 7465 7266 6163  megfile.interfac
+00000370: 6573 2069 6d70 6f72 7420 4163 6365 7373  es import Access
+00000380: 2c20 436f 6e74 6578 7449 7465 7261 746f  , ContextIterato
+00000390: 722c 2046 696c 6543 6163 6865 722c 2046  r, FileCacher, F
+000003a0: 696c 6545 6e74 7279 2c20 5061 7468 4c69  ileEntry, PathLi
+000003b0: 6b65 2c20 5374 6174 5265 7375 6c74 2c20  ke, StatResult, 
+000003c0: 5552 4950 6174 680a 6672 6f6d 206d 6567  URIPath.from meg
+000003d0: 6669 6c65 2e6c 6962 2e63 6f6d 7061 7420  file.lib.compat 
+000003e0: 696d 706f 7274 2066 7370 6174 680a 6672  import fspath.fr
+000003f0: 6f6d 206d 6567 6669 6c65 2e6c 6962 2e66  om megfile.lib.f
+00000400: 6e6d 6174 6368 2069 6d70 6f72 7420 7472  nmatch import tr
+00000410: 616e 736c 6174 650a 6672 6f6d 206d 6567  anslate.from meg
+00000420: 6669 6c65 2e6c 6962 2e67 6c6f 6220 696d  file.lib.glob im
+00000430: 706f 7274 2068 6173 5f6d 6167 6963 2c20  port has_magic, 
+00000440: 6861 735f 6d61 6769 635f 6967 6e6f 7265  has_magic_ignore
+00000450: 5f62 7261 6365 2c20 756e 676c 6f62 6c69  _brace, unglobli
+00000460: 7a65 0a66 726f 6d20 6d65 6766 696c 652e  ze.from megfile.
+00000470: 6c69 622e 6a6f 696e 7061 7468 2069 6d70  lib.joinpath imp
+00000480: 6f72 7420 7572 695f 6a6f 696e 0a66 726f  ort uri_join.fro
+00000490: 6d20 6d65 6766 696c 652e 6c69 622e 7333  m megfile.lib.s3
+000004a0: 5f62 7566 6665 7265 645f 7772 6974 6572  _buffered_writer
+000004b0: 2069 6d70 6f72 7420 4445 4641 554c 545f   import DEFAULT_
+000004c0: 4d41 585f 4255 4646 4552 5f53 495a 452c  MAX_BUFFER_SIZE,
+000004d0: 2047 4c4f 4241 4c5f 4d41 585f 574f 524b   GLOBAL_MAX_WORK
+000004e0: 4552 532c 2053 3342 7566 6665 7265 6457  ERS, S3BufferedW
+000004f0: 7269 7465 720a 6672 6f6d 206d 6567 6669  riter.from megfi
+00000500: 6c65 2e6c 6962 2e73 335f 6361 6368 6564  le.lib.s3_cached
+00000510: 5f68 616e 646c 6572 2069 6d70 6f72 7420  _handler import 
+00000520: 5333 4361 6368 6564 4861 6e64 6c65 720a  S3CachedHandler.
+00000530: 6672 6f6d 206d 6567 6669 6c65 2e6c 6962  from megfile.lib
+00000540: 2e73 335f 6c69 6d69 7465 645f 7365 656b  .s3_limited_seek
+00000550: 6162 6c65 5f77 7269 7465 7220 696d 706f  able_writer impo
+00000560: 7274 2053 334c 696d 6974 6564 5365 656b  rt S3LimitedSeek
+00000570: 6162 6c65 5772 6974 6572 0a66 726f 6d20  ableWriter.from 
+00000580: 6d65 6766 696c 652e 6c69 622e 7333 5f6d  megfile.lib.s3_m
+00000590: 656d 6f72 795f 6861 6e64 6c65 7220 696d  emory_handler im
+000005a0: 706f 7274 2053 334d 656d 6f72 7948 616e  port S3MemoryHan
+000005b0: 646c 6572 0a66 726f 6d20 6d65 6766 696c  dler.from megfil
+000005c0: 652e 6c69 622e 7333 5f70 6970 655f 6861  e.lib.s3_pipe_ha
+000005d0: 6e64 6c65 7220 696d 706f 7274 2053 3350  ndler import S3P
+000005e0: 6970 6548 616e 646c 6572 0a66 726f 6d20  ipeHandler.from 
+000005f0: 6d65 6766 696c 652e 6c69 622e 7333 5f70  megfile.lib.s3_p
+00000600: 7265 6665 7463 685f 7265 6164 6572 2069  refetch_reader i
+00000610: 6d70 6f72 7420 4445 4641 554c 545f 424c  mport DEFAULT_BL
+00000620: 4f43 4b5f 5349 5a45 2c20 5333 5072 6566  OCK_SIZE, S3Pref
+00000630: 6574 6368 5265 6164 6572 0a66 726f 6d20  etchReader.from 
+00000640: 6d65 6766 696c 652e 6c69 622e 7333 5f73  megfile.lib.s3_s
+00000650: 6861 7265 5f63 6163 6865 5f72 6561 6465  hare_cache_reade
+00000660: 7220 696d 706f 7274 2053 3353 6861 7265  r import S3Share
+00000670: 4361 6368 6552 6561 6465 720a 6672 6f6d  CacheReader.from
+00000680: 206d 6567 6669 6c65 2e73 6d61 7274 5f70   megfile.smart_p
+00000690: 6174 6820 696d 706f 7274 2053 6d61 7274  ath import Smart
+000006a0: 5061 7468 0a66 726f 6d20 6d65 6766 696c  Path.from megfil
+000006b0: 652e 7574 696c 7320 696d 706f 7274 2063  e.utils import c
+000006c0: 6163 6865 6470 726f 7065 7274 792c 2063  achedproperty, c
+000006d0: 616c 6375 6c61 7465 5f6d 6435 2c20 6765  alculate_md5, ge
+000006e0: 6e65 7261 7465 5f63 6163 6865 5f70 6174  nerate_cache_pat
+000006f0: 682c 2067 6574 5f62 696e 6172 795f 6d6f  h, get_binary_mo
+00000700: 6465 2c20 6765 745f 636f 6e74 656e 745f  de, get_content_
+00000710: 6f66 6673 6574 2c20 6973 5f72 6561 6461  offset, is_reada
+00000720: 626c 652c 206e 6563 6573 7361 7279 5f70  ble, necessary_p
+00000730: 6172 616d 732c 2074 6872 6561 645f 6c6f  arams, thread_lo
+00000740: 6361 6c0a 0a5f 5f61 6c6c 5f5f 203d 205b  cal..__all__ = [
+00000750: 0a20 2020 2027 5333 5061 7468 272c 0a20  .    'S3Path',. 
+00000760: 2020 2027 7061 7273 655f 7333 5f75 726c     'parse_s3_url
+00000770: 272c 0a20 2020 2027 6765 745f 656e 6470  ',.    'get_endp
+00000780: 6f69 6e74 5f75 726c 272c 0a20 2020 2027  oint_url',.    '
+00000790: 6765 745f 7333 5f73 6573 7369 6f6e 272c  get_s3_session',
+000007a0: 0a20 2020 2027 6765 745f 7333 5f63 6c69  .    'get_s3_cli
+000007b0: 656e 7427 2c0a 2020 2020 2773 335f 7061  ent',.    's3_pa
+000007c0: 7468 5f6a 6f69 6e27 2c0a 2020 2020 2769  th_join',.    'i
+000007d0: 735f 7333 272c 0a20 2020 2027 7333 5f62  s_s3',.    's3_b
+000007e0: 7566 6665 7265 645f 6f70 656e 272c 0a20  uffered_open',. 
+000007f0: 2020 2027 7333 5f63 6163 6865 645f 6f70     's3_cached_op
+00000800: 656e 272c 0a20 2020 2027 7333 5f64 6f77  en',.    's3_dow
+00000810: 6e6c 6f61 6427 2c0a 2020 2020 2773 335f  nload',.    's3_
+00000820: 6d65 6d6f 7279 5f6f 7065 6e27 2c0a 2020  memory_open',.  
+00000830: 2020 2773 335f 7069 7065 5f6f 7065 6e27    's3_pipe_open'
+00000840: 2c0a 2020 2020 2773 335f 7072 6566 6574  ,.    's3_prefet
+00000850: 6368 5f6f 7065 6e27 2c0a 2020 2020 2773  ch_open',.    's
+00000860: 335f 7368 6172 655f 6361 6368 655f 6f70  3_share_cache_op
+00000870: 656e 272c 0a20 2020 2027 7333 5f6f 7065  en',.    's3_ope
+00000880: 6e27 2c0a 2020 2020 2753 3343 6163 6865  n',.    'S3Cache
+00000890: 7227 2c0a 2020 2020 2753 3342 7566 6665  r',.    'S3Buffe
+000008a0: 7265 6457 7269 7465 7227 2c0a 2020 2020  redWriter',.    
+000008b0: 2753 334c 696d 6974 6564 5365 656b 6162  'S3LimitedSeekab
+000008c0: 6c65 5772 6974 6572 272c 0a20 2020 2027  leWriter',.    '
+000008d0: 5333 5072 6566 6574 6368 5265 6164 6572  S3PrefetchReader
+000008e0: 272c 0a20 2020 2027 5333 5368 6172 6543  ',.    'S3ShareC
+000008f0: 6163 6865 5265 6164 6572 272c 0a20 2020  acheReader',.   
+00000900: 2027 7333 5f75 706c 6f61 6427 2c0a 2020   's3_upload',.  
+00000910: 2020 2773 335f 646f 776e 6c6f 6164 272c    's3_download',
+00000920: 0a20 2020 2027 7333 5f6c 6f61 645f 636f  .    's3_load_co
+00000930: 6e74 656e 7427 2c0a 2020 2020 2773 335f  ntent',.    's3_
+00000940: 7265 6164 6c69 6e6b 272c 0a20 2020 2027  readlink',.    '
+00000950: 7333 5f67 6c6f 6227 2c0a 2020 2020 2773  s3_glob',.    's
+00000960: 335f 676c 6f62 5f73 7461 7427 2c0a 2020  3_glob_stat',.  
+00000970: 2020 2773 335f 6967 6c6f 6227 2c0a 2020    's3_iglob',.  
+00000980: 2020 2773 335f 7265 6e61 6d65 272c 0a20    's3_rename',. 
+00000990: 2020 2027 7333 5f6d 616b 6564 6972 7327     's3_makedirs'
+000009a0: 2c0a 2020 2020 2773 335f 636f 6e63 6174  ,.    's3_concat
+000009b0: 272c 0a5d 0a5f 6c6f 6767 6572 203d 2067  ',.]._logger = g
+000009c0: 6574 5f6c 6f67 6765 7228 5f5f 6e61 6d65  et_logger(__name
+000009d0: 5f5f 290a 636f 6e74 656e 745f 6d64 355f  __).content_md5_
+000009e0: 6865 6164 6572 203d 2027 6d65 6766 696c  header = 'megfil
+000009f0: 652d 636f 6e74 656e 742d 6d64 3527 0a65  e-content-md5'.e
+00000a00: 6e64 706f 696e 745f 7572 6c20 3d20 2768  ndpoint_url = 'h
+00000a10: 7474 7073 3a2f 2f73 332e 616d 617a 6f6e  ttps://s3.amazon
+00000a20: 6177 732e 636f 6d27 0a6d 6178 5f70 6f6f  aws.com'.max_poo
+00000a30: 6c5f 636f 6e6e 6563 7469 6f6e 7320 3d20  l_connections = 
+00000a40: 3332 0a6d 6178 5f72 6574 7269 6573 203d  32.max_retries =
+00000a50: 2031 300a 6d61 785f 6b65 7973 203d 2031   10.max_keys = 1
+00000a60: 3030 300a 0a0a 6465 6620 5f70 6174 6368  000...def _patch
+00000a70: 5f6d 616b 655f 7265 7175 6573 7428 636c  _make_request(cl
+00000a80: 6965 6e74 3a20 626f 746f 636f 7265 2e63  ient: botocore.c
+00000a90: 6c69 656e 742e 4261 7365 436c 6965 6e74  lient.BaseClient
+00000aa0: 293a 0a0a 2020 2020 6465 6620 6166 7465  ):..    def afte
+00000ab0: 725f 6361 6c6c 6261 636b 2872 6573 756c  r_callback(resul
+00000ac0: 743a 2054 7570 6c65 5b41 5753 5265 7370  t: Tuple[AWSResp
+00000ad0: 6f6e 7365 2c20 6469 6374 5d2c 202a 6172  onse, dict], *ar
+00000ae0: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
+00000af0: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
+00000b00: 696e 7374 616e 6365 2872 6573 756c 742c  instance(result,
+00000b10: 2074 7570 6c65 2920 6f72 206c 656e 2872   tuple) or len(r
+00000b20: 6573 756c 7429 2021 3d20 3220 5c0a 2020  esult) != 2 \.  
+00000b30: 2020 2020 2020 2020 2020 6f72 206e 6f74            or not
+00000b40: 2069 7369 6e73 7461 6e63 6528 7265 7375   isinstance(resu
+00000b50: 6c74 5b30 5d2c 2041 5753 5265 7370 6f6e  lt[0], AWSRespon
+00000b60: 7365 2920 6f72 206e 6f74 2069 7369 6e73  se) or not isins
+00000b70: 7461 6e63 6528 7265 7375 6c74 5b31 5d2c  tance(result[1],
+00000b80: 2064 6963 7429 3a0a 2020 2020 2020 2020   dict):.        
+00000b90: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+00000ba0: 740a 2020 2020 2020 2020 6874 7470 2c20  t.        http, 
+00000bb0: 7061 7273 6564 5f72 6573 706f 6e73 6520  parsed_response 
+00000bc0: 3d20 7265 7375 6c74 0a20 2020 2020 2020  = result.       
+00000bd0: 2069 6620 6874 7470 2e73 7461 7475 735f   if http.status_
+00000be0: 636f 6465 203e 3d20 3530 303a 0a20 2020  code >= 500:.   
+00000bf0: 2020 2020 2020 2020 2065 7272 6f72 5f63           error_c
+00000c00: 6f64 6520 3d20 7061 7273 6564 5f72 6573  ode = parsed_res
+00000c10: 706f 6e73 652e 6765 7428 2245 7272 6f72  ponse.get("Error
+00000c20: 222c 207b 7d29 2e67 6574 2822 436f 6465  ", {}).get("Code
+00000c30: 2229 0a20 2020 2020 2020 2020 2020 206f  ").            o
+00000c40: 7065 7261 7469 6f6e 5f6d 6f64 656c 203d  peration_model =
+00000c50: 206b 7761 7267 732e 6765 7428 276f 7065   kwargs.get('ope
+00000c60: 7261 7469 6f6e 5f6d 6f64 656c 2729 206f  ration_model') o
+00000c70: 7220 280a 2020 2020 2020 2020 2020 2020  r (.            
+00000c80: 2020 2020 6172 6773 5b30 5d20 6966 2061      args[0] if a
+00000c90: 7267 7320 656c 7365 204e 6f6e 6529 0a20  rgs else None). 
+00000ca0: 2020 2020 2020 2020 2020 206f 7065 7261             opera
+00000cb0: 7469 6f6e 5f6e 616d 6520 3d20 6f70 6572  tion_name = oper
+00000cc0: 6174 696f 6e5f 6d6f 6465 6c2e 6e61 6d65  ation_model.name
+00000cd0: 2069 6620 6f70 6572 6174 696f 6e5f 6d6f   if operation_mo
+00000ce0: 6465 6c20 656c 7365 2027 5072 6f78 794d  del else 'ProxyM
+00000cf0: 6574 686f 6427 0a20 2020 2020 2020 2020  ethod'.         
+00000d00: 2020 2065 7272 6f72 5f63 6c61 7373 203d     error_class =
+00000d10: 2063 6c69 656e 742e 6578 6365 7074 696f   client.exceptio
+00000d20: 6e73 2e66 726f 6d5f 636f 6465 2865 7272  ns.from_code(err
+00000d30: 6f72 5f63 6f64 6529 0a20 2020 2020 2020  or_code).       
+00000d40: 2020 2020 2072 6169 7365 2065 7272 6f72       raise error
+00000d50: 5f63 6c61 7373 2870 6172 7365 645f 7265  _class(parsed_re
+00000d60: 7370 6f6e 7365 2c20 6f70 6572 6174 696f  sponse, operatio
+00000d70: 6e5f 6e61 6d65 290a 2020 2020 2020 2020  n_name).        
+00000d80: 7265 7475 726e 2072 6573 756c 740a 0a20  return result.. 
+00000d90: 2020 2064 6566 2072 6574 7279 5f63 616c     def retry_cal
+00000da0: 6c62 6163 6b28 6572 726f 722c 206f 7065  lback(error, ope
+00000db0: 7261 7469 6f6e 5f6d 6f64 656c 2c20 7265  ration_model, re
+00000dc0: 7175 6573 745f 6469 6374 2c20 7265 7175  quest_dict, requ
+00000dd0: 6573 745f 636f 6e74 6578 7429 3a0a 2020  est_context):.  
+00000de0: 2020 2020 2020 6966 2065 7272 6f72 2069        if error i
+00000df0: 7320 4e6f 6e65 3a20 2023 2072 6574 7279  s None:  # retry
+00000e00: 2066 6f72 2074 6865 2066 6972 7374 2074   for the first t
+00000e10: 696d 650a 2020 2020 2020 2020 2020 2020  ime.            
+00000e20: 6572 726f 725f 6c6f 6767 6572 2e64 6562  error_logger.deb
+00000e30: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+00000e40: 2020 2020 2766 6169 6c65 6420 746f 2070      'failed to p
+00000e50: 726f 6365 7373 3a20 2572 2c20 7769 7468  rocess: %r, with
+00000e60: 2070 6172 616d 6574 6572 733a 2025 7327   parameters: %s'
+00000e70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00000e80: 2020 6f70 6572 6174 696f 6e5f 6d6f 6465    operation_mode
+00000e90: 6c2e 6e61 6d65 2c20 7265 7175 6573 745f  l.name, request_
+00000ea0: 6469 6374 290a 2020 2020 2020 2020 6966  dict).        if
+00000eb0: 2069 735f 7265 6164 6162 6c65 2872 6571   is_readable(req
+00000ec0: 7565 7374 5f64 6963 745b 2762 6f64 7927  uest_dict['body'
+00000ed0: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
+00000ee0: 7265 7175 6573 745f 6469 6374 5b27 626f  request_dict['bo
+00000ef0: 6479 275d 2e73 6565 6b28 3029 0a0a 2020  dy'].seek(0)..  
+00000f00: 2020 6465 6620 6265 666f 7265 5f63 616c    def before_cal
+00000f10: 6c62 6163 6b28 6f70 6572 6174 696f 6e5f  lback(operation_
+00000f20: 6d6f 6465 6c2c 2072 6571 7565 7374 5f64  model, request_d
+00000f30: 6963 742c 2072 6571 7565 7374 5f63 6f6e  ict, request_con
+00000f40: 7465 7874 293a 0a20 2020 2020 2020 205f  text):.        _
+00000f50: 6c6f 6767 6572 2e64 6562 7567 280a 2020  logger.debug(.  
+00000f60: 2020 2020 2020 2020 2020 2773 656e 6420            'send 
+00000f70: 7333 2072 6571 7565 7374 3a20 2572 2c20  s3 request: %r, 
+00000f80: 7769 7468 2070 6172 616d 6574 6572 733a  with parameters:
+00000f90: 2025 7327 2c20 6f70 6572 6174 696f 6e5f   %s', operation_
+00000fa0: 6d6f 6465 6c2e 6e61 6d65 2c0a 2020 2020  model.name,.    
+00000fb0: 2020 2020 2020 2020 7265 7175 6573 745f          request_
+00000fc0: 6469 6374 290a 0a20 2020 2063 6c69 656e  dict)..    clien
+00000fd0: 742e 5f6d 616b 655f 7265 7175 6573 7420  t._make_request 
+00000fe0: 3d20 7061 7463 685f 6d65 7468 6f64 280a  = patch_method(.
+00000ff0: 2020 2020 2020 2020 636c 6965 6e74 2e5f          client._
+00001000: 6d61 6b65 5f72 6571 7565 7374 2c0a 2020  make_request,.  
+00001010: 2020 2020 2020 6d61 785f 7265 7472 6965        max_retrie
+00001020: 733d 6d61 785f 7265 7472 6965 732c 0a20  s=max_retries,. 
+00001030: 2020 2020 2020 2073 686f 756c 645f 7265         should_re
+00001040: 7472 793d 7333 5f73 686f 756c 645f 7265  try=s3_should_re
+00001050: 7472 792c 0a20 2020 2020 2020 2061 6674  try,.        aft
+00001060: 6572 5f63 616c 6c62 6163 6b3d 6166 7465  er_callback=afte
+00001070: 725f 6361 6c6c 6261 636b 2c0a 2020 2020  r_callback,.    
+00001080: 2020 2020 6265 666f 7265 5f63 616c 6c62      before_callb
+00001090: 6163 6b3d 6265 666f 7265 5f63 616c 6c62  ack=before_callb
+000010a0: 6163 6b2c 0a20 2020 2020 2020 2072 6574  ack,.        ret
+000010b0: 7279 5f63 616c 6c62 6163 6b3d 7265 7472  ry_callback=retr
+000010c0: 795f 6361 6c6c 6261 636b 290a 2020 2020  y_callback).    
+000010d0: 7265 7475 726e 2063 6c69 656e 740a 0a0a  return client...
+000010e0: 6465 6620 7061 7273 655f 7333 5f75 726c  def parse_s3_url
+000010f0: 2873 335f 7572 6c3a 2050 6174 684c 696b  (s3_url: PathLik
+00001100: 6529 202d 3e20 5475 706c 655b 7374 722c  e) -> Tuple[str,
+00001110: 2073 7472 5d3a 0a20 2020 2073 335f 7572   str]:.    s3_ur
+00001120: 6c20 3d20 6673 7061 7468 2873 335f 7572  l = fspath(s3_ur
+00001130: 6c29 0a20 2020 2069 6620 6e6f 7420 6973  l).    if not is
+00001140: 5f73 3328 7333 5f75 726c 293a 0a20 2020  _s3(s3_url):.   
+00001150: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00001160: 4572 726f 7228 274e 6f74 2061 2073 3320  Error('Not a s3 
+00001170: 7572 6c3a 2025 7227 2025 2073 335f 7572  url: %r' % s3_ur
+00001180: 6c29 0a20 2020 2072 6967 6874 7061 7274  l).    rightpart
+00001190: 203d 2073 335f 7572 6c2e 7370 6c69 7428   = s3_url.split(
+000011a0: 273a 2f2f 272c 206d 6178 7370 6c69 743d  '://', maxsplit=
+000011b0: 3129 5b31 5d0a 2020 2020 6275 636b 6574  1)[1].    bucket
+000011c0: 6d61 7463 6820 3d20 7265 2e6d 6174 6368  match = re.match
+000011d0: 2827 282e 2a3f 292f 272c 2072 6967 6874  ('(.*?)/', right
+000011e0: 7061 7274 290a 2020 2020 6966 2062 7563  part).    if buc
+000011f0: 6b65 746d 6174 6368 2069 7320 4e6f 6e65  ketmatch is None
+00001200: 3a0a 2020 2020 2020 2020 6275 636b 6574  :.        bucket
+00001210: 203d 2072 6967 6874 7061 7274 0a20 2020   = rightpart.   
+00001220: 2020 2020 2070 6174 6820 3d20 2727 0a20       path = ''. 
+00001230: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00001240: 2062 7563 6b65 7420 3d20 6275 636b 6574   bucket = bucket
+00001250: 6d61 7463 682e 6772 6f75 7028 3129 0a20  match.group(1). 
+00001260: 2020 2020 2020 2070 6174 6820 3d20 7269         path = ri
+00001270: 6768 7470 6172 745b 6c65 6e28 6275 636b  ghtpart[len(buck
+00001280: 6574 2920 2b20 313a 5d0a 2020 2020 7265  et) + 1:].    re
+00001290: 7475 726e 2062 7563 6b65 742c 2070 6174  turn bucket, pat
+000012a0: 680a 0a0a 6465 6620 6765 745f 7363 6f70  h...def get_scop
+000012b0: 6564 5f63 6f6e 6669 6728 7072 6f66 696c  ed_config(profil
+000012c0: 655f 6e61 6d65 3a20 4f70 7469 6f6e 616c  e_name: Optional
+000012d0: 5b73 7472 5d20 3d20 4e6f 6e65 2920 2d3e  [str] = None) ->
+000012e0: 2044 6963 743a 0a20 2020 2072 6574 7572   Dict:.    retur
+000012f0: 6e20 6765 745f 7333 5f73 6573 7369 6f6e  n get_s3_session
+00001300: 280a 2020 2020 2020 2020 7072 6f66 696c  (.        profil
+00001310: 655f 6e61 6d65 3d70 726f 6669 6c65 5f6e  e_name=profile_n
+00001320: 616d 6529 2e5f 7365 7373 696f 6e2e 6765  ame)._session.ge
+00001330: 745f 7363 6f70 6564 5f63 6f6e 6669 6728  t_scoped_config(
+00001340: 290a 0a0a 6465 6620 6765 745f 656e 6470  )...def get_endp
+00001350: 6f69 6e74 5f75 726c 2870 726f 6669 6c65  oint_url(profile
+00001360: 5f6e 616d 653a 204f 7074 696f 6e61 6c5b  _name: Optional[
+00001370: 7374 725d 203d 204e 6f6e 6529 202d 3e20  str] = None) -> 
+00001380: 7374 723a 0a20 2020 2027 2727 4765 7420  str:.    '''Get 
+00001390: 7468 6520 656e 6470 6f69 6e74 2075 726c  the endpoint url
+000013a0: 206f 6620 5333 0a0a 2020 2020 3a72 6574   of S3..    :ret
+000013b0: 7572 6e73 3a20 5333 2065 6e64 706f 696e  urns: S3 endpoin
+000013c0: 7420 7572 6c0a 2020 2020 2727 270a 2020  t url.    '''.  
+000013d0: 2020 656e 7669 726f 6e5f 6b65 7920 3d20    environ_key = 
+000013e0: 6627 7b70 726f 6669 6c65 5f6e 616d 657d  f'{profile_name}
+000013f0: 5f5f 4f53 535f 454e 4450 4f49 4e54 272e  __OSS_ENDPOINT'.
+00001400: 7570 7065 7228 0a20 2020 2029 2069 6620  upper(.    ) if 
+00001410: 7072 6f66 696c 655f 6e61 6d65 2065 6c73  profile_name els
+00001420: 6520 274f 5353 5f45 4e44 504f 494e 5427  e 'OSS_ENDPOINT'
+00001430: 0a20 2020 2065 6e76 6972 6f6e 5f65 6e64  .    environ_end
+00001440: 706f 696e 745f 7572 6c20 3d20 6f73 2e65  point_url = os.e
+00001450: 6e76 6972 6f6e 2e67 6574 2865 6e76 6972  nviron.get(envir
+00001460: 6f6e 5f6b 6579 290a 2020 2020 6966 2065  on_key).    if e
+00001470: 6e76 6972 6f6e 5f65 6e64 706f 696e 745f  nviron_endpoint_
+00001480: 7572 6c3a 0a20 2020 2020 2020 205f 6c6f  url:.        _lo
+00001490: 6767 6572 2e69 6e66 6f28 2275 7369 6e67  gger.info("using
+000014a0: 2025 733a 2025 7322 2025 2028 656e 7669   %s: %s" % (envi
+000014b0: 726f 6e5f 6b65 792c 2065 6e76 6972 6f6e  ron_key, environ
+000014c0: 5f65 6e64 706f 696e 745f 7572 6c29 290a  _endpoint_url)).
+000014d0: 2020 2020 2020 2020 7265 7475 726e 2065          return e
+000014e0: 6e76 6972 6f6e 5f65 6e64 706f 696e 745f  nviron_endpoint_
+000014f0: 7572 6c0a 2020 2020 7472 793a 0a20 2020  url.    try:.   
+00001500: 2020 2020 2063 6f6e 6669 675f 656e 6470       config_endp
+00001510: 6f69 6e74 5f75 726c 203d 2067 6574 5f73  oint_url = get_s
+00001520: 636f 7065 645f 636f 6e66 6967 2870 726f  coped_config(pro
+00001530: 6669 6c65 5f6e 616d 653d 7072 6f66 696c  file_name=profil
+00001540: 655f 6e61 6d65 292e 6765 7428 0a20 2020  e_name).get(.   
+00001550: 2020 2020 2020 2020 2027 7333 272c 207b           's3', {
+00001560: 7d29 2e67 6574 2827 656e 6470 6f69 6e74  }).get('endpoint
+00001570: 5f75 726c 2729 0a20 2020 2020 2020 2069  _url').        i
+00001580: 6620 636f 6e66 6967 5f65 6e64 706f 696e  f config_endpoin
+00001590: 745f 7572 6c3a 0a20 2020 2020 2020 2020  t_url:.         
+000015a0: 2020 205f 6c6f 6767 6572 2e69 6e66 6f28     _logger.info(
+000015b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000015c0: 2022 7573 696e 6720 7e2f 2e61 7773 2f63   "using ~/.aws/c
+000015d0: 6f6e 6669 673a 2065 6e64 706f 696e 745f  onfig: endpoint_
+000015e0: 7572 6c3d 2573 2220 2520 636f 6e66 6967  url=%s" % config
+000015f0: 5f65 6e64 706f 696e 745f 7572 6c29 0a20  _endpoint_url). 
+00001600: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00001610: 6e20 636f 6e66 6967 5f65 6e64 706f 696e  n config_endpoin
+00001620: 745f 7572 6c0a 2020 2020 6578 6365 7074  t_url.    except
+00001630: 2062 6f74 6f63 6f72 652e 6578 6365 7074   botocore.except
+00001640: 696f 6e73 2e50 726f 6669 6c65 4e6f 7446  ions.ProfileNotF
+00001650: 6f75 6e64 3a20 2023 2070 7261 676d 613a  ound:  # pragma:
+00001660: 206e 6f20 636f 7665 720a 2020 2020 2020   no cover.      
+00001670: 2020 7061 7373 0a20 2020 2072 6574 7572    pass.    retur
+00001680: 6e20 656e 6470 6f69 6e74 5f75 726c 0a0a  n endpoint_url..
+00001690: 0a64 6566 2067 6574 5f73 335f 7365 7373  .def get_s3_sess
+000016a0: 696f 6e28 7072 6f66 696c 655f 6e61 6d65  ion(profile_name
+000016b0: 3d4e 6f6e 6529 3a0a 2020 2020 2727 2747  =None):.    '''G
+000016c0: 6574 2053 3320 7365 7373 696f 6e0a 0a20  et S3 session.. 
+000016d0: 2020 203a 7265 7475 726e 733a 2053 3320     :returns: S3 
+000016e0: 7365 7373 696f 6e0a 2020 2020 2727 270a  session.    '''.
+000016f0: 2020 2020 7265 7475 726e 2074 6872 6561      return threa
+00001700: 645f 6c6f 6361 6c28 0a20 2020 2020 2020  d_local(.       
+00001710: 2066 2773 335f 7365 7373 696f 6e3a 7b70   f's3_session:{p
+00001720: 726f 6669 6c65 5f6e 616d 657d 272c 2062  rofile_name}', b
+00001730: 6f74 6f33 2e53 6573 7369 6f6e 2c20 7072  oto3.Session, pr
+00001740: 6f66 696c 655f 6e61 6d65 3d70 726f 6669  ofile_name=profi
+00001750: 6c65 5f6e 616d 6529 0a0a 0a64 6566 2067  le_name)...def g
+00001760: 6574 5f61 6363 6573 735f 746f 6b65 6e28  et_access_token(
+00001770: 7072 6f66 696c 655f 6e61 6d65 3d4e 6f6e  profile_name=Non
+00001780: 6529 3a0a 2020 2020 6163 6365 7373 5f6b  e):.    access_k
+00001790: 6579 5f65 6e76 5f6e 616d 6520 3d20 6622  ey_env_name = f"
+000017a0: 7b70 726f 6669 6c65 5f6e 616d 657d 5f5f  {profile_name}__
+000017b0: 4157 535f 4143 4345 5353 5f4b 4559 5f49  AWS_ACCESS_KEY_I
+000017c0: 4422 2e75 7070 6572 280a 2020 2020 2920  D".upper(.    ) 
+000017d0: 6966 2070 726f 6669 6c65 5f6e 616d 6520  if profile_name 
+000017e0: 656c 7365 2022 4157 535f 4143 4345 5353  else "AWS_ACCESS
+000017f0: 5f4b 4559 5f49 4422 0a20 2020 2073 6563  _KEY_ID".    sec
+00001800: 7265 745f 6b65 795f 656e 765f 6e61 6d65  ret_key_env_name
+00001810: 203d 2066 227b 7072 6f66 696c 655f 6e61   = f"{profile_na
+00001820: 6d65 7d5f 5f41 5753 5f53 4543 5245 545f  me}__AWS_SECRET_
+00001830: 4143 4345 5353 5f4b 4559 222e 7570 7065  ACCESS_KEY".uppe
+00001840: 7228 0a20 2020 2029 2069 6620 7072 6f66  r(.    ) if prof
+00001850: 696c 655f 6e61 6d65 2065 6c73 6520 2241  ile_name else "A
+00001860: 5753 5f53 4543 5245 545f 4143 4345 5353  WS_SECRET_ACCESS
+00001870: 5f4b 4559 220a 2020 2020 6163 6365 7373  _KEY".    access
+00001880: 5f6b 6579 203d 206f 732e 6765 7465 6e76  _key = os.getenv
+00001890: 2861 6363 6573 735f 6b65 795f 656e 765f  (access_key_env_
+000018a0: 6e61 6d65 290a 2020 2020 7365 6372 6574  name).    secret
+000018b0: 5f6b 6579 203d 206f 732e 6765 7465 6e76  _key = os.getenv
+000018c0: 2873 6563 7265 745f 6b65 795f 656e 765f  (secret_key_env_
+000018d0: 6e61 6d65 290a 2020 2020 6966 2061 6363  name).    if acc
+000018e0: 6573 735f 6b65 7920 616e 6420 7365 6372  ess_key and secr
+000018f0: 6574 5f6b 6579 3a0a 2020 2020 2020 2020  et_key:.        
+00001900: 7265 7475 726e 2061 6363 6573 735f 6b65  return access_ke
+00001910: 792c 2073 6563 7265 745f 6b65 790a 0a20  y, secret_key.. 
+00001920: 2020 2063 7265 6465 6e74 6961 6c73 203d     credentials =
+00001930: 2067 6574 5f73 335f 7365 7373 696f 6e28   get_s3_session(
+00001940: 7072 6f66 696c 655f 6e61 6d65 3d70 726f  profile_name=pro
+00001950: 6669 6c65 5f6e 616d 6529 2e67 6574 5f63  file_name).get_c
+00001960: 7265 6465 6e74 6961 6c73 2829 0a20 2020  redentials().   
+00001970: 2069 6620 6372 6564 656e 7469 616c 733a   if credentials:
+00001980: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00001990: 6163 6365 7373 5f6b 6579 3a0a 2020 2020  access_key:.    
+000019a0: 2020 2020 2020 2020 6163 6365 7373 5f6b          access_k
+000019b0: 6579 203d 2063 7265 6465 6e74 6961 6c73  ey = credentials
+000019c0: 2e61 6363 6573 735f 6b65 790a 2020 2020  .access_key.    
+000019d0: 2020 2020 6966 206e 6f74 2073 6563 7265      if not secre
+000019e0: 745f 6b65 793a 0a20 2020 2020 2020 2020  t_key:.         
+000019f0: 2020 2073 6563 7265 745f 6b65 7920 3d20     secret_key = 
+00001a00: 6372 6564 656e 7469 616c 732e 7365 6372  credentials.secr
+00001a10: 6574 5f6b 6579 0a20 2020 2072 6574 7572  et_key.    retur
+00001a20: 6e20 6163 6365 7373 5f6b 6579 2c20 7365  n access_key, se
+00001a30: 6372 6574 5f6b 6579 0a0a 0a64 6566 2067  cret_key...def g
+00001a40: 6574 5f73 335f 636c 6965 6e74 280a 2020  et_s3_client(.  
+00001a50: 2020 2020 2020 636f 6e66 6967 3a20 4f70        config: Op
+00001a60: 7469 6f6e 616c 5b62 6f74 6f63 6f72 652e  tional[botocore.
+00001a70: 636f 6e66 6967 2e43 6f6e 6669 675d 203d  config.Config] =
+00001a80: 204e 6f6e 652c 0a20 2020 2020 2020 2063   None,.        c
+00001a90: 6163 6865 5f6b 6579 3a20 4f70 7469 6f6e  ache_key: Option
+00001aa0: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2c0a  al[str] = None,.
+00001ab0: 2020 2020 2020 2020 7072 6f66 696c 655f          profile_
+00001ac0: 6e61 6d65 3a20 4f70 7469 6f6e 616c 5b73  name: Optional[s
+00001ad0: 7472 5d20 3d20 4e6f 6e65 293a 0a20 2020  tr] = None):.   
+00001ae0: 2027 2727 4765 7420 5333 2063 6c69 656e   '''Get S3 clien
+00001af0: 740a 0a20 2020 203a 7265 7475 726e 733a  t..    :returns:
+00001b00: 2053 3320 636c 6965 6e74 0a20 2020 2027   S3 client.    '
+00001b10: 2727 0a20 2020 2069 6620 6361 6368 655f  ''.    if cache_
+00001b20: 6b65 7920 6973 206e 6f74 204e 6f6e 653a  key is not None:
+00001b30: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00001b40: 7468 7265 6164 5f6c 6f63 616c 280a 2020  thread_local(.  
+00001b50: 2020 2020 2020 2020 2020 6361 6368 655f            cache_
+00001b60: 6b65 792c 2067 6574 5f73 335f 636c 6965  key, get_s3_clie
+00001b70: 6e74 2c20 636f 6e66 6967 3d63 6f6e 6669  nt, config=confi
+00001b80: 672c 2070 726f 6669 6c65 5f6e 616d 653d  g, profile_name=
+00001b90: 7072 6f66 696c 655f 6e61 6d65 290a 0a20  profile_name).. 
+00001ba0: 2020 2061 6363 6573 735f 6b65 792c 2073     access_key, s
+00001bb0: 6563 7265 745f 6b65 7920 3d20 6765 745f  ecret_key = get_
+00001bc0: 6163 6365 7373 5f74 6f6b 656e 2870 726f  access_token(pro
+00001bd0: 6669 6c65 5f6e 616d 6529 0a20 2020 2063  file_name).    c
+00001be0: 6c69 656e 7420 3d20 6765 745f 7333 5f73  lient = get_s3_s
+00001bf0: 6573 7369 6f6e 2829 2e63 6c69 656e 7428  ession().client(
+00001c00: 0a20 2020 2020 2020 2027 7333 272c 0a20  .        's3',. 
+00001c10: 2020 2020 2020 2065 6e64 706f 696e 745f         endpoint_
+00001c20: 7572 6c3d 6765 745f 656e 6470 6f69 6e74  url=get_endpoint
+00001c30: 5f75 726c 2870 726f 6669 6c65 5f6e 616d  _url(profile_nam
+00001c40: 653d 7072 6f66 696c 655f 6e61 6d65 292c  e=profile_name),
+00001c50: 0a20 2020 2020 2020 2063 6f6e 6669 673d  .        config=
+00001c60: 636f 6e66 6967 2c0a 2020 2020 2020 2020  config,.        
+00001c70: 6177 735f 6163 6365 7373 5f6b 6579 5f69  aws_access_key_i
+00001c80: 643d 6163 6365 7373 5f6b 6579 2c0a 2020  d=access_key,.  
+00001c90: 2020 2020 2020 6177 735f 7365 6372 6574        aws_secret
+00001ca0: 5f61 6363 6573 735f 6b65 793d 7365 6372  _access_key=secr
+00001cb0: 6574 5f6b 6579 2c0a 2020 2020 290a 2020  et_key,.    ).  
+00001cc0: 2020 636c 6965 6e74 203d 205f 7061 7463    client = _patc
+00001cd0: 685f 6d61 6b65 5f72 6571 7565 7374 2863  h_make_request(c
+00001ce0: 6c69 656e 7429 0a20 2020 2072 6574 7572  lient).    retur
+00001cf0: 6e20 636c 6965 6e74 0a0a 0a64 6566 2073  n client...def s
+00001d00: 335f 7061 7468 5f6a 6f69 6e28 7061 7468  3_path_join(path
+00001d10: 3a20 5061 7468 4c69 6b65 2c20 2a6f 7468  : PathLike, *oth
+00001d20: 6572 5f70 6174 6873 3a20 5061 7468 4c69  er_paths: PathLi
+00001d30: 6b65 2920 2d3e 2073 7472 3a0a 2020 2020  ke) -> str:.    
+00001d40: 2727 270a 2020 2020 436f 6e63 6174 2032  '''.    Concat 2
+00001d50: 206f 7220 6d6f 7265 2070 6174 6820 746f   or more path to
+00001d60: 2061 2063 6f6d 706c 6574 6520 7061 7468   a complete path
+00001d70: 0a0a 2020 2020 3a70 6172 616d 2070 6174  ..    :param pat
+00001d80: 683a 2047 6976 656e 2070 6174 680a 2020  h: Given path.  
+00001d90: 2020 3a70 6172 616d 206f 7468 6572 5f70    :param other_p
+00001da0: 6174 6873 3a20 5061 7468 7320 746f 2062  aths: Paths to b
+00001db0: 6520 636f 6e63 6174 656e 6174 6564 0a20  e concatenated. 
+00001dc0: 2020 203a 7265 7475 726e 733a 2043 6f6e     :returns: Con
+00001dd0: 6361 7465 6e61 7465 6420 636f 6d70 6c65  catenated comple
+00001de0: 7465 2070 6174 680a 0a20 2020 202e 2e20  te path..    .. 
+00001df0: 6e6f 7465 203a 3a0a 0a20 2020 2020 2020  note ::..       
+00001e00: 2054 6865 2064 6966 6665 7265 6e63 6520   The difference 
+00001e10: 6265 7477 6565 6e20 7468 6973 2066 756e  between this fun
+00001e20: 6374 696f 6e20 616e 6420 6060 6f73 2e70  ction and ``os.p
+00001e30: 6174 682e 6a6f 696e 6060 2069 7320 7468  ath.join`` is th
+00001e40: 6174 2074 6869 7320 6675 6e63 7469 6f6e  at this function
+00001e50: 2069 676e 6f72 6573 206c 6566 7420 7369   ignores left si
+00001e60: 6465 2073 6c61 7368 2028 7768 6963 6820  de slash (which 
+00001e70: 696e 6469 6361 7465 7320 6162 736f 6c75  indicates absolu
+00001e80: 7465 2070 6174 6829 2069 6e20 6060 6f74  te path) in ``ot
+00001e90: 6865 725f 7061 7468 7360 6020 616e 6420  her_paths`` and 
+00001ea0: 7769 6c6c 2064 6972 6563 746c 7920 636f  will directly co
+00001eb0: 6e63 6174 2e0a 2020 2020 2020 2020 652e  ncat..        e.
+00001ec0: 672e 206f 732e 7061 7468 2e6a 6f69 6e28  g. os.path.join(
+00001ed0: 272f 7061 7468 272c 2027 746f 272c 2027  '/path', 'to', '
+00001ee0: 2f66 696c 6527 2920 3d3e 2027 2f66 696c  /file') => '/fil
+00001ef0: 6527 2c20 6275 7420 7333 5f70 6174 685f  e', but s3_path_
+00001f00: 6a6f 696e 2827 2f70 6174 6827 2c20 2774  join('/path', 't
+00001f10: 6f27 2c20 272f 6669 6c65 2729 203d 3e20  o', '/file') => 
+00001f20: 272f 7061 7468 2f74 6f2f 6669 6c65 270a  '/path/to/file'.
+00001f30: 2020 2020 2727 270a 2020 2020 7265 7475      '''.    retu
+00001f40: 726e 2075 7269 5f6a 6f69 6e28 6673 7061  rn uri_join(fspa
+00001f50: 7468 2870 6174 6829 2c20 2a6d 6170 2866  th(path), *map(f
+00001f60: 7370 6174 682c 206f 7468 6572 5f70 6174  spath, other_pat
+00001f70: 6873 2929 0a0a 0a64 6566 205f 6c69 7374  hs))...def _list
+00001f80: 5f61 6c6c 5f62 7563 6b65 7473 2870 726f  _all_buckets(pro
+00001f90: 6669 6c65 5f6e 616d 653a 204f 7074 696f  file_name: Optio
+00001fa0: 6e61 6c5b 7374 725d 203d 204e 6f6e 6529  nal[str] = None)
+00001fb0: 202d 3e20 4c69 7374 5b73 7472 5d3a 0a20   -> List[str]:. 
+00001fc0: 2020 2063 6c69 656e 7420 3d20 6765 745f     client = get_
+00001fd0: 7333 5f63 6c69 656e 7428 7072 6f66 696c  s3_client(profil
+00001fe0: 655f 6e61 6d65 3d70 726f 6669 6c65 5f6e  e_name=profile_n
+00001ff0: 616d 6529 0a20 2020 2072 6573 706f 6e73  ame).    respons
+00002000: 6520 3d20 636c 6965 6e74 2e6c 6973 745f  e = client.list_
+00002010: 6275 636b 6574 7328 290a 2020 2020 7265  buckets().    re
+00002020: 7475 726e 205b 636f 6e74 656e 745b 274e  turn [content['N
+00002030: 616d 6527 5d20 666f 7220 636f 6e74 656e  ame'] for conten
+00002040: 7420 696e 2072 6573 706f 6e73 655b 2742  t in response['B
+00002050: 7563 6b65 7473 275d 5d0a 0a0a 6465 6620  uckets']]...def 
+00002060: 5f70 6172 7365 5f73 335f 7572 6c5f 6967  _parse_s3_url_ig
+00002070: 6e6f 7265 5f62 7261 6365 2873 335f 7572  nore_brace(s3_ur
+00002080: 6c3a 2073 7472 2920 2d3e 2054 7570 6c65  l: str) -> Tuple
+00002090: 5b73 7472 2c20 7374 725d 3a0a 2020 2020  [str, str]:.    
+000020a0: 7333 5f75 726c 203d 2066 7370 6174 6828  s3_url = fspath(
+000020b0: 7333 5f75 726c 290a 2020 2020 7333 5f73  s3_url).    s3_s
+000020c0: 6368 656d 652c 2072 6967 6874 7061 7274  cheme, rightpart
+000020d0: 203d 2073 335f 7572 6c5b 3a35 5d2c 2073   = s3_url[:5], s
+000020e0: 335f 7572 6c5b 353a 5d0a 2020 2020 6966  3_url[5:].    if
+000020f0: 2073 335f 7363 6865 6d65 2021 3d20 2773   s3_scheme != 's
+00002100: 333a 2f2f 273a 0a20 2020 2020 2020 2072  3://':.        r
+00002110: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00002120: 274e 6f74 2061 2073 3320 7572 6c3a 2025  'Not a s3 url: %
+00002130: 7227 2025 2073 335f 7572 6c29 0a20 2020  r' % s3_url).   
+00002140: 206c 6566 745f 6272 6163 6520 3d20 4661   left_brace = Fa
+00002150: 6c73 650a 2020 2020 666f 7220 6375 7272  lse.    for curr
+00002160: 656e 745f 696e 6465 782c 2063 7572 7265  ent_index, curre
+00002170: 6e74 5f63 6861 7261 6374 6572 2069 6e20  nt_character in 
+00002180: 656e 756d 6572 6174 6528 7269 6768 7470  enumerate(rightp
+00002190: 6172 7429 3a0a 2020 2020 2020 2020 6966  art):.        if
+000021a0: 2063 7572 7265 6e74 5f63 6861 7261 6374   current_charact
+000021b0: 6572 203d 3d20 222f 2220 616e 6420 6c65  er == "/" and le
+000021c0: 6674 5f62 7261 6365 2069 7320 4661 6c73  ft_brace is Fals
+000021d0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+000021e0: 6574 7572 6e20 7269 6768 7470 6172 745b  eturn rightpart[
+000021f0: 3a63 7572 7265 6e74 5f69 6e64 6578 5d2c  :current_index],
+00002200: 2072 6967 6874 7061 7274 5b63 7572 7265   rightpart[curre
+00002210: 6e74 5f69 6e64 6578 202b 2031 3a5d 0a20  nt_index + 1:]. 
+00002220: 2020 2020 2020 2065 6c69 6620 6375 7272         elif curr
+00002230: 656e 745f 6368 6172 6163 7465 7220 3d3d  ent_character ==
+00002240: 2022 7b22 3a0a 2020 2020 2020 2020 2020   "{":.          
+00002250: 2020 6c65 6674 5f62 7261 6365 203d 2054    left_brace = T
+00002260: 7275 650a 2020 2020 2020 2020 656c 6966  rue.        elif
+00002270: 2063 7572 7265 6e74 5f63 6861 7261 6374   current_charact
+00002280: 6572 203d 3d20 227d 223a 0a20 2020 2020  er == "}":.     
+00002290: 2020 2020 2020 206c 6566 745f 6272 6163         left_brac
+000022a0: 6520 3d20 4661 6c73 650a 2020 2020 7265  e = False.    re
+000022b0: 7475 726e 2072 6967 6874 7061 7274 2c20  turn rightpart, 
+000022c0: 2222 0a0a 0a64 6566 205f 6772 6f75 705f  ""...def _group_
+000022d0: 7333 7061 7468 5f62 795f 6275 636b 6574  s3path_by_bucket
+000022e0: 280a 2020 2020 2020 2020 7333 5f70 6174  (.        s3_pat
+000022f0: 686e 616d 653a 2073 7472 2c20 7072 6f66  hname: str, prof
+00002300: 696c 655f 6e61 6d65 3a20 4f70 7469 6f6e  ile_name: Option
+00002310: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2920  al[str] = None) 
+00002320: 2d3e 204c 6973 745b 7374 725d 3a0a 2020  -> List[str]:.  
+00002330: 2020 6275 636b 6574 2c20 6b65 7920 3d20    bucket, key = 
+00002340: 5f70 6172 7365 5f73 335f 7572 6c5f 6967  _parse_s3_url_ig
+00002350: 6e6f 7265 5f62 7261 6365 2873 335f 7061  nore_brace(s3_pa
+00002360: 7468 6e61 6d65 290a 2020 2020 6966 206e  thname).    if n
+00002370: 6f74 2062 7563 6b65 743a 0a20 2020 2020  ot bucket:.     
+00002380: 2020 2069 6620 6e6f 7420 6b65 793a 0a20     if not key:. 
+00002390: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000023a0: 2055 6e73 7570 706f 7274 6564 4572 726f   UnsupportedErro
+000023b0: 7228 2747 6c6f 6220 7768 6f6c 6520 7333  r('Glob whole s3
+000023c0: 272c 2073 335f 7061 7468 6e61 6d65 290a  ', s3_pathname).
+000023d0: 2020 2020 2020 2020 7261 6973 6520 5333          raise S3
+000023e0: 4275 636b 6574 4e6f 7446 6f75 6e64 4572  BucketNotFoundEr
+000023f0: 726f 7228 2745 6d70 7479 2062 7563 6b65  ror('Empty bucke
+00002400: 7420 6e61 6d65 3a20 2572 2720 2520 7333  t name: %r' % s3
+00002410: 5f70 6174 686e 616d 6529 0a0a 2020 2020  _pathname)..    
+00002420: 6772 6f75 7065 645f 7061 7468 203d 205b  grouped_path = [
+00002430: 5d0a 0a20 2020 2064 6566 2067 656e 6572  ]..    def gener
+00002440: 6174 655f 7333 5f70 6174 6828 6275 636b  ate_s3_path(buck
+00002450: 6574 3a20 7374 722c 206b 6579 3a20 7374  et: str, key: st
+00002460: 7229 202d 3e20 7374 723a 0a20 2020 2020  r) -> str:.     
+00002470: 2020 2069 6620 6b65 793a 0a20 2020 2020     if key:.     
+00002480: 2020 2020 2020 2072 6574 7572 6e20 2273         return "s
+00002490: 333a 2f2f 2573 2f25 7322 2025 2028 6275  3://%s/%s" % (bu
+000024a0: 636b 6574 2c20 6b65 7929 0a20 2020 2020  cket, key).     
+000024b0: 2020 2072 6574 7572 6e20 2273 333a 2f2f     return "s3://
+000024c0: 2573 2573 2220 2520 2862 7563 6b65 742c  %s%s" % (bucket,
+000024d0: 2022 2f22 2069 6620 7333 5f70 6174 686e   "/" if s3_pathn
+000024e0: 616d 652e 656e 6473 7769 7468 2822 2f22  ame.endswith("/"
+000024f0: 2920 656c 7365 2022 2229 0a0a 2020 2020  ) else "")..    
+00002500: 616c 6c5f 6275 636b 6574 203d 206c 7275  all_bucket = lru
+00002510: 5f63 6163 6865 286d 6178 7369 7a65 3d31  _cache(maxsize=1
+00002520: 2928 5f6c 6973 745f 616c 6c5f 6275 636b  )(_list_all_buck
+00002530: 6574 7329 0a20 2020 2066 6f72 2062 7563  ets).    for buc
+00002540: 6b65 746e 616d 6520 696e 2075 6e67 6c6f  ketname in unglo
+00002550: 626c 697a 6528 6275 636b 6574 293a 0a20  blize(bucket):. 
+00002560: 2020 2020 2020 2069 6620 6861 735f 6d61         if has_ma
+00002570: 6769 6328 6275 636b 6574 6e61 6d65 293a  gic(bucketname):
+00002580: 0a20 2020 2020 2020 2020 2020 2073 706c  .            spl
+00002590: 6974 5f62 7563 6b65 746e 616d 6520 3d20  it_bucketname = 
+000025a0: 6275 636b 6574 6e61 6d65 2e73 706c 6974  bucketname.split
+000025b0: 2822 2f22 2c20 3129 0a20 2020 2020 2020  ("/", 1).       
+000025c0: 2020 2020 2070 6174 685f 7061 7274 203d       path_part =
+000025d0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+000025e0: 2020 6966 206c 656e 2873 706c 6974 5f62    if len(split_b
+000025f0: 7563 6b65 746e 616d 6529 203d 3d20 323a  ucketname) == 2:
+00002600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002610: 2062 7563 6b65 746e 616d 652c 2070 6174   bucketname, pat
+00002620: 685f 7061 7274 203d 2073 706c 6974 5f62  h_part = split_b
+00002630: 7563 6b65 746e 616d 650a 2020 2020 2020  ucketname.      
+00002640: 2020 2020 2020 7061 7474 6572 6e20 3d20        pattern = 
+00002650: 7265 2e63 6f6d 7069 6c65 2874 7261 6e73  re.compile(trans
+00002660: 6c61 7465 2872 652e 7375 6228 7227 5c2a  late(re.sub(r'\*
+00002670: 7b32 2c7d 272c 2027 2a27 2c20 6275 636b  {2,}', '*', buck
+00002680: 6574 6e61 6d65 2929 290a 0a20 2020 2020  etname)))..     
+00002690: 2020 2020 2020 2066 6f72 2062 7563 6b65         for bucke
+000026a0: 7420 696e 2061 6c6c 5f62 7563 6b65 7428  t in all_bucket(
+000026b0: 7072 6f66 696c 655f 6e61 6d65 293a 0a20  profile_name):. 
+000026c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000026d0: 6620 7061 7474 6572 6e2e 6675 6c6c 6d61  f pattern.fullma
+000026e0: 7463 6828 6275 636b 6574 2920 6973 206e  tch(bucket) is n
+000026f0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00002700: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00002710: 7061 7468 5f70 6172 7420 6973 206e 6f74  path_part is not
+00002720: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00002730: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00002740: 7563 6b65 7420 3d20 2225 732f 2573 2220  ucket = "%s/%s" 
+00002750: 2520 280a 2020 2020 2020 2020 2020 2020  % (.            
+00002760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002770: 6275 636b 6574 2c20 7061 7468 5f70 6172  bucket, path_par
+00002780: 7429 2020 2320 7072 6167 6d61 3a20 6e6f  t)  # pragma: no
+00002790: 2063 6f76 6572 0a20 2020 2020 2020 2020   cover.         
+000027a0: 2020 2020 2020 2020 2020 2067 726f 7570             group
+000027b0: 6564 5f70 6174 682e 6170 7065 6e64 2867  ed_path.append(g
+000027c0: 656e 6572 6174 655f 7333 5f70 6174 6828  enerate_s3_path(
+000027d0: 6275 636b 6574 2c20 6b65 7929 290a 2020  bucket, key)).  
+000027e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000027f0: 2020 2020 2020 2020 6772 6f75 7065 645f          grouped_
+00002800: 7061 7468 2e61 7070 656e 6428 6765 6e65  path.append(gene
+00002810: 7261 7465 5f73 335f 7061 7468 2862 7563  rate_s3_path(buc
+00002820: 6b65 746e 616d 652c 206b 6579 2929 0a0a  ketname, key))..
+00002830: 2020 2020 7265 7475 726e 2067 726f 7570      return group
+00002840: 6564 5f70 6174 680a 0a0a 6465 6620 5f73  ed_path...def _s
+00002850: 335f 7370 6c69 745f 6d61 6769 635f 6967  3_split_magic_ig
+00002860: 6e6f 7265 5f62 7261 6365 2873 335f 7061  nore_brace(s3_pa
+00002870: 7468 6e61 6d65 3a20 7374 7229 202d 3e20  thname: str) -> 
+00002880: 5475 706c 655b 7374 722c 2073 7472 5d3a  Tuple[str, str]:
+00002890: 0a20 2020 2069 6620 6e6f 7420 7333 5f70  .    if not s3_p
+000028a0: 6174 686e 616d 653a 0a20 2020 2020 2020  athname:.       
+000028b0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+000028c0: 7228 2273 335f 7061 7468 6e61 6d65 3a20  r("s3_pathname: 
+000028d0: 2573 222c 2073 335f 7061 7468 6e61 6d65  %s", s3_pathname
+000028e0: 290a 0a20 2020 2068 6173 5f70 726f 746f  )..    has_proto
+000028f0: 636f 6c20 3d20 4661 6c73 650a 2020 2020  col = False.    
+00002900: 6966 2073 335f 7061 7468 6e61 6d65 2e73  if s3_pathname.s
+00002910: 7461 7274 7377 6974 6828 2273 333a 2f2f  tartswith("s3://
+00002920: 2229 3a0a 2020 2020 2020 2020 6861 735f  "):.        has_
+00002930: 7072 6f74 6f63 6f6c 203d 2054 7275 650a  protocol = True.
+00002940: 2020 2020 2020 2020 7333 5f70 6174 686e          s3_pathn
+00002950: 616d 6520 3d20 7333 5f70 6174 686e 616d  ame = s3_pathnam
+00002960: 655b 353a 5d0a 0a20 2020 2068 6173 5f64  e[5:]..    has_d
+00002970: 656c 696d 6974 6572 203d 2046 616c 7365  elimiter = False
+00002980: 0a20 2020 2069 6620 7333 5f70 6174 686e  .    if s3_pathn
+00002990: 616d 652e 656e 6473 7769 7468 2822 2f22  ame.endswith("/"
+000029a0: 293a 0a20 2020 2020 2020 2068 6173 5f64  ):.        has_d
+000029b0: 656c 696d 6974 6572 203d 2054 7275 650a  elimiter = True.
+000029c0: 2020 2020 2020 2020 7333 5f70 6174 686e          s3_pathn
+000029d0: 616d 6520 3d20 7333 5f70 6174 686e 616d  ame = s3_pathnam
+000029e0: 655b 3a2d 315d 0a0a 2020 2020 6e6f 726d  e[:-1]..    norm
+000029f0: 616c 5f70 6172 7473 203d 205b 5d0a 2020  al_parts = [].  
+00002a00: 2020 6d61 6769 635f 7061 7274 7320 3d20    magic_parts = 
+00002a10: 5b5d 0a20 2020 206c 6566 745f 6272 6163  [].    left_brac
+00002a20: 6520 3d20 4661 6c73 650a 2020 2020 6c65  e = False.    le
+00002a30: 6674 5f69 6e64 6578 203d 2030 0a20 2020  ft_index = 0.   
+00002a40: 2066 6f72 2063 7572 7265 6e74 5f69 6e64   for current_ind
+00002a50: 6578 2c20 6375 7272 656e 745f 6368 6172  ex, current_char
+00002a60: 6163 7465 7220 696e 2065 6e75 6d65 7261  acter in enumera
+00002a70: 7465 2873 335f 7061 7468 6e61 6d65 293a  te(s3_pathname):
+00002a80: 0a20 2020 2020 2020 2069 6620 6375 7272  .        if curr
+00002a90: 656e 745f 6368 6172 6163 7465 7220 3d3d  ent_character ==
+00002aa0: 2022 2f22 2061 6e64 206c 6566 745f 6272   "/" and left_br
+00002ab0: 6163 6520 6973 2046 616c 7365 3a0a 2020  ace is False:.  
+00002ac0: 2020 2020 2020 2020 2020 6966 2068 6173            if has
+00002ad0: 5f6d 6167 6963 5f69 676e 6f72 655f 6272  _magic_ignore_br
+00002ae0: 6163 6528 7333 5f70 6174 686e 616d 655b  ace(s3_pathname[
+00002af0: 6c65 6674 5f69 6e64 6578 3a63 7572 7265  left_index:curre
+00002b00: 6e74 5f69 6e64 6578 5d29 3a0a 2020 2020  nt_index]):.    
+00002b10: 2020 2020 2020 2020 2020 2020 6d61 6769              magi
+00002b20: 635f 7061 7274 732e 6170 7065 6e64 2873  c_parts.append(s
+00002b30: 335f 7061 7468 6e61 6d65 5b6c 6566 745f  3_pathname[left_
+00002b40: 696e 6465 783a 6375 7272 656e 745f 696e  index:current_in
+00002b50: 6465 785d 290a 2020 2020 2020 2020 2020  dex]).          
+00002b60: 2020 2020 2020 6966 2073 335f 7061 7468        if s3_path
+00002b70: 6e61 6d65 5b63 7572 7265 6e74 5f69 6e64  name[current_ind
+00002b80: 6578 202b 2031 3a5d 3a0a 2020 2020 2020  ex + 1:]:.      
+00002b90: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+00002ba0: 6769 635f 7061 7274 732e 6170 7065 6e64  gic_parts.append
+00002bb0: 2873 335f 7061 7468 6e61 6d65 5b63 7572  (s3_pathname[cur
+00002bc0: 7265 6e74 5f69 6e64 6578 202b 2031 3a5d  rent_index + 1:]
+00002bd0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00002be0: 2020 2020 2020 6c65 6674 5f69 6e64 6578        left_index
+00002bf0: 203d 206c 656e 2873 335f 7061 7468 6e61   = len(s3_pathna
+00002c00: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
+00002c10: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
+00002c20: 2020 2020 2020 6e6f 726d 616c 5f70 6172        normal_par
+00002c30: 7473 2e61 7070 656e 6428 7333 5f70 6174  ts.append(s3_pat
+00002c40: 686e 616d 655b 6c65 6674 5f69 6e64 6578  hname[left_index
+00002c50: 3a63 7572 7265 6e74 5f69 6e64 6578 5d29  :current_index])
+00002c60: 0a20 2020 2020 2020 2020 2020 206c 6566  .            lef
+00002c70: 745f 696e 6465 7820 3d20 6375 7272 656e  t_index = curren
+00002c80: 745f 696e 6465 7820 2b20 310a 2020 2020  t_index + 1.    
+00002c90: 2020 2020 656c 6966 2063 7572 7265 6e74      elif current
+00002ca0: 5f63 6861 7261 6374 6572 203d 3d20 227b  _character == "{
+00002cb0: 223a 0a20 2020 2020 2020 2020 2020 206c  ":.            l
+00002cc0: 6566 745f 6272 6163 6520 3d20 5472 7565  eft_brace = True
+00002cd0: 0a20 2020 2020 2020 2065 6c69 6620 6375  .        elif cu
+00002ce0: 7272 656e 745f 6368 6172 6163 7465 7220  rrent_character 
+00002cf0: 3d3d 2022 7d22 3a0a 2020 2020 2020 2020  == "}":.        
+00002d00: 2020 2020 6c65 6674 5f62 7261 6365 203d      left_brace =
+00002d10: 2046 616c 7365 0a20 2020 2069 6620 7333   False.    if s3
+00002d20: 5f70 6174 686e 616d 655b 6c65 6674 5f69  _pathname[left_i
+00002d30: 6e64 6578 3a5d 3a0a 2020 2020 2020 2020  ndex:]:.        
+00002d40: 6966 2068 6173 5f6d 6167 6963 5f69 676e  if has_magic_ign
+00002d50: 6f72 655f 6272 6163 6528 7333 5f70 6174  ore_brace(s3_pat
+00002d60: 686e 616d 655b 6c65 6674 5f69 6e64 6578  hname[left_index
+00002d70: 3a5d 293a 0a20 2020 2020 2020 2020 2020  :]):.           
+00002d80: 206d 6167 6963 5f70 6172 7473 2e61 7070   magic_parts.app
+00002d90: 656e 6428 7333 5f70 6174 686e 616d 655b  end(s3_pathname[
+00002da0: 6c65 6674 5f69 6e64 6578 3a5d 290a 2020  left_index:]).  
+00002db0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00002dc0: 2020 2020 2020 2020 6e6f 726d 616c 5f70          normal_p
+00002dd0: 6172 7473 2e61 7070 656e 6428 7333 5f70  arts.append(s3_p
+00002de0: 6174 686e 616d 655b 6c65 6674 5f69 6e64  athname[left_ind
+00002df0: 6578 3a5d 290a 0a20 2020 2069 6620 6861  ex:])..    if ha
+00002e00: 735f 7072 6f74 6f63 6f6c 2061 6e64 206e  s_protocol and n
+00002e10: 6f72 6d61 6c5f 7061 7274 733a 0a20 2020  ormal_parts:.   
+00002e20: 2020 2020 206e 6f72 6d61 6c5f 7061 7274       normal_part
+00002e30: 732e 696e 7365 7274 2830 2c20 2273 333a  s.insert(0, "s3:
+00002e40: 2f22 290a 2020 2020 656c 6966 2068 6173  /").    elif has
+00002e50: 5f70 726f 746f 636f 6c3a 0a20 2020 2020  _protocol:.     
+00002e60: 2020 206d 6167 6963 5f70 6172 7473 2e69     magic_parts.i
+00002e70: 6e73 6572 7428 302c 2022 7333 3a2f 2229  nsert(0, "s3:/")
+00002e80: 0a0a 2020 2020 6966 2068 6173 5f64 656c  ..    if has_del
+00002e90: 696d 6974 6572 2061 6e64 206d 6167 6963  imiter and magic
+00002ea0: 5f70 6172 7473 3a0a 2020 2020 2020 2020  _parts:.        
+00002eb0: 6d61 6769 635f 7061 7274 732e 6170 7065  magic_parts.appe
+00002ec0: 6e64 2822 2229 0a20 2020 2065 6c69 6620  nd("").    elif 
+00002ed0: 6861 735f 6465 6c69 6d69 7465 723a 0a20  has_delimiter:. 
+00002ee0: 2020 2020 2020 206e 6f72 6d61 6c5f 7061         normal_pa
+00002ef0: 7274 732e 6170 7065 6e64 2822 2229 0a0a  rts.append("")..
+00002f00: 2020 2020 7265 7475 726e 2022 2f22 2e6a      return "/".j
+00002f10: 6f69 6e28 6e6f 726d 616c 5f70 6172 7473  oin(normal_parts
+00002f20: 292c 2022 2f22 2e6a 6f69 6e28 6d61 6769  ), "/".join(magi
+00002f30: 635f 7061 7274 7329 0a0a 0a64 6566 205f  c_parts)...def _
+00002f40: 6772 6f75 705f 7333 7061 7468 5f62 795f  group_s3path_by_
+00002f50: 7072 6566 6978 2873 335f 7061 7468 6e61  prefix(s3_pathna
+00002f60: 6d65 3a20 7374 7229 202d 3e20 4c69 7374  me: str) -> List
+00002f70: 5b73 7472 5d3a 0a0a 2020 2020 5f2c 206b  [str]:..    _, k
+00002f80: 6579 203d 2070 6172 7365 5f73 335f 7572  ey = parse_s3_ur
+00002f90: 6c28 7333 5f70 6174 686e 616d 6529 0a20  l(s3_pathname). 
+00002fa0: 2020 2069 6620 6e6f 7420 6b65 793a 0a20     if not key:. 
+00002fb0: 2020 2020 2020 2072 6574 7572 6e20 756e         return un
+00002fc0: 676c 6f62 6c69 7a65 2873 335f 7061 7468  globlize(s3_path
+00002fd0: 6e61 6d65 290a 0a20 2020 2074 6f70 5f64  name)..    top_d
+00002fe0: 6972 2c20 6d61 6769 635f 7061 7274 203d  ir, magic_part =
+00002ff0: 205f 7333 5f73 706c 6974 5f6d 6167 6963   _s3_split_magic
+00003000: 5f69 676e 6f72 655f 6272 6163 6528 7333  _ignore_brace(s3
+00003010: 5f70 6174 686e 616d 6529 0a20 2020 2069  _pathname).    i
+00003020: 6620 6e6f 7420 746f 705f 6469 723a 0a20  f not top_dir:. 
+00003030: 2020 2020 2020 2072 6574 7572 6e20 5b6d         return [m
+00003040: 6167 6963 5f70 6172 745d 0a20 2020 2067  agic_part].    g
+00003050: 726f 7570 6564 5f70 6174 6820 3d20 5b5d  rouped_path = []
+00003060: 0a20 2020 2066 6f72 2070 6174 686e 616d  .    for pathnam
+00003070: 6520 696e 2075 6e67 6c6f 626c 697a 6528  e in ungloblize(
+00003080: 746f 705f 6469 7229 3a0a 2020 2020 2020  top_dir):.      
+00003090: 2020 6966 206d 6167 6963 5f70 6172 743a    if magic_part:
+000030a0: 0a20 2020 2020 2020 2020 2020 2070 6174  .            pat
+000030b0: 686e 616d 6520 3d20 222f 222e 6a6f 696e  hname = "/".join
+000030c0: 285b 7061 7468 6e61 6d65 2c20 6d61 6769  ([pathname, magi
+000030d0: 635f 7061 7274 5d29 0a20 2020 2020 2020  c_part]).       
+000030e0: 2067 726f 7570 6564 5f70 6174 682e 6170   grouped_path.ap
+000030f0: 7065 6e64 2870 6174 686e 616d 6529 0a20  pend(pathname). 
+00003100: 2020 2072 6574 7572 6e20 6772 6f75 7065     return groupe
+00003110: 645f 7061 7468 0a0a 0a64 6566 205f 6265  d_path...def _be
+00003120: 636f 6d65 5f70 7265 6669 7828 7072 6566  come_prefix(pref
+00003130: 6978 3a20 7374 7229 202d 3e20 7374 723a  ix: str) -> str:
+00003140: 0a20 2020 2069 6620 7072 6566 6978 2021  .    if prefix !
+00003150: 3d20 2727 2061 6e64 206e 6f74 2070 7265  = '' and not pre
+00003160: 6669 782e 656e 6473 7769 7468 2827 2f27  fix.endswith('/'
+00003170: 293a 0a20 2020 2020 2020 2070 7265 6669  ):.        prefi
+00003180: 7820 2b3d 2027 2f27 0a20 2020 2072 6574  x += '/'.    ret
+00003190: 7572 6e20 7072 6566 6978 0a0a 0a64 6566  urn prefix...def
+000031a0: 205f 7333 5f73 706c 6974 5f6d 6167 6963   _s3_split_magic
+000031b0: 2873 335f 7061 7468 6e61 6d65 3a20 7374  (s3_pathname: st
+000031c0: 7229 202d 3e20 5475 706c 655b 7374 722c  r) -> Tuple[str,
+000031d0: 2073 7472 5d3a 0a20 2020 2069 6620 6e6f   str]:.    if no
+000031e0: 7420 6861 735f 6d61 6769 6328 7333 5f70  t has_magic(s3_p
+000031f0: 6174 686e 616d 6529 3a0a 2020 2020 2020  athname):.      
+00003200: 2020 7265 7475 726e 2073 335f 7061 7468    return s3_path
+00003210: 6e61 6d65 2c20 2727 0a20 2020 2064 656c  name, ''.    del
+00003220: 696d 6974 6572 203d 2027 2f27 0a20 2020  imiter = '/'.   
+00003230: 206e 6f72 6d61 6c5f 7061 7274 7320 3d20   normal_parts = 
+00003240: 5b5d 0a20 2020 206d 6167 6963 5f70 6172  [].    magic_par
+00003250: 7473 203d 205b 5d0a 2020 2020 616c 6c5f  ts = [].    all_
+00003260: 7061 7274 7320 3d20 7333 5f70 6174 686e  parts = s3_pathn
+00003270: 616d 652e 7370 6c69 7428 6465 6c69 6d69  ame.split(delimi
+00003280: 7465 7229 0a20 2020 2066 6f72 2069 2c20  ter).    for i, 
+00003290: 7061 7274 2069 6e20 656e 756d 6572 6174  part in enumerat
+000032a0: 6528 616c 6c5f 7061 7274 7329 3a0a 2020  e(all_parts):.  
+000032b0: 2020 2020 2020 6966 206e 6f74 2068 6173        if not has
+000032c0: 5f6d 6167 6963 2870 6172 7429 3a0a 2020  _magic(part):.  
+000032d0: 2020 2020 2020 2020 2020 6e6f 726d 616c            normal
+000032e0: 5f70 6172 7473 2e61 7070 656e 6428 7061  _parts.append(pa
+000032f0: 7274 290a 2020 2020 2020 2020 656c 7365  rt).        else
+00003300: 3a0a 2020 2020 2020 2020 2020 2020 6d61  :.            ma
+00003310: 6769 635f 7061 7274 7320 3d20 616c 6c5f  gic_parts = all_
+00003320: 7061 7274 735b 693a 5d0a 2020 2020 2020  parts[i:].      
+00003330: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
+00003340: 7265 7475 726e 2064 656c 696d 6974 6572  return delimiter
+00003350: 2e6a 6f69 6e28 6e6f 726d 616c 5f70 6172  .join(normal_par
+00003360: 7473 292c 2064 656c 696d 6974 6572 2e6a  ts), delimiter.j
+00003370: 6f69 6e28 6d61 6769 635f 7061 7274 7329  oin(magic_parts)
+00003380: 0a0a 0a64 6566 205f 6c69 7374 5f6f 626a  ...def _list_obj
+00003390: 6563 7473 5f72 6563 7572 7369 7665 280a  ects_recursive(.
+000033a0: 2020 2020 2020 2020 7333 5f63 6c69 656e          s3_clien
+000033b0: 742c 2062 7563 6b65 743a 2073 7472 2c20  t, bucket: str, 
+000033c0: 7072 6566 6978 3a20 7374 722c 2064 656c  prefix: str, del
+000033d0: 696d 6974 6572 3a20 7374 7220 3d20 2727  imiter: str = ''
+000033e0: 293a 0a0a 2020 2020 7265 7370 203d 2073  ):..    resp = s
+000033f0: 335f 636c 6965 6e74 2e6c 6973 745f 6f62  3_client.list_ob
+00003400: 6a65 6374 735f 7632 280a 2020 2020 2020  jects_v2(.      
+00003410: 2020 4275 636b 6574 3d62 7563 6b65 742c    Bucket=bucket,
+00003420: 2050 7265 6669 783d 7072 6566 6978 2c20   Prefix=prefix, 
+00003430: 4465 6c69 6d69 7465 723d 6465 6c69 6d69  Delimiter=delimi
+00003440: 7465 722c 204d 6178 4b65 7973 3d6d 6178  ter, MaxKeys=max
+00003450: 5f6b 6579 7329 0a0a 2020 2020 7768 696c  _keys)..    whil
+00003460: 6520 5472 7565 3a0a 2020 2020 2020 2020  e True:.        
+00003470: 7969 656c 6420 7265 7370 0a0a 2020 2020  yield resp..    
+00003480: 2020 2020 6966 206e 6f74 2072 6573 705b      if not resp[
+00003490: 2749 7354 7275 6e63 6174 6564 275d 3a0a  'IsTruncated']:.
+000034a0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+000034b0: 6b0a 0a20 2020 2020 2020 2072 6573 7020  k..        resp 
+000034c0: 3d20 7333 5f63 6c69 656e 742e 6c69 7374  = s3_client.list
+000034d0: 5f6f 626a 6563 7473 5f76 3228 0a20 2020  _objects_v2(.   
+000034e0: 2020 2020 2020 2020 2042 7563 6b65 743d           Bucket=
+000034f0: 6275 636b 6574 2c0a 2020 2020 2020 2020  bucket,.        
+00003500: 2020 2020 5072 6566 6978 3d70 7265 6669      Prefix=prefi
+00003510: 782c 0a20 2020 2020 2020 2020 2020 2044  x,.            D
+00003520: 656c 696d 6974 6572 3d64 656c 696d 6974  elimiter=delimit
+00003530: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
+00003540: 436f 6e74 696e 7561 7469 6f6e 546f 6b65  ContinuationToke
+00003550: 6e3d 7265 7370 5b27 4e65 7874 436f 6e74  n=resp['NextCont
+00003560: 696e 7561 7469 6f6e 546f 6b65 6e27 5d2c  inuationToken'],
+00003570: 0a20 2020 2020 2020 2020 2020 204d 6178  .            Max
+00003580: 4b65 7973 3d6d 6178 5f6b 6579 7329 0a0a  Keys=max_keys)..
+00003590: 0a64 6566 205f 6d61 6b65 5f73 7461 7428  .def _make_stat(
+000035a0: 636f 6e74 656e 743a 2044 6963 745b 7374  content: Dict[st
+000035b0: 722c 2041 6e79 5d29 3a0a 2020 2020 7265  r, Any]):.    re
+000035c0: 7475 726e 2053 7461 7452 6573 756c 7428  turn StatResult(
+000035d0: 0a20 2020 2020 2020 2069 736c 6e6b 3d63  .        islnk=c
+000035e0: 6f6e 7465 6e74 2e67 6574 2827 6973 6c6e  ontent.get('isln
+000035f0: 6b27 2c20 4661 6c73 6529 2c0a 2020 2020  k', False),.    
+00003600: 2020 2020 7369 7a65 3d63 6f6e 7465 6e74      size=content
+00003610: 5b27 5369 7a65 275d 2c0a 2020 2020 2020  ['Size'],.      
+00003620: 2020 6d74 696d 653d 636f 6e74 656e 745b    mtime=content[
+00003630: 274c 6173 744d 6f64 6966 6965 6427 5d2e  'LastModified'].
+00003640: 7469 6d65 7374 616d 7028 292c 0a20 2020  timestamp(),.   
+00003650: 2020 2020 2065 7874 7261 3d63 6f6e 7465       extra=conte
+00003660: 6e74 2c0a 2020 2020 290a 0a0a 6465 6620  nt,.    )...def 
+00003670: 5f73 335f 676c 6f62 5f73 7461 745f 7369  _s3_glob_stat_si
+00003680: 6e67 6c65 5f70 6174 6828 0a20 2020 2020  ngle_path(.     
+00003690: 2020 2073 335f 7061 7468 6e61 6d65 3a20     s3_pathname: 
+000036a0: 5061 7468 4c69 6b65 2c0a 2020 2020 2020  PathLike,.      
+000036b0: 2020 7265 6375 7273 6976 653a 2062 6f6f    recursive: boo
+000036c0: 6c20 3d20 5472 7565 2c0a 2020 2020 2020  l = True,.      
+000036d0: 2020 6d69 7373 696e 675f 6f6b 3a20 626f    missing_ok: bo
+000036e0: 6f6c 203d 2054 7275 652c 0a20 2020 2020  ol = True,.     
+000036f0: 2020 2066 6f6c 6c6f 776c 696e 6b73 3a20     followlinks: 
+00003700: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
+00003710: 2020 2020 2020 7072 6f66 696c 655f 6e61        profile_na
+00003720: 6d65 3a20 4f70 7469 6f6e 616c 5b73 7472  me: Optional[str
+00003730: 5d20 3d20 4e6f 6e65 2920 2d3e 2049 7465  ] = None) -> Ite
+00003740: 7261 746f 725b 4669 6c65 456e 7472 795d  rator[FileEntry]
+00003750: 3a0a 2020 2020 6966 206e 6f74 2072 6563  :.    if not rec
+00003760: 7572 7369 7665 3a0a 2020 2020 2020 2020  ursive:.        
+00003770: 2320 4966 206e 6f74 2072 6563 7572 7369  # If not recursi
+00003780: 7665 2c20 7265 706c 6163 6520 2a2a 2077  ve, replace ** w
+00003790: 6974 6820 2a0a 2020 2020 2020 2020 7333  ith *.        s3
+000037a0: 5f70 6174 686e 616d 6520 3d20 7265 2e73  _pathname = re.s
+000037b0: 7562 2872 275c 2a7b 322c 7d27 2c20 272a  ub(r'\*{2,}', '*
+000037c0: 272c 2073 335f 7061 7468 6e61 6d65 290a  ', s3_pathname).
+000037d0: 2020 2020 746f 705f 6469 722c 2077 696c      top_dir, wil
+000037e0: 6463 6172 645f 7061 7274 203d 205f 7333  dcard_part = _s3
+000037f0: 5f73 706c 6974 5f6d 6167 6963 2873 335f  _split_magic(s3_
+00003800: 7061 7468 6e61 6d65 290a 2020 2020 7365  pathname).    se
+00003810: 6172 6368 5f64 6972 203d 2077 696c 6463  arch_dir = wildc
+00003820: 6172 645f 7061 7274 2e65 6e64 7377 6974  ard_part.endswit
+00003830: 6828 272f 2729 0a0a 2020 2020 6465 6620  h('/')..    def 
+00003840: 7368 6f75 6c64 5f72 6563 7572 7369 7665  should_recursive
+00003850: 2877 696c 6463 6172 645f 7061 7274 3a20  (wildcard_part: 
+00003860: 7374 7229 202d 3e20 626f 6f6c 3a0a 2020  str) -> bool:.  
+00003870: 2020 2020 2020 6966 2027 2a2a 2720 696e        if '**' in
+00003880: 2077 696c 6463 6172 645f 7061 7274 3a0a   wildcard_part:.
+00003890: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000038a0: 726e 2054 7275 650a 2020 2020 2020 2020  rn True.        
+000038b0: 666f 7220 6578 7061 6e64 6564 5f70 6174  for expanded_pat
+000038c0: 6820 696e 2075 6e67 6c6f 626c 697a 6528  h in ungloblize(
+000038d0: 7769 6c64 6361 7264 5f70 6172 7429 3a0a  wildcard_part):.
+000038e0: 2020 2020 2020 2020 2020 2020 7061 7274              part
+000038f0: 735f 6c65 6e67 7468 203d 206c 656e 2865  s_length = len(e
+00003900: 7870 616e 6465 645f 7061 7468 2e73 706c  xpanded_path.spl
+00003910: 6974 2827 2f27 2929 0a20 2020 2020 2020  it('/')).       
+00003920: 2020 2020 2069 6620 7061 7274 735f 6c65       if parts_le
+00003930: 6e67 7468 202b 2073 6561 7263 685f 6469  ngth + search_di
+00003940: 7220 3e3d 2032 3a0a 2020 2020 2020 2020  r >= 2:.        
+00003950: 2020 2020 2020 2020 7265 7475 726e 2054          return T
+00003960: 7275 650a 2020 2020 2020 2020 7265 7475  rue.        retu
+00003970: 726e 2046 616c 7365 0a0a 2020 2020 6465  rn False..    de
+00003980: 6620 6372 6561 7465 5f67 656e 6572 6174  f create_generat
+00003990: 6f72 285f 7333 5f70 6174 686e 616d 6529  or(_s3_pathname)
+000039a0: 202d 3e20 4974 6572 6174 6f72 5b46 696c   -> Iterator[Fil
+000039b0: 6545 6e74 7279 5d3a 0a20 2020 2020 2020  eEntry]:.       
+000039c0: 2069 6620 6e6f 7420 5333 5061 7468 2874   if not S3Path(t
+000039d0: 6f70 5f64 6972 292e 6578 6973 7473 2829  op_dir).exists()
+000039e0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+000039f0: 7475 726e 0a20 2020 2020 2020 2069 6620  turn.        if 
+00003a00: 6e6f 7420 6861 735f 6d61 6769 6328 5f73  not has_magic(_s
+00003a10: 335f 7061 7468 6e61 6d65 293a 0a20 2020  3_pathname):.   
+00003a20: 2020 2020 2020 2020 205f 7333 5f70 6174           _s3_pat
+00003a30: 686e 616d 655f 6f62 6a20 3d20 5333 5061  hname_obj = S3Pa
+00003a40: 7468 285f 7333 5f70 6174 686e 616d 6529  th(_s3_pathname)
+00003a50: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00003a60: 5f73 335f 7061 7468 6e61 6d65 5f6f 626a  _s3_pathname_obj
+00003a70: 2e69 735f 6669 6c65 2829 3a0a 2020 2020  .is_file():.    
+00003a80: 2020 2020 2020 2020 2020 2020 7374 6174              stat
+00003a90: 203d 2053 3350 6174 6828 5f73 335f 7061   = S3Path(_s3_pa
+00003aa0: 7468 6e61 6d65 292e 7374 6174 2866 6f6c  thname).stat(fol
+00003ab0: 6c6f 775f 7379 6d6c 696e 6b73 3d66 6f6c  low_symlinks=fol
+00003ac0: 6c6f 776c 696e 6b73 290a 2020 2020 2020  lowlinks).      
+00003ad0: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
+00003ae0: 4669 6c65 456e 7472 7928 0a20 2020 2020  FileEntry(.     
+00003af0: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+00003b00: 7333 5f70 6174 686e 616d 655f 6f62 6a2e  s3_pathname_obj.
+00003b10: 6e61 6d65 2c20 5f73 335f 7061 7468 6e61  name, _s3_pathna
+00003b20: 6d65 5f6f 626a 2e70 6174 682c 2073 7461  me_obj.path, sta
+00003b30: 7429 0a20 2020 2020 2020 2020 2020 2069  t).            i
+00003b40: 6620 5f73 335f 7061 7468 6e61 6d65 5f6f  f _s3_pathname_o
+00003b50: 626a 2e69 735f 6469 7228 293a 0a20 2020  bj.is_dir():.   
+00003b60: 2020 2020 2020 2020 2020 2020 2079 6965               yie
+00003b70: 6c64 2046 696c 6545 6e74 7279 280a 2020  ld FileEntry(.  
+00003b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003b90: 2020 5f73 335f 7061 7468 6e61 6d65 5f6f    _s3_pathname_o
+00003ba0: 626a 2e6e 616d 652c 205f 7333 5f70 6174  bj.name, _s3_pat
+00003bb0: 686e 616d 655f 6f62 6a2e 7061 7468 2c0a  hname_obj.path,.
 00003bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003bd0: 2020 2020 2020 2020 2020 2064 656c 696d             delim
-00003be0: 6974 6572 293a 0a20 2020 2020 2020 2020  iter):.         
-00003bf0: 2020 2020 2020 2066 6f72 2063 6f6e 7465         for conte
-00003c00: 6e74 2069 6e20 7265 7370 2e67 6574 2827  nt in resp.get('
-00003c10: 436f 6e74 656e 7473 272c 205b 5d29 3a0a  Contents', []):.
-00003c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003c30: 2020 2020 7061 7468 203d 2073 335f 7061      path = s3_pa
-00003c40: 7468 5f6a 6f69 6e28 2773 333a 2f2f 272c  th_join('s3://',
-00003c50: 2062 7563 6b65 742c 2063 6f6e 7465 6e74   bucket, content
-00003c60: 5b27 4b65 7927 5d29 0a20 2020 2020 2020  ['Key']).       
-00003c70: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00003c80: 6e6f 7420 7365 6172 6368 5f64 6972 2061  not search_dir a
-00003c90: 6e64 2070 6174 7465 726e 2e6d 6174 6368  nd pattern.match
-00003ca0: 2870 6174 6829 3a0a 2020 2020 2020 2020  (path):.        
-00003cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003cc0: 7969 656c 6420 4669 6c65 456e 7472 7928  yield FileEntry(
-00003cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003ce0: 2020 2020 2020 2020 2020 2020 2053 3350               S3P
-00003cf0: 6174 6828 7061 7468 292e 6e61 6d65 2c20  ath(path).name, 
-00003d00: 7061 7468 2c20 5f6d 616b 655f 7374 6174  path, _make_stat
-00003d10: 2863 6f6e 7465 6e74 2929 0a20 2020 2020  (content)).     
-00003d20: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00003d30: 6972 6e61 6d65 203d 206f 732e 7061 7468  irname = os.path
-00003d40: 2e64 6972 6e61 6d65 2870 6174 6829 0a20  .dirname(path). 
-00003d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003d60: 2020 2077 6869 6c65 2064 6972 6e61 6d65     while dirname
-00003d70: 206e 6f74 2069 6e20 6469 726e 616d 6573   not in dirnames
-00003d80: 2061 6e64 2064 6972 6e61 6d65 2021 3d20   and dirname != 
-00003d90: 746f 705f 6469 723a 0a20 2020 2020 2020  top_dir:.       
-00003da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003db0: 2064 6972 6e61 6d65 732e 6164 6428 6469   dirnames.add(di
-00003dc0: 726e 616d 6529 0a20 2020 2020 2020 2020  rname).         
-00003dd0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00003de0: 6174 6820 3d20 6469 726e 616d 6520 2b20  ath = dirname + 
-00003df0: 272f 2720 6966 2073 6561 7263 685f 6469  '/' if search_di
-00003e00: 7220 656c 7365 2064 6972 6e61 6d65 0a20  r else dirname. 
-00003e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003e20: 2020 2020 2020 2069 6620 7061 7474 6572         if patter
-00003e30: 6e2e 6d61 7463 6828 7061 7468 293a 0a20  n.match(path):. 
-00003e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003e50: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
-00003e60: 2046 696c 6545 6e74 7279 280a 2020 2020   FileEntry(.    
+00003bd0: 2020 2020 5374 6174 5265 7375 6c74 2869      StatResult(i
+00003be0: 7364 6972 3d54 7275 6529 290a 2020 2020  sdir=True)).    
+00003bf0: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
+00003c00: 2020 2020 2020 2020 6465 6c69 6d69 7465          delimite
+00003c10: 7220 3d20 2727 0a20 2020 2020 2020 2069  r = ''.        i
+00003c20: 6620 6e6f 7420 7368 6f75 6c64 5f72 6563  f not should_rec
+00003c30: 7572 7369 7665 2877 696c 6463 6172 645f  ursive(wildcard_
+00003c40: 7061 7274 293a 0a20 2020 2020 2020 2020  part):.         
+00003c50: 2020 2064 656c 696d 6974 6572 203d 2027     delimiter = '
+00003c60: 2f27 0a0a 2020 2020 2020 2020 6469 726e  /'..        dirn
+00003c70: 616d 6573 203d 2073 6574 2829 0a20 2020  ames = set().   
+00003c80: 2020 2020 2070 6174 7465 726e 203d 2072       pattern = r
+00003c90: 652e 636f 6d70 696c 6528 7472 616e 736c  e.compile(transl
+00003ca0: 6174 6528 5f73 335f 7061 7468 6e61 6d65  ate(_s3_pathname
+00003cb0: 2929 0a20 2020 2020 2020 2062 7563 6b65  )).        bucke
+00003cc0: 742c 206b 6579 203d 2070 6172 7365 5f73  t, key = parse_s
+00003cd0: 335f 7572 6c28 746f 705f 6469 7229 0a20  3_url(top_dir). 
+00003ce0: 2020 2020 2020 2070 7265 6669 7820 3d20         prefix = 
+00003cf0: 5f62 6563 6f6d 655f 7072 6566 6978 286b  _become_prefix(k
+00003d00: 6579 290a 2020 2020 2020 2020 636c 6965  ey).        clie
+00003d10: 6e74 203d 2067 6574 5f73 335f 636c 6965  nt = get_s3_clie
+00003d20: 6e74 2870 726f 6669 6c65 5f6e 616d 653d  nt(profile_name=
+00003d30: 7072 6f66 696c 655f 6e61 6d65 290a 2020  profile_name).  
+00003d40: 2020 2020 2020 7769 7468 2072 6169 7365        with raise
+00003d50: 5f73 335f 6572 726f 7228 5f73 335f 7061  _s3_error(_s3_pa
+00003d60: 7468 6e61 6d65 293a 0a20 2020 2020 2020  thname):.       
+00003d70: 2020 2020 2066 6f72 2072 6573 7020 696e       for resp in
+00003d80: 205f 6c69 7374 5f6f 626a 6563 7473 5f72   _list_objects_r
+00003d90: 6563 7572 7369 7665 2863 6c69 656e 742c  ecursive(client,
+00003da0: 2062 7563 6b65 742c 2070 7265 6669 782c   bucket, prefix,
+00003db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003de0: 2064 656c 696d 6974 6572 293a 0a20 2020   delimiter):.   
+00003df0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00003e00: 2063 6f6e 7465 6e74 2069 6e20 7265 7370   content in resp
+00003e10: 2e67 6574 2827 436f 6e74 656e 7473 272c  .get('Contents',
+00003e20: 205b 5d29 3a0a 2020 2020 2020 2020 2020   []):.          
+00003e30: 2020 2020 2020 2020 2020 7061 7468 203d            path =
+00003e40: 2073 335f 7061 7468 5f6a 6f69 6e28 2773   s3_path_join('s
+00003e50: 333a 2f2f 272c 2062 7563 6b65 742c 2063  3://', bucket, c
+00003e60: 6f6e 7465 6e74 5b27 4b65 7927 5d29 0a20  ontent['Key']). 
 00003e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003e80: 2020 2020 2020 2020 2020 2020 5333 5061              S3Pa
-00003e90: 7468 2870 6174 6829 2e6e 616d 652c 2070  th(path).name, p
-00003ea0: 6174 682c 2053 7461 7452 6573 756c 7428  ath, StatResult(
-00003eb0: 6973 6469 723d 5472 7565 2929 0a20 2020  isdir=True)).   
-00003ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003ed0: 2020 2020 2064 6972 6e61 6d65 203d 206f       dirname = o
-00003ee0: 732e 7061 7468 2e64 6972 6e61 6d65 2864  s.path.dirname(d
-00003ef0: 6972 6e61 6d65 290a 2020 2020 2020 2020  irname).        
-00003f00: 2020 2020 2020 2020 666f 7220 636f 6d6d          for comm
-00003f10: 6f6e 5f70 7265 6669 7820 696e 2072 6573  on_prefix in res
-00003f20: 702e 6765 7428 2743 6f6d 6d6f 6e50 7265  p.get('CommonPre
-00003f30: 6669 7865 7327 2c20 5b5d 293a 0a20 2020  fixes', []):.   
-00003f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003f50: 2070 6174 6820 3d20 7333 5f70 6174 685f   path = s3_path_
-00003f60: 6a6f 696e 280a 2020 2020 2020 2020 2020  join(.          
-00003f70: 2020 2020 2020 2020 2020 2020 2020 2773                's
-00003f80: 333a 2f2f 272c 2062 7563 6b65 742c 2063  3://', bucket, c
-00003f90: 6f6d 6d6f 6e5f 7072 6566 6978 5b27 5072  ommon_prefix['Pr
-00003fa0: 6566 6978 275d 290a 2020 2020 2020 2020  efix']).        
-00003fb0: 2020 2020 2020 2020 2020 2020 6469 726e              dirn
-00003fc0: 616d 6520 3d20 6f73 2e70 6174 682e 6469  ame = os.path.di
-00003fd0: 726e 616d 6528 7061 7468 290a 2020 2020  rname(path).    
-00003fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003ff0: 6966 2064 6972 6e61 6d65 206e 6f74 2069  if dirname not i
-00004000: 6e20 6469 726e 616d 6573 2061 6e64 2064  n dirnames and d
-00004010: 6972 6e61 6d65 2021 3d20 746f 705f 6469  irname != top_di
-00004020: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-00004030: 2020 2020 2020 2020 2020 2064 6972 6e61             dirna
-00004040: 6d65 732e 6164 6428 6469 726e 616d 6529  mes.add(dirname)
-00004050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004060: 2020 2020 2020 2020 2070 6174 6820 3d20           path = 
-00004070: 6469 726e 616d 6520 2b20 272f 2720 6966  dirname + '/' if
-00004080: 2073 6561 7263 685f 6469 7220 656c 7365   search_dir else
-00004090: 2064 6972 6e61 6d65 0a20 2020 2020 2020   dirname.       
-000040a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000040b0: 2069 6620 7061 7474 6572 6e2e 6d61 7463   if pattern.matc
-000040c0: 6828 7061 7468 293a 0a20 2020 2020 2020  h(path):.       
-000040d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000040e0: 2020 2020 2079 6965 6c64 2046 696c 6545       yield FileE
-000040f0: 6e74 7279 280a 2020 2020 2020 2020 2020  ntry(.          
-00004100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004110: 2020 2020 2020 5333 5061 7468 2870 6174        S3Path(pat
-00004120: 6829 2e6e 616d 652c 2070 6174 682c 2053  h).name, path, S
-00004130: 7461 7452 6573 756c 7428 6973 6469 723d  tatResult(isdir=
-00004140: 5472 7565 2929 0a0a 2020 2020 7265 7475  True))..    retu
-00004150: 726e 2063 7265 6174 655f 6765 6e65 7261  rn create_genera
-00004160: 746f 7228 7333 5f70 6174 686e 616d 6529  tor(s3_pathname)
-00004170: 0a0a 0a64 6566 205f 7333 5f73 6361 6e5f  ...def _s3_scan_
-00004180: 7061 6972 7328 7372 635f 7572 6c3a 2050  pairs(src_url: P
-00004190: 6174 684c 696b 652c 0a20 2020 2020 2020  athLike,.       
-000041a0: 2020 2020 2020 2020 2020 2020 6473 745f              dst_
-000041b0: 7572 6c3a 2050 6174 684c 696b 6529 202d  url: PathLike) -
-000041c0: 3e20 4974 6572 6174 6f72 5b54 7570 6c65  > Iterator[Tuple
-000041d0: 5b50 6174 684c 696b 652c 2050 6174 684c  [PathLike, PathL
-000041e0: 696b 655d 5d3a 0a20 2020 2066 6f72 2073  ike]]:.    for s
-000041f0: 7263 5f66 696c 655f 7061 7468 2069 6e20  rc_file_path in 
-00004200: 5333 5061 7468 2873 7263 5f75 726c 292e  S3Path(src_url).
-00004210: 7363 616e 2829 3a0a 2020 2020 2020 2020  scan():.        
-00004220: 636f 6e74 656e 745f 7061 7468 203d 2073  content_path = s
-00004230: 7263 5f66 696c 655f 7061 7468 5b6c 656e  rc_file_path[len
-00004240: 2873 7263 5f75 726c 293a 5d0a 2020 2020  (src_url):].    
-00004250: 2020 2020 6966 206c 656e 2863 6f6e 7465      if len(conte
-00004260: 6e74 5f70 6174 6829 203e 2030 3a0a 2020  nt_path) > 0:.  
-00004270: 2020 2020 2020 2020 2020 6473 745f 6669            dst_fi
-00004280: 6c65 5f70 6174 6820 3d20 7333 5f70 6174  le_path = s3_pat
-00004290: 685f 6a6f 696e 2864 7374 5f75 726c 2c20  h_join(dst_url, 
-000042a0: 636f 6e74 656e 745f 7061 7468 290a 2020  content_path).  
-000042b0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000042c0: 2020 2020 2020 2020 6473 745f 6669 6c65          dst_file
-000042d0: 5f70 6174 6820 3d20 6473 745f 7572 6c0a  _path = dst_url.
-000042e0: 2020 2020 2020 2020 7969 656c 6420 7372          yield sr
-000042f0: 635f 6669 6c65 5f70 6174 682c 2064 7374  c_file_path, dst
-00004300: 5f66 696c 655f 7061 7468 0a0a 0a64 6566  _file_path...def
-00004310: 205f 7333 5f67 6574 5f6d 6574 6164 6174   _s3_get_metadat
-00004320: 6128 7372 635f 7572 6c3a 2050 6174 684c  a(src_url: PathL
-00004330: 696b 6529 202d 3e20 6469 6374 3a0a 2020  ike) -> dict:.  
-00004340: 2020 2727 270a 2020 2020 4765 7420 6f62    '''.    Get ob
-00004350: 6a65 6374 206d 6574 6164 6174 610a 0a20  ject metadata.. 
-00004360: 2020 203a 7061 7261 6d20 7061 7468 3a20     :param path: 
-00004370: 4f62 6a65 6374 2070 6174 680a 2020 2020  Object path.    
-00004380: 3a72 6574 7572 6e73 3a20 4f62 6a65 6374  :returns: Object
-00004390: 206d 6574 6164 6174 610a 2020 2020 2727   metadata.    ''
-000043a0: 270a 2020 2020 6275 636b 6574 2c20 6b65  '.    bucket, ke
-000043b0: 7920 3d20 7061 7273 655f 7333 5f75 726c  y = parse_s3_url
-000043c0: 2873 7263 5f75 726c 290a 2020 2020 6966  (src_url).    if
-000043d0: 206e 6f74 2062 7563 6b65 743a 0a20 2020   not bucket:.   
-000043e0: 2020 2020 2072 6574 7572 6e20 7b7d 0a20       return {}. 
-000043f0: 2020 2069 6620 6e6f 7420 6b65 7920 6f72     if not key or
-00004400: 206b 6579 2e65 6e64 7377 6974 6828 272f   key.endswith('/
-00004410: 2729 3a0a 2020 2020 2020 2020 7265 7475  '):.        retu
-00004420: 726e 207b 7d0a 2020 2020 636c 6965 6e74  rn {}.    client
-00004430: 203d 2067 6574 5f73 335f 636c 6965 6e74   = get_s3_client
-00004440: 2829 0a20 2020 2074 7279 3a0a 2020 2020  ().    try:.    
-00004450: 2020 2020 7769 7468 2072 6169 7365 5f73      with raise_s
-00004460: 335f 6572 726f 7228 7372 635f 7572 6c29  3_error(src_url)
-00004470: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00004480: 7370 203d 2063 6c69 656e 742e 6865 6164  sp = client.head
-00004490: 5f6f 626a 6563 7428 4275 636b 6574 3d62  _object(Bucket=b
-000044a0: 7563 6b65 742c 204b 6579 3d6b 6579 290a  ucket, Key=key).
-000044b0: 2020 2020 2020 2020 7265 7475 726e 2064          return d
-000044c0: 6963 7428 0a20 2020 2020 2020 2020 2020  ict(.           
-000044d0: 2028 6b65 792e 6c6f 7765 7228 292c 2076   (key.lower(), v
-000044e0: 616c 7565 2920 666f 7220 6b65 792c 2076  alue) for key, v
-000044f0: 616c 7565 2069 6e20 7265 7370 5b27 4d65  alue in resp['Me
-00004500: 7461 6461 7461 275d 2e69 7465 6d73 2829  tadata'].items()
-00004510: 290a 2020 2020 6578 6365 7074 2045 7863  ).    except Exc
-00004520: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-00004530: 7265 7475 726e 207b 7d0a 0a0a 6465 6620  return {}...def 
-00004540: 6973 5f73 3328 7061 7468 3a20 5061 7468  is_s3(path: Path
-00004550: 4c69 6b65 2920 2d3e 2062 6f6f 6c3a 0a20  Like) -> bool:. 
-00004560: 2020 2027 2727 0a20 2020 2041 6363 6f72     '''.    Accor
-00004570: 6469 6e67 2074 6f20 6061 7773 2d63 6c69  ding to `aws-cli
-00004580: 203c 6874 7470 733a 2f2f 646f 6373 2e61   <https://docs.a
-00004590: 7773 2e61 6d61 7a6f 6e2e 636f 6d2f 636c  ws.amazon.com/cl
-000045a0: 692f 6c61 7465 7374 2f72 6566 6572 656e  i/latest/referen
-000045b0: 6365 2f73 332f 696e 6465 782e 6874 6d6c  ce/s3/index.html
-000045c0: 3e60 5f20 2c20 7465 7374 2069 6620 6120  >`_ , test if a 
-000045d0: 7061 7468 2069 7320 7333 2070 6174 680a  path is s3 path.
-000045e0: 0a20 2020 203a 7061 7261 6d20 7061 7468  .    :param path
-000045f0: 3a20 5061 7468 2074 6f20 6265 2074 6573  : Path to be tes
-00004600: 7465 640a 2020 2020 3a72 6574 7572 6e73  ted.    :returns
-00004610: 3a20 5472 7565 2069 6620 7061 7468 2069  : True if path i
-00004620: 7320 7333 2070 6174 682c 2065 6c73 6520  s s3 path, else 
-00004630: 4661 6c73 650a 2020 2020 2727 270a 2020  False.    '''.  
-00004640: 2020 7061 7468 203d 2066 7370 6174 6828    path = fspath(
-00004650: 7061 7468 290a 2020 2020 6966 206e 6f74  path).    if not
-00004660: 2070 6174 682e 7374 6172 7473 7769 7468   path.startswith
-00004670: 2827 7333 3a2f 2f27 293a 0a20 2020 2020  ('s3://'):.     
-00004680: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
-00004690: 2020 2020 7061 7274 7320 3d20 7572 6c73      parts = urls
-000046a0: 706c 6974 2870 6174 6829 0a20 2020 2072  plit(path).    r
-000046b0: 6574 7572 6e20 7061 7274 732e 7363 6865  eturn parts.sche
-000046c0: 6d65 203d 3d20 2773 3327 0a0a 0a64 6566  me == 's3'...def
-000046d0: 205f 7333 5f62 696e 6172 795f 6d6f 6465   _s3_binary_mode
-000046e0: 2873 335f 6f70 656e 5f66 756e 6329 3a0a  (s3_open_func):.
-000046f0: 0a20 2020 2040 7772 6170 7328 7333 5f6f  .    @wraps(s3_o
-00004700: 7065 6e5f 6675 6e63 290a 2020 2020 6465  pen_func).    de
-00004710: 6620 7772 6170 7065 7228 7333 5f75 726c  f wrapper(s3_url
-00004720: 2c20 6d6f 6465 3a20 7374 7220 3d20 2772  , mode: str = 'r
-00004730: 6227 2c20 2a2a 6b77 6172 6773 293a 0a20  b', **kwargs):. 
-00004740: 2020 2020 2020 2062 7563 6b65 742c 206b         bucket, k
-00004750: 6579 203d 2070 6172 7365 5f73 335f 7572  ey = parse_s3_ur
-00004760: 6c28 7333 5f75 726c 290a 2020 2020 2020  l(s3_url).      
-00004770: 2020 6966 206e 6f74 2062 7563 6b65 743a    if not bucket:
-00004780: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00004790: 7365 2053 3342 7563 6b65 744e 6f74 466f  se S3BucketNotFo
-000047a0: 756e 6445 7272 6f72 2827 456d 7074 7920  undError('Empty 
-000047b0: 6275 636b 6574 206e 616d 653a 2025 7227  bucket name: %r'
-000047c0: 2025 2073 335f 7572 6c29 0a0a 2020 2020   % s3_url)..    
-000047d0: 2020 2020 6966 206e 6f74 206b 6579 206f      if not key o
-000047e0: 7220 6b65 792e 656e 6473 7769 7468 2827  r key.endswith('
-000047f0: 2f27 293a 0a20 2020 2020 2020 2020 2020  /'):.           
-00004800: 2072 6169 7365 2053 3349 7341 4469 7265   raise S3IsADire
-00004810: 6374 6f72 7945 7272 6f72 2827 4973 2061  ctoryError('Is a
-00004820: 2064 6972 6563 746f 7279 3a20 2572 2720   directory: %r' 
-00004830: 2520 7333 5f75 726c 290a 0a20 2020 2020  % s3_url)..     
-00004840: 2020 2069 6620 2778 2720 696e 206d 6f64     if 'x' in mod
-00004850: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
-00004860: 6620 5333 5061 7468 2873 335f 7572 6c29  f S3Path(s3_url)
-00004870: 2e69 735f 6669 6c65 2829 3a0a 2020 2020  .is_file():.    
-00004880: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00004890: 6520 5333 4669 6c65 4578 6973 7473 4572  e S3FileExistsEr
-000048a0: 726f 7228 2746 696c 6520 6578 6973 7473  ror('File exists
-000048b0: 3a20 2572 2720 2520 7333 5f75 726c 290a  : %r' % s3_url).
-000048c0: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-000048d0: 203d 206d 6f64 652e 7265 706c 6163 6528   = mode.replace(
-000048e0: 2778 272c 2027 7727 290a 0a20 2020 2020  'x', 'w')..     
-000048f0: 2020 2069 6620 2777 2720 696e 206d 6f64     if 'w' in mod
-00004900: 6520 6f72 2027 6127 2069 6e20 6d6f 6465  e or 'a' in mode
-00004910: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00004920: 206e 6f74 2053 3350 6174 6828 7333 5f75   not S3Path(s3_u
-00004930: 726c 292e 6861 7362 7563 6b65 7428 293a  rl).hasbucket():
-00004940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004950: 2072 6169 7365 2053 3342 7563 6b65 744e   raise S3BucketN
-00004960: 6f74 466f 756e 6445 7272 6f72 2827 4e6f  otFoundError('No
-00004970: 2073 7563 6820 6275 636b 6574 3a20 2572   such bucket: %r
-00004980: 2720 2520 7333 5f75 726c 290a 0a20 2020  ' % s3_url)..   
-00004990: 2020 2020 2066 696c 656f 626a 203d 2073       fileobj = s
-000049a0: 335f 6f70 656e 5f66 756e 6328 7333 5f75  3_open_func(s3_u
-000049b0: 726c 2c20 6765 745f 6269 6e61 7279 5f6d  rl, get_binary_m
-000049c0: 6f64 6528 6d6f 6465 292c 202a 2a6b 7761  ode(mode), **kwa
-000049d0: 7267 7329 0a20 2020 2020 2020 2069 6620  rgs).        if 
-000049e0: 2762 2720 6e6f 7420 696e 206d 6f64 653a  'b' not in mode:
-000049f0: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
-00004a00: 656f 626a 203d 2069 6f2e 5465 7874 494f  eobj = io.TextIO
-00004a10: 5772 6170 7065 7228 6669 6c65 6f62 6a29  Wrapper(fileobj)
-00004a20: 2020 2320 7079 7479 7065 3a20 6469 7361    # pytype: disa
-00004a30: 626c 653d 7772 6f6e 672d 6172 672d 7479  ble=wrong-arg-ty
-00004a40: 7065 730a 2020 2020 2020 2020 2020 2020  pes.            
-00004a50: 6669 6c65 6f62 6a2e 6d6f 6465 203d 206d  fileobj.mode = m
-00004a60: 6f64 650a 2020 2020 2020 2020 7265 7475  ode.        retu
-00004a70: 726e 2066 696c 656f 626a 0a0a 2020 2020  rn fileobj..    
-00004a80: 7265 7475 726e 2077 7261 7070 6572 0a0a  return wrapper..
-00004a90: 0a40 5f73 335f 6269 6e61 7279 5f6d 6f64  .@_s3_binary_mod
-00004aa0: 650a 6465 6620 7333 5f70 7265 6665 7463  e.def s3_prefetc
-00004ab0: 685f 6f70 656e 280a 2020 2020 2020 2020  h_open(.        
-00004ac0: 7333 5f75 726c 3a20 5061 7468 4c69 6b65  s3_url: PathLike
-00004ad0: 2c0a 2020 2020 2020 2020 6d6f 6465 3a20  ,.        mode: 
-00004ae0: 7374 7220 3d20 2772 6227 2c0a 2020 2020  str = 'rb',.    
-00004af0: 2020 2020 666f 6c6c 6f77 6c69 6e6b 733a      followlinks:
-00004b00: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
-00004b10: 2020 2020 2020 202a 2c0a 2020 2020 2020         *,.      
-00004b20: 2020 6d61 785f 636f 6e63 7572 7265 6e63    max_concurrenc
-00004b30: 793a 204f 7074 696f 6e61 6c5b 696e 745d  y: Optional[int]
-00004b40: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00004b50: 206d 6178 5f62 6c6f 636b 5f73 697a 653a   max_block_size:
-00004b60: 2069 6e74 203d 2044 4546 4155 4c54 5f42   int = DEFAULT_B
-00004b70: 4c4f 434b 5f53 495a 4529 202d 3e20 5333  LOCK_SIZE) -> S3
-00004b80: 5072 6566 6574 6368 5265 6164 6572 3a0a  PrefetchReader:.
-00004b90: 2020 2020 2727 274f 7065 6e20 6120 6173      '''Open a as
-00004ba0: 796e 6368 726f 6e6f 7573 2070 7265 6665  ynchronous prefe
-00004bb0: 7463 6820 7265 6164 6572 2c20 746f 2073  tch reader, to s
-00004bc0: 7570 706f 7274 2066 6173 7420 7365 7175  upport fast sequ
-00004bd0: 656e 7469 616c 2072 6561 6420 616e 6420  ential read and 
-00004be0: 7261 6e64 6f6d 2072 6561 640a 0a20 2020  random read..   
-00004bf0: 202e 2e20 6e6f 7465 203a 3a0a 0a20 2020   .. note ::..   
-00004c00: 2020 2020 2055 7365 7220 7368 6f75 6c64       User should
-00004c10: 206d 616b 6520 7375 7265 2074 6861 7420   make sure that 
-00004c20: 7265 6164 6572 202f 2077 7269 7465 7220  reader / writer 
-00004c30: 6172 6520 636c 6f73 6564 2063 6f72 7265  are closed corre
-00004c40: 6374 6c79 0a0a 2020 2020 2020 2020 5375  ctly..        Su
-00004c50: 7070 6f72 7473 2063 6f6e 7465 7874 206d  pports context m
-00004c60: 616e 6167 6572 0a0a 2020 2020 2020 2020  anager..        
-00004c70: 536f 6d65 2070 6172 616d 6574 6572 2073  Some parameter s
-00004c80: 6574 7469 6e67 206d 6179 2070 6572 666f  etting may perfo
-00004c90: 726d 2077 656c 6c3a 206d 6178 5f63 6f6e  rm well: max_con
-00004ca0: 6375 7272 656e 6379 3d31 3020 6f72 2032  currency=10 or 2
-00004cb0: 302c 206d 6178 5f62 6c6f 636b 5f73 697a  0, max_block_siz
-00004cc0: 653d 3820 6f72 2031 3620 4d42 2c20 6465  e=8 or 16 MB, de
-00004cd0: 6661 756c 7420 7661 6c75 6520 4e6f 6e65  fault value None
-00004ce0: 206d 6561 6e73 2075 7369 6e67 2067 6c6f   means using glo
-00004cf0: 6261 6c20 7468 7265 6164 2070 6f6f 6c0a  bal thread pool.
-00004d00: 0a20 2020 203a 7061 7261 6d20 6d61 785f  .    :param max_
-00004d10: 636f 6e63 7572 7265 6e63 793a 204d 6178  concurrency: Max
-00004d20: 2064 6f77 6e6c 6f61 6420 7468 7265 6164   download thread
-00004d30: 206e 756d 6265 722c 204e 6f6e 6520 6279   number, None by
-00004d40: 2064 6566 6175 6c74 0a20 2020 203a 7061   default.    :pa
-00004d50: 7261 6d20 6d61 785f 626c 6f63 6b5f 7369  ram max_block_si
-00004d60: 7a65 3a20 4d61 7820 6461 7461 2073 697a  ze: Max data siz
-00004d70: 6520 646f 776e 6c6f 6164 6564 2062 7920  e downloaded by 
-00004d80: 6561 6368 2074 6872 6561 642c 2069 6e20  each thread, in 
-00004d90: 6279 7465 732c 2038 4d42 2062 7920 6465  bytes, 8MB by de
-00004da0: 6661 756c 740a 2020 2020 3a72 6574 7572  fault.    :retur
-00004db0: 6e73 3a20 416e 206f 7065 6e65 6420 5333  ns: An opened S3
-00004dc0: 5072 6566 6574 6368 5265 6164 6572 206f  PrefetchReader o
-00004dd0: 626a 6563 740a 2020 2020 3a72 6169 7365  bject.    :raise
-00004de0: 733a 2053 3346 696c 654e 6f74 466f 756e  s: S3FileNotFoun
-00004df0: 6445 7272 6f72 0a20 2020 2027 2727 0a20  dError.    '''. 
-00004e00: 2020 2069 6620 6d6f 6465 2021 3d20 2772     if mode != 'r
-00004e10: 6227 3a0a 2020 2020 2020 2020 7261 6973  b':.        rais
-00004e20: 6520 5661 6c75 6545 7272 6f72 2827 756e  e ValueError('un
-00004e30: 6163 6365 7074 6162 6c65 206d 6f64 653a  acceptable mode:
-00004e40: 2025 7227 2025 206d 6f64 6529 2020 2320   %r' % mode)  # 
-00004e50: 7072 6167 6d61 3a20 6e6f 2063 6f76 6572  pragma: no cover
-00004e60: 0a20 2020 2069 6620 666f 6c6c 6f77 6c69  .    if followli
-00004e70: 6e6b 733a 0a20 2020 2020 2020 206d 6574  nks:.        met
-00004e80: 6164 6174 6120 3d20 5f73 335f 6765 745f  adata = _s3_get_
-00004e90: 6d65 7461 6461 7461 2873 335f 7572 6c29  metadata(s3_url)
-00004ea0: 0a20 2020 2020 2020 2069 6620 6d65 7461  .        if meta
-00004eb0: 6461 7461 2061 6e64 2027 7379 6d6c 696e  data and 'symlin
-00004ec0: 6b5f 746f 2720 696e 206d 6574 6164 6174  k_to' in metadat
-00004ed0: 613a 0a20 2020 2020 2020 2020 2020 2073  a:.            s
-00004ee0: 335f 7572 6c20 3d20 6d65 7461 6461 7461  3_url = metadata
-00004ef0: 5b27 7379 6d6c 696e 6b5f 746f 275d 0a0a  ['symlink_to']..
-00004f00: 2020 2020 6275 636b 6574 2c20 6b65 7920      bucket, key 
-00004f10: 3d20 7061 7273 655f 7333 5f75 726c 2873  = parse_s3_url(s
-00004f20: 335f 7572 6c29 0a20 2020 2063 6f6e 6669  3_url).    confi
-00004f30: 6720 3d20 626f 746f 636f 7265 2e63 6f6e  g = botocore.con
-00004f40: 6669 672e 436f 6e66 6967 286d 6178 5f70  fig.Config(max_p
-00004f50: 6f6f 6c5f 636f 6e6e 6563 7469 6f6e 733d  ool_connections=
-00004f60: 6d61 785f 706f 6f6c 5f63 6f6e 6e65 6374  max_pool_connect
-00004f70: 696f 6e73 290a 2020 2020 636c 6965 6e74  ions).    client
-00004f80: 203d 2067 6574 5f73 335f 636c 6965 6e74   = get_s3_client
-00004f90: 2863 6f6e 6669 673d 636f 6e66 6967 2c20  (config=config, 
-00004fa0: 6361 6368 655f 6b65 793d 2773 335f 6669  cache_key='s3_fi
-00004fb0: 6c65 6c69 6b65 5f63 6c69 656e 7427 290a  lelike_client').
-00004fc0: 2020 2020 7265 7475 726e 2053 3350 7265      return S3Pre
-00004fd0: 6665 7463 6852 6561 6465 7228 0a20 2020  fetchReader(.   
-00004fe0: 2020 2020 2062 7563 6b65 742c 0a20 2020       bucket,.   
-00004ff0: 2020 2020 206b 6579 2c0a 2020 2020 2020       key,.      
-00005000: 2020 7333 5f63 6c69 656e 743d 636c 6965    s3_client=clie
-00005010: 6e74 2c0a 2020 2020 2020 2020 6d61 785f  nt,.        max_
-00005020: 7265 7472 6965 733d 6d61 785f 7265 7472  retries=max_retr
-00005030: 6965 732c 0a20 2020 2020 2020 206d 6178  ies,.        max
-00005040: 5f77 6f72 6b65 7273 3d6d 6178 5f63 6f6e  _workers=max_con
-00005050: 6375 7272 656e 6379 2c0a 2020 2020 2020  currency,.      
-00005060: 2020 626c 6f63 6b5f 7369 7a65 3d6d 6178    block_size=max
-00005070: 5f62 6c6f 636b 5f73 697a 6529 0a0a 0a40  _block_size)...@
-00005080: 5f73 335f 6269 6e61 7279 5f6d 6f64 650a  _s3_binary_mode.
-00005090: 6465 6620 7333 5f73 6861 7265 5f63 6163  def s3_share_cac
-000050a0: 6865 5f6f 7065 6e28 0a20 2020 2020 2020  he_open(.       
-000050b0: 2073 335f 7572 6c3a 2050 6174 684c 696b   s3_url: PathLik
-000050c0: 652c 0a20 2020 2020 2020 206d 6f64 653a  e,.        mode:
-000050d0: 2073 7472 203d 2027 7262 272c 0a20 2020   str = 'rb',.   
-000050e0: 2020 2020 2066 6f6c 6c6f 776c 696e 6b73       followlinks
-000050f0: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
-00005100: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
-00005110: 2020 2063 6163 6865 5f6b 6579 3a20 7374     cache_key: st
-00005120: 7220 3d20 276c 7275 272c 0a20 2020 2020  r = 'lru',.     
-00005130: 2020 206d 6178 5f63 6f6e 6375 7272 656e     max_concurren
-00005140: 6379 3a20 4f70 7469 6f6e 616c 5b69 6e74  cy: Optional[int
-00005150: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
-00005160: 2020 6d61 785f 626c 6f63 6b5f 7369 7a65    max_block_size
-00005170: 3a20 696e 7420 3d20 4445 4641 554c 545f  : int = DEFAULT_
-00005180: 424c 4f43 4b5f 5349 5a45 2920 2d3e 2053  BLOCK_SIZE) -> S
-00005190: 3353 6861 7265 4361 6368 6552 6561 6465  3ShareCacheReade
-000051a0: 723a 0a20 2020 2027 2727 4f70 656e 2061  r:.    '''Open a
-000051b0: 2061 7379 6e63 6872 6f6e 6f75 7320 7072   asynchronous pr
-000051c0: 6566 6574 6368 2072 6561 6465 722c 2074  efetch reader, t
-000051d0: 6f20 7375 7070 6f72 7420 6661 7374 2073  o support fast s
-000051e0: 6571 7565 6e74 6961 6c20 7265 6164 2061  equential read a
-000051f0: 6e64 2072 616e 646f 6d20 7265 6164 0a0a  nd random read..
-00005200: 2020 2020 2e2e 206e 6f74 6520 3a3a 0a0a      .. note ::..
-00005210: 2020 2020 2020 2020 5573 6572 2073 686f          User sho
-00005220: 756c 6420 6d61 6b65 2073 7572 6520 7468  uld make sure th
-00005230: 6174 2072 6561 6465 7220 2f20 7772 6974  at reader / writ
-00005240: 6572 2061 7265 2063 6c6f 7365 6420 636f  er are closed co
-00005250: 7272 6563 746c 790a 0a20 2020 2020 2020  rrectly..       
-00005260: 2053 7570 706f 7274 7320 636f 6e74 6578   Supports contex
-00005270: 7420 6d61 6e61 6765 720a 0a20 2020 2020  t manager..     
-00005280: 2020 2053 6f6d 6520 7061 7261 6d65 7465     Some paramete
-00005290: 7220 7365 7474 696e 6720 6d61 7920 7065  r setting may pe
-000052a0: 7266 6f72 6d20 7765 6c6c 3a20 6d61 785f  rform well: max_
-000052b0: 636f 6e63 7572 7265 6e63 793d 3130 206f  concurrency=10 o
-000052c0: 7220 3230 2c20 6d61 785f 626c 6f63 6b5f  r 20, max_block_
-000052d0: 7369 7a65 3d38 206f 7220 3136 204d 422c  size=8 or 16 MB,
-000052e0: 2064 6566 6175 6c74 2076 616c 7565 204e   default value N
-000052f0: 6f6e 6520 6d65 616e 7320 7573 696e 6720  one means using 
-00005300: 676c 6f62 616c 2074 6872 6561 6420 706f  global thread po
-00005310: 6f6c 0a0a 2020 2020 3a70 6172 616d 206d  ol..    :param m
-00005320: 6178 5f63 6f6e 6375 7272 656e 6379 3a20  ax_concurrency: 
-00005330: 4d61 7820 646f 776e 6c6f 6164 2074 6872  Max download thr
-00005340: 6561 6420 6e75 6d62 6572 2c20 4e6f 6e65  ead number, None
-00005350: 2062 7920 6465 6661 756c 740a 2020 2020   by default.    
-00005360: 3a70 6172 616d 206d 6178 5f62 6c6f 636b  :param max_block
-00005370: 5f73 697a 653a 204d 6178 2064 6174 6120  _size: Max data 
-00005380: 7369 7a65 2064 6f77 6e6c 6f61 6465 6420  size downloaded 
-00005390: 6279 2065 6163 6820 7468 7265 6164 2c20  by each thread, 
-000053a0: 696e 2062 7974 6573 2c20 384d 4220 6279  in bytes, 8MB by
-000053b0: 2064 6566 6175 6c74 0a20 2020 203a 7265   default.    :re
-000053c0: 7475 726e 733a 2041 6e20 6f70 656e 6564  turns: An opened
-000053d0: 2053 3353 6861 7265 4361 6368 6552 6561   S3ShareCacheRea
-000053e0: 6465 7220 6f62 6a65 6374 0a20 2020 203a  der object.    :
-000053f0: 7261 6973 6573 3a20 5333 4669 6c65 4e6f  raises: S3FileNo
-00005400: 7446 6f75 6e64 4572 726f 720a 2020 2020  tFoundError.    
-00005410: 2727 270a 2020 2020 6966 206d 6f64 6520  '''.    if mode 
-00005420: 213d 2027 7262 273a 0a20 2020 2020 2020  != 'rb':.       
-00005430: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00005440: 7228 2775 6e61 6363 6570 7461 626c 6520  r('unacceptable 
-00005450: 6d6f 6465 3a20 2572 2720 2520 6d6f 6465  mode: %r' % mode
-00005460: 2920 2023 2070 7261 676d 613a 206e 6f20  )  # pragma: no 
-00005470: 636f 7665 720a 2020 2020 6966 2066 6f6c  cover.    if fol
-00005480: 6c6f 776c 696e 6b73 3a0a 2020 2020 2020  lowlinks:.      
-00005490: 2020 6d65 7461 6461 7461 203d 205f 7333    metadata = _s3
-000054a0: 5f67 6574 5f6d 6574 6164 6174 6128 7333  _get_metadata(s3
-000054b0: 5f75 726c 290a 2020 2020 2020 2020 6966  _url).        if
-000054c0: 206d 6574 6164 6174 6120 616e 6420 2773   metadata and 's
-000054d0: 796d 6c69 6e6b 5f74 6f27 2069 6e20 6d65  ymlink_to' in me
-000054e0: 7461 6461 7461 3a0a 2020 2020 2020 2020  tadata:.        
-000054f0: 2020 2020 7333 5f75 726c 203d 206d 6574      s3_url = met
-00005500: 6164 6174 615b 2773 796d 6c69 6e6b 5f74  adata['symlink_t
-00005510: 6f27 5d0a 0a20 2020 2062 7563 6b65 742c  o']..    bucket,
-00005520: 206b 6579 203d 2070 6172 7365 5f73 335f   key = parse_s3_
-00005530: 7572 6c28 7333 5f75 726c 290a 2020 2020  url(s3_url).    
-00005540: 636f 6e66 6967 203d 2062 6f74 6f63 6f72  config = botocor
-00005550: 652e 636f 6e66 6967 2e43 6f6e 6669 6728  e.config.Config(
-00005560: 6d61 785f 706f 6f6c 5f63 6f6e 6e65 6374  max_pool_connect
-00005570: 696f 6e73 3d6d 6178 5f70 6f6f 6c5f 636f  ions=max_pool_co
-00005580: 6e6e 6563 7469 6f6e 7329 0a20 2020 2063  nnections).    c
-00005590: 6c69 656e 7420 3d20 6765 745f 7333 5f63  lient = get_s3_c
-000055a0: 6c69 656e 7428 636f 6e66 6967 3d63 6f6e  lient(config=con
-000055b0: 6669 672c 2063 6163 6865 5f6b 6579 3d27  fig, cache_key='
-000055c0: 7333 5f66 696c 656c 696b 655f 636c 6965  s3_filelike_clie
-000055d0: 6e74 2729 0a20 2020 2072 6574 7572 6e20  nt').    return 
-000055e0: 5333 5368 6172 6543 6163 6865 5265 6164  S3ShareCacheRead
-000055f0: 6572 280a 2020 2020 2020 2020 6275 636b  er(.        buck
-00005600: 6574 2c0a 2020 2020 2020 2020 6b65 792c  et,.        key,
+00003e80: 2020 2069 6620 6e6f 7420 7365 6172 6368     if not search
+00003e90: 5f64 6972 2061 6e64 2070 6174 7465 726e  _dir and pattern
+00003ea0: 2e6d 6174 6368 2870 6174 6829 3a0a 2020  .match(path):.  
+00003eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003ec0: 2020 2020 2020 7969 656c 6420 4669 6c65        yield File
+00003ed0: 456e 7472 7928 0a20 2020 2020 2020 2020  Entry(.         
+00003ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003ef0: 2020 2053 3350 6174 6828 7061 7468 292e     S3Path(path).
+00003f00: 6e61 6d65 2c20 7061 7468 2c20 5f6d 616b  name, path, _mak
+00003f10: 655f 7374 6174 2863 6f6e 7465 6e74 2929  e_stat(content))
+00003f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003f30: 2020 2020 2064 6972 6e61 6d65 203d 206f       dirname = o
+00003f40: 732e 7061 7468 2e64 6972 6e61 6d65 2870  s.path.dirname(p
+00003f50: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
+00003f60: 2020 2020 2020 2020 2077 6869 6c65 2064           while d
+00003f70: 6972 6e61 6d65 206e 6f74 2069 6e20 6469  irname not in di
+00003f80: 726e 616d 6573 2061 6e64 2064 6972 6e61  rnames and dirna
+00003f90: 6d65 2021 3d20 746f 705f 6469 723a 0a20  me != top_dir:. 
+00003fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003fb0: 2020 2020 2020 2064 6972 6e61 6d65 732e         dirnames.
+00003fc0: 6164 6428 6469 726e 616d 6529 0a20 2020  add(dirname).   
+00003fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003fe0: 2020 2020 2070 6174 6820 3d20 6469 726e       path = dirn
+00003ff0: 616d 6520 2b20 272f 2720 6966 2073 6561  ame + '/' if sea
+00004000: 7263 685f 6469 7220 656c 7365 2064 6972  rch_dir else dir
+00004010: 6e61 6d65 0a20 2020 2020 2020 2020 2020  name.           
+00004020: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00004030: 7061 7474 6572 6e2e 6d61 7463 6828 7061  pattern.match(pa
+00004040: 7468 293a 0a20 2020 2020 2020 2020 2020  th):.           
+00004050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004060: 2079 6965 6c64 2046 696c 6545 6e74 7279   yield FileEntry
+00004070: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00004080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004090: 2020 5333 5061 7468 2870 6174 6829 2e6e    S3Path(path).n
+000040a0: 616d 652c 2070 6174 682c 2053 7461 7452  ame, path, StatR
+000040b0: 6573 756c 7428 6973 6469 723d 5472 7565  esult(isdir=True
+000040c0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+000040d0: 2020 2020 2020 2020 2020 2064 6972 6e61             dirna
+000040e0: 6d65 203d 206f 732e 7061 7468 2e64 6972  me = os.path.dir
+000040f0: 6e61 6d65 2864 6972 6e61 6d65 290a 2020  name(dirname).  
+00004100: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00004110: 7220 636f 6d6d 6f6e 5f70 7265 6669 7820  r common_prefix 
+00004120: 696e 2072 6573 702e 6765 7428 2743 6f6d  in resp.get('Com
+00004130: 6d6f 6e50 7265 6669 7865 7327 2c20 5b5d  monPrefixes', []
+00004140: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00004150: 2020 2020 2020 2070 6174 6820 3d20 7333         path = s3
+00004160: 5f70 6174 685f 6a6f 696e 280a 2020 2020  _path_join(.    
+00004170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004180: 2020 2020 2773 333a 2f2f 272c 2062 7563      's3://', buc
+00004190: 6b65 742c 2063 6f6d 6d6f 6e5f 7072 6566  ket, common_pref
+000041a0: 6978 5b27 5072 6566 6978 275d 290a 2020  ix['Prefix']).  
+000041b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000041c0: 2020 6469 726e 616d 6520 3d20 6f73 2e70    dirname = os.p
+000041d0: 6174 682e 6469 726e 616d 6528 7061 7468  ath.dirname(path
+000041e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000041f0: 2020 2020 2020 6966 2064 6972 6e61 6d65        if dirname
+00004200: 206e 6f74 2069 6e20 6469 726e 616d 6573   not in dirnames
+00004210: 2061 6e64 2064 6972 6e61 6d65 2021 3d20   and dirname != 
+00004220: 746f 705f 6469 723a 0a20 2020 2020 2020  top_dir:.       
+00004230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004240: 2064 6972 6e61 6d65 732e 6164 6428 6469   dirnames.add(di
+00004250: 726e 616d 6529 0a20 2020 2020 2020 2020  rname).         
+00004260: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00004270: 6174 6820 3d20 6469 726e 616d 6520 2b20  ath = dirname + 
+00004280: 272f 2720 6966 2073 6561 7263 685f 6469  '/' if search_di
+00004290: 7220 656c 7365 2064 6972 6e61 6d65 0a20  r else dirname. 
+000042a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000042b0: 2020 2020 2020 2069 6620 7061 7474 6572         if patter
+000042c0: 6e2e 6d61 7463 6828 7061 7468 293a 0a20  n.match(path):. 
+000042d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000042e0: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
+000042f0: 2046 696c 6545 6e74 7279 280a 2020 2020   FileEntry(.    
+00004300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004310: 2020 2020 2020 2020 2020 2020 5333 5061              S3Pa
+00004320: 7468 2870 6174 6829 2e6e 616d 652c 2070  th(path).name, p
+00004330: 6174 682c 2053 7461 7452 6573 756c 7428  ath, StatResult(
+00004340: 6973 6469 723d 5472 7565 2929 0a0a 2020  isdir=True))..  
+00004350: 2020 7265 7475 726e 2063 7265 6174 655f    return create_
+00004360: 6765 6e65 7261 746f 7228 7333 5f70 6174  generator(s3_pat
+00004370: 686e 616d 6529 0a0a 0a64 6566 205f 7333  hname)...def _s3
+00004380: 5f73 6361 6e5f 7061 6972 7328 7372 635f  _scan_pairs(src_
+00004390: 7572 6c3a 2050 6174 684c 696b 652c 0a20  url: PathLike,. 
+000043a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000043b0: 2020 6473 745f 7572 6c3a 2050 6174 684c    dst_url: PathL
+000043c0: 696b 6529 202d 3e20 4974 6572 6174 6f72  ike) -> Iterator
+000043d0: 5b54 7570 6c65 5b50 6174 684c 696b 652c  [Tuple[PathLike,
+000043e0: 2050 6174 684c 696b 655d 5d3a 0a20 2020   PathLike]]:.   
+000043f0: 2066 6f72 2073 7263 5f66 696c 655f 7061   for src_file_pa
+00004400: 7468 2069 6e20 5333 5061 7468 2873 7263  th in S3Path(src
+00004410: 5f75 726c 292e 7363 616e 2829 3a0a 2020  _url).scan():.  
+00004420: 2020 2020 2020 636f 6e74 656e 745f 7061        content_pa
+00004430: 7468 203d 2073 7263 5f66 696c 655f 7061  th = src_file_pa
+00004440: 7468 5b6c 656e 2873 7263 5f75 726c 293a  th[len(src_url):
+00004450: 5d0a 2020 2020 2020 2020 6966 206c 656e  ].        if len
+00004460: 2863 6f6e 7465 6e74 5f70 6174 6829 203e  (content_path) >
+00004470: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00004480: 6473 745f 6669 6c65 5f70 6174 6820 3d20  dst_file_path = 
+00004490: 7333 5f70 6174 685f 6a6f 696e 2864 7374  s3_path_join(dst
+000044a0: 5f75 726c 2c20 636f 6e74 656e 745f 7061  _url, content_pa
+000044b0: 7468 290a 2020 2020 2020 2020 656c 7365  th).        else
+000044c0: 3a0a 2020 2020 2020 2020 2020 2020 6473  :.            ds
+000044d0: 745f 6669 6c65 5f70 6174 6820 3d20 6473  t_file_path = ds
+000044e0: 745f 7572 6c0a 2020 2020 2020 2020 7969  t_url.        yi
+000044f0: 656c 6420 7372 635f 6669 6c65 5f70 6174  eld src_file_pat
+00004500: 682c 2064 7374 5f66 696c 655f 7061 7468  h, dst_file_path
+00004510: 0a0a 0a64 6566 2069 735f 7333 2870 6174  ...def is_s3(pat
+00004520: 683a 2050 6174 684c 696b 6529 202d 3e20  h: PathLike) -> 
+00004530: 626f 6f6c 3a0a 2020 2020 2727 270a 2020  bool:.    '''.  
+00004540: 2020 312e 2041 6363 6f72 6469 6e67 2074    1. According t
+00004550: 6f20 6061 7773 2d63 6c69 203c 6874 7470  o `aws-cli <http
+00004560: 733a 2f2f 646f 6373 2e61 7773 2e61 6d61  s://docs.aws.ama
+00004570: 7a6f 6e2e 636f 6d2f 636c 692f 6c61 7465  zon.com/cli/late
+00004580: 7374 2f72 6566 6572 656e 6365 2f73 332f  st/reference/s3/
+00004590: 696e 6465 782e 6874 6d6c 3e60 5f20 2c20  index.html>`_ , 
+000045a0: 7465 7374 2069 6620 6120 7061 7468 2069  test if a path i
+000045b0: 7320 7333 2070 6174 682e 0a20 2020 2032  s s3 path..    2
+000045c0: 2e20 6d65 6766 696c 6520 616c 736f 2073  . megfile also s
+000045d0: 7570 706f 7274 2074 6865 2070 6174 6820  upport the path 
+000045e0: 6c69 6b65 2060 7333 5b2b 7072 6f66 696c  like `s3[+profil
+000045f0: 655f 6e61 6d65 5d3a 2f2f 6275 636b 6574  e_name]://bucket
+00004600: 2f6b 6579 600a 0a20 2020 203a 7061 7261  /key`..    :para
+00004610: 6d20 7061 7468 3a20 5061 7468 2074 6f20  m path: Path to 
+00004620: 6265 2074 6573 7465 640a 2020 2020 3a72  be tested.    :r
+00004630: 6574 7572 6e73 3a20 5472 7565 2069 6620  eturns: True if 
+00004640: 7061 7468 2069 7320 7333 2070 6174 682c  path is s3 path,
+00004650: 2065 6c73 6520 4661 6c73 650a 2020 2020   else False.    
+00004660: 2727 270a 2020 2020 7061 7468 203d 2066  '''.    path = f
+00004670: 7370 6174 6828 7061 7468 290a 2020 2020  spath(path).    
+00004680: 6966 2072 652e 6d61 7463 6828 7227 5e73  if re.match(r'^s
+00004690: 3328 5c2b 5c77 2b29 3f3a 5c2f 5c2f 272c  3(\+\w+)?:\/\/',
+000046a0: 2070 6174 6829 3a0a 2020 2020 2020 2020   path):.        
+000046b0: 7265 7475 726e 2054 7275 650a 2020 2020  return True.    
+000046c0: 7265 7475 726e 2046 616c 7365 0a0a 0a64  return False...d
+000046d0: 6566 205f 7333 5f62 696e 6172 795f 6d6f  ef _s3_binary_mo
+000046e0: 6465 2873 335f 6f70 656e 5f66 756e 6329  de(s3_open_func)
+000046f0: 3a0a 0a20 2020 2040 7772 6170 7328 7333  :..    @wraps(s3
+00004700: 5f6f 7065 6e5f 6675 6e63 290a 2020 2020  _open_func).    
+00004710: 6465 6620 7772 6170 7065 7228 7333 5f75  def wrapper(s3_u
+00004720: 726c 2c20 6d6f 6465 3a20 7374 7220 3d20  rl, mode: str = 
+00004730: 2772 6227 2c20 2a2a 6b77 6172 6773 293a  'rb', **kwargs):
+00004740: 0a20 2020 2020 2020 2062 7563 6b65 742c  .        bucket,
+00004750: 206b 6579 203d 2070 6172 7365 5f73 335f   key = parse_s3_
+00004760: 7572 6c28 7333 5f75 726c 290a 2020 2020  url(s3_url).    
+00004770: 2020 2020 6966 206e 6f74 2062 7563 6b65      if not bucke
+00004780: 743a 0a20 2020 2020 2020 2020 2020 2072  t:.            r
+00004790: 6169 7365 2053 3342 7563 6b65 744e 6f74  aise S3BucketNot
+000047a0: 466f 756e 6445 7272 6f72 2827 456d 7074  FoundError('Empt
+000047b0: 7920 6275 636b 6574 206e 616d 653a 2025  y bucket name: %
+000047c0: 7227 2025 2073 335f 7572 6c29 0a0a 2020  r' % s3_url)..  
+000047d0: 2020 2020 2020 6966 206e 6f74 206b 6579        if not key
+000047e0: 206f 7220 6b65 792e 656e 6473 7769 7468   or key.endswith
+000047f0: 2827 2f27 293a 0a20 2020 2020 2020 2020  ('/'):.         
+00004800: 2020 2072 6169 7365 2053 3349 7341 4469     raise S3IsADi
+00004810: 7265 6374 6f72 7945 7272 6f72 2827 4973  rectoryError('Is
+00004820: 2061 2064 6972 6563 746f 7279 3a20 2572   a directory: %r
+00004830: 2720 2520 7333 5f75 726c 290a 0a20 2020  ' % s3_url)..   
+00004840: 2020 2020 2069 6620 2778 2720 696e 206d       if 'x' in m
+00004850: 6f64 653a 0a20 2020 2020 2020 2020 2020  ode:.           
+00004860: 2069 6620 5333 5061 7468 2873 335f 7572   if S3Path(s3_ur
+00004870: 6c29 2e69 735f 6669 6c65 2829 3a0a 2020  l).is_file():.  
+00004880: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00004890: 6973 6520 5333 4669 6c65 4578 6973 7473  ise S3FileExists
+000048a0: 4572 726f 7228 2746 696c 6520 6578 6973  Error('File exis
+000048b0: 7473 3a20 2572 2720 2520 7333 5f75 726c  ts: %r' % s3_url
+000048c0: 290a 2020 2020 2020 2020 2020 2020 6d6f  ).            mo
+000048d0: 6465 203d 206d 6f64 652e 7265 706c 6163  de = mode.replac
+000048e0: 6528 2778 272c 2027 7727 290a 0a20 2020  e('x', 'w')..   
+000048f0: 2020 2020 2069 6620 2777 2720 696e 206d       if 'w' in m
+00004900: 6f64 6520 6f72 2027 6127 2069 6e20 6d6f  ode or 'a' in mo
+00004910: 6465 3a0a 2020 2020 2020 2020 2020 2020  de:.            
+00004920: 6966 206e 6f74 2053 3350 6174 6828 7333  if not S3Path(s3
+00004930: 5f75 726c 292e 6861 7362 7563 6b65 7428  _url).hasbucket(
+00004940: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00004950: 2020 2072 6169 7365 2053 3342 7563 6b65     raise S3Bucke
+00004960: 744e 6f74 466f 756e 6445 7272 6f72 2827  tNotFoundError('
+00004970: 4e6f 2073 7563 6820 6275 636b 6574 3a20  No such bucket: 
+00004980: 2572 2720 2520 7333 5f75 726c 290a 0a20  %r' % s3_url).. 
+00004990: 2020 2020 2020 2066 696c 656f 626a 203d         fileobj =
+000049a0: 2073 335f 6f70 656e 5f66 756e 6328 7333   s3_open_func(s3
+000049b0: 5f75 726c 2c20 6765 745f 6269 6e61 7279  _url, get_binary
+000049c0: 5f6d 6f64 6528 6d6f 6465 292c 202a 2a6b  _mode(mode), **k
+000049d0: 7761 7267 7329 0a20 2020 2020 2020 2069  wargs).        i
+000049e0: 6620 2762 2720 6e6f 7420 696e 206d 6f64  f 'b' not in mod
+000049f0: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
+00004a00: 696c 656f 626a 203d 2069 6f2e 5465 7874  ileobj = io.Text
+00004a10: 494f 5772 6170 7065 7228 6669 6c65 6f62  IOWrapper(fileob
+00004a20: 6a29 2020 2320 7079 7479 7065 3a20 6469  j)  # pytype: di
+00004a30: 7361 626c 653d 7772 6f6e 672d 6172 672d  sable=wrong-arg-
+00004a40: 7479 7065 730a 2020 2020 2020 2020 2020  types.          
+00004a50: 2020 6669 6c65 6f62 6a2e 6d6f 6465 203d    fileobj.mode =
+00004a60: 206d 6f64 650a 2020 2020 2020 2020 7265   mode.        re
+00004a70: 7475 726e 2066 696c 656f 626a 0a0a 2020  turn fileobj..  
+00004a80: 2020 7265 7475 726e 2077 7261 7070 6572    return wrapper
+00004a90: 0a0a 0a40 5f73 335f 6269 6e61 7279 5f6d  ...@_s3_binary_m
+00004aa0: 6f64 650a 6465 6620 7333 5f70 7265 6665  ode.def s3_prefe
+00004ab0: 7463 685f 6f70 656e 280a 2020 2020 2020  tch_open(.      
+00004ac0: 2020 7333 5f75 726c 3a20 5061 7468 4c69    s3_url: PathLi
+00004ad0: 6b65 2c0a 2020 2020 2020 2020 6d6f 6465  ke,.        mode
+00004ae0: 3a20 7374 7220 3d20 2772 6227 2c0a 2020  : str = 'rb',.  
+00004af0: 2020 2020 2020 666f 6c6c 6f77 6c69 6e6b        followlink
+00004b00: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
+00004b10: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
+00004b20: 2020 2020 6d61 785f 636f 6e63 7572 7265      max_concurre
+00004b30: 6e63 793a 204f 7074 696f 6e61 6c5b 696e  ncy: Optional[in
+00004b40: 745d 203d 204e 6f6e 652c 0a20 2020 2020  t] = None,.     
+00004b50: 2020 206d 6178 5f62 6c6f 636b 5f73 697a     max_block_siz
+00004b60: 653a 2069 6e74 203d 2044 4546 4155 4c54  e: int = DEFAULT
+00004b70: 5f42 4c4f 434b 5f53 495a 4529 202d 3e20  _BLOCK_SIZE) -> 
+00004b80: 5333 5072 6566 6574 6368 5265 6164 6572  S3PrefetchReader
+00004b90: 3a0a 2020 2020 2727 274f 7065 6e20 6120  :.    '''Open a 
+00004ba0: 6173 796e 6368 726f 6e6f 7573 2070 7265  asynchronous pre
+00004bb0: 6665 7463 6820 7265 6164 6572 2c20 746f  fetch reader, to
+00004bc0: 2073 7570 706f 7274 2066 6173 7420 7365   support fast se
+00004bd0: 7175 656e 7469 616c 2072 6561 6420 616e  quential read an
+00004be0: 6420 7261 6e64 6f6d 2072 6561 640a 0a20  d random read.. 
+00004bf0: 2020 202e 2e20 6e6f 7465 203a 3a0a 0a20     .. note ::.. 
+00004c00: 2020 2020 2020 2055 7365 7220 7368 6f75         User shou
+00004c10: 6c64 206d 616b 6520 7375 7265 2074 6861  ld make sure tha
+00004c20: 7420 7265 6164 6572 202f 2077 7269 7465  t reader / write
+00004c30: 7220 6172 6520 636c 6f73 6564 2063 6f72  r are closed cor
+00004c40: 7265 6374 6c79 0a0a 2020 2020 2020 2020  rectly..        
+00004c50: 5375 7070 6f72 7473 2063 6f6e 7465 7874  Supports context
+00004c60: 206d 616e 6167 6572 0a0a 2020 2020 2020   manager..      
+00004c70: 2020 536f 6d65 2070 6172 616d 6574 6572    Some parameter
+00004c80: 2073 6574 7469 6e67 206d 6179 2070 6572   setting may per
+00004c90: 666f 726d 2077 656c 6c3a 206d 6178 5f63  form well: max_c
+00004ca0: 6f6e 6375 7272 656e 6379 3d31 3020 6f72  oncurrency=10 or
+00004cb0: 2032 302c 206d 6178 5f62 6c6f 636b 5f73   20, max_block_s
+00004cc0: 697a 653d 3820 6f72 2031 3620 4d42 2c20  ize=8 or 16 MB, 
+00004cd0: 6465 6661 756c 7420 7661 6c75 6520 4e6f  default value No
+00004ce0: 6e65 206d 6561 6e73 2075 7369 6e67 2067  ne means using g
+00004cf0: 6c6f 6261 6c20 7468 7265 6164 2070 6f6f  lobal thread poo
+00004d00: 6c0a 0a20 2020 203a 7061 7261 6d20 6d61  l..    :param ma
+00004d10: 785f 636f 6e63 7572 7265 6e63 793a 204d  x_concurrency: M
+00004d20: 6178 2064 6f77 6e6c 6f61 6420 7468 7265  ax download thre
+00004d30: 6164 206e 756d 6265 722c 204e 6f6e 6520  ad number, None 
+00004d40: 6279 2064 6566 6175 6c74 0a20 2020 203a  by default.    :
+00004d50: 7061 7261 6d20 6d61 785f 626c 6f63 6b5f  param max_block_
+00004d60: 7369 7a65 3a20 4d61 7820 6461 7461 2073  size: Max data s
+00004d70: 697a 6520 646f 776e 6c6f 6164 6564 2062  ize downloaded b
+00004d80: 7920 6561 6368 2074 6872 6561 642c 2069  y each thread, i
+00004d90: 6e20 6279 7465 732c 2038 4d42 2062 7920  n bytes, 8MB by 
+00004da0: 6465 6661 756c 740a 2020 2020 3a72 6574  default.    :ret
+00004db0: 7572 6e73 3a20 416e 206f 7065 6e65 6420  urns: An opened 
+00004dc0: 5333 5072 6566 6574 6368 5265 6164 6572  S3PrefetchReader
+00004dd0: 206f 626a 6563 740a 2020 2020 3a72 6169   object.    :rai
+00004de0: 7365 733a 2053 3346 696c 654e 6f74 466f  ses: S3FileNotFo
+00004df0: 756e 6445 7272 6f72 0a20 2020 2027 2727  undError.    '''
+00004e00: 0a20 2020 2069 6620 6d6f 6465 2021 3d20  .    if mode != 
+00004e10: 2772 6227 3a0a 2020 2020 2020 2020 7261  'rb':.        ra
+00004e20: 6973 6520 5661 6c75 6545 7272 6f72 2827  ise ValueError('
+00004e30: 756e 6163 6365 7074 6162 6c65 206d 6f64  unacceptable mod
+00004e40: 653a 2025 7227 2025 206d 6f64 6529 2020  e: %r' % mode)  
+00004e50: 2320 7072 6167 6d61 3a20 6e6f 2063 6f76  # pragma: no cov
+00004e60: 6572 0a20 2020 2073 335f 7572 6c20 3d20  er.    s3_url = 
+00004e70: 5333 5061 7468 2873 335f 7572 6c29 0a20  S3Path(s3_url). 
+00004e80: 2020 2069 6620 666f 6c6c 6f77 6c69 6e6b     if followlink
+00004e90: 733a 0a20 2020 2020 2020 2074 7279 3a0a  s:.        try:.
+00004ea0: 2020 2020 2020 2020 2020 2020 7333 5f75              s3_u
+00004eb0: 726c 203d 2073 335f 7572 6c2e 7265 6164  rl = s3_url.read
+00004ec0: 6c69 6e6b 2829 0a20 2020 2020 2020 2065  link().        e
+00004ed0: 7863 6570 7420 5333 4e6f 7441 4c69 6e6b  xcept S3NotALink
+00004ee0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+00004ef0: 2020 2070 6173 730a 0a20 2020 2062 7563     pass..    buc
+00004f00: 6b65 742c 206b 6579 203d 2070 6172 7365  ket, key = parse
+00004f10: 5f73 335f 7572 6c28 7333 5f75 726c 2e70  _s3_url(s3_url.p
+00004f20: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+00004f30: 6c29 0a20 2020 2063 6f6e 6669 6720 3d20  l).    config = 
+00004f40: 626f 746f 636f 7265 2e63 6f6e 6669 672e  botocore.config.
+00004f50: 436f 6e66 6967 286d 6178 5f70 6f6f 6c5f  Config(max_pool_
+00004f60: 636f 6e6e 6563 7469 6f6e 733d 6d61 785f  connections=max_
+00004f70: 706f 6f6c 5f63 6f6e 6e65 6374 696f 6e73  pool_connections
+00004f80: 290a 2020 2020 636c 6965 6e74 203d 2067  ).    client = g
+00004f90: 6574 5f73 335f 636c 6965 6e74 280a 2020  et_s3_client(.  
+00004fa0: 2020 2020 2020 636f 6e66 6967 3d63 6f6e        config=con
+00004fb0: 6669 672c 0a20 2020 2020 2020 2063 6163  fig,.        cac
+00004fc0: 6865 5f6b 6579 3d27 7333 5f66 696c 656c  he_key='s3_filel
+00004fd0: 696b 655f 636c 6965 6e74 272c 0a20 2020  ike_client',.   
+00004fe0: 2020 2020 2070 726f 6669 6c65 5f6e 616d       profile_nam
+00004ff0: 653d 7333 5f75 726c 2e5f 7072 6f66 696c  e=s3_url._profil
+00005000: 655f 6e61 6d65 290a 2020 2020 7265 7475  e_name).    retu
+00005010: 726e 2053 3350 7265 6665 7463 6852 6561  rn S3PrefetchRea
+00005020: 6465 7228 0a20 2020 2020 2020 2062 7563  der(.        buc
+00005030: 6b65 742c 0a20 2020 2020 2020 206b 6579  ket,.        key
+00005040: 2c0a 2020 2020 2020 2020 7333 5f63 6c69  ,.        s3_cli
+00005050: 656e 743d 636c 6965 6e74 2c0a 2020 2020  ent=client,.    
+00005060: 2020 2020 6d61 785f 7265 7472 6965 733d      max_retries=
+00005070: 6d61 785f 7265 7472 6965 732c 0a20 2020  max_retries,.   
+00005080: 2020 2020 206d 6178 5f77 6f72 6b65 7273       max_workers
+00005090: 3d6d 6178 5f63 6f6e 6375 7272 656e 6379  =max_concurrency
+000050a0: 2c0a 2020 2020 2020 2020 626c 6f63 6b5f  ,.        block_
+000050b0: 7369 7a65 3d6d 6178 5f62 6c6f 636b 5f73  size=max_block_s
+000050c0: 697a 6529 0a0a 0a40 5f73 335f 6269 6e61  ize)...@_s3_bina
+000050d0: 7279 5f6d 6f64 650a 6465 6620 7333 5f73  ry_mode.def s3_s
+000050e0: 6861 7265 5f63 6163 6865 5f6f 7065 6e28  hare_cache_open(
+000050f0: 0a20 2020 2020 2020 2073 335f 7572 6c3a  .        s3_url:
+00005100: 2050 6174 684c 696b 652c 0a20 2020 2020   PathLike,.     
+00005110: 2020 206d 6f64 653a 2073 7472 203d 2027     mode: str = '
+00005120: 7262 272c 0a20 2020 2020 2020 2066 6f6c  rb',.        fol
+00005130: 6c6f 776c 696e 6b73 3a20 626f 6f6c 203d  lowlinks: bool =
+00005140: 2046 616c 7365 2c0a 2020 2020 2020 2020   False,.        
+00005150: 2a2c 0a20 2020 2020 2020 2063 6163 6865  *,.        cache
+00005160: 5f6b 6579 3a20 7374 7220 3d20 276c 7275  _key: str = 'lru
+00005170: 272c 0a20 2020 2020 2020 206d 6178 5f63  ',.        max_c
+00005180: 6f6e 6375 7272 656e 6379 3a20 4f70 7469  oncurrency: Opti
+00005190: 6f6e 616c 5b69 6e74 5d20 3d20 4e6f 6e65  onal[int] = None
+000051a0: 2c0a 2020 2020 2020 2020 6d61 785f 626c  ,.        max_bl
+000051b0: 6f63 6b5f 7369 7a65 3a20 696e 7420 3d20  ock_size: int = 
+000051c0: 4445 4641 554c 545f 424c 4f43 4b5f 5349  DEFAULT_BLOCK_SI
+000051d0: 5a45 2920 2d3e 2053 3353 6861 7265 4361  ZE) -> S3ShareCa
+000051e0: 6368 6552 6561 6465 723a 0a20 2020 2027  cheReader:.    '
+000051f0: 2727 4f70 656e 2061 2061 7379 6e63 6872  ''Open a asynchr
+00005200: 6f6e 6f75 7320 7072 6566 6574 6368 2072  onous prefetch r
+00005210: 6561 6465 722c 2074 6f20 7375 7070 6f72  eader, to suppor
+00005220: 7420 6661 7374 2073 6571 7565 6e74 6961  t fast sequentia
+00005230: 6c20 7265 6164 2061 6e64 2072 616e 646f  l read and rando
+00005240: 6d20 7265 6164 0a0a 2020 2020 2e2e 206e  m read..    .. n
+00005250: 6f74 6520 3a3a 0a0a 2020 2020 2020 2020  ote ::..        
+00005260: 5573 6572 2073 686f 756c 6420 6d61 6b65  User should make
+00005270: 2073 7572 6520 7468 6174 2072 6561 6465   sure that reade
+00005280: 7220 2f20 7772 6974 6572 2061 7265 2063  r / writer are c
+00005290: 6c6f 7365 6420 636f 7272 6563 746c 790a  losed correctly.
+000052a0: 0a20 2020 2020 2020 2053 7570 706f 7274  .        Support
+000052b0: 7320 636f 6e74 6578 7420 6d61 6e61 6765  s context manage
+000052c0: 720a 0a20 2020 2020 2020 2053 6f6d 6520  r..        Some 
+000052d0: 7061 7261 6d65 7465 7220 7365 7474 696e  parameter settin
+000052e0: 6720 6d61 7920 7065 7266 6f72 6d20 7765  g may perform we
+000052f0: 6c6c 3a20 6d61 785f 636f 6e63 7572 7265  ll: max_concurre
+00005300: 6e63 793d 3130 206f 7220 3230 2c20 6d61  ncy=10 or 20, ma
+00005310: 785f 626c 6f63 6b5f 7369 7a65 3d38 206f  x_block_size=8 o
+00005320: 7220 3136 204d 422c 2064 6566 6175 6c74  r 16 MB, default
+00005330: 2076 616c 7565 204e 6f6e 6520 6d65 616e   value None mean
+00005340: 7320 7573 696e 6720 676c 6f62 616c 2074  s using global t
+00005350: 6872 6561 6420 706f 6f6c 0a0a 2020 2020  hread pool..    
+00005360: 3a70 6172 616d 206d 6178 5f63 6f6e 6375  :param max_concu
+00005370: 7272 656e 6379 3a20 4d61 7820 646f 776e  rrency: Max down
+00005380: 6c6f 6164 2074 6872 6561 6420 6e75 6d62  load thread numb
+00005390: 6572 2c20 4e6f 6e65 2062 7920 6465 6661  er, None by defa
+000053a0: 756c 740a 2020 2020 3a70 6172 616d 206d  ult.    :param m
+000053b0: 6178 5f62 6c6f 636b 5f73 697a 653a 204d  ax_block_size: M
+000053c0: 6178 2064 6174 6120 7369 7a65 2064 6f77  ax data size dow
+000053d0: 6e6c 6f61 6465 6420 6279 2065 6163 6820  nloaded by each 
+000053e0: 7468 7265 6164 2c20 696e 2062 7974 6573  thread, in bytes
+000053f0: 2c20 384d 4220 6279 2064 6566 6175 6c74  , 8MB by default
+00005400: 0a20 2020 203a 7265 7475 726e 733a 2041  .    :returns: A
+00005410: 6e20 6f70 656e 6564 2053 3353 6861 7265  n opened S3Share
+00005420: 4361 6368 6552 6561 6465 7220 6f62 6a65  CacheReader obje
+00005430: 6374 0a20 2020 203a 7261 6973 6573 3a20  ct.    :raises: 
+00005440: 5333 4669 6c65 4e6f 7446 6f75 6e64 4572  S3FileNotFoundEr
+00005450: 726f 720a 2020 2020 2727 270a 2020 2020  ror.    '''.    
+00005460: 6966 206d 6f64 6520 213d 2027 7262 273a  if mode != 'rb':
+00005470: 0a20 2020 2020 2020 2072 6169 7365 2056  .        raise V
+00005480: 616c 7565 4572 726f 7228 2775 6e61 6363  alueError('unacc
+00005490: 6570 7461 626c 6520 6d6f 6465 3a20 2572  eptable mode: %r
+000054a0: 2720 2520 6d6f 6465 2920 2023 2070 7261  ' % mode)  # pra
+000054b0: 676d 613a 206e 6f20 636f 7665 720a 0a20  gma: no cover.. 
+000054c0: 2020 2073 335f 7572 6c20 3d20 5333 5061     s3_url = S3Pa
+000054d0: 7468 2873 335f 7572 6c29 0a20 2020 2069  th(s3_url).    i
+000054e0: 6620 666f 6c6c 6f77 6c69 6e6b 733a 0a20  f followlinks:. 
+000054f0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00005500: 2020 2020 2020 2020 7333 5f75 726c 203d          s3_url =
+00005510: 2073 335f 7572 6c2e 7265 6164 6c69 6e6b   s3_url.readlink
+00005520: 2829 0a20 2020 2020 2020 2065 7863 6570  ().        excep
+00005530: 7420 5333 4e6f 7441 4c69 6e6b 4572 726f  t S3NotALinkErro
+00005540: 723a 0a20 2020 2020 2020 2020 2020 2070  r:.            p
+00005550: 6173 730a 0a20 2020 2062 7563 6b65 742c  ass..    bucket,
+00005560: 206b 6579 203d 2070 6172 7365 5f73 335f   key = parse_s3_
+00005570: 7572 6c28 7333 5f75 726c 2e70 6174 685f  url(s3_url.path_
+00005580: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
+00005590: 2020 2063 6f6e 6669 6720 3d20 626f 746f     config = boto
+000055a0: 636f 7265 2e63 6f6e 6669 672e 436f 6e66  core.config.Conf
+000055b0: 6967 286d 6178 5f70 6f6f 6c5f 636f 6e6e  ig(max_pool_conn
+000055c0: 6563 7469 6f6e 733d 6d61 785f 706f 6f6c  ections=max_pool
+000055d0: 5f63 6f6e 6e65 6374 696f 6e73 290a 2020  _connections).  
+000055e0: 2020 636c 6965 6e74 203d 2067 6574 5f73    client = get_s
+000055f0: 335f 636c 6965 6e74 280a 2020 2020 2020  3_client(.      
+00005600: 2020 636f 6e66 6967 3d63 6f6e 6669 672c    config=config,
 00005610: 0a20 2020 2020 2020 2063 6163 6865 5f6b  .        cache_k
-00005620: 6579 3d63 6163 6865 5f6b 6579 2c0a 2020  ey=cache_key,.  
-00005630: 2020 2020 2020 7333 5f63 6c69 656e 743d        s3_client=
-00005640: 636c 6965 6e74 2c0a 2020 2020 2020 2020  client,.        
-00005650: 6d61 785f 7265 7472 6965 733d 6d61 785f  max_retries=max_
-00005660: 7265 7472 6965 732c 0a20 2020 2020 2020  retries,.       
-00005670: 206d 6178 5f77 6f72 6b65 7273 3d6d 6178   max_workers=max
-00005680: 5f63 6f6e 6375 7272 656e 6379 2c0a 2020  _concurrency,.  
-00005690: 2020 2020 2020 626c 6f63 6b5f 7369 7a65        block_size
-000056a0: 3d6d 6178 5f62 6c6f 636b 5f73 697a 6529  =max_block_size)
-000056b0: 0a0a 0a40 5f73 335f 6269 6e61 7279 5f6d  ...@_s3_binary_m
-000056c0: 6f64 650a 6465 6620 7333 5f70 6970 655f  ode.def s3_pipe_
-000056d0: 6f70 656e 280a 2020 2020 2020 2020 7333  open(.        s3
-000056e0: 5f75 726c 3a20 5061 7468 4c69 6b65 2c0a  _url: PathLike,.
-000056f0: 2020 2020 2020 2020 6d6f 6465 3a20 7374          mode: st
-00005700: 722c 0a20 2020 2020 2020 2066 6f6c 6c6f  r,.        follo
-00005710: 776c 696e 6b73 3a20 626f 6f6c 203d 2046  wlinks: bool = F
-00005720: 616c 7365 2c0a 2020 2020 2020 2020 2a2c  alse,.        *,
-00005730: 0a20 2020 2020 2020 206a 6f69 6e5f 7468  .        join_th
-00005740: 7265 6164 3a20 626f 6f6c 203d 2054 7275  read: bool = Tru
-00005750: 6529 202d 3e20 5333 5069 7065 4861 6e64  e) -> S3PipeHand
-00005760: 6c65 723a 0a20 2020 2027 2727 4f70 656e  ler:.    '''Open
-00005770: 2061 2061 7379 6e63 6872 6f6e 6f75 7320   a asynchronous 
-00005780: 7265 6164 2d77 7269 7465 2072 6561 6465  read-write reade
-00005790: 7220 2f20 7772 6974 6572 2c20 746f 2073  r / writer, to s
-000057a0: 7570 706f 7274 2066 6173 7420 7365 7175  upport fast sequ
-000057b0: 656e 7469 616c 2072 6561 6420 2f20 7772  ential read / wr
-000057c0: 6974 650a 0a20 2020 202e 2e20 6e6f 7465  ite..    .. note
-000057d0: 203a 3a0a 0a20 2020 2020 2020 2055 7365   ::..        Use
-000057e0: 7220 7368 6f75 6c64 206d 616b 6520 7375  r should make su
-000057f0: 7265 2074 6861 7420 7265 6164 6572 202f  re that reader /
-00005800: 2077 7269 7465 7220 6172 6520 636c 6f73   writer are clos
-00005810: 6564 2063 6f72 7265 6374 6c79 0a0a 2020  ed correctly..  
-00005820: 2020 2020 2020 5375 7070 6f72 7473 2063        Supports c
-00005830: 6f6e 7465 7874 206d 616e 6167 6572 0a0a  ontext manager..
-00005840: 2020 2020 2020 2020 5768 656e 206a 6f69          When joi
-00005850: 6e5f 7468 7265 6164 2069 7320 4661 6c73  n_thread is Fals
-00005860: 652c 2077 6869 6c65 2074 6865 2066 696c  e, while the fil
-00005870: 6520 6861 6e64 6c65 2061 7265 2063 6c6f  e handle are clo
-00005880: 7369 6e67 2c20 7468 6973 2066 756e 6374  sing, this funct
-00005890: 696f 6e20 7769 6c6c 206e 6f74 2077 6169  ion will not wai
-000058a0: 7420 756e 7469 6c20 7468 6520 6173 796e  t until the asyn
-000058b0: 6368 726f 6e6f 7573 2077 7269 7469 6e67  chronous writing
-000058c0: 2066 696e 6973 6865 733b 0a20 2020 2020   finishes;.     
-000058d0: 2020 2046 616c 7365 2064 6f65 736e 2774     False doesn't
-000058e0: 2061 6666 6563 7420 7265 6164 2d68 616e   affect read-han
-000058f0: 646c 652c 2062 7574 2074 6869 7320 6361  dle, but this ca
-00005900: 6e20 7370 6565 6420 7570 2077 7269 7465  n speed up write
-00005910: 2d68 616e 646c 6520 6265 6361 7573 6520  -handle because 
-00005920: 6669 6c65 2077 696c 6c20 6265 2077 7269  file will be wri
-00005930: 7474 656e 2061 7379 6e63 6872 6f6e 6f75  tten asynchronou
-00005940: 736c 792e 0a20 2020 2020 2020 2042 7574  sly..        But
-00005950: 2061 7379 6e63 6872 6f6e 6f75 7320 6265   asynchronous be
-00005960: 6861 7669 6f75 7220 6361 6e20 6775 6172  haviour can guar
-00005970: 616e 7465 6520 7468 6520 6669 6c65 2061  antee the file a
-00005980: 7265 2073 7563 6365 7373 6675 6c6c 7920  re successfully 
-00005990: 7772 6974 7465 6e2c 2061 6e64 2066 7265  written, and fre
-000059a0: 7175 656e 7420 6578 6563 7574 696f 6e20  quent execution 
-000059b0: 6d61 7920 6361 7573 6520 7468 7265 6164  may cause thread
-000059c0: 2061 6e64 2066 696c 6520 6861 6e64 6c65   and file handle
-000059d0: 2065 7868 6175 7374 696f 6e0a 0a20 2020   exhaustion..   
-000059e0: 203a 7061 7261 6d20 6d6f 6465 3a20 4d6f   :param mode: Mo
-000059f0: 6465 2074 6f20 6f70 656e 2066 696c 652c  de to open file,
-00005a00: 2065 6974 6865 7220 2272 6222 206f 7220   either "rb" or 
-00005a10: 2277 6222 0a20 2020 203a 7061 7261 6d20  "wb".    :param 
-00005a20: 6a6f 696e 5f74 6872 6561 643a 2049 6620  join_thread: If 
-00005a30: 7761 6974 2061 6674 6572 2066 756e 6374  wait after funct
-00005a40: 696f 6e20 6578 6563 7574 696f 6e20 756e  ion execution un
-00005a50: 7469 6c20 7333 2066 696e 6973 6865 7320  til s3 finishes 
-00005a60: 7772 6974 696e 670a 2020 2020 3a72 6574  writing.    :ret
-00005a70: 7572 6e73 3a20 416e 206f 7065 6e65 6420  urns: An opened 
-00005a80: 4275 6666 6572 6564 5265 6164 6572 202f  BufferedReader /
-00005a90: 2042 7566 6665 7265 6457 7269 7465 7220   BufferedWriter 
-00005aa0: 6f62 6a65 6374 0a20 2020 2027 2727 0a20  object.    '''. 
-00005ab0: 2020 2069 6620 6d6f 6465 206e 6f74 2069     if mode not i
-00005ac0: 6e20 2827 7262 272c 2027 7762 2729 3a0a  n ('rb', 'wb'):.
-00005ad0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-00005ae0: 6c75 6545 7272 6f72 2827 756e 6163 6365  lueError('unacce
-00005af0: 7074 6162 6c65 206d 6f64 653a 2025 7227  ptable mode: %r'
-00005b00: 2025 206d 6f64 6529 2020 2320 7072 6167   % mode)  # prag
-00005b10: 6d61 3a20 6e6f 2063 6f76 6572 0a0a 2020  ma: no cover..  
-00005b20: 2020 6966 206d 6f64 655b 305d 203d 3d20    if mode[0] == 
-00005b30: 2772 2720 616e 6420 6e6f 7420 5333 5061  'r' and not S3Pa
-00005b40: 7468 2873 335f 7572 6c29 2e69 735f 6669  th(s3_url).is_fi
-00005b50: 6c65 2829 3a0a 2020 2020 2020 2020 7261  le():.        ra
-00005b60: 6973 6520 5333 4669 6c65 4e6f 7446 6f75  ise S3FileNotFou
-00005b70: 6e64 4572 726f 7228 274e 6f20 7375 6368  ndError('No such
-00005b80: 2066 696c 653a 2025 7227 2025 2073 335f   file: %r' % s3_
-00005b90: 7572 6c29 0a0a 2020 2020 6966 2066 6f6c  url)..    if fol
-00005ba0: 6c6f 776c 696e 6b73 3a0a 2020 2020 2020  lowlinks:.      
-00005bb0: 2020 6d65 7461 6461 7461 203d 205f 7333    metadata = _s3
-00005bc0: 5f67 6574 5f6d 6574 6164 6174 6128 7333  _get_metadata(s3
-00005bd0: 5f75 726c 290a 2020 2020 2020 2020 6966  _url).        if
-00005be0: 206d 6574 6164 6174 6120 616e 6420 2773   metadata and 's
-00005bf0: 796d 6c69 6e6b 5f74 6f27 2069 6e20 6d65  ymlink_to' in me
-00005c00: 7461 6461 7461 3a0a 2020 2020 2020 2020  tadata:.        
-00005c10: 2020 2020 7333 5f75 726c 203d 206d 6574      s3_url = met
-00005c20: 6164 6174 615b 2773 796d 6c69 6e6b 5f74  adata['symlink_t
-00005c30: 6f27 5d0a 0a20 2020 2062 7563 6b65 742c  o']..    bucket,
-00005c40: 206b 6579 203d 2070 6172 7365 5f73 335f   key = parse_s3_
-00005c50: 7572 6c28 7333 5f75 726c 290a 2020 2020  url(s3_url).    
-00005c60: 636f 6e66 6967 203d 2062 6f74 6f63 6f72  config = botocor
-00005c70: 652e 636f 6e66 6967 2e43 6f6e 6669 6728  e.config.Config(
-00005c80: 6d61 785f 706f 6f6c 5f63 6f6e 6e65 6374  max_pool_connect
-00005c90: 696f 6e73 3d6d 6178 5f70 6f6f 6c5f 636f  ions=max_pool_co
-00005ca0: 6e6e 6563 7469 6f6e 7329 0a20 2020 2063  nnections).    c
-00005cb0: 6c69 656e 7420 3d20 6765 745f 7333 5f63  lient = get_s3_c
-00005cc0: 6c69 656e 7428 636f 6e66 6967 3d63 6f6e  lient(config=con
-00005cd0: 6669 672c 2063 6163 6865 5f6b 6579 3d27  fig, cache_key='
-00005ce0: 7333 5f66 696c 656c 696b 655f 636c 6965  s3_filelike_clie
-00005cf0: 6e74 2729 0a20 2020 2072 6574 7572 6e20  nt').    return 
-00005d00: 5333 5069 7065 4861 6e64 6c65 7228 0a20  S3PipeHandler(. 
-00005d10: 2020 2020 2020 2062 7563 6b65 742c 206b         bucket, k
-00005d20: 6579 2c20 6d6f 6465 2c20 7333 5f63 6c69  ey, mode, s3_cli
-00005d30: 656e 743d 636c 6965 6e74 2c20 6a6f 696e  ent=client, join
-00005d40: 5f74 6872 6561 643d 6a6f 696e 5f74 6872  _thread=join_thr
-00005d50: 6561 6429 0a0a 0a40 5f73 335f 6269 6e61  ead)...@_s3_bina
-00005d60: 7279 5f6d 6f64 650a 6465 6620 7333 5f63  ry_mode.def s3_c
-00005d70: 6163 6865 645f 6f70 656e 280a 2020 2020  ached_open(.    
-00005d80: 2020 2020 7333 5f75 726c 3a20 5061 7468      s3_url: Path
-00005d90: 4c69 6b65 2c0a 2020 2020 2020 2020 6d6f  Like,.        mo
-00005da0: 6465 3a20 7374 722c 0a20 2020 2020 2020  de: str,.       
-00005db0: 2066 6f6c 6c6f 776c 696e 6b73 3a20 626f   followlinks: bo
-00005dc0: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
-00005dd0: 2020 2020 2a2c 0a20 2020 2020 2020 2063      *,.        c
-00005de0: 6163 6865 5f70 6174 683a 204f 7074 696f  ache_path: Optio
-00005df0: 6e61 6c5b 7374 725d 203d 204e 6f6e 6529  nal[str] = None)
-00005e00: 202d 3e20 5333 4361 6368 6564 4861 6e64   -> S3CachedHand
-00005e10: 6c65 723a 0a20 2020 2027 2727 4f70 656e  ler:.    '''Open
-00005e20: 2061 206c 6f63 616c 2d63 6163 6865 2066   a local-cache f
-00005e30: 696c 6520 7265 6164 6572 202f 2077 7269  ile reader / wri
-00005e40: 7465 722c 2066 6f72 2066 7265 7175 656e  ter, for frequen
-00005e50: 7420 7261 6e64 6f6d 2072 6561 6420 2f20  t random read / 
-00005e60: 7772 6974 650a 0a20 2020 202e 2e20 6e6f  write..    .. no
-00005e70: 7465 203a 3a0a 0a20 2020 2020 2020 2055  te ::..        U
-00005e80: 7365 7220 7368 6f75 6c64 206d 616b 6520  ser should make 
-00005e90: 7375 7265 2074 6861 7420 7265 6164 6572  sure that reader
-00005ea0: 202f 2077 7269 7465 7220 6172 6520 636c   / writer are cl
-00005eb0: 6f73 6564 2063 6f72 7265 6374 6c79 0a0a  osed correctly..
-00005ec0: 2020 2020 2020 2020 5375 7070 6f72 7473          Supports
-00005ed0: 2063 6f6e 7465 7874 206d 616e 6167 6572   context manager
-00005ee0: 0a0a 2020 2020 2020 2020 6361 6368 655f  ..        cache_
-00005ef0: 7061 7468 2063 616e 2073 7065 6369 6679  path can specify
-00005f00: 2074 6865 2070 6174 6820 6f66 2063 6163   the path of cac
-00005f10: 6865 2066 696c 652e 2050 6572 666f 726d  he file. Perform
-00005f20: 616e 6365 2063 6f75 6c64 2062 6520 6265  ance could be be
-00005f30: 7474 6572 2069 6620 6361 6368 6520 6669  tter if cache fi
-00005f40: 6c65 2070 6174 6820 6973 206f 6e20 7373  le path is on ss
-00005f50: 6420 6f72 2074 6d70 6673 0a0a 2020 2020  d or tmpfs..    
-00005f60: 3a70 6172 616d 206d 6f64 653a 204d 6f64  :param mode: Mod
-00005f70: 6520 746f 206f 7065 6e20 6669 6c65 2c20  e to open file, 
-00005f80: 636f 756c 6420 6265 206f 6e65 206f 6620  could be one of 
-00005f90: 2272 6222 2c20 2277 6222 206f 7220 2261  "rb", "wb" or "a
-00005fa0: 6222 0a20 2020 203a 7061 7261 6d20 6361  b".    :param ca
-00005fb0: 6368 655f 7061 7468 3a20 6361 6368 6520  che_path: cache 
-00005fc0: 6669 6c65 2070 6174 680a 2020 2020 3a72  file path.    :r
-00005fd0: 6574 7572 6e73 3a20 416e 206f 7065 6e65  eturns: An opene
-00005fe0: 6420 4275 6666 6572 6564 5265 6164 6572  d BufferedReader
-00005ff0: 202f 2042 7566 6665 7265 6457 7269 7465   / BufferedWrite
-00006000: 7220 6f62 6a65 6374 0a20 2020 2027 2727  r object.    '''
-00006010: 0a20 2020 2069 6620 6d6f 6465 206e 6f74  .    if mode not
-00006020: 2069 6e20 2827 7262 272c 2027 7762 272c   in ('rb', 'wb',
-00006030: 2027 6162 272c 2027 7262 2b27 2c20 2777   'ab', 'rb+', 'w
-00006040: 622b 272c 2027 6162 2b27 293a 0a20 2020  b+', 'ab+'):.   
-00006050: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-00006060: 4572 726f 7228 2775 6e61 6363 6570 7461  Error('unaccepta
-00006070: 626c 6520 6d6f 6465 3a20 2572 2720 2520  ble mode: %r' % 
-00006080: 6d6f 6465 2920 2023 2070 7261 676d 613a  mode)  # pragma:
-00006090: 206e 6f20 636f 7665 720a 2020 2020 6966   no cover.    if
-000060a0: 2066 6f6c 6c6f 776c 696e 6b73 3a0a 2020   followlinks:.  
-000060b0: 2020 2020 2020 6d65 7461 6461 7461 203d        metadata =
-000060c0: 205f 7333 5f67 6574 5f6d 6574 6164 6174   _s3_get_metadat
-000060d0: 6128 7333 5f75 726c 290a 2020 2020 2020  a(s3_url).      
-000060e0: 2020 6966 206d 6574 6164 6174 6120 616e    if metadata an
-000060f0: 6420 2773 796d 6c69 6e6b 5f74 6f27 2069  d 'symlink_to' i
-00006100: 6e20 6d65 7461 6461 7461 3a0a 2020 2020  n metadata:.    
-00006110: 2020 2020 2020 2020 7333 5f75 726c 203d          s3_url =
-00006120: 206d 6574 6164 6174 615b 2773 796d 6c69   metadata['symli
-00006130: 6e6b 5f74 6f27 5d0a 0a20 2020 2062 7563  nk_to']..    buc
-00006140: 6b65 742c 206b 6579 203d 2070 6172 7365  ket, key = parse
-00006150: 5f73 335f 7572 6c28 7333 5f75 726c 290a  _s3_url(s3_url).
-00006160: 2020 2020 636f 6e66 6967 203d 2062 6f74      config = bot
-00006170: 6f63 6f72 652e 636f 6e66 6967 2e43 6f6e  ocore.config.Con
-00006180: 6669 6728 6d61 785f 706f 6f6c 5f63 6f6e  fig(max_pool_con
-00006190: 6e65 6374 696f 6e73 3d6d 6178 5f70 6f6f  nections=max_poo
-000061a0: 6c5f 636f 6e6e 6563 7469 6f6e 7329 0a20  l_connections). 
-000061b0: 2020 2063 6c69 656e 7420 3d20 6765 745f     client = get_
-000061c0: 7333 5f63 6c69 656e 7428 636f 6e66 6967  s3_client(config
-000061d0: 3d63 6f6e 6669 672c 2063 6163 6865 5f6b  =config, cache_k
-000061e0: 6579 3d27 7333 5f66 696c 656c 696b 655f  ey='s3_filelike_
-000061f0: 636c 6965 6e74 2729 0a20 2020 2072 6574  client').    ret
-00006200: 7572 6e20 5333 4361 6368 6564 4861 6e64  urn S3CachedHand
-00006210: 6c65 7228 0a20 2020 2020 2020 2062 7563  ler(.        buc
-00006220: 6b65 742c 206b 6579 2c20 6d6f 6465 2c20  ket, key, mode, 
-00006230: 7333 5f63 6c69 656e 743d 636c 6965 6e74  s3_client=client
-00006240: 2c20 6361 6368 655f 7061 7468 3d63 6163  , cache_path=cac
-00006250: 6865 5f70 6174 6829 0a0a 0a40 5f73 335f  he_path)...@_s3_
-00006260: 6269 6e61 7279 5f6d 6f64 650a 6465 6620  binary_mode.def 
-00006270: 7333 5f62 7566 6665 7265 645f 6f70 656e  s3_buffered_open
-00006280: 280a 2020 2020 2020 2020 7333 5f75 726c  (.        s3_url
-00006290: 3a20 5061 7468 4c69 6b65 2c0a 2020 2020  : PathLike,.    
-000062a0: 2020 2020 6d6f 6465 3a20 7374 722c 0a20      mode: str,. 
-000062b0: 2020 2020 2020 2066 6f6c 6c6f 776c 696e         followlin
-000062c0: 6b73 3a20 626f 6f6c 203d 2046 616c 7365  ks: bool = False
-000062d0: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
-000062e0: 2020 2020 206d 6178 5f63 6f6e 6375 7272       max_concurr
-000062f0: 656e 6379 3a20 4f70 7469 6f6e 616c 5b69  ency: Optional[i
-00006300: 6e74 5d20 3d20 4e6f 6e65 2c0a 2020 2020  nt] = None,.    
-00006310: 2020 2020 6d61 785f 6275 6666 6572 5f73      max_buffer_s
-00006320: 697a 653a 2069 6e74 203d 2044 4546 4155  ize: int = DEFAU
-00006330: 4c54 5f4d 4158 5f42 5546 4645 525f 5349  LT_MAX_BUFFER_SI
-00006340: 5a45 2c0a 2020 2020 2020 2020 666f 7277  ZE,.        forw
-00006350: 6172 645f 7261 7469 6f3a 204f 7074 696f  ard_ratio: Optio
-00006360: 6e61 6c5b 666c 6f61 745d 203d 204e 6f6e  nal[float] = Non
-00006370: 652c 0a20 2020 2020 2020 2062 6c6f 636b  e,.        block
-00006380: 5f73 697a 653a 2069 6e74 203d 2044 4546  _size: int = DEF
-00006390: 4155 4c54 5f42 4c4f 434b 5f53 495a 452c  AULT_BLOCK_SIZE,
-000063a0: 0a20 2020 2020 2020 206c 696d 6974 6564  .        limited
-000063b0: 5f73 6565 6b61 626c 653a 2062 6f6f 6c20  _seekable: bool 
-000063c0: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
-000063d0: 2062 7566 6665 7265 643a 2062 6f6f 6c20   buffered: bool 
-000063e0: 3d20 5472 7565 2c0a 2020 2020 2020 2020  = True,.        
-000063f0: 7368 6172 655f 6361 6368 655f 6b65 793a  share_cache_key:
-00006400: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
-00006410: 204e 6f6e 652c 0a20 2020 2020 2020 2063   None,.        c
-00006420: 6163 6865 5f70 6174 683a 204f 7074 696f  ache_path: Optio
-00006430: 6e61 6c5b 7374 725d 203d 204e 6f6e 650a  nal[str] = None.
-00006440: 2920 2d3e 2055 6e69 6f6e 5b53 3350 7265  ) -> Union[S3Pre
-00006450: 6665 7463 6852 6561 6465 722c 2053 3342  fetchReader, S3B
-00006460: 7566 6665 7265 6457 7269 7465 722c 2069  ufferedWriter, i
-00006470: 6f2e 4275 6666 6572 6564 5265 6164 6572  o.BufferedReader
-00006480: 2c20 696f 2e0a 2020 2020 2020 2020 2020  , io..          
-00006490: 2042 7566 6665 7265 6457 7269 7465 722c   BufferedWriter,
-000064a0: 2053 334d 656d 6f72 7948 616e 646c 6572   S3MemoryHandler
-000064b0: 5d3a 0a20 2020 2027 2727 4f70 656e 2061  ]:.    '''Open a
-000064c0: 6e20 6173 796e 6368 726f 6e6f 7573 2070  n asynchronous p
-000064d0: 7265 6665 7463 6820 7265 6164 6572 2c20  refetch reader, 
-000064e0: 746f 2073 7570 706f 7274 2066 6173 7420  to support fast 
-000064f0: 7365 7175 656e 7469 616c 2072 6561 640a  sequential read.
-00006500: 0a20 2020 202e 2e20 6e6f 7465 203a 3a0a  .    .. note ::.
-00006510: 0a20 2020 2020 2020 2055 7365 7220 7368  .        User sh
-00006520: 6f75 6c64 206d 616b 6520 7375 7265 2074  ould make sure t
-00006530: 6861 7420 7265 6164 6572 202f 2077 7269  hat reader / wri
-00006540: 7465 7220 6172 6520 636c 6f73 6564 2063  ter are closed c
-00006550: 6f72 7265 6374 6c79 0a0a 2020 2020 2020  orrectly..      
-00006560: 2020 5375 7070 6f72 7473 2063 6f6e 7465    Supports conte
-00006570: 7874 206d 616e 6167 6572 0a0a 2020 2020  xt manager..    
-00006580: 2020 2020 536f 6d65 2070 6172 616d 6574      Some paramet
-00006590: 6572 2073 6574 7469 6e67 206d 6179 2070  er setting may p
-000065a0: 6572 666f 726d 2077 656c 6c3a 206d 6178  erform well: max
-000065b0: 5f63 6f6e 6375 7272 656e 6379 3d31 3020  _concurrency=10 
-000065c0: 6f72 2032 302c 206d 6178 5f62 6c6f 636b  or 20, max_block
-000065d0: 5f73 697a 653d 3820 6f72 2031 3620 4d42  _size=8 or 16 MB
-000065e0: 2c20 6465 6661 756c 7420 7661 6c75 6520  , default value 
-000065f0: 4e6f 6e65 206d 6561 6e73 2075 7369 6e67  None means using
-00006600: 2067 6c6f 6261 6c20 7468 7265 6164 2070   global thread p
-00006610: 6f6f 6c0a 0a20 2020 203a 7061 7261 6d20  ool..    :param 
-00006620: 6d61 785f 636f 6e63 7572 7265 6e63 793a  max_concurrency:
-00006630: 204d 6178 2064 6f77 6e6c 6f61 6420 7468   Max download th
-00006640: 7265 6164 206e 756d 6265 722c 204e 6f6e  read number, Non
-00006650: 6520 6279 2064 6566 6175 6c74 0a20 2020  e by default.   
-00006660: 203a 7061 7261 6d20 6d61 785f 6275 6666   :param max_buff
-00006670: 6572 5f73 697a 653a 204d 6178 2063 6163  er_size: Max cac
-00006680: 6865 6420 6275 6666 6572 2073 697a 6520  hed buffer size 
-00006690: 696e 206d 656d 6f72 792c 2031 3238 4d42  in memory, 128MB
-000066a0: 2062 7920 6465 6661 756c 740a 2020 2020   by default.    
-000066b0: 3a70 6172 616d 2062 6c6f 636b 5f73 697a  :param block_siz
-000066c0: 653a 2053 697a 6520 6f66 2073 696e 676c  e: Size of singl
-000066d0: 6520 626c 6f63 6b2c 2038 4d42 2062 7920  e block, 8MB by 
-000066e0: 6465 6661 756c 742e 2045 6163 6820 626c  default. Each bl
-000066f0: 6f63 6b20 7769 6c6c 2062 6520 7570 6c6f  ock will be uplo
-00006700: 6164 6564 206f 7220 646f 776e 6c6f 6164  aded or download
-00006710: 6564 2062 7920 7369 6e67 6c65 2074 6872  ed by single thr
-00006720: 6561 642e 0a20 2020 203a 7061 7261 6d20  ead..    :param 
-00006730: 6c69 6d69 7465 645f 7365 656b 6162 6c65  limited_seekable
-00006740: 3a20 4966 2077 7269 7465 2d68 616e 646c  : If write-handl
-00006750: 6520 7375 7070 6f72 7473 206c 696d 6974  e supports limit
-00006760: 6564 2073 6565 6b20 2862 6f74 6820 6669  ed seek (both fi
-00006770: 6c65 2068 6561 6420 7061 7274 2061 6e64  le head part and
-00006780: 2074 6169 6c20 7061 7274 2063 616e 2073   tail part can s
-00006790: 6565 6b20 626c 6f63 6b5f 7369 7a65 292e  eek block_size).
-000067a0: 204e 6f74 6573 3a20 5468 6973 2070 6172   Notes: This par
-000067b0: 616d 6574 6572 2061 7265 2076 616c 6964  ameter are valid
-000067c0: 206f 6e6c 7920 666f 7220 7772 6974 652d   only for write-
-000067d0: 6861 6e64 6c65 2e20 5265 6164 2d68 616e  handle. Read-han
-000067e0: 646c 6520 7375 7070 6f72 7420 6172 6269  dle support arbi
-000067f0: 7472 6172 7920 7365 656b 0a20 2020 203a  trary seek.    :
-00006800: 7265 7475 726e 733a 2041 6e20 6f70 656e  returns: An open
-00006810: 6564 2053 3350 7265 6665 7463 6852 6561  ed S3PrefetchRea
-00006820: 6465 7220 6f62 6a65 6374 0a20 2020 203a  der object.    :
-00006830: 7261 6973 6573 3a20 5333 4669 6c65 4e6f  raises: S3FileNo
-00006840: 7446 6f75 6e64 4572 726f 720a 2020 2020  tFoundError.    
-00006850: 2727 270a 2020 2020 6966 206d 6f64 6520  '''.    if mode 
-00006860: 6e6f 7420 696e 2028 2772 6227 2c20 2777  not in ('rb', 'w
-00006870: 6227 2c20 2761 6227 2c20 2772 622b 272c  b', 'ab', 'rb+',
-00006880: 2027 7762 2b27 2c20 2761 622b 2729 3a0a   'wb+', 'ab+'):.
-00006890: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-000068a0: 6c75 6545 7272 6f72 2827 756e 6163 6365  lueError('unacce
-000068b0: 7074 6162 6c65 206d 6f64 653a 2025 7227  ptable mode: %r'
-000068c0: 2025 206d 6f64 6529 0a20 2020 2069 6620   % mode).    if 
-000068d0: 666f 6c6c 6f77 6c69 6e6b 733a 0a20 2020  followlinks:.   
-000068e0: 2020 2020 206d 6574 6164 6174 6120 3d20       metadata = 
-000068f0: 5f73 335f 6765 745f 6d65 7461 6461 7461  _s3_get_metadata
-00006900: 2873 335f 7572 6c29 0a20 2020 2020 2020  (s3_url).       
-00006910: 2069 6620 6d65 7461 6461 7461 2061 6e64   if metadata and
-00006920: 2027 7379 6d6c 696e 6b5f 746f 2720 696e   'symlink_to' in
-00006930: 206d 6574 6164 6174 613a 0a20 2020 2020   metadata:.     
-00006940: 2020 2020 2020 2073 335f 7572 6c20 3d20         s3_url = 
-00006950: 6d65 7461 6461 7461 5b27 7379 6d6c 696e  metadata['symlin
-00006960: 6b5f 746f 275d 0a0a 2020 2020 6275 636b  k_to']..    buck
-00006970: 6574 2c20 6b65 7920 3d20 7061 7273 655f  et, key = parse_
-00006980: 7333 5f75 726c 2873 335f 7572 6c29 0a20  s3_url(s3_url). 
-00006990: 2020 2063 6f6e 6669 6720 3d20 626f 746f     config = boto
-000069a0: 636f 7265 2e63 6f6e 6669 672e 436f 6e66  core.config.Conf
-000069b0: 6967 286d 6178 5f70 6f6f 6c5f 636f 6e6e  ig(max_pool_conn
-000069c0: 6563 7469 6f6e 733d 6d61 785f 706f 6f6c  ections=max_pool
-000069d0: 5f63 6f6e 6e65 6374 696f 6e73 290a 2020  _connections).  
-000069e0: 2020 636c 6965 6e74 203d 2067 6574 5f73    client = get_s
-000069f0: 335f 636c 6965 6e74 2863 6f6e 6669 673d  3_client(config=
-00006a00: 636f 6e66 6967 2c20 6361 6368 655f 6b65  config, cache_ke
-00006a10: 793d 2773 335f 6669 6c65 6c69 6b65 5f63  y='s3_filelike_c
-00006a20: 6c69 656e 7427 290a 0a20 2020 2069 6620  lient')..    if 
-00006a30: 2761 2720 696e 206d 6f64 6520 6f72 2027  'a' in mode or '
-00006a40: 2b27 2069 6e20 6d6f 6465 3a0a 2020 2020  +' in mode:.    
-00006a50: 2020 2020 6966 2063 6163 6865 5f70 6174      if cache_pat
-00006a60: 6820 6973 204e 6f6e 653a 0a20 2020 2020  h is None:.     
-00006a70: 2020 2020 2020 2072 6574 7572 6e20 5333         return S3
-00006a80: 4d65 6d6f 7279 4861 6e64 6c65 7228 6275  MemoryHandler(bu
-00006a90: 636b 6574 2c20 6b65 792c 206d 6f64 652c  cket, key, mode,
-00006aa0: 2073 335f 636c 6965 6e74 3d63 6c69 656e   s3_client=clien
-00006ab0: 7429 0a20 2020 2020 2020 2072 6574 7572  t).        retur
-00006ac0: 6e20 5333 4361 6368 6564 4861 6e64 6c65  n S3CachedHandle
-00006ad0: 7228 0a20 2020 2020 2020 2020 2020 2062  r(.            b
-00006ae0: 7563 6b65 742c 206b 6579 2c20 6d6f 6465  ucket, key, mode
-00006af0: 2c20 7333 5f63 6c69 656e 743d 636c 6965  , s3_client=clie
-00006b00: 6e74 2c20 6361 6368 655f 7061 7468 3d63  nt, cache_path=c
-00006b10: 6163 6865 5f70 6174 6829 0a0a 2020 2020  ache_path)..    
-00006b20: 6966 206d 6f64 6520 3d3d 2027 7262 273a  if mode == 'rb':
-00006b30: 0a20 2020 2020 2020 2023 2041 2072 6f75  .        # A rou
-00006b40: 6768 2063 6f6e 7665 7273 696f 6e20 616c  gh conversion al
-00006b50: 676f 7269 7468 6d20 746f 2061 6c69 676e  gorithm to align
-00006b60: 2032 2074 7970 6573 206f 6620 5265 6164   2 types of Read
-00006b70: 6572 202f 2057 7269 7465 7220 7061 7261  er / Writer para
-00006b80: 6d65 7465 7273 0a20 2020 2020 2020 2023  meters.        #
-00006b90: 2054 4f44 4f3a 204f 7074 696d 697a 6520   TODO: Optimize 
-00006ba0: 7468 6520 636f 6e76 6572 7369 6f6e 2061  the conversion a
-00006bb0: 6c67 6f72 6974 686d 0a20 2020 2020 2020  lgorithm.       
-00006bc0: 2062 6c6f 636b 5f63 6170 6163 6974 7920   block_capacity 
-00006bd0: 3d20 6d61 785f 6275 6666 6572 5f73 697a  = max_buffer_siz
-00006be0: 6520 2f2f 2062 6c6f 636b 5f73 697a 650a  e // block_size.
-00006bf0: 2020 2020 2020 2020 6966 2066 6f72 7761          if forwa
-00006c00: 7264 5f72 6174 696f 2069 7320 4e6f 6e65  rd_ratio is None
-00006c10: 3a0a 2020 2020 2020 2020 2020 2020 626c  :.            bl
-00006c20: 6f63 6b5f 666f 7277 6172 6420 3d20 4e6f  ock_forward = No
-00006c30: 6e65 0a20 2020 2020 2020 2065 6c73 653a  ne.        else:
-00006c40: 0a20 2020 2020 2020 2020 2020 2062 6c6f  .            blo
-00006c50: 636b 5f66 6f72 7761 7264 203d 206d 6178  ck_forward = max
-00006c60: 2869 6e74 2862 6c6f 636b 5f63 6170 6163  (int(block_capac
-00006c70: 6974 7920 2a20 666f 7277 6172 645f 7261  ity * forward_ra
-00006c80: 7469 6f29 2c20 3129 0a20 2020 2020 2020  tio), 1).       
-00006c90: 2069 6620 7368 6172 655f 6361 6368 655f   if share_cache_
-00006ca0: 6b65 7920 6973 206e 6f74 204e 6f6e 653a  key is not None:
-00006cb0: 0a20 2020 2020 2020 2020 2020 2072 6561  .            rea
-00006cc0: 6465 7220 3d20 5333 5368 6172 6543 6163  der = S3ShareCac
-00006cd0: 6865 5265 6164 6572 280a 2020 2020 2020  heReader(.      
-00006ce0: 2020 2020 2020 2020 2020 6275 636b 6574            bucket
-00006cf0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00006d00: 2020 6b65 792c 0a20 2020 2020 2020 2020    key,.         
-00006d10: 2020 2020 2020 2063 6163 6865 5f6b 6579         cache_key
-00006d20: 3d73 6861 7265 5f63 6163 6865 5f6b 6579  =share_cache_key
-00006d30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00006d40: 2020 7333 5f63 6c69 656e 743d 636c 6965    s3_client=clie
-00006d50: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
-00006d60: 2020 2020 6d61 785f 7265 7472 6965 733d      max_retries=
-00006d70: 6d61 785f 7265 7472 6965 732c 0a20 2020  max_retries,.   
-00006d80: 2020 2020 2020 2020 2020 2020 206d 6178               max
-00006d90: 5f77 6f72 6b65 7273 3d6d 6178 5f63 6f6e  _workers=max_con
-00006da0: 6375 7272 656e 6379 2c0a 2020 2020 2020  currency,.      
-00006db0: 2020 2020 2020 2020 2020 626c 6f63 6b5f            block_
-00006dc0: 7369 7a65 3d62 6c6f 636b 5f73 697a 652c  size=block_size,
-00006dd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006de0: 2062 6c6f 636b 5f66 6f72 7761 7264 3d62   block_forward=b
-00006df0: 6c6f 636b 5f66 6f72 7761 7264 290a 2020  lock_forward).  
-00006e00: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00006e10: 2020 2020 2020 2020 7265 6164 6572 203d          reader =
-00006e20: 2053 3350 7265 6665 7463 6852 6561 6465   S3PrefetchReade
-00006e30: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-00006e40: 2020 2062 7563 6b65 742c 0a20 2020 2020     bucket,.     
-00006e50: 2020 2020 2020 2020 2020 206b 6579 2c0a             key,.
-00006e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006e70: 7333 5f63 6c69 656e 743d 636c 6965 6e74  s3_client=client
-00006e80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00006e90: 2020 6d61 785f 7265 7472 6965 733d 6d61    max_retries=ma
-00006ea0: 785f 7265 7472 6965 732c 0a20 2020 2020  x_retries,.     
-00006eb0: 2020 2020 2020 2020 2020 206d 6178 5f77             max_w
-00006ec0: 6f72 6b65 7273 3d6d 6178 5f63 6f6e 6375  orkers=max_concu
-00006ed0: 7272 656e 6379 2c0a 2020 2020 2020 2020  rrency,.        
-00006ee0: 2020 2020 2020 2020 626c 6f63 6b5f 6361          block_ca
-00006ef0: 7061 6369 7479 3d62 6c6f 636b 5f63 6170  pacity=block_cap
-00006f00: 6163 6974 792c 0a20 2020 2020 2020 2020  acity,.         
-00006f10: 2020 2020 2020 2062 6c6f 636b 5f66 6f72         block_for
-00006f20: 7761 7264 3d62 6c6f 636b 5f66 6f72 7761  ward=block_forwa
-00006f30: 7264 2c0a 2020 2020 2020 2020 2020 2020  rd,.            
-00006f40: 2020 2020 626c 6f63 6b5f 7369 7a65 3d62      block_size=b
-00006f50: 6c6f 636b 5f73 697a 6529 0a20 2020 2020  lock_size).     
-00006f60: 2020 2069 6620 6275 6666 6572 6564 3a0a     if buffered:.
-00006f70: 2020 2020 2020 2020 2020 2020 7265 6164              read
-00006f80: 6572 203d 2069 6f2e 4275 6666 6572 6564  er = io.Buffered
-00006f90: 5265 6164 6572 2872 6561 6465 7229 2020  Reader(reader)  
-00006fa0: 2320 7079 7479 7065 3a20 6469 7361 626c  # pytype: disabl
-00006fb0: 653d 7772 6f6e 672d 6172 672d 7479 7065  e=wrong-arg-type
-00006fc0: 730a 2020 2020 2020 2020 7265 7475 726e  s.        return
-00006fd0: 2072 6561 6465 720a 0a20 2020 2069 6620   reader..    if 
-00006fe0: 6c69 6d69 7465 645f 7365 656b 6162 6c65  limited_seekable
-00006ff0: 3a0a 2020 2020 2020 2020 7772 6974 6572  :.        writer
-00007000: 203d 2053 334c 696d 6974 6564 5365 656b   = S3LimitedSeek
-00007010: 6162 6c65 5772 6974 6572 280a 2020 2020  ableWriter(.    
-00007020: 2020 2020 2020 2020 6275 636b 6574 2c0a          bucket,.
-00007030: 2020 2020 2020 2020 2020 2020 6b65 792c              key,
-00007040: 0a20 2020 2020 2020 2020 2020 2073 335f  .            s3_
-00007050: 636c 6965 6e74 3d63 6c69 656e 742c 0a20  client=client,. 
-00007060: 2020 2020 2020 2020 2020 206d 6178 5f77             max_w
-00007070: 6f72 6b65 7273 3d6d 6178 5f63 6f6e 6375  orkers=max_concu
-00007080: 7272 656e 6379 2c0a 2020 2020 2020 2020  rrency,.        
-00007090: 2020 2020 6d61 785f 6275 6666 6572 5f73      max_buffer_s
-000070a0: 697a 653d 6d61 785f 6275 6666 6572 5f73  ize=max_buffer_s
-000070b0: 697a 652c 0a20 2020 2020 2020 2020 2020  ize,.           
-000070c0: 2062 6c6f 636b 5f73 697a 653d 626c 6f63   block_size=bloc
-000070d0: 6b5f 7369 7a65 290a 2020 2020 656c 7365  k_size).    else
-000070e0: 3a0a 2020 2020 2020 2020 7772 6974 6572  :.        writer
-000070f0: 203d 2053 3342 7566 6665 7265 6457 7269   = S3BufferedWri
-00007100: 7465 7228 0a20 2020 2020 2020 2020 2020  ter(.           
-00007110: 2062 7563 6b65 742c 0a20 2020 2020 2020   bucket,.       
-00007120: 2020 2020 206b 6579 2c0a 2020 2020 2020       key,.      
-00007130: 2020 2020 2020 7333 5f63 6c69 656e 743d        s3_client=
-00007140: 636c 6965 6e74 2c0a 2020 2020 2020 2020  client,.        
-00007150: 2020 2020 6d61 785f 776f 726b 6572 733d      max_workers=
-00007160: 6d61 785f 636f 6e63 7572 7265 6e63 792c  max_concurrency,
-00007170: 0a20 2020 2020 2020 2020 2020 206d 6178  .            max
-00007180: 5f62 7566 6665 725f 7369 7a65 3d6d 6178  _buffer_size=max
-00007190: 5f62 7566 6665 725f 7369 7a65 2c0a 2020  _buffer_size,.  
-000071a0: 2020 2020 2020 2020 2020 626c 6f63 6b5f            block_
-000071b0: 7369 7a65 3d62 6c6f 636b 5f73 697a 6529  size=block_size)
-000071c0: 0a20 2020 2069 6620 6275 6666 6572 6564  .    if buffered
-000071d0: 3a0a 2020 2020 2020 2020 7772 6974 6572  :.        writer
-000071e0: 203d 2069 6f2e 4275 6666 6572 6564 5772   = io.BufferedWr
-000071f0: 6974 6572 2877 7269 7465 7229 2020 2320  iter(writer)  # 
-00007200: 7079 7479 7065 3a20 6469 7361 626c 653d  pytype: disable=
-00007210: 7772 6f6e 672d 6172 672d 7479 7065 730a  wrong-arg-types.
-00007220: 2020 2020 7265 7475 726e 2077 7269 7465      return write
-00007230: 720a 0a0a 405f 7333 5f62 696e 6172 795f  r...@_s3_binary_
-00007240: 6d6f 6465 0a64 6566 2073 335f 6d65 6d6f  mode.def s3_memo
-00007250: 7279 5f6f 7065 6e28 0a20 2020 2020 2020  ry_open(.       
-00007260: 2073 335f 7572 6c3a 2050 6174 684c 696b   s3_url: PathLik
-00007270: 652c 206d 6f64 653a 2073 7472 2c0a 2020  e, mode: str,.  
-00007280: 2020 2020 2020 666f 6c6c 6f77 6c69 6e6b        followlink
-00007290: 733a 2062 6f6f 6c20 3d20 4661 6c73 6529  s: bool = False)
-000072a0: 202d 3e20 5333 4d65 6d6f 7279 4861 6e64   -> S3MemoryHand
-000072b0: 6c65 723a 0a20 2020 2027 2727 4f70 656e  ler:.    '''Open
-000072c0: 2061 206d 656d 6f72 792d 6361 6368 6520   a memory-cache 
-000072d0: 6669 6c65 2072 6561 6465 7220 2f20 7772  file reader / wr
-000072e0: 6974 6572 2c20 666f 7220 6672 6571 7565  iter, for freque
-000072f0: 6e74 2072 616e 646f 6d20 7265 6164 202f  nt random read /
-00007300: 2077 7269 7465 0a0a 2020 2020 2e2e 206e   write..    .. n
-00007310: 6f74 6520 3a3a 0a0a 2020 2020 2020 2020  ote ::..        
-00007320: 5573 6572 2073 686f 756c 6420 6d61 6b65  User should make
-00007330: 2073 7572 6520 7468 6174 2072 6561 6465   sure that reade
-00007340: 7220 2f20 7772 6974 6572 2061 7265 2063  r / writer are c
-00007350: 6c6f 7365 6420 636f 7272 6563 746c 790a  losed correctly.
-00007360: 0a20 2020 2020 2020 2053 7570 706f 7274  .        Support
-00007370: 7320 636f 6e74 6578 7420 6d61 6e61 6765  s context manage
-00007380: 720a 0a20 2020 203a 7061 7261 6d20 6d6f  r..    :param mo
-00007390: 6465 3a20 4d6f 6465 2074 6f20 6f70 656e  de: Mode to open
-000073a0: 2066 696c 652c 2063 6f75 6c64 2062 6520   file, could be 
-000073b0: 6f6e 6520 6f66 2022 7262 222c 2022 7762  one of "rb", "wb
-000073c0: 222c 2022 6162 222c 2022 7262 2b22 2c20  ", "ab", "rb+", 
-000073d0: 2277 622b 2220 6f72 2022 6162 2b22 0a20  "wb+" or "ab+". 
-000073e0: 2020 203a 7265 7475 726e 733a 2041 6e20     :returns: An 
-000073f0: 6f70 656e 6564 2042 7566 6665 7265 6452  opened BufferedR
-00007400: 6561 6465 7220 2f20 4275 6666 6572 6564  eader / Buffered
-00007410: 5772 6974 6572 206f 626a 6563 740a 2020  Writer object.  
-00007420: 2020 2727 270a 2020 2020 6966 206d 6f64    '''.    if mod
-00007430: 6520 6e6f 7420 696e 2028 2772 6227 2c20  e not in ('rb', 
-00007440: 2777 6227 2c20 2761 6227 2c20 2772 622b  'wb', 'ab', 'rb+
-00007450: 272c 2027 7762 2b27 2c20 2761 622b 2729  ', 'wb+', 'ab+')
-00007460: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-00007470: 5661 6c75 6545 7272 6f72 2827 756e 6163  ValueError('unac
-00007480: 6365 7074 6162 6c65 206d 6f64 653a 2025  ceptable mode: %
-00007490: 7227 2025 206d 6f64 6529 0a20 2020 2069  r' % mode).    i
-000074a0: 6620 666f 6c6c 6f77 6c69 6e6b 733a 0a20  f followlinks:. 
-000074b0: 2020 2020 2020 206d 6574 6164 6174 6120         metadata 
-000074c0: 3d20 5f73 335f 6765 745f 6d65 7461 6461  = _s3_get_metada
-000074d0: 7461 2873 335f 7572 6c29 0a20 2020 2020  ta(s3_url).     
-000074e0: 2020 2069 6620 6d65 7461 6461 7461 2061     if metadata a
-000074f0: 6e64 2027 7379 6d6c 696e 6b5f 746f 2720  nd 'symlink_to' 
-00007500: 696e 206d 6574 6164 6174 613a 0a20 2020  in metadata:.   
-00007510: 2020 2020 2020 2020 2073 335f 7572 6c20           s3_url 
-00007520: 3d20 6d65 7461 6461 7461 5b27 7379 6d6c  = metadata['syml
-00007530: 696e 6b5f 746f 275d 0a0a 2020 2020 6275  ink_to']..    bu
-00007540: 636b 6574 2c20 6b65 7920 3d20 7061 7273  cket, key = pars
-00007550: 655f 7333 5f75 726c 2873 335f 7572 6c29  e_s3_url(s3_url)
-00007560: 0a20 2020 2063 6f6e 6669 6720 3d20 626f  .    config = bo
-00007570: 746f 636f 7265 2e63 6f6e 6669 672e 436f  tocore.config.Co
-00007580: 6e66 6967 286d 6178 5f70 6f6f 6c5f 636f  nfig(max_pool_co
-00007590: 6e6e 6563 7469 6f6e 733d 6d61 785f 706f  nnections=max_po
-000075a0: 6f6c 5f63 6f6e 6e65 6374 696f 6e73 290a  ol_connections).
-000075b0: 2020 2020 636c 6965 6e74 203d 2067 6574      client = get
-000075c0: 5f73 335f 636c 6965 6e74 2863 6f6e 6669  _s3_client(confi
-000075d0: 673d 636f 6e66 6967 2c20 6361 6368 655f  g=config, cache_
-000075e0: 6b65 793d 2773 335f 6669 6c65 6c69 6b65  key='s3_filelike
-000075f0: 5f63 6c69 656e 7427 290a 2020 2020 7265  _client').    re
-00007600: 7475 726e 2053 334d 656d 6f72 7948 616e  turn S3MemoryHan
-00007610: 646c 6572 2862 7563 6b65 742c 206b 6579  dler(bucket, key
-00007620: 2c20 6d6f 6465 2c20 7333 5f63 6c69 656e  , mode, s3_clien
-00007630: 743d 636c 6965 6e74 290a 0a0a 405f 7333  t=client)...@_s3
-00007640: 5f62 696e 6172 795f 6d6f 6465 0a64 6566  _binary_mode.def
-00007650: 2073 335f 6c65 6761 6379 5f6f 7065 6e28   s3_legacy_open(
-00007660: 7333 5f75 726c 3a20 5061 7468 4c69 6b65  s3_url: PathLike
-00007670: 2c20 6d6f 6465 3a20 7374 722c 2066 6f6c  , mode: str, fol
-00007680: 6c6f 776c 696e 6b73 3a20 626f 6f6c 203d  lowlinks: bool =
-00007690: 2046 616c 7365 293a 0a20 2020 2027 2727   False):.    '''
-000076a0: 5573 6520 736d 6172 745f 6f70 656e 2e73  Use smart_open.s
-000076b0: 332e 6f70 656e 206f 7065 6e20 6120 7265  3.open open a re
-000076c0: 6164 6572 202f 2077 7269 7465 720a 0a20  ader / writer.. 
-000076d0: 2020 202e 2e20 6e6f 7465 203a 3a0a 0a20     .. note ::.. 
-000076e0: 2020 2020 2020 2055 7365 7220 7368 6f75         User shou
-000076f0: 6c64 206d 616b 6520 7375 7265 2074 6861  ld make sure tha
-00007700: 7420 7265 6164 6572 202f 2077 7269 7465  t reader / write
-00007710: 7220 6172 6520 636c 6f73 6564 2063 6f72  r are closed cor
-00007720: 7265 6374 6c79 0a0a 2020 2020 2020 2020  rectly..        
-00007730: 5375 7070 6f72 7473 2063 6f6e 7465 7874  Supports context
-00007740: 206d 616e 6167 6572 0a0a 2020 2020 3a70   manager..    :p
-00007750: 6172 616d 206d 6f64 653a 204d 6f64 6520  aram mode: Mode 
-00007760: 746f 206f 7065 6e20 6669 6c65 2c20 6569  to open file, ei
-00007770: 7468 6572 2022 7262 2220 6f72 2022 7762  ther "rb" or "wb
-00007780: 220a 2020 2020 3a72 6574 7572 6e73 3a20  ".    :returns: 
-00007790: 4669 6c65 2d4c 696b 6520 4f62 6a65 6374  File-Like Object
-000077a0: 0a20 2020 2027 2727 0a20 2020 2069 6620  .    '''.    if 
-000077b0: 6d6f 6465 206e 6f74 2069 6e20 2827 7262  mode not in ('rb
-000077c0: 272c 2027 7762 2729 3a20 2023 2070 7261  ', 'wb'):  # pra
-000077d0: 676d 613a 206e 6f20 636f 7665 720a 2020  gma: no cover.  
-000077e0: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-000077f0: 6545 7272 6f72 2827 756e 6163 6365 7074  eError('unaccept
-00007800: 6162 6c65 206d 6f64 653a 2025 7227 2025  able mode: %r' %
-00007810: 206d 6f64 6529 0a20 2020 2069 6620 666f   mode).    if fo
-00007820: 6c6c 6f77 6c69 6e6b 733a 0a20 2020 2020  llowlinks:.     
-00007830: 2020 206d 6574 6164 6174 6120 3d20 5f73     metadata = _s
-00007840: 335f 6765 745f 6d65 7461 6461 7461 2873  3_get_metadata(s
-00007850: 335f 7572 6c29 0a20 2020 2020 2020 2069  3_url).        i
-00007860: 6620 6d65 7461 6461 7461 2061 6e64 2027  f metadata and '
-00007870: 7379 6d6c 696e 6b5f 746f 2720 696e 206d  symlink_to' in m
-00007880: 6574 6164 6174 613a 0a20 2020 2020 2020  etadata:.       
-00007890: 2020 2020 2073 335f 7572 6c20 3d20 6d65       s3_url = me
-000078a0: 7461 6461 7461 5b27 7379 6d6c 696e 6b5f  tadata['symlink_
-000078b0: 746f 275d 0a0a 2020 2020 6275 636b 6574  to']..    bucket
-000078c0: 2c20 6b65 7920 3d20 7061 7273 655f 7333  , key = parse_s3
-000078d0: 5f75 726c 2873 335f 7572 6c29 0a0a 2020  _url(s3_url)..  
-000078e0: 2020 7472 793a 0a20 2020 2020 2020 2072    try:.        r
-000078f0: 6574 7572 6e20 5f73 335f 6f70 656e 2862  eturn _s3_open(b
-00007900: 7563 6b65 742c 206b 6579 2c20 6d6f 6465  ucket, key, mode
-00007910: 290a 2020 2020 6578 6365 7074 2045 7863  ).    except Exc
-00007920: 6570 7469 6f6e 2061 7320 6572 726f 723a  eption as error:
-00007930: 2020 2320 7072 6167 6d61 3a20 6e6f 2063    # pragma: no c
-00007940: 6f76 6572 0a20 2020 2020 2020 2069 6620  over.        if 
-00007950: 6973 696e 7374 616e 6365 2865 7272 6f72  isinstance(error
-00007960: 2c20 494f 4572 726f 7229 3a0a 2020 2020  , IOError):.    
-00007970: 2020 2020 2020 2020 6572 726f 725f 7374          error_st
-00007980: 7220 3d20 7374 7228 6572 726f 7229 0a20  r = str(error). 
-00007990: 2020 2020 2020 2020 2020 2069 6620 274e             if 'N
-000079a0: 6f53 7563 684b 6579 2720 696e 2065 7272  oSuchKey' in err
-000079b0: 6f72 5f73 7472 3a0a 2020 2020 2020 2020  or_str:.        
-000079c0: 2020 2020 2020 2020 7261 6973 6520 5333          raise S3
-000079d0: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
-000079e0: 7228 274e 6f20 7375 6368 2066 696c 653a  r('No such file:
-000079f0: 2025 7227 2025 2073 335f 7572 6c29 0a20   %r' % s3_url). 
-00007a00: 2020 2020 2020 2020 2020 2069 6620 274e             if 'N
-00007a10: 6f53 7563 6842 7563 6b65 7427 2069 6e20  oSuchBucket' in 
-00007a20: 6572 726f 725f 7374 723a 0a20 2020 2020  error_str:.     
-00007a30: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00007a40: 2053 3342 7563 6b65 744e 6f74 466f 756e   S3BucketNotFoun
-00007a50: 6445 7272 6f72 2827 4e6f 2073 7563 6820  dError('No such 
-00007a60: 6275 636b 6574 3a20 2572 2720 2520 7333  bucket: %r' % s3
-00007a70: 5f75 726c 290a 2020 2020 2020 2020 2020  _url).          
-00007a80: 2020 666f 7220 636f 6465 2069 6e20 2827    for code in ('
-00007a90: 4163 6365 7373 4465 6e69 6564 272c 2027  AccessDenied', '
-00007aa0: 496e 7661 6c69 6441 6363 6573 734b 6579  InvalidAccessKey
-00007ab0: 4964 272c 0a20 2020 2020 2020 2020 2020  Id',.           
-00007ac0: 2020 2020 2020 2020 2020 2020 2020 2753                'S
-00007ad0: 6967 6e61 7475 7265 446f 6573 4e6f 744d  ignatureDoesNotM
-00007ae0: 6174 6368 2729 3a0a 2020 2020 2020 2020  atch'):.        
-00007af0: 2020 2020 2020 2020 6966 2063 6f64 6520          if code 
-00007b00: 696e 2065 7272 6f72 5f73 7472 3a0a 2020  in error_str:.  
-00007b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007b20: 2020 7261 6973 6520 5333 5065 726d 6973    raise S3Permis
-00007b30: 7369 6f6e 4572 726f 7228 0a20 2020 2020  sionError(.     
-00007b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007b50: 2020 2027 5065 726d 6973 7369 6f6e 2064     'Permission d
-00007b60: 656e 6965 643a 2025 722c 2063 6f64 653a  enied: %r, code:
-00007b70: 2025 7327 2025 2028 7333 5f75 726c 2c20   %s' % (s3_url, 
-00007b80: 636f 6465 2929 0a20 2020 2020 2020 2020  code)).         
-00007b90: 2020 2072 6169 7365 2053 3355 6e6b 6e6f     raise S3Unkno
-00007ba0: 776e 4572 726f 7228 6572 726f 722c 2073  wnError(error, s
-00007bb0: 335f 7572 6c29 0a20 2020 2020 2020 2065  3_url).        e
-00007bc0: 6c69 6620 6973 696e 7374 616e 6365 2865  lif isinstance(e
-00007bd0: 7272 6f72 2c20 5661 6c75 6545 7272 6f72  rror, ValueError
-00007be0: 293a 0a20 2020 2020 2020 2020 2020 2065  ):.            e
-00007bf0: 7272 6f72 5f73 7472 203d 2073 7472 2865  rror_str = str(e
-00007c00: 7272 6f72 290a 2020 2020 2020 2020 2020  rror).          
-00007c10: 2020 6966 2027 646f 6573 206e 6f74 2065    if 'does not e
-00007c20: 7869 7374 2720 696e 2065 7272 6f72 5f73  xist' in error_s
-00007c30: 7472 3a0a 2020 2020 2020 2020 2020 2020  tr:.            
-00007c40: 2020 2020 2320 6966 2062 7563 6b65 7420      # if bucket 
-00007c50: 6973 206e 6f6e 2d65 7869 7374 656e 7420  is non-existent 
-00007c60: 6f72 2068 6173 206e 6f20 5752 4954 4520  or has no WRITE 
-00007c70: 6163 6365 7373 0a20 2020 2020 2020 2020  access.         
-00007c80: 2020 2020 2020 2072 6169 7365 2053 3342         raise S3B
-00007c90: 7563 6b65 744e 6f74 466f 756e 6445 7272  ucketNotFoundErr
-00007ca0: 6f72 2827 4e6f 2073 7563 6820 6275 636b  or('No such buck
-00007cb0: 6574 3a20 2572 2720 2520 7333 5f75 726c  et: %r' % s3_url
-00007cc0: 290a 2020 2020 2020 2020 2020 2020 7261  ).            ra
-00007cd0: 6973 6520 5333 556e 6b6e 6f77 6e45 7272  ise S3UnknownErr
-00007ce0: 6f72 2865 7272 6f72 2c20 7333 5f75 726c  or(error, s3_url
-00007cf0: 290a 2020 2020 2020 2020 7261 6973 6520  ).        raise 
-00007d00: 7472 616e 736c 6174 655f 7333 5f65 7272  translate_s3_err
-00007d10: 6f72 2865 7272 6f72 2c20 7333 5f75 726c  or(error, s3_url
-00007d20: 290a 0a0a 7333 5f6f 7065 6e20 3d20 7333  )...s3_open = s3
-00007d30: 5f62 7566 6665 7265 645f 6f70 656e 0a0a  _buffered_open..
-00007d40: 0a64 6566 2073 335f 646f 776e 6c6f 6164  .def s3_download
-00007d50: 280a 2020 2020 2020 2020 7372 635f 7572  (.        src_ur
-00007d60: 6c3a 2050 6174 684c 696b 652c 0a20 2020  l: PathLike,.   
-00007d70: 2020 2020 2064 7374 5f75 726c 3a20 5061       dst_url: Pa
-00007d80: 7468 4c69 6b65 2c0a 2020 2020 2020 2020  thLike,.        
-00007d90: 666f 6c6c 6f77 6c69 6e6b 733a 2062 6f6f  followlinks: boo
-00007da0: 6c20 3d20 4661 6c73 652c 0a20 2020 2020  l = False,.     
-00007db0: 2020 2063 616c 6c62 6163 6b3a 204f 7074     callback: Opt
-00007dc0: 696f 6e61 6c5b 4361 6c6c 6162 6c65 5b5b  ional[Callable[[
-00007dd0: 696e 745d 2c20 4e6f 6e65 5d5d 203d 204e  int], None]] = N
-00007de0: 6f6e 6529 202d 3e20 4e6f 6e65 3a0a 2020  one) -> None:.  
-00007df0: 2020 2727 270a 2020 2020 446f 776e 6c6f    '''.    Downlo
-00007e00: 6164 7320 6120 6669 6c65 2066 726f 6d20  ads a file from 
-00007e10: 7333 2074 6f20 6c6f 6361 6c20 6669 6c65  s3 to local file
-00007e20: 7379 7374 656d 2e0a 2020 2020 3a70 6172  system..    :par
-00007e30: 616d 2073 7263 5f75 726c 3a20 736f 7572  am src_url: sour
-00007e40: 6365 2073 3320 7061 7468 0a20 2020 203a  ce s3 path.    :
-00007e50: 7061 7261 6d20 6473 745f 7572 6c3a 2074  param dst_url: t
-00007e60: 6172 6765 7420 6673 2070 6174 680a 2020  arget fs path.  
-00007e70: 2020 3a70 6172 616d 2063 616c 6c62 6163    :param callbac
-00007e80: 6b3a 2043 616c 6c65 6420 7065 7269 6f64  k: Called period
-00007e90: 6963 616c 6c79 2064 7572 696e 6720 636f  ically during co
-00007ea0: 7079 2c20 616e 6420 7468 6520 696e 7075  py, and the inpu
-00007eb0: 7420 7061 7261 6d65 7465 7220 6973 2074  t parameter is t
-00007ec0: 6865 2064 6174 6120 7369 7a65 2028 696e  he data size (in
-00007ed0: 2062 7974 6573 2920 6f66 2063 6f70 7920   bytes) of copy 
-00007ee0: 7369 6e63 6520 7468 6520 6c61 7374 2063  since the last c
-00007ef0: 616c 6c0a 2020 2020 2727 270a 2020 2020  all.    '''.    
-00007f00: 6966 2066 6f6c 6c6f 776c 696e 6b73 3a0a  if followlinks:.
-00007f10: 2020 2020 2020 2020 6d65 7461 6461 7461          metadata
-00007f20: 203d 205f 7333 5f67 6574 5f6d 6574 6164   = _s3_get_metad
-00007f30: 6174 6128 7372 635f 7572 6c29 0a20 2020  ata(src_url).   
-00007f40: 2020 2020 2069 6620 6d65 7461 6461 7461       if metadata
-00007f50: 2061 6e64 2027 7379 6d6c 696e 6b5f 746f   and 'symlink_to
-00007f60: 2720 696e 206d 6574 6164 6174 613a 0a20  ' in metadata:. 
-00007f70: 2020 2020 2020 2020 2020 2073 7263 5f75             src_u
-00007f80: 726c 203d 206d 6574 6164 6174 615b 2773  rl = metadata['s
-00007f90: 796d 6c69 6e6b 5f74 6f27 5d0a 2020 2020  ymlink_to'].    
-00007fa0: 7372 635f 6275 636b 6574 2c20 7372 635f  src_bucket, src_
-00007fb0: 6b65 7920 3d20 7061 7273 655f 7333 5f75  key = parse_s3_u
-00007fc0: 726c 2873 7263 5f75 726c 290a 2020 2020  rl(src_url).    
-00007fd0: 6966 206e 6f74 2073 7263 5f62 7563 6b65  if not src_bucke
-00007fe0: 743a 0a20 2020 2020 2020 2072 6169 7365  t:.        raise
-00007ff0: 2053 3342 7563 6b65 744e 6f74 466f 756e   S3BucketNotFoun
-00008000: 6445 7272 6f72 2827 456d 7074 7920 6275  dError('Empty bu
-00008010: 636b 6574 206e 616d 653a 2025 7227 2025  cket name: %r' %
-00008020: 2073 7263 5f75 726c 290a 0a20 2020 2069   src_url)..    i
-00008030: 6620 6e6f 7420 5333 5061 7468 2873 7263  f not S3Path(src
-00008040: 5f75 726c 292e 6578 6973 7473 2829 3a0a  _url).exists():.
-00008050: 2020 2020 2020 2020 7261 6973 6520 5333          raise S3
-00008060: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
-00008070: 7228 2746 696c 6520 6e6f 7420 666f 756e  r('File not foun
-00008080: 643a 2025 7227 2025 2073 7263 5f75 726c  d: %r' % src_url
-00008090: 290a 0a20 2020 2069 6620 6e6f 7420 5333  )..    if not S3
-000080a0: 5061 7468 2873 7263 5f75 726c 292e 6973  Path(src_url).is
-000080b0: 5f66 696c 6528 293a 0a20 2020 2020 2020  _file():.       
-000080c0: 2072 6169 7365 2053 3349 7341 4469 7265   raise S3IsADire
-000080d0: 6374 6f72 7945 7272 6f72 2827 4973 2061  ctoryError('Is a
-000080e0: 2064 6972 6563 746f 7279 3a20 2572 2720   directory: %r' 
-000080f0: 2520 7372 635f 7572 6c29 0a0a 2020 2020  % src_url)..    
-00008100: 6473 745f 7572 6c20 3d20 6673 7061 7468  dst_url = fspath
-00008110: 2864 7374 5f75 726c 290a 2020 2020 6966  (dst_url).    if
-00008120: 206e 6f74 2064 7374 5f75 726c 206f 7220   not dst_url or 
-00008130: 6473 745f 7572 6c2e 656e 6473 7769 7468  dst_url.endswith
-00008140: 2827 2f27 293a 0a20 2020 2020 2020 2072  ('/'):.        r
-00008150: 6169 7365 2053 3349 7341 4469 7265 6374  aise S3IsADirect
-00008160: 6f72 7945 7272 6f72 2827 4973 2061 2064  oryError('Is a d
-00008170: 6972 6563 746f 7279 3a20 2572 2720 2520  irectory: %r' % 
-00008180: 6473 745f 7572 6c29 0a0a 2020 2020 6473  dst_url)..    ds
-00008190: 745f 6469 7265 6374 6f72 7920 3d20 6f73  t_directory = os
-000081a0: 2e70 6174 682e 6469 726e 616d 6528 6473  .path.dirname(ds
-000081b0: 745f 7572 6c29 0a20 2020 2069 6620 6473  t_url).    if ds
-000081c0: 745f 6469 7265 6374 6f72 7920 213d 2027  t_directory != '
-000081d0: 273a 0a20 2020 2020 2020 206f 732e 6d61  ':.        os.ma
-000081e0: 6b65 6469 7273 2864 7374 5f64 6972 6563  kedirs(dst_direc
-000081f0: 746f 7279 2c20 6578 6973 745f 6f6b 3d54  tory, exist_ok=T
-00008200: 7275 6529 0a0a 2020 2020 636c 6965 6e74  rue)..    client
-00008210: 203d 2067 6574 5f73 335f 636c 6965 6e74   = get_s3_client
-00008220: 2829 0a20 2020 2074 7279 3a0a 2020 2020  ().    try:.    
-00008230: 2020 2020 636c 6965 6e74 2e64 6f77 6e6c      client.downl
-00008240: 6f61 645f 6669 6c65 2873 7263 5f62 7563  oad_file(src_buc
-00008250: 6b65 742c 2073 7263 5f6b 6579 2c20 6473  ket, src_key, ds
-00008260: 745f 7572 6c2c 2043 616c 6c62 6163 6b3d  t_url, Callback=
-00008270: 6361 6c6c 6261 636b 290a 2020 2020 6578  callback).    ex
-00008280: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
-00008290: 7320 6572 726f 723a 2020 2320 7072 6167  s error:  # prag
-000082a0: 6d61 3a20 6e6f 2063 6f76 6572 0a20 2020  ma: no cover.   
-000082b0: 2020 2020 2065 7272 6f72 203d 2074 7261       error = tra
-000082c0: 6e73 6c61 7465 5f66 735f 6572 726f 7228  nslate_fs_error(
-000082d0: 6572 726f 722c 2064 7374 5f75 726c 290a  error, dst_url).
-000082e0: 2020 2020 2020 2020 6572 726f 7220 3d20          error = 
-000082f0: 7472 616e 736c 6174 655f 7333 5f65 7272  translate_s3_err
-00008300: 6f72 2865 7272 6f72 2c20 7372 635f 7572  or(error, src_ur
-00008310: 6c29 0a20 2020 2020 2020 2072 6169 7365  l).        raise
-00008320: 2065 7272 6f72 0a0a 0a64 6566 2073 335f   error...def s3_
-00008330: 7570 6c6f 6164 280a 2020 2020 2020 2020  upload(.        
-00008340: 7372 635f 7572 6c3a 2050 6174 684c 696b  src_url: PathLik
-00008350: 652c 0a20 2020 2020 2020 2064 7374 5f75  e,.        dst_u
-00008360: 726c 3a20 5061 7468 4c69 6b65 2c0a 2020  rl: PathLike,.  
-00008370: 2020 2020 2020 6361 6c6c 6261 636b 3a20        callback: 
-00008380: 4f70 7469 6f6e 616c 5b43 616c 6c61 626c  Optional[Callabl
-00008390: 655b 5b69 6e74 5d2c 204e 6f6e 655d 5d20  e[[int], None]] 
-000083a0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-000083b0: 2a2a 6b77 6172 6773 2920 2d3e 204e 6f6e  **kwargs) -> Non
-000083c0: 653a 0a20 2020 2027 2727 0a20 2020 2055  e:.    '''.    U
-000083d0: 706c 6f61 6473 2061 2066 696c 6520 6672  ploads a file fr
-000083e0: 6f6d 206c 6f63 616c 2066 696c 6573 7973  om local filesys
-000083f0: 7465 6d20 746f 2073 332e 0a20 2020 203a  tem to s3..    :
-00008400: 7061 7261 6d20 7372 635f 7572 6c3a 2073  param src_url: s
-00008410: 6f75 7263 6520 6673 2070 6174 680a 2020  ource fs path.  
-00008420: 2020 3a70 6172 616d 2064 7374 5f75 726c    :param dst_url
-00008430: 3a20 7461 7267 6574 2073 3320 7061 7468  : target s3 path
-00008440: 0a20 2020 203a 7061 7261 6d20 6361 6c6c  .    :param call
-00008450: 6261 636b 3a20 4361 6c6c 6564 2070 6572  back: Called per
-00008460: 696f 6469 6361 6c6c 7920 6475 7269 6e67  iodically during
-00008470: 2063 6f70 792c 2061 6e64 2074 6865 2069   copy, and the i
-00008480: 6e70 7574 2070 6172 616d 6574 6572 2069  nput parameter i
-00008490: 7320 7468 6520 6461 7461 2073 697a 6520  s the data size 
-000084a0: 2869 6e20 6279 7465 7329 206f 6620 636f  (in bytes) of co
-000084b0: 7079 2073 696e 6365 2074 6865 206c 6173  py since the las
-000084c0: 7420 6361 6c6c 0a20 2020 2027 2727 0a20  t call.    '''. 
-000084d0: 2020 2064 7374 5f62 7563 6b65 742c 2064     dst_bucket, d
-000084e0: 7374 5f6b 6579 203d 2070 6172 7365 5f73  st_key = parse_s
-000084f0: 335f 7572 6c28 6473 745f 7572 6c29 0a20  3_url(dst_url). 
-00008500: 2020 2069 6620 6e6f 7420 6473 745f 6275     if not dst_bu
-00008510: 636b 6574 3a0a 2020 2020 2020 2020 7261  cket:.        ra
-00008520: 6973 6520 5333 4275 636b 6574 4e6f 7446  ise S3BucketNotF
-00008530: 6f75 6e64 4572 726f 7228 2745 6d70 7479  oundError('Empty
-00008540: 2062 7563 6b65 7420 6e61 6d65 3a20 2572   bucket name: %r
-00008550: 2720 2520 6473 745f 7572 6c29 0a20 2020  ' % dst_url).   
-00008560: 2069 6620 6e6f 7420 6473 745f 6b65 7920   if not dst_key 
-00008570: 6f72 2064 7374 5f6b 6579 2e65 6e64 7377  or dst_key.endsw
-00008580: 6974 6828 272f 2729 3a0a 2020 2020 2020  ith('/'):.      
-00008590: 2020 7261 6973 6520 5333 4973 4144 6972    raise S3IsADir
-000085a0: 6563 746f 7279 4572 726f 7228 2749 7320  ectoryError('Is 
-000085b0: 6120 6469 7265 6374 6f72 793a 2025 7227  a directory: %r'
-000085c0: 2025 2064 7374 5f75 726c 290a 0a20 2020   % dst_url)..   
-000085d0: 2063 6c69 656e 7420 3d20 6765 745f 7333   client = get_s3
-000085e0: 5f63 6c69 656e 7428 290a 2020 2020 7769  _client().    wi
-000085f0: 7468 206f 7065 6e28 7372 635f 7572 6c2c  th open(src_url,
-00008600: 2027 7262 2729 2061 7320 7372 633a 0a20   'rb') as src:. 
-00008610: 2020 2020 2020 2077 6974 6820 7261 6973         with rais
-00008620: 655f 7333 5f65 7272 6f72 2864 7374 5f75  e_s3_error(dst_u
-00008630: 726c 293a 0a20 2020 2020 2020 2020 2020  rl):.           
-00008640: 2063 6c69 656e 742e 7570 6c6f 6164 5f66   client.upload_f
-00008650: 696c 656f 626a 280a 2020 2020 2020 2020  ileobj(.        
-00008660: 2020 2020 2020 2020 7372 632c 2042 7563          src, Buc
-00008670: 6b65 743d 6473 745f 6275 636b 6574 2c20  ket=dst_bucket, 
-00008680: 4b65 793d 6473 745f 6b65 792c 2043 616c  Key=dst_key, Cal
-00008690: 6c62 6163 6b3d 6361 6c6c 6261 636b 290a  lback=callback).
-000086a0: 0a0a 6465 6620 6765 745f 636f 6e74 656e  ..def get_conten
-000086b0: 745f 6f66 6673 6574 2873 7461 7274 3a20  t_offset(start: 
-000086c0: 4f70 7469 6f6e 616c 5b69 6e74 5d2c 2073  Optional[int], s
-000086d0: 746f 703a 204f 7074 696f 6e61 6c5b 696e  top: Optional[in
-000086e0: 745d 2c20 7369 7a65 3a20 696e 7429 3a0a  t], size: int):.
-000086f0: 2020 2020 6966 2073 7461 7274 2069 7320      if start is 
-00008700: 4e6f 6e65 3a0a 2020 2020 2020 2020 7374  None:.        st
-00008710: 6172 7420 3d20 300a 2020 2020 6966 2073  art = 0.    if s
-00008720: 746f 7020 6973 204e 6f6e 6520 6f72 2073  top is None or s
-00008730: 746f 7020 3c20 3020 6f72 2073 7461 7274  top < 0 or start
-00008740: 203c 2030 3a0a 2020 2020 2020 2020 7374   < 0:.        st
-00008750: 6172 742c 2073 746f 702c 205f 203d 2073  art, stop, _ = s
-00008760: 6c69 6365 2873 7461 7274 2c20 7374 6f70  lice(start, stop
-00008770: 292e 696e 6469 6365 7328 7369 7a65 290a  ).indices(size).
-00008780: 2020 2020 6966 2073 746f 7020 3c20 7374      if stop < st
-00008790: 6172 743a 0a20 2020 2020 2020 2072 6169  art:.        rai
-000087a0: 7365 2056 616c 7565 4572 726f 7228 2772  se ValueError('r
-000087b0: 6561 6420 6c65 6e67 7468 206d 7573 7420  ead length must 
-000087c0: 6265 2070 6f73 6974 6976 6527 290a 2020  be positive').  
-000087d0: 2020 7265 7475 726e 2073 7461 7274 2c20    return start, 
-000087e0: 7374 6f70 0a0a 0a64 6566 2073 335f 6c6f  stop...def s3_lo
-000087f0: 6164 5f63 6f6e 7465 6e74 280a 2020 2020  ad_content(.    
-00008800: 2020 2020 7333 5f75 726c 2c0a 2020 2020      s3_url,.    
-00008810: 2020 2020 7374 6172 743a 204f 7074 696f      start: Optio
-00008820: 6e61 6c5b 696e 745d 203d 204e 6f6e 652c  nal[int] = None,
-00008830: 0a20 2020 2020 2020 2073 746f 703a 204f  .        stop: O
-00008840: 7074 696f 6e61 6c5b 696e 745d 203d 204e  ptional[int] = N
-00008850: 6f6e 652c 0a20 2020 2020 2020 2066 6f6c  one,.        fol
-00008860: 6c6f 776c 696e 6b73 3a20 626f 6f6c 203d  lowlinks: bool =
-00008870: 2046 616c 7365 2920 2d3e 2062 7974 6573   False) -> bytes
-00008880: 3a0a 2020 2020 2727 270a 2020 2020 4765  :.    '''.    Ge
-00008890: 7420 7370 6563 6966 6965 6420 6669 6c65  t specified file
-000088a0: 2066 726f 6d20 5b73 7461 7274 2c20 7374   from [start, st
-000088b0: 6f70 2920 696e 2062 7974 6573 0a0a 2020  op) in bytes..  
-000088c0: 2020 3a70 6172 616d 2073 335f 7572 6c3a    :param s3_url:
-000088d0: 2053 7065 6369 6669 6564 2070 6174 680a   Specified path.
-000088e0: 2020 2020 3a70 6172 616d 2073 7461 7274      :param start
-000088f0: 3a20 7374 6172 7420 696e 6465 780a 2020  : start index.  
-00008900: 2020 3a70 6172 616d 2073 746f 703a 2073    :param stop: s
-00008910: 746f 7020 696e 6465 780a 2020 2020 3a72  top index.    :r
-00008920: 6574 7572 6e73 3a20 6279 7465 7320 636f  eturns: bytes co
-00008930: 6e74 656e 7420 696e 2072 616e 6765 205b  ntent in range [
-00008940: 7374 6172 742c 2073 746f 7029 0a20 2020  start, stop).   
-00008950: 2027 2727 0a0a 2020 2020 6465 6620 5f67   '''..    def _g
-00008960: 6574 5f6f 626a 6563 7428 636c 6965 6e74  et_object(client
-00008970: 2c20 6275 636b 6579 2c20 6b65 792c 2072  , buckey, key, r
-00008980: 616e 6765 5f73 7472 293a 0a20 2020 2020  ange_str):.     
-00008990: 2020 2072 6574 7572 6e20 636c 6965 6e74     return client
-000089a0: 2e67 6574 5f6f 626a 6563 7428 0a20 2020  .get_object(.   
-000089b0: 2020 2020 2020 2020 2042 7563 6b65 743d           Bucket=
-000089c0: 6275 636b 6574 2c20 4b65 793d 6b65 792c  bucket, Key=key,
-000089d0: 2052 616e 6765 3d72 616e 6765 5f73 7472   Range=range_str
-000089e0: 295b 2742 6f64 7927 5d2e 7265 6164 2829  )['Body'].read()
-000089f0: 0a0a 2020 2020 6966 2066 6f6c 6c6f 776c  ..    if followl
-00008a00: 696e 6b73 3a0a 2020 2020 2020 2020 6d65  inks:.        me
-00008a10: 7461 6461 7461 203d 205f 7333 5f67 6574  tadata = _s3_get
-00008a20: 5f6d 6574 6164 6174 6128 7333 5f75 726c  _metadata(s3_url
-00008a30: 290a 2020 2020 2020 2020 6966 206d 6574  ).        if met
-00008a40: 6164 6174 6120 616e 6420 2773 796d 6c69  adata and 'symli
-00008a50: 6e6b 5f74 6f27 2069 6e20 6d65 7461 6461  nk_to' in metada
-00008a60: 7461 3a0a 2020 2020 2020 2020 2020 2020  ta:.            
-00008a70: 7333 5f75 726c 203d 206d 6574 6164 6174  s3_url = metadat
-00008a80: 615b 2773 796d 6c69 6e6b 5f74 6f27 5d0a  a['symlink_to'].
-00008a90: 2020 2020 6275 636b 6574 2c20 6b65 7920      bucket, key 
-00008aa0: 3d20 7061 7273 655f 7333 5f75 726c 2873  = parse_s3_url(s
-00008ab0: 335f 7572 6c29 0a20 2020 2069 6620 6e6f  3_url).    if no
-00008ac0: 7420 6275 636b 6574 3a0a 2020 2020 2020  t bucket:.      
-00008ad0: 2020 7261 6973 6520 5333 4275 636b 6574    raise S3Bucket
-00008ae0: 4e6f 7446 6f75 6e64 4572 726f 7228 2745  NotFoundError('E
-00008af0: 6d70 7479 2062 7563 6b65 7420 6e61 6d65  mpty bucket name
-00008b00: 3a20 2572 2720 2520 7333 5f75 726c 290a  : %r' % s3_url).
-00008b10: 2020 2020 6966 206e 6f74 206b 6579 206f      if not key o
-00008b20: 7220 6b65 792e 656e 6473 7769 7468 2827  r key.endswith('
-00008b30: 2f27 293a 0a20 2020 2020 2020 2072 6169  /'):.        rai
-00008b40: 7365 2053 3349 7341 4469 7265 6374 6f72  se S3IsADirector
-00008b50: 7945 7272 6f72 2827 4973 2061 2064 6972  yError('Is a dir
-00008b60: 6563 746f 7279 3a20 2572 2720 2520 7333  ectory: %r' % s3
-00008b70: 5f75 726c 290a 0a20 2020 2073 7461 7274  _url)..    start
-00008b80: 2c20 7374 6f70 203d 2067 6574 5f63 6f6e  , stop = get_con
-00008b90: 7465 6e74 5f6f 6666 7365 7428 0a20 2020  tent_offset(.   
-00008ba0: 2020 2020 2073 7461 7274 2c20 7374 6f70       start, stop
-00008bb0: 2c0a 2020 2020 2020 2020 5333 5061 7468  ,.        S3Path
-00008bc0: 2873 335f 7572 6c29 2e67 6574 7369 7a65  (s3_url).getsize
-00008bd0: 2866 6f6c 6c6f 775f 7379 6d6c 696e 6b73  (follow_symlinks
-00008be0: 3d66 6f6c 6c6f 776c 696e 6b73 2929 0a20  =followlinks)). 
-00008bf0: 2020 2069 6620 7374 6172 7420 3d3d 2030     if start == 0
-00008c00: 2061 6e64 2073 746f 7020 3d3d 2030 3a0a   and stop == 0:.
-00008c10: 2020 2020 2020 2020 7265 7475 726e 2062          return b
-00008c20: 2727 0a20 2020 2072 616e 6765 5f73 7472  ''.    range_str
-00008c30: 203d 2027 6279 7465 733d 2564 2d25 6427   = 'bytes=%d-%d'
-00008c40: 2025 2028 7374 6172 742c 2073 746f 7020   % (start, stop 
-00008c50: 2d20 3129 0a0a 2020 2020 636c 6965 6e74  - 1)..    client
-00008c60: 203d 2067 6574 5f73 335f 636c 6965 6e74   = get_s3_client
-00008c70: 2829 0a20 2020 2077 6974 6820 7261 6973  ().    with rais
-00008c80: 655f 7333 5f65 7272 6f72 2873 335f 7572  e_s3_error(s3_ur
-00008c90: 6c29 3a0a 2020 2020 2020 2020 7265 7475  l):.        retu
-00008ca0: 726e 2070 6174 6368 5f6d 6574 686f 6428  rn patch_method(
-00008cb0: 0a20 2020 2020 2020 2020 2020 205f 6765  .            _ge
-00008cc0: 745f 6f62 6a65 6374 2c0a 2020 2020 2020  t_object,.      
-00008cd0: 2020 2020 2020 6d61 785f 7265 7472 6965        max_retrie
-00008ce0: 733d 6d61 785f 7265 7472 6965 732c 0a20  s=max_retries,. 
-00008cf0: 2020 2020 2020 2020 2020 2073 686f 756c             shoul
-00008d00: 645f 7265 7472 793d 7333 5f73 686f 756c  d_retry=s3_shoul
-00008d10: 645f 7265 7472 792c 0a20 2020 2020 2020  d_retry,.       
-00008d20: 2029 2863 6c69 656e 742c 2062 7563 6b65   )(client, bucke
-00008d30: 742c 206b 6579 2c20 7261 6e67 655f 7374  t, key, range_st
-00008d40: 7229 0a0a 0a64 6566 2073 335f 7265 6164  r)...def s3_read
-00008d50: 6c69 6e6b 2870 6174 6829 202d 3e20 7374  link(path) -> st
-00008d60: 723a 0a20 2020 2027 2727 0a20 2020 2052  r:.    '''.    R
-00008d70: 6574 7572 6e20 6120 7374 7269 6e67 2072  eturn a string r
-00008d80: 6570 7265 7365 6e74 696e 6720 7468 6520  epresenting the 
-00008d90: 7061 7468 2074 6f20 7768 6963 6820 7468  path to which th
-00008da0: 6520 7379 6d62 6f6c 6963 206c 696e 6b20  e symbolic link 
-00008db0: 706f 696e 7473 2e0a 0a20 2020 203a 7265  points...    :re
-00008dc0: 7475 726e 733a 2052 6574 7572 6e20 6120  turns: Return a 
-00008dd0: 7374 7269 6e67 2072 6570 7265 7365 6e74  string represent
-00008de0: 696e 6720 7468 6520 7061 7468 2074 6f20  ing the path to 
-00008df0: 7768 6963 6820 7468 6520 7379 6d62 6f6c  which the symbol
-00008e00: 6963 206c 696e 6b20 706f 696e 7473 2e0a  ic link points..
-00008e10: 2020 2020 3a72 6169 7365 733a 2053 334e      :raises: S3N
-00008e20: 616d 6554 6f6f 4c6f 6e67 4572 726f 722c  ameTooLongError,
-00008e30: 2053 3342 7563 6b65 744e 6f74 466f 756e   S3BucketNotFoun
-00008e40: 6445 7272 6f72 2c20 5333 4973 4144 6972  dError, S3IsADir
-00008e50: 6563 746f 7279 4572 726f 722c 2053 334e  ectoryError, S3N
-00008e60: 6f74 414c 696e 6b45 7272 6f72 0a20 2020  otALinkError.   
-00008e70: 2027 2727 0a20 2020 2062 7563 6b65 742c   '''.    bucket,
-00008e80: 206b 6579 203d 2070 6172 7365 5f73 335f   key = parse_s3_
-00008e90: 7572 6c28 7061 7468 290a 2020 2020 6966  url(path).    if
-00008ea0: 206e 6f74 2062 7563 6b65 743a 0a20 2020   not bucket:.   
-00008eb0: 2020 2020 2072 6169 7365 2053 3342 7563       raise S3Buc
-00008ec0: 6b65 744e 6f74 466f 756e 6445 7272 6f72  ketNotFoundError
-00008ed0: 2827 456d 7074 7920 6275 636b 6574 206e  ('Empty bucket n
-00008ee0: 616d 653a 2025 7227 2025 2070 6174 6829  ame: %r' % path)
-00008ef0: 0a20 2020 2069 6620 6e6f 7420 6b65 7920  .    if not key 
-00008f00: 6f72 206b 6579 2e65 6e64 7377 6974 6828  or key.endswith(
-00008f10: 272f 2729 3a0a 2020 2020 2020 2020 7261  '/'):.        ra
-00008f20: 6973 6520 5333 4973 4144 6972 6563 746f  ise S3IsADirecto
-00008f30: 7279 4572 726f 7228 2749 7320 6120 6469  ryError('Is a di
-00008f40: 7265 6374 6f72 793a 2025 7227 2025 2070  rectory: %r' % p
-00008f50: 6174 6829 0a20 2020 206d 6574 6164 6174  ath).    metadat
-00008f60: 6120 3d20 5f73 335f 6765 745f 6d65 7461  a = _s3_get_meta
-00008f70: 6461 7461 2870 6174 6829 0a0a 2020 2020  data(path)..    
-00008f80: 6966 206e 6f74 2027 7379 6d6c 696e 6b5f  if not 'symlink_
-00008f90: 746f 2720 696e 206d 6574 6164 6174 613a  to' in metadata:
-00008fa0: 0a20 2020 2020 2020 2072 6169 7365 2053  .        raise S
-00008fb0: 334e 6f74 414c 696e 6b45 7272 6f72 2827  3NotALinkError('
-00008fc0: 4e6f 7420 6120 6c69 6e6b 3a20 2572 2720  Not a link: %r' 
-00008fd0: 2520 7061 7468 290a 2020 2020 656c 7365  % path).    else
-00008fe0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00008ff0: 206d 6574 6164 6174 615b 2773 796d 6c69   metadata['symli
-00009000: 6e6b 5f74 6f27 5d0a 0a0a 6465 6620 7333  nk_to']...def s3
-00009010: 5f72 656e 616d 6528 7372 635f 7572 6c3a  _rename(src_url:
-00009020: 2050 6174 684c 696b 652c 2064 7374 5f75   PathLike, dst_u
-00009030: 726c 3a20 5061 7468 4c69 6b65 293a 0a20  rl: PathLike):. 
-00009040: 2020 2027 2727 0a20 2020 204d 6f76 6520     '''.    Move 
-00009050: 7333 2066 696c 6520 7061 7468 2066 726f  s3 file path fro
-00009060: 6d20 7372 635f 7572 6c20 746f 2064 7374  m src_url to dst
-00009070: 5f75 726c 0a0a 2020 2020 3a70 6172 616d  _url..    :param
-00009080: 2064 7374 5f75 726c 3a20 4769 7665 6e20   dst_url: Given 
-00009090: 6465 7374 696e 6174 696f 6e20 7061 7468  destination path
-000090a0: 0a20 2020 2027 2727 0a20 2020 2073 7263  .    '''.    src
-000090b0: 5f70 6174 685f 696e 7320 3d20 5333 5061  _path_ins = S3Pa
-000090c0: 7468 2873 7263 5f75 726c 290a 2020 2020  th(src_url).    
-000090d0: 6966 2073 7263 5f70 6174 685f 696e 732e  if src_path_ins.
-000090e0: 6973 5f66 696c 6528 293a 0a20 2020 2020  is_file():.     
-000090f0: 2020 2073 7263 5f70 6174 685f 696e 732e     src_path_ins.
-00009100: 636f 7079 2864 7374 5f75 726c 290a 2020  copy(dst_url).  
-00009110: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00009120: 7372 635f 7061 7468 5f69 6e73 2e73 796e  src_path_ins.syn
-00009130: 6328 6473 745f 7572 6c29 0a20 2020 2073  c(dst_url).    s
-00009140: 7263 5f70 6174 685f 696e 732e 7265 6d6f  rc_path_ins.remo
-00009150: 7665 2829 0a0a 0a63 6c61 7373 2053 3343  ve()...class S3C
-00009160: 6163 6865 7228 4669 6c65 4361 6368 6572  acher(FileCacher
-00009170: 293a 0a20 2020 2063 6163 6865 5f70 6174  ):.    cache_pat
-00009180: 6820 3d20 4e6f 6e65 0a0a 2020 2020 6465  h = None..    de
-00009190: 6620 5f5f 696e 6974 5f5f 280a 2020 2020  f __init__(.    
-000091a0: 2020 2020 2020 2020 7365 6c66 2c20 7061          self, pa
-000091b0: 7468 3a20 7374 722c 2063 6163 6865 5f70  th: str, cache_p
-000091c0: 6174 683a 204f 7074 696f 6e61 6c5b 7374  ath: Optional[st
-000091d0: 725d 203d 204e 6f6e 652c 206d 6f64 653a  r] = None, mode:
-000091e0: 2073 7472 203d 2027 7227 293a 0a20 2020   str = 'r'):.   
-000091f0: 2020 2020 2069 6620 6d6f 6465 206e 6f74       if mode not
-00009200: 2069 6e20 2827 7227 2c20 2777 272c 2027   in ('r', 'w', '
-00009210: 6127 293a 0a20 2020 2020 2020 2020 2020  a'):.           
-00009220: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00009230: 7228 2775 6e61 6363 6570 7461 626c 6520  r('unacceptable 
-00009240: 6d6f 6465 3a20 2572 2720 2520 6d6f 6465  mode: %r' % mode
-00009250: 290a 2020 2020 2020 2020 6966 206d 6f64  ).        if mod
-00009260: 6520 696e 2028 2772 272c 2027 6127 293a  e in ('r', 'a'):
-00009270: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00009280: 6361 6368 655f 7061 7468 2069 7320 4e6f  cache_path is No
-00009290: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-000092a0: 2020 2020 6361 6368 655f 7061 7468 203d      cache_path =
-000092b0: 2067 656e 6572 6174 655f 6361 6368 655f   generate_cache_
-000092c0: 7061 7468 2870 6174 6829 0a20 2020 2020  path(path).     
-000092d0: 2020 2020 2020 2073 335f 646f 776e 6c6f         s3_downlo
-000092e0: 6164 2870 6174 682c 2063 6163 6865 5f70  ad(path, cache_p
-000092f0: 6174 6829 0a20 2020 2020 2020 2073 656c  ath).        sel
-00009300: 662e 6e61 6d65 203d 2070 6174 680a 2020  f.name = path.  
-00009310: 2020 2020 2020 7365 6c66 2e6d 6f64 6520        self.mode 
-00009320: 3d20 6d6f 6465 0a20 2020 2020 2020 2073  = mode.        s
-00009330: 656c 662e 6361 6368 655f 7061 7468 203d  elf.cache_path =
-00009340: 2063 6163 6865 5f70 6174 680a 0a20 2020   cache_path..   
-00009350: 2064 6566 205f 636c 6f73 6528 7365 6c66   def _close(self
-00009360: 293a 0a20 2020 2020 2020 2069 6620 7365  ):.        if se
-00009370: 6c66 2e63 6163 6865 5f70 6174 6820 6973  lf.cache_path is
-00009380: 206e 6f74 204e 6f6e 6520 616e 6420 5c0a   not None and \.
-00009390: 2020 2020 2020 2020 2020 2020 6f73 2e70              os.p
-000093a0: 6174 682e 6578 6973 7473 2873 656c 662e  ath.exists(self.
-000093b0: 6361 6368 655f 7061 7468 293a 0a20 2020  cache_path):.   
-000093c0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-000093d0: 2e6d 6f64 6520 696e 2028 2777 272c 2027  .mode in ('w', '
-000093e0: 6127 293a 0a20 2020 2020 2020 2020 2020  a'):.           
-000093f0: 2020 2020 2073 335f 7570 6c6f 6164 2873       s3_upload(s
-00009400: 656c 662e 6361 6368 655f 7061 7468 2c20  elf.cache_path, 
-00009410: 7365 6c66 2e6e 616d 6529 0a20 2020 2020  self.name).     
-00009420: 2020 2020 2020 206f 732e 756e 6c69 6e6b         os.unlink
-00009430: 2873 656c 662e 6361 6368 655f 7061 7468  (self.cache_path
-00009440: 290a 0a0a 6465 6620 7333 5f67 6c6f 6228  )...def s3_glob(
-00009450: 0a20 2020 2020 2020 2070 6174 683a 2050  .        path: P
-00009460: 6174 684c 696b 652c 0a20 2020 2020 2020  athLike,.       
-00009470: 2072 6563 7572 7369 7665 3a20 626f 6f6c   recursive: bool
-00009480: 203d 2054 7275 652c 0a20 2020 2020 2020   = True,.       
-00009490: 206d 6973 7369 6e67 5f6f 6b3a 2062 6f6f   missing_ok: boo
-000094a0: 6c20 3d20 5472 7565 2c0a 2020 2020 2020  l = True,.      
-000094b0: 2020 666f 6c6c 6f77 6c69 6e6b 733a 2062    followlinks: b
-000094c0: 6f6f 6c20 3d20 4661 6c73 652c 0a29 202d  ool = False,.) -
-000094d0: 3e20 4c69 7374 5b73 7472 5d3a 0a20 2020  > List[str]:.   
-000094e0: 2027 2727 5265 7475 726e 2073 3320 7061   '''Return s3 pa
-000094f0: 7468 206c 6973 7420 696e 2061 7363 656e  th list in ascen
-00009500: 6469 6e67 2061 6c70 6861 6265 7469 6361  ding alphabetica
-00009510: 6c20 6f72 6465 722c 2069 6e20 7768 6963  l order, in whic
-00009520: 6820 7061 7468 206d 6174 6368 6573 2067  h path matches g
-00009530: 6c6f 6220 7061 7474 6572 6e0a 2020 2020  lob pattern.    
-00009540: 4e6f 7465 733a 204f 6e6c 7920 676c 6f62  Notes: Only glob
-00009550: 2069 6e20 6275 636b 6574 2e20 4966 2074   in bucket. If t
-00009560: 7279 696e 6720 746f 206d 6174 6368 2062  rying to match b
-00009570: 7563 6b65 7420 7769 7468 2077 696c 6463  ucket with wildc
-00009580: 6172 6420 6368 6172 6163 7465 7273 2c20  ard characters, 
-00009590: 7261 6973 6520 556e 7375 7070 6f72 7465  raise Unsupporte
-000095a0: 6445 7272 6f72 0a0a 2020 2020 3a70 6172  dError..    :par
-000095b0: 616d 2072 6563 7572 7369 7665 3a20 4966  am recursive: If
-000095c0: 2046 616c 7365 2c20 602a 2a60 2077 696c   False, `**` wil
-000095d0: 6c20 6e6f 7420 7365 6172 6368 2064 6972  l not search dir
-000095e0: 6563 746f 7279 2072 6563 7572 7369 7665  ectory recursive
-000095f0: 6c79 0a20 2020 203a 7061 7261 6d20 6d69  ly.    :param mi
-00009600: 7373 696e 675f 6f6b 3a20 4966 2046 616c  ssing_ok: If Fal
-00009610: 7365 2061 6e64 2074 6172 6765 7420 7061  se and target pa
-00009620: 7468 2064 6f65 736e 2774 206d 6174 6368  th doesn't match
-00009630: 2061 6e79 2066 696c 652c 2072 6169 7365   any file, raise
-00009640: 2046 696c 654e 6f74 466f 756e 6445 7272   FileNotFoundErr
-00009650: 6f72 0a20 2020 203a 7261 6973 6573 3a20  or.    :raises: 
-00009660: 556e 7375 7070 6f72 7465 6445 7272 6f72  UnsupportedError
-00009670: 2c20 7768 656e 2062 7563 6b65 7420 7061  , when bucket pa
-00009680: 7274 2063 6f6e 7461 696e 7320 7769 6c64  rt contains wild
-00009690: 6361 7264 2063 6861 7261 6374 6572 730a  card characters.
-000096a0: 2020 2020 3a72 6574 7572 6e73 3a20 4120      :returns: A 
-000096b0: 6c69 7374 2063 6f6e 7461 696e 7320 7061  list contains pa
-000096c0: 7468 7320 6d61 7463 6820 6073 335f 7061  ths match `s3_pa
-000096d0: 7468 6e61 6d65 600a 2020 2020 2727 270a  thname`.    '''.
-000096e0: 2020 2020 7265 7475 726e 206c 6973 7428      return list(
-000096f0: 0a20 2020 2020 2020 2073 335f 6967 6c6f  .        s3_iglo
-00009700: 6228 0a20 2020 2020 2020 2020 2020 2070  b(.            p
-00009710: 6174 683d 7061 7468 2c0a 2020 2020 2020  ath=path,.      
-00009720: 2020 2020 2020 7265 6375 7273 6976 653d        recursive=
-00009730: 7265 6375 7273 6976 652c 0a20 2020 2020  recursive,.     
-00009740: 2020 2020 2020 206d 6973 7369 6e67 5f6f         missing_o
-00009750: 6b3d 6d69 7373 696e 675f 6f6b 2c0a 2020  k=missing_ok,.  
-00009760: 2020 2020 2020 2020 2020 666f 6c6c 6f77            follow
-00009770: 6c69 6e6b 733d 666f 6c6c 6f77 6c69 6e6b  links=followlink
-00009780: 7329 290a 0a0a 6465 6620 7333 5f67 6c6f  s))...def s3_glo
-00009790: 625f 7374 6174 280a 2020 2020 2020 2020  b_stat(.        
-000097a0: 7061 7468 3a20 5061 7468 4c69 6b65 2c0a  path: PathLike,.
-000097b0: 2020 2020 2020 2020 7265 6375 7273 6976          recursiv
-000097c0: 653a 2062 6f6f 6c20 3d20 5472 7565 2c0a  e: bool = True,.
-000097d0: 2020 2020 2020 2020 6d69 7373 696e 675f          missing_
-000097e0: 6f6b 3a20 626f 6f6c 203d 2054 7275 652c  ok: bool = True,
-000097f0: 0a20 2020 2020 2020 2066 6f6c 6c6f 776c  .        followl
-00009800: 696e 6b73 3a20 626f 6f6c 203d 2046 616c  inks: bool = Fal
-00009810: 7365 2920 2d3e 2049 7465 7261 746f 725b  se) -> Iterator[
-00009820: 4669 6c65 456e 7472 795d 3a0a 2020 2020  FileEntry]:.    
-00009830: 2727 2752 6574 7572 6e20 6120 6765 6e65  '''Return a gene
-00009840: 7261 746f 7220 636f 6e74 6169 6e73 2074  rator contains t
-00009850: 7570 6c65 7320 6f66 2070 6174 6820 616e  uples of path an
-00009860: 6420 6669 6c65 2073 7461 742c 2069 6e20  d file stat, in 
-00009870: 6173 6365 6e64 696e 6720 616c 7068 6162  ascending alphab
-00009880: 6574 6963 616c 206f 7264 6572 2c20 696e  etical order, in
-00009890: 2077 6869 6368 2070 6174 6820 6d61 7463   which path matc
-000098a0: 6865 7320 676c 6f62 2070 6174 7465 726e  hes glob pattern
-000098b0: 0a20 2020 204e 6f74 6573 3a20 4f6e 6c79  .    Notes: Only
-000098c0: 2067 6c6f 6220 696e 2062 7563 6b65 742e   glob in bucket.
-000098d0: 2049 6620 7472 7969 6e67 2074 6f20 6d61   If trying to ma
-000098e0: 7463 6820 6275 636b 6574 2077 6974 6820  tch bucket with 
-000098f0: 7769 6c64 6361 7264 2063 6861 7261 6374  wildcard charact
-00009900: 6572 732c 2072 6169 7365 2055 6e73 7570  ers, raise Unsup
-00009910: 706f 7274 6564 4572 726f 720a 0a20 2020  portedError..   
-00009920: 203a 7061 7261 6d20 7265 6375 7273 6976   :param recursiv
-00009930: 653a 2049 6620 4661 6c73 652c 2060 2a2a  e: If False, `**
-00009940: 6020 7769 6c6c 206e 6f74 2073 6561 7263  ` will not searc
-00009950: 6820 6469 7265 6374 6f72 7920 7265 6375  h directory recu
-00009960: 7273 6976 656c 790a 2020 2020 3a70 6172  rsively.    :par
-00009970: 616d 206d 6973 7369 6e67 5f6f 6b3a 2049  am missing_ok: I
-00009980: 6620 4661 6c73 6520 616e 6420 7461 7267  f False and targ
-00009990: 6574 2070 6174 6820 646f 6573 6e27 7420  et path doesn't 
-000099a0: 6d61 7463 6820 616e 7920 6669 6c65 2c20  match any file, 
-000099b0: 7261 6973 6520 4669 6c65 4e6f 7446 6f75  raise FileNotFou
-000099c0: 6e64 4572 726f 720a 2020 2020 3a72 6169  ndError.    :rai
-000099d0: 7365 733a 2055 6e73 7570 706f 7274 6564  ses: Unsupported
-000099e0: 4572 726f 722c 2077 6865 6e20 6275 636b  Error, when buck
-000099f0: 6574 2070 6172 7420 636f 6e74 6169 6e73  et part contains
-00009a00: 2077 696c 6463 6172 6420 6368 6172 6163   wildcard charac
-00009a10: 7465 7273 0a20 2020 203a 7265 7475 726e  ters.    :return
-00009a20: 733a 2041 2067 656e 6572 6174 6f72 2063  s: A generator c
-00009a30: 6f6e 7461 696e 7320 7475 706c 6573 206f  ontains tuples o
-00009a40: 6620 7061 7468 2061 6e64 2066 696c 6520  f path and file 
-00009a50: 7374 6174 2c20 696e 2077 6869 6368 2070  stat, in which p
-00009a60: 6174 6873 206d 6174 6368 2060 7333 5f70  aths match `s3_p
-00009a70: 6174 686e 616d 6560 0a20 2020 2027 2727  athname`.    '''
-00009a80: 0a20 2020 2073 335f 7061 7468 6e61 6d65  .    s3_pathname
-00009a90: 203d 2066 7370 6174 6828 7061 7468 290a   = fspath(path).
-00009aa0: 0a20 2020 2064 6566 2063 7265 6174 655f  .    def create_
-00009ab0: 6765 6e65 7261 746f 7228 293a 0a20 2020  generator():.   
-00009ac0: 2020 2020 2066 6f72 2067 726f 7570 5f73       for group_s
-00009ad0: 335f 7061 7468 6e61 6d65 5f31 2069 6e20  3_pathname_1 in 
-00009ae0: 5f67 726f 7570 5f73 3370 6174 685f 6279  _group_s3path_by
-00009af0: 5f62 7563 6b65 7428 7333 5f70 6174 686e  _bucket(s3_pathn
-00009b00: 616d 6529 3a0a 2020 2020 2020 2020 2020  ame):.          
-00009b10: 2020 666f 7220 6772 6f75 705f 7333 5f70    for group_s3_p
-00009b20: 6174 686e 616d 655f 3220 696e 205f 6772  athname_2 in _gr
-00009b30: 6f75 705f 7333 7061 7468 5f62 795f 7072  oup_s3path_by_pr
-00009b40: 6566 6978 280a 2020 2020 2020 2020 2020  efix(.          
-00009b50: 2020 2020 2020 2020 2020 6772 6f75 705f            group_
-00009b60: 7333 5f70 6174 686e 616d 655f 3129 3a0a  s3_pathname_1):.
-00009b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009b80: 7969 656c 6420 6672 6f6d 205f 7333 5f67  yield from _s3_g
-00009b90: 6c6f 625f 7374 6174 5f73 696e 676c 655f  lob_stat_single_
-00009ba0: 7061 7468 280a 2020 2020 2020 2020 2020  path(.          
-00009bb0: 2020 2020 2020 2020 2020 6772 6f75 705f            group_
-00009bc0: 7333 5f70 6174 686e 616d 655f 322c 0a20  s3_pathname_2,. 
-00009bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009be0: 2020 2072 6563 7572 7369 7665 2c0a 2020     recursive,.  
-00009bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c00: 2020 6d69 7373 696e 675f 6f6b 2c0a 2020    missing_ok,.  
-00009c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c20: 2020 666f 6c6c 6f77 6c69 6e6b 733d 666f    followlinks=fo
-00009c30: 6c6c 6f77 6c69 6e6b 7329 0a0a 2020 2020  llowlinks)..    
-00009c40: 7265 7475 726e 205f 6372 6561 7465 5f6d  return _create_m
-00009c50: 6973 7369 6e67 5f6f 6b5f 6765 6e65 7261  issing_ok_genera
-00009c60: 746f 7228 0a20 2020 2020 2020 2063 7265  tor(.        cre
-00009c70: 6174 655f 6765 6e65 7261 746f 7228 292c  ate_generator(),
-00009c80: 206d 6973 7369 6e67 5f6f 6b2c 0a20 2020   missing_ok,.   
-00009c90: 2020 2020 2053 3346 696c 654e 6f74 466f       S3FileNotFo
-00009ca0: 756e 6445 7272 6f72 2827 4e6f 206d 6174  undError('No mat
-00009cb0: 6368 2066 696c 653a 2025 7227 2025 2073  ch file: %r' % s
-00009cc0: 335f 7061 7468 6e61 6d65 2929 0a0a 0a64  3_pathname))...d
-00009cd0: 6566 2073 335f 6967 6c6f 6228 0a20 2020  ef s3_iglob(.   
-00009ce0: 2020 2020 2070 6174 683a 2050 6174 684c       path: PathL
-00009cf0: 696b 652c 0a20 2020 2020 2020 2072 6563  ike,.        rec
-00009d00: 7572 7369 7665 3a20 626f 6f6c 203d 2054  ursive: bool = T
-00009d10: 7275 652c 0a20 2020 2020 2020 206d 6973  rue,.        mis
-00009d20: 7369 6e67 5f6f 6b3a 2062 6f6f 6c20 3d20  sing_ok: bool = 
-00009d30: 5472 7565 2c0a 2020 2020 2020 2020 666f  True,.        fo
-00009d40: 6c6c 6f77 6c69 6e6b 733a 2062 6f6f 6c20  llowlinks: bool 
-00009d50: 3d20 4661 6c73 652c 0a29 202d 3e20 4974  = False,.) -> It
-00009d60: 6572 6174 6f72 5b73 7472 5d3a 0a20 2020  erator[str]:.   
-00009d70: 2027 2727 5265 7475 726e 2073 3320 7061   '''Return s3 pa
-00009d80: 7468 2069 7465 7261 746f 7220 696e 2061  th iterator in a
-00009d90: 7363 656e 6469 6e67 2061 6c70 6861 6265  scending alphabe
-00009da0: 7469 6361 6c20 6f72 6465 722c 2069 6e20  tical order, in 
-00009db0: 7768 6963 6820 7061 7468 206d 6174 6368  which path match
-00009dc0: 6573 2067 6c6f 6220 7061 7474 6572 6e0a  es glob pattern.
-00009dd0: 2020 2020 4e6f 7465 733a 204f 6e6c 7920      Notes: Only 
-00009de0: 676c 6f62 2069 6e20 6275 636b 6574 2e20  glob in bucket. 
-00009df0: 4966 2074 7279 696e 6720 746f 206d 6174  If trying to mat
-00009e00: 6368 2062 7563 6b65 7420 7769 7468 2077  ch bucket with w
-00009e10: 696c 6463 6172 6420 6368 6172 6163 7465  ildcard characte
-00009e20: 7273 2c20 7261 6973 6520 556e 7375 7070  rs, raise Unsupp
-00009e30: 6f72 7465 6445 7272 6f72 0a0a 2020 2020  ortedError..    
-00009e40: 3a70 6172 616d 2072 6563 7572 7369 7665  :param recursive
-00009e50: 3a20 4966 2046 616c 7365 2c20 602a 2a60  : If False, `**`
-00009e60: 2077 696c 6c20 6e6f 7420 7365 6172 6368   will not search
-00009e70: 2064 6972 6563 746f 7279 2072 6563 7572   directory recur
-00009e80: 7369 7665 6c79 0a20 2020 203a 7061 7261  sively.    :para
-00009e90: 6d20 6d69 7373 696e 675f 6f6b 3a20 4966  m missing_ok: If
-00009ea0: 2046 616c 7365 2061 6e64 2074 6172 6765   False and targe
-00009eb0: 7420 7061 7468 2064 6f65 736e 2774 206d  t path doesn't m
-00009ec0: 6174 6368 2061 6e79 2066 696c 652c 2072  atch any file, r
-00009ed0: 6169 7365 2046 696c 654e 6f74 466f 756e  aise FileNotFoun
-00009ee0: 6445 7272 6f72 0a20 2020 203a 7261 6973  dError.    :rais
-00009ef0: 6573 3a20 556e 7375 7070 6f72 7465 6445  es: UnsupportedE
-00009f00: 7272 6f72 2c20 7768 656e 2062 7563 6b65  rror, when bucke
-00009f10: 7420 7061 7274 2063 6f6e 7461 696e 7320  t part contains 
-00009f20: 7769 6c64 6361 7264 2063 6861 7261 6374  wildcard charact
-00009f30: 6572 730a 2020 2020 3a72 6574 7572 6e73  ers.    :returns
-00009f40: 3a20 416e 2069 7465 7261 746f 7220 636f  : An iterator co
-00009f50: 6e74 6169 6e73 2070 6174 6873 206d 6174  ntains paths mat
-00009f60: 6368 2060 7333 5f70 6174 686e 616d 6560  ch `s3_pathname`
-00009f70: 0a20 2020 2027 2727 0a20 2020 2066 6f72  .    '''.    for
-00009f80: 2066 696c 655f 656e 7472 7920 696e 2073   file_entry in s
-00009f90: 335f 676c 6f62 5f73 7461 7428 7061 7468  3_glob_stat(path
-00009fa0: 3d70 6174 682c 2072 6563 7572 7369 7665  =path, recursive
-00009fb0: 3d72 6563 7572 7369 7665 2c0a 2020 2020  =recursive,.    
-00009fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009fd0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00009fe0: 6973 7369 6e67 5f6f 6b3d 6d69 7373 696e  issing_ok=missin
-00009ff0: 675f 6f6b 2c0a 2020 2020 2020 2020 2020  g_ok,.          
-0000a000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a010: 2020 2020 2020 2020 2066 6f6c 6c6f 776c           followl
-0000a020: 696e 6b73 3d66 6f6c 6c6f 776c 696e 6b73  inks=followlinks
-0000a030: 293a 0a20 2020 2020 2020 2079 6965 6c64  ):.        yield
-0000a040: 2066 696c 655f 656e 7472 792e 7061 7468   file_entry.path
-0000a050: 0a0a 0a64 6566 2073 335f 6d61 6b65 6469  ...def s3_makedi
-0000a060: 7273 2870 6174 683a 2050 6174 684c 696b  rs(path: PathLik
-0000a070: 652c 2065 7869 7374 5f6f 6b3a 2062 6f6f  e, exist_ok: boo
-0000a080: 6c20 3d20 4661 6c73 6529 3a0a 2020 2020  l = False):.    
-0000a090: 2727 270a 2020 2020 4372 6561 7465 2061  '''.    Create a
-0000a0a0: 6e20 7333 2064 6972 6563 746f 7279 2e0a  n s3 directory..
-0000a0b0: 2020 2020 5075 7265 6c79 2063 7265 6174      Purely creat
-0000a0c0: 696e 6720 6469 7265 6374 6f72 7920 6973  ing directory is
-0000a0d0: 2069 6e76 616c 6964 2062 6563 6175 7365   invalid because
-0000a0e0: 2069 7427 7320 756e 6176 6169 6c61 626c   it's unavailabl
-0000a0f0: 6520 6f6e 204f 5353 2e0a 2020 2020 5468  e on OSS..    Th
-0000a100: 6973 2066 756e 6374 696f 6e20 6973 2074  is function is t
-0000a110: 6f20 7465 7374 2074 6865 2074 6172 6765  o test the targe
-0000a120: 7420 6275 636b 6574 2068 6176 6520 5752  t bucket have WR
-0000a130: 4954 4520 6163 6365 7373 2e0a 0a20 2020  ITE access...   
-0000a140: 203a 7061 7261 6d20 7061 7468 3a20 4769   :param path: Gi
-0000a150: 7665 6e20 7061 7468 0a20 2020 203a 7061  ven path.    :pa
-0000a160: 7261 6d20 6578 6973 745f 6f6b 3a20 4966  ram exist_ok: If
-0000a170: 2046 616c 7365 2061 6e64 2074 6172 6765   False and targe
-0000a180: 7420 6469 7265 6374 6f72 7920 6578 6973  t directory exis
-0000a190: 7473 2c20 7261 6973 6520 5333 4669 6c65  ts, raise S3File
-0000a1a0: 4578 6973 7473 4572 726f 720a 2020 2020  ExistsError.    
-0000a1b0: 3a72 6169 7365 733a 2053 3342 7563 6b65  :raises: S3Bucke
-0000a1c0: 744e 6f74 466f 756e 6445 7272 6f72 2c20  tNotFoundError, 
-0000a1d0: 5333 4669 6c65 4578 6973 7473 4572 726f  S3FileExistsErro
-0000a1e0: 720a 2020 2020 2727 270a 2020 2020 7265  r.    '''.    re
-0000a1f0: 7475 726e 2053 3350 6174 6828 7061 7468  turn S3Path(path
-0000a200: 292e 6d6b 6469 7228 7061 7265 6e74 733d  ).mkdir(parents=
-0000a210: 5472 7565 2c20 6578 6973 745f 6f6b 3d65  True, exist_ok=e
-0000a220: 7869 7374 5f6f 6b29 0a0a 0a40 536d 6172  xist_ok)...@Smar
-0000a230: 7450 6174 682e 7265 6769 7374 6572 0a63  tPath.register.c
-0000a240: 6c61 7373 2053 3350 6174 6828 5552 4950  lass S3Path(URIP
-0000a250: 6174 6829 3a0a 0a20 2020 2070 726f 746f  ath):..    proto
-0000a260: 636f 6c20 3d20 2273 3322 0a0a 2020 2020  col = "s3"..    
-0000a270: 6465 6620 6163 6365 7373 280a 2020 2020  def access(.    
-0000a280: 2020 2020 2020 2020 7365 6c66 2c20 6d6f          self, mo
-0000a290: 6465 3a20 4163 6365 7373 203d 2041 6363  de: Access = Acc
-0000a2a0: 6573 732e 5245 4144 2c0a 2020 2020 2020  ess.READ,.      
-0000a2b0: 2020 2020 2020 666f 6c6c 6f77 6c69 6e6b        followlink
-0000a2c0: 733a 2062 6f6f 6c20 3d20 4661 6c73 6529  s: bool = False)
-0000a2d0: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
-0000a2e0: 2020 2727 270a 2020 2020 2020 2020 5465    '''.        Te
-0000a2f0: 7374 2069 6620 7061 7468 2068 6173 2061  st if path has a
-0000a300: 6363 6573 7320 7065 726d 6973 7369 6f6e  ccess permission
-0000a310: 2064 6573 6372 6962 6564 2062 7920 6d6f   described by mo
-0000a320: 6465 0a20 2020 2020 2020 2055 7369 6e67  de.        Using
-0000a330: 2068 6561 645f 6275 636b 6574 2829 2c20   head_bucket(), 
-0000a340: 6e6f 7720 5245 4144 2f57 5249 5445 2061  now READ/WRITE a
-0000a350: 7265 2073 616d 652e 0a0a 2020 2020 2020  re same...      
-0000a360: 2020 3a70 6172 616d 206d 6f64 653a 2061    :param mode: a
-0000a370: 6363 6573 7320 6d6f 6465 0a20 2020 2020  ccess mode.     
-0000a380: 2020 203a 7265 7475 726e 733a 2062 6f6f     :returns: boo
-0000a390: 6c2c 2069 6620 7468 6520 6275 636b 6574  l, if the bucket
-0000a3a0: 206f 6620 7333 5f75 726c 2068 6173 2072   of s3_url has r
-0000a3b0: 6561 642f 7772 6974 6520 6163 6365 7373  ead/write access
-0000a3c0: 2e0a 2020 2020 2020 2020 2727 270a 2020  ..        '''.  
-0000a3d0: 2020 2020 2020 7333 5f75 726c 203d 2073        s3_url = s
-0000a3e0: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
-0000a3f0: 6f74 6f63 6f6c 0a20 2020 2020 2020 2069  otocol.        i
-0000a400: 6620 666f 6c6c 6f77 6c69 6e6b 733a 0a20  f followlinks:. 
-0000a410: 2020 2020 2020 2020 2020 206d 6574 6164             metad
-0000a420: 6174 6120 3d20 5f73 335f 6765 745f 6d65  ata = _s3_get_me
-0000a430: 7461 6461 7461 2873 335f 7572 6c29 0a20  tadata(s3_url). 
-0000a440: 2020 2020 2020 2020 2020 2069 6620 6d65             if me
-0000a450: 7461 6461 7461 2061 6e64 2027 7379 6d6c  tadata and 'syml
-0000a460: 696e 6b5f 746f 2720 696e 206d 6574 6164  ink_to' in metad
-0000a470: 6174 613a 0a20 2020 2020 2020 2020 2020  ata:.           
-0000a480: 2020 2020 2073 335f 7572 6c20 3d20 6d65       s3_url = me
-0000a490: 7461 6461 7461 5b27 7379 6d6c 696e 6b5f  tadata['symlink_
-0000a4a0: 746f 275d 0a20 2020 2020 2020 2062 7563  to'].        buc
-0000a4b0: 6b65 742c 205f 203d 2070 6172 7365 5f73  ket, _ = parse_s
-0000a4c0: 335f 7572 6c28 7333 5f75 726c 2920 2023  3_url(s3_url)  #
-0000a4d0: 206f 6e6c 7920 6368 6563 6b20 6275 636b   only check buck
-0000a4e0: 6574 2061 6363 6573 7369 6269 6c69 7479  et accessibility
-0000a4f0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0000a500: 6275 636b 6574 3a0a 2020 2020 2020 2020  bucket:.        
-0000a510: 2020 2020 7261 6973 6520 4578 6365 7074      raise Except
-0000a520: 696f 6e28 224e 6f20 6176 6169 6c61 626c  ion("No availabl
-0000a530: 6520 6275 636b 6574 2229 0a20 2020 2020  e bucket").     
-0000a540: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
-0000a550: 616e 6365 286d 6f64 652c 2041 6363 6573  ance(mode, Acces
-0000a560: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-0000a570: 7261 6973 6520 5479 7065 4572 726f 7228  raise TypeError(
-0000a580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a590: 2027 556e 7375 7070 6f72 7465 6420 6d6f   'Unsupported mo
-0000a5a0: 6465 3a20 7b7d 202d 2d20 4d6f 6465 2073  de: {} -- Mode s
-0000a5b0: 686f 756c 6420 7573 6520 6f6e 6520 6f66  hould use one of
-0000a5c0: 2074 6865 2065 6e75 6d73 2062 656c 6f6e   the enums belon
-0000a5d0: 6769 6e67 2074 6f3a 2020 7b7d 270a 2020  ging to:  {}'.  
-0000a5e0: 2020 2020 2020 2020 2020 2020 2020 2e66                .f
-0000a5f0: 6f72 6d61 7428 6d6f 6465 2c20 272c 2027  ormat(mode, ', '
-0000a600: 2e6a 6f69 6e28 5b73 7472 2861 2920 666f  .join([str(a) fo
-0000a610: 7220 6120 696e 2041 6363 6573 735d 2929  r a in Access]))
-0000a620: 290a 2020 2020 2020 2020 6966 206d 6f64  ).        if mod
-0000a630: 6520 6e6f 7420 696e 2028 4163 6365 7373  e not in (Access
-0000a640: 2e52 4541 442c 2041 6363 6573 732e 5752  .READ, Access.WR
-0000a650: 4954 4529 3a0a 2020 2020 2020 2020 2020  ITE):.          
-0000a660: 2020 7261 6973 6520 5479 7065 4572 726f    raise TypeErro
-0000a670: 7228 2755 6e73 7570 706f 7274 6564 206d  r('Unsupported m
-0000a680: 6f64 653a 207b 7d27 2e66 6f72 6d61 7428  ode: {}'.format(
-0000a690: 6d6f 6465 2929 0a20 2020 2020 2020 2063  mode)).        c
-0000a6a0: 6c69 656e 7420 3d20 6765 745f 7333 5f63  lient = get_s3_c
-0000a6b0: 6c69 656e 7428 290a 2020 2020 2020 2020  lient().        
-0000a6c0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0000a6d0: 2063 6c69 656e 742e 6865 6164 5f62 7563   client.head_buc
-0000a6e0: 6b65 7428 4275 636b 6574 3d62 7563 6b65  ket(Bucket=bucke
-0000a6f0: 7429 0a20 2020 2020 2020 2065 7863 6570  t).        excep
-0000a700: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
-0000a710: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
-0000a720: 2020 6572 726f 7220 3d20 7472 616e 736c    error = transl
-0000a730: 6174 655f 7333 5f65 7272 6f72 2865 7272  ate_s3_error(err
-0000a740: 6f72 2c20 7333 5f75 726c 290a 2020 2020  or, s3_url).    
-0000a750: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0000a760: 7461 6e63 6528 6572 726f 722c 2028 5333  tance(error, (S3
-0000a770: 5065 726d 6973 7369 6f6e 4572 726f 722c  PermissionError,
-0000a780: 2053 3346 696c 654e 6f74 466f 756e 6445   S3FileNotFoundE
-0000a790: 7272 6f72 2c0a 2020 2020 2020 2020 2020  rror,.          
-0000a7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a7b0: 2020 2020 2020 2020 5333 4275 636b 6574          S3Bucket
-0000a7c0: 4e6f 7446 6f75 6e64 4572 726f 7229 293a  NotFoundError)):
-0000a7d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a7e0: 2072 6574 7572 6e20 4661 6c73 650a 2020   return False.  
-0000a7f0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0000a800: 6572 726f 720a 2020 2020 2020 2020 7265  error.        re
-0000a810: 7475 726e 2054 7275 650a 0a20 2020 2064  turn True..    d
-0000a820: 6566 2065 7869 7374 7328 7365 6c66 2c20  ef exists(self, 
-0000a830: 666f 6c6c 6f77 6c69 6e6b 733a 2062 6f6f  followlinks: boo
-0000a840: 6c20 3d20 4661 6c73 6529 202d 3e20 626f  l = False) -> bo
-0000a850: 6f6c 3a0a 2020 2020 2020 2020 2727 270a  ol:.        '''.
-0000a860: 2020 2020 2020 2020 5465 7374 2069 6620          Test if 
-0000a870: 7333 5f75 726c 2065 7869 7374 730a 0a20  s3_url exists.. 
-0000a880: 2020 2020 2020 2049 6620 7468 6520 6275         If the bu
-0000a890: 636b 6574 206f 6620 7333 5f75 726c 2061  cket of s3_url a
-0000a8a0: 7265 206e 6f74 2070 6572 6d69 7474 6564  re not permitted
-0000a8b0: 2074 6f20 7265 6164 2c20 7265 7475 726e   to read, return
-0000a8c0: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
-0000a8d0: 3a72 6574 7572 6e73 3a20 5472 7565 2069  :returns: True i
-0000a8e0: 6620 7333 5f75 726c 2065 6978 7374 732c  f s3_url eixsts,
-0000a8f0: 2065 6c73 6520 4661 6c73 650a 2020 2020   else False.    
-0000a900: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
-0000a910: 6275 636b 6574 2c20 6b65 7920 3d20 7061  bucket, key = pa
-0000a920: 7273 655f 7333 5f75 726c 2873 656c 662e  rse_s3_url(self.
-0000a930: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
-0000a940: 6f6c 290a 2020 2020 2020 2020 6966 206e  ol).        if n
-0000a950: 6f74 2062 7563 6b65 743a 2020 2320 7333  ot bucket:  # s3
-0000a960: 3a2f 2f20 3d3e 2054 7275 652c 2073 333a  :// => True, s3:
-0000a970: 2f2f 2f6b 6579 203d 3e20 4661 6c73 650a  ///key => False.
-0000a980: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000a990: 726e 206e 6f74 206b 6579 0a0a 2020 2020  rn not key..    
-0000a9a0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0000a9b0: 6973 5f64 6972 2829 206f 7220 7365 6c66  is_dir() or self
-0000a9c0: 2e69 735f 6669 6c65 2866 6f6c 6c6f 776c  .is_file(followl
-0000a9d0: 696e 6b73 290a 0a20 2020 2064 6566 2067  inks)..    def g
-0000a9e0: 6574 6d74 696d 6528 7365 6c66 2c20 666f  etmtime(self, fo
-0000a9f0: 6c6c 6f77 5f73 796d 6c69 6e6b 733a 2062  llow_symlinks: b
-0000aa00: 6f6f 6c20 3d20 4661 6c73 6529 202d 3e20  ool = False) -> 
-0000aa10: 666c 6f61 743a 0a20 2020 2020 2020 2027  float:.        '
-0000aa20: 2727 0a20 2020 2020 2020 2047 6574 206c  ''.        Get l
-0000aa30: 6173 742d 6d6f 6469 6669 6564 2074 696d  ast-modified tim
-0000aa40: 6520 6f66 2074 6865 2066 696c 6520 6f6e  e of the file on
-0000aa50: 2074 6865 2067 6976 656e 2073 335f 7572   the given s3_ur
-0000aa60: 6c20 7061 7468 2028 696e 2055 6e69 7820  l path (in Unix 
-0000aa70: 7469 6d65 7374 616d 7020 666f 726d 6174  timestamp format
-0000aa80: 292e 0a20 2020 2020 2020 2049 6620 7468  )..        If th
-0000aa90: 6520 7061 7468 2069 7320 616e 2065 7869  e path is an exi
-0000aaa0: 7374 656e 7420 6469 7265 6374 6f72 792c  stent directory,
-0000aab0: 2072 6574 7572 6e20 7468 6520 6c61 7465   return the late
-0000aac0: 7374 206d 6f64 6966 6965 6420 7469 6d65  st modified time
-0000aad0: 206f 6620 616c 6c20 6669 6c65 2069 6e20   of all file in 
-0000aae0: 6974 2e20 5468 6520 6d74 696d 6520 6f66  it. The mtime of
-0000aaf0: 2065 6d70 7479 2064 6972 6563 746f 7279   empty directory
-0000ab00: 2069 7320 3139 3730 2d30 312d 3031 2030   is 1970-01-01 0
-0000ab10: 303a 3030 3a30 300a 0a20 2020 2020 2020  0:00:00..       
-0000ab20: 2049 6620 7333 5f75 726c 2069 7320 6e6f   If s3_url is no
-0000ab30: 7420 616e 2065 7869 7374 656e 7420 7061  t an existent pa
-0000ab40: 7468 2c20 7768 6963 6820 6d65 616e 7320  th, which means 
-0000ab50: 7333 5f65 7869 7374 2873 335f 7572 6c29  s3_exist(s3_url)
-0000ab60: 2072 6574 7572 6e73 2046 616c 7365 2c20   returns False, 
-0000ab70: 7468 656e 2072 6169 7365 2053 3346 696c  then raise S3Fil
-0000ab80: 654e 6f74 466f 756e 6445 7272 6f72 0a0a  eNotFoundError..
-0000ab90: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
-0000aba0: 3a20 4c61 7374 2d6d 6f64 6966 6965 6420  : Last-modified 
-0000abb0: 7469 6d65 0a20 2020 2020 2020 203a 7261  time.        :ra
-0000abc0: 6973 6573 3a20 5333 4669 6c65 4e6f 7446  ises: S3FileNotF
-0000abd0: 6f75 6e64 4572 726f 722c 2055 6e73 7570  oundError, Unsup
-0000abe0: 706f 7274 6564 4572 726f 720a 2020 2020  portedError.    
-0000abf0: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
-0000ac00: 7265 7475 726e 2073 656c 662e 7374 6174  return self.stat
-0000ac10: 2866 6f6c 6c6f 775f 7379 6d6c 696e 6b73  (follow_symlinks
-0000ac20: 3d66 6f6c 6c6f 775f 7379 6d6c 696e 6b73  =follow_symlinks
-0000ac30: 292e 6d74 696d 650a 0a20 2020 2064 6566  ).mtime..    def
-0000ac40: 2067 6574 7369 7a65 2873 656c 662c 2066   getsize(self, f
-0000ac50: 6f6c 6c6f 775f 7379 6d6c 696e 6b73 3a20  ollow_symlinks: 
-0000ac60: 626f 6f6c 203d 2046 616c 7365 2920 2d3e  bool = False) ->
-0000ac70: 2069 6e74 3a0a 2020 2020 2020 2020 2727   int:.        ''
-0000ac80: 270a 2020 2020 2020 2020 4765 7420 6669  '.        Get fi
-0000ac90: 6c65 2073 697a 6520 6f6e 2074 6865 2067  le size on the g
-0000aca0: 6976 656e 2073 335f 7572 6c20 7061 7468  iven s3_url path
-0000acb0: 2028 696e 2062 7974 6573 292e 0a20 2020   (in bytes)..   
-0000acc0: 2020 2020 2049 6620 7468 6520 7061 7468       If the path
-0000acd0: 2069 6e20 6120 6469 7265 6374 6f72 792c   in a directory,
-0000ace0: 2072 6574 7572 6e20 7468 6520 7375 6d20   return the sum 
-0000acf0: 6f66 2061 6c6c 2066 696c 6520 7369 7a65  of all file size
-0000ad00: 2069 6e20 6974 2c20 696e 636c 7564 696e   in it, includin
-0000ad10: 6720 6669 6c65 2069 6e20 7375 6264 6972  g file in subdir
-0000ad20: 6563 746f 7269 6573 2028 6966 2065 7869  ectories (if exi
-0000ad30: 7374 292e 0a20 2020 2020 2020 2054 6865  st)..        The
-0000ad40: 2072 6573 756c 7420 6578 636c 7564 6573   result excludes
-0000ad50: 2074 6865 2073 697a 6520 6f66 2064 6972   the size of dir
-0000ad60: 6563 746f 7279 2069 7473 656c 662e 2049  ectory itself. I
-0000ad70: 6e20 6f74 6865 7220 776f 7264 732c 2072  n other words, r
-0000ad80: 6574 7572 6e20 3020 4279 7465 206f 6e20  eturn 0 Byte on 
-0000ad90: 616e 2065 6d70 7479 2064 6972 6563 746f  an empty directo
-0000ada0: 7279 2070 6174 682e 0a0a 2020 2020 2020  ry path...      
-0000adb0: 2020 4966 2073 335f 7572 6c20 6973 206e    If s3_url is n
-0000adc0: 6f74 2061 6e20 6578 6973 7465 6e74 2070  ot an existent p
-0000add0: 6174 682c 2077 6869 6368 206d 6561 6e73  ath, which means
-0000ade0: 2073 335f 6578 6973 7428 7333 5f75 726c   s3_exist(s3_url
-0000adf0: 2920 7265 7475 726e 7320 4661 6c73 652c  ) returns False,
-0000ae00: 2074 6865 6e20 7261 6973 6520 5333 4669   then raise S3Fi
-0000ae10: 6c65 4e6f 7446 6f75 6e64 4572 726f 720a  leNotFoundError.
-0000ae20: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-0000ae30: 733a 2046 696c 6520 7369 7a65 0a20 2020  s: File size.   
-0000ae40: 2020 2020 203a 7261 6973 6573 3a20 5333       :raises: S3
-0000ae50: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
-0000ae60: 722c 2055 6e73 7570 706f 7274 6564 4572  r, UnsupportedEr
-0000ae70: 726f 720a 2020 2020 2020 2020 2727 270a  ror.        '''.
-0000ae80: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0000ae90: 656c 662e 7374 6174 2866 6f6c 6c6f 775f  elf.stat(follow_
-0000aea0: 7379 6d6c 696e 6b73 3d66 6f6c 6c6f 775f  symlinks=follow_
-0000aeb0: 7379 6d6c 696e 6b73 292e 7369 7a65 0a0a  symlinks).size..
-0000aec0: 2020 2020 6465 6620 676c 6f62 280a 2020      def glob(.  
-0000aed0: 2020 2020 2020 2020 2020 7365 6c66 2c0a            self,.
-0000aee0: 2020 2020 2020 2020 2020 2020 7061 7474              patt
-0000aef0: 6572 6e2c 0a20 2020 2020 2020 2020 2020  ern,.           
-0000af00: 2072 6563 7572 7369 7665 3a20 626f 6f6c   recursive: bool
-0000af10: 203d 2054 7275 652c 0a20 2020 2020 2020   = True,.       
-0000af20: 2020 2020 206d 6973 7369 6e67 5f6f 6b3a       missing_ok:
-0000af30: 2062 6f6f 6c20 3d20 5472 7565 2c0a 2020   bool = True,.  
-0000af40: 2020 2020 2020 2020 2020 666f 6c6c 6f77            follow
-0000af50: 6c69 6e6b 733a 2062 6f6f 6c20 3d20 4661  links: bool = Fa
-0000af60: 6c73 652c 0a20 2020 2029 202d 3e20 4c69  lse,.    ) -> Li
-0000af70: 7374 5b27 5333 5061 7468 275d 3a0a 2020  st['S3Path']:.  
-0000af80: 2020 2020 2020 2727 2752 6574 7572 6e20        '''Return 
-0000af90: 7333 2070 6174 6820 6c69 7374 2069 6e20  s3 path list in 
-0000afa0: 6173 6365 6e64 696e 6720 616c 7068 6162  ascending alphab
-0000afb0: 6574 6963 616c 206f 7264 6572 2c20 696e  etical order, in
-0000afc0: 2077 6869 6368 2070 6174 6820 6d61 7463   which path matc
-0000afd0: 6865 7320 676c 6f62 2070 6174 7465 726e  hes glob pattern
-0000afe0: 0a20 2020 2020 2020 204e 6f74 6573 3a20  .        Notes: 
-0000aff0: 4f6e 6c79 2067 6c6f 6220 696e 2062 7563  Only glob in buc
-0000b000: 6b65 742e 2049 6620 7472 7969 6e67 2074  ket. If trying t
-0000b010: 6f20 6d61 7463 6820 6275 636b 6574 2077  o match bucket w
-0000b020: 6974 6820 7769 6c64 6361 7264 2063 6861  ith wildcard cha
-0000b030: 7261 6374 6572 732c 2072 6169 7365 2055  racters, raise U
-0000b040: 6e73 7570 706f 7274 6564 4572 726f 720a  nsupportedError.
-0000b050: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-0000b060: 7061 7474 6572 6e3a 2047 6c6f 6220 7468  pattern: Glob th
-0000b070: 6520 6769 7665 6e20 7265 6c61 7469 7665  e given relative
-0000b080: 2070 6174 7465 726e 2069 6e20 7468 6520   pattern in the 
-0000b090: 6469 7265 6374 6f72 7920 7265 7072 6573  directory repres
-0000b0a0: 656e 7465 6420 6279 2074 6869 7320 7061  ented by this pa
-0000b0b0: 7468 0a20 2020 2020 2020 203a 7061 7261  th.        :para
-0000b0c0: 6d20 7265 6375 7273 6976 653a 2049 6620  m recursive: If 
-0000b0d0: 4661 6c73 652c 2060 2a2a 6020 7769 6c6c  False, `**` will
-0000b0e0: 206e 6f74 2073 6561 7263 6820 6469 7265   not search dire
-0000b0f0: 6374 6f72 7920 7265 6375 7273 6976 656c  ctory recursivel
-0000b100: 790a 2020 2020 2020 2020 3a70 6172 616d  y.        :param
-0000b110: 206d 6973 7369 6e67 5f6f 6b3a 2049 6620   missing_ok: If 
-0000b120: 4661 6c73 6520 616e 6420 7461 7267 6574  False and target
-0000b130: 2070 6174 6820 646f 6573 6e27 7420 6d61   path doesn't ma
-0000b140: 7463 6820 616e 7920 6669 6c65 2c20 7261  tch any file, ra
-0000b150: 6973 6520 4669 6c65 4e6f 7446 6f75 6e64  ise FileNotFound
-0000b160: 4572 726f 720a 2020 2020 2020 2020 3a72  Error.        :r
-0000b170: 6169 7365 733a 2055 6e73 7570 706f 7274  aises: Unsupport
-0000b180: 6564 4572 726f 722c 2077 6865 6e20 6275  edError, when bu
-0000b190: 636b 6574 2070 6172 7420 636f 6e74 6169  cket part contai
-0000b1a0: 6e73 2077 696c 6463 6172 6420 6368 6172  ns wildcard char
-0000b1b0: 6163 7465 7273 0a20 2020 2020 2020 203a  acters.        :
-0000b1c0: 7265 7475 726e 733a 2041 206c 6973 7420  returns: A list 
-0000b1d0: 636f 6e74 6169 6e73 2070 6174 6873 206d  contains paths m
-0000b1e0: 6174 6368 2060 7333 5f70 6174 686e 616d  atch `s3_pathnam
-0000b1f0: 6560 0a20 2020 2020 2020 2027 2727 0a20  e`.        '''. 
-0000b200: 2020 2020 2020 2072 6574 7572 6e20 6c69         return li
-0000b210: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
-0000b220: 7365 6c66 2e69 676c 6f62 280a 2020 2020  self.iglob(.    
-0000b230: 2020 2020 2020 2020 2020 2020 7061 7474              patt
-0000b240: 6572 6e3d 7061 7474 6572 6e2c 0a20 2020  ern=pattern,.   
-0000b250: 2020 2020 2020 2020 2020 2020 2072 6563               rec
-0000b260: 7572 7369 7665 3d72 6563 7572 7369 7665  ursive=recursive
-0000b270: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000b280: 2020 6d69 7373 696e 675f 6f6b 3d6d 6973    missing_ok=mis
-0000b290: 7369 6e67 5f6f 6b2c 0a20 2020 2020 2020  sing_ok,.       
-0000b2a0: 2020 2020 2020 2020 2066 6f6c 6c6f 776c           followl
-0000b2b0: 696e 6b73 3d66 6f6c 6c6f 776c 696e 6b73  inks=followlinks
-0000b2c0: 2929 0a0a 2020 2020 6465 6620 676c 6f62  ))..    def glob
-0000b2d0: 5f73 7461 7428 0a20 2020 2020 2020 2020  _stat(.         
-0000b2e0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-0000b2f0: 2020 2020 2070 6174 7465 726e 2c0a 2020       pattern,.  
-0000b300: 2020 2020 2020 2020 2020 7265 6375 7273            recurs
-0000b310: 6976 653a 2062 6f6f 6c20 3d20 5472 7565  ive: bool = True
-0000b320: 2c0a 2020 2020 2020 2020 2020 2020 6d69  ,.            mi
-0000b330: 7373 696e 675f 6f6b 3a20 626f 6f6c 203d  ssing_ok: bool =
-0000b340: 2054 7275 652c 0a20 2020 2020 2020 2020   True,.         
-0000b350: 2020 2066 6f6c 6c6f 776c 696e 6b73 3a20     followlinks: 
-0000b360: 626f 6f6c 203d 2046 616c 7365 2920 2d3e  bool = False) ->
-0000b370: 2049 7465 7261 746f 725b 4669 6c65 456e   Iterator[FileEn
-0000b380: 7472 795d 3a0a 2020 2020 2020 2020 2727  try]:.        ''
-0000b390: 2752 6574 7572 6e20 6120 6765 6e65 7261  'Return a genera
-0000b3a0: 746f 7220 636f 6e74 6169 6e73 2074 7570  tor contains tup
-0000b3b0: 6c65 7320 6f66 2070 6174 6820 616e 6420  les of path and 
-0000b3c0: 6669 6c65 2073 7461 742c 2069 6e20 6173  file stat, in as
-0000b3d0: 6365 6e64 696e 6720 616c 7068 6162 6574  cending alphabet
-0000b3e0: 6963 616c 206f 7264 6572 2c20 696e 2077  ical order, in w
-0000b3f0: 6869 6368 2070 6174 6820 6d61 7463 6865  hich path matche
-0000b400: 7320 676c 6f62 2070 6174 7465 726e 0a20  s glob pattern. 
-0000b410: 2020 2020 2020 204e 6f74 6573 3a20 4f6e         Notes: On
-0000b420: 6c79 2067 6c6f 6220 696e 2062 7563 6b65  ly glob in bucke
-0000b430: 742e 2049 6620 7472 7969 6e67 2074 6f20  t. If trying to 
-0000b440: 6d61 7463 6820 6275 636b 6574 2077 6974  match bucket wit
-0000b450: 6820 7769 6c64 6361 7264 2063 6861 7261  h wildcard chara
-0000b460: 6374 6572 732c 2072 6169 7365 2055 6e73  cters, raise Uns
-0000b470: 7570 706f 7274 6564 4572 726f 720a 0a20  upportedError.. 
-0000b480: 2020 2020 2020 203a 7061 7261 6d20 7061         :param pa
-0000b490: 7474 6572 6e3a 2047 6c6f 6220 7468 6520  ttern: Glob the 
-0000b4a0: 6769 7665 6e20 7265 6c61 7469 7665 2070  given relative p
-0000b4b0: 6174 7465 726e 2069 6e20 7468 6520 6469  attern in the di
-0000b4c0: 7265 6374 6f72 7920 7265 7072 6573 656e  rectory represen
-0000b4d0: 7465 6420 6279 2074 6869 7320 7061 7468  ted by this path
-0000b4e0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-0000b4f0: 7265 6375 7273 6976 653a 2049 6620 4661  recursive: If Fa
-0000b500: 6c73 652c 2060 2a2a 6020 7769 6c6c 206e  lse, `**` will n
-0000b510: 6f74 2073 6561 7263 6820 6469 7265 6374  ot search direct
-0000b520: 6f72 7920 7265 6375 7273 6976 656c 790a  ory recursively.
-0000b530: 2020 2020 2020 2020 3a70 6172 616d 206d          :param m
-0000b540: 6973 7369 6e67 5f6f 6b3a 2049 6620 4661  issing_ok: If Fa
-0000b550: 6c73 6520 616e 6420 7461 7267 6574 2070  lse and target p
-0000b560: 6174 6820 646f 6573 6e27 7420 6d61 7463  ath doesn't matc
-0000b570: 6820 616e 7920 6669 6c65 2c20 7261 6973  h any file, rais
-0000b580: 6520 4669 6c65 4e6f 7446 6f75 6e64 4572  e FileNotFoundEr
-0000b590: 726f 720a 2020 2020 2020 2020 3a72 6169  ror.        :rai
-0000b5a0: 7365 733a 2055 6e73 7570 706f 7274 6564  ses: Unsupported
-0000b5b0: 4572 726f 722c 2077 6865 6e20 6275 636b  Error, when buck
-0000b5c0: 6574 2070 6172 7420 636f 6e74 6169 6e73  et part contains
-0000b5d0: 2077 696c 6463 6172 6420 6368 6172 6163   wildcard charac
-0000b5e0: 7465 7273 0a20 2020 2020 2020 203a 7265  ters.        :re
-0000b5f0: 7475 726e 733a 2041 2067 656e 6572 6174  turns: A generat
-0000b600: 6f72 2063 6f6e 7461 696e 7320 7475 706c  or contains tupl
-0000b610: 6573 206f 6620 7061 7468 2061 6e64 2066  es of path and f
-0000b620: 696c 6520 7374 6174 2c20 696e 2077 6869  ile stat, in whi
-0000b630: 6368 2070 6174 6873 206d 6174 6368 2060  ch paths match `
-0000b640: 7333 5f70 6174 686e 616d 6560 0a20 2020  s3_pathname`.   
-0000b650: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
-0000b660: 2067 6c6f 625f 7061 7468 203d 2073 656c   glob_path = sel
-0000b670: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
-0000b680: 6f63 6f6c 0a20 2020 2020 2020 2069 6620  ocol.        if 
-0000b690: 7061 7474 6572 6e3a 0a20 2020 2020 2020  pattern:.       
-0000b6a0: 2020 2020 2067 6c6f 625f 7061 7468 203d       glob_path =
-0000b6b0: 2073 656c 662e 6a6f 696e 7061 7468 2870   self.joinpath(p
-0000b6c0: 6174 7465 726e 292e 7061 7468 5f77 6974  attern).path_wit
-0000b6d0: 685f 7072 6f74 6f63 6f6c 0a20 2020 2020  h_protocol.     
-0000b6e0: 2020 2072 6574 7572 6e20 7333 5f67 6c6f     return s3_glo
-0000b6f0: 625f 7374 6174 280a 2020 2020 2020 2020  b_stat(.        
-0000b700: 2020 2020 7061 7468 3d67 6c6f 625f 7061      path=glob_pa
-0000b710: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
-0000b720: 7265 6375 7273 6976 653d 7265 6375 7273  recursive=recurs
-0000b730: 6976 652c 0a20 2020 2020 2020 2020 2020  ive,.           
-0000b740: 206d 6973 7369 6e67 5f6f 6b3d 6d69 7373   missing_ok=miss
-0000b750: 696e 675f 6f6b 2c0a 2020 2020 2020 2020  ing_ok,.        
-0000b760: 2020 2020 666f 6c6c 6f77 6c69 6e6b 733d      followlinks=
-0000b770: 666f 6c6c 6f77 6c69 6e6b 7329 0a0a 2020  followlinks)..  
-0000b780: 2020 6465 6620 6967 6c6f 6228 0a20 2020    def iglob(.   
-0000b790: 2020 2020 2020 2020 2073 656c 662c 0a20           self,. 
-0000b7a0: 2020 2020 2020 2020 2020 2070 6174 7465             patte
-0000b7b0: 726e 2c0a 2020 2020 2020 2020 2020 2020  rn,.            
-0000b7c0: 7265 6375 7273 6976 653a 2062 6f6f 6c20  recursive: bool 
-0000b7d0: 3d20 5472 7565 2c0a 2020 2020 2020 2020  = True,.        
-0000b7e0: 2020 2020 6d69 7373 696e 675f 6f6b 3a20      missing_ok: 
-0000b7f0: 626f 6f6c 203d 2054 7275 652c 0a20 2020  bool = True,.   
-0000b800: 2020 2020 2020 2020 2066 6f6c 6c6f 776c           followl
-0000b810: 696e 6b73 3a20 626f 6f6c 203d 2046 616c  inks: bool = Fal
-0000b820: 7365 2c0a 2020 2020 2920 2d3e 2049 7465  se,.    ) -> Ite
-0000b830: 7261 746f 725b 2753 3350 6174 6827 5d3a  rator['S3Path']:
-0000b840: 0a20 2020 2020 2020 2027 2727 5265 7475  .        '''Retu
-0000b850: 726e 2073 3320 7061 7468 2069 7465 7261  rn s3 path itera
-0000b860: 746f 7220 696e 2061 7363 656e 6469 6e67  tor in ascending
-0000b870: 2061 6c70 6861 6265 7469 6361 6c20 6f72   alphabetical or
-0000b880: 6465 722c 2069 6e20 7768 6963 6820 7061  der, in which pa
-0000b890: 7468 206d 6174 6368 6573 2067 6c6f 6220  th matches glob 
-0000b8a0: 7061 7474 6572 6e0a 2020 2020 2020 2020  pattern.        
-0000b8b0: 4e6f 7465 733a 204f 6e6c 7920 676c 6f62  Notes: Only glob
-0000b8c0: 2069 6e20 6275 636b 6574 2e20 4966 2074   in bucket. If t
-0000b8d0: 7279 696e 6720 746f 206d 6174 6368 2062  rying to match b
-0000b8e0: 7563 6b65 7420 7769 7468 2077 696c 6463  ucket with wildc
-0000b8f0: 6172 6420 6368 6172 6163 7465 7273 2c20  ard characters, 
-0000b900: 7261 6973 6520 556e 7375 7070 6f72 7465  raise Unsupporte
-0000b910: 6445 7272 6f72 0a0a 2020 2020 2020 2020  dError..        
-0000b920: 3a70 6172 616d 2070 6174 7465 726e 3a20  :param pattern: 
-0000b930: 476c 6f62 2074 6865 2067 6976 656e 2072  Glob the given r
-0000b940: 656c 6174 6976 6520 7061 7474 6572 6e20  elative pattern 
-0000b950: 696e 2074 6865 2064 6972 6563 746f 7279  in the directory
-0000b960: 2072 6570 7265 7365 6e74 6564 2062 7920   represented by 
-0000b970: 7468 6973 2070 6174 680a 2020 2020 2020  this path.      
-0000b980: 2020 3a70 6172 616d 2072 6563 7572 7369    :param recursi
-0000b990: 7665 3a20 4966 2046 616c 7365 2c20 602a  ve: If False, `*
-0000b9a0: 2a60 2077 696c 6c20 6e6f 7420 7365 6172  *` will not sear
-0000b9b0: 6368 2064 6972 6563 746f 7279 2072 6563  ch directory rec
-0000b9c0: 7572 7369 7665 6c79 0a20 2020 2020 2020  ursively.       
-0000b9d0: 203a 7061 7261 6d20 6d69 7373 696e 675f   :param missing_
-0000b9e0: 6f6b 3a20 4966 2046 616c 7365 2061 6e64  ok: If False and
-0000b9f0: 2074 6172 6765 7420 7061 7468 2064 6f65   target path doe
-0000ba00: 736e 2774 206d 6174 6368 2061 6e79 2066  sn't match any f
-0000ba10: 696c 652c 2072 6169 7365 2046 696c 654e  ile, raise FileN
-0000ba20: 6f74 466f 756e 6445 7272 6f72 0a20 2020  otFoundError.   
-0000ba30: 2020 2020 203a 7261 6973 6573 3a20 556e       :raises: Un
-0000ba40: 7375 7070 6f72 7465 6445 7272 6f72 2c20  supportedError, 
-0000ba50: 7768 656e 2062 7563 6b65 7420 7061 7274  when bucket part
-0000ba60: 2063 6f6e 7461 696e 7320 7769 6c64 6361   contains wildca
-0000ba70: 7264 2063 6861 7261 6374 6572 730a 2020  rd characters.  
-0000ba80: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
-0000ba90: 416e 2069 7465 7261 746f 7220 636f 6e74  An iterator cont
-0000baa0: 6169 6e73 2070 6174 6873 206d 6174 6368  ains paths match
-0000bab0: 2060 7333 5f70 6174 686e 616d 6560 0a20   `s3_pathname`. 
-0000bac0: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-0000bad0: 2020 2067 6c6f 625f 7061 7468 203d 2073     glob_path = s
-0000bae0: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
-0000baf0: 6f74 6f63 6f6c 0a20 2020 2020 2020 2069  otocol.        i
-0000bb00: 6620 7061 7474 6572 6e3a 0a20 2020 2020  f pattern:.     
-0000bb10: 2020 2020 2020 2067 6c6f 625f 7061 7468         glob_path
-0000bb20: 203d 2073 656c 662e 6a6f 696e 7061 7468   = self.joinpath
-0000bb30: 2870 6174 7465 726e 292e 7061 7468 5f77  (pattern).path_w
-0000bb40: 6974 685f 7072 6f74 6f63 6f6c 0a20 2020  ith_protocol.   
-0000bb50: 2020 2020 2066 6f72 2070 6174 6820 696e       for path in
-0000bb60: 2073 335f 6967 6c6f 6228 7061 7468 3d67   s3_iglob(path=g
-0000bb70: 6c6f 625f 7061 7468 2c20 7265 6375 7273  lob_path, recurs
-0000bb80: 6976 653d 7265 6375 7273 6976 652c 0a20  ive=recursive,. 
-0000bb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bba0: 2020 2020 2020 2020 2020 2020 6d69 7373              miss
-0000bbb0: 696e 675f 6f6b 3d6d 6973 7369 6e67 5f6f  ing_ok=missing_o
-0000bbc0: 6b2c 2066 6f6c 6c6f 776c 696e 6b73 3d66  k, followlinks=f
-0000bbd0: 6f6c 6c6f 776c 696e 6b73 293a 0a20 2020  ollowlinks):.   
-0000bbe0: 2020 2020 2020 2020 2079 6965 6c64 2073           yield s
-0000bbf0: 656c 662e 6672 6f6d 5f70 6174 6828 7061  elf.from_path(pa
-0000bc00: 7468 290a 0a20 2020 2064 6566 2069 735f  th)..    def is_
-0000bc10: 6469 7228 7365 6c66 2c20 666f 6c6c 6f77  dir(self, follow
-0000bc20: 6c69 6e6b 733a 2062 6f6f 6c20 3d20 4661  links: bool = Fa
-0000bc30: 6c73 6529 202d 3e20 626f 6f6c 3a0a 2020  lse) -> bool:.  
-0000bc40: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
-0000bc50: 2020 5465 7374 2069 6620 616e 2073 3320    Test if an s3 
-0000bc60: 7572 6c20 6973 2064 6972 6563 746f 7279  url is directory
-0000bc70: 0a20 2020 2020 2020 2053 7065 6369 6669  .        Specifi
-0000bc80: 6320 7072 6f63 6564 7572 6573 2061 7265  c procedures are
-0000bc90: 2061 7320 666f 6c6c 6f77 733a 0a20 2020   as follows:.   
-0000bca0: 2020 2020 2049 6620 7468 6572 6520 6578       If there ex
-0000bcb0: 6973 7473 2061 2073 7566 6669 782c 206f  ists a suffix, o
-0000bcc0: 6620 7768 6963 6820 6060 6f73 2e70 6174  f which ``os.pat
-0000bcd0: 682e 6a6f 696e 2873 335f 7572 6c2c 2073  h.join(s3_url, s
-0000bce0: 7566 6669 7829 6060 2069 7320 6120 6669  uffix)`` is a fi
-0000bcf0: 6c65 0a20 2020 2020 2020 2049 6620 7468  le.        If th
-0000bd00: 6520 7572 6c20 6973 2065 6d70 7479 2062  e url is empty b
-0000bd10: 7563 6b65 7420 6f72 2073 333a 2f2f 0a0a  ucket or s3://..
-0000bd20: 2020 2020 2020 2020 3a70 6172 616d 2066          :param f
-0000bd30: 6f6c 6c6f 776c 696e 6b73 3a20 7768 6574  ollowlinks: whet
-0000bd40: 6865 7220 666f 6c6c 6f77 6c69 6e6b 7320  her followlinks 
-0000bd50: 6973 2054 7275 6520 6f72 2046 616c 7365  is True or False
-0000bd60: 2c20 7265 7375 6c74 2069 7320 7468 6520  , result is the 
-0000bd70: 7361 6d65 2e20 4265 6361 7573 6520 7333  same. Because s3
-0000bd80: 2073 796d 6c69 6e6b 206e 6f74 2073 7570   symlink not sup
-0000bd90: 706f 7274 2064 6972 2e0a 2020 2020 2020  port dir..      
-0000bda0: 2020 3a72 6574 7572 6e73 3a20 5472 7565    :returns: True
-0000bdb0: 2069 6620 7061 7468 2069 7320 7333 2064   if path is s3 d
-0000bdc0: 6972 6563 746f 7279 2c20 656c 7365 2046  irectory, else F
-0000bdd0: 616c 7365 0a20 2020 2020 2020 2027 2727  alse.        '''
-0000bde0: 0a20 2020 2020 2020 2062 7563 6b65 742c  .        bucket,
-0000bdf0: 206b 6579 203d 2070 6172 7365 5f73 335f   key = parse_s3_
-0000be00: 7572 6c28 7365 6c66 2e70 6174 685f 7769  url(self.path_wi
-0000be10: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
-0000be20: 2020 2020 2069 6620 6e6f 7420 6275 636b       if not buck
-0000be30: 6574 3a20 2023 2073 333a 2f2f 203d 3e20  et:  # s3:// => 
-0000be40: 5472 7565 2c20 7333 3a2f 2f2f 6b65 7920  True, s3:///key 
-0000be50: 3d3e 2046 616c 7365 0a20 2020 2020 2020  => False.       
-0000be60: 2020 2020 2072 6574 7572 6e20 6e6f 7420       return not 
-0000be70: 6b65 790a 2020 2020 2020 2020 7072 6566  key.        pref
-0000be80: 6978 203d 205f 6265 636f 6d65 5f70 7265  ix = _become_pre
-0000be90: 6669 7828 6b65 7929 0a20 2020 2020 2020  fix(key).       
-0000bea0: 2063 6c69 656e 7420 3d20 6765 745f 7333   client = get_s3
-0000beb0: 5f63 6c69 656e 7428 290a 2020 2020 2020  _client().      
-0000bec0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0000bed0: 2020 2072 6573 7020 3d20 636c 6965 6e74     resp = client
-0000bee0: 2e6c 6973 745f 6f62 6a65 6374 735f 7632  .list_objects_v2
-0000bef0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000bf00: 2020 4275 636b 6574 3d62 7563 6b65 742c    Bucket=bucket,
-0000bf10: 2050 7265 6669 783d 7072 6566 6978 2c20   Prefix=prefix, 
-0000bf20: 4465 6c69 6d69 7465 723d 272f 272c 204d  Delimiter='/', M
-0000bf30: 6178 4b65 7973 3d31 290a 2020 2020 2020  axKeys=1).      
-0000bf40: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-0000bf50: 6f6e 2061 7320 6572 726f 723a 0a20 2020  on as error:.   
-0000bf60: 2020 2020 2020 2020 2065 7272 6f72 203d           error =
-0000bf70: 2074 7261 6e73 6c61 7465 5f73 335f 6572   translate_s3_er
-0000bf80: 726f 7228 6572 726f 722c 2073 656c 662e  ror(error, self.
-0000bf90: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
-0000bfa0: 6f6c 290a 2020 2020 2020 2020 2020 2020  ol).            
-0000bfb0: 6966 2069 7369 6e73 7461 6e63 6528 6572  if isinstance(er
-0000bfc0: 726f 722c 2028 5333 556e 6b6e 6f77 6e45  ror, (S3UnknownE
-0000bfd0: 7272 6f72 2c20 5333 436f 6e66 6967 4572  rror, S3ConfigEr
-0000bfe0: 726f 7229 293a 0a20 2020 2020 2020 2020  ror)):.         
-0000bff0: 2020 2020 2020 2072 6169 7365 2065 7272         raise err
-0000c000: 6f72 0a20 2020 2020 2020 2020 2020 2072  or.            r
-0000c010: 6574 7572 6e20 4661 6c73 650a 0a20 2020  eturn False..   
-0000c020: 2020 2020 2069 6620 6e6f 7420 6b65 793a       if not key:
-0000c030: 2020 2320 6275 636b 6574 2069 7320 6163    # bucket is ac
-0000c040: 6365 7373 6962 6c65 0a20 2020 2020 2020  cessible.       
-0000c050: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
-0000c060: 0a0a 2020 2020 2020 2020 6966 2027 4b65  ..        if 'Ke
-0000c070: 7943 6f75 6e74 2720 696e 2072 6573 703a  yCount' in resp:
-0000c080: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0000c090: 7572 6e20 7265 7370 5b27 4b65 7943 6f75  urn resp['KeyCou
-0000c0a0: 6e74 275d 203e 2030 0a0a 2020 2020 2020  nt'] > 0..      
-0000c0b0: 2020 7265 7475 726e 206c 656e 2872 6573    return len(res
-0000c0c0: 702e 6765 7428 2743 6f6e 7465 6e74 7327  p.get('Contents'
-0000c0d0: 2c20 5b5d 2929 203e 2030 206f 7220 5c0a  , [])) > 0 or \.
-0000c0e0: 2020 2020 2020 2020 2020 2020 6c65 6e28              len(
-0000c0f0: 7265 7370 2e67 6574 2827 436f 6d6d 6f6e  resp.get('Common
-0000c100: 5072 6566 6978 6573 272c 205b 5d29 2920  Prefixes', [])) 
-0000c110: 3e20 300a 0a20 2020 2064 6566 2069 735f  > 0..    def is_
-0000c120: 6669 6c65 2873 656c 662c 2066 6f6c 6c6f  file(self, follo
-0000c130: 776c 696e 6b73 3a20 626f 6f6c 203d 2046  wlinks: bool = F
-0000c140: 616c 7365 2920 2d3e 2062 6f6f 6c3a 0a20  alse) -> bool:. 
-0000c150: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-0000c160: 2020 2054 6573 7420 6966 2061 6e20 7333     Test if an s3
-0000c170: 5f75 726c 2069 7320 6669 6c65 0a0a 2020  _url is file..  
-0000c180: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
-0000c190: 5472 7565 2069 6620 7061 7468 2069 7320  True if path is 
-0000c1a0: 7333 2066 696c 652c 2065 6c73 6520 4661  s3 file, else Fa
-0000c1b0: 6c73 650a 2020 2020 2020 2020 2727 270a  lse.        '''.
-0000c1c0: 2020 2020 2020 2020 7333 5f75 726c 203d          s3_url =
-0000c1d0: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
-0000c1e0: 7072 6f74 6f63 6f6c 0a20 2020 2020 2020  protocol.       
-0000c1f0: 2069 6620 666f 6c6c 6f77 6c69 6e6b 733a   if followlinks:
-0000c200: 0a20 2020 2020 2020 2020 2020 206d 6574  .            met
-0000c210: 6164 6174 6120 3d20 5f73 335f 6765 745f  adata = _s3_get_
-0000c220: 6d65 7461 6461 7461 2873 335f 7572 6c29  metadata(s3_url)
-0000c230: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000c240: 6d65 7461 6461 7461 2061 6e64 2027 7379  metadata and 'sy
-0000c250: 6d6c 696e 6b5f 746f 2720 696e 206d 6574  mlink_to' in met
-0000c260: 6164 6174 613a 0a20 2020 2020 2020 2020  adata:.         
-0000c270: 2020 2020 2020 2073 335f 7572 6c20 3d20         s3_url = 
-0000c280: 6d65 7461 6461 7461 5b27 7379 6d6c 696e  metadata['symlin
-0000c290: 6b5f 746f 275d 0a20 2020 2020 2020 2062  k_to'].        b
-0000c2a0: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
-0000c2b0: 7365 5f73 335f 7572 6c28 7333 5f75 726c  se_s3_url(s3_url
-0000c2c0: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-0000c2d0: 2062 7563 6b65 7420 6f72 206e 6f74 206b   bucket or not k
-0000c2e0: 6579 206f 7220 6b65 792e 656e 6473 7769  ey or key.endswi
-0000c2f0: 7468 2827 2f27 293a 0a20 2020 2020 2020  th('/'):.       
-0000c300: 2020 2020 2023 2073 333a 2f2f 2c20 7333       # s3://, s3
-0000c310: 3a2f 2f2f 6b65 792c 2073 333a 2f2f 6275  :///key, s3://bu
-0000c320: 636b 6574 2c20 7333 3a2f 2f62 7563 6b65  cket, s3://bucke
-0000c330: 742f 7072 6566 6978 2f0a 2020 2020 2020  t/prefix/.      
-0000c340: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
-0000c350: 7365 0a20 2020 2020 2020 2063 6c69 656e  se.        clien
-0000c360: 7420 3d20 6765 745f 7333 5f63 6c69 656e  t = get_s3_clien
-0000c370: 7428 290a 2020 2020 2020 2020 7472 793a  t().        try:
-0000c380: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
-0000c390: 656e 742e 6865 6164 5f6f 626a 6563 7428  ent.head_object(
-0000c3a0: 4275 636b 6574 3d62 7563 6b65 742c 204b  Bucket=bucket, K
-0000c3b0: 6579 3d6b 6579 290a 2020 2020 2020 2020  ey=key).        
-0000c3c0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-0000c3d0: 2061 7320 6572 726f 723a 0a20 2020 2020   as error:.     
-0000c3e0: 2020 2020 2020 2065 7272 6f72 203d 2074         error = t
-0000c3f0: 7261 6e73 6c61 7465 5f73 335f 6572 726f  ranslate_s3_erro
-0000c400: 7228 6572 726f 722c 2073 335f 7572 6c29  r(error, s3_url)
-0000c410: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000c420: 6973 696e 7374 616e 6365 2865 7272 6f72  isinstance(error
-0000c430: 2c20 2853 3355 6e6b 6e6f 776e 4572 726f  , (S3UnknownErro
-0000c440: 722c 2053 3343 6f6e 6669 6745 7272 6f72  r, S3ConfigError
-0000c450: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-0000c460: 2020 2020 7261 6973 6520 6572 726f 720a      raise error.
-0000c470: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000c480: 726e 2046 616c 7365 0a20 2020 2020 2020  rn False.       
-0000c490: 2072 6574 7572 6e20 5472 7565 0a0a 2020   return True..  
-0000c4a0: 2020 6465 6620 6c69 7374 6469 7228 7365    def listdir(se
-0000c4b0: 6c66 2c20 666f 6c6c 6f77 6c69 6e6b 733a  lf, followlinks:
-0000c4c0: 2062 6f6f 6c20 3d20 4661 6c73 6529 202d   bool = False) -
-0000c4d0: 3e20 4c69 7374 5b73 7472 5d3a 0a20 2020  > List[str]:.   
-0000c4e0: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
-0000c4f0: 2047 6574 2061 6c6c 2063 6f6e 7465 6e74   Get all content
-0000c500: 7320 6f66 2067 6976 656e 2073 335f 7572  s of given s3_ur
-0000c510: 6c2e 2054 6865 2072 6573 756c 7420 6973  l. The result is
-0000c520: 2069 6e20 6163 7365 6e64 696e 6720 616c   in acsending al
-0000c530: 7068 6162 6574 6963 616c 206f 7264 6572  phabetical order
-0000c540: 2e0a 0a20 2020 2020 2020 203a 7265 7475  ...        :retu
-0000c550: 726e 733a 2041 6c6c 2063 6f6e 7465 6e74  rns: All content
-0000c560: 7320 6861 7665 2070 7265 6669 7820 6f66  s have prefix of
-0000c570: 2073 335f 7572 6c20 696e 2061 6373 656e   s3_url in acsen
-0000c580: 6469 6e67 2061 6c70 6861 6265 7469 6361  ding alphabetica
-0000c590: 6c20 6f72 6465 720a 2020 2020 2020 2020  l order.        
-0000c5a0: 3a72 6169 7365 733a 2053 3346 696c 654e  :raises: S3FileN
-0000c5b0: 6f74 466f 756e 6445 7272 6f72 2c20 5333  otFoundError, S3
-0000c5c0: 4e6f 7441 4469 7265 6374 6f72 7945 7272  NotADirectoryErr
-0000c5d0: 6f72 0a20 2020 2020 2020 2027 2727 0a20  or.        '''. 
-0000c5e0: 2020 2020 2020 2065 6e74 7269 6573 203d         entries =
-0000c5f0: 206c 6973 7428 7365 6c66 2e73 6361 6e64   list(self.scand
-0000c600: 6972 2866 6f6c 6c6f 776c 696e 6b73 3d66  ir(followlinks=f
-0000c610: 6f6c 6c6f 776c 696e 6b73 2929 0a20 2020  ollowlinks)).   
-0000c620: 2020 2020 2072 6574 7572 6e20 736f 7274       return sort
-0000c630: 6564 285b 656e 7472 792e 6e61 6d65 2066  ed([entry.name f
-0000c640: 6f72 2065 6e74 7279 2069 6e20 656e 7472  or entry in entr
-0000c650: 6965 735d 290a 0a20 2020 2064 6566 2069  ies])..    def i
-0000c660: 7465 7264 6972 2873 656c 662c 2066 6f6c  terdir(self, fol
-0000c670: 6c6f 776c 696e 6b73 3a20 626f 6f6c 203d  lowlinks: bool =
-0000c680: 2046 616c 7365 2920 2d3e 2049 7465 7261   False) -> Itera
-0000c690: 746f 725b 2753 3350 6174 6827 5d3a 0a20  tor['S3Path']:. 
-0000c6a0: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-0000c6b0: 2020 2047 6574 2061 6c6c 2063 6f6e 7465     Get all conte
-0000c6c0: 6e74 7320 6f66 2067 6976 656e 2073 335f  nts of given s3_
-0000c6d0: 7572 6c2e 2054 6865 2072 6573 756c 7420  url. The result 
-0000c6e0: 6973 2069 6e20 6163 7365 6e64 696e 6720  is in acsending 
-0000c6f0: 616c 7068 6162 6574 6963 616c 206f 7264  alphabetical ord
-0000c700: 6572 2e0a 0a20 2020 2020 2020 203a 7265  er...        :re
-0000c710: 7475 726e 733a 2041 6c6c 2063 6f6e 7465  turns: All conte
-0000c720: 6e74 7320 6861 7665 2070 7265 6669 7820  nts have prefix 
-0000c730: 6f66 2073 335f 7572 6c20 696e 2061 6373  of s3_url in acs
-0000c740: 656e 6469 6e67 2061 6c70 6861 6265 7469  ending alphabeti
-0000c750: 6361 6c20 6f72 6465 720a 2020 2020 2020  cal order.      
-0000c760: 2020 3a72 6169 7365 733a 2053 3346 696c    :raises: S3Fil
-0000c770: 654e 6f74 466f 756e 6445 7272 6f72 2c20  eNotFoundError, 
-0000c780: 5333 4e6f 7441 4469 7265 6374 6f72 7945  S3NotADirectoryE
-0000c790: 7272 6f72 0a20 2020 2020 2020 2027 2727  rror.        '''
-0000c7a0: 0a20 2020 2020 2020 2066 6f72 2070 6174  .        for pat
-0000c7b0: 6820 696e 2073 656c 662e 6c69 7374 6469  h in self.listdi
-0000c7c0: 7228 666f 6c6c 6f77 6c69 6e6b 733d 666f  r(followlinks=fo
-0000c7d0: 6c6c 6f77 6c69 6e6b 7329 3a0a 2020 2020  llowlinks):.    
-0000c7e0: 2020 2020 2020 2020 7969 656c 6420 7365          yield se
-0000c7f0: 6c66 2e6a 6f69 6e70 6174 6828 7061 7468  lf.joinpath(path
-0000c800: 2920 2023 2074 7970 653a 2069 676e 6f72  )  # type: ignor
-0000c810: 650a 0a20 2020 2064 6566 206c 6f61 6428  e..    def load(
-0000c820: 7365 6c66 2c20 666f 6c6c 6f77 6c69 6e6b  self, followlink
-0000c830: 733a 2062 6f6f 6c20 3d20 4661 6c73 6529  s: bool = False)
-0000c840: 202d 3e20 4269 6e61 7279 494f 3a0a 2020   -> BinaryIO:.  
-0000c850: 2020 2020 2020 2727 2752 6561 6420 616c        '''Read al
-0000c860: 6c20 636f 6e74 656e 7420 696e 2062 696e  l content in bin
-0000c870: 6172 7920 6f6e 2073 7065 6369 6669 6564  ary on specified
-0000c880: 2070 6174 6820 616e 6420 7772 6974 6520   path and write 
-0000c890: 696e 746f 206d 656d 6f72 790a 0a20 2020  into memory..   
-0000c8a0: 2020 2020 2055 7365 7220 7368 6f75 6c64       User should
-0000c8b0: 2063 6c6f 7365 2074 6865 2042 696e 6172   close the Binar
-0000c8c0: 7949 4f20 6d61 6e75 616c 6c79 0a0a 2020  yIO manually..  
-0000c8d0: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
-0000c8e0: 4269 6e61 7279 494f 0a20 2020 2020 2020  BinaryIO.       
-0000c8f0: 2027 2727 0a20 2020 2020 2020 2073 335f   '''.        s3_
-0000c900: 7572 6c20 3d20 7365 6c66 2e70 6174 685f  url = self.path_
-0000c910: 7769 7468 5f70 726f 746f 636f 6c0a 2020  with_protocol.  
-0000c920: 2020 2020 2020 6966 2066 6f6c 6c6f 776c        if followl
-0000c930: 696e 6b73 3a0a 2020 2020 2020 2020 2020  inks:.          
-0000c940: 2020 6d65 7461 6461 7461 203d 205f 7333    metadata = _s3
-0000c950: 5f67 6574 5f6d 6574 6164 6174 6128 7333  _get_metadata(s3
-0000c960: 5f75 726c 290a 2020 2020 2020 2020 2020  _url).          
-0000c970: 2020 6966 206d 6574 6164 6174 6120 616e    if metadata an
-0000c980: 6420 2773 796d 6c69 6e6b 5f74 6f27 2069  d 'symlink_to' i
-0000c990: 6e20 6d65 7461 6461 7461 3a0a 2020 2020  n metadata:.    
-0000c9a0: 2020 2020 2020 2020 2020 2020 7333 5f75              s3_u
-0000c9b0: 726c 203d 206d 6574 6164 6174 615b 2773  rl = metadata['s
-0000c9c0: 796d 6c69 6e6b 5f74 6f27 5d0a 2020 2020  ymlink_to'].    
-0000c9d0: 2020 2020 6275 636b 6574 2c20 6b65 7920      bucket, key 
-0000c9e0: 3d20 7061 7273 655f 7333 5f75 726c 2873  = parse_s3_url(s
-0000c9f0: 335f 7572 6c29 0a20 2020 2020 2020 2069  3_url).        i
-0000ca00: 6620 6e6f 7420 6275 636b 6574 3a0a 2020  f not bucket:.  
-0000ca10: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0000ca20: 5333 4275 636b 6574 4e6f 7446 6f75 6e64  S3BucketNotFound
-0000ca30: 4572 726f 7228 2745 6d70 7479 2062 7563  Error('Empty buc
-0000ca40: 6b65 7420 6e61 6d65 3a20 2572 2720 2520  ket name: %r' % 
-0000ca50: 7333 5f75 726c 290a 2020 2020 2020 2020  s3_url).        
-0000ca60: 6966 206e 6f74 206b 6579 206f 7220 6b65  if not key or ke
-0000ca70: 792e 656e 6473 7769 7468 2827 2f27 293a  y.endswith('/'):
-0000ca80: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-0000ca90: 7365 2053 3349 7341 4469 7265 6374 6f72  se S3IsADirector
-0000caa0: 7945 7272 6f72 2827 4973 2061 2064 6972  yError('Is a dir
-0000cab0: 6563 746f 7279 3a20 2572 2720 2520 7333  ectory: %r' % s3
-0000cac0: 5f75 726c 290a 0a20 2020 2020 2020 2062  _url)..        b
-0000cad0: 7566 6665 7220 3d20 696f 2e42 7974 6573  uffer = io.Bytes
-0000cae0: 494f 2829 0a20 2020 2020 2020 2063 6c69  IO().        cli
-0000caf0: 656e 7420 3d20 6765 745f 7333 5f63 6c69  ent = get_s3_cli
-0000cb00: 656e 7428 290a 2020 2020 2020 2020 7769  ent().        wi
-0000cb10: 7468 2072 6169 7365 5f73 335f 6572 726f  th raise_s3_erro
-0000cb20: 7228 7333 5f75 726c 293a 0a20 2020 2020  r(s3_url):.     
-0000cb30: 2020 2020 2020 2063 6c69 656e 742e 646f         client.do
-0000cb40: 776e 6c6f 6164 5f66 696c 656f 626a 2862  wnload_fileobj(b
-0000cb50: 7563 6b65 742c 206b 6579 2c20 6275 6666  ucket, key, buff
-0000cb60: 6572 290a 2020 2020 2020 2020 6275 6666  er).        buff
-0000cb70: 6572 2e73 6565 6b28 3029 0a20 2020 2020  er.seek(0).     
-0000cb80: 2020 2072 6574 7572 6e20 6275 6666 6572     return buffer
-0000cb90: 0a0a 2020 2020 6465 6620 6861 7362 7563  ..    def hasbuc
-0000cba0: 6b65 7428 7365 6c66 2920 2d3e 2062 6f6f  ket(self) -> boo
-0000cbb0: 6c3a 0a20 2020 2020 2020 2027 2727 0a20  l:.        '''. 
-0000cbc0: 2020 2020 2020 2054 6573 7420 6966 2074         Test if t
-0000cbd0: 6865 2062 7563 6b65 7420 6f66 2073 335f  he bucket of s3_
-0000cbe0: 7572 6c20 6578 6973 7473 0a0a 2020 2020  url exists..    
-0000cbf0: 2020 2020 3a72 6574 7572 6e73 3a20 5472      :returns: Tr
-0000cc00: 7565 2069 6620 6275 636b 6574 206f 6620  ue if bucket of 
-0000cc10: 7333 5f75 726c 2065 6978 7374 732c 2065  s3_url eixsts, e
-0000cc20: 6c73 6520 4661 6c73 650a 2020 2020 2020  lse False.      
-0000cc30: 2020 2727 270a 2020 2020 2020 2020 6275    '''.        bu
-0000cc40: 636b 6574 2c20 5f20 3d20 7061 7273 655f  cket, _ = parse_
-0000cc50: 7333 5f75 726c 2873 656c 662e 7061 7468  s3_url(self.path
-0000cc60: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
-0000cc70: 2020 2020 2020 2020 6966 206e 6f74 2062          if not b
-0000cc80: 7563 6b65 743a 0a20 2020 2020 2020 2020  ucket:.         
-0000cc90: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
-0000cca0: 0a20 2020 2020 2020 2063 6c69 656e 7420  .        client 
-0000ccb0: 3d20 6765 745f 7333 5f63 6c69 656e 7428  = get_s3_client(
-0000ccc0: 290a 2020 2020 2020 2020 7472 793a 0a20  ).        try:. 
-0000ccd0: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
-0000cce0: 742e 6865 6164 5f62 7563 6b65 7428 4275  t.head_bucket(Bu
-0000ccf0: 636b 6574 3d62 7563 6b65 7429 0a20 2020  cket=bucket).   
-0000cd00: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
-0000cd10: 7074 696f 6e20 6173 2065 7272 6f72 3a0a  ption as error:.
-0000cd20: 2020 2020 2020 2020 2020 2020 6572 726f              erro
-0000cd30: 7220 3d20 7472 616e 736c 6174 655f 7333  r = translate_s3
-0000cd40: 5f65 7272 6f72 2865 7272 6f72 2c20 7365  _error(error, se
-0000cd50: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-0000cd60: 746f 636f 6c29 0a20 2020 2020 2020 2020  tocol).         
-0000cd70: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-0000cd80: 2865 7272 6f72 2c20 2853 3355 6e6b 6e6f  (error, (S3Unkno
-0000cd90: 776e 4572 726f 722c 2053 3343 6f6e 6669  wnError, S3Confi
-0000cda0: 6745 7272 6f72 2929 3a0a 2020 2020 2020  gError)):.      
-0000cdb0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0000cdc0: 6572 726f 720a 2020 2020 2020 2020 2020  error.          
-0000cdd0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-0000cde0: 6572 726f 722c 2053 3346 696c 654e 6f74  error, S3FileNot
-0000cdf0: 466f 756e 6445 7272 6f72 293a 0a20 2020  FoundError):.   
-0000ce00: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0000ce10: 7572 6e20 4661 6c73 650a 0a20 2020 2020  urn False..     
-0000ce20: 2020 2072 6574 7572 6e20 5472 7565 0a0a     return True..
-0000ce30: 2020 2020 6465 6620 6d6b 6469 7228 7365      def mkdir(se
-0000ce40: 6c66 2c20 6d6f 6465 3d30 6f37 3737 2c20  lf, mode=0o777, 
-0000ce50: 7061 7265 6e74 733a 2062 6f6f 6c20 3d20  parents: bool = 
-0000ce60: 4661 6c73 652c 2065 7869 7374 5f6f 6b3a  False, exist_ok:
-0000ce70: 2062 6f6f 6c20 3d20 4661 6c73 6529 3a0a   bool = False):.
-0000ce80: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-0000ce90: 2020 2020 4372 6561 7465 2061 6e20 7333      Create an s3
-0000cea0: 2064 6972 6563 746f 7279 2e0a 2020 2020   directory..    
-0000ceb0: 2020 2020 5075 7265 6c79 2063 7265 6174      Purely creat
-0000cec0: 696e 6720 6469 7265 6374 6f72 7920 6973  ing directory is
-0000ced0: 2069 6e76 616c 6964 2062 6563 6175 7365   invalid because
-0000cee0: 2069 7427 7320 756e 6176 6169 6c61 626c   it's unavailabl
-0000cef0: 6520 6f6e 204f 5353 2e0a 2020 2020 2020  e on OSS..      
-0000cf00: 2020 5468 6973 2066 756e 6374 696f 6e20    This function 
-0000cf10: 6973 2074 6f20 7465 7374 2074 6865 2074  is to test the t
-0000cf20: 6172 6765 7420 6275 636b 6574 2068 6176  arget bucket hav
-0000cf30: 6520 5752 4954 4520 6163 6365 7373 2e0a  e WRITE access..
-0000cf40: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-0000cf50: 6d6f 6465 3a20 6d6f 6465 2069 7320 6967  mode: mode is ig
-0000cf60: 6e6f 7265 642c 206f 6e6c 7920 6265 2063  nored, only be c
-0000cf70: 6f6d 7061 7469 626c 6520 7769 7468 2070  ompatible with p
-0000cf80: 6174 686c 6962 2e50 6174 680a 2020 2020  athlib.Path.    
-0000cf90: 2020 2020 3a70 6172 616d 2070 6172 656e      :param paren
-0000cfa0: 7473 3a20 7061 7265 6e74 7320 6973 2069  ts: parents is i
-0000cfb0: 676e 6f72 6564 2c20 6f6e 6c79 2062 6520  gnored, only be 
-0000cfc0: 636f 6d70 6174 6962 6c65 2077 6974 6820  compatible with 
-0000cfd0: 7061 7468 6c69 622e 5061 7468 0a20 2020  pathlib.Path.   
-0000cfe0: 2020 2020 203a 7061 7261 6d20 6578 6973       :param exis
-0000cff0: 745f 6f6b 3a20 4966 2046 616c 7365 2061  t_ok: If False a
-0000d000: 6e64 2074 6172 6765 7420 6469 7265 6374  nd target direct
-0000d010: 6f72 7920 6578 6973 7473 2c20 7261 6973  ory exists, rais
-0000d020: 6520 5333 4669 6c65 4578 6973 7473 4572  e S3FileExistsEr
-0000d030: 726f 720a 2020 2020 2020 2020 3a72 6169  ror.        :rai
-0000d040: 7365 733a 2053 3342 7563 6b65 744e 6f74  ses: S3BucketNot
-0000d050: 466f 756e 6445 7272 6f72 2c20 5333 4669  FoundError, S3Fi
-0000d060: 6c65 4578 6973 7473 4572 726f 720a 2020  leExistsError.  
-0000d070: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
-0000d080: 2020 6275 636b 6574 2c20 5f20 3d20 7061    bucket, _ = pa
-0000d090: 7273 655f 7333 5f75 726c 2873 656c 662e  rse_s3_url(self.
-0000d0a0: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
-0000d0b0: 6f6c 290a 2020 2020 2020 2020 6966 206e  ol).        if n
-0000d0c0: 6f74 2062 7563 6b65 743a 0a20 2020 2020  ot bucket:.     
-0000d0d0: 2020 2020 2020 2072 6169 7365 2053 3342         raise S3B
-0000d0e0: 7563 6b65 744e 6f74 466f 756e 6445 7272  ucketNotFoundErr
-0000d0f0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-0000d100: 2020 2020 2745 6d70 7479 2062 7563 6b65      'Empty bucke
-0000d110: 7420 6e61 6d65 3a20 2572 2720 2520 7365  t name: %r' % se
-0000d120: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-0000d130: 746f 636f 6c29 0a20 2020 2020 2020 2069  tocol).        i
-0000d140: 6620 6e6f 7420 7365 6c66 2e68 6173 6275  f not self.hasbu
-0000d150: 636b 6574 2829 3a0a 2020 2020 2020 2020  cket():.        
-0000d160: 2020 2020 7261 6973 6520 5333 4275 636b      raise S3Buck
-0000d170: 6574 4e6f 7446 6f75 6e64 4572 726f 7228  etNotFoundError(
-0000d180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d190: 2027 4e6f 2073 7563 6820 6275 636b 6574   'No such bucket
-0000d1a0: 3a20 2572 2720 2520 7365 6c66 2e70 6174  : %r' % self.pat
-0000d1b0: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-0000d1c0: 0a20 2020 2020 2020 2069 6620 6578 6973  .        if exis
-0000d1d0: 745f 6f6b 3a0a 2020 2020 2020 2020 2020  t_ok:.          
-0000d1e0: 2020 6966 2073 656c 662e 6973 5f66 696c    if self.is_fil
-0000d1f0: 6528 293a 0a20 2020 2020 2020 2020 2020  e():.           
-0000d200: 2020 2020 2072 6169 7365 2053 3346 696c       raise S3Fil
-0000d210: 6545 7869 7374 7345 7272 6f72 280a 2020  eExistsError(.  
-0000d220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d230: 2020 2746 696c 6520 6578 6973 7473 3a20    'File exists: 
-0000d240: 2572 2720 2520 7365 6c66 2e70 6174 685f  %r' % self.path_
-0000d250: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
-0000d260: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000d270: 6e0a 2020 2020 2020 2020 6966 2073 656c  n.        if sel
-0000d280: 662e 6578 6973 7473 2829 3a0a 2020 2020  f.exists():.    
-0000d290: 2020 2020 2020 2020 7261 6973 6520 5333          raise S3
-0000d2a0: 4669 6c65 4578 6973 7473 4572 726f 7228  FileExistsError(
-0000d2b0: 2746 696c 6520 6578 6973 7473 3a20 2572  'File exists: %r
-0000d2c0: 2720 2520 7365 6c66 2e70 6174 685f 7769  ' % self.path_wi
-0000d2d0: 7468 5f70 726f 746f 636f 6c29 0a0a 2020  th_protocol)..  
-0000d2e0: 2020 6465 6620 6d6f 7665 2873 656c 662c    def move(self,
-0000d2f0: 2064 7374 5f75 726c 3a20 5061 7468 4c69   dst_url: PathLi
-0000d300: 6b65 2920 2d3e 204e 6f6e 653a 0a20 2020  ke) -> None:.   
-0000d310: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
-0000d320: 204d 6f76 6520 6669 6c65 2f64 6972 6563   Move file/direc
-0000d330: 746f 7279 2070 6174 6820 6672 6f6d 2073  tory path from s
-0000d340: 7263 5f75 726c 2074 6f20 6473 745f 7572  rc_url to dst_ur
-0000d350: 6c0a 0a20 2020 2020 2020 203a 7061 7261  l..        :para
-0000d360: 6d20 6473 745f 7572 6c3a 2047 6976 656e  m dst_url: Given
-0000d370: 2064 6573 7469 6e61 7469 6f6e 2070 6174   destination pat
-0000d380: 680a 2020 2020 2020 2020 2727 270a 2020  h.        '''.  
-0000d390: 2020 2020 2020 666f 7220 7372 635f 6669        for src_fi
-0000d3a0: 6c65 5f70 6174 682c 2064 7374 5f66 696c  le_path, dst_fil
-0000d3b0: 655f 7061 7468 2069 6e20 5f73 335f 7363  e_path in _s3_sc
-0000d3c0: 616e 5f70 6169 7273 280a 2020 2020 2020  an_pairs(.      
-0000d3d0: 2020 2020 2020 2020 2020 7365 6c66 2e70            self.p
-0000d3e0: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-0000d3f0: 6c2c 2064 7374 5f75 726c 293a 0a20 2020  l, dst_url):.   
-0000d400: 2020 2020 2020 2020 2053 3350 6174 6828           S3Path(
-0000d410: 7372 635f 6669 6c65 5f70 6174 6829 2e72  src_file_path).r
-0000d420: 656e 616d 6528 6473 745f 6669 6c65 5f70  ename(dst_file_p
-0000d430: 6174 6829 0a0a 2020 2020 6465 6620 7265  ath)..    def re
-0000d440: 6d6f 7665 2873 656c 662c 206d 6973 7369  move(self, missi
-0000d450: 6e67 5f6f 6b3a 2062 6f6f 6c20 3d20 4661  ng_ok: bool = Fa
-0000d460: 6c73 6529 202d 3e20 4e6f 6e65 3a0a 2020  lse) -> None:.  
-0000d470: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
-0000d480: 2020 5265 6d6f 7665 2074 6865 2066 696c    Remove the fil
-0000d490: 6520 6f72 2064 6972 6563 746f 7279 206f  e or directory o
-0000d4a0: 6e20 7333 2c20 6073 333a 2f2f 6020 616e  n s3, `s3://` an
-0000d4b0: 6420 6073 333a 2f2f 6275 636b 6574 6020  d `s3://bucket` 
-0000d4c0: 6172 6520 6e6f 7420 7065 726d 6974 7465  are not permitte
-0000d4d0: 6420 746f 2072 656d 6f76 650a 0a20 2020  d to remove..   
-0000d4e0: 2020 2020 203a 7061 7261 6d20 6d69 7373       :param miss
-0000d4f0: 696e 675f 6f6b 3a20 6966 2046 616c 7365  ing_ok: if False
-0000d500: 2061 6e64 2074 6172 6765 7420 6669 6c65   and target file
-0000d510: 2f64 6972 6563 746f 7279 206e 6f74 2065  /directory not e
-0000d520: 7869 7374 732c 2072 6169 7365 2053 3346  xists, raise S3F
-0000d530: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
-0000d540: 0a20 2020 2020 2020 203a 7261 6973 6573  .        :raises
-0000d550: 3a20 5333 5065 726d 6973 7369 6f6e 4572  : S3PermissionEr
-0000d560: 726f 722c 2053 3346 696c 654e 6f74 466f  ror, S3FileNotFo
-0000d570: 756e 6445 7272 6f72 2c20 556e 7375 7070  undError, Unsupp
-0000d580: 6f72 7465 6445 7272 6f72 0a20 2020 2020  ortedError.     
-0000d590: 2020 2027 2727 0a20 2020 2020 2020 2062     '''.        b
-0000d5a0: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
-0000d5b0: 7365 5f73 335f 7572 6c28 7365 6c66 2e70  se_s3_url(self.p
-0000d5c0: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-0000d5d0: 6c29 0a20 2020 2020 2020 2069 6620 6e6f  l).        if no
-0000d5e0: 7420 6275 636b 6574 3a0a 2020 2020 2020  t bucket:.      
-0000d5f0: 2020 2020 2020 6966 206e 6f74 206b 6579        if not key
-0000d600: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000d610: 2020 7261 6973 6520 556e 7375 7070 6f72    raise Unsuppor
-0000d620: 7465 6445 7272 6f72 280a 2020 2020 2020  tedError(.      
-0000d630: 2020 2020 2020 2020 2020 2020 2020 2752                'R
-0000d640: 656d 6f76 6520 7768 6f6c 6520 7333 272c  emove whole s3',
-0000d650: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
-0000d660: 7072 6f74 6f63 6f6c 290a 2020 2020 2020  protocol).      
-0000d670: 2020 2020 2020 7261 6973 6520 5333 4275        raise S3Bu
-0000d680: 636b 6574 4e6f 7446 6f75 6e64 4572 726f  cketNotFoundErro
-0000d690: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-0000d6a0: 2020 2027 456d 7074 7920 6275 636b 6574     'Empty bucket
-0000d6b0: 206e 616d 653a 2025 7227 2025 2073 656c   name: %r' % sel
-0000d6c0: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
-0000d6d0: 6f63 6f6c 290a 2020 2020 2020 2020 6966  ocol).        if
-0000d6e0: 206e 6f74 206b 6579 3a0a 2020 2020 2020   not key:.      
-0000d6f0: 2020 2020 2020 7261 6973 6520 556e 7375        raise Unsu
-0000d700: 7070 6f72 7465 6445 7272 6f72 2827 5265  pportedError('Re
-0000d710: 6d6f 7665 2062 7563 6b65 7427 2c20 7365  move bucket', se
-0000d720: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-0000d730: 746f 636f 6c29 0a20 2020 2020 2020 2069  tocol).        i
-0000d740: 6620 6e6f 7420 7365 6c66 2e65 7869 7374  f not self.exist
-0000d750: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-0000d760: 2069 6620 6d69 7373 696e 675f 6f6b 3a0a   if missing_ok:.
-0000d770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d780: 7265 7475 726e 0a20 2020 2020 2020 2020  return.         
-0000d790: 2020 2072 6169 7365 2053 3346 696c 654e     raise S3FileN
-0000d7a0: 6f74 466f 756e 6445 7272 6f72 280a 2020  otFoundError(.  
-0000d7b0: 2020 2020 2020 2020 2020 2020 2020 274e                'N
-0000d7c0: 6f20 7375 6368 2066 696c 6520 6f72 2064  o such file or d
-0000d7d0: 6972 6563 746f 7279 3a20 2572 2720 2520  irectory: %r' % 
-0000d7e0: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
-0000d7f0: 726f 746f 636f 6c29 0a0a 2020 2020 2020  rotocol)..      
-0000d800: 2020 636c 6965 6e74 203d 2067 6574 5f73    client = get_s
-0000d810: 335f 636c 6965 6e74 2829 0a20 2020 2020  3_client().     
-0000d820: 2020 2077 6974 6820 7261 6973 655f 7333     with raise_s3
-0000d830: 5f65 7272 6f72 2873 656c 662e 7061 7468  _error(self.path
-0000d840: 5f77 6974 685f 7072 6f74 6f63 6f6c 293a  _with_protocol):
-0000d850: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000d860: 7365 6c66 2e69 735f 6669 6c65 2829 3a0a  self.is_file():.
-0000d870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d880: 636c 6965 6e74 2e64 656c 6574 655f 6f62  client.delete_ob
-0000d890: 6a65 6374 2842 7563 6b65 743d 6275 636b  ject(Bucket=buck
-0000d8a0: 6574 2c20 4b65 793d 6b65 7929 0a20 2020  et, Key=key).   
-0000d8b0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0000d8c0: 7572 6e0a 2020 2020 2020 2020 2020 2020  urn.            
-0000d8d0: 7072 6566 6978 203d 205f 6265 636f 6d65  prefix = _become
-0000d8e0: 5f70 7265 6669 7828 6b65 7929 0a20 2020  _prefix(key).   
-0000d8f0: 2020 2020 2020 2020 2074 6f74 616c 5f63           total_c
-0000d900: 6f75 6e74 2c20 6572 726f 725f 636f 756e  ount, error_coun
-0000d910: 7420 3d20 302c 2030 0a20 2020 2020 2020  t = 0, 0.       
-0000d920: 2020 2020 2066 6f72 2072 6573 7020 696e       for resp in
-0000d930: 205f 6c69 7374 5f6f 626a 6563 7473 5f72   _list_objects_r
-0000d940: 6563 7572 7369 7665 2863 6c69 656e 742c  ecursive(client,
-0000d950: 2062 7563 6b65 742c 2070 7265 6669 7829   bucket, prefix)
-0000d960: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000d970: 2020 6966 2027 436f 6e74 656e 7473 2720    if 'Contents' 
-0000d980: 696e 2072 6573 703a 0a20 2020 2020 2020  in resp:.       
-0000d990: 2020 2020 2020 2020 2020 2020 206b 6579               key
-0000d9a0: 7320 3d20 5b0a 2020 2020 2020 2020 2020  s = [.          
-0000d9b0: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
-0000d9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d9d0: 2020 2020 2020 2020 2020 2020 274b 6579              'Key
-0000d9e0: 273a 2063 6f6e 7465 6e74 5b27 4b65 7927  ': content['Key'
-0000d9f0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0000da00: 2020 2020 2020 2020 2020 7d20 666f 7220            } for 
-0000da10: 636f 6e74 656e 7420 696e 2072 6573 705b  content in resp[
-0000da20: 2743 6f6e 7465 6e74 7327 5d0a 2020 2020  'Contents'].    
-0000da30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000da40: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0000da50: 2020 2020 2020 746f 7461 6c5f 636f 756e        total_coun
-0000da60: 7420 2b3d 206c 656e 286b 6579 7329 0a20  t += len(keys). 
+00005620: 6579 3d27 7333 5f66 696c 656c 696b 655f  ey='s3_filelike_
+00005630: 636c 6965 6e74 272c 0a20 2020 2020 2020  client',.       
+00005640: 2070 726f 6669 6c65 5f6e 616d 653d 7333   profile_name=s3
+00005650: 5f75 726c 2e5f 7072 6f66 696c 655f 6e61  _url._profile_na
+00005660: 6d65 290a 2020 2020 7265 7475 726e 2053  me).    return S
+00005670: 3353 6861 7265 4361 6368 6552 6561 6465  3ShareCacheReade
+00005680: 7228 0a20 2020 2020 2020 2062 7563 6b65  r(.        bucke
+00005690: 742c 0a20 2020 2020 2020 206b 6579 2c0a  t,.        key,.
+000056a0: 2020 2020 2020 2020 6361 6368 655f 6b65          cache_ke
+000056b0: 793d 6361 6368 655f 6b65 792c 0a20 2020  y=cache_key,.   
+000056c0: 2020 2020 2073 335f 636c 6965 6e74 3d63       s3_client=c
+000056d0: 6c69 656e 742c 0a20 2020 2020 2020 206d  lient,.        m
+000056e0: 6178 5f72 6574 7269 6573 3d6d 6178 5f72  ax_retries=max_r
+000056f0: 6574 7269 6573 2c0a 2020 2020 2020 2020  etries,.        
+00005700: 6d61 785f 776f 726b 6572 733d 6d61 785f  max_workers=max_
+00005710: 636f 6e63 7572 7265 6e63 792c 0a20 2020  concurrency,.   
+00005720: 2020 2020 2062 6c6f 636b 5f73 697a 653d       block_size=
+00005730: 6d61 785f 626c 6f63 6b5f 7369 7a65 290a  max_block_size).
+00005740: 0a0a 405f 7333 5f62 696e 6172 795f 6d6f  ..@_s3_binary_mo
+00005750: 6465 0a64 6566 2073 335f 7069 7065 5f6f  de.def s3_pipe_o
+00005760: 7065 6e28 0a20 2020 2020 2020 2073 335f  pen(.        s3_
+00005770: 7572 6c3a 2050 6174 684c 696b 652c 0a20  url: PathLike,. 
+00005780: 2020 2020 2020 206d 6f64 653a 2073 7472         mode: str
+00005790: 2c0a 2020 2020 2020 2020 666f 6c6c 6f77  ,.        follow
+000057a0: 6c69 6e6b 733a 2062 6f6f 6c20 3d20 4661  links: bool = Fa
+000057b0: 6c73 652c 0a20 2020 2020 2020 202a 2c0a  lse,.        *,.
+000057c0: 2020 2020 2020 2020 6a6f 696e 5f74 6872          join_thr
+000057d0: 6561 643a 2062 6f6f 6c20 3d20 5472 7565  ead: bool = True
+000057e0: 2920 2d3e 2053 3350 6970 6548 616e 646c  ) -> S3PipeHandl
+000057f0: 6572 3a0a 2020 2020 2727 274f 7065 6e20  er:.    '''Open 
+00005800: 6120 6173 796e 6368 726f 6e6f 7573 2072  a asynchronous r
+00005810: 6561 642d 7772 6974 6520 7265 6164 6572  ead-write reader
+00005820: 202f 2077 7269 7465 722c 2074 6f20 7375   / writer, to su
+00005830: 7070 6f72 7420 6661 7374 2073 6571 7565  pport fast seque
+00005840: 6e74 6961 6c20 7265 6164 202f 2077 7269  ntial read / wri
+00005850: 7465 0a0a 2020 2020 2e2e 206e 6f74 6520  te..    .. note 
+00005860: 3a3a 0a0a 2020 2020 2020 2020 5573 6572  ::..        User
+00005870: 2073 686f 756c 6420 6d61 6b65 2073 7572   should make sur
+00005880: 6520 7468 6174 2072 6561 6465 7220 2f20  e that reader / 
+00005890: 7772 6974 6572 2061 7265 2063 6c6f 7365  writer are close
+000058a0: 6420 636f 7272 6563 746c 790a 0a20 2020  d correctly..   
+000058b0: 2020 2020 2053 7570 706f 7274 7320 636f       Supports co
+000058c0: 6e74 6578 7420 6d61 6e61 6765 720a 0a20  ntext manager.. 
+000058d0: 2020 2020 2020 2057 6865 6e20 6a6f 696e         When join
+000058e0: 5f74 6872 6561 6420 6973 2046 616c 7365  _thread is False
+000058f0: 2c20 7768 696c 6520 7468 6520 6669 6c65  , while the file
+00005900: 2068 616e 646c 6520 6172 6520 636c 6f73   handle are clos
+00005910: 696e 672c 2074 6869 7320 6675 6e63 7469  ing, this functi
+00005920: 6f6e 2077 696c 6c20 6e6f 7420 7761 6974  on will not wait
+00005930: 2075 6e74 696c 2074 6865 2061 7379 6e63   until the async
+00005940: 6872 6f6e 6f75 7320 7772 6974 696e 6720  hronous writing 
+00005950: 6669 6e69 7368 6573 3b0a 2020 2020 2020  finishes;.      
+00005960: 2020 4661 6c73 6520 646f 6573 6e27 7420    False doesn't 
+00005970: 6166 6665 6374 2072 6561 642d 6861 6e64  affect read-hand
+00005980: 6c65 2c20 6275 7420 7468 6973 2063 616e  le, but this can
+00005990: 2073 7065 6564 2075 7020 7772 6974 652d   speed up write-
+000059a0: 6861 6e64 6c65 2062 6563 6175 7365 2066  handle because f
+000059b0: 696c 6520 7769 6c6c 2062 6520 7772 6974  ile will be writ
+000059c0: 7465 6e20 6173 796e 6368 726f 6e6f 7573  ten asynchronous
+000059d0: 6c79 2e0a 2020 2020 2020 2020 4275 7420  ly..        But 
+000059e0: 6173 796e 6368 726f 6e6f 7573 2062 6568  asynchronous beh
+000059f0: 6176 696f 7572 2063 616e 2067 7561 7261  aviour can guara
+00005a00: 6e74 6565 2074 6865 2066 696c 6520 6172  ntee the file ar
+00005a10: 6520 7375 6363 6573 7366 756c 6c79 2077  e successfully w
+00005a20: 7269 7474 656e 2c20 616e 6420 6672 6571  ritten, and freq
+00005a30: 7565 6e74 2065 7865 6375 7469 6f6e 206d  uent execution m
+00005a40: 6179 2063 6175 7365 2074 6872 6561 6420  ay cause thread 
+00005a50: 616e 6420 6669 6c65 2068 616e 646c 6520  and file handle 
+00005a60: 6578 6861 7573 7469 6f6e 0a0a 2020 2020  exhaustion..    
+00005a70: 3a70 6172 616d 206d 6f64 653a 204d 6f64  :param mode: Mod
+00005a80: 6520 746f 206f 7065 6e20 6669 6c65 2c20  e to open file, 
+00005a90: 6569 7468 6572 2022 7262 2220 6f72 2022  either "rb" or "
+00005aa0: 7762 220a 2020 2020 3a70 6172 616d 206a  wb".    :param j
+00005ab0: 6f69 6e5f 7468 7265 6164 3a20 4966 2077  oin_thread: If w
+00005ac0: 6169 7420 6166 7465 7220 6675 6e63 7469  ait after functi
+00005ad0: 6f6e 2065 7865 6375 7469 6f6e 2075 6e74  on execution unt
+00005ae0: 696c 2073 3320 6669 6e69 7368 6573 2077  il s3 finishes w
+00005af0: 7269 7469 6e67 0a20 2020 203a 7265 7475  riting.    :retu
+00005b00: 726e 733a 2041 6e20 6f70 656e 6564 2042  rns: An opened B
+00005b10: 7566 6665 7265 6452 6561 6465 7220 2f20  ufferedReader / 
+00005b20: 4275 6666 6572 6564 5772 6974 6572 206f  BufferedWriter o
+00005b30: 626a 6563 740a 2020 2020 2727 270a 2020  bject.    '''.  
+00005b40: 2020 6966 206d 6f64 6520 6e6f 7420 696e    if mode not in
+00005b50: 2028 2772 6227 2c20 2777 6227 293a 0a20   ('rb', 'wb'):. 
+00005b60: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+00005b70: 7565 4572 726f 7228 2775 6e61 6363 6570  ueError('unaccep
+00005b80: 7461 626c 6520 6d6f 6465 3a20 2572 2720  table mode: %r' 
+00005b90: 2520 6d6f 6465 2920 2023 2070 7261 676d  % mode)  # pragm
+00005ba0: 613a 206e 6f20 636f 7665 720a 0a20 2020  a: no cover..   
+00005bb0: 2069 6620 6d6f 6465 5b30 5d20 3d3d 2027   if mode[0] == '
+00005bc0: 7227 2061 6e64 206e 6f74 2053 3350 6174  r' and not S3Pat
+00005bd0: 6828 7333 5f75 726c 292e 6973 5f66 696c  h(s3_url).is_fil
+00005be0: 6528 293a 0a20 2020 2020 2020 2072 6169  e():.        rai
+00005bf0: 7365 2053 3346 696c 654e 6f74 466f 756e  se S3FileNotFoun
+00005c00: 6445 7272 6f72 2827 4e6f 2073 7563 6820  dError('No such 
+00005c10: 6669 6c65 3a20 2572 2720 2520 7333 5f75  file: %r' % s3_u
+00005c20: 726c 290a 0a20 2020 2073 335f 7572 6c20  rl)..    s3_url 
+00005c30: 3d20 5333 5061 7468 2873 335f 7572 6c29  = S3Path(s3_url)
+00005c40: 0a20 2020 2069 6620 666f 6c6c 6f77 6c69  .    if followli
+00005c50: 6e6b 733a 0a20 2020 2020 2020 2074 7279  nks:.        try
+00005c60: 3a0a 2020 2020 2020 2020 2020 2020 7333  :.            s3
+00005c70: 5f75 726c 203d 2073 335f 7572 6c2e 7265  _url = s3_url.re
+00005c80: 6164 6c69 6e6b 2829 0a20 2020 2020 2020  adlink().       
+00005c90: 2065 7863 6570 7420 5333 4e6f 7441 4c69   except S3NotALi
+00005ca0: 6e6b 4572 726f 723a 0a20 2020 2020 2020  nkError:.       
+00005cb0: 2020 2020 2070 6173 730a 0a20 2020 2062       pass..    b
+00005cc0: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
+00005cd0: 7365 5f73 335f 7572 6c28 7333 5f75 726c  se_s3_url(s3_url
+00005ce0: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+00005cf0: 636f 6c29 0a20 2020 2063 6f6e 6669 6720  col).    config 
+00005d00: 3d20 626f 746f 636f 7265 2e63 6f6e 6669  = botocore.confi
+00005d10: 672e 436f 6e66 6967 286d 6178 5f70 6f6f  g.Config(max_poo
+00005d20: 6c5f 636f 6e6e 6563 7469 6f6e 733d 6d61  l_connections=ma
+00005d30: 785f 706f 6f6c 5f63 6f6e 6e65 6374 696f  x_pool_connectio
+00005d40: 6e73 290a 2020 2020 636c 6965 6e74 203d  ns).    client =
+00005d50: 2067 6574 5f73 335f 636c 6965 6e74 280a   get_s3_client(.
+00005d60: 2020 2020 2020 2020 636f 6e66 6967 3d63          config=c
+00005d70: 6f6e 6669 672c 0a20 2020 2020 2020 2063  onfig,.        c
+00005d80: 6163 6865 5f6b 6579 3d27 7333 5f66 696c  ache_key='s3_fil
+00005d90: 656c 696b 655f 636c 6965 6e74 272c 0a20  elike_client',. 
+00005da0: 2020 2020 2020 2070 726f 6669 6c65 5f6e         profile_n
+00005db0: 616d 653d 7333 5f75 726c 2e5f 7072 6f66  ame=s3_url._prof
+00005dc0: 696c 655f 6e61 6d65 290a 2020 2020 7265  ile_name).    re
+00005dd0: 7475 726e 2053 3350 6970 6548 616e 646c  turn S3PipeHandl
+00005de0: 6572 280a 2020 2020 2020 2020 6275 636b  er(.        buck
+00005df0: 6574 2c20 6b65 792c 206d 6f64 652c 2073  et, key, mode, s
+00005e00: 335f 636c 6965 6e74 3d63 6c69 656e 742c  3_client=client,
+00005e10: 206a 6f69 6e5f 7468 7265 6164 3d6a 6f69   join_thread=joi
+00005e20: 6e5f 7468 7265 6164 290a 0a0a 405f 7333  n_thread)...@_s3
+00005e30: 5f62 696e 6172 795f 6d6f 6465 0a64 6566  _binary_mode.def
+00005e40: 2073 335f 6361 6368 6564 5f6f 7065 6e28   s3_cached_open(
+00005e50: 0a20 2020 2020 2020 2073 335f 7572 6c3a  .        s3_url:
+00005e60: 2050 6174 684c 696b 652c 0a20 2020 2020   PathLike,.     
+00005e70: 2020 206d 6f64 653a 2073 7472 2c0a 2020     mode: str,.  
+00005e80: 2020 2020 2020 666f 6c6c 6f77 6c69 6e6b        followlink
+00005e90: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
+00005ea0: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
+00005eb0: 2020 2020 6361 6368 655f 7061 7468 3a20      cache_path: 
+00005ec0: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
+00005ed0: 4e6f 6e65 2920 2d3e 2053 3343 6163 6865  None) -> S3Cache
+00005ee0: 6448 616e 646c 6572 3a0a 2020 2020 2727  dHandler:.    ''
+00005ef0: 274f 7065 6e20 6120 6c6f 6361 6c2d 6361  'Open a local-ca
+00005f00: 6368 6520 6669 6c65 2072 6561 6465 7220  che file reader 
+00005f10: 2f20 7772 6974 6572 2c20 666f 7220 6672  / writer, for fr
+00005f20: 6571 7565 6e74 2072 616e 646f 6d20 7265  equent random re
+00005f30: 6164 202f 2077 7269 7465 0a0a 2020 2020  ad / write..    
+00005f40: 2e2e 206e 6f74 6520 3a3a 0a0a 2020 2020  .. note ::..    
+00005f50: 2020 2020 5573 6572 2073 686f 756c 6420      User should 
+00005f60: 6d61 6b65 2073 7572 6520 7468 6174 2072  make sure that r
+00005f70: 6561 6465 7220 2f20 7772 6974 6572 2061  eader / writer a
+00005f80: 7265 2063 6c6f 7365 6420 636f 7272 6563  re closed correc
+00005f90: 746c 790a 0a20 2020 2020 2020 2053 7570  tly..        Sup
+00005fa0: 706f 7274 7320 636f 6e74 6578 7420 6d61  ports context ma
+00005fb0: 6e61 6765 720a 0a20 2020 2020 2020 2063  nager..        c
+00005fc0: 6163 6865 5f70 6174 6820 6361 6e20 7370  ache_path can sp
+00005fd0: 6563 6966 7920 7468 6520 7061 7468 206f  ecify the path o
+00005fe0: 6620 6361 6368 6520 6669 6c65 2e20 5065  f cache file. Pe
+00005ff0: 7266 6f72 6d61 6e63 6520 636f 756c 6420  rformance could 
+00006000: 6265 2062 6574 7465 7220 6966 2063 6163  be better if cac
+00006010: 6865 2066 696c 6520 7061 7468 2069 7320  he file path is 
+00006020: 6f6e 2073 7364 206f 7220 746d 7066 730a  on ssd or tmpfs.
+00006030: 0a20 2020 203a 7061 7261 6d20 6d6f 6465  .    :param mode
+00006040: 3a20 4d6f 6465 2074 6f20 6f70 656e 2066  : Mode to open f
+00006050: 696c 652c 2063 6f75 6c64 2062 6520 6f6e  ile, could be on
+00006060: 6520 6f66 2022 7262 222c 2022 7762 2220  e of "rb", "wb" 
+00006070: 6f72 2022 6162 220a 2020 2020 3a70 6172  or "ab".    :par
+00006080: 616d 2063 6163 6865 5f70 6174 683a 2063  am cache_path: c
+00006090: 6163 6865 2066 696c 6520 7061 7468 0a20  ache file path. 
+000060a0: 2020 203a 7265 7475 726e 733a 2041 6e20     :returns: An 
+000060b0: 6f70 656e 6564 2042 7566 6665 7265 6452  opened BufferedR
+000060c0: 6561 6465 7220 2f20 4275 6666 6572 6564  eader / Buffered
+000060d0: 5772 6974 6572 206f 626a 6563 740a 2020  Writer object.  
+000060e0: 2020 2727 270a 2020 2020 6966 206d 6f64    '''.    if mod
+000060f0: 6520 6e6f 7420 696e 2028 2772 6227 2c20  e not in ('rb', 
+00006100: 2777 6227 2c20 2761 6227 2c20 2772 622b  'wb', 'ab', 'rb+
+00006110: 272c 2027 7762 2b27 2c20 2761 622b 2729  ', 'wb+', 'ab+')
+00006120: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+00006130: 5661 6c75 6545 7272 6f72 2827 756e 6163  ValueError('unac
+00006140: 6365 7074 6162 6c65 206d 6f64 653a 2025  ceptable mode: %
+00006150: 7227 2025 206d 6f64 6529 2020 2320 7072  r' % mode)  # pr
+00006160: 6167 6d61 3a20 6e6f 2063 6f76 6572 0a20  agma: no cover. 
+00006170: 2020 2073 335f 7572 6c20 3d20 5333 5061     s3_url = S3Pa
+00006180: 7468 2873 335f 7572 6c29 0a20 2020 2069  th(s3_url).    i
+00006190: 6620 666f 6c6c 6f77 6c69 6e6b 733a 0a20  f followlinks:. 
+000061a0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+000061b0: 2020 2020 2020 2020 7333 5f75 726c 203d          s3_url =
+000061c0: 2073 335f 7572 6c2e 7265 6164 6c69 6e6b   s3_url.readlink
+000061d0: 2829 0a20 2020 2020 2020 2065 7863 6570  ().        excep
+000061e0: 7420 5333 4e6f 7441 4c69 6e6b 4572 726f  t S3NotALinkErro
+000061f0: 723a 0a20 2020 2020 2020 2020 2020 2070  r:.            p
+00006200: 6173 730a 0a20 2020 2062 7563 6b65 742c  ass..    bucket,
+00006210: 206b 6579 203d 2070 6172 7365 5f73 335f   key = parse_s3_
+00006220: 7572 6c28 7333 5f75 726c 2e70 6174 685f  url(s3_url.path_
+00006230: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
+00006240: 2020 2063 6f6e 6669 6720 3d20 626f 746f     config = boto
+00006250: 636f 7265 2e63 6f6e 6669 672e 436f 6e66  core.config.Conf
+00006260: 6967 286d 6178 5f70 6f6f 6c5f 636f 6e6e  ig(max_pool_conn
+00006270: 6563 7469 6f6e 733d 6d61 785f 706f 6f6c  ections=max_pool
+00006280: 5f63 6f6e 6e65 6374 696f 6e73 290a 2020  _connections).  
+00006290: 2020 636c 6965 6e74 203d 2067 6574 5f73    client = get_s
+000062a0: 335f 636c 6965 6e74 280a 2020 2020 2020  3_client(.      
+000062b0: 2020 636f 6e66 6967 3d63 6f6e 6669 672c    config=config,
+000062c0: 0a20 2020 2020 2020 2063 6163 6865 5f6b  .        cache_k
+000062d0: 6579 3d27 7333 5f66 696c 656c 696b 655f  ey='s3_filelike_
+000062e0: 636c 6965 6e74 272c 0a20 2020 2020 2020  client',.       
+000062f0: 2070 726f 6669 6c65 5f6e 616d 653d 7333   profile_name=s3
+00006300: 5f75 726c 2e5f 7072 6f66 696c 655f 6e61  _url._profile_na
+00006310: 6d65 290a 2020 2020 7265 7475 726e 2053  me).    return S
+00006320: 3343 6163 6865 6448 616e 646c 6572 280a  3CachedHandler(.
+00006330: 2020 2020 2020 2020 6275 636b 6574 2c20          bucket, 
+00006340: 6b65 792c 206d 6f64 652c 2073 335f 636c  key, mode, s3_cl
+00006350: 6965 6e74 3d63 6c69 656e 742c 2063 6163  ient=client, cac
+00006360: 6865 5f70 6174 683d 6361 6368 655f 7061  he_path=cache_pa
+00006370: 7468 290a 0a0a 405f 7333 5f62 696e 6172  th)...@_s3_binar
+00006380: 795f 6d6f 6465 0a64 6566 2073 335f 6275  y_mode.def s3_bu
+00006390: 6666 6572 6564 5f6f 7065 6e28 0a20 2020  ffered_open(.   
+000063a0: 2020 2020 2073 335f 7572 6c3a 2050 6174       s3_url: Pat
+000063b0: 684c 696b 652c 0a20 2020 2020 2020 206d  hLike,.        m
+000063c0: 6f64 653a 2073 7472 2c0a 2020 2020 2020  ode: str,.      
+000063d0: 2020 666f 6c6c 6f77 6c69 6e6b 733a 2062    followlinks: b
+000063e0: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+000063f0: 2020 2020 202a 2c0a 2020 2020 2020 2020       *,.        
+00006400: 6d61 785f 636f 6e63 7572 7265 6e63 793a  max_concurrency:
+00006410: 204f 7074 696f 6e61 6c5b 696e 745d 203d   Optional[int] =
+00006420: 204e 6f6e 652c 0a20 2020 2020 2020 206d   None,.        m
+00006430: 6178 5f62 7566 6665 725f 7369 7a65 3a20  ax_buffer_size: 
+00006440: 696e 7420 3d20 4445 4641 554c 545f 4d41  int = DEFAULT_MA
+00006450: 585f 4255 4646 4552 5f53 495a 452c 0a20  X_BUFFER_SIZE,. 
+00006460: 2020 2020 2020 2066 6f72 7761 7264 5f72         forward_r
+00006470: 6174 696f 3a20 4f70 7469 6f6e 616c 5b66  atio: Optional[f
+00006480: 6c6f 6174 5d20 3d20 4e6f 6e65 2c0a 2020  loat] = None,.  
+00006490: 2020 2020 2020 626c 6f63 6b5f 7369 7a65        block_size
+000064a0: 3a20 696e 7420 3d20 4445 4641 554c 545f  : int = DEFAULT_
+000064b0: 424c 4f43 4b5f 5349 5a45 2c0a 2020 2020  BLOCK_SIZE,.    
+000064c0: 2020 2020 6c69 6d69 7465 645f 7365 656b      limited_seek
+000064d0: 6162 6c65 3a20 626f 6f6c 203d 2046 616c  able: bool = Fal
+000064e0: 7365 2c0a 2020 2020 2020 2020 6275 6666  se,.        buff
+000064f0: 6572 6564 3a20 626f 6f6c 203d 2054 7275  ered: bool = Tru
+00006500: 652c 0a20 2020 2020 2020 2073 6861 7265  e,.        share
+00006510: 5f63 6163 6865 5f6b 6579 3a20 4f70 7469  _cache_key: Opti
+00006520: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
+00006530: 2c0a 2020 2020 2020 2020 6361 6368 655f  ,.        cache_
+00006540: 7061 7468 3a20 4f70 7469 6f6e 616c 5b73  path: Optional[s
+00006550: 7472 5d20 3d20 4e6f 6e65 0a29 202d 3e20  tr] = None.) -> 
+00006560: 556e 696f 6e5b 5333 5072 6566 6574 6368  Union[S3Prefetch
+00006570: 5265 6164 6572 2c20 5333 4275 6666 6572  Reader, S3Buffer
+00006580: 6564 5772 6974 6572 2c20 696f 2e42 7566  edWriter, io.Buf
+00006590: 6665 7265 6452 6561 6465 722c 2069 6f2e  feredReader, io.
+000065a0: 0a20 2020 2020 2020 2020 2020 4275 6666  .           Buff
+000065b0: 6572 6564 5772 6974 6572 2c20 5333 4d65  eredWriter, S3Me
+000065c0: 6d6f 7279 4861 6e64 6c65 725d 3a0a 2020  moryHandler]:.  
+000065d0: 2020 2727 274f 7065 6e20 616e 2061 7379    '''Open an asy
+000065e0: 6e63 6872 6f6e 6f75 7320 7072 6566 6574  nchronous prefet
+000065f0: 6368 2072 6561 6465 722c 2074 6f20 7375  ch reader, to su
+00006600: 7070 6f72 7420 6661 7374 2073 6571 7565  pport fast seque
+00006610: 6e74 6961 6c20 7265 6164 0a0a 2020 2020  ntial read..    
+00006620: 2e2e 206e 6f74 6520 3a3a 0a0a 2020 2020  .. note ::..    
+00006630: 2020 2020 5573 6572 2073 686f 756c 6420      User should 
+00006640: 6d61 6b65 2073 7572 6520 7468 6174 2072  make sure that r
+00006650: 6561 6465 7220 2f20 7772 6974 6572 2061  eader / writer a
+00006660: 7265 2063 6c6f 7365 6420 636f 7272 6563  re closed correc
+00006670: 746c 790a 0a20 2020 2020 2020 2053 7570  tly..        Sup
+00006680: 706f 7274 7320 636f 6e74 6578 7420 6d61  ports context ma
+00006690: 6e61 6765 720a 0a20 2020 2020 2020 2053  nager..        S
+000066a0: 6f6d 6520 7061 7261 6d65 7465 7220 7365  ome parameter se
+000066b0: 7474 696e 6720 6d61 7920 7065 7266 6f72  tting may perfor
+000066c0: 6d20 7765 6c6c 3a20 6d61 785f 636f 6e63  m well: max_conc
+000066d0: 7572 7265 6e63 793d 3130 206f 7220 3230  urrency=10 or 20
+000066e0: 2c20 6d61 785f 626c 6f63 6b5f 7369 7a65  , max_block_size
+000066f0: 3d38 206f 7220 3136 204d 422c 2064 6566  =8 or 16 MB, def
+00006700: 6175 6c74 2076 616c 7565 204e 6f6e 6520  ault value None 
+00006710: 6d65 616e 7320 7573 696e 6720 676c 6f62  means using glob
+00006720: 616c 2074 6872 6561 6420 706f 6f6c 0a0a  al thread pool..
+00006730: 2020 2020 3a70 6172 616d 206d 6178 5f63      :param max_c
+00006740: 6f6e 6375 7272 656e 6379 3a20 4d61 7820  oncurrency: Max 
+00006750: 646f 776e 6c6f 6164 2074 6872 6561 6420  download thread 
+00006760: 6e75 6d62 6572 2c20 4e6f 6e65 2062 7920  number, None by 
+00006770: 6465 6661 756c 740a 2020 2020 3a70 6172  default.    :par
+00006780: 616d 206d 6178 5f62 7566 6665 725f 7369  am max_buffer_si
+00006790: 7a65 3a20 4d61 7820 6361 6368 6564 2062  ze: Max cached b
+000067a0: 7566 6665 7220 7369 7a65 2069 6e20 6d65  uffer size in me
+000067b0: 6d6f 7279 2c20 3132 384d 4220 6279 2064  mory, 128MB by d
+000067c0: 6566 6175 6c74 0a20 2020 203a 7061 7261  efault.    :para
+000067d0: 6d20 626c 6f63 6b5f 7369 7a65 3a20 5369  m block_size: Si
+000067e0: 7a65 206f 6620 7369 6e67 6c65 2062 6c6f  ze of single blo
+000067f0: 636b 2c20 384d 4220 6279 2064 6566 6175  ck, 8MB by defau
+00006800: 6c74 2e20 4561 6368 2062 6c6f 636b 2077  lt. Each block w
+00006810: 696c 6c20 6265 2075 706c 6f61 6465 6420  ill be uploaded 
+00006820: 6f72 2064 6f77 6e6c 6f61 6465 6420 6279  or downloaded by
+00006830: 2073 696e 676c 6520 7468 7265 6164 2e0a   single thread..
+00006840: 2020 2020 3a70 6172 616d 206c 696d 6974      :param limit
+00006850: 6564 5f73 6565 6b61 626c 653a 2049 6620  ed_seekable: If 
+00006860: 7772 6974 652d 6861 6e64 6c65 2073 7570  write-handle sup
+00006870: 706f 7274 7320 6c69 6d69 7465 6420 7365  ports limited se
+00006880: 656b 2028 626f 7468 2066 696c 6520 6865  ek (both file he
+00006890: 6164 2070 6172 7420 616e 6420 7461 696c  ad part and tail
+000068a0: 2070 6172 7420 6361 6e20 7365 656b 2062   part can seek b
+000068b0: 6c6f 636b 5f73 697a 6529 2e20 4e6f 7465  lock_size). Note
+000068c0: 733a 2054 6869 7320 7061 7261 6d65 7465  s: This paramete
+000068d0: 7220 6172 6520 7661 6c69 6420 6f6e 6c79  r are valid only
+000068e0: 2066 6f72 2077 7269 7465 2d68 616e 646c   for write-handl
+000068f0: 652e 2052 6561 642d 6861 6e64 6c65 2073  e. Read-handle s
+00006900: 7570 706f 7274 2061 7262 6974 7261 7279  upport arbitrary
+00006910: 2073 6565 6b0a 2020 2020 3a72 6574 7572   seek.    :retur
+00006920: 6e73 3a20 416e 206f 7065 6e65 6420 5333  ns: An opened S3
+00006930: 5072 6566 6574 6368 5265 6164 6572 206f  PrefetchReader o
+00006940: 626a 6563 740a 2020 2020 3a72 6169 7365  bject.    :raise
+00006950: 733a 2053 3346 696c 654e 6f74 466f 756e  s: S3FileNotFoun
+00006960: 6445 7272 6f72 0a20 2020 2027 2727 0a20  dError.    '''. 
+00006970: 2020 2069 6620 6d6f 6465 206e 6f74 2069     if mode not i
+00006980: 6e20 2827 7262 272c 2027 7762 272c 2027  n ('rb', 'wb', '
+00006990: 6162 272c 2027 7262 2b27 2c20 2777 622b  ab', 'rb+', 'wb+
+000069a0: 272c 2027 6162 2b27 293a 0a20 2020 2020  ', 'ab+'):.     
+000069b0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+000069c0: 726f 7228 2775 6e61 6363 6570 7461 626c  ror('unacceptabl
+000069d0: 6520 6d6f 6465 3a20 2572 2720 2520 6d6f  e mode: %r' % mo
+000069e0: 6465 290a 2020 2020 7333 5f75 726c 203d  de).    s3_url =
+000069f0: 2053 3350 6174 6828 7333 5f75 726c 290a   S3Path(s3_url).
+00006a00: 2020 2020 6966 2066 6f6c 6c6f 776c 696e      if followlin
+00006a10: 6b73 3a0a 2020 2020 2020 2020 7472 793a  ks:.        try:
+00006a20: 0a20 2020 2020 2020 2020 2020 2073 335f  .            s3_
+00006a30: 7572 6c20 3d20 7333 5f75 726c 2e72 6561  url = s3_url.rea
+00006a40: 646c 696e 6b28 290a 2020 2020 2020 2020  dlink().        
+00006a50: 6578 6365 7074 2053 334e 6f74 414c 696e  except S3NotALin
+00006a60: 6b45 7272 6f72 3a0a 2020 2020 2020 2020  kError:.        
+00006a70: 2020 2020 7061 7373 0a0a 2020 2020 6275      pass..    bu
+00006a80: 636b 6574 2c20 6b65 7920 3d20 7061 7273  cket, key = pars
+00006a90: 655f 7333 5f75 726c 2873 335f 7572 6c2e  e_s3_url(s3_url.
+00006aa0: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
+00006ab0: 6f6c 290a 2020 2020 636f 6e66 6967 203d  ol).    config =
+00006ac0: 2062 6f74 6f63 6f72 652e 636f 6e66 6967   botocore.config
+00006ad0: 2e43 6f6e 6669 6728 6d61 785f 706f 6f6c  .Config(max_pool
+00006ae0: 5f63 6f6e 6e65 6374 696f 6e73 3d6d 6178  _connections=max
+00006af0: 5f70 6f6f 6c5f 636f 6e6e 6563 7469 6f6e  _pool_connection
+00006b00: 7329 0a20 2020 2063 6c69 656e 7420 3d20  s).    client = 
+00006b10: 6765 745f 7333 5f63 6c69 656e 7428 0a20  get_s3_client(. 
+00006b20: 2020 2020 2020 2063 6f6e 6669 673d 636f         config=co
+00006b30: 6e66 6967 2c0a 2020 2020 2020 2020 6361  nfig,.        ca
+00006b40: 6368 655f 6b65 793d 2773 335f 6669 6c65  che_key='s3_file
+00006b50: 6c69 6b65 5f63 6c69 656e 7427 2c0a 2020  like_client',.  
+00006b60: 2020 2020 2020 7072 6f66 696c 655f 6e61        profile_na
+00006b70: 6d65 3d73 335f 7572 6c2e 5f70 726f 6669  me=s3_url._profi
+00006b80: 6c65 5f6e 616d 6529 0a0a 2020 2020 6966  le_name)..    if
+00006b90: 2027 6127 2069 6e20 6d6f 6465 206f 7220   'a' in mode or 
+00006ba0: 272b 2720 696e 206d 6f64 653a 0a20 2020  '+' in mode:.   
+00006bb0: 2020 2020 2069 6620 6361 6368 655f 7061       if cache_pa
+00006bc0: 7468 2069 7320 4e6f 6e65 3a0a 2020 2020  th is None:.    
+00006bd0: 2020 2020 2020 2020 7265 7475 726e 2053          return S
+00006be0: 334d 656d 6f72 7948 616e 646c 6572 2862  3MemoryHandler(b
+00006bf0: 7563 6b65 742c 206b 6579 2c20 6d6f 6465  ucket, key, mode
+00006c00: 2c20 7333 5f63 6c69 656e 743d 636c 6965  , s3_client=clie
+00006c10: 6e74 290a 2020 2020 2020 2020 7265 7475  nt).        retu
+00006c20: 726e 2053 3343 6163 6865 6448 616e 646c  rn S3CachedHandl
+00006c30: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+00006c40: 6275 636b 6574 2c20 6b65 792c 206d 6f64  bucket, key, mod
+00006c50: 652c 2073 335f 636c 6965 6e74 3d63 6c69  e, s3_client=cli
+00006c60: 656e 742c 2063 6163 6865 5f70 6174 683d  ent, cache_path=
+00006c70: 6361 6368 655f 7061 7468 290a 0a20 2020  cache_path)..   
+00006c80: 2069 6620 6d6f 6465 203d 3d20 2772 6227   if mode == 'rb'
+00006c90: 3a0a 2020 2020 2020 2020 2320 4120 726f  :.        # A ro
+00006ca0: 7567 6820 636f 6e76 6572 7369 6f6e 2061  ugh conversion a
+00006cb0: 6c67 6f72 6974 686d 2074 6f20 616c 6967  lgorithm to alig
+00006cc0: 6e20 3220 7479 7065 7320 6f66 2052 6561  n 2 types of Rea
+00006cd0: 6465 7220 2f20 5772 6974 6572 2070 6172  der / Writer par
+00006ce0: 616d 6574 6572 730a 2020 2020 2020 2020  ameters.        
+00006cf0: 2320 544f 444f 3a20 4f70 7469 6d69 7a65  # TODO: Optimize
+00006d00: 2074 6865 2063 6f6e 7665 7273 696f 6e20   the conversion 
+00006d10: 616c 676f 7269 7468 6d0a 2020 2020 2020  algorithm.      
+00006d20: 2020 626c 6f63 6b5f 6361 7061 6369 7479    block_capacity
+00006d30: 203d 206d 6178 5f62 7566 6665 725f 7369   = max_buffer_si
+00006d40: 7a65 202f 2f20 626c 6f63 6b5f 7369 7a65  ze // block_size
+00006d50: 0a20 2020 2020 2020 2069 6620 666f 7277  .        if forw
+00006d60: 6172 645f 7261 7469 6f20 6973 204e 6f6e  ard_ratio is Non
+00006d70: 653a 0a20 2020 2020 2020 2020 2020 2062  e:.            b
+00006d80: 6c6f 636b 5f66 6f72 7761 7264 203d 204e  lock_forward = N
+00006d90: 6f6e 650a 2020 2020 2020 2020 656c 7365  one.        else
+00006da0: 3a0a 2020 2020 2020 2020 2020 2020 626c  :.            bl
+00006db0: 6f63 6b5f 666f 7277 6172 6420 3d20 6d61  ock_forward = ma
+00006dc0: 7828 696e 7428 626c 6f63 6b5f 6361 7061  x(int(block_capa
+00006dd0: 6369 7479 202a 2066 6f72 7761 7264 5f72  city * forward_r
+00006de0: 6174 696f 292c 2031 290a 2020 2020 2020  atio), 1).      
+00006df0: 2020 6966 2073 6861 7265 5f63 6163 6865    if share_cache
+00006e00: 5f6b 6579 2069 7320 6e6f 7420 4e6f 6e65  _key is not None
+00006e10: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00006e20: 6164 6572 203d 2053 3353 6861 7265 4361  ader = S3ShareCa
+00006e30: 6368 6552 6561 6465 7228 0a20 2020 2020  cheReader(.     
+00006e40: 2020 2020 2020 2020 2020 2062 7563 6b65             bucke
+00006e50: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+00006e60: 2020 206b 6579 2c0a 2020 2020 2020 2020     key,.        
+00006e70: 2020 2020 2020 2020 6361 6368 655f 6b65          cache_ke
+00006e80: 793d 7368 6172 655f 6361 6368 655f 6b65  y=share_cache_ke
+00006e90: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
+00006ea0: 2020 2073 335f 636c 6965 6e74 3d63 6c69     s3_client=cli
+00006eb0: 656e 742c 0a20 2020 2020 2020 2020 2020  ent,.           
+00006ec0: 2020 2020 206d 6178 5f72 6574 7269 6573       max_retries
+00006ed0: 3d6d 6178 5f72 6574 7269 6573 2c0a 2020  =max_retries,.  
+00006ee0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+00006ef0: 785f 776f 726b 6572 733d 6d61 785f 636f  x_workers=max_co
+00006f00: 6e63 7572 7265 6e63 792c 0a20 2020 2020  ncurrency,.     
+00006f10: 2020 2020 2020 2020 2020 2062 6c6f 636b             block
+00006f20: 5f73 697a 653d 626c 6f63 6b5f 7369 7a65  _size=block_size
+00006f30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00006f40: 2020 626c 6f63 6b5f 666f 7277 6172 643d    block_forward=
+00006f50: 626c 6f63 6b5f 666f 7277 6172 6429 0a20  block_forward). 
+00006f60: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00006f70: 2020 2020 2020 2020 2072 6561 6465 7220           reader 
+00006f80: 3d20 5333 5072 6566 6574 6368 5265 6164  = S3PrefetchRead
+00006f90: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+00006fa0: 2020 2020 6275 636b 6574 2c0a 2020 2020      bucket,.    
+00006fb0: 2020 2020 2020 2020 2020 2020 6b65 792c              key,
+00006fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006fd0: 2073 335f 636c 6965 6e74 3d63 6c69 656e   s3_client=clien
+00006fe0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+00006ff0: 2020 206d 6178 5f72 6574 7269 6573 3d6d     max_retries=m
+00007000: 6178 5f72 6574 7269 6573 2c0a 2020 2020  ax_retries,.    
+00007010: 2020 2020 2020 2020 2020 2020 6d61 785f              max_
+00007020: 776f 726b 6572 733d 6d61 785f 636f 6e63  workers=max_conc
+00007030: 7572 7265 6e63 792c 0a20 2020 2020 2020  urrency,.       
+00007040: 2020 2020 2020 2020 2062 6c6f 636b 5f63           block_c
+00007050: 6170 6163 6974 793d 626c 6f63 6b5f 6361  apacity=block_ca
+00007060: 7061 6369 7479 2c0a 2020 2020 2020 2020  pacity,.        
+00007070: 2020 2020 2020 2020 626c 6f63 6b5f 666f          block_fo
+00007080: 7277 6172 643d 626c 6f63 6b5f 666f 7277  rward=block_forw
+00007090: 6172 642c 0a20 2020 2020 2020 2020 2020  ard,.           
+000070a0: 2020 2020 2062 6c6f 636b 5f73 697a 653d       block_size=
+000070b0: 626c 6f63 6b5f 7369 7a65 290a 2020 2020  block_size).    
+000070c0: 2020 2020 6966 2062 7566 6665 7265 643a      if buffered:
+000070d0: 0a20 2020 2020 2020 2020 2020 2072 6561  .            rea
+000070e0: 6465 7220 3d20 696f 2e42 7566 6665 7265  der = io.Buffere
+000070f0: 6452 6561 6465 7228 7265 6164 6572 2920  dReader(reader) 
+00007100: 2023 2070 7974 7970 653a 2064 6973 6162   # pytype: disab
+00007110: 6c65 3d77 726f 6e67 2d61 7267 2d74 7970  le=wrong-arg-typ
+00007120: 6573 0a20 2020 2020 2020 2072 6574 7572  es.        retur
+00007130: 6e20 7265 6164 6572 0a0a 2020 2020 6966  n reader..    if
+00007140: 206c 696d 6974 6564 5f73 6565 6b61 626c   limited_seekabl
+00007150: 653a 0a20 2020 2020 2020 2077 7269 7465  e:.        write
+00007160: 7220 3d20 5333 4c69 6d69 7465 6453 6565  r = S3LimitedSee
+00007170: 6b61 626c 6557 7269 7465 7228 0a20 2020  kableWriter(.   
+00007180: 2020 2020 2020 2020 2062 7563 6b65 742c           bucket,
+00007190: 0a20 2020 2020 2020 2020 2020 206b 6579  .            key
+000071a0: 2c0a 2020 2020 2020 2020 2020 2020 7333  ,.            s3
+000071b0: 5f63 6c69 656e 743d 636c 6965 6e74 2c0a  _client=client,.
+000071c0: 2020 2020 2020 2020 2020 2020 6d61 785f              max_
+000071d0: 776f 726b 6572 733d 6d61 785f 636f 6e63  workers=max_conc
+000071e0: 7572 7265 6e63 792c 0a20 2020 2020 2020  urrency,.       
+000071f0: 2020 2020 206d 6178 5f62 7566 6665 725f       max_buffer_
+00007200: 7369 7a65 3d6d 6178 5f62 7566 6665 725f  size=max_buffer_
+00007210: 7369 7a65 2c0a 2020 2020 2020 2020 2020  size,.          
+00007220: 2020 626c 6f63 6b5f 7369 7a65 3d62 6c6f    block_size=blo
+00007230: 636b 5f73 697a 6529 0a20 2020 2065 6c73  ck_size).    els
+00007240: 653a 0a20 2020 2020 2020 2077 7269 7465  e:.        write
+00007250: 7220 3d20 5333 4275 6666 6572 6564 5772  r = S3BufferedWr
+00007260: 6974 6572 280a 2020 2020 2020 2020 2020  iter(.          
+00007270: 2020 6275 636b 6574 2c0a 2020 2020 2020    bucket,.      
+00007280: 2020 2020 2020 6b65 792c 0a20 2020 2020        key,.     
+00007290: 2020 2020 2020 2073 335f 636c 6965 6e74         s3_client
+000072a0: 3d63 6c69 656e 742c 0a20 2020 2020 2020  =client,.       
+000072b0: 2020 2020 206d 6178 5f77 6f72 6b65 7273       max_workers
+000072c0: 3d6d 6178 5f63 6f6e 6375 7272 656e 6379  =max_concurrency
+000072d0: 2c0a 2020 2020 2020 2020 2020 2020 6d61  ,.            ma
+000072e0: 785f 6275 6666 6572 5f73 697a 653d 6d61  x_buffer_size=ma
+000072f0: 785f 6275 6666 6572 5f73 697a 652c 0a20  x_buffer_size,. 
+00007300: 2020 2020 2020 2020 2020 2062 6c6f 636b             block
+00007310: 5f73 697a 653d 626c 6f63 6b5f 7369 7a65  _size=block_size
+00007320: 290a 2020 2020 6966 2062 7566 6665 7265  ).    if buffere
+00007330: 643a 0a20 2020 2020 2020 2077 7269 7465  d:.        write
+00007340: 7220 3d20 696f 2e42 7566 6665 7265 6457  r = io.BufferedW
+00007350: 7269 7465 7228 7772 6974 6572 2920 2023  riter(writer)  #
+00007360: 2070 7974 7970 653a 2064 6973 6162 6c65   pytype: disable
+00007370: 3d77 726f 6e67 2d61 7267 2d74 7970 6573  =wrong-arg-types
+00007380: 0a20 2020 2072 6574 7572 6e20 7772 6974  .    return writ
+00007390: 6572 0a0a 0a40 5f73 335f 6269 6e61 7279  er...@_s3_binary
+000073a0: 5f6d 6f64 650a 6465 6620 7333 5f6d 656d  _mode.def s3_mem
+000073b0: 6f72 795f 6f70 656e 280a 2020 2020 2020  ory_open(.      
+000073c0: 2020 7333 5f75 726c 3a20 5061 7468 4c69    s3_url: PathLi
+000073d0: 6b65 2c20 6d6f 6465 3a20 7374 722c 0a20  ke, mode: str,. 
+000073e0: 2020 2020 2020 2066 6f6c 6c6f 776c 696e         followlin
+000073f0: 6b73 3a20 626f 6f6c 203d 2046 616c 7365  ks: bool = False
+00007400: 2920 2d3e 2053 334d 656d 6f72 7948 616e  ) -> S3MemoryHan
+00007410: 646c 6572 3a0a 2020 2020 2727 274f 7065  dler:.    '''Ope
+00007420: 6e20 6120 6d65 6d6f 7279 2d63 6163 6865  n a memory-cache
+00007430: 2066 696c 6520 7265 6164 6572 202f 2077   file reader / w
+00007440: 7269 7465 722c 2066 6f72 2066 7265 7175  riter, for frequ
+00007450: 656e 7420 7261 6e64 6f6d 2072 6561 6420  ent random read 
+00007460: 2f20 7772 6974 650a 0a20 2020 202e 2e20  / write..    .. 
+00007470: 6e6f 7465 203a 3a0a 0a20 2020 2020 2020  note ::..       
+00007480: 2055 7365 7220 7368 6f75 6c64 206d 616b   User should mak
+00007490: 6520 7375 7265 2074 6861 7420 7265 6164  e sure that read
+000074a0: 6572 202f 2077 7269 7465 7220 6172 6520  er / writer are 
+000074b0: 636c 6f73 6564 2063 6f72 7265 6374 6c79  closed correctly
+000074c0: 0a0a 2020 2020 2020 2020 5375 7070 6f72  ..        Suppor
+000074d0: 7473 2063 6f6e 7465 7874 206d 616e 6167  ts context manag
+000074e0: 6572 0a0a 2020 2020 3a70 6172 616d 206d  er..    :param m
+000074f0: 6f64 653a 204d 6f64 6520 746f 206f 7065  ode: Mode to ope
+00007500: 6e20 6669 6c65 2c20 636f 756c 6420 6265  n file, could be
+00007510: 206f 6e65 206f 6620 2272 6222 2c20 2277   one of "rb", "w
+00007520: 6222 2c20 2261 6222 2c20 2272 622b 222c  b", "ab", "rb+",
+00007530: 2022 7762 2b22 206f 7220 2261 622b 220a   "wb+" or "ab+".
+00007540: 2020 2020 3a72 6574 7572 6e73 3a20 416e      :returns: An
+00007550: 206f 7065 6e65 6420 4275 6666 6572 6564   opened Buffered
+00007560: 5265 6164 6572 202f 2042 7566 6665 7265  Reader / Buffere
+00007570: 6457 7269 7465 7220 6f62 6a65 6374 0a20  dWriter object. 
+00007580: 2020 2027 2727 0a20 2020 2069 6620 6d6f     '''.    if mo
+00007590: 6465 206e 6f74 2069 6e20 2827 7262 272c  de not in ('rb',
+000075a0: 2027 7762 272c 2027 6162 272c 2027 7262   'wb', 'ab', 'rb
+000075b0: 2b27 2c20 2777 622b 272c 2027 6162 2b27  +', 'wb+', 'ab+'
+000075c0: 293a 0a20 2020 2020 2020 2072 6169 7365  ):.        raise
+000075d0: 2056 616c 7565 4572 726f 7228 2775 6e61   ValueError('una
+000075e0: 6363 6570 7461 626c 6520 6d6f 6465 3a20  cceptable mode: 
+000075f0: 2572 2720 2520 6d6f 6465 290a 2020 2020  %r' % mode).    
+00007600: 7333 5f75 726c 203d 2053 3350 6174 6828  s3_url = S3Path(
+00007610: 7333 5f75 726c 290a 2020 2020 6966 2066  s3_url).    if f
+00007620: 6f6c 6c6f 776c 696e 6b73 3a0a 2020 2020  ollowlinks:.    
+00007630: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00007640: 2020 2020 2073 335f 7572 6c20 3d20 7333       s3_url = s3
+00007650: 5f75 726c 2e72 6561 646c 696e 6b28 290a  _url.readlink().
+00007660: 2020 2020 2020 2020 6578 6365 7074 2053          except S
+00007670: 334e 6f74 414c 696e 6b45 7272 6f72 3a0a  3NotALinkError:.
+00007680: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+00007690: 0a0a 2020 2020 6275 636b 6574 2c20 6b65  ..    bucket, ke
+000076a0: 7920 3d20 7061 7273 655f 7333 5f75 726c  y = parse_s3_url
+000076b0: 2873 335f 7572 6c2e 7061 7468 5f77 6974  (s3_url.path_wit
+000076c0: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
+000076d0: 636f 6e66 6967 203d 2062 6f74 6f63 6f72  config = botocor
+000076e0: 652e 636f 6e66 6967 2e43 6f6e 6669 6728  e.config.Config(
+000076f0: 6d61 785f 706f 6f6c 5f63 6f6e 6e65 6374  max_pool_connect
+00007700: 696f 6e73 3d6d 6178 5f70 6f6f 6c5f 636f  ions=max_pool_co
+00007710: 6e6e 6563 7469 6f6e 7329 0a20 2020 2063  nnections).    c
+00007720: 6c69 656e 7420 3d20 6765 745f 7333 5f63  lient = get_s3_c
+00007730: 6c69 656e 7428 0a20 2020 2020 2020 2063  lient(.        c
+00007740: 6f6e 6669 673d 636f 6e66 6967 2c0a 2020  onfig=config,.  
+00007750: 2020 2020 2020 6361 6368 655f 6b65 793d        cache_key=
+00007760: 2773 335f 6669 6c65 6c69 6b65 5f63 6c69  's3_filelike_cli
+00007770: 656e 7427 2c0a 2020 2020 2020 2020 7072  ent',.        pr
+00007780: 6f66 696c 655f 6e61 6d65 3d73 335f 7572  ofile_name=s3_ur
+00007790: 6c2e 5f70 726f 6669 6c65 5f6e 616d 6529  l._profile_name)
+000077a0: 0a20 2020 2072 6574 7572 6e20 5333 4d65  .    return S3Me
+000077b0: 6d6f 7279 4861 6e64 6c65 7228 6275 636b  moryHandler(buck
+000077c0: 6574 2c20 6b65 792c 206d 6f64 652c 2073  et, key, mode, s
+000077d0: 335f 636c 6965 6e74 3d63 6c69 656e 7429  3_client=client)
+000077e0: 0a0a 0a73 335f 6f70 656e 203d 2073 335f  ...s3_open = s3_
+000077f0: 6275 6666 6572 6564 5f6f 7065 6e0a 0a0a  buffered_open...
+00007800: 6465 6620 7333 5f64 6f77 6e6c 6f61 6428  def s3_download(
+00007810: 0a20 2020 2020 2020 2073 7263 5f75 726c  .        src_url
+00007820: 3a20 5061 7468 4c69 6b65 2c0a 2020 2020  : PathLike,.    
+00007830: 2020 2020 6473 745f 7572 6c3a 2050 6174      dst_url: Pat
+00007840: 684c 696b 652c 0a20 2020 2020 2020 2066  hLike,.        f
+00007850: 6f6c 6c6f 776c 696e 6b73 3a20 626f 6f6c  ollowlinks: bool
+00007860: 203d 2046 616c 7365 2c0a 2020 2020 2020   = False,.      
+00007870: 2020 6361 6c6c 6261 636b 3a20 4f70 7469    callback: Opti
+00007880: 6f6e 616c 5b43 616c 6c61 626c 655b 5b69  onal[Callable[[i
+00007890: 6e74 5d2c 204e 6f6e 655d 5d20 3d20 4e6f  nt], None]] = No
+000078a0: 6e65 2920 2d3e 204e 6f6e 653a 0a20 2020  ne) -> None:.   
+000078b0: 2027 2727 0a20 2020 2044 6f77 6e6c 6f61   '''.    Downloa
+000078c0: 6473 2061 2066 696c 6520 6672 6f6d 2073  ds a file from s
+000078d0: 3320 746f 206c 6f63 616c 2066 696c 6573  3 to local files
+000078e0: 7973 7465 6d2e 0a20 2020 203a 7061 7261  ystem..    :para
+000078f0: 6d20 7372 635f 7572 6c3a 2073 6f75 7263  m src_url: sourc
+00007900: 6520 7333 2070 6174 680a 2020 2020 3a70  e s3 path.    :p
+00007910: 6172 616d 2064 7374 5f75 726c 3a20 7461  aram dst_url: ta
+00007920: 7267 6574 2066 7320 7061 7468 0a20 2020  rget fs path.   
+00007930: 203a 7061 7261 6d20 6361 6c6c 6261 636b   :param callback
+00007940: 3a20 4361 6c6c 6564 2070 6572 696f 6469  : Called periodi
+00007950: 6361 6c6c 7920 6475 7269 6e67 2063 6f70  cally during cop
+00007960: 792c 2061 6e64 2074 6865 2069 6e70 7574  y, and the input
+00007970: 2070 6172 616d 6574 6572 2069 7320 7468   parameter is th
+00007980: 6520 6461 7461 2073 697a 6520 2869 6e20  e data size (in 
+00007990: 6279 7465 7329 206f 6620 636f 7079 2073  bytes) of copy s
+000079a0: 696e 6365 2074 6865 206c 6173 7420 6361  ince the last ca
+000079b0: 6c6c 0a20 2020 2027 2727 0a20 2020 2073  ll.    '''.    s
+000079c0: 7263 5f75 726c 203d 2053 3350 6174 6828  rc_url = S3Path(
+000079d0: 7372 635f 7572 6c29 0a20 2020 2069 6620  src_url).    if 
+000079e0: 666f 6c6c 6f77 6c69 6e6b 733a 0a20 2020  followlinks:.   
+000079f0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00007a00: 2020 2020 2020 7372 635f 7572 6c20 3d20        src_url = 
+00007a10: 7372 635f 7572 6c2e 7265 6164 6c69 6e6b  src_url.readlink
+00007a20: 2829 0a20 2020 2020 2020 2065 7863 6570  ().        excep
+00007a30: 7420 5333 4e6f 7441 4c69 6e6b 4572 726f  t S3NotALinkErro
+00007a40: 723a 0a20 2020 2020 2020 2020 2020 2070  r:.            p
+00007a50: 6173 730a 2020 2020 7372 635f 6275 636b  ass.    src_buck
+00007a60: 6574 2c20 7372 635f 6b65 7920 3d20 7061  et, src_key = pa
+00007a70: 7273 655f 7333 5f75 726c 2873 7263 5f75  rse_s3_url(src_u
+00007a80: 726c 2e70 6174 685f 7769 7468 5f70 726f  rl.path_with_pro
+00007a90: 746f 636f 6c29 0a20 2020 2069 6620 6e6f  tocol).    if no
+00007aa0: 7420 7372 635f 6275 636b 6574 3a0a 2020  t src_bucket:.  
+00007ab0: 2020 2020 2020 7261 6973 6520 5333 4275        raise S3Bu
+00007ac0: 636b 6574 4e6f 7446 6f75 6e64 4572 726f  cketNotFoundErro
+00007ad0: 7228 0a20 2020 2020 2020 2020 2020 2027  r(.            '
+00007ae0: 456d 7074 7920 6275 636b 6574 206e 616d  Empty bucket nam
+00007af0: 653a 2025 7227 2025 2073 7263 5f75 726c  e: %r' % src_url
+00007b00: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+00007b10: 636f 6c29 0a0a 2020 2020 6966 206e 6f74  col)..    if not
+00007b20: 2073 7263 5f75 726c 2e65 7869 7374 7328   src_url.exists(
+00007b30: 293a 0a20 2020 2020 2020 2072 6169 7365  ):.        raise
+00007b40: 2053 3346 696c 654e 6f74 466f 756e 6445   S3FileNotFoundE
+00007b50: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+00007b60: 2020 2746 696c 6520 6e6f 7420 666f 756e    'File not foun
+00007b70: 643a 2025 7227 2025 2073 7263 5f75 726c  d: %r' % src_url
+00007b80: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+00007b90: 636f 6c29 0a0a 2020 2020 6966 206e 6f74  col)..    if not
+00007ba0: 2073 7263 5f75 726c 2e69 735f 6669 6c65   src_url.is_file
+00007bb0: 2829 3a0a 2020 2020 2020 2020 7261 6973  ():.        rais
+00007bc0: 6520 5333 4973 4144 6972 6563 746f 7279  e S3IsADirectory
+00007bd0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+00007be0: 2020 2027 4973 2061 2064 6972 6563 746f     'Is a directo
+00007bf0: 7279 3a20 2572 2720 2520 7372 635f 7572  ry: %r' % src_ur
+00007c00: 6c2e 7061 7468 5f77 6974 685f 7072 6f74  l.path_with_prot
+00007c10: 6f63 6f6c 290a 0a20 2020 2064 7374 5f75  ocol)..    dst_u
+00007c20: 726c 203d 2066 7370 6174 6828 6473 745f  rl = fspath(dst_
+00007c30: 7572 6c29 0a20 2020 2069 6620 6e6f 7420  url).    if not 
+00007c40: 6473 745f 7572 6c20 6f72 2064 7374 5f75  dst_url or dst_u
+00007c50: 726c 2e65 6e64 7377 6974 6828 272f 2729  rl.endswith('/')
+00007c60: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+00007c70: 5333 4973 4144 6972 6563 746f 7279 4572  S3IsADirectoryEr
+00007c80: 726f 7228 2749 7320 6120 6469 7265 6374  ror('Is a direct
+00007c90: 6f72 793a 2025 7227 2025 2064 7374 5f75  ory: %r' % dst_u
+00007ca0: 726c 290a 0a20 2020 2064 7374 5f64 6972  rl)..    dst_dir
+00007cb0: 6563 746f 7279 203d 206f 732e 7061 7468  ectory = os.path
+00007cc0: 2e64 6972 6e61 6d65 2864 7374 5f75 726c  .dirname(dst_url
+00007cd0: 290a 2020 2020 6966 2064 7374 5f64 6972  ).    if dst_dir
+00007ce0: 6563 746f 7279 2021 3d20 2727 3a0a 2020  ectory != '':.  
+00007cf0: 2020 2020 2020 6f73 2e6d 616b 6564 6972        os.makedir
+00007d00: 7328 6473 745f 6469 7265 6374 6f72 792c  s(dst_directory,
+00007d10: 2065 7869 7374 5f6f 6b3d 5472 7565 290a   exist_ok=True).
+00007d20: 0a20 2020 2063 6c69 656e 7420 3d20 6765  .    client = ge
+00007d30: 745f 7333 5f63 6c69 656e 7428 7072 6f66  t_s3_client(prof
+00007d40: 696c 655f 6e61 6d65 3d73 7263 5f75 726c  ile_name=src_url
+00007d50: 2e5f 7072 6f66 696c 655f 6e61 6d65 290a  ._profile_name).
+00007d60: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00007d70: 2063 6c69 656e 742e 646f 776e 6c6f 6164   client.download
+00007d80: 5f66 696c 6528 7372 635f 6275 636b 6574  _file(src_bucket
+00007d90: 2c20 7372 635f 6b65 792c 2064 7374 5f75  , src_key, dst_u
+00007da0: 726c 2c20 4361 6c6c 6261 636b 3d63 616c  rl, Callback=cal
+00007db0: 6c62 6163 6b29 0a20 2020 2065 7863 6570  lback).    excep
+00007dc0: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+00007dd0: 7272 6f72 3a20 2023 2070 7261 676d 613a  rror:  # pragma:
+00007de0: 206e 6f20 636f 7665 720a 2020 2020 2020   no cover.      
+00007df0: 2020 6572 726f 7220 3d20 7472 616e 736c    error = transl
+00007e00: 6174 655f 6673 5f65 7272 6f72 2865 7272  ate_fs_error(err
+00007e10: 6f72 2c20 6473 745f 7572 6c29 0a20 2020  or, dst_url).   
+00007e20: 2020 2020 2065 7272 6f72 203d 2074 7261       error = tra
+00007e30: 6e73 6c61 7465 5f73 335f 6572 726f 7228  nslate_s3_error(
+00007e40: 6572 726f 722c 2073 7263 5f75 726c 2e70  error, src_url.p
+00007e50: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+00007e60: 6c29 0a20 2020 2020 2020 2072 6169 7365  l).        raise
+00007e70: 2065 7272 6f72 0a0a 0a64 6566 2073 335f   error...def s3_
+00007e80: 7570 6c6f 6164 280a 2020 2020 2020 2020  upload(.        
+00007e90: 7372 635f 7572 6c3a 2050 6174 684c 696b  src_url: PathLik
+00007ea0: 652c 0a20 2020 2020 2020 2064 7374 5f75  e,.        dst_u
+00007eb0: 726c 3a20 5061 7468 4c69 6b65 2c0a 2020  rl: PathLike,.  
+00007ec0: 2020 2020 2020 6361 6c6c 6261 636b 3a20        callback: 
+00007ed0: 4f70 7469 6f6e 616c 5b43 616c 6c61 626c  Optional[Callabl
+00007ee0: 655b 5b69 6e74 5d2c 204e 6f6e 655d 5d20  e[[int], None]] 
+00007ef0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00007f00: 2a2a 6b77 6172 6773 2920 2d3e 204e 6f6e  **kwargs) -> Non
+00007f10: 653a 0a20 2020 2027 2727 0a20 2020 2055  e:.    '''.    U
+00007f20: 706c 6f61 6473 2061 2066 696c 6520 6672  ploads a file fr
+00007f30: 6f6d 206c 6f63 616c 2066 696c 6573 7973  om local filesys
+00007f40: 7465 6d20 746f 2073 332e 0a20 2020 203a  tem to s3..    :
+00007f50: 7061 7261 6d20 7372 635f 7572 6c3a 2073  param src_url: s
+00007f60: 6f75 7263 6520 6673 2070 6174 680a 2020  ource fs path.  
+00007f70: 2020 3a70 6172 616d 2064 7374 5f75 726c    :param dst_url
+00007f80: 3a20 7461 7267 6574 2073 3320 7061 7468  : target s3 path
+00007f90: 0a20 2020 203a 7061 7261 6d20 6361 6c6c  .    :param call
+00007fa0: 6261 636b 3a20 4361 6c6c 6564 2070 6572  back: Called per
+00007fb0: 696f 6469 6361 6c6c 7920 6475 7269 6e67  iodically during
+00007fc0: 2063 6f70 792c 2061 6e64 2074 6865 2069   copy, and the i
+00007fd0: 6e70 7574 2070 6172 616d 6574 6572 2069  nput parameter i
+00007fe0: 7320 7468 6520 6461 7461 2073 697a 6520  s the data size 
+00007ff0: 2869 6e20 6279 7465 7329 206f 6620 636f  (in bytes) of co
+00008000: 7079 2073 696e 6365 2074 6865 206c 6173  py since the las
+00008010: 7420 6361 6c6c 0a20 2020 2027 2727 0a20  t call.    '''. 
+00008020: 2020 2064 7374 5f62 7563 6b65 742c 2064     dst_bucket, d
+00008030: 7374 5f6b 6579 203d 2070 6172 7365 5f73  st_key = parse_s
+00008040: 335f 7572 6c28 6473 745f 7572 6c29 0a20  3_url(dst_url). 
+00008050: 2020 2069 6620 6e6f 7420 6473 745f 6275     if not dst_bu
+00008060: 636b 6574 3a0a 2020 2020 2020 2020 7261  cket:.        ra
+00008070: 6973 6520 5333 4275 636b 6574 4e6f 7446  ise S3BucketNotF
+00008080: 6f75 6e64 4572 726f 7228 2745 6d70 7479  oundError('Empty
+00008090: 2062 7563 6b65 7420 6e61 6d65 3a20 2572   bucket name: %r
+000080a0: 2720 2520 6473 745f 7572 6c29 0a20 2020  ' % dst_url).   
+000080b0: 2069 6620 6e6f 7420 6473 745f 6b65 7920   if not dst_key 
+000080c0: 6f72 2064 7374 5f6b 6579 2e65 6e64 7377  or dst_key.endsw
+000080d0: 6974 6828 272f 2729 3a0a 2020 2020 2020  ith('/'):.      
+000080e0: 2020 7261 6973 6520 5333 4973 4144 6972    raise S3IsADir
+000080f0: 6563 746f 7279 4572 726f 7228 2749 7320  ectoryError('Is 
+00008100: 6120 6469 7265 6374 6f72 793a 2025 7227  a directory: %r'
+00008110: 2025 2064 7374 5f75 726c 290a 0a20 2020   % dst_url)..   
+00008120: 2063 6c69 656e 7420 3d20 6765 745f 7333   client = get_s3
+00008130: 5f63 6c69 656e 7428 7072 6f66 696c 655f  _client(profile_
+00008140: 6e61 6d65 3d53 3350 6174 6828 6473 745f  name=S3Path(dst_
+00008150: 7572 6c29 2e5f 7072 6f66 696c 655f 6e61  url)._profile_na
+00008160: 6d65 290a 2020 2020 7769 7468 206f 7065  me).    with ope
+00008170: 6e28 7372 635f 7572 6c2c 2027 7262 2729  n(src_url, 'rb')
+00008180: 2061 7320 7372 633a 0a20 2020 2020 2020   as src:.       
+00008190: 2077 6974 6820 7261 6973 655f 7333 5f65   with raise_s3_e
+000081a0: 7272 6f72 2864 7374 5f75 726c 293a 0a20  rror(dst_url):. 
+000081b0: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
+000081c0: 742e 7570 6c6f 6164 5f66 696c 656f 626a  t.upload_fileobj
+000081d0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000081e0: 2020 7372 632c 2042 7563 6b65 743d 6473    src, Bucket=ds
+000081f0: 745f 6275 636b 6574 2c20 4b65 793d 6473  t_bucket, Key=ds
+00008200: 745f 6b65 792c 2043 616c 6c62 6163 6b3d  t_key, Callback=
+00008210: 6361 6c6c 6261 636b 290a 0a0a 6465 6620  callback)...def 
+00008220: 7333 5f6c 6f61 645f 636f 6e74 656e 7428  s3_load_content(
+00008230: 0a20 2020 2020 2020 2073 335f 7572 6c2c  .        s3_url,
+00008240: 0a20 2020 2020 2020 2073 7461 7274 3a20  .        start: 
+00008250: 4f70 7469 6f6e 616c 5b69 6e74 5d20 3d20  Optional[int] = 
+00008260: 4e6f 6e65 2c0a 2020 2020 2020 2020 7374  None,.        st
+00008270: 6f70 3a20 4f70 7469 6f6e 616c 5b69 6e74  op: Optional[int
+00008280: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+00008290: 2020 666f 6c6c 6f77 6c69 6e6b 733a 2062    followlinks: b
+000082a0: 6f6f 6c20 3d20 4661 6c73 6529 202d 3e20  ool = False) -> 
+000082b0: 6279 7465 733a 0a20 2020 2027 2727 0a20  bytes:.    '''. 
+000082c0: 2020 2047 6574 2073 7065 6369 6669 6564     Get specified
+000082d0: 2066 696c 6520 6672 6f6d 205b 7374 6172   file from [star
+000082e0: 742c 2073 746f 7029 2069 6e20 6279 7465  t, stop) in byte
+000082f0: 730a 0a20 2020 203a 7061 7261 6d20 7333  s..    :param s3
+00008300: 5f75 726c 3a20 5370 6563 6966 6965 6420  _url: Specified 
+00008310: 7061 7468 0a20 2020 203a 7061 7261 6d20  path.    :param 
+00008320: 7374 6172 743a 2073 7461 7274 2069 6e64  start: start ind
+00008330: 6578 0a20 2020 203a 7061 7261 6d20 7374  ex.    :param st
+00008340: 6f70 3a20 7374 6f70 2069 6e64 6578 0a20  op: stop index. 
+00008350: 2020 203a 7265 7475 726e 733a 2062 7974     :returns: byt
+00008360: 6573 2063 6f6e 7465 6e74 2069 6e20 7261  es content in ra
+00008370: 6e67 6520 5b73 7461 7274 2c20 7374 6f70  nge [start, stop
+00008380: 290a 2020 2020 2727 270a 0a20 2020 2064  ).    '''..    d
+00008390: 6566 205f 6765 745f 6f62 6a65 6374 2863  ef _get_object(c
+000083a0: 6c69 656e 742c 2062 7563 6b65 742c 206b  lient, bucket, k
+000083b0: 6579 2c20 7261 6e67 655f 7374 7229 3a0a  ey, range_str):.
+000083c0: 2020 2020 2020 2020 7265 7475 726e 2063          return c
+000083d0: 6c69 656e 742e 6765 745f 6f62 6a65 6374  lient.get_object
+000083e0: 280a 2020 2020 2020 2020 2020 2020 4275  (.            Bu
+000083f0: 636b 6574 3d62 7563 6b65 742c 204b 6579  cket=bucket, Key
+00008400: 3d6b 6579 2c20 5261 6e67 653d 7261 6e67  =key, Range=rang
+00008410: 655f 7374 7229 5b27 426f 6479 275d 2e72  e_str)['Body'].r
+00008420: 6561 6428 290a 0a20 2020 2073 335f 7572  ead()..    s3_ur
+00008430: 6c20 3d20 5333 5061 7468 2873 335f 7572  l = S3Path(s3_ur
+00008440: 6c29 0a20 2020 2069 6620 666f 6c6c 6f77  l).    if follow
+00008450: 6c69 6e6b 733a 0a20 2020 2020 2020 2074  links:.        t
+00008460: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00008470: 7333 5f75 726c 203d 2073 335f 7572 6c2e  s3_url = s3_url.
+00008480: 7265 6164 6c69 6e6b 2829 0a20 2020 2020  readlink().     
+00008490: 2020 2065 7863 6570 7420 5333 4e6f 7441     except S3NotA
+000084a0: 4c69 6e6b 4572 726f 723a 0a20 2020 2020  LinkError:.     
+000084b0: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
+000084c0: 2062 7563 6b65 742c 206b 6579 203d 2070   bucket, key = p
+000084d0: 6172 7365 5f73 335f 7572 6c28 7333 5f75  arse_s3_url(s3_u
+000084e0: 726c 2e70 6174 685f 7769 7468 5f70 726f  rl.path_with_pro
+000084f0: 746f 636f 6c29 0a20 2020 2069 6620 6e6f  tocol).    if no
+00008500: 7420 6275 636b 6574 3a0a 2020 2020 2020  t bucket:.      
+00008510: 2020 7261 6973 6520 5333 4275 636b 6574    raise S3Bucket
+00008520: 4e6f 7446 6f75 6e64 4572 726f 7228 2745  NotFoundError('E
+00008530: 6d70 7479 2062 7563 6b65 7420 6e61 6d65  mpty bucket name
+00008540: 3a20 2572 2720 2520 7333 5f75 726c 290a  : %r' % s3_url).
+00008550: 2020 2020 6966 206e 6f74 206b 6579 206f      if not key o
+00008560: 7220 6b65 792e 656e 6473 7769 7468 2827  r key.endswith('
+00008570: 2f27 293a 0a20 2020 2020 2020 2072 6169  /'):.        rai
+00008580: 7365 2053 3349 7341 4469 7265 6374 6f72  se S3IsADirector
+00008590: 7945 7272 6f72 2827 4973 2061 2064 6972  yError('Is a dir
+000085a0: 6563 746f 7279 3a20 2572 2720 2520 7333  ectory: %r' % s3
+000085b0: 5f75 726c 290a 0a20 2020 2073 7461 7274  _url)..    start
+000085c0: 2c20 7374 6f70 203d 2067 6574 5f63 6f6e  , stop = get_con
+000085d0: 7465 6e74 5f6f 6666 7365 7428 0a20 2020  tent_offset(.   
+000085e0: 2020 2020 2073 7461 7274 2c20 7374 6f70       start, stop
+000085f0: 2c20 7333 5f75 726c 2e67 6574 7369 7a65  , s3_url.getsize
+00008600: 2866 6f6c 6c6f 775f 7379 6d6c 696e 6b73  (follow_symlinks
+00008610: 3d46 616c 7365 2929 0a20 2020 2069 6620  =False)).    if 
+00008620: 7374 6172 7420 3d3d 2030 2061 6e64 2073  start == 0 and s
+00008630: 746f 7020 3d3d 2030 3a0a 2020 2020 2020  top == 0:.      
+00008640: 2020 7265 7475 726e 2062 2727 0a20 2020    return b''.   
+00008650: 2072 616e 6765 5f73 7472 203d 2027 6279   range_str = 'by
+00008660: 7465 733d 2564 2d25 6427 2025 2028 7374  tes=%d-%d' % (st
+00008670: 6172 742c 2073 746f 7020 2d20 3129 0a0a  art, stop - 1)..
+00008680: 2020 2020 636c 6965 6e74 203d 2067 6574      client = get
+00008690: 5f73 335f 636c 6965 6e74 2870 726f 6669  _s3_client(profi
+000086a0: 6c65 5f6e 616d 653d 7333 5f75 726c 2e5f  le_name=s3_url._
+000086b0: 7072 6f66 696c 655f 6e61 6d65 290a 2020  profile_name).  
+000086c0: 2020 7769 7468 2072 6169 7365 5f73 335f    with raise_s3_
+000086d0: 6572 726f 7228 7333 5f75 726c 2e70 6174  error(s3_url.pat
+000086e0: 6829 3a0a 2020 2020 2020 2020 7265 7475  h):.        retu
+000086f0: 726e 2070 6174 6368 5f6d 6574 686f 6428  rn patch_method(
+00008700: 0a20 2020 2020 2020 2020 2020 205f 6765  .            _ge
+00008710: 745f 6f62 6a65 6374 2c0a 2020 2020 2020  t_object,.      
+00008720: 2020 2020 2020 6d61 785f 7265 7472 6965        max_retrie
+00008730: 733d 6d61 785f 7265 7472 6965 732c 0a20  s=max_retries,. 
+00008740: 2020 2020 2020 2020 2020 2073 686f 756c             shoul
+00008750: 645f 7265 7472 793d 7333 5f73 686f 756c  d_retry=s3_shoul
+00008760: 645f 7265 7472 792c 0a20 2020 2020 2020  d_retry,.       
+00008770: 2029 2863 6c69 656e 742c 2062 7563 6b65   )(client, bucke
+00008780: 742c 206b 6579 2c20 7261 6e67 655f 7374  t, key, range_st
+00008790: 7229 0a0a 0a64 6566 2073 335f 7265 6164  r)...def s3_read
+000087a0: 6c69 6e6b 2870 6174 6829 202d 3e20 7374  link(path) -> st
+000087b0: 723a 0a20 2020 2027 2727 0a20 2020 2052  r:.    '''.    R
+000087c0: 6574 7572 6e20 6120 7374 7269 6e67 2072  eturn a string r
+000087d0: 6570 7265 7365 6e74 696e 6720 7468 6520  epresenting the 
+000087e0: 7061 7468 2074 6f20 7768 6963 6820 7468  path to which th
+000087f0: 6520 7379 6d62 6f6c 6963 206c 696e 6b20  e symbolic link 
+00008800: 706f 696e 7473 2e0a 0a20 2020 203a 7265  points...    :re
+00008810: 7475 726e 733a 2052 6574 7572 6e20 6120  turns: Return a 
+00008820: 7374 7269 6e67 2072 6570 7265 7365 6e74  string represent
+00008830: 696e 6720 7468 6520 7061 7468 2074 6f20  ing the path to 
+00008840: 7768 6963 6820 7468 6520 7379 6d62 6f6c  which the symbol
+00008850: 6963 206c 696e 6b20 706f 696e 7473 2e0a  ic link points..
+00008860: 2020 2020 3a72 6169 7365 733a 2053 334e      :raises: S3N
+00008870: 616d 6554 6f6f 4c6f 6e67 4572 726f 722c  ameTooLongError,
+00008880: 2053 3342 7563 6b65 744e 6f74 466f 756e   S3BucketNotFoun
+00008890: 6445 7272 6f72 2c20 5333 4973 4144 6972  dError, S3IsADir
+000088a0: 6563 746f 7279 4572 726f 722c 2053 334e  ectoryError, S3N
+000088b0: 6f74 414c 696e 6b45 7272 6f72 0a20 2020  otALinkError.   
+000088c0: 2027 2727 0a20 2020 2072 6574 7572 6e20   '''.    return 
+000088d0: 5333 5061 7468 2870 6174 6829 2e72 6561  S3Path(path).rea
+000088e0: 646c 696e 6b28 292e 7061 7468 5f77 6974  dlink().path_wit
+000088f0: 685f 7072 6f74 6f63 6f6c 0a0a 0a64 6566  h_protocol...def
+00008900: 2073 335f 7265 6e61 6d65 2873 7263 5f75   s3_rename(src_u
+00008910: 726c 3a20 5061 7468 4c69 6b65 2c20 6473  rl: PathLike, ds
+00008920: 745f 7572 6c3a 2050 6174 684c 696b 6529  t_url: PathLike)
+00008930: 3a0a 2020 2020 2727 270a 2020 2020 4d6f  :.    '''.    Mo
+00008940: 7665 2073 3320 6669 6c65 2070 6174 6820  ve s3 file path 
+00008950: 6672 6f6d 2073 7263 5f75 726c 2074 6f20  from src_url to 
+00008960: 6473 745f 7572 6c0a 0a20 2020 203a 7061  dst_url..    :pa
+00008970: 7261 6d20 6473 745f 7572 6c3a 2047 6976  ram dst_url: Giv
+00008980: 656e 2064 6573 7469 6e61 7469 6f6e 2070  en destination p
+00008990: 6174 680a 2020 2020 2727 270a 2020 2020  ath.    '''.    
+000089a0: 7372 635f 7061 7468 5f69 6e73 203d 2053  src_path_ins = S
+000089b0: 3350 6174 6828 7372 635f 7572 6c29 0a20  3Path(src_url). 
+000089c0: 2020 2069 6620 7372 635f 7061 7468 5f69     if src_path_i
+000089d0: 6e73 2e69 735f 6669 6c65 2829 3a0a 2020  ns.is_file():.  
+000089e0: 2020 2020 2020 7372 635f 7061 7468 5f69        src_path_i
+000089f0: 6e73 2e63 6f70 7928 6473 745f 7572 6c29  ns.copy(dst_url)
+00008a00: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+00008a10: 2020 2073 7263 5f70 6174 685f 696e 732e     src_path_ins.
+00008a20: 7379 6e63 2864 7374 5f75 726c 290a 2020  sync(dst_url).  
+00008a30: 2020 7372 635f 7061 7468 5f69 6e73 2e72    src_path_ins.r
+00008a40: 656d 6f76 6528 290a 0a0a 636c 6173 7320  emove()...class 
+00008a50: 5333 4361 6368 6572 2846 696c 6543 6163  S3Cacher(FileCac
+00008a60: 6865 7229 3a0a 2020 2020 6361 6368 655f  her):.    cache_
+00008a70: 7061 7468 203d 204e 6f6e 650a 0a20 2020  path = None..   
+00008a80: 2064 6566 205f 5f69 6e69 745f 5f28 0a20   def __init__(. 
+00008a90: 2020 2020 2020 2020 2020 2073 656c 662c             self,
+00008aa0: 2070 6174 683a 2073 7472 2c20 6361 6368   path: str, cach
+00008ab0: 655f 7061 7468 3a20 4f70 7469 6f6e 616c  e_path: Optional
+00008ac0: 5b73 7472 5d20 3d20 4e6f 6e65 2c20 6d6f  [str] = None, mo
+00008ad0: 6465 3a20 7374 7220 3d20 2772 2729 3a0a  de: str = 'r'):.
+00008ae0: 2020 2020 2020 2020 6966 206d 6f64 6520          if mode 
+00008af0: 6e6f 7420 696e 2028 2772 272c 2027 7727  not in ('r', 'w'
+00008b00: 2c20 2761 2729 3a0a 2020 2020 2020 2020  , 'a'):.        
+00008b10: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+00008b20: 7272 6f72 2827 756e 6163 6365 7074 6162  rror('unacceptab
+00008b30: 6c65 206d 6f64 653a 2025 7227 2025 206d  le mode: %r' % m
+00008b40: 6f64 6529 0a20 2020 2020 2020 2069 6620  ode).        if 
+00008b50: 6d6f 6465 2069 6e20 2827 7227 2c20 2761  mode in ('r', 'a
+00008b60: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+00008b70: 6966 2063 6163 6865 5f70 6174 6820 6973  if cache_path is
+00008b80: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00008b90: 2020 2020 2020 2063 6163 6865 5f70 6174         cache_pat
+00008ba0: 6820 3d20 6765 6e65 7261 7465 5f63 6163  h = generate_cac
+00008bb0: 6865 5f70 6174 6828 7061 7468 290a 2020  he_path(path).  
+00008bc0: 2020 2020 2020 2020 2020 7333 5f64 6f77            s3_dow
+00008bd0: 6e6c 6f61 6428 7061 7468 2c20 6361 6368  nload(path, cach
+00008be0: 655f 7061 7468 290a 2020 2020 2020 2020  e_path).        
+00008bf0: 7365 6c66 2e6e 616d 6520 3d20 7061 7468  self.name = path
+00008c00: 0a20 2020 2020 2020 2073 656c 662e 6d6f  .        self.mo
+00008c10: 6465 203d 206d 6f64 650a 2020 2020 2020  de = mode.      
+00008c20: 2020 7365 6c66 2e63 6163 6865 5f70 6174    self.cache_pat
+00008c30: 6820 3d20 6361 6368 655f 7061 7468 0a0a  h = cache_path..
+00008c40: 2020 2020 6465 6620 5f63 6c6f 7365 2873      def _close(s
+00008c50: 656c 6629 3a0a 2020 2020 2020 2020 6966  elf):.        if
+00008c60: 2073 656c 662e 6361 6368 655f 7061 7468   self.cache_path
+00008c70: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
+00008c80: 205c 0a20 2020 2020 2020 2020 2020 206f   \.            o
+00008c90: 732e 7061 7468 2e65 7869 7374 7328 7365  s.path.exists(se
+00008ca0: 6c66 2e63 6163 6865 5f70 6174 6829 3a0a  lf.cache_path):.
+00008cb0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00008cc0: 656c 662e 6d6f 6465 2069 6e20 2827 7727  elf.mode in ('w'
+00008cd0: 2c20 2761 2729 3a0a 2020 2020 2020 2020  , 'a'):.        
+00008ce0: 2020 2020 2020 2020 7333 5f75 706c 6f61          s3_uploa
+00008cf0: 6428 7365 6c66 2e63 6163 6865 5f70 6174  d(self.cache_pat
+00008d00: 682c 2073 656c 662e 6e61 6d65 290a 2020  h, self.name).  
+00008d10: 2020 2020 2020 2020 2020 6f73 2e75 6e6c            os.unl
+00008d20: 696e 6b28 7365 6c66 2e63 6163 6865 5f70  ink(self.cache_p
+00008d30: 6174 6829 0a0a 0a64 6566 2073 335f 676c  ath)...def s3_gl
+00008d40: 6f62 280a 2020 2020 2020 2020 7061 7468  ob(.        path
+00008d50: 3a20 5061 7468 4c69 6b65 2c0a 2020 2020  : PathLike,.    
+00008d60: 2020 2020 7265 6375 7273 6976 653a 2062      recursive: b
+00008d70: 6f6f 6c20 3d20 5472 7565 2c0a 2020 2020  ool = True,.    
+00008d80: 2020 2020 6d69 7373 696e 675f 6f6b 3a20      missing_ok: 
+00008d90: 626f 6f6c 203d 2054 7275 652c 0a20 2020  bool = True,.   
+00008da0: 2020 2020 2066 6f6c 6c6f 776c 696e 6b73       followlinks
+00008db0: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
+00008dc0: 2920 2d3e 204c 6973 745b 7374 725d 3a0a  ) -> List[str]:.
+00008dd0: 2020 2020 2727 2752 6574 7572 6e20 7333      '''Return s3
+00008de0: 2070 6174 6820 6c69 7374 2069 6e20 6173   path list in as
+00008df0: 6365 6e64 696e 6720 616c 7068 6162 6574  cending alphabet
+00008e00: 6963 616c 206f 7264 6572 2c20 696e 2077  ical order, in w
+00008e10: 6869 6368 2070 6174 6820 6d61 7463 6865  hich path matche
+00008e20: 7320 676c 6f62 2070 6174 7465 726e 0a20  s glob pattern. 
+00008e30: 2020 204e 6f74 6573 3a20 4f6e 6c79 2067     Notes: Only g
+00008e40: 6c6f 6220 696e 2062 7563 6b65 742e 2049  lob in bucket. I
+00008e50: 6620 7472 7969 6e67 2074 6f20 6d61 7463  f trying to matc
+00008e60: 6820 6275 636b 6574 2077 6974 6820 7769  h bucket with wi
+00008e70: 6c64 6361 7264 2063 6861 7261 6374 6572  ldcard character
+00008e80: 732c 2072 6169 7365 2055 6e73 7570 706f  s, raise Unsuppo
+00008e90: 7274 6564 4572 726f 720a 0a20 2020 203a  rtedError..    :
+00008ea0: 7061 7261 6d20 7265 6375 7273 6976 653a  param recursive:
+00008eb0: 2049 6620 4661 6c73 652c 2060 2a2a 6020   If False, `**` 
+00008ec0: 7769 6c6c 206e 6f74 2073 6561 7263 6820  will not search 
+00008ed0: 6469 7265 6374 6f72 7920 7265 6375 7273  directory recurs
+00008ee0: 6976 656c 790a 2020 2020 3a70 6172 616d  ively.    :param
+00008ef0: 206d 6973 7369 6e67 5f6f 6b3a 2049 6620   missing_ok: If 
+00008f00: 4661 6c73 6520 616e 6420 7461 7267 6574  False and target
+00008f10: 2070 6174 6820 646f 6573 6e27 7420 6d61   path doesn't ma
+00008f20: 7463 6820 616e 7920 6669 6c65 2c20 7261  tch any file, ra
+00008f30: 6973 6520 4669 6c65 4e6f 7446 6f75 6e64  ise FileNotFound
+00008f40: 4572 726f 720a 2020 2020 3a72 6169 7365  Error.    :raise
+00008f50: 733a 2055 6e73 7570 706f 7274 6564 4572  s: UnsupportedEr
+00008f60: 726f 722c 2077 6865 6e20 6275 636b 6574  ror, when bucket
+00008f70: 2070 6172 7420 636f 6e74 6169 6e73 2077   part contains w
+00008f80: 696c 6463 6172 6420 6368 6172 6163 7465  ildcard characte
+00008f90: 7273 0a20 2020 203a 7265 7475 726e 733a  rs.    :returns:
+00008fa0: 2041 206c 6973 7420 636f 6e74 6169 6e73   A list contains
+00008fb0: 2070 6174 6873 206d 6174 6368 2060 7333   paths match `s3
+00008fc0: 5f70 6174 686e 616d 6560 0a20 2020 2027  _pathname`.    '
+00008fd0: 2727 0a20 2020 2072 6574 7572 6e20 6c69  ''.    return li
+00008fe0: 7374 280a 2020 2020 2020 2020 7333 5f69  st(.        s3_i
+00008ff0: 676c 6f62 280a 2020 2020 2020 2020 2020  glob(.          
+00009000: 2020 7061 7468 3d70 6174 682c 0a20 2020    path=path,.   
+00009010: 2020 2020 2020 2020 2072 6563 7572 7369           recursi
+00009020: 7665 3d72 6563 7572 7369 7665 2c0a 2020  ve=recursive,.  
+00009030: 2020 2020 2020 2020 2020 6d69 7373 696e            missin
+00009040: 675f 6f6b 3d6d 6973 7369 6e67 5f6f 6b2c  g_ok=missing_ok,
+00009050: 0a20 2020 2020 2020 2020 2020 2066 6f6c  .            fol
+00009060: 6c6f 776c 696e 6b73 3d66 6f6c 6c6f 776c  lowlinks=followl
+00009070: 696e 6b73 2929 0a0a 0a64 6566 2073 335f  inks))...def s3_
+00009080: 676c 6f62 5f73 7461 7428 0a20 2020 2020  glob_stat(.     
+00009090: 2020 2070 6174 683a 2050 6174 684c 696b     path: PathLik
+000090a0: 652c 0a20 2020 2020 2020 2072 6563 7572  e,.        recur
+000090b0: 7369 7665 3a20 626f 6f6c 203d 2054 7275  sive: bool = Tru
+000090c0: 652c 0a20 2020 2020 2020 206d 6973 7369  e,.        missi
+000090d0: 6e67 5f6f 6b3a 2062 6f6f 6c20 3d20 5472  ng_ok: bool = Tr
+000090e0: 7565 2c0a 2020 2020 2020 2020 666f 6c6c  ue,.        foll
+000090f0: 6f77 6c69 6e6b 733a 2062 6f6f 6c20 3d20  owlinks: bool = 
+00009100: 4661 6c73 6529 202d 3e20 4974 6572 6174  False) -> Iterat
+00009110: 6f72 5b46 696c 6545 6e74 7279 5d3a 0a20  or[FileEntry]:. 
+00009120: 2020 2027 2727 5265 7475 726e 2061 2067     '''Return a g
+00009130: 656e 6572 6174 6f72 2063 6f6e 7461 696e  enerator contain
+00009140: 7320 7475 706c 6573 206f 6620 7061 7468  s tuples of path
+00009150: 2061 6e64 2066 696c 6520 7374 6174 2c20   and file stat, 
+00009160: 696e 2061 7363 656e 6469 6e67 2061 6c70  in ascending alp
+00009170: 6861 6265 7469 6361 6c20 6f72 6465 722c  habetical order,
+00009180: 2069 6e20 7768 6963 6820 7061 7468 206d   in which path m
+00009190: 6174 6368 6573 2067 6c6f 6220 7061 7474  atches glob patt
+000091a0: 6572 6e0a 2020 2020 4e6f 7465 733a 204f  ern.    Notes: O
+000091b0: 6e6c 7920 676c 6f62 2069 6e20 6275 636b  nly glob in buck
+000091c0: 6574 2e20 4966 2074 7279 696e 6720 746f  et. If trying to
+000091d0: 206d 6174 6368 2062 7563 6b65 7420 7769   match bucket wi
+000091e0: 7468 2077 696c 6463 6172 6420 6368 6172  th wildcard char
+000091f0: 6163 7465 7273 2c20 7261 6973 6520 556e  acters, raise Un
+00009200: 7375 7070 6f72 7465 6445 7272 6f72 0a0a  supportedError..
+00009210: 2020 2020 3a70 6172 616d 2072 6563 7572      :param recur
+00009220: 7369 7665 3a20 4966 2046 616c 7365 2c20  sive: If False, 
+00009230: 602a 2a60 2077 696c 6c20 6e6f 7420 7365  `**` will not se
+00009240: 6172 6368 2064 6972 6563 746f 7279 2072  arch directory r
+00009250: 6563 7572 7369 7665 6c79 0a20 2020 203a  ecursively.    :
+00009260: 7061 7261 6d20 6d69 7373 696e 675f 6f6b  param missing_ok
+00009270: 3a20 4966 2046 616c 7365 2061 6e64 2074  : If False and t
+00009280: 6172 6765 7420 7061 7468 2064 6f65 736e  arget path doesn
+00009290: 2774 206d 6174 6368 2061 6e79 2066 696c  't match any fil
+000092a0: 652c 2072 6169 7365 2046 696c 654e 6f74  e, raise FileNot
+000092b0: 466f 756e 6445 7272 6f72 0a20 2020 203a  FoundError.    :
+000092c0: 7261 6973 6573 3a20 556e 7375 7070 6f72  raises: Unsuppor
+000092d0: 7465 6445 7272 6f72 2c20 7768 656e 2062  tedError, when b
+000092e0: 7563 6b65 7420 7061 7274 2063 6f6e 7461  ucket part conta
+000092f0: 696e 7320 7769 6c64 6361 7264 2063 6861  ins wildcard cha
+00009300: 7261 6374 6572 730a 2020 2020 3a72 6574  racters.    :ret
+00009310: 7572 6e73 3a20 4120 6765 6e65 7261 746f  urns: A generato
+00009320: 7220 636f 6e74 6169 6e73 2074 7570 6c65  r contains tuple
+00009330: 7320 6f66 2070 6174 6820 616e 6420 6669  s of path and fi
+00009340: 6c65 2073 7461 742c 2069 6e20 7768 6963  le stat, in whic
+00009350: 6820 7061 7468 7320 6d61 7463 6820 6073  h paths match `s
+00009360: 335f 7061 7468 6e61 6d65 600a 2020 2020  3_pathname`.    
+00009370: 2727 270a 2020 2020 7265 7475 726e 2053  '''.    return S
+00009380: 3350 6174 6828 7061 7468 292e 676c 6f62  3Path(path).glob
+00009390: 5f73 7461 7428 0a20 2020 2020 2020 2070  _stat(.        p
+000093a0: 6174 7465 726e 3d22 222c 0a20 2020 2020  attern="",.     
+000093b0: 2020 2072 6563 7572 7369 7665 3d72 6563     recursive=rec
+000093c0: 7572 7369 7665 2c0a 2020 2020 2020 2020  ursive,.        
+000093d0: 6d69 7373 696e 675f 6f6b 3d6d 6973 7369  missing_ok=missi
+000093e0: 6e67 5f6f 6b2c 0a20 2020 2020 2020 2066  ng_ok,.        f
+000093f0: 6f6c 6c6f 776c 696e 6b73 3d66 6f6c 6c6f  ollowlinks=follo
+00009400: 776c 696e 6b73 290a 0a0a 6465 6620 7333  wlinks)...def s3
+00009410: 5f69 676c 6f62 280a 2020 2020 2020 2020  _iglob(.        
+00009420: 7061 7468 3a20 5061 7468 4c69 6b65 2c0a  path: PathLike,.
+00009430: 2020 2020 2020 2020 7265 6375 7273 6976          recursiv
+00009440: 653a 2062 6f6f 6c20 3d20 5472 7565 2c0a  e: bool = True,.
+00009450: 2020 2020 2020 2020 6d69 7373 696e 675f          missing_
+00009460: 6f6b 3a20 626f 6f6c 203d 2054 7275 652c  ok: bool = True,
+00009470: 0a20 2020 2020 2020 2066 6f6c 6c6f 776c  .        followl
+00009480: 696e 6b73 3a20 626f 6f6c 203d 2046 616c  inks: bool = Fal
+00009490: 7365 2c0a 2920 2d3e 2049 7465 7261 746f  se,.) -> Iterato
+000094a0: 725b 7374 725d 3a0a 2020 2020 2727 2752  r[str]:.    '''R
+000094b0: 6574 7572 6e20 7333 2070 6174 6820 6974  eturn s3 path it
+000094c0: 6572 6174 6f72 2069 6e20 6173 6365 6e64  erator in ascend
+000094d0: 696e 6720 616c 7068 6162 6574 6963 616c  ing alphabetical
+000094e0: 206f 7264 6572 2c20 696e 2077 6869 6368   order, in which
+000094f0: 2070 6174 6820 6d61 7463 6865 7320 676c   path matches gl
+00009500: 6f62 2070 6174 7465 726e 0a20 2020 204e  ob pattern.    N
+00009510: 6f74 6573 3a20 4f6e 6c79 2067 6c6f 6220  otes: Only glob 
+00009520: 696e 2062 7563 6b65 742e 2049 6620 7472  in bucket. If tr
+00009530: 7969 6e67 2074 6f20 6d61 7463 6820 6275  ying to match bu
+00009540: 636b 6574 2077 6974 6820 7769 6c64 6361  cket with wildca
+00009550: 7264 2063 6861 7261 6374 6572 732c 2072  rd characters, r
+00009560: 6169 7365 2055 6e73 7570 706f 7274 6564  aise Unsupported
+00009570: 4572 726f 720a 0a20 2020 203a 7061 7261  Error..    :para
+00009580: 6d20 7265 6375 7273 6976 653a 2049 6620  m recursive: If 
+00009590: 4661 6c73 652c 2060 2a2a 6020 7769 6c6c  False, `**` will
+000095a0: 206e 6f74 2073 6561 7263 6820 6469 7265   not search dire
+000095b0: 6374 6f72 7920 7265 6375 7273 6976 656c  ctory recursivel
+000095c0: 790a 2020 2020 3a70 6172 616d 206d 6973  y.    :param mis
+000095d0: 7369 6e67 5f6f 6b3a 2049 6620 4661 6c73  sing_ok: If Fals
+000095e0: 6520 616e 6420 7461 7267 6574 2070 6174  e and target pat
+000095f0: 6820 646f 6573 6e27 7420 6d61 7463 6820  h doesn't match 
+00009600: 616e 7920 6669 6c65 2c20 7261 6973 6520  any file, raise 
+00009610: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
+00009620: 720a 2020 2020 3a72 6169 7365 733a 2055  r.    :raises: U
+00009630: 6e73 7570 706f 7274 6564 4572 726f 722c  nsupportedError,
+00009640: 2077 6865 6e20 6275 636b 6574 2070 6172   when bucket par
+00009650: 7420 636f 6e74 6169 6e73 2077 696c 6463  t contains wildc
+00009660: 6172 6420 6368 6172 6163 7465 7273 0a20  ard characters. 
+00009670: 2020 203a 7265 7475 726e 733a 2041 6e20     :returns: An 
+00009680: 6974 6572 6174 6f72 2063 6f6e 7461 696e  iterator contain
+00009690: 7320 7061 7468 7320 6d61 7463 6820 6073  s paths match `s
+000096a0: 335f 7061 7468 6e61 6d65 600a 2020 2020  3_pathname`.    
+000096b0: 2727 270a 2020 2020 666f 7220 7061 7468  '''.    for path
+000096c0: 5f6f 626a 2069 6e20 5333 5061 7468 2870  _obj in S3Path(p
+000096d0: 6174 6829 2e69 676c 6f62 2870 6174 7465  ath).iglob(patte
+000096e0: 726e 3d22 222c 2072 6563 7572 7369 7665  rn="", recursive
+000096f0: 3d72 6563 7572 7369 7665 2c0a 2020 2020  =recursive,.    
+00009700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009720: 2020 206d 6973 7369 6e67 5f6f 6b3d 6d69     missing_ok=mi
+00009730: 7373 696e 675f 6f6b 2c0a 2020 2020 2020  ssing_ok,.      
+00009740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009760: 2066 6f6c 6c6f 776c 696e 6b73 3d66 6f6c   followlinks=fol
+00009770: 6c6f 776c 696e 6b73 293a 0a20 2020 2020  lowlinks):.     
+00009780: 2020 2079 6965 6c64 2070 6174 685f 6f62     yield path_ob
+00009790: 6a2e 7061 7468 5f77 6974 685f 7072 6f74  j.path_with_prot
+000097a0: 6f63 6f6c 0a0a 0a64 6566 2073 335f 6d61  ocol...def s3_ma
+000097b0: 6b65 6469 7273 2870 6174 683a 2050 6174  kedirs(path: Pat
+000097c0: 684c 696b 652c 2065 7869 7374 5f6f 6b3a  hLike, exist_ok:
+000097d0: 2062 6f6f 6c20 3d20 4661 6c73 6529 3a0a   bool = False):.
+000097e0: 2020 2020 2727 270a 2020 2020 4372 6561      '''.    Crea
+000097f0: 7465 2061 6e20 7333 2064 6972 6563 746f  te an s3 directo
+00009800: 7279 2e0a 2020 2020 5075 7265 6c79 2063  ry..    Purely c
+00009810: 7265 6174 696e 6720 6469 7265 6374 6f72  reating director
+00009820: 7920 6973 2069 6e76 616c 6964 2062 6563  y is invalid bec
+00009830: 6175 7365 2069 7427 7320 756e 6176 6169  ause it's unavai
+00009840: 6c61 626c 6520 6f6e 204f 5353 2e0a 2020  lable on OSS..  
+00009850: 2020 5468 6973 2066 756e 6374 696f 6e20    This function 
+00009860: 6973 2074 6f20 7465 7374 2074 6865 2074  is to test the t
+00009870: 6172 6765 7420 6275 636b 6574 2068 6176  arget bucket hav
+00009880: 6520 5752 4954 4520 6163 6365 7373 2e0a  e WRITE access..
+00009890: 0a20 2020 203a 7061 7261 6d20 7061 7468  .    :param path
+000098a0: 3a20 4769 7665 6e20 7061 7468 0a20 2020  : Given path.   
+000098b0: 203a 7061 7261 6d20 6578 6973 745f 6f6b   :param exist_ok
+000098c0: 3a20 4966 2046 616c 7365 2061 6e64 2074  : If False and t
+000098d0: 6172 6765 7420 6469 7265 6374 6f72 7920  arget directory 
+000098e0: 6578 6973 7473 2c20 7261 6973 6520 5333  exists, raise S3
+000098f0: 4669 6c65 4578 6973 7473 4572 726f 720a  FileExistsError.
+00009900: 2020 2020 3a72 6169 7365 733a 2053 3342      :raises: S3B
+00009910: 7563 6b65 744e 6f74 466f 756e 6445 7272  ucketNotFoundErr
+00009920: 6f72 2c20 5333 4669 6c65 4578 6973 7473  or, S3FileExists
+00009930: 4572 726f 720a 2020 2020 2727 270a 2020  Error.    '''.  
+00009940: 2020 7265 7475 726e 2053 3350 6174 6828    return S3Path(
+00009950: 7061 7468 292e 6d6b 6469 7228 7061 7265  path).mkdir(pare
+00009960: 6e74 733d 5472 7565 2c20 6578 6973 745f  nts=True, exist_
+00009970: 6f6b 3d65 7869 7374 5f6f 6b29 0a0a 0a64  ok=exist_ok)...d
+00009980: 6566 205f 6772 6f75 705f 7372 635f 7061  ef _group_src_pa
+00009990: 7468 735f 6279 5f62 6c6f 636b 280a 2020  ths_by_block(.  
+000099a0: 2020 2020 2020 7372 635f 7061 7468 733a        src_paths:
+000099b0: 204c 6973 745b 5061 7468 4c69 6b65 5d2c   List[PathLike],
+000099c0: 2062 6c6f 636b 5f73 697a 653a 2069 6e74   block_size: int
+000099d0: 203d 2044 4546 4155 4c54 5f42 4c4f 434b   = DEFAULT_BLOCK
+000099e0: 5f53 495a 450a 2920 2d3e 204c 6973 745b  _SIZE.) -> List[
+000099f0: 4c69 7374 5b54 7570 6c65 5b50 6174 684c  List[Tuple[PathL
+00009a00: 696b 652c 204f 7074 696f 6e61 6c5b 7374  ike, Optional[st
+00009a10: 725d 5d5d 5d3a 0a20 2020 2067 726f 7570  r]]]]:.    group
+00009a20: 7320 3d20 5b5d 0a20 2020 2063 7572 7265  s = [].    curre
+00009a30: 6e74 5f67 726f 7570 2c20 6375 7272 656e  nt_group, curren
+00009a40: 745f 6772 6f75 705f 7369 7a65 203d 205b  t_group_size = [
+00009a50: 5d2c 2030 0a20 2020 2066 6f72 2073 7263  ], 0.    for src
+00009a60: 5f70 6174 6820 696e 2073 7263 5f70 6174  _path in src_pat
+00009a70: 6873 3a0a 2020 2020 2020 2020 6375 7272  hs:.        curr
+00009a80: 656e 745f 6669 6c65 5f73 697a 6520 3d20  ent_file_size = 
+00009a90: 5333 5061 7468 2873 7263 5f70 6174 6829  S3Path(src_path)
+00009aa0: 2e73 7461 7428 292e 7369 7a65 0a20 2020  .stat().size.   
+00009ab0: 2020 2020 2069 6620 6375 7272 656e 745f       if current_
+00009ac0: 6669 6c65 5f73 697a 6520 3d3d 2030 3a20  file_size == 0: 
+00009ad0: 2023 2070 7261 676d 613a 206e 6f20 636f   # pragma: no co
+00009ae0: 7665 720a 2020 2020 2020 2020 2020 2020  ver.            
+00009af0: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
+00009b00: 2020 6966 2063 7572 7265 6e74 5f66 696c    if current_fil
+00009b10: 655f 7369 7a65 203e 3d20 626c 6f63 6b5f  e_size >= block_
+00009b20: 7369 7a65 3a0a 2020 2020 2020 2020 2020  size:.          
+00009b30: 2020 6966 206c 656e 2867 726f 7570 7329    if len(groups)
+00009b40: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
+00009b50: 2020 2020 2020 2069 6620 6375 7272 656e         if curren
+00009b60: 745f 6772 6f75 705f 7369 7a65 202b 2063  t_group_size + c
+00009b70: 7572 7265 6e74 5f66 696c 655f 7369 7a65  urrent_file_size
+00009b80: 203e 2032 202a 2062 6c6f 636b 5f73 697a   > 2 * block_siz
+00009b90: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00009ba0: 2020 2020 2020 2067 726f 7570 5f6c 6163         group_lac
+00009bb0: 6b5f 7369 7a65 203d 2062 6c6f 636b 5f73  k_size = block_s
+00009bc0: 697a 6520 2d20 6375 7272 656e 745f 6772  ize - current_gr
+00009bd0: 6f75 705f 7369 7a65 0a20 2020 2020 2020  oup_size.       
+00009be0: 2020 2020 2020 2020 2020 2020 2063 7572               cur
+00009bf0: 7265 6e74 5f67 726f 7570 2e61 7070 656e  rent_group.appen
+00009c00: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
+00009c10: 2020 2020 2020 2020 2020 2028 7372 635f             (src_
+00009c20: 7061 7468 2c20 6627 6279 7465 733d 302d  path, f'bytes=0-
+00009c30: 7b67 726f 7570 5f6c 6163 6b5f 7369 7a65  {group_lack_size
+00009c40: 2d31 7d27 2929 0a20 2020 2020 2020 2020  -1}')).         
+00009c50: 2020 2020 2020 2020 2020 2067 726f 7570             group
+00009c60: 732e 6578 7465 6e64 280a 2020 2020 2020  s.extend(.      
+00009c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009c80: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00009c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ca0: 6375 7272 656e 745f 6772 6f75 702c 0a20  current_group,. 
+00009cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009cc0: 2020 2020 2020 2020 2020 205b 0a20 2020             [.   
+00009cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ce0: 2020 2020 2020 2020 2020 2020 2028 0a20               (. 
+00009cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d10: 2020 2073 7263 5f70 6174 682c 0a20 2020     src_path,.   
+00009d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d40: 2066 2762 7974 6573 3d7b 6772 6f75 705f   f'bytes={group_
+00009d50: 6c61 636b 5f73 697a 657d 2d7b 6375 7272  lack_size}-{curr
+00009d60: 656e 745f 6669 6c65 5f73 697a 652d 317d  ent_file_size-1}
+00009d70: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00009d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d90: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00009da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009db0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00009dc0: 2020 2020 2020 2020 2020 5d29 0a20 2020            ]).   
+00009dd0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00009de0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00009df0: 2020 2020 2020 2063 7572 7265 6e74 5f67         current_g
+00009e00: 726f 7570 2e61 7070 656e 6428 2873 7263  roup.append((src
+00009e10: 5f70 6174 682c 204e 6f6e 6529 290a 2020  _path, None)).  
+00009e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009e30: 2020 6772 6f75 7073 2e61 7070 656e 6428    groups.append(
+00009e40: 6375 7272 656e 745f 6772 6f75 7029 0a20  current_group). 
+00009e50: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00009e60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009e70: 2067 726f 7570 735b 2d31 5d2e 6578 7465   groups[-1].exte
+00009e80: 6e64 2863 7572 7265 6e74 5f67 726f 7570  nd(current_group
+00009e90: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00009ea0: 2020 6772 6f75 7073 2e61 7070 656e 6428    groups.append(
+00009eb0: 5b28 7372 635f 7061 7468 2c20 4e6f 6e65  [(src_path, None
+00009ec0: 295d 290a 2020 2020 2020 2020 2020 2020  )]).            
+00009ed0: 6375 7272 656e 745f 6772 6f75 702c 2063  current_group, c
+00009ee0: 7572 7265 6e74 5f67 726f 7570 5f73 697a  urrent_group_siz
+00009ef0: 6520 3d20 5b5d 2c20 300a 2020 2020 2020  e = [], 0.      
+00009f00: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00009f10: 2020 2020 6375 7272 656e 745f 6772 6f75      current_grou
+00009f20: 702e 6170 7065 6e64 2828 7372 635f 7061  p.append((src_pa
+00009f30: 7468 2c20 4e6f 6e65 2929 0a20 2020 2020  th, None)).     
+00009f40: 2020 2020 2020 2063 7572 7265 6e74 5f67         current_g
+00009f50: 726f 7570 5f73 697a 6520 2b3d 2063 7572  roup_size += cur
+00009f60: 7265 6e74 5f66 696c 655f 7369 7a65 0a20  rent_file_size. 
+00009f70: 2020 2020 2020 2020 2020 2069 6620 6375             if cu
+00009f80: 7272 656e 745f 6772 6f75 705f 7369 7a65  rrent_group_size
+00009f90: 203e 3d20 626c 6f63 6b5f 7369 7a65 3a0a   >= block_size:.
+00009fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009fb0: 6772 6f75 7073 2e61 7070 656e 6428 6375  groups.append(cu
+00009fc0: 7272 656e 745f 6772 6f75 7029 0a20 2020  rrent_group).   
+00009fd0: 2020 2020 2020 2020 2020 2020 2063 7572               cur
+00009fe0: 7265 6e74 5f67 726f 7570 2c20 6375 7272  rent_group, curr
+00009ff0: 656e 745f 6772 6f75 705f 7369 7a65 203d  ent_group_size =
+0000a000: 205b 5d2c 2030 0a20 2020 2069 6620 6375   [], 0.    if cu
+0000a010: 7272 656e 745f 6772 6f75 703a 0a20 2020  rrent_group:.   
+0000a020: 2020 2020 2067 726f 7570 732e 6170 7065       groups.appe
+0000a030: 6e64 2863 7572 7265 6e74 5f67 726f 7570  nd(current_group
+0000a040: 290a 2020 2020 7265 7475 726e 2067 726f  ).    return gro
+0000a050: 7570 730a 0a0a 6465 6620 7333 5f63 6f6e  ups...def s3_con
+0000a060: 6361 7428 0a20 2020 2020 2020 2073 7263  cat(.        src
+0000a070: 5f70 6174 6873 3a20 4c69 7374 5b50 6174  _paths: List[Pat
+0000a080: 684c 696b 655d 2c0a 2020 2020 2020 2020  hLike],.        
+0000a090: 6473 745f 7061 7468 3a20 5061 7468 4c69  dst_path: PathLi
+0000a0a0: 6b65 2c0a 2020 2020 2020 2020 626c 6f63  ke,.        bloc
+0000a0b0: 6b5f 7369 7a65 3a20 696e 7420 3d20 4445  k_size: int = DE
+0000a0c0: 4641 554c 545f 424c 4f43 4b5f 5349 5a45  FAULT_BLOCK_SIZE
+0000a0d0: 2c0a 2020 2020 2020 2020 6d61 785f 776f  ,.        max_wo
+0000a0e0: 726b 6572 733a 2069 6e74 203d 2047 4c4f  rkers: int = GLO
+0000a0f0: 4241 4c5f 4d41 585f 574f 524b 4552 5329  BAL_MAX_WORKERS)
+0000a100: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2727   -> None:.    ''
+0000a110: 2743 6f6e 6361 7465 6e61 7465 2073 3320  'Concatenate s3 
+0000a120: 6669 6c65 7320 746f 206f 6e65 2066 696c  files to one fil
+0000a130: 652e 0a0a 2020 2020 3a70 6172 616d 2073  e...    :param s
+0000a140: 7263 5f70 6174 6873 3a20 4769 7665 6e20  rc_paths: Given 
+0000a150: 736f 7572 6365 2070 6174 6873 0a20 2020  source paths.   
+0000a160: 203a 7061 7261 6d20 6473 745f 7061 7468   :param dst_path
+0000a170: 3a20 4769 7665 6e20 6465 7374 696e 6174  : Given destinat
+0000a180: 696f 6e20 7061 7468 0a20 2020 2027 2727  ion path.    '''
+0000a190: 0a20 2020 2063 6c69 656e 7420 3d20 5333  .    client = S3
+0000a1a0: 5061 7468 2864 7374 5f70 6174 6829 2e5f  Path(dst_path)._
+0000a1b0: 636c 6965 6e74 0a20 2020 2077 6974 6820  client.    with 
+0000a1c0: 7261 6973 655f 7333 5f65 7272 6f72 2864  raise_s3_error(d
+0000a1d0: 7374 5f70 6174 6829 3a0a 2020 2020 2020  st_path):.      
+0000a1e0: 2020 6966 2062 6c6f 636b 5f73 697a 6520    if block_size 
+0000a1f0: 3d3d 2030 3a20 2023 2070 7261 676d 613a  == 0:  # pragma:
+0000a200: 206e 6f20 636f 7665 720a 2020 2020 2020   no cover.      
+0000a210: 2020 2020 2020 6772 6f75 7073 203d 205b        groups = [
+0000a220: 5b28 7372 635f 7061 7468 2c20 4e6f 6e65  [(src_path, None
+0000a230: 295d 2066 6f72 2073 7263 5f70 6174 6820  )] for src_path 
+0000a240: 696e 2073 7263 5f70 6174 6873 5d0a 2020  in src_paths].  
+0000a250: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000a260: 2020 2020 2020 2020 6772 6f75 7073 203d          groups =
+0000a270: 205f 6772 6f75 705f 7372 635f 7061 7468   _group_src_path
+0000a280: 735f 6279 5f62 6c6f 636b 2873 7263 5f70  s_by_block(src_p
+0000a290: 6174 6873 2c20 626c 6f63 6b5f 7369 7a65  aths, block_size
+0000a2a0: 3d62 6c6f 636b 5f73 697a 6529 0a0a 2020  =block_size)..  
+0000a2b0: 2020 2020 2020 7769 7468 204d 756c 7469        with Multi
+0000a2c0: 5061 7274 5772 6974 6572 2863 6c69 656e  PartWriter(clien
+0000a2d0: 742c 2064 7374 5f70 6174 6829 2061 7320  t, dst_path) as 
+0000a2e0: 7772 6974 6572 2c20 5468 7265 6164 506f  writer, ThreadPo
+0000a2f0: 6f6c 4578 6563 7574 6f72 280a 2020 2020  olExecutor(.    
+0000a300: 2020 2020 2020 2020 2020 2020 6d61 785f              max_
+0000a310: 776f 726b 6572 733d 6d61 785f 776f 726b  workers=max_work
+0000a320: 6572 7329 2061 7320 6578 6563 7574 6f72  ers) as executor
+0000a330: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
+0000a340: 7220 696e 6465 782c 2067 726f 7570 2069  r index, group i
+0000a350: 6e20 656e 756d 6572 6174 6528 6772 6f75  n enumerate(grou
+0000a360: 7073 2c20 7374 6172 743d 3129 3a0a 2020  ps, start=1):.  
+0000a370: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000a380: 206c 656e 2867 726f 7570 2920 3d3d 2031   len(group) == 1
+0000a390: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000a3a0: 2020 2020 2020 6578 6563 7574 6f72 2e73        executor.s
+0000a3b0: 7562 6d69 7428 0a20 2020 2020 2020 2020  ubmit(.         
+0000a3c0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0000a3d0: 7269 7465 722e 7570 6c6f 6164 5f70 6172  riter.upload_par
+0000a3e0: 745f 636f 7079 2c20 696e 6465 782c 2067  t_copy, index, g
+0000a3f0: 726f 7570 5b30 5d5b 305d 2c0a 2020 2020  roup[0][0],.    
+0000a400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a410: 2020 2020 6772 6f75 705b 305d 5b31 5d29      group[0][1])
+0000a420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a430: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000a440: 2020 2020 2020 2020 2020 2065 7865 6375             execu
+0000a450: 746f 722e 7375 626d 6974 2877 7269 7465  tor.submit(write
+0000a460: 722e 7570 6c6f 6164 5f70 6172 745f 6279  r.upload_part_by
+0000a470: 5f70 6174 6873 2c20 696e 6465 782c 2067  _paths, index, g
+0000a480: 726f 7570 290a 0a0a 4053 6d61 7274 5061  roup)...@SmartPa
+0000a490: 7468 2e72 6567 6973 7465 720a 636c 6173  th.register.clas
+0000a4a0: 7320 5333 5061 7468 2855 5249 5061 7468  s S3Path(URIPath
+0000a4b0: 293a 0a0a 2020 2020 7072 6f74 6f63 6f6c  ):..    protocol
+0000a4c0: 203d 2022 7333 220a 0a20 2020 2064 6566   = "s3"..    def
+0000a4d0: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+0000a4e0: 7061 7468 3a20 2250 6174 684c 696b 6522  path: "PathLike"
+0000a4f0: 2c20 2a6f 7468 6572 5f70 6174 6873 3a20  , *other_paths: 
+0000a500: 2250 6174 684c 696b 6522 293a 0a20 2020  "PathLike"):.   
+0000a510: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
+0000a520: 6e69 745f 5f28 7061 7468 2c20 2a6f 7468  nit__(path, *oth
+0000a530: 6572 5f70 6174 6873 290a 2020 2020 2020  er_paths).      
+0000a540: 2020 7072 6f74 6f63 6f6c 203d 2075 726c    protocol = url
+0000a550: 7370 6c69 7428 7365 6c66 2e70 6174 6829  split(self.path)
+0000a560: 2e73 6368 656d 650a 2020 2020 2020 2020  .scheme.        
+0000a570: 7365 6c66 2e5f 7072 6f74 6f63 6f6c 5f77  self._protocol_w
+0000a580: 6974 685f 7072 6f66 696c 6520 3d20 7365  ith_profile = se
+0000a590: 6c66 2e70 726f 746f 636f 6c0a 2020 2020  lf.protocol.    
+0000a5a0: 2020 2020 7365 6c66 2e5f 7072 6f66 696c      self._profil
+0000a5b0: 655f 6e61 6d65 203d 204e 6f6e 650a 2020  e_name = None.  
+0000a5c0: 2020 2020 2020 6966 2070 726f 746f 636f        if protoco
+0000a5d0: 6c2e 7374 6172 7473 7769 7468 2827 7333  l.startswith('s3
+0000a5e0: 2b27 293a 0a20 2020 2020 2020 2020 2020  +'):.           
+0000a5f0: 2073 656c 662e 5f70 726f 746f 636f 6c5f   self._protocol_
+0000a600: 7769 7468 5f70 726f 6669 6c65 203d 2070  with_profile = p
+0000a610: 726f 746f 636f 6c0a 2020 2020 2020 2020  rotocol.        
+0000a620: 2020 2020 7365 6c66 2e5f 7072 6f66 696c      self._profil
+0000a630: 655f 6e61 6d65 203d 2070 726f 746f 636f  e_name = protoco
+0000a640: 6c5b 333a 5d0a 2020 2020 2020 2020 2020  l[3:].          
+0000a650: 2020 7365 6c66 2e5f 7333 5f70 6174 6820    self._s3_path 
+0000a660: 3d20 6622 7333 3a2f 2f7b 7365 6c66 2e70  = f"s3://{self.p
+0000a670: 6174 685b 6c65 6e28 7072 6f74 6f63 6f6c  ath[len(protocol
+0000a680: 292b 333a 5d7d 220a 2020 2020 2020 2020  )+3:]}".        
+0000a690: 656c 6966 206e 6f74 2070 726f 746f 636f  elif not protoco
+0000a6a0: 6c3a 0a20 2020 2020 2020 2020 2020 2073  l:.            s
+0000a6b0: 656c 662e 5f73 335f 7061 7468 203d 2066  elf._s3_path = f
+0000a6c0: 2273 333a 2f2f 7b73 656c 662e 7061 7468  "s3://{self.path
+0000a6d0: 2e6c 7374 7269 7028 272f 2729 7d22 0a20  .lstrip('/')}". 
+0000a6e0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000a6f0: 2020 2020 2020 2020 2073 656c 662e 5f73           self._s
+0000a700: 335f 7061 7468 203d 2073 656c 662e 7061  3_path = self.pa
+0000a710: 7468 0a0a 2020 2020 4063 6163 6865 6470  th..    @cachedp
+0000a720: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+0000a730: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
+0000a740: 6f6c 2873 656c 6629 202d 3e20 7374 723a  ol(self) -> str:
+0000a750: 0a20 2020 2020 2020 2027 2727 5265 7475  .        '''Retu
+0000a760: 726e 2070 6174 6820 7769 7468 2070 726f  rn path with pro
+0000a770: 746f 636f 6c2c 206c 696b 6520 6669 6c65  tocol, like file
+0000a780: 3a2f 2f2f 726f 6f74 2c20 7333 3a2f 2f62  :///root, s3://b
+0000a790: 7563 6b65 742f 6b65 7927 2727 0a20 2020  ucket/key'''.   
+0000a7a0: 2020 2020 2070 6174 6820 3d20 7365 6c66       path = self
+0000a7b0: 2e70 6174 680a 2020 2020 2020 2020 7072  .path.        pr
+0000a7c0: 6f74 6f63 6f6c 5f70 7265 6669 7820 3d20  otocol_prefix = 
+0000a7d0: 7365 6c66 2e5f 7072 6f74 6f63 6f6c 5f77  self._protocol_w
+0000a7e0: 6974 685f 7072 6f66 696c 6520 2b20 223a  ith_profile + ":
+0000a7f0: 2f2f 220a 2020 2020 2020 2020 6966 2070  //".        if p
+0000a800: 6174 682e 7374 6172 7473 7769 7468 2870  ath.startswith(p
+0000a810: 726f 746f 636f 6c5f 7072 6566 6978 293a  rotocol_prefix):
+0000a820: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0000a830: 7572 6e20 7061 7468 0a20 2020 2020 2020  urn path.       
+0000a840: 2072 6574 7572 6e20 7072 6f74 6f63 6f6c   return protocol
+0000a850: 5f70 7265 6669 7820 2b20 7061 7468 2e6c  _prefix + path.l
+0000a860: 7374 7269 7028 272f 2729 0a0a 2020 2020  strip('/')..    
+0000a870: 4063 6163 6865 6470 726f 7065 7274 790a  @cachedproperty.
+0000a880: 2020 2020 6465 6620 7061 7468 5f77 6974      def path_wit
+0000a890: 686f 7574 5f70 726f 746f 636f 6c28 7365  hout_protocol(se
+0000a8a0: 6c66 2920 2d3e 2073 7472 3a0a 2020 2020  lf) -> str:.    
+0000a8b0: 2020 2020 2727 2752 6574 7572 6e20 7061      '''Return pa
+0000a8c0: 7468 2077 6974 686f 7574 2070 726f 746f  th without proto
+0000a8d0: 636f 6c2c 2065 7861 6d70 6c65 3a20 6966  col, example: if
+0000a8e0: 2070 6174 6820 6973 2073 333a 2f2f 6275   path is s3://bu
+0000a8f0: 636b 6574 2f6b 6579 2c20 7265 7475 726e  cket/key, return
+0000a900: 2062 7563 6b65 742f 6b65 7927 2727 0a20   bucket/key'''. 
+0000a910: 2020 2020 2020 2070 6174 6820 3d20 7365         path = se
+0000a920: 6c66 2e70 6174 680a 2020 2020 2020 2020  lf.path.        
+0000a930: 7072 6f74 6f63 6f6c 5f70 7265 6669 7820  protocol_prefix 
+0000a940: 3d20 7365 6c66 2e5f 7072 6f74 6f63 6f6c  = self._protocol
+0000a950: 5f77 6974 685f 7072 6f66 696c 6520 2b20  _with_profile + 
+0000a960: 223a 2f2f 220a 2020 2020 2020 2020 6966  "://".        if
+0000a970: 2070 6174 682e 7374 6172 7473 7769 7468   path.startswith
+0000a980: 2870 726f 746f 636f 6c5f 7072 6566 6978  (protocol_prefix
+0000a990: 293a 0a20 2020 2020 2020 2020 2020 2070  ):.            p
+0000a9a0: 6174 6820 3d20 7061 7468 5b6c 656e 2870  ath = path[len(p
+0000a9b0: 726f 746f 636f 6c5f 7072 6566 6978 293a  rotocol_prefix):
+0000a9c0: 5d0a 2020 2020 2020 2020 7265 7475 726e  ].        return
+0000a9d0: 2070 6174 680a 0a20 2020 2040 6361 6368   path..    @cach
+0000a9e0: 6564 7072 6f70 6572 7479 0a20 2020 2064  edproperty.    d
+0000a9f0: 6566 205f 636c 6965 6e74 2873 656c 6629  ef _client(self)
+0000aa00: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0000aa10: 2067 6574 5f73 335f 636c 6965 6e74 2870   get_s3_client(p
+0000aa20: 726f 6669 6c65 5f6e 616d 653d 7365 6c66  rofile_name=self
+0000aa30: 2e5f 7072 6f66 696c 655f 6e61 6d65 290a  ._profile_name).
+0000aa40: 0a20 2020 2064 6566 205f 7333 5f67 6574  .    def _s3_get
+0000aa50: 5f6d 6574 6164 6174 6128 7365 6c66 2920  _metadata(self) 
+0000aa60: 2d3e 2064 6963 743a 0a20 2020 2020 2020  -> dict:.       
+0000aa70: 2027 2727 0a20 2020 2020 2020 2047 6574   '''.        Get
+0000aa80: 206f 626a 6563 7420 6d65 7461 6461 7461   object metadata
+0000aa90: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+0000aaa0: 2070 6174 683a 204f 626a 6563 7420 7061   path: Object pa
+0000aab0: 7468 0a20 2020 2020 2020 203a 7265 7475  th.        :retu
+0000aac0: 726e 733a 204f 626a 6563 7420 6d65 7461  rns: Object meta
+0000aad0: 6461 7461 0a20 2020 2020 2020 2027 2727  data.        '''
+0000aae0: 0a20 2020 2020 2020 2062 7563 6b65 742c  .        bucket,
+0000aaf0: 206b 6579 203d 2070 6172 7365 5f73 335f   key = parse_s3_
+0000ab00: 7572 6c28 7365 6c66 2e70 6174 685f 7769  url(self.path_wi
+0000ab10: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
+0000ab20: 2020 2020 2069 6620 6e6f 7420 6275 636b       if not buck
+0000ab30: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
+0000ab40: 7265 7475 726e 207b 7d0a 2020 2020 2020  return {}.      
+0000ab50: 2020 6966 206e 6f74 206b 6579 206f 7220    if not key or 
+0000ab60: 6b65 792e 656e 6473 7769 7468 2827 2f27  key.endswith('/'
+0000ab70: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+0000ab80: 6574 7572 6e20 7b7d 0a20 2020 2020 2020  eturn {}.       
+0000ab90: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0000aba0: 2020 7769 7468 2072 6169 7365 5f73 335f    with raise_s3_
+0000abb0: 6572 726f 7228 7365 6c66 2e70 6174 685f  error(self.path_
+0000abc0: 7769 7468 5f70 726f 746f 636f 6c29 3a0a  with_protocol):.
+0000abd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000abe0: 7265 7370 203d 2073 656c 662e 5f63 6c69  resp = self._cli
+0000abf0: 656e 742e 6865 6164 5f6f 626a 6563 7428  ent.head_object(
+0000ac00: 4275 636b 6574 3d62 7563 6b65 742c 204b  Bucket=bucket, K
+0000ac10: 6579 3d6b 6579 290a 2020 2020 2020 2020  ey=key).        
+0000ac20: 2020 2020 7265 7475 726e 2064 6963 7428      return dict(
+0000ac30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ac40: 2028 6b65 792e 6c6f 7765 7228 292c 2076   (key.lower(), v
+0000ac50: 616c 7565 2920 666f 7220 6b65 792c 2076  alue) for key, v
+0000ac60: 616c 7565 2069 6e20 7265 7370 5b27 4d65  alue in resp['Me
+0000ac70: 7461 6461 7461 275d 2e69 7465 6d73 2829  tadata'].items()
+0000ac80: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+0000ac90: 2045 7863 6570 7469 6f6e 3a0a 2020 2020   Exception:.    
+0000aca0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+0000acb0: 7d0a 0a20 2020 2064 6566 2061 6363 6573  }..    def acces
+0000acc0: 7328 0a20 2020 2020 2020 2020 2020 2073  s(.            s
+0000acd0: 656c 662c 206d 6f64 653a 2041 6363 6573  elf, mode: Acces
+0000ace0: 7320 3d20 4163 6365 7373 2e52 4541 442c  s = Access.READ,
+0000acf0: 0a20 2020 2020 2020 2020 2020 2066 6f6c  .            fol
+0000ad00: 6c6f 776c 696e 6b73 3a20 626f 6f6c 203d  lowlinks: bool =
+0000ad10: 2046 616c 7365 2920 2d3e 2062 6f6f 6c3a   False) -> bool:
+0000ad20: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
+0000ad30: 2020 2020 2054 6573 7420 6966 2070 6174       Test if pat
+0000ad40: 6820 6861 7320 6163 6365 7373 2070 6572  h has access per
+0000ad50: 6d69 7373 696f 6e20 6465 7363 7269 6265  mission describe
+0000ad60: 6420 6279 206d 6f64 650a 2020 2020 2020  d by mode.      
+0000ad70: 2020 5573 696e 6720 6865 6164 5f62 7563    Using head_buc
+0000ad80: 6b65 7428 292c 206e 6f77 2052 4541 442f  ket(), now READ/
+0000ad90: 5752 4954 4520 6172 6520 7361 6d65 2e0a  WRITE are same..
+0000ada0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0000adb0: 6d6f 6465 3a20 6163 6365 7373 206d 6f64  mode: access mod
+0000adc0: 650a 2020 2020 2020 2020 3a72 6574 7572  e.        :retur
+0000add0: 6e73 3a20 626f 6f6c 2c20 6966 2074 6865  ns: bool, if the
+0000ade0: 2062 7563 6b65 7420 6f66 2073 335f 7572   bucket of s3_ur
+0000adf0: 6c20 6861 7320 7265 6164 2f77 7269 7465  l has read/write
+0000ae00: 2061 6363 6573 732e 0a20 2020 2020 2020   access..       
+0000ae10: 2027 2727 0a20 2020 2020 2020 2073 335f   '''.        s3_
+0000ae20: 7572 6c20 3d20 7365 6c66 2e70 6174 685f  url = self.path_
+0000ae30: 7769 7468 5f70 726f 746f 636f 6c0a 2020  with_protocol.  
+0000ae40: 2020 2020 2020 6966 2066 6f6c 6c6f 776c        if followl
+0000ae50: 696e 6b73 3a0a 2020 2020 2020 2020 2020  inks:.          
+0000ae60: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0000ae70: 2020 2020 2020 2073 335f 7572 6c20 3d20         s3_url = 
+0000ae80: 7365 6c66 2e72 6561 646c 696e 6b28 292e  self.readlink().
+0000ae90: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
+0000aea0: 6f6c 0a20 2020 2020 2020 2020 2020 2065  ol.            e
+0000aeb0: 7863 6570 7420 5333 4e6f 7441 4c69 6e6b  xcept S3NotALink
+0000aec0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+0000aed0: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
+0000aee0: 2020 2020 6275 636b 6574 2c20 5f20 3d20      bucket, _ = 
+0000aef0: 7061 7273 655f 7333 5f75 726c 2873 335f  parse_s3_url(s3_
+0000af00: 7572 6c29 2020 2320 6f6e 6c79 2063 6865  url)  # only che
+0000af10: 636b 2062 7563 6b65 7420 6163 6365 7373  ck bucket access
+0000af20: 6962 696c 6974 790a 2020 2020 2020 2020  ibility.        
+0000af30: 6966 206e 6f74 2062 7563 6b65 743a 0a20  if not bucket:. 
+0000af40: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000af50: 2045 7863 6570 7469 6f6e 2822 4e6f 2061   Exception("No a
+0000af60: 7661 696c 6162 6c65 2062 7563 6b65 7422  vailable bucket"
+0000af70: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+0000af80: 2069 7369 6e73 7461 6e63 6528 6d6f 6465   isinstance(mode
+0000af90: 2c20 4163 6365 7373 293a 0a20 2020 2020  , Access):.     
+0000afa0: 2020 2020 2020 2072 6169 7365 2054 7970         raise Typ
+0000afb0: 6545 7272 6f72 280a 2020 2020 2020 2020  eError(.        
+0000afc0: 2020 2020 2020 2020 2755 6e73 7570 706f          'Unsuppo
+0000afd0: 7274 6564 206d 6f64 653a 207b 7d20 2d2d  rted mode: {} --
+0000afe0: 204d 6f64 6520 7368 6f75 6c64 2075 7365   Mode should use
+0000aff0: 206f 6e65 206f 6620 7468 6520 656e 756d   one of the enum
+0000b000: 7320 6265 6c6f 6e67 696e 6720 746f 3a20  s belonging to: 
+0000b010: 207b 7d27 0a20 2020 2020 2020 2020 2020   {}'.           
+0000b020: 2020 2020 202e 666f 726d 6174 286d 6f64       .format(mod
+0000b030: 652c 2027 2c20 272e 6a6f 696e 285b 7374  e, ', '.join([st
+0000b040: 7228 6129 2066 6f72 2061 2069 6e20 4163  r(a) for a in Ac
+0000b050: 6365 7373 5d29 2929 0a20 2020 2020 2020  cess]))).       
+0000b060: 2069 6620 6d6f 6465 206e 6f74 2069 6e20   if mode not in 
+0000b070: 2841 6363 6573 732e 5245 4144 2c20 4163  (Access.READ, Ac
+0000b080: 6365 7373 2e57 5249 5445 293a 0a20 2020  cess.WRITE):.   
+0000b090: 2020 2020 2020 2020 2072 6169 7365 2054           raise T
+0000b0a0: 7970 6545 7272 6f72 2827 556e 7375 7070  ypeError('Unsupp
+0000b0b0: 6f72 7465 6420 6d6f 6465 3a20 7b7d 272e  orted mode: {}'.
+0000b0c0: 666f 726d 6174 286d 6f64 6529 290a 2020  format(mode)).  
+0000b0d0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0000b0e0: 2020 2020 2020 2073 656c 662e 5f63 6c69         self._cli
+0000b0f0: 656e 742e 6865 6164 5f62 7563 6b65 7428  ent.head_bucket(
+0000b100: 4275 636b 6574 3d62 7563 6b65 7429 0a20  Bucket=bucket). 
+0000b110: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
+0000b120: 6365 7074 696f 6e20 6173 2065 7272 6f72  ception as error
+0000b130: 3a0a 2020 2020 2020 2020 2020 2020 6572  :.            er
+0000b140: 726f 7220 3d20 7472 616e 736c 6174 655f  ror = translate_
+0000b150: 7333 5f65 7272 6f72 2865 7272 6f72 2c20  s3_error(error, 
+0000b160: 7333 5f75 726c 290a 2020 2020 2020 2020  s3_url).        
+0000b170: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+0000b180: 6528 6572 726f 722c 2028 5333 5065 726d  e(error, (S3Perm
+0000b190: 6973 7369 6f6e 4572 726f 722c 2053 3346  issionError, S3F
+0000b1a0: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
+0000b1b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000b1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b1d0: 2020 2020 5333 4275 636b 6574 4e6f 7446      S3BucketNotF
+0000b1e0: 6f75 6e64 4572 726f 7229 293a 0a20 2020  oundError)):.   
+0000b1f0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0000b200: 7572 6e20 4661 6c73 650a 2020 2020 2020  urn False.      
+0000b210: 2020 2020 2020 7261 6973 6520 6572 726f        raise erro
+0000b220: 720a 2020 2020 2020 2020 7265 7475 726e  r.        return
+0000b230: 2054 7275 650a 0a20 2020 2064 6566 2065   True..    def e
+0000b240: 7869 7374 7328 7365 6c66 2c20 666f 6c6c  xists(self, foll
+0000b250: 6f77 6c69 6e6b 733a 2062 6f6f 6c20 3d20  owlinks: bool = 
+0000b260: 4661 6c73 6529 202d 3e20 626f 6f6c 3a0a  False) -> bool:.
+0000b270: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+0000b280: 2020 2020 5465 7374 2069 6620 7333 5f75      Test if s3_u
+0000b290: 726c 2065 7869 7374 730a 0a20 2020 2020  rl exists..     
+0000b2a0: 2020 2049 6620 7468 6520 6275 636b 6574     If the bucket
+0000b2b0: 206f 6620 7333 5f75 726c 2061 7265 206e   of s3_url are n
+0000b2c0: 6f74 2070 6572 6d69 7474 6564 2074 6f20  ot permitted to 
+0000b2d0: 7265 6164 2c20 7265 7475 726e 2046 616c  read, return Fal
+0000b2e0: 7365 0a0a 2020 2020 2020 2020 3a72 6574  se..        :ret
+0000b2f0: 7572 6e73 3a20 5472 7565 2069 6620 7333  urns: True if s3
+0000b300: 5f75 726c 2065 6978 7374 732c 2065 6c73  _url eixsts, els
+0000b310: 6520 4661 6c73 650a 2020 2020 2020 2020  e False.        
+0000b320: 2727 270a 2020 2020 2020 2020 6275 636b  '''.        buck
+0000b330: 6574 2c20 6b65 7920 3d20 7061 7273 655f  et, key = parse_
+0000b340: 7333 5f75 726c 2873 656c 662e 7061 7468  s3_url(self.path
+0000b350: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
+0000b360: 2020 2020 2020 2020 6966 206e 6f74 2062          if not b
+0000b370: 7563 6b65 743a 2020 2320 7333 3a2f 2f20  ucket:  # s3:// 
+0000b380: 3d3e 2054 7275 652c 2073 333a 2f2f 2f6b  => True, s3:///k
+0000b390: 6579 203d 3e20 4661 6c73 650a 2020 2020  ey => False.    
+0000b3a0: 2020 2020 2020 2020 7265 7475 726e 206e          return n
+0000b3b0: 6f74 206b 6579 0a0a 2020 2020 2020 2020  ot key..        
+0000b3c0: 7265 7475 726e 2073 656c 662e 6973 5f64  return self.is_d
+0000b3d0: 6972 2829 206f 7220 7365 6c66 2e69 735f  ir() or self.is_
+0000b3e0: 6669 6c65 2866 6f6c 6c6f 776c 696e 6b73  file(followlinks
+0000b3f0: 290a 0a20 2020 2064 6566 2067 6574 6d74  )..    def getmt
+0000b400: 696d 6528 7365 6c66 2c20 666f 6c6c 6f77  ime(self, follow
+0000b410: 5f73 796d 6c69 6e6b 733a 2062 6f6f 6c20  _symlinks: bool 
+0000b420: 3d20 4661 6c73 6529 202d 3e20 666c 6f61  = False) -> floa
+0000b430: 743a 0a20 2020 2020 2020 2027 2727 0a20  t:.        '''. 
+0000b440: 2020 2020 2020 2047 6574 206c 6173 742d         Get last-
+0000b450: 6d6f 6469 6669 6564 2074 696d 6520 6f66  modified time of
+0000b460: 2074 6865 2066 696c 6520 6f6e 2074 6865   the file on the
+0000b470: 2067 6976 656e 2073 335f 7572 6c20 7061   given s3_url pa
+0000b480: 7468 2028 696e 2055 6e69 7820 7469 6d65  th (in Unix time
+0000b490: 7374 616d 7020 666f 726d 6174 292e 0a20  stamp format).. 
+0000b4a0: 2020 2020 2020 2049 6620 7468 6520 7061         If the pa
+0000b4b0: 7468 2069 7320 616e 2065 7869 7374 656e  th is an existen
+0000b4c0: 7420 6469 7265 6374 6f72 792c 2072 6574  t directory, ret
+0000b4d0: 7572 6e20 7468 6520 6c61 7465 7374 206d  urn the latest m
+0000b4e0: 6f64 6966 6965 6420 7469 6d65 206f 6620  odified time of 
+0000b4f0: 616c 6c20 6669 6c65 2069 6e20 6974 2e20  all file in it. 
+0000b500: 5468 6520 6d74 696d 6520 6f66 2065 6d70  The mtime of emp
+0000b510: 7479 2064 6972 6563 746f 7279 2069 7320  ty directory is 
+0000b520: 3139 3730 2d30 312d 3031 2030 303a 3030  1970-01-01 00:00
+0000b530: 3a30 300a 0a20 2020 2020 2020 2049 6620  :00..        If 
+0000b540: 7333 5f75 726c 2069 7320 6e6f 7420 616e  s3_url is not an
+0000b550: 2065 7869 7374 656e 7420 7061 7468 2c20   existent path, 
+0000b560: 7768 6963 6820 6d65 616e 7320 7333 5f65  which means s3_e
+0000b570: 7869 7374 2873 335f 7572 6c29 2072 6574  xist(s3_url) ret
+0000b580: 7572 6e73 2046 616c 7365 2c20 7468 656e  urns False, then
+0000b590: 2072 6169 7365 2053 3346 696c 654e 6f74   raise S3FileNot
+0000b5a0: 466f 756e 6445 7272 6f72 0a0a 2020 2020  FoundError..    
+0000b5b0: 2020 2020 3a72 6574 7572 6e73 3a20 4c61      :returns: La
+0000b5c0: 7374 2d6d 6f64 6966 6965 6420 7469 6d65  st-modified time
+0000b5d0: 0a20 2020 2020 2020 203a 7261 6973 6573  .        :raises
+0000b5e0: 3a20 5333 4669 6c65 4e6f 7446 6f75 6e64  : S3FileNotFound
+0000b5f0: 4572 726f 722c 2055 6e73 7570 706f 7274  Error, Unsupport
+0000b600: 6564 4572 726f 720a 2020 2020 2020 2020  edError.        
+0000b610: 2727 270a 2020 2020 2020 2020 7265 7475  '''.        retu
+0000b620: 726e 2073 656c 662e 7374 6174 2866 6f6c  rn self.stat(fol
+0000b630: 6c6f 775f 7379 6d6c 696e 6b73 3d66 6f6c  low_symlinks=fol
+0000b640: 6c6f 775f 7379 6d6c 696e 6b73 292e 6d74  low_symlinks).mt
+0000b650: 696d 650a 0a20 2020 2064 6566 2067 6574  ime..    def get
+0000b660: 7369 7a65 2873 656c 662c 2066 6f6c 6c6f  size(self, follo
+0000b670: 775f 7379 6d6c 696e 6b73 3a20 626f 6f6c  w_symlinks: bool
+0000b680: 203d 2046 616c 7365 2920 2d3e 2069 6e74   = False) -> int
+0000b690: 3a0a 2020 2020 2020 2020 2727 270a 2020  :.        '''.  
+0000b6a0: 2020 2020 2020 4765 7420 6669 6c65 2073        Get file s
+0000b6b0: 697a 6520 6f6e 2074 6865 2067 6976 656e  ize on the given
+0000b6c0: 2073 335f 7572 6c20 7061 7468 2028 696e   s3_url path (in
+0000b6d0: 2062 7974 6573 292e 0a20 2020 2020 2020   bytes)..       
+0000b6e0: 2049 6620 7468 6520 7061 7468 2069 6e20   If the path in 
+0000b6f0: 6120 6469 7265 6374 6f72 792c 2072 6574  a directory, ret
+0000b700: 7572 6e20 7468 6520 7375 6d20 6f66 2061  urn the sum of a
+0000b710: 6c6c 2066 696c 6520 7369 7a65 2069 6e20  ll file size in 
+0000b720: 6974 2c20 696e 636c 7564 696e 6720 6669  it, including fi
+0000b730: 6c65 2069 6e20 7375 6264 6972 6563 746f  le in subdirecto
+0000b740: 7269 6573 2028 6966 2065 7869 7374 292e  ries (if exist).
+0000b750: 0a20 2020 2020 2020 2054 6865 2072 6573  .        The res
+0000b760: 756c 7420 6578 636c 7564 6573 2074 6865  ult excludes the
+0000b770: 2073 697a 6520 6f66 2064 6972 6563 746f   size of directo
+0000b780: 7279 2069 7473 656c 662e 2049 6e20 6f74  ry itself. In ot
+0000b790: 6865 7220 776f 7264 732c 2072 6574 7572  her words, retur
+0000b7a0: 6e20 3020 4279 7465 206f 6e20 616e 2065  n 0 Byte on an e
+0000b7b0: 6d70 7479 2064 6972 6563 746f 7279 2070  mpty directory p
+0000b7c0: 6174 682e 0a0a 2020 2020 2020 2020 4966  ath...        If
+0000b7d0: 2073 335f 7572 6c20 6973 206e 6f74 2061   s3_url is not a
+0000b7e0: 6e20 6578 6973 7465 6e74 2070 6174 682c  n existent path,
+0000b7f0: 2077 6869 6368 206d 6561 6e73 2073 335f   which means s3_
+0000b800: 6578 6973 7428 7333 5f75 726c 2920 7265  exist(s3_url) re
+0000b810: 7475 726e 7320 4661 6c73 652c 2074 6865  turns False, the
+0000b820: 6e20 7261 6973 6520 5333 4669 6c65 4e6f  n raise S3FileNo
+0000b830: 7446 6f75 6e64 4572 726f 720a 0a20 2020  tFoundError..   
+0000b840: 2020 2020 203a 7265 7475 726e 733a 2046       :returns: F
+0000b850: 696c 6520 7369 7a65 0a20 2020 2020 2020  ile size.       
+0000b860: 203a 7261 6973 6573 3a20 5333 4669 6c65   :raises: S3File
+0000b870: 4e6f 7446 6f75 6e64 4572 726f 722c 2055  NotFoundError, U
+0000b880: 6e73 7570 706f 7274 6564 4572 726f 720a  nsupportedError.
+0000b890: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+0000b8a0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0000b8b0: 7374 6174 2866 6f6c 6c6f 775f 7379 6d6c  stat(follow_syml
+0000b8c0: 696e 6b73 3d66 6f6c 6c6f 775f 7379 6d6c  inks=follow_syml
+0000b8d0: 696e 6b73 292e 7369 7a65 0a0a 2020 2020  inks).size..    
+0000b8e0: 6465 6620 676c 6f62 280a 2020 2020 2020  def glob(.      
+0000b8f0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+0000b900: 2020 2020 2020 2020 7061 7474 6572 6e2c          pattern,
+0000b910: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
+0000b920: 7572 7369 7665 3a20 626f 6f6c 203d 2054  ursive: bool = T
+0000b930: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
+0000b940: 206d 6973 7369 6e67 5f6f 6b3a 2062 6f6f   missing_ok: boo
+0000b950: 6c20 3d20 5472 7565 2c0a 2020 2020 2020  l = True,.      
+0000b960: 2020 2020 2020 666f 6c6c 6f77 6c69 6e6b        followlink
+0000b970: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
+0000b980: 0a20 2020 2029 202d 3e20 4c69 7374 5b27  .    ) -> List['
+0000b990: 5333 5061 7468 275d 3a0a 2020 2020 2020  S3Path']:.      
+0000b9a0: 2020 2727 2752 6574 7572 6e20 7333 2070    '''Return s3 p
+0000b9b0: 6174 6820 6c69 7374 2069 6e20 6173 6365  ath list in asce
+0000b9c0: 6e64 696e 6720 616c 7068 6162 6574 6963  nding alphabetic
+0000b9d0: 616c 206f 7264 6572 2c20 696e 2077 6869  al order, in whi
+0000b9e0: 6368 2070 6174 6820 6d61 7463 6865 7320  ch path matches 
+0000b9f0: 676c 6f62 2070 6174 7465 726e 0a20 2020  glob pattern.   
+0000ba00: 2020 2020 204e 6f74 6573 3a20 4f6e 6c79       Notes: Only
+0000ba10: 2067 6c6f 6220 696e 2062 7563 6b65 742e   glob in bucket.
+0000ba20: 2049 6620 7472 7969 6e67 2074 6f20 6d61   If trying to ma
+0000ba30: 7463 6820 6275 636b 6574 2077 6974 6820  tch bucket with 
+0000ba40: 7769 6c64 6361 7264 2063 6861 7261 6374  wildcard charact
+0000ba50: 6572 732c 2072 6169 7365 2055 6e73 7570  ers, raise Unsup
+0000ba60: 706f 7274 6564 4572 726f 720a 0a20 2020  portedError..   
+0000ba70: 2020 2020 203a 7061 7261 6d20 7061 7474       :param patt
+0000ba80: 6572 6e3a 2047 6c6f 6220 7468 6520 6769  ern: Glob the gi
+0000ba90: 7665 6e20 7265 6c61 7469 7665 2070 6174  ven relative pat
+0000baa0: 7465 726e 2069 6e20 7468 6520 6469 7265  tern in the dire
+0000bab0: 6374 6f72 7920 7265 7072 6573 656e 7465  ctory represente
+0000bac0: 6420 6279 2074 6869 7320 7061 7468 0a20  d by this path. 
+0000bad0: 2020 2020 2020 203a 7061 7261 6d20 7265         :param re
+0000bae0: 6375 7273 6976 653a 2049 6620 4661 6c73  cursive: If Fals
+0000baf0: 652c 2060 2a2a 6020 7769 6c6c 206e 6f74  e, `**` will not
+0000bb00: 2073 6561 7263 6820 6469 7265 6374 6f72   search director
+0000bb10: 7920 7265 6375 7273 6976 656c 790a 2020  y recursively.  
+0000bb20: 2020 2020 2020 3a70 6172 616d 206d 6973        :param mis
+0000bb30: 7369 6e67 5f6f 6b3a 2049 6620 4661 6c73  sing_ok: If Fals
+0000bb40: 6520 616e 6420 7461 7267 6574 2070 6174  e and target pat
+0000bb50: 6820 646f 6573 6e27 7420 6d61 7463 6820  h doesn't match 
+0000bb60: 616e 7920 6669 6c65 2c20 7261 6973 6520  any file, raise 
+0000bb70: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
+0000bb80: 720a 2020 2020 2020 2020 3a72 6169 7365  r.        :raise
+0000bb90: 733a 2055 6e73 7570 706f 7274 6564 4572  s: UnsupportedEr
+0000bba0: 726f 722c 2077 6865 6e20 6275 636b 6574  ror, when bucket
+0000bbb0: 2070 6172 7420 636f 6e74 6169 6e73 2077   part contains w
+0000bbc0: 696c 6463 6172 6420 6368 6172 6163 7465  ildcard characte
+0000bbd0: 7273 0a20 2020 2020 2020 203a 7265 7475  rs.        :retu
+0000bbe0: 726e 733a 2041 206c 6973 7420 636f 6e74  rns: A list cont
+0000bbf0: 6169 6e73 2070 6174 6873 206d 6174 6368  ains paths match
+0000bc00: 2060 7333 5f70 6174 686e 616d 6560 0a20   `s3_pathname`. 
+0000bc10: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+0000bc20: 2020 2072 6574 7572 6e20 6c69 7374 280a     return list(.
+0000bc30: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000bc40: 2e69 676c 6f62 280a 2020 2020 2020 2020  .iglob(.        
+0000bc50: 2020 2020 2020 2020 7061 7474 6572 6e3d          pattern=
+0000bc60: 7061 7474 6572 6e2c 0a20 2020 2020 2020  pattern,.       
+0000bc70: 2020 2020 2020 2020 2072 6563 7572 7369           recursi
+0000bc80: 7665 3d72 6563 7572 7369 7665 2c0a 2020  ve=recursive,.  
+0000bc90: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
+0000bca0: 7373 696e 675f 6f6b 3d6d 6973 7369 6e67  ssing_ok=missing
+0000bcb0: 5f6f 6b2c 0a20 2020 2020 2020 2020 2020  _ok,.           
+0000bcc0: 2020 2020 2066 6f6c 6c6f 776c 696e 6b73       followlinks
+0000bcd0: 3d66 6f6c 6c6f 776c 696e 6b73 2929 0a0a  =followlinks))..
+0000bce0: 2020 2020 6465 6620 676c 6f62 5f73 7461      def glob_sta
+0000bcf0: 7428 0a20 2020 2020 2020 2020 2020 2073  t(.            s
+0000bd00: 656c 662c 0a20 2020 2020 2020 2020 2020  elf,.           
+0000bd10: 2070 6174 7465 726e 2c0a 2020 2020 2020   pattern,.      
+0000bd20: 2020 2020 2020 7265 6375 7273 6976 653a        recursive:
+0000bd30: 2062 6f6f 6c20 3d20 5472 7565 2c0a 2020   bool = True,.  
+0000bd40: 2020 2020 2020 2020 2020 6d69 7373 696e            missin
+0000bd50: 675f 6f6b 3a20 626f 6f6c 203d 2054 7275  g_ok: bool = Tru
+0000bd60: 652c 0a20 2020 2020 2020 2020 2020 2066  e,.            f
+0000bd70: 6f6c 6c6f 776c 696e 6b73 3a20 626f 6f6c  ollowlinks: bool
+0000bd80: 203d 2046 616c 7365 2920 2d3e 2049 7465   = False) -> Ite
+0000bd90: 7261 746f 725b 4669 6c65 456e 7472 795d  rator[FileEntry]
+0000bda0: 3a0a 2020 2020 2020 2020 2727 2752 6574  :.        '''Ret
+0000bdb0: 7572 6e20 6120 6765 6e65 7261 746f 7220  urn a generator 
+0000bdc0: 636f 6e74 6169 6e73 2074 7570 6c65 7320  contains tuples 
+0000bdd0: 6f66 2070 6174 6820 616e 6420 6669 6c65  of path and file
+0000bde0: 2073 7461 742c 2069 6e20 6173 6365 6e64   stat, in ascend
+0000bdf0: 696e 6720 616c 7068 6162 6574 6963 616c  ing alphabetical
+0000be00: 206f 7264 6572 2c20 696e 2077 6869 6368   order, in which
+0000be10: 2070 6174 6820 6d61 7463 6865 7320 676c   path matches gl
+0000be20: 6f62 2070 6174 7465 726e 0a20 2020 2020  ob pattern.     
+0000be30: 2020 204e 6f74 6573 3a20 4f6e 6c79 2067     Notes: Only g
+0000be40: 6c6f 6220 696e 2062 7563 6b65 742e 2049  lob in bucket. I
+0000be50: 6620 7472 7969 6e67 2074 6f20 6d61 7463  f trying to matc
+0000be60: 6820 6275 636b 6574 2077 6974 6820 7769  h bucket with wi
+0000be70: 6c64 6361 7264 2063 6861 7261 6374 6572  ldcard character
+0000be80: 732c 2072 6169 7365 2055 6e73 7570 706f  s, raise Unsuppo
+0000be90: 7274 6564 4572 726f 720a 0a20 2020 2020  rtedError..     
+0000bea0: 2020 203a 7061 7261 6d20 7061 7474 6572     :param patter
+0000beb0: 6e3a 2047 6c6f 6220 7468 6520 6769 7665  n: Glob the give
+0000bec0: 6e20 7265 6c61 7469 7665 2070 6174 7465  n relative patte
+0000bed0: 726e 2069 6e20 7468 6520 6469 7265 6374  rn in the direct
+0000bee0: 6f72 7920 7265 7072 6573 656e 7465 6420  ory represented 
+0000bef0: 6279 2074 6869 7320 7061 7468 0a20 2020  by this path.   
+0000bf00: 2020 2020 203a 7061 7261 6d20 7265 6375       :param recu
+0000bf10: 7273 6976 653a 2049 6620 4661 6c73 652c  rsive: If False,
+0000bf20: 2060 2a2a 6020 7769 6c6c 206e 6f74 2073   `**` will not s
+0000bf30: 6561 7263 6820 6469 7265 6374 6f72 7920  earch directory 
+0000bf40: 7265 6375 7273 6976 656c 790a 2020 2020  recursively.    
+0000bf50: 2020 2020 3a70 6172 616d 206d 6973 7369      :param missi
+0000bf60: 6e67 5f6f 6b3a 2049 6620 4661 6c73 6520  ng_ok: If False 
+0000bf70: 616e 6420 7461 7267 6574 2070 6174 6820  and target path 
+0000bf80: 646f 6573 6e27 7420 6d61 7463 6820 616e  doesn't match an
+0000bf90: 7920 6669 6c65 2c20 7261 6973 6520 4669  y file, raise Fi
+0000bfa0: 6c65 4e6f 7446 6f75 6e64 4572 726f 720a  leNotFoundError.
+0000bfb0: 2020 2020 2020 2020 3a72 6169 7365 733a          :raises:
+0000bfc0: 2055 6e73 7570 706f 7274 6564 4572 726f   UnsupportedErro
+0000bfd0: 722c 2077 6865 6e20 6275 636b 6574 2070  r, when bucket p
+0000bfe0: 6172 7420 636f 6e74 6169 6e73 2077 696c  art contains wil
+0000bff0: 6463 6172 6420 6368 6172 6163 7465 7273  dcard characters
+0000c000: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+0000c010: 733a 2041 2067 656e 6572 6174 6f72 2063  s: A generator c
+0000c020: 6f6e 7461 696e 7320 7475 706c 6573 206f  ontains tuples o
+0000c030: 6620 7061 7468 2061 6e64 2066 696c 6520  f path and file 
+0000c040: 7374 6174 2c20 696e 2077 6869 6368 2070  stat, in which p
+0000c050: 6174 6873 206d 6174 6368 2060 7333 5f70  aths match `s3_p
+0000c060: 6174 686e 616d 6560 0a20 2020 2020 2020  athname`.       
+0000c070: 2027 2727 0a20 2020 2020 2020 2067 6c6f   '''.        glo
+0000c080: 625f 7061 7468 203d 2073 656c 662e 5f73  b_path = self._s
+0000c090: 335f 7061 7468 0a20 2020 2020 2020 2069  3_path.        i
+0000c0a0: 6620 7061 7474 6572 6e3a 0a20 2020 2020  f pattern:.     
+0000c0b0: 2020 2020 2020 2067 6c6f 625f 7061 7468         glob_path
+0000c0c0: 203d 2073 656c 662e 6a6f 696e 7061 7468   = self.joinpath
+0000c0d0: 2870 6174 7465 726e 292e 5f73 335f 7061  (pattern)._s3_pa
+0000c0e0: 7468 2020 2320 7079 7479 7065 3a20 6469  th  # pytype: di
+0000c0f0: 7361 626c 653d 6174 7472 6962 7574 652d  sable=attribute-
+0000c100: 6572 726f 720a 2020 2020 2020 2020 7333  error.        s3
+0000c110: 5f70 6174 686e 616d 6520 3d20 6673 7061  _pathname = fspa
+0000c120: 7468 2867 6c6f 625f 7061 7468 290a 0a20  th(glob_path).. 
+0000c130: 2020 2020 2020 2064 6566 2063 7265 6174         def creat
+0000c140: 655f 6765 6e65 7261 746f 7228 293a 0a20  e_generator():. 
+0000c150: 2020 2020 2020 2020 2020 2066 6f72 2067             for g
+0000c160: 726f 7570 5f73 335f 7061 7468 6e61 6d65  roup_s3_pathname
+0000c170: 5f31 2069 6e20 5f67 726f 7570 5f73 3370  _1 in _group_s3p
+0000c180: 6174 685f 6279 5f62 7563 6b65 7428 0a20  ath_by_bucket(. 
+0000c190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c1a0: 2020 2073 335f 7061 7468 6e61 6d65 2c20     s3_pathname, 
+0000c1b0: 7365 6c66 2e5f 7072 6f66 696c 655f 6e61  self._profile_na
+0000c1c0: 6d65 293a 0a20 2020 2020 2020 2020 2020  me):.           
+0000c1d0: 2020 2020 2066 6f72 2067 726f 7570 5f73       for group_s
+0000c1e0: 335f 7061 7468 6e61 6d65 5f32 2069 6e20  3_pathname_2 in 
+0000c1f0: 5f67 726f 7570 5f73 3370 6174 685f 6279  _group_s3path_by
+0000c200: 5f70 7265 6669 7828 0a20 2020 2020 2020  _prefix(.       
+0000c210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c220: 2067 726f 7570 5f73 335f 7061 7468 6e61   group_s3_pathna
+0000c230: 6d65 5f31 293a 0a20 2020 2020 2020 2020  me_1):.         
+0000c240: 2020 2020 2020 2020 2020 2066 6f72 2066             for f
+0000c250: 696c 655f 656e 7472 7920 696e 205f 7333  ile_entry in _s3
+0000c260: 5f67 6c6f 625f 7374 6174 5f73 696e 676c  _glob_stat_singl
+0000c270: 655f 7061 7468 280a 2020 2020 2020 2020  e_path(.        
+0000c280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c290: 2020 2020 6772 6f75 705f 7333 5f70 6174      group_s3_pat
+0000c2a0: 686e 616d 655f 322c 2072 6563 7572 7369  hname_2, recursi
+0000c2b0: 7665 2c20 6d69 7373 696e 675f 6f6b 2c0a  ve, missing_ok,.
+0000c2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c2d0: 2020 2020 2020 2020 2020 2020 666f 6c6c              foll
+0000c2e0: 6f77 6c69 6e6b 733d 666f 6c6c 6f77 6c69  owlinks=followli
+0000c2f0: 6e6b 732c 0a20 2020 2020 2020 2020 2020  nks,.           
+0000c300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c310: 2070 726f 6669 6c65 5f6e 616d 653d 7365   profile_name=se
+0000c320: 6c66 2e5f 7072 6f66 696c 655f 6e61 6d65  lf._profile_name
+0000c330: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000c340: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+0000c350: 6c66 2e5f 7072 6f66 696c 655f 6e61 6d65  lf._profile_name
+0000c360: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000c370: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+0000c380: 6c65 5f65 6e74 7279 203d 2066 696c 655f  le_entry = file_
+0000c390: 656e 7472 792e 5f72 6570 6c61 6365 280a  entry._replace(.
+0000c3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c3c0: 7061 7468 3d0a 2020 2020 2020 2020 2020  path=.          
+0000c3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c3e0: 2020 2020 2020 6622 7b73 656c 662e 5f70        f"{self._p
+0000c3f0: 726f 746f 636f 6c5f 7769 7468 5f70 726f  rotocol_with_pro
+0000c400: 6669 6c65 7d3a 2f2f 7b66 696c 655f 656e  file}://{file_en
+0000c410: 7472 792e 7061 7468 5b35 3a5d 7d22 0a20  try.path[5:]}". 
+0000c420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c430: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0000c440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c450: 2020 2020 2079 6965 6c64 2066 696c 655f       yield file_
+0000c460: 656e 7472 790a 0a20 2020 2020 2020 2072  entry..        r
+0000c470: 6574 7572 6e20 5f63 7265 6174 655f 6d69  eturn _create_mi
+0000c480: 7373 696e 675f 6f6b 5f67 656e 6572 6174  ssing_ok_generat
+0000c490: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+0000c4a0: 6372 6561 7465 5f67 656e 6572 6174 6f72  create_generator
+0000c4b0: 2829 2c20 6d69 7373 696e 675f 6f6b 2c0a  (), missing_ok,.
+0000c4c0: 2020 2020 2020 2020 2020 2020 5333 4669              S3Fi
+0000c4d0: 6c65 4e6f 7446 6f75 6e64 4572 726f 7228  leNotFoundError(
+0000c4e0: 274e 6f20 6d61 7463 6820 6669 6c65 3a20  'No match file: 
+0000c4f0: 2572 2720 2520 7333 5f70 6174 686e 616d  %r' % s3_pathnam
+0000c500: 6529 290a 0a20 2020 2064 6566 2069 676c  e))..    def igl
+0000c510: 6f62 280a 2020 2020 2020 2020 2020 2020  ob(.            
+0000c520: 7365 6c66 2c0a 2020 2020 2020 2020 2020  self,.          
+0000c530: 2020 7061 7474 6572 6e2c 0a20 2020 2020    pattern,.     
+0000c540: 2020 2020 2020 2072 6563 7572 7369 7665         recursive
+0000c550: 3a20 626f 6f6c 203d 2054 7275 652c 0a20  : bool = True,. 
+0000c560: 2020 2020 2020 2020 2020 206d 6973 7369             missi
+0000c570: 6e67 5f6f 6b3a 2062 6f6f 6c20 3d20 5472  ng_ok: bool = Tr
+0000c580: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+0000c590: 666f 6c6c 6f77 6c69 6e6b 733a 2062 6f6f  followlinks: boo
+0000c5a0: 6c20 3d20 4661 6c73 652c 0a20 2020 2029  l = False,.    )
+0000c5b0: 202d 3e20 4974 6572 6174 6f72 5b27 5333   -> Iterator['S3
+0000c5c0: 5061 7468 275d 3a0a 2020 2020 2020 2020  Path']:.        
+0000c5d0: 2727 2752 6574 7572 6e20 7333 2070 6174  '''Return s3 pat
+0000c5e0: 6820 6974 6572 6174 6f72 2069 6e20 6173  h iterator in as
+0000c5f0: 6365 6e64 696e 6720 616c 7068 6162 6574  cending alphabet
+0000c600: 6963 616c 206f 7264 6572 2c20 696e 2077  ical order, in w
+0000c610: 6869 6368 2070 6174 6820 6d61 7463 6865  hich path matche
+0000c620: 7320 676c 6f62 2070 6174 7465 726e 0a20  s glob pattern. 
+0000c630: 2020 2020 2020 204e 6f74 6573 3a20 4f6e         Notes: On
+0000c640: 6c79 2067 6c6f 6220 696e 2062 7563 6b65  ly glob in bucke
+0000c650: 742e 2049 6620 7472 7969 6e67 2074 6f20  t. If trying to 
+0000c660: 6d61 7463 6820 6275 636b 6574 2077 6974  match bucket wit
+0000c670: 6820 7769 6c64 6361 7264 2063 6861 7261  h wildcard chara
+0000c680: 6374 6572 732c 2072 6169 7365 2055 6e73  cters, raise Uns
+0000c690: 7570 706f 7274 6564 4572 726f 720a 0a20  upportedError.. 
+0000c6a0: 2020 2020 2020 203a 7061 7261 6d20 7061         :param pa
+0000c6b0: 7474 6572 6e3a 2047 6c6f 6220 7468 6520  ttern: Glob the 
+0000c6c0: 6769 7665 6e20 7265 6c61 7469 7665 2070  given relative p
+0000c6d0: 6174 7465 726e 2069 6e20 7468 6520 6469  attern in the di
+0000c6e0: 7265 6374 6f72 7920 7265 7072 6573 656e  rectory represen
+0000c6f0: 7465 6420 6279 2074 6869 7320 7061 7468  ted by this path
+0000c700: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0000c710: 7265 6375 7273 6976 653a 2049 6620 4661  recursive: If Fa
+0000c720: 6c73 652c 2060 2a2a 6020 7769 6c6c 206e  lse, `**` will n
+0000c730: 6f74 2073 6561 7263 6820 6469 7265 6374  ot search direct
+0000c740: 6f72 7920 7265 6375 7273 6976 656c 790a  ory recursively.
+0000c750: 2020 2020 2020 2020 3a70 6172 616d 206d          :param m
+0000c760: 6973 7369 6e67 5f6f 6b3a 2049 6620 4661  issing_ok: If Fa
+0000c770: 6c73 6520 616e 6420 7461 7267 6574 2070  lse and target p
+0000c780: 6174 6820 646f 6573 6e27 7420 6d61 7463  ath doesn't matc
+0000c790: 6820 616e 7920 6669 6c65 2c20 7261 6973  h any file, rais
+0000c7a0: 6520 4669 6c65 4e6f 7446 6f75 6e64 4572  e FileNotFoundEr
+0000c7b0: 726f 720a 2020 2020 2020 2020 3a72 6169  ror.        :rai
+0000c7c0: 7365 733a 2055 6e73 7570 706f 7274 6564  ses: Unsupported
+0000c7d0: 4572 726f 722c 2077 6865 6e20 6275 636b  Error, when buck
+0000c7e0: 6574 2070 6172 7420 636f 6e74 6169 6e73  et part contains
+0000c7f0: 2077 696c 6463 6172 6420 6368 6172 6163   wildcard charac
+0000c800: 7465 7273 0a20 2020 2020 2020 203a 7265  ters.        :re
+0000c810: 7475 726e 733a 2041 6e20 6974 6572 6174  turns: An iterat
+0000c820: 6f72 2063 6f6e 7461 696e 7320 7061 7468  or contains path
+0000c830: 7320 6d61 7463 6820 6073 335f 7061 7468  s match `s3_path
+0000c840: 6e61 6d65 600a 2020 2020 2020 2020 2727  name`.        ''
+0000c850: 270a 2020 2020 2020 2020 666f 7220 6669  '.        for fi
+0000c860: 6c65 5f65 6e74 7279 2069 6e20 7365 6c66  le_entry in self
+0000c870: 2e67 6c6f 625f 7374 6174 2870 6174 7465  .glob_stat(patte
+0000c880: 726e 3d70 6174 7465 726e 2c20 7265 6375  rn=pattern, recu
+0000c890: 7273 6976 653d 7265 6375 7273 6976 652c  rsive=recursive,
+0000c8a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c8c0: 2020 2020 2020 2020 2020 6d69 7373 696e            missin
+0000c8d0: 675f 6f6b 3d6d 6973 7369 6e67 5f6f 6b2c  g_ok=missing_ok,
+0000c8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c900: 2020 2020 2020 2020 2020 666f 6c6c 6f77            follow
+0000c910: 6c69 6e6b 733d 666f 6c6c 6f77 6c69 6e6b  links=followlink
+0000c920: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+0000c930: 7969 656c 6420 7365 6c66 2e66 726f 6d5f  yield self.from_
+0000c940: 7061 7468 2866 696c 655f 656e 7472 792e  path(file_entry.
+0000c950: 7061 7468 290a 0a20 2020 2064 6566 2069  path)..    def i
+0000c960: 735f 6469 7228 7365 6c66 2c20 666f 6c6c  s_dir(self, foll
+0000c970: 6f77 6c69 6e6b 733a 2062 6f6f 6c20 3d20  owlinks: bool = 
+0000c980: 4661 6c73 6529 202d 3e20 626f 6f6c 3a0a  False) -> bool:.
+0000c990: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+0000c9a0: 2020 2020 5465 7374 2069 6620 616e 2073      Test if an s
+0000c9b0: 3320 7572 6c20 6973 2064 6972 6563 746f  3 url is directo
+0000c9c0: 7279 0a20 2020 2020 2020 2053 7065 6369  ry.        Speci
+0000c9d0: 6669 6320 7072 6f63 6564 7572 6573 2061  fic procedures a
+0000c9e0: 7265 2061 7320 666f 6c6c 6f77 733a 0a20  re as follows:. 
+0000c9f0: 2020 2020 2020 2049 6620 7468 6572 6520         If there 
+0000ca00: 6578 6973 7473 2061 2073 7566 6669 782c  exists a suffix,
+0000ca10: 206f 6620 7768 6963 6820 6060 6f73 2e70   of which ``os.p
+0000ca20: 6174 682e 6a6f 696e 2873 335f 7572 6c2c  ath.join(s3_url,
+0000ca30: 2073 7566 6669 7829 6060 2069 7320 6120   suffix)`` is a 
+0000ca40: 6669 6c65 0a20 2020 2020 2020 2049 6620  file.        If 
+0000ca50: 7468 6520 7572 6c20 6973 2065 6d70 7479  the url is empty
+0000ca60: 2062 7563 6b65 7420 6f72 2073 333a 2f2f   bucket or s3://
+0000ca70: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+0000ca80: 2066 6f6c 6c6f 776c 696e 6b73 3a20 7768   followlinks: wh
+0000ca90: 6574 6865 7220 666f 6c6c 6f77 6c69 6e6b  ether followlink
+0000caa0: 7320 6973 2054 7275 6520 6f72 2046 616c  s is True or Fal
+0000cab0: 7365 2c20 7265 7375 6c74 2069 7320 7468  se, result is th
+0000cac0: 6520 7361 6d65 2e20 4265 6361 7573 6520  e same. Because 
+0000cad0: 7333 2073 796d 6c69 6e6b 206e 6f74 2073  s3 symlink not s
+0000cae0: 7570 706f 7274 2064 6972 2e0a 2020 2020  upport dir..    
+0000caf0: 2020 2020 3a72 6574 7572 6e73 3a20 5472      :returns: Tr
+0000cb00: 7565 2069 6620 7061 7468 2069 7320 7333  ue if path is s3
+0000cb10: 2064 6972 6563 746f 7279 2c20 656c 7365   directory, else
+0000cb20: 2046 616c 7365 0a20 2020 2020 2020 2027   False.        '
+0000cb30: 2727 0a20 2020 2020 2020 2062 7563 6b65  ''.        bucke
+0000cb40: 742c 206b 6579 203d 2070 6172 7365 5f73  t, key = parse_s
+0000cb50: 335f 7572 6c28 7365 6c66 2e70 6174 685f  3_url(self.path_
+0000cb60: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
+0000cb70: 2020 2020 2020 2069 6620 6e6f 7420 6275         if not bu
+0000cb80: 636b 6574 3a20 2023 2073 333a 2f2f 203d  cket:  # s3:// =
+0000cb90: 3e20 5472 7565 2c20 7333 3a2f 2f2f 6b65  > True, s3:///ke
+0000cba0: 7920 3d3e 2046 616c 7365 0a20 2020 2020  y => False.     
+0000cbb0: 2020 2020 2020 2072 6574 7572 6e20 6e6f         return no
+0000cbc0: 7420 6b65 790a 2020 2020 2020 2020 7072  t key.        pr
+0000cbd0: 6566 6978 203d 205f 6265 636f 6d65 5f70  efix = _become_p
+0000cbe0: 7265 6669 7828 6b65 7929 0a20 2020 2020  refix(key).     
+0000cbf0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0000cc00: 2020 2020 7265 7370 203d 2073 656c 662e      resp = self.
+0000cc10: 5f63 6c69 656e 742e 6c69 7374 5f6f 626a  _client.list_obj
+0000cc20: 6563 7473 5f76 3228 0a20 2020 2020 2020  ects_v2(.       
+0000cc30: 2020 2020 2020 2020 2042 7563 6b65 743d           Bucket=
+0000cc40: 6275 636b 6574 2c20 5072 6566 6978 3d70  bucket, Prefix=p
+0000cc50: 7265 6669 782c 2044 656c 696d 6974 6572  refix, Delimiter
+0000cc60: 3d27 2f27 2c20 4d61 784b 6579 733d 3129  ='/', MaxKeys=1)
+0000cc70: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+0000cc80: 4578 6365 7074 696f 6e20 6173 2065 7272  Exception as err
+0000cc90: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+0000cca0: 6572 726f 7220 3d20 7472 616e 736c 6174  error = translat
+0000ccb0: 655f 7333 5f65 7272 6f72 2865 7272 6f72  e_s3_error(error
+0000ccc0: 2c20 7365 6c66 2e70 6174 685f 7769 7468  , self.path_with
+0000ccd0: 5f70 726f 746f 636f 6c29 0a20 2020 2020  _protocol).     
+0000cce0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+0000ccf0: 616e 6365 2865 7272 6f72 2c20 2853 3355  ance(error, (S3U
+0000cd00: 6e6b 6e6f 776e 4572 726f 722c 2053 3343  nknownError, S3C
+0000cd10: 6f6e 6669 6745 7272 6f72 2929 3a0a 2020  onfigError)):.  
+0000cd20: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0000cd30: 6973 6520 6572 726f 720a 2020 2020 2020  ise error.      
+0000cd40: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
+0000cd50: 7365 0a0a 2020 2020 2020 2020 6966 206e  se..        if n
+0000cd60: 6f74 206b 6579 3a20 2023 2062 7563 6b65  ot key:  # bucke
+0000cd70: 7420 6973 2061 6363 6573 7369 626c 650a  t is accessible.
+0000cd80: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000cd90: 726e 2054 7275 650a 0a20 2020 2020 2020  rn True..       
+0000cda0: 2069 6620 274b 6579 436f 756e 7427 2069   if 'KeyCount' i
+0000cdb0: 6e20 7265 7370 3a0a 2020 2020 2020 2020  n resp:.        
+0000cdc0: 2020 2020 7265 7475 726e 2072 6573 705b      return resp[
+0000cdd0: 274b 6579 436f 756e 7427 5d20 3e20 300a  'KeyCount'] > 0.
+0000cde0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000cdf0: 6c65 6e28 7265 7370 2e67 6574 2827 436f  len(resp.get('Co
+0000ce00: 6e74 656e 7473 272c 205b 5d29 2920 3e20  ntents', [])) > 
+0000ce10: 3020 6f72 205c 0a20 2020 2020 2020 2020  0 or \.         
+0000ce20: 2020 206c 656e 2872 6573 702e 6765 7428     len(resp.get(
+0000ce30: 2743 6f6d 6d6f 6e50 7265 6669 7865 7327  'CommonPrefixes'
+0000ce40: 2c20 5b5d 2929 203e 2030 0a0a 2020 2020  , [])) > 0..    
+0000ce50: 6465 6620 6973 5f66 696c 6528 7365 6c66  def is_file(self
+0000ce60: 2c20 666f 6c6c 6f77 6c69 6e6b 733a 2062  , followlinks: b
+0000ce70: 6f6f 6c20 3d20 4661 6c73 6529 202d 3e20  ool = False) -> 
+0000ce80: 626f 6f6c 3a0a 2020 2020 2020 2020 2727  bool:.        ''
+0000ce90: 270a 2020 2020 2020 2020 5465 7374 2069  '.        Test i
+0000cea0: 6620 616e 2073 335f 7572 6c20 6973 2066  f an s3_url is f
+0000ceb0: 696c 650a 0a20 2020 2020 2020 203a 7265  ile..        :re
+0000cec0: 7475 726e 733a 2054 7275 6520 6966 2070  turns: True if p
+0000ced0: 6174 6820 6973 2073 3320 6669 6c65 2c20  ath is s3 file, 
+0000cee0: 656c 7365 2046 616c 7365 0a20 2020 2020  else False.     
+0000cef0: 2020 2027 2727 0a20 2020 2020 2020 2073     '''.        s
+0000cf00: 335f 7572 6c20 3d20 7365 6c66 2e70 6174  3_url = self.pat
+0000cf10: 685f 7769 7468 5f70 726f 746f 636f 6c0a  h_with_protocol.
+0000cf20: 2020 2020 2020 2020 6966 2066 6f6c 6c6f          if follo
+0000cf30: 776c 696e 6b73 3a0a 2020 2020 2020 2020  wlinks:.        
+0000cf40: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0000cf50: 2020 2020 2020 2020 2073 335f 7572 6c20           s3_url 
+0000cf60: 3d20 7365 6c66 2e72 6561 646c 696e 6b28  = self.readlink(
+0000cf70: 292e 7061 7468 5f77 6974 685f 7072 6f74  ).path_with_prot
+0000cf80: 6f63 6f6c 0a20 2020 2020 2020 2020 2020  ocol.           
+0000cf90: 2065 7863 6570 7420 5333 4e6f 7441 4c69   except S3NotALi
+0000cfa0: 6e6b 4572 726f 723a 0a20 2020 2020 2020  nkError:.       
+0000cfb0: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
+0000cfc0: 2020 2020 2020 6275 636b 6574 2c20 6b65        bucket, ke
+0000cfd0: 7920 3d20 7061 7273 655f 7333 5f75 726c  y = parse_s3_url
+0000cfe0: 2873 335f 7572 6c29 0a20 2020 2020 2020  (s3_url).       
+0000cff0: 2069 6620 6e6f 7420 6275 636b 6574 206f   if not bucket o
+0000d000: 7220 6e6f 7420 6b65 7920 6f72 206b 6579  r not key or key
+0000d010: 2e65 6e64 7377 6974 6828 272f 2729 3a0a  .endswith('/'):.
+0000d020: 2020 2020 2020 2020 2020 2020 2320 7333              # s3
+0000d030: 3a2f 2f2c 2073 333a 2f2f 2f6b 6579 2c20  ://, s3:///key, 
+0000d040: 7333 3a2f 2f62 7563 6b65 742c 2073 333a  s3://bucket, s3:
+0000d050: 2f2f 6275 636b 6574 2f70 7265 6669 782f  //bucket/prefix/
+0000d060: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0000d070: 7572 6e20 4661 6c73 650a 2020 2020 2020  urn False.      
+0000d080: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0000d090: 2020 2073 656c 662e 5f63 6c69 656e 742e     self._client.
+0000d0a0: 6865 6164 5f6f 626a 6563 7428 4275 636b  head_object(Buck
+0000d0b0: 6574 3d62 7563 6b65 742c 204b 6579 3d6b  et=bucket, Key=k
+0000d0c0: 6579 290a 2020 2020 2020 2020 6578 6365  ey).        exce
+0000d0d0: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
+0000d0e0: 6572 726f 723a 0a20 2020 2020 2020 2020  error:.         
+0000d0f0: 2020 2065 7272 6f72 203d 2074 7261 6e73     error = trans
+0000d100: 6c61 7465 5f73 335f 6572 726f 7228 6572  late_s3_error(er
+0000d110: 726f 722c 2073 335f 7572 6c29 0a20 2020  ror, s3_url).   
+0000d120: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
+0000d130: 7374 616e 6365 2865 7272 6f72 2c20 2853  stance(error, (S
+0000d140: 3355 6e6b 6e6f 776e 4572 726f 722c 2053  3UnknownError, S
+0000d150: 3343 6f6e 6669 6745 7272 6f72 2929 3a0a  3ConfigError)):.
+0000d160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d170: 7261 6973 6520 6572 726f 720a 2020 2020  raise error.    
+0000d180: 2020 2020 2020 2020 7265 7475 726e 2046          return F
+0000d190: 616c 7365 0a20 2020 2020 2020 2072 6574  alse.        ret
+0000d1a0: 7572 6e20 5472 7565 0a0a 2020 2020 6465  urn True..    de
+0000d1b0: 6620 6c69 7374 6469 7228 7365 6c66 2c20  f listdir(self, 
+0000d1c0: 666f 6c6c 6f77 6c69 6e6b 733a 2062 6f6f  followlinks: boo
+0000d1d0: 6c20 3d20 4661 6c73 6529 202d 3e20 4c69  l = False) -> Li
+0000d1e0: 7374 5b73 7472 5d3a 0a20 2020 2020 2020  st[str]:.       
+0000d1f0: 2027 2727 0a20 2020 2020 2020 2047 6574   '''.        Get
+0000d200: 2061 6c6c 2063 6f6e 7465 6e74 7320 6f66   all contents of
+0000d210: 2067 6976 656e 2073 335f 7572 6c2e 2054   given s3_url. T
+0000d220: 6865 2072 6573 756c 7420 6973 2069 6e20  he result is in 
+0000d230: 6163 7365 6e64 696e 6720 616c 7068 6162  acsending alphab
+0000d240: 6574 6963 616c 206f 7264 6572 2e0a 0a20  etical order... 
+0000d250: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
+0000d260: 2041 6c6c 2063 6f6e 7465 6e74 7320 6861   All contents ha
+0000d270: 7665 2070 7265 6669 7820 6f66 2073 335f  ve prefix of s3_
+0000d280: 7572 6c20 696e 2061 6373 656e 6469 6e67  url in acsending
+0000d290: 2061 6c70 6861 6265 7469 6361 6c20 6f72   alphabetical or
+0000d2a0: 6465 720a 2020 2020 2020 2020 3a72 6169  der.        :rai
+0000d2b0: 7365 733a 2053 3346 696c 654e 6f74 466f  ses: S3FileNotFo
+0000d2c0: 756e 6445 7272 6f72 2c20 5333 4e6f 7441  undError, S3NotA
+0000d2d0: 4469 7265 6374 6f72 7945 7272 6f72 0a20  DirectoryError. 
+0000d2e0: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+0000d2f0: 2020 2065 6e74 7269 6573 203d 206c 6973     entries = lis
+0000d300: 7428 7365 6c66 2e73 6361 6e64 6972 2866  t(self.scandir(f
+0000d310: 6f6c 6c6f 776c 696e 6b73 3d66 6f6c 6c6f  ollowlinks=follo
+0000d320: 776c 696e 6b73 2929 0a20 2020 2020 2020  wlinks)).       
+0000d330: 2072 6574 7572 6e20 736f 7274 6564 285b   return sorted([
+0000d340: 656e 7472 792e 6e61 6d65 2066 6f72 2065  entry.name for e
+0000d350: 6e74 7279 2069 6e20 656e 7472 6965 735d  ntry in entries]
+0000d360: 290a 0a20 2020 2064 6566 2069 7465 7264  )..    def iterd
+0000d370: 6972 2873 656c 662c 2066 6f6c 6c6f 776c  ir(self, followl
+0000d380: 696e 6b73 3a20 626f 6f6c 203d 2046 616c  inks: bool = Fal
+0000d390: 7365 2920 2d3e 2049 7465 7261 746f 725b  se) -> Iterator[
+0000d3a0: 2753 3350 6174 6827 5d3a 0a20 2020 2020  'S3Path']:.     
+0000d3b0: 2020 2027 2727 0a20 2020 2020 2020 2047     '''.        G
+0000d3c0: 6574 2061 6c6c 2063 6f6e 7465 6e74 7320  et all contents 
+0000d3d0: 6f66 2067 6976 656e 2073 335f 7572 6c2e  of given s3_url.
+0000d3e0: 2054 6865 2072 6573 756c 7420 6973 2069   The result is i
+0000d3f0: 6e20 6163 7365 6e64 696e 6720 616c 7068  n acsending alph
+0000d400: 6162 6574 6963 616c 206f 7264 6572 2e0a  abetical order..
+0000d410: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+0000d420: 733a 2041 6c6c 2063 6f6e 7465 6e74 7320  s: All contents 
+0000d430: 6861 7665 2070 7265 6669 7820 6f66 2073  have prefix of s
+0000d440: 335f 7572 6c20 696e 2061 6373 656e 6469  3_url in acsendi
+0000d450: 6e67 2061 6c70 6861 6265 7469 6361 6c20  ng alphabetical 
+0000d460: 6f72 6465 720a 2020 2020 2020 2020 3a72  order.        :r
+0000d470: 6169 7365 733a 2053 3346 696c 654e 6f74  aises: S3FileNot
+0000d480: 466f 756e 6445 7272 6f72 2c20 5333 4e6f  FoundError, S3No
+0000d490: 7441 4469 7265 6374 6f72 7945 7272 6f72  tADirectoryError
+0000d4a0: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
+0000d4b0: 2020 2020 2066 6f72 2070 6174 6820 696e       for path in
+0000d4c0: 2073 656c 662e 6c69 7374 6469 7228 666f   self.listdir(fo
+0000d4d0: 6c6c 6f77 6c69 6e6b 733d 666f 6c6c 6f77  llowlinks=follow
+0000d4e0: 6c69 6e6b 7329 3a0a 2020 2020 2020 2020  links):.        
+0000d4f0: 2020 2020 7969 656c 6420 7365 6c66 2e6a      yield self.j
+0000d500: 6f69 6e70 6174 6828 7061 7468 2920 2023  oinpath(path)  #
+0000d510: 2074 7970 653a 2069 676e 6f72 650a 0a20   type: ignore.. 
+0000d520: 2020 2064 6566 206c 6f61 6428 7365 6c66     def load(self
+0000d530: 2c20 666f 6c6c 6f77 6c69 6e6b 733a 2062  , followlinks: b
+0000d540: 6f6f 6c20 3d20 4661 6c73 6529 202d 3e20  ool = False) -> 
+0000d550: 4269 6e61 7279 494f 3a0a 2020 2020 2020  BinaryIO:.      
+0000d560: 2020 2727 2752 6561 6420 616c 6c20 636f    '''Read all co
+0000d570: 6e74 656e 7420 696e 2062 696e 6172 7920  ntent in binary 
+0000d580: 6f6e 2073 7065 6369 6669 6564 2070 6174  on specified pat
+0000d590: 6820 616e 6420 7772 6974 6520 696e 746f  h and write into
+0000d5a0: 206d 656d 6f72 790a 0a20 2020 2020 2020   memory..       
+0000d5b0: 2055 7365 7220 7368 6f75 6c64 2063 6c6f   User should clo
+0000d5c0: 7365 2074 6865 2042 696e 6172 7949 4f20  se the BinaryIO 
+0000d5d0: 6d61 6e75 616c 6c79 0a0a 2020 2020 2020  manually..      
+0000d5e0: 2020 3a72 6574 7572 6e73 3a20 4269 6e61    :returns: Bina
+0000d5f0: 7279 494f 0a20 2020 2020 2020 2027 2727  ryIO.        '''
+0000d600: 0a20 2020 2020 2020 2073 335f 7572 6c20  .        s3_url 
+0000d610: 3d20 7365 6c66 2e70 6174 685f 7769 7468  = self.path_with
+0000d620: 5f70 726f 746f 636f 6c0a 2020 2020 2020  _protocol.      
+0000d630: 2020 6966 2066 6f6c 6c6f 776c 696e 6b73    if followlinks
+0000d640: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
+0000d650: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0000d660: 2020 2073 335f 7572 6c20 3d20 7365 6c66     s3_url = self
+0000d670: 2e72 6561 646c 696e 6b28 292e 7061 7468  .readlink().path
+0000d680: 5f77 6974 685f 7072 6f74 6f63 6f6c 0a20  _with_protocol. 
+0000d690: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0000d6a0: 7420 5333 4e6f 7441 4c69 6e6b 4572 726f  t S3NotALinkErro
+0000d6b0: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+0000d6c0: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
+0000d6d0: 6275 636b 6574 2c20 6b65 7920 3d20 7061  bucket, key = pa
+0000d6e0: 7273 655f 7333 5f75 726c 2873 335f 7572  rse_s3_url(s3_ur
+0000d6f0: 6c29 0a20 2020 2020 2020 2069 6620 6e6f  l).        if no
+0000d700: 7420 6275 636b 6574 3a0a 2020 2020 2020  t bucket:.      
+0000d710: 2020 2020 2020 7261 6973 6520 5333 4275        raise S3Bu
+0000d720: 636b 6574 4e6f 7446 6f75 6e64 4572 726f  cketNotFoundErro
+0000d730: 7228 2745 6d70 7479 2062 7563 6b65 7420  r('Empty bucket 
+0000d740: 6e61 6d65 3a20 2572 2720 2520 7333 5f75  name: %r' % s3_u
+0000d750: 726c 290a 2020 2020 2020 2020 6966 206e  rl).        if n
+0000d760: 6f74 206b 6579 206f 7220 6b65 792e 656e  ot key or key.en
+0000d770: 6473 7769 7468 2827 2f27 293a 0a20 2020  dswith('/'):.   
+0000d780: 2020 2020 2020 2020 2072 6169 7365 2053           raise S
+0000d790: 3349 7341 4469 7265 6374 6f72 7945 7272  3IsADirectoryErr
+0000d7a0: 6f72 2827 4973 2061 2064 6972 6563 746f  or('Is a directo
+0000d7b0: 7279 3a20 2572 2720 2520 7333 5f75 726c  ry: %r' % s3_url
+0000d7c0: 290a 0a20 2020 2020 2020 2062 7566 6665  )..        buffe
+0000d7d0: 7220 3d20 696f 2e42 7974 6573 494f 2829  r = io.BytesIO()
+0000d7e0: 0a20 2020 2020 2020 2077 6974 6820 7261  .        with ra
+0000d7f0: 6973 655f 7333 5f65 7272 6f72 2873 335f  ise_s3_error(s3_
+0000d800: 7572 6c29 3a0a 2020 2020 2020 2020 2020  url):.          
+0000d810: 2020 7365 6c66 2e5f 636c 6965 6e74 2e64    self._client.d
+0000d820: 6f77 6e6c 6f61 645f 6669 6c65 6f62 6a28  ownload_fileobj(
+0000d830: 6275 636b 6574 2c20 6b65 792c 2062 7566  bucket, key, buf
+0000d840: 6665 7229 0a20 2020 2020 2020 2062 7566  fer).        buf
+0000d850: 6665 722e 7365 656b 2830 290a 2020 2020  fer.seek(0).    
+0000d860: 2020 2020 7265 7475 726e 2062 7566 6665      return buffe
+0000d870: 720a 0a20 2020 2064 6566 2068 6173 6275  r..    def hasbu
+0000d880: 636b 6574 2873 656c 6629 202d 3e20 626f  cket(self) -> bo
+0000d890: 6f6c 3a0a 2020 2020 2020 2020 2727 270a  ol:.        '''.
+0000d8a0: 2020 2020 2020 2020 5465 7374 2069 6620          Test if 
+0000d8b0: 7468 6520 6275 636b 6574 206f 6620 7333  the bucket of s3
+0000d8c0: 5f75 726c 2065 7869 7374 730a 0a20 2020  _url exists..   
+0000d8d0: 2020 2020 203a 7265 7475 726e 733a 2054       :returns: T
+0000d8e0: 7275 6520 6966 2062 7563 6b65 7420 6f66  rue if bucket of
+0000d8f0: 2073 335f 7572 6c20 6569 7873 7473 2c20   s3_url eixsts, 
+0000d900: 656c 7365 2046 616c 7365 0a20 2020 2020  else False.     
+0000d910: 2020 2027 2727 0a20 2020 2020 2020 2062     '''.        b
+0000d920: 7563 6b65 742c 205f 203d 2070 6172 7365  ucket, _ = parse
+0000d930: 5f73 335f 7572 6c28 7365 6c66 2e70 6174  _s3_url(self.pat
+0000d940: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
+0000d950: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0000d960: 6275 636b 6574 3a0a 2020 2020 2020 2020  bucket:.        
+0000d970: 2020 2020 7265 7475 726e 2046 616c 7365      return False
+0000d980: 0a0a 2020 2020 2020 2020 7472 793a 0a20  ..        try:. 
+0000d990: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000d9a0: 5f63 6c69 656e 742e 6865 6164 5f62 7563  _client.head_buc
+0000d9b0: 6b65 7428 4275 636b 6574 3d62 7563 6b65  ket(Bucket=bucke
+0000d9c0: 7429 0a20 2020 2020 2020 2065 7863 6570  t).        excep
+0000d9d0: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+0000d9e0: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+0000d9f0: 2020 6572 726f 7220 3d20 7472 616e 736c    error = transl
+0000da00: 6174 655f 7333 5f65 7272 6f72 2865 7272  ate_s3_error(err
+0000da10: 6f72 2c20 7365 6c66 2e70 6174 685f 7769  or, self.path_wi
+0000da20: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
+0000da30: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
+0000da40: 7374 616e 6365 2865 7272 6f72 2c20 2853  stance(error, (S
+0000da50: 3355 6e6b 6e6f 776e 4572 726f 722c 2053  3UnknownError, S
+0000da60: 3343 6f6e 6669 6745 7272 6f72 2929 3a0a  3ConfigError)):.
 0000da70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000da80: 2020 2065 7272 6f72 7320 3d20 5b5d 0a20     errors = []. 
-0000da90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000daa0: 2020 2072 6574 7269 6573 203d 2032 0a20     retries = 2. 
-0000dab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dac0: 2020 2072 6574 7279 5f69 6e74 6572 7661     retry_interva
-0000dad0: 6c20 3d20 6d69 6e28 302e 3120 2a20 322a  l = min(0.1 * 2*
-0000dae0: 2a72 6574 7269 6573 2c20 3330 290a 2020  *retries, 30).  
-0000daf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000db00: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
-0000db10: 2872 6574 7269 6573 293a 0a20 2020 2020  (retries):.     
-0000db20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000db30: 2020 2023 2064 6f63 3a20 6874 7470 733a     # doc: https:
-0000db40: 2f2f 626f 746f 332e 616d 617a 6f6e 6177  //boto3.amazonaw
-0000db50: 732e 636f 6d2f 7631 2f64 6f63 756d 656e  s.com/v1/documen
-0000db60: 7461 7469 6f6e 2f61 7069 2f6c 6174 6573  tation/api/lates
-0000db70: 742f 7265 6665 7265 6e63 652f 7365 7276  t/reference/serv
-0000db80: 6963 6573 2f73 332e 6874 6d6c 2353 332e  ices/s3.html#S3.
-0000db90: 436c 6965 6e74 2e64 656c 6574 655f 6f62  Client.delete_ob
-0000dba0: 6a65 6374 730a 2020 2020 2020 2020 2020  jects.          
-0000dbb0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000dbc0: 206e 6f74 206b 6579 733a 0a20 2020 2020   not keys:.     
-0000dbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dbe0: 2020 2020 2020 2062 7265 616b 0a20 2020         break.   
-0000dbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dc00: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
-0000dc10: 636c 6965 6e74 2e64 656c 6574 655f 6f62  client.delete_ob
-0000dc20: 6a65 6374 7328 0a20 2020 2020 2020 2020  jects(.         
-0000dc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dc40: 2020 2042 7563 6b65 743d 6275 636b 6574     Bucket=bucket
-0000dc50: 2c20 4465 6c65 7465 3d7b 274f 626a 6563  , Delete={'Objec
-0000dc60: 7473 273a 206b 6579 737d 290a 2020 2020  ts': keys}).    
-0000dc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dc80: 2020 2020 6b65 7973 203d 205b 5d0a 2020      keys = [].  
-0000dc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dca0: 2020 2020 2020 666f 7220 6572 726f 725f        for error_
-0000dcb0: 696e 666f 2069 6e20 7265 7370 6f6e 7365  info in response
-0000dcc0: 2e67 6574 2827 4572 726f 7273 272c 205b  .get('Errors', [
-0000dcd0: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
-0000dce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dcf0: 6966 2073 335f 6572 726f 725f 636f 6465  if s3_error_code
-0000dd00: 5f73 686f 756c 645f 7265 7472 7928 0a20  _should_retry(. 
-0000dd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dd30: 2020 2065 7272 6f72 5f69 6e66 6f2e 6765     error_info.ge
-0000dd40: 7428 2743 6f64 6527 2929 3a0a 2020 2020  t('Code')):.    
-0000dd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dd60: 2020 2020 2020 2020 2020 2020 6572 726f              erro
-0000dd70: 725f 6c6f 6767 6572 2e77 6172 6e69 6e67  r_logger.warning
-0000dd80: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000dd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dda0: 2020 2020 2020 2272 6574 7279 2025 7320        "retry %s 
-0000ddb0: 7469 6d65 732c 2072 656d 6f76 696e 6720  times, removing 
-0000ddc0: 6669 6c65 3a20 2573 2c20 7769 7468 2065  file: %s, with e
-0000ddd0: 7272 6f72 2025 733a 2025 7322 0a20 2020  rror %s: %s".   
-0000dde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ddf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000de00: 2025 2028 0a20 2020 2020 2020 2020 2020   % (.           
-0000de10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000de20: 2020 2020 2020 2020 2020 2020 2069 202b               i +
-0000de30: 2031 2c20 6572 726f 725f 696e 666f 5b27   1, error_info['
-0000de40: 4b65 7927 5d2c 0a20 2020 2020 2020 2020  Key'],.         
-0000de50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000de60: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000de70: 7272 6f72 5f69 6e66 6f5b 2743 6f64 6527  rror_info['Code'
-0000de80: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-0000de90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dea0: 2020 2020 2020 2020 2020 2065 7272 6f72             error
-0000deb0: 5f69 6e66 6f5b 274d 6573 7361 6765 275d  _info['Message']
-0000dec0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-0000ded0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dee0: 2020 206b 6579 732e 6170 7065 6e64 287b     keys.append({
-0000def0: 274b 6579 273a 2065 7272 6f72 5f69 6e66  'Key': error_inf
-0000df00: 6f5b 274b 6579 275d 7d29 0a20 2020 2020  o['Key']}).     
-0000df10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000df20: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0000df30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000df40: 2020 2020 2020 2020 2020 2020 2065 7272               err
-0000df50: 6f72 732e 6170 7065 6e64 2865 7272 6f72  ors.append(error
-0000df60: 5f69 6e66 6f29 0a20 2020 2020 2020 2020  _info).         
-0000df70: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000df80: 696d 652e 736c 6565 7028 7265 7472 795f  ime.sleep(retry_
-0000df90: 696e 7465 7276 616c 290a 2020 2020 2020  interval).      
-0000dfa0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0000dfb0: 7220 6572 726f 725f 696e 666f 2069 6e20  r error_info in 
-0000dfc0: 6572 726f 7273 3a0a 2020 2020 2020 2020  errors:.        
-0000dfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dfe0: 6572 726f 725f 6c6f 6767 6572 2e65 7272  error_logger.err
-0000dff0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-0000e000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e010: 2266 6169 6c65 6420 7265 6d6f 7665 2066  "failed remove f
-0000e020: 696c 653a 2025 732c 2077 6974 6820 6572  ile: %s, with er
-0000e030: 726f 7220 2573 3a20 2573 2220 2520 280a  ror %s: %s" % (.
-0000e040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e060: 6572 726f 725f 696e 666f 5b27 4b65 7927  error_info['Key'
-0000e070: 5d2c 2065 7272 6f72 5f69 6e66 6f5b 2743  ], error_info['C
-0000e080: 6f64 6527 5d2c 0a20 2020 2020 2020 2020  ode'],.         
+0000da80: 7261 6973 6520 6572 726f 720a 2020 2020  raise error.    
+0000da90: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+0000daa0: 7461 6e63 6528 6572 726f 722c 2053 3346  tance(error, S3F
+0000dab0: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
+0000dac0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000dad0: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+0000dae0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000daf0: 5472 7565 0a0a 2020 2020 6465 6620 6d6b  True..    def mk
+0000db00: 6469 7228 7365 6c66 2c20 6d6f 6465 3d30  dir(self, mode=0
+0000db10: 6f37 3737 2c20 7061 7265 6e74 733a 2062  o777, parents: b
+0000db20: 6f6f 6c20 3d20 4661 6c73 652c 2065 7869  ool = False, exi
+0000db30: 7374 5f6f 6b3a 2062 6f6f 6c20 3d20 4661  st_ok: bool = Fa
+0000db40: 6c73 6529 3a0a 2020 2020 2020 2020 2727  lse):.        ''
+0000db50: 270a 2020 2020 2020 2020 4372 6561 7465  '.        Create
+0000db60: 2061 6e20 7333 2064 6972 6563 746f 7279   an s3 directory
+0000db70: 2e0a 2020 2020 2020 2020 5075 7265 6c79  ..        Purely
+0000db80: 2063 7265 6174 696e 6720 6469 7265 6374   creating direct
+0000db90: 6f72 7920 6973 2069 6e76 616c 6964 2062  ory is invalid b
+0000dba0: 6563 6175 7365 2069 7427 7320 756e 6176  ecause it's unav
+0000dbb0: 6169 6c61 626c 6520 6f6e 204f 5353 2e0a  ailable on OSS..
+0000dbc0: 2020 2020 2020 2020 5468 6973 2066 756e          This fun
+0000dbd0: 6374 696f 6e20 6973 2074 6f20 7465 7374  ction is to test
+0000dbe0: 2074 6865 2074 6172 6765 7420 6275 636b   the target buck
+0000dbf0: 6574 2068 6176 6520 5752 4954 4520 6163  et have WRITE ac
+0000dc00: 6365 7373 2e0a 0a20 2020 2020 2020 203a  cess...        :
+0000dc10: 7061 7261 6d20 6d6f 6465 3a20 6d6f 6465  param mode: mode
+0000dc20: 2069 7320 6967 6e6f 7265 642c 206f 6e6c   is ignored, onl
+0000dc30: 7920 6265 2063 6f6d 7061 7469 626c 6520  y be compatible 
+0000dc40: 7769 7468 2070 6174 686c 6962 2e50 6174  with pathlib.Pat
+0000dc50: 680a 2020 2020 2020 2020 3a70 6172 616d  h.        :param
+0000dc60: 2070 6172 656e 7473 3a20 7061 7265 6e74   parents: parent
+0000dc70: 7320 6973 2069 676e 6f72 6564 2c20 6f6e  s is ignored, on
+0000dc80: 6c79 2062 6520 636f 6d70 6174 6962 6c65  ly be compatible
+0000dc90: 2077 6974 6820 7061 7468 6c69 622e 5061   with pathlib.Pa
+0000dca0: 7468 0a20 2020 2020 2020 203a 7061 7261  th.        :para
+0000dcb0: 6d20 6578 6973 745f 6f6b 3a20 4966 2046  m exist_ok: If F
+0000dcc0: 616c 7365 2061 6e64 2074 6172 6765 7420  alse and target 
+0000dcd0: 6469 7265 6374 6f72 7920 6578 6973 7473  directory exists
+0000dce0: 2c20 7261 6973 6520 5333 4669 6c65 4578  , raise S3FileEx
+0000dcf0: 6973 7473 4572 726f 720a 2020 2020 2020  istsError.      
+0000dd00: 2020 3a72 6169 7365 733a 2053 3342 7563    :raises: S3Buc
+0000dd10: 6b65 744e 6f74 466f 756e 6445 7272 6f72  ketNotFoundError
+0000dd20: 2c20 5333 4669 6c65 4578 6973 7473 4572  , S3FileExistsEr
+0000dd30: 726f 720a 2020 2020 2020 2020 2727 270a  ror.        '''.
+0000dd40: 2020 2020 2020 2020 6275 636b 6574 2c20          bucket, 
+0000dd50: 5f20 3d20 7061 7273 655f 7333 5f75 726c  _ = parse_s3_url
+0000dd60: 2873 656c 662e 7061 7468 5f77 6974 685f  (self.path_with_
+0000dd70: 7072 6f74 6f63 6f6c 290a 2020 2020 2020  protocol).      
+0000dd80: 2020 6966 206e 6f74 2062 7563 6b65 743a    if not bucket:
+0000dd90: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0000dda0: 7365 2053 3342 7563 6b65 744e 6f74 466f  se S3BucketNotFo
+0000ddb0: 756e 6445 7272 6f72 280a 2020 2020 2020  undError(.      
+0000ddc0: 2020 2020 2020 2020 2020 2745 6d70 7479            'Empty
+0000ddd0: 2062 7563 6b65 7420 6e61 6d65 3a20 2572   bucket name: %r
+0000dde0: 2720 2520 7365 6c66 2e70 6174 685f 7769  ' % self.path_wi
+0000ddf0: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
+0000de00: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+0000de10: 2e68 6173 6275 636b 6574 2829 3a0a 2020  .hasbucket():.  
+0000de20: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000de30: 5333 4275 636b 6574 4e6f 7446 6f75 6e64  S3BucketNotFound
+0000de40: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+0000de50: 2020 2020 2020 2027 4e6f 2073 7563 6820         'No such 
+0000de60: 6275 636b 6574 3a20 2572 2720 2520 7365  bucket: %r' % se
+0000de70: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
+0000de80: 746f 636f 6c29 0a20 2020 2020 2020 2069  tocol).        i
+0000de90: 6620 6578 6973 745f 6f6b 3a0a 2020 2020  f exist_ok:.    
+0000dea0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0000deb0: 6973 5f66 696c 6528 293a 0a20 2020 2020  is_file():.     
+0000dec0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000ded0: 2053 3346 696c 6545 7869 7374 7345 7272   S3FileExistsErr
+0000dee0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+0000def0: 2020 2020 2020 2020 2746 696c 6520 6578          'File ex
+0000df00: 6973 7473 3a20 2572 2720 2520 7365 6c66  ists: %r' % self
+0000df10: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+0000df20: 636f 6c29 0a20 2020 2020 2020 2020 2020  col).           
+0000df30: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
+0000df40: 6966 2073 656c 662e 6578 6973 7473 2829  if self.exists()
+0000df50: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+0000df60: 6973 6520 5333 4669 6c65 4578 6973 7473  ise S3FileExists
+0000df70: 4572 726f 7228 2746 696c 6520 6578 6973  Error('File exis
+0000df80: 7473 3a20 2572 2720 2520 7365 6c66 2e70  ts: %r' % self.p
+0000df90: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+0000dfa0: 6c29 0a0a 2020 2020 6465 6620 6d6f 7665  l)..    def move
+0000dfb0: 2873 656c 662c 2064 7374 5f75 726c 3a20  (self, dst_url: 
+0000dfc0: 5061 7468 4c69 6b65 2920 2d3e 204e 6f6e  PathLike) -> Non
+0000dfd0: 653a 0a20 2020 2020 2020 2027 2727 0a20  e:.        '''. 
+0000dfe0: 2020 2020 2020 204d 6f76 6520 6669 6c65         Move file
+0000dff0: 2f64 6972 6563 746f 7279 2070 6174 6820  /directory path 
+0000e000: 6672 6f6d 2073 7263 5f75 726c 2074 6f20  from src_url to 
+0000e010: 6473 745f 7572 6c0a 0a20 2020 2020 2020  dst_url..       
+0000e020: 203a 7061 7261 6d20 6473 745f 7572 6c3a   :param dst_url:
+0000e030: 2047 6976 656e 2064 6573 7469 6e61 7469   Given destinati
+0000e040: 6f6e 2070 6174 680a 2020 2020 2020 2020  on path.        
+0000e050: 2727 270a 2020 2020 2020 2020 666f 7220  '''.        for 
+0000e060: 7372 635f 6669 6c65 5f70 6174 682c 2064  src_file_path, d
+0000e070: 7374 5f66 696c 655f 7061 7468 2069 6e20  st_file_path in 
+0000e080: 5f73 335f 7363 616e 5f70 6169 7273 280a  _s3_scan_pairs(.
 0000e090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e0a0: 2020 2020 2020 2065 7272 6f72 5f69 6e66         error_inf
-0000e0b0: 6f5b 274d 6573 7361 6765 275d 2929 0a20  o['Message'])). 
-0000e0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e0d0: 2020 2065 7272 6f72 5f63 6f75 6e74 202b     error_count +
-0000e0e0: 3d20 6c65 6e28 6572 726f 7273 290a 2020  = len(errors).  
-0000e0f0: 2020 2020 2020 2020 2020 6966 2065 7272            if err
-0000e100: 6f72 5f63 6f75 6e74 203e 2030 3a0a 2020  or_count > 0:.  
-0000e110: 2020 2020 2020 2020 2020 2020 2020 6572                er
-0000e120: 726f 725f 6d73 6720 3d20 2266 6169 6c65  ror_msg = "faile
-0000e130: 6420 7265 6d6f 7665 2070 6174 683a 2025  d remove path: %
-0000e140: 732c 2074 6f74 616c 2066 696c 6520 636f  s, total file co
-0000e150: 756e 743a 2025 732c 2066 6169 6c65 6420  unt: %s, failed 
-0000e160: 636f 756e 743a 2025 7322 2025 2028 0a20  count: %s" % (. 
-0000e170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e180: 2020 2073 656c 662e 7061 7468 5f77 6974     self.path_wit
-0000e190: 685f 7072 6f74 6f63 6f6c 2c20 746f 7461  h_protocol, tota
-0000e1a0: 6c5f 636f 756e 742c 2065 7272 6f72 5f63  l_count, error_c
-0000e1b0: 6f75 6e74 290a 2020 2020 2020 2020 2020  ount).          
-0000e1c0: 2020 2020 2020 7261 6973 6520 5333 556e        raise S3Un
-0000e1d0: 6b6e 6f77 6e45 7272 6f72 280a 2020 2020  knownError(.    
-0000e1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e1f0: 4578 6365 7074 696f 6e28 6572 726f 725f  Exception(error_
-0000e200: 6d73 6729 2c20 7365 6c66 2e70 6174 685f  msg), self.path_
-0000e210: 7769 7468 5f70 726f 746f 636f 6c29 0a0a  with_protocol)..
-0000e220: 2020 2020 6465 6620 7265 6e61 6d65 2873      def rename(s
-0000e230: 656c 662c 2064 7374 5f70 6174 683a 2050  elf, dst_path: P
-0000e240: 6174 684c 696b 6529 202d 3e20 2753 3350  athLike) -> 'S3P
-0000e250: 6174 6827 3a0a 2020 2020 2020 2020 2727  ath':.        ''
-0000e260: 270a 2020 2020 2020 2020 4d6f 7665 2073  '.        Move s
-0000e270: 3320 6669 6c65 2070 6174 6820 6672 6f6d  3 file path from
-0000e280: 2073 7263 5f75 726c 2074 6f20 6473 745f   src_url to dst_
-0000e290: 7572 6c0a 0a20 2020 2020 2020 203a 7061  url..        :pa
-0000e2a0: 7261 6d20 6473 745f 7061 7468 3a20 4769  ram dst_path: Gi
-0000e2b0: 7665 6e20 6465 7374 696e 6174 696f 6e20  ven destination 
-0000e2c0: 7061 7468 0a20 2020 2020 2020 2027 2727  path.        '''
-0000e2d0: 0a20 2020 2020 2020 2073 335f 7265 6e61  .        s3_rena
-0000e2e0: 6d65 2873 656c 662e 7061 7468 5f77 6974  me(self.path_wit
-0000e2f0: 685f 7072 6f74 6f63 6f6c 2c20 6473 745f  h_protocol, dst_
-0000e300: 7061 7468 290a 2020 2020 2020 2020 7265  path).        re
-0000e310: 7475 726e 2073 656c 662e 6672 6f6d 5f70  turn self.from_p
-0000e320: 6174 6828 6473 745f 7061 7468 290a 0a20  ath(dst_path).. 
-0000e330: 2020 2064 6566 2073 6361 6e28 7365 6c66     def scan(self
-0000e340: 2c20 6d69 7373 696e 675f 6f6b 3a20 626f  , missing_ok: bo
-0000e350: 6f6c 203d 2054 7275 652c 0a20 2020 2020  ol = True,.     
-0000e360: 2020 2020 2020 2020 666f 6c6c 6f77 6c69          followli
-0000e370: 6e6b 733a 2062 6f6f 6c20 3d20 4661 6c73  nks: bool = Fals
-0000e380: 6529 202d 3e20 4974 6572 6174 6f72 5b73  e) -> Iterator[s
-0000e390: 7472 5d3a 0a20 2020 2020 2020 2027 2727  tr]:.        '''
-0000e3a0: 0a20 2020 2020 2020 2049 7465 7261 7469  .        Iterati
-0000e3b0: 7665 6c79 2074 7261 7665 7273 6520 6f6e  vely traverse on
-0000e3c0: 6c79 2066 696c 6573 2069 6e20 6769 7665  ly files in give
-0000e3d0: 6e20 7333 2064 6972 6563 746f 7279 2c20  n s3 directory, 
-0000e3e0: 696e 2061 6c70 6861 6265 7469 6361 6c20  in alphabetical 
-0000e3f0: 6f72 6465 722e 0a20 2020 2020 2020 2045  order..        E
-0000e400: 7665 7279 2069 7465 7261 7469 6f6e 206f  very iteration o
-0000e410: 6e20 6765 6e65 7261 746f 7220 7969 656c  n generator yiel
-0000e420: 6473 2061 2070 6174 6820 7374 7269 6e67  ds a path string
-0000e430: 2e0a 0a20 2020 2020 2020 2049 6620 7333  ...        If s3
-0000e440: 5f75 726c 2069 7320 6120 6669 6c65 2070  _url is a file p
-0000e450: 6174 682c 2079 6965 6c64 7320 7468 6520  ath, yields the 
-0000e460: 6669 6c65 206f 6e6c 790a 2020 2020 2020  file only.      
-0000e470: 2020 4966 2073 335f 7572 6c20 6973 2061    If s3_url is a
-0000e480: 206e 6f6e 2d65 7869 7374 656e 7420 7061   non-existent pa
-0000e490: 7468 2c20 7265 7475 726e 2061 6e20 656d  th, return an em
-0000e4a0: 7074 7920 6765 6e65 7261 746f 720a 2020  pty generator.  
-0000e4b0: 2020 2020 2020 4966 2073 335f 7572 6c20        If s3_url 
-0000e4c0: 6973 2061 2062 7563 6b65 7420 7061 7468  is a bucket path
-0000e4d0: 2c20 7265 7475 726e 2061 6c6c 2066 696c  , return all fil
-0000e4e0: 6520 7061 7468 7320 696e 2074 6865 2062  e paths in the b
-0000e4f0: 7563 6b65 740a 2020 2020 2020 2020 4966  ucket.        If
-0000e500: 2073 335f 7572 6c20 6973 2061 6e20 656d   s3_url is an em
-0000e510: 7074 7920 6275 636b 6574 2c20 7265 7475  pty bucket, retu
-0000e520: 726e 2061 6e20 656d 7074 7920 6765 6e65  rn an empty gene
-0000e530: 7261 746f 720a 2020 2020 2020 2020 4966  rator.        If
-0000e540: 2073 335f 7572 6c20 646f 6573 6e27 7420   s3_url doesn't 
-0000e550: 636f 6e74 6169 6e20 616e 7920 6275 636b  contain any buck
-0000e560: 6574 2c20 7768 6963 6820 6973 2073 335f  et, which is s3_
-0000e570: 7572 6c20 3d3d 2027 7333 3a2f 2f27 2c20  url == 's3://', 
-0000e580: 7261 6973 6520 556e 7375 7070 6f72 7465  raise Unsupporte
-0000e590: 6445 7272 6f72 2e20 7761 6c6b 2829 206f  dError. walk() o
-0000e5a0: 6e20 636f 6d70 6c65 7465 2073 3320 6973  n complete s3 is
-0000e5b0: 206e 6f74 2073 7570 706f 7274 6564 2069   not supported i
-0000e5c0: 6e20 6d65 6766 696c 650a 0a20 2020 2020  n megfile..     
-0000e5d0: 2020 203a 7061 7261 6d20 6d69 7373 696e     :param missin
-0000e5e0: 675f 6f6b 3a20 4966 2046 616c 7365 2061  g_ok: If False a
-0000e5f0: 6e64 2074 6865 7265 2773 206e 6f20 6669  nd there's no fi
-0000e600: 6c65 2069 6e20 7468 6520 6469 7265 6374  le in the direct
-0000e610: 6f72 792c 2072 6169 7365 2046 696c 654e  ory, raise FileN
-0000e620: 6f74 466f 756e 6445 7272 6f72 0a20 2020  otFoundError.   
-0000e630: 2020 2020 203a 7261 6973 6573 3a20 556e       :raises: Un
-0000e640: 7375 7070 6f72 7465 6445 7272 6f72 0a20  supportedError. 
-0000e650: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
-0000e660: 2041 2066 696c 6520 7061 7468 2067 656e   A file path gen
-0000e670: 6572 6174 6f72 0a20 2020 2020 2020 2027  erator.        '
-0000e680: 2727 0a20 2020 2020 2020 2073 6361 6e5f  ''.        scan_
-0000e690: 7374 6174 5f69 7465 7220 3d20 7365 6c66  stat_iter = self
-0000e6a0: 2e73 6361 6e5f 7374 6174 280a 2020 2020  .scan_stat(.    
-0000e6b0: 2020 2020 2020 2020 6d69 7373 696e 675f          missing_
-0000e6c0: 6f6b 3d6d 6973 7369 6e67 5f6f 6b2c 2066  ok=missing_ok, f
-0000e6d0: 6f6c 6c6f 776c 696e 6b73 3d66 6f6c 6c6f  ollowlinks=follo
-0000e6e0: 776c 696e 6b73 290a 0a20 2020 2020 2020  wlinks)..       
-0000e6f0: 2064 6566 2063 7265 6174 655f 6765 6e65   def create_gene
-0000e700: 7261 746f 7228 2920 2d3e 2049 7465 7261  rator() -> Itera
-0000e710: 746f 725b 7374 725d 3a0a 2020 2020 2020  tor[str]:.      
-0000e720: 2020 2020 2020 666f 7220 6669 6c65 5f65        for file_e
-0000e730: 6e74 7279 2069 6e20 7363 616e 5f73 7461  ntry in scan_sta
-0000e740: 745f 6974 6572 3a0a 2020 2020 2020 2020  t_iter:.        
-0000e750: 2020 2020 2020 2020 7969 656c 6420 6669          yield fi
-0000e760: 6c65 5f65 6e74 7279 2e70 6174 680a 0a20  le_entry.path.. 
-0000e770: 2020 2020 2020 2072 6574 7572 6e20 6372         return cr
-0000e780: 6561 7465 5f67 656e 6572 6174 6f72 2829  eate_generator()
-0000e790: 0a0a 2020 2020 6465 6620 7363 616e 5f73  ..    def scan_s
-0000e7a0: 7461 7428 7365 6c66 2c20 6d69 7373 696e  tat(self, missin
-0000e7b0: 675f 6f6b 3a20 626f 6f6c 203d 2054 7275  g_ok: bool = Tru
-0000e7c0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0000e7d0: 2020 2020 2066 6f6c 6c6f 776c 696e 6b73       followlinks
-0000e7e0: 3a20 626f 6f6c 203d 2046 616c 7365 2920  : bool = False) 
-0000e7f0: 2d3e 2049 7465 7261 746f 725b 4669 6c65  -> Iterator[File
-0000e800: 456e 7472 795d 3a0a 2020 2020 2020 2020  Entry]:.        
-0000e810: 2727 270a 2020 2020 2020 2020 4974 6572  '''.        Iter
-0000e820: 6174 6976 656c 7920 7472 6176 6572 7365  atively traverse
-0000e830: 206f 6e6c 7920 6669 6c65 7320 696e 2067   only files in g
-0000e840: 6976 656e 2064 6972 6563 746f 7279 2c20  iven directory, 
-0000e850: 696e 2061 6c70 6861 6265 7469 6361 6c20  in alphabetical 
-0000e860: 6f72 6465 722e 0a20 2020 2020 2020 2045  order..        E
-0000e870: 7665 7279 2069 7465 7261 7469 6f6e 206f  very iteration o
-0000e880: 6e20 6765 6e65 7261 746f 7220 7969 656c  n generator yiel
-0000e890: 6473 2061 2074 7570 6c65 206f 6620 7061  ds a tuple of pa
-0000e8a0: 7468 2073 7472 696e 6720 616e 6420 6669  th string and fi
-0000e8b0: 6c65 2073 7461 740a 0a20 2020 2020 2020  le stat..       
-0000e8c0: 203a 7061 7261 6d20 6d69 7373 696e 675f   :param missing_
-0000e8d0: 6f6b 3a20 4966 2046 616c 7365 2061 6e64  ok: If False and
-0000e8e0: 2074 6865 7265 2773 206e 6f20 6669 6c65   there's no file
-0000e8f0: 2069 6e20 7468 6520 6469 7265 6374 6f72   in the director
-0000e900: 792c 2072 6169 7365 2046 696c 654e 6f74  y, raise FileNot
-0000e910: 466f 756e 6445 7272 6f72 0a20 2020 2020  FoundError.     
-0000e920: 2020 203a 7261 6973 6573 3a20 556e 7375     :raises: Unsu
-0000e930: 7070 6f72 7465 6445 7272 6f72 0a20 2020  pportedError.   
-0000e940: 2020 2020 203a 7265 7475 726e 733a 2041       :returns: A
-0000e950: 2066 696c 6520 7061 7468 2067 656e 6572   file path gener
-0000e960: 6174 6f72 0a20 2020 2020 2020 2027 2727  ator.        '''
-0000e970: 0a20 2020 2020 2020 2062 7563 6b65 742c  .        bucket,
-0000e980: 206b 6579 203d 2070 6172 7365 5f73 335f   key = parse_s3_
-0000e990: 7572 6c28 7365 6c66 2e70 6174 685f 7769  url(self.path_wi
-0000e9a0: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
-0000e9b0: 2020 2020 2069 6620 6e6f 7420 6275 636b       if not buck
-0000e9c0: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
-0000e9d0: 7261 6973 6520 556e 7375 7070 6f72 7465  raise Unsupporte
-0000e9e0: 6445 7272 6f72 2827 5363 616e 2077 686f  dError('Scan who
-0000e9f0: 6c65 2073 3327 2c20 7365 6c66 2e70 6174  le s3', self.pat
-0000ea00: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-0000ea10: 0a0a 2020 2020 2020 2020 6465 6620 6372  ..        def cr
-0000ea20: 6561 7465 5f67 656e 6572 6174 6f72 2829  eate_generator()
-0000ea30: 202d 3e20 4974 6572 6174 6f72 5b46 696c   -> Iterator[Fil
-0000ea40: 6545 6e74 7279 5d3a 0a20 2020 2020 2020  eEntry]:.       
-0000ea50: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
-0000ea60: 2e69 735f 6469 7228 293a 0a20 2020 2020  .is_dir():.     
-0000ea70: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-0000ea80: 6c66 2e69 735f 6669 6c65 2829 3a0a 2020  lf.is_file():.  
-0000ea90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eaa0: 2020 2320 4f6e 2073 332c 2066 696c 6520    # On s3, file 
-0000eab0: 616e 6420 6469 7265 6374 6f72 7920 6d61  and directory ma
-0000eac0: 7920 6265 206f 6620 7361 6d65 206e 616d  y be of same nam
-0000ead0: 6520 616e 6420 6c65 7665 6c2c 2073 6f20  e and level, so 
-0000eae0: 6e65 6564 2074 6f20 7465 7374 2074 6865  need to test the
-0000eaf0: 2070 6174 6820 6973 2066 696c 6520 6f72   path is file or
-0000eb00: 2064 6972 6563 746f 7279 0a20 2020 2020   directory.     
-0000eb10: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-0000eb20: 6965 6c64 2046 696c 6545 6e74 7279 280a  ield FileEntry(.
-0000eb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb40: 2020 2020 2020 2020 7365 6c66 2e6e 616d          self.nam
-0000eb50: 652c 2066 7370 6174 6828 7365 6c66 2e70  e, fspath(self.p
-0000eb60: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-0000eb70: 6c29 2c0a 2020 2020 2020 2020 2020 2020  l),.            
-0000eb80: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000eb90: 2e73 7461 7428 666f 6c6c 6f77 5f73 796d  .stat(follow_sym
-0000eba0: 6c69 6e6b 733d 666f 6c6c 6f77 6c69 6e6b  links=followlink
-0000ebb0: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
-0000ebc0: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-0000ebd0: 2020 2020 2020 2020 6966 206e 6f74 206b          if not k
-0000ebe0: 6579 2e65 6e64 7377 6974 6828 272f 2729  ey.endswith('/')
-0000ebf0: 2061 6e64 2073 656c 662e 6973 5f66 696c   and self.is_fil
-0000ec00: 6528 293a 0a20 2020 2020 2020 2020 2020  e():.           
-0000ec10: 2020 2020 2079 6965 6c64 2046 696c 6545       yield FileE
-0000ec20: 6e74 7279 280a 2020 2020 2020 2020 2020  ntry(.          
-0000ec30: 2020 2020 2020 2020 2020 7365 6c66 2e6e            self.n
-0000ec40: 616d 652c 2066 7370 6174 6828 7365 6c66  ame, fspath(self
-0000ec50: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
-0000ec60: 636f 6c29 2c0a 2020 2020 2020 2020 2020  col),.          
-0000ec70: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-0000ec80: 7461 7428 666f 6c6c 6f77 5f73 796d 6c69  tat(follow_symli
-0000ec90: 6e6b 733d 666f 6c6c 6f77 6c69 6e6b 7329  nks=followlinks)
-0000eca0: 290a 0a20 2020 2020 2020 2020 2020 2070  )..            p
-0000ecb0: 7265 6669 7820 3d20 5f62 6563 6f6d 655f  refix = _become_
-0000ecc0: 7072 6566 6978 286b 6579 290a 2020 2020  prefix(key).    
-0000ecd0: 2020 2020 2020 2020 636c 6965 6e74 203d          client =
-0000ece0: 2067 6574 5f73 335f 636c 6965 6e74 2829   get_s3_client()
-0000ecf0: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
-0000ed00: 6820 7261 6973 655f 7333 5f65 7272 6f72  h raise_s3_error
-0000ed10: 2873 656c 662e 7061 7468 5f77 6974 685f  (self.path_with_
-0000ed20: 7072 6f74 6f63 6f6c 293a 0a20 2020 2020  protocol):.     
-0000ed30: 2020 2020 2020 2020 2020 2066 6f72 2072             for r
-0000ed40: 6573 7020 696e 205f 6c69 7374 5f6f 626a  esp in _list_obj
-0000ed50: 6563 7473 5f72 6563 7572 7369 7665 2863  ects_recursive(c
-0000ed60: 6c69 656e 742c 2062 7563 6b65 742c 2070  lient, bucket, p
-0000ed70: 7265 6669 7829 3a0a 2020 2020 2020 2020  refix):.        
-0000ed80: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000ed90: 636f 6e74 656e 7420 696e 2072 6573 702e  content in resp.
-0000eda0: 6765 7428 2743 6f6e 7465 6e74 7327 2c20  get('Contents', 
-0000edb0: 5b5d 293a 0a20 2020 2020 2020 2020 2020  []):.           
-0000edc0: 2020 2020 2020 2020 2020 2020 2066 756c               ful
-0000edd0: 6c5f 7061 7468 203d 2073 335f 7061 7468  l_path = s3_path
-0000ede0: 5f6a 6f69 6e28 0a20 2020 2020 2020 2020  _join(.         
-0000edf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee00: 2020 2027 7333 3a2f 2f27 2c20 6275 636b     's3://', buck
-0000ee10: 6574 2c20 636f 6e74 656e 745b 274b 6579  et, content['Key
-0000ee20: 275d 290a 2020 2020 2020 2020 2020 2020  ']).            
-0000ee30: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
-0000ee40: 6420 4669 6c65 456e 7472 7928 0a20 2020  d FileEntry(.   
-0000ee50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee60: 2020 2020 2020 2020 2053 3350 6174 6828           S3Path(
-0000ee70: 6675 6c6c 5f70 6174 6829 2e6e 616d 652c  full_path).name,
-0000ee80: 2066 756c 6c5f 7061 7468 2c0a 2020 2020   full_path,.    
-0000ee90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eea0: 2020 2020 2020 2020 5f6d 616b 655f 7374          _make_st
-0000eeb0: 6174 2863 6f6e 7465 6e74 2929 0a0a 2020  at(content))..  
-0000eec0: 2020 2020 2020 7265 7475 726e 205f 6372        return _cr
-0000eed0: 6561 7465 5f6d 6973 7369 6e67 5f6f 6b5f  eate_missing_ok_
-0000eee0: 6765 6e65 7261 746f 7228 0a20 2020 2020  generator(.     
-0000eef0: 2020 2020 2020 2063 7265 6174 655f 6765         create_ge
-0000ef00: 6e65 7261 746f 7228 292c 206d 6973 7369  nerator(), missi
-0000ef10: 6e67 5f6f 6b2c 0a20 2020 2020 2020 2020  ng_ok,.         
-0000ef20: 2020 2053 3346 696c 654e 6f74 466f 756e     S3FileNotFoun
-0000ef30: 6445 7272 6f72 2827 4e6f 206d 6174 6368  dError('No match
-0000ef40: 2066 696c 653a 2025 7227 2025 2073 656c   file: %r' % sel
-0000ef50: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
-0000ef60: 6f63 6f6c 2929 0a0a 2020 2020 6465 6620  ocol))..    def 
-0000ef70: 7363 616e 6469 7228 7365 6c66 2c20 666f  scandir(self, fo
-0000ef80: 6c6c 6f77 6c69 6e6b 733a 2062 6f6f 6c20  llowlinks: bool 
-0000ef90: 3d20 4661 6c73 6529 202d 3e20 4974 6572  = False) -> Iter
-0000efa0: 6174 6f72 5b46 696c 6545 6e74 7279 5d3a  ator[FileEntry]:
-0000efb0: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
-0000efc0: 2020 2020 2047 6574 2061 6c6c 2063 6f6e       Get all con
-0000efd0: 7465 6e74 7320 6f66 2067 6976 656e 2073  tents of given s
-0000efe0: 335f 7572 6c2c 2074 6865 206f 7264 6572  3_url, the order
-0000eff0: 206f 6620 7265 7375 6c74 2069 7320 6e6f   of result is no
-0000f000: 7420 6775 6172 616e 7465 6564 2e0a 0a20  t guaranteed... 
-0000f010: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
-0000f020: 2041 6c6c 2063 6f6e 7465 6e74 7320 6861   All contents ha
-0000f030: 7665 2070 7265 6669 7820 6f66 2073 335f  ve prefix of s3_
-0000f040: 7572 6c0a 2020 2020 2020 2020 3a72 6169  url.        :rai
-0000f050: 7365 733a 2053 3346 696c 654e 6f74 466f  ses: S3FileNotFo
-0000f060: 756e 6445 7272 6f72 2c20 5333 4e6f 7441  undError, S3NotA
-0000f070: 4469 7265 6374 6f72 7945 7272 6f72 0a20  DirectoryError. 
-0000f080: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-0000f090: 2020 2062 7563 6b65 742c 206b 6579 203d     bucket, key =
-0000f0a0: 2070 6172 7365 5f73 335f 7572 6c28 7365   parse_s3_url(se
-0000f0b0: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-0000f0c0: 746f 636f 6c29 0a20 2020 2020 2020 2069  tocol).        i
-0000f0d0: 6620 6e6f 7420 6275 636b 6574 2061 6e64  f not bucket and
-0000f0e0: 206b 6579 3a0a 2020 2020 2020 2020 2020   key:.          
-0000f0f0: 2020 7261 6973 6520 5333 4275 636b 6574    raise S3Bucket
-0000f100: 4e6f 7446 6f75 6e64 4572 726f 7228 0a20  NotFoundError(. 
-0000f110: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0000f120: 456d 7074 7920 6275 636b 6574 206e 616d  Empty bucket nam
-0000f130: 653a 2025 7227 2025 2073 656c 662e 7061  e: %r' % self.pa
-0000f140: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-0000f150: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
-0000f160: 6c66 2e69 735f 6669 6c65 2829 3a0a 2020  lf.is_file():.  
-0000f170: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0000f180: 5333 4e6f 7441 4469 7265 6374 6f72 7945  S3NotADirectoryE
-0000f190: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-0000f1a0: 2020 2020 2020 274e 6f74 2061 2064 6972        'Not a dir
-0000f1b0: 6563 746f 7279 3a20 2572 2720 2520 7365  ectory: %r' % se
-0000f1c0: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-0000f1d0: 746f 636f 6c29 0a20 2020 2020 2020 2065  tocol).        e
-0000f1e0: 6c69 6620 6e6f 7420 7365 6c66 2e69 735f  lif not self.is_
-0000f1f0: 6469 7228 293a 0a20 2020 2020 2020 2020  dir():.         
-0000f200: 2020 2072 6169 7365 2053 3346 696c 654e     raise S3FileN
-0000f210: 6f74 466f 756e 6445 7272 6f72 280a 2020  otFoundError(.  
-0000f220: 2020 2020 2020 2020 2020 2020 2020 274e                'N
-0000f230: 6f20 7375 6368 2064 6972 6563 746f 7279  o such directory
-0000f240: 3a20 2572 2720 2520 7365 6c66 2e70 6174  : %r' % self.pat
-0000f250: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-0000f260: 0a20 2020 2020 2020 2070 7265 6669 7820  .        prefix 
-0000f270: 3d20 5f62 6563 6f6d 655f 7072 6566 6978  = _become_prefix
-0000f280: 286b 6579 290a 2020 2020 2020 2020 636c  (key).        cl
-0000f290: 6965 6e74 203d 2067 6574 5f73 335f 636c  ient = get_s3_cl
-0000f2a0: 6965 6e74 2829 0a0a 2020 2020 2020 2020  ient()..        
-0000f2b0: 2320 496e 206f 7264 6572 2074 6f20 646f  # In order to do
-0000f2c0: 2063 6865 636b 206f 6e20 6372 6561 7469   check on creati
-0000f2d0: 6f6e 2c0a 2020 2020 2020 2020 2320 7765  on,.        # we
-0000f2e0: 206e 6565 6420 746f 2077 7261 7020 7468   need to wrap th
-0000f2f0: 6520 6974 6572 6174 6f72 2069 6e20 616e  e iterator in an
-0000f300: 6f74 6865 7220 6675 6e63 7469 6f6e 0a20  other function. 
-0000f310: 2020 2020 2020 2064 6566 2063 7265 6174         def creat
-0000f320: 655f 6765 6e65 7261 746f 7228 2920 2d3e  e_generator() ->
-0000f330: 2049 7465 7261 746f 725b 4669 6c65 456e   Iterator[FileEn
-0000f340: 7472 795d 3a0a 2020 2020 2020 2020 2020  try]:.          
-0000f350: 2020 7769 7468 2072 6169 7365 5f73 335f    with raise_s3_
-0000f360: 6572 726f 7228 7365 6c66 2e70 6174 685f  error(self.path_
-0000f370: 7769 7468 5f70 726f 746f 636f 6c29 3a0a  with_protocol):.
-0000f380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f390: 2064 6566 2067 656e 6572 6174 655f 7333   def generate_s3
-0000f3a0: 5f70 6174 6828 6275 636b 6574 3a20 7374  _path(bucket: st
-0000f3b0: 722c 206b 6579 3a20 7374 7229 202d 3e20  r, key: str) -> 
-0000f3c0: 7374 723a 0a20 2020 2020 2020 2020 2020  str:.           
-0000f3d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000f3e0: 2273 333a 2f2f 2573 2f25 7322 2025 2028  "s3://%s/%s" % (
-0000f3f0: 6275 636b 6574 2c20 6b65 7929 0a0a 2020  bucket, key)..  
-0000f400: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000f410: 206e 6f74 2062 7563 6b65 7420 616e 6420   not bucket and 
-0000f420: 6e6f 7420 6b65 793a 2020 2320 6c69 7374  not key:  # list
-0000f430: 2062 7563 6b65 7473 0a20 2020 2020 2020   buckets.       
-0000f440: 2020 2020 2020 2020 2020 2020 2072 6573               res
-0000f450: 706f 6e73 6520 3d20 636c 6965 6e74 2e6c  ponse = client.l
-0000f460: 6973 745f 6275 636b 6574 7328 290a 2020  ist_buckets().  
-0000f470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f480: 2020 666f 7220 636f 6e74 656e 7420 696e    for content in
-0000f490: 2072 6573 706f 6e73 655b 2742 7563 6b65   response['Bucke
-0000f4a0: 7473 275d 3a0a 2020 2020 2020 2020 2020  ts']:.          
-0000f4b0: 2020 2020 2020 2020 2020 2020 2020 7969                yi
-0000f4c0: 656c 6420 4669 6c65 456e 7472 7928 0a20  eld FileEntry(. 
-0000f4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f4e0: 2020 2020 2020 2020 2020 2063 6f6e 7465             conte
-0000f4f0: 6e74 5b27 4e61 6d65 275d 2c20 6622 7333  nt['Name'], f"s3
-0000f500: 3a2f 2f7b 636f 6e74 656e 745b 274e 616d  ://{content['Nam
-0000f510: 6527 5d7d 222c 0a20 2020 2020 2020 2020  e']}",.         
-0000f520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f530: 2020 2053 7461 7452 6573 756c 7428 0a20     StatResult(. 
-0000f540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f550: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0000f560: 7469 6d65 3d63 6f6e 7465 6e74 5b27 4372  time=content['Cr
-0000f570: 6561 7469 6f6e 4461 7465 275d 2e74 696d  eationDate'].tim
-0000f580: 6573 7461 6d70 2829 2c0a 2020 2020 2020  estamp(),.      
-0000f590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f5a0: 2020 2020 2020 2020 2020 6973 6469 723d            isdir=
-0000f5b0: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
-0000f5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f5d0: 2020 2020 2020 6578 7472 613d 636f 6e74        extra=cont
-0000f5e0: 656e 742c 0a20 2020 2020 2020 2020 2020  ent,.           
-0000f5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f600: 2029 290a 2020 2020 2020 2020 2020 2020   )).            
-0000f610: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
-0000f620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f630: 666f 7220 7265 7370 2069 6e20 5f6c 6973  for resp in _lis
-0000f640: 745f 6f62 6a65 6374 735f 7265 6375 7273  t_objects_recurs
-0000f650: 6976 6528 636c 6965 6e74 2c20 6275 636b  ive(client, buck
-0000f660: 6574 2c20 7072 6566 6978 2c0a 2020 2020  et, prefix,.    
-0000f670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f6a0: 272f 2729 3a0a 2020 2020 2020 2020 2020  '/'):.          
-0000f6b0: 2020 2020 2020 2020 2020 666f 7220 636f            for co
-0000f6c0: 6d6d 6f6e 5f70 7265 6669 7820 696e 2072  mmon_prefix in r
-0000f6d0: 6573 702e 6765 7428 2743 6f6d 6d6f 6e50  esp.get('CommonP
-0000f6e0: 7265 6669 7865 7327 2c20 5b5d 293a 0a20  refixes', []):. 
-0000f6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f700: 2020 2020 2020 2079 6965 6c64 2046 696c         yield Fil
-0000f710: 6545 6e74 7279 280a 2020 2020 2020 2020  eEntry(.        
-0000f720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f730: 2020 2020 636f 6d6d 6f6e 5f70 7265 6669      common_prefi
-0000f740: 785b 2750 7265 6669 7827 5d5b 6c65 6e28  x['Prefix'][len(
-0000f750: 7072 6566 6978 293a 2d31 5d2c 0a20 2020  prefix):-1],.   
-0000f760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f770: 2020 2020 2020 2020 2067 656e 6572 6174           generat
-0000f780: 655f 7333 5f70 6174 6828 6275 636b 6574  e_s3_path(bucket
-0000f790: 2c20 636f 6d6d 6f6e 5f70 7265 6669 785b  , common_prefix[
-0000f7a0: 2750 7265 6669 7827 5d29 2c0a 2020 2020  'Prefix']),.    
-0000f7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f7c0: 2020 2020 2020 2020 5374 6174 5265 7375          StatResu
-0000f7d0: 6c74 2869 7364 6972 3d54 7275 652c 2065  lt(isdir=True, e
-0000f7e0: 7874 7261 3d63 6f6d 6d6f 6e5f 7072 6566  xtra=common_pref
-0000f7f0: 6978 2929 0a20 2020 2020 2020 2020 2020  ix)).           
-0000f800: 2020 2020 2020 2020 2066 6f72 2063 6f6e           for con
-0000f810: 7465 6e74 2069 6e20 7265 7370 2e67 6574  tent in resp.get
-0000f820: 2827 436f 6e74 656e 7473 272c 205b 5d29  ('Contents', [])
-0000f830: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000f840: 2020 2020 2020 2020 2020 7372 635f 7572            src_ur
-0000f850: 6c20 3d20 6765 6e65 7261 7465 5f73 335f  l = generate_s3_
-0000f860: 7061 7468 2862 7563 6b65 742c 2063 6f6e  path(bucket, con
-0000f870: 7465 6e74 5b27 4b65 7927 5d29 0a0a 2020  tent['Key'])..  
-0000f880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f890: 2020 2020 2020 6966 2066 6f6c 6c6f 776c        if followl
-0000f8a0: 696e 6b73 2061 6e64 2053 3350 6174 6828  inks and S3Path(
-0000f8b0: 7372 635f 7572 6c29 2e69 735f 7379 6d6c  src_url).is_syml
-0000f8c0: 696e 6b28 293a 0a20 2020 2020 2020 2020  ink():.         
-0000f8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f8e0: 2020 2063 6f6e 7465 6e74 5b27 6973 6c6e     content['isln
-0000f8f0: 6b27 5d20 3d20 5472 7565 0a0a 2020 2020  k'] = True..    
-0000f900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f910: 2020 2020 7969 656c 6420 4669 6c65 456e      yield FileEn
-0000f920: 7472 7928 0a20 2020 2020 2020 2020 2020  try(.           
-0000f930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f940: 2063 6f6e 7465 6e74 5b27 4b65 7927 5d5b   content['Key'][
-0000f950: 6c65 6e28 7072 6566 6978 293a 5d2c 2073  len(prefix):], s
-0000f960: 7263 5f75 726c 2c0a 2020 2020 2020 2020  rc_url,.        
-0000f970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f980: 2020 2020 5f6d 616b 655f 7374 6174 2863      _make_stat(c
-0000f990: 6f6e 7465 6e74 2929 0a0a 2020 2020 2020  ontent))..      
-0000f9a0: 2020 7265 7475 726e 2043 6f6e 7465 7874    return Context
-0000f9b0: 4974 6572 6174 6f72 2863 7265 6174 655f  Iterator(create_
-0000f9c0: 6765 6e65 7261 746f 7228 2929 0a0a 2020  generator())..  
-0000f9d0: 2020 6465 6620 5f67 6574 6469 7273 7461    def _getdirsta
-0000f9e0: 7428 7365 6c66 2920 2d3e 2053 7461 7452  t(self) -> StatR
-0000f9f0: 6573 756c 743a 0a20 2020 2020 2020 2027  esult:.        '
-0000fa00: 2727 0a20 2020 2020 2020 2052 6574 7572  ''.        Retur
-0000fa10: 6e20 5374 6174 5265 7375 6c74 206f 6620  n StatResult of 
-0000fa20: 6769 7665 6e20 7333 5f75 726c 2064 6972  given s3_url dir
-0000fa30: 6563 746f 7279 2c20 696e 636c 7564 696e  ectory, includin
-0000fa40: 673a 200a 0a20 2020 2020 2020 2031 2e20  g: ..        1. 
-0000fa50: 4469 7265 6374 6f72 7920 7369 7a65 3a20  Directory size: 
-0000fa60: 7468 6520 7375 6d20 6f66 2061 6c6c 2066  the sum of all f
-0000fa70: 696c 6520 7369 7a65 2069 6e20 6974 2c20  ile size in it, 
-0000fa80: 696e 636c 7564 696e 6720 6669 6c65 2069  including file i
-0000fa90: 6e20 7375 6264 6972 6563 746f 7269 6573  n subdirectories
-0000faa0: 2028 6966 2065 7869 7374 292e 0a20 2020   (if exist)..   
-0000fab0: 2020 2020 2054 6865 2072 6573 756c 7420       The result 
-0000fac0: 6578 636c 7564 6573 2074 6865 2073 697a  excludes the siz
-0000fad0: 6520 6f66 2064 6972 6563 746f 7279 2069  e of directory i
-0000fae0: 7473 656c 662e 2049 6e20 6f74 6865 7220  tself. In other 
-0000faf0: 776f 7264 732c 2072 6574 7572 6e20 3020  words, return 0 
-0000fb00: 4279 7465 206f 6e20 616e 2065 6d70 7479  Byte on an empty
-0000fb10: 2064 6972 6563 746f 7279 2070 6174 680a   directory path.
-0000fb20: 2020 2020 2020 2020 322e 204c 6173 742d          2. Last-
-0000fb30: 6d6f 6469 6669 6564 2074 696d 6520 6f66  modified time of
-0000fb40: 2064 6972 6563 746f 7279 3a20 7265 7475   directory: retu
-0000fb50: 726e 2074 6865 206c 6174 6573 7420 6d6f  rn the latest mo
-0000fb60: 6469 6669 6564 2074 696d 6520 6f66 2061  dified time of a
-0000fb70: 6c6c 2066 696c 6520 696e 2069 742e 2054  ll file in it. T
-0000fb80: 6865 206d 7469 6d65 206f 6620 656d 7074  he mtime of empt
-0000fb90: 7920 6469 7265 6374 6f72 7920 6973 2031  y directory is 1
-0000fba0: 3937 302d 3031 2d30 3120 3030 3a30 303a  970-01-01 00:00:
-0000fbb0: 3030 0a0a 2020 2020 2020 2020 3a72 6574  00..        :ret
-0000fbc0: 7572 6e73 3a20 416e 2069 6e74 2069 6e64  urns: An int ind
-0000fbd0: 6963 6174 6573 2073 697a 6520 696e 2042  icates size in B
-0000fbe0: 7974 6573 0a20 2020 2020 2020 2027 2727  ytes.        '''
-0000fbf0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0000fc00: 7365 6c66 2e69 735f 6469 7228 293a 0a20  self.is_dir():. 
-0000fc10: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000fc20: 2053 3346 696c 654e 6f74 466f 756e 6445   S3FileNotFoundE
-0000fc30: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-0000fc40: 2020 2020 2020 274e 6f20 7375 6368 2066        'No such f
-0000fc50: 696c 6520 6f72 2064 6972 6563 746f 7279  ile or directory
-0000fc60: 3a20 2572 2720 2520 7365 6c66 2e70 6174  : %r' % self.pat
-0000fc70: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-0000fc80: 0a0a 2020 2020 2020 2020 6275 636b 6574  ..        bucket
-0000fc90: 2c20 6b65 7920 3d20 7061 7273 655f 7333  , key = parse_s3
-0000fca0: 5f75 726c 2873 656c 662e 7061 7468 5f77  _url(self.path_w
-0000fcb0: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
-0000fcc0: 2020 2020 2020 7072 6566 6978 203d 205f        prefix = _
-0000fcd0: 6265 636f 6d65 5f70 7265 6669 7828 6b65  become_prefix(ke
-0000fce0: 7929 0a20 2020 2020 2020 2063 6c69 656e  y).        clien
-0000fcf0: 7420 3d20 6765 745f 7333 5f63 6c69 656e  t = get_s3_clien
-0000fd00: 7428 290a 2020 2020 2020 2020 7369 7a65  t().        size
-0000fd10: 203d 2030 0a20 2020 2020 2020 206d 7469   = 0.        mti
-0000fd20: 6d65 203d 2030 2e30 0a20 2020 2020 2020  me = 0.0.       
-0000fd30: 2077 6974 6820 7261 6973 655f 7333 5f65   with raise_s3_e
-0000fd40: 7272 6f72 2873 656c 662e 7061 7468 5f77  rror(self.path_w
-0000fd50: 6974 685f 7072 6f74 6f63 6f6c 293a 0a20  ith_protocol):. 
-0000fd60: 2020 2020 2020 2020 2020 2066 6f72 2072             for r
-0000fd70: 6573 7020 696e 205f 6c69 7374 5f6f 626a  esp in _list_obj
-0000fd80: 6563 7473 5f72 6563 7572 7369 7665 2863  ects_recursive(c
-0000fd90: 6c69 656e 742c 2062 7563 6b65 742c 2070  lient, bucket, p
-0000fda0: 7265 6669 7829 3a0a 2020 2020 2020 2020  refix):.        
-0000fdb0: 2020 2020 2020 2020 666f 7220 636f 6e74          for cont
-0000fdc0: 656e 7420 696e 2072 6573 702e 6765 7428  ent in resp.get(
-0000fdd0: 2743 6f6e 7465 6e74 7327 2c20 5b5d 293a  'Contents', []):
-0000fde0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fdf0: 2020 2020 2073 697a 6520 2b3d 2063 6f6e       size += con
-0000fe00: 7465 6e74 5b27 5369 7a65 275d 0a20 2020  tent['Size'].   
-0000fe10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fe20: 206c 6173 745f 6d6f 6469 6669 6564 203d   last_modified =
-0000fe30: 2063 6f6e 7465 6e74 5b27 4c61 7374 4d6f   content['LastMo
-0000fe40: 6469 6669 6564 275d 2e74 696d 6573 7461  dified'].timesta
-0000fe50: 6d70 2829 0a20 2020 2020 2020 2020 2020  mp().           
-0000fe60: 2020 2020 2020 2020 2069 6620 6d74 696d           if mtim
-0000fe70: 6520 3c20 6c61 7374 5f6d 6f64 6966 6965  e < last_modifie
-0000fe80: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
-0000fe90: 2020 2020 2020 2020 2020 206d 7469 6d65             mtime
-0000fea0: 203d 206c 6173 745f 6d6f 6469 6669 6564   = last_modified
-0000feb0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-0000fec0: 2053 7461 7452 6573 756c 7428 7369 7a65   StatResult(size
-0000fed0: 3d73 697a 652c 206d 7469 6d65 3d6d 7469  =size, mtime=mti
-0000fee0: 6d65 2c20 6973 6469 723d 5472 7565 290a  me, isdir=True).
-0000fef0: 0a20 2020 2064 6566 2073 7461 7428 7365  .    def stat(se
-0000ff00: 6c66 2c20 666f 6c6c 6f77 5f73 796d 6c69  lf, follow_symli
-0000ff10: 6e6b 733d 5472 7565 2920 2d3e 2053 7461  nks=True) -> Sta
-0000ff20: 7452 6573 756c 743a 0a20 2020 2020 2020  tResult:.       
-0000ff30: 2027 2727 0a20 2020 2020 2020 2047 6574   '''.        Get
-0000ff40: 2053 7461 7452 6573 756c 7420 6f66 2073   StatResult of s
-0000ff50: 335f 7572 6c20 6669 6c65 2c20 696e 636c  3_url file, incl
-0000ff60: 7564 696e 6720 6669 6c65 2073 697a 6520  uding file size 
-0000ff70: 616e 6420 6d74 696d 652c 2072 6566 6572  and mtime, refer
-0000ff80: 7269 6e67 2074 6f20 7333 5f67 6574 7369  ring to s3_getsi
-0000ff90: 7a65 2061 6e64 2073 335f 6765 746d 7469  ze and s3_getmti
-0000ffa0: 6d65 0a0a 2020 2020 2020 2020 4966 2073  me..        If s
-0000ffb0: 335f 7572 6c20 6973 206e 6f74 2061 6e20  3_url is not an 
-0000ffc0: 6578 6973 7465 6e74 2070 6174 682c 2077  existent path, w
-0000ffd0: 6869 6368 206d 6561 6e73 2073 335f 6578  hich means s3_ex
-0000ffe0: 6973 7428 7333 5f75 726c 2920 7265 7475  ist(s3_url) retu
-0000fff0: 726e 7320 4661 6c73 652c 2074 6865 6e20  rns False, then 
-00010000: 7261 6973 6520 5333 4669 6c65 4e6f 7446  raise S3FileNotF
-00010010: 6f75 6e64 4572 726f 720a 2020 2020 2020  oundError.      
-00010020: 2020 4966 2061 7474 656d 7074 2074 6f20    If attempt to 
-00010030: 6765 7420 5374 6174 5265 7375 6c74 206f  get StatResult o
-00010040: 6620 636f 6d70 6c65 7465 2073 332c 2073  f complete s3, s
-00010050: 7563 6820 6173 2073 335f 6469 725f 7572  uch as s3_dir_ur
-00010060: 6c20 3d3d 2027 7333 3a2f 2f27 2c20 7261  l == 's3://', ra
-00010070: 6973 6520 5333 4275 636b 6574 4e6f 7446  ise S3BucketNotF
-00010080: 6f75 6e64 4572 726f 720a 0a20 2020 2020  oundError..     
-00010090: 2020 203a 7265 7475 726e 733a 2053 7461     :returns: Sta
-000100a0: 7452 6573 756c 740a 2020 2020 2020 2020  tResult.        
-000100b0: 3a72 6169 7365 733a 2053 3346 696c 654e  :raises: S3FileN
-000100c0: 6f74 466f 756e 6445 7272 6f72 2c20 5333  otFoundError, S3
-000100d0: 4275 636b 6574 4e6f 7446 6f75 6e64 4572  BucketNotFoundEr
-000100e0: 726f 720a 2020 2020 2020 2020 2727 270a  ror.        '''.
-000100f0: 2020 2020 2020 2020 6973 6c6e 6b20 3d20          islnk = 
-00010100: 4661 6c73 650a 2020 2020 2020 2020 6275  False.        bu
-00010110: 636b 6574 2c20 6b65 7920 3d20 7061 7273  cket, key = pars
-00010120: 655f 7333 5f75 726c 2873 656c 662e 7061  e_s3_url(self.pa
-00010130: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-00010140: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-00010150: 2062 7563 6b65 743a 0a20 2020 2020 2020   bucket:.       
-00010160: 2020 2020 2072 6169 7365 2053 3342 7563       raise S3Buc
-00010170: 6b65 744e 6f74 466f 756e 6445 7272 6f72  ketNotFoundError
-00010180: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00010190: 2020 2745 6d70 7479 2062 7563 6b65 7420    'Empty bucket 
-000101a0: 6e61 6d65 3a20 2572 2720 2520 7365 6c66  name: %r' % self
-000101b0: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
-000101c0: 636f 6c29 0a0a 2020 2020 2020 2020 6966  col)..        if
-000101d0: 206e 6f74 2073 656c 662e 6973 5f66 696c   not self.is_fil
-000101e0: 6528 293a 0a20 2020 2020 2020 2020 2020  e():.           
-000101f0: 2072 6574 7572 6e20 7365 6c66 2e5f 6765   return self._ge
-00010200: 7464 6972 7374 6174 2829 0a0a 2020 2020  tdirstat()..    
-00010210: 2020 2020 636c 6965 6e74 203d 2067 6574      client = get
-00010220: 5f73 335f 636c 6965 6e74 2829 0a20 2020  _s3_client().   
-00010230: 2020 2020 2077 6974 6820 7261 6973 655f       with raise_
-00010240: 7333 5f65 7272 6f72 2873 656c 662e 7061  s3_error(self.pa
-00010250: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-00010260: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
-00010270: 6f6e 7465 6e74 203d 2063 6c69 656e 742e  ontent = client.
-00010280: 6865 6164 5f6f 626a 6563 7428 4275 636b  head_object(Buck
-00010290: 6574 3d62 7563 6b65 742c 204b 6579 3d6b  et=bucket, Key=k
-000102a0: 6579 290a 2020 2020 2020 2020 2020 2020  ey).            
-000102b0: 6966 2027 4d65 7461 6461 7461 2720 696e  if 'Metadata' in
-000102c0: 2063 6f6e 7465 6e74 3a0a 2020 2020 2020   content:.      
-000102d0: 2020 2020 2020 2020 2020 6d65 7461 6461            metada
-000102e0: 7461 203d 2064 6963 7428 0a20 2020 2020  ta = dict(.     
-000102f0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00010300: 6b65 792e 6c6f 7765 7228 292c 2076 616c  key.lower(), val
-00010310: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
-00010320: 2020 2020 2020 2020 666f 7220 6b65 792c          for key,
-00010330: 2076 616c 7565 2069 6e20 636f 6e74 656e   value in conten
-00010340: 745b 274d 6574 6164 6174 6127 5d2e 6974  t['Metadata'].it
-00010350: 656d 7328 2929 0a20 2020 2020 2020 2020  ems()).         
-00010360: 2020 2020 2020 2069 6620 6d65 7461 6461         if metada
-00010370: 7461 2061 6e64 2027 7379 6d6c 696e 6b5f  ta and 'symlink_
-00010380: 746f 2720 696e 206d 6574 6164 6174 613a  to' in metadata:
-00010390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000103a0: 2020 2020 2069 736c 6e6b 203d 2054 7275       islnk = Tru
-000103b0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-000103c0: 2020 2020 2020 6966 2069 736c 6e6b 2061        if islnk a
-000103d0: 6e64 2066 6f6c 6c6f 775f 7379 6d6c 696e  nd follow_symlin
-000103e0: 6b73 3a0a 2020 2020 2020 2020 2020 2020  ks:.            
-000103f0: 2020 2020 2020 2020 2020 2020 7333 5f75              s3_u
-00010400: 726c 203d 206d 6574 6164 6174 615b 2773  rl = metadata['s
-00010410: 796d 6c69 6e6b 5f74 6f27 5d0a 2020 2020  ymlink_to'].    
-00010420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010430: 2020 2020 6275 636b 6574 2c20 6b65 7920      bucket, key 
-00010440: 3d20 7061 7273 655f 7333 5f75 726c 2873  = parse_s3_url(s
-00010450: 335f 7572 6c29 0a20 2020 2020 2020 2020  3_url).         
-00010460: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00010470: 6f6e 7465 6e74 203d 2063 6c69 656e 742e  ontent = client.
-00010480: 6865 6164 5f6f 626a 6563 7428 4275 636b  head_object(Buck
-00010490: 6574 3d62 7563 6b65 742c 204b 6579 3d6b  et=bucket, Key=k
-000104a0: 6579 290a 2020 2020 2020 2020 2020 2020  ey).            
-000104b0: 7374 6174 5f72 6563 6f72 6420 3d20 5374  stat_record = St
-000104c0: 6174 5265 7375 6c74 280a 2020 2020 2020  atResult(.      
-000104d0: 2020 2020 2020 2020 2020 6973 6c6e 6b3d            islnk=
-000104e0: 6973 6c6e 6b2c 0a20 2020 2020 2020 2020  islnk,.         
-000104f0: 2020 2020 2020 2073 697a 653d 636f 6e74         size=cont
-00010500: 656e 745b 2743 6f6e 7465 6e74 4c65 6e67  ent['ContentLeng
-00010510: 7468 275d 2c0a 2020 2020 2020 2020 2020  th'],.          
-00010520: 2020 2020 2020 6d74 696d 653d 636f 6e74        mtime=cont
-00010530: 656e 745b 274c 6173 744d 6f64 6966 6965  ent['LastModifie
-00010540: 6427 5d2e 7469 6d65 7374 616d 7028 292c  d'].timestamp(),
-00010550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010560: 2065 7874 7261 3d63 6f6e 7465 6e74 290a   extra=content).
-00010570: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00010580: 7461 745f 7265 636f 7264 0a0a 2020 2020  tat_record..    
-00010590: 6465 6620 6c73 7461 7428 7365 6c66 2920  def lstat(self) 
-000105a0: 2d3e 2053 7461 7452 6573 756c 743a 0a20  -> StatResult:. 
-000105b0: 2020 2020 2020 2027 2727 4c69 6b65 2050         '''Like P
-000105c0: 6174 682e 7374 6174 2829 2062 7574 2c20  ath.stat() but, 
-000105d0: 6966 2074 6865 2070 6174 6820 706f 696e  if the path poin
-000105e0: 7473 2074 6f20 6120 7379 6d62 6f6c 6963  ts to a symbolic
-000105f0: 206c 696e 6b2c 2072 6574 7572 6e20 7468   link, return th
-00010600: 6520 7379 6d62 6f6c 6963 206c 696e 6be2  e symbolic link.
-00010610: 8099 7320 696e 666f 726d 6174 696f 6e20  ..s information 
-00010620: 7261 7468 6572 2074 6861 6e20 6974 7320  rather than its 
-00010630: 7461 7267 6574 e280 9973 2e27 2727 0a20  target...s.'''. 
-00010640: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00010650: 6c66 2e73 7461 7428 666f 6c6c 6f77 5f73  lf.stat(follow_s
-00010660: 796d 6c69 6e6b 733d 4661 6c73 6529 0a0a  ymlinks=False)..
-00010670: 2020 2020 6465 6620 756e 6c69 6e6b 2873      def unlink(s
-00010680: 656c 662c 206d 6973 7369 6e67 5f6f 6b3a  elf, missing_ok:
-00010690: 2062 6f6f 6c20 3d20 4661 6c73 6529 202d   bool = False) -
-000106a0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-000106b0: 2727 270a 2020 2020 2020 2020 5265 6d6f  '''.        Remo
-000106c0: 7665 2074 6865 2066 696c 6520 6f6e 2073  ve the file on s
-000106d0: 330a 0a20 2020 2020 2020 203a 7061 7261  3..        :para
-000106e0: 6d20 6d69 7373 696e 675f 6f6b 3a20 6966  m missing_ok: if
-000106f0: 2046 616c 7365 2061 6e64 2074 6172 6765   False and targe
-00010700: 7420 6669 6c65 206e 6f74 2065 7869 7374  t file not exist
-00010710: 732c 2072 6169 7365 2053 3346 696c 654e  s, raise S3FileN
-00010720: 6f74 466f 756e 6445 7272 6f72 0a20 2020  otFoundError.   
-00010730: 2020 2020 203a 7261 6973 6573 3a20 5333       :raises: S3
-00010740: 5065 726d 6973 7369 6f6e 4572 726f 722c  PermissionError,
-00010750: 2053 3346 696c 654e 6f74 466f 756e 6445   S3FileNotFoundE
-00010760: 7272 6f72 2c20 5333 4973 4144 6972 6563  rror, S3IsADirec
-00010770: 746f 7279 4572 726f 720a 2020 2020 2020  toryError.      
-00010780: 2020 2727 270a 2020 2020 2020 2020 6275    '''.        bu
-00010790: 636b 6574 2c20 6b65 7920 3d20 7061 7273  cket, key = pars
-000107a0: 655f 7333 5f75 726c 2873 656c 662e 7061  e_s3_url(self.pa
-000107b0: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-000107c0: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-000107d0: 2062 7563 6b65 7420 6f72 206e 6f74 206b   bucket or not k
-000107e0: 6579 206f 7220 6b65 792e 656e 6473 7769  ey or key.endswi
-000107f0: 7468 2827 2f27 293a 0a20 2020 2020 2020  th('/'):.       
-00010800: 2020 2020 2072 6169 7365 2053 3349 7341       raise S3IsA
-00010810: 4469 7265 6374 6f72 7945 7272 6f72 280a  DirectoryError(.
-00010820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010830: 2749 7320 6120 6469 7265 6374 6f72 793a  'Is a directory:
-00010840: 2025 7227 2025 2073 656c 662e 7061 7468   %r' % self.path
-00010850: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
-00010860: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-00010870: 656c 662e 6973 5f66 696c 6528 293a 0a20  elf.is_file():. 
-00010880: 2020 2020 2020 2020 2020 2069 6620 6d69             if mi
-00010890: 7373 696e 675f 6f6b 3a0a 2020 2020 2020  ssing_ok:.      
-000108a0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000108b0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-000108c0: 7365 2053 3346 696c 654e 6f74 466f 756e  se S3FileNotFoun
-000108d0: 6445 7272 6f72 280a 2020 2020 2020 2020  dError(.        
-000108e0: 2020 2020 2020 2020 274e 6f20 7375 6368          'No such
-000108f0: 2066 696c 653a 2025 7227 2025 2073 656c   file: %r' % sel
-00010900: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
-00010910: 6f63 6f6c 290a 0a20 2020 2020 2020 2063  ocol)..        c
-00010920: 6c69 656e 7420 3d20 6765 745f 7333 5f63  lient = get_s3_c
-00010930: 6c69 656e 7428 290a 2020 2020 2020 2020  lient().        
-00010940: 7769 7468 2072 6169 7365 5f73 335f 6572  with raise_s3_er
-00010950: 726f 7228 7365 6c66 2e70 6174 685f 7769  ror(self.path_wi
-00010960: 7468 5f70 726f 746f 636f 6c29 3a0a 2020  th_protocol):.  
-00010970: 2020 2020 2020 2020 2020 636c 6965 6e74            client
-00010980: 2e64 656c 6574 655f 6f62 6a65 6374 2842  .delete_object(B
-00010990: 7563 6b65 743d 6275 636b 6574 2c20 4b65  ucket=bucket, Ke
-000109a0: 793d 6b65 7929 0a0a 2020 2020 6465 6620  y=key)..    def 
-000109b0: 7761 6c6b 2873 656c 662c 2066 6f6c 6c6f  walk(self, follo
-000109c0: 776c 696e 6b73 3a20 626f 6f6c 203d 2046  wlinks: bool = F
-000109d0: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
-000109e0: 2029 202d 3e20 4974 6572 6174 6f72 5b54   ) -> Iterator[T
-000109f0: 7570 6c65 5b73 7472 2c20 4c69 7374 5b73  uple[str, List[s
-00010a00: 7472 5d2c 204c 6973 745b 7374 725d 5d5d  tr], List[str]]]
-00010a10: 3a0a 2020 2020 2020 2020 2727 270a 2020  :.        '''.  
-00010a20: 2020 2020 2020 4974 6572 6174 6976 656c        Iterativel
-00010a30: 7920 7472 6176 6572 7365 2074 6865 2067  y traverse the g
-00010a40: 6976 656e 2073 3320 6469 7265 6374 6f72  iven s3 director
-00010a50: 792c 2069 6e20 746f 702d 626f 7474 6f6d  y, in top-bottom
-00010a60: 206f 7264 6572 2e20 496e 206f 7468 6572   order. In other
-00010a70: 2077 6f72 6473 2c20 6669 7273 746c 7920   words, firstly 
-00010a80: 7472 6176 6572 7365 2070 6172 656e 7420  traverse parent 
-00010a90: 6469 7265 6374 6f72 792c 2069 6620 7375  directory, if su
-00010aa0: 6264 6972 6563 746f 7269 6573 2065 7869  bdirectories exi
-00010ab0: 7374 2c20 7472 6176 6572 7365 2074 6865  st, traverse the
-00010ac0: 2073 7562 6469 7265 6374 6f72 6965 7320   subdirectories 
-00010ad0: 696e 2061 6c70 6861 6265 7469 6361 6c20  in alphabetical 
-00010ae0: 6f72 6465 722e 0a20 2020 2020 2020 2045  order..        E
-00010af0: 7665 7279 2069 7465 7261 7469 6f6e 206f  very iteration o
-00010b00: 6e20 6765 6e65 7261 746f 7220 7969 656c  n generator yiel
-00010b10: 6473 2061 2033 2d74 7570 6c65 3a20 2872  ds a 3-tuple: (r
-00010b20: 6f6f 742c 2064 6972 732c 2066 696c 6573  oot, dirs, files
-00010b30: 290a 0a20 2020 2020 2020 202d 2072 6f6f  )..        - roo
-00010b40: 743a 2043 7572 7265 6e74 2073 3320 7061  t: Current s3 pa
-00010b50: 7468 3b0a 2020 2020 2020 2020 2d20 6469  th;.        - di
-00010b60: 7273 3a20 4e61 6d65 206c 6973 7420 6f66  rs: Name list of
-00010b70: 2073 7562 6469 7265 6374 6f72 6965 7320   subdirectories 
-00010b80: 696e 2063 7572 7265 6e74 2064 6972 6563  in current direc
-00010b90: 746f 7279 2e20 5468 6520 6c69 7374 2069  tory. The list i
-00010ba0: 7320 736f 7274 6564 2062 7920 6e61 6d65  s sorted by name
-00010bb0: 2069 6e20 6173 6365 6e64 696e 6720 616c   in ascending al
-00010bc0: 7068 6162 6574 6963 616c 206f 7264 6572  phabetical order
-00010bd0: 3b0a 2020 2020 2020 2020 2d20 6669 6c65  ;.        - file
-00010be0: 733a 204e 616d 6520 6c69 7374 206f 6620  s: Name list of 
-00010bf0: 6669 6c65 7320 696e 2063 7572 7265 6e74  files in current
-00010c00: 2064 6972 6563 746f 7279 2e20 5468 6520   directory. The 
-00010c10: 6c69 7374 2069 7320 736f 7274 6564 2062  list is sorted b
-00010c20: 7920 6e61 6d65 2069 6e20 6173 6365 6e64  y name in ascend
-00010c30: 696e 6720 616c 7068 6162 6574 6963 616c  ing alphabetical
-00010c40: 206f 7264 6572 3b0a 0a20 2020 2020 2020   order;..       
-00010c50: 2049 6620 7333 5f75 726c 2069 7320 6120   If s3_url is a 
-00010c60: 6669 6c65 2070 6174 682c 2072 6574 7572  file path, retur
-00010c70: 6e20 616e 2065 6d70 7479 2067 656e 6572  n an empty gener
-00010c80: 6174 6f72 0a20 2020 2020 2020 2049 6620  ator.        If 
-00010c90: 7333 5f75 726c 2069 7320 6120 6e6f 6e2d  s3_url is a non-
-00010ca0: 6578 6973 7465 6e74 2070 6174 682c 2072  existent path, r
-00010cb0: 6574 7572 6e20 616e 2065 6d70 7479 2067  eturn an empty g
-00010cc0: 656e 6572 6174 6f72 0a20 2020 2020 2020  enerator.       
-00010cd0: 2049 6620 7333 5f75 726c 2069 7320 6120   If s3_url is a 
-00010ce0: 6275 636b 6574 2070 6174 682c 2062 7563  bucket path, buc
-00010cf0: 6b65 7420 7769 6c6c 2062 6520 7468 6520  ket will be the 
-00010d00: 746f 7020 6469 7265 6374 6f72 792c 2061  top directory, a
-00010d10: 6e64 2077 696c 6c20 6265 2072 6574 7572  nd will be retur
-00010d20: 6e65 6420 6174 2066 6972 7374 2069 7465  ned at first ite
-00010d30: 7261 7469 6f6e 206f 6620 6765 6e65 7261  ration of genera
-00010d40: 746f 720a 2020 2020 2020 2020 4966 2073  tor.        If s
-00010d50: 335f 7572 6c20 6973 2061 6e20 656d 7074  3_url is an empt
-00010d60: 7920 6275 636b 6574 2c20 6f6e 6c79 2079  y bucket, only y
-00010d70: 6965 6c64 206f 6e65 2033 2d74 7570 6c65  ield one 3-tuple
-00010d80: 2028 6e6f 7465 733a 2073 3320 646f 6573   (notes: s3 does
-00010d90: 6e27 7420 6861 7665 2065 6d70 7479 2064  n't have empty d
-00010da0: 6972 6563 746f 7279 290a 2020 2020 2020  irectory).      
-00010db0: 2020 4966 2073 335f 7572 6c20 646f 6573    If s3_url does
-00010dc0: 6e27 7420 636f 6e74 6169 6e20 616e 7920  n't contain any 
-00010dd0: 6275 636b 6574 2c20 7768 6963 6820 6973  bucket, which is
-00010de0: 2073 335f 7572 6c20 3d3d 2027 7333 3a2f   s3_url == 's3:/
-00010df0: 2f27 2c20 7261 6973 6520 556e 7375 7070  /', raise Unsupp
-00010e00: 6f72 7465 6445 7272 6f72 2e20 7761 6c6b  ortedError. walk
-00010e10: 2829 206f 6e20 636f 6d70 6c65 7465 2073  () on complete s
-00010e20: 3320 6973 206e 6f74 2073 7570 706f 7274  3 is not support
-00010e30: 6564 2069 6e20 6d65 6766 696c 650a 0a20  ed in megfile.. 
-00010e40: 2020 2020 2020 203a 7061 7261 6d20 666f         :param fo
-00010e50: 6c6c 6f77 6c69 6e6b 733a 2077 6865 7468  llowlinks: wheth
-00010e60: 6572 2066 6f6c 6c6f 776c 696e 6b73 2069  er followlinks i
-00010e70: 7320 5472 7565 206f 7220 4661 6c73 652c  s True or False,
-00010e80: 2072 6573 756c 7420 6973 2074 6865 2073   result is the s
-00010e90: 616d 652e 2042 6563 6175 7365 2073 3320  ame. Because s3 
-00010ea0: 7379 6d6c 696e 6b20 6e6f 7420 7375 7070  symlink not supp
-00010eb0: 6f72 7420 6469 722e 0a20 2020 2020 2020  ort dir..       
-00010ec0: 203a 7261 6973 6573 3a20 556e 7375 7070   :raises: Unsupp
-00010ed0: 6f72 7465 6445 7272 6f72 0a20 2020 2020  ortedError.     
-00010ee0: 2020 203a 7265 7475 726e 733a 2041 2033     :returns: A 3
-00010ef0: 2d74 7570 6c65 2067 656e 6572 6174 6f72  -tuple generator
-00010f00: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
-00010f10: 2020 2020 2062 7563 6b65 742c 206b 6579       bucket, key
-00010f20: 203d 2070 6172 7365 5f73 335f 7572 6c28   = parse_s3_url(
-00010f30: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
-00010f40: 726f 746f 636f 6c29 0a20 2020 2020 2020  rotocol).       
-00010f50: 2069 6620 6e6f 7420 6275 636b 6574 3a0a   if not bucket:.
-00010f60: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00010f70: 6520 556e 7375 7070 6f72 7465 6445 7272  e UnsupportedErr
-00010f80: 6f72 2827 5761 6c6b 2077 686f 6c65 2073  or('Walk whole s
-00010f90: 3327 2c20 7365 6c66 2e70 6174 685f 7769  3', self.path_wi
-00010fa0: 7468 5f70 726f 746f 636f 6c29 0a0a 2020  th_protocol)..  
-00010fb0: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
-00010fc0: 662e 6973 5f64 6972 2829 3a0a 2020 2020  f.is_dir():.    
-00010fd0: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
-00010fe0: 2020 2020 2020 2020 7374 6163 6b20 3d20          stack = 
-00010ff0: 5b6b 6579 5d0a 2020 2020 2020 2020 636c  [key].        cl
-00011000: 6965 6e74 203d 2067 6574 5f73 335f 636c  ient = get_s3_cl
-00011010: 6965 6e74 2829 0a20 2020 2020 2020 2077  ient().        w
-00011020: 6869 6c65 206c 656e 2873 7461 636b 2920  hile len(stack) 
-00011030: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
-00011040: 2063 7572 7265 6e74 203d 205f 6265 636f   current = _beco
-00011050: 6d65 5f70 7265 6669 7828 7374 6163 6b2e  me_prefix(stack.
-00011060: 706f 7028 2929 0a20 2020 2020 2020 2020  pop()).         
-00011070: 2020 2064 6972 732c 2066 696c 6573 203d     dirs, files =
-00011080: 205b 5d2c 205b 5d0a 2020 2020 2020 2020   [], [].        
-00011090: 2020 2020 666f 7220 7265 7370 2069 6e20      for resp in 
-000110a0: 5f6c 6973 745f 6f62 6a65 6374 735f 7265  _list_objects_re
-000110b0: 6375 7273 6976 6528 636c 6965 6e74 2c20  cursive(client, 
-000110c0: 6275 636b 6574 2c20 6375 7272 656e 742c  bucket, current,
-000110d0: 2027 2f27 293a 0a20 2020 2020 2020 2020   '/'):.         
-000110e0: 2020 2020 2020 2066 6f72 2063 6f6d 6d6f         for commo
-000110f0: 6e5f 7072 6566 6978 2069 6e20 7265 7370  n_prefix in resp
-00011100: 2e67 6574 2827 436f 6d6d 6f6e 5072 6566  .get('CommonPref
-00011110: 6978 6573 272c 205b 5d29 3a0a 2020 2020  ixes', []):.    
-00011120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011130: 6469 7273 2e61 7070 656e 6428 636f 6d6d  dirs.append(comm
-00011140: 6f6e 5f70 7265 6669 785b 2750 7265 6669  on_prefix['Prefi
-00011150: 7827 5d5b 3a2d 315d 290a 2020 2020 2020  x'][:-1]).      
-00011160: 2020 2020 2020 2020 2020 666f 7220 636f            for co
-00011170: 6e74 656e 7420 696e 2072 6573 702e 6765  ntent in resp.ge
-00011180: 7428 2743 6f6e 7465 6e74 7327 2c20 5b5d  t('Contents', []
-00011190: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000111a0: 2020 2020 2020 2066 696c 6573 2e61 7070         files.app
-000111b0: 656e 6428 636f 6e74 656e 745b 274b 6579  end(content['Key
-000111c0: 275d 290a 0a20 2020 2020 2020 2020 2020  '])..           
-000111d0: 2064 6972 7320 3d20 736f 7274 6564 2864   dirs = sorted(d
-000111e0: 6972 7329 0a20 2020 2020 2020 2020 2020  irs).           
-000111f0: 2073 7461 636b 2e65 7874 656e 6428 7265   stack.extend(re
-00011200: 7665 7273 6564 2864 6972 7329 290a 0a20  versed(dirs)).. 
-00011210: 2020 2020 2020 2020 2020 2072 6f6f 7420             root 
-00011220: 3d20 7333 5f70 6174 685f 6a6f 696e 2827  = s3_path_join('
-00011230: 7333 3a2f 2f27 2c20 6275 636b 6574 2c20  s3://', bucket, 
-00011240: 6375 7272 656e 7429 5b3a 2d31 5d0a 2020  current)[:-1].  
-00011250: 2020 2020 2020 2020 2020 6469 7273 203d            dirs =
-00011260: 205b 7061 7468 5b6c 656e 2863 7572 7265   [path[len(curre
-00011270: 6e74 293a 5d20 666f 7220 7061 7468 2069  nt):] for path i
-00011280: 6e20 6469 7273 5d0a 2020 2020 2020 2020  n dirs].        
-00011290: 2020 2020 6669 6c65 7320 3d20 736f 7274      files = sort
-000112a0: 6564 2870 6174 685b 6c65 6e28 6375 7272  ed(path[len(curr
-000112b0: 656e 7429 3a5d 2066 6f72 2070 6174 6820  ent):] for path 
-000112c0: 696e 2066 696c 6573 290a 2020 2020 2020  in files).      
-000112d0: 2020 2020 2020 7969 656c 6420 726f 6f74        yield root
-000112e0: 2c20 6469 7273 2c20 6669 6c65 730a 0a20  , dirs, files.. 
-000112f0: 2020 2064 6566 206d 6435 2873 656c 662c     def md5(self,
-00011300: 2072 6563 616c 6375 6c61 7465 3a20 626f   recalculate: bo
-00011310: 6f6c 203d 2046 616c 7365 2c20 666f 6c6c  ol = False, foll
-00011320: 6f77 6c69 6e6b 733a 2062 6f6f 6c20 3d20  owlinks: bool = 
-00011330: 4661 6c73 6529 202d 3e20 7374 723a 0a20  False) -> str:. 
-00011340: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-00011350: 2020 2047 6574 206d 6435 206d 6574 6120     Get md5 meta 
-00011360: 696e 666f 2069 6e20 6669 6c65 7320 7468  info in files th
-00011370: 6174 2075 706c 6f61 6465 642f 636f 7069  at uploaded/copi
-00011380: 6564 2076 6961 206d 6567 6669 6c65 0a0a  ed via megfile..
-00011390: 2020 2020 2020 2020 4966 206d 6574 6120          If meta 
-000113a0: 696e 666f 2069 7320 6c6f 7374 206f 7220  info is lost or 
-000113b0: 6e6f 6e2d 6578 6973 7465 6e74 2c20 7265  non-existent, re
-000113c0: 7475 726e 204e 6f6e 650a 0a20 2020 2020  turn None..     
-000113d0: 2020 203a 7061 7261 6d20 7265 6361 6c63     :param recalc
-000113e0: 756c 6174 653a 2063 616c 6375 6c61 7465  ulate: calculate
-000113f0: 206d 6435 2069 6e20 7265 616c 2d74 696d   md5 in real-tim
-00011400: 6520 6f72 2072 6574 7572 6e20 7333 2065  e or return s3 e
-00011410: 7461 670a 2020 2020 2020 2020 3a70 6172  tag.        :par
-00011420: 616d 2066 6f6c 6c6f 776c 696e 6b73 3a20  am followlinks: 
-00011430: 4966 2069 7320 5472 7565 2c20 6361 6c63  If is True, calc
-00011440: 756c 6174 6520 6d64 3520 666f 7220 7265  ulate md5 for re
-00011450: 616c 2066 696c 650a 2020 2020 2020 2020  al file.        
-00011460: 3a72 6574 7572 6e73 3a20 6d64 3520 6d65  :returns: md5 me
-00011470: 7461 2069 6e66 6f0a 2020 2020 2020 2020  ta info.        
-00011480: 2727 270a 2020 2020 2020 2020 6275 636b  '''.        buck
-00011490: 6574 2c20 5f20 3d20 7061 7273 655f 7333  et, _ = parse_s3
-000114a0: 5f75 726c 2873 656c 662e 7061 7468 5f77  _url(self.path_w
-000114b0: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
-000114c0: 2020 2020 2020 6966 206e 6f74 2062 7563        if not buc
-000114d0: 6b65 743a 0a20 2020 2020 2020 2020 2020  ket:.           
-000114e0: 2072 6169 7365 2053 3342 7563 6b65 744e   raise S3BucketN
-000114f0: 6f74 466f 756e 6445 7272 6f72 280a 2020  otFoundError(.  
-00011500: 2020 2020 2020 2020 2020 2020 2020 2745                'E
-00011510: 6d70 7479 2062 7563 6b65 7420 6e61 6d65  mpty bucket name
-00011520: 3a20 2572 2720 2520 7365 6c66 2e70 6174  : %r' % self.pat
-00011530: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-00011540: 0a20 2020 2020 2020 2073 7461 7420 3d20  .        stat = 
-00011550: 7365 6c66 2e73 7461 7428 666f 6c6c 6f77  self.stat(follow
-00011560: 5f73 796d 6c69 6e6b 733d 666f 6c6c 6f77  _symlinks=follow
-00011570: 6c69 6e6b 7329 0a20 2020 2020 2020 2069  links).        i
-00011580: 6620 7374 6174 2e69 7364 6972 3a0a 2020  f stat.isdir:.  
-00011590: 2020 2020 2020 2020 2020 6861 7368 5f6d            hash_m
-000115a0: 6435 203d 2068 6173 686c 6962 2e6d 6435  d5 = hashlib.md5
-000115b0: 2829 2020 2320 6e6f 7365 630a 2020 2020  ()  # nosec.    
-000115c0: 2020 2020 2020 2020 666f 7220 6669 6c65          for file
-000115d0: 5f6e 616d 6520 696e 2073 656c 662e 6c69  _name in self.li
-000115e0: 7374 6469 7228 293a 0a20 2020 2020 2020  stdir():.       
-000115f0: 2020 2020 2020 2020 2063 6875 6e6b 203d           chunk =
-00011600: 2053 3350 6174 6828 0a20 2020 2020 2020   S3Path(.       
-00011610: 2020 2020 2020 2020 2020 2020 2073 335f               s3_
-00011620: 7061 7468 5f6a 6f69 6e28 0a20 2020 2020  path_join(.     
-00011630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011640: 2020 2073 656c 662e 7061 7468 5f77 6974     self.path_wit
-00011650: 685f 7072 6f74 6f63 6f6c 2c0a 2020 2020  h_protocol,.    
-00011660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011670: 2020 2020 6669 6c65 5f6e 616d 6529 292e      file_name)).
-00011680: 6d64 3528 7265 6361 6c63 756c 6174 653d  md5(recalculate=
-00011690: 7265 6361 6c63 756c 6174 6529 2e65 6e63  recalculate).enc
-000116a0: 6f64 6528 290a 2020 2020 2020 2020 2020  ode().          
-000116b0: 2020 2020 2020 6861 7368 5f6d 6435 2e75        hash_md5.u
-000116c0: 7064 6174 6528 6368 756e 6b29 0a20 2020  pdate(chunk).   
-000116d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000116e0: 6861 7368 5f6d 6435 2e68 6578 6469 6765  hash_md5.hexdige
-000116f0: 7374 2829 0a20 2020 2020 2020 2069 6620  st().        if 
-00011700: 7265 6361 6c63 756c 6174 653a 0a20 2020  recalculate:.   
-00011710: 2020 2020 2020 2020 2070 6174 685f 696e           path_in
-00011720: 7374 616e 6365 203d 2073 656c 660a 2020  stance = self.  
-00011730: 2020 2020 2020 2020 2020 6966 2066 6f6c            if fol
-00011740: 6c6f 776c 696e 6b73 3a0a 2020 2020 2020  lowlinks:.      
-00011750: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-00011760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011770: 2020 2070 6174 685f 696e 7374 616e 6365     path_instance
-00011780: 203d 2073 656c 662e 7265 6164 6c69 6e6b   = self.readlink
-00011790: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-000117a0: 2020 2065 7863 6570 7420 5333 4e6f 7441     except S3NotA
-000117b0: 4c69 6e6b 4572 726f 723a 0a20 2020 2020  LinkError:.     
-000117c0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000117d0: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
-000117e0: 7769 7468 2070 6174 685f 696e 7374 616e  with path_instan
-000117f0: 6365 2e6f 7065 6e28 2772 6227 2920 6173  ce.open('rb') as
-00011800: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
-00011810: 2020 2020 7265 7475 726e 2063 616c 6375      return calcu
-00011820: 6c61 7465 5f6d 6435 2866 290a 2020 2020  late_md5(f).    
-00011830: 2020 2020 7265 7475 726e 2073 7461 742e      return stat.
-00011840: 6578 7472 612e 6765 7428 2745 5461 6727  extra.get('ETag'
-00011850: 2c20 2727 295b 313a 2d31 5d0a 0a20 2020  , '')[1:-1]..   
-00011860: 2064 6566 2063 6f70 7928 0a20 2020 2020   def copy(.     
-00011870: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-00011880: 2020 2020 2020 2020 2064 7374 5f75 726c           dst_url
-00011890: 3a20 5061 7468 4c69 6b65 2c0a 2020 2020  : PathLike,.    
-000118a0: 2020 2020 2020 2020 666f 6c6c 6f77 6c69          followli
-000118b0: 6e6b 733a 2062 6f6f 6c20 3d20 4661 6c73  nks: bool = Fals
-000118c0: 652c 0a20 2020 2020 2020 2020 2020 2063  e,.            c
-000118d0: 616c 6c62 6163 6b3a 204f 7074 696f 6e61  allback: Optiona
-000118e0: 6c5b 4361 6c6c 6162 6c65 5b5b 696e 745d  l[Callable[[int]
-000118f0: 2c20 4e6f 6e65 5d5d 203d 204e 6f6e 6529  , None]] = None)
-00011900: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00011910: 2020 2727 2720 4669 6c65 2063 6f70 7920    ''' File copy 
-00011920: 6f6e 2053 330a 2020 2020 2020 2020 436f  on S3.        Co
-00011930: 7079 2063 6f6e 7465 6e74 206f 6620 6669  py content of fi
-00011940: 6c65 206f 6e20 6073 7263 5f70 6174 6860  le on `src_path`
-00011950: 2074 6f20 6064 7374 5f70 6174 6860 2e0a   to `dst_path`..
-00011960: 2020 2020 2020 2020 4974 2773 2063 616c          It's cal
-00011970: 6c65 7227 7320 7265 7370 6f6e 7365 6269  ler's responsebi
-00011980: 6c69 7479 2074 6f20 656e 7375 7265 2074  lity to ensure t
-00011990: 6865 2073 335f 6973 6669 6c65 2873 7263  he s3_isfile(src
-000119a0: 5f75 726c 2920 3d3d 2054 7275 650a 0a20  _url) == True.. 
-000119b0: 2020 2020 2020 203a 7061 7261 6d20 6473         :param ds
-000119c0: 745f 7061 7468 3a20 5461 7267 6574 2066  t_path: Target f
-000119d0: 696c 6520 7061 7468 0a20 2020 2020 2020  ile path.       
-000119e0: 203a 7061 7261 6d20 6361 6c6c 6261 636b   :param callback
-000119f0: 3a20 4361 6c6c 6564 2070 6572 696f 6469  : Called periodi
-00011a00: 6361 6c6c 7920 6475 7269 6e67 2063 6f70  cally during cop
-00011a10: 792c 2061 6e64 2074 6865 2069 6e70 7574  y, and the input
-00011a20: 2070 6172 616d 6574 6572 2069 7320 7468   parameter is th
-00011a30: 6520 6461 7461 2073 697a 6520 2869 6e20  e data size (in 
-00011a40: 6279 7465 7329 206f 6620 636f 7079 2073  bytes) of copy s
-00011a50: 696e 6365 2074 6865 206c 6173 7420 6361  ince the last ca
-00011a60: 6c6c 0a20 2020 2020 2020 2027 2727 0a20  ll.        '''. 
-00011a70: 2020 2020 2020 2073 7263 5f75 726c 203d         src_url =
-00011a80: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
-00011a90: 7072 6f74 6f63 6f6c 0a20 2020 2020 2020  protocol.       
-00011aa0: 2073 7263 5f62 7563 6b65 742c 2073 7263   src_bucket, src
-00011ab0: 5f6b 6579 203d 2070 6172 7365 5f73 335f  _key = parse_s3_
-00011ac0: 7572 6c28 7372 635f 7572 6c29 0a20 2020  url(src_url).   
-00011ad0: 2020 2020 2064 7374 5f62 7563 6b65 742c       dst_bucket,
-00011ae0: 2064 7374 5f6b 6579 203d 2070 6172 7365   dst_key = parse
-00011af0: 5f73 335f 7572 6c28 6473 745f 7572 6c29  _s3_url(dst_url)
-00011b00: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-00011b10: 2073 7263 5f62 7563 6b65 743a 0a20 2020   src_bucket:.   
-00011b20: 2020 2020 2020 2020 2072 6169 7365 2053           raise S
-00011b30: 3342 7563 6b65 744e 6f74 466f 756e 6445  3BucketNotFoundE
-00011b40: 7272 6f72 2827 456d 7074 7920 6275 636b  rror('Empty buck
-00011b50: 6574 206e 616d 653a 2025 7227 2025 2073  et name: %r' % s
-00011b60: 7263 5f75 726c 290a 2020 2020 2020 2020  rc_url).        
-00011b70: 6966 2073 656c 662e 6973 5f64 6972 2829  if self.is_dir()
-00011b80: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00011b90: 6973 6520 5333 4973 4144 6972 6563 746f  ise S3IsADirecto
-00011ba0: 7279 4572 726f 7228 2749 7320 6120 6469  ryError('Is a di
-00011bb0: 7265 6374 6f72 793a 2025 7227 2025 2073  rectory: %r' % s
-00011bc0: 7263 5f75 726c 290a 0a20 2020 2020 2020  rc_url)..       
-00011bd0: 2069 6620 6e6f 7420 6473 745f 6275 636b   if not dst_buck
-00011be0: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
-00011bf0: 7261 6973 6520 5333 4275 636b 6574 4e6f  raise S3BucketNo
-00011c00: 7446 6f75 6e64 4572 726f 7228 2745 6d70  tFoundError('Emp
-00011c10: 7479 2062 7563 6b65 7420 6e61 6d65 3a20  ty bucket name: 
-00011c20: 2572 2720 2520 6473 745f 7572 6c29 0a20  %r' % dst_url). 
-00011c30: 2020 2020 2020 2069 6620 6e6f 7420 6473         if not ds
-00011c40: 745f 6b65 7920 6f72 2064 7374 5f6b 6579  t_key or dst_key
-00011c50: 2e65 6e64 7377 6974 6828 272f 2729 3a0a  .endswith('/'):.
-00011c60: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00011c70: 6520 5333 4973 4144 6972 6563 746f 7279  e S3IsADirectory
-00011c80: 4572 726f 7228 2749 7320 6120 6469 7265  Error('Is a dire
-00011c90: 6374 6f72 793a 2025 7227 2025 2064 7374  ctory: %r' % dst
-00011ca0: 5f75 726c 290a 0a20 2020 2020 2020 2069  _url)..        i
-00011cb0: 6620 666f 6c6c 6f77 6c69 6e6b 733a 0a20  f followlinks:. 
-00011cc0: 2020 2020 2020 2020 2020 206d 6574 6164             metad
-00011cd0: 6174 6120 3d20 5f73 335f 6765 745f 6d65  ata = _s3_get_me
-00011ce0: 7461 6461 7461 2873 7263 5f75 726c 290a  tadata(src_url).
-00011cf0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
-00011d00: 6574 6164 6174 6120 616e 6420 2773 796d  etadata and 'sym
-00011d10: 6c69 6e6b 5f74 6f27 2069 6e20 6d65 7461  link_to' in meta
-00011d20: 6461 7461 3a0a 2020 2020 2020 2020 2020  data:.          
-00011d30: 2020 2020 2020 7372 635f 7572 6c20 3d20        src_url = 
-00011d40: 6d65 7461 6461 7461 5b27 7379 6d6c 696e  metadata['symlin
-00011d50: 6b5f 746f 275d 0a20 2020 2020 2020 2020  k_to'].         
-00011d60: 2020 2020 2020 2073 7263 5f62 7563 6b65         src_bucke
-00011d70: 742c 2073 7263 5f6b 6579 203d 2070 6172  t, src_key = par
-00011d80: 7365 5f73 335f 7572 6c28 7372 635f 7572  se_s3_url(src_ur
-00011d90: 6c29 0a0a 2020 2020 2020 2020 636c 6965  l)..        clie
-00011da0: 6e74 203d 2067 6574 5f73 335f 636c 6965  nt = get_s3_clie
-00011db0: 6e74 2829 0a20 2020 2020 2020 2074 7279  nt().        try
-00011dc0: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
-00011dd0: 6965 6e74 2e63 6f70 7928 0a20 2020 2020  ient.copy(.     
-00011de0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00011df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011e00: 2027 4275 636b 6574 273a 2073 7263 5f62   'Bucket': src_b
-00011e10: 7563 6b65 742c 0a20 2020 2020 2020 2020  ucket,.         
-00011e20: 2020 2020 2020 2020 2020 2027 4b65 7927             'Key'
-00011e30: 3a20 7372 635f 6b65 792c 0a20 2020 2020  : src_key,.     
-00011e40: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
-00011e50: 2020 2020 2020 2020 2020 2020 2020 4275                Bu
-00011e60: 636b 6574 3d64 7374 5f62 7563 6b65 742c  cket=dst_bucket,
-00011e70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011e80: 204b 6579 3d64 7374 5f6b 6579 2c0a 2020   Key=dst_key,.  
-00011e90: 2020 2020 2020 2020 2020 2020 2020 4361                Ca
-00011ea0: 6c6c 6261 636b 3d63 616c 6c62 6163 6b29  llback=callback)
-00011eb0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00011ec0: 4578 6365 7074 696f 6e20 6173 2065 7272  Exception as err
-00011ed0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-00011ee0: 6572 726f 7220 3d20 7472 616e 736c 6174  error = translat
-00011ef0: 655f 7333 5f65 7272 6f72 2865 7272 6f72  e_s3_error(error
-00011f00: 2c20 6473 745f 7572 6c29 0a20 2020 2020  , dst_url).     
-00011f10: 2020 2020 2020 2023 2045 7272 6f72 2063         # Error c
-00011f20: 616e 2774 2068 656c 7020 7465 6c6c 2077  an't help tell w
-00011f30: 6869 6368 2069 7320 7072 6f62 6c65 6d61  hich is problema
-00011f40: 7469 630a 2020 2020 2020 2020 2020 2020  tic.            
-00011f50: 6966 2069 7369 6e73 7461 6e63 6528 6572  if isinstance(er
-00011f60: 726f 722c 2053 3342 7563 6b65 744e 6f74  ror, S3BucketNot
-00011f70: 466f 756e 6445 7272 6f72 293a 0a20 2020  FoundError):.   
-00011f80: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00011f90: 6e6f 7420 7365 6c66 2e68 6173 6275 636b  not self.hasbuck
-00011fa0: 6574 2829 3a0a 2020 2020 2020 2020 2020  et():.          
-00011fb0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00011fc0: 5333 4275 636b 6574 4e6f 7446 6f75 6e64  S3BucketNotFound
-00011fd0: 4572 726f 7228 274e 6f20 7375 6368 2062  Error('No such b
-00011fe0: 7563 6b65 743a 2025 7227 2025 2073 7263  ucket: %r' % src
-00011ff0: 5f75 726c 290a 2020 2020 2020 2020 2020  _url).          
-00012000: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
-00012010: 6528 6572 726f 722c 2053 3346 696c 654e  e(error, S3FileN
-00012020: 6f74 466f 756e 6445 7272 6f72 293a 0a20  otFoundError):. 
-00012030: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00012040: 6620 6e6f 7420 7365 6c66 2e69 735f 6669  f not self.is_fi
-00012050: 6c65 2829 3a0a 2020 2020 2020 2020 2020  le():.          
-00012060: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00012070: 5333 4669 6c65 4e6f 7446 6f75 6e64 4572  S3FileNotFoundEr
-00012080: 726f 7228 274e 6f20 7375 6368 2066 696c  ror('No such fil
-00012090: 653a 2025 7227 2025 2073 7263 5f75 726c  e: %r' % src_url
-000120a0: 290a 2020 2020 2020 2020 2020 2020 7261  ).            ra
-000120b0: 6973 6520 6572 726f 720a 0a20 2020 2064  ise error..    d
-000120c0: 6566 2073 796e 6328 7365 6c66 2c20 6473  ef sync(self, ds
-000120d0: 745f 7572 6c3a 2050 6174 684c 696b 652c  t_url: PathLike,
-000120e0: 2066 6f6c 6c6f 776c 696e 6b73 3a20 626f   followlinks: bo
-000120f0: 6f6c 203d 2046 616c 7365 2920 2d3e 204e  ol = False) -> N
-00012100: 6f6e 653a 0a20 2020 2020 2020 2027 2727  one:.        '''
-00012110: 0a20 2020 2020 2020 2043 6f70 7920 6669  .        Copy fi
-00012120: 6c65 2f64 6972 6563 746f 7279 206f 6e20  le/directory on 
-00012130: 7372 635f 7572 6c20 746f 2064 7374 5f75  src_url to dst_u
-00012140: 726c 0a0a 2020 2020 2020 2020 3a70 6172  rl..        :par
-00012150: 616d 2064 7374 5f75 726c 3a20 4769 7665  am dst_url: Give
-00012160: 6e20 6465 7374 696e 6174 696f 6e20 7061  n destination pa
-00012170: 7468 0a20 2020 2020 2020 2027 2727 0a20  th.        '''. 
-00012180: 2020 2020 2020 2066 6f72 2073 7263 5f66         for src_f
-00012190: 696c 655f 7061 7468 2c20 6473 745f 6669  ile_path, dst_fi
-000121a0: 6c65 5f70 6174 6820 696e 205f 7333 5f73  le_path in _s3_s
-000121b0: 6361 6e5f 7061 6972 7328 0a20 2020 2020  can_pairs(.     
-000121c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000121d0: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
-000121e0: 6f6c 2c20 6473 745f 7572 6c29 3a0a 2020  ol, dst_url):.  
-000121f0: 2020 2020 2020 2020 2020 5333 5061 7468            S3Path
-00012200: 2873 7263 5f66 696c 655f 7061 7468 292e  (src_file_path).
-00012210: 636f 7079 2864 7374 5f66 696c 655f 7061  copy(dst_file_pa
-00012220: 7468 2c20 666f 6c6c 6f77 6c69 6e6b 733d  th, followlinks=
-00012230: 666f 6c6c 6f77 6c69 6e6b 7329 0a0a 2020  followlinks)..  
-00012240: 2020 6465 6620 7379 6d6c 696e 6b28 7365    def symlink(se
-00012250: 6c66 2c20 6473 745f 7061 7468 3a20 5061  lf, dst_path: Pa
-00012260: 7468 4c69 6b65 2920 2d3e 204e 6f6e 653a  thLike) -> None:
-00012270: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
-00012280: 2020 2020 2043 7265 6174 6520 6120 7379       Create a sy
-00012290: 6d62 6f6c 6963 206c 696e 6b20 706f 696e  mbolic link poin
-000122a0: 7469 6e67 2074 6f20 7372 635f 7061 7468  ting to src_path
-000122b0: 206e 616d 6564 2064 7374 5f70 6174 682e   named dst_path.
-000122c0: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-000122d0: 2064 7374 5f70 6174 683a 2044 6573 696e   dst_path: Desin
-000122e0: 6174 696f 6e20 7061 7468 0a20 2020 2020  ation path.     
-000122f0: 2020 203a 7261 6973 6573 3a20 5333 4e61     :raises: S3Na
-00012300: 6d65 546f 6f4c 6f6e 6745 7272 6f72 2c20  meTooLongError, 
-00012310: 5333 4275 636b 6574 4e6f 7446 6f75 6e64  S3BucketNotFound
-00012320: 4572 726f 722c 2053 3349 7341 4469 7265  Error, S3IsADire
-00012330: 6374 6f72 7945 7272 6f72 0a20 2020 2020  ctoryError.     
-00012340: 2020 2027 2727 0a20 2020 2020 2020 2073     '''.        s
-00012350: 7263 5f70 6174 6820 3d20 7365 6c66 2e70  rc_path = self.p
-00012360: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-00012370: 6c0a 2020 2020 2020 2020 6966 206c 656e  l.        if len
-00012380: 2873 7472 2873 7263 5f70 6174 6829 2e65  (str(src_path).e
-00012390: 6e63 6f64 6528 2929 203e 2031 3032 343a  ncode()) > 1024:
-000123a0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-000123b0: 7365 2053 334e 616d 6554 6f6f 4c6f 6e67  se S3NameTooLong
-000123c0: 4572 726f 7228 2746 696c 6520 6e61 6d65  Error('File name
-000123d0: 2074 6f6f 206c 6f6e 673a 2025 7227 2025   too long: %r' %
-000123e0: 2064 7374 5f70 6174 6829 0a20 2020 2020   dst_path).     
-000123f0: 2020 2073 7263 5f62 7563 6b65 742c 2073     src_bucket, s
-00012400: 7263 5f6b 6579 203d 2070 6172 7365 5f73  rc_key = parse_s
-00012410: 335f 7572 6c28 7372 635f 7061 7468 290a  3_url(src_path).
-00012420: 2020 2020 2020 2020 6473 745f 6275 636b          dst_buck
-00012430: 6574 2c20 6473 745f 6b65 7920 3d20 7061  et, dst_key = pa
-00012440: 7273 655f 7333 5f75 726c 2864 7374 5f70  rse_s3_url(dst_p
-00012450: 6174 6829 0a0a 2020 2020 2020 2020 6966  ath)..        if
-00012460: 206e 6f74 2073 7263 5f62 7563 6b65 743a   not src_bucket:
-00012470: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00012480: 7365 2053 3342 7563 6b65 744e 6f74 466f  se S3BucketNotFo
-00012490: 756e 6445 7272 6f72 2827 456d 7074 7920  undError('Empty 
-000124a0: 6275 636b 6574 206e 616d 653a 2025 7227  bucket name: %r'
-000124b0: 2025 2073 7263 5f70 6174 6829 0a20 2020   % src_path).   
-000124c0: 2020 2020 2069 6620 6e6f 7420 6473 745f       if not dst_
-000124d0: 6275 636b 6574 3a0a 2020 2020 2020 2020  bucket:.        
-000124e0: 2020 2020 7261 6973 6520 5333 4275 636b      raise S3Buck
-000124f0: 6574 4e6f 7446 6f75 6e64 4572 726f 7228  etNotFoundError(
-00012500: 2745 6d70 7479 2062 7563 6b65 7420 6e61  'Empty bucket na
-00012510: 6d65 3a20 2572 2720 2520 6473 745f 7061  me: %r' % dst_pa
-00012520: 7468 290a 2020 2020 2020 2020 6966 206e  th).        if n
-00012530: 6f74 2064 7374 5f6b 6579 206f 7220 6473  ot dst_key or ds
-00012540: 745f 6b65 792e 656e 6473 7769 7468 2827  t_key.endswith('
-00012550: 2f27 293a 0a20 2020 2020 2020 2020 2020  /'):.           
-00012560: 2072 6169 7365 2053 3349 7341 4469 7265   raise S3IsADire
-00012570: 6374 6f72 7945 7272 6f72 2827 4973 2061  ctoryError('Is a
-00012580: 2064 6972 6563 746f 7279 3a20 2572 2720   directory: %r' 
-00012590: 2520 6473 745f 7061 7468 290a 0a20 2020  % dst_path)..   
-000125a0: 2020 2020 206d 6574 6164 6174 6120 3d20       metadata = 
-000125b0: 5f73 335f 6765 745f 6d65 7461 6461 7461  _s3_get_metadata
-000125c0: 2873 7263 5f70 6174 6829 0a0a 2020 2020  (src_path)..    
-000125d0: 2020 2020 6966 2027 7379 6d6c 696e 6b5f      if 'symlink_
-000125e0: 746f 2720 696e 206d 6574 6164 6174 613a  to' in metadata:
-000125f0: 0a20 2020 2020 2020 2020 2020 2073 7263  .            src
-00012600: 5f70 6174 6820 3d20 6d65 7461 6461 7461  _path = metadata
-00012610: 5b27 7379 6d6c 696e 6b5f 746f 275d 0a20  ['symlink_to']. 
-00012620: 2020 2020 2020 2077 6974 6820 7261 6973         with rais
-00012630: 655f 7333 5f65 7272 6f72 2864 7374 5f70  e_s3_error(dst_p
-00012640: 6174 6829 3a0a 2020 2020 2020 2020 2020  ath):.          
-00012650: 2020 636c 6965 6e74 203d 2067 6574 5f73    client = get_s
-00012660: 335f 636c 6965 6e74 2829 0a20 2020 2020  3_client().     
-00012670: 2020 2020 2020 2063 6c69 656e 742e 7075         client.pu
-00012680: 745f 6f62 6a65 6374 280a 2020 2020 2020  t_object(.      
-00012690: 2020 2020 2020 2020 2020 4275 636b 6574            Bucket
-000126a0: 3d64 7374 5f62 7563 6b65 742c 0a20 2020  =dst_bucket,.   
-000126b0: 2020 2020 2020 2020 2020 2020 204b 6579               Key
-000126c0: 3d64 7374 5f6b 6579 2c0a 2020 2020 2020  =dst_key,.      
-000126d0: 2020 2020 2020 2020 2020 4d65 7461 6461            Metada
-000126e0: 7461 3d7b 2273 796d 6c69 6e6b 5f74 6f22  ta={"symlink_to"
-000126f0: 3a20 7372 635f 7061 7468 7d29 0a0a 2020  : src_path})..  
-00012700: 2020 6465 6620 7265 6164 6c69 6e6b 2873    def readlink(s
-00012710: 656c 6629 202d 3e20 2753 3350 6174 6827  elf) -> 'S3Path'
-00012720: 3a0a 2020 2020 2020 2020 2727 270a 2020  :.        '''.  
-00012730: 2020 2020 2020 5265 7475 726e 2061 2053        Return a S
-00012740: 3350 6174 6820 696e 7374 616e 6365 2072  3Path instance r
-00012750: 6570 7265 7365 6e74 696e 6720 7468 6520  epresenting the 
-00012760: 7061 7468 2074 6f20 7768 6963 6820 7468  path to which th
-00012770: 6520 7379 6d62 6f6c 6963 206c 696e 6b20  e symbolic link 
-00012780: 706f 696e 7473 2e0a 0a20 2020 2020 2020  points...       
-00012790: 203a 7265 7475 726e 733a 2052 6574 7572   :returns: Retur
-000127a0: 6e20 6120 5333 5061 7468 2069 6e73 7461  n a S3Path insta
-000127b0: 6e63 6520 7265 7072 6573 656e 7469 6e67  nce representing
-000127c0: 2074 6865 2070 6174 6820 746f 2077 6869   the path to whi
-000127d0: 6368 2074 6865 2073 796d 626f 6c69 6320  ch the symbolic 
-000127e0: 6c69 6e6b 2070 6f69 6e74 732e 0a20 2020  link points..   
-000127f0: 2020 2020 203a 7261 6973 6573 3a20 5333       :raises: S3
-00012800: 4e61 6d65 546f 6f4c 6f6e 6745 7272 6f72  NameTooLongError
-00012810: 2c20 5333 4275 636b 6574 4e6f 7446 6f75  , S3BucketNotFou
-00012820: 6e64 4572 726f 722c 2053 3349 7341 4469  ndError, S3IsADi
-00012830: 7265 6374 6f72 7945 7272 6f72 2c20 5333  rectoryError, S3
-00012840: 4e6f 7441 4c69 6e6b 4572 726f 720a 2020  NotALinkError.  
-00012850: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
-00012860: 2020 7265 7475 726e 2073 656c 662e 6672    return self.fr
-00012870: 6f6d 5f70 6174 6828 7333 5f72 6561 646c  om_path(s3_readl
-00012880: 696e 6b28 7365 6c66 2e70 6174 685f 7769  ink(self.path_wi
-00012890: 7468 5f70 726f 746f 636f 6c29 290a 0a20  th_protocol)).. 
-000128a0: 2020 2064 6566 2069 735f 7379 6d6c 696e     def is_symlin
-000128b0: 6b28 7365 6c66 2920 2d3e 2062 6f6f 6c3a  k(self) -> bool:
-000128c0: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
-000128d0: 2020 2020 2054 6573 7420 7768 6574 6865       Test whethe
-000128e0: 7220 6120 7061 7468 2069 7320 6c69 6e6b  r a path is link
-000128f0: 0a0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
-00012900: 6e73 3a20 5472 7565 2069 6620 6120 7061  ns: True if a pa
-00012910: 7468 2069 7320 6c69 6e6b 2c20 656c 7365  th is link, else
-00012920: 2046 616c 7365 0a20 2020 2020 2020 203a   False.        :
-00012930: 7261 6973 6573 3a20 5333 4e6f 7441 4c69  raises: S3NotALi
-00012940: 6e6b 4572 726f 720a 2020 2020 2020 2020  nkError.        
-00012950: 2727 270a 2020 2020 2020 2020 6275 636b  '''.        buck
-00012960: 6574 2c20 6b65 7920 3d20 7061 7273 655f  et, key = parse_
-00012970: 7333 5f75 726c 2873 656c 662e 7061 7468  s3_url(self.path
-00012980: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
-00012990: 2020 2020 2020 2020 6966 206e 6f74 2062          if not b
-000129a0: 7563 6b65 743a 0a20 2020 2020 2020 2020  ucket:.         
-000129b0: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
-000129c0: 2020 2020 2020 2020 6966 206e 6f74 206b          if not k
-000129d0: 6579 206f 7220 6b65 792e 656e 6473 7769  ey or key.endswi
-000129e0: 7468 2827 2f27 293a 0a20 2020 2020 2020  th('/'):.       
-000129f0: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
-00012a00: 650a 2020 2020 2020 2020 6d65 7461 6461  e.        metada
-00012a10: 7461 203d 205f 7333 5f67 6574 5f6d 6574  ta = _s3_get_met
-00012a20: 6164 6174 6128 7365 6c66 2e70 6174 685f  adata(self.path_
-00012a30: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
-00012a40: 2020 2020 2020 2072 6574 7572 6e20 2773         return 's
-00012a50: 796d 6c69 6e6b 5f74 6f27 2069 6e20 6d65  ymlink_to' in me
-00012a60: 7461 6461 7461 0a0a 2020 2020 6465 6620  tadata..    def 
-00012a70: 7361 7665 2873 656c 662c 2066 696c 655f  save(self, file_
-00012a80: 6f62 6a65 6374 3a20 4269 6e61 7279 494f  object: BinaryIO
-00012a90: 293a 0a20 2020 2020 2020 2027 2727 5772  ):.        '''Wr
-00012aa0: 6974 6520 7468 6520 6f70 656e 6564 2062  ite the opened b
-00012ab0: 696e 6172 7920 7374 7265 616d 2074 6f20  inary stream to 
-00012ac0: 7370 6563 6966 6965 6420 7061 7468 2c20  specified path, 
-00012ad0: 6275 7420 7468 6520 7374 7265 616d 2077  but the stream w
-00012ae0: 6f6e 2774 2062 6520 636c 6f73 6564 0a0a  on't be closed..
-00012af0: 2020 2020 2020 2020 3a70 6172 616d 2066          :param f
-00012b00: 696c 655f 6f62 6a65 6374 3a20 5374 7265  ile_object: Stre
-00012b10: 616d 2074 6f20 6265 2072 6561 640a 2020  am to be read.  
-00012b20: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
-00012b30: 2020 6275 636b 6574 2c20 6b65 7920 3d20    bucket, key = 
-00012b40: 7061 7273 655f 7333 5f75 726c 2873 656c  parse_s3_url(sel
-00012b50: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
-00012b60: 6f63 6f6c 290a 2020 2020 2020 2020 6966  ocol).        if
-00012b70: 206e 6f74 2062 7563 6b65 743a 0a20 2020   not bucket:.   
-00012b80: 2020 2020 2020 2020 2072 6169 7365 2053           raise S
-00012b90: 3342 7563 6b65 744e 6f74 466f 756e 6445  3BucketNotFoundE
-00012ba0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00012bb0: 2020 2020 2020 2745 6d70 7479 2062 7563        'Empty buc
-00012bc0: 6b65 7420 6e61 6d65 3a20 2572 2720 2520  ket name: %r' % 
-00012bd0: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
-00012be0: 726f 746f 636f 6c29 0a20 2020 2020 2020  rotocol).       
-00012bf0: 2069 6620 6e6f 7420 6b65 7920 6f72 206b   if not key or k
-00012c00: 6579 2e65 6e64 7377 6974 6828 272f 2729  ey.endswith('/')
-00012c10: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00012c20: 6973 6520 5333 4973 4144 6972 6563 746f  ise S3IsADirecto
-00012c30: 7279 4572 726f 7228 0a20 2020 2020 2020  ryError(.       
-00012c40: 2020 2020 2020 2020 2027 4973 2061 2064           'Is a d
-00012c50: 6972 6563 746f 7279 3a20 2572 2720 2520  irectory: %r' % 
-00012c60: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
-00012c70: 726f 746f 636f 6c29 0a0a 2020 2020 2020  rotocol)..      
-00012c80: 2020 636c 6965 6e74 203d 2067 6574 5f73    client = get_s
-00012c90: 335f 636c 6965 6e74 2829 0a20 2020 2020  3_client().     
-00012ca0: 2020 2077 6974 6820 7261 6973 655f 7333     with raise_s3
-00012cb0: 5f65 7272 6f72 2873 656c 662e 7061 7468  _error(self.path
-00012cc0: 5f77 6974 685f 7072 6f74 6f63 6f6c 293a  _with_protocol):
-00012cd0: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
-00012ce0: 656e 742e 7570 6c6f 6164 5f66 696c 656f  ent.upload_fileo
-00012cf0: 626a 2866 696c 655f 6f62 6a65 6374 2c20  bj(file_object, 
-00012d00: 4275 636b 6574 3d62 7563 6b65 742c 204b  Bucket=bucket, K
-00012d10: 6579 3d6b 6579 290a 0a20 2020 2064 6566  ey=key)..    def
-00012d20: 206f 7065 6e28 0a20 2020 2020 2020 2020   open(.         
-00012d30: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00012d40: 2020 2020 206d 6f64 653a 2073 7472 203d       mode: str =
-00012d50: 2027 7227 2c0a 2020 2020 2020 2020 2020   'r',.          
-00012d60: 2020 2a2c 0a20 2020 2020 2020 2020 2020    *,.           
-00012d70: 2073 335f 6f70 656e 5f66 756e 633a 2043   s3_open_func: C
-00012d80: 616c 6c61 626c 655b 5b73 7472 2c20 7374  allable[[str, st
-00012d90: 725d 2c20 4269 6e61 7279 494f 5d20 3d20  r], BinaryIO] = 
-00012da0: 7333 5f6f 7065 6e2c 0a20 2020 2020 2020  s3_open,.       
-00012db0: 2020 2020 202a 2a6b 7761 7267 7329 202d       **kwargs) -
-00012dc0: 3e20 494f 5b41 6e79 5374 725d 3a0a 2020  > IO[AnyStr]:.  
-00012dd0: 2020 2020 2020 7265 7475 726e 2073 335f        return s3_
-00012de0: 6f70 656e 5f66 756e 6328 0a20 2020 2020  open_func(.     
-00012df0: 2020 2020 2020 2073 656c 662e 7061 7468         self.path
-00012e00: 5f77 6974 685f 7072 6f74 6f63 6f6c 2c20  _with_protocol, 
-00012e10: 6d6f 6465 2c0a 2020 2020 2020 2020 2020  mode,.          
-00012e20: 2020 2a2a 6e65 6365 7373 6172 795f 7061    **necessary_pa
-00012e30: 7261 6d73 2873 335f 6f70 656e 5f66 756e  rams(s3_open_fun
-00012e40: 632c 202a 2a6b 7761 7267 7329 290a 0a20  c, **kwargs)).. 
-00012e50: 2020 2064 6566 2061 6273 6f6c 7574 6528     def absolute(
-00012e60: 7365 6c66 2920 2d3e 2027 5333 5061 7468  self) -> 'S3Path
-00012e70: 273a 0a20 2020 2020 2020 2027 2727 0a20  ':.        '''. 
-00012e80: 2020 2020 2020 204d 616b 6520 7468 6520         Make the 
-00012e90: 7061 7468 2061 6273 6f6c 7574 652c 2077  path absolute, w
-00012ea0: 6974 686f 7574 206e 6f72 6d61 6c69 7a61  ithout normaliza
-00012eb0: 7469 6f6e 206f 7220 7265 736f 6c76 696e  tion or resolvin
-00012ec0: 6720 7379 6d6c 696e 6b73 2e20 5265 7475  g symlinks. Retu
-00012ed0: 726e 7320 6120 6e65 7720 7061 7468 206f  rns a new path o
-00012ee0: 626a 6563 740a 2020 2020 2020 2020 2727  bject.        ''
-00012ef0: 270a 2020 2020 2020 2020 7265 7475 726e  '.        return
-00012f00: 2073 656c 660a 0a20 2020 2064 6566 2063   self..    def c
-00012f10: 7764 2873 656c 6629 202d 3e20 2753 3350  wd(self) -> 'S3P
-00012f20: 6174 6827 3a0a 2020 2020 2020 2020 2727  ath':.        ''
-00012f30: 2752 6574 7572 6e20 6375 7272 656e 7420  'Return current 
-00012f40: 776f 726b 696e 6720 6469 7265 6374 6f72  working director
-00012f50: 790a 0a20 2020 2020 2020 2072 6574 7572  y..        retur
-00012f60: 6e73 3a20 4375 7272 656e 7420 776f 726b  ns: Current work
-00012f70: 696e 6720 6469 7265 6374 6f72 790a 2020  ing directory.  
-00012f80: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
-00012f90: 2020 7265 7475 726e 2073 656c 662e 6672    return self.fr
-00012fa0: 6f6d 5f70 6174 6828 7365 6c66 2e70 6174  om_path(self.pat
-00012fb0: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-00012fc0: 0a                                       .
+0000e0a0: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
+0000e0b0: 726f 746f 636f 6c2c 2064 7374 5f75 726c  rotocol, dst_url
+0000e0c0: 293a 0a20 2020 2020 2020 2020 2020 2053  ):.            S
+0000e0d0: 3350 6174 6828 7372 635f 6669 6c65 5f70  3Path(src_file_p
+0000e0e0: 6174 6829 2e72 656e 616d 6528 6473 745f  ath).rename(dst_
+0000e0f0: 6669 6c65 5f70 6174 6829 0a0a 2020 2020  file_path)..    
+0000e100: 6465 6620 7265 6d6f 7665 2873 656c 662c  def remove(self,
+0000e110: 206d 6973 7369 6e67 5f6f 6b3a 2062 6f6f   missing_ok: boo
+0000e120: 6c20 3d20 4661 6c73 6529 202d 3e20 4e6f  l = False) -> No
+0000e130: 6e65 3a0a 2020 2020 2020 2020 2727 270a  ne:.        '''.
+0000e140: 2020 2020 2020 2020 5265 6d6f 7665 2074          Remove t
+0000e150: 6865 2066 696c 6520 6f72 2064 6972 6563  he file or direc
+0000e160: 746f 7279 206f 6e20 7333 2c20 6073 333a  tory on s3, `s3:
+0000e170: 2f2f 6020 616e 6420 6073 333a 2f2f 6275  //` and `s3://bu
+0000e180: 636b 6574 6020 6172 6520 6e6f 7420 7065  cket` are not pe
+0000e190: 726d 6974 7465 6420 746f 2072 656d 6f76  rmitted to remov
+0000e1a0: 650a 0a20 2020 2020 2020 203a 7061 7261  e..        :para
+0000e1b0: 6d20 6d69 7373 696e 675f 6f6b 3a20 6966  m missing_ok: if
+0000e1c0: 2046 616c 7365 2061 6e64 2074 6172 6765   False and targe
+0000e1d0: 7420 6669 6c65 2f64 6972 6563 746f 7279  t file/directory
+0000e1e0: 206e 6f74 2065 7869 7374 732c 2072 6169   not exists, rai
+0000e1f0: 7365 2053 3346 696c 654e 6f74 466f 756e  se S3FileNotFoun
+0000e200: 6445 7272 6f72 0a20 2020 2020 2020 203a  dError.        :
+0000e210: 7261 6973 6573 3a20 5333 5065 726d 6973  raises: S3Permis
+0000e220: 7369 6f6e 4572 726f 722c 2053 3346 696c  sionError, S3Fil
+0000e230: 654e 6f74 466f 756e 6445 7272 6f72 2c20  eNotFoundError, 
+0000e240: 556e 7375 7070 6f72 7465 6445 7272 6f72  UnsupportedError
+0000e250: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
+0000e260: 2020 2020 2062 7563 6b65 742c 206b 6579       bucket, key
+0000e270: 203d 2070 6172 7365 5f73 335f 7572 6c28   = parse_s3_url(
+0000e280: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
+0000e290: 726f 746f 636f 6c29 0a20 2020 2020 2020  rotocol).       
+0000e2a0: 2069 6620 6e6f 7420 6275 636b 6574 3a0a   if not bucket:.
+0000e2b0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0000e2c0: 6f74 206b 6579 3a0a 2020 2020 2020 2020  ot key:.        
+0000e2d0: 2020 2020 2020 2020 7261 6973 6520 556e          raise Un
+0000e2e0: 7375 7070 6f72 7465 6445 7272 6f72 280a  supportedError(.
+0000e2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e300: 2020 2020 2752 656d 6f76 6520 7768 6f6c      'Remove whol
+0000e310: 6520 7333 272c 2073 656c 662e 7061 7468  e s3', self.path
+0000e320: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
+0000e330: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000e340: 6520 5333 4275 636b 6574 4e6f 7446 6f75  e S3BucketNotFou
+0000e350: 6e64 4572 726f 7228 0a20 2020 2020 2020  ndError(.       
+0000e360: 2020 2020 2020 2020 2027 456d 7074 7920           'Empty 
+0000e370: 6275 636b 6574 206e 616d 653a 2025 7227  bucket name: %r'
+0000e380: 2025 2073 656c 662e 7061 7468 5f77 6974   % self.path_wit
+0000e390: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
+0000e3a0: 2020 2020 6966 206e 6f74 206b 6579 3a0a      if not key:.
+0000e3b0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000e3c0: 6520 556e 7375 7070 6f72 7465 6445 7272  e UnsupportedErr
+0000e3d0: 6f72 2827 5265 6d6f 7665 2062 7563 6b65  or('Remove bucke
+0000e3e0: 7427 2c20 7365 6c66 2e70 6174 685f 7769  t', self.path_wi
+0000e3f0: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
+0000e400: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+0000e410: 2e65 7869 7374 7328 293a 0a20 2020 2020  .exists():.     
+0000e420: 2020 2020 2020 2069 6620 6d69 7373 696e         if missin
+0000e430: 675f 6f6b 3a0a 2020 2020 2020 2020 2020  g_ok:.          
+0000e440: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+0000e450: 2020 2020 2020 2020 2072 6169 7365 2053           raise S
+0000e460: 3346 696c 654e 6f74 466f 756e 6445 7272  3FileNotFoundErr
+0000e470: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+0000e480: 2020 2020 274e 6f20 7375 6368 2066 696c      'No such fil
+0000e490: 6520 6f72 2064 6972 6563 746f 7279 3a20  e or directory: 
+0000e4a0: 2572 2720 2520 7365 6c66 2e70 6174 685f  %r' % self.path_
+0000e4b0: 7769 7468 5f70 726f 746f 636f 6c29 0a0a  with_protocol)..
+0000e4c0: 2020 2020 2020 2020 636c 6965 6e74 203d          client =
+0000e4d0: 2073 656c 662e 5f63 6c69 656e 740a 2020   self._client.  
+0000e4e0: 2020 2020 2020 7769 7468 2072 6169 7365        with raise
+0000e4f0: 5f73 335f 6572 726f 7228 7365 6c66 2e70  _s3_error(self.p
+0000e500: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+0000e510: 6c29 3a0a 2020 2020 2020 2020 2020 2020  l):.            
+0000e520: 6966 2073 656c 662e 6973 5f66 696c 6528  if self.is_file(
+0000e530: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000e540: 2020 2063 6c69 656e 742e 6465 6c65 7465     client.delete
+0000e550: 5f6f 626a 6563 7428 4275 636b 6574 3d62  _object(Bucket=b
+0000e560: 7563 6b65 742c 204b 6579 3d6b 6579 290a  ucket, Key=key).
+0000e570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e580: 7265 7475 726e 0a20 2020 2020 2020 2020  return.         
+0000e590: 2020 2070 7265 6669 7820 3d20 5f62 6563     prefix = _bec
+0000e5a0: 6f6d 655f 7072 6566 6978 286b 6579 290a  ome_prefix(key).
+0000e5b0: 2020 2020 2020 2020 2020 2020 746f 7461              tota
+0000e5c0: 6c5f 636f 756e 742c 2065 7272 6f72 5f63  l_count, error_c
+0000e5d0: 6f75 6e74 203d 2030 2c20 300a 2020 2020  ount = 0, 0.    
+0000e5e0: 2020 2020 2020 2020 666f 7220 7265 7370          for resp
+0000e5f0: 2069 6e20 5f6c 6973 745f 6f62 6a65 6374   in _list_object
+0000e600: 735f 7265 6375 7273 6976 6528 636c 6965  s_recursive(clie
+0000e610: 6e74 2c20 6275 636b 6574 2c20 7072 6566  nt, bucket, pref
+0000e620: 6978 293a 0a20 2020 2020 2020 2020 2020  ix):.           
+0000e630: 2020 2020 2069 6620 2743 6f6e 7465 6e74       if 'Content
+0000e640: 7327 2069 6e20 7265 7370 3a0a 2020 2020  s' in resp:.    
+0000e650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e660: 6b65 7973 203d 205b 0a20 2020 2020 2020  keys = [.       
+0000e670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e680: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0000e690: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0000e6a0: 4b65 7927 3a20 636f 6e74 656e 745b 274b  Key': content['K
+0000e6b0: 6579 275d 0a20 2020 2020 2020 2020 2020  ey'].           
+0000e6c0: 2020 2020 2020 2020 2020 2020 207d 2066               } f
+0000e6d0: 6f72 2063 6f6e 7465 6e74 2069 6e20 7265  or content in re
+0000e6e0: 7370 5b27 436f 6e74 656e 7473 275d 0a20  sp['Contents']. 
+0000e6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e700: 2020 205d 0a20 2020 2020 2020 2020 2020     ].           
+0000e710: 2020 2020 2020 2020 2074 6f74 616c 5f63           total_c
+0000e720: 6f75 6e74 202b 3d20 6c65 6e28 6b65 7973  ount += len(keys
+0000e730: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000e740: 2020 2020 2020 6572 726f 7273 203d 205b        errors = [
+0000e750: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0000e760: 2020 2020 2020 7265 7472 6965 7320 3d20        retries = 
+0000e770: 320a 2020 2020 2020 2020 2020 2020 2020  2.              
+0000e780: 2020 2020 2020 7265 7472 795f 696e 7465        retry_inte
+0000e790: 7276 616c 203d 206d 696e 2830 2e31 202a  rval = min(0.1 *
+0000e7a0: 2032 2a2a 7265 7472 6965 732c 2033 3029   2**retries, 30)
+0000e7b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e7c0: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
+0000e7d0: 6e67 6528 7265 7472 6965 7329 3a0a 2020  nge(retries):.  
+0000e7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e7f0: 2020 2020 2020 2320 646f 633a 2068 7474        # doc: htt
+0000e800: 7073 3a2f 2f62 6f74 6f33 2e61 6d61 7a6f  ps://boto3.amazo
+0000e810: 6e61 7773 2e63 6f6d 2f76 312f 646f 6375  naws.com/v1/docu
+0000e820: 6d65 6e74 6174 696f 6e2f 6170 692f 6c61  mentation/api/la
+0000e830: 7465 7374 2f72 6566 6572 656e 6365 2f73  test/reference/s
+0000e840: 6572 7669 6365 732f 7333 2e68 746d 6c23  ervices/s3.html#
+0000e850: 5333 2e43 6c69 656e 742e 6465 6c65 7465  S3.Client.delete
+0000e860: 5f6f 626a 6563 7473 0a20 2020 2020 2020  _objects.       
+0000e870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e880: 2069 6620 6e6f 7420 6b65 7973 3a0a 2020   if not keys:.  
+0000e890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e8a0: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
+0000e8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e8c0: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+0000e8d0: 203d 2063 6c69 656e 742e 6465 6c65 7465   = client.delete
+0000e8e0: 5f6f 626a 6563 7473 280a 2020 2020 2020  _objects(.      
+0000e8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e900: 2020 2020 2020 4275 636b 6574 3d62 7563        Bucket=buc
+0000e910: 6b65 742c 2044 656c 6574 653d 7b27 4f62  ket, Delete={'Ob
+0000e920: 6a65 6374 7327 3a20 6b65 7973 7d29 0a20  jects': keys}). 
+0000e930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e940: 2020 2020 2020 206b 6579 7320 3d20 5b5d         keys = []
+0000e950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e960: 2020 2020 2020 2020 2066 6f72 2065 7272           for err
+0000e970: 6f72 5f69 6e66 6f20 696e 2072 6573 706f  or_info in respo
+0000e980: 6e73 652e 6765 7428 2745 7272 6f72 7327  nse.get('Errors'
+0000e990: 2c20 5b5d 293a 0a20 2020 2020 2020 2020  , []):.         
+0000e9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e9b0: 2020 2069 6620 7333 5f65 7272 6f72 5f63     if s3_error_c
+0000e9c0: 6f64 655f 7368 6f75 6c64 5f72 6574 7279  ode_should_retry
+0000e9d0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000e9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e9f0: 2020 2020 2020 6572 726f 725f 696e 666f        error_info
+0000ea00: 2e67 6574 2827 436f 6465 2729 293a 0a20  .get('Code')):. 
+0000ea10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea20: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0000ea30: 7272 6f72 5f6c 6f67 6765 722e 7761 726e  rror_logger.warn
+0000ea40: 696e 6728 0a20 2020 2020 2020 2020 2020  ing(.           
+0000ea50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea60: 2020 2020 2020 2020 2022 7265 7472 7920           "retry 
+0000ea70: 2573 2074 696d 6573 2c20 7265 6d6f 7669  %s times, removi
+0000ea80: 6e67 2066 696c 653a 2025 732c 2077 6974  ng file: %s, wit
+0000ea90: 6820 6572 726f 7220 2573 3a20 2573 220a  h error %s: %s".
+0000eaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eac0: 2020 2020 2520 280a 2020 2020 2020 2020      % (.        
+0000ead0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eaf0: 6920 2b20 312c 2065 7272 6f72 5f69 6e66  i + 1, error_inf
+0000eb00: 6f5b 274b 6579 275d 2c0a 2020 2020 2020  o['Key'],.      
+0000eb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb30: 2020 6572 726f 725f 696e 666f 5b27 436f    error_info['Co
+0000eb40: 6465 275d 2c0a 2020 2020 2020 2020 2020  de'],.          
+0000eb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb60: 2020 2020 2020 2020 2020 2020 2020 6572                er
+0000eb70: 726f 725f 696e 666f 5b27 4d65 7373 6167  ror_info['Messag
+0000eb80: 6527 5d29 290a 2020 2020 2020 2020 2020  e'])).          
+0000eb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eba0: 2020 2020 2020 6b65 7973 2e61 7070 656e        keys.appen
+0000ebb0: 6428 7b27 4b65 7927 3a20 6572 726f 725f  d({'Key': error_
+0000ebc0: 696e 666f 5b27 4b65 7927 5d7d 290a 2020  info['Key']}).  
+0000ebd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ebe0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0000ebf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec10: 6572 726f 7273 2e61 7070 656e 6428 6572  errors.append(er
+0000ec20: 726f 725f 696e 666f 290a 2020 2020 2020  ror_info).      
+0000ec30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec40: 2020 7469 6d65 2e73 6c65 6570 2872 6574    time.sleep(ret
+0000ec50: 7279 5f69 6e74 6572 7661 6c29 0a20 2020  ry_interval).   
+0000ec60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec70: 2066 6f72 2065 7272 6f72 5f69 6e66 6f20   for error_info 
+0000ec80: 696e 2065 7272 6f72 733a 0a20 2020 2020  in errors:.     
+0000ec90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eca0: 2020 2065 7272 6f72 5f6c 6f67 6765 722e     error_logger.
+0000ecb0: 6572 726f 7228 0a20 2020 2020 2020 2020  error(.         
+0000ecc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ecd0: 2020 2022 6661 696c 6564 2072 656d 6f76     "failed remov
+0000ece0: 6520 6669 6c65 3a20 2573 2c20 7769 7468  e file: %s, with
+0000ecf0: 2065 7272 6f72 2025 733a 2025 7322 2025   error %s: %s" %
+0000ed00: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+0000ed10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ed20: 2020 2065 7272 6f72 5f69 6e66 6f5b 274b     error_info['K
+0000ed30: 6579 275d 2c20 6572 726f 725f 696e 666f  ey'], error_info
+0000ed40: 5b27 436f 6465 275d 2c0a 2020 2020 2020  ['Code'],.      
+0000ed50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ed60: 2020 2020 2020 2020 2020 6572 726f 725f            error_
+0000ed70: 696e 666f 5b27 4d65 7373 6167 6527 5d29  info['Message'])
+0000ed80: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000ed90: 2020 2020 2020 6572 726f 725f 636f 756e        error_coun
+0000eda0: 7420 2b3d 206c 656e 2865 7272 6f72 7329  t += len(errors)
+0000edb0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000edc0: 6572 726f 725f 636f 756e 7420 3e20 303a  error_count > 0:
+0000edd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ede0: 2065 7272 6f72 5f6d 7367 203d 2022 6661   error_msg = "fa
+0000edf0: 696c 6564 2072 656d 6f76 6520 7061 7468  iled remove path
+0000ee00: 3a20 2573 2c20 746f 7461 6c20 6669 6c65  : %s, total file
+0000ee10: 2063 6f75 6e74 3a20 2573 2c20 6661 696c   count: %s, fail
+0000ee20: 6564 2063 6f75 6e74 3a20 2573 2220 2520  ed count: %s" % 
+0000ee30: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000ee40: 2020 2020 2020 7365 6c66 2e70 6174 685f        self.path_
+0000ee50: 7769 7468 5f70 726f 746f 636f 6c2c 2074  with_protocol, t
+0000ee60: 6f74 616c 5f63 6f75 6e74 2c20 6572 726f  otal_count, erro
+0000ee70: 725f 636f 756e 7429 0a20 2020 2020 2020  r_count).       
+0000ee80: 2020 2020 2020 2020 2072 6169 7365 2053           raise S
+0000ee90: 3355 6e6b 6e6f 776e 4572 726f 7228 0a20  3UnknownError(. 
+0000eea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eeb0: 2020 2045 7863 6570 7469 6f6e 2865 7272     Exception(err
+0000eec0: 6f72 5f6d 7367 292c 2073 656c 662e 7061  or_msg), self.pa
+0000eed0: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
+0000eee0: 290a 0a20 2020 2064 6566 2072 656e 616d  )..    def renam
+0000eef0: 6528 7365 6c66 2c20 6473 745f 7061 7468  e(self, dst_path
+0000ef00: 3a20 5061 7468 4c69 6b65 2920 2d3e 2027  : PathLike) -> '
+0000ef10: 5333 5061 7468 273a 0a20 2020 2020 2020  S3Path':.       
+0000ef20: 2027 2727 0a20 2020 2020 2020 204d 6f76   '''.        Mov
+0000ef30: 6520 7333 2066 696c 6520 7061 7468 2066  e s3 file path f
+0000ef40: 726f 6d20 7372 635f 7572 6c20 746f 2064  rom src_url to d
+0000ef50: 7374 5f75 726c 0a0a 2020 2020 2020 2020  st_url..        
+0000ef60: 3a70 6172 616d 2064 7374 5f70 6174 683a  :param dst_path:
+0000ef70: 2047 6976 656e 2064 6573 7469 6e61 7469   Given destinati
+0000ef80: 6f6e 2070 6174 680a 2020 2020 2020 2020  on path.        
+0000ef90: 2727 270a 2020 2020 2020 2020 7333 5f72  '''.        s3_r
+0000efa0: 656e 616d 6528 7365 6c66 2e70 6174 685f  ename(self.path_
+0000efb0: 7769 7468 5f70 726f 746f 636f 6c2c 2064  with_protocol, d
+0000efc0: 7374 5f70 6174 6829 0a20 2020 2020 2020  st_path).       
+0000efd0: 2072 6574 7572 6e20 7365 6c66 2e66 726f   return self.fro
+0000efe0: 6d5f 7061 7468 2864 7374 5f70 6174 6829  m_path(dst_path)
+0000eff0: 0a0a 2020 2020 6465 6620 7363 616e 2873  ..    def scan(s
+0000f000: 656c 662c 206d 6973 7369 6e67 5f6f 6b3a  elf, missing_ok:
+0000f010: 2062 6f6f 6c20 3d20 5472 7565 2c0a 2020   bool = True,.  
+0000f020: 2020 2020 2020 2020 2020 2066 6f6c 6c6f             follo
+0000f030: 776c 696e 6b73 3a20 626f 6f6c 203d 2046  wlinks: bool = F
+0000f040: 616c 7365 2920 2d3e 2049 7465 7261 746f  alse) -> Iterato
+0000f050: 725b 7374 725d 3a0a 2020 2020 2020 2020  r[str]:.        
+0000f060: 2727 270a 2020 2020 2020 2020 4974 6572  '''.        Iter
+0000f070: 6174 6976 656c 7920 7472 6176 6572 7365  atively traverse
+0000f080: 206f 6e6c 7920 6669 6c65 7320 696e 2067   only files in g
+0000f090: 6976 656e 2073 3320 6469 7265 6374 6f72  iven s3 director
+0000f0a0: 792c 2069 6e20 616c 7068 6162 6574 6963  y, in alphabetic
+0000f0b0: 616c 206f 7264 6572 2e0a 2020 2020 2020  al order..      
+0000f0c0: 2020 4576 6572 7920 6974 6572 6174 696f    Every iteratio
+0000f0d0: 6e20 6f6e 2067 656e 6572 6174 6f72 2079  n on generator y
+0000f0e0: 6965 6c64 7320 6120 7061 7468 2073 7472  ields a path str
+0000f0f0: 696e 672e 0a0a 2020 2020 2020 2020 4966  ing...        If
+0000f100: 2073 335f 7572 6c20 6973 2061 2066 696c   s3_url is a fil
+0000f110: 6520 7061 7468 2c20 7969 656c 6473 2074  e path, yields t
+0000f120: 6865 2066 696c 6520 6f6e 6c79 0a20 2020  he file only.   
+0000f130: 2020 2020 2049 6620 7333 5f75 726c 2069       If s3_url i
+0000f140: 7320 6120 6e6f 6e2d 6578 6973 7465 6e74  s a non-existent
+0000f150: 2070 6174 682c 2072 6574 7572 6e20 616e   path, return an
+0000f160: 2065 6d70 7479 2067 656e 6572 6174 6f72   empty generator
+0000f170: 0a20 2020 2020 2020 2049 6620 7333 5f75  .        If s3_u
+0000f180: 726c 2069 7320 6120 6275 636b 6574 2070  rl is a bucket p
+0000f190: 6174 682c 2072 6574 7572 6e20 616c 6c20  ath, return all 
+0000f1a0: 6669 6c65 2070 6174 6873 2069 6e20 7468  file paths in th
+0000f1b0: 6520 6275 636b 6574 0a20 2020 2020 2020  e bucket.       
+0000f1c0: 2049 6620 7333 5f75 726c 2069 7320 616e   If s3_url is an
+0000f1d0: 2065 6d70 7479 2062 7563 6b65 742c 2072   empty bucket, r
+0000f1e0: 6574 7572 6e20 616e 2065 6d70 7479 2067  eturn an empty g
+0000f1f0: 656e 6572 6174 6f72 0a20 2020 2020 2020  enerator.       
+0000f200: 2049 6620 7333 5f75 726c 2064 6f65 736e   If s3_url doesn
+0000f210: 2774 2063 6f6e 7461 696e 2061 6e79 2062  't contain any b
+0000f220: 7563 6b65 742c 2077 6869 6368 2069 7320  ucket, which is 
+0000f230: 7333 5f75 726c 203d 3d20 2773 333a 2f2f  s3_url == 's3://
+0000f240: 272c 2072 6169 7365 2055 6e73 7570 706f  ', raise Unsuppo
+0000f250: 7274 6564 4572 726f 722e 2077 616c 6b28  rtedError. walk(
+0000f260: 2920 6f6e 2063 6f6d 706c 6574 6520 7333  ) on complete s3
+0000f270: 2069 7320 6e6f 7420 7375 7070 6f72 7465   is not supporte
+0000f280: 6420 696e 206d 6567 6669 6c65 0a0a 2020  d in megfile..  
+0000f290: 2020 2020 2020 3a70 6172 616d 206d 6973        :param mis
+0000f2a0: 7369 6e67 5f6f 6b3a 2049 6620 4661 6c73  sing_ok: If Fals
+0000f2b0: 6520 616e 6420 7468 6572 6527 7320 6e6f  e and there's no
+0000f2c0: 2066 696c 6520 696e 2074 6865 2064 6972   file in the dir
+0000f2d0: 6563 746f 7279 2c20 7261 6973 6520 4669  ectory, raise Fi
+0000f2e0: 6c65 4e6f 7446 6f75 6e64 4572 726f 720a  leNotFoundError.
+0000f2f0: 2020 2020 2020 2020 3a72 6169 7365 733a          :raises:
+0000f300: 2055 6e73 7570 706f 7274 6564 4572 726f   UnsupportedErro
+0000f310: 720a 2020 2020 2020 2020 3a72 6574 7572  r.        :retur
+0000f320: 6e73 3a20 4120 6669 6c65 2070 6174 6820  ns: A file path 
+0000f330: 6765 6e65 7261 746f 720a 2020 2020 2020  generator.      
+0000f340: 2020 2727 270a 2020 2020 2020 2020 7363    '''.        sc
+0000f350: 616e 5f73 7461 745f 6974 6572 203d 2073  an_stat_iter = s
+0000f360: 656c 662e 7363 616e 5f73 7461 7428 0a20  elf.scan_stat(. 
+0000f370: 2020 2020 2020 2020 2020 206d 6973 7369             missi
+0000f380: 6e67 5f6f 6b3d 6d69 7373 696e 675f 6f6b  ng_ok=missing_ok
+0000f390: 2c20 666f 6c6c 6f77 6c69 6e6b 733d 666f  , followlinks=fo
+0000f3a0: 6c6c 6f77 6c69 6e6b 7329 0a0a 2020 2020  llowlinks)..    
+0000f3b0: 2020 2020 6465 6620 6372 6561 7465 5f67      def create_g
+0000f3c0: 656e 6572 6174 6f72 2829 202d 3e20 4974  enerator() -> It
+0000f3d0: 6572 6174 6f72 5b73 7472 5d3a 0a20 2020  erator[str]:.   
+0000f3e0: 2020 2020 2020 2020 2066 6f72 2066 696c           for fil
+0000f3f0: 655f 656e 7472 7920 696e 2073 6361 6e5f  e_entry in scan_
+0000f400: 7374 6174 5f69 7465 723a 0a20 2020 2020  stat_iter:.     
+0000f410: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
+0000f420: 2066 696c 655f 656e 7472 792e 7061 7468   file_entry.path
+0000f430: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0000f440: 2063 7265 6174 655f 6765 6e65 7261 746f   create_generato
+0000f450: 7228 290a 0a20 2020 2064 6566 2073 6361  r()..    def sca
+0000f460: 6e5f 7374 6174 2873 656c 662c 206d 6973  n_stat(self, mis
+0000f470: 7369 6e67 5f6f 6b3a 2062 6f6f 6c20 3d20  sing_ok: bool = 
+0000f480: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+0000f490: 2020 2020 2020 2020 666f 6c6c 6f77 6c69          followli
+0000f4a0: 6e6b 733a 2062 6f6f 6c20 3d20 4661 6c73  nks: bool = Fals
+0000f4b0: 6529 202d 3e20 4974 6572 6174 6f72 5b46  e) -> Iterator[F
+0000f4c0: 696c 6545 6e74 7279 5d3a 0a20 2020 2020  ileEntry]:.     
+0000f4d0: 2020 2027 2727 0a20 2020 2020 2020 2049     '''.        I
+0000f4e0: 7465 7261 7469 7665 6c79 2074 7261 7665  teratively trave
+0000f4f0: 7273 6520 6f6e 6c79 2066 696c 6573 2069  rse only files i
+0000f500: 6e20 6769 7665 6e20 6469 7265 6374 6f72  n given director
+0000f510: 792c 2069 6e20 616c 7068 6162 6574 6963  y, in alphabetic
+0000f520: 616c 206f 7264 6572 2e0a 2020 2020 2020  al order..      
+0000f530: 2020 4576 6572 7920 6974 6572 6174 696f    Every iteratio
+0000f540: 6e20 6f6e 2067 656e 6572 6174 6f72 2079  n on generator y
+0000f550: 6965 6c64 7320 6120 7475 706c 6520 6f66  ields a tuple of
+0000f560: 2070 6174 6820 7374 7269 6e67 2061 6e64   path string and
+0000f570: 2066 696c 6520 7374 6174 0a0a 2020 2020   file stat..    
+0000f580: 2020 2020 3a70 6172 616d 206d 6973 7369      :param missi
+0000f590: 6e67 5f6f 6b3a 2049 6620 4661 6c73 6520  ng_ok: If False 
+0000f5a0: 616e 6420 7468 6572 6527 7320 6e6f 2066  and there's no f
+0000f5b0: 696c 6520 696e 2074 6865 2064 6972 6563  ile in the direc
+0000f5c0: 746f 7279 2c20 7261 6973 6520 4669 6c65  tory, raise File
+0000f5d0: 4e6f 7446 6f75 6e64 4572 726f 720a 2020  NotFoundError.  
+0000f5e0: 2020 2020 2020 3a72 6169 7365 733a 2055        :raises: U
+0000f5f0: 6e73 7570 706f 7274 6564 4572 726f 720a  nsupportedError.
+0000f600: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
+0000f610: 3a20 4120 6669 6c65 2070 6174 6820 6765  : A file path ge
+0000f620: 6e65 7261 746f 720a 2020 2020 2020 2020  nerator.        
+0000f630: 2727 270a 2020 2020 2020 2020 6275 636b  '''.        buck
+0000f640: 6574 2c20 6b65 7920 3d20 7061 7273 655f  et, key = parse_
+0000f650: 7333 5f75 726c 2873 656c 662e 7061 7468  s3_url(self.path
+0000f660: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
+0000f670: 2020 2020 2020 2020 6966 206e 6f74 2062          if not b
+0000f680: 7563 6b65 743a 0a20 2020 2020 2020 2020  ucket:.         
+0000f690: 2020 2072 6169 7365 2055 6e73 7570 706f     raise Unsuppo
+0000f6a0: 7274 6564 4572 726f 7228 2753 6361 6e20  rtedError('Scan 
+0000f6b0: 7768 6f6c 6520 7333 272c 2073 656c 662e  whole s3', self.
+0000f6c0: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
+0000f6d0: 6f6c 290a 0a20 2020 2020 2020 2064 6566  ol)..        def
+0000f6e0: 2063 7265 6174 655f 6765 6e65 7261 746f   create_generato
+0000f6f0: 7228 2920 2d3e 2049 7465 7261 746f 725b  r() -> Iterator[
+0000f700: 4669 6c65 456e 7472 795d 3a0a 2020 2020  FileEntry]:.    
+0000f710: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+0000f720: 656c 662e 6973 5f64 6972 2829 3a0a 2020  elf.is_dir():.  
+0000f730: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000f740: 2073 656c 662e 6973 5f66 696c 6528 293a   self.is_file():
+0000f750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f760: 2020 2020 2023 204f 6e20 7333 2c20 6669       # On s3, fi
+0000f770: 6c65 2061 6e64 2064 6972 6563 746f 7279  le and directory
+0000f780: 206d 6179 2062 6520 6f66 2073 616d 6520   may be of same 
+0000f790: 6e61 6d65 2061 6e64 206c 6576 656c 2c20  name and level, 
+0000f7a0: 736f 206e 6565 6420 746f 2074 6573 7420  so need to test 
+0000f7b0: 7468 6520 7061 7468 2069 7320 6669 6c65  the path is file
+0000f7c0: 206f 7220 6469 7265 6374 6f72 790a 2020   or directory.  
+0000f7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f7e0: 2020 7969 656c 6420 4669 6c65 456e 7472    yield FileEntr
+0000f7f0: 7928 0a20 2020 2020 2020 2020 2020 2020  y(.             
+0000f800: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000f810: 6e61 6d65 2c20 6673 7061 7468 2873 656c  name, fspath(sel
+0000f820: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
+0000f830: 6f63 6f6c 292c 0a20 2020 2020 2020 2020  ocol),.         
+0000f840: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000f850: 656c 662e 7374 6174 2866 6f6c 6c6f 775f  elf.stat(follow_
+0000f860: 7379 6d6c 696e 6b73 3d66 6f6c 6c6f 776c  symlinks=followl
+0000f870: 696e 6b73 2929 0a20 2020 2020 2020 2020  inks)).         
+0000f880: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
+0000f890: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0000f8a0: 7420 6b65 792e 656e 6473 7769 7468 2827  t key.endswith('
+0000f8b0: 2f27 2920 616e 6420 7365 6c66 2e69 735f  /') and self.is_
+0000f8c0: 6669 6c65 2829 3a0a 2020 2020 2020 2020  file():.        
+0000f8d0: 2020 2020 2020 2020 7969 656c 6420 4669          yield Fi
+0000f8e0: 6c65 456e 7472 7928 0a20 2020 2020 2020  leEntry(.       
+0000f8f0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0000f900: 662e 6e61 6d65 2c20 6673 7061 7468 2873  f.name, fspath(s
+0000f910: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
+0000f920: 6f74 6f63 6f6c 292c 0a20 2020 2020 2020  otocol),.       
+0000f930: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0000f940: 662e 7374 6174 2866 6f6c 6c6f 775f 7379  f.stat(follow_sy
+0000f950: 6d6c 696e 6b73 3d66 6f6c 6c6f 776c 696e  mlinks=followlin
+0000f960: 6b73 2929 0a0a 2020 2020 2020 2020 2020  ks))..          
+0000f970: 2020 7072 6566 6978 203d 205f 6265 636f    prefix = _beco
+0000f980: 6d65 5f70 7265 6669 7828 6b65 7929 0a20  me_prefix(key). 
+0000f990: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
+0000f9a0: 7420 3d20 7365 6c66 2e5f 636c 6965 6e74  t = self._client
+0000f9b0: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
+0000f9c0: 6820 7261 6973 655f 7333 5f65 7272 6f72  h raise_s3_error
+0000f9d0: 2873 656c 662e 7061 7468 5f77 6974 685f  (self.path_with_
+0000f9e0: 7072 6f74 6f63 6f6c 293a 0a20 2020 2020  protocol):.     
+0000f9f0: 2020 2020 2020 2020 2020 2066 6f72 2072             for r
+0000fa00: 6573 7020 696e 205f 6c69 7374 5f6f 626a  esp in _list_obj
+0000fa10: 6563 7473 5f72 6563 7572 7369 7665 2863  ects_recursive(c
+0000fa20: 6c69 656e 742c 2062 7563 6b65 742c 2070  lient, bucket, p
+0000fa30: 7265 6669 7829 3a0a 2020 2020 2020 2020  refix):.        
+0000fa40: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0000fa50: 636f 6e74 656e 7420 696e 2072 6573 702e  content in resp.
+0000fa60: 6765 7428 2743 6f6e 7465 6e74 7327 2c20  get('Contents', 
+0000fa70: 5b5d 293a 0a20 2020 2020 2020 2020 2020  []):.           
+0000fa80: 2020 2020 2020 2020 2020 2020 2066 756c               ful
+0000fa90: 6c5f 7061 7468 203d 2073 335f 7061 7468  l_path = s3_path
+0000faa0: 5f6a 6f69 6e28 0a20 2020 2020 2020 2020  _join(.         
+0000fab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fac0: 2020 2066 277b 7365 6c66 2e5f 7072 6f74     f'{self._prot
+0000fad0: 6f63 6f6c 5f77 6974 685f 7072 6f66 696c  ocol_with_profil
+0000fae0: 657d 3a2f 2f27 2c20 6275 636b 6574 2c0a  e}://', bucket,.
+0000faf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb00: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+0000fb10: 656e 745b 274b 6579 275d 290a 2020 2020  ent['Key']).    
+0000fb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb30: 2020 2020 7969 656c 6420 4669 6c65 456e      yield FileEn
+0000fb40: 7472 7928 0a20 2020 2020 2020 2020 2020  try(.           
+0000fb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb60: 2053 3350 6174 6828 6675 6c6c 5f70 6174   S3Path(full_pat
+0000fb70: 6829 2e6e 616d 652c 2066 756c 6c5f 7061  h).name, full_pa
+0000fb80: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+0000fb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fba0: 5f6d 616b 655f 7374 6174 2863 6f6e 7465  _make_stat(conte
+0000fbb0: 6e74 2929 0a0a 2020 2020 2020 2020 7265  nt))..        re
+0000fbc0: 7475 726e 205f 6372 6561 7465 5f6d 6973  turn _create_mis
+0000fbd0: 7369 6e67 5f6f 6b5f 6765 6e65 7261 746f  sing_ok_generato
+0000fbe0: 7228 0a20 2020 2020 2020 2020 2020 2063  r(.            c
+0000fbf0: 7265 6174 655f 6765 6e65 7261 746f 7228  reate_generator(
+0000fc00: 292c 206d 6973 7369 6e67 5f6f 6b2c 0a20  ), missing_ok,. 
+0000fc10: 2020 2020 2020 2020 2020 2053 3346 696c             S3Fil
+0000fc20: 654e 6f74 466f 756e 6445 7272 6f72 2827  eNotFoundError('
+0000fc30: 4e6f 206d 6174 6368 2066 696c 653a 2025  No match file: %
+0000fc40: 7227 2025 2073 656c 662e 7061 7468 5f77  r' % self.path_w
+0000fc50: 6974 685f 7072 6f74 6f63 6f6c 2929 0a0a  ith_protocol))..
+0000fc60: 2020 2020 6465 6620 7363 616e 6469 7228      def scandir(
+0000fc70: 7365 6c66 2c20 666f 6c6c 6f77 6c69 6e6b  self, followlink
+0000fc80: 733a 2062 6f6f 6c20 3d20 4661 6c73 6529  s: bool = False)
+0000fc90: 202d 3e20 4974 6572 6174 6f72 5b46 696c   -> Iterator[Fil
+0000fca0: 6545 6e74 7279 5d3a 0a20 2020 2020 2020  eEntry]:.       
+0000fcb0: 2027 2727 0a20 2020 2020 2020 2047 6574   '''.        Get
+0000fcc0: 2061 6c6c 2063 6f6e 7465 6e74 7320 6f66   all contents of
+0000fcd0: 2067 6976 656e 2073 335f 7572 6c2c 2074   given s3_url, t
+0000fce0: 6865 206f 7264 6572 206f 6620 7265 7375  he order of resu
+0000fcf0: 6c74 2069 7320 6e6f 7420 6775 6172 616e  lt is not guaran
+0000fd00: 7465 6564 2e0a 0a20 2020 2020 2020 203a  teed...        :
+0000fd10: 7265 7475 726e 733a 2041 6c6c 2063 6f6e  returns: All con
+0000fd20: 7465 6e74 7320 6861 7665 2070 7265 6669  tents have prefi
+0000fd30: 7820 6f66 2073 335f 7572 6c0a 2020 2020  x of s3_url.    
+0000fd40: 2020 2020 3a72 6169 7365 733a 2053 3346      :raises: S3F
+0000fd50: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
+0000fd60: 2c20 5333 4e6f 7441 4469 7265 6374 6f72  , S3NotADirector
+0000fd70: 7945 7272 6f72 0a20 2020 2020 2020 2027  yError.        '
+0000fd80: 2727 0a20 2020 2020 2020 2062 7563 6b65  ''.        bucke
+0000fd90: 742c 206b 6579 203d 2070 6172 7365 5f73  t, key = parse_s
+0000fda0: 335f 7572 6c28 7365 6c66 2e70 6174 685f  3_url(self.path_
+0000fdb0: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
+0000fdc0: 2020 2020 2020 2069 6620 6e6f 7420 6275         if not bu
+0000fdd0: 636b 6574 2061 6e64 206b 6579 3a0a 2020  cket and key:.  
+0000fde0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000fdf0: 5333 4275 636b 6574 4e6f 7446 6f75 6e64  S3BucketNotFound
+0000fe00: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+0000fe10: 2020 2020 2020 2027 456d 7074 7920 6275         'Empty bu
+0000fe20: 636b 6574 206e 616d 653a 2025 7227 2025  cket name: %r' %
+0000fe30: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
+0000fe40: 7072 6f74 6f63 6f6c 290a 0a20 2020 2020  protocol)..     
+0000fe50: 2020 2069 6620 7365 6c66 2e69 735f 6669     if self.is_fi
+0000fe60: 6c65 2829 3a0a 2020 2020 2020 2020 2020  le():.          
+0000fe70: 2020 7261 6973 6520 5333 4e6f 7441 4469    raise S3NotADi
+0000fe80: 7265 6374 6f72 7945 7272 6f72 280a 2020  rectoryError(.  
+0000fe90: 2020 2020 2020 2020 2020 2020 2020 274e                'N
+0000fea0: 6f74 2061 2064 6972 6563 746f 7279 3a20  ot a directory: 
+0000feb0: 2572 2720 2520 7365 6c66 2e70 6174 685f  %r' % self.path_
+0000fec0: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
+0000fed0: 2020 2020 2020 2065 6c69 6620 6e6f 7420         elif not 
+0000fee0: 7365 6c66 2e69 735f 6469 7228 293a 0a20  self.is_dir():. 
+0000fef0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000ff00: 2053 3346 696c 654e 6f74 466f 756e 6445   S3FileNotFoundE
+0000ff10: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+0000ff20: 2020 2020 2020 274e 6f20 7375 6368 2064        'No such d
+0000ff30: 6972 6563 746f 7279 3a20 2572 2720 2520  irectory: %r' % 
+0000ff40: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
+0000ff50: 726f 746f 636f 6c29 0a20 2020 2020 2020  rotocol).       
+0000ff60: 2070 7265 6669 7820 3d20 5f62 6563 6f6d   prefix = _becom
+0000ff70: 655f 7072 6566 6978 286b 6579 290a 2020  e_prefix(key).  
+0000ff80: 2020 2020 2020 636c 6965 6e74 203d 2073        client = s
+0000ff90: 656c 662e 5f63 6c69 656e 740a 0a20 2020  elf._client..   
+0000ffa0: 2020 2020 2023 2049 6e20 6f72 6465 7220       # In order 
+0000ffb0: 746f 2064 6f20 6368 6563 6b20 6f6e 2063  to do check on c
+0000ffc0: 7265 6174 696f 6e2c 0a20 2020 2020 2020  reation,.       
+0000ffd0: 2023 2077 6520 6e65 6564 2074 6f20 7772   # we need to wr
+0000ffe0: 6170 2074 6865 2069 7465 7261 746f 7220  ap the iterator 
+0000fff0: 696e 2061 6e6f 7468 6572 2066 756e 6374  in another funct
+00010000: 696f 6e0a 2020 2020 2020 2020 6465 6620  ion.        def 
+00010010: 6372 6561 7465 5f67 656e 6572 6174 6f72  create_generator
+00010020: 2829 202d 3e20 4974 6572 6174 6f72 5b46  () -> Iterator[F
+00010030: 696c 6545 6e74 7279 5d3a 0a20 2020 2020  ileEntry]:.     
+00010040: 2020 2020 2020 2077 6974 6820 7261 6973         with rais
+00010050: 655f 7333 5f65 7272 6f72 2873 656c 662e  e_s3_error(self.
+00010060: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
+00010070: 6f6c 293a 0a0a 2020 2020 2020 2020 2020  ol):..          
+00010080: 2020 2020 2020 6465 6620 6765 6e65 7261        def genera
+00010090: 7465 5f73 335f 7061 7468 280a 2020 2020  te_s3_path(.    
+000100a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000100b0: 2020 2020 7072 6f74 6f63 6f6c 3a20 7374      protocol: st
+000100c0: 722c 2062 7563 6b65 743a 2073 7472 2c20  r, bucket: str, 
+000100d0: 6b65 793a 2073 7472 2920 2d3e 2073 7472  key: str) -> str
+000100e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000100f0: 2020 2020 2020 7265 7475 726e 2022 2573        return "%s
+00010100: 3a2f 2f25 732f 2573 2220 2520 2870 726f  ://%s/%s" % (pro
+00010110: 746f 636f 6c2c 2062 7563 6b65 742c 206b  tocol, bucket, k
+00010120: 6579 290a 0a20 2020 2020 2020 2020 2020  ey)..           
+00010130: 2020 2020 2069 6620 6e6f 7420 6275 636b       if not buck
+00010140: 6574 2061 6e64 206e 6f74 206b 6579 3a20  et and not key: 
+00010150: 2023 206c 6973 7420 6275 636b 6574 730a   # list buckets.
+00010160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010170: 2020 2020 7265 7370 6f6e 7365 203d 2063      response = c
+00010180: 6c69 656e 742e 6c69 7374 5f62 7563 6b65  lient.list_bucke
+00010190: 7473 2829 0a20 2020 2020 2020 2020 2020  ts().           
+000101a0: 2020 2020 2020 2020 2066 6f72 2063 6f6e           for con
+000101b0: 7465 6e74 2069 6e20 7265 7370 6f6e 7365  tent in response
+000101c0: 5b27 4275 636b 6574 7327 5d3a 0a20 2020  ['Buckets']:.   
+000101d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000101e0: 2020 2020 2079 6965 6c64 2046 696c 6545       yield FileE
+000101f0: 6e74 7279 280a 2020 2020 2020 2020 2020  ntry(.          
+00010200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010210: 2020 636f 6e74 656e 745b 274e 616d 6527    content['Name'
+00010220: 5d2c 2066 2273 333a 2f2f 7b63 6f6e 7465  ], f"s3://{conte
+00010230: 6e74 5b27 4e61 6d65 275d 7d22 2c0a 2020  nt['Name']}",.  
+00010240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010250: 2020 2020 2020 2020 2020 5374 6174 5265            StatRe
+00010260: 7375 6c74 280a 2020 2020 2020 2020 2020  sult(.          
+00010270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010280: 2020 2020 2020 6374 696d 653d 636f 6e74        ctime=cont
+00010290: 656e 745b 2743 7265 6174 696f 6e44 6174  ent['CreationDat
+000102a0: 6527 5d2e 7469 6d65 7374 616d 7028 292c  e'].timestamp(),
+000102b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000102c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000102d0: 2069 7364 6972 3d54 7275 652c 0a20 2020   isdir=True,.   
+000102e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000102f0: 2020 2020 2020 2020 2020 2020 2065 7874               ext
+00010300: 7261 3d63 6f6e 7465 6e74 2c0a 2020 2020  ra=content,.    
+00010310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010320: 2020 2020 2020 2020 2929 0a20 2020 2020          )).     
+00010330: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00010340: 6574 7572 6e0a 0a20 2020 2020 2020 2020  eturn..         
+00010350: 2020 2020 2020 2066 6f72 2072 6573 7020         for resp 
+00010360: 696e 205f 6c69 7374 5f6f 626a 6563 7473  in _list_objects
+00010370: 5f72 6563 7572 7369 7665 2863 6c69 656e  _recursive(clien
+00010380: 742c 2062 7563 6b65 742c 2070 7265 6669  t, bucket, prefi
+00010390: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+000103a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000103b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000103c0: 2020 2020 2020 2027 2f27 293a 0a20 2020         '/'):.   
+000103d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000103e0: 2066 6f72 2063 6f6d 6d6f 6e5f 7072 6566   for common_pref
+000103f0: 6978 2069 6e20 7265 7370 2e67 6574 2827  ix in resp.get('
+00010400: 436f 6d6d 6f6e 5072 6566 6978 6573 272c  CommonPrefixes',
+00010410: 205b 5d29 3a0a 2020 2020 2020 2020 2020   []):.          
+00010420: 2020 2020 2020 2020 2020 2020 2020 7969                yi
+00010430: 656c 6420 4669 6c65 456e 7472 7928 0a20  eld FileEntry(. 
+00010440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010450: 2020 2020 2020 2020 2020 2063 6f6d 6d6f             commo
+00010460: 6e5f 7072 6566 6978 5b27 5072 6566 6978  n_prefix['Prefix
+00010470: 275d 5b6c 656e 2870 7265 6669 7829 3a2d  '][len(prefix):-
+00010480: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
+00010490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000104a0: 6765 6e65 7261 7465 5f73 335f 7061 7468  generate_s3_path
+000104b0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000104c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000104d0: 2020 7365 6c66 2e5f 7072 6f74 6f63 6f6c    self._protocol
+000104e0: 5f77 6974 685f 7072 6f66 696c 652c 2062  _with_profile, b
+000104f0: 7563 6b65 742c 0a20 2020 2020 2020 2020  ucket,.         
+00010500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010510: 2020 2020 2020 2063 6f6d 6d6f 6e5f 7072         common_pr
+00010520: 6566 6978 5b27 5072 6566 6978 275d 292c  efix['Prefix']),
+00010530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010540: 2020 2020 2020 2020 2020 2020 2053 7461               Sta
+00010550: 7452 6573 756c 7428 6973 6469 723d 5472  tResult(isdir=Tr
+00010560: 7565 2c20 6578 7472 613d 636f 6d6d 6f6e  ue, extra=common
+00010570: 5f70 7265 6669 7829 290a 2020 2020 2020  _prefix)).      
+00010580: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00010590: 7220 636f 6e74 656e 7420 696e 2072 6573  r content in res
+000105a0: 702e 6765 7428 2743 6f6e 7465 6e74 7327  p.get('Contents'
+000105b0: 2c20 5b5d 293a 0a20 2020 2020 2020 2020  , []):.         
+000105c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000105d0: 7263 5f75 726c 203d 2067 656e 6572 6174  rc_url = generat
+000105e0: 655f 7333 5f70 6174 6828 0a20 2020 2020  e_s3_path(.     
+000105f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010600: 2020 2020 2020 2073 656c 662e 5f70 726f         self._pro
+00010610: 746f 636f 6c5f 7769 7468 5f70 726f 6669  tocol_with_profi
+00010620: 6c65 2c20 6275 636b 6574 2c20 636f 6e74  le, bucket, cont
+00010630: 656e 745b 274b 6579 275d 290a 0a20 2020  ent['Key'])..   
+00010640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010650: 2020 2020 2069 6620 666f 6c6c 6f77 6c69       if followli
+00010660: 6e6b 7320 616e 6420 5333 5061 7468 2873  nks and S3Path(s
+00010670: 7263 5f75 726c 292e 6973 5f73 796d 6c69  rc_url).is_symli
+00010680: 6e6b 2829 3a0a 2020 2020 2020 2020 2020  nk():.          
+00010690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000106a0: 2020 636f 6e74 656e 745b 2769 736c 6e6b    content['islnk
+000106b0: 275d 203d 2054 7275 650a 0a20 2020 2020  '] = True..     
+000106c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000106d0: 2020 2079 6965 6c64 2046 696c 6545 6e74     yield FileEnt
+000106e0: 7279 280a 2020 2020 2020 2020 2020 2020  ry(.            
+000106f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010700: 636f 6e74 656e 745b 274b 6579 275d 5b6c  content['Key'][l
+00010710: 656e 2870 7265 6669 7829 3a5d 2c20 7372  en(prefix):], sr
+00010720: 635f 7572 6c2c 0a20 2020 2020 2020 2020  c_url,.         
+00010730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010740: 2020 205f 6d61 6b65 5f73 7461 7428 636f     _make_stat(co
+00010750: 6e74 656e 7429 290a 0a20 2020 2020 2020  ntent))..       
+00010760: 2072 6574 7572 6e20 436f 6e74 6578 7449   return ContextI
+00010770: 7465 7261 746f 7228 6372 6561 7465 5f67  terator(create_g
+00010780: 656e 6572 6174 6f72 2829 290a 0a20 2020  enerator())..   
+00010790: 2064 6566 205f 6765 7464 6972 7374 6174   def _getdirstat
+000107a0: 2873 656c 6629 202d 3e20 5374 6174 5265  (self) -> StatRe
+000107b0: 7375 6c74 3a0a 2020 2020 2020 2020 2727  sult:.        ''
+000107c0: 270a 2020 2020 2020 2020 5265 7475 726e  '.        Return
+000107d0: 2053 7461 7452 6573 756c 7420 6f66 2067   StatResult of g
+000107e0: 6976 656e 2073 335f 7572 6c20 6469 7265  iven s3_url dire
+000107f0: 6374 6f72 792c 2069 6e63 6c75 6469 6e67  ctory, including
+00010800: 3a20 0a0a 2020 2020 2020 2020 312e 2044  : ..        1. D
+00010810: 6972 6563 746f 7279 2073 697a 653a 2074  irectory size: t
+00010820: 6865 2073 756d 206f 6620 616c 6c20 6669  he sum of all fi
+00010830: 6c65 2073 697a 6520 696e 2069 742c 2069  le size in it, i
+00010840: 6e63 6c75 6469 6e67 2066 696c 6520 696e  ncluding file in
+00010850: 2073 7562 6469 7265 6374 6f72 6965 7320   subdirectories 
+00010860: 2869 6620 6578 6973 7429 2e0a 2020 2020  (if exist)..    
+00010870: 2020 2020 5468 6520 7265 7375 6c74 2065      The result e
+00010880: 7863 6c75 6465 7320 7468 6520 7369 7a65  xcludes the size
+00010890: 206f 6620 6469 7265 6374 6f72 7920 6974   of directory it
+000108a0: 7365 6c66 2e20 496e 206f 7468 6572 2077  self. In other w
+000108b0: 6f72 6473 2c20 7265 7475 726e 2030 2042  ords, return 0 B
+000108c0: 7974 6520 6f6e 2061 6e20 656d 7074 7920  yte on an empty 
+000108d0: 6469 7265 6374 6f72 7920 7061 7468 0a20  directory path. 
+000108e0: 2020 2020 2020 2032 2e20 4c61 7374 2d6d         2. Last-m
+000108f0: 6f64 6966 6965 6420 7469 6d65 206f 6620  odified time of 
+00010900: 6469 7265 6374 6f72 793a 2072 6574 7572  directory: retur
+00010910: 6e20 7468 6520 6c61 7465 7374 206d 6f64  n the latest mod
+00010920: 6966 6965 6420 7469 6d65 206f 6620 616c  ified time of al
+00010930: 6c20 6669 6c65 2069 6e20 6974 2e20 5468  l file in it. Th
+00010940: 6520 6d74 696d 6520 6f66 2065 6d70 7479  e mtime of empty
+00010950: 2064 6972 6563 746f 7279 2069 7320 3139   directory is 19
+00010960: 3730 2d30 312d 3031 2030 303a 3030 3a30  70-01-01 00:00:0
+00010970: 300a 0a20 2020 2020 2020 203a 7265 7475  0..        :retu
+00010980: 726e 733a 2041 6e20 696e 7420 696e 6469  rns: An int indi
+00010990: 6361 7465 7320 7369 7a65 2069 6e20 4279  cates size in By
+000109a0: 7465 730a 2020 2020 2020 2020 2727 270a  tes.        '''.
+000109b0: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+000109c0: 656c 662e 6973 5f64 6972 2829 3a0a 2020  elf.is_dir():.  
+000109d0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+000109e0: 5333 4669 6c65 4e6f 7446 6f75 6e64 4572  S3FileNotFoundEr
+000109f0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+00010a00: 2020 2020 2027 4e6f 2073 7563 6820 6669       'No such fi
+00010a10: 6c65 206f 7220 6469 7265 6374 6f72 793a  le or directory:
+00010a20: 2025 7227 2025 2073 656c 662e 7061 7468   %r' % self.path
+00010a30: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
+00010a40: 0a20 2020 2020 2020 2062 7563 6b65 742c  .        bucket,
+00010a50: 206b 6579 203d 2070 6172 7365 5f73 335f   key = parse_s3_
+00010a60: 7572 6c28 7365 6c66 2e70 6174 685f 7769  url(self.path_wi
+00010a70: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
+00010a80: 2020 2020 2070 7265 6669 7820 3d20 5f62       prefix = _b
+00010a90: 6563 6f6d 655f 7072 6566 6978 286b 6579  ecome_prefix(key
+00010aa0: 290a 2020 2020 2020 2020 636c 6965 6e74  ).        client
+00010ab0: 203d 2073 656c 662e 5f63 6c69 656e 740a   = self._client.
+00010ac0: 2020 2020 2020 2020 7369 7a65 203d 2030          size = 0
+00010ad0: 0a20 2020 2020 2020 206d 7469 6d65 203d  .        mtime =
+00010ae0: 2030 2e30 0a20 2020 2020 2020 2077 6974   0.0.        wit
+00010af0: 6820 7261 6973 655f 7333 5f65 7272 6f72  h raise_s3_error
+00010b00: 2873 656c 662e 7061 7468 5f77 6974 685f  (self.path_with_
+00010b10: 7072 6f74 6f63 6f6c 293a 0a20 2020 2020  protocol):.     
+00010b20: 2020 2020 2020 2066 6f72 2072 6573 7020         for resp 
+00010b30: 696e 205f 6c69 7374 5f6f 626a 6563 7473  in _list_objects
+00010b40: 5f72 6563 7572 7369 7665 2863 6c69 656e  _recursive(clien
+00010b50: 742c 2062 7563 6b65 742c 2070 7265 6669  t, bucket, prefi
+00010b60: 7829 3a0a 2020 2020 2020 2020 2020 2020  x):.            
+00010b70: 2020 2020 666f 7220 636f 6e74 656e 7420      for content 
+00010b80: 696e 2072 6573 702e 6765 7428 2743 6f6e  in resp.get('Con
+00010b90: 7465 6e74 7327 2c20 5b5d 293a 0a20 2020  tents', []):.   
+00010ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010bb0: 2073 697a 6520 2b3d 2063 6f6e 7465 6e74   size += content
+00010bc0: 5b27 5369 7a65 275d 0a20 2020 2020 2020  ['Size'].       
+00010bd0: 2020 2020 2020 2020 2020 2020 206c 6173               las
+00010be0: 745f 6d6f 6469 6669 6564 203d 2063 6f6e  t_modified = con
+00010bf0: 7465 6e74 5b27 4c61 7374 4d6f 6469 6669  tent['LastModifi
+00010c00: 6564 275d 2e74 696d 6573 7461 6d70 2829  ed'].timestamp()
+00010c10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010c20: 2020 2020 2069 6620 6d74 696d 6520 3c20       if mtime < 
+00010c30: 6c61 7374 5f6d 6f64 6966 6965 643a 0a20  last_modified:. 
+00010c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c50: 2020 2020 2020 206d 7469 6d65 203d 206c         mtime = l
+00010c60: 6173 745f 6d6f 6469 6669 6564 0a0a 2020  ast_modified..  
+00010c70: 2020 2020 2020 7265 7475 726e 2053 7461        return Sta
+00010c80: 7452 6573 756c 7428 7369 7a65 3d73 697a  tResult(size=siz
+00010c90: 652c 206d 7469 6d65 3d6d 7469 6d65 2c20  e, mtime=mtime, 
+00010ca0: 6973 6469 723d 5472 7565 290a 0a20 2020  isdir=True)..   
+00010cb0: 2064 6566 2073 7461 7428 7365 6c66 2c20   def stat(self, 
+00010cc0: 666f 6c6c 6f77 5f73 796d 6c69 6e6b 733d  follow_symlinks=
+00010cd0: 5472 7565 2920 2d3e 2053 7461 7452 6573  True) -> StatRes
+00010ce0: 756c 743a 0a20 2020 2020 2020 2027 2727  ult:.        '''
+00010cf0: 0a20 2020 2020 2020 2047 6574 2053 7461  .        Get Sta
+00010d00: 7452 6573 756c 7420 6f66 2073 335f 7572  tResult of s3_ur
+00010d10: 6c20 6669 6c65 2c20 696e 636c 7564 696e  l file, includin
+00010d20: 6720 6669 6c65 2073 697a 6520 616e 6420  g file size and 
+00010d30: 6d74 696d 652c 2072 6566 6572 7269 6e67  mtime, referring
+00010d40: 2074 6f20 7333 5f67 6574 7369 7a65 2061   to s3_getsize a
+00010d50: 6e64 2073 335f 6765 746d 7469 6d65 0a0a  nd s3_getmtime..
+00010d60: 2020 2020 2020 2020 4966 2073 335f 7572          If s3_ur
+00010d70: 6c20 6973 206e 6f74 2061 6e20 6578 6973  l is not an exis
+00010d80: 7465 6e74 2070 6174 682c 2077 6869 6368  tent path, which
+00010d90: 206d 6561 6e73 2073 335f 6578 6973 7428   means s3_exist(
+00010da0: 7333 5f75 726c 2920 7265 7475 726e 7320  s3_url) returns 
+00010db0: 4661 6c73 652c 2074 6865 6e20 7261 6973  False, then rais
+00010dc0: 6520 5333 4669 6c65 4e6f 7446 6f75 6e64  e S3FileNotFound
+00010dd0: 4572 726f 720a 2020 2020 2020 2020 4966  Error.        If
+00010de0: 2061 7474 656d 7074 2074 6f20 6765 7420   attempt to get 
+00010df0: 5374 6174 5265 7375 6c74 206f 6620 636f  StatResult of co
+00010e00: 6d70 6c65 7465 2073 332c 2073 7563 6820  mplete s3, such 
+00010e10: 6173 2073 335f 6469 725f 7572 6c20 3d3d  as s3_dir_url ==
+00010e20: 2027 7333 3a2f 2f27 2c20 7261 6973 6520   's3://', raise 
+00010e30: 5333 4275 636b 6574 4e6f 7446 6f75 6e64  S3BucketNotFound
+00010e40: 4572 726f 720a 0a20 2020 2020 2020 203a  Error..        :
+00010e50: 7265 7475 726e 733a 2053 7461 7452 6573  returns: StatRes
+00010e60: 756c 740a 2020 2020 2020 2020 3a72 6169  ult.        :rai
+00010e70: 7365 733a 2053 3346 696c 654e 6f74 466f  ses: S3FileNotFo
+00010e80: 756e 6445 7272 6f72 2c20 5333 4275 636b  undError, S3Buck
+00010e90: 6574 4e6f 7446 6f75 6e64 4572 726f 720a  etNotFoundError.
+00010ea0: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+00010eb0: 2020 2020 6973 6c6e 6b20 3d20 4661 6c73      islnk = Fals
+00010ec0: 650a 2020 2020 2020 2020 6275 636b 6574  e.        bucket
+00010ed0: 2c20 6b65 7920 3d20 7061 7273 655f 7333  , key = parse_s3
+00010ee0: 5f75 726c 2873 656c 662e 7061 7468 5f77  _url(self.path_w
+00010ef0: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
+00010f00: 2020 2020 2020 6966 206e 6f74 2062 7563        if not buc
+00010f10: 6b65 743a 0a20 2020 2020 2020 2020 2020  ket:.           
+00010f20: 2072 6169 7365 2053 3342 7563 6b65 744e   raise S3BucketN
+00010f30: 6f74 466f 756e 6445 7272 6f72 280a 2020  otFoundError(.  
+00010f40: 2020 2020 2020 2020 2020 2020 2020 2745                'E
+00010f50: 6d70 7479 2062 7563 6b65 7420 6e61 6d65  mpty bucket name
+00010f60: 3a20 2572 2720 2520 7365 6c66 2e70 6174  : %r' % self.pat
+00010f70: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
+00010f80: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+00010f90: 2073 656c 662e 6973 5f66 696c 6528 293a   self.is_file():
+00010fa0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00010fb0: 7572 6e20 7365 6c66 2e5f 6765 7464 6972  urn self._getdir
+00010fc0: 7374 6174 2829 0a0a 2020 2020 2020 2020  stat()..        
+00010fd0: 636c 6965 6e74 203d 2073 656c 662e 5f63  client = self._c
+00010fe0: 6c69 656e 740a 2020 2020 2020 2020 7769  lient.        wi
+00010ff0: 7468 2072 6169 7365 5f73 335f 6572 726f  th raise_s3_erro
+00011000: 7228 7365 6c66 2e70 6174 685f 7769 7468  r(self.path_with
+00011010: 5f70 726f 746f 636f 6c29 3a0a 2020 2020  _protocol):.    
+00011020: 2020 2020 2020 2020 636f 6e74 656e 7420          content 
+00011030: 3d20 636c 6965 6e74 2e68 6561 645f 6f62  = client.head_ob
+00011040: 6a65 6374 2842 7563 6b65 743d 6275 636b  ject(Bucket=buck
+00011050: 6574 2c20 4b65 793d 6b65 7929 0a20 2020  et, Key=key).   
+00011060: 2020 2020 2020 2020 2069 6620 274d 6574           if 'Met
+00011070: 6164 6174 6127 2069 6e20 636f 6e74 656e  adata' in conten
+00011080: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00011090: 2020 206d 6574 6164 6174 6120 3d20 6469     metadata = di
+000110a0: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
+000110b0: 2020 2020 2020 2020 286b 6579 2e6c 6f77          (key.low
+000110c0: 6572 2829 2c20 7661 6c75 6529 0a20 2020  er(), value).   
+000110d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000110e0: 2066 6f72 206b 6579 2c20 7661 6c75 6520   for key, value 
+000110f0: 696e 2063 6f6e 7465 6e74 5b27 4d65 7461  in content['Meta
+00011100: 6461 7461 275d 2e69 7465 6d73 2829 290a  data'].items()).
+00011110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011120: 6966 206d 6574 6164 6174 6120 616e 6420  if metadata and 
+00011130: 2773 796d 6c69 6e6b 5f74 6f27 2069 6e20  'symlink_to' in 
+00011140: 6d65 7461 6461 7461 3a0a 2020 2020 2020  metadata:.      
+00011150: 2020 2020 2020 2020 2020 2020 2020 6973                is
+00011160: 6c6e 6b20 3d20 5472 7565 0a20 2020 2020  lnk = True.     
+00011170: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00011180: 6620 6973 6c6e 6b20 616e 6420 666f 6c6c  f islnk and foll
+00011190: 6f77 5f73 796d 6c69 6e6b 733a 0a20 2020  ow_symlinks:.   
+000111a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000111b0: 2020 2020 2073 335f 7572 6c20 3d20 6d65       s3_url = me
+000111c0: 7461 6461 7461 5b27 7379 6d6c 696e 6b5f  tadata['symlink_
+000111d0: 746f 275d 0a20 2020 2020 2020 2020 2020  to'].           
+000111e0: 2020 2020 2020 2020 2020 2020 2062 7563               buc
+000111f0: 6b65 742c 206b 6579 203d 2070 6172 7365  ket, key = parse
+00011200: 5f73 335f 7572 6c28 7333 5f75 726c 290a  _s3_url(s3_url).
+00011210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011220: 2020 2020 2020 2020 636f 6e74 656e 7420          content 
+00011230: 3d20 636c 6965 6e74 2e68 6561 645f 6f62  = client.head_ob
+00011240: 6a65 6374 2842 7563 6b65 743d 6275 636b  ject(Bucket=buck
+00011250: 6574 2c20 4b65 793d 6b65 7929 0a20 2020  et, Key=key).   
+00011260: 2020 2020 2020 2020 2073 7461 745f 7265           stat_re
+00011270: 636f 7264 203d 2053 7461 7452 6573 756c  cord = StatResul
+00011280: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+00011290: 2020 2069 736c 6e6b 3d69 736c 6e6b 2c0a     islnk=islnk,.
+000112a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000112b0: 7369 7a65 3d63 6f6e 7465 6e74 5b27 436f  size=content['Co
+000112c0: 6e74 656e 744c 656e 6774 6827 5d2c 0a20  ntentLength'],. 
+000112d0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+000112e0: 7469 6d65 3d63 6f6e 7465 6e74 5b27 4c61  time=content['La
+000112f0: 7374 4d6f 6469 6669 6564 275d 2e74 696d  stModified'].tim
+00011300: 6573 7461 6d70 2829 2c0a 2020 2020 2020  estamp(),.      
+00011310: 2020 2020 2020 2020 2020 6578 7472 613d            extra=
+00011320: 636f 6e74 656e 7429 0a20 2020 2020 2020  content).       
+00011330: 2072 6574 7572 6e20 7374 6174 5f72 6563   return stat_rec
+00011340: 6f72 640a 0a20 2020 2064 6566 206c 7374  ord..    def lst
+00011350: 6174 2873 656c 6629 202d 3e20 5374 6174  at(self) -> Stat
+00011360: 5265 7375 6c74 3a0a 2020 2020 2020 2020  Result:.        
+00011370: 2727 274c 696b 6520 5061 7468 2e73 7461  '''Like Path.sta
+00011380: 7428 2920 6275 742c 2069 6620 7468 6520  t() but, if the 
+00011390: 7061 7468 2070 6f69 6e74 7320 746f 2061  path points to a
+000113a0: 2073 796d 626f 6c69 6320 6c69 6e6b 2c20   symbolic link, 
+000113b0: 7265 7475 726e 2074 6865 2073 796d 626f  return the symbo
+000113c0: 6c69 6320 6c69 6e6b e280 9973 2069 6e66  lic link...s inf
+000113d0: 6f72 6d61 7469 6f6e 2072 6174 6865 7220  ormation rather 
+000113e0: 7468 616e 2069 7473 2074 6172 6765 74e2  than its target.
+000113f0: 8099 732e 2727 270a 2020 2020 2020 2020  ..s.'''.        
+00011400: 7265 7475 726e 2073 656c 662e 7374 6174  return self.stat
+00011410: 2866 6f6c 6c6f 775f 7379 6d6c 696e 6b73  (follow_symlinks
+00011420: 3d46 616c 7365 290a 0a20 2020 2064 6566  =False)..    def
+00011430: 2075 6e6c 696e 6b28 7365 6c66 2c20 6d69   unlink(self, mi
+00011440: 7373 696e 675f 6f6b 3a20 626f 6f6c 203d  ssing_ok: bool =
+00011450: 2046 616c 7365 2920 2d3e 204e 6f6e 653a   False) -> None:
+00011460: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
+00011470: 2020 2020 2052 656d 6f76 6520 7468 6520       Remove the 
+00011480: 6669 6c65 206f 6e20 7333 0a0a 2020 2020  file on s3..    
+00011490: 2020 2020 3a70 6172 616d 206d 6973 7369      :param missi
+000114a0: 6e67 5f6f 6b3a 2069 6620 4661 6c73 6520  ng_ok: if False 
+000114b0: 616e 6420 7461 7267 6574 2066 696c 6520  and target file 
+000114c0: 6e6f 7420 6578 6973 7473 2c20 7261 6973  not exists, rais
+000114d0: 6520 5333 4669 6c65 4e6f 7446 6f75 6e64  e S3FileNotFound
+000114e0: 4572 726f 720a 2020 2020 2020 2020 3a72  Error.        :r
+000114f0: 6169 7365 733a 2053 3350 6572 6d69 7373  aises: S3Permiss
+00011500: 696f 6e45 7272 6f72 2c20 5333 4669 6c65  ionError, S3File
+00011510: 4e6f 7446 6f75 6e64 4572 726f 722c 2053  NotFoundError, S
+00011520: 3349 7341 4469 7265 6374 6f72 7945 7272  3IsADirectoryErr
+00011530: 6f72 0a20 2020 2020 2020 2027 2727 0a20  or.        '''. 
+00011540: 2020 2020 2020 2062 7563 6b65 742c 206b         bucket, k
+00011550: 6579 203d 2070 6172 7365 5f73 335f 7572  ey = parse_s3_ur
+00011560: 6c28 7365 6c66 2e70 6174 685f 7769 7468  l(self.path_with
+00011570: 5f70 726f 746f 636f 6c29 0a20 2020 2020  _protocol).     
+00011580: 2020 2069 6620 6e6f 7420 6275 636b 6574     if not bucket
+00011590: 206f 7220 6e6f 7420 6b65 7920 6f72 206b   or not key or k
+000115a0: 6579 2e65 6e64 7377 6974 6828 272f 2729  ey.endswith('/')
+000115b0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+000115c0: 6973 6520 5333 4973 4144 6972 6563 746f  ise S3IsADirecto
+000115d0: 7279 4572 726f 7228 0a20 2020 2020 2020  ryError(.       
+000115e0: 2020 2020 2020 2020 2027 4973 2061 2064           'Is a d
+000115f0: 6972 6563 746f 7279 3a20 2572 2720 2520  irectory: %r' % 
+00011600: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
+00011610: 726f 746f 636f 6c29 0a20 2020 2020 2020  rotocol).       
+00011620: 2069 6620 6e6f 7420 7365 6c66 2e69 735f   if not self.is_
+00011630: 6669 6c65 2829 3a0a 2020 2020 2020 2020  file():.        
+00011640: 2020 2020 6966 206d 6973 7369 6e67 5f6f      if missing_o
+00011650: 6b3a 0a20 2020 2020 2020 2020 2020 2020  k:.             
+00011660: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
+00011670: 2020 2020 2020 7261 6973 6520 5333 4669        raise S3Fi
+00011680: 6c65 4e6f 7446 6f75 6e64 4572 726f 7228  leNotFoundError(
+00011690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000116a0: 2027 4e6f 2073 7563 6820 6669 6c65 3a20   'No such file: 
+000116b0: 2572 2720 2520 7365 6c66 2e70 6174 685f  %r' % self.path_
+000116c0: 7769 7468 5f70 726f 746f 636f 6c29 0a0a  with_protocol)..
+000116d0: 2020 2020 2020 2020 7769 7468 2072 6169          with rai
+000116e0: 7365 5f73 335f 6572 726f 7228 7365 6c66  se_s3_error(self
+000116f0: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+00011700: 636f 6c29 3a0a 2020 2020 2020 2020 2020  col):.          
+00011710: 2020 7365 6c66 2e5f 636c 6965 6e74 2e64    self._client.d
+00011720: 656c 6574 655f 6f62 6a65 6374 2842 7563  elete_object(Buc
+00011730: 6b65 743d 6275 636b 6574 2c20 4b65 793d  ket=bucket, Key=
+00011740: 6b65 7929 0a0a 2020 2020 6465 6620 7761  key)..    def wa
+00011750: 6c6b 2873 656c 662c 2066 6f6c 6c6f 776c  lk(self, followl
+00011760: 696e 6b73 3a20 626f 6f6c 203d 2046 616c  inks: bool = Fal
+00011770: 7365 0a20 2020 2020 2020 2020 2020 2029  se.            )
+00011780: 202d 3e20 4974 6572 6174 6f72 5b54 7570   -> Iterator[Tup
+00011790: 6c65 5b73 7472 2c20 4c69 7374 5b73 7472  le[str, List[str
+000117a0: 5d2c 204c 6973 745b 7374 725d 5d5d 3a0a  ], List[str]]]:.
+000117b0: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+000117c0: 2020 2020 4974 6572 6174 6976 656c 7920      Iteratively 
+000117d0: 7472 6176 6572 7365 2074 6865 2067 6976  traverse the giv
+000117e0: 656e 2073 3320 6469 7265 6374 6f72 792c  en s3 directory,
+000117f0: 2069 6e20 746f 702d 626f 7474 6f6d 206f   in top-bottom o
+00011800: 7264 6572 2e20 496e 206f 7468 6572 2077  rder. In other w
+00011810: 6f72 6473 2c20 6669 7273 746c 7920 7472  ords, firstly tr
+00011820: 6176 6572 7365 2070 6172 656e 7420 6469  averse parent di
+00011830: 7265 6374 6f72 792c 2069 6620 7375 6264  rectory, if subd
+00011840: 6972 6563 746f 7269 6573 2065 7869 7374  irectories exist
+00011850: 2c20 7472 6176 6572 7365 2074 6865 2073  , traverse the s
+00011860: 7562 6469 7265 6374 6f72 6965 7320 696e  ubdirectories in
+00011870: 2061 6c70 6861 6265 7469 6361 6c20 6f72   alphabetical or
+00011880: 6465 722e 0a20 2020 2020 2020 2045 7665  der..        Eve
+00011890: 7279 2069 7465 7261 7469 6f6e 206f 6e20  ry iteration on 
+000118a0: 6765 6e65 7261 746f 7220 7969 656c 6473  generator yields
+000118b0: 2061 2033 2d74 7570 6c65 3a20 2872 6f6f   a 3-tuple: (roo
+000118c0: 742c 2064 6972 732c 2066 696c 6573 290a  t, dirs, files).
+000118d0: 0a20 2020 2020 2020 202d 2072 6f6f 743a  .        - root:
+000118e0: 2043 7572 7265 6e74 2073 3320 7061 7468   Current s3 path
+000118f0: 3b0a 2020 2020 2020 2020 2d20 6469 7273  ;.        - dirs
+00011900: 3a20 4e61 6d65 206c 6973 7420 6f66 2073  : Name list of s
+00011910: 7562 6469 7265 6374 6f72 6965 7320 696e  ubdirectories in
+00011920: 2063 7572 7265 6e74 2064 6972 6563 746f   current directo
+00011930: 7279 2e20 5468 6520 6c69 7374 2069 7320  ry. The list is 
+00011940: 736f 7274 6564 2062 7920 6e61 6d65 2069  sorted by name i
+00011950: 6e20 6173 6365 6e64 696e 6720 616c 7068  n ascending alph
+00011960: 6162 6574 6963 616c 206f 7264 6572 3b0a  abetical order;.
+00011970: 2020 2020 2020 2020 2d20 6669 6c65 733a          - files:
+00011980: 204e 616d 6520 6c69 7374 206f 6620 6669   Name list of fi
+00011990: 6c65 7320 696e 2063 7572 7265 6e74 2064  les in current d
+000119a0: 6972 6563 746f 7279 2e20 5468 6520 6c69  irectory. The li
+000119b0: 7374 2069 7320 736f 7274 6564 2062 7920  st is sorted by 
+000119c0: 6e61 6d65 2069 6e20 6173 6365 6e64 696e  name in ascendin
+000119d0: 6720 616c 7068 6162 6574 6963 616c 206f  g alphabetical o
+000119e0: 7264 6572 3b0a 0a20 2020 2020 2020 2049  rder;..        I
+000119f0: 6620 7333 5f75 726c 2069 7320 6120 6669  f s3_url is a fi
+00011a00: 6c65 2070 6174 682c 2072 6574 7572 6e20  le path, return 
+00011a10: 616e 2065 6d70 7479 2067 656e 6572 6174  an empty generat
+00011a20: 6f72 0a20 2020 2020 2020 2049 6620 7333  or.        If s3
+00011a30: 5f75 726c 2069 7320 6120 6e6f 6e2d 6578  _url is a non-ex
+00011a40: 6973 7465 6e74 2070 6174 682c 2072 6574  istent path, ret
+00011a50: 7572 6e20 616e 2065 6d70 7479 2067 656e  urn an empty gen
+00011a60: 6572 6174 6f72 0a20 2020 2020 2020 2049  erator.        I
+00011a70: 6620 7333 5f75 726c 2069 7320 6120 6275  f s3_url is a bu
+00011a80: 636b 6574 2070 6174 682c 2062 7563 6b65  cket path, bucke
+00011a90: 7420 7769 6c6c 2062 6520 7468 6520 746f  t will be the to
+00011aa0: 7020 6469 7265 6374 6f72 792c 2061 6e64  p directory, and
+00011ab0: 2077 696c 6c20 6265 2072 6574 7572 6e65   will be returne
+00011ac0: 6420 6174 2066 6972 7374 2069 7465 7261  d at first itera
+00011ad0: 7469 6f6e 206f 6620 6765 6e65 7261 746f  tion of generato
+00011ae0: 720a 2020 2020 2020 2020 4966 2073 335f  r.        If s3_
+00011af0: 7572 6c20 6973 2061 6e20 656d 7074 7920  url is an empty 
+00011b00: 6275 636b 6574 2c20 6f6e 6c79 2079 6965  bucket, only yie
+00011b10: 6c64 206f 6e65 2033 2d74 7570 6c65 2028  ld one 3-tuple (
+00011b20: 6e6f 7465 733a 2073 3320 646f 6573 6e27  notes: s3 doesn'
+00011b30: 7420 6861 7665 2065 6d70 7479 2064 6972  t have empty dir
+00011b40: 6563 746f 7279 290a 2020 2020 2020 2020  ectory).        
+00011b50: 4966 2073 335f 7572 6c20 646f 6573 6e27  If s3_url doesn'
+00011b60: 7420 636f 6e74 6169 6e20 616e 7920 6275  t contain any bu
+00011b70: 636b 6574 2c20 7768 6963 6820 6973 2073  cket, which is s
+00011b80: 335f 7572 6c20 3d3d 2027 7333 3a2f 2f27  3_url == 's3://'
+00011b90: 2c20 7261 6973 6520 556e 7375 7070 6f72  , raise Unsuppor
+00011ba0: 7465 6445 7272 6f72 2e20 7761 6c6b 2829  tedError. walk()
+00011bb0: 206f 6e20 636f 6d70 6c65 7465 2073 3320   on complete s3 
+00011bc0: 6973 206e 6f74 2073 7570 706f 7274 6564  is not supported
+00011bd0: 2069 6e20 6d65 6766 696c 650a 0a20 2020   in megfile..   
+00011be0: 2020 2020 203a 7061 7261 6d20 666f 6c6c       :param foll
+00011bf0: 6f77 6c69 6e6b 733a 2077 6865 7468 6572  owlinks: whether
+00011c00: 2066 6f6c 6c6f 776c 696e 6b73 2069 7320   followlinks is 
+00011c10: 5472 7565 206f 7220 4661 6c73 652c 2072  True or False, r
+00011c20: 6573 756c 7420 6973 2074 6865 2073 616d  esult is the sam
+00011c30: 652e 2042 6563 6175 7365 2073 3320 7379  e. Because s3 sy
+00011c40: 6d6c 696e 6b20 6e6f 7420 7375 7070 6f72  mlink not suppor
+00011c50: 7420 6469 722e 0a20 2020 2020 2020 203a  t dir..        :
+00011c60: 7261 6973 6573 3a20 556e 7375 7070 6f72  raises: Unsuppor
+00011c70: 7465 6445 7272 6f72 0a20 2020 2020 2020  tedError.       
+00011c80: 203a 7265 7475 726e 733a 2041 2033 2d74   :returns: A 3-t
+00011c90: 7570 6c65 2067 656e 6572 6174 6f72 0a20  uple generator. 
+00011ca0: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+00011cb0: 2020 2062 7563 6b65 742c 206b 6579 203d     bucket, key =
+00011cc0: 2070 6172 7365 5f73 335f 7572 6c28 7365   parse_s3_url(se
+00011cd0: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
+00011ce0: 746f 636f 6c29 0a20 2020 2020 2020 2069  tocol).        i
+00011cf0: 6620 6e6f 7420 6275 636b 6574 3a0a 2020  f not bucket:.  
+00011d00: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00011d10: 556e 7375 7070 6f72 7465 6445 7272 6f72  UnsupportedError
+00011d20: 2827 5761 6c6b 2077 686f 6c65 2073 3327  ('Walk whole s3'
+00011d30: 2c20 7365 6c66 2e70 6174 685f 7769 7468  , self.path_with
+00011d40: 5f70 726f 746f 636f 6c29 0a0a 2020 2020  _protocol)..    
+00011d50: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+00011d60: 6973 5f64 6972 2829 3a0a 2020 2020 2020  is_dir():.      
+00011d70: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+00011d80: 2020 2020 2020 7374 6163 6b20 3d20 5b6b        stack = [k
+00011d90: 6579 5d0a 2020 2020 2020 2020 636c 6965  ey].        clie
+00011da0: 6e74 203d 2073 656c 662e 5f63 6c69 656e  nt = self._clien
+00011db0: 740a 2020 2020 2020 2020 7768 696c 6520  t.        while 
+00011dc0: 6c65 6e28 7374 6163 6b29 203e 2030 3a0a  len(stack) > 0:.
+00011dd0: 2020 2020 2020 2020 2020 2020 6375 7272              curr
+00011de0: 656e 7420 3d20 5f62 6563 6f6d 655f 7072  ent = _become_pr
+00011df0: 6566 6978 2873 7461 636b 2e70 6f70 2829  efix(stack.pop()
+00011e00: 290a 2020 2020 2020 2020 2020 2020 6469  ).            di
+00011e10: 7273 2c20 6669 6c65 7320 3d20 5b5d 2c20  rs, files = [], 
+00011e20: 5b5d 0a20 2020 2020 2020 2020 2020 2066  [].            f
+00011e30: 6f72 2072 6573 7020 696e 205f 6c69 7374  or resp in _list
+00011e40: 5f6f 626a 6563 7473 5f72 6563 7572 7369  _objects_recursi
+00011e50: 7665 2863 6c69 656e 742c 2062 7563 6b65  ve(client, bucke
+00011e60: 742c 2063 7572 7265 6e74 2c20 272f 2729  t, current, '/')
+00011e70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00011e80: 2020 666f 7220 636f 6d6d 6f6e 5f70 7265    for common_pre
+00011e90: 6669 7820 696e 2072 6573 702e 6765 7428  fix in resp.get(
+00011ea0: 2743 6f6d 6d6f 6e50 7265 6669 7865 7327  'CommonPrefixes'
+00011eb0: 2c20 5b5d 293a 0a20 2020 2020 2020 2020  , []):.         
+00011ec0: 2020 2020 2020 2020 2020 2064 6972 732e             dirs.
+00011ed0: 6170 7065 6e64 2863 6f6d 6d6f 6e5f 7072  append(common_pr
+00011ee0: 6566 6978 5b27 5072 6566 6978 275d 5b3a  efix['Prefix'][:
+00011ef0: 2d31 5d29 0a20 2020 2020 2020 2020 2020  -1]).           
+00011f00: 2020 2020 2066 6f72 2063 6f6e 7465 6e74       for content
+00011f10: 2069 6e20 7265 7370 2e67 6574 2827 436f   in resp.get('Co
+00011f20: 6e74 656e 7473 272c 205b 5d29 3a0a 2020  ntents', []):.  
+00011f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f40: 2020 6669 6c65 732e 6170 7065 6e64 2863    files.append(c
+00011f50: 6f6e 7465 6e74 5b27 4b65 7927 5d29 0a0a  ontent['Key'])..
+00011f60: 2020 2020 2020 2020 2020 2020 6469 7273              dirs
+00011f70: 203d 2073 6f72 7465 6428 6469 7273 290a   = sorted(dirs).
+00011f80: 2020 2020 2020 2020 2020 2020 7374 6163              stac
+00011f90: 6b2e 6578 7465 6e64 2872 6576 6572 7365  k.extend(reverse
+00011fa0: 6428 6469 7273 2929 0a0a 2020 2020 2020  d(dirs))..      
+00011fb0: 2020 2020 2020 726f 6f74 203d 2073 335f        root = s3_
+00011fc0: 7061 7468 5f6a 6f69 6e28 0a20 2020 2020  path_join(.     
+00011fd0: 2020 2020 2020 2020 2020 2066 277b 7365             f'{se
+00011fe0: 6c66 2e5f 7072 6f74 6f63 6f6c 5f77 6974  lf._protocol_wit
+00011ff0: 685f 7072 6f66 696c 657d 3a2f 2f27 2c20  h_profile}://', 
+00012000: 6275 636b 6574 2c20 6375 7272 656e 7429  bucket, current)
+00012010: 5b3a 2d31 5d0a 2020 2020 2020 2020 2020  [:-1].          
+00012020: 2020 6469 7273 203d 205b 7061 7468 5b6c    dirs = [path[l
+00012030: 656e 2863 7572 7265 6e74 293a 5d20 666f  en(current):] fo
+00012040: 7220 7061 7468 2069 6e20 6469 7273 5d0a  r path in dirs].
+00012050: 2020 2020 2020 2020 2020 2020 6669 6c65              file
+00012060: 7320 3d20 736f 7274 6564 2870 6174 685b  s = sorted(path[
+00012070: 6c65 6e28 6375 7272 656e 7429 3a5d 2066  len(current):] f
+00012080: 6f72 2070 6174 6820 696e 2066 696c 6573  or path in files
+00012090: 290a 2020 2020 2020 2020 2020 2020 7969  ).            yi
+000120a0: 656c 6420 726f 6f74 2c20 6469 7273 2c20  eld root, dirs, 
+000120b0: 6669 6c65 730a 0a20 2020 2064 6566 206d  files..    def m
+000120c0: 6435 2873 656c 662c 2072 6563 616c 6375  d5(self, recalcu
+000120d0: 6c61 7465 3a20 626f 6f6c 203d 2046 616c  late: bool = Fal
+000120e0: 7365 2c20 666f 6c6c 6f77 6c69 6e6b 733a  se, followlinks:
+000120f0: 2062 6f6f 6c20 3d20 4661 6c73 6529 202d   bool = False) -
+00012100: 3e20 7374 723a 0a20 2020 2020 2020 2027  > str:.        '
+00012110: 2727 0a20 2020 2020 2020 2047 6574 206d  ''.        Get m
+00012120: 6435 206d 6574 6120 696e 666f 2069 6e20  d5 meta info in 
+00012130: 6669 6c65 7320 7468 6174 2075 706c 6f61  files that uploa
+00012140: 6465 642f 636f 7069 6564 2076 6961 206d  ded/copied via m
+00012150: 6567 6669 6c65 0a0a 2020 2020 2020 2020  egfile..        
+00012160: 4966 206d 6574 6120 696e 666f 2069 7320  If meta info is 
+00012170: 6c6f 7374 206f 7220 6e6f 6e2d 6578 6973  lost or non-exis
+00012180: 7465 6e74 2c20 7265 7475 726e 204e 6f6e  tent, return Non
+00012190: 650a 0a20 2020 2020 2020 203a 7061 7261  e..        :para
+000121a0: 6d20 7265 6361 6c63 756c 6174 653a 2063  m recalculate: c
+000121b0: 616c 6375 6c61 7465 206d 6435 2069 6e20  alculate md5 in 
+000121c0: 7265 616c 2d74 696d 6520 6f72 2072 6574  real-time or ret
+000121d0: 7572 6e20 7333 2065 7461 670a 2020 2020  urn s3 etag.    
+000121e0: 2020 2020 3a70 6172 616d 2066 6f6c 6c6f      :param follo
+000121f0: 776c 696e 6b73 3a20 4966 2069 7320 5472  wlinks: If is Tr
+00012200: 7565 2c20 6361 6c63 756c 6174 6520 6d64  ue, calculate md
+00012210: 3520 666f 7220 7265 616c 2066 696c 650a  5 for real file.
+00012220: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
+00012230: 3a20 6d64 3520 6d65 7461 2069 6e66 6f0a  : md5 meta info.
+00012240: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+00012250: 2020 2020 6275 636b 6574 2c20 5f20 3d20      bucket, _ = 
+00012260: 7061 7273 655f 7333 5f75 726c 2873 656c  parse_s3_url(sel
+00012270: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
+00012280: 6f63 6f6c 290a 2020 2020 2020 2020 6966  ocol).        if
+00012290: 206e 6f74 2062 7563 6b65 743a 0a20 2020   not bucket:.   
+000122a0: 2020 2020 2020 2020 2072 6169 7365 2053           raise S
+000122b0: 3342 7563 6b65 744e 6f74 466f 756e 6445  3BucketNotFoundE
+000122c0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+000122d0: 2020 2020 2020 2745 6d70 7479 2062 7563        'Empty buc
+000122e0: 6b65 7420 6e61 6d65 3a20 2572 2720 2520  ket name: %r' % 
+000122f0: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
+00012300: 726f 746f 636f 6c29 0a20 2020 2020 2020  rotocol).       
+00012310: 2073 7461 7420 3d20 7365 6c66 2e73 7461   stat = self.sta
+00012320: 7428 666f 6c6c 6f77 5f73 796d 6c69 6e6b  t(follow_symlink
+00012330: 733d 666f 6c6c 6f77 6c69 6e6b 7329 0a20  s=followlinks). 
+00012340: 2020 2020 2020 2069 6620 7374 6174 2e69         if stat.i
+00012350: 7364 6972 3a0a 2020 2020 2020 2020 2020  sdir:.          
+00012360: 2020 6861 7368 5f6d 6435 203d 2068 6173    hash_md5 = has
+00012370: 686c 6962 2e6d 6435 2829 2020 2320 6e6f  hlib.md5()  # no
+00012380: 7365 630a 2020 2020 2020 2020 2020 2020  sec.            
+00012390: 666f 7220 6669 6c65 5f6e 616d 6520 696e  for file_name in
+000123a0: 2073 656c 662e 6c69 7374 6469 7228 293a   self.listdir():
+000123b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000123c0: 2063 6875 6e6b 203d 2053 3350 6174 6828   chunk = S3Path(
+000123d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000123e0: 2020 2020 2073 335f 7061 7468 5f6a 6f69       s3_path_joi
+000123f0: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+00012400: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00012410: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
+00012420: 6f6c 2c0a 2020 2020 2020 2020 2020 2020  ol,.            
+00012430: 2020 2020 2020 2020 2020 2020 6669 6c65              file
+00012440: 5f6e 616d 6529 292e 6d64 3528 7265 6361  _name)).md5(reca
+00012450: 6c63 756c 6174 653d 7265 6361 6c63 756c  lculate=recalcul
+00012460: 6174 6529 2e65 6e63 6f64 6528 290a 2020  ate).encode().  
+00012470: 2020 2020 2020 2020 2020 2020 2020 6861                ha
+00012480: 7368 5f6d 6435 2e75 7064 6174 6528 6368  sh_md5.update(ch
+00012490: 756e 6b29 0a20 2020 2020 2020 2020 2020  unk).           
+000124a0: 2072 6574 7572 6e20 6861 7368 5f6d 6435   return hash_md5
+000124b0: 2e68 6578 6469 6765 7374 2829 0a20 2020  .hexdigest().   
+000124c0: 2020 2020 2069 6620 7265 6361 6c63 756c       if recalcul
+000124d0: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
+000124e0: 2070 6174 685f 696e 7374 616e 6365 203d   path_instance =
+000124f0: 2073 656c 660a 2020 2020 2020 2020 2020   self.          
+00012500: 2020 6966 2066 6f6c 6c6f 776c 696e 6b73    if followlinks
+00012510: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00012520: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00012530: 2020 2020 2020 2020 2020 2070 6174 685f             path_
+00012540: 696e 7374 616e 6365 203d 2073 656c 662e  instance = self.
+00012550: 7265 6164 6c69 6e6b 2829 0a20 2020 2020  readlink().     
+00012560: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00012570: 7420 5333 4e6f 7441 4c69 6e6b 4572 726f  t S3NotALinkErro
+00012580: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+00012590: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
+000125a0: 2020 2020 2020 2020 7769 7468 2070 6174          with pat
+000125b0: 685f 696e 7374 616e 6365 2e6f 7065 6e28  h_instance.open(
+000125c0: 2772 6227 2920 6173 2066 3a0a 2020 2020  'rb') as f:.    
+000125d0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000125e0: 726e 2063 616c 6375 6c61 7465 5f6d 6435  rn calculate_md5
+000125f0: 2866 290a 2020 2020 2020 2020 7265 7475  (f).        retu
+00012600: 726e 2073 7461 742e 6578 7472 612e 6765  rn stat.extra.ge
+00012610: 7428 2745 5461 6727 2c20 2727 295b 313a  t('ETag', '')[1:
+00012620: 2d31 5d0a 0a20 2020 2064 6566 2063 6f70  -1]..    def cop
+00012630: 7928 0a20 2020 2020 2020 2020 2020 2073  y(.            s
+00012640: 656c 662c 0a20 2020 2020 2020 2020 2020  elf,.           
+00012650: 2064 7374 5f75 726c 3a20 5061 7468 4c69   dst_url: PathLi
+00012660: 6b65 2c0a 2020 2020 2020 2020 2020 2020  ke,.            
+00012670: 666f 6c6c 6f77 6c69 6e6b 733a 2062 6f6f  followlinks: boo
+00012680: 6c20 3d20 4661 6c73 652c 0a20 2020 2020  l = False,.     
+00012690: 2020 2020 2020 2063 616c 6c62 6163 6b3a         callback:
+000126a0: 204f 7074 696f 6e61 6c5b 4361 6c6c 6162   Optional[Callab
+000126b0: 6c65 5b5b 696e 745d 2c20 4e6f 6e65 5d5d  le[[int], None]]
+000126c0: 203d 204e 6f6e 6529 202d 3e20 4e6f 6e65   = None) -> None
+000126d0: 3a0a 2020 2020 2020 2020 2727 2720 4669  :.        ''' Fi
+000126e0: 6c65 2063 6f70 7920 6f6e 2053 330a 2020  le copy on S3.  
+000126f0: 2020 2020 2020 436f 7079 2063 6f6e 7465        Copy conte
+00012700: 6e74 206f 6620 6669 6c65 206f 6e20 6073  nt of file on `s
+00012710: 7263 5f70 6174 6860 2074 6f20 6064 7374  rc_path` to `dst
+00012720: 5f70 6174 6860 2e0a 2020 2020 2020 2020  _path`..        
+00012730: 4974 2773 2063 616c 6c65 7227 7320 7265  It's caller's re
+00012740: 7370 6f6e 7365 6269 6c69 7479 2074 6f20  sponsebility to 
+00012750: 656e 7375 7265 2074 6865 2073 335f 6973  ensure the s3_is
+00012760: 6669 6c65 2873 7263 5f75 726c 2920 3d3d  file(src_url) ==
+00012770: 2054 7275 650a 0a20 2020 2020 2020 203a   True..        :
+00012780: 7061 7261 6d20 6473 745f 7061 7468 3a20  param dst_path: 
+00012790: 5461 7267 6574 2066 696c 6520 7061 7468  Target file path
+000127a0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+000127b0: 6361 6c6c 6261 636b 3a20 4361 6c6c 6564  callback: Called
+000127c0: 2070 6572 696f 6469 6361 6c6c 7920 6475   periodically du
+000127d0: 7269 6e67 2063 6f70 792c 2061 6e64 2074  ring copy, and t
+000127e0: 6865 2069 6e70 7574 2070 6172 616d 6574  he input paramet
+000127f0: 6572 2069 7320 7468 6520 6461 7461 2073  er is the data s
+00012800: 697a 6520 2869 6e20 6279 7465 7329 206f  ize (in bytes) o
+00012810: 6620 636f 7079 2073 696e 6365 2074 6865  f copy since the
+00012820: 206c 6173 7420 6361 6c6c 0a20 2020 2020   last call.     
+00012830: 2020 2027 2727 0a20 2020 2020 2020 2073     '''.        s
+00012840: 7263 5f75 726c 203d 2073 656c 662e 7061  rc_url = self.pa
+00012850: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
+00012860: 0a20 2020 2020 2020 2073 7263 5f62 7563  .        src_buc
+00012870: 6b65 742c 2073 7263 5f6b 6579 203d 2070  ket, src_key = p
+00012880: 6172 7365 5f73 335f 7572 6c28 7372 635f  arse_s3_url(src_
+00012890: 7572 6c29 0a20 2020 2020 2020 2064 7374  url).        dst
+000128a0: 5f62 7563 6b65 742c 2064 7374 5f6b 6579  _bucket, dst_key
+000128b0: 203d 2070 6172 7365 5f73 335f 7572 6c28   = parse_s3_url(
+000128c0: 6473 745f 7572 6c29 0a0a 2020 2020 2020  dst_url)..      
+000128d0: 2020 6966 206e 6f74 2073 7263 5f62 7563    if not src_buc
+000128e0: 6b65 743a 0a20 2020 2020 2020 2020 2020  ket:.           
+000128f0: 2072 6169 7365 2053 3342 7563 6b65 744e   raise S3BucketN
+00012900: 6f74 466f 756e 6445 7272 6f72 2827 456d  otFoundError('Em
+00012910: 7074 7920 6275 636b 6574 206e 616d 653a  pty bucket name:
+00012920: 2025 7227 2025 2073 7263 5f75 726c 290a   %r' % src_url).
+00012930: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00012940: 6973 5f64 6972 2829 3a0a 2020 2020 2020  is_dir():.      
+00012950: 2020 2020 2020 7261 6973 6520 5333 4973        raise S3Is
+00012960: 4144 6972 6563 746f 7279 4572 726f 7228  ADirectoryError(
+00012970: 2749 7320 6120 6469 7265 6374 6f72 793a  'Is a directory:
+00012980: 2025 7227 2025 2073 7263 5f75 726c 290a   %r' % src_url).
+00012990: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+000129a0: 6473 745f 6275 636b 6574 3a0a 2020 2020  dst_bucket:.    
+000129b0: 2020 2020 2020 2020 7261 6973 6520 5333          raise S3
+000129c0: 4275 636b 6574 4e6f 7446 6f75 6e64 4572  BucketNotFoundEr
+000129d0: 726f 7228 2745 6d70 7479 2062 7563 6b65  ror('Empty bucke
+000129e0: 7420 6e61 6d65 3a20 2572 2720 2520 6473  t name: %r' % ds
+000129f0: 745f 7572 6c29 0a20 2020 2020 2020 2069  t_url).        i
+00012a00: 6620 6e6f 7420 6473 745f 6b65 7920 6f72  f not dst_key or
+00012a10: 2064 7374 5f6b 6579 2e65 6e64 7377 6974   dst_key.endswit
+00012a20: 6828 272f 2729 3a0a 2020 2020 2020 2020  h('/'):.        
+00012a30: 2020 2020 7261 6973 6520 5333 4973 4144      raise S3IsAD
+00012a40: 6972 6563 746f 7279 4572 726f 7228 2749  irectoryError('I
+00012a50: 7320 6120 6469 7265 6374 6f72 793a 2025  s a directory: %
+00012a60: 7227 2025 2064 7374 5f75 726c 290a 0a20  r' % dst_url).. 
+00012a70: 2020 2020 2020 2069 6620 666f 6c6c 6f77         if follow
+00012a80: 6c69 6e6b 733a 0a20 2020 2020 2020 2020  links:.         
+00012a90: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00012aa0: 2020 2020 2020 2020 7333 5f75 726c 203d          s3_url =
+00012ab0: 2073 656c 662e 7265 6164 6c69 6e6b 2829   self.readlink()
+00012ac0: 2e70 6174 680a 2020 2020 2020 2020 2020  .path.          
+00012ad0: 2020 2020 2020 7372 635f 6275 636b 6574        src_bucket
+00012ae0: 2c20 7372 635f 6b65 7920 3d20 7061 7273  , src_key = pars
+00012af0: 655f 7333 5f75 726c 2873 335f 7572 6c29  e_s3_url(s3_url)
+00012b00: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+00012b10: 6570 7420 5333 4e6f 7441 4c69 6e6b 4572  ept S3NotALinkEr
+00012b20: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+00012b30: 2020 2020 2070 6173 730a 0a20 2020 2020       pass..     
+00012b40: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00012b50: 2020 2020 7365 6c66 2e5f 636c 6965 6e74      self._client
+00012b60: 2e63 6f70 7928 0a20 2020 2020 2020 2020  .copy(.         
+00012b70: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00012b80: 2020 2020 2020 2020 2020 2020 2027 4275               'Bu
+00012b90: 636b 6574 273a 2073 7263 5f62 7563 6b65  cket': src_bucke
+00012ba0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+00012bb0: 2020 2020 2020 2027 4b65 7927 3a20 7372         'Key': sr
+00012bc0: 635f 6b65 792c 0a20 2020 2020 2020 2020  c_key,.         
+00012bd0: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+00012be0: 2020 2020 2020 2020 2020 4275 636b 6574            Bucket
+00012bf0: 3d64 7374 5f62 7563 6b65 742c 0a20 2020  =dst_bucket,.   
+00012c00: 2020 2020 2020 2020 2020 2020 204b 6579               Key
+00012c10: 3d64 7374 5f6b 6579 2c0a 2020 2020 2020  =dst_key,.      
+00012c20: 2020 2020 2020 2020 2020 4361 6c6c 6261            Callba
+00012c30: 636b 3d63 616c 6c62 6163 6b29 0a20 2020  ck=callback).   
+00012c40: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
+00012c50: 7074 696f 6e20 6173 2065 7272 6f72 3a0a  ption as error:.
+00012c60: 2020 2020 2020 2020 2020 2020 6572 726f              erro
+00012c70: 7220 3d20 7472 616e 736c 6174 655f 7333  r = translate_s3
+00012c80: 5f65 7272 6f72 2865 7272 6f72 2c20 6473  _error(error, ds
+00012c90: 745f 7572 6c29 0a20 2020 2020 2020 2020  t_url).         
+00012ca0: 2020 2023 2045 7272 6f72 2063 616e 2774     # Error can't
+00012cb0: 2068 656c 7020 7465 6c6c 2077 6869 6368   help tell which
+00012cc0: 2069 7320 7072 6f62 6c65 6d61 7469 630a   is problematic.
+00012cd0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+00012ce0: 7369 6e73 7461 6e63 6528 6572 726f 722c  sinstance(error,
+00012cf0: 2053 3342 7563 6b65 744e 6f74 466f 756e   S3BucketNotFoun
+00012d00: 6445 7272 6f72 293a 0a20 2020 2020 2020  dError):.       
+00012d10: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00012d20: 7365 6c66 2e68 6173 6275 636b 6574 2829  self.hasbucket()
+00012d30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00012d40: 2020 2020 2020 7261 6973 6520 5333 4275        raise S3Bu
+00012d50: 636b 6574 4e6f 7446 6f75 6e64 4572 726f  cketNotFoundErro
+00012d60: 7228 274e 6f20 7375 6368 2062 7563 6b65  r('No such bucke
+00012d70: 743a 2025 7227 2025 2073 7263 5f75 726c  t: %r' % src_url
+00012d80: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00012d90: 6966 2069 7369 6e73 7461 6e63 6528 6572  if isinstance(er
+00012da0: 726f 722c 2053 3346 696c 654e 6f74 466f  ror, S3FileNotFo
+00012db0: 756e 6445 7272 6f72 293a 0a20 2020 2020  undError):.     
+00012dc0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00012dd0: 7420 7365 6c66 2e69 735f 6669 6c65 2829  t self.is_file()
+00012de0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00012df0: 2020 2020 2020 7261 6973 6520 5333 4669        raise S3Fi
+00012e00: 6c65 4e6f 7446 6f75 6e64 4572 726f 7228  leNotFoundError(
+00012e10: 274e 6f20 7375 6368 2066 696c 653a 2025  'No such file: %
+00012e20: 7227 2025 2073 7263 5f75 726c 290a 2020  r' % src_url).  
+00012e30: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00012e40: 6572 726f 720a 0a20 2020 2064 6566 2073  error..    def s
+00012e50: 796e 6328 7365 6c66 2c20 6473 745f 7572  ync(self, dst_ur
+00012e60: 6c3a 2050 6174 684c 696b 652c 2066 6f6c  l: PathLike, fol
+00012e70: 6c6f 776c 696e 6b73 3a20 626f 6f6c 203d  lowlinks: bool =
+00012e80: 2046 616c 7365 2920 2d3e 204e 6f6e 653a   False) -> None:
+00012e90: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
+00012ea0: 2020 2020 2043 6f70 7920 6669 6c65 2f64       Copy file/d
+00012eb0: 6972 6563 746f 7279 206f 6e20 7372 635f  irectory on src_
+00012ec0: 7572 6c20 746f 2064 7374 5f75 726c 0a0a  url to dst_url..
+00012ed0: 2020 2020 2020 2020 3a70 6172 616d 2064          :param d
+00012ee0: 7374 5f75 726c 3a20 4769 7665 6e20 6465  st_url: Given de
+00012ef0: 7374 696e 6174 696f 6e20 7061 7468 0a20  stination path. 
+00012f00: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+00012f10: 2020 2066 6f72 2073 7263 5f66 696c 655f     for src_file_
+00012f20: 7061 7468 2c20 6473 745f 6669 6c65 5f70  path, dst_file_p
+00012f30: 6174 6820 696e 205f 7333 5f73 6361 6e5f  ath in _s3_scan_
+00012f40: 7061 6972 7328 0a20 2020 2020 2020 2020  pairs(.         
+00012f50: 2020 2020 2020 2073 656c 662e 7061 7468         self.path
+00012f60: 5f77 6974 685f 7072 6f74 6f63 6f6c 2c20  _with_protocol, 
+00012f70: 6473 745f 7572 6c29 3a0a 2020 2020 2020  dst_url):.      
+00012f80: 2020 2020 2020 5333 5061 7468 2873 7263        S3Path(src
+00012f90: 5f66 696c 655f 7061 7468 292e 636f 7079  _file_path).copy
+00012fa0: 2864 7374 5f66 696c 655f 7061 7468 2c20  (dst_file_path, 
+00012fb0: 666f 6c6c 6f77 6c69 6e6b 733d 666f 6c6c  followlinks=foll
+00012fc0: 6f77 6c69 6e6b 7329 0a0a 2020 2020 6465  owlinks)..    de
+00012fd0: 6620 7379 6d6c 696e 6b28 7365 6c66 2c20  f symlink(self, 
+00012fe0: 6473 745f 7061 7468 3a20 5061 7468 4c69  dst_path: PathLi
+00012ff0: 6b65 2920 2d3e 204e 6f6e 653a 0a20 2020  ke) -> None:.   
+00013000: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
+00013010: 2043 7265 6174 6520 6120 7379 6d62 6f6c   Create a symbol
+00013020: 6963 206c 696e 6b20 706f 696e 7469 6e67  ic link pointing
+00013030: 2074 6f20 7372 635f 7061 7468 206e 616d   to src_path nam
+00013040: 6564 2064 7374 5f70 6174 682e 0a0a 2020  ed dst_path...  
+00013050: 2020 2020 2020 3a70 6172 616d 2064 7374        :param dst
+00013060: 5f70 6174 683a 2044 6573 696e 6174 696f  _path: Desinatio
+00013070: 6e20 7061 7468 0a20 2020 2020 2020 203a  n path.        :
+00013080: 7261 6973 6573 3a20 5333 4e61 6d65 546f  raises: S3NameTo
+00013090: 6f4c 6f6e 6745 7272 6f72 2c20 5333 4275  oLongError, S3Bu
+000130a0: 636b 6574 4e6f 7446 6f75 6e64 4572 726f  cketNotFoundErro
+000130b0: 722c 2053 3349 7341 4469 7265 6374 6f72  r, S3IsADirector
+000130c0: 7945 7272 6f72 0a20 2020 2020 2020 2027  yError.        '
+000130d0: 2727 0a20 2020 2020 2020 2069 6620 6c65  ''.        if le
+000130e0: 6e28 7374 7228 7365 6c66 2e5f 7333 5f70  n(str(self._s3_p
+000130f0: 6174 6829 2e65 6e63 6f64 6528 2929 203e  ath).encode()) >
+00013100: 2031 3032 343a 0a20 2020 2020 2020 2020   1024:.         
+00013110: 2020 2072 6169 7365 2053 334e 616d 6554     raise S3NameT
+00013120: 6f6f 4c6f 6e67 4572 726f 7228 2746 696c  ooLongError('Fil
+00013130: 6520 6e61 6d65 2074 6f6f 206c 6f6e 673a  e name too long:
+00013140: 2025 7227 2025 2064 7374 5f70 6174 6829   %r' % dst_path)
+00013150: 0a20 2020 2020 2020 2073 7263 5f62 7563  .        src_buc
+00013160: 6b65 742c 2073 7263 5f6b 6579 203d 2070  ket, src_key = p
+00013170: 6172 7365 5f73 335f 7572 6c28 7365 6c66  arse_s3_url(self
+00013180: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+00013190: 636f 6c29 0a20 2020 2020 2020 2064 7374  col).        dst
+000131a0: 5f62 7563 6b65 742c 2064 7374 5f6b 6579  _bucket, dst_key
+000131b0: 203d 2070 6172 7365 5f73 335f 7572 6c28   = parse_s3_url(
+000131c0: 6473 745f 7061 7468 290a 0a20 2020 2020  dst_path)..     
+000131d0: 2020 2069 6620 6e6f 7420 7372 635f 6275     if not src_bu
+000131e0: 636b 6574 3a0a 2020 2020 2020 2020 2020  cket:.          
+000131f0: 2020 7261 6973 6520 5333 4275 636b 6574    raise S3Bucket
+00013200: 4e6f 7446 6f75 6e64 4572 726f 7228 2745  NotFoundError('E
+00013210: 6d70 7479 2062 7563 6b65 7420 6e61 6d65  mpty bucket name
+00013220: 3a20 2572 2720 2520 7365 6c66 2e70 6174  : %r' % self.pat
+00013230: 6829 0a20 2020 2020 2020 2069 6620 6e6f  h).        if no
+00013240: 7420 6473 745f 6275 636b 6574 3a0a 2020  t dst_bucket:.  
+00013250: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00013260: 5333 4275 636b 6574 4e6f 7446 6f75 6e64  S3BucketNotFound
+00013270: 4572 726f 7228 2745 6d70 7479 2062 7563  Error('Empty buc
+00013280: 6b65 7420 6e61 6d65 3a20 2572 2720 2520  ket name: %r' % 
+00013290: 6473 745f 7061 7468 290a 2020 2020 2020  dst_path).      
+000132a0: 2020 6966 206e 6f74 2064 7374 5f6b 6579    if not dst_key
+000132b0: 206f 7220 6473 745f 6b65 792e 656e 6473   or dst_key.ends
+000132c0: 7769 7468 2827 2f27 293a 0a20 2020 2020  with('/'):.     
+000132d0: 2020 2020 2020 2072 6169 7365 2053 3349         raise S3I
+000132e0: 7341 4469 7265 6374 6f72 7945 7272 6f72  sADirectoryError
+000132f0: 2827 4973 2061 2064 6972 6563 746f 7279  ('Is a directory
+00013300: 3a20 2572 2720 2520 6473 745f 7061 7468  : %r' % dst_path
+00013310: 290a 0a20 2020 2020 2020 2073 7263 5f70  )..        src_p
+00013320: 6174 6820 3d20 7365 6c66 2e5f 7333 5f70  ath = self._s3_p
+00013330: 6174 680a 2020 2020 2020 2020 7472 793a  ath.        try:
+00013340: 0a20 2020 2020 2020 2020 2020 2073 7263  .            src
+00013350: 5f70 6174 6820 3d20 7365 6c66 2e72 6561  _path = self.rea
+00013360: 646c 696e 6b28 292e 5f73 335f 7061 7468  dlink()._s3_path
+00013370: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+00013380: 5333 4e6f 7441 4c69 6e6b 4572 726f 723a  S3NotALinkError:
+00013390: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
+000133a0: 730a 2020 2020 2020 2020 7769 7468 2072  s.        with r
+000133b0: 6169 7365 5f73 335f 6572 726f 7228 6473  aise_s3_error(ds
+000133c0: 745f 7061 7468 293a 0a20 2020 2020 2020  t_path):.       
+000133d0: 2020 2020 2073 656c 662e 5f63 6c69 656e       self._clien
+000133e0: 742e 7075 745f 6f62 6a65 6374 280a 2020  t.put_object(.  
+000133f0: 2020 2020 2020 2020 2020 2020 2020 4275                Bu
+00013400: 636b 6574 3d64 7374 5f62 7563 6b65 742c  cket=dst_bucket,
+00013410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013420: 204b 6579 3d64 7374 5f6b 6579 2c0a 2020   Key=dst_key,.  
+00013430: 2020 2020 2020 2020 2020 2020 2020 4d65                Me
+00013440: 7461 6461 7461 3d7b 2273 796d 6c69 6e6b  tadata={"symlink
+00013450: 5f74 6f22 3a20 7372 635f 7061 7468 7d29  _to": src_path})
+00013460: 0a0a 2020 2020 6465 6620 7265 6164 6c69  ..    def readli
+00013470: 6e6b 2873 656c 6629 202d 3e20 2753 3350  nk(self) -> 'S3P
+00013480: 6174 6827 3a0a 2020 2020 2020 2020 2727  ath':.        ''
+00013490: 270a 2020 2020 2020 2020 5265 7475 726e  '.        Return
+000134a0: 2061 2053 3350 6174 6820 696e 7374 616e   a S3Path instan
+000134b0: 6365 2072 6570 7265 7365 6e74 696e 6720  ce representing 
+000134c0: 7468 6520 7061 7468 2074 6f20 7768 6963  the path to whic
+000134d0: 6820 7468 6520 7379 6d62 6f6c 6963 206c  h the symbolic l
+000134e0: 696e 6b20 706f 696e 7473 2e0a 0a20 2020  ink points...   
+000134f0: 2020 2020 203a 7265 7475 726e 733a 2052       :returns: R
+00013500: 6574 7572 6e20 6120 5333 5061 7468 2069  eturn a S3Path i
+00013510: 6e73 7461 6e63 6520 7265 7072 6573 656e  nstance represen
+00013520: 7469 6e67 2074 6865 2070 6174 6820 746f  ting the path to
+00013530: 2077 6869 6368 2074 6865 2073 796d 626f   which the symbo
+00013540: 6c69 6320 6c69 6e6b 2070 6f69 6e74 732e  lic link points.
+00013550: 0a20 2020 2020 2020 203a 7261 6973 6573  .        :raises
+00013560: 3a20 5333 4e61 6d65 546f 6f4c 6f6e 6745  : S3NameTooLongE
+00013570: 7272 6f72 2c20 5333 4275 636b 6574 4e6f  rror, S3BucketNo
+00013580: 7446 6f75 6e64 4572 726f 722c 2053 3349  tFoundError, S3I
+00013590: 7341 4469 7265 6374 6f72 7945 7272 6f72  sADirectoryError
+000135a0: 2c20 5333 4e6f 7441 4c69 6e6b 4572 726f  , S3NotALinkErro
+000135b0: 720a 2020 2020 2020 2020 2727 270a 2020  r.        '''.  
+000135c0: 2020 2020 2020 6275 636b 6574 2c20 6b65        bucket, ke
+000135d0: 7920 3d20 7061 7273 655f 7333 5f75 726c  y = parse_s3_url
+000135e0: 2873 656c 662e 7061 7468 5f77 6974 685f  (self.path_with_
+000135f0: 7072 6f74 6f63 6f6c 290a 2020 2020 2020  protocol).      
+00013600: 2020 6966 206e 6f74 2062 7563 6b65 743a    if not bucket:
+00013610: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00013620: 7365 2053 3342 7563 6b65 744e 6f74 466f  se S3BucketNotFo
+00013630: 756e 6445 7272 6f72 280a 2020 2020 2020  undError(.      
+00013640: 2020 2020 2020 2020 2020 2745 6d70 7479            'Empty
+00013650: 2062 7563 6b65 7420 6e61 6d65 3a20 2572   bucket name: %r
+00013660: 2720 2520 7365 6c66 2e70 6174 685f 7769  ' % self.path_wi
+00013670: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
+00013680: 2020 2020 2069 6620 6e6f 7420 6b65 7920       if not key 
+00013690: 6f72 206b 6579 2e65 6e64 7377 6974 6828  or key.endswith(
+000136a0: 272f 2729 3a0a 2020 2020 2020 2020 2020  '/'):.          
+000136b0: 2020 7261 6973 6520 5333 4973 4144 6972    raise S3IsADir
+000136c0: 6563 746f 7279 4572 726f 7228 0a20 2020  ectoryError(.   
+000136d0: 2020 2020 2020 2020 2020 2020 2027 4973               'Is
+000136e0: 2061 2064 6972 6563 746f 7279 3a20 2572   a directory: %r
+000136f0: 2720 2520 7365 6c66 2e70 6174 685f 7769  ' % self.path_wi
+00013700: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
+00013710: 2020 2020 206d 6574 6164 6174 6120 3d20       metadata = 
+00013720: 7365 6c66 2e5f 7333 5f67 6574 5f6d 6574  self._s3_get_met
+00013730: 6164 6174 6128 290a 0a20 2020 2020 2020  adata()..       
+00013740: 2069 6620 6e6f 7420 2773 796d 6c69 6e6b   if not 'symlink
+00013750: 5f74 6f27 2069 6e20 6d65 7461 6461 7461  _to' in metadata
+00013760: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00013770: 6973 6520 5333 4e6f 7441 4c69 6e6b 4572  ise S3NotALinkEr
+00013780: 726f 7228 274e 6f74 2061 206c 696e 6b3a  ror('Not a link:
+00013790: 2025 7227 2025 2073 656c 662e 7061 7468   %r' % self.path
+000137a0: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
+000137b0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000137c0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000137d0: 2073 656c 662e 6672 6f6d 5f70 6174 6828   self.from_path(
+000137e0: 6d65 7461 6461 7461 5b27 7379 6d6c 696e  metadata['symlin
+000137f0: 6b5f 746f 275d 290a 0a20 2020 2064 6566  k_to'])..    def
+00013800: 2069 735f 7379 6d6c 696e 6b28 7365 6c66   is_symlink(self
+00013810: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
+00013820: 2020 2027 2727 0a20 2020 2020 2020 2054     '''.        T
+00013830: 6573 7420 7768 6574 6865 7220 6120 7061  est whether a pa
+00013840: 7468 2069 7320 6c69 6e6b 0a0a 2020 2020  th is link..    
+00013850: 2020 2020 3a72 6574 7572 6e73 3a20 5472      :returns: Tr
+00013860: 7565 2069 6620 6120 7061 7468 2069 7320  ue if a path is 
+00013870: 6c69 6e6b 2c20 656c 7365 2046 616c 7365  link, else False
+00013880: 0a20 2020 2020 2020 203a 7261 6973 6573  .        :raises
+00013890: 3a20 5333 4e6f 7441 4c69 6e6b 4572 726f  : S3NotALinkErro
+000138a0: 720a 2020 2020 2020 2020 2727 270a 2020  r.        '''.  
+000138b0: 2020 2020 2020 6275 636b 6574 2c20 6b65        bucket, ke
+000138c0: 7920 3d20 7061 7273 655f 7333 5f75 726c  y = parse_s3_url
+000138d0: 2873 656c 662e 7061 7468 5f77 6974 685f  (self.path_with_
+000138e0: 7072 6f74 6f63 6f6c 290a 2020 2020 2020  protocol).      
+000138f0: 2020 6966 206e 6f74 2062 7563 6b65 743a    if not bucket:
+00013900: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00013910: 7572 6e20 4661 6c73 650a 2020 2020 2020  urn False.      
+00013920: 2020 6966 206e 6f74 206b 6579 206f 7220    if not key or 
+00013930: 6b65 792e 656e 6473 7769 7468 2827 2f27  key.endswith('/'
+00013940: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+00013950: 6574 7572 6e20 4661 6c73 650a 2020 2020  eturn False.    
+00013960: 2020 2020 6d65 7461 6461 7461 203d 2073      metadata = s
+00013970: 656c 662e 5f73 335f 6765 745f 6d65 7461  elf._s3_get_meta
+00013980: 6461 7461 2829 0a20 2020 2020 2020 2072  data().        r
+00013990: 6574 7572 6e20 2773 796d 6c69 6e6b 5f74  eturn 'symlink_t
+000139a0: 6f27 2069 6e20 6d65 7461 6461 7461 0a0a  o' in metadata..
+000139b0: 2020 2020 6465 6620 7361 7665 2873 656c      def save(sel
+000139c0: 662c 2066 696c 655f 6f62 6a65 6374 3a20  f, file_object: 
+000139d0: 4269 6e61 7279 494f 293a 0a20 2020 2020  BinaryIO):.     
+000139e0: 2020 2027 2727 5772 6974 6520 7468 6520     '''Write the 
+000139f0: 6f70 656e 6564 2062 696e 6172 7920 7374  opened binary st
+00013a00: 7265 616d 2074 6f20 7370 6563 6966 6965  ream to specifie
+00013a10: 6420 7061 7468 2c20 6275 7420 7468 6520  d path, but the 
+00013a20: 7374 7265 616d 2077 6f6e 2774 2062 6520  stream won't be 
+00013a30: 636c 6f73 6564 0a0a 2020 2020 2020 2020  closed..        
+00013a40: 3a70 6172 616d 2066 696c 655f 6f62 6a65  :param file_obje
+00013a50: 6374 3a20 5374 7265 616d 2074 6f20 6265  ct: Stream to be
+00013a60: 2072 6561 640a 2020 2020 2020 2020 2727   read.        ''
+00013a70: 270a 2020 2020 2020 2020 6275 636b 6574  '.        bucket
+00013a80: 2c20 6b65 7920 3d20 7061 7273 655f 7333  , key = parse_s3
+00013a90: 5f75 726c 2873 656c 662e 7061 7468 5f77  _url(self.path_w
+00013aa0: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
+00013ab0: 2020 2020 2020 6966 206e 6f74 2062 7563        if not buc
+00013ac0: 6b65 743a 0a20 2020 2020 2020 2020 2020  ket:.           
+00013ad0: 2072 6169 7365 2053 3342 7563 6b65 744e   raise S3BucketN
+00013ae0: 6f74 466f 756e 6445 7272 6f72 280a 2020  otFoundError(.  
+00013af0: 2020 2020 2020 2020 2020 2020 2020 2745                'E
+00013b00: 6d70 7479 2062 7563 6b65 7420 6e61 6d65  mpty bucket name
+00013b10: 3a20 2572 2720 2520 7365 6c66 2e70 6174  : %r' % self.pat
+00013b20: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
+00013b30: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00013b40: 6b65 7920 6f72 206b 6579 2e65 6e64 7377  key or key.endsw
+00013b50: 6974 6828 272f 2729 3a0a 2020 2020 2020  ith('/'):.      
+00013b60: 2020 2020 2020 7261 6973 6520 5333 4973        raise S3Is
+00013b70: 4144 6972 6563 746f 7279 4572 726f 7228  ADirectoryError(
+00013b80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013b90: 2027 4973 2061 2064 6972 6563 746f 7279   'Is a directory
+00013ba0: 3a20 2572 2720 2520 7365 6c66 2e70 6174  : %r' % self.pat
+00013bb0: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
+00013bc0: 0a0a 2020 2020 2020 2020 7769 7468 2072  ..        with r
+00013bd0: 6169 7365 5f73 335f 6572 726f 7228 7365  aise_s3_error(se
+00013be0: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
+00013bf0: 746f 636f 6c29 3a0a 2020 2020 2020 2020  tocol):.        
+00013c00: 2020 2020 7365 6c66 2e5f 636c 6965 6e74      self._client
+00013c10: 2e75 706c 6f61 645f 6669 6c65 6f62 6a28  .upload_fileobj(
+00013c20: 6669 6c65 5f6f 626a 6563 742c 2042 7563  file_object, Buc
+00013c30: 6b65 743d 6275 636b 6574 2c20 4b65 793d  ket=bucket, Key=
+00013c40: 6b65 7929 0a0a 2020 2020 6465 6620 6f70  key)..    def op
+00013c50: 656e 280a 2020 2020 2020 2020 2020 2020  en(.            
+00013c60: 7365 6c66 2c0a 2020 2020 2020 2020 2020  self,.          
+00013c70: 2020 6d6f 6465 3a20 7374 7220 3d20 2772    mode: str = 'r
+00013c80: 272c 0a20 2020 2020 2020 2020 2020 202a  ',.            *
+00013c90: 2c0a 2020 2020 2020 2020 2020 2020 7333  ,.            s3
+00013ca0: 5f6f 7065 6e5f 6675 6e63 3a20 4361 6c6c  _open_func: Call
+00013cb0: 6162 6c65 5b5b 7374 722c 2073 7472 5d2c  able[[str, str],
+00013cc0: 2042 696e 6172 7949 4f5d 203d 2073 335f   BinaryIO] = s3_
+00013cd0: 6f70 656e 2c0a 2020 2020 2020 2020 2020  open,.          
+00013ce0: 2020 2a2a 6b77 6172 6773 2920 2d3e 2049    **kwargs) -> I
+00013cf0: 4f5b 416e 7953 7472 5d3a 0a20 2020 2020  O[AnyStr]:.     
+00013d00: 2020 2072 6574 7572 6e20 7333 5f6f 7065     return s3_ope
+00013d10: 6e5f 6675 6e63 280a 2020 2020 2020 2020  n_func(.        
+00013d20: 2020 2020 7365 6c66 2e70 6174 685f 7769      self.path_wi
+00013d30: 7468 5f70 726f 746f 636f 6c2c 206d 6f64  th_protocol, mod
+00013d40: 652c 0a20 2020 2020 2020 2020 2020 202a  e,.            *
+00013d50: 2a6e 6563 6573 7361 7279 5f70 6172 616d  *necessary_param
+00013d60: 7328 7333 5f6f 7065 6e5f 6675 6e63 2c20  s(s3_open_func, 
+00013d70: 2a2a 6b77 6172 6773 2929 0a0a 2020 2020  **kwargs))..    
+00013d80: 6465 6620 6162 736f 6c75 7465 2873 656c  def absolute(sel
+00013d90: 6629 202d 3e20 2753 3350 6174 6827 3a0a  f) -> 'S3Path':.
+00013da0: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+00013db0: 2020 2020 4d61 6b65 2074 6865 2070 6174      Make the pat
+00013dc0: 6820 6162 736f 6c75 7465 2c20 7769 7468  h absolute, with
+00013dd0: 6f75 7420 6e6f 726d 616c 697a 6174 696f  out normalizatio
+00013de0: 6e20 6f72 2072 6573 6f6c 7669 6e67 2073  n or resolving s
+00013df0: 796d 6c69 6e6b 732e 2052 6574 7572 6e73  ymlinks. Returns
+00013e00: 2061 206e 6577 2070 6174 6820 6f62 6a65   a new path obje
+00013e10: 6374 0a20 2020 2020 2020 2027 2727 0a20  ct.        '''. 
+00013e20: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00013e30: 6c66 0a0a 2020 2020 6465 6620 6377 6428  lf..    def cwd(
+00013e40: 7365 6c66 2920 2d3e 2027 5333 5061 7468  self) -> 'S3Path
+00013e50: 273a 0a20 2020 2020 2020 2027 2727 5265  ':.        '''Re
+00013e60: 7475 726e 2063 7572 7265 6e74 2077 6f72  turn current wor
+00013e70: 6b69 6e67 2064 6972 6563 746f 7279 0a0a  king directory..
+00013e80: 2020 2020 2020 2020 7265 7475 726e 733a          returns:
+00013e90: 2043 7572 7265 6e74 2077 6f72 6b69 6e67   Current working
+00013ea0: 2064 6972 6563 746f 7279 0a20 2020 2020   directory.     
+00013eb0: 2020 2027 2727 0a20 2020 2020 2020 2072     '''.        r
+00013ec0: 6574 7572 6e20 7365 6c66 2e66 726f 6d5f  eturn self.from_
+00013ed0: 7061 7468 2873 656c 662e 7061 7468 5f77  path(self.path_w
+00013ee0: 6974 685f 7072 6f74 6f63 6f6c 290a 0a0a  ith_protocol)...
+00013ef0: 636c 6173 7320 4d75 6c74 6950 6172 7457  class MultiPartW
+00013f00: 7269 7465 723a 0a0a 2020 2020 6465 6620  riter:..    def 
+00013f10: 5f5f 696e 6974 5f5f 2873 656c 662c 2063  __init__(self, c
+00013f20: 6c69 656e 742c 2070 6174 683a 2050 6174  lient, path: Pat
+00013f30: 684c 696b 6529 202d 3e20 4e6f 6e65 3a0a  hLike) -> None:.
+00013f40: 2020 2020 2020 2020 7365 6c66 2e5f 636c          self._cl
+00013f50: 6965 6e74 203d 2063 6c69 656e 740a 2020  ient = client.  
+00013f60: 2020 2020 2020 7365 6c66 2e5f 6d75 6c74        self._mult
+00013f70: 6970 6172 745f 7570 6c6f 6164 5f69 6e66  ipart_upload_inf
+00013f80: 6f20 3d20 5b5d 0a0a 2020 2020 2020 2020  o = []..        
+00013f90: 6275 636b 6574 2c20 6b65 7920 3d20 7061  bucket, key = pa
+00013fa0: 7273 655f 7333 5f75 726c 2870 6174 6829  rse_s3_url(path)
+00013fb0: 0a20 2020 2020 2020 2073 656c 662e 5f62  .        self._b
+00013fc0: 7563 6b65 7420 3d20 6275 636b 6574 0a20  ucket = bucket. 
+00013fd0: 2020 2020 2020 2073 656c 662e 5f6b 6579         self._key
+00013fe0: 203d 206b 6579 0a20 2020 2020 2020 2073   = key.        s
+00013ff0: 656c 662e 5f75 706c 6f61 645f 6964 203d  elf._upload_id =
+00014000: 2073 656c 662e 5f63 6c69 656e 742e 6372   self._client.cr
+00014010: 6561 7465 5f6d 756c 7469 7061 7274 5f75  eate_multipart_u
+00014020: 706c 6f61 6428 0a20 2020 2020 2020 2020  pload(.         
+00014030: 2020 2042 7563 6b65 743d 7365 6c66 2e5f     Bucket=self._
+00014040: 6275 636b 6574 2c20 4b65 793d 7365 6c66  bucket, Key=self
+00014050: 2e5f 6b65 7929 5b27 5570 6c6f 6164 4964  ._key)['UploadId
+00014060: 275d 0a0a 2020 2020 6465 6620 7570 6c6f  ']..    def uplo
+00014070: 6164 5f70 6172 7428 7365 6c66 2c20 7061  ad_part(self, pa
+00014080: 7274 5f6e 756d 3a20 696e 742c 2066 696c  rt_num: int, fil
+00014090: 655f 6f62 6a3a 2069 6f2e 4279 7465 7349  e_obj: io.BytesI
+000140a0: 4f29 202d 3e20 4e6f 6e65 3a0a 2020 2020  O) -> None:.    
+000140b0: 2020 2020 7265 7370 6f6e 7365 203d 2073      response = s
+000140c0: 656c 662e 5f63 6c69 656e 742e 7570 6c6f  elf._client.uplo
+000140d0: 6164 5f70 6172 7428 0a20 2020 2020 2020  ad_part(.       
+000140e0: 2020 2020 2042 6f64 793d 6669 6c65 5f6f       Body=file_o
+000140f0: 626a 2c0a 2020 2020 2020 2020 2020 2020  bj,.            
+00014100: 5570 6c6f 6164 4964 3d73 656c 662e 5f75  UploadId=self._u
+00014110: 706c 6f61 645f 6964 2c0a 2020 2020 2020  pload_id,.      
+00014120: 2020 2020 2020 5061 7274 4e75 6d62 6572        PartNumber
+00014130: 3d70 6172 745f 6e75 6d2c 0a20 2020 2020  =part_num,.     
+00014140: 2020 2020 2020 2042 7563 6b65 743d 7365         Bucket=se
+00014150: 6c66 2e5f 6275 636b 6574 2c0a 2020 2020  lf._bucket,.    
+00014160: 2020 2020 2020 2020 4b65 793d 7365 6c66          Key=self
+00014170: 2e5f 6b65 792c 0a20 2020 2020 2020 2029  ._key,.        )
+00014180: 0a20 2020 2020 2020 2073 656c 662e 5f6d  .        self._m
+00014190: 756c 7469 7061 7274 5f75 706c 6f61 645f  ultipart_upload_
+000141a0: 696e 666f 2e61 7070 656e 6428 0a20 2020  info.append(.   
+000141b0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+000141c0: 2020 2020 2020 2020 2020 2027 5061 7274             'Part
+000141d0: 4e75 6d62 6572 273a 2070 6172 745f 6e75  Number': part_nu
+000141e0: 6d2c 0a20 2020 2020 2020 2020 2020 2020  m,.             
+000141f0: 2020 2027 4554 6167 273a 2072 6573 706f     'ETag': respo
+00014200: 6e73 655b 2745 5461 6727 5d0a 2020 2020  nse['ETag'].    
+00014210: 2020 2020 2020 2020 7d29 0a0a 2020 2020          })..    
+00014220: 6465 6620 7570 6c6f 6164 5f70 6172 745f  def upload_part_
+00014230: 6279 5f70 6174 6873 280a 2020 2020 2020  by_paths(.      
+00014240: 2020 2020 2020 7365 6c66 2c20 7061 7274        self, part
+00014250: 5f6e 756d 3a20 696e 742c 2070 6174 6873  _num: int, paths
+00014260: 3a20 4c69 7374 5b54 7570 6c65 5b50 6174  : List[Tuple[Pat
+00014270: 684c 696b 652c 2073 7472 5d5d 2920 2d3e  hLike, str]]) ->
+00014280: 204e 6f6e 653a 0a20 2020 2020 2020 2066   None:.        f
+00014290: 696c 655f 6f62 6a20 3d20 696f 2e42 7974  ile_obj = io.Byt
+000142a0: 6573 494f 2829 0a20 2020 2020 2020 2066  esIO().        f
+000142b0: 6f72 2070 6174 682c 2062 7974 6573 5f72  or path, bytes_r
+000142c0: 616e 6765 2069 6e20 7061 7468 733a 0a20  ange in paths:. 
+000142d0: 2020 2020 2020 2020 2020 2062 7563 6b65             bucke
+000142e0: 742c 206b 6579 203d 2070 6172 7365 5f73  t, key = parse_s
+000142f0: 335f 7572 6c28 7061 7468 290a 2020 2020  3_url(path).    
+00014300: 2020 2020 2020 2020 6966 2062 7974 6573          if bytes
+00014310: 5f72 616e 6765 3a0a 2020 2020 2020 2020  _range:.        
+00014320: 2020 2020 2020 2020 6669 6c65 5f6f 626a          file_obj
+00014330: 2e77 7269 7465 280a 2020 2020 2020 2020  .write(.        
+00014340: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00014350: 2e5f 636c 6965 6e74 2e67 6574 5f6f 626a  ._client.get_obj
+00014360: 6563 7428 0a20 2020 2020 2020 2020 2020  ect(.           
+00014370: 2020 2020 2020 2020 2020 2020 2042 7563               Buc
+00014380: 6b65 743d 6275 636b 6574 2c20 4b65 793d  ket=bucket, Key=
+00014390: 6b65 792c 0a20 2020 2020 2020 2020 2020  key,.           
+000143a0: 2020 2020 2020 2020 2020 2020 2052 616e               Ran
+000143b0: 6765 3d62 7974 6573 5f72 616e 6765 295b  ge=bytes_range)[
+000143c0: 2742 6f64 7927 5d2e 7265 6164 2829 290a  'Body'].read()).
+000143d0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000143e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000143f0: 2020 6669 6c65 5f6f 626a 2e77 7269 7465    file_obj.write
+00014400: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00014410: 2020 2020 2020 7365 6c66 2e5f 636c 6965        self._clie
+00014420: 6e74 2e67 6574 5f6f 626a 6563 7428 4275  nt.get_object(Bu
+00014430: 636b 6574 3d62 7563 6b65 742c 0a20 2020  cket=bucket,.   
+00014440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014460: 2020 2020 2020 2020 204b 6579 3d6b 6579           Key=key
+00014470: 295b 2742 6f64 7927 5d2e 7265 6164 2829  )['Body'].read()
+00014480: 290a 2020 2020 2020 2020 6669 6c65 5f6f  ).        file_o
+00014490: 626a 2e73 6565 6b28 302c 206f 732e 5345  bj.seek(0, os.SE
+000144a0: 454b 5f53 4554 290a 2020 2020 2020 2020  EK_SET).        
+000144b0: 7365 6c66 2e75 706c 6f61 645f 7061 7274  self.upload_part
+000144c0: 2870 6172 745f 6e75 6d2c 2066 696c 655f  (part_num, file_
+000144d0: 6f62 6a29 0a0a 2020 2020 6465 6620 7570  obj)..    def up
+000144e0: 6c6f 6164 5f70 6172 745f 636f 7079 280a  load_part_copy(.
+000144f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00014500: 2c0a 2020 2020 2020 2020 2020 2020 7061  ,.            pa
+00014510: 7274 5f6e 756d 3a20 696e 742c 0a20 2020  rt_num: int,.   
+00014520: 2020 2020 2020 2020 2070 6174 683a 2050           path: P
+00014530: 6174 684c 696b 652c 0a20 2020 2020 2020  athLike,.       
+00014540: 2020 2020 2063 6f70 795f 736f 7572 6365       copy_source
+00014550: 5f72 616e 6765 3a20 4f70 7469 6f6e 616c  _range: Optional
+00014560: 5b73 7472 5d20 3d20 4e6f 6e65 2920 2d3e  [str] = None) ->
+00014570: 204e 6f6e 653a 0a20 2020 2020 2020 2062   None:.        b
+00014580: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
+00014590: 7365 5f73 335f 7572 6c28 7061 7468 290a  se_s3_url(path).
+000145a0: 2020 2020 2020 2020 7061 7261 6d73 203d          params =
+000145b0: 2064 6963 7428 0a20 2020 2020 2020 2020   dict(.         
+000145c0: 2020 2055 706c 6f61 6449 643d 7365 6c66     UploadId=self
+000145d0: 2e5f 7570 6c6f 6164 5f69 642c 0a20 2020  ._upload_id,.   
+000145e0: 2020 2020 2020 2020 2050 6172 744e 756d           PartNum
+000145f0: 6265 723d 7061 7274 5f6e 756d 2c0a 2020  ber=part_num,.  
+00014600: 2020 2020 2020 2020 2020 436f 7079 536f            CopySo
+00014610: 7572 6365 3d7b 0a20 2020 2020 2020 2020  urce={.         
+00014620: 2020 2020 2020 2027 4275 636b 6574 273a         'Bucket':
+00014630: 2062 7563 6b65 742c 0a20 2020 2020 2020   bucket,.       
+00014640: 2020 2020 2020 2020 2027 4b65 7927 3a20           'Key': 
+00014650: 6b65 790a 2020 2020 2020 2020 2020 2020  key.            
+00014660: 7d2c 0a20 2020 2020 2020 2020 2020 2042  },.            B
+00014670: 7563 6b65 743d 7365 6c66 2e5f 6275 636b  ucket=self._buck
+00014680: 6574 2c0a 2020 2020 2020 2020 2020 2020  et,.            
+00014690: 4b65 793d 7365 6c66 2e5f 6b65 792c 0a20  Key=self._key,. 
+000146a0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000146b0: 2069 6620 636f 7079 5f73 6f75 7263 655f   if copy_source_
+000146c0: 7261 6e67 653a 0a20 2020 2020 2020 2020  range:.         
+000146d0: 2020 2070 6172 616d 735b 2743 6f70 7953     params['CopyS
+000146e0: 6f75 7263 6552 616e 6765 275d 203d 2063  ourceRange'] = c
+000146f0: 6f70 795f 736f 7572 6365 5f72 616e 6765  opy_source_range
+00014700: 0a20 2020 2020 2020 2072 6573 706f 6e73  .        respons
+00014710: 6520 3d20 7365 6c66 2e5f 636c 6965 6e74  e = self._client
+00014720: 2e75 706c 6f61 645f 7061 7274 5f63 6f70  .upload_part_cop
+00014730: 7928 2a2a 7061 7261 6d73 290a 2020 2020  y(**params).    
+00014740: 2020 2020 7365 6c66 2e5f 6d75 6c74 6970      self._multip
+00014750: 6172 745f 7570 6c6f 6164 5f69 6e66 6f2e  art_upload_info.
+00014760: 6170 7065 6e64 280a 2020 2020 2020 2020  append(.        
+00014770: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00014780: 2020 2020 2020 2750 6172 744e 756d 6265        'PartNumbe
+00014790: 7227 3a20 7061 7274 5f6e 756d 2c0a 2020  r': part_num,.  
+000147a0: 2020 2020 2020 2020 2020 2020 2020 2745                'E
+000147b0: 5461 6727 3a20 7265 7370 6f6e 7365 5b27  Tag': response['
+000147c0: 436f 7079 5061 7274 5265 7375 6c74 275d  CopyPartResult']
+000147d0: 5b27 4554 6167 275d 0a20 2020 2020 2020  ['ETag'].       
+000147e0: 2020 2020 207d 290a 0a20 2020 2064 6566       })..    def
+000147f0: 2063 6c6f 7365 2873 656c 6629 3a0a 2020   close(self):.  
+00014800: 2020 2020 2020 7365 6c66 2e5f 6d75 6c74        self._mult
+00014810: 6970 6172 745f 7570 6c6f 6164 5f69 6e66  ipart_upload_inf
+00014820: 6f2e 736f 7274 286b 6579 3d6c 616d 6264  o.sort(key=lambd
+00014830: 6120 743a 2074 5b27 5061 7274 4e75 6d62  a t: t['PartNumb
+00014840: 6572 275d 290a 2020 2020 2020 2020 7365  er']).        se
+00014850: 6c66 2e5f 636c 6965 6e74 2e63 6f6d 706c  lf._client.compl
+00014860: 6574 655f 6d75 6c74 6970 6172 745f 7570  ete_multipart_up
+00014870: 6c6f 6164 280a 2020 2020 2020 2020 2020  load(.          
+00014880: 2020 5570 6c6f 6164 4964 3d73 656c 662e    UploadId=self.
+00014890: 5f75 706c 6f61 645f 6964 2c0a 2020 2020  _upload_id,.    
+000148a0: 2020 2020 2020 2020 4275 636b 6574 3d73          Bucket=s
+000148b0: 656c 662e 5f62 7563 6b65 742c 0a20 2020  elf._bucket,.   
+000148c0: 2020 2020 2020 2020 204b 6579 3d73 656c           Key=sel
+000148d0: 662e 5f6b 6579 2c0a 2020 2020 2020 2020  f._key,.        
+000148e0: 2020 2020 4d75 6c74 6970 6172 7455 706c      MultipartUpl
+000148f0: 6f61 643d 7b27 5061 7274 7327 3a20 7365  oad={'Parts': se
+00014900: 6c66 2e5f 6d75 6c74 6970 6172 745f 7570  lf._multipart_up
+00014910: 6c6f 6164 5f69 6e66 6f7d 290a 0a20 2020  load_info})..   
+00014920: 2064 6566 205f 5f65 6e74 6572 5f5f 2873   def __enter__(s
+00014930: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
+00014940: 7475 726e 2073 656c 660a 0a20 2020 2064  turn self..    d
+00014950: 6566 205f 5f65 7869 745f 5f28 7365 6c66  ef __exit__(self
+00014960: 2c20 6578 635f 7479 7065 2c20 6578 635f  , exc_type, exc_
+00014970: 7661 6c2c 2065 7863 5f74 6229 3a0a 2020  val, exc_tb):.  
+00014980: 2020 2020 2020 7365 6c66 2e63 6c6f 7365        self.close
+00014990: 2829 0a                                  ().
```

## megfile/sftp.py

```diff
@@ -1,22 +1,23 @@
 from typing import IO, AnyStr, BinaryIO, Callable, Iterator, List, Optional, Tuple
 
 from megfile.interfaces import FileEntry, PathLike, StatResult
-from megfile.sftp_path import SftpPath, is_sftp, sftp_download, sftp_glob, sftp_glob_stat, sftp_iglob, sftp_path_join, sftp_readlink, sftp_resolve, sftp_upload
+from megfile.sftp_path import SftpPath, is_sftp, sftp_concat, sftp_download, sftp_glob, sftp_glob_stat, sftp_iglob, sftp_path_join, sftp_readlink, sftp_resolve, sftp_upload
 
 __all__ = [
     'is_sftp',
     'sftp_readlink',
     'sftp_glob',
     'sftp_iglob',
     'sftp_glob_stat',
     'sftp_resolve',
     'sftp_download',
     'sftp_upload',
     'sftp_path_join',
+    'sftp_concat',
     'sftp_exists',
     'sftp_getmtime',
     'sftp_getsize',
     'sftp_isdir',
     'sftp_isfile',
     'sftp_listdir',
     'sftp_load_from',
```

## megfile/sftp_path.py

```diff
@@ -1,11 +1,12 @@
 import atexit
 import hashlib
 import io
 import os
+import subprocess
 from functools import lru_cache
 from logging import getLogger as get_logger
 from stat import S_ISDIR, S_ISLNK, S_ISREG
 from typing import IO, AnyStr, BinaryIO, Callable, Iterator, List, Optional, Tuple
 from urllib.parse import urlsplit, urlunsplit
 
 import paramiko
@@ -29,14 +30,15 @@
     'sftp_glob',
     'sftp_iglob',
     'sftp_glob_stat',
     'sftp_resolve',
     'sftp_download',
     'sftp_upload',
     'sftp_path_join',
+    'sftp_concat',
 ]
 
 SFTP_USERNAME = "SFTP_USERNAME"
 SFTP_PASSWORD = "SFTP_PASSWORD"
 SFTP_PRIVATE_KEY_PATH = "SFTP_PRIVATE_KEY_PATH"
 SFTP_PRIVATE_KEY_TYPE = "SFTP_PRIVATE_KEY_TYPE"
 SFTP_PRIVATE_KEY_PASSWORD = "SFTP_PRIVATE_KEY_PASSWORD"
@@ -88,41 +90,30 @@
 
 @lru_cache()
 def get_sftp_client(
         hostname: str,
         port: Optional[int] = None,
         username: Optional[str] = None,
         password: Optional[str] = None,
-):  # pragma: no cover
+) -> paramiko.SFTPClient:  # pragma: no cover
     '''Get sftp client
 
     :returns: sftp client
     '''
-    hostname, port, username, password, private_key = provide_connect_info(
-        hostname=hostname,
-        port=port,
-        username=username,
-        password=password,
-    )
-    transport = paramiko.Transport((hostname, port))
-    transport.connect(username=username, password=password, pkey=private_key)
-    client = paramiko.SFTPClient.from_transport(transport)
-    if not client:
-        raise ConnectionError('SFTP connect error')
-    atexit.register(client.close)
-    return client
+    ssh_client = get_ssh_client(hostname, port, username, password)
+    return ssh_client.open_sftp()
 
 
 @lru_cache()
 def get_ssh_client(
         hostname: str,
         port: Optional[int] = None,
         username: Optional[str] = None,
         password: Optional[str] = None,
-):  # pragma: no cover
+) -> paramiko.SSHClient:  # pragma: no cover
     hostname, port, username, password, private_key = provide_connect_info(
         hostname=hostname,
         port=port,
         username=username,
         password=password,
     )
 
@@ -319,14 +310,34 @@
 
         The difference between this function and ``os.path.join`` is that this function ignores left side slash (which indicates absolute path) in ``other_paths`` and will directly concat.
         e.g. os.path.join('/path', 'to', '/file') => '/file', but sftp_path_join('/path', 'to', '/file') => '/path/to/file'
     '''
     return uri_join(fspath(path), *map(fspath, other_paths))
 
 
+def sftp_concat(src_paths: List[PathLike], dst_path: PathLike) -> None:
+    '''Concatenate sftp files to one file.
+
+    :param src_paths: Given source paths
+    :param dst_path: Given destination path
+    '''
+    dst_path_obj = SftpPath(dst_path)
+
+    def get_real_path(path: PathLike) -> str:
+        return SftpPath(path)._real_path
+
+    command = [
+        'cat', *map(get_real_path, src_paths), '>',
+        get_real_path(dst_path)
+    ]
+    exec_result = dst_path_obj._exec_command(command)
+    if exec_result.returncode != 0:
+        raise OSError(f'Failed to concat {src_paths} to {dst_path}')
+
+
 @SmartPath.register
 class SftpPath(URIPath):
     """sftp protocol
 
     uri format: sftp://[username[:password]@]hostname[:port]/file_path
     e.g. sftp://username:password@127.0.0.1:22/data/test/
     """
@@ -575,22 +586,41 @@
     def realpath(self) -> str:
         '''Return the real path of given path
 
         :returns: Real path of given path
         '''
         return self.resolve().path_with_protocol
 
+    def _is_same_backend(self, other: 'SftpPath') -> bool:
+        return self._urlsplit_parts.hostname == other._urlsplit_parts.hostname and self._urlsplit_parts.username == other._urlsplit_parts.username and self._urlsplit_parts.password == other._urlsplit_parts.password and self._urlsplit_parts.port == other._urlsplit_parts.port
+
     def rename(self, dst_path: PathLike) -> 'SftpPath':
         '''
         rename file on sftp
 
         :param dst_path: Given destination path
         '''
         dst_path = self.from_path(dst_path)
-        self._client.rename(self._real_path, dst_path._real_path)
+        if self._is_same_backend(dst_path):
+            self._client.rename(self._real_path, dst_path._real_path)
+        else:
+            if self.is_dir():
+                for file_entry in self.scandir():
+                    self.from_path(file_entry.path).rename(
+                        dst_path.joinpath(file_entry.name))
+            else:
+                with self.open('rb') as fsrc:
+                    with dst_path.open('wb') as fdst:
+                        length = 16 * 1024
+                        while True:
+                            buf = fsrc.read(length)
+                            if not buf:
+                                break
+                            fdst.write(buf)
+                self.unlink()
         return dst_path
 
     def replace(self, dst_path: PathLike) -> 'SftpPath':
         '''
         move file on sftp
 
         :param dst_path: Given destination path
@@ -850,16 +880,16 @@
                 pass
             self.parent.mkdir(parents=True, exist_ok=True)
         elif not self.is_file():
             raise IsADirectoryError(
                 'Is a directory: %r' % self.path_with_protocol)
         fileobj = self._client.open(self._real_path, mode, bufsize=buffering)
         if 'r' in mode and 'b' not in mode:
-            return io.TextIOWrapper(fileobj)
-        return fileobj
+            return io.TextIOWrapper(fileobj)  # type: ignore
+        return fileobj  # type: ignore
 
     def chmod(self, mode: int, follow_symlinks: bool = True):
         '''
         Change the file mode and permissions, like os.chmod().
 
         :param mode: the file mode you want to change
         :param followlinks: Ignore this parameter, just for compatibility
@@ -876,14 +906,43 @@
         '''
         Remove this directory. The directory must be empty.
         '''
         if len(self.listdir()) > 0:
             raise OSError(f"Directory not empty: '{self.path_with_protocol}'")
         return self._client.rmdir(self._real_path)
 
+    def _exec_command(
+            self,
+            command: List[str],
+            bufsize: int = -1,
+            timeout: Optional[int] = None,
+            environment: Optional[dict] = None,
+    ) -> subprocess.CompletedProcess:  # pragma: no cover
+        ssh_client = get_ssh_client(
+            hostname=self._urlsplit_parts.hostname,
+            port=self._urlsplit_parts.port,
+            username=self._urlsplit_parts.username,
+            password=self._urlsplit_parts.password,
+        )
+        transport = ssh_client.get_transport()
+        if not transport:
+            raise OSError(f"SSH client error: {self.path_with_protocol}")
+        chan = transport.open_session(timeout=timeout)
+        chan.settimeout(timeout)
+        if environment:
+            chan.update_environment(environment)
+        chan.exec_command(" ".join(command))
+        stdout = chan.makefile("r", bufsize)
+        stderr = chan.makefile_stderr("r", bufsize)
+        return subprocess.CompletedProcess(
+            args=command,
+            returncode=chan.recv_exit_status(),
+            stdout=stdout,
+            stderr=stderr)
+
     def copy(
             self,
             dst_path: PathLike,
             callback: Optional[Callable[[int], None]] = None,
             followlinks: bool = False):
         '''
         File copy
@@ -895,28 +954,21 @@
             return self.readlink().copy(dst_path=dst_path, callback=callback)
 
         if self.is_dir():
             raise IsADirectoryError(
                 'Is a directory: %r' % self.path_with_protocol)
 
         dst_path = self.from_path(dst_path)
-        if self._urlsplit_parts.hostname == dst_path._urlsplit_parts.hostname and self._urlsplit_parts.username == dst_path._urlsplit_parts.username and self._urlsplit_parts.password == dst_path._urlsplit_parts.password and self._urlsplit_parts.port == dst_path._urlsplit_parts.port:
-            ssh_client = get_ssh_client(
-                hostname=self._urlsplit_parts.hostname,
-                port=self._urlsplit_parts.port,
-                username=self._urlsplit_parts.username,
-                password=self._urlsplit_parts.password,
-            )
-            _stdin, _stdout, stderr = ssh_client.exec_command(
-                f"cp {self._real_path} {dst_path._real_path}")
-            if not dst_path.exists():  # pragma: no cover
-                _logger.error(stderr)
+        if self._is_same_backend(dst_path):
+            exec_result = self._exec_command(
+                ["cp", self._real_path, dst_path._real_path])
+            _logger.info(f"exec_result.returncode: {exec_result.returncode}")
+            if exec_result.returncode != 0:  # pragma: no cover
+                _logger.error(exec_result.stderr)
                 raise OSError('Copy file error')
-            elif dst_path.lstat().size != self.lstat().size:  # pragma: no cover
-                raise OSError('Copy file error, size mismatch')
         else:
             with self.open('rb') as fsrc:
                 with dst_path.open('wb') as fdst:
                     length = 16 * 1024
                     while True:
                         buf = fsrc.read(length)
                         if not buf:
```

## megfile/smart.py

```diff
@@ -1,24 +1,23 @@
 import os
 from collections import defaultdict
 from functools import partial
-from itertools import chain
-from typing import IO, AnyStr, BinaryIO, Callable, Iterator, List, Optional, Tuple
+from typing import IO, Any, AnyStr, BinaryIO, Callable, Iterable, Iterator, List, Optional, Tuple
 
 from tqdm import tqdm
 
-from megfile.fs import fs_copy, fs_getsize, fs_scandir
+from megfile.fs import fs_copy, fs_scandir
 from megfile.interfaces import Access, FileEntry, NullCacher, PathLike, StatResult
 from megfile.lib.combine_reader import CombineReader
 from megfile.lib.compat import fspath
 from megfile.lib.glob import globlize, ungloblize
-from megfile.s3 import S3Cacher, is_s3, s3_copy, s3_download, s3_load_content, s3_open, s3_upload
-from megfile.sftp import sftp_copy, sftp_download, sftp_upload
+from megfile.s3 import S3Cacher, is_s3, s3_concat, s3_copy, s3_download, s3_load_content, s3_open, s3_upload
+from megfile.sftp import sftp_concat, sftp_copy, sftp_download, sftp_upload
 from megfile.smart_path import SmartPath, get_traditional_path
-from megfile.utils import combine, get_content_offset
+from megfile.utils import combine
 
 __all__ = [
     'smart_access',
     'smart_cache',
     'smart_combine_open',
     'smart_copy',
     'smart_exists',
@@ -305,36 +304,47 @@
     except KeyError:
         copy_func = _default_copy_func
     copy_func(
         src_path, dst_path, callback=callback,
         followlinks=followlinks)  # type: ignore
 
 
-def _smart_sync_single_file(
-        src_path, dst_path, src_file_path, callback, followlinks):
-    content_path = os.path.relpath(src_file_path, start=src_path)
+def _smart_sync_single_file(items: dict):
+    src_root_path = items['src_root_path']
+    dst_root_path = items['dst_root_path']
+    src_file_path = items['src_file_path']
+    callback = items['callback']
+    followlinks = items['followlinks']
+    callback_after_copy_file = items['callback_after_copy_file']
+
+    content_path = os.path.relpath(src_file_path, start=src_root_path)
     if len(content_path) and content_path != '.':
         content_path = content_path.lstrip('/')
-        dst_abs_file_path = smart_path_join(dst_path, content_path)
+        dst_abs_file_path = smart_path_join(dst_root_path, content_path)
     else:
         # if content_path is empty, which means smart_isfile(src_path) is True, this function is equal to smart_copy
-        dst_abs_file_path = dst_path
+        dst_abs_file_path = dst_root_path
     copy_callback = partial(callback, src_file_path) if callback else None
     smart_copy(
         src_file_path,
         dst_abs_file_path,
         callback=copy_callback,
         followlinks=followlinks)
+    if callback_after_copy_file:
+        callback_after_copy_file(src_file_path, dst_abs_file_path)
 
 
 def smart_sync(
         src_path: PathLike,
         dst_path: PathLike,
         callback: Optional[Callable[[str, int], None]] = None,
-        followlinks: bool = False) -> None:
+        followlinks: bool = False,
+        callback_after_copy_file: Optional[Callable[[str, str], None]] = None,
+        src_file_stats: Optional[Iterable[FileEntry]] = None,
+        map_func: Callable[[Callable, Iterable], Any] = map) -> None:
     '''
     Sync file or directory on s3 and fs
 
     .. note ::
 
         When the parameter is file, this function bahaves like ``smart_copy``.
 
@@ -364,45 +374,73 @@
         ...            self._bar.update(num_bytes)
         >>> total_file = len(list(smart_glob('src_path')))
         >>> smart_sync('src_path', 'dst_path', callback=Bar(total_file=total_file))
 
     :param src_path: Given source path
     :param dst_path: Given destination path
     :param callback: Called periodically during copy, and the input parameter is the data size (in bytes) of copy since the last call
+    :param followlinks: False if regard symlink as file, else True
+    :param callback_after_copy_file: Called after copy success, and the input parameter is src file path and dst file path
+    :param src_file_stats: If this parameter is not None, only this parameter's files will be synced, 
+            and src_path is the root_path of these files used to calculate the path of the target file. 
+            This parameter is in order to reduce file traversal times.
+    :param map_func: A Callable func like `map`. You can use ThreadPoolExecutor.map, Pool.map and so on if you need concurrent capability.
+            default is standard library `map`.
     '''
     src_path, dst_path = get_traditional_path(src_path), get_traditional_path(
         dst_path)
+    if not src_file_stats:
+        src_file_stats = smart_scan_stat(src_path, followlinks=followlinks)
 
-    for src_file_entry in smart_scan_stat(src_path, followlinks=followlinks):
-        if src_file_entry.name:
-            src_file_path = src_file_entry.path
-            _smart_sync_single_file(
-                src_path, dst_path, src_file_path, callback, followlinks)
+    def create_generator():
+        for src_file_entry in src_file_stats:
+            if src_file_entry.name:
+                src_file_path = src_file_entry.path
+                yield dict(
+                    src_root_path=src_path,
+                    dst_root_path=dst_path,
+                    src_file_path=src_file_path,
+                    callback=callback,
+                    followlinks=followlinks,
+                    callback_after_copy_file=callback_after_copy_file,
+                )
+
+    list(map_func(_smart_sync_single_file, create_generator()))
 
 
 def smart_sync_with_progress(
         src_path,
         dst_path,
         callback: Optional[Callable[[str, int], None]] = None,
-        followlinks: bool = False):  # pragma: no cover
+        followlinks: bool = False,
+        map_func: Callable[[Callable, Iterable], Iterator] = map
+):  # pragma: no cover
     src_path, dst_path = get_traditional_path(src_path), get_traditional_path(
         dst_path)
-    files = list(smart_scan(src_path, followlinks=followlinks))
-    tbar = tqdm(total=len(files), ascii=True)
+    file_stats = list(smart_scan_stat(src_path, followlinks=followlinks))
+    tbar = tqdm(total=len(file_stats), ascii=True)
     sbar = tqdm(unit='B', ascii=True, unit_scale=True)
 
     def tqdm_callback(current_src_path, length: int):
         sbar.update(length)
         if callback:
             callback(current_src_path, length)
 
-    for src_file_path in files:
-        _smart_sync_single_file(
-            src_path, dst_path, src_file_path, tqdm_callback, followlinks)
+    def callback_after_copy_file(src_file_path, dst_file_path):
         tbar.update(1)
+
+    smart_sync(
+        src_path,
+        dst_path,
+        callback=tqdm_callback,
+        followlinks=followlinks,
+        callback_after_copy_file=callback_after_copy_file,
+        src_file_stats=file_stats,
+        map_func=map_func,
+    )
     tbar.close()
     sbar.close()
 
 
 def smart_remove(path: PathLike, missing_ok: bool = False) -> None:
     '''
     Remove the file or directory on s3 or fs, `s3://` and `s3://bucket` are not permitted to remove
@@ -828,7 +866,46 @@
 def smart_getmd5(path: PathLike, recalculate: bool = False):
     '''Get md5 value of file
 
     param path: File path
     param recalculate: calculate md5 in real-time or not return s3 etag when path is s3
     '''
     return SmartPath(path).md5(recalculate=recalculate)
+
+
+_concat_funcs = {
+    's3': s3_concat,
+    'sftp': sftp_concat,
+}
+
+
+def _default_concat_func(src_paths: List[PathLike], dst_path: PathLike) -> None:
+    length = 16 * 1024
+    with smart_open(dst_path, 'wb') as dst_fd:
+        for src_path in src_paths:
+            with smart_open(src_path, 'rb') as src_fd:
+                while True:
+                    buf = src_fd.read(length)
+                    if not buf:
+                        break
+                    dst_fd.write(buf)
+
+
+def smart_concat(src_paths: List[PathLike], dst_path: PathLike) -> None:
+    '''
+    Concatenate src_paths to dst_path
+    
+    :param src_paths: List of source paths
+    :param dst_path: Destination path
+    '''
+    if not src_paths:  # pragma: no cover
+        return
+
+    dst_protocol, _ = SmartPath._extract_protocol(dst_path)
+    for src_path in src_paths:
+        src_protocol, _ = SmartPath._extract_protocol(src_path)
+        if src_protocol != dst_protocol:
+            concat_func = _default_concat_func
+            break
+    else:
+        concat_func = _concat_funcs.get(dst_protocol, _default_concat_func)
+    concat_func(src_paths, dst_path)
```

## megfile/smart_path.py

```diff
@@ -62,14 +62,16 @@
         else:
             raise ProtocolNotFoundError('protocol not found: %r' % path)
         return protocol, path_without_protocol
 
     @classmethod
     def _create_pathlike(cls, path: Union[PathLike, int]) -> BasePath:
         protocol, _ = cls._extract_protocol(path)
+        if protocol.startswith('s3+'):
+            protocol = 's3'
         if protocol not in cls._registered_protocols:
             raise ProtocolNotFoundError(
                 'protocol %r not found: %r' % (protocol, path))
         path_class = cls._registered_protocols[protocol]
         return path_class(path)
 
     @classmethod
```

## megfile/version.py

```diff
@@ -1 +1 @@
-VERSION = "2.0.3"
+VERSION = "2.0.4"
```

## megfile/lib/s3_prefetch_reader.py

```diff
@@ -1,17 +1,17 @@
 import os
 from collections import OrderedDict
-from concurrent.futures import ThreadPoolExecutor
+from concurrent.futures import Future, ThreadPoolExecutor
 from io import BytesIO
 from logging import getLogger as get_logger
 from math import ceil
 from statistics import mean
 from typing import Optional
 
-from megfile.errors import S3FileChangedError, patch_method, raise_s3_error, s3_should_retry
+from megfile.errors import S3FileChangedError, S3InvalidRangeError, patch_method, raise_s3_error, s3_should_retry
 from megfile.interfaces import Readable, Seekable
 from megfile.utils import get_human_size, process_local
 
 DEFAULT_BLOCK_SIZE = 8 * 2**20  # 8MB
 DEFAULT_BLOCK_CAPACITY = 16
 GLOBAL_MAX_WORKERS = 128
 
@@ -54,32 +54,42 @@
         assert block_capacity > block_forward, 'block_capacity should greater than block_forward, got: block_capacity=%s, block_forward=%s' % (
             block_capacity, block_forward)
 
         self._bucket = bucket
         self._key = key
         self._client = s3_client
         self._max_retries = max_retries
-
-        with raise_s3_error(self.name):
-            data = self._client.head_object(Bucket=self._bucket, Key=self._key)
-            self._content_size = data['ContentLength']
-            self._content_etag = data['ETag']
-            self._content_info = data
-
         self._block_size = block_size
         self._block_capacity = block_capacity  # Max number of blocks
         self._block_forward = block_forward  # Number of blocks every prefetch, which should be smaller than block_capacity
+
+        try:
+            first_index_response = self._fetch_response(index=0)
+            self._content_size = int(
+                first_index_response['ContentRange'].split('/')[-1])
+        except S3InvalidRangeError:
+            # usually when read a empty file
+            # TODO: use minio test empty file: https://hub.docker.com/r/minio/minio
+            first_index_response = self._fetch_response(index=None)
+            self._content_size = int(first_index_response['ContentLength'])
+
+        first_future = Future()
+        first_future.set_result(BytesIO(first_index_response['Body'].read()))
+        self._futures = self._get_futures()
+        self._insert_futures(index=0, future=first_future)
+        self._content_etag = first_index_response['ETag']
+        self._content_info = first_index_response
+
         self._block_stop = ceil(self._content_size / block_size)
 
         self.__offset = 0
         self._backoff_size = BACKOFF_INITIAL
         self._block_index = None  # Current block index
         self._seek_history = []
 
-        self._futures = self._get_futures()
         self._is_global_executor = False
         if max_workers is None:
             self._executor = process_local(
                 'S3PrefetchReader.executor',
                 ThreadPoolExecutor,
                 max_workers=GLOBAL_MAX_WORKERS)
             self._is_global_executor = True
@@ -338,41 +348,52 @@
             self._seek_history = history
             self._block_forward = max(
                 (self._block_capacity - 1) // len(self._seek_history), 1)
 
         self._cached_offset = offset
         self._block_index = index
 
-    def _fetch_buffer(self, index: int) -> BytesIO:
-        range_str = 'bytes=%d-%d' % (
-            index * self._block_size, (index + 1) * self._block_size - 1)
+    def _fetch_response(self, index: Optional[int] = None) -> dict:
 
-        def fetch_bytes() -> bytes:
-            data = self._client.get_object(
+        def fetch_response() -> dict:
+            if index is None:
+                return self._client.get_object(
+                    Bucket=self._bucket, Key=self._key)
+
+            range_str = 'bytes=%d-%d' % (
+                index * self._block_size, (index + 1) * self._block_size - 1)
+            return self._client.get_object(
                 Bucket=self._bucket, Key=self._key, Range=range_str)
-            etag = data.get('ETag', None)
-            if etag is not None and etag != self._content_etag:
-                raise S3FileChangedError(
-                    'File changed: %r, etag before: %s, after: %s' %
-                    (self.name, self._content_info, data))
-            return data['Body'].read()
 
-        fetch_bytes = patch_method(
-            fetch_bytes,
+        fetch_response = patch_method(
+            fetch_response,
             max_retries=self._max_retries,
             should_retry=s3_should_retry)
 
         with raise_s3_error(self.name):
-            return BytesIO(fetch_bytes())
+            return fetch_response()
+
+    def _fetch_buffer(self, index: int) -> BytesIO:
+        response = self._fetch_response(index=index)
+        etag = response.get('ETag', None)
+        if etag is not None and etag != self._content_etag:
+            raise S3FileChangedError(
+                'File changed: %r, etag before: %s, after: %s' %
+                (self.name, self._content_info, response))
+
+        return BytesIO(response['Body'].read())
 
     def _submit_future(self, index: int):
         if index < 0 or index >= self._block_stop:
             return  # pragma: no cover
         self._futures.submit(self._executor, index, self._fetch_buffer, index)
 
+    def _insert_futures(self, index: int, future: Future):
+        self._futures[index] = future
+
     def _fetch_future_result(self, index: int):
         return self._futures.result(index)
 
     def _cleanup_futures(self):
         self._futures.cleanup(self._block_capacity)
 
     def _close(self):
```

## megfile/lib/s3_share_cache_reader.py

```diff
@@ -1,8 +1,9 @@
 from collections import Counter
+from concurrent.futures import Future
 from logging import getLogger as get_logger
 from typing import Optional
 
 from megfile.lib.s3_prefetch_reader import LRUCacheFutureManager, S3PrefetchReader
 from megfile.utils import thread_local
 
 DEFAULT_BLOCK_SIZE = 8 * 2**20  # 8MB
@@ -68,14 +69,17 @@
 
     def _submit_future(self, index: int):
         if index < 0 or index >= self._block_stop:
             return  # pragma: no cover
         self._futures.submit(
             self._executor, (self.name, index), self._fetch_buffer, index)
 
+    def _insert_futures(self, index: int, future: Future):
+        self._futures[(self.name, index)] = future
+
     def _fetch_future_result(self, index: int):
         return self._futures.result((self.name, index))
 
     def _cleanup_futures(self):
         self._futures.cleanup(DEFAULT_BLOCK_CAPACITY)
 
     def _close(self):
```

## Comparing `megfile-2.0.3.dist-info/LICENSE` & `megfile-2.0.4.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `megfile-2.0.3.dist-info/LICENSE.pyre` & `megfile-2.0.4.dist-info/LICENSE.pyre`

 * *Files identical despite different names*

## Comparing `megfile-2.0.3.dist-info/METADATA` & `megfile-2.0.4.dist-info/METADATA`

 * *Files 14% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: megfile
-Version: 2.0.3
+Version: 2.0.4
 Summary: Megvii file operation library
 Home-page: https://github.com/megvii-research/megfile
 Author: megvii
 Author-email: megfile@megvii.com
 License: UNKNOWN
 Platform: UNKNOWN
 Classifier: Development Status :: 4 - Beta
@@ -22,15 +22,14 @@
 Classifier: Programming Language :: Python :: 3.10
 Requires-Python: >=3.6
 Description-Content-Type: text/markdown
 License-File: LICENSE
 License-File: LICENSE.pyre
 Requires-Dist: boto3
 Requires-Dist: botocore (>=1.13.0)
-Requires-Dist: smart-open (>=1.6.0)
 Requires-Dist: requests
 Requires-Dist: paramiko
 Requires-Dist: tqdm
 
 megfile - Megvii FILE library
 ---
 
@@ -145,15 +144,15 @@
 git clone git@github.com:megvii-research/megfile.git
 cd megfile
 pip3 install -r requirements.txt -r requirements-dev.txt
 ```
 
 ## Configuration
 
-Before using `megfile` to access files on s3, you need to set up authentication credentials for your s3 account using the [AWS CLI](https://docs.aws.amazon.com/cli/latest/reference/configure/index.html) or editing the file `~/.aws/config` directly, see also: [boto3 configuration](https://boto3.amazonaws.com/v1/documentation/api/latest/guide/configuration.html) & [boto3 credentials](https://boto3.amazonaws.com/v1/documentation/api/latest/guide/credentials.html). You can set your endpoint url with environments `AWS_ENDPOINT` or `OSS_ENDPOINT`.
+Before using `megfile` to access files on s3, you need to set up authentication credentials for your s3 account using the [AWS CLI](https://docs.aws.amazon.com/cli/latest/reference/configure/index.html) or editing the file `~/.aws/config` directly, see also: [boto3 configuration](https://boto3.amazonaws.com/v1/documentation/api/latest/guide/configuration.html) & [boto3 credentials](https://boto3.amazonaws.com/v1/documentation/api/latest/guide/credentials.html). You can set your endpoint url with environments `OSS_ENDPOINT`.
 
 ```
 $ aws configure
 AWS Access Key ID [None]: accesskey
 AWS Secret Access Key [None]: secretkey
 Default region name [None]:
 Default output format [None]:
@@ -168,14 +167,45 @@
 aws_access_key_id = secretkey
 
 s3 =
     addressing_style = virtual
     endpoint_url = http://oss-cn-hangzhou.aliyuncs.com
 ```
 
+You also can operate s3 files with different endpoint urls, access keys and secret keys. You can set config for different profiles by environment(`PROFILE_NAME__AWS_ACCESS_KEY_ID`, `PROFILE_NAME__AWS_SECRET_ACCESS_KEY`, `PROFILE_NAME__OSS_ENDPOINT`) or `~/.aws/config`. Then you can operate files with path `s3+profile_name://bucket/key`.
+For example:
+```
+# set config with environment
+$ export PROFILE1__AWS_ACCESS_KEY_ID=profile1-accesskey
+$ export PROFILE1__AWS_SECRET_ACCESS_KEY=profile1-secretkey
+$ export PROFILE1__OSS_ENDPOINT=https://profile1.s3.custom.com
+
+$ export PROFILE2__AWS_ACCESS_KEY_ID=profile2-accesskey
+$ export PROFILE2__AWS_SECRET_ACCESS_KEY=profile2-secretkey
+$ export PROFILE2__OSS_ENDPOINT=https://profile2.s3.custom.com
+
+# set config with file
+$ cat ~/.aws/config
+[profile1]
+aws_secret_access_key = profile1-accesskey
+aws_access_key_id = profile1-secretkey
+s3 =
+    endpoint_url = https://profile1.s3.custom.com
+
+[profile2]
+aws_secret_access_key = profile2-accesskey
+aws_access_key_id = profile2-secretkey
+s3 =
+    endpoint_url = https://profile2.s3.custom.com
+
+
+# python
+megfile.smart_copy('s3+profile1://bucket/key', 's3+profile2://bucket/key')
+```
+
 sftp path format is `sftp://[username[:password]@]hostname[:port]/file_path`, and sftp support some environments:
 ```
 # If you are not set username or password in path, you can set them in environments
 $ export SFTP_USERNAME=user
 $ export SFTP_PASSWORD=user_password
 
 # You can also set private key for sftp connection
```

## Comparing `megfile-2.0.3.dist-info/RECORD` & `megfile-2.0.4.dist-info/RECORD`

 * *Files 10% similar despite different names*

```diff
@@ -1,43 +1,43 @@
-megfile/__init__.py,sha256=-i734yfLzRfEJSbjLb3jzB5tlbEX5BfhX8zaHwd1or4,5378
-megfile/cli.py,sha256=tRzibt5ieED-1bxPM-eTjEgzTy57T0Y5NH5kMZpagaU,9441
-megfile/errors.py,sha256=0QD5-Xn32vzQQxgHgD9bOlvpLDXAZkuHSEzn7-Th4-U,11252
+megfile/__init__.py,sha256=wlijLJS6F8Vdm1xjpsjd9fKBeDGpgIMrVsXYSeOQ4Xw,5434
+megfile/cli.py,sha256=xQVArkn1uernhWy7K9z2QaVIQ0rQhVbirHBd58DV4rA,9918
+megfile/errors.py,sha256=FE9mGMxnNFpsQdtNJWiL-BuZbPGbbx8es9eAo8osyio,11584
 megfile/fs.py,sha256=sjkm_LsvNCw8hj9Ee-1HSNzvg7bRHTPem8KTDDBQlCw,11621
 megfile/fs_path.py,sha256=-AcwwvifUeq6skQolWBFFeTqohCKCMyewJDC0CnYwE4,37313
 megfile/http.py,sha256=EtyFazgenIhEvkwMpX6ga32POKUG21969Y2cRQbFn58,1852
 megfile/http_path.py,sha256=up1gB0Yk1a3ZbmHoJV-XWzOTiKh66hmm5p_Kzy3GMHo,4483
 megfile/interfaces.py,sha256=sRLQxyucY8f3Y5_7g6h8qHDZ8xLoTbcWu-Ofh15mlDc,6181
 megfile/pathlike.py,sha256=EKVSfr13IFYTyUIfkTxzli93UJXkxtTH3IXdv946DhE,28741
-megfile/s3.py,sha256=NMAf3_9L-nmuVbYw9fc2rkr49BfZfGa9FsaCfikTx0c,12466
-megfile/s3_path.py,sha256=9Z3p_TXEAXowFijBRhYa7FmQH98T_C-1RQ6BZYjSJwg,77761
-megfile/sftp.py,sha256=x2N4Ji3OO-4HEzeQBoGiCs02hlNE0ER4A5OjAc_KaXw,11337
-megfile/sftp_path.py,sha256=q9mLYYptMv24OYUsAc_x4PsEMOAwc5nvlye5WY7iga0,38016
-megfile/smart.py,sha256=mX8XIAJOBUMSec2d_BEdYA3o0NLyizgsl9QfsyKdF9w,27453
-megfile/smart_path.py,sha256=2kvguFCJowZTYqiE-0AeD1D4o59pCGZafoEMNQSLlAs,6546
+megfile/s3.py,sha256=hlXqQvZuXuDJbLjsrK23LD25cblThO9f-r78eWFsYZ8,12456
+megfile/s3_path.py,sha256=ZvJeTO7XPfVgWmB0Z8FqdWWWJWHO3aspEOeD6N1CLqU,84371
+megfile/sftp.py,sha256=3BcPcIW2QLhKDs7Bn6m3O5pH9NVr2m0EYn6KudQNinc,11369
+megfile/sftp_path.py,sha256=gSGyL0dgYuv8gO_62i9u1IBex2gw75KAUfwf3BmaokM,39883
+megfile/smart.py,sha256=Gx_HjBmr3dkZtF8Dj1X95O57l78jqJYTPNWNfG1F5hs,30409
+megfile/smart_path.py,sha256=OPFfRgv-wtdSgakt7eN01d3Sne4qGNe4_nL_9a4AyzA,6613
 megfile/stdio.py,sha256=DmSdL-f1A0SBoOBFhOqZSaHk5MuZVWRyUZJlYpzRppA,521
 megfile/stdio_path.py,sha256=g2Sv7tOkYNANK_vAN7p6oxTvr3MOEM1gwEpHkha9PFg,2634
-megfile/version.py,sha256=iRcRdeHI2Tgrr10qzzky1Spn7sy5qebUehdP_IdgS94,19
+megfile/version.py,sha256=MZ9IA9j4gnDYgK8Mq9qb0AgIHlAuLKqHCZdZhCK8d90,19
 megfile/lib/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 megfile/lib/combine_reader.py,sha256=nOQ7kJhQwwIqA8thZE7red7AjmVpwMhLrzIq4y84StI,4466
 megfile/lib/compat.py,sha256=ro07M9GU9hmqnSBu-IV13qKQQ9ktiMNDxaGGw9I9W3k,228
 megfile/lib/fnmatch.py,sha256=HgdlnEWBsdFUOZqnW_v1kj1jeH_9lMcCqW85pyMu4vM,4054
 megfile/lib/glob.py,sha256=XOENsZS5aLJk1WDqDkBJl62CICxgarmqlKjCAWvixMg,9478
 megfile/lib/joinpath.py,sha256=D4Px6-lnDDpYs1LMUHkTIGqMPJQ0oCBGfTzREs373iU,929
 megfile/lib/lazy_handler.py,sha256=FFyVO4OdG9Hi0j0moELW2z8Nq8D3f3PGEROM6IKCwUM,1801
 megfile/lib/s3_buffered_writer.py,sha256=AGjCNQ1X16kjFbEJouavkO6ykmlAtfVKBPAD-yYwAT0,6934
 megfile/lib/s3_cached_handler.py,sha256=e4KamTLMIPKa96yp7HGF05wDl2Yfoizz9pBrz-uAQ5w,1322
 megfile/lib/s3_limited_seekable_writer.py,sha256=OEh_HCbxNt8hsF2Y5OAQ9puikvzDfNkzluHjXtThegg,6057
 megfile/lib/s3_memory_handler.py,sha256=jLBA5HVuI-UBPYMYN-B8iX_VGr8bC9brAqY-KbEGrtw,3725
 megfile/lib/s3_pipe_handler.py,sha256=6r0rmLQp6VlJ4ZpBAvurfkaY0-qxKIuNpi5wMe1sDJ4,3404
-megfile/lib/s3_prefetch_reader.py,sha256=o3q_U4utpEKH-7WJl7G-sh2jy2kFI3gOkabGKcwtgQg,14148
-megfile/lib/s3_share_cache_reader.py,sha256=eiwvfehiiLoPVJ0PX2xVmC6CKs-_zkzbRPQQUPf7-Jc,3638
+megfile/lib/s3_prefetch_reader.py,sha256=zSd_gmpDtQCDA-Rrh7Nxh2WOb0Z8Q1QZZg1g7WO6JNg,15053
+megfile/lib/s3_share_cache_reader.py,sha256=q3MVEDUgOvalO7js6S_LWQ-eJS4xFHiio8ZoJZt40e4,3791
 megfile/lib/shadow_handler.py,sha256=qbew6o1FLv4WKY6xAK05Ei9jQpNUK_E06iSIU_2AE0o,2569
 megfile/lib/stdio_handler.py,sha256=M9mAfG7EUR8a4yL-BwcU_025BVwNC0iI_lSIA8xNVa8,1930
 megfile/utils/__init__.py,sha256=gWplPIHzpSqV9AiQiRvUrBCkD737caNYyudsgwQBbKk,9025
 megfile/utils/mutex.py,sha256=BE16gbmZxr0RgU0ULaAFVDTZGwiOA-Jven-fDeG3ltQ,2461
-megfile-2.0.3.dist-info/LICENSE,sha256=WNHhf_5RCaeuKWyq_K39vmp9F28LxKsB4SpomwSZ2L0,11357
-megfile-2.0.3.dist-info/LICENSE.pyre,sha256=9lf5nT-5ZH25JijpYAequ0bl8E8z5JmZB1qrjiUMp84,1080
-megfile-2.0.3.dist-info/METADATA,sha256=jbIj4ad3nZYPUxVn-P1Ax5uppmJANdIwCudmd4WN9qM,9017
-megfile-2.0.3.dist-info/WHEEL,sha256=G16H4A3IeoQmnOrYV4ueZGKSjhipXx8zc8nu9FGlvMA,92
-megfile-2.0.3.dist-info/entry_points.txt,sha256=O8y31sCLdgUkNujumqaC4GDjJDOq55SJQ_uc7s1FeYw,50
-megfile-2.0.3.dist-info/top_level.txt,sha256=i3rMgdU1ZAJekAceojhA-bkm3749PzshtRmLTbeLUPQ,8
-megfile-2.0.3.dist-info/RECORD,,
+megfile-2.0.4.dist-info/LICENSE,sha256=WNHhf_5RCaeuKWyq_K39vmp9F28LxKsB4SpomwSZ2L0,11357
+megfile-2.0.4.dist-info/LICENSE.pyre,sha256=9lf5nT-5ZH25JijpYAequ0bl8E8z5JmZB1qrjiUMp84,1080
+megfile-2.0.4.dist-info/METADATA,sha256=7Mj8cyShpWEOvjr00Ol9tmN89MRi8w7r3mb_Lh2lCmA,10140
+megfile-2.0.4.dist-info/WHEEL,sha256=G16H4A3IeoQmnOrYV4ueZGKSjhipXx8zc8nu9FGlvMA,92
+megfile-2.0.4.dist-info/entry_points.txt,sha256=O8y31sCLdgUkNujumqaC4GDjJDOq55SJQ_uc7s1FeYw,50
+megfile-2.0.4.dist-info/top_level.txt,sha256=i3rMgdU1ZAJekAceojhA-bkm3749PzshtRmLTbeLUPQ,8
+megfile-2.0.4.dist-info/RECORD,,
```

