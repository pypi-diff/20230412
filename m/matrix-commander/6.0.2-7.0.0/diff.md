# Comparing `tmp/matrix-commander-6.0.2.tar.gz` & `tmp/matrix-commander-7.0.0.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "matrix-commander-6.0.2.tar", last modified: Tue Apr  4 13:37:02 2023, max compression
+gzip compressed data, was "matrix-commander-7.0.0.tar", last modified: Wed Apr 12 13:25:26 2023, max compression
```

## Comparing `matrix-commander-6.0.2.tar` & `matrix-commander-7.0.0.tar`

### file list

```diff
@@ -1,21 +1,21 @@
-drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-04-04 13:37:02.422000 matrix-commander-6.0.2/
--rw-rw-r--   0 user      (1000) user      (1000)    35149 2022-05-22 12:47:05.000000 matrix-commander-6.0.2/LICENSE
--rw-rw-r--   0 user      (1000) user      (1000)       29 2022-05-29 22:34:19.000000 matrix-commander-6.0.2/MANIFEST.in
--rw-r--r--   0 user      (1000) user      (1000)   123116 2023-04-04 13:37:02.423000 matrix-commander-6.0.2/PKG-INFO
--rw-rw-r--   0 user      (1000) user      (1000)     2397 2022-12-11 20:36:11.000000 matrix-commander-6.0.2/PyPi-Instructions.md
--rw-r--r--   0 user      (1000) user      (1000)   119715 2023-04-04 13:19:21.000000 matrix-commander-6.0.2/README.md
-drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-04-04 13:37:02.419000 matrix-commander-6.0.2/matrix_commander/
--rw-rw-r--   0 user      (1000) user      (1000)       35 2022-05-26 15:24:28.000000 matrix-commander-6.0.2/matrix_commander/__init__.py
--rwxr-xr-x   0 user      (1000) user      (1000)     1409 2022-12-12 12:36:26.000000 matrix-commander-6.0.2/matrix_commander/matrix-commander-tui
--rwxr-xr-x   0 user      (1000) user      (1000)   351107 2023-04-04 13:29:54.000000 matrix-commander-6.0.2/matrix_commander/matrix_commander.py
-drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-04-04 13:37:02.421000 matrix-commander-6.0.2/matrix_commander.egg-info/
--rw-rw-r--   0 user      (1000) user      (1000)   123116 2023-04-04 13:37:02.000000 matrix-commander-6.0.2/matrix_commander.egg-info/PKG-INFO
--rw-rw-r--   0 user      (1000) user      (1000)      440 2023-04-04 13:37:02.000000 matrix-commander-6.0.2/matrix_commander.egg-info/SOURCES.txt
--rw-rw-r--   0 user      (1000) user      (1000)        1 2023-04-04 13:37:02.000000 matrix-commander-6.0.2/matrix_commander.egg-info/dependency_links.txt
--rw-rw-r--   0 user      (1000) user      (1000)       59 2023-04-04 13:37:02.000000 matrix-commander-6.0.2/matrix_commander.egg-info/entry_points.txt
--rw-rw-r--   0 user      (1000) user      (1000)      122 2023-04-04 13:37:02.000000 matrix-commander-6.0.2/matrix_commander.egg-info/requires.txt
--rw-rw-r--   0 user      (1000) user      (1000)       17 2023-04-04 13:37:02.000000 matrix-commander-6.0.2/matrix_commander.egg-info/top_level.txt
--rw-rw-r--   0 user      (1000) user      (1000)       85 2022-05-26 08:19:14.000000 matrix-commander-6.0.2/pyproject.toml
--rw-rw-r--   0 user      (1000) user      (1000)     1372 2023-04-04 13:37:02.425000 matrix-commander-6.0.2/setup.cfg
-drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-04-04 13:37:02.422000 matrix-commander-6.0.2/tests/
--rwxrwxr-x   0 user      (1000) user      (1000)     2068 2022-10-15 11:32:09.000000 matrix-commander-6.0.2/tests/test-send.py
+drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-04-12 13:25:26.531000 matrix-commander-7.0.0/
+-rw-rw-r--   0 user      (1000) user      (1000)    35149 2022-05-22 12:47:05.000000 matrix-commander-7.0.0/LICENSE
+-rw-rw-r--   0 user      (1000) user      (1000)       29 2022-05-29 22:34:19.000000 matrix-commander-7.0.0/MANIFEST.in
+-rw-r--r--   0 user      (1000) user      (1000)   123847 2023-04-12 13:25:26.532000 matrix-commander-7.0.0/PKG-INFO
+-rw-rw-r--   0 user      (1000) user      (1000)     2397 2022-12-11 20:36:11.000000 matrix-commander-7.0.0/PyPi-Instructions.md
+-rw-r--r--   0 user      (1000) user      (1000)   120446 2023-04-12 13:22:06.000000 matrix-commander-7.0.0/README.md
+drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-04-12 13:25:26.524000 matrix-commander-7.0.0/matrix_commander/
+-rw-rw-r--   0 user      (1000) user      (1000)       35 2022-05-26 15:24:28.000000 matrix-commander-7.0.0/matrix_commander/__init__.py
+-rwxr-xr-x   0 user      (1000) user      (1000)     1409 2022-12-12 12:36:26.000000 matrix-commander-7.0.0/matrix_commander/matrix-commander-tui
+-rwxr-xr-x   0 user      (1000) user      (1000)   351897 2023-04-12 13:23:37.000000 matrix-commander-7.0.0/matrix_commander/matrix_commander.py
+drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-04-12 13:25:26.530000 matrix-commander-7.0.0/matrix_commander.egg-info/
+-rw-rw-r--   0 user      (1000) user      (1000)   123847 2023-04-12 13:25:26.000000 matrix-commander-7.0.0/matrix_commander.egg-info/PKG-INFO
+-rw-rw-r--   0 user      (1000) user      (1000)      440 2023-04-12 13:25:26.000000 matrix-commander-7.0.0/matrix_commander.egg-info/SOURCES.txt
+-rw-rw-r--   0 user      (1000) user      (1000)        1 2023-04-12 13:25:26.000000 matrix-commander-7.0.0/matrix_commander.egg-info/dependency_links.txt
+-rw-rw-r--   0 user      (1000) user      (1000)       59 2023-04-12 13:25:26.000000 matrix-commander-7.0.0/matrix_commander.egg-info/entry_points.txt
+-rw-rw-r--   0 user      (1000) user      (1000)      128 2023-04-12 13:25:26.000000 matrix-commander-7.0.0/matrix_commander.egg-info/requires.txt
+-rw-rw-r--   0 user      (1000) user      (1000)       17 2023-04-12 13:25:26.000000 matrix-commander-7.0.0/matrix_commander.egg-info/top_level.txt
+-rw-rw-r--   0 user      (1000) user      (1000)       85 2022-05-26 08:19:14.000000 matrix-commander-7.0.0/pyproject.toml
+-rw-r--r--   0 user      (1000) user      (1000)     1379 2023-04-12 13:25:26.534000 matrix-commander-7.0.0/setup.cfg
+drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-04-12 13:25:26.530000 matrix-commander-7.0.0/tests/
+-rwxrwxr-x   0 user      (1000) user      (1000)     2068 2022-10-15 11:32:09.000000 matrix-commander-7.0.0/tests/test-send.py
```

### Comparing `matrix-commander-6.0.2/LICENSE` & `matrix-commander-7.0.0/LICENSE`

 * *Files identical despite different names*

### Comparing `matrix-commander-6.0.2/PKG-INFO` & `matrix-commander-7.0.0/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: matrix-commander
-Version: 6.0.2
+Version: 7.0.0
 Summary: A simple command-line Matrix client
 Home-page: https://github.com/8go/matrix-commander
 Author: 8go
 Project-URL: Bug Tracker, https://github.com/8go/matrix-commander/issues
 Project-URL: repository, https://github.com/8go/matrix-commander
 Keywords: Matrix,chat,messaging
 Classifier: Programming Language :: Python :: 3.8
@@ -91,15 +91,15 @@
 
 <p>
 <a href="https://matrix.org/docs/projects/client/matrix-commander">
 <img src="https://matrix.org/docs/projects/images/made-for-matrix.png"
 alt="made for Matrix" height="100"></a>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 <a href="https://pypi.org/project/matrix-commander/">
-<img src="https://pypi.org/static/images/logo-large.6bdbb439.svg"
+<img src="https://pypi.org/static/images/logo-large.9f732b5f.svg"
 alt="get it on PyPi" height="100"></a>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 <a href="https://hub.docker.com/r/matrixcommander/matrix-commander">
 <img src="https://www.unixtutorial.org/images/software/docker-hub.png"
 alt="get it on Docker Hub" height="100"></a>
 </p>
 
@@ -235,14 +235,15 @@
 - Supports SSO (Single Sign-On)
 - Sending messages
 - Sending notices
 - Sending formatted messages
 - Sending MarkDown messages
 - Message splitting before sending
 - Sending Code-formatted messages
+- Sending emojis in messages via shorthand
 - Sending to one room
 - Sending to multiple rooms
 - Sending image files (photos, etc.)
 - Sending of media files (music, videos, etc.)
 - Sending of arbitrary files (PDF, xls, doc, txt, etc.)
 - Sending events such as emoji reactions, or replies as threads
 - Using events to edit sent messages
@@ -461,14 +462,16 @@
     - Python 3.8 or higher installed (3.7 will NOT work)
     - libolm-dev must be installed as it is required by matrix-nio
       - libolm-dev on Debian/Ubuntu, libolm-devel on Fedora, libolm on MacOS
     - matrix-nio must be installed, see https://github.com/poljar/matrix-nio
       - pip3 install --user --upgrade matrix-nio[e2e]
     - python3 package markdown must be installed to support MarkDown format
       - pip3 install --user --upgrade markdown
+    - python3 package emoji must be installed to support emojis in text messages
+      - pip3 install --user --upgrade emoji
     - python3 package python_magic must be installed to support image sending
       - pip3 install --user --upgrade python_magic
     - if (and only if) you want OS notification support, then the python3
       package notify2 and dbus-python should be installed
       - pip3 install --user --upgrade dbus-python # optional
       - pip3 install --user --upgrade notify2 # optional
     - python3 package urllib must be installed to support media download
@@ -566,14 +569,17 @@
 $ matrix-commander --message "Hello World!" # sends provided message
 $ echo "Hello World" | matrix-commander # pipe input msg into program
 $ matrix-commander -m msg1 -m msg2 # sends 2 messages
 $ matrix-commander -m msg1 msg2 msg3 # sends 3 messages
 $ df -h | matrix-commander --code # formatting for code/tables
 $ matrix-commander -m "<b>BOLD</b> and <i>ITALIC</i>" --html
 $ matrix-commander -m "- bullet1" --markdown
+$ matrix-commander -m "I :red_heart: you" --emojize
+$ matrix-commander -m "Well done :clapping_hands:" --emojize
+# See https://unicode.org/emoji/charts/full-emoji-list.html for emoji list
 $ # take input from an RSS feed and split large RSS entries into multiple
 $ # Matrix messages wherever the pattern "\n\n\n" is found
 $ rssfeed | matrix-commander --split "\n\n\n"
 $ matrix-commander --credentials usr1room2.json # select credentials file
 $ matrix-commander --store /var/storage/ # select store directory
 $ # Send to a specific room
 $ matrix-commander -m "hi" --room '!YourRoomId:example.com'
@@ -845,15 +851,15 @@
                         [--room-kick ROOM [ROOM ...]] [-u USER [USER ...]]
                         [--user-login USER] [--name ROOM_NAME [ROOM_NAME ...]]
                         [--topic ROOM_TOPIC [ROOM_TOPIC ...]]
                         [--alias ROOM_ALIAS [ROOM_ALIAS ...]]
                         [-m TEXT [TEXT ...]] [-i IMAGE_FILE [IMAGE_FILE ...]]
                         [-a AUDIO_FILE [AUDIO_FILE ...]] [-f FILE [FILE ...]]
                         [-e MATRIX_JSON_OBJECT [MATRIX_JSON_OBJECT ...]] [-w]
-                        [-z] [-k] [-p SEPARATOR] [--config CONFIG_FILE]
+                        [-z] [-k] [-j] [-p SEPARATOR] [--config CONFIG_FILE]
                         [--proxy PROXY] [-n] [--encrypted]
                         [-l [NEVER|ONCE|FOREVER|TAIL|ALL]] [-t [NUMBER]] [-y]
                         [--print-event-id]
                         [--download-media [DOWNLOAD_DIRECTORY]] [--os-notify]
                         [--set-device-name DEVICE_NAME]
                         [--set-display-name DISPLAY_NAME] [--get-display-name]
                         [--set-presence ONLINE|OFFLINE|UNAVAILABLE]
@@ -1293,14 +1299,19 @@
                         language.
   -k, --code            Send message as format "CODE". Details:: If not
                         specified, message will be sent as format "TEXT". If
                         both --html and --code are specified then --code takes
                         priority. This is useful for sending ASCII-art or
                         tabbed output like tables as a fixed-sized font will
                         be used for display.
+  -j, --emojize         Send message after emojizing. Details:: If not
+                        specified, message will be sent as format "TEXT". If
+                        both --code and --emojize are specified then --code
+                        takes priority. This is useful for sending emojis in
+                        shortcode form :collision:.
   -p SEPARATOR, --split SEPARATOR
                         Split message text into multiple Matrix messages.
                         Details:: If set, split the message(s) into multiple
                         messages wherever the string specified with --split
                         occurs. E.g. One pipes a stream of RSS articles into
                         the program and the articles are separated by three
                         newlines. Then with --split set to "\n\n\n" each
@@ -1891,15 +1902,15 @@
                         There is no 'calling home' on every run, only a 'check
                         pypi.org' upon request. Your privacy is protected. The
                         new release is neither downloaded, nor installed. It
                         just informs you. After printing version information
                         the program will continue to run. This is useful for
                         having version number in the log files.
 
-You are running version 6.0.2 2023-04-04. Enjoy, star on Github and contribute
+You are running version 7.0.0 2023-04-12. Enjoy, star on Github and contribute
 by submitting a Pull Request. Also have a look at matrix-commander-tui.
 ```
 
 # Autocompletion
 
 Tab completion is provided for shells (e.g. bash), courtesy of @mizlan).
 
@@ -2003,10 +2014,10 @@
 
 # Final Remarks
 
 - Thanks to all of you who already have contributed! So appreciated!
   - :heart: and :thumbsup: to @fyfe, @berlincount, @ezwen, @Scriptkiddi,
     @pelzvieh, @mizlan, @edwinsage, @jschwartzentruber, @nirgal, @benneti,
     @opk12, @pataquets, @KizzyCode, @murlock1000, @Benjamin-Loison,
-    @barathrm, etc.
+    @barathrm, @jonathandmoore, etc.
 - Enjoy!
 - Give it a :star: star on GitHub! Pull requests are welcome  :heart:
```

### Comparing `matrix-commander-6.0.2/PyPi-Instructions.md` & `matrix-commander-7.0.0/PyPi-Instructions.md`

 * *Files identical despite different names*

### Comparing `matrix-commander-6.0.2/README.md` & `matrix-commander-7.0.0/README.md`

 * *Files 1% similar despite different names*

```diff
@@ -23,15 +23,15 @@
 
 <p>
 <a href="https://matrix.org/docs/projects/client/matrix-commander">
 <img src="https://matrix.org/docs/projects/images/made-for-matrix.png"
 alt="made for Matrix" height="100"></a>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 <a href="https://pypi.org/project/matrix-commander/">
-<img src="https://pypi.org/static/images/logo-large.6bdbb439.svg"
+<img src="https://pypi.org/static/images/logo-large.9f732b5f.svg"
 alt="get it on PyPi" height="100"></a>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 <a href="https://hub.docker.com/r/matrixcommander/matrix-commander">
 <img src="https://www.unixtutorial.org/images/software/docker-hub.png"
 alt="get it on Docker Hub" height="100"></a>
 </p>
 
@@ -167,14 +167,15 @@
 - Supports SSO (Single Sign-On)
 - Sending messages
 - Sending notices
 - Sending formatted messages
 - Sending MarkDown messages
 - Message splitting before sending
 - Sending Code-formatted messages
+- Sending emojis in messages via shorthand
 - Sending to one room
 - Sending to multiple rooms
 - Sending image files (photos, etc.)
 - Sending of media files (music, videos, etc.)
 - Sending of arbitrary files (PDF, xls, doc, txt, etc.)
 - Sending events such as emoji reactions, or replies as threads
 - Using events to edit sent messages
@@ -393,14 +394,16 @@
     - Python 3.8 or higher installed (3.7 will NOT work)
     - libolm-dev must be installed as it is required by matrix-nio
       - libolm-dev on Debian/Ubuntu, libolm-devel on Fedora, libolm on MacOS
     - matrix-nio must be installed, see https://github.com/poljar/matrix-nio
       - pip3 install --user --upgrade matrix-nio[e2e]
     - python3 package markdown must be installed to support MarkDown format
       - pip3 install --user --upgrade markdown
+    - python3 package emoji must be installed to support emojis in text messages
+      - pip3 install --user --upgrade emoji
     - python3 package python_magic must be installed to support image sending
       - pip3 install --user --upgrade python_magic
     - if (and only if) you want OS notification support, then the python3
       package notify2 and dbus-python should be installed
       - pip3 install --user --upgrade dbus-python # optional
       - pip3 install --user --upgrade notify2 # optional
     - python3 package urllib must be installed to support media download
@@ -498,14 +501,17 @@
 $ matrix-commander --message "Hello World!" # sends provided message
 $ echo "Hello World" | matrix-commander # pipe input msg into program
 $ matrix-commander -m msg1 -m msg2 # sends 2 messages
 $ matrix-commander -m msg1 msg2 msg3 # sends 3 messages
 $ df -h | matrix-commander --code # formatting for code/tables
 $ matrix-commander -m "<b>BOLD</b> and <i>ITALIC</i>" --html
 $ matrix-commander -m "- bullet1" --markdown
+$ matrix-commander -m "I :red_heart: you" --emojize
+$ matrix-commander -m "Well done :clapping_hands:" --emojize
+# See https://unicode.org/emoji/charts/full-emoji-list.html for emoji list
 $ # take input from an RSS feed and split large RSS entries into multiple
 $ # Matrix messages wherever the pattern "\n\n\n" is found
 $ rssfeed | matrix-commander --split "\n\n\n"
 $ matrix-commander --credentials usr1room2.json # select credentials file
 $ matrix-commander --store /var/storage/ # select store directory
 $ # Send to a specific room
 $ matrix-commander -m "hi" --room '!YourRoomId:example.com'
@@ -777,15 +783,15 @@
                         [--room-kick ROOM [ROOM ...]] [-u USER [USER ...]]
                         [--user-login USER] [--name ROOM_NAME [ROOM_NAME ...]]
                         [--topic ROOM_TOPIC [ROOM_TOPIC ...]]
                         [--alias ROOM_ALIAS [ROOM_ALIAS ...]]
                         [-m TEXT [TEXT ...]] [-i IMAGE_FILE [IMAGE_FILE ...]]
                         [-a AUDIO_FILE [AUDIO_FILE ...]] [-f FILE [FILE ...]]
                         [-e MATRIX_JSON_OBJECT [MATRIX_JSON_OBJECT ...]] [-w]
-                        [-z] [-k] [-p SEPARATOR] [--config CONFIG_FILE]
+                        [-z] [-k] [-j] [-p SEPARATOR] [--config CONFIG_FILE]
                         [--proxy PROXY] [-n] [--encrypted]
                         [-l [NEVER|ONCE|FOREVER|TAIL|ALL]] [-t [NUMBER]] [-y]
                         [--print-event-id]
                         [--download-media [DOWNLOAD_DIRECTORY]] [--os-notify]
                         [--set-device-name DEVICE_NAME]
                         [--set-display-name DISPLAY_NAME] [--get-display-name]
                         [--set-presence ONLINE|OFFLINE|UNAVAILABLE]
@@ -1225,14 +1231,19 @@
                         language.
   -k, --code            Send message as format "CODE". Details:: If not
                         specified, message will be sent as format "TEXT". If
                         both --html and --code are specified then --code takes
                         priority. This is useful for sending ASCII-art or
                         tabbed output like tables as a fixed-sized font will
                         be used for display.
+  -j, --emojize         Send message after emojizing. Details:: If not
+                        specified, message will be sent as format "TEXT". If
+                        both --code and --emojize are specified then --code
+                        takes priority. This is useful for sending emojis in
+                        shortcode form :collision:.
   -p SEPARATOR, --split SEPARATOR
                         Split message text into multiple Matrix messages.
                         Details:: If set, split the message(s) into multiple
                         messages wherever the string specified with --split
                         occurs. E.g. One pipes a stream of RSS articles into
                         the program and the articles are separated by three
                         newlines. Then with --split set to "\n\n\n" each
@@ -1823,15 +1834,15 @@
                         There is no 'calling home' on every run, only a 'check
                         pypi.org' upon request. Your privacy is protected. The
                         new release is neither downloaded, nor installed. It
                         just informs you. After printing version information
                         the program will continue to run. This is useful for
                         having version number in the log files.
 
-You are running version 6.0.2 2023-04-04. Enjoy, star on Github and contribute
+You are running version 7.0.0 2023-04-12. Enjoy, star on Github and contribute
 by submitting a Pull Request. Also have a look at matrix-commander-tui.
 ```
 
 # Autocompletion
 
 Tab completion is provided for shells (e.g. bash), courtesy of @mizlan).
 
@@ -1935,10 +1946,10 @@
 
 # Final Remarks
 
 - Thanks to all of you who already have contributed! So appreciated!
   - :heart: and :thumbsup: to @fyfe, @berlincount, @ezwen, @Scriptkiddi,
     @pelzvieh, @mizlan, @edwinsage, @jschwartzentruber, @nirgal, @benneti,
     @opk12, @pataquets, @KizzyCode, @murlock1000, @Benjamin-Loison,
-    @barathrm, etc.
+    @barathrm, @jonathandmoore, etc.
 - Enjoy!
 - Give it a :star: star on GitHub! Pull requests are welcome  :heart:
```

#### html2text {}

```diff
@@ -90,344 +90,348 @@
 it, use it, fork it, make a Pull Request or contribute. Please give it a :star:
 on Github right now so others find it more easily. :heart: # Features - CLI,
 Command Line Interface - Python 3 - Simplicity - Small footprint, small
 application (only around 250K) - Uses `nio-template` - End-to-end encryption -
 Storage for End-to-end encryption - Storage of credentials - Supports access
 token instead of password - Supports SSO (Single Sign-On) - Sending messages -
 Sending notices - Sending formatted messages - Sending MarkDown messages -
-Message splitting before sending - Sending Code-formatted messages - Sending to
-one room - Sending to multiple rooms - Sending image files (photos, etc.) -
-Sending of media files (music, videos, etc.) - Sending of arbitrary files (PDF,
-xls, doc, txt, etc.) - Sending events such as emoji reactions, or replies as
-threads - Using events to edit sent messages - Supports creating private DM
-rooms (thanks to PR from @murlock1000) - Supports DM (direct messaging),
-sending DMs, listening for DMs - Listing of joined rooms - Listing of members
-of given room(s) - Receiving messages forever - Receiving messages once -
-Receiving last messages - Receiving or skipping its own messages - Receiving
-and downloading media files - including automatic decryption - Creating new
-rooms - Joining rooms - Leaving rooms - Forgetting rooms - Inviting other users
-to rooms - Banning from rooms - Unbanning from rooms - Kicking from rooms -
-Supports renaming of device - Supports getting and setting display name -
-Supports getting and setting presence - Uploading, downloading, and deleting
-to/from resource depository - Listing your devices - Listing discovery info -
-Listing available login methods supported by server - Supports skipping SSL
-verification to use HTTP instead of HTTPS - Supports providing local SSL
-certificate files - Supports notification via OS of received messages -
-Supports periodic execution via crontab - Supports room aliases - Supports
-multiple output formats like `text` (for human consumption) and `json` (for
-machine consumption and further processing) - Provides PID files - Logging (at
-various levels) - In-source documentation - Can be run as a service - Smart tab
-completion for shells like bash (thanks to PR from @mizlan :clap:) - TUI tool
-for building commands (`matrix-commander-tui`) - More than 90 options - More
-than 300 stars :stars: on Github - Easy installation, available through `pip`,
-i.e. available in [PyPi](https://pypi.org/project/matrix-commander/) store -
-Easy installation, available as docker image on [Docker Hub](https://
-hub.docker.com/r/matrixcommander/matrix-commander) (thanks to PR from
-@pataquets :clap:) - Easy installation, available in Nix repository as
-reproducible [Nix package](https://search.nixos.org/packages?query=matrix-
-commander) - Callable from the terminal, from shells like `bash`, etc. -
-Callable from Python programs via the entry point (function) `main`. - Open
-source - Free, GPL3+ license # First Run, Set Up, Credentials File, End-to-end
-Encryption On the first run `matrix-commander` must be executed with the `--
-login` argument and the corresponding secondary arguments. This creates a
-credentials.json file. The credentials.json file stores: homeserver, user id,
-access token, device id, and default room id. On the first run, the --login
-run, it asks some questions if not everything is provided by arguments, creates
-the token and device id and stores everything in the credentials.json file. If
-desired, all arguments can be provided via arguments to that log in can be
-performed fully in batch. Since the credentials file holds an access token it
-should be protected and secured. One can use different credential files for
-different users or different rooms. On creation the credentials file will by
-default be created in the local directory, so the users sees it right away.
-This is fine if you have only one or a few credential files, but for better
-maintainability it is suggested to place your credentials files into directory
-$HOME/.config/matrix-commander/. When the program looks for a credentials file
-it will first look in local directory and then as secondary choice it will look
-in directory $HOME/.config/matrix-commander/. If you want to re-use an existing
-device id and an existing access token, you can do so as well, just manually
-edit the credentials file. However, for end-to-end encryption this will NOT
-work. End-to-end encryption (e2ee) is enabled by default. It cannot be turned
-off. Wherever possible end-to-end encryption will be used. For e2ee to work
-efficiently a `store` directory is needed to store e2ee data persistently. The
-default location for the store directory is a local directory named `store`.
-Alternatively, as a secondary choice the program looks for a store directory in
-$HOME/.local/shared/matrix-commander/store/. The user can always specify a
-different location via the --store argument. The `store` directory will usually
-be created on the first run. For specific use cases end-to-end encryption can
-be disabled. Please see description of flag `--plain` for details. From the
-second time the program is run, and on all future runs it will use the
-homeserver, user id and access token found in the credentials file to log into
-the Matrix account. Now this program can be used to easily send simple text
-messages, images, and so forth to the just configured room. # Verification As
-second step after the `--login`, it is recommended to perform an emoji
-verification by running `--verify`. Verification is always interactive, because
-the emojis need to be confirmed via the keyboard. If desired `--login` and `--
-verify` can be done in the same first run. The program can accept verification
-request and verify other devices via emojis. See `--verify` in help for more
-details. # Room Operations, Actions on Rooms The program can create rooms,
-join, leave and forget rooms. It can also send invitations to join rooms to
-others (given that user has the appropriate permissions) as well as ban, unban
-and kick other users from rooms. # Sending Messages to send can be provided 1)
-in the command line (-m or --message) 2) as input from the keyboard (if there
-is no other input or command) 3) through a pipe from stdin (|), i.e. piped in
-from another program. For sending messages the program supports various text
-formats: 1) text: default 2) html: HTML formatted text 3) markdown: MarkDown
-formatted text 4) code: used a block of fixed-sized font, ideal for ASCII art
-or tables, bash outputs, etc. 5) notification 6) split: splits messages into
-multiple units at given pattern Photos and images that can be sent. That
-includes files like .jpg, .gif, .png or .svg. Arbitrary files like .txt, .pdf,
-.doc, audio files like .mp3 or video files like .mp4 can also be sent. Matrix
-events like sending an emoji reaction, replying as a thread, message edits can
-be sent. # Listening, Receiving One can listen to one or multiple rooms.
-Received messages will be displayed on the screen. If desired, optionally, you
-can be notified of incoming messages through the operating system standard
-notification system, usually a small pop-up window. Messages can be received or
-listened to various ways: 1) Forever: the program runs forever, listens
-forever, and prints all messages as they arrive in real-time. 2) Once: the
-program prints all the messages that are waiting in the queue, i.e. all
-messages that have been sent in, and after printing them the program
-terminates. 3) Tail: prints the last N read or unread messages of one or
-multiple specified rooms and after printing them the program terminates. When
-listening to messages you can also choose to download and decrypt media. Say,
-someone is sending a song. The mp3 file can be downloaded and automatically
-decrypted for you. # Dependencies and Installation - If you install via `pip`,
-then `pip` will take care of most of the dependencies. - See https://pypi.org/
-project/matrix-commander - Usually `pip install matrix-commander` will do the
-trick. - But, note that even if you install via `pip` you must have a) Python
-3.8+ and b) `libolm` installed. See `PyPi-Instructions.md`. - Run `python -V`
-to get your Python version number and assure that it is 3.8+. - For e2ee
-support, python-olm is needed which requires the libolm C library (version
-3.x). See also https://gitlab.matrix.org/matrix-org/olm. Make sure that version
-3 is installed. Version 2 will not work. To install `libolm` do this: - On
-Debian, Ubuntu and Debian/Ubuntu derivative distributions: `sudo apt install
-libolm-dev` - On Fedora or Fedora derivative distributions do: `sudo dnf
-install libolm-devel` - On MacOS use brew: `brew install libolm` - For macOS
-Monterey 12.4 (21F79) (Apple M1 Pro) and similar please follow these steps for
-installation: - Install `libolm`, `dbus` and `libmagic` using Homebrew: - `brew
-install libolm dbus libmagic` - Install `matrix-commander` using this command:
-- `pip3 install --global-option=build_ext --global-option="-I/opt/homebrew/
-include/" --global-option="-L/opt/homebrew/lib/" matrix-commander` - For more
-details see Issue #79. Thanks to @KizzyCode for the contribution. - For macOS
-x86_64 and similar please follow these steps for installation: - `brew install
-libolm dbus libmagic` - `pip3 install poetry` - `pip3 install --global-
-option=build_ext --global-option="-I/usr/local/include/" --global-option="-L/
-usr/local/lib/" matrix-commander` - Notice that the Link and Include
-directories between ARM (M1, etc.) and x86-64 are different. So, check for
-example where file `olm.h` is located on your hard disk. That gives you a hint
-which Include directory to use. - For more details see Issue #103. Thanks to
-@johannes87 for the contribution. - If you install a docker image: `matrix-
-commander` is available on [Docker Hub](https://hub.docker.com/r/
-matrixcommander/matrix-commander) and hence easy to install as docker image (:
-clap: to @pataquets for his PR). Install via `docker pull matrixcommander/
-matrix-commander`. - If you install it via `git` or via file download then
-these are the dependencies that you must take care of: - Python 3.8 or higher
-installed (3.7 will NOT work) - libolm-dev must be installed as it is required
-by matrix-nio - libolm-dev on Debian/Ubuntu, libolm-devel on Fedora, libolm on
-MacOS - matrix-nio must be installed, see https://github.com/poljar/matrix-nio
-- pip3 install --user --upgrade matrix-nio[e2e] - python3 package markdown must
-be installed to support MarkDown format - pip3 install --user --upgrade
-markdown - python3 package python_magic must be installed to support image
-sending - pip3 install --user --upgrade python_magic - if (and only if) you
-want OS notification support, then the python3 package notify2 and dbus-python
-should be installed - pip3 install --user --upgrade dbus-python # optional -
-pip3 install --user --upgrade notify2 # optional - python3 package urllib must
-be installed to support media download - pip3 install --user --upgrade urllib -
-python3 package pyxdg must be installed to support `XDG_*` env vars. Be
-careful. Multiple packages install in the same directory `xdg` and overwrite
-each other. These packages can be conflicting. Specifically, packages `pyxdg`
-and `xdg` collide. If you already have `xdg` installed you cannot just simply
-install `pyxdg`; in this case you should opt for a separate Python environment.
-- pip3 install --user --upgrade pyxdg - `matrix_commander/matrix_commander.py`
-file must be installed, and should have execution permissions - chmod 755
-matrix_commander.py - `matrix_commander/matrix-commander` file is recommended
-for the install, and should have execution permissions - chmod 755 matrix-
-commander - for a full list or requirements look at the `requirements.txt` file
-- run `pip install -r requirements.txt` to automatically install all required
-Python packages - if you e.g. run on a headless server and don't want dbus-
-python and notify2, please remove the corresponding 2 lines from the
-`requirements.txt` file - Installing dependencies of `matrix-commander-tui` -
-`matrix-commander-tui` requires that you install `vipe` from the package
-`moreutils`. - Read https://www.putorius.net/moreutils.html for installation
-instructions. - As an alternative you could also install `vipe.sh` from https:/
-/github.com/0mp/vipe.sh/blob/master/vipe.sh. - `matrix-commander-tui` requires
-that you install `fzf`. - Read https://github.com/junegunn/fzf#installation for
-installation instructions. # Documentation and Resources - There are 4 level of
-details for the documentation. In sorted order from short summary to long
-details: - Just the options, no explanation: `matrix-commander --usage` or
-[online](https://github.com/8go/matrix-commander/blob/master/help.usage.txt) on
-Github - One-liner explanations for each option: `matrix-commander --help` or
-[online](https://github.com/8go/matrix-commander/blob/master/help.help.txt) on
-Github - Detailed verbose explanations for each option, like a man-page:
-`matrix-commander --manual` or [online](https://github.com/8go/matrix-
-commander/blob/master/help.manual.txt) on Github - Full documentation,
-installation, examples, use-cases, etc.: `matrix-commander --readme` or
-[online](https://github.com/8go/matrix-commander/blob/master/README.md) on
-Github # Examples of calling `matrix-commander` - Alternative 1: Usually
-`matrix-commander` is called from a terminal inside a shell like `bash`, `sh`,
-`zsh`, your Windows CMD terminal or similar. You will find plenty of examples
-how to use it within a terminal just a few lines down. Or invoke it via the TUI
-(Terminal User Interface) tool `matrix-commander-tui`. - Alternative 2:
-Sometimes, however, it might be more convenient to call `matrix-commander` from
-within a Python program. This is also possible. Import the Python module
-`matrix_commander` and use the provided entry point `main`. An example of how
-this can be done can be found in [tests/test-send.py]( https://github.com/8go/
-matrix-commander/blob/master/tests/test-send.py). ``` $ matrix-commander --
-login password # first run; will configure everything $ matrix-commander --
-login sso # alternative first run with Single Sign-On; $ # this will configure
-everything on a headless server w/o a browser $ # this created a
-credentials.json file, and a store directory. $ # optionally, if you want you
-can move credentials to app config directory $ mkdir $HOME/.config/matrix-
-commander # optional $ mv -i credentials.json $HOME/.config/matrix-commander/ $
-# optionally, if you want you can move store to the app share directory $ mkdir
-$HOME/.local/share/matrix-commander # optional $ mv -i store $HOME/.local/
-share/matrix-commander/ $ # Now you are ready to run program for a second time
-$ # Let us verify the device/room to where we want to send messages $ # The
-other device will issue a "verify by emoji" request $ matrix-commander --verify
-$ # Now program is both configured and verified, let us send the first message
-$ matrix-commander -m "First message!" $ matrix-commander --debug -m "First
-message!" # turn debugging on $ # turn debugging on also for submodules $
-matrix-commander --debug --debug -m "First message!" $ # turn debugging on,
-high verbosity $ matrix-commander --debug --verbose -m "First message!" $ #
-turn debugging on, very high verbosity $ matrix-commander --debug --verbose --
-verbose -m "First message!" $ # maximum debugging info $ matrix-commander --
-debug --debug --verbose --verbose -m "First message!" $ matrix-commander --help
-# print help $ matrix-commander # this will ask user for message to send $
-matrix-commander --message "Hello World!" # sends provided message $ echo
-"Hello World" | matrix-commander # pipe input msg into program $ matrix-
-commander -m msg1 -m msg2 # sends 2 messages $ matrix-commander -m msg1 msg2
-msg3 # sends 3 messages $ df -h | matrix-commander --code # formatting for
-code/tables $ matrix-commander -m "BOLD and ITALIC" --html $ matrix-commander -
-m "- bullet1" --markdown $ # take input from an RSS feed and split large RSS
-entries into multiple $ # Matrix messages wherever the pattern "\n\n\n" is
-found $ rssfeed | matrix-commander --split "\n\n\n" $ matrix-commander --
-credentials usr1room2.json # select credentials file $ matrix-commander --store
-/var/storage/ # select store directory $ # Send to a specific room $ matrix-
-commander -m "hi" --room '!YourRoomId:example.com' $ # some shells require the
-! of the room id to be escaped with \ $ matrix-commander -m "hi" --room
-"\!YourRoomId:example.com" $ # Send to multiple rooms $ matrix-commander -
-m "hi" -r '!r1:example.com' '!r2:example.com' $ # Send to multiple rooms,
-another way $ matrix-commander -m "hi" -r '!r1:example.com' -r '!r2:
-example.com' $ # Send to a specific user, DM, direct messaging, using full user
-id $ matrix-commander -m "hi" --user '@MyFriend:example.com' $ # Send to a
-specific user, DM, direct messaging, using partial user id $ # It will be
-assumed that user @MyFriend is on same homeserver $ matrix-commander -m "hi" --
-user '@MyFriend' $ # Send to a specific user, DM, direct messaging, using
-display name $ # Careful! Display names might not be unique. Don't DM the wrong
-person! $ # To double-check the display names do a --joined-members "*" $
-matrix-commander -m "hi" -u 'Joe' $ # Send to multiple users $ matrix-commander
--m "hi" -u '@Joe:example.com' '@Jane:example.com' $ # Send to multiple users,
-another way $ matrix-commander -m "hi" -u '@Joe:example.com' -u '@Jane:
-example.com' $ # send 2 images and 1 text, text will be sent last $ matrix-
-commander -i photo1.jpg photo2.img -m "Do you like my 2 photos?" $ # send 1
-image and no text $ matrix-commander -i photo1.jpg $ # pipe 1 image and no text
-$ cat image1.jpg | matrix-commander -i - $ # send 1 audio and 1 text to 2 rooms
-$ matrix-commander -a song.mp3 -m "Do you like this song?" \ -r '!someroom1:
-example.com' '!someroom2:example.com' $ # send 2 audios, 1 via stdin pipe $
-audio-generator | matrix-commander -a intro.mp3 - $ # send a .pdf file and a
-video with a text $ matrix-commander -f example.pdf video.mp4 -m "Here are the
-promised files" $ # send a .pdf file via stdin pipe $ pdf-generator | matrix-
-commander -f - $ # listen forever, get msgs in real-time and notify me via OS $
-matrix-commander --listen forever --os-notify $ # listen forever, and show me
-also my own messages $ matrix-commander --listen forever --listen-self $ #
-listen once, get any new messages and quit $ matrix-commander --listen once --
-listen-self $ matrix-commander --listen once --listen-self | process-in-other-
-app $ # listen to tail, get the last N messages and quit $ matrix-commander --
-listen tail --tail 10 --listen-self $ # listen to tail, another way of
-specifying it $ matrix-commander --tail 10 --listen-self | process-in-other-app
-$ # get the very last message $ matrix-commander --tail 1 --listen-self $ #
-listen to (get) all messages, old and new, and process them in another app $
-matrix-commander --listen all | process-in-other-app $ # listen to (get) all
-messages, including own $ matrix-commander --listen all --listen-self $ # set,
-rename device-name, sometimes also called device display-name $ matrix-
-commander --set-device-name "my new device name" $ # set, rename display name
-for authenticated user $ matrix-commander --set-display-name "Alex" $ # get
-display name for authenticated user, for itself $ matrix-commander --get-
-display-name $ # get display name for other users $ matrix-commander --get-
-display-name \ --user '@user1:example.com' '@user2:example.com' $ # list all
-the rooms that I am a member of, all joined rooms $ matrix-commander --joined-
-rooms $ # list all the members of 2 specific rooms $ matrix-commander --joined-
-members '!someroomId1:example.com' \ '!someroomId2:example.com' $ # list all
-the members of all rooms that I am member of $ matrix-commander --joined-
-members '*' $ # set presence $ matrix-commander --set-presence "unavailable" $
-# get presence of matrix-commander itself $ matrix-commander --get-presence $ #
-get presence of other users $ matrix-commander --get-presence \ --user '@user1:
-example.com' '@user2:example.com' $ # upload file to resource repository $
-matrix-commander --upload "avatar.png" $ # download file from resource
-repository via URI (MXC) $ matrix-commander --download "mxc://example.com/
-SomeStrangeUriKey" $ matrix-commander --delete-mxc mxc://... # delete image
-from database $ matrix-commander --delete-mxc-before '20.01.2022 19:38:42'
-1024000 $ # for more examples of --upload, --download, --delete-mxc, $ # --
-delete-mxc-before, --mxc-to-http, see file tests/test-upload.sh $ matrix-
-commander --rest GET "" '__homeserver__/_matrix/client/versions' $ # for more
-examples of --rest see file tests/test-rest.sh $ matrix-commander --get-avatar
-# get its own avatar MXC URI $ # get avatar MXC URIs of other users $ matrix-
-commander --get-avatar '@user1:example.com' '@user2:example.com' $ matrix-
-commander --set-avatar mxc://... # set its own avatar MXC URI $ # for more
-examples of --set_avatar see tests/test-setget.sh $ matrix-commander --get-
-profile # get its own user profile $ matrix-commander --get-profile '@user1:
-example.com' '@user2:example.com' $ matrix-commander --get-room-info # get its
-default room info $ matrix-commander --get-room-info '\!room1:example.com' \
-'\!room2:example.com' # get room info for multiple rooms $ # map from room id
-to room alias $ matrix-commander --get-room-info '\!roomId1:example.com' $ #
-map from room alias to room id $ matrix-commander --get-room-info '#roomAlias1:
-example.com' $ matrix-commander --get-client-info # get client info $ matrix-
-commander --has-permission '!someroomId1:example.com' 'ban' $ matrix-commander
---export-keys mykeys "my passphrase" # export keys $ matrix-commander --import-
-keys mykeys "my passphrase" # import keys $ matrix-commander --get-openid-token
-# get its own OpenId token $ # get OpenID tokens for other users $ matrix-
-commander --get-openid-token '@user1:example.com' '@user2:example.com' $
-matrix-commander --room-get-visibility # get default room visibility $ matrix-
-commander --room-get-visibility \ '\!someroomId1:example.com' '\!someroomId2:
-example.com' $ matrix-commander --room-set-alias '#someRoomAlias:
-matrix.example.com' $ matrix-commander --room-set-alias 'someRoomAlias' \
-'\!someroomId1:example.com' $ matrix-commander --room-resolve-alias
-'#someRoomAlias:matrix.example.com' $ matrix-commander --room-resolve-alias
-'#someRoomAlias1:matrix.example.com' \ 'someRoomAlias2' $ matrix-commander --
-room-delete-alias '#someRoomAlias:matrix.example.com' $ matrix-commander --
-room-delete-alias '#someRoomAlias1:matrix.example.com' \ 'someRoomAlias2' $
-matrix-commander --room-get-state # get state of default room $ matrix-
-commander --room-get-state \ '\!someroomId1:example.com' '\!someroomId2:
-example.com' $ matrix-commander --delete-device "QBUAZIFURK" --password 'mc-
-password' $ matrix-commander --delete-device "QBUAZIFURK" "AUIECTSRND" \ --user
-'@user1:example.com' --password 'user1-password' $ # delete a message with
-event id 'someEventId' # matrix-commander --room-redact '!someroomId1:
-example.com' 'someEventId' $ # delete 2 images from 2 rooms $ matrix-commander
---room-redact \ '\!someroomId1:example.com' '\$someEventId1' 'Image deleted,
-obsolete info' '\!someroomId2:example.com' '\$someEventId2' 'Image deleted,
-outdated' $ # print its own user id $ matrix-commander --whoami $ # skip SSL
-certificate verification for a homeserver without SSL $ matrix-commander --no-
-ssl -m "also working without Let's Encrypt SSL" $ # use your own SSL
-certificate for a homeserver with SSL and local certs $ matrix-commander --ssl-
-certificate mycert.crt -m "using my own cert" $ # download and decrypt media
-files like images, audio, PDF, etc. $ # and store downloaded files in directory
-"mymedia" $ matrix-commander --listen forever --listen-self --download-media
-mymedia $ # create rooms without name and topic, just with alias, use a simple
-alias $ matrix-commander --room-create roomAlias1 $ # don't use a well formed
-alias like '#roomAlias1:example.com' as it will $ # confuse the server! $ #
-BAD: matrix-commander --room-create roomAlias1 '#roomAlias1:example.com' $ #
-create rooms with name and topic $ matrix-commander --room-create roomAlias3 --
-name 'Fancy Room' \ --topic 'All about Matrix' $ matrix-commander --room-create
-roomAlias4 roomAlias5 \ --name 'Fancy Room 4' -name 'Cute Room 5' \ --topic
-'All about Matrix 4' 'All about Nio 5' $ # create DM rooms with user. $ matrix-
-commander --room-dm-create '@user1:example.com' $ # create DM rooms with name,
-topic, alias $ matrix-commander --room-dm-create '@user1:example.com' '@user2:
-example.com' \ --name 'Fancy DM room 4' -name 'Cute DM room 4' \ --topic 'All
-about Matrix 4' 'All about Nio 5' \ --alias roomAlias1 '#roomAlias2:
-example.com' $ # rooms (normal as well as DM) are by default created encrypted,
-$ # to overwrite that and to create a room with encryption disabled use --plain
-$ matrix-commander --room-create public-room-alias2 --plain $ matrix-commander
---room-dm-create not-encrypted-alias3 --plain $ # join rooms $ matrix-commander
---room-join '!someroomId1:example.com' \ '!someroomId2:example.com'
-'#roomAlias1:example.com' $ # leave rooms $ matrix-commander --room-leave
-'#roomAlias1:example.com' \ '!someroomId2:example.com' $ # forget rooms, you
-have to first leave a room before you forget it $ matrix-commander --room-
-forget '#roomAlias1:example.com' $ # invite users to rooms $ matrix-commander -
--room-invite '#roomAlias1:example.com' \ --user '@user1:example.com' '@user2:
-example.com' $ # ban users from rooms $ matrix-commander --room-ban
-'!someroom1:example.com' \ '!someroom2:example.com' \ --user '@user1:
+Message splitting before sending - Sending Code-formatted messages - Sending
+emojis in messages via shorthand - Sending to one room - Sending to multiple
+rooms - Sending image files (photos, etc.) - Sending of media files (music,
+videos, etc.) - Sending of arbitrary files (PDF, xls, doc, txt, etc.) - Sending
+events such as emoji reactions, or replies as threads - Using events to edit
+sent messages - Supports creating private DM rooms (thanks to PR from
+@murlock1000) - Supports DM (direct messaging), sending DMs, listening for DMs
+- Listing of joined rooms - Listing of members of given room(s) - Receiving
+messages forever - Receiving messages once - Receiving last messages -
+Receiving or skipping its own messages - Receiving and downloading media files
+- including automatic decryption - Creating new rooms - Joining rooms - Leaving
+rooms - Forgetting rooms - Inviting other users to rooms - Banning from rooms -
+Unbanning from rooms - Kicking from rooms - Supports renaming of device -
+Supports getting and setting display name - Supports getting and setting
+presence - Uploading, downloading, and deleting to/from resource depository -
+Listing your devices - Listing discovery info - Listing available login methods
+supported by server - Supports skipping SSL verification to use HTTP instead of
+HTTPS - Supports providing local SSL certificate files - Supports notification
+via OS of received messages - Supports periodic execution via crontab -
+Supports room aliases - Supports multiple output formats like `text` (for human
+consumption) and `json` (for machine consumption and further processing) -
+Provides PID files - Logging (at various levels) - In-source documentation -
+Can be run as a service - Smart tab completion for shells like bash (thanks to
+PR from @mizlan :clap:) - TUI tool for building commands (`matrix-commander-
+tui`) - More than 90 options - More than 300 stars :stars: on Github - Easy
+installation, available through `pip`, i.e. available in [PyPi](https://
+pypi.org/project/matrix-commander/) store - Easy installation, available as
+docker image on [Docker Hub](https://hub.docker.com/r/matrixcommander/matrix-
+commander) (thanks to PR from @pataquets :clap:) - Easy installation, available
+in Nix repository as reproducible [Nix package](https://search.nixos.org/
+packages?query=matrix-commander) - Callable from the terminal, from shells like
+`bash`, etc. - Callable from Python programs via the entry point (function)
+`main`. - Open source - Free, GPL3+ license # First Run, Set Up, Credentials
+File, End-to-end Encryption On the first run `matrix-commander` must be
+executed with the `--login` argument and the corresponding secondary arguments.
+This creates a credentials.json file. The credentials.json file stores:
+homeserver, user id, access token, device id, and default room id. On the first
+run, the --login run, it asks some questions if not everything is provided by
+arguments, creates the token and device id and stores everything in the
+credentials.json file. If desired, all arguments can be provided via arguments
+to that log in can be performed fully in batch. Since the credentials file
+holds an access token it should be protected and secured. One can use different
+credential files for different users or different rooms. On creation the
+credentials file will by default be created in the local directory, so the
+users sees it right away. This is fine if you have only one or a few credential
+files, but for better maintainability it is suggested to place your credentials
+files into directory $HOME/.config/matrix-commander/. When the program looks
+for a credentials file it will first look in local directory and then as
+secondary choice it will look in directory $HOME/.config/matrix-commander/. If
+you want to re-use an existing device id and an existing access token, you can
+do so as well, just manually edit the credentials file. However, for end-to-end
+encryption this will NOT work. End-to-end encryption (e2ee) is enabled by
+default. It cannot be turned off. Wherever possible end-to-end encryption will
+be used. For e2ee to work efficiently a `store` directory is needed to store
+e2ee data persistently. The default location for the store directory is a local
+directory named `store`. Alternatively, as a secondary choice the program looks
+for a store directory in $HOME/.local/shared/matrix-commander/store/. The user
+can always specify a different location via the --store argument. The `store`
+directory will usually be created on the first run. For specific use cases end-
+to-end encryption can be disabled. Please see description of flag `--plain` for
+details. From the second time the program is run, and on all future runs it
+will use the homeserver, user id and access token found in the credentials file
+to log into the Matrix account. Now this program can be used to easily send
+simple text messages, images, and so forth to the just configured room. #
+Verification As second step after the `--login`, it is recommended to perform
+an emoji verification by running `--verify`. Verification is always
+interactive, because the emojis need to be confirmed via the keyboard. If
+desired `--login` and `--verify` can be done in the same first run. The program
+can accept verification request and verify other devices via emojis. See `--
+verify` in help for more details. # Room Operations, Actions on Rooms The
+program can create rooms, join, leave and forget rooms. It can also send
+invitations to join rooms to others (given that user has the appropriate
+permissions) as well as ban, unban and kick other users from rooms. # Sending
+Messages to send can be provided 1) in the command line (-m or --message) 2) as
+input from the keyboard (if there is no other input or command) 3) through a
+pipe from stdin (|), i.e. piped in from another program. For sending messages
+the program supports various text formats: 1) text: default 2) html: HTML
+formatted text 3) markdown: MarkDown formatted text 4) code: used a block of
+fixed-sized font, ideal for ASCII art or tables, bash outputs, etc. 5)
+notification 6) split: splits messages into multiple units at given pattern
+Photos and images that can be sent. That includes files like .jpg, .gif, .png
+or .svg. Arbitrary files like .txt, .pdf, .doc, audio files like .mp3 or video
+files like .mp4 can also be sent. Matrix events like sending an emoji reaction,
+replying as a thread, message edits can be sent. # Listening, Receiving One can
+listen to one or multiple rooms. Received messages will be displayed on the
+screen. If desired, optionally, you can be notified of incoming messages
+through the operating system standard notification system, usually a small pop-
+up window. Messages can be received or listened to various ways: 1) Forever:
+the program runs forever, listens forever, and prints all messages as they
+arrive in real-time. 2) Once: the program prints all the messages that are
+waiting in the queue, i.e. all messages that have been sent in, and after
+printing them the program terminates. 3) Tail: prints the last N read or unread
+messages of one or multiple specified rooms and after printing them the program
+terminates. When listening to messages you can also choose to download and
+decrypt media. Say, someone is sending a song. The mp3 file can be downloaded
+and automatically decrypted for you. # Dependencies and Installation - If you
+install via `pip`, then `pip` will take care of most of the dependencies. - See
+https://pypi.org/project/matrix-commander - Usually `pip install matrix-
+commander` will do the trick. - But, note that even if you install via `pip`
+you must have a) Python 3.8+ and b) `libolm` installed. See `PyPi-
+Instructions.md`. - Run `python -V` to get your Python version number and
+assure that it is 3.8+. - For e2ee support, python-olm is needed which requires
+the libolm C library (version 3.x). See also https://gitlab.matrix.org/matrix-
+org/olm. Make sure that version 3 is installed. Version 2 will not work. To
+install `libolm` do this: - On Debian, Ubuntu and Debian/Ubuntu derivative
+distributions: `sudo apt install libolm-dev` - On Fedora or Fedora derivative
+distributions do: `sudo dnf install libolm-devel` - On MacOS use brew: `brew
+install libolm` - For macOS Monterey 12.4 (21F79) (Apple M1 Pro) and similar
+please follow these steps for installation: - Install `libolm`, `dbus` and
+`libmagic` using Homebrew: - `brew install libolm dbus libmagic` - Install
+`matrix-commander` using this command: - `pip3 install --global-
+option=build_ext --global-option="-I/opt/homebrew/include/" --global-option="-
+L/opt/homebrew/lib/" matrix-commander` - For more details see Issue #79. Thanks
+to @KizzyCode for the contribution. - For macOS x86_64 and similar please
+follow these steps for installation: - `brew install libolm dbus libmagic` -
+`pip3 install poetry` - `pip3 install --global-option=build_ext --global-
+option="-I/usr/local/include/" --global-option="-L/usr/local/lib/" matrix-
+commander` - Notice that the Link and Include directories between ARM (M1,
+etc.) and x86-64 are different. So, check for example where file `olm.h` is
+located on your hard disk. That gives you a hint which Include directory to
+use. - For more details see Issue #103. Thanks to @johannes87 for the
+contribution. - If you install a docker image: `matrix-commander` is available
+on [Docker Hub](https://hub.docker.com/r/matrixcommander/matrix-commander) and
+hence easy to install as docker image (:clap: to @pataquets for his PR).
+Install via `docker pull matrixcommander/matrix-commander`. - If you install it
+via `git` or via file download then these are the dependencies that you must
+take care of: - Python 3.8 or higher installed (3.7 will NOT work) - libolm-dev
+must be installed as it is required by matrix-nio - libolm-dev on Debian/
+Ubuntu, libolm-devel on Fedora, libolm on MacOS - matrix-nio must be installed,
+see https://github.com/poljar/matrix-nio - pip3 install --user --upgrade
+matrix-nio[e2e] - python3 package markdown must be installed to support
+MarkDown format - pip3 install --user --upgrade markdown - python3 package
+emoji must be installed to support emojis in text messages - pip3 install --
+user --upgrade emoji - python3 package python_magic must be installed to
+support image sending - pip3 install --user --upgrade python_magic - if (and
+only if) you want OS notification support, then the python3 package notify2 and
+dbus-python should be installed - pip3 install --user --upgrade dbus-python #
+optional - pip3 install --user --upgrade notify2 # optional - python3 package
+urllib must be installed to support media download - pip3 install --user --
+upgrade urllib - python3 package pyxdg must be installed to support `XDG_*` env
+vars. Be careful. Multiple packages install in the same directory `xdg` and
+overwrite each other. These packages can be conflicting. Specifically, packages
+`pyxdg` and `xdg` collide. If you already have `xdg` installed you cannot just
+simply install `pyxdg`; in this case you should opt for a separate Python
+environment. - pip3 install --user --upgrade pyxdg - `matrix_commander/
+matrix_commander.py` file must be installed, and should have execution
+permissions - chmod 755 matrix_commander.py - `matrix_commander/matrix-
+commander` file is recommended for the install, and should have execution
+permissions - chmod 755 matrix-commander - for a full list or requirements look
+at the `requirements.txt` file - run `pip install -r requirements.txt` to
+automatically install all required Python packages - if you e.g. run on a
+headless server and don't want dbus-python and notify2, please remove the
+corresponding 2 lines from the `requirements.txt` file - Installing
+dependencies of `matrix-commander-tui` - `matrix-commander-tui` requires that
+you install `vipe` from the package `moreutils`. - Read https://
+www.putorius.net/moreutils.html for installation instructions. - As an
+alternative you could also install `vipe.sh` from https://github.com/0mp/
+vipe.sh/blob/master/vipe.sh. - `matrix-commander-tui` requires that you install
+`fzf`. - Read https://github.com/junegunn/fzf#installation for installation
+instructions. # Documentation and Resources - There are 4 level of details for
+the documentation. In sorted order from short summary to long details: - Just
+the options, no explanation: `matrix-commander --usage` or [online](https://
+github.com/8go/matrix-commander/blob/master/help.usage.txt) on Github - One-
+liner explanations for each option: `matrix-commander --help` or [online]
+(https://github.com/8go/matrix-commander/blob/master/help.help.txt) on Github -
+Detailed verbose explanations for each option, like a man-page: `matrix-
+commander --manual` or [online](https://github.com/8go/matrix-commander/blob/
+master/help.manual.txt) on Github - Full documentation, installation, examples,
+use-cases, etc.: `matrix-commander --readme` or [online](https://github.com/
+8go/matrix-commander/blob/master/README.md) on Github # Examples of calling
+`matrix-commander` - Alternative 1: Usually `matrix-commander` is called from a
+terminal inside a shell like `bash`, `sh`, `zsh`, your Windows CMD terminal or
+similar. You will find plenty of examples how to use it within a terminal just
+a few lines down. Or invoke it via the TUI (Terminal User Interface) tool
+`matrix-commander-tui`. - Alternative 2: Sometimes, however, it might be more
+convenient to call `matrix-commander` from within a Python program. This is
+also possible. Import the Python module `matrix_commander` and use the provided
+entry point `main`. An example of how this can be done can be found in [tests/
+test-send.py]( https://github.com/8go/matrix-commander/blob/master/tests/test-
+send.py). ``` $ matrix-commander --login password # first run; will configure
+everything $ matrix-commander --login sso # alternative first run with Single
+Sign-On; $ # this will configure everything on a headless server w/o a browser
+$ # this created a credentials.json file, and a store directory. $ #
+optionally, if you want you can move credentials to app config directory $
+mkdir $HOME/.config/matrix-commander # optional $ mv -i credentials.json
+$HOME/.config/matrix-commander/ $ # optionally, if you want you can move store
+to the app share directory $ mkdir $HOME/.local/share/matrix-commander #
+optional $ mv -i store $HOME/.local/share/matrix-commander/ $ # Now you are
+ready to run program for a second time $ # Let us verify the device/room to
+where we want to send messages $ # The other device will issue a "verify by
+emoji" request $ matrix-commander --verify $ # Now program is both configured
+and verified, let us send the first message $ matrix-commander -m "First
+message!" $ matrix-commander --debug -m "First message!" # turn debugging on $
+# turn debugging on also for submodules $ matrix-commander --debug --debug -
+m "First message!" $ # turn debugging on, high verbosity $ matrix-commander --
+debug --verbose -m "First message!" $ # turn debugging on, very high verbosity
+$ matrix-commander --debug --verbose --verbose -m "First message!" $ # maximum
+debugging info $ matrix-commander --debug --debug --verbose --verbose -m "First
+message!" $ matrix-commander --help # print help $ matrix-commander # this will
+ask user for message to send $ matrix-commander --message "Hello World!" #
+sends provided message $ echo "Hello World" | matrix-commander # pipe input msg
+into program $ matrix-commander -m msg1 -m msg2 # sends 2 messages $ matrix-
+commander -m msg1 msg2 msg3 # sends 3 messages $ df -h | matrix-commander --
+code # formatting for code/tables $ matrix-commander -m "BOLD and ITALIC" --
+html $ matrix-commander -m "- bullet1" --markdown $ matrix-commander -m "I :
+red_heart: you" --emojize $ matrix-commander -m "Well done :clapping_hands:" --
+emojize # See https://unicode.org/emoji/charts/full-emoji-list.html for emoji
+list $ # take input from an RSS feed and split large RSS entries into multiple
+$ # Matrix messages wherever the pattern "\n\n\n" is found $ rssfeed | matrix-
+commander --split "\n\n\n" $ matrix-commander --credentials usr1room2.json #
+select credentials file $ matrix-commander --store /var/storage/ # select store
+directory $ # Send to a specific room $ matrix-commander -m "hi" --room
+'!YourRoomId:example.com' $ # some shells require the ! of the room id to be
+escaped with \ $ matrix-commander -m "hi" --room "\!YourRoomId:example.com" $ #
+Send to multiple rooms $ matrix-commander -m "hi" -r '!r1:example.com' '!r2:
+example.com' $ # Send to multiple rooms, another way $ matrix-commander -m "hi"
+-r '!r1:example.com' -r '!r2:example.com' $ # Send to a specific user, DM,
+direct messaging, using full user id $ matrix-commander -m "hi" --user
+'@MyFriend:example.com' $ # Send to a specific user, DM, direct messaging,
+using partial user id $ # It will be assumed that user @MyFriend is on same
+homeserver $ matrix-commander -m "hi" --user '@MyFriend' $ # Send to a specific
+user, DM, direct messaging, using display name $ # Careful! Display names might
+not be unique. Don't DM the wrong person! $ # To double-check the display names
+do a --joined-members "*" $ matrix-commander -m "hi" -u 'Joe' $ # Send to
+multiple users $ matrix-commander -m "hi" -u '@Joe:example.com' '@Jane:
+example.com' $ # Send to multiple users, another way $ matrix-commander -m "hi"
+-u '@Joe:example.com' -u '@Jane:example.com' $ # send 2 images and 1 text, text
+will be sent last $ matrix-commander -i photo1.jpg photo2.img -m "Do you like
+my 2 photos?" $ # send 1 image and no text $ matrix-commander -i photo1.jpg $ #
+pipe 1 image and no text $ cat image1.jpg | matrix-commander -i - $ # send 1
+audio and 1 text to 2 rooms $ matrix-commander -a song.mp3 -m "Do you like this
+song?" \ -r '!someroom1:example.com' '!someroom2:example.com' $ # send 2
+audios, 1 via stdin pipe $ audio-generator | matrix-commander -a intro.mp3 - $
+# send a .pdf file and a video with a text $ matrix-commander -f example.pdf
+video.mp4 -m "Here are the promised files" $ # send a .pdf file via stdin pipe
+$ pdf-generator | matrix-commander -f - $ # listen forever, get msgs in real-
+time and notify me via OS $ matrix-commander --listen forever --os-notify $ #
+listen forever, and show me also my own messages $ matrix-commander --listen
+forever --listen-self $ # listen once, get any new messages and quit $ matrix-
+commander --listen once --listen-self $ matrix-commander --listen once --
+listen-self | process-in-other-app $ # listen to tail, get the last N messages
+and quit $ matrix-commander --listen tail --tail 10 --listen-self $ # listen to
+tail, another way of specifying it $ matrix-commander --tail 10 --listen-self |
+process-in-other-app $ # get the very last message $ matrix-commander --tail 1
+--listen-self $ # listen to (get) all messages, old and new, and process them
+in another app $ matrix-commander --listen all | process-in-other-app $ #
+listen to (get) all messages, including own $ matrix-commander --listen all --
+listen-self $ # set, rename device-name, sometimes also called device display-
+name $ matrix-commander --set-device-name "my new device name" $ # set, rename
+display name for authenticated user $ matrix-commander --set-display-name
+"Alex" $ # get display name for authenticated user, for itself $ matrix-
+commander --get-display-name $ # get display name for other users $ matrix-
+commander --get-display-name \ --user '@user1:example.com' '@user2:example.com'
+$ # list all the rooms that I am a member of, all joined rooms $ matrix-
+commander --joined-rooms $ # list all the members of 2 specific rooms $ matrix-
+commander --joined-members '!someroomId1:example.com' \ '!someroomId2:
+example.com' $ # list all the members of all rooms that I am member of $
+matrix-commander --joined-members '*' $ # set presence $ matrix-commander --
+set-presence "unavailable" $ # get presence of matrix-commander itself $
+matrix-commander --get-presence $ # get presence of other users $ matrix-
+commander --get-presence \ --user '@user1:example.com' '@user2:example.com' $ #
+upload file to resource repository $ matrix-commander --upload "avatar.png" $ #
+download file from resource repository via URI (MXC) $ matrix-commander --
+download "mxc://example.com/SomeStrangeUriKey" $ matrix-commander --delete-mxc
+mxc://... # delete image from database $ matrix-commander --delete-mxc-before
+'20.01.2022 19:38:42' 1024000 $ # for more examples of --upload, --download, --
+delete-mxc, $ # --delete-mxc-before, --mxc-to-http, see file tests/test-
+upload.sh $ matrix-commander --rest GET "" '__homeserver__/_matrix/client/
+versions' $ # for more examples of --rest see file tests/test-rest.sh $ matrix-
+commander --get-avatar # get its own avatar MXC URI $ # get avatar MXC URIs of
+other users $ matrix-commander --get-avatar '@user1:example.com' '@user2:
+example.com' $ matrix-commander --set-avatar mxc://... # set its own avatar MXC
+URI $ # for more examples of --set_avatar see tests/test-setget.sh $ matrix-
+commander --get-profile # get its own user profile $ matrix-commander --get-
+profile '@user1:example.com' '@user2:example.com' $ matrix-commander --get-
+room-info # get its default room info $ matrix-commander --get-room-info
+'\!room1:example.com' \ '\!room2:example.com' # get room info for multiple
+rooms $ # map from room id to room alias $ matrix-commander --get-room-info
+'\!roomId1:example.com' $ # map from room alias to room id $ matrix-commander -
+-get-room-info '#roomAlias1:example.com' $ matrix-commander --get-client-info #
+get client info $ matrix-commander --has-permission '!someroomId1:example.com'
+'ban' $ matrix-commander --export-keys mykeys "my passphrase" # export keys $
+matrix-commander --import-keys mykeys "my passphrase" # import keys $ matrix-
+commander --get-openid-token # get its own OpenId token $ # get OpenID tokens
+for other users $ matrix-commander --get-openid-token '@user1:example.com'
+'@user2:example.com' $ matrix-commander --room-get-visibility # get default
+room visibility $ matrix-commander --room-get-visibility \ '\!someroomId1:
+example.com' '\!someroomId2:example.com' $ matrix-commander --room-set-alias
+'#someRoomAlias:matrix.example.com' $ matrix-commander --room-set-alias
+'someRoomAlias' \ '\!someroomId1:example.com' $ matrix-commander --room-
+resolve-alias '#someRoomAlias:matrix.example.com' $ matrix-commander --room-
+resolve-alias '#someRoomAlias1:matrix.example.com' \ 'someRoomAlias2' $ matrix-
+commander --room-delete-alias '#someRoomAlias:matrix.example.com' $ matrix-
+commander --room-delete-alias '#someRoomAlias1:matrix.example.com' \
+'someRoomAlias2' $ matrix-commander --room-get-state # get state of default
+room $ matrix-commander --room-get-state \ '\!someroomId1:example.com'
+'\!someroomId2:example.com' $ matrix-commander --delete-device "QBUAZIFURK" --
+password 'mc-password' $ matrix-commander --delete-device "QBUAZIFURK"
+"AUIECTSRND" \ --user '@user1:example.com' --password 'user1-password' $ #
+delete a message with event id 'someEventId' # matrix-commander --room-redact
+'!someroomId1:example.com' 'someEventId' $ # delete 2 images from 2 rooms $
+matrix-commander --room-redact \ '\!someroomId1:example.com' '\$someEventId1'
+'Image deleted, obsolete info' '\!someroomId2:example.com' '\$someEventId2'
+'Image deleted, outdated' $ # print its own user id $ matrix-commander --whoami
+$ # skip SSL certificate verification for a homeserver without SSL $ matrix-
+commander --no-ssl -m "also working without Let's Encrypt SSL" $ # use your own
+SSL certificate for a homeserver with SSL and local certs $ matrix-commander --
+ssl-certificate mycert.crt -m "using my own cert" $ # download and decrypt
+media files like images, audio, PDF, etc. $ # and store downloaded files in
+directory "mymedia" $ matrix-commander --listen forever --listen-self --
+download-media mymedia $ # create rooms without name and topic, just with
+alias, use a simple alias $ matrix-commander --room-create roomAlias1 $ # don't
+use a well formed alias like '#roomAlias1:example.com' as it will $ # confuse
+the server! $ # BAD: matrix-commander --room-create roomAlias1 '#roomAlias1:
+example.com' $ # create rooms with name and topic $ matrix-commander --room-
+create roomAlias3 --name 'Fancy Room' \ --topic 'All about Matrix' $ matrix-
+commander --room-create roomAlias4 roomAlias5 \ --name 'Fancy Room 4' -name
+'Cute Room 5' \ --topic 'All about Matrix 4' 'All about Nio 5' $ # create DM
+rooms with user. $ matrix-commander --room-dm-create '@user1:example.com' $ #
+create DM rooms with name, topic, alias $ matrix-commander --room-dm-create
+'@user1:example.com' '@user2:example.com' \ --name 'Fancy DM room 4' -name
+'Cute DM room 4' \ --topic 'All about Matrix 4' 'All about Nio 5' \ --alias
+roomAlias1 '#roomAlias2:example.com' $ # rooms (normal as well as DM) are by
+default created encrypted, $ # to overwrite that and to create a room with
+encryption disabled use --plain $ matrix-commander --room-create public-room-
+alias2 --plain $ matrix-commander --room-dm-create not-encrypted-alias3 --plain
+$ # join rooms $ matrix-commander --room-join '!someroomId1:example.com' \
+'!someroomId2:example.com' '#roomAlias1:example.com' $ # leave rooms $ matrix-
+commander --room-leave '#roomAlias1:example.com' \ '!someroomId2:example.com' $
+# forget rooms, you have to first leave a room before you forget it $ matrix-
+commander --room-forget '#roomAlias1:example.com' $ # invite users to rooms $
+matrix-commander --room-invite '#roomAlias1:example.com' \ --user '@user1:
+example.com' '@user2:example.com' $ # ban users from rooms $ matrix-commander -
+-room-ban '!someroom1:example.com' \ '!someroom2:example.com' \ --user '@user1:
 example.com' '@user2:example.com' $ # unban users from rooms, remember after
 unbanning you have to invite again $ matrix-commander --room-unban '!someroom1:
 example.com' \ '!someroom2:example.com' \ --user '@user1:example.com' '@user2:
 example.com' $ # kick users from rooms $ matrix-commander --room-kick
 '!someroom1:example.com' \ '#roomAlias2:example.com' \ --user '@user1:
 example.com' '@user2:example.com' $ # set log levels, INFO for matrix-commander
 and ERROR for modules below $ matrix-commander -m "test" --log-level INFO ERROR
@@ -493,16 +497,16 @@
 USER [USER ...]] [--room-join ROOM [ROOM ...]] [--room-leave ROOM [ROOM ...]]
 [--room-forget ROOM [ROOM ...]] [--room-invite ROOM [ROOM ...]] [--room-ban
 ROOM [ROOM ...]] [--room-unban ROOM [ROOM ...]] [--room-kick ROOM [ROOM ...]]
 [-u USER [USER ...]] [--user-login USER] [--name ROOM_NAME [ROOM_NAME ...]] [--
 topic ROOM_TOPIC [ROOM_TOPIC ...]] [--alias ROOM_ALIAS [ROOM_ALIAS ...]] [-
 m TEXT [TEXT ...]] [-i IMAGE_FILE [IMAGE_FILE ...]] [-a AUDIO_FILE [AUDIO_FILE
 ...]] [-f FILE [FILE ...]] [-e MATRIX_JSON_OBJECT [MATRIX_JSON_OBJECT ...]] [-
-w] [-z] [-k] [-p SEPARATOR] [--config CONFIG_FILE] [--proxy PROXY] [-n] [--
-encrypted] [-l [NEVER|ONCE|FOREVER|TAIL|ALL]] [-t [NUMBER]] [-y] [--print-
+w] [-z] [-k] [-j] [-p SEPARATOR] [--config CONFIG_FILE] [--proxy PROXY] [-n] [-
+-encrypted] [-l [NEVER|ONCE|FOREVER|TAIL|ALL]] [-t [NUMBER]] [-y] [--print-
 event-id] [--download-media [DOWNLOAD_DIRECTORY]] [--os-notify] [--set-device-
 name DEVICE_NAME] [--set-display-name DISPLAY_NAME] [--get-display-name] [--
 set-presence ONLINE|OFFLINE|UNAVAILABLE] [--get-presence] [--upload FILE [FILE
 ...]] [--download MXC_URI [MXC_URI ...]] [--delete-mxc MXC_URI [MXC_URI ...]]
 [--delete-mxc-before TIMESTAMP [TIMESTAMP ...]] [--joined-rooms] [--joined-
 members ROOM [ROOM ...]] [--mxc-to-http MXC_URI [MXC_URI ...]] [--devices] [--
 discovery-info] [--login-info] [--content-repository-config] [--rest
@@ -779,190 +783,194 @@
 sent as format "TEXT". E.g. that allows some text to be bold, etc. Only a
 subset of HTML tags are accepted by Matrix. -z, --markdown Send message as
 format "MARKDOWN". Details:: If not specified, message will be sent as format
 "TEXT". E.g. that allows sending of text formatted in MarkDown language. -k, --
 code Send message as format "CODE". Details:: If not specified, message will be
 sent as format "TEXT". If both --html and --code are specified then --code
 takes priority. This is useful for sending ASCII-art or tabbed output like
-tables as a fixed-sized font will be used for display. -p SEPARATOR, --split
-SEPARATOR Split message text into multiple Matrix messages. Details:: If set,
-split the message(s) into multiple messages wherever the string specified with
---split occurs. E.g. One pipes a stream of RSS articles into the program and
-the articles are separated by three newlines. Then with --split set to "\n\n\n"
-each article will be printed in a separate message. By default, i.e. if not
-set, no messages will be split. --config CONFIG_FILE Specify the location of a
-config file. Details:: By default, no config file is used. If this option is
-provided, the provided file name will be used to read configuration from. Not
-implemented. --proxy PROXY Specify a proxy for connectivity. Details:: By
-default, i.e. if this option is not set, no proxy is used. If this option is
-used a proxy URL must be provided. The provided proxy URL will be used for the
-HTTP connection to the server. The proxy supports SOCKS4(a), SOCKS5, and HTTP
-(tunneling). Examples of valid URLs are "http://10.10.10.10:8118" or "socks5://
-user:password@127.0.0.1:1080". URLs with "https" or "socks4a" are not valid.
-Only "http", "socks4" and "socks5" are valid. -n, --notice Send message as
-notice. Details:: If not specified, message will be sent as text. --encrypted
-Send message end-to-end encrypted. Details:: Encryption is always turned on and
-will always be used where possible. It cannot be turned off. This flag does
-nothing as encryption is turned on with or without this argument. This flag
-exists only for historic reasons. In some specific case encryption can be
-disabled, please see --plain. -l [NEVER|ONCE|FOREVER|TAIL|ALL], --listen
-[NEVER|ONCE|FOREVER|TAIL|ALL] Print received messages and listen to messages.
-Details:: The --listen option takes one argument. There are several choices:
-"never", "once", "forever", "tail", and "all". By default, --listen is set to
-"never". So, by default no listening will be done. Set it to "forever" to
-listen for and print incoming messages to stdout. "--listen forever" will
-listen to all messages on all rooms forever. To stop listening "forever", use
-Control-C on the keyboard or send a signal to the process or service. The PID
-for signaling can be found in a PID file in directory "/home/user/.run". "--
-listen once" will get all the messages from all rooms that are currently queued
-up. So, with "once" the program will start, print waiting messages (if any) and
-then stop. The timeout for "once" is set to 10 seconds. So, be patient, it
-might take up to that amount of time. "tail" reads and prints the last N
-messages from the specified rooms, then quits. The number N can be set with the
---tail option. With "tail" some messages read might be old, i.e. already read
-before, some might be new, i.e. never read before. It prints the messages and
-then the program stops. Messages are sorted, last-first. Look at --tail as that
-option is related to --listen tail. The option "all" gets all messages
-available, old and new. Unlike "once" and "forever" that listen in ALL rooms,
-"tail" and "all" listen only to the room specified in the credentials file or
-the --room options. -t [NUMBER], --tail [NUMBER] Print last messages. Details::
-The --tail option reads and prints up to the last N messages from the specified
-rooms, then quits. It takes one argument, an integer, which we call N here. If
-there are fewer than N messages in a room, it reads and prints up to N
-messages. It gets the last N messages in reverse order. It print the newest
-message first, and the oldest message last. If --listen-self is not set it will
-print less than N messages in many cases because N messages are obtained, but
-some of them are discarded by default if they are from the user itself. Look at
---listen as this option is related to --tail. -y, --listen-self Print your own
-messages as well. Details:: If set and listening, then program will listen to
-and print also the messages sent by its own user. By default messages from
-oneself are not printed. --print-event-id Print event ids of received messages.
-Details:: If set and listening, then 'matrix-commander' will print also the
-event id for each received message or other received event. If set and sending,
-then 'matrix- commander' will print the event id of the sent message or the
-sent object (audio, file, event) to stdout. Other information like room id and
-reference to what was sent will be printed too. For sending this is useful, if
-after sending the user wishes to perform further operations on the sent object,
-e.g. redacting/deleting it after an expiration time, etc. --download-media
-[DOWNLOAD_DIRECTORY] Download media files while listening. Details:: If set and
-listening, then program will download received media files (e.g. image, audio,
-video, text, PDF files). media will be downloaded to local directory. By
-default, media will be downloaded to is "./media/". You can overwrite default
-with your preferred directory. If media is encrypted it will be decrypted and
-stored decrypted. By default media files will not be downloaded. --os-notify
-Notify me of arriving messages. Details:: If set and listening, then program
-will attempt to visually notify of arriving messages through the operating
-system. By default there is no notification via OS. --set-device-name
-DEVICE_NAME Set or rename the current device. Details:: Set or rename the
-current device to the device name provided. Send, listen and verify operations
-are allowed when renaming the device. --set-display-name DISPLAY_NAME Set or
-rename the display name. Details:: Set or rename the display name for the
-current user to the display name provided. Send, listen and verify operations
-are allowed when setting the display name. Do not confuse this option with the
-option '--get- room-info' which gets the room display name, not the user
-display name. --get-display-name Get the display name of yourself. Details::
-Get the display name of matrix-commander (itself), or of one or multiple users.
-Specify user(s) with the --user option. If no user is specified get the display
-name of itself. Send, listen and verify operations are allowed when getting
-display name(s). Do not confuse this option with the option '--get-room-info'
-which gets the room display name, not the user display name. --set-presence
-ONLINE|OFFLINE|UNAVAILABLE Set your presence. Details:: Set presence of matrix-
-commander to the given value. Must be one of these values: online,
-offline, unavailable. Otherwise an error will be produced. --get-
-presence Get your presence. Details:: Get presence of matrix- commander
+tables as a fixed-sized font will be used for display. -j, --emojize Send
+message after emojizing. Details:: If not specified, message will be sent as
+format "TEXT". If both --code and --emojize are specified then --code takes
+priority. This is useful for sending emojis in shortcode form :collision:. -
+p SEPARATOR, --split SEPARATOR Split message text into multiple Matrix
+messages. Details:: If set, split the message(s) into multiple messages
+wherever the string specified with --split occurs. E.g. One pipes a stream of
+RSS articles into the program and the articles are separated by three newlines.
+Then with --split set to "\n\n\n" each article will be printed in a separate
+message. By default, i.e. if not set, no messages will be split. --config
+CONFIG_FILE Specify the location of a config file. Details:: By default, no
+config file is used. If this option is provided, the provided file name will be
+used to read configuration from. Not implemented. --proxy PROXY Specify a proxy
+for connectivity. Details:: By default, i.e. if this option is not set, no
+proxy is used. If this option is used a proxy URL must be provided. The
+provided proxy URL will be used for the HTTP connection to the server. The
+proxy supports SOCKS4(a), SOCKS5, and HTTP (tunneling). Examples of valid URLs
+are "http://10.10.10.10:8118" or "socks5://user:password@127.0.0.1:1080". URLs
+with "https" or "socks4a" are not valid. Only "http", "socks4" and "socks5" are
+valid. -n, --notice Send message as notice. Details:: If not specified, message
+will be sent as text. --encrypted Send message end-to-end encrypted. Details::
+Encryption is always turned on and will always be used where possible. It
+cannot be turned off. This flag does nothing as encryption is turned on with or
+without this argument. This flag exists only for historic reasons. In some
+specific case encryption can be disabled, please see --plain. -l
+[NEVER|ONCE|FOREVER|TAIL|ALL], --listen [NEVER|ONCE|FOREVER|TAIL|ALL] Print
+received messages and listen to messages. Details:: The --listen option takes
+one argument. There are several choices: "never", "once", "forever", "tail",
+and "all". By default, --listen is set to "never". So, by default no listening
+will be done. Set it to "forever" to listen for and print incoming messages to
+stdout. "--listen forever" will listen to all messages on all rooms forever. To
+stop listening "forever", use Control-C on the keyboard or send a signal to the
+process or service. The PID for signaling can be found in a PID file in
+directory "/home/user/.run". "--listen once" will get all the messages from all
+rooms that are currently queued up. So, with "once" the program will start,
+print waiting messages (if any) and then stop. The timeout for "once" is set to
+10 seconds. So, be patient, it might take up to that amount of time. "tail"
+reads and prints the last N messages from the specified rooms, then quits. The
+number N can be set with the --tail option. With "tail" some messages read
+might be old, i.e. already read before, some might be new, i.e. never read
+before. It prints the messages and then the program stops. Messages are sorted,
+last-first. Look at --tail as that option is related to --listen tail. The
+option "all" gets all messages available, old and new. Unlike "once" and
+"forever" that listen in ALL rooms, "tail" and "all" listen only to the room
+specified in the credentials file or the --room options. -t [NUMBER], --tail
+[NUMBER] Print last messages. Details:: The --tail option reads and prints up
+to the last N messages from the specified rooms, then quits. It takes one
+argument, an integer, which we call N here. If there are fewer than N messages
+in a room, it reads and prints up to N messages. It gets the last N messages in
+reverse order. It print the newest message first, and the oldest message last.
+If --listen-self is not set it will print less than N messages in many cases
+because N messages are obtained, but some of them are discarded by default if
+they are from the user itself. Look at --listen as this option is related to --
+tail. -y, --listen-self Print your own messages as well. Details:: If set and
+listening, then program will listen to and print also the messages sent by its
+own user. By default messages from oneself are not printed. --print-event-id
+Print event ids of received messages. Details:: If set and listening, then
+'matrix-commander' will print also the event id for each received message or
+other received event. If set and sending, then 'matrix- commander' will print
+the event id of the sent message or the sent object (audio, file, event) to
+stdout. Other information like room id and reference to what was sent will be
+printed too. For sending this is useful, if after sending the user wishes to
+perform further operations on the sent object, e.g. redacting/deleting it after
+an expiration time, etc. --download-media [DOWNLOAD_DIRECTORY] Download media
+files while listening. Details:: If set and listening, then program will
+download received media files (e.g. image, audio, video, text, PDF files).
+media will be downloaded to local directory. By default, media will be
+downloaded to is "./media/". You can overwrite default with your preferred
+directory. If media is encrypted it will be decrypted and stored decrypted. By
+default media files will not be downloaded. --os-notify Notify me of arriving
+messages. Details:: If set and listening, then program will attempt to visually
+notify of arriving messages through the operating system. By default there is
+no notification via OS. --set-device-name DEVICE_NAME Set or rename the current
+device. Details:: Set or rename the current device to the device name provided.
+Send, listen and verify operations are allowed when renaming the device. --set-
+display-name DISPLAY_NAME Set or rename the display name. Details:: Set or
+rename the display name for the current user to the display name provided.
+Send, listen and verify operations are allowed when setting the display name.
+Do not confuse this option with the option '--get- room-info' which gets the
+room display name, not the user display name. --get-display-name Get the
+display name of yourself. Details:: Get the display name of matrix-commander
 (itself), or of one or multiple users. Specify user(s) with the --user option.
-If no user is specified get the presence of itself. Send, listen and verify
-operations are allowed when getting presence(s). --upload FILE [FILE ...]
-Upload one or multiple files to the content repository. Details:: The files
-will be given a Matrix URI and stored on the server. --upload allows the
-optional argument --plain to skip encryption for upload. See tests/test-
-upload.sh for an example. --download MXC_URI [MXC_URI ...] Download one or
-multiple files from the content repository. Details:: You must provide one or
-multiple Matrix URIs (MXCs) which are strings like this 'mxc://example.com/
-SomeStrangeUriKey'. If found they will be downloaded, decrypted, and stored in
-local files. If file names are specified with --file-name the downloads will be
-saved with these file names. If --file-name is not specified the original file
-name from the upload will be used. If neither specified nor available on
-server, then the file name of last resort 'mxc-' will be used. If a file name
-in --file- name contains the placeholder __mxc_id__, it will be replaced with
-the mxc-id. If a file name is specified as empty string in --file-name, then
-also the name 'mxc-' will be used. By default, the upload was encrypted so a
-decryption dictionary must be provided to decrypt the data. Specify one or
-multiple decryption keys with --key-dict. If --key-dict is not set, not
-decryption is attempted; and the data might be stored in encrypted fashion, or
-might be plain-text if the --upload skipped encryption with --plain. See tests/
-test-upload.sh for an example. --delete-mxc MXC_URI [MXC_URI ...] Delete one or
-multiple objects from the content repository. Details:: You must provide one or
-multiple Matrix URIs (MXC) which are strings like this 'mxc://example.com/
-SomeStrangeUriKey'. Alternatively, you can just provide the MXC id, i.e. the
-part after the last slash. If found they (i.e. the files they represent) will
-be deleted from the server database. In order to delete objects one must have
-server admin permissions. Having only room admin permissions is not sufficient
-and it will fail. Read https://matrix-org.g ithub.io/synapse/latest/usage/
-administration/admin_api / for learning how to set server admin permissions on
-the server. Alternatively, and optionally, one can specify an access token
-which has server admin permissions with the --access-token argument. See tests/
-test-upload.sh for an example. --delete-mxc-before TIMESTAMP [TIMESTAMP ...]
-Delete old objects from the content repositoryDetails:: Delete files from the
-content repository that are older than a given timestamp. It is the timestamp
-of last access, not the timestamp when the file was created. Additionally you
-can specify a size in bytes to indicate that only files older than timestamp
-and larger than size will be deleted. You must provide a timestamp of the
-following format: 'DD.MM.YYYY HH:MM:SS' like '20.01.2022 19:38:42' for January
-20, 2022, 7pm 38min 42sec. Files that are still used in image data (e.g user
-profile, room avatar) will not be deleted from the server database. In order to
-delete objects one must have server admin permissions. Having only room admin
-permissions is not sufficient and it will fail. Read https://matrix-
-org.github.io/synapse/latest/usage/admi nistration/admin_api/ for learning how
+If no user is specified get the display name of itself. Send, listen and verify
+operations are allowed when getting display name(s). Do not confuse this option
+with the option '--get-room-info' which gets the room display name, not the
+user display name. --set-presence ONLINE|OFFLINE|UNAVAILABLE Set your presence.
+Details:: Set presence of matrix- commander to the given value. Must be one of
+these values: online, offline, unavailable. Otherwise an
+error will be produced. --get-presence Get your presence. Details:: Get
+presence of matrix- commander (itself), or of one or multiple users. Specify
+user(s) with the --user option. If no user is specified get the presence of
+itself. Send, listen and verify operations are allowed when getting presence
+(s). --upload FILE [FILE ...] Upload one or multiple files to the content
+repository. Details:: The files will be given a Matrix URI and stored on the
+server. --upload allows the optional argument --plain to skip encryption for
+upload. See tests/test-upload.sh for an example. --download MXC_URI [MXC_URI
+...] Download one or multiple files from the content repository. Details:: You
+must provide one or multiple Matrix URIs (MXCs) which are strings like this
+'mxc://example.com/SomeStrangeUriKey'. If found they will be downloaded,
+decrypted, and stored in local files. If file names are specified with --file-
+name the downloads will be saved with these file names. If --file-name is not
+specified the original file name from the upload will be used. If neither
+specified nor available on server, then the file name of last resort 'mxc-
+' will be used. If a file name in --file- name contains the placeholder
+__mxc_id__, it will be replaced with the mxc-id. If a file name is specified as
+empty string in --file-name, then also the name 'mxc-' will be used. By
+default, the upload was encrypted so a decryption dictionary must be provided
+to decrypt the data. Specify one or multiple decryption keys with --key-dict.
+If --key-dict is not set, not decryption is attempted; and the data might be
+stored in encrypted fashion, or might be plain-text if the --upload skipped
+encryption with --plain. See tests/test-upload.sh for an example. --delete-mxc
+MXC_URI [MXC_URI ...] Delete one or multiple objects from the content
+repository. Details:: You must provide one or multiple Matrix URIs (MXC) which
+are strings like this 'mxc://example.com/SomeStrangeUriKey'. Alternatively, you
+can just provide the MXC id, i.e. the part after the last slash. If found they
+(i.e. the files they represent) will be deleted from the server database. In
+order to delete objects one must have server admin permissions. Having only
+room admin permissions is not sufficient and it will fail. Read https://matrix-
+org.g ithub.io/synapse/latest/usage/administration/admin_api / for learning how
 to set server admin permissions on the server. Alternatively, and optionally,
 one can specify an access token which has server admin permissions with the --
-access-token argument. See tests/test-upload.sh for an example. --joined-rooms
-Print the list of joined rooms. Details:: All rooms that you are a member of
-will be printed, one room per line. --joined-members ROOM [ROOM ...] Print the
-list of joined members for one or multiple rooms. Details:: If you want to
-print the joined members of all rooms that you are member of, then use the
-special character '*'. --mxc-to-http MXC_URI [MXC_URI ...] Convert MXC URIs to
-HTTP URLs. Details:: Convert one or more matrix content URIs to the
-corresponding HTTP URLs. The MXC URIs to provide look something like this 'mxc:
-//example.com/SomeStrangeUriKey'. See tests/test- upload.sh for an example. --
-devices, --get-devices Print the list of devices. Details:: All device of this
-account will be printed, one device per line. --discovery-info Print discovery
-information about current homeserver. Details:: Note that not all homeservers
-support discovery and an error might be reported. --login-info Print login
-methods supported by the homeserver. Details:: It prints one login method per
-line. --content-repository-config Print the content repository configuration.
-Details:: This currently just prints the upload size limit in bytes. --rest
-REST_METHOD DATA URL [REST_METHOD DATA URL ...] Use the Matrix Client REST API.
-Details:: Matrix has several extensive REST APIs. With the --rest argument you
-can invoke a Matrix REST API call. This allows the user to do pretty much
-anything, at the price of not being very convenient. The APIs are described in
-https://matrix.org/docs/api/, https://spec.matrix.org/latest/client-server-
-api/, https://matrix-org.github.io/synapse/latest/usage/admi nistration/
-admin_api/, etc. Each REST call requires exactly 3 arguments. So, the total
-number of arguments used with --rest must be a multiple of 3. The argument
-triples are: (a) the method, a string of GET, POST, PUT, DELETE, or OPTIONS.
-(b) a string containing the data (if any) in JSON format. (c) a string
-containing the URL. All strings must be UTF-8. There are a few placeholders.
-They are: __homeserver__ (like https://matrix.example.org), __hostname__ (like
-matrix.example.org), __access_token__, __user_id__ (like @mc:
-matrix.example.com), __device_id__, and __room_id__. If a placeholder is found
-it is replaced with the value from the local credentials file. An example would
-be: --rest 'GET' '' '__homeserver__/_matrix/client/versions'. If there is no
-data, i.e. data (b) is empty, then use '' for it. Optionally, --access-token
-can be used to overwrite the access token from credentials (if needed). See
-tests/test-rest.sh for an example. --set-avatar AVATAR_MXC_URI Set your avatar.
-Details:: Set the avatar MXC resource used by matrix-commander. Provide one MXC
-URI that looks like this 'mxc://example.com/SomeStrangeUriKey'. --get-avatar
-[USER ...] Get an avatar. Details:: Get the avatar MXC resource used by matrix-
-commander, or one or multiple other users. Specify zero or more user ids. If no
-user id is specified, the avatar of matrix-commander will be fetched. If one or
-more user ids are given, the avatars of these users will be fetched. As
-response both MXC URI as well as URL will be printed. --get-profile [USER ...]
-Get a user profile. Details:: Get the user profile used by matrix-commander, or
-one or multiple other users. Specify zero or more user ids. If no user id is
+access-token argument. See tests/test-upload.sh for an example. --delete-mxc-
+before TIMESTAMP [TIMESTAMP ...] Delete old objects from the content
+repositoryDetails:: Delete files from the content repository that are older
+than a given timestamp. It is the timestamp of last access, not the timestamp
+when the file was created. Additionally you can specify a size in bytes to
+indicate that only files older than timestamp and larger than size will be
+deleted. You must provide a timestamp of the following format: 'DD.MM.YYYY HH:
+MM:SS' like '20.01.2022 19:38:42' for January 20, 2022, 7pm 38min 42sec. Files
+that are still used in image data (e.g user profile, room avatar) will not be
+deleted from the server database. In order to delete objects one must have
+server admin permissions. Having only room admin permissions is not sufficient
+and it will fail. Read https://matrix-org.github.io/synapse/latest/usage/admi
+nistration/admin_api/ for learning how to set server admin permissions on the
+server. Alternatively, and optionally, one can specify an access token which
+has server admin permissions with the --access-token argument. See tests/test-
+upload.sh for an example. --joined-rooms Print the list of joined rooms.
+Details:: All rooms that you are a member of will be printed, one room per
+line. --joined-members ROOM [ROOM ...] Print the list of joined members for one
+or multiple rooms. Details:: If you want to print the joined members of all
+rooms that you are member of, then use the special character '*'. --mxc-to-http
+MXC_URI [MXC_URI ...] Convert MXC URIs to HTTP URLs. Details:: Convert one or
+more matrix content URIs to the corresponding HTTP URLs. The MXC URIs to
+provide look something like this 'mxc://example.com/SomeStrangeUriKey'. See
+tests/test- upload.sh for an example. --devices, --get-devices Print the list
+of devices. Details:: All device of this account will be printed, one device
+per line. --discovery-info Print discovery information about current
+homeserver. Details:: Note that not all homeservers support discovery and an
+error might be reported. --login-info Print login methods supported by the
+homeserver. Details:: It prints one login method per line. --content-
+repository-config Print the content repository configuration. Details:: This
+currently just prints the upload size limit in bytes. --rest REST_METHOD DATA
+URL [REST_METHOD DATA URL ...] Use the Matrix Client REST API. Details:: Matrix
+has several extensive REST APIs. With the --rest argument you can invoke a
+Matrix REST API call. This allows the user to do pretty much anything, at the
+price of not being very convenient. The APIs are described in https://
+matrix.org/docs/api/, https://spec.matrix.org/latest/client-server-api/, https:
+//matrix-org.github.io/synapse/latest/usage/admi nistration/admin_api/, etc.
+Each REST call requires exactly 3 arguments. So, the total number of arguments
+used with --rest must be a multiple of 3. The argument triples are: (a) the
+method, a string of GET, POST, PUT, DELETE, or OPTIONS. (b) a string containing
+the data (if any) in JSON format. (c) a string containing the URL. All strings
+must be UTF-8. There are a few placeholders. They are: __homeserver__ (like
+https://matrix.example.org), __hostname__ (like matrix.example.org),
+__access_token__, __user_id__ (like @mc:matrix.example.com), __device_id__, and
+__room_id__. If a placeholder is found it is replaced with the value from the
+local credentials file. An example would be: --rest 'GET' '' '__homeserver__/
+_matrix/client/versions'. If there is no data, i.e. data (b) is empty, then use
+'' for it. Optionally, --access-token can be used to overwrite the access token
+from credentials (if needed). See tests/test-rest.sh for an example. --set-
+avatar AVATAR_MXC_URI Set your avatar. Details:: Set the avatar MXC resource
+used by matrix-commander. Provide one MXC URI that looks like this 'mxc://
+example.com/SomeStrangeUriKey'. --get-avatar [USER ...] Get an avatar.
+Details:: Get the avatar MXC resource used by matrix-commander, or one or
+multiple other users. Specify zero or more user ids. If no user id is
+specified, the avatar of matrix-commander will be fetched. If one or more user
+ids are given, the avatars of these users will be fetched. As response both MXC
+URI as well as URL will be printed. --get-profile [USER ...] Get a user
+profile. Details:: Get the user profile used by matrix-commander, or one or
+multiple other users. Specify zero or more user ids. If no user id is
 specified, the user profile of matrix-commander will be fetched. If one or more
 user ids are given, the user profiles of these users will be fetched. As
 response display name and avatar MXC URI as well as possible additional profile
 information (if present) will be printed. One line per user will be printed. --
 get-room-info [ROOM ...] Get the room information. Details:: Get the room
 information such as room display name, room alias, room creator, etc. for one
 or multiple specified rooms. The included room 'display name' is also referred
@@ -1167,15 +1175,15 @@
 one argument. If no argument is given, 'print' is assumed which will print the
 version of the currently installed 'PROG_WITHOUT_EXT' package. 'check' is the
 alternative. '{CHECK}' connects to https://pypi.org and gets the version number
 of latest stable release. There is no 'calling home' on every run, only a
 'check pypi.org' upon request. Your privacy is protected. The new release is
 neither downloaded, nor installed. It just informs you. After printing version
 information the program will continue to run. This is useful for having version
-number in the log files. You are running version 6.0.2 2023-04-04. Enjoy, star
+number in the log files. You are running version 7.0.0 2023-04-12. Enjoy, star
 on Github and contribute by submitting a Pull Request. Also have a look at
 matrix-commander-tui. ``` # Autocompletion Tab completion is provided for
 shells (e.g. bash), courtesy of @mizlan). Here is a sample snapshot of tab
 completion in action: ![tab completion screenshot](screenshots/
 tab_complete.png) # Performance and Speed - `matrix-commander` is written in
 Python and hence rather on the slow side - It is not thread-safe. One cannot
 just simply run multiple instances at the same time. However, with very careful
@@ -1230,9 +1238,9 @@
 commander/matrix_commander) - [matrix-commander-rs](https://github.com/8go/
 matrix-commander-rs/) - [nostr-commander-rs](https://github.com/8go/nostr-
 commander-rs/) - [matrix-nostr-bridge](https://github.com/8go/matrix-nostr-
 bridge/) # Final Remarks - Thanks to all of you who already have contributed!
 So appreciated! - :heart: and :thumbsup: to @fyfe, @berlincount, @ezwen,
 @Scriptkiddi, @pelzvieh, @mizlan, @edwinsage, @jschwartzentruber, @nirgal,
 @benneti, @opk12, @pataquets, @KizzyCode, @murlock1000, @Benjamin-Loison,
-@barathrm, etc. - Enjoy! - Give it a :star: star on GitHub! Pull requests are
-welcome :heart:
+@barathrm, @jonathandmoore, etc. - Enjoy! - Give it a :star: star on GitHub!
+Pull requests are welcome :heart:
```

### Comparing `matrix-commander-6.0.2/matrix_commander/matrix-commander-tui` & `matrix-commander-7.0.0/matrix_commander/matrix-commander-tui`

 * *Files identical despite different names*

### Comparing `matrix-commander-6.0.2/matrix_commander/matrix_commander.py` & `matrix-commander-7.0.0/matrix_commander/matrix_commander.py`

 * *Files 0% similar despite different names*

```diff
@@ -53,21893 +53,21942 @@
 00000340: 2074 7970 696e 6720 696d 706f 7274 204c   typing import L
 00000350: 6974 6572 616c 2c20 4f70 7469 6f6e 616c  iteral, Optional
 00000360: 2c20 556e 696f 6e0a 6672 6f6d 2075 726c  , Union.from url
 00000370: 6c69 622e 7061 7273 6520 696d 706f 7274  lib.parse import
 00000380: 2071 756f 7465 2c20 7572 6c70 6172 7365   quote, urlparse
 00000390: 0a0a 696d 706f 7274 2061 696f 6669 6c65  ..import aiofile
 000003a0: 730a 696d 706f 7274 2061 696f 6669 6c65  s.import aiofile
-000003b0: 732e 6f73 0a69 6d70 6f72 7420 6d61 6769  s.os.import magi
-000003c0: 630a 696d 706f 7274 2070 6b67 5f72 6573  c.import pkg_res
-000003d0: 6f75 7263 6573 0a66 726f 6d20 6169 6f68  ources.from aioh
-000003e0: 7474 7020 696d 706f 7274 2043 6c69 656e  ttp import Clien
-000003f0: 7443 6f6e 6e65 6374 6f72 4572 726f 722c  tConnectorError,
-00000400: 2043 6c69 656e 7453 6573 7369 6f6e 2c20   ClientSession, 
-00000410: 5443 5043 6f6e 6e65 6374 6f72 2c20 7765  TCPConnector, we
-00000420: 620a 6672 6f6d 206d 6172 6b64 6f77 6e20  b.from markdown 
-00000430: 696d 706f 7274 206d 6172 6b64 6f77 6e0a  import markdown.
-00000440: 6672 6f6d 206e 696f 2069 6d70 6f72 7420  from nio import 
-00000450: 2841 7379 6e63 436c 6965 6e74 2c20 4173  (AsyncClient, As
-00000460: 796e 6343 6c69 656e 7443 6f6e 6669 672c  yncClientConfig,
-00000470: 2043 6f6e 7465 6e74 5265 706f 7369 746f   ContentReposito
-00000480: 7279 436f 6e66 6967 4572 726f 722c 0a20  ryConfigError,. 
-00000490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000004a0: 4465 6c65 7465 4465 7669 6365 7341 7574  DeleteDevicesAut
-000004b0: 6852 6573 706f 6e73 652c 2044 656c 6574  hResponse, Delet
-000004c0: 6544 6576 6963 6573 4572 726f 722c 2044  eDevicesError, D
-000004d0: 6576 6963 6573 4572 726f 722c 0a20 2020  evicesError,.   
-000004e0: 2020 2020 2020 2020 2020 2020 2020 4469                Di
-000004f0: 7363 6f76 6572 7949 6e66 6f45 7272 6f72  scoveryInfoError
-00000500: 2c20 446f 776e 6c6f 6164 4572 726f 722c  , DownloadError,
-00000510: 2045 6e61 626c 6545 6e63 7279 7074 696f   EnableEncryptio
-00000520: 6e42 7569 6c64 6572 2c0a 2020 2020 2020  nBuilder,.      
-00000530: 2020 2020 2020 2020 2020 2045 6e63 7279             Encry
-00000540: 7074 696f 6e45 7272 6f72 2c20 4572 726f  ptionError, Erro
-00000550: 7252 6573 706f 6e73 652c 204a 6f69 6e65  rResponse, Joine
-00000560: 644d 656d 6265 7273 4572 726f 722c 0a20  dMembersError,. 
-00000570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000580: 4a6f 696e 6564 526f 6f6d 7345 7272 6f72  JoinedRoomsError
-00000590: 2c20 4a6f 696e 4572 726f 722c 204b 6579  , JoinError, Key
-000005a0: 5665 7269 6669 6361 7469 6f6e 4361 6e63  VerificationCanc
-000005b0: 656c 2c0a 2020 2020 2020 2020 2020 2020  el,.            
-000005c0: 2020 2020 204b 6579 5665 7269 6669 6361       KeyVerifica
-000005d0: 7469 6f6e 4576 656e 742c 204b 6579 5665  tionEvent, KeyVe
-000005e0: 7269 6669 6361 7469 6f6e 4b65 792c 204b  rificationKey, K
-000005f0: 6579 5665 7269 6669 6361 7469 6f6e 4d61  eyVerificationMa
-00000600: 632c 0a20 2020 2020 2020 2020 2020 2020  c,.             
-00000610: 2020 2020 4b65 7956 6572 6966 6963 6174      KeyVerificat
-00000620: 696f 6e53 7461 7274 2c20 4c6f 6361 6c50  ionStart, LocalP
-00000630: 726f 746f 636f 6c45 7272 6f72 2c20 4c6f  rotocolError, Lo
-00000640: 6769 6e49 6e66 6f45 7272 6f72 2c0a 2020  ginInfoError,.  
-00000650: 2020 2020 2020 2020 2020 2020 2020 204c                 L
-00000660: 6f67 696e 5265 7370 6f6e 7365 2c20 4c6f  oginResponse, Lo
-00000670: 676f 7574 4572 726f 722c 204d 6174 7269  goutError, Matri
-00000680: 7852 6f6f 6d2c 204d 6573 7361 6765 4469  xRoom, MessageDi
-00000690: 7265 6374 696f 6e2c 0a20 2020 2020 2020  rection,.       
-000006a0: 2020 2020 2020 2020 2020 5072 6573 656e            Presen
-000006b0: 6365 4765 7445 7272 6f72 2c20 5072 6573  ceGetError, Pres
-000006c0: 656e 6365 5365 7445 7272 6f72 2c20 5072  enceSetError, Pr
-000006d0: 6f66 696c 6547 6574 4176 6174 6172 5265  ofileGetAvatarRe
-000006e0: 7370 6f6e 7365 2c0a 2020 2020 2020 2020  sponse,.        
-000006f0: 2020 2020 2020 2020 2050 726f 6669 6c65           Profile
-00000700: 4765 7444 6973 706c 6179 4e61 6d65 4572  GetDisplayNameEr
-00000710: 726f 722c 2050 726f 6669 6c65 4765 7445  ror, ProfileGetE
-00000720: 7272 6f72 2c0a 2020 2020 2020 2020 2020  rror,.          
-00000730: 2020 2020 2020 2050 726f 6669 6c65 5365         ProfileSe
-00000740: 7441 7661 7461 7252 6573 706f 6e73 652c  tAvatarResponse,
-00000750: 2050 726f 6669 6c65 5365 7444 6973 706c   ProfileSetDispl
-00000760: 6179 4e61 6d65 4572 726f 722c 0a20 2020  ayNameError,.   
-00000770: 2020 2020 2020 2020 2020 2020 2020 5265                Re
-00000780: 6461 6374 6564 4576 656e 742c 2052 6564  dactedEvent, Red
-00000790: 6163 7469 6f6e 4576 656e 742c 2052 6f6f  actionEvent, Roo
-000007a0: 6d41 6c69 6173 4576 656e 742c 2052 6f6f  mAliasEvent, Roo
-000007b0: 6d42 616e 4572 726f 722c 0a20 2020 2020  mBanError,.     
-000007c0: 2020 2020 2020 2020 2020 2020 526f 6f6d              Room
-000007d0: 4372 6561 7465 4572 726f 722c 2052 6f6f  CreateError, Roo
-000007e0: 6d44 656c 6574 6541 6c69 6173 5265 7370  mDeleteAliasResp
-000007f0: 6f6e 7365 2c20 526f 6f6d 456e 6372 7970  onse, RoomEncryp
-00000800: 7465 6441 7564 696f 2c0a 2020 2020 2020  tedAudio,.      
-00000810: 2020 2020 2020 2020 2020 2052 6f6f 6d45             RoomE
-00000820: 6e63 7279 7074 6564 4669 6c65 2c20 526f  ncryptedFile, Ro
-00000830: 6f6d 456e 6372 7970 7465 6449 6d61 6765  omEncryptedImage
-00000840: 2c20 526f 6f6d 456e 6372 7970 7465 644d  , RoomEncryptedM
-00000850: 6564 6961 2c0a 2020 2020 2020 2020 2020  edia,.          
-00000860: 2020 2020 2020 2052 6f6f 6d45 6e63 7279         RoomEncry
-00000870: 7074 6564 5669 6465 6f2c 2052 6f6f 6d45  ptedVideo, RoomE
-00000880: 6e63 7279 7074 696f 6e45 7665 6e74 2c20  ncryptionEvent, 
-00000890: 526f 6f6d 466f 7267 6574 4572 726f 722c  RoomForgetError,
-000008a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000008b0: 2020 526f 6f6d 4765 7453 7461 7465 5265    RoomGetStateRe
-000008c0: 7370 6f6e 7365 2c20 526f 6f6d 4765 7456  sponse, RoomGetV
-000008d0: 6973 6962 696c 6974 7952 6573 706f 6e73  isibilityRespons
-000008e0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-000008f0: 2020 2020 526f 6f6d 496e 7669 7465 4572      RoomInviteEr
-00000900: 726f 722c 2052 6f6f 6d4b 6963 6b45 7272  ror, RoomKickErr
-00000910: 6f72 2c20 526f 6f6d 4c65 6176 6545 7272  or, RoomLeaveErr
-00000920: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
-00000930: 2020 2020 2052 6f6f 6d4d 656d 6265 7245       RoomMemberE
-00000940: 7665 6e74 2c20 526f 6f6d 4d65 7373 6167  vent, RoomMessag
-00000950: 652c 2052 6f6f 6d4d 6573 7361 6765 4175  e, RoomMessageAu
-00000960: 6469 6f2c 0a20 2020 2020 2020 2020 2020  dio,.           
-00000970: 2020 2020 2020 526f 6f6d 4d65 7373 6167        RoomMessag
-00000980: 6545 6d6f 7465 2c20 526f 6f6d 4d65 7373  eEmote, RoomMess
-00000990: 6167 6546 696c 652c 2052 6f6f 6d4d 6573  ageFile, RoomMes
-000009a0: 7361 6765 466f 726d 6174 7465 642c 0a20  sageFormatted,. 
-000009b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000009c0: 526f 6f6d 4d65 7373 6167 6549 6d61 6765  RoomMessageImage
-000009d0: 2c20 526f 6f6d 4d65 7373 6167 654d 6564  , RoomMessageMed
-000009e0: 6961 2c20 526f 6f6d 4d65 7373 6167 654e  ia, RoomMessageN
-000009f0: 6f74 6963 652c 0a20 2020 2020 2020 2020  otice,.         
-00000a00: 2020 2020 2020 2020 526f 6f6d 4d65 7373          RoomMess
-00000a10: 6167 6573 4572 726f 722c 2052 6f6f 6d4d  agesError, RoomM
-00000a20: 6573 7361 6765 5465 7874 2c20 526f 6f6d  essageText, Room
-00000a30: 4d65 7373 6167 6555 6e6b 6e6f 776e 2c0a  MessageUnknown,.
-00000a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000a50: 2052 6f6f 6d4d 6573 7361 6765 5669 6465   RoomMessageVide
-00000a60: 6f2c 2052 6f6f 6d4e 616d 6545 7665 6e74  o, RoomNameEvent
-00000a70: 2c20 526f 6f6d 5072 6573 6574 2c0a 2020  , RoomPreset,.  
-00000a80: 2020 2020 2020 2020 2020 2020 2020 2052                 R
-00000a90: 6f6f 6d50 7574 416c 6961 7352 6573 706f  oomPutAliasRespo
-00000aa0: 6e73 652c 2052 6f6f 6d52 6561 644d 6172  nse, RoomReadMar
-00000ab0: 6b65 7273 4572 726f 722c 2052 6f6f 6d52  kersError, RoomR
-00000ac0: 6564 6163 7445 7272 6f72 2c0a 2020 2020  edactError,.    
-00000ad0: 2020 2020 2020 2020 2020 2020 2052 6f6f               Roo
-00000ae0: 6d52 6573 6f6c 7665 416c 6961 7345 7272  mResolveAliasErr
-00000af0: 6f72 2c20 526f 6f6d 5265 736f 6c76 6541  or, RoomResolveA
-00000b00: 6c69 6173 5265 7370 6f6e 7365 2c0a 2020  liasResponse,.  
-00000b10: 2020 2020 2020 2020 2020 2020 2020 2052                 R
-00000b20: 6f6f 6d53 656e 6445 7272 6f72 2c20 526f  oomSendError, Ro
-00000b30: 6f6d 556e 6261 6e45 7272 6f72 2c20 526f  omUnbanError, Ro
-00000b40: 6f6d 5669 7369 6269 6c69 7479 2c20 5379  omVisibility, Sy
-00000b50: 6e63 4572 726f 722c 0a20 2020 2020 2020  ncError,.       
-00000b60: 2020 2020 2020 2020 2020 5379 6e63 5265            SyncRe
-00000b70: 7370 6f6e 7365 2c20 546f 4465 7669 6365  sponse, ToDevice
-00000b80: 4572 726f 722c 2055 6e6b 6e6f 776e 4576  Error, UnknownEv
-00000b90: 656e 742c 2055 7064 6174 6544 6576 6963  ent, UpdateDevic
-00000ba0: 6545 7272 6f72 2c0a 2020 2020 2020 2020  eError,.        
-00000bb0: 2020 2020 2020 2020 2055 706c 6f61 6445           UploadE
-00000bc0: 7272 6f72 2c20 5570 6c6f 6164 5265 7370  rror, UploadResp
-00000bd0: 6f6e 7365 2c20 6372 7970 746f 2c20 7265  onse, crypto, re
-00000be0: 7370 6f6e 7365 7329 0a66 726f 6d20 5049  sponses).from PI
-00000bf0: 4c20 696d 706f 7274 2049 6d61 6765 0a66  L import Image.f
-00000c00: 726f 6d20 7864 6720 696d 706f 7274 2042  rom xdg import B
-00000c10: 6173 6544 6972 6563 746f 7279 0a0a 7472  aseDirectory..tr
-00000c20: 793a 0a20 2020 2069 6d70 6f72 7420 6e6f  y:.    import no
-00000c30: 7469 6679 320a 0a20 2020 2048 4156 455f  tify2..    HAVE_
-00000c40: 4e4f 5449 4659 203d 2054 7275 650a 6578  NOTIFY = True.ex
-00000c50: 6365 7074 2049 6d70 6f72 7445 7272 6f72  cept ImportError
-00000c60: 3a0a 2020 2020 4841 5645 5f4e 4f54 4946  :.    HAVE_NOTIF
-00000c70: 5920 3d20 4661 6c73 650a 0a74 7279 3a0a  Y = False..try:.
-00000c80: 2020 2020 6672 6f6d 206e 696f 2069 6d70      from nio imp
-00000c90: 6f72 7420 4765 744f 7065 6e49 4454 6f6b  ort GetOpenIDTok
-00000ca0: 656e 4572 726f 720a 0a20 2020 2048 4156  enError..    HAV
-00000cb0: 455f 4f50 454e 4944 203d 2054 7275 650a  E_OPENID = True.
-00000cc0: 6578 6365 7074 2049 6d70 6f72 7445 7272  except ImportErr
-00000cd0: 6f72 3a0a 2020 2020 4841 5645 5f4f 5045  or:.    HAVE_OPE
-00000ce0: 4e49 4420 3d20 4661 6c73 650a 0a23 2076  NID = False..# v
-00000cf0: 6572 7369 6f6e 206e 756d 6265 720a 5645  ersion number.VE
-00000d00: 5253 494f 4e20 3d20 2232 3032 332d 3034  RSION = "2023-04
-00000d10: 2d30 3422 0a56 4552 5349 4f4e 4e52 203d  -04".VERSIONNR =
-00000d20: 2022 362e 302e 3222 0a23 206d 6174 7269   "6.0.2".# matri
-00000d30: 782d 636f 6d6d 616e 6465 723b 2066 6f72  x-commander; for
-00000d40: 2062 6163 6b77 6172 6473 2063 6f6d 7069   backwards compi
-00000d50: 7461 6269 6c69 7479 2072 6570 6c61 6365  tability replace
-00000d60: 205f 2077 6974 6820 2d0a 5052 4f47 5f57   _ with -.PROG_W
-00000d70: 4954 484f 5554 5f45 5854 203d 206f 732e  ITHOUT_EXT = os.
-00000d80: 7061 7468 2e73 706c 6974 6578 7428 6f73  path.splitext(os
-00000d90: 2e70 6174 682e 6261 7365 6e61 6d65 285f  .path.basename(_
-00000da0: 5f66 696c 655f 5f29 295b 305d 2e72 6570  _file__))[0].rep
-00000db0: 6c61 6365 280a 2020 2020 225f 222c 2022  lace(.    "_", "
-00000dc0: 2d22 0a29 0a23 206d 6174 7269 782d 636f  -".).# matrix-co
-00000dd0: 6d6d 616e 6465 722e 7079 3b20 666f 7220  mmander.py; for 
-00000de0: 6261 636b 7761 7264 7320 636f 6d70 6974  backwards compit
-00000df0: 6162 696c 6974 7920 7265 706c 6163 6520  ability replace 
-00000e00: 5f20 7769 7468 202d 0a50 524f 475f 5749  _ with -.PROG_WI
-00000e10: 5448 5f45 5854 203d 206f 732e 7061 7468  TH_EXT = os.path
-00000e20: 2e62 6173 656e 616d 6528 5f5f 6669 6c65  .basename(__file
-00000e30: 5f5f 292e 7265 706c 6163 6528 225f 222c  __).replace("_",
-00000e40: 2022 2d22 290a 2320 6669 6c65 2074 6f20   "-").# file to 
-00000e50: 7374 6f72 6520 6372 6564 656e 7469 616c  store credential
-00000e60: 7320 696e 2063 6173 6520 796f 7520 7761  s in case you wa
-00000e70: 6e74 2074 6f20 7275 6e20 7072 6f67 7261  nt to run progra
-00000e80: 6d20 6d75 6c74 6970 6c65 2074 696d 6573  m multiple times
-00000e90: 0a43 5245 4445 4e54 4941 4c53 5f46 494c  .CREDENTIALS_FIL
-00000ea0: 455f 4445 4641 554c 5420 3d20 2263 7265  E_DEFAULT = "cre
-00000eb0: 6465 6e74 6961 6c73 2e6a 736f 6e22 2020  dentials.json"  
-00000ec0: 2320 6c6f 6769 6e20 6372 6564 656e 7469  # login credenti
-00000ed0: 616c 7320 4a53 4f4e 2066 696c 650a 2320  als JSON file.# 
-00000ee0: 652e 672e 207e 2f2e 636f 6e66 6967 2f6d  e.g. ~/.config/m
-00000ef0: 6174 7269 782d 636f 6d6d 616e 6465 722f  atrix-commander/
-00000f00: 0a43 5245 4445 4e54 4941 4c53 5f44 4952  .CREDENTIALS_DIR
-00000f10: 5f4c 4153 5452 4553 4f52 5420 3d20 6f73  _LASTRESORT = os
-00000f20: 2e70 6174 682e 6578 7061 6e64 7573 6572  .path.expanduser
-00000f30: 280a 2020 2020 4261 7365 4469 7265 6374  (.    BaseDirect
-00000f40: 6f72 792e 7864 675f 636f 6e66 6967 5f68  ory.xdg_config_h
-00000f50: 6f6d 6520 2b20 222f 2220 2023 2022 7e2f  ome + "/"  # "~/
-00000f60: 2e63 6f6e 6669 672f 220a 2920 2b20 6f73  .config/".) + os
-00000f70: 2e70 6174 682e 7370 6c69 7465 7874 286f  .path.splitext(o
-00000f80: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
-00000f90: 5f5f 6669 6c65 5f5f 2929 5b30 5d2e 7265  __file__))[0].re
-00000fa0: 706c 6163 6528 225f 222c 2022 2d22 290a  place("_", "-").
-00000fb0: 2320 6469 7265 6374 6f72 7920 746f 2062  # directory to b
-00000fc0: 6520 7573 6564 2062 7920 656e 642d 746f  e used by end-to
-00000fd0: 2d65 6e64 2065 6e63 7279 7074 6564 2070  -end encrypted p
-00000fe0: 726f 746f 636f 6c20 666f 7220 7065 7273  rotocol for pers
-00000ff0: 6973 7465 6e74 2073 746f 7261 6765 0a53  istent storage.S
-00001000: 544f 5245 5f44 4952 5f44 4546 4155 4c54  TORE_DIR_DEFAULT
-00001010: 203d 2022 2e2f 7374 6f72 652f 220a 2320   = "./store/".# 
-00001020: 652e 672e 207e 2f2e 6c6f 6361 6c2f 7368  e.g. ~/.local/sh
-00001030: 6172 652f 6d61 7472 6978 2d63 6f6d 6d61  are/matrix-comma
-00001040: 6e64 6572 2f0a 2320 7468 6520 5354 4f52  nder/.# the STOR
-00001050: 455f 5041 5448 5f4c 4153 5452 4553 4f52  E_PATH_LASTRESOR
-00001060: 5420 7769 6c6c 2062 6520 636f 6e63 6174  T will be concat
-00001070: 656e 6174 6564 2077 6974 6820 6120 6469  enated with a di
-00001080: 7265 6374 6f72 7920 6e61 6d65 0a23 206c  rectory name.# l
-00001090: 696b 6520 7374 6f72 6520 746f 2072 6573  ike store to res
-000010a0: 756c 7420 696e 2061 2066 696e 616c 2070  ult in a final p
-000010b0: 6174 6820 6f66 0a23 2065 2e67 2e20 7e2f  ath of.# e.g. ~/
-000010c0: 2e6c 6f63 616c 2f73 6861 7265 2f6d 6174  .local/share/mat
-000010d0: 7269 782d 636f 6d6d 616e 6465 722f 7374  rix-commander/st
-000010e0: 6f72 652f 2061 7320 6163 7475 616c 2070  ore/ as actual p
-000010f0: 6572 7369 7374 656e 7420 7374 6f72 6520  ersistent store 
-00001100: 6469 720a 5354 4f52 455f 5041 5448 5f4c  dir.STORE_PATH_L
-00001110: 4153 5452 4553 4f52 5420 3d20 6f73 2e70  ASTRESORT = os.p
-00001120: 6174 682e 6e6f 726d 7061 7468 280a 2020  ath.normpath(.  
-00001130: 2020 280a 2020 2020 2020 2020 6f73 2e70    (.        os.p
-00001140: 6174 682e 6578 7061 6e64 7573 6572 280a  ath.expanduser(.
-00001150: 2020 2020 2020 2020 2020 2020 4261 7365              Base
-00001160: 4469 7265 6374 6f72 792e 7864 675f 6461  Directory.xdg_da
-00001170: 7461 5f68 6f6d 6520 2b20 222f 220a 2020  ta_home + "/".  
-00001180: 2020 2020 2020 2920 2023 207e 2f2e 6c6f        )  # ~/.lo
-00001190: 6361 6c2f 7368 6172 652f 0a20 2020 2020  cal/share/.     
-000011a0: 2020 202b 206f 732e 7061 7468 2e73 706c     + os.path.spl
-000011b0: 6974 6578 7428 6f73 2e70 6174 682e 6261  itext(os.path.ba
-000011c0: 7365 6e61 6d65 285f 5f66 696c 655f 5f29  sename(__file__)
-000011d0: 295b 305d 2e72 6570 6c61 6365 2822 5f22  )[0].replace("_"
-000011e0: 2c20 222d 2229 0a20 2020 2029 0a29 0a23  , "-").    ).).#
-000011f0: 2065 2e67 2e20 7e2f 2e6c 6f63 616c 2f73   e.g. ~/.local/s
-00001200: 6861 7265 2f6d 6174 7269 782d 636f 6d6d  hare/matrix-comm
-00001210: 616e 6465 722f 7374 6f72 652f 0a53 544f  ander/store/.STO
-00001220: 5245 5f44 4952 5f4c 4153 5452 4553 4f52  RE_DIR_LASTRESOR
-00001230: 5420 3d20 6f73 2e70 6174 682e 6e6f 726d  T = os.path.norm
-00001240: 7061 7468 280a 2020 2020 286f 732e 7061  path(.    (os.pa
-00001250: 7468 2e65 7870 616e 6475 7365 7228 5354  th.expanduser(ST
-00001260: 4f52 455f 5041 5448 5f4c 4153 5452 4553  ORE_PATH_LASTRES
-00001270: 4f52 5420 2b20 222f 2220 2b20 5354 4f52  ORT + "/" + STOR
-00001280: 455f 4449 525f 4445 4641 554c 5429 290a  E_DIR_DEFAULT)).
-00001290: 290a 2320 6469 7265 6374 6f72 7920 746f  ).# directory to
-000012a0: 2062 6520 7573 6564 2066 6f72 2064 6f77   be used for dow
-000012b0: 6e6c 6f61 6469 6e67 206d 6564 6961 2066  nloading media f
-000012c0: 696c 6573 0a4d 4544 4941 5f44 4952 5f44  iles.MEDIA_DIR_D
-000012d0: 4546 4155 4c54 203d 2022 2e2f 6d65 6469  EFAULT = "./medi
-000012e0: 612f 220a 2320 7573 7561 6c6c 7920 7468  a/".# usually th
-000012f0: 6572 6520 6172 6520 6e6f 2070 6572 6d69  ere are no permi
-00001300: 7373 696f 6e73 2066 6f72 2075 7369 6e67  ssions for using
-00001310: 3a20 2f72 756e 2f6d 6174 7269 782d 636f  : /run/matrix-co
-00001320: 6d6d 616e 6465 722e 7069 640a 2320 736f  mmander.pid.# so
-00001330: 2069 6e73 7465 6164 206c 6f63 616c 2066   instead local f
-00001340: 696c 6573 206c 696b 6520 7e2f 2e72 756e  iles like ~/.run
-00001350: 2f6d 6174 7269 782d 636f 6d6d 616e 6465  /matrix-commande
-00001360: 722e 736f 6d65 2d75 7569 642d 6865 7265  r.some-uuid-here
-00001370: 2e70 6964 2077 696c 6c0a 2320 6265 2075  .pid will.# be u
-00001380: 7365 6420 666f 7220 7374 6f72 696e 6720  sed for storing 
-00001390: 7468 6520 5049 4428 7329 2066 6f72 2073  the PID(s) for s
-000013a0: 656e 6469 6e67 2073 6967 6e61 6c73 2e0a  ending signals..
-000013b0: 2320 5468 6572 6520 6d69 6768 7420 6265  # There might be
-000013c0: 206d 6f72 6520 7468 616e 2031 2070 726f   more than 1 pro
-000013d0: 6365 7373 2072 756e 6e69 6e67 2069 6e20  cess running in 
-000013e0: 7061 7261 6c6c 656c 2c20 736f 2074 6865  parallel, so the
-000013f0: 7265 206d 6967 6874 2062 650a 2320 6d6f  re might be.# mo
-00001400: 7265 2074 6861 6e20 3120 5049 4420 6174  re than 1 PID at
-00001410: 2061 2067 6976 656e 2070 6f69 6e74 2069   a given point i
-00001420: 6e20 7469 6d65 2e0a 5049 445f 4449 525f  n time..PID_DIR_
-00001430: 4445 4641 554c 5420 3d20 6f73 2e70 6174  DEFAULT = os.pat
-00001440: 682e 6e6f 726d 7061 7468 286f 732e 7061  h.normpath(os.pa
-00001450: 7468 2e65 7870 616e 6475 7365 7228 227e  th.expanduser("~
-00001460: 2f2e 7275 6e2f 2229 290a 5049 445f 4649  /.run/")).PID_FI
-00001470: 4c45 5f44 4546 4155 4c54 203d 206f 732e  LE_DEFAULT = os.
-00001480: 7061 7468 2e6e 6f72 6d70 6174 6828 0a20  path.normpath(. 
-00001490: 2020 2050 4944 5f44 4952 5f44 4546 4155     PID_DIR_DEFAU
-000014a0: 4c54 202b 2022 2f22 202b 2050 524f 475f  LT + "/" + PROG_
-000014b0: 5749 5448 4f55 545f 4558 5420 2b20 222e  WITHOUT_EXT + ".
-000014c0: 2220 2b20 7374 7228 7575 6964 2e75 7569  " + str(uuid.uui
-000014d0: 6434 2829 2920 2b20 222e 7069 6422 0a29  d4()) + ".pid".)
-000014e0: 0a45 4d4f 4a49 203d 2022 656d 6f6a 6922  .EMOJI = "emoji"
-000014f0: 2020 2320 7665 7269 6669 6361 7469 6f6e    # verification
-00001500: 2074 7970 650a 5052 494e 5420 3d20 2270   type.PRINT = "p
-00001510: 7269 6e74 2220 2023 2076 6572 7369 6f6e  rint"  # version
-00001520: 2074 7970 650a 4348 4543 4b20 3d20 2263   type.CHECK = "c
-00001530: 6865 636b 2220 2023 2076 6572 7369 6f6e  heck"  # version
-00001540: 2074 7970 650a 4f4e 4345 203d 2022 6f6e   type.ONCE = "on
-00001550: 6365 2220 2023 206c 6973 7465 6e69 6e67  ce"  # listening
-00001560: 2074 7970 650a 4e45 5645 5220 3d20 226e   type.NEVER = "n
-00001570: 6576 6572 2220 2023 206c 6973 7465 6e69  ever"  # listeni
-00001580: 6e67 2074 7970 650a 464f 5245 5645 5220  ng type.FOREVER 
-00001590: 3d20 2266 6f72 6576 6572 2220 2023 206c  = "forever"  # l
-000015a0: 6973 7465 6e69 6e67 2074 7970 650a 414c  istening type.AL
-000015b0: 4c20 3d20 2261 6c6c 2220 2023 206c 6973  L = "all"  # lis
-000015c0: 7465 6e69 6e67 2074 7970 650a 5441 494c  tening type.TAIL
-000015d0: 203d 2022 7461 696c 2220 2023 206c 6973   = "tail"  # lis
-000015e0: 7465 6e69 6e67 2074 7970 650a 4445 4641  tening type.DEFA
-000015f0: 554c 545f 5345 5041 5241 544f 5220 3d20  ULT_SEPARATOR = 
-00001600: 2220 2020 2022 2020 2320 7573 6564 2066  "    "  # used f
-00001610: 6f72 2073 7065 7261 7469 6e67 2063 6f6c  or sperating col
-00001620: 756d 6e73 2069 6e20 7072 696e 7420 6f75  umns in print ou
-00001630: 7470 7574 730a 5345 5020 3d20 4445 4641  tputs.SEP = DEFA
-00001640: 554c 545f 5345 5041 5241 544f 520a 4c49  ULT_SEPARATOR.LI
-00001650: 5354 454e 5f44 4546 4155 4c54 203d 204e  STEN_DEFAULT = N
-00001660: 4556 4552 0a54 4149 4c5f 554e 5553 4544  EVER.TAIL_UNUSED
-00001670: 5f44 4546 4155 4c54 203d 2030 2020 2320  _DEFAULT = 0  # 
-00001680: 6765 7420 3020 6966 202d 2d74 6169 6c20  get 0 if --tail 
-00001690: 6973 206e 6f74 2073 7065 6369 6669 6564  is not specified
-000016a0: 0a54 4149 4c5f 5553 4544 5f44 4546 4155  .TAIL_USED_DEFAU
-000016b0: 4c54 203d 2031 3020 2023 2067 6574 2074  LT = 10  # get t
-000016c0: 6865 206c 6173 7420 3130 206d 7367 7320  he last 10 msgs 
-000016d0: 6279 2064 6566 6175 6c74 2077 6974 6820  by default with 
-000016e0: 2d2d 7461 696c 0a56 4552 4946 595f 554e  --tail.VERIFY_UN
-000016f0: 5553 4544 5f44 4546 4155 4c54 203d 204e  USED_DEFAULT = N
-00001700: 6f6e 6520 2023 2075 7365 204e 6f6e 6520  one  # use None 
-00001710: 6966 202d 2d76 6572 6966 7920 6973 206e  if --verify is n
-00001720: 6f74 2073 7065 6369 6669 6564 0a56 4552  ot specified.VER
-00001730: 4946 595f 5553 4544 5f44 4546 4155 4c54  IFY_USED_DEFAULT
-00001740: 203d 2045 4d4f 4a49 2020 2320 7573 6520   = EMOJI  # use 
-00001750: 2765 6d6f 6a69 2720 6279 2064 6566 6175  'emoji' by defau
-00001760: 6c74 2077 6974 6820 2d2d 7665 7269 6679  lt with --verify
-00001770: 0a56 4552 5349 4f4e 5f55 4e55 5345 445f  .VERSION_UNUSED_
-00001780: 4445 4641 554c 5420 3d20 4e6f 6e65 2020  DEFAULT = None  
-00001790: 2320 7573 6520 4e6f 6e65 2069 6620 2d2d  # use None if --
-000017a0: 7665 7273 696f 6e20 6973 206e 6f74 2073  version is not s
-000017b0: 7065 6369 6669 6564 0a56 4552 5349 4f4e  pecified.VERSION
-000017c0: 5f55 5345 445f 4445 4641 554c 5420 3d20  _USED_DEFAULT = 
-000017d0: 5052 494e 5420 2023 2075 7365 2027 7072  PRINT  # use 'pr
-000017e0: 696e 7427 2062 7920 6465 6661 756c 7420  int' by default 
-000017f0: 7769 7468 202d 2d76 6572 7369 6f6e 0a53  with --version.S
-00001800: 4554 5f44 4556 4943 455f 4e41 4d45 5f55  ET_DEVICE_NAME_U
-00001810: 4e55 5345 445f 4445 4641 554c 5420 3d20  NUSED_DEFAULT = 
-00001820: 4e6f 6e65 2020 2320 7573 6520 4e6f 6e65  None  # use None
-00001830: 2069 6620 6f70 7469 6f6e 2069 7320 6e6f   if option is no
-00001840: 7420 7370 6563 6966 6965 640a 5345 545f  t specified.SET_
-00001850: 4449 5350 4c41 595f 4e41 4d45 5f55 4e55  DISPLAY_NAME_UNU
-00001860: 5345 445f 4445 4641 554c 5420 3d20 4e6f  SED_DEFAULT = No
-00001870: 6e65 2020 2320 7573 6520 4e6f 6e65 206f  ne  # use None o
-00001880: 7074 696f 6e20 6e6f 7420 7573 6564 0a4e  ption not used.N
-00001890: 4f5f 5353 4c5f 554e 5553 4544 5f44 4546  O_SSL_UNUSED_DEF
-000018a0: 4155 4c54 203d 204e 6f6e 6520 2023 2075  AULT = None  # u
-000018b0: 7365 204e 6f6e 6520 6966 202d 2d6e 6f2d  se None if --no-
-000018c0: 7373 6c20 6973 206e 6f74 2067 6976 656e  ssl is not given
-000018d0: 0a53 534c 5f43 4552 5449 4649 4341 5445  .SSL_CERTIFICATE
-000018e0: 5f44 4546 4155 4c54 203d 204e 6f6e 6520  _DEFAULT = None 
-000018f0: 2023 2075 7365 204e 6f6e 6520 6966 202d   # use None if -
-00001900: 2d73 736c 2d63 6572 7469 6669 6361 7465  -ssl-certificate
-00001910: 2069 7320 6e6f 7420 6769 7665 6e0a 4d58   is not given.MX
-00001920: 435f 4944 5f50 4c41 4345 484f 4c44 4552  C_ID_PLACEHOLDER
-00001930: 203d 2022 5f5f 6d78 635f 6964 5f5f 220a   = "__mxc_id__".
-00001940: 484f 4d45 5345 5256 4552 5f50 4c41 4345  HOMESERVER_PLACE
-00001950: 484f 4c44 4552 203d 2022 5f5f 686f 6d65  HOLDER = "__home
-00001960: 7365 7276 6572 5f5f 2220 2023 206c 696b  server__"  # lik
-00001970: 6520 6874 7470 733a 2f2f 6d61 7472 6978  e https://matrix
-00001980: 2e65 7861 6d70 6c65 2e6f 7267 0a48 4f53  .example.org.HOS
-00001990: 544e 414d 455f 504c 4143 4548 4f4c 4445  TNAME_PLACEHOLDE
-000019a0: 5220 3d20 225f 5f68 6f73 746e 616d 655f  R = "__hostname_
-000019b0: 5f22 2020 2320 6c69 6b65 206d 6174 7269  _"  # like matri
-000019c0: 782e 6578 616d 706c 652e 6f72 670a 4143  x.example.org.AC
-000019d0: 4345 5353 5f54 4f4b 454e 5f50 4c41 4345  CESS_TOKEN_PLACE
-000019e0: 484f 4c44 4552 203d 2022 5f5f 6163 6365  HOLDER = "__acce
-000019f0: 7373 5f74 6f6b 656e 5f5f 220a 5553 4552  ss_token__".USER
-00001a00: 5f49 445f 504c 4143 4548 4f4c 4445 5220  _ID_PLACEHOLDER 
-00001a10: 3d20 225f 5f75 7365 725f 6964 5f5f 2220  = "__user_id__" 
-00001a20: 2023 206c 696b 6520 4020 6d63 3a20 6d61   # like @ mc: ma
-00001a30: 7472 6978 2e65 7861 6d70 6c65 2e63 6f6d  trix.example.com
-00001a40: 0a44 4556 4943 455f 4944 5f50 4c41 4345  .DEVICE_ID_PLACE
-00001a50: 484f 4c44 4552 203d 2022 5f5f 6465 7669  HOLDER = "__devi
-00001a60: 6365 5f69 645f 5f22 0a52 4f4f 4d5f 4944  ce_id__".ROOM_ID
-00001a70: 5f50 4c41 4345 484f 4c44 4552 203d 2022  _PLACEHOLDER = "
-00001a80: 5f5f 726f 6f6d 5f69 645f 5f22 0a53 594e  __room_id__".SYN
-00001a90: 435f 4655 4c4c 203d 2022 6675 6c6c 2220  C_FULL = "full" 
-00001aa0: 2023 2073 796e 6320 7769 7468 2066 756c   # sync with ful
-00001ab0: 6c5f 7374 6174 653d 5472 7565 2066 6f72  l_state=True for
-00001ac0: 2073 656e 6420 6163 7469 6f6e 730a 2320   send actions.# 
-00001ad0: 5359 4e43 5f50 4152 5449 414c 203d 2022  SYNC_PARTIAL = "
-00001ae0: 6675 6c6c 2220 2320 7379 6e63 2077 6974  full" # sync wit
-00001af0: 6820 6675 6c6c 5f73 7461 7465 3d46 616c  h full_state=Fal
-00001b00: 7365 2066 6f72 2073 656e 6420 6163 7469  se for send acti
-00001b10: 6f6e 730a 5359 4e43 5f4f 4646 203d 2022  ons.SYNC_OFF = "
-00001b20: 6f66 6622 2020 2320 6e6f 2073 796e 6320  off"  # no sync 
-00001b30: 6973 2064 6f6e 6520 666f 7220 7365 6e64  is done for send
-00001b40: 2061 6374 696f 6e73 0a53 594e 435f 4445   actions.SYNC_DE
-00001b50: 4641 554c 5420 3d20 5359 4e43 5f46 554c  FAULT = SYNC_FUL
-00001b60: 4c0a 2320 7465 7874 2c20 696e 7465 6e64  L.# text, intend
-00001b70: 6564 2066 6f72 2068 756d 616e 2063 6f6e  ed for human con
-00001b80: 7375 6d70 7469 6f6e 0a4f 5554 5055 545f  sumption.OUTPUT_
-00001b90: 5445 5854 203d 2022 7465 7874 220a 2320  TEXT = "text".# 
-00001ba0: 6a73 6f6e 2c20 6173 2063 6c6f 7365 2074  json, as close t
-00001bb0: 6f20 6173 2077 6861 7420 4e49 4f20 4150  o as what NIO AP
-00001bc0: 4920 7072 6f76 6964 6573 2c20 6120 6665  I provides, a fe
-00001bd0: 7720 636f 6e76 656e 6965 6e74 2066 6965  w convenient fie
-00001be0: 6c64 7320 6164 6465 640a 2320 7472 616e  lds added.# tran
-00001bf0: 7370 6f72 745f 7265 7370 6f6e 7365 2072  sport_response r
-00001c00: 656d 6f76 6564 0a4f 5554 5055 545f 4a53  emoved.OUTPUT_JS
-00001c10: 4f4e 203d 2022 6a73 6f6e 220a 2320 6a73  ON = "json".# js
-00001c20: 6f6e 2d6d 6178 2c20 6a73 6f6e 2066 6f72  on-max, json for
-00001c30: 6d61 742c 206c 696b 6520 226a 736f 6e22  mat, like "json"
-00001c40: 2062 7574 2077 6974 6820 7472 616e 7370   but with transp
-00001c50: 6f72 745f 7265 7370 6f6e 7365 206f 626a  ort_response obj
-00001c60: 6563 7420 6164 6465 640a 4f55 5450 5554  ect added.OUTPUT
-00001c70: 5f4a 534f 4e5f 4d41 5820 3d20 226a 736f  _JSON_MAX = "jso
-00001c80: 6e2d 6d61 7822 0a23 206a 736f 6e2d 7370  n-max".# json-sp
-00001c90: 6563 2c20 6a73 6f6e 2066 6f72 6d61 742c  ec, json format,
-00001ca0: 2069 6620 616e 6420 6f6e 6c79 2069 6620   if and only if 
-00001cb0: 6f75 7470 7574 2061 6468 6572 6573 2031  output adheres 1
-00001cc0: 3030 2520 746f 204d 6174 7269 780a 2320  00% to Matrix.# 
-00001cd0: 5370 6563 6966 6963 6174 696f 6e20 7769  Specification wi
-00001ce0: 6c6c 2074 6865 2064 6174 6120 6265 2070  ll the data be p
-00001cf0: 7269 6e74 6564 2e20 4375 7272 656e 746c  rinted. Currentl
-00001d00: 792c 206f 6e6c 7920 2d2d 6c69 7374 656e  y, only --listen
-00001d10: 2028 2d2d 7461 696c 290a 2320 6164 6865   (--tail).# adhe
-00001d20: 7265 2074 6f20 5370 6563 2061 6e64 2068  re to Spec and h
-00001d30: 656e 6365 2070 7269 6e74 2061 204a 534f  ence print a JSO
-00001d40: 4e20 6f62 6a65 6374 2e20 416c 6c20 6f74  N object. All ot
-00001d50: 6865 7220 7072 696e 7420 6e6f 7468 696e  her print nothin
-00001d60: 672e 0a4f 5554 5055 545f 4a53 4f4e 5f53  g..OUTPUT_JSON_S
-00001d70: 5045 4320 3d20 226a 736f 6e2d 7370 6563  PEC = "json-spec
-00001d80: 220a 4f55 5450 5554 5f44 4546 4155 4c54  ".OUTPUT_DEFAULT
-00001d90: 203d 204f 5554 5055 545f 5445 5854 0a23   = OUTPUT_TEXT.#
-00001da0: 206c 6f63 6174 696f 6e20 6f66 2052 4541   location of REA
-00001db0: 444d 452e 6d64 2066 696c 6520 6966 2069  DME.md file if i
-00001dc0: 7420 6973 206e 6f74 2066 6f75 6e64 206f  t is not found o
-00001dd0: 6e20 6c6f 6361 6c20 6861 7264 6469 736b  n local harddisk
-00001de0: 0a23 2075 7365 6420 666f 7220 2d2d 6d61  .# used for --ma
-00001df0: 6e75 616c 0a52 4541 444d 455f 4649 4c45  nual.README_FILE
-00001e00: 5f52 4157 5f55 524c 203d 2028 0a20 2020  _RAW_URL = (.   
-00001e10: 2022 6874 7470 733a 2f2f 7261 772e 6769   "https://raw.gi
-00001e20: 7468 7562 7573 6572 636f 6e74 656e 742e  thubusercontent.
-00001e30: 636f 6d2f 3867 6f2f 6d61 7472 6978 2d63  com/8go/matrix-c
-00001e40: 6f6d 6d61 6e64 6572 2f6d 6173 7465 722f  ommander/master/
-00001e50: 5245 4144 4d45 2e6d 6422 0a29 0a23 2069  README.md".).# i
-00001e60: 6e63 7265 6d65 6e74 2074 6869 7320 6e75  ncrement this nu
-00001e70: 6d62 6572 2061 6e64 2075 7365 206e 6577  mber and use new
-00001e80: 2069 6e63 7265 6d65 6e74 6564 206e 756d   incremented num
-00001e90: 6265 7220 666f 7220 6e65 7874 2077 6172  ber for next war
-00001ea0: 6e69 6e67 0a23 206c 6173 7420 756e 6971  ning.# last uniq
-00001eb0: 7565 2057 7878 7820 7761 726e 696e 6720  ue Wxxx warning 
-00001ec0: 6e75 6d62 6572 2075 7365 643a 2057 3131  number used: W11
-00001ed0: 323a 0a23 2069 6e63 7265 6d65 6e74 2074  2:.# increment t
-00001ee0: 6869 7320 6e75 6d62 6572 2061 6e64 2075  his number and u
-00001ef0: 7365 206e 6577 2069 6e63 7265 6d65 6e74  se new increment
-00001f00: 6564 206e 756d 6265 7220 666f 7220 6e65  ed number for ne
-00001f10: 7874 2065 7272 6f72 0a23 206c 6173 7420  xt error.# last 
-00001f20: 756e 6971 7565 2045 7878 7820 6572 726f  unique Exxx erro
-00001f30: 7220 6e75 6d62 6572 2075 7365 643a 2045  r number used: E
-00001f40: 3234 383a 0a0a 0a63 6c61 7373 204c 6f6f  248:...class Loo
-00001f50: 7365 5665 7273 696f 6e3a 0a20 2020 2022  seVersion:.    "
-00001f60: 2222 5665 7273 696f 6e20 6e75 6d62 6572  ""Version number
-00001f70: 696e 6720 616e 6420 636f 6d70 6172 6973  ing and comparis
-00001f80: 6f6e 2e0a 2020 2020 5365 6520 6874 7470  on..    See http
-00001f90: 733a 2f2f 6769 7468 7562 2e63 6f6d 2f65  s://github.com/e
-00001fa0: 6666 6967 6965 732f 6c6f 6f73 6576 6572  ffigies/loosever
-00001fb0: 7369 6f6e 2f62 6c6f 622f 6d61 696e 2f6c  sion/blob/main/l
-00001fc0: 6f6f 7365 7665 7273 696f 6e2e 7079 2e0a  ooseversion.py..
-00001fd0: 2020 2020 4172 6775 6d65 6e74 2027 6f74      Argument 'ot
-00001fe0: 6865 7227 206d 7573 7420 6265 206f 6620  her' must be of 
-00001ff0: 7479 7065 204c 6f6f 7365 5665 7273 696f  type LooseVersio
-00002000: 6e2e 0a20 2020 2022 2222 0a0a 2020 2020  n..    """..    
-00002010: 636f 6d70 6f6e 656e 745f 7265 203d 2072  component_re = r
-00002020: 652e 636f 6d70 696c 6528 7222 285c 642b  e.compile(r"(\d+
-00002030: 207c 205b 612d 7a5d 2b20 7c20 5c2e 2922   | [a-z]+ | \.)"
-00002040: 2c20 7265 2e56 4552 424f 5345 290a 0a20  , re.VERBOSE).. 
-00002050: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-00002060: 7365 6c66 2c20 7673 7472 696e 673d 4e6f  self, vstring=No
-00002070: 6e65 293a 0a20 2020 2020 2020 2069 6620  ne):.        if 
-00002080: 7673 7472 696e 673a 0a20 2020 2020 2020  vstring:.       
-00002090: 2020 2020 2073 656c 662e 7061 7273 6528       self.parse(
-000020a0: 7673 7472 696e 6729 0a0a 2020 2020 6465  vstring)..    de
-000020b0: 6620 5f5f 6571 5f5f 2873 656c 662c 206f  f __eq__(self, o
-000020c0: 7468 6572 293a 0a20 2020 2020 2020 2072  ther):.        r
-000020d0: 6574 7572 6e20 7365 6c66 2e5f 636d 7028  eturn self._cmp(
-000020e0: 6f74 6865 7229 203d 3d20 300a 0a20 2020  other) == 0..   
-000020f0: 2064 6566 205f 5f6c 745f 5f28 7365 6c66   def __lt__(self
-00002100: 2c20 6f74 6865 7229 3a0a 2020 2020 2020  , other):.      
-00002110: 2020 7265 7475 726e 2073 656c 662e 5f63    return self._c
-00002120: 6d70 286f 7468 6572 2920 3c20 300a 0a20  mp(other) < 0.. 
-00002130: 2020 2064 6566 205f 5f6c 655f 5f28 7365     def __le__(se
-00002140: 6c66 2c20 6f74 6865 7229 3a0a 2020 2020  lf, other):.    
-00002150: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-00002160: 5f63 6d70 286f 7468 6572 2920 3c3d 2030  _cmp(other) <= 0
-00002170: 0a0a 2020 2020 6465 6620 5f5f 6774 5f5f  ..    def __gt__
-00002180: 2873 656c 662c 206f 7468 6572 293a 0a20  (self, other):. 
-00002190: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-000021a0: 6c66 2e5f 636d 7028 6f74 6865 7229 203e  lf._cmp(other) >
-000021b0: 2030 0a0a 2020 2020 6465 6620 5f5f 6765   0..    def __ge
-000021c0: 5f5f 2873 656c 662c 206f 7468 6572 293a  __(self, other):
-000021d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000021e0: 7365 6c66 2e5f 636d 7028 6f74 6865 7229  self._cmp(other)
-000021f0: 203e 3d20 300a 0a20 2020 2064 6566 2070   >= 0..    def p
-00002200: 6172 7365 2873 656c 662c 2076 7374 7269  arse(self, vstri
-00002210: 6e67 293a 0a20 2020 2020 2020 2073 656c  ng):.        sel
-00002220: 662e 7673 7472 696e 6720 3d20 7673 7472  f.vstring = vstr
-00002230: 696e 670a 2020 2020 2020 2020 636f 6d70  ing.        comp
-00002240: 6f6e 656e 7473 203d 205b 0a20 2020 2020  onents = [.     
-00002250: 2020 2020 2020 2078 2066 6f72 2078 2069         x for x i
-00002260: 6e20 7365 6c66 2e63 6f6d 706f 6e65 6e74  n self.component
-00002270: 5f72 652e 7370 6c69 7428 7673 7472 696e  _re.split(vstrin
-00002280: 6729 2069 6620 7820 616e 6420 7820 213d  g) if x and x !=
-00002290: 2022 2e22 0a20 2020 2020 2020 205d 0a20   ".".        ]. 
-000022a0: 2020 2020 2020 2066 6f72 2069 2c20 6f62         for i, ob
-000022b0: 6a20 696e 2065 6e75 6d65 7261 7465 2863  j in enumerate(c
-000022c0: 6f6d 706f 6e65 6e74 7329 3a0a 2020 2020  omponents):.    
-000022d0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-000022e0: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
-000022f0: 706f 6e65 6e74 735b 695d 203d 2069 6e74  ponents[i] = int
-00002300: 286f 626a 290a 2020 2020 2020 2020 2020  (obj).          
-00002310: 2020 6578 6365 7074 2056 616c 7565 4572    except ValueEr
-00002320: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-00002330: 2020 2020 2070 6173 730a 2020 2020 2020       pass.      
-00002340: 2020 7365 6c66 2e76 6572 7369 6f6e 203d    self.version =
-00002350: 2063 6f6d 706f 6e65 6e74 730a 0a20 2020   components..   
-00002360: 2064 6566 205f 5f73 7472 5f5f 2873 656c   def __str__(sel
-00002370: 6629 3a0a 2020 2020 2020 2020 7265 7475  f):.        retu
-00002380: 726e 2073 656c 662e 7673 7472 696e 670a  rn self.vstring.
-00002390: 0a20 2020 2064 6566 205f 5f72 6570 725f  .    def __repr_
-000023a0: 5f28 7365 6c66 293a 0a20 2020 2020 2020  _(self):.       
-000023b0: 2072 6574 7572 6e20 224c 6f6f 7365 5665   return "LooseVe
-000023c0: 7273 696f 6e20 2827 2573 2729 2220 2520  rsion ('%s')" % 
-000023d0: 7374 7228 7365 6c66 290a 0a20 2020 2064  str(self)..    d
-000023e0: 6566 205f 636d 7028 7365 6c66 2c20 6f74  ef _cmp(self, ot
-000023f0: 6865 7229 3a0a 2020 2020 2020 2020 6966  her):.        if
-00002400: 2073 656c 662e 7665 7273 696f 6e20 3d3d   self.version ==
-00002410: 206f 7468 6572 2e76 6572 7369 6f6e 3a0a   other.version:.
-00002420: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00002430: 726e 2030 0a20 2020 2020 2020 2069 6620  rn 0.        if 
-00002440: 7365 6c66 2e76 6572 7369 6f6e 203c 206f  self.version < o
-00002450: 7468 6572 2e76 6572 7369 6f6e 3a0a 2020  ther.version:.  
-00002460: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00002470: 202d 310a 2020 2020 2020 2020 6966 2073   -1.        if s
-00002480: 656c 662e 7665 7273 696f 6e20 3e20 6f74  elf.version > ot
-00002490: 6865 722e 7665 7273 696f 6e3a 0a20 2020  her.version:.   
-000024a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000024b0: 310a 0a0a 636c 6173 7320 4d61 7472 6978  1...class Matrix
-000024c0: 436f 6d6d 616e 6465 7245 7272 6f72 2845  CommanderError(E
-000024d0: 7863 6570 7469 6f6e 293a 0a20 2020 2070  xception):.    p
-000024e0: 6173 730a 0a0a 636c 6173 7320 4d61 7472  ass...class Matr
-000024f0: 6978 436f 6d6d 616e 6465 7257 6172 6e69  ixCommanderWarni
-00002500: 6e67 2857 6172 6e69 6e67 293a 0a20 2020  ng(Warning):.   
-00002510: 2070 6173 730a 0a0a 636c 6173 7320 476c   pass...class Gl
-00002520: 6f62 616c 5374 6174 653a 0a20 2020 2022  obalState:.    "
-00002530: 2222 4b65 6570 2067 6c6f 6261 6c20 7661  ""Keep global va
-00002540: 7269 6162 6c65 732e 0a0a 2020 2020 5472  riables...    Tr
-00002550: 6976 6961 6c20 636c 6173 7320 746f 2068  ivial class to h
-00002560: 656c 7020 6b65 6570 2073 6f6d 6520 676c  elp keep some gl
-00002570: 6f62 616c 2073 7461 7465 2e0a 2020 2020  obal state..    
-00002580: 2222 220a 0a20 2020 2064 6566 205f 5f69  """..    def __i
-00002590: 6e69 745f 5f28 7365 6c66 293a 0a20 2020  nit__(self):.   
-000025a0: 2020 2020 2022 2222 5374 6f72 6520 676c       """Store gl
-000025b0: 6f62 616c 2073 7461 7465 2e22 2222 0a20  obal state.""". 
-000025c0: 2020 2020 2020 2073 656c 662e 6c6f 673a         self.log:
-000025d0: 206c 6f67 6769 6e67 2e4c 6f67 6765 7220   logging.Logger 
-000025e0: 3d20 4e6f 6e65 2020 2320 6c6f 6767 6572  = None  # logger
-000025f0: 206f 626a 6563 740a 2020 2020 2020 2020   object.        
-00002600: 7365 6c66 2e70 613a 2061 7267 7061 7273  self.pa: argpars
-00002610: 652e 4e61 6d65 7370 6163 6520 3d20 4e6f  e.Namespace = No
-00002620: 6e65 2020 2320 7061 7273 6564 2061 7267  ne  # parsed arg
-00002630: 756d 656e 7473 0a20 2020 2020 2020 2023  uments.        #
-00002640: 2074 6f20 7768 6963 6820 6c6f 6769 6320   to which logic 
-00002650: 286d 6573 7361 6765 2c20 696d 6167 652c  (message, image,
-00002660: 2061 7564 696f 2c20 6669 6c65 2c20 6576   audio, file, ev
-00002670: 656e 7429 2069 730a 2020 2020 2020 2020  ent) is.        
-00002680: 2320 7374 6469 6e20 7069 7065 2061 7373  # stdin pipe ass
-00002690: 6967 6e65 643f 0a20 2020 2020 2020 2073  igned?.        s
-000026a0: 656c 662e 7374 6469 6e5f 7573 653a 2073  elf.stdin_use: s
-000026b0: 7472 203d 2022 6e6f 6e65 220a 2020 2020  tr = "none".    
-000026c0: 2020 2020 2320 3129 2073 736c 204e 6f6e      # 1) ssl Non
-000026d0: 6520 6d65 616e 7320 6465 6661 756c 7420  e means default 
-000026e0: 5353 4c20 636f 6e74 6578 7420 7769 6c6c  SSL context will
-000026f0: 2062 6520 7573 6564 2e0a 2020 2020 2020   be used..      
-00002700: 2020 2320 3229 2073 736c 2046 616c 7365    # 2) ssl False
-00002710: 206d 6561 6e73 2053 534c 2063 6572 7469   means SSL certi
-00002720: 6669 6361 7465 2076 616c 6964 6174 696f  ficate validatio
-00002730: 6e20 7769 6c6c 2062 6520 736b 6970 7065  n will be skippe
-00002740: 640a 2020 2020 2020 2020 2320 3329 2073  d.        # 3) s
-00002750: 736c 2061 2076 616c 6964 2053 534c 436f  sl a valid SSLCo
-00002760: 6e74 6578 7420 6d65 616e 7320 7468 6174  ntext means that
-00002770: 2074 6865 2073 7065 6369 6669 6564 2063   the specified c
-00002780: 6f6e 7465 7874 2077 696c 6c20 6265 0a20  ontext will be. 
-00002790: 2020 2020 2020 2023 2020 2020 7573 6564         #    used
-000027a0: 2e20 5468 6973 2069 7320 7573 6566 756c  . This is useful
-000027b0: 2074 6f20 7573 696e 6720 6c6f 6361 6c20   to using local 
-000027c0: 5353 4c20 6365 7274 6966 6963 6174 652e  SSL certificate.
-000027d0: 0a20 2020 2020 2020 2073 656c 662e 7373  .        self.ss
-000027e0: 6c3a 2055 6e69 6f6e 5b4e 6f6e 652c 2053  l: Union[None, S
-000027f0: 534c 436f 6e74 6578 742c 2062 6f6f 6c5d  SLContext, bool]
-00002800: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00002810: 7365 6c66 2e63 6c69 656e 743a 2055 6e69  self.client: Uni
-00002820: 6f6e 5b4e 6f6e 652c 2041 7379 6e63 436c  on[None, AsyncCl
-00002830: 6965 6e74 5d20 3d20 4e6f 6e65 0a20 2020  ient] = None.   
-00002840: 2020 2020 2073 656c 662e 6372 6564 656e       self.creden
-00002850: 7469 616c 733a 2055 6e69 6f6e 5b4e 6f6e  tials: Union[Non
-00002860: 652c 2064 6963 745d 203d 204e 6f6e 650a  e, dict] = None.
-00002870: 2020 2020 2020 2020 7365 6c66 2e73 656e          self.sen
-00002880: 645f 6163 7469 6f6e 203d 2046 616c 7365  d_action = False
-00002890: 2020 2320 6172 6776 2063 6f6e 7461 696e    # argv contain
-000028a0: 7320 7365 6e64 2061 6374 696f 6e0a 2020  s send action.  
-000028b0: 2020 2020 2020 7365 6c66 2e6c 6973 7465        self.liste
-000028c0: 6e5f 6163 7469 6f6e 203d 2046 616c 7365  n_action = False
-000028d0: 2020 2320 6172 6776 2063 6f6e 7461 696e    # argv contain
-000028e0: 7320 6c69 7374 656e 2061 6374 696f 6e0a  s listen action.
-000028f0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-00002900: 6d5f 6163 7469 6f6e 203d 2046 616c 7365  m_action = False
-00002910: 2020 2320 6172 6776 2063 6f6e 7461 696e    # argv contain
-00002920: 7320 726f 6f6d 2061 6374 696f 6e0a 2020  s room action.  
-00002930: 2020 2020 2020 7365 6c66 2e73 6574 5f61        self.set_a
-00002940: 6374 696f 6e20 3d20 4661 6c73 6520 2023  ction = False  #
-00002950: 2061 7267 7620 636f 6e74 6169 6e73 2073   argv contains s
-00002960: 6574 2061 6374 696f 6e0a 2020 2020 2020  et action.      
-00002970: 2020 7365 6c66 2e67 6574 5f61 6374 696f    self.get_actio
-00002980: 6e20 3d20 4661 6c73 6520 2023 2061 7267  n = False  # arg
-00002990: 7620 636f 6e74 6169 6e73 2067 6574 2061  v contains get a
-000029a0: 6374 696f 6e0a 2020 2020 2020 2020 7365  ction.        se
-000029b0: 6c66 2e73 6574 6765 745f 6163 7469 6f6e  lf.setget_action
-000029c0: 203d 2046 616c 7365 2020 2320 6172 6776   = False  # argv
-000029d0: 2063 6f6e 7461 696e 7320 7365 7420 6f72   contains set or
-000029e0: 2067 6574 2061 6374 696f 6e0a 2020 2020   get action.    
-000029f0: 2020 2020 7365 6c66 2e65 7272 5f63 6f75      self.err_cou
-00002a00: 6e74 203d 2030 2020 2320 686f 7720 6d61  nt = 0  # how ma
-00002a10: 6e79 2065 7272 6f72 7320 6861 7665 206f  ny errors have o
-00002a20: 6363 7572 7265 6420 736f 2066 6172 0a20  ccurred so far. 
-00002a30: 2020 2020 2020 2073 656c 662e 7761 726e         self.warn
-00002a40: 5f63 6f75 6e74 203d 2030 2020 2320 686f  _count = 0  # ho
-00002a50: 7720 6d61 6e79 2077 6172 6e69 6e67 7320  w many warnings 
-00002a60: 6861 7665 206f 6363 7572 7265 6420 736f  have occurred so
-00002a70: 2066 6172 0a0a 0a23 2043 6f6e 7665 7274   far...# Convert
-00002a80: 204e 6f6e 6520 746f 2022 222c 2075 7365   None to "", use
-00002a90: 6675 6c20 7768 656e 2072 6570 6f72 7469  ful when reporti
-00002aa0: 6e67 2076 616c 7565 7320 746f 2073 7464  ng values to std
-00002ab0: 6f75 740a 2320 5368 6f75 6c64 206f 6e6c  out.# Should onl
-00002ac0: 7920 6265 2063 616c 6c65 6420 7769 7468  y be called with
-00002ad0: 2061 2920 4e6f 6e65 206f 7220 6229 2061   a) None or b) a
-00002ae0: 2073 7472 696e 672e 0a23 2057 6520 7761   string..# We wa
-00002af0: 6e74 2074 6f20 6176 6f69 6420 7369 7475  nt to avoid situ
-00002b00: 6174 696f 6e20 7768 6572 6520 7765 2077  ation where we w
-00002b10: 6f75 6c64 2070 7269 6e74 3a20 6e61 6d65  ould print: name
-00002b20: 203d 204e 6f6e 650a 6465 6620 7a6e 2873   = None.def zn(s
-00002b30: 7472 293a 0a20 2020 2072 6574 7572 6e20  tr):.    return 
-00002b40: 7374 7220 6f72 2022 220a 0a0a 6465 6620  str or ""...def 
-00002b50: 6765 745f 7175 616c 6966 6965 6463 6c61  get_qualifiedcla
-00002b60: 7373 6e61 6d65 286f 626a 293a 0a20 2020  ssname(obj):.   
-00002b70: 206b 6c61 7373 203d 206f 626a 2e5f 5f63   klass = obj.__c
-00002b80: 6c61 7373 5f5f 0a20 2020 206d 6f64 756c  lass__.    modul
-00002b90: 6520 3d20 6b6c 6173 732e 5f5f 6d6f 6475  e = klass.__modu
-00002ba0: 6c65 5f5f 0a20 2020 2069 6620 6d6f 6475  le__.    if modu
-00002bb0: 6c65 203d 3d20 2262 7569 6c74 696e 7322  le == "builtins"
-00002bc0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00002bd0: 206b 6c61 7373 2e5f 5f71 7561 6c6e 616d   klass.__qualnam
-00002be0: 655f 5f20 2023 2061 766f 6964 206f 7574  e__  # avoid out
-00002bf0: 7075 7473 206c 696b 6520 2762 7569 6c74  puts like 'built
-00002c00: 696e 732e 7374 7227 0a20 2020 2072 6574  ins.str'.    ret
-00002c10: 7572 6e20 6d6f 6475 6c65 202b 2022 2e22  urn module + "."
-00002c20: 202b 206b 6c61 7373 2e5f 5f71 7561 6c6e   + klass.__qualn
-00002c30: 616d 655f 5f0a 0a0a 6465 6620 7072 6976  ame__...def priv
-00002c40: 6163 795f 6669 6c74 6572 2864 6972 7479  acy_filter(dirty
-00002c50: 3a20 7374 7229 202d 3e20 7374 723a 0a20  : str) -> str:. 
-00002c60: 2020 2022 2222 5265 6d6f 7665 2070 7269     """Remove pri
-00002c70: 7661 7465 2069 6e66 6f20 6672 6f6d 2073  vate info from s
-00002c80: 7472 696e 6722 2222 0a20 2020 2023 2068  tring""".    # h
-00002c90: 6f6d 6573 6572 7665 7220 3d20 7572 6c70  omeserver = urlp
-00002ca0: 6172 7365 2867 732e 6372 6564 656e 7469  arse(gs.credenti
-00002cb0: 616c 735b 2268 6f6d 6573 6572 7665 7222  als["homeserver"
-00002cc0: 5d29 0a20 2020 2023 2073 6572 7665 725f  ]).    # server_
-00002cd0: 6e61 6d65 203d 2068 6f6d 6573 6572 7665  name = homeserve
-00002ce0: 722e 6e65 746c 6f63 0a20 2020 2023 2063  r.netloc.    # c
-00002cf0: 6c65 616e 203d 2064 6972 7479 2e72 6570  lean = dirty.rep
-00002d00: 6c61 6365 2873 6572 7665 725f 6e61 6d65  lace(server_name
-00002d10: 2c20 2279 6f75 722e 686f 6d65 7365 7276  , "your.homeserv
-00002d20: 6572 2e6f 7267 2229 0a20 2020 2072 6574  er.org").    ret
-00002d30: 7572 6e20 6469 7274 792e 7265 706c 6163  urn dirty.replac
-00002d40: 6528 6773 2e63 7265 6465 6e74 6961 6c73  e(gs.credentials
-00002d50: 5b22 6163 6365 7373 5f74 6f6b 656e 225d  ["access_token"]
-00002d60: 2c20 222a 2a2a 2229 0a0a 0a64 6566 2070  , "***")...def p
-00002d70: 7269 6e74 5f6f 7574 7075 7428 0a20 2020  rint_output(.   
-00002d80: 206f 7074 696f 6e3a 204c 6974 6572 616c   option: Literal
-00002d90: 5b22 7465 7874 222c 2022 6a73 6f6e 222c  ["text", "json",
-00002da0: 2022 6a73 6f6e 2d6d 6178 222c 2022 6a73   "json-max", "js
-00002db0: 6f6e 2d73 7065 6322 5d2c 0a20 2020 202a  on-spec"],.    *
-00002dc0: 2c0a 2020 2020 7465 7874 3a20 7374 722c  ,.    text: str,
-00002dd0: 0a20 2020 206a 736f 6e5f 3a20 6469 6374  .    json_: dict
-00002de0: 203d 204e 6f6e 652c 0a20 2020 206a 736f   = None,.    jso
-00002df0: 6e5f 6d61 783a 2064 6963 7420 3d20 4e6f  n_max: dict = No
-00002e00: 6e65 2c0a 2020 2020 6a73 6f6e 5f73 7065  ne,.    json_spe
-00002e10: 633a 2064 6963 7420 3d20 4e6f 6e65 2c0a  c: dict = None,.
-00002e20: 2920 2d3e 204e 6f6e 653a 0a20 2020 2022  ) -> None:.    "
-00002e30: 2222 5072 696e 7420 6f75 7470 7574 2061  ""Print output a
-00002e40: 6363 6f72 6469 6e67 2074 6f20 7768 6963  ccording to whic
-00002e50: 6820 6f70 7469 6f6e 2069 7320 7370 6563  h option is spec
-00002e60: 6966 6965 6420 7769 7468 202d 2d6f 7574  ified with --out
-00002e70: 7075 7422 2222 0a20 2020 2023 206a 736f  put""".    # jso
-00002e80: 6e5f 2068 6173 2074 6865 2075 6e64 6572  n_ has the under
-00002e90: 7363 6f72 6520 746f 2061 766f 6964 2061  score to avoid a
-00002ea0: 206e 616d 6520 636c 6173 6820 7769 7468   name clash with
-00002eb0: 2074 6865 206d 6f64 756c 6520 6a73 6f6e   the module json
-00002ec0: 0a20 2020 2072 6573 756c 7473 203d 207b  .    results = {
-00002ed0: 0a20 2020 2020 2020 204f 5554 5055 545f  .        OUTPUT_
-00002ee0: 5445 5854 3a20 7465 7874 2c0a 2020 2020  TEXT: text,.    
-00002ef0: 2020 2020 4f55 5450 5554 5f4a 534f 4e3a      OUTPUT_JSON:
-00002f00: 206a 736f 6e5f 2c0a 2020 2020 2020 2020   json_,.        
-00002f10: 4f55 5450 5554 5f4a 534f 4e5f 4d41 583a  OUTPUT_JSON_MAX:
-00002f20: 206a 736f 6e5f 6d61 782c 0a20 2020 2020   json_max,.     
-00002f30: 2020 204f 5554 5055 545f 4a53 4f4e 5f53     OUTPUT_JSON_S
-00002f40: 5045 433a 206a 736f 6e5f 7370 6563 2c0a  PEC: json_spec,.
-00002f50: 2020 2020 7d0a 2020 2020 6966 2072 6573      }.    if res
-00002f60: 756c 7473 5b6f 7074 696f 6e5d 2069 7320  ults[option] is 
-00002f70: 4e6f 6e65 3a0a 2020 2020 2020 2020 6966  None:.        if
-00002f80: 206f 7074 696f 6e20 3d3d 204f 5554 5055   option == OUTPU
-00002f90: 545f 4a53 4f4e 5f53 5045 433a 0a20 2020  T_JSON_SPEC:.   
-00002fa0: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
-00002fb0: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
-00002fc0: 2020 2020 2020 2022 4172 6520 796f 7520         "Are you 
-00002fd0: 7375 7265 2079 6f75 2077 616e 7465 6420  sure you wanted 
-00002fe0: 746f 2075 7365 202d 2d6f 7574 7075 7420  to use --output 
-00002ff0: 6a73 6f6e 2d73 7065 633f 2022 0a20 2020  json-spec? ".   
-00003000: 2020 2020 2020 2020 2020 2020 2022 4d6f               "Mo
-00003010: 7374 206f 7574 7075 7473 2077 696c 6c20  st outputs will 
-00003020: 6265 2065 6d70 7479 2e22 0a20 2020 2020  be empty.".     
-00003030: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00003040: 2072 6574 7572 6e0a 2020 2020 6966 206f   return.    if o
-00003050: 7074 696f 6e20 3d3d 204f 5554 5055 545f  ption == OUTPUT_
-00003060: 5445 5854 3a0a 2020 2020 2020 2020 7072  TEXT:.        pr
-00003070: 696e 7428 7265 7375 6c74 735b 6f70 7469  int(results[opti
-00003080: 6f6e 5d2c 2066 6c75 7368 3d54 7275 6529  on], flush=True)
-00003090: 0a20 2020 2065 6c69 6620 6f70 7469 6f6e  .    elif option
-000030a0: 203d 3d20 4f55 5450 5554 5f4a 534f 4e5f   == OUTPUT_JSON_
-000030b0: 5350 4543 3a0a 2020 2020 2020 2020 7072  SPEC:.        pr
-000030c0: 696e 7428 6a73 6f6e 2e64 756d 7073 2872  int(json.dumps(r
-000030d0: 6573 756c 7473 5b6f 7074 696f 6e5d 292c  esults[option]),
-000030e0: 2066 6c75 7368 3d54 7275 6529 0a20 2020   flush=True).   
-000030f0: 2065 6c73 653a 2020 2320 4f55 5450 5554   else:  # OUTPUT
-00003100: 5f4a 534f 4e20 6f72 204f 5554 5055 545f  _JSON or OUTPUT_
-00003110: 4a53 4f4e 5f4d 4158 0a20 2020 2020 2020  JSON_MAX.       
-00003120: 2070 7269 6e74 286a 736f 6e2e 6475 6d70   print(json.dump
-00003130: 7328 7265 7375 6c74 735b 6f70 7469 6f6e  s(results[option
-00003140: 5d2c 2064 6566 6175 6c74 3d6f 626a 5f74  ], default=obj_t
-00003150: 6f5f 6469 6374 292c 2066 6c75 7368 3d54  o_dict), flush=T
-00003160: 7275 6529 0a0a 0a64 6566 206f 626a 5f74  rue)...def obj_t
-00003170: 6f5f 6469 6374 286f 626a 293a 0a20 2020  o_dict(obj):.   
-00003180: 2022 2222 5265 7475 726e 2064 6963 7420   """Return dict 
-00003190: 6f66 206f 626a 6563 740a 0a20 2020 2055  of object..    U
-000031a0: 7365 6675 6c20 666f 7220 6a73 6f6e 2e64  seful for json.d
-000031b0: 756d 7028 2920 6469 6374 2d74 6f2d 6a73  ump() dict-to-js
-000031c0: 6f6e 2063 6f6e 7665 7273 696f 6e2e 0a20  on conversion.. 
-000031d0: 2020 2022 2222 0a20 2020 2069 6620 6773     """.    if gs
-000031e0: 2e70 612e 7665 7262 6f73 6520 3e20 313a  .pa.verbose > 1:
-000031f0: 2020 2320 322b 0a20 2020 2020 2020 2067    # 2+.        g
-00003200: 732e 6c6f 672e 6465 6275 6728 6622 6f62  s.log.debug(f"ob
-00003210: 6a5f 746f 5f64 6963 743a 207b 6f62 6a2e  j_to_dict: {obj.
-00003220: 5f5f 636c 6173 735f 5f7d 2229 0a20 2020  __class__}").   
-00003230: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-00003240: 6728 6622 6f62 6a5f 746f 5f64 6963 743a  g(f"obj_to_dict:
-00003250: 207b 6f62 6a2e 5f5f 636c 6173 735f 5f2e   {obj.__class__.
-00003260: 5f5f 6e61 6d65 5f5f 7d22 290a 2020 2020  __name__}").    
-00003270: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-00003280: 2866 226f 626a 5f74 6f5f 6469 6374 3a20  (f"obj_to_dict: 
-00003290: 7b67 6574 5f71 7561 6c69 6669 6564 636c  {get_qualifiedcl
-000032a0: 6173 736e 616d 6528 6f62 6a29 7d22 290a  assname(obj)}").
-000032b0: 2020 2020 2320 7375 6d6d 6172 793a 2073      # summary: s
-000032c0: 686f 7274 6375 743a 206a 7573 7420 7468  hortcut: just th
-000032d0: 6573 6520 323a 2052 6571 7565 7374 496e  ese 2: RequestIn
-000032e0: 666f 2061 6e64 2043 6c69 656e 7452 6573  fo and ClientRes
-000032f0: 706f 6e73 650a 2020 2020 2320 6966 2067  ponse.    # if g
-00003300: 6574 5f71 7561 6c69 6669 6564 636c 6173  et_qualifiedclas
-00003310: 736e 616d 6528 6f62 6a29 203d 3d20 2261  sname(obj) == "a
-00003320: 696f 6874 7470 2e63 6c69 656e 745f 7265  iohttp.client_re
-00003330: 7172 6570 2e52 6571 7565 7374 496e 666f  qrep.RequestInfo
-00003340: 223a 0a20 2020 2023 2020 2020 2072 6574  ":.    #     ret
-00003350: 7572 6e20 7b6f 626a 2e5f 5f63 6c61 7373  urn {obj.__class
-00003360: 5f5f 2e5f 5f6e 616d 655f 5f3a 2073 7472  __.__name__: str
-00003370: 286f 626a 297d 0a20 2020 2023 2069 6620  (obj)}.    # if 
-00003380: 6765 745f 7175 616c 6966 6965 6463 6c61  get_qualifiedcla
-00003390: 7373 6e61 6d65 286f 626a 2920 3d3d 2022  ssname(obj) == "
-000033a0: 6169 6f68 7474 702e 636c 6965 6e74 5f72  aiohttp.client_r
-000033b0: 6571 7265 702e 436c 6965 6e74 5265 7370  eqrep.ClientResp
-000033c0: 6f6e 7365 223a 0a20 2020 2023 2020 2020  onse":.    #    
-000033d0: 7265 7475 726e 207b 6f62 6a2e 5f5f 636c  return {obj.__cl
-000033e0: 6173 735f 5f2e 5f5f 6e61 6d65 5f5f 3a20  ass__.__name__: 
-000033f0: 7374 7228 6f62 6a29 7d0a 2020 2020 2320  str(obj)}.    # 
-00003400: 6465 7461 696c 732c 206f 6e65 2062 7920  details, one by 
-00003410: 6f6e 653a 0a20 2020 2023 2069 6620 6765  one:.    # if ge
-00003420: 745f 7175 616c 6966 6965 6463 6c61 7373  t_qualifiedclass
-00003430: 6e61 6d65 286f 626a 2920 3d3d 2022 636f  name(obj) == "co
-00003440: 6c6c 6563 7469 6f6e 732e 6465 7175 6522  llections.deque"
-00003450: 3a0a 2020 2020 2320 2020 2020 7265 7475  :.    #     retu
-00003460: 726e 207b 6f62 6a2e 5f5f 636c 6173 735f  rn {obj.__class_
-00003470: 5f2e 5f5f 6e61 6d65 5f5f 3a20 7374 7228  _.__name__: str(
-00003480: 6f62 6a29 7d0a 2020 2020 2320 6966 2067  obj)}.    # if g
-00003490: 6574 5f71 7561 6c69 6669 6564 636c 6173  et_qualifiedclas
-000034a0: 736e 616d 6528 6f62 6a29 203d 3d20 2261  sname(obj) == "a
-000034b0: 696f 6874 7470 2e68 656c 7065 7273 2e54  iohttp.helpers.T
-000034c0: 696d 6572 436f 6e74 6578 7422 3a0a 2020  imerContext":.  
-000034d0: 2020 2320 2020 2020 7265 7475 726e 207b    #     return {
-000034e0: 6f62 6a2e 5f5f 636c 6173 735f 5f2e 5f5f  obj.__class__.__
-000034f0: 6e61 6d65 5f5f 3a20 7374 7228 6f62 6a29  name__: str(obj)
-00003500: 7d0a 2020 2020 2320 6966 2067 6574 5f71  }.    # if get_q
-00003510: 7561 6c69 6669 6564 636c 6173 736e 616d  ualifiedclassnam
-00003520: 6528 6f62 6a29 203d 3d20 2261 7379 6e63  e(obj) == "async
-00003530: 696f 2e65 7665 6e74 732e 5469 6d65 7248  io.events.TimerH
-00003540: 616e 646c 6522 3a0a 2020 2020 2320 2020  andle":.    #   
-00003550: 2020 7265 7475 726e 207b 6f62 6a2e 5f5f    return {obj.__
-00003560: 636c 6173 735f 5f2e 5f5f 6e61 6d65 5f5f  class__.__name__
-00003570: 3a20 7374 7228 6f62 6a29 7d0a 2020 2020  : str(obj)}.    
-00003580: 2320 6966 2067 6574 5f71 7561 6c69 6669  # if get_qualifi
-00003590: 6564 636c 6173 736e 616d 6528 6f62 6a29  edclassname(obj)
-000035a0: 203d 3d22 6d75 6c74 6964 6963 742e 5f6d   =="multidict._m
-000035b0: 756c 7469 6469 6374 2e43 494d 756c 7469  ultidict.CIMulti
-000035c0: 4469 6374 5072 6f78 7922 3a0a 2020 2020  DictProxy":.    
-000035d0: 2320 2020 2020 7265 7475 726e 207b 6f62  #     return {ob
-000035e0: 6a2e 5f5f 636c 6173 735f 5f2e 5f5f 6e61  j.__class__.__na
-000035f0: 6d65 5f5f 3a20 7374 7228 6f62 6a29 7d0a  me__: str(obj)}.
-00003600: 2020 2020 2320 6966 2067 6574 5f71 7561      # if get_qua
-00003610: 6c69 6669 6564 636c 6173 736e 616d 6528  lifiedclassname(
-00003620: 6f62 6a29 203d 3d20 2261 696f 7369 676e  obj) == "aiosign
-00003630: 616c 2e53 6967 6e61 6c22 3a0a 2020 2020  al.Signal":.    
-00003640: 2320 2020 2020 7265 7475 726e 207b 6f62  #     return {ob
-00003650: 6a2e 5f5f 636c 6173 735f 5f2e 5f5f 6e61  j.__class__.__na
-00003660: 6d65 5f5f 3a20 7374 7228 6f62 6a29 7d0a  me__: str(obj)}.
-00003670: 2020 2020 2320 7468 6973 206f 6e65 2069      # this one i
-00003680: 7320 6372 7563 6961 6c2c 2069 7420 6d61  s crucial, it ma
-00003690: 6b65 2074 6865 2073 6572 6961 6c69 7a61  ke the serializa
-000036a0: 7469 6f6e 2063 6972 6375 6c61 7220 7265  tion circular re
-000036b0: 6665 7265 6e63 652e 0a20 2020 2069 6620  ference..    if 
-000036c0: 6765 745f 7175 616c 6966 6965 6463 6c61  get_qualifiedcla
-000036d0: 7373 6e61 6d65 286f 626a 2920 3d3d 2022  ssname(obj) == "
-000036e0: 6169 6f68 7474 702e 7374 7265 616d 732e  aiohttp.streams.
-000036f0: 5374 7265 616d 5265 6164 6572 223a 0a20  StreamReader":. 
-00003700: 2020 2020 2020 2072 6574 7572 6e20 7b6f         return {o
-00003710: 626a 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e  bj.__class__.__n
-00003720: 616d 655f 5f3a 2073 7472 286f 626a 297d  ame__: str(obj)}
-00003730: 0a20 2020 2023 2074 6865 7365 2066 6f75  .    # these fou
-00003740: 7220 6172 6520 6372 7563 6961 6c2c 2074  r are crucial, t
-00003750: 6865 7920 6d61 6b65 2074 6865 2073 6572  hey make the ser
-00003760: 6961 6c69 7a61 7469 6f6e 2063 6972 6375  ialization circu
-00003770: 6c61 7220 7265 6665 7265 6e63 652e 0a20  lar reference.. 
-00003780: 2020 2069 6620 280a 2020 2020 2020 2020     if (.        
-00003790: 6765 745f 7175 616c 6966 6965 6463 6c61  get_qualifiedcla
-000037a0: 7373 6e61 6d65 286f 626a 290a 2020 2020  ssname(obj).    
-000037b0: 2020 2020 3d3d 2022 6173 796e 6369 6f2e      == "asyncio.
-000037c0: 756e 6978 5f65 7665 6e74 732e 5f55 6e69  unix_events._Uni
-000037d0: 7853 656c 6563 746f 7245 7665 6e74 4c6f  xSelectorEventLo
-000037e0: 6f70 220a 2020 2020 293a 0a20 2020 2020  op".    ):.     
-000037f0: 2020 2072 6574 7572 6e20 7b6f 626a 2e5f     return {obj._
-00003800: 5f63 6c61 7373 5f5f 2e5f 5f6e 616d 655f  _class__.__name_
-00003810: 5f3a 2073 7472 286f 626a 297d 0a20 2020  _: str(obj)}.   
-00003820: 2069 6620 6765 745f 7175 616c 6966 6965   if get_qualifie
-00003830: 6463 6c61 7373 6e61 6d65 286f 626a 2920  dclassname(obj) 
-00003840: 3d3d 2022 6169 6f68 7474 702e 7472 6163  == "aiohttp.trac
-00003850: 696e 672e 5472 6163 6522 3a0a 2020 2020  ing.Trace":.    
-00003860: 2020 2020 7265 7475 726e 207b 6f62 6a2e      return {obj.
-00003870: 5f5f 636c 6173 735f 5f2e 5f5f 6e61 6d65  __class__.__name
-00003880: 5f5f 3a20 7374 7228 6f62 6a29 7d0a 2020  __: str(obj)}.  
-00003890: 2020 6966 2067 6574 5f71 7561 6c69 6669    if get_qualifi
-000038a0: 6564 636c 6173 736e 616d 6528 6f62 6a29  edclassname(obj)
-000038b0: 203d 3d20 2261 696f 6874 7470 2e74 7261   == "aiohttp.tra
-000038c0: 6369 6e67 2e54 7261 6365 436f 6e66 6967  cing.TraceConfig
-000038d0: 223a 0a20 2020 2020 2020 2072 6574 7572  ":.        retur
-000038e0: 6e20 7b6f 626a 2e5f 5f63 6c61 7373 5f5f  n {obj.__class__
-000038f0: 2e5f 5f6e 616d 655f 5f3a 2073 7472 286f  .__name__: str(o
-00003900: 626a 297d 0a20 2020 2023 2061 766f 6964  bj)}.    # avoid
-00003910: 2022 6b65 7973 206d 7573 7420 6265 2073   "keys must be s
-00003920: 7472 2c20 696e 742c 2066 6c6f 6174 2c20  tr, int, float, 
-00003930: 626f 6f6c 206f 7220 4e6f 6e65 2220 6572  bool or None" er
-00003940: 726f 7273 0a20 2020 2069 6620 6765 745f  rors.    if get_
-00003950: 7175 616c 6966 6965 6463 6c61 7373 6e61  qualifiedclassna
-00003960: 6d65 286f 626a 2920 3d3d 2022 6169 6f68  me(obj) == "aioh
-00003970: 7474 702e 636f 6e6e 6563 746f 722e 5443  ttp.connector.TC
-00003980: 5043 6f6e 6e65 6374 6f72 223a 0a20 2020  PConnector":.   
-00003990: 2020 2020 2072 6574 7572 6e20 7b6f 626a       return {obj
-000039a0: 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e 616d  .__class__.__nam
-000039b0: 655f 5f3a 2073 7472 286f 626a 297d 0a0a  e__: str(obj)}..
-000039c0: 2020 2020 6966 2068 6173 6174 7472 286f      if hasattr(o
-000039d0: 626a 2c20 225f 5f64 6963 745f 5f22 293a  bj, "__dict__"):
-000039e0: 0a20 2020 2020 2020 2069 6620 280a 2020  .        if (.  
-000039f0: 2020 2020 2020 2020 2020 2269 6e62 6f75            "inbou
-00003a00: 6e64 5f67 726f 7570 5f73 746f 7265 2220  nd_group_store" 
-00003a10: 696e 206f 626a 2e5f 5f64 6963 745f 5f0a  in obj.__dict__.
-00003a20: 2020 2020 2020 2020 2020 2020 616e 6420              and 
-00003a30: 2273 6573 7369 6f6e 5f73 746f 7265 2220  "session_store" 
-00003a40: 696e 206f 626a 2e5f 5f64 6963 745f 5f0a  in obj.__dict__.
-00003a50: 2020 2020 2020 2020 2020 2020 616e 6420              and 
-00003a60: 226f 7574 626f 756e 645f 6772 6f75 705f  "outbound_group_
-00003a70: 7365 7373 696f 6e73 2220 696e 206f 626a  sessions" in obj
-00003a80: 2e5f 5f64 6963 745f 5f0a 2020 2020 2020  .__dict__.      
-00003a90: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-00003aa0: 2023 2022 6f6c 6d22 2069 7320 6869 6765   # "olm" is hige
-00003ab0: 2c20 314d 422b 2c20 3230 4b20 6c69 6e65  , 1MB+, 20K line
-00003ac0: 7320 6f66 204a 534f 4e0a 2020 2020 2020  s of JSON.      
-00003ad0: 2020 2020 2020 2320 6772 6162 206f 6e6c        # grab onl
-00003ae0: 7920 736f 6d65 2069 7465 6d73 0a20 2020  y some items.   
-00003af0: 2020 2020 2020 2020 2023 2022 6f6c 6d22           # "olm"
-00003b00: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-00003b10: 2320 2020 2275 7365 725f 6964 223a 2022  #   "user_id": "
-00003b20: 4078 7878 3a78 7878 2e78 7878 2e78 7878  @xxx:xxx.xxx.xxx
-00003b30: 222c 0a20 2020 2020 2020 2020 2020 2023  ",.            #
-00003b40: 2020 2022 6465 7669 6365 5f69 6422 3a20     "device_id": 
-00003b50: 2278 7878 222c 0a20 2020 2020 2020 2020  "xxx",.         
-00003b60: 2020 2023 2020 2022 7570 6c6f 6164 6564     #   "uploaded
-00003b70: 5f6b 6579 5f63 6f75 6e74 223a 2035 302c  _key_count": 50,
-00003b80: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-00003b90: 2022 7573 6572 735f 666f 725f 6b65 795f   "users_for_key_
-00003ba0: 7175 6572 7922 3a20 7b0a 2020 2020 2020  query": {.      
-00003bb0: 2020 2020 2020 2320 2020 2020 2273 6574        #     "set
-00003bc0: 223a 2022 2e2e 2e22 0a20 2020 2020 2020  ": "...".       
-00003bd0: 2020 2020 2023 2020 207d 2c0a 2020 2020       #   },.    
-00003be0: 2020 2020 2020 2020 2320 2020 2264 6576          #   "dev
-00003bf0: 6963 655f 7374 6f72 6522 3a20 7b0a 2020  ice_store": {.  
-00003c00: 2020 2020 2020 2020 2020 2320 2020 2020            #     
-00003c10: 2020 2e2e 2e20 7761 6e74 0a20 2020 2020    ... want.     
-00003c20: 2020 2020 2020 2023 2020 207d 2c0a 2020         #   },.  
-00003c30: 2020 2020 2020 2020 2020 2320 2020 2273            #   "s
-00003c40: 6573 7369 6f6e 5f73 746f 7265 223a 207b  ession_store": {
-00003c50: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-00003c60: 2020 2020 202e 2e2e 2064 6f6e 7420 7761       ... dont wa
-00003c70: 6e74 2c20 746f 6f20 6c6f 6e67 0a20 2020  nt, too long.   
-00003c80: 2020 2020 2020 2020 2023 2020 207d 2c0a           #   },.
-00003c90: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-00003ca0: 2269 6e62 6f75 6e64 5f67 726f 7570 5f73  "inbound_group_s
-00003cb0: 746f 7265 223a 207b 0a20 2020 2020 2020  tore": {.       
-00003cc0: 2020 2020 2023 2020 2020 2020 202e 2e2e       #       ...
-00003cd0: 2064 6f6e 7420 7761 6e74 2c20 3230 4b20   dont want, 20K 
-00003ce0: 6c69 6e65 732c 2074 6f6f 206c 6f6e 670a  lines, too long.
-00003cf0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-00003d00: 7d2c 0a20 2020 2020 2020 2020 2020 2023  },.            #
-00003d10: 2020 2022 6f75 7462 6f75 6e64 5f67 726f     "outbound_gro
-00003d20: 7570 5f73 6573 7369 6f6e 7322 3a20 7b7d  up_sessions": {}
-00003d30: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00003d40: 2020 2274 7261 636b 6564 5f75 7365 7273    "tracked_users
-00003d50: 223a 207b 0a20 2020 2020 2020 2020 2020  ": {.           
-00003d60: 2023 2020 2020 2022 7365 7422 3a20 2273   #     "set": "s
-00003d70: 6574 2829 220a 2020 2020 2020 2020 2020  et()".          
-00003d80: 2020 2320 2020 7d2c 0a20 2020 2020 2020    #   },.       
-00003d90: 2020 2020 2064 6963 7463 6f70 7920 3d20       dictcopy = 
-00003da0: 7b7d 0a20 2020 2020 2020 2020 2020 2066  {}.            f
-00003db0: 6f72 206b 6579 2069 6e20 5b0a 2020 2020  or key in [.    
-00003dc0: 2020 2020 2020 2020 2020 2020 2275 7365              "use
-00003dd0: 725f 6964 222c 0a20 2020 2020 2020 2020  r_id",.         
-00003de0: 2020 2020 2020 2022 6465 7669 6365 5f69         "device_i
-00003df0: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
-00003e00: 2020 2020 2275 706c 6f61 6465 645f 6b65      "uploaded_ke
-00003e10: 795f 636f 756e 7422 2c0a 2020 2020 2020  y_count",.      
-00003e20: 2020 2020 2020 2020 2020 2275 7365 7273            "users
-00003e30: 5f66 6f72 5f6b 6579 5f71 7565 7279 222c  _for_key_query",
-00003e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003e50: 2022 6465 7669 6365 5f73 746f 7265 222c   "device_store",
-00003e60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003e70: 2022 6f75 7462 6f75 6e64 5f67 726f 7570   "outbound_group
-00003e80: 5f73 6573 7369 6f6e 7322 2c0a 2020 2020  _sessions",.    
-00003e90: 2020 2020 2020 2020 2020 2020 2274 7261              "tra
-00003ea0: 636b 6564 5f75 7365 7273 222c 0a20 2020  cked_users",.   
-00003eb0: 2020 2020 2020 2020 2020 2020 2022 6f75               "ou
-00003ec0: 7467 6f69 6e67 5f6b 6579 5f72 6571 7565  tgoing_key_reque
-00003ed0: 7374 7322 2c0a 2020 2020 2020 2020 2020  sts",.          
-00003ee0: 2020 2020 2020 2272 6563 6569 7665 645f        "received_
-00003ef0: 6b65 795f 7265 7175 6573 7473 222c 0a20  key_requests",. 
-00003f00: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00003f10: 6b65 795f 7265 7175 6573 7473 5f77 6169  key_requests_wai
-00003f20: 7469 6e67 5f66 6f72 5f73 6573 7369 6f6e  ting_for_session
-00003f30: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00003f40: 2020 2022 6b65 795f 7265 7175 6573 745f     "key_request_
-00003f50: 6465 7669 6365 735f 6e6f 5f73 6573 7369  devices_no_sessi
-00003f60: 6f6e 222c 0a20 2020 2020 2020 2020 2020  on",.           
-00003f70: 2020 2020 2022 6b65 795f 7265 7175 6573       "key_reques
-00003f80: 745f 6672 6f6d 5f75 6e74 7275 7374 6564  t_from_untrusted
-00003f90: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00003fa0: 2020 2022 7765 6467 6564 5f64 6576 6963     "wedged_devic
-00003fb0: 6573 222c 0a20 2020 2020 2020 2020 2020  es",.           
-00003fc0: 2020 2020 2022 6b65 795f 7265 5f72 6571       "key_re_req
-00003fd0: 7565 7374 735f 6576 656e 7473 222c 0a20  uests_events",. 
-00003fe0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00003ff0: 6b65 795f 7665 7269 6669 6361 7469 6f6e  key_verification
-00004000: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-00004010: 2020 2020 226f 7574 676f 696e 675f 746f      "outgoing_to
-00004020: 5f64 6576 6963 655f 6d65 7373 6167 6573  _device_messages
-00004030: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00004040: 2020 2022 6d65 7373 6167 655f 696e 6465     "message_inde
-00004050: 785f 7374 6f72 6522 2c0a 2020 2020 2020  x_store",.      
-00004060: 2020 2020 2020 2020 2020 2273 746f 7265            "store
-00004070: 222c 0a20 2020 2020 2020 2020 2020 205d  ",.            ]
-00004080: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00004090: 2020 6469 6374 636f 7079 2e75 7064 6174    dictcopy.updat
-000040a0: 6528 7b6b 6579 3a20 6f62 6a2e 5f5f 6469  e({key: obj.__di
-000040b0: 6374 5f5f 5b6b 6579 5d7d 290a 2020 2020  ct__[key]}).    
-000040c0: 2020 2020 2020 2020 6966 2067 732e 7061          if gs.pa
-000040d0: 2e76 6572 626f 7365 203e 2031 3a20 2023  .verbose > 1:  #
-000040e0: 2032 2b0a 2020 2020 2020 2020 2020 2020   2+.            
-000040f0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-00004100: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00004110: 2020 2020 2020 6622 7b6f 626a 7d20 6973        f"{obj} is
-00004120: 206e 6f74 2073 6572 6961 6c69 7a61 626c   not serializabl
-00004130: 652c 2073 696d 706c 6966 7969 6e67 2074  e, simplifying t
-00004140: 6f20 7b64 6963 7463 6f70 797d 2e22 0a20  o {dictcopy}.". 
-00004150: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00004160: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00004170: 7572 6e20 6469 6374 636f 7079 0a20 2020  urn dictcopy.   
-00004180: 2020 2020 2069 6620 6773 2e70 612e 7665       if gs.pa.ve
-00004190: 7262 6f73 6520 3e20 313a 2020 2320 322b  rbose > 1:  # 2+
-000041a0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
-000041b0: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
-000041c0: 2020 2020 2020 2020 2020 2066 227b 6f62             f"{ob
-000041d0: 6a7d 2069 7320 6e6f 7420 7365 7269 616c  j} is not serial
-000041e0: 697a 6162 6c65 2c20 7573 696e 6720 6974  izable, using it
-000041f0: 7320 6176 6169 6c61 626c 6520 6469 6374  s available dict
-00004200: 696f 6e61 7279 2022 0a20 2020 2020 2020  ionary ".       
-00004210: 2020 2020 2020 2020 2066 227b 6f62 6a2e           f"{obj.
-00004220: 5f5f 6469 6374 5f5f 7d2e 220a 2020 2020  __dict__}.".    
-00004230: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00004240: 2020 7265 7475 726e 206f 626a 2e5f 5f64    return obj.__d
-00004250: 6963 745f 5f0a 2020 2020 656c 7365 3a0a  ict__.    else:.
-00004260: 2020 2020 2020 2020 2320 6773 2e6c 6f67          # gs.log
-00004270: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-00004280: 2320 2020 2020 6622 4f62 6a65 6374 207b  #     f"Object {
-00004290: 6f62 6a7d 2028 7b74 7970 6528 6f62 6a29  obj} ({type(obj)
-000042a0: 7d29 2068 6173 206e 6f20 636c 6173 7320  }) has no class 
-000042b0: 6469 6374 696f 6e61 7279 2e20 220a 2020  dictionary. ".  
-000042c0: 2020 2020 2020 2320 2020 2020 2243 616e        #     "Can
-000042d0: 6e6f 7420 6265 2063 6f6e 7665 7274 6564  not be converted
-000042e0: 2074 6f20 4a53 4f4e 206f 626a 6563 742e   to JSON object.
-000042f0: 2022 0a20 2020 2020 2020 2023 2020 2020   ".        #    
-00004300: 2022 5769 6c6c 2062 6520 636f 6e76 6572   "Will be conver
-00004310: 7465 6420 746f 204a 534f 4e20 7374 7269  ted to JSON stri
-00004320: 6e67 2e22 0a20 2020 2020 2020 2023 2029  ng.".        # )
-00004330: 0a20 2020 2020 2020 2023 2073 696d 706c  .        # simpl
-00004340: 6520 7479 7065 7320 6c69 6b65 2079 6172  e types like yar
-00004350: 6c2e 5552 4c20 646f 206e 6f74 2068 6176  l.URL do not hav
-00004360: 6520 6120 5f5f 6469 6374 5f5f 0a20 2020  e a __dict__.   
-00004370: 2020 2020 2023 2067 6574 2074 6865 2063       # get the c
-00004380: 6c61 7373 206e 616d 6520 6173 2073 7472  lass name as str
-00004390: 696e 672c 2063 7265 6174 6520 6120 6469  ing, create a di
-000043a0: 6374 2077 6974 6820 636c 6173 736e 616d  ct with classnam
-000043b0: 6520 616e 6420 7661 6c75 650a 2020 2020  e and value.    
-000043c0: 2020 2020 6966 2067 732e 7061 2e76 6572      if gs.pa.ver
-000043d0: 626f 7365 203e 2031 3a20 2023 2032 2b0a  bose > 1:  # 2+.
-000043e0: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
-000043f0: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
-00004400: 2020 2020 2020 2020 2020 6622 7b6f 626a            f"{obj
-00004410: 7d20 6973 206e 6f74 2073 6572 6961 6c69  } is not seriali
-00004420: 7a61 626c 652c 2073 696d 706c 6966 7969  zable, simplifyi
-00004430: 6e67 2074 6f20 6b65 7920 7661 6c75 6520  ng to key value 
-00004440: 7061 6972 2022 0a20 2020 2020 2020 2020  pair ".         
-00004450: 2020 2020 2020 2066 226b 6579 2027 7b6f         f"key '{o
-00004460: 626a 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e  bj.__class__.__n
-00004470: 616d 655f 5f7d 2720 616e 6420 7661 6c75  ame__}' and valu
-00004480: 6520 277b 7374 7228 6f62 6a29 7d27 2e22  e '{str(obj)}'."
-00004490: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-000044a0: 2020 2020 2020 2072 6574 7572 6e20 7b6f         return {o
-000044b0: 626a 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e  bj.__class__.__n
-000044c0: 616d 655f 5f3a 2073 7472 286f 626a 297d  ame__: str(obj)}
-000044d0: 0a0a 0a64 6566 2063 686f 6f73 655f 6176  ...def choose_av
-000044e0: 6169 6c61 626c 655f 6669 6c65 6e61 6d65  ailable_filename
-000044f0: 2866 696c 656e 616d 6529 3a0a 2020 2020  (filename):.    
-00004500: 2222 2252 6574 7572 6e20 6e65 7874 2061  """Return next a
-00004510: 7661 696c 6162 6c65 2066 696c 656e 616d  vailable filenam
-00004520: 652e 0a0a 2020 2020 4966 2066 696c 656e  e...    If filen
-00004530: 616d 6520 2869 6e63 6c75 6465 7320 7061  ame (includes pa
-00004540: 7468 2920 646f 6573 206e 6f74 2065 7869  th) does not exi
-00004550: 7374 2c0a 2020 2020 7468 656e 2069 7420  st,.    then it 
-00004560: 7265 7475 726e 7320 6669 6c65 6e61 6d65  returns filename
-00004570: 2e20 4966 2066 696c 6520 616c 7265 6164  . If file alread
-00004580: 790a 2020 2020 6578 6973 7473 2069 7420  y.    exists it 
-00004590: 6164 6473 2061 2063 6f75 6e74 6572 2061  adds a counter a
-000045a0: 7420 656e 642c 2062 6566 6f72 650a 2020  t end, before.  
-000045b0: 2020 6578 7465 6e73 696f 6e2c 2061 6e64    extension, and
-000045c0: 2069 6e63 7265 6173 6573 2063 6f75 6e74   increases count
-000045d0: 6572 2075 6e74 696c 2069 740a 2020 2020  er until it.    
-000045e0: 6669 6e64 7320 6120 6669 6c65 6e61 6d65  finds a filename
-000045f0: 2074 6861 7420 646f 6573 206e 6f74 2079   that does not y
-00004600: 6574 2065 7869 7374 2e0a 2020 2020 5468  et exist..    Th
-00004610: 6973 2061 766f 6964 7320 6f76 6572 7772  is avoids overwr
-00004620: 6974 7469 6e67 2066 696c 6573 2077 6865  itting files whe
-00004630: 6e20 736f 7572 6365 730a 2020 2020 6861  n sources.    ha
-00004640: 7665 2073 616d 6520 6e61 6d65 2e0a 2020  ve same name..  
-00004650: 2020 2222 220a 2020 2020 6966 206f 732e    """.    if os.
-00004660: 7061 7468 2e65 7869 7374 7328 6669 6c65  path.exists(file
-00004670: 6e61 6d65 293a 0a20 2020 2020 2020 2074  name):.        t
-00004680: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00004690: 7374 6172 742c 2065 7874 203d 2066 696c  start, ext = fil
-000046a0: 656e 616d 652e 7273 706c 6974 2822 2e22  ename.rsplit("."
-000046b0: 2c20 3129 0a20 2020 2020 2020 2065 7863  , 1).        exc
-000046c0: 6570 7420 5661 6c75 6545 7272 6f72 3a0a  ept ValueError:.
-000046d0: 2020 2020 2020 2020 2020 2020 7374 6172              star
-000046e0: 742c 2065 7874 203d 2028 6669 6c65 6e61  t, ext = (filena
-000046f0: 6d65 2c20 2222 290a 2020 2020 2020 2020  me, "").        
-00004700: 6920 3d20 300a 2020 2020 2020 2020 7768  i = 0.        wh
-00004710: 696c 6520 6f73 2e70 6174 682e 6578 6973  ile os.path.exis
-00004720: 7473 2866 227b 7374 6172 747d 5f7b 697d  ts(f"{start}_{i}
-00004730: 2e7b 6578 747d 2229 3a0a 2020 2020 2020  .{ext}"):.      
-00004740: 2020 2020 2020 6920 2b3d 2031 0a20 2020        i += 1.   
-00004750: 2020 2020 2072 6574 7572 6e20 6622 7b73       return f"{s
-00004760: 7461 7274 7d5f 7b69 7d2e 7b65 7874 7d22  tart}_{i}.{ext}"
-00004770: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00004780: 2020 2072 6574 7572 6e20 6669 6c65 6e61     return filena
-00004790: 6d65 0a0a 0a61 7379 6e63 2064 6566 2073  me...async def s
-000047a0: 796e 6368 726f 6e69 7a65 2863 6c69 656e  ynchronize(clien
-000047b0: 743a 2041 7379 6e63 436c 6965 6e74 2920  t: AsyncClient) 
-000047c0: 2d3e 2053 796e 6352 6573 706f 6e73 653a  -> SyncResponse:
-000047d0: 0a20 2020 2022 2222 5379 6e63 6872 6f6e  .    """Synchron
-000047e0: 697a 6520 7769 7468 2073 6572 7665 722c  ize with server,
-000047f0: 2065 2e67 2e20 696e 206f 7264 6572 2074   e.g. in order t
-00004800: 6f20 6765 7420 726f 6f6d 732e 0a0a 2020  o get rooms...  
-00004810: 2020 4172 6775 6d65 6e74 733a 0a20 2020    Arguments:.   
-00004820: 202d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063   ---------.    c
-00004830: 6c69 656e 7420 3a20 436c 6965 6e74 0a0a  lient : Client..
-00004840: 2020 2020 5265 7475 726e 733a 204e 6f6e      Returns: Non
-00004850: 650a 0a20 2020 2052 6169 7365 7320 6578  e..    Raises ex
-00004860: 6365 7074 696f 6e20 6f6e 2065 7272 6f72  ception on error
-00004870: 2e0a 2020 2020 2222 220a 2020 2020 7472  ..    """.    tr
-00004880: 793a 0a20 2020 2020 2020 2072 6573 7020  y:.        resp 
-00004890: 3d20 6177 6169 7420 636c 6965 6e74 2e73  = await client.s
-000048a0: 796e 6328 7469 6d65 6f75 743d 3130 3030  ync(timeout=1000
-000048b0: 302c 2066 756c 6c5f 7374 6174 653d 5472  0, full_state=Tr
-000048c0: 7565 290a 2020 2020 6578 6365 7074 2043  ue).    except C
-000048d0: 6c69 656e 7443 6f6e 6e65 6374 6f72 4572  lientConnectorEr
-000048e0: 726f 7220 6173 2065 3a0a 2020 2020 2020  ror as e:.      
-000048f0: 2020 6572 7220 3d20 280a 2020 2020 2020    err = (.      
-00004900: 2020 2020 2020 2245 3130 303a 2022 0a20        "E100: ". 
-00004910: 2020 2020 2020 2020 2020 2022 7379 6e63             "sync
-00004920: 2829 2066 6169 6c65 642e 2044 6f20 796f  () failed. Do yo
-00004930: 7520 6861 7665 2063 6f6e 6e65 6374 6976  u have connectiv
-00004940: 6974 7920 746f 2069 6e74 6572 6e65 743f  ity to internet?
-00004950: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
-00004960: 2243 6c69 656e 7443 6f6e 6e65 6374 6f72  "ClientConnector
-00004970: 4572 726f 7220 7b65 7d22 0a20 2020 2020  Error {e}".     
-00004980: 2020 2029 0a20 2020 2020 2020 2072 6169     ).        rai
-00004990: 7365 204d 6174 7269 7843 6f6d 6d61 6e64  se MatrixCommand
-000049a0: 6572 4572 726f 7228 6572 7229 2066 726f  erError(err) fro
-000049b0: 6d20 650a 2020 2020 6578 6365 7074 2045  m e.    except E
-000049c0: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
-000049d0: 2020 2020 2020 2065 7272 203d 2022 4531         err = "E1
-000049e0: 3031 3a20 2220 6622 7379 6e63 2829 2066  01: " f"sync() f
-000049f0: 6169 6c65 642e 2045 7863 6570 7469 6f6e  ailed. Exception
-00004a00: 207b 657d 220a 2020 2020 2020 2020 7261   {e}".        ra
-00004a10: 6973 6520 4d61 7472 6978 436f 6d6d 616e  ise MatrixComman
-00004a20: 6465 7245 7272 6f72 2865 7272 2920 6672  derError(err) fr
-00004a30: 6f6d 2065 0a20 2020 2069 6620 6973 696e  om e.    if isin
-00004a40: 7374 616e 6365 2872 6573 702c 2053 796e  stance(resp, Syn
-00004a50: 6345 7272 6f72 293a 0a20 2020 2020 2020  cError):.       
-00004a60: 2065 7272 203d 2022 4531 3032 3a20 2220   err = "E102: " 
-00004a70: 6622 7379 6e63 2066 6169 6c65 6420 7769  f"sync failed wi
-00004a80: 7468 2072 6573 7020 3d20 7b70 7269 7661  th resp = {priva
-00004a90: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
-00004aa0: 7370 2929 7d22 0a20 2020 2020 2020 2072  sp))}".        r
-00004ab0: 6169 7365 204d 6174 7269 7843 6f6d 6d61  aise MatrixComma
-00004ac0: 6e64 6572 4572 726f 7228 6572 7229 2066  nderError(err) f
-00004ad0: 726f 6d20 4e6f 6e65 0a20 2020 2072 6574  rom None.    ret
-00004ae0: 7572 6e20 7265 7370 0a0a 0a61 7379 6e63  urn resp...async
-00004af0: 2064 6566 2064 6f77 6e6c 6f61 645f 6d78   def download_mx
-00004b00: 6328 0a20 2020 2063 6c69 656e 743a 2041  c(.    client: A
-00004b10: 7379 6e63 436c 6965 6e74 2c20 6d78 633a  syncClient, mxc:
-00004b20: 2073 7472 2c20 6669 6c65 6e61 6d65 3a20   str, filename: 
-00004b30: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
-00004b40: 4e6f 6e65 0a29 3a0a 2020 2020 2222 2244  None.):.    """D
-00004b50: 6f77 6e6c 6f61 6420 4d58 4320 7265 736f  ownload MXC reso
-00004b60: 7572 6365 2e0a 0a20 2020 2041 7267 756d  urce...    Argum
-00004b70: 656e 7473 3a0a 2020 2020 2d2d 2d2d 2d2d  ents:.    ------
-00004b80: 2d2d 2d0a 2020 2020 636c 6965 6e74 203a  ---.    client :
-00004b90: 2043 6c69 656e 740a 2020 2020 6d78 6320   Client.    mxc 
-00004ba0: 3a20 7374 720a 2020 2020 2020 2020 7374  : str.        st
-00004bb0: 7269 6e67 2072 6570 7265 7365 6e74 696e  ring representin
-00004bc0: 6720 5552 4c20 6c69 6b65 206d 7863 3a2f  g URL like mxc:/
-00004bd0: 2f6d 6174 7269 782e 6f72 672f 736f 6d65  /matrix.org/some
-00004be0: 5261 6e64 6f6d 4b65 790a 2020 2020 6669  RandomKey.    fi
-00004bf0: 6c65 6e61 6d65 203a 2073 7472 0a20 2020  lename : str.   
-00004c00: 2020 2020 206f 7074 696f 6e61 6c20 6e61       optional na
-00004c10: 6d65 206f 6620 6669 6c65 2066 6f72 2073  me of file for s
-00004c20: 746f 7269 6e67 2064 6f77 6e6c 6f61 640a  toring download.
-00004c30: 2020 2020 2222 220a 2020 2020 6e69 6f5f      """.    nio_
-00004c40: 7665 7273 696f 6e20 3d20 706b 675f 7265  version = pkg_re
-00004c50: 736f 7572 6365 732e 6765 745f 6469 7374  sources.get_dist
-00004c60: 7269 6275 7469 6f6e 2822 6d61 7472 6978  ribution("matrix
-00004c70: 2d6e 696f 2229 2e76 6572 7369 6f6e 0a20  -nio").version. 
-00004c80: 2020 2023 2076 6572 7369 6f6e 2069 6e63     # version inc
-00004c90: 6f6d 7061 7469 6269 6c69 7479 2062 6574  ompatibility bet
-00004ca0: 7765 656e 206d 6174 7269 782d 6e69 6f20  ween matrix-nio 
-00004cb0: 302e 3139 2e30 2061 6e64 2030 2e32 302b  0.19.0 and 0.20+
-00004cc0: 0a20 2020 2023 2068 7474 7073 3a2f 2f6d  .    # https://m
-00004cd0: 7472 782e 7379 7465 732e 6e65 742f 4f49  trx.sytes.net/OI
-00004ce0: 756b 4b42 5555 7050 7341 6242 4742 7875  ukKBUUpPsAbBGBxu
-00004cf0: 4b56 4945 6f0a 2020 2020 2320 7365 7276  KVIEo.    # serv
-00004d00: 6572 5f6e 616d 6520 3d20 226d 7472 782e  er_name = "mtrx.
-00004d10: 7379 7465 732e 6e65 7422 0a20 2020 2023  sytes.net".    #
-00004d20: 206d 6564 6961 5f69 6420 3d20 224f 4975   media_id = "OIu
-00004d30: 6b4b 4255 5570 5073 4162 4245 4742 7875  kKBUUpPsAbBEGBxu
-00004d40: 4b56 4945 6f22 0a20 2020 2023 206d 6174  KVIEo".    # mat
-00004d50: 7269 782d 6e69 6f20 7630 2e31 392e 3020  rix-nio v0.19.0 
-00004d60: 6861 733a 2064 6f77 6e6c 6f61 6428 7365  has: download(se
-00004d70: 7276 6572 5f6e 616d 653a 2073 7472 2c20  rver_name: str, 
-00004d80: 6d65 6469 615f 6964 3a20 7374 722c 202e  media_id: str, .
-00004d90: 2e29 0a20 2020 2023 2063 6f6e 7665 7274  .).    # convert
-00004da0: 206d 7863 2074 6f20 7365 7276 6572 5f6e   mxc to server_n
-00004db0: 616d 6520 616e 6420 6d65 6469 615f 6964  ame and media_id
-00004dc0: 0a20 2020 2023 2076 302e 3230 2b20 3a20  .    # v0.20+ : 
-00004dd0: 7265 7370 203d 2061 7761 6974 2063 6c69  resp = await cli
-00004de0: 656e 742e 646f 776e 6c6f 6164 286d 7863  ent.download(mxc
-00004df0: 3d6d 7863 2c20 6669 6c65 6e61 6d65 3d66  =mxc, filename=f
-00004e00: 696c 656e 616d 6529 0a20 2020 2023 2076  ilename).    # v
-00004e10: 302e 3139 2d20 3a20 7265 7370 203d 2061  0.19- : resp = a
-00004e20: 7761 6974 2063 6c69 656e 742e 646f 776e  wait client.down
-00004e30: 6c6f 6164 280a 2020 2020 2320 2020 2020  load(.    #     
-00004e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004e50: 7365 7276 6572 5f6e 616d 653d 7365 7276  server_name=serv
-00004e60: 6572 5f6e 616d 652c 206d 6564 6961 5f69  er_name, media_i
-00004e70: 643d 6d65 6469 615f 6964 2c0a 2020 2020  d=media_id,.    
-00004e80: 2320 2020 2020 2020 2020 2020 2020 2020  #               
-00004e90: 2020 2020 2020 6669 6c65 6e61 6d65 3d66        filename=f
-00004ea0: 696c 656e 616d 6529 0a20 2020 2067 732e  ilename).    gs.
-00004eb0: 6c6f 672e 6465 6275 6728 6622 646f 776e  log.debug(f"down
-00004ec0: 6c6f 6164 5f6d 7863 2069 6e70 7574 206d  load_mxc input m
-00004ed0: 7863 2069 7320 7b6d 7863 7d2e 2229 0a20  xc is {mxc}."). 
-00004ee0: 2020 2069 6620 6e69 6f5f 7665 7273 696f     if nio_versio
-00004ef0: 6e2e 7374 6172 7473 7769 7468 2822 302e  n.startswith("0.
-00004f00: 3122 293a 2020 2320 6c69 6b65 2030 2e31  1"):  # like 0.1
-00004f10: 390a 2020 2020 2020 2020 6773 2e6c 6f67  9.        gs.log
-00004f20: 2e69 6e66 6f28 0a20 2020 2020 2020 2020  .info(.         
-00004f30: 2020 2066 2259 6f75 2061 7265 2072 756e     f"You are run
-00004f40: 6e69 6e67 206d 6174 7269 782d 6e69 6f20  ning matrix-nio 
-00004f50: 7665 7273 696f 6e20 7b6e 696f 5f76 6572  version {nio_ver
-00004f60: 7369 6f6e 7d2e 2022 0a20 2020 2020 2020  sion}. ".       
-00004f70: 2020 2020 2022 596f 7520 7368 6f75 6c64       "You should
-00004f80: 2062 6520 7275 6e6e 696e 6720 7665 7273   be running vers
-00004f90: 696f 6e20 302e 3230 2b2e 2055 7064 6174  ion 0.20+. Updat
-00004fa0: 6520 6966 206e 6563 6573 7361 7279 2e20  e if necessary. 
-00004fb0: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
-00004fc0: 2020 2020 7572 6c20 3d20 7572 6c70 6172      url = urlpar
-00004fd0: 7365 286d 7863 290a 2020 2020 2020 2020  se(mxc).        
-00004fe0: 6773 2e6c 6f67 2e64 6562 7567 2866 2264  gs.log.debug(f"d
-00004ff0: 6f77 6e6c 6f61 645f 6d78 6320 696e 7075  ownload_mxc inpu
-00005000: 7420 7572 6c20 6973 207b 7572 6c7d 2e22  t url is {url}."
-00005010: 290a 2020 2020 2020 2020 7265 7370 6f6e  ).        respon
-00005020: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
-00005030: 742e 646f 776e 6c6f 6164 280a 2020 2020  t.download(.    
-00005040: 2020 2020 2020 2020 7365 7276 6572 5f6e          server_n
-00005050: 616d 653d 7572 6c2e 6e65 746c 6f63 2c0a  ame=url.netloc,.
-00005060: 2020 2020 2020 2020 2020 2020 6d65 6469              medi
-00005070: 615f 6964 3d75 726c 2e70 6174 682e 7374  a_id=url.path.st
-00005080: 7269 7028 222f 2229 2c0a 2020 2020 2020  rip("/"),.      
-00005090: 2020 2020 2020 6669 6c65 6e61 6d65 3d66        filename=f
-000050a0: 696c 656e 616d 652c 0a20 2020 2020 2020  ilename,.       
-000050b0: 2029 0a20 2020 2065 6c73 653a 0a20 2020   ).    else:.   
-000050c0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-000050d0: 6728 0a20 2020 2020 2020 2020 2020 2066  g(.            f
-000050e0: 2259 6f75 2061 7265 2072 756e 6e69 6e67  "You are running
-000050f0: 206d 6174 7269 782d 6e69 6f20 7665 7273   matrix-nio vers
-00005100: 696f 6e20 7b6e 696f 5f76 6572 7369 6f6e  ion {nio_version
-00005110: 7d2e 2047 7265 6174 2122 0a20 2020 2020  }. Great!".     
-00005120: 2020 2029 0a20 2020 2020 2020 2072 6573     ).        res
-00005130: 706f 6e73 6520 3d20 6177 6169 7420 636c  ponse = await cl
-00005140: 6965 6e74 2e64 6f77 6e6c 6f61 6428 6d78  ient.download(mx
-00005150: 633d 6d78 632c 2066 696c 656e 616d 653d  c=mxc, filename=
-00005160: 6669 6c65 6e61 6d65 290a 2020 2020 6773  filename).    gs
-00005170: 2e6c 6f67 2e64 6562 7567 2866 2264 6f77  .log.debug(f"dow
-00005180: 6e6c 6f61 645f 6d78 6320 7265 7370 6f6e  nload_mxc respon
-00005190: 7365 2069 7320 7b72 6573 706f 6e73 657d  se is {response}
-000051a0: 2e22 290a 2020 2020 7265 7475 726e 2072  .").    return r
-000051b0: 6573 706f 6e73 650a 0a0a 636c 6173 7320  esponse...class 
-000051c0: 4361 6c6c 6261 636b 7328 6f62 6a65 6374  Callbacks(object
-000051d0: 293a 0a20 2020 2022 2222 436c 6173 7320  ):.    """Class 
-000051e0: 746f 2070 6173 7320 636c 6965 6e74 2074  to pass client t
-000051f0: 6f20 6361 6c6c 6261 636b 206d 6574 686f  o callback metho
-00005200: 6473 2e22 2222 0a0a 2020 2020 6465 6620  ds."""..    def 
-00005210: 5f5f 696e 6974 5f5f 2873 656c 662c 2063  __init__(self, c
-00005220: 6c69 656e 7429 3a0a 2020 2020 2020 2020  lient):.        
-00005230: 2222 2253 746f 7265 2041 7379 6e63 436c  """Store AsyncCl
-00005240: 6965 6e74 2e22 2222 0a20 2020 2020 2020  ient.""".       
-00005250: 2073 656c 662e 636c 6965 6e74 203d 2063   self.client = c
-00005260: 6c69 656e 740a 0a20 2020 2023 2061 6363  lient..    # acc
-00005270: 6f72 6469 6e67 2074 6f20 7079 6c61 6d61  ording to pylama
-00005280: 3a20 6675 6e63 7469 6f6e 2074 6f6f 2063  : function too c
-00005290: 6f6d 706c 6578 3a20 4339 3031 2023 206e  omplex: C901 # n
-000052a0: 6f71 613a 2043 3930 310a 2020 2020 6173  oqa: C901.    as
-000052b0: 796e 6320 6465 6620 6d65 7373 6167 655f  ync def message_
-000052c0: 6361 6c6c 6261 636b 2873 656c 662c 2072  callback(self, r
-000052d0: 6f6f 6d3a 204d 6174 7269 7852 6f6f 6d2c  oom: MatrixRoom,
-000052e0: 2065 7665 6e74 293a 2020 2320 6e6f 7161   event):  # noqa
-000052f0: 3a20 4339 3031 0a20 2020 2020 2020 2022  : C901.        "
-00005300: 2222 4861 6e64 6c65 2061 6c6c 2065 7665  ""Handle all eve
-00005310: 6e74 7320 6f66 2074 7970 6520 526f 6f6d  nts of type Room
-00005320: 4d65 7373 6167 652e 0a0a 2020 2020 2020  Message...      
-00005330: 2020 496e 636c 7564 6573 2065 7665 6e74    Includes event
-00005340: 7320 6c69 6b65 2052 6f6f 6d4d 6573 7361  s like RoomMessa
-00005350: 6765 5465 7874 2c20 526f 6f6d 4d65 7373  geText, RoomMess
-00005360: 6167 6549 6d61 6765 2c20 6574 632e 0a20  ageImage, etc.. 
-00005370: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00005380: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00005390: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-000053a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000053b0: 2020 6622 6d65 7373 6167 655f 6361 6c6c    f"message_call
-000053c0: 6261 636b 2829 3a20 666f 7220 726f 6f6d  back(): for room
-000053d0: 207b 726f 6f6d 7d20 7265 6365 6976 6564   {room} received
-000053e0: 2074 6869 7320 220a 2020 2020 2020 2020   this ".        
-000053f0: 2020 2020 2020 2020 6622 6576 656e 743a          f"event:
-00005400: 2074 7970 653a 207b 7479 7065 2865 7665   type: {type(eve
-00005410: 6e74 297d 2c20 6576 656e 745f 6964 3a20  nt)}, event_id: 
-00005420: 7b65 7665 6e74 2e65 7665 6e74 5f69 647d  {event.event_id}
-00005430: 2c20 220a 2020 2020 2020 2020 2020 2020  , ".            
-00005440: 2020 2020 6622 6576 656e 743a 207b 6576      f"event: {ev
-00005450: 656e 747d 220a 2020 2020 2020 2020 2020  ent}".          
-00005460: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00005470: 6966 206e 6f74 2067 732e 7061 2e6c 6973  if not gs.pa.lis
-00005480: 7465 6e5f 7365 6c66 3a0a 2020 2020 2020  ten_self:.      
-00005490: 2020 2020 2020 2020 2020 6966 2065 7665            if eve
-000054a0: 6e74 2e73 656e 6465 7220 3d3d 2073 656c  nt.sender == sel
-000054b0: 662e 636c 6965 6e74 2e75 7365 723a 0a20  f.client.user:. 
-000054c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000054d0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-000054e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000054f0: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
-00005500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005510: 2020 2020 2020 2020 2020 6622 536b 6970            f"Skip
-00005520: 7069 6e67 206d 6573 7361 6765 2073 656e  ping message sen
-00005530: 7420 6279 206d 7973 656c 663a 207b 6576  t by myself: {ev
-00005540: 656e 742e 626f 6479 7d22 0a20 2020 2020  ent.body}".     
-00005550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005560: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00005570: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-00005580: 4174 7472 6962 7574 6545 7272 6f72 3a20  AttributeError: 
-00005590: 2023 2064 6f65 7320 6e6f 7420 6861 7665   # does not have
-000055a0: 202e 626f 6479 0a20 2020 2020 2020 2020   .body.         
-000055b0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-000055c0: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
-000055d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000055e0: 2020 2020 2020 2020 2066 2253 6b69 7070           f"Skipp
-000055f0: 696e 6720 6d65 7373 6167 6520 7365 6e74  ing message sent
-00005600: 2062 7920 6d79 7365 6c66 3a20 7b65 7665   by myself: {eve
-00005610: 6e74 7d22 0a20 2020 2020 2020 2020 2020  nt}".           
-00005620: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00005630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005640: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
-00005650: 2020 2020 2020 2023 206d 696c 6c69 7365         # millise
-00005660: 6320 7369 6e63 6520 3139 3730 0a20 2020  c since 1970.   
-00005670: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
-00005680: 6465 6275 6728 6622 6576 656e 742e 7365  debug(f"event.se
-00005690: 7276 6572 5f74 696d 6573 7461 6d70 203d  rver_timestamp =
-000056a0: 207b 6576 656e 742e 7365 7276 6572 5f74   {event.server_t
-000056b0: 696d 6573 7461 6d70 7d22 290a 2020 2020  imestamp}").    
-000056c0: 2020 2020 2020 2020 7469 6d65 7374 616d          timestam
-000056d0: 7020 3d20 6461 7465 7469 6d65 2e64 6174  p = datetime.dat
-000056e0: 6574 696d 652e 6672 6f6d 7469 6d65 7374  etime.fromtimest
-000056f0: 616d 7028 0a20 2020 2020 2020 2020 2020  amp(.           
-00005700: 2020 2020 2069 6e74 2865 7665 6e74 2e73       int(event.s
-00005710: 6572 7665 725f 7469 6d65 7374 616d 7020  erver_timestamp 
-00005720: 2f20 3130 3030 290a 2020 2020 2020 2020  / 1000).        
-00005730: 2020 2020 2920 2023 2073 6563 2073 696e      )  # sec sin
-00005740: 6365 2031 3937 300a 2020 2020 2020 2020  ce 1970.        
-00005750: 2020 2020 6576 656e 745f 6461 7465 7469      event_dateti
-00005760: 6d65 203d 2074 696d 6573 7461 6d70 2e73  me = timestamp.s
-00005770: 7472 6674 696d 6528 2225 592d 256d 2d25  trftime("%Y-%m-%
-00005780: 6420 2548 3a25 4d3a 2553 2229 0a20 2020  d %H:%M:%S").   
-00005790: 2020 2020 2020 2020 2023 2065 2e67 2e20           # e.g. 
-000057a0: 3230 3230 2d30 382d 3036 2031 373a 3330  2020-08-06 17:30
-000057b0: 3a31 380a 2020 2020 2020 2020 2020 2020  :18.            
-000057c0: 6773 2e6c 6f67 2e64 6562 7567 2866 2265  gs.log.debug(f"e
-000057d0: 7665 6e74 5f64 6174 6574 696d 6520 3d20  vent_datetime = 
-000057e0: 7b65 7665 6e74 5f64 6174 6574 696d 657d  {event_datetime}
-000057f0: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
-00005800: 6966 2069 7369 6e73 7461 6e63 6528 6576  if isinstance(ev
-00005810: 656e 742c 2052 6f6f 6d4d 6573 7361 6765  ent, RoomMessage
-00005820: 4d65 6469 6129 3a20 2023 2066 6f72 2061  Media):  # for a
-00005830: 6c6c 206d 6564 6961 2065 7665 6e74 730a  ll media events.
-00005840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005850: 6d78 6320 3d20 6576 656e 742e 7572 6c20  mxc = event.url 
-00005860: 2023 206d 6564 6961 206d 7863 0a20 2020   # media mxc.   
-00005870: 2020 2020 2020 2020 2020 2020 2075 726c               url
-00005880: 203d 2061 7761 6974 2073 656c 662e 636c   = await self.cl
-00005890: 6965 6e74 2e6d 7863 5f74 6f5f 6874 7470  ient.mxc_to_http
-000058a0: 286d 7863 2920 2023 206d 6564 6961 2075  (mxc)  # media u
-000058b0: 726c 0a20 2020 2020 2020 2020 2020 2020  rl.             
-000058c0: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-000058d0: 6622 4854 5450 2055 524c 206f 6620 6d65  f"HTTP URL of me
-000058e0: 6469 6120 6973 203a 207b 7572 6c7d 2229  dia is : {url}")
-000058f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005900: 206d 7367 5f75 726c 203d 2022 205b 2220   msg_url = " [" 
-00005910: 2b20 7572 6c20 2b20 225d 220a 2020 2020  + url + "]".    
-00005920: 2020 2020 2020 2020 2020 2020 6966 2067              if g
-00005930: 732e 7061 2e64 6f77 6e6c 6f61 645f 6d65  s.pa.download_me
-00005940: 6469 6120 213d 2022 223a 0a20 2020 2020  dia != "":.     
-00005950: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00005960: 2064 6f77 6e6c 6f61 6420 756e 656e 6372   download unencr
-00005970: 7970 7465 642f 706c 6169 6e20 6d65 6469  ypted/plain medi
-00005980: 6120 6669 6c65 0a20 2020 2020 2020 2020  a file.         
-00005990: 2020 2020 2020 2020 2020 2072 6573 7020             resp 
-000059a0: 3d20 6177 6169 7420 646f 776e 6c6f 6164  = await download
-000059b0: 5f6d 7863 2873 656c 662e 636c 6965 6e74  _mxc(self.client
-000059c0: 2c20 6d78 6329 0a20 2020 2020 2020 2020  , mxc).         
-000059d0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-000059e0: 696e 7374 616e 6365 2872 6573 702c 2044  instance(resp, D
-000059f0: 6f77 6e6c 6f61 6445 7272 6f72 293a 0a20  ownloadError):. 
-00005a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005a10: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
-00005a20: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-00005a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005a40: 2022 4531 3035 3a20 220a 2020 2020 2020   "E105: ".      
-00005a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005a60: 2020 2020 2020 6622 646f 776e 6c6f 6164        f"download
-00005a70: 206f 6620 5552 4920 277b 6d78 637d 2720   of URI '{mxc}' 
-00005a80: 746f 206c 6f63 616c 2066 696c 6520 220a  to local file ".
-00005a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005aa0: 2020 2020 2020 2020 2020 2020 6622 6661              f"fa
-00005ab0: 696c 6564 2077 6974 6820 7265 7370 6f6e  iled with respon
-00005ac0: 7365 207b 7072 6976 6163 795f 6669 6c74  se {privacy_filt
-00005ad0: 6572 2873 7472 2872 6573 7029 297d 220a  er(str(resp))}".
-00005ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005af0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00005b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005b10: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
-00005b20: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-00005b30: 2020 2020 2020 2020 2020 2020 6d73 675f              msg_
-00005b40: 7572 6c20 2b3d 2022 205b 446f 776e 6c6f  url += " [Downlo
-00005b50: 6164 206f 6620 6d65 6469 6120 6669 6c65  ad of media file
-00005b60: 2066 6169 6c65 645d 220a 2020 2020 2020   failed]".      
-00005b70: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00005b80: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00005b90: 2020 2020 2020 2020 2020 2020 6d65 6469              medi
-00005ba0: 615f 6461 7461 203d 2072 6573 702e 626f  a_data = resp.bo
-00005bb0: 6479 0a20 2020 2020 2020 2020 2020 2020  dy.             
-00005bc0: 2020 2020 2020 2020 2020 2066 696c 656e             filen
-00005bd0: 616d 6520 3d20 6368 6f6f 7365 5f61 7661  ame = choose_ava
-00005be0: 696c 6162 6c65 5f66 696c 656e 616d 6528  ilable_filename(
-00005bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005c00: 2020 2020 2020 2020 2020 2020 206f 732e               os.
-00005c10: 7061 7468 2e6a 6f69 6e28 6773 2e70 612e  path.join(gs.pa.
-00005c20: 646f 776e 6c6f 6164 5f6d 6564 6961 2c20  download_media, 
-00005c30: 6576 656e 742e 626f 6479 290a 2020 2020  event.body).    
-00005c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005c50: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00005c60: 2020 2020 2020 2020 2020 2020 2020 6173                as
-00005c70: 796e 6320 7769 7468 2061 696f 6669 6c65  ync with aiofile
-00005c80: 732e 6f70 656e 2866 696c 656e 616d 652c  s.open(filename,
-00005c90: 2022 7762 2229 2061 7320 663a 0a20 2020   "wb") as f:.   
-00005ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005cb0: 2020 2020 2020 2020 2061 7761 6974 2066           await f
-00005cc0: 2e77 7269 7465 286d 6564 6961 5f64 6174  .write(media_dat
-00005cd0: 6129 0a20 2020 2020 2020 2020 2020 2020  a).             
-00005ce0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00005cf0: 2053 6574 2061 7469 6d65 2061 6e64 206d   Set atime and m
-00005d00: 7469 6d65 206f 6620 6669 6c65 2074 6f20  time of file to 
-00005d10: 6576 656e 7420 7469 6d65 7374 616d 700a  event timestamp.
-00005d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005d30: 2020 2020 2020 2020 2020 2020 6f73 2e75              os.u
-00005d40: 7469 6d65 280a 2020 2020 2020 2020 2020  time(.          
-00005d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005d60: 2020 2020 2020 6669 6c65 6e61 6d65 2c0a        filename,.
-00005d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000003b0: 732e 6f73 0a69 6d70 6f72 7420 656d 6f6a  s.os.import emoj
+000003c0: 690a 696d 706f 7274 206d 6167 6963 0a69  i.import magic.i
+000003d0: 6d70 6f72 7420 706b 675f 7265 736f 7572  mport pkg_resour
+000003e0: 6365 730a 6672 6f6d 2061 696f 6874 7470  ces.from aiohttp
+000003f0: 2069 6d70 6f72 7420 436c 6965 6e74 436f   import ClientCo
+00000400: 6e6e 6563 746f 7245 7272 6f72 2c20 436c  nnectorError, Cl
+00000410: 6965 6e74 5365 7373 696f 6e2c 2054 4350  ientSession, TCP
+00000420: 436f 6e6e 6563 746f 722c 2077 6562 0a66  Connector, web.f
+00000430: 726f 6d20 6d61 726b 646f 776e 2069 6d70  rom markdown imp
+00000440: 6f72 7420 6d61 726b 646f 776e 0a66 726f  ort markdown.fro
+00000450: 6d20 6e69 6f20 696d 706f 7274 2028 4173  m nio import (As
+00000460: 796e 6343 6c69 656e 742c 2041 7379 6e63  yncClient, Async
+00000470: 436c 6965 6e74 436f 6e66 6967 2c20 436f  ClientConfig, Co
+00000480: 6e74 656e 7452 6570 6f73 6974 6f72 7943  ntentRepositoryC
+00000490: 6f6e 6669 6745 7272 6f72 2c0a 2020 2020  onfigError,.    
+000004a0: 2020 2020 2020 2020 2020 2020 2044 656c               Del
+000004b0: 6574 6544 6576 6963 6573 4175 7468 5265  eteDevicesAuthRe
+000004c0: 7370 6f6e 7365 2c20 4465 6c65 7465 4465  sponse, DeleteDe
+000004d0: 7669 6365 7345 7272 6f72 2c20 4465 7669  vicesError, Devi
+000004e0: 6365 7345 7272 6f72 2c0a 2020 2020 2020  cesError,.      
+000004f0: 2020 2020 2020 2020 2020 2044 6973 636f             Disco
+00000500: 7665 7279 496e 666f 4572 726f 722c 2044  veryInfoError, D
+00000510: 6f77 6e6c 6f61 6445 7272 6f72 2c20 456e  ownloadError, En
+00000520: 6162 6c65 456e 6372 7970 7469 6f6e 4275  ableEncryptionBu
+00000530: 696c 6465 722c 0a20 2020 2020 2020 2020  ilder,.         
+00000540: 2020 2020 2020 2020 456e 6372 7970 7469          Encrypti
+00000550: 6f6e 4572 726f 722c 2045 7272 6f72 5265  onError, ErrorRe
+00000560: 7370 6f6e 7365 2c20 4a6f 696e 6564 4d65  sponse, JoinedMe
+00000570: 6d62 6572 7345 7272 6f72 2c0a 2020 2020  mbersError,.    
+00000580: 2020 2020 2020 2020 2020 2020 204a 6f69               Joi
+00000590: 6e65 6452 6f6f 6d73 4572 726f 722c 204a  nedRoomsError, J
+000005a0: 6f69 6e45 7272 6f72 2c20 4b65 7956 6572  oinError, KeyVer
+000005b0: 6966 6963 6174 696f 6e43 616e 6365 6c2c  ificationCancel,
+000005c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000005d0: 2020 4b65 7956 6572 6966 6963 6174 696f    KeyVerificatio
+000005e0: 6e45 7665 6e74 2c20 4b65 7956 6572 6966  nEvent, KeyVerif
+000005f0: 6963 6174 696f 6e4b 6579 2c20 4b65 7956  icationKey, KeyV
+00000600: 6572 6966 6963 6174 696f 6e4d 6163 2c0a  erificationMac,.
+00000610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000620: 204b 6579 5665 7269 6669 6361 7469 6f6e   KeyVerification
+00000630: 5374 6172 742c 204c 6f63 616c 5072 6f74  Start, LocalProt
+00000640: 6f63 6f6c 4572 726f 722c 204c 6f67 696e  ocolError, Login
+00000650: 496e 666f 4572 726f 722c 0a20 2020 2020  InfoError,.     
+00000660: 2020 2020 2020 2020 2020 2020 4c6f 6769              Logi
+00000670: 6e52 6573 706f 6e73 652c 204c 6f67 6f75  nResponse, Logou
+00000680: 7445 7272 6f72 2c20 4d61 7472 6978 526f  tError, MatrixRo
+00000690: 6f6d 2c20 4d65 7373 6167 6544 6972 6563  om, MessageDirec
+000006a0: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
+000006b0: 2020 2020 2020 2050 7265 7365 6e63 6547         PresenceG
+000006c0: 6574 4572 726f 722c 2050 7265 7365 6e63  etError, Presenc
+000006d0: 6553 6574 4572 726f 722c 2050 726f 6669  eSetError, Profi
+000006e0: 6c65 4765 7441 7661 7461 7252 6573 706f  leGetAvatarRespo
+000006f0: 6e73 652c 0a20 2020 2020 2020 2020 2020  nse,.           
+00000700: 2020 2020 2020 5072 6f66 696c 6547 6574        ProfileGet
+00000710: 4469 7370 6c61 794e 616d 6545 7272 6f72  DisplayNameError
+00000720: 2c20 5072 6f66 696c 6547 6574 4572 726f  , ProfileGetErro
+00000730: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+00000740: 2020 2020 5072 6f66 696c 6553 6574 4176      ProfileSetAv
+00000750: 6174 6172 5265 7370 6f6e 7365 2c20 5072  atarResponse, Pr
+00000760: 6f66 696c 6553 6574 4469 7370 6c61 794e  ofileSetDisplayN
+00000770: 616d 6545 7272 6f72 2c0a 2020 2020 2020  ameError,.      
+00000780: 2020 2020 2020 2020 2020 2052 6564 6163             Redac
+00000790: 7465 6445 7665 6e74 2c20 5265 6461 6374  tedEvent, Redact
+000007a0: 696f 6e45 7665 6e74 2c20 526f 6f6d 416c  ionEvent, RoomAl
+000007b0: 6961 7345 7665 6e74 2c20 526f 6f6d 4261  iasEvent, RoomBa
+000007c0: 6e45 7272 6f72 2c0a 2020 2020 2020 2020  nError,.        
+000007d0: 2020 2020 2020 2020 2052 6f6f 6d43 7265           RoomCre
+000007e0: 6174 6545 7272 6f72 2c20 526f 6f6d 4465  ateError, RoomDe
+000007f0: 6c65 7465 416c 6961 7352 6573 706f 6e73  leteAliasRespons
+00000800: 652c 2052 6f6f 6d45 6e63 7279 7074 6564  e, RoomEncrypted
+00000810: 4175 6469 6f2c 0a20 2020 2020 2020 2020  Audio,.         
+00000820: 2020 2020 2020 2020 526f 6f6d 456e 6372          RoomEncr
+00000830: 7970 7465 6446 696c 652c 2052 6f6f 6d45  yptedFile, RoomE
+00000840: 6e63 7279 7074 6564 496d 6167 652c 2052  ncryptedImage, R
+00000850: 6f6f 6d45 6e63 7279 7074 6564 4d65 6469  oomEncryptedMedi
+00000860: 612c 0a20 2020 2020 2020 2020 2020 2020  a,.             
+00000870: 2020 2020 526f 6f6d 456e 6372 7970 7465      RoomEncrypte
+00000880: 6456 6964 656f 2c20 526f 6f6d 456e 6372  dVideo, RoomEncr
+00000890: 7970 7469 6f6e 4576 656e 742c 2052 6f6f  yptionEvent, Roo
+000008a0: 6d46 6f72 6765 7445 7272 6f72 2c0a 2020  mForgetError,.  
+000008b0: 2020 2020 2020 2020 2020 2020 2020 2052                 R
+000008c0: 6f6f 6d47 6574 5374 6174 6552 6573 706f  oomGetStateRespo
+000008d0: 6e73 652c 2052 6f6f 6d47 6574 5669 7369  nse, RoomGetVisi
+000008e0: 6269 6c69 7479 5265 7370 6f6e 7365 2c0a  bilityResponse,.
+000008f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000900: 2052 6f6f 6d49 6e76 6974 6545 7272 6f72   RoomInviteError
+00000910: 2c20 526f 6f6d 4b69 636b 4572 726f 722c  , RoomKickError,
+00000920: 2052 6f6f 6d4c 6561 7665 4572 726f 722c   RoomLeaveError,
+00000930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00000940: 2020 526f 6f6d 4d65 6d62 6572 4576 656e    RoomMemberEven
+00000950: 742c 2052 6f6f 6d4d 6573 7361 6765 2c20  t, RoomMessage, 
+00000960: 526f 6f6d 4d65 7373 6167 6541 7564 696f  RoomMessageAudio
+00000970: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00000980: 2020 2052 6f6f 6d4d 6573 7361 6765 456d     RoomMessageEm
+00000990: 6f74 652c 2052 6f6f 6d4d 6573 7361 6765  ote, RoomMessage
+000009a0: 4669 6c65 2c20 526f 6f6d 4d65 7373 6167  File, RoomMessag
+000009b0: 6546 6f72 6d61 7474 6564 2c0a 2020 2020  eFormatted,.    
+000009c0: 2020 2020 2020 2020 2020 2020 2052 6f6f               Roo
+000009d0: 6d4d 6573 7361 6765 496d 6167 652c 2052  mMessageImage, R
+000009e0: 6f6f 6d4d 6573 7361 6765 4d65 6469 612c  oomMessageMedia,
+000009f0: 2052 6f6f 6d4d 6573 7361 6765 4e6f 7469   RoomMessageNoti
+00000a00: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
+00000a10: 2020 2020 2052 6f6f 6d4d 6573 7361 6765       RoomMessage
+00000a20: 7345 7272 6f72 2c20 526f 6f6d 4d65 7373  sError, RoomMess
+00000a30: 6167 6554 6578 742c 2052 6f6f 6d4d 6573  ageText, RoomMes
+00000a40: 7361 6765 556e 6b6e 6f77 6e2c 0a20 2020  sageUnknown,.   
+00000a50: 2020 2020 2020 2020 2020 2020 2020 526f                Ro
+00000a60: 6f6d 4d65 7373 6167 6556 6964 656f 2c20  omMessageVideo, 
+00000a70: 526f 6f6d 4e61 6d65 4576 656e 742c 2052  RoomNameEvent, R
+00000a80: 6f6f 6d50 7265 7365 742c 0a20 2020 2020  oomPreset,.     
+00000a90: 2020 2020 2020 2020 2020 2020 526f 6f6d              Room
+00000aa0: 5075 7441 6c69 6173 5265 7370 6f6e 7365  PutAliasResponse
+00000ab0: 2c20 526f 6f6d 5265 6164 4d61 726b 6572  , RoomReadMarker
+00000ac0: 7345 7272 6f72 2c20 526f 6f6d 5265 6461  sError, RoomReda
+00000ad0: 6374 4572 726f 722c 0a20 2020 2020 2020  ctError,.       
+00000ae0: 2020 2020 2020 2020 2020 526f 6f6d 5265            RoomRe
+00000af0: 736f 6c76 6541 6c69 6173 4572 726f 722c  solveAliasError,
+00000b00: 2052 6f6f 6d52 6573 6f6c 7665 416c 6961   RoomResolveAlia
+00000b10: 7352 6573 706f 6e73 652c 0a20 2020 2020  sResponse,.     
+00000b20: 2020 2020 2020 2020 2020 2020 526f 6f6d              Room
+00000b30: 5365 6e64 4572 726f 722c 2052 6f6f 6d55  SendError, RoomU
+00000b40: 6e62 616e 4572 726f 722c 2052 6f6f 6d56  nbanError, RoomV
+00000b50: 6973 6962 696c 6974 792c 2053 796e 6345  isibility, SyncE
+00000b60: 7272 6f72 2c0a 2020 2020 2020 2020 2020  rror,.          
+00000b70: 2020 2020 2020 2053 796e 6352 6573 706f         SyncRespo
+00000b80: 6e73 652c 2054 6f44 6576 6963 6545 7272  nse, ToDeviceErr
+00000b90: 6f72 2c20 556e 6b6e 6f77 6e45 7665 6e74  or, UnknownEvent
+00000ba0: 2c20 5570 6461 7465 4465 7669 6365 4572  , UpdateDeviceEr
+00000bb0: 726f 722c 0a20 2020 2020 2020 2020 2020  ror,.           
+00000bc0: 2020 2020 2020 5570 6c6f 6164 4572 726f        UploadErro
+00000bd0: 722c 2055 706c 6f61 6452 6573 706f 6e73  r, UploadRespons
+00000be0: 652c 2063 7279 7074 6f2c 2072 6573 706f  e, crypto, respo
+00000bf0: 6e73 6573 290a 6672 6f6d 2050 494c 2069  nses).from PIL i
+00000c00: 6d70 6f72 7420 496d 6167 650a 6672 6f6d  mport Image.from
+00000c10: 2078 6467 2069 6d70 6f72 7420 4261 7365   xdg import Base
+00000c20: 4469 7265 6374 6f72 790a 0a74 7279 3a0a  Directory..try:.
+00000c30: 2020 2020 696d 706f 7274 206e 6f74 6966      import notif
+00000c40: 7932 0a0a 2020 2020 4841 5645 5f4e 4f54  y2..    HAVE_NOT
+00000c50: 4946 5920 3d20 5472 7565 0a65 7863 6570  IFY = True.excep
+00000c60: 7420 496d 706f 7274 4572 726f 723a 0a20  t ImportError:. 
+00000c70: 2020 2048 4156 455f 4e4f 5449 4659 203d     HAVE_NOTIFY =
+00000c80: 2046 616c 7365 0a0a 7472 793a 0a20 2020   False..try:.   
+00000c90: 2066 726f 6d20 6e69 6f20 696d 706f 7274   from nio import
+00000ca0: 2047 6574 4f70 656e 4944 546f 6b65 6e45   GetOpenIDTokenE
+00000cb0: 7272 6f72 0a0a 2020 2020 4841 5645 5f4f  rror..    HAVE_O
+00000cc0: 5045 4e49 4420 3d20 5472 7565 0a65 7863  PENID = True.exc
+00000cd0: 6570 7420 496d 706f 7274 4572 726f 723a  ept ImportError:
+00000ce0: 0a20 2020 2048 4156 455f 4f50 454e 4944  .    HAVE_OPENID
+00000cf0: 203d 2046 616c 7365 0a0a 2320 7665 7273   = False..# vers
+00000d00: 696f 6e20 6e75 6d62 6572 0a56 4552 5349  ion number.VERSI
+00000d10: 4f4e 203d 2022 3230 3233 2d30 342d 3132  ON = "2023-04-12
+00000d20: 220a 5645 5253 494f 4e4e 5220 3d20 2237  ".VERSIONNR = "7
+00000d30: 2e30 2e30 220a 2320 6d61 7472 6978 2d63  .0.0".# matrix-c
+00000d40: 6f6d 6d61 6e64 6572 3b20 666f 7220 6261  ommander; for ba
+00000d50: 636b 7761 7264 7320 636f 6d70 6974 6162  ckwards compitab
+00000d60: 696c 6974 7920 7265 706c 6163 6520 5f20  ility replace _ 
+00000d70: 7769 7468 202d 0a50 524f 475f 5749 5448  with -.PROG_WITH
+00000d80: 4f55 545f 4558 5420 3d20 6f73 2e70 6174  OUT_EXT = os.pat
+00000d90: 682e 7370 6c69 7465 7874 286f 732e 7061  h.splitext(os.pa
+00000da0: 7468 2e62 6173 656e 616d 6528 5f5f 6669  th.basename(__fi
+00000db0: 6c65 5f5f 2929 5b30 5d2e 7265 706c 6163  le__))[0].replac
+00000dc0: 6528 0a20 2020 2022 5f22 2c20 222d 220a  e(.    "_", "-".
+00000dd0: 290a 2320 6d61 7472 6978 2d63 6f6d 6d61  ).# matrix-comma
+00000de0: 6e64 6572 2e70 793b 2066 6f72 2062 6163  nder.py; for bac
+00000df0: 6b77 6172 6473 2063 6f6d 7069 7461 6269  kwards compitabi
+00000e00: 6c69 7479 2072 6570 6c61 6365 205f 2077  lity replace _ w
+00000e10: 6974 6820 2d0a 5052 4f47 5f57 4954 485f  ith -.PROG_WITH_
+00000e20: 4558 5420 3d20 6f73 2e70 6174 682e 6261  EXT = os.path.ba
+00000e30: 7365 6e61 6d65 285f 5f66 696c 655f 5f29  sename(__file__)
+00000e40: 2e72 6570 6c61 6365 2822 5f22 2c20 222d  .replace("_", "-
+00000e50: 2229 0a23 2066 696c 6520 746f 2073 746f  ").# file to sto
+00000e60: 7265 2063 7265 6465 6e74 6961 6c73 2069  re credentials i
+00000e70: 6e20 6361 7365 2079 6f75 2077 616e 7420  n case you want 
+00000e80: 746f 2072 756e 2070 726f 6772 616d 206d  to run program m
+00000e90: 756c 7469 706c 6520 7469 6d65 730a 4352  ultiple times.CR
+00000ea0: 4544 454e 5449 414c 535f 4649 4c45 5f44  EDENTIALS_FILE_D
+00000eb0: 4546 4155 4c54 203d 2022 6372 6564 656e  EFAULT = "creden
+00000ec0: 7469 616c 732e 6a73 6f6e 2220 2023 206c  tials.json"  # l
+00000ed0: 6f67 696e 2063 7265 6465 6e74 6961 6c73  ogin credentials
+00000ee0: 204a 534f 4e20 6669 6c65 0a23 2065 2e67   JSON file.# e.g
+00000ef0: 2e20 7e2f 2e63 6f6e 6669 672f 6d61 7472  . ~/.config/matr
+00000f00: 6978 2d63 6f6d 6d61 6e64 6572 2f0a 4352  ix-commander/.CR
+00000f10: 4544 454e 5449 414c 535f 4449 525f 4c41  EDENTIALS_DIR_LA
+00000f20: 5354 5245 534f 5254 203d 206f 732e 7061  STRESORT = os.pa
+00000f30: 7468 2e65 7870 616e 6475 7365 7228 0a20  th.expanduser(. 
+00000f40: 2020 2042 6173 6544 6972 6563 746f 7279     BaseDirectory
+00000f50: 2e78 6467 5f63 6f6e 6669 675f 686f 6d65  .xdg_config_home
+00000f60: 202b 2022 2f22 2020 2320 227e 2f2e 636f   + "/"  # "~/.co
+00000f70: 6e66 6967 2f22 0a29 202b 206f 732e 7061  nfig/".) + os.pa
+00000f80: 7468 2e73 706c 6974 6578 7428 6f73 2e70  th.splitext(os.p
+00000f90: 6174 682e 6261 7365 6e61 6d65 285f 5f66  ath.basename(__f
+00000fa0: 696c 655f 5f29 295b 305d 2e72 6570 6c61  ile__))[0].repla
+00000fb0: 6365 2822 5f22 2c20 222d 2229 0a23 2064  ce("_", "-").# d
+00000fc0: 6972 6563 746f 7279 2074 6f20 6265 2075  irectory to be u
+00000fd0: 7365 6420 6279 2065 6e64 2d74 6f2d 656e  sed by end-to-en
+00000fe0: 6420 656e 6372 7970 7465 6420 7072 6f74  d encrypted prot
+00000ff0: 6f63 6f6c 2066 6f72 2070 6572 7369 7374  ocol for persist
+00001000: 656e 7420 7374 6f72 6167 650a 5354 4f52  ent storage.STOR
+00001010: 455f 4449 525f 4445 4641 554c 5420 3d20  E_DIR_DEFAULT = 
+00001020: 222e 2f73 746f 7265 2f22 0a23 2065 2e67  "./store/".# e.g
+00001030: 2e20 7e2f 2e6c 6f63 616c 2f73 6861 7265  . ~/.local/share
+00001040: 2f6d 6174 7269 782d 636f 6d6d 616e 6465  /matrix-commande
+00001050: 722f 0a23 2074 6865 2053 544f 5245 5f50  r/.# the STORE_P
+00001060: 4154 485f 4c41 5354 5245 534f 5254 2077  ATH_LASTRESORT w
+00001070: 696c 6c20 6265 2063 6f6e 6361 7465 6e61  ill be concatena
+00001080: 7465 6420 7769 7468 2061 2064 6972 6563  ted with a direc
+00001090: 746f 7279 206e 616d 650a 2320 6c69 6b65  tory name.# like
+000010a0: 2073 746f 7265 2074 6f20 7265 7375 6c74   store to result
+000010b0: 2069 6e20 6120 6669 6e61 6c20 7061 7468   in a final path
+000010c0: 206f 660a 2320 652e 672e 207e 2f2e 6c6f   of.# e.g. ~/.lo
+000010d0: 6361 6c2f 7368 6172 652f 6d61 7472 6978  cal/share/matrix
+000010e0: 2d63 6f6d 6d61 6e64 6572 2f73 746f 7265  -commander/store
+000010f0: 2f20 6173 2061 6374 7561 6c20 7065 7273  / as actual pers
+00001100: 6973 7465 6e74 2073 746f 7265 2064 6972  istent store dir
+00001110: 0a53 544f 5245 5f50 4154 485f 4c41 5354  .STORE_PATH_LAST
+00001120: 5245 534f 5254 203d 206f 732e 7061 7468  RESORT = os.path
+00001130: 2e6e 6f72 6d70 6174 6828 0a20 2020 2028  .normpath(.    (
+00001140: 0a20 2020 2020 2020 206f 732e 7061 7468  .        os.path
+00001150: 2e65 7870 616e 6475 7365 7228 0a20 2020  .expanduser(.   
+00001160: 2020 2020 2020 2020 2042 6173 6544 6972           BaseDir
+00001170: 6563 746f 7279 2e78 6467 5f64 6174 615f  ectory.xdg_data_
+00001180: 686f 6d65 202b 2022 2f22 0a20 2020 2020  home + "/".     
+00001190: 2020 2029 2020 2320 7e2f 2e6c 6f63 616c     )  # ~/.local
+000011a0: 2f73 6861 7265 2f0a 2020 2020 2020 2020  /share/.        
+000011b0: 2b20 6f73 2e70 6174 682e 7370 6c69 7465  + os.path.splite
+000011c0: 7874 286f 732e 7061 7468 2e62 6173 656e  xt(os.path.basen
+000011d0: 616d 6528 5f5f 6669 6c65 5f5f 2929 5b30  ame(__file__))[0
+000011e0: 5d2e 7265 706c 6163 6528 225f 222c 2022  ].replace("_", "
+000011f0: 2d22 290a 2020 2020 290a 290a 2320 652e  -").    ).).# e.
+00001200: 672e 207e 2f2e 6c6f 6361 6c2f 7368 6172  g. ~/.local/shar
+00001210: 652f 6d61 7472 6978 2d63 6f6d 6d61 6e64  e/matrix-command
+00001220: 6572 2f73 746f 7265 2f0a 5354 4f52 455f  er/store/.STORE_
+00001230: 4449 525f 4c41 5354 5245 534f 5254 203d  DIR_LASTRESORT =
+00001240: 206f 732e 7061 7468 2e6e 6f72 6d70 6174   os.path.normpat
+00001250: 6828 0a20 2020 2028 6f73 2e70 6174 682e  h(.    (os.path.
+00001260: 6578 7061 6e64 7573 6572 2853 544f 5245  expanduser(STORE
+00001270: 5f50 4154 485f 4c41 5354 5245 534f 5254  _PATH_LASTRESORT
+00001280: 202b 2022 2f22 202b 2053 544f 5245 5f44   + "/" + STORE_D
+00001290: 4952 5f44 4546 4155 4c54 2929 0a29 0a23  IR_DEFAULT)).).#
+000012a0: 2064 6972 6563 746f 7279 2074 6f20 6265   directory to be
+000012b0: 2075 7365 6420 666f 7220 646f 776e 6c6f   used for downlo
+000012c0: 6164 696e 6720 6d65 6469 6120 6669 6c65  ading media file
+000012d0: 730a 4d45 4449 415f 4449 525f 4445 4641  s.MEDIA_DIR_DEFA
+000012e0: 554c 5420 3d20 222e 2f6d 6564 6961 2f22  ULT = "./media/"
+000012f0: 0a23 2075 7375 616c 6c79 2074 6865 7265  .# usually there
+00001300: 2061 7265 206e 6f20 7065 726d 6973 7369   are no permissi
+00001310: 6f6e 7320 666f 7220 7573 696e 673a 202f  ons for using: /
+00001320: 7275 6e2f 6d61 7472 6978 2d63 6f6d 6d61  run/matrix-comma
+00001330: 6e64 6572 2e70 6964 0a23 2073 6f20 696e  nder.pid.# so in
+00001340: 7374 6561 6420 6c6f 6361 6c20 6669 6c65  stead local file
+00001350: 7320 6c69 6b65 207e 2f2e 7275 6e2f 6d61  s like ~/.run/ma
+00001360: 7472 6978 2d63 6f6d 6d61 6e64 6572 2e73  trix-commander.s
+00001370: 6f6d 652d 7575 6964 2d68 6572 652e 7069  ome-uuid-here.pi
+00001380: 6420 7769 6c6c 0a23 2062 6520 7573 6564  d will.# be used
+00001390: 2066 6f72 2073 746f 7269 6e67 2074 6865   for storing the
+000013a0: 2050 4944 2873 2920 666f 7220 7365 6e64   PID(s) for send
+000013b0: 696e 6720 7369 676e 616c 732e 0a23 2054  ing signals..# T
+000013c0: 6865 7265 206d 6967 6874 2062 6520 6d6f  here might be mo
+000013d0: 7265 2074 6861 6e20 3120 7072 6f63 6573  re than 1 proces
+000013e0: 7320 7275 6e6e 696e 6720 696e 2070 6172  s running in par
+000013f0: 616c 6c65 6c2c 2073 6f20 7468 6572 6520  allel, so there 
+00001400: 6d69 6768 7420 6265 0a23 206d 6f72 6520  might be.# more 
+00001410: 7468 616e 2031 2050 4944 2061 7420 6120  than 1 PID at a 
+00001420: 6769 7665 6e20 706f 696e 7420 696e 2074  given point in t
+00001430: 696d 652e 0a50 4944 5f44 4952 5f44 4546  ime..PID_DIR_DEF
+00001440: 4155 4c54 203d 206f 732e 7061 7468 2e6e  AULT = os.path.n
+00001450: 6f72 6d70 6174 6828 6f73 2e70 6174 682e  ormpath(os.path.
+00001460: 6578 7061 6e64 7573 6572 2822 7e2f 2e72  expanduser("~/.r
+00001470: 756e 2f22 2929 0a50 4944 5f46 494c 455f  un/")).PID_FILE_
+00001480: 4445 4641 554c 5420 3d20 6f73 2e70 6174  DEFAULT = os.pat
+00001490: 682e 6e6f 726d 7061 7468 280a 2020 2020  h.normpath(.    
+000014a0: 5049 445f 4449 525f 4445 4641 554c 5420  PID_DIR_DEFAULT 
+000014b0: 2b20 222f 2220 2b20 5052 4f47 5f57 4954  + "/" + PROG_WIT
+000014c0: 484f 5554 5f45 5854 202b 2022 2e22 202b  HOUT_EXT + "." +
+000014d0: 2073 7472 2875 7569 642e 7575 6964 3428   str(uuid.uuid4(
+000014e0: 2929 202b 2022 2e70 6964 220a 290a 454d  )) + ".pid".).EM
+000014f0: 4f4a 4920 3d20 2265 6d6f 6a69 2220 2023  OJI = "emoji"  #
+00001500: 2076 6572 6966 6963 6174 696f 6e20 7479   verification ty
+00001510: 7065 0a50 5249 4e54 203d 2022 7072 696e  pe.PRINT = "prin
+00001520: 7422 2020 2320 7665 7273 696f 6e20 7479  t"  # version ty
+00001530: 7065 0a43 4845 434b 203d 2022 6368 6563  pe.CHECK = "chec
+00001540: 6b22 2020 2320 7665 7273 696f 6e20 7479  k"  # version ty
+00001550: 7065 0a4f 4e43 4520 3d20 226f 6e63 6522  pe.ONCE = "once"
+00001560: 2020 2320 6c69 7374 656e 696e 6720 7479    # listening ty
+00001570: 7065 0a4e 4556 4552 203d 2022 6e65 7665  pe.NEVER = "neve
+00001580: 7222 2020 2320 6c69 7374 656e 696e 6720  r"  # listening 
+00001590: 7479 7065 0a46 4f52 4556 4552 203d 2022  type.FOREVER = "
+000015a0: 666f 7265 7665 7222 2020 2320 6c69 7374  forever"  # list
+000015b0: 656e 696e 6720 7479 7065 0a41 4c4c 203d  ening type.ALL =
+000015c0: 2022 616c 6c22 2020 2320 6c69 7374 656e   "all"  # listen
+000015d0: 696e 6720 7479 7065 0a54 4149 4c20 3d20  ing type.TAIL = 
+000015e0: 2274 6169 6c22 2020 2320 6c69 7374 656e  "tail"  # listen
+000015f0: 696e 6720 7479 7065 0a44 4546 4155 4c54  ing type.DEFAULT
+00001600: 5f53 4550 4152 4154 4f52 203d 2022 2020  _SEPARATOR = "  
+00001610: 2020 2220 2023 2075 7365 6420 666f 7220    "  # used for 
+00001620: 7370 6572 6174 696e 6720 636f 6c75 6d6e  sperating column
+00001630: 7320 696e 2070 7269 6e74 206f 7574 7075  s in print outpu
+00001640: 7473 0a53 4550 203d 2044 4546 4155 4c54  ts.SEP = DEFAULT
+00001650: 5f53 4550 4152 4154 4f52 0a4c 4953 5445  _SEPARATOR.LISTE
+00001660: 4e5f 4445 4641 554c 5420 3d20 4e45 5645  N_DEFAULT = NEVE
+00001670: 520a 5441 494c 5f55 4e55 5345 445f 4445  R.TAIL_UNUSED_DE
+00001680: 4641 554c 5420 3d20 3020 2023 2067 6574  FAULT = 0  # get
+00001690: 2030 2069 6620 2d2d 7461 696c 2069 7320   0 if --tail is 
+000016a0: 6e6f 7420 7370 6563 6966 6965 640a 5441  not specified.TA
+000016b0: 494c 5f55 5345 445f 4445 4641 554c 5420  IL_USED_DEFAULT 
+000016c0: 3d20 3130 2020 2320 6765 7420 7468 6520  = 10  # get the 
+000016d0: 6c61 7374 2031 3020 6d73 6773 2062 7920  last 10 msgs by 
+000016e0: 6465 6661 756c 7420 7769 7468 202d 2d74  default with --t
+000016f0: 6169 6c0a 5645 5249 4659 5f55 4e55 5345  ail.VERIFY_UNUSE
+00001700: 445f 4445 4641 554c 5420 3d20 4e6f 6e65  D_DEFAULT = None
+00001710: 2020 2320 7573 6520 4e6f 6e65 2069 6620    # use None if 
+00001720: 2d2d 7665 7269 6679 2069 7320 6e6f 7420  --verify is not 
+00001730: 7370 6563 6966 6965 640a 5645 5249 4659  specified.VERIFY
+00001740: 5f55 5345 445f 4445 4641 554c 5420 3d20  _USED_DEFAULT = 
+00001750: 454d 4f4a 4920 2023 2075 7365 2027 656d  EMOJI  # use 'em
+00001760: 6f6a 6927 2062 7920 6465 6661 756c 7420  oji' by default 
+00001770: 7769 7468 202d 2d76 6572 6966 790a 5645  with --verify.VE
+00001780: 5253 494f 4e5f 554e 5553 4544 5f44 4546  RSION_UNUSED_DEF
+00001790: 4155 4c54 203d 204e 6f6e 6520 2023 2075  AULT = None  # u
+000017a0: 7365 204e 6f6e 6520 6966 202d 2d76 6572  se None if --ver
+000017b0: 7369 6f6e 2069 7320 6e6f 7420 7370 6563  sion is not spec
+000017c0: 6966 6965 640a 5645 5253 494f 4e5f 5553  ified.VERSION_US
+000017d0: 4544 5f44 4546 4155 4c54 203d 2050 5249  ED_DEFAULT = PRI
+000017e0: 4e54 2020 2320 7573 6520 2770 7269 6e74  NT  # use 'print
+000017f0: 2720 6279 2064 6566 6175 6c74 2077 6974  ' by default wit
+00001800: 6820 2d2d 7665 7273 696f 6e0a 5345 545f  h --version.SET_
+00001810: 4445 5649 4345 5f4e 414d 455f 554e 5553  DEVICE_NAME_UNUS
+00001820: 4544 5f44 4546 4155 4c54 203d 204e 6f6e  ED_DEFAULT = Non
+00001830: 6520 2023 2075 7365 204e 6f6e 6520 6966  e  # use None if
+00001840: 206f 7074 696f 6e20 6973 206e 6f74 2073   option is not s
+00001850: 7065 6369 6669 6564 0a53 4554 5f44 4953  pecified.SET_DIS
+00001860: 504c 4159 5f4e 414d 455f 554e 5553 4544  PLAY_NAME_UNUSED
+00001870: 5f44 4546 4155 4c54 203d 204e 6f6e 6520  _DEFAULT = None 
+00001880: 2023 2075 7365 204e 6f6e 6520 6f70 7469   # use None opti
+00001890: 6f6e 206e 6f74 2075 7365 640a 4e4f 5f53  on not used.NO_S
+000018a0: 534c 5f55 4e55 5345 445f 4445 4641 554c  SL_UNUSED_DEFAUL
+000018b0: 5420 3d20 4e6f 6e65 2020 2320 7573 6520  T = None  # use 
+000018c0: 4e6f 6e65 2069 6620 2d2d 6e6f 2d73 736c  None if --no-ssl
+000018d0: 2069 7320 6e6f 7420 6769 7665 6e0a 5353   is not given.SS
+000018e0: 4c5f 4345 5254 4946 4943 4154 455f 4445  L_CERTIFICATE_DE
+000018f0: 4641 554c 5420 3d20 4e6f 6e65 2020 2320  FAULT = None  # 
+00001900: 7573 6520 4e6f 6e65 2069 6620 2d2d 7373  use None if --ss
+00001910: 6c2d 6365 7274 6966 6963 6174 6520 6973  l-certificate is
+00001920: 206e 6f74 2067 6976 656e 0a4d 5843 5f49   not given.MXC_I
+00001930: 445f 504c 4143 4548 4f4c 4445 5220 3d20  D_PLACEHOLDER = 
+00001940: 225f 5f6d 7863 5f69 645f 5f22 0a48 4f4d  "__mxc_id__".HOM
+00001950: 4553 4552 5645 525f 504c 4143 4548 4f4c  ESERVER_PLACEHOL
+00001960: 4445 5220 3d20 225f 5f68 6f6d 6573 6572  DER = "__homeser
+00001970: 7665 725f 5f22 2020 2320 6c69 6b65 2068  ver__"  # like h
+00001980: 7474 7073 3a2f 2f6d 6174 7269 782e 6578  ttps://matrix.ex
+00001990: 616d 706c 652e 6f72 670a 484f 5354 4e41  ample.org.HOSTNA
+000019a0: 4d45 5f50 4c41 4345 484f 4c44 4552 203d  ME_PLACEHOLDER =
+000019b0: 2022 5f5f 686f 7374 6e61 6d65 5f5f 2220   "__hostname__" 
+000019c0: 2023 206c 696b 6520 6d61 7472 6978 2e65   # like matrix.e
+000019d0: 7861 6d70 6c65 2e6f 7267 0a41 4343 4553  xample.org.ACCES
+000019e0: 535f 544f 4b45 4e5f 504c 4143 4548 4f4c  S_TOKEN_PLACEHOL
+000019f0: 4445 5220 3d20 225f 5f61 6363 6573 735f  DER = "__access_
+00001a00: 746f 6b65 6e5f 5f22 0a55 5345 525f 4944  token__".USER_ID
+00001a10: 5f50 4c41 4345 484f 4c44 4552 203d 2022  _PLACEHOLDER = "
+00001a20: 5f5f 7573 6572 5f69 645f 5f22 2020 2320  __user_id__"  # 
+00001a30: 6c69 6b65 2040 206d 633a 206d 6174 7269  like @ mc: matri
+00001a40: 782e 6578 616d 706c 652e 636f 6d0a 4445  x.example.com.DE
+00001a50: 5649 4345 5f49 445f 504c 4143 4548 4f4c  VICE_ID_PLACEHOL
+00001a60: 4445 5220 3d20 225f 5f64 6576 6963 655f  DER = "__device_
+00001a70: 6964 5f5f 220a 524f 4f4d 5f49 445f 504c  id__".ROOM_ID_PL
+00001a80: 4143 4548 4f4c 4445 5220 3d20 225f 5f72  ACEHOLDER = "__r
+00001a90: 6f6f 6d5f 6964 5f5f 220a 5359 4e43 5f46  oom_id__".SYNC_F
+00001aa0: 554c 4c20 3d20 2266 756c 6c22 2020 2320  ULL = "full"  # 
+00001ab0: 7379 6e63 2077 6974 6820 6675 6c6c 5f73  sync with full_s
+00001ac0: 7461 7465 3d54 7275 6520 666f 7220 7365  tate=True for se
+00001ad0: 6e64 2061 6374 696f 6e73 0a23 2053 594e  nd actions.# SYN
+00001ae0: 435f 5041 5254 4941 4c20 3d20 2266 756c  C_PARTIAL = "ful
+00001af0: 6c22 2023 2073 796e 6320 7769 7468 2066  l" # sync with f
+00001b00: 756c 6c5f 7374 6174 653d 4661 6c73 6520  ull_state=False 
+00001b10: 666f 7220 7365 6e64 2061 6374 696f 6e73  for send actions
+00001b20: 0a53 594e 435f 4f46 4620 3d20 226f 6666  .SYNC_OFF = "off
+00001b30: 2220 2023 206e 6f20 7379 6e63 2069 7320  "  # no sync is 
+00001b40: 646f 6e65 2066 6f72 2073 656e 6420 6163  done for send ac
+00001b50: 7469 6f6e 730a 5359 4e43 5f44 4546 4155  tions.SYNC_DEFAU
+00001b60: 4c54 203d 2053 594e 435f 4655 4c4c 0a23  LT = SYNC_FULL.#
+00001b70: 2074 6578 742c 2069 6e74 656e 6465 6420   text, intended 
+00001b80: 666f 7220 6875 6d61 6e20 636f 6e73 756d  for human consum
+00001b90: 7074 696f 6e0a 4f55 5450 5554 5f54 4558  ption.OUTPUT_TEX
+00001ba0: 5420 3d20 2274 6578 7422 0a23 206a 736f  T = "text".# jso
+00001bb0: 6e2c 2061 7320 636c 6f73 6520 746f 2061  n, as close to a
+00001bc0: 7320 7768 6174 204e 494f 2041 5049 2070  s what NIO API p
+00001bd0: 726f 7669 6465 732c 2061 2066 6577 2063  rovides, a few c
+00001be0: 6f6e 7665 6e69 656e 7420 6669 656c 6473  onvenient fields
+00001bf0: 2061 6464 6564 0a23 2074 7261 6e73 706f   added.# transpo
+00001c00: 7274 5f72 6573 706f 6e73 6520 7265 6d6f  rt_response remo
+00001c10: 7665 640a 4f55 5450 5554 5f4a 534f 4e20  ved.OUTPUT_JSON 
+00001c20: 3d20 226a 736f 6e22 0a23 206a 736f 6e2d  = "json".# json-
+00001c30: 6d61 782c 206a 736f 6e20 666f 726d 6174  max, json format
+00001c40: 2c20 6c69 6b65 2022 6a73 6f6e 2220 6275  , like "json" bu
+00001c50: 7420 7769 7468 2074 7261 6e73 706f 7274  t with transport
+00001c60: 5f72 6573 706f 6e73 6520 6f62 6a65 6374  _response object
+00001c70: 2061 6464 6564 0a4f 5554 5055 545f 4a53   added.OUTPUT_JS
+00001c80: 4f4e 5f4d 4158 203d 2022 6a73 6f6e 2d6d  ON_MAX = "json-m
+00001c90: 6178 220a 2320 6a73 6f6e 2d73 7065 632c  ax".# json-spec,
+00001ca0: 206a 736f 6e20 666f 726d 6174 2c20 6966   json format, if
+00001cb0: 2061 6e64 206f 6e6c 7920 6966 206f 7574   and only if out
+00001cc0: 7075 7420 6164 6865 7265 7320 3130 3025  put adheres 100%
+00001cd0: 2074 6f20 4d61 7472 6978 0a23 2053 7065   to Matrix.# Spe
+00001ce0: 6369 6669 6361 7469 6f6e 2077 696c 6c20  cification will 
+00001cf0: 7468 6520 6461 7461 2062 6520 7072 696e  the data be prin
+00001d00: 7465 642e 2043 7572 7265 6e74 6c79 2c20  ted. Currently, 
+00001d10: 6f6e 6c79 202d 2d6c 6973 7465 6e20 282d  only --listen (-
+00001d20: 2d74 6169 6c29 0a23 2061 6468 6572 6520  -tail).# adhere 
+00001d30: 746f 2053 7065 6320 616e 6420 6865 6e63  to Spec and henc
+00001d40: 6520 7072 696e 7420 6120 4a53 4f4e 206f  e print a JSON o
+00001d50: 626a 6563 742e 2041 6c6c 206f 7468 6572  bject. All other
+00001d60: 2070 7269 6e74 206e 6f74 6869 6e67 2e0a   print nothing..
+00001d70: 4f55 5450 5554 5f4a 534f 4e5f 5350 4543  OUTPUT_JSON_SPEC
+00001d80: 203d 2022 6a73 6f6e 2d73 7065 6322 0a4f   = "json-spec".O
+00001d90: 5554 5055 545f 4445 4641 554c 5420 3d20  UTPUT_DEFAULT = 
+00001da0: 4f55 5450 5554 5f54 4558 540a 2320 6c6f  OUTPUT_TEXT.# lo
+00001db0: 6361 7469 6f6e 206f 6620 5245 4144 4d45  cation of README
+00001dc0: 2e6d 6420 6669 6c65 2069 6620 6974 2069  .md file if it i
+00001dd0: 7320 6e6f 7420 666f 756e 6420 6f6e 206c  s not found on l
+00001de0: 6f63 616c 2068 6172 6464 6973 6b0a 2320  ocal harddisk.# 
+00001df0: 7573 6564 2066 6f72 202d 2d6d 616e 7561  used for --manua
+00001e00: 6c0a 5245 4144 4d45 5f46 494c 455f 5241  l.README_FILE_RA
+00001e10: 575f 5552 4c20 3d20 280a 2020 2020 2268  W_URL = (.    "h
+00001e20: 7474 7073 3a2f 2f72 6177 2e67 6974 6875  ttps://raw.githu
+00001e30: 6275 7365 7263 6f6e 7465 6e74 2e63 6f6d  busercontent.com
+00001e40: 2f38 676f 2f6d 6174 7269 782d 636f 6d6d  /8go/matrix-comm
+00001e50: 616e 6465 722f 6d61 7374 6572 2f52 4541  ander/master/REA
+00001e60: 444d 452e 6d64 220a 290a 2320 696e 6372  DME.md".).# incr
+00001e70: 656d 656e 7420 7468 6973 206e 756d 6265  ement this numbe
+00001e80: 7220 616e 6420 7573 6520 6e65 7720 696e  r and use new in
+00001e90: 6372 656d 656e 7465 6420 6e75 6d62 6572  cremented number
+00001ea0: 2066 6f72 206e 6578 7420 7761 726e 696e   for next warnin
+00001eb0: 670a 2320 6c61 7374 2075 6e69 7175 6520  g.# last unique 
+00001ec0: 5778 7878 2077 6172 6e69 6e67 206e 756d  Wxxx warning num
+00001ed0: 6265 7220 7573 6564 3a20 5731 3132 3a0a  ber used: W112:.
+00001ee0: 2320 696e 6372 656d 656e 7420 7468 6973  # increment this
+00001ef0: 206e 756d 6265 7220 616e 6420 7573 6520   number and use 
+00001f00: 6e65 7720 696e 6372 656d 656e 7465 6420  new incremented 
+00001f10: 6e75 6d62 6572 2066 6f72 206e 6578 7420  number for next 
+00001f20: 6572 726f 720a 2320 6c61 7374 2075 6e69  error.# last uni
+00001f30: 7175 6520 4578 7878 2065 7272 6f72 206e  que Exxx error n
+00001f40: 756d 6265 7220 7573 6564 3a20 4532 3438  umber used: E248
+00001f50: 3a0a 0a0a 636c 6173 7320 4c6f 6f73 6556  :...class LooseV
+00001f60: 6572 7369 6f6e 3a0a 2020 2020 2222 2256  ersion:.    """V
+00001f70: 6572 7369 6f6e 206e 756d 6265 7269 6e67  ersion numbering
+00001f80: 2061 6e64 2063 6f6d 7061 7269 736f 6e2e   and comparison.
+00001f90: 0a20 2020 2053 6565 2068 7474 7073 3a2f  .    See https:/
+00001fa0: 2f67 6974 6875 622e 636f 6d2f 6566 6669  /github.com/effi
+00001fb0: 6769 6573 2f6c 6f6f 7365 7665 7273 696f  gies/looseversio
+00001fc0: 6e2f 626c 6f62 2f6d 6169 6e2f 6c6f 6f73  n/blob/main/loos
+00001fd0: 6576 6572 7369 6f6e 2e70 792e 0a20 2020  eversion.py..   
+00001fe0: 2041 7267 756d 656e 7420 276f 7468 6572   Argument 'other
+00001ff0: 2720 6d75 7374 2062 6520 6f66 2074 7970  ' must be of typ
+00002000: 6520 4c6f 6f73 6556 6572 7369 6f6e 2e0a  e LooseVersion..
+00002010: 2020 2020 2222 220a 0a20 2020 2063 6f6d      """..    com
+00002020: 706f 6e65 6e74 5f72 6520 3d20 7265 2e63  ponent_re = re.c
+00002030: 6f6d 7069 6c65 2872 2228 5c64 2b20 7c20  ompile(r"(\d+ | 
+00002040: 5b61 2d7a 5d2b 207c 205c 2e29 222c 2072  [a-z]+ | \.)", r
+00002050: 652e 5645 5242 4f53 4529 0a0a 2020 2020  e.VERBOSE)..    
+00002060: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+00002070: 662c 2076 7374 7269 6e67 3d4e 6f6e 6529  f, vstring=None)
+00002080: 3a0a 2020 2020 2020 2020 6966 2076 7374  :.        if vst
+00002090: 7269 6e67 3a0a 2020 2020 2020 2020 2020  ring:.          
+000020a0: 2020 7365 6c66 2e70 6172 7365 2876 7374    self.parse(vst
+000020b0: 7269 6e67 290a 0a20 2020 2064 6566 205f  ring)..    def _
+000020c0: 5f65 715f 5f28 7365 6c66 2c20 6f74 6865  _eq__(self, othe
+000020d0: 7229 3a0a 2020 2020 2020 2020 7265 7475  r):.        retu
+000020e0: 726e 2073 656c 662e 5f63 6d70 286f 7468  rn self._cmp(oth
+000020f0: 6572 2920 3d3d 2030 0a0a 2020 2020 6465  er) == 0..    de
+00002100: 6620 5f5f 6c74 5f5f 2873 656c 662c 206f  f __lt__(self, o
+00002110: 7468 6572 293a 0a20 2020 2020 2020 2072  ther):.        r
+00002120: 6574 7572 6e20 7365 6c66 2e5f 636d 7028  eturn self._cmp(
+00002130: 6f74 6865 7229 203c 2030 0a0a 2020 2020  other) < 0..    
+00002140: 6465 6620 5f5f 6c65 5f5f 2873 656c 662c  def __le__(self,
+00002150: 206f 7468 6572 293a 0a20 2020 2020 2020   other):.       
+00002160: 2072 6574 7572 6e20 7365 6c66 2e5f 636d   return self._cm
+00002170: 7028 6f74 6865 7229 203c 3d20 300a 0a20  p(other) <= 0.. 
+00002180: 2020 2064 6566 205f 5f67 745f 5f28 7365     def __gt__(se
+00002190: 6c66 2c20 6f74 6865 7229 3a0a 2020 2020  lf, other):.    
+000021a0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+000021b0: 5f63 6d70 286f 7468 6572 2920 3e20 300a  _cmp(other) > 0.
+000021c0: 0a20 2020 2064 6566 205f 5f67 655f 5f28  .    def __ge__(
+000021d0: 7365 6c66 2c20 6f74 6865 7229 3a0a 2020  self, other):.  
+000021e0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+000021f0: 662e 5f63 6d70 286f 7468 6572 2920 3e3d  f._cmp(other) >=
+00002200: 2030 0a0a 2020 2020 6465 6620 7061 7273   0..    def pars
+00002210: 6528 7365 6c66 2c20 7673 7472 696e 6729  e(self, vstring)
+00002220: 3a0a 2020 2020 2020 2020 7365 6c66 2e76  :.        self.v
+00002230: 7374 7269 6e67 203d 2076 7374 7269 6e67  string = vstring
+00002240: 0a20 2020 2020 2020 2063 6f6d 706f 6e65  .        compone
+00002250: 6e74 7320 3d20 5b0a 2020 2020 2020 2020  nts = [.        
+00002260: 2020 2020 7820 666f 7220 7820 696e 2073      x for x in s
+00002270: 656c 662e 636f 6d70 6f6e 656e 745f 7265  elf.component_re
+00002280: 2e73 706c 6974 2876 7374 7269 6e67 2920  .split(vstring) 
+00002290: 6966 2078 2061 6e64 2078 2021 3d20 222e  if x and x != ".
+000022a0: 220a 2020 2020 2020 2020 5d0a 2020 2020  ".        ].    
+000022b0: 2020 2020 666f 7220 692c 206f 626a 2069      for i, obj i
+000022c0: 6e20 656e 756d 6572 6174 6528 636f 6d70  n enumerate(comp
+000022d0: 6f6e 656e 7473 293a 0a20 2020 2020 2020  onents):.       
+000022e0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+000022f0: 2020 2020 2020 2020 2020 636f 6d70 6f6e            compon
+00002300: 656e 7473 5b69 5d20 3d20 696e 7428 6f62  ents[i] = int(ob
+00002310: 6a29 0a20 2020 2020 2020 2020 2020 2065  j).            e
+00002320: 7863 6570 7420 5661 6c75 6545 7272 6f72  xcept ValueError
+00002330: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00002340: 2020 7061 7373 0a20 2020 2020 2020 2073    pass.        s
+00002350: 656c 662e 7665 7273 696f 6e20 3d20 636f  elf.version = co
+00002360: 6d70 6f6e 656e 7473 0a0a 2020 2020 6465  mponents..    de
+00002370: 6620 5f5f 7374 725f 5f28 7365 6c66 293a  f __str__(self):
+00002380: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00002390: 7365 6c66 2e76 7374 7269 6e67 0a0a 2020  self.vstring..  
+000023a0: 2020 6465 6620 5f5f 7265 7072 5f5f 2873    def __repr__(s
+000023b0: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
+000023c0: 7475 726e 2022 4c6f 6f73 6556 6572 7369  turn "LooseVersi
+000023d0: 6f6e 2028 2725 7327 2922 2025 2073 7472  on ('%s')" % str
+000023e0: 2873 656c 6629 0a0a 2020 2020 6465 6620  (self)..    def 
+000023f0: 5f63 6d70 2873 656c 662c 206f 7468 6572  _cmp(self, other
+00002400: 293a 0a20 2020 2020 2020 2069 6620 7365  ):.        if se
+00002410: 6c66 2e76 6572 7369 6f6e 203d 3d20 6f74  lf.version == ot
+00002420: 6865 722e 7665 7273 696f 6e3a 0a20 2020  her.version:.   
+00002430: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00002440: 300a 2020 2020 2020 2020 6966 2073 656c  0.        if sel
+00002450: 662e 7665 7273 696f 6e20 3c20 6f74 6865  f.version < othe
+00002460: 722e 7665 7273 696f 6e3a 0a20 2020 2020  r.version:.     
+00002470: 2020 2020 2020 2072 6574 7572 6e20 2d31         return -1
+00002480: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00002490: 2e76 6572 7369 6f6e 203e 206f 7468 6572  .version > other
+000024a0: 2e76 6572 7369 6f6e 3a0a 2020 2020 2020  .version:.      
+000024b0: 2020 2020 2020 7265 7475 726e 2031 0a0a        return 1..
+000024c0: 0a63 6c61 7373 204d 6174 7269 7843 6f6d  .class MatrixCom
+000024d0: 6d61 6e64 6572 4572 726f 7228 4578 6365  manderError(Exce
+000024e0: 7074 696f 6e29 3a0a 2020 2020 7061 7373  ption):.    pass
+000024f0: 0a0a 0a63 6c61 7373 204d 6174 7269 7843  ...class MatrixC
+00002500: 6f6d 6d61 6e64 6572 5761 726e 696e 6728  ommanderWarning(
+00002510: 5761 726e 696e 6729 3a0a 2020 2020 7061  Warning):.    pa
+00002520: 7373 0a0a 0a63 6c61 7373 2047 6c6f 6261  ss...class Globa
+00002530: 6c53 7461 7465 3a0a 2020 2020 2222 224b  lState:.    """K
+00002540: 6565 7020 676c 6f62 616c 2076 6172 6961  eep global varia
+00002550: 626c 6573 2e0a 0a20 2020 2054 7269 7669  bles...    Trivi
+00002560: 616c 2063 6c61 7373 2074 6f20 6865 6c70  al class to help
+00002570: 206b 6565 7020 736f 6d65 2067 6c6f 6261   keep some globa
+00002580: 6c20 7374 6174 652e 0a20 2020 2022 2222  l state..    """
+00002590: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+000025a0: 5f5f 2873 656c 6629 3a0a 2020 2020 2020  __(self):.      
+000025b0: 2020 2222 2253 746f 7265 2067 6c6f 6261    """Store globa
+000025c0: 6c20 7374 6174 652e 2222 220a 2020 2020  l state.""".    
+000025d0: 2020 2020 7365 6c66 2e6c 6f67 3a20 6c6f      self.log: lo
+000025e0: 6767 696e 672e 4c6f 6767 6572 203d 204e  gging.Logger = N
+000025f0: 6f6e 6520 2023 206c 6f67 6765 7220 6f62  one  # logger ob
+00002600: 6a65 6374 0a20 2020 2020 2020 2073 656c  ject.        sel
+00002610: 662e 7061 3a20 6172 6770 6172 7365 2e4e  f.pa: argparse.N
+00002620: 616d 6573 7061 6365 203d 204e 6f6e 6520  amespace = None 
+00002630: 2023 2070 6172 7365 6420 6172 6775 6d65   # parsed argume
+00002640: 6e74 730a 2020 2020 2020 2020 2320 746f  nts.        # to
+00002650: 2077 6869 6368 206c 6f67 6963 2028 6d65   which logic (me
+00002660: 7373 6167 652c 2069 6d61 6765 2c20 6175  ssage, image, au
+00002670: 6469 6f2c 2066 696c 652c 2065 7665 6e74  dio, file, event
+00002680: 2920 6973 0a20 2020 2020 2020 2023 2073  ) is.        # s
+00002690: 7464 696e 2070 6970 6520 6173 7369 676e  tdin pipe assign
+000026a0: 6564 3f0a 2020 2020 2020 2020 7365 6c66  ed?.        self
+000026b0: 2e73 7464 696e 5f75 7365 3a20 7374 7220  .stdin_use: str 
+000026c0: 3d20 226e 6f6e 6522 0a20 2020 2020 2020  = "none".       
+000026d0: 2023 2031 2920 7373 6c20 4e6f 6e65 206d   # 1) ssl None m
+000026e0: 6561 6e73 2064 6566 6175 6c74 2053 534c  eans default SSL
+000026f0: 2063 6f6e 7465 7874 2077 696c 6c20 6265   context will be
+00002700: 2075 7365 642e 0a20 2020 2020 2020 2023   used..        #
+00002710: 2032 2920 7373 6c20 4661 6c73 6520 6d65   2) ssl False me
+00002720: 616e 7320 5353 4c20 6365 7274 6966 6963  ans SSL certific
+00002730: 6174 6520 7661 6c69 6461 7469 6f6e 2077  ate validation w
+00002740: 696c 6c20 6265 2073 6b69 7070 6564 0a20  ill be skipped. 
+00002750: 2020 2020 2020 2023 2033 2920 7373 6c20         # 3) ssl 
+00002760: 6120 7661 6c69 6420 5353 4c43 6f6e 7465  a valid SSLConte
+00002770: 7874 206d 6561 6e73 2074 6861 7420 7468  xt means that th
+00002780: 6520 7370 6563 6966 6965 6420 636f 6e74  e specified cont
+00002790: 6578 7420 7769 6c6c 2062 650a 2020 2020  ext will be.    
+000027a0: 2020 2020 2320 2020 2075 7365 642e 2054      #    used. T
+000027b0: 6869 7320 6973 2075 7365 6675 6c20 746f  his is useful to
+000027c0: 2075 7369 6e67 206c 6f63 616c 2053 534c   using local SSL
+000027d0: 2063 6572 7469 6669 6361 7465 2e0a 2020   certificate..  
+000027e0: 2020 2020 2020 7365 6c66 2e73 736c 3a20        self.ssl: 
+000027f0: 556e 696f 6e5b 4e6f 6e65 2c20 5353 4c43  Union[None, SSLC
+00002800: 6f6e 7465 7874 2c20 626f 6f6c 5d20 3d20  ontext, bool] = 
+00002810: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
+00002820: 662e 636c 6965 6e74 3a20 556e 696f 6e5b  f.client: Union[
+00002830: 4e6f 6e65 2c20 4173 796e 6343 6c69 656e  None, AsyncClien
+00002840: 745d 203d 204e 6f6e 650a 2020 2020 2020  t] = None.      
+00002850: 2020 7365 6c66 2e63 7265 6465 6e74 6961    self.credentia
+00002860: 6c73 3a20 556e 696f 6e5b 4e6f 6e65 2c20  ls: Union[None, 
+00002870: 6469 6374 5d20 3d20 4e6f 6e65 0a20 2020  dict] = None.   
+00002880: 2020 2020 2073 656c 662e 7365 6e64 5f61       self.send_a
+00002890: 6374 696f 6e20 3d20 4661 6c73 6520 2023  ction = False  #
+000028a0: 2061 7267 7620 636f 6e74 6169 6e73 2073   argv contains s
+000028b0: 656e 6420 6163 7469 6f6e 0a20 2020 2020  end action.     
+000028c0: 2020 2073 656c 662e 6c69 7374 656e 5f61     self.listen_a
+000028d0: 6374 696f 6e20 3d20 4661 6c73 6520 2023  ction = False  #
+000028e0: 2061 7267 7620 636f 6e74 6169 6e73 206c   argv contains l
+000028f0: 6973 7465 6e20 6163 7469 6f6e 0a20 2020  isten action.   
+00002900: 2020 2020 2073 656c 662e 726f 6f6d 5f61       self.room_a
+00002910: 6374 696f 6e20 3d20 4661 6c73 6520 2023  ction = False  #
+00002920: 2061 7267 7620 636f 6e74 6169 6e73 2072   argv contains r
+00002930: 6f6f 6d20 6163 7469 6f6e 0a20 2020 2020  oom action.     
+00002940: 2020 2073 656c 662e 7365 745f 6163 7469     self.set_acti
+00002950: 6f6e 203d 2046 616c 7365 2020 2320 6172  on = False  # ar
+00002960: 6776 2063 6f6e 7461 696e 7320 7365 7420  gv contains set 
+00002970: 6163 7469 6f6e 0a20 2020 2020 2020 2073  action.        s
+00002980: 656c 662e 6765 745f 6163 7469 6f6e 203d  elf.get_action =
+00002990: 2046 616c 7365 2020 2320 6172 6776 2063   False  # argv c
+000029a0: 6f6e 7461 696e 7320 6765 7420 6163 7469  ontains get acti
+000029b0: 6f6e 0a20 2020 2020 2020 2073 656c 662e  on.        self.
+000029c0: 7365 7467 6574 5f61 6374 696f 6e20 3d20  setget_action = 
+000029d0: 4661 6c73 6520 2023 2061 7267 7620 636f  False  # argv co
+000029e0: 6e74 6169 6e73 2073 6574 206f 7220 6765  ntains set or ge
+000029f0: 7420 6163 7469 6f6e 0a20 2020 2020 2020  t action.       
+00002a00: 2073 656c 662e 6572 725f 636f 756e 7420   self.err_count 
+00002a10: 3d20 3020 2023 2068 6f77 206d 616e 7920  = 0  # how many 
+00002a20: 6572 726f 7273 2068 6176 6520 6f63 6375  errors have occu
+00002a30: 7272 6564 2073 6f20 6661 720a 2020 2020  rred so far.    
+00002a40: 2020 2020 7365 6c66 2e77 6172 6e5f 636f      self.warn_co
+00002a50: 756e 7420 3d20 3020 2023 2068 6f77 206d  unt = 0  # how m
+00002a60: 616e 7920 7761 726e 696e 6773 2068 6176  any warnings hav
+00002a70: 6520 6f63 6375 7272 6564 2073 6f20 6661  e occurred so fa
+00002a80: 720a 0a0a 2320 436f 6e76 6572 7420 4e6f  r...# Convert No
+00002a90: 6e65 2074 6f20 2222 2c20 7573 6566 756c  ne to "", useful
+00002aa0: 2077 6865 6e20 7265 706f 7274 696e 6720   when reporting 
+00002ab0: 7661 6c75 6573 2074 6f20 7374 646f 7574  values to stdout
+00002ac0: 0a23 2053 686f 756c 6420 6f6e 6c79 2062  .# Should only b
+00002ad0: 6520 6361 6c6c 6564 2077 6974 6820 6129  e called with a)
+00002ae0: 204e 6f6e 6520 6f72 2062 2920 6120 7374   None or b) a st
+00002af0: 7269 6e67 2e0a 2320 5765 2077 616e 7420  ring..# We want 
+00002b00: 746f 2061 766f 6964 2073 6974 7561 7469  to avoid situati
+00002b10: 6f6e 2077 6865 7265 2077 6520 776f 756c  on where we woul
+00002b20: 6420 7072 696e 743a 206e 616d 6520 3d20  d print: name = 
+00002b30: 4e6f 6e65 0a64 6566 207a 6e28 7374 7229  None.def zn(str)
+00002b40: 3a0a 2020 2020 7265 7475 726e 2073 7472  :.    return str
+00002b50: 206f 7220 2222 0a0a 0a64 6566 2067 6574   or ""...def get
+00002b60: 5f71 7561 6c69 6669 6564 636c 6173 736e  _qualifiedclassn
+00002b70: 616d 6528 6f62 6a29 3a0a 2020 2020 6b6c  ame(obj):.    kl
+00002b80: 6173 7320 3d20 6f62 6a2e 5f5f 636c 6173  ass = obj.__clas
+00002b90: 735f 5f0a 2020 2020 6d6f 6475 6c65 203d  s__.    module =
+00002ba0: 206b 6c61 7373 2e5f 5f6d 6f64 756c 655f   klass.__module_
+00002bb0: 5f0a 2020 2020 6966 206d 6f64 756c 6520  _.    if module 
+00002bc0: 3d3d 2022 6275 696c 7469 6e73 223a 0a20  == "builtins":. 
+00002bd0: 2020 2020 2020 2072 6574 7572 6e20 6b6c         return kl
+00002be0: 6173 732e 5f5f 7175 616c 6e61 6d65 5f5f  ass.__qualname__
+00002bf0: 2020 2320 6176 6f69 6420 6f75 7470 7574    # avoid output
+00002c00: 7320 6c69 6b65 2027 6275 696c 7469 6e73  s like 'builtins
+00002c10: 2e73 7472 270a 2020 2020 7265 7475 726e  .str'.    return
+00002c20: 206d 6f64 756c 6520 2b20 222e 2220 2b20   module + "." + 
+00002c30: 6b6c 6173 732e 5f5f 7175 616c 6e61 6d65  klass.__qualname
+00002c40: 5f5f 0a0a 0a64 6566 2070 7269 7661 6379  __...def privacy
+00002c50: 5f66 696c 7465 7228 6469 7274 793a 2073  _filter(dirty: s
+00002c60: 7472 2920 2d3e 2073 7472 3a0a 2020 2020  tr) -> str:.    
+00002c70: 2222 2252 656d 6f76 6520 7072 6976 6174  """Remove privat
+00002c80: 6520 696e 666f 2066 726f 6d20 7374 7269  e info from stri
+00002c90: 6e67 2222 220a 2020 2020 2320 686f 6d65  ng""".    # home
+00002ca0: 7365 7276 6572 203d 2075 726c 7061 7273  server = urlpars
+00002cb0: 6528 6773 2e63 7265 6465 6e74 6961 6c73  e(gs.credentials
+00002cc0: 5b22 686f 6d65 7365 7276 6572 225d 290a  ["homeserver"]).
+00002cd0: 2020 2020 2320 7365 7276 6572 5f6e 616d      # server_nam
+00002ce0: 6520 3d20 686f 6d65 7365 7276 6572 2e6e  e = homeserver.n
+00002cf0: 6574 6c6f 630a 2020 2020 2320 636c 6561  etloc.    # clea
+00002d00: 6e20 3d20 6469 7274 792e 7265 706c 6163  n = dirty.replac
+00002d10: 6528 7365 7276 6572 5f6e 616d 652c 2022  e(server_name, "
+00002d20: 796f 7572 2e68 6f6d 6573 6572 7665 722e  your.homeserver.
+00002d30: 6f72 6722 290a 2020 2020 7265 7475 726e  org").    return
+00002d40: 2064 6972 7479 2e72 6570 6c61 6365 2867   dirty.replace(g
+00002d50: 732e 6372 6564 656e 7469 616c 735b 2261  s.credentials["a
+00002d60: 6363 6573 735f 746f 6b65 6e22 5d2c 2022  ccess_token"], "
+00002d70: 2a2a 2a22 290a 0a0a 6465 6620 7072 696e  ***")...def prin
+00002d80: 745f 6f75 7470 7574 280a 2020 2020 6f70  t_output(.    op
+00002d90: 7469 6f6e 3a20 4c69 7465 7261 6c5b 2274  tion: Literal["t
+00002da0: 6578 7422 2c20 226a 736f 6e22 2c20 226a  ext", "json", "j
+00002db0: 736f 6e2d 6d61 7822 2c20 226a 736f 6e2d  son-max", "json-
+00002dc0: 7370 6563 225d 2c0a 2020 2020 2a2c 0a20  spec"],.    *,. 
+00002dd0: 2020 2074 6578 743a 2073 7472 2c0a 2020     text: str,.  
+00002de0: 2020 6a73 6f6e 5f3a 2064 6963 7420 3d20    json_: dict = 
+00002df0: 4e6f 6e65 2c0a 2020 2020 6a73 6f6e 5f6d  None,.    json_m
+00002e00: 6178 3a20 6469 6374 203d 204e 6f6e 652c  ax: dict = None,
+00002e10: 0a20 2020 206a 736f 6e5f 7370 6563 3a20  .    json_spec: 
+00002e20: 6469 6374 203d 204e 6f6e 652c 0a29 202d  dict = None,.) -
+00002e30: 3e20 4e6f 6e65 3a0a 2020 2020 2222 2250  > None:.    """P
+00002e40: 7269 6e74 206f 7574 7075 7420 6163 636f  rint output acco
+00002e50: 7264 696e 6720 746f 2077 6869 6368 206f  rding to which o
+00002e60: 7074 696f 6e20 6973 2073 7065 6369 6669  ption is specifi
+00002e70: 6564 2077 6974 6820 2d2d 6f75 7470 7574  ed with --output
+00002e80: 2222 220a 2020 2020 2320 6a73 6f6e 5f20  """.    # json_ 
+00002e90: 6861 7320 7468 6520 756e 6465 7273 636f  has the undersco
+00002ea0: 7265 2074 6f20 6176 6f69 6420 6120 6e61  re to avoid a na
+00002eb0: 6d65 2063 6c61 7368 2077 6974 6820 7468  me clash with th
+00002ec0: 6520 6d6f 6475 6c65 206a 736f 6e0a 2020  e module json.  
+00002ed0: 2020 7265 7375 6c74 7320 3d20 7b0a 2020    results = {.  
+00002ee0: 2020 2020 2020 4f55 5450 5554 5f54 4558        OUTPUT_TEX
+00002ef0: 543a 2074 6578 742c 0a20 2020 2020 2020  T: text,.       
+00002f00: 204f 5554 5055 545f 4a53 4f4e 3a20 6a73   OUTPUT_JSON: js
+00002f10: 6f6e 5f2c 0a20 2020 2020 2020 204f 5554  on_,.        OUT
+00002f20: 5055 545f 4a53 4f4e 5f4d 4158 3a20 6a73  PUT_JSON_MAX: js
+00002f30: 6f6e 5f6d 6178 2c0a 2020 2020 2020 2020  on_max,.        
+00002f40: 4f55 5450 5554 5f4a 534f 4e5f 5350 4543  OUTPUT_JSON_SPEC
+00002f50: 3a20 6a73 6f6e 5f73 7065 632c 0a20 2020  : json_spec,.   
+00002f60: 207d 0a20 2020 2069 6620 7265 7375 6c74   }.    if result
+00002f70: 735b 6f70 7469 6f6e 5d20 6973 204e 6f6e  s[option] is Non
+00002f80: 653a 0a20 2020 2020 2020 2069 6620 6f70  e:.        if op
+00002f90: 7469 6f6e 203d 3d20 4f55 5450 5554 5f4a  tion == OUTPUT_J
+00002fa0: 534f 4e5f 5350 4543 3a0a 2020 2020 2020  SON_SPEC:.      
+00002fb0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+00002fc0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+00002fd0: 2020 2020 2241 7265 2079 6f75 2073 7572      "Are you sur
+00002fe0: 6520 796f 7520 7761 6e74 6564 2074 6f20  e you wanted to 
+00002ff0: 7573 6520 2d2d 6f75 7470 7574 206a 736f  use --output jso
+00003000: 6e2d 7370 6563 3f20 220a 2020 2020 2020  n-spec? ".      
+00003010: 2020 2020 2020 2020 2020 224d 6f73 7420            "Most 
+00003020: 6f75 7470 7574 7320 7769 6c6c 2062 6520  outputs will be 
+00003030: 656d 7074 792e 220a 2020 2020 2020 2020  empty.".        
+00003040: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
+00003050: 7475 726e 0a20 2020 2069 6620 6f70 7469  turn.    if opti
+00003060: 6f6e 203d 3d20 4f55 5450 5554 5f54 4558  on == OUTPUT_TEX
+00003070: 543a 0a20 2020 2020 2020 2070 7269 6e74  T:.        print
+00003080: 2872 6573 756c 7473 5b6f 7074 696f 6e5d  (results[option]
+00003090: 2c20 666c 7573 683d 5472 7565 290a 2020  , flush=True).  
+000030a0: 2020 656c 6966 206f 7074 696f 6e20 3d3d    elif option ==
+000030b0: 204f 5554 5055 545f 4a53 4f4e 5f53 5045   OUTPUT_JSON_SPE
+000030c0: 433a 0a20 2020 2020 2020 2070 7269 6e74  C:.        print
+000030d0: 286a 736f 6e2e 6475 6d70 7328 7265 7375  (json.dumps(resu
+000030e0: 6c74 735b 6f70 7469 6f6e 5d29 2c20 666c  lts[option]), fl
+000030f0: 7573 683d 5472 7565 290a 2020 2020 656c  ush=True).    el
+00003100: 7365 3a20 2023 204f 5554 5055 545f 4a53  se:  # OUTPUT_JS
+00003110: 4f4e 206f 7220 4f55 5450 5554 5f4a 534f  ON or OUTPUT_JSO
+00003120: 4e5f 4d41 580a 2020 2020 2020 2020 7072  N_MAX.        pr
+00003130: 696e 7428 6a73 6f6e 2e64 756d 7073 2872  int(json.dumps(r
+00003140: 6573 756c 7473 5b6f 7074 696f 6e5d 2c20  esults[option], 
+00003150: 6465 6661 756c 743d 6f62 6a5f 746f 5f64  default=obj_to_d
+00003160: 6963 7429 2c20 666c 7573 683d 5472 7565  ict), flush=True
+00003170: 290a 0a0a 6465 6620 6f62 6a5f 746f 5f64  )...def obj_to_d
+00003180: 6963 7428 6f62 6a29 3a0a 2020 2020 2222  ict(obj):.    ""
+00003190: 2252 6574 7572 6e20 6469 6374 206f 6620  "Return dict of 
+000031a0: 6f62 6a65 6374 0a0a 2020 2020 5573 6566  object..    Usef
+000031b0: 756c 2066 6f72 206a 736f 6e2e 6475 6d70  ul for json.dump
+000031c0: 2829 2064 6963 742d 746f 2d6a 736f 6e20  () dict-to-json 
+000031d0: 636f 6e76 6572 7369 6f6e 2e0a 2020 2020  conversion..    
+000031e0: 2222 220a 2020 2020 6966 2067 732e 7061  """.    if gs.pa
+000031f0: 2e76 6572 626f 7365 203e 2031 3a20 2023  .verbose > 1:  #
+00003200: 2032 2b0a 2020 2020 2020 2020 6773 2e6c   2+.        gs.l
+00003210: 6f67 2e64 6562 7567 2866 226f 626a 5f74  og.debug(f"obj_t
+00003220: 6f5f 6469 6374 3a20 7b6f 626a 2e5f 5f63  o_dict: {obj.__c
+00003230: 6c61 7373 5f5f 7d22 290a 2020 2020 2020  lass__}").      
+00003240: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
+00003250: 226f 626a 5f74 6f5f 6469 6374 3a20 7b6f  "obj_to_dict: {o
+00003260: 626a 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e  bj.__class__.__n
+00003270: 616d 655f 5f7d 2229 0a20 2020 2020 2020  ame__}").       
+00003280: 2067 732e 6c6f 672e 6465 6275 6728 6622   gs.log.debug(f"
+00003290: 6f62 6a5f 746f 5f64 6963 743a 207b 6765  obj_to_dict: {ge
+000032a0: 745f 7175 616c 6966 6965 6463 6c61 7373  t_qualifiedclass
+000032b0: 6e61 6d65 286f 626a 297d 2229 0a20 2020  name(obj)}").   
+000032c0: 2023 2073 756d 6d61 7279 3a20 7368 6f72   # summary: shor
+000032d0: 7463 7574 3a20 6a75 7374 2074 6865 7365  tcut: just these
+000032e0: 2032 3a20 5265 7175 6573 7449 6e66 6f20   2: RequestInfo 
+000032f0: 616e 6420 436c 6965 6e74 5265 7370 6f6e  and ClientRespon
+00003300: 7365 0a20 2020 2023 2069 6620 6765 745f  se.    # if get_
+00003310: 7175 616c 6966 6965 6463 6c61 7373 6e61  qualifiedclassna
+00003320: 6d65 286f 626a 2920 3d3d 2022 6169 6f68  me(obj) == "aioh
+00003330: 7474 702e 636c 6965 6e74 5f72 6571 7265  ttp.client_reqre
+00003340: 702e 5265 7175 6573 7449 6e66 6f22 3a0a  p.RequestInfo":.
+00003350: 2020 2020 2320 2020 2020 7265 7475 726e      #     return
+00003360: 207b 6f62 6a2e 5f5f 636c 6173 735f 5f2e   {obj.__class__.
+00003370: 5f5f 6e61 6d65 5f5f 3a20 7374 7228 6f62  __name__: str(ob
+00003380: 6a29 7d0a 2020 2020 2320 6966 2067 6574  j)}.    # if get
+00003390: 5f71 7561 6c69 6669 6564 636c 6173 736e  _qualifiedclassn
+000033a0: 616d 6528 6f62 6a29 203d 3d20 2261 696f  ame(obj) == "aio
+000033b0: 6874 7470 2e63 6c69 656e 745f 7265 7172  http.client_reqr
+000033c0: 6570 2e43 6c69 656e 7452 6573 706f 6e73  ep.ClientRespons
+000033d0: 6522 3a0a 2020 2020 2320 2020 2072 6574  e":.    #    ret
+000033e0: 7572 6e20 7b6f 626a 2e5f 5f63 6c61 7373  urn {obj.__class
+000033f0: 5f5f 2e5f 5f6e 616d 655f 5f3a 2073 7472  __.__name__: str
+00003400: 286f 626a 297d 0a20 2020 2023 2064 6574  (obj)}.    # det
+00003410: 6169 6c73 2c20 6f6e 6520 6279 206f 6e65  ails, one by one
+00003420: 3a0a 2020 2020 2320 6966 2067 6574 5f71  :.    # if get_q
+00003430: 7561 6c69 6669 6564 636c 6173 736e 616d  ualifiedclassnam
+00003440: 6528 6f62 6a29 203d 3d20 2263 6f6c 6c65  e(obj) == "colle
+00003450: 6374 696f 6e73 2e64 6571 7565 223a 0a20  ctions.deque":. 
+00003460: 2020 2023 2020 2020 2072 6574 7572 6e20     #     return 
+00003470: 7b6f 626a 2e5f 5f63 6c61 7373 5f5f 2e5f  {obj.__class__._
+00003480: 5f6e 616d 655f 5f3a 2073 7472 286f 626a  _name__: str(obj
+00003490: 297d 0a20 2020 2023 2069 6620 6765 745f  )}.    # if get_
+000034a0: 7175 616c 6966 6965 6463 6c61 7373 6e61  qualifiedclassna
+000034b0: 6d65 286f 626a 2920 3d3d 2022 6169 6f68  me(obj) == "aioh
+000034c0: 7474 702e 6865 6c70 6572 732e 5469 6d65  ttp.helpers.Time
+000034d0: 7243 6f6e 7465 7874 223a 0a20 2020 2023  rContext":.    #
+000034e0: 2020 2020 2072 6574 7572 6e20 7b6f 626a       return {obj
+000034f0: 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e 616d  .__class__.__nam
+00003500: 655f 5f3a 2073 7472 286f 626a 297d 0a20  e__: str(obj)}. 
+00003510: 2020 2023 2069 6620 6765 745f 7175 616c     # if get_qual
+00003520: 6966 6965 6463 6c61 7373 6e61 6d65 286f  ifiedclassname(o
+00003530: 626a 2920 3d3d 2022 6173 796e 6369 6f2e  bj) == "asyncio.
+00003540: 6576 656e 7473 2e54 696d 6572 4861 6e64  events.TimerHand
+00003550: 6c65 223a 0a20 2020 2023 2020 2020 2072  le":.    #     r
+00003560: 6574 7572 6e20 7b6f 626a 2e5f 5f63 6c61  eturn {obj.__cla
+00003570: 7373 5f5f 2e5f 5f6e 616d 655f 5f3a 2073  ss__.__name__: s
+00003580: 7472 286f 626a 297d 0a20 2020 2023 2069  tr(obj)}.    # i
+00003590: 6620 6765 745f 7175 616c 6966 6965 6463  f get_qualifiedc
+000035a0: 6c61 7373 6e61 6d65 286f 626a 2920 3d3d  lassname(obj) ==
+000035b0: 226d 756c 7469 6469 6374 2e5f 6d75 6c74  "multidict._mult
+000035c0: 6964 6963 742e 4349 4d75 6c74 6944 6963  idict.CIMultiDic
+000035d0: 7450 726f 7879 223a 0a20 2020 2023 2020  tProxy":.    #  
+000035e0: 2020 2072 6574 7572 6e20 7b6f 626a 2e5f     return {obj._
+000035f0: 5f63 6c61 7373 5f5f 2e5f 5f6e 616d 655f  _class__.__name_
+00003600: 5f3a 2073 7472 286f 626a 297d 0a20 2020  _: str(obj)}.   
+00003610: 2023 2069 6620 6765 745f 7175 616c 6966   # if get_qualif
+00003620: 6965 6463 6c61 7373 6e61 6d65 286f 626a  iedclassname(obj
+00003630: 2920 3d3d 2022 6169 6f73 6967 6e61 6c2e  ) == "aiosignal.
+00003640: 5369 676e 616c 223a 0a20 2020 2023 2020  Signal":.    #  
+00003650: 2020 2072 6574 7572 6e20 7b6f 626a 2e5f     return {obj._
+00003660: 5f63 6c61 7373 5f5f 2e5f 5f6e 616d 655f  _class__.__name_
+00003670: 5f3a 2073 7472 286f 626a 297d 0a20 2020  _: str(obj)}.   
+00003680: 2023 2074 6869 7320 6f6e 6520 6973 2063   # this one is c
+00003690: 7275 6369 616c 2c20 6974 206d 616b 6520  rucial, it make 
+000036a0: 7468 6520 7365 7269 616c 697a 6174 696f  the serializatio
+000036b0: 6e20 6369 7263 756c 6172 2072 6566 6572  n circular refer
+000036c0: 656e 6365 2e0a 2020 2020 6966 2067 6574  ence..    if get
+000036d0: 5f71 7561 6c69 6669 6564 636c 6173 736e  _qualifiedclassn
+000036e0: 616d 6528 6f62 6a29 203d 3d20 2261 696f  ame(obj) == "aio
+000036f0: 6874 7470 2e73 7472 6561 6d73 2e53 7472  http.streams.Str
+00003700: 6561 6d52 6561 6465 7222 3a0a 2020 2020  eamReader":.    
+00003710: 2020 2020 7265 7475 726e 207b 6f62 6a2e      return {obj.
+00003720: 5f5f 636c 6173 735f 5f2e 5f5f 6e61 6d65  __class__.__name
+00003730: 5f5f 3a20 7374 7228 6f62 6a29 7d0a 2020  __: str(obj)}.  
+00003740: 2020 2320 7468 6573 6520 666f 7572 2061    # these four a
+00003750: 7265 2063 7275 6369 616c 2c20 7468 6579  re crucial, they
+00003760: 206d 616b 6520 7468 6520 7365 7269 616c   make the serial
+00003770: 697a 6174 696f 6e20 6369 7263 756c 6172  ization circular
+00003780: 2072 6566 6572 656e 6365 2e0a 2020 2020   reference..    
+00003790: 6966 2028 0a20 2020 2020 2020 2067 6574  if (.        get
+000037a0: 5f71 7561 6c69 6669 6564 636c 6173 736e  _qualifiedclassn
+000037b0: 616d 6528 6f62 6a29 0a20 2020 2020 2020  ame(obj).       
+000037c0: 203d 3d20 2261 7379 6e63 696f 2e75 6e69   == "asyncio.uni
+000037d0: 785f 6576 656e 7473 2e5f 556e 6978 5365  x_events._UnixSe
+000037e0: 6c65 6374 6f72 4576 656e 744c 6f6f 7022  lectorEventLoop"
+000037f0: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+00003800: 7265 7475 726e 207b 6f62 6a2e 5f5f 636c  return {obj.__cl
+00003810: 6173 735f 5f2e 5f5f 6e61 6d65 5f5f 3a20  ass__.__name__: 
+00003820: 7374 7228 6f62 6a29 7d0a 2020 2020 6966  str(obj)}.    if
+00003830: 2067 6574 5f71 7561 6c69 6669 6564 636c   get_qualifiedcl
+00003840: 6173 736e 616d 6528 6f62 6a29 203d 3d20  assname(obj) == 
+00003850: 2261 696f 6874 7470 2e74 7261 6369 6e67  "aiohttp.tracing
+00003860: 2e54 7261 6365 223a 0a20 2020 2020 2020  .Trace":.       
+00003870: 2072 6574 7572 6e20 7b6f 626a 2e5f 5f63   return {obj.__c
+00003880: 6c61 7373 5f5f 2e5f 5f6e 616d 655f 5f3a  lass__.__name__:
+00003890: 2073 7472 286f 626a 297d 0a20 2020 2069   str(obj)}.    i
+000038a0: 6620 6765 745f 7175 616c 6966 6965 6463  f get_qualifiedc
+000038b0: 6c61 7373 6e61 6d65 286f 626a 2920 3d3d  lassname(obj) ==
+000038c0: 2022 6169 6f68 7474 702e 7472 6163 696e   "aiohttp.tracin
+000038d0: 672e 5472 6163 6543 6f6e 6669 6722 3a0a  g.TraceConfig":.
+000038e0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+000038f0: 6f62 6a2e 5f5f 636c 6173 735f 5f2e 5f5f  obj.__class__.__
+00003900: 6e61 6d65 5f5f 3a20 7374 7228 6f62 6a29  name__: str(obj)
+00003910: 7d0a 2020 2020 2320 6176 6f69 6420 226b  }.    # avoid "k
+00003920: 6579 7320 6d75 7374 2062 6520 7374 722c  eys must be str,
+00003930: 2069 6e74 2c20 666c 6f61 742c 2062 6f6f   int, float, boo
+00003940: 6c20 6f72 204e 6f6e 6522 2065 7272 6f72  l or None" error
+00003950: 730a 2020 2020 6966 2067 6574 5f71 7561  s.    if get_qua
+00003960: 6c69 6669 6564 636c 6173 736e 616d 6528  lifiedclassname(
+00003970: 6f62 6a29 203d 3d20 2261 696f 6874 7470  obj) == "aiohttp
+00003980: 2e63 6f6e 6e65 6374 6f72 2e54 4350 436f  .connector.TCPCo
+00003990: 6e6e 6563 746f 7222 3a0a 2020 2020 2020  nnector":.      
+000039a0: 2020 7265 7475 726e 207b 6f62 6a2e 5f5f    return {obj.__
+000039b0: 636c 6173 735f 5f2e 5f5f 6e61 6d65 5f5f  class__.__name__
+000039c0: 3a20 7374 7228 6f62 6a29 7d0a 0a20 2020  : str(obj)}..   
+000039d0: 2069 6620 6861 7361 7474 7228 6f62 6a2c   if hasattr(obj,
+000039e0: 2022 5f5f 6469 6374 5f5f 2229 3a0a 2020   "__dict__"):.  
+000039f0: 2020 2020 2020 6966 2028 0a20 2020 2020        if (.     
+00003a00: 2020 2020 2020 2022 696e 626f 756e 645f         "inbound_
+00003a10: 6772 6f75 705f 7374 6f72 6522 2069 6e20  group_store" in 
+00003a20: 6f62 6a2e 5f5f 6469 6374 5f5f 0a20 2020  obj.__dict__.   
+00003a30: 2020 2020 2020 2020 2061 6e64 2022 7365           and "se
+00003a40: 7373 696f 6e5f 7374 6f72 6522 2069 6e20  ssion_store" in 
+00003a50: 6f62 6a2e 5f5f 6469 6374 5f5f 0a20 2020  obj.__dict__.   
+00003a60: 2020 2020 2020 2020 2061 6e64 2022 6f75           and "ou
+00003a70: 7462 6f75 6e64 5f67 726f 7570 5f73 6573  tbound_group_ses
+00003a80: 7369 6f6e 7322 2069 6e20 6f62 6a2e 5f5f  sions" in obj.__
+00003a90: 6469 6374 5f5f 0a20 2020 2020 2020 2029  dict__.        )
+00003aa0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00003ab0: 226f 6c6d 2220 6973 2068 6967 652c 2031  "olm" is hige, 1
+00003ac0: 4d42 2b2c 2032 304b 206c 696e 6573 206f  MB+, 20K lines o
+00003ad0: 6620 4a53 4f4e 0a20 2020 2020 2020 2020  f JSON.         
+00003ae0: 2020 2023 2067 7261 6220 6f6e 6c79 2073     # grab only s
+00003af0: 6f6d 6520 6974 656d 730a 2020 2020 2020  ome items.      
+00003b00: 2020 2020 2020 2320 226f 6c6d 223a 207b        # "olm": {
+00003b10: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
+00003b20: 2022 7573 6572 5f69 6422 3a20 2240 7878   "user_id": "@xx
+00003b30: 783a 7878 782e 7878 782e 7878 7822 2c0a  x:xxx.xxx.xxx",.
+00003b40: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+00003b50: 2264 6576 6963 655f 6964 223a 2022 7878  "device_id": "xx
+00003b60: 7822 2c0a 2020 2020 2020 2020 2020 2020  x",.            
+00003b70: 2320 2020 2275 706c 6f61 6465 645f 6b65  #   "uploaded_ke
+00003b80: 795f 636f 756e 7422 3a20 3530 2c0a 2020  y_count": 50,.  
+00003b90: 2020 2020 2020 2020 2020 2320 2020 2275            #   "u
+00003ba0: 7365 7273 5f66 6f72 5f6b 6579 5f71 7565  sers_for_key_que
+00003bb0: 7279 223a 207b 0a20 2020 2020 2020 2020  ry": {.         
+00003bc0: 2020 2023 2020 2020 2022 7365 7422 3a20     #     "set": 
+00003bd0: 222e 2e2e 220a 2020 2020 2020 2020 2020  "...".          
+00003be0: 2020 2320 2020 7d2c 0a20 2020 2020 2020    #   },.       
+00003bf0: 2020 2020 2023 2020 2022 6465 7669 6365       #   "device
+00003c00: 5f73 746f 7265 223a 207b 0a20 2020 2020  _store": {.     
+00003c10: 2020 2020 2020 2023 2020 2020 2020 202e         #       .
+00003c20: 2e2e 2077 616e 740a 2020 2020 2020 2020  .. want.        
+00003c30: 2020 2020 2320 2020 7d2c 0a20 2020 2020      #   },.     
+00003c40: 2020 2020 2020 2023 2020 2022 7365 7373         #   "sess
+00003c50: 696f 6e5f 7374 6f72 6522 3a20 7b0a 2020  ion_store": {.  
+00003c60: 2020 2020 2020 2020 2020 2320 2020 2020            #     
+00003c70: 2020 2e2e 2e20 646f 6e74 2077 616e 742c    ... dont want,
+00003c80: 2074 6f6f 206c 6f6e 670a 2020 2020 2020   too long.      
+00003c90: 2020 2020 2020 2320 2020 7d2c 0a20 2020        #   },.   
+00003ca0: 2020 2020 2020 2020 2023 2020 2022 696e           #   "in
+00003cb0: 626f 756e 645f 6772 6f75 705f 7374 6f72  bound_group_stor
+00003cc0: 6522 3a20 7b0a 2020 2020 2020 2020 2020  e": {.          
+00003cd0: 2020 2320 2020 2020 2020 2e2e 2e20 646f    #       ... do
+00003ce0: 6e74 2077 616e 742c 2032 304b 206c 696e  nt want, 20K lin
+00003cf0: 6573 2c20 746f 6f20 6c6f 6e67 0a20 2020  es, too long.   
+00003d00: 2020 2020 2020 2020 2023 2020 207d 2c0a           #   },.
+00003d10: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+00003d20: 226f 7574 626f 756e 645f 6772 6f75 705f  "outbound_group_
+00003d30: 7365 7373 696f 6e73 223a 207b 7d2c 0a20  sessions": {},. 
+00003d40: 2020 2020 2020 2020 2020 2023 2020 2022             #   "
+00003d50: 7472 6163 6b65 645f 7573 6572 7322 3a20  tracked_users": 
+00003d60: 7b0a 2020 2020 2020 2020 2020 2020 2320  {.            # 
+00003d70: 2020 2020 2273 6574 223a 2022 7365 7428      "set": "set(
+00003d80: 2922 0a20 2020 2020 2020 2020 2020 2023  )".            #
+00003d90: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
+00003da0: 2020 6469 6374 636f 7079 203d 207b 7d0a    dictcopy = {}.
+00003db0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00003dc0: 6b65 7920 696e 205b 0a20 2020 2020 2020  key in [.       
+00003dd0: 2020 2020 2020 2020 2022 7573 6572 5f69           "user_i
+00003de0: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
+00003df0: 2020 2020 2264 6576 6963 655f 6964 222c      "device_id",
+00003e00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003e10: 2022 7570 6c6f 6164 6564 5f6b 6579 5f63   "uploaded_key_c
+00003e20: 6f75 6e74 222c 0a20 2020 2020 2020 2020  ount",.         
+00003e30: 2020 2020 2020 2022 7573 6572 735f 666f         "users_fo
+00003e40: 725f 6b65 795f 7175 6572 7922 2c0a 2020  r_key_query",.  
+00003e50: 2020 2020 2020 2020 2020 2020 2020 2264                "d
+00003e60: 6576 6963 655f 7374 6f72 6522 2c0a 2020  evice_store",.  
+00003e70: 2020 2020 2020 2020 2020 2020 2020 226f                "o
+00003e80: 7574 626f 756e 645f 6772 6f75 705f 7365  utbound_group_se
+00003e90: 7373 696f 6e73 222c 0a20 2020 2020 2020  ssions",.       
+00003ea0: 2020 2020 2020 2020 2022 7472 6163 6b65           "tracke
+00003eb0: 645f 7573 6572 7322 2c0a 2020 2020 2020  d_users",.      
+00003ec0: 2020 2020 2020 2020 2020 226f 7574 676f            "outgo
+00003ed0: 696e 675f 6b65 795f 7265 7175 6573 7473  ing_key_requests
+00003ee0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00003ef0: 2020 2022 7265 6365 6976 6564 5f6b 6579     "received_key
+00003f00: 5f72 6571 7565 7374 7322 2c0a 2020 2020  _requests",.    
+00003f10: 2020 2020 2020 2020 2020 2020 226b 6579              "key
+00003f20: 5f72 6571 7565 7374 735f 7761 6974 696e  _requests_waitin
+00003f30: 675f 666f 725f 7365 7373 696f 6e22 2c0a  g_for_session",.
+00003f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003f50: 226b 6579 5f72 6571 7565 7374 5f64 6576  "key_request_dev
+00003f60: 6963 6573 5f6e 6f5f 7365 7373 696f 6e22  ices_no_session"
+00003f70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00003f80: 2020 226b 6579 5f72 6571 7565 7374 5f66    "key_request_f
+00003f90: 726f 6d5f 756e 7472 7573 7465 6422 2c0a  rom_untrusted",.
+00003fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003fb0: 2277 6564 6765 645f 6465 7669 6365 7322  "wedged_devices"
+00003fc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00003fd0: 2020 226b 6579 5f72 655f 7265 7175 6573    "key_re_reques
+00003fe0: 7473 5f65 7665 6e74 7322 2c0a 2020 2020  ts_events",.    
+00003ff0: 2020 2020 2020 2020 2020 2020 226b 6579              "key
+00004000: 5f76 6572 6966 6963 6174 696f 6e73 222c  _verifications",
+00004010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004020: 2022 6f75 7467 6f69 6e67 5f74 6f5f 6465   "outgoing_to_de
+00004030: 7669 6365 5f6d 6573 7361 6765 7322 2c0a  vice_messages",.
+00004040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004050: 226d 6573 7361 6765 5f69 6e64 6578 5f73  "message_index_s
+00004060: 746f 7265 222c 0a20 2020 2020 2020 2020  tore",.         
+00004070: 2020 2020 2020 2022 7374 6f72 6522 2c0a         "store",.
+00004080: 2020 2020 2020 2020 2020 2020 5d3a 0a20              ]:. 
+00004090: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000040a0: 6963 7463 6f70 792e 7570 6461 7465 287b  ictcopy.update({
+000040b0: 6b65 793a 206f 626a 2e5f 5f64 6963 745f  key: obj.__dict_
+000040c0: 5f5b 6b65 795d 7d29 0a20 2020 2020 2020  _[key]}).       
+000040d0: 2020 2020 2069 6620 6773 2e70 612e 7665       if gs.pa.ve
+000040e0: 7262 6f73 6520 3e20 313a 2020 2320 322b  rbose > 1:  # 2+
+000040f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004100: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
+00004110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004120: 2020 2066 227b 6f62 6a7d 2069 7320 6e6f     f"{obj} is no
+00004130: 7420 7365 7269 616c 697a 6162 6c65 2c20  t serializable, 
+00004140: 7369 6d70 6c69 6679 696e 6720 746f 207b  simplifying to {
+00004150: 6469 6374 636f 7079 7d2e 220a 2020 2020  dictcopy}.".    
+00004160: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00004170: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00004180: 2064 6963 7463 6f70 790a 2020 2020 2020   dictcopy.      
+00004190: 2020 6966 2067 732e 7061 2e76 6572 626f    if gs.pa.verbo
+000041a0: 7365 203e 2031 3a20 2023 2032 2b0a 2020  se > 1:  # 2+.  
+000041b0: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
+000041c0: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+000041d0: 2020 2020 2020 2020 6622 7b6f 626a 7d20          f"{obj} 
+000041e0: 6973 206e 6f74 2073 6572 6961 6c69 7a61  is not serializa
+000041f0: 626c 652c 2075 7369 6e67 2069 7473 2061  ble, using its a
+00004200: 7661 696c 6162 6c65 2064 6963 7469 6f6e  vailable diction
+00004210: 6172 7920 220a 2020 2020 2020 2020 2020  ary ".          
+00004220: 2020 2020 2020 6622 7b6f 626a 2e5f 5f64        f"{obj.__d
+00004230: 6963 745f 5f7d 2e22 0a20 2020 2020 2020  ict__}.".       
+00004240: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+00004250: 6574 7572 6e20 6f62 6a2e 5f5f 6469 6374  eturn obj.__dict
+00004260: 5f5f 0a20 2020 2065 6c73 653a 0a20 2020  __.    else:.   
+00004270: 2020 2020 2023 2067 732e 6c6f 672e 6465       # gs.log.de
+00004280: 6275 6728 0a20 2020 2020 2020 2023 2020  bug(.        #  
+00004290: 2020 2066 224f 626a 6563 7420 7b6f 626a     f"Object {obj
+000042a0: 7d20 287b 7479 7065 286f 626a 297d 2920  } ({type(obj)}) 
+000042b0: 6861 7320 6e6f 2063 6c61 7373 2064 6963  has no class dic
+000042c0: 7469 6f6e 6172 792e 2022 0a20 2020 2020  tionary. ".     
+000042d0: 2020 2023 2020 2020 2022 4361 6e6e 6f74     #     "Cannot
+000042e0: 2062 6520 636f 6e76 6572 7465 6420 746f   be converted to
+000042f0: 204a 534f 4e20 6f62 6a65 6374 2e20 220a   JSON object. ".
+00004300: 2020 2020 2020 2020 2320 2020 2020 2257          #     "W
+00004310: 696c 6c20 6265 2063 6f6e 7665 7274 6564  ill be converted
+00004320: 2074 6f20 4a53 4f4e 2073 7472 696e 672e   to JSON string.
+00004330: 220a 2020 2020 2020 2020 2320 290a 2020  ".        # ).  
+00004340: 2020 2020 2020 2320 7369 6d70 6c65 2074        # simple t
+00004350: 7970 6573 206c 696b 6520 7961 726c 2e55  ypes like yarl.U
+00004360: 524c 2064 6f20 6e6f 7420 6861 7665 2061  RL do not have a
+00004370: 205f 5f64 6963 745f 5f0a 2020 2020 2020   __dict__.      
+00004380: 2020 2320 6765 7420 7468 6520 636c 6173    # get the clas
+00004390: 7320 6e61 6d65 2061 7320 7374 7269 6e67  s name as string
+000043a0: 2c20 6372 6561 7465 2061 2064 6963 7420  , create a dict 
+000043b0: 7769 7468 2063 6c61 7373 6e61 6d65 2061  with classname a
+000043c0: 6e64 2076 616c 7565 0a20 2020 2020 2020  nd value.       
+000043d0: 2069 6620 6773 2e70 612e 7665 7262 6f73   if gs.pa.verbos
+000043e0: 6520 3e20 313a 2020 2320 322b 0a20 2020  e > 1:  # 2+.   
+000043f0: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
+00004400: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
+00004410: 2020 2020 2020 2066 227b 6f62 6a7d 2069         f"{obj} i
+00004420: 7320 6e6f 7420 7365 7269 616c 697a 6162  s not serializab
+00004430: 6c65 2c20 7369 6d70 6c69 6679 696e 6720  le, simplifying 
+00004440: 746f 206b 6579 2076 616c 7565 2070 6169  to key value pai
+00004450: 7220 220a 2020 2020 2020 2020 2020 2020  r ".            
+00004460: 2020 2020 6622 6b65 7920 277b 6f62 6a2e      f"key '{obj.
+00004470: 5f5f 636c 6173 735f 5f2e 5f5f 6e61 6d65  __class__.__name
+00004480: 5f5f 7d27 2061 6e64 2076 616c 7565 2027  __}' and value '
+00004490: 7b73 7472 286f 626a 297d 272e 220a 2020  {str(obj)}'.".  
+000044a0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000044b0: 2020 2020 7265 7475 726e 207b 6f62 6a2e      return {obj.
+000044c0: 5f5f 636c 6173 735f 5f2e 5f5f 6e61 6d65  __class__.__name
+000044d0: 5f5f 3a20 7374 7228 6f62 6a29 7d0a 0a0a  __: str(obj)}...
+000044e0: 6465 6620 6368 6f6f 7365 5f61 7661 696c  def choose_avail
+000044f0: 6162 6c65 5f66 696c 656e 616d 6528 6669  able_filename(fi
+00004500: 6c65 6e61 6d65 293a 0a20 2020 2022 2222  lename):.    """
+00004510: 5265 7475 726e 206e 6578 7420 6176 6169  Return next avai
+00004520: 6c61 626c 6520 6669 6c65 6e61 6d65 2e0a  lable filename..
+00004530: 0a20 2020 2049 6620 6669 6c65 6e61 6d65  .    If filename
+00004540: 2028 696e 636c 7564 6573 2070 6174 6829   (includes path)
+00004550: 2064 6f65 7320 6e6f 7420 6578 6973 742c   does not exist,
+00004560: 0a20 2020 2074 6865 6e20 6974 2072 6574  .    then it ret
+00004570: 7572 6e73 2066 696c 656e 616d 652e 2049  urns filename. I
+00004580: 6620 6669 6c65 2061 6c72 6561 6479 0a20  f file already. 
+00004590: 2020 2065 7869 7374 7320 6974 2061 6464     exists it add
+000045a0: 7320 6120 636f 756e 7465 7220 6174 2065  s a counter at e
+000045b0: 6e64 2c20 6265 666f 7265 0a20 2020 2065  nd, before.    e
+000045c0: 7874 656e 7369 6f6e 2c20 616e 6420 696e  xtension, and in
+000045d0: 6372 6561 7365 7320 636f 756e 7465 7220  creases counter 
+000045e0: 756e 7469 6c20 6974 0a20 2020 2066 696e  until it.    fin
+000045f0: 6473 2061 2066 696c 656e 616d 6520 7468  ds a filename th
+00004600: 6174 2064 6f65 7320 6e6f 7420 7965 7420  at does not yet 
+00004610: 6578 6973 742e 0a20 2020 2054 6869 7320  exist..    This 
+00004620: 6176 6f69 6473 206f 7665 7277 7269 7474  avoids overwritt
+00004630: 696e 6720 6669 6c65 7320 7768 656e 2073  ing files when s
+00004640: 6f75 7263 6573 0a20 2020 2068 6176 6520  ources.    have 
+00004650: 7361 6d65 206e 616d 652e 0a20 2020 2022  same name..    "
+00004660: 2222 0a20 2020 2069 6620 6f73 2e70 6174  "".    if os.pat
+00004670: 682e 6578 6973 7473 2866 696c 656e 616d  h.exists(filenam
+00004680: 6529 3a0a 2020 2020 2020 2020 7472 793a  e):.        try:
+00004690: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
+000046a0: 7274 2c20 6578 7420 3d20 6669 6c65 6e61  rt, ext = filena
+000046b0: 6d65 2e72 7370 6c69 7428 222e 222c 2031  me.rsplit(".", 1
+000046c0: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+000046d0: 2056 616c 7565 4572 726f 723a 0a20 2020   ValueError:.   
+000046e0: 2020 2020 2020 2020 2073 7461 7274 2c20           start, 
+000046f0: 6578 7420 3d20 2866 696c 656e 616d 652c  ext = (filename,
+00004700: 2022 2229 0a20 2020 2020 2020 2069 203d   "").        i =
+00004710: 2030 0a20 2020 2020 2020 2077 6869 6c65   0.        while
+00004720: 206f 732e 7061 7468 2e65 7869 7374 7328   os.path.exists(
+00004730: 6622 7b73 7461 7274 7d5f 7b69 7d2e 7b65  f"{start}_{i}.{e
+00004740: 7874 7d22 293a 0a20 2020 2020 2020 2020  xt}"):.         
+00004750: 2020 2069 202b 3d20 310a 2020 2020 2020     i += 1.      
+00004760: 2020 7265 7475 726e 2066 227b 7374 6172    return f"{star
+00004770: 747d 5f7b 697d 2e7b 6578 747d 220a 2020  t}_{i}.{ext}".  
+00004780: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00004790: 7265 7475 726e 2066 696c 656e 616d 650a  return filename.
+000047a0: 0a0a 6173 796e 6320 6465 6620 7379 6e63  ..async def sync
+000047b0: 6872 6f6e 697a 6528 636c 6965 6e74 3a20  hronize(client: 
+000047c0: 4173 796e 6343 6c69 656e 7429 202d 3e20  AsyncClient) -> 
+000047d0: 5379 6e63 5265 7370 6f6e 7365 3a0a 2020  SyncResponse:.  
+000047e0: 2020 2222 2253 796e 6368 726f 6e69 7a65    """Synchronize
+000047f0: 2077 6974 6820 7365 7276 6572 2c20 652e   with server, e.
+00004800: 672e 2069 6e20 6f72 6465 7220 746f 2067  g. in order to g
+00004810: 6574 2072 6f6f 6d73 2e0a 0a20 2020 2041  et rooms...    A
+00004820: 7267 756d 656e 7473 3a0a 2020 2020 2d2d  rguments:.    --
+00004830: 2d2d 2d2d 2d2d 2d0a 2020 2020 636c 6965  -------.    clie
+00004840: 6e74 203a 2043 6c69 656e 740a 0a20 2020  nt : Client..   
+00004850: 2052 6574 7572 6e73 3a20 4e6f 6e65 0a0a   Returns: None..
+00004860: 2020 2020 5261 6973 6573 2065 7863 6570      Raises excep
+00004870: 7469 6f6e 206f 6e20 6572 726f 722e 0a20  tion on error.. 
+00004880: 2020 2022 2222 0a20 2020 2074 7279 3a0a     """.    try:.
+00004890: 2020 2020 2020 2020 7265 7370 203d 2061          resp = a
+000048a0: 7761 6974 2063 6c69 656e 742e 7379 6e63  wait client.sync
+000048b0: 2874 696d 656f 7574 3d31 3030 3030 2c20  (timeout=10000, 
+000048c0: 6675 6c6c 5f73 7461 7465 3d54 7275 6529  full_state=True)
+000048d0: 0a20 2020 2065 7863 6570 7420 436c 6965  .    except Clie
+000048e0: 6e74 436f 6e6e 6563 746f 7245 7272 6f72  ntConnectorError
+000048f0: 2061 7320 653a 0a20 2020 2020 2020 2065   as e:.        e
+00004900: 7272 203d 2028 0a20 2020 2020 2020 2020  rr = (.         
+00004910: 2020 2022 4531 3030 3a20 220a 2020 2020     "E100: ".    
+00004920: 2020 2020 2020 2020 2273 796e 6328 2920          "sync() 
+00004930: 6661 696c 6564 2e20 446f 2079 6f75 2068  failed. Do you h
+00004940: 6176 6520 636f 6e6e 6563 7469 7669 7479  ave connectivity
+00004950: 2074 6f20 696e 7465 726e 6574 3f20 220a   to internet? ".
+00004960: 2020 2020 2020 2020 2020 2020 6622 436c              f"Cl
+00004970: 6965 6e74 436f 6e6e 6563 746f 7245 7272  ientConnectorErr
+00004980: 6f72 207b 657d 220a 2020 2020 2020 2020  or {e}".        
+00004990: 290a 2020 2020 2020 2020 7261 6973 6520  ).        raise 
+000049a0: 4d61 7472 6978 436f 6d6d 616e 6465 7245  MatrixCommanderE
+000049b0: 7272 6f72 2865 7272 2920 6672 6f6d 2065  rror(err) from e
+000049c0: 0a20 2020 2065 7863 6570 7420 4578 6365  .    except Exce
+000049d0: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
+000049e0: 2020 2020 6572 7220 3d20 2245 3130 313a      err = "E101:
+000049f0: 2022 2066 2273 796e 6328 2920 6661 696c   " f"sync() fail
+00004a00: 6564 2e20 4578 6365 7074 696f 6e20 7b65  ed. Exception {e
+00004a10: 7d22 0a20 2020 2020 2020 2072 6169 7365  }".        raise
+00004a20: 204d 6174 7269 7843 6f6d 6d61 6e64 6572   MatrixCommander
+00004a30: 4572 726f 7228 6572 7229 2066 726f 6d20  Error(err) from 
+00004a40: 650a 2020 2020 6966 2069 7369 6e73 7461  e.    if isinsta
+00004a50: 6e63 6528 7265 7370 2c20 5379 6e63 4572  nce(resp, SyncEr
+00004a60: 726f 7229 3a0a 2020 2020 2020 2020 6572  ror):.        er
+00004a70: 7220 3d20 2245 3130 323a 2022 2066 2273  r = "E102: " f"s
+00004a80: 796e 6320 6661 696c 6564 2077 6974 6820  ync failed with 
+00004a90: 7265 7370 203d 207b 7072 6976 6163 795f  resp = {privacy_
+00004aa0: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
+00004ab0: 297d 220a 2020 2020 2020 2020 7261 6973  )}".        rais
+00004ac0: 6520 4d61 7472 6978 436f 6d6d 616e 6465  e MatrixCommande
+00004ad0: 7245 7272 6f72 2865 7272 2920 6672 6f6d  rError(err) from
+00004ae0: 204e 6f6e 650a 2020 2020 7265 7475 726e   None.    return
+00004af0: 2072 6573 700a 0a0a 6173 796e 6320 6465   resp...async de
+00004b00: 6620 646f 776e 6c6f 6164 5f6d 7863 280a  f download_mxc(.
+00004b10: 2020 2020 636c 6965 6e74 3a20 4173 796e      client: Asyn
+00004b20: 6343 6c69 656e 742c 206d 7863 3a20 7374  cClient, mxc: st
+00004b30: 722c 2066 696c 656e 616d 653a 204f 7074  r, filename: Opt
+00004b40: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
+00004b50: 650a 293a 0a20 2020 2022 2222 446f 776e  e.):.    """Down
+00004b60: 6c6f 6164 204d 5843 2072 6573 6f75 7263  load MXC resourc
+00004b70: 652e 0a0a 2020 2020 4172 6775 6d65 6e74  e...    Argument
+00004b80: 733a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  s:.    ---------
+00004b90: 0a20 2020 2063 6c69 656e 7420 3a20 436c  .    client : Cl
+00004ba0: 6965 6e74 0a20 2020 206d 7863 203a 2073  ient.    mxc : s
+00004bb0: 7472 0a20 2020 2020 2020 2073 7472 696e  tr.        strin
+00004bc0: 6720 7265 7072 6573 656e 7469 6e67 2055  g representing U
+00004bd0: 524c 206c 696b 6520 6d78 633a 2f2f 6d61  RL like mxc://ma
+00004be0: 7472 6978 2e6f 7267 2f73 6f6d 6552 616e  trix.org/someRan
+00004bf0: 646f 6d4b 6579 0a20 2020 2066 696c 656e  domKey.    filen
+00004c00: 616d 6520 3a20 7374 720a 2020 2020 2020  ame : str.      
+00004c10: 2020 6f70 7469 6f6e 616c 206e 616d 6520    optional name 
+00004c20: 6f66 2066 696c 6520 666f 7220 7374 6f72  of file for stor
+00004c30: 696e 6720 646f 776e 6c6f 6164 0a20 2020  ing download.   
+00004c40: 2022 2222 0a20 2020 206e 696f 5f76 6572   """.    nio_ver
+00004c50: 7369 6f6e 203d 2070 6b67 5f72 6573 6f75  sion = pkg_resou
+00004c60: 7263 6573 2e67 6574 5f64 6973 7472 6962  rces.get_distrib
+00004c70: 7574 696f 6e28 226d 6174 7269 782d 6e69  ution("matrix-ni
+00004c80: 6f22 292e 7665 7273 696f 6e0a 2020 2020  o").version.    
+00004c90: 2320 7665 7273 696f 6e20 696e 636f 6d70  # version incomp
+00004ca0: 6174 6962 696c 6974 7920 6265 7477 6565  atibility betwee
+00004cb0: 6e20 6d61 7472 6978 2d6e 696f 2030 2e31  n matrix-nio 0.1
+00004cc0: 392e 3020 616e 6420 302e 3230 2b0a 2020  9.0 and 0.20+.  
+00004cd0: 2020 2320 6874 7470 733a 2f2f 6d74 7278    # https://mtrx
+00004ce0: 2e73 7974 6573 2e6e 6574 2f4f 4975 6b4b  .sytes.net/OIukK
+00004cf0: 4255 5570 5073 4162 4247 4278 754b 5649  BUUpPsAbBGBxuKVI
+00004d00: 456f 0a20 2020 2023 2073 6572 7665 725f  Eo.    # server_
+00004d10: 6e61 6d65 203d 2022 6d74 7278 2e73 7974  name = "mtrx.syt
+00004d20: 6573 2e6e 6574 220a 2020 2020 2320 6d65  es.net".    # me
+00004d30: 6469 615f 6964 203d 2022 4f49 756b 4b42  dia_id = "OIukKB
+00004d40: 5555 7050 7341 6242 4547 4278 754b 5649  UUpPsAbBEGBxuKVI
+00004d50: 456f 220a 2020 2020 2320 6d61 7472 6978  Eo".    # matrix
+00004d60: 2d6e 696f 2076 302e 3139 2e30 2068 6173  -nio v0.19.0 has
+00004d70: 3a20 646f 776e 6c6f 6164 2873 6572 7665  : download(serve
+00004d80: 725f 6e61 6d65 3a20 7374 722c 206d 6564  r_name: str, med
+00004d90: 6961 5f69 643a 2073 7472 2c20 2e2e 290a  ia_id: str, ..).
+00004da0: 2020 2020 2320 636f 6e76 6572 7420 6d78      # convert mx
+00004db0: 6320 746f 2073 6572 7665 725f 6e61 6d65  c to server_name
+00004dc0: 2061 6e64 206d 6564 6961 5f69 640a 2020   and media_id.  
+00004dd0: 2020 2320 7630 2e32 302b 203a 2072 6573    # v0.20+ : res
+00004de0: 7020 3d20 6177 6169 7420 636c 6965 6e74  p = await client
+00004df0: 2e64 6f77 6e6c 6f61 6428 6d78 633d 6d78  .download(mxc=mx
+00004e00: 632c 2066 696c 656e 616d 653d 6669 6c65  c, filename=file
+00004e10: 6e61 6d65 290a 2020 2020 2320 7630 2e31  name).    # v0.1
+00004e20: 392d 203a 2072 6573 7020 3d20 6177 6169  9- : resp = awai
+00004e30: 7420 636c 6965 6e74 2e64 6f77 6e6c 6f61  t client.downloa
+00004e40: 6428 0a20 2020 2023 2020 2020 2020 2020  d(.    #        
+00004e50: 2020 2020 2020 2020 2020 2020 2073 6572               ser
+00004e60: 7665 725f 6e61 6d65 3d73 6572 7665 725f  ver_name=server_
+00004e70: 6e61 6d65 2c20 6d65 6469 615f 6964 3d6d  name, media_id=m
+00004e80: 6564 6961 5f69 642c 0a20 2020 2023 2020  edia_id,.    #  
+00004e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004ea0: 2020 2066 696c 656e 616d 653d 6669 6c65     filename=file
+00004eb0: 6e61 6d65 290a 2020 2020 6773 2e6c 6f67  name).    gs.log
+00004ec0: 2e64 6562 7567 2866 2264 6f77 6e6c 6f61  .debug(f"downloa
+00004ed0: 645f 6d78 6320 696e 7075 7420 6d78 6320  d_mxc input mxc 
+00004ee0: 6973 207b 6d78 637d 2e22 290a 2020 2020  is {mxc}.").    
+00004ef0: 6966 206e 696f 5f76 6572 7369 6f6e 2e73  if nio_version.s
+00004f00: 7461 7274 7377 6974 6828 2230 2e31 2229  tartswith("0.1")
+00004f10: 3a20 2023 206c 696b 6520 302e 3139 0a20  :  # like 0.19. 
+00004f20: 2020 2020 2020 2067 732e 6c6f 672e 696e         gs.log.in
+00004f30: 666f 280a 2020 2020 2020 2020 2020 2020  fo(.            
+00004f40: 6622 596f 7520 6172 6520 7275 6e6e 696e  f"You are runnin
+00004f50: 6720 6d61 7472 6978 2d6e 696f 2076 6572  g matrix-nio ver
+00004f60: 7369 6f6e 207b 6e69 6f5f 7665 7273 696f  sion {nio_versio
+00004f70: 6e7d 2e20 220a 2020 2020 2020 2020 2020  n}. ".          
+00004f80: 2020 2259 6f75 2073 686f 756c 6420 6265    "You should be
+00004f90: 2072 756e 6e69 6e67 2076 6572 7369 6f6e   running version
+00004fa0: 2030 2e32 302b 2e20 5570 6461 7465 2069   0.20+. Update i
+00004fb0: 6620 6e65 6365 7373 6172 792e 2022 0a20  f necessary. ". 
+00004fc0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00004fd0: 2075 726c 203d 2075 726c 7061 7273 6528   url = urlparse(
+00004fe0: 6d78 6329 0a20 2020 2020 2020 2067 732e  mxc).        gs.
+00004ff0: 6c6f 672e 6465 6275 6728 6622 646f 776e  log.debug(f"down
+00005000: 6c6f 6164 5f6d 7863 2069 6e70 7574 2075  load_mxc input u
+00005010: 726c 2069 7320 7b75 726c 7d2e 2229 0a20  rl is {url}."). 
+00005020: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
+00005030: 3d20 6177 6169 7420 636c 6965 6e74 2e64  = await client.d
+00005040: 6f77 6e6c 6f61 6428 0a20 2020 2020 2020  ownload(.       
+00005050: 2020 2020 2073 6572 7665 725f 6e61 6d65       server_name
+00005060: 3d75 726c 2e6e 6574 6c6f 632c 0a20 2020  =url.netloc,.   
+00005070: 2020 2020 2020 2020 206d 6564 6961 5f69           media_i
+00005080: 643d 7572 6c2e 7061 7468 2e73 7472 6970  d=url.path.strip
+00005090: 2822 2f22 292c 0a20 2020 2020 2020 2020  ("/"),.         
+000050a0: 2020 2066 696c 656e 616d 653d 6669 6c65     filename=file
+000050b0: 6e61 6d65 2c0a 2020 2020 2020 2020 290a  name,.        ).
+000050c0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000050d0: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
+000050e0: 2020 2020 2020 2020 2020 2020 6622 596f              f"Yo
+000050f0: 7520 6172 6520 7275 6e6e 696e 6720 6d61  u are running ma
+00005100: 7472 6978 2d6e 696f 2076 6572 7369 6f6e  trix-nio version
+00005110: 207b 6e69 6f5f 7665 7273 696f 6e7d 2e20   {nio_version}. 
+00005120: 4772 6561 7421 220a 2020 2020 2020 2020  Great!".        
+00005130: 290a 2020 2020 2020 2020 7265 7370 6f6e  ).        respon
+00005140: 7365 203d 2061 7761 6974 2063 6c69 656e  se = await clien
+00005150: 742e 646f 776e 6c6f 6164 286d 7863 3d6d  t.download(mxc=m
+00005160: 7863 2c20 6669 6c65 6e61 6d65 3d66 696c  xc, filename=fil
+00005170: 656e 616d 6529 0a20 2020 2067 732e 6c6f  ename).    gs.lo
+00005180: 672e 6465 6275 6728 6622 646f 776e 6c6f  g.debug(f"downlo
+00005190: 6164 5f6d 7863 2072 6573 706f 6e73 6520  ad_mxc response 
+000051a0: 6973 207b 7265 7370 6f6e 7365 7d2e 2229  is {response}.")
+000051b0: 0a20 2020 2072 6574 7572 6e20 7265 7370  .    return resp
+000051c0: 6f6e 7365 0a0a 0a63 6c61 7373 2043 616c  onse...class Cal
+000051d0: 6c62 6163 6b73 286f 626a 6563 7429 3a0a  lbacks(object):.
+000051e0: 2020 2020 2222 2243 6c61 7373 2074 6f20      """Class to 
+000051f0: 7061 7373 2063 6c69 656e 7420 746f 2063  pass client to c
+00005200: 616c 6c62 6163 6b20 6d65 7468 6f64 732e  allback methods.
+00005210: 2222 220a 0a20 2020 2064 6566 205f 5f69  """..    def __i
+00005220: 6e69 745f 5f28 7365 6c66 2c20 636c 6965  nit__(self, clie
+00005230: 6e74 293a 0a20 2020 2020 2020 2022 2222  nt):.        """
+00005240: 5374 6f72 6520 4173 796e 6343 6c69 656e  Store AsyncClien
+00005250: 742e 2222 220a 2020 2020 2020 2020 7365  t.""".        se
+00005260: 6c66 2e63 6c69 656e 7420 3d20 636c 6965  lf.client = clie
+00005270: 6e74 0a0a 2020 2020 2320 6163 636f 7264  nt..    # accord
+00005280: 696e 6720 746f 2070 796c 616d 613a 2066  ing to pylama: f
+00005290: 756e 6374 696f 6e20 746f 6f20 636f 6d70  unction too comp
+000052a0: 6c65 783a 2043 3930 3120 2320 6e6f 7161  lex: C901 # noqa
+000052b0: 3a20 4339 3031 0a20 2020 2061 7379 6e63  : C901.    async
+000052c0: 2064 6566 206d 6573 7361 6765 5f63 616c   def message_cal
+000052d0: 6c62 6163 6b28 7365 6c66 2c20 726f 6f6d  lback(self, room
+000052e0: 3a20 4d61 7472 6978 526f 6f6d 2c20 6576  : MatrixRoom, ev
+000052f0: 656e 7429 3a20 2023 206e 6f71 613a 2043  ent):  # noqa: C
+00005300: 3930 310a 2020 2020 2020 2020 2222 2248  901.        """H
+00005310: 616e 646c 6520 616c 6c20 6576 656e 7473  andle all events
+00005320: 206f 6620 7479 7065 2052 6f6f 6d4d 6573   of type RoomMes
+00005330: 7361 6765 2e0a 0a20 2020 2020 2020 2049  sage...        I
+00005340: 6e63 6c75 6465 7320 6576 656e 7473 206c  ncludes events l
+00005350: 696b 6520 526f 6f6d 4d65 7373 6167 6554  ike RoomMessageT
+00005360: 6578 742c 2052 6f6f 6d4d 6573 7361 6765  ext, RoomMessage
+00005370: 496d 6167 652c 2065 7463 2e0a 2020 2020  Image, etc..    
+00005380: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00005390: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+000053a0: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
+000053b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000053c0: 226d 6573 7361 6765 5f63 616c 6c62 6163  "message_callbac
+000053d0: 6b28 293a 2066 6f72 2072 6f6f 6d20 7b72  k(): for room {r
+000053e0: 6f6f 6d7d 2072 6563 6569 7665 6420 7468  oom} received th
+000053f0: 6973 2022 0a20 2020 2020 2020 2020 2020  is ".           
+00005400: 2020 2020 2066 2265 7665 6e74 3a20 7479       f"event: ty
+00005410: 7065 3a20 7b74 7970 6528 6576 656e 7429  pe: {type(event)
+00005420: 7d2c 2065 7665 6e74 5f69 643a 207b 6576  }, event_id: {ev
+00005430: 656e 742e 6576 656e 745f 6964 7d2c 2022  ent.event_id}, "
+00005440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005450: 2066 2265 7665 6e74 3a20 7b65 7665 6e74   f"event: {event
+00005460: 7d22 0a20 2020 2020 2020 2020 2020 2029  }".            )
+00005470: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00005480: 6e6f 7420 6773 2e70 612e 6c69 7374 656e  not gs.pa.listen
+00005490: 5f73 656c 663a 0a20 2020 2020 2020 2020  _self:.         
+000054a0: 2020 2020 2020 2069 6620 6576 656e 742e         if event.
+000054b0: 7365 6e64 6572 203d 3d20 7365 6c66 2e63  sender == self.c
+000054c0: 6c69 656e 742e 7573 6572 3a0a 2020 2020  lient.user:.    
+000054d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000054e0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+000054f0: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
+00005500: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
+00005510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005520: 2020 2020 2020 2066 2253 6b69 7070 696e         f"Skippin
+00005530: 6720 6d65 7373 6167 6520 7365 6e74 2062  g message sent b
+00005540: 7920 6d79 7365 6c66 3a20 7b65 7665 6e74  y myself: {event
+00005550: 2e62 6f64 797d 220a 2020 2020 2020 2020  .body}".        
+00005560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005570: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00005580: 2020 2020 2020 6578 6365 7074 2041 7474        except Att
+00005590: 7269 6275 7465 4572 726f 723a 2020 2320  ributeError:  # 
+000055a0: 646f 6573 206e 6f74 2068 6176 6520 2e62  does not have .b
+000055b0: 6f64 790a 2020 2020 2020 2020 2020 2020  ody.            
+000055c0: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+000055d0: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
+000055e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000055f0: 2020 2020 2020 6622 536b 6970 7069 6e67        f"Skipping
+00005600: 206d 6573 7361 6765 2073 656e 7420 6279   message sent by
+00005610: 206d 7973 656c 663a 207b 6576 656e 747d   myself: {event}
+00005620: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00005630: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00005640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005650: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
+00005660: 2020 2020 2320 6d69 6c6c 6973 6563 2073      # millisec s
+00005670: 696e 6365 2031 3937 300a 2020 2020 2020  ince 1970.      
+00005680: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+00005690: 7567 2866 2265 7665 6e74 2e73 6572 7665  ug(f"event.serve
+000056a0: 725f 7469 6d65 7374 616d 7020 3d20 7b65  r_timestamp = {e
+000056b0: 7665 6e74 2e73 6572 7665 725f 7469 6d65  vent.server_time
+000056c0: 7374 616d 707d 2229 0a20 2020 2020 2020  stamp}").       
+000056d0: 2020 2020 2074 696d 6573 7461 6d70 203d       timestamp =
+000056e0: 2064 6174 6574 696d 652e 6461 7465 7469   datetime.dateti
+000056f0: 6d65 2e66 726f 6d74 696d 6573 7461 6d70  me.fromtimestamp
+00005700: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00005710: 2020 696e 7428 6576 656e 742e 7365 7276    int(event.serv
+00005720: 6572 5f74 696d 6573 7461 6d70 202f 2031  er_timestamp / 1
+00005730: 3030 3029 0a20 2020 2020 2020 2020 2020  000).           
+00005740: 2029 2020 2320 7365 6320 7369 6e63 6520   )  # sec since 
+00005750: 3139 3730 0a20 2020 2020 2020 2020 2020  1970.           
+00005760: 2065 7665 6e74 5f64 6174 6574 696d 6520   event_datetime 
+00005770: 3d20 7469 6d65 7374 616d 702e 7374 7266  = timestamp.strf
+00005780: 7469 6d65 2822 2559 2d25 6d2d 2564 2025  time("%Y-%m-%d %
+00005790: 483a 254d 3a25 5322 290a 2020 2020 2020  H:%M:%S").      
+000057a0: 2020 2020 2020 2320 652e 672e 2032 3032        # e.g. 202
+000057b0: 302d 3038 2d30 3620 3137 3a33 303a 3138  0-08-06 17:30:18
+000057c0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+000057d0: 6c6f 672e 6465 6275 6728 6622 6576 656e  log.debug(f"even
+000057e0: 745f 6461 7465 7469 6d65 203d 207b 6576  t_datetime = {ev
+000057f0: 656e 745f 6461 7465 7469 6d65 7d22 290a  ent_datetime}").
+00005800: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00005810: 6973 696e 7374 616e 6365 2865 7665 6e74  isinstance(event
+00005820: 2c20 526f 6f6d 4d65 7373 6167 654d 6564  , RoomMessageMed
+00005830: 6961 293a 2020 2320 666f 7220 616c 6c20  ia):  # for all 
+00005840: 6d65 6469 6120 6576 656e 7473 0a20 2020  media events.   
+00005850: 2020 2020 2020 2020 2020 2020 206d 7863               mxc
+00005860: 203d 2065 7665 6e74 2e75 726c 2020 2320   = event.url  # 
+00005870: 6d65 6469 6120 6d78 630a 2020 2020 2020  media mxc.      
+00005880: 2020 2020 2020 2020 2020 7572 6c20 3d20            url = 
+00005890: 6177 6169 7420 7365 6c66 2e63 6c69 656e  await self.clien
+000058a0: 742e 6d78 635f 746f 5f68 7474 7028 6d78  t.mxc_to_http(mx
+000058b0: 6329 2020 2320 6d65 6469 6120 7572 6c0a  c)  # media url.
+000058c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000058d0: 6773 2e6c 6f67 2e64 6562 7567 2866 2248  gs.log.debug(f"H
+000058e0: 5454 5020 5552 4c20 6f66 206d 6564 6961  TTP URL of media
+000058f0: 2069 7320 3a20 7b75 726c 7d22 290a 2020   is : {url}").  
+00005900: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
+00005910: 675f 7572 6c20 3d20 2220 5b22 202b 2075  g_url = " [" + u
+00005920: 726c 202b 2022 5d22 0a20 2020 2020 2020  rl + "]".       
+00005930: 2020 2020 2020 2020 2069 6620 6773 2e70           if gs.p
+00005940: 612e 646f 776e 6c6f 6164 5f6d 6564 6961  a.download_media
+00005950: 2021 3d20 2222 3a0a 2020 2020 2020 2020   != "":.        
+00005960: 2020 2020 2020 2020 2020 2020 2320 646f              # do
+00005970: 776e 6c6f 6164 2075 6e65 6e63 7279 7074  wnload unencrypt
+00005980: 6564 2f70 6c61 696e 206d 6564 6961 2066  ed/plain media f
+00005990: 696c 650a 2020 2020 2020 2020 2020 2020  ile.            
+000059a0: 2020 2020 2020 2020 7265 7370 203d 2061          resp = a
+000059b0: 7761 6974 2064 6f77 6e6c 6f61 645f 6d78  wait download_mx
+000059c0: 6328 7365 6c66 2e63 6c69 656e 742c 206d  c(self.client, m
+000059d0: 7863 290a 2020 2020 2020 2020 2020 2020  xc).            
+000059e0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+000059f0: 7461 6e63 6528 7265 7370 2c20 446f 776e  tance(resp, Down
+00005a00: 6c6f 6164 4572 726f 7229 3a0a 2020 2020  loadError):.    
+00005a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005a20: 2020 2020 6773 2e6c 6f67 2e65 7272 6f72      gs.log.error
+00005a30: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00005a40: 2020 2020 2020 2020 2020 2020 2020 2245                "E
+00005a50: 3130 353a 2022 0a20 2020 2020 2020 2020  105: ".         
+00005a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005a70: 2020 2066 2264 6f77 6e6c 6f61 6420 6f66     f"download of
+00005a80: 2055 5249 2027 7b6d 7863 7d27 2074 6f20   URI '{mxc}' to 
+00005a90: 6c6f 6361 6c20 6669 6c65 2022 0a20 2020  local file ".   
+00005aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005ab0: 2020 2020 2020 2020 2066 2266 6169 6c65           f"faile
+00005ac0: 6420 7769 7468 2072 6573 706f 6e73 6520  d with response 
+00005ad0: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
+00005ae0: 7374 7228 7265 7370 2929 7d22 0a20 2020  str(resp))}".   
+00005af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005b00: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00005b10: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00005b20: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
+00005b30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005b40: 2020 2020 2020 2020 206d 7367 5f75 726c           msg_url
+00005b50: 202b 3d20 2220 5b44 6f77 6e6c 6f61 6420   += " [Download 
+00005b60: 6f66 206d 6564 6961 2066 696c 6520 6661  of media file fa
+00005b70: 696c 6564 5d22 0a20 2020 2020 2020 2020  iled]".         
+00005b80: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00005b90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005ba0: 2020 2020 2020 2020 206d 6564 6961 5f64           media_d
+00005bb0: 6174 6120 3d20 7265 7370 2e62 6f64 790a  ata = resp.body.
+00005bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005bd0: 2020 2020 2020 2020 6669 6c65 6e61 6d65          filename
+00005be0: 203d 2063 686f 6f73 655f 6176 6169 6c61   = choose_availa
+00005bf0: 626c 655f 6669 6c65 6e61 6d65 280a 2020  ble_filename(.  
+00005c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005c10: 2020 2020 2020 2020 2020 6f73 2e70 6174            os.pat
+00005c20: 682e 6a6f 696e 2867 732e 7061 2e64 6f77  h.join(gs.pa.dow
+00005c30: 6e6c 6f61 645f 6d65 6469 612c 2065 7665  nload_media, eve
+00005c40: 6e74 2e62 6f64 7929 0a20 2020 2020 2020  nt.body).       
+00005c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005c60: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00005c70: 2020 2020 2020 2020 2020 2061 7379 6e63             async
+00005c80: 2077 6974 6820 6169 6f66 696c 6573 2e6f   with aiofiles.o
+00005c90: 7065 6e28 6669 6c65 6e61 6d65 2c20 2277  pen(filename, "w
+00005ca0: 6222 2920 6173 2066 3a0a 2020 2020 2020  b") as f:.      
+00005cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005cc0: 2020 2020 2020 6177 6169 7420 662e 7772        await f.wr
+00005cd0: 6974 6528 6d65 6469 615f 6461 7461 290a  ite(media_data).
+00005ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005cf0: 2020 2020 2020 2020 2020 2020 2320 5365              # Se
+00005d00: 7420 6174 696d 6520 616e 6420 6d74 696d  t atime and mtim
+00005d10: 6520 6f66 2066 696c 6520 746f 2065 7665  e of file to eve
+00005d20: 6e74 2074 696d 6573 7461 6d70 0a20 2020  nt timestamp.   
+00005d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005d40: 2020 2020 2020 2020 206f 732e 7574 696d           os.utim
+00005d50: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+00005d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005d70: 2020 2066 696c 656e 616d 652c 0a20 2020     filename,.   
 00005d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005d90: 6e73 3d28 2865 7665 6e74 2e73 6572 7665  ns=((event.serve
-00005da0: 725f 7469 6d65 7374 616d 7020 2a20 3130  r_timestamp * 10
-00005db0: 3030 3030 302c 2920 2a20 3229 2c0a 2020  00000,) * 2),.  
-00005dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005dd0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00005de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005df0: 2020 2020 6d73 675f 7572 6c20 2b3d 2066      msg_url += f
-00005e00: 2220 5b44 6f77 6e6c 6f61 6465 6420 6d65  " [Downloaded me
-00005e10: 6469 6120 6669 6c65 2074 6f20 7b66 696c  dia file to {fil
-00005e20: 656e 616d 657d 5d22 0a0a 2020 2020 2020  ename}]"..      
-00005e30: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00005e40: 6e63 6528 6576 656e 742c 2052 6f6f 6d45  nce(event, RoomE
-00005e50: 6e63 7279 7074 6564 4d65 6469 6129 3a20  ncryptedMedia): 
-00005e60: 2023 2066 6f72 2061 6c6c 2065 3265 206d   # for all e2e m
-00005e70: 6564 6961 0a20 2020 2020 2020 2020 2020  edia.           
-00005e80: 2020 2020 206d 7863 203d 2065 7665 6e74       mxc = event
-00005e90: 2e75 726c 2020 2320 6d65 6469 6120 6d78  .url  # media mx
-00005ea0: 630a 2020 2020 2020 2020 2020 2020 2020  c.              
-00005eb0: 2020 7572 6c20 3d20 6177 6169 7420 7365    url = await se
-00005ec0: 6c66 2e63 6c69 656e 742e 6d78 635f 746f  lf.client.mxc_to
-00005ed0: 5f68 7474 7028 6d78 6329 2020 2320 6d65  _http(mxc)  # me
-00005ee0: 6469 6120 7572 6c0a 2020 2020 2020 2020  dia url.        
-00005ef0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-00005f00: 6562 7567 2866 2248 5454 5020 5552 4c20  ebug(f"HTTP URL 
-00005f10: 6f66 206d 6564 6961 2069 7320 3a20 7b75  of media is : {u
-00005f20: 726c 7d22 290a 2020 2020 2020 2020 2020  rl}").          
-00005f30: 2020 2020 2020 6d73 675f 7572 6c20 3d20        msg_url = 
-00005f40: 2220 5b22 202b 2075 726c 202b 2022 5d22  " [" + url + "]"
-00005f50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005f60: 2069 6620 6773 2e70 612e 646f 776e 6c6f   if gs.pa.downlo
-00005f70: 6164 5f6d 6564 6961 2021 3d20 2222 3a0a  ad_media != "":.
-00005f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005f90: 2020 2020 2320 646f 776e 6c6f 6164 2065      # download e
-00005fa0: 6e63 7279 7074 6564 206d 6564 6961 2066  ncrypted media f
-00005fb0: 696c 650a 2020 2020 2020 2020 2020 2020  ile.            
-00005fc0: 2020 2020 2020 2020 7265 7370 203d 2061          resp = a
-00005fd0: 7761 6974 2064 6f77 6e6c 6f61 645f 6d78  wait download_mx
-00005fe0: 6328 7365 6c66 2e63 6c69 656e 742c 206d  c(self.client, m
-00005ff0: 7863 290a 2020 2020 2020 2020 2020 2020  xc).            
-00006000: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00006010: 7461 6e63 6528 7265 7370 2c20 446f 776e  tance(resp, Down
-00006020: 6c6f 6164 4572 726f 7229 3a0a 2020 2020  loadError):.    
-00006030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006040: 2020 2020 6773 2e6c 6f67 2e65 7272 6f72      gs.log.error
-00006050: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00006060: 2020 2020 2020 2020 2020 2020 2020 2245                "E
-00006070: 3130 363a 2022 0a20 2020 2020 2020 2020  106: ".         
-00006080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006090: 2020 2066 2264 6f77 6e6c 6f61 6420 6f66     f"download of
-000060a0: 2055 5249 2027 7b6d 7863 7d27 2074 6f20   URI '{mxc}' to 
-000060b0: 6c6f 6361 6c20 6669 6c65 2022 0a20 2020  local file ".   
-000060c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000060d0: 2020 2020 2020 2020 2066 2266 6169 6c65           f"faile
-000060e0: 6420 7769 7468 2072 6573 706f 6e73 6520  d with response 
-000060f0: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
-00006100: 7374 7228 7265 7370 2929 7d22 0a20 2020  str(resp))}".   
-00006110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006120: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00006130: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00006140: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
-00006150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006160: 2020 2020 2020 2020 206d 7367 5f75 726c           msg_url
-00006170: 202b 3d20 2220 5b44 6f77 6e6c 6f61 6420   += " [Download 
-00006180: 6f66 206d 6564 6961 2066 696c 6520 6661  of media file fa
-00006190: 696c 6564 5d22 0a20 2020 2020 2020 2020  iled]".         
-000061a0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-000061b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000061c0: 2020 2020 2020 2020 206d 6564 6961 5f64           media_d
-000061d0: 6174 6120 3d20 7265 7370 2e62 6f64 790a  ata = resp.body.
-000061e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000061f0: 2020 2020 2020 2020 6669 6c65 6e61 6d65          filename
-00006200: 203d 2063 686f 6f73 655f 6176 6169 6c61   = choose_availa
-00006210: 626c 655f 6669 6c65 6e61 6d65 280a 2020  ble_filename(.  
-00006220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006230: 2020 2020 2020 2020 2020 6f73 2e70 6174            os.pat
-00006240: 682e 6a6f 696e 2867 732e 7061 2e64 6f77  h.join(gs.pa.dow
-00006250: 6e6c 6f61 645f 6d65 6469 612c 2065 7665  nload_media, eve
-00006260: 6e74 2e62 6f64 7929 0a20 2020 2020 2020  nt.body).       
-00006270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006280: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00006290: 2020 2020 2020 2020 2020 2061 7379 6e63             async
-000062a0: 2077 6974 6820 6169 6f66 696c 6573 2e6f   with aiofiles.o
-000062b0: 7065 6e28 6669 6c65 6e61 6d65 2c20 2277  pen(filename, "w
-000062c0: 6222 2920 6173 2066 3a0a 2020 2020 2020  b") as f:.      
-000062d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000062e0: 2020 2020 2020 6177 6169 7420 662e 7772        await f.wr
-000062f0: 6974 6528 0a20 2020 2020 2020 2020 2020  ite(.           
-00006300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006310: 2020 2020 2063 7279 7074 6f2e 6174 7461       crypto.atta
-00006320: 6368 6d65 6e74 732e 6465 6372 7970 745f  chments.decrypt_
-00006330: 6174 7461 6368 6d65 6e74 280a 2020 2020  attachment(.    
-00006340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005d90: 2020 2020 2020 2020 2020 2020 206e 733d               ns=
+00005da0: 2828 6576 656e 742e 7365 7276 6572 5f74  ((event.server_t
+00005db0: 696d 6573 7461 6d70 202a 2031 3030 3030  imestamp * 10000
+00005dc0: 3030 2c29 202a 2032 292c 0a20 2020 2020  00,) * 2),.     
+00005dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005de0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00005df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005e00: 206d 7367 5f75 726c 202b 3d20 6622 205b   msg_url += f" [
+00005e10: 446f 776e 6c6f 6164 6564 206d 6564 6961  Downloaded media
+00005e20: 2066 696c 6520 746f 207b 6669 6c65 6e61   file to {filena
+00005e30: 6d65 7d5d 220a 0a20 2020 2020 2020 2020  me}]"..         
+00005e40: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+00005e50: 2865 7665 6e74 2c20 526f 6f6d 456e 6372  (event, RoomEncr
+00005e60: 7970 7465 644d 6564 6961 293a 2020 2320  yptedMedia):  # 
+00005e70: 666f 7220 616c 6c20 6532 6520 6d65 6469  for all e2e medi
+00005e80: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
+00005e90: 2020 6d78 6320 3d20 6576 656e 742e 7572    mxc = event.ur
+00005ea0: 6c20 2023 206d 6564 6961 206d 7863 0a20  l  # media mxc. 
+00005eb0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+00005ec0: 726c 203d 2061 7761 6974 2073 656c 662e  rl = await self.
+00005ed0: 636c 6965 6e74 2e6d 7863 5f74 6f5f 6874  client.mxc_to_ht
+00005ee0: 7470 286d 7863 2920 2023 206d 6564 6961  tp(mxc)  # media
+00005ef0: 2075 726c 0a20 2020 2020 2020 2020 2020   url.           
+00005f00: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
+00005f10: 6728 6622 4854 5450 2055 524c 206f 6620  g(f"HTTP URL of 
+00005f20: 6d65 6469 6120 6973 203a 207b 7572 6c7d  media is : {url}
+00005f30: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+00005f40: 2020 206d 7367 5f75 726c 203d 2022 205b     msg_url = " [
+00005f50: 2220 2b20 7572 6c20 2b20 225d 220a 2020  " + url + "]".  
+00005f60: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00005f70: 2067 732e 7061 2e64 6f77 6e6c 6f61 645f   gs.pa.download_
+00005f80: 6d65 6469 6120 213d 2022 223a 0a20 2020  media != "":.   
+00005f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005fa0: 2023 2064 6f77 6e6c 6f61 6420 656e 6372   # download encr
+00005fb0: 7970 7465 6420 6d65 6469 6120 6669 6c65  ypted media file
+00005fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005fd0: 2020 2020 2072 6573 7020 3d20 6177 6169       resp = awai
+00005fe0: 7420 646f 776e 6c6f 6164 5f6d 7863 2873  t download_mxc(s
+00005ff0: 656c 662e 636c 6965 6e74 2c20 6d78 6329  elf.client, mxc)
+00006000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006010: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+00006020: 6365 2872 6573 702c 2044 6f77 6e6c 6f61  ce(resp, Downloa
+00006030: 6445 7272 6f72 293a 0a20 2020 2020 2020  dError):.       
+00006040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006050: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
+00006060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006070: 2020 2020 2020 2020 2020 2022 4531 3036             "E106
+00006080: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
+00006090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000060a0: 6622 646f 776e 6c6f 6164 206f 6620 5552  f"download of UR
+000060b0: 4920 277b 6d78 637d 2720 746f 206c 6f63  I '{mxc}' to loc
+000060c0: 616c 2066 696c 6520 220a 2020 2020 2020  al file ".      
+000060d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000060e0: 2020 2020 2020 6622 6661 696c 6564 2077        f"failed w
+000060f0: 6974 6820 7265 7370 6f6e 7365 207b 7072  ith response {pr
+00006100: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
+00006110: 2872 6573 7029 297d 220a 2020 2020 2020  (resp))}".      
+00006120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006130: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00006140: 2020 2020 2020 2020 2020 2020 6773 2e65              gs.e
+00006150: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
+00006160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006170: 2020 2020 2020 6d73 675f 7572 6c20 2b3d        msg_url +=
+00006180: 2022 205b 446f 776e 6c6f 6164 206f 6620   " [Download of 
+00006190: 6d65 6469 6120 6669 6c65 2066 6169 6c65  media file faile
+000061a0: 645d 220a 2020 2020 2020 2020 2020 2020  d]".            
+000061b0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000061c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000061d0: 2020 2020 2020 6d65 6469 615f 6461 7461        media_data
+000061e0: 203d 2072 6573 702e 626f 6479 0a20 2020   = resp.body.   
+000061f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006200: 2020 2020 2066 696c 656e 616d 6520 3d20       filename = 
+00006210: 6368 6f6f 7365 5f61 7661 696c 6162 6c65  choose_available
+00006220: 5f66 696c 656e 616d 6528 0a20 2020 2020  _filename(.     
+00006230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006240: 2020 2020 2020 206f 732e 7061 7468 2e6a         os.path.j
+00006250: 6f69 6e28 6773 2e70 612e 646f 776e 6c6f  oin(gs.pa.downlo
+00006260: 6164 5f6d 6564 6961 2c20 6576 656e 742e  ad_media, event.
+00006270: 626f 6479 290a 2020 2020 2020 2020 2020  body).          
+00006280: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00006290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000062a0: 2020 2020 2020 2020 6173 796e 6320 7769          async wi
+000062b0: 7468 2061 696f 6669 6c65 732e 6f70 656e  th aiofiles.open
+000062c0: 2866 696c 656e 616d 652c 2022 7762 2229  (filename, "wb")
+000062d0: 2061 7320 663a 0a20 2020 2020 2020 2020   as f:.         
+000062e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000062f0: 2020 2061 7761 6974 2066 2e77 7269 7465     await f.write
+00006300: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00006310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006320: 2020 6372 7970 746f 2e61 7474 6163 686d    crypto.attachm
+00006330: 656e 7473 2e64 6563 7279 7074 5f61 7474  ents.decrypt_att
+00006340: 6163 686d 656e 7428 0a20 2020 2020 2020  achment(.       
 00006350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006360: 6d65 6469 615f 6461 7461 2c0a 2020 2020  media_data,.    
-00006370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006360: 2020 2020 2020 2020 2020 2020 206d 6564               med
+00006370: 6961 5f64 6174 612c 0a20 2020 2020 2020  ia_data,.       
 00006380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006390: 6576 656e 742e 736f 7572 6365 5b22 636f  event.source["co
-000063a0: 6e74 656e 7422 5d5b 2266 696c 6522 5d5b  ntent"]["file"][
-000063b0: 226b 6579 225d 5b0a 2020 2020 2020 2020  "key"][.        
-000063c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006390: 2020 2020 2020 2020 2020 2020 2065 7665               eve
+000063a0: 6e74 2e73 6f75 7263 655b 2263 6f6e 7465  nt.source["conte
+000063b0: 6e74 225d 5b22 6669 6c65 225d 5b22 6b65  nt"]["file"]["ke
+000063c0: 7922 5d5b 0a20 2020 2020 2020 2020 2020  y"][.           
 000063d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000063e0: 226b 220a 2020 2020 2020 2020 2020 2020  "k".            
-000063f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006400: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00006410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006420: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00006430: 7665 6e74 2e73 6f75 7263 655b 2263 6f6e  vent.source["con
-00006440: 7465 6e74 225d 5b22 6669 6c65 225d 5b22  tent"]["file"]["
-00006450: 6861 7368 6573 225d 5b0a 2020 2020 2020  hashes"][.      
-00006460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000063e0: 2020 2020 2020 2020 2020 2020 2022 6b22               "k"
+000063f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006410: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00006420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006430: 2020 2020 2020 2020 2020 2020 6576 656e              even
+00006440: 742e 736f 7572 6365 5b22 636f 6e74 656e  t.source["conten
+00006450: 7422 5d5b 2266 696c 6522 5d5b 2268 6173  t"]["file"]["has
+00006460: 6865 7322 5d5b 0a20 2020 2020 2020 2020  hes"][.         
 00006470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006480: 2020 2273 6861 3235 3622 0a20 2020 2020    "sha256".     
-00006490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000064a0: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
-000064b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00006480: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00006490: 7368 6132 3536 220a 2020 2020 2020 2020  sha256".        
+000064a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000064b0: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
 000064c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000064d0: 2020 2020 2020 6576 656e 742e 736f 7572        event.sour
-000064e0: 6365 5b22 636f 6e74 656e 7422 5d5b 2266  ce["content"]["f
-000064f0: 696c 6522 5d5b 2269 7622 5d2c 0a20 2020  ile"]["iv"],.   
-00006500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006510: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00006520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006530: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00006540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006550: 2020 2020 2020 2020 2023 2053 6574 2061           # Set a
-00006560: 7469 6d65 2061 6e64 206d 7469 6d65 206f  time and mtime o
-00006570: 6620 6669 6c65 2074 6f20 6576 656e 7420  f file to event 
-00006580: 7469 6d65 7374 616d 700a 2020 2020 2020  timestamp.      
-00006590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000065a0: 2020 2020 2020 6f73 2e75 7469 6d65 280a        os.utime(.
-000065b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000064d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000064e0: 2020 2065 7665 6e74 2e73 6f75 7263 655b     event.source[
+000064f0: 2263 6f6e 7465 6e74 225d 5b22 6669 6c65  "content"]["file
+00006500: 225d 5b22 6976 225d 2c0a 2020 2020 2020  "]["iv"],.      
+00006510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006520: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00006530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006540: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00006550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006560: 2020 2020 2020 2320 5365 7420 6174 696d        # Set atim
+00006570: 6520 616e 6420 6d74 696d 6520 6f66 2066  e and mtime of f
+00006580: 696c 6520 746f 2065 7665 6e74 2074 696d  ile to event tim
+00006590: 6573 7461 6d70 0a20 2020 2020 2020 2020  estamp.         
+000065a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000065b0: 2020 206f 732e 7574 696d 6528 0a20 2020     os.utime(.   
 000065c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000065d0: 6669 6c65 6e61 6d65 2c0a 2020 2020 2020  filename,.      
-000065e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000065f0: 2020 2020 2020 2020 2020 6e73 3d28 2865            ns=((e
-00006600: 7665 6e74 2e73 6572 7665 725f 7469 6d65  vent.server_time
-00006610: 7374 616d 7020 2a20 3130 3030 3030 302c  stamp * 1000000,
-00006620: 2920 2a20 3229 2c0a 2020 2020 2020 2020  ) * 2),.        
-00006630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006640: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00006650: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
-00006660: 675f 7572 6c20 2b3d 2028 0a20 2020 2020  g_url += (.     
-00006670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006680: 2020 2020 2020 2022 205b 446f 776e 6c6f         " [Downlo
-00006690: 6164 6564 2061 6e64 2064 6563 7279 7074  aded and decrypt
-000066a0: 6564 206d 6564 6961 2022 0a20 2020 2020  ed media ".     
-000066b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000066c0: 2020 2020 2020 2066 2266 696c 6520 746f         f"file to
-000066d0: 207b 6669 6c65 6e61 6d65 7d5d 220a 2020   {filename}]".  
-000066e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000066f0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00006700: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-00006710: 6365 2865 7665 6e74 2c20 526f 6f6d 4d65  ce(event, RoomMe
-00006720: 7373 6167 6541 7564 696f 293a 0a20 2020  ssageAudio):.   
-00006730: 2020 2020 2020 2020 2020 2020 206d 7367               msg
-00006740: 203d 2022 5265 6365 6976 6564 2061 7564   = "Received aud
-00006750: 696f 3a20 2220 2b20 6576 656e 742e 626f  io: " + event.bo
-00006760: 6479 202b 206d 7367 5f75 726c 0a20 2020  dy + msg_url.   
-00006770: 2020 2020 2020 2020 2065 6c69 6620 6973           elif is
-00006780: 696e 7374 616e 6365 2865 7665 6e74 2c20  instance(event, 
-00006790: 526f 6f6d 4d65 7373 6167 6545 6d6f 7465  RoomMessageEmote
-000067a0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000067b0: 2020 206d 7367 203d 2022 5265 6365 6976     msg = "Receiv
-000067c0: 6564 2065 6d6f 7465 3a20 2220 2b20 6576  ed emote: " + ev
-000067d0: 656e 742e 626f 6479 0a20 2020 2020 2020  ent.body.       
-000067e0: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
-000067f0: 616e 6365 2865 7665 6e74 2c20 526f 6f6d  ance(event, Room
-00006800: 4d65 7373 6167 6546 696c 6529 3a0a 2020  MessageFile):.  
-00006810: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
-00006820: 6720 3d20 2252 6563 6569 7665 6420 6669  g = "Received fi
-00006830: 6c65 3a20 2220 2b20 6576 656e 742e 626f  le: " + event.bo
-00006840: 6479 202b 206d 7367 5f75 726c 0a20 2020  dy + msg_url.   
-00006850: 2020 2020 2020 2020 2065 6c69 6620 6973           elif is
-00006860: 696e 7374 616e 6365 2865 7665 6e74 2c20  instance(event, 
-00006870: 526f 6f6d 4d65 7373 6167 6546 6f72 6d61  RoomMessageForma
-00006880: 7474 6564 293a 0a20 2020 2020 2020 2020  tted):.         
-00006890: 2020 2020 2020 206d 7367 203d 2065 7665         msg = eve
-000068a0: 6e74 2e62 6f64 790a 2020 2020 2020 2020  nt.body.        
-000068b0: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-000068c0: 6e63 6528 6576 656e 742c 2052 6f6f 6d4d  nce(event, RoomM
-000068d0: 6573 7361 6765 496d 6167 6529 3a0a 2020  essageImage):.  
-000068e0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000068f0: 5573 7561 6c6c 7920 626f 6479 2069 7320  Usually body is 
-00006900: 736f 6d65 7468 696e 6720 6c69 6b65 2022  something like "
-00006910: 696d 6167 652e 7376 6722 0a20 2020 2020  image.svg".     
-00006920: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
-00006930: 2022 5265 6365 6976 6564 2069 6d61 6765   "Received image
-00006940: 3a20 2220 2b20 6576 656e 742e 626f 6479  : " + event.body
-00006950: 202b 206d 7367 5f75 726c 0a20 2020 2020   + msg_url.     
-00006960: 2020 2020 2020 2065 6c69 6620 6973 696e         elif isin
-00006970: 7374 616e 6365 2865 7665 6e74 2c20 526f  stance(event, Ro
-00006980: 6f6d 4d65 7373 6167 654e 6f74 6963 6529  omMessageNotice)
-00006990: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000069a0: 2020 6d73 6720 3d20 6576 656e 742e 626f    msg = event.bo
-000069b0: 6479 2020 2320 4578 7472 6163 7420 7468  dy  # Extract th
-000069c0: 6520 6d65 7373 6167 6520 7465 7874 0a20  e message text. 
-000069d0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-000069e0: 6973 696e 7374 616e 6365 2865 7665 6e74  isinstance(event
-000069f0: 2c20 526f 6f6d 4d65 7373 6167 6554 6578  , RoomMessageTex
-00006a00: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-00006a10: 2020 2020 6d73 6720 3d20 6576 656e 742e      msg = event.
-00006a20: 626f 6479 2020 2320 4578 7472 6163 7420  body  # Extract 
-00006a30: 7468 6520 6d65 7373 6167 6520 7465 7874  the message text
-00006a40: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-00006a50: 6620 6973 696e 7374 616e 6365 2865 7665  f isinstance(eve
-00006a60: 6e74 2c20 526f 6f6d 4d65 7373 6167 6555  nt, RoomMessageU
-00006a70: 6e6b 6e6f 776e 293a 0a20 2020 2020 2020  nknown):.       
-00006a80: 2020 2020 2020 2020 206d 7367 203d 2022           msg = "
-00006a90: 5265 6365 6976 6564 2072 6f6f 6d20 6d65  Received room me
-00006aa0: 7373 6167 6520 6f66 2075 6e6b 6e6f 776e  ssage of unknown
-00006ab0: 2074 7970 653a 2022 202b 2065 7665 6e74   type: " + event
-00006ac0: 2e6d 7367 7479 7065 0a20 2020 2020 2020  .msgtype.       
-00006ad0: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
-00006ae0: 616e 6365 2865 7665 6e74 2c20 526f 6f6d  ance(event, Room
-00006af0: 4d65 7373 6167 6556 6964 656f 293a 0a20  MessageVideo):. 
-00006b00: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00006b10: 7367 203d 2022 5265 6365 6976 6564 2076  sg = "Received v
-00006b20: 6964 656f 3a20 2220 2b20 6576 656e 742e  ideo: " + event.
-00006b30: 626f 6479 202b 206d 7367 5f75 726c 0a20  body + msg_url. 
-00006b40: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-00006b50: 6973 696e 7374 616e 6365 2865 7665 6e74  isinstance(event
-00006b60: 2c20 526f 6f6d 456e 6372 7970 7465 6441  , RoomEncryptedA
-00006b70: 7564 696f 293a 0a20 2020 2020 2020 2020  udio):.         
-00006b80: 2020 2020 2020 206d 7367 203d 2022 5265         msg = "Re
-00006b90: 6365 6976 6564 2065 6e63 7279 7074 6564  ceived encrypted
-00006ba0: 2061 7564 696f 3a20 2220 2b20 6576 656e   audio: " + even
-00006bb0: 742e 626f 6479 202b 206d 7367 5f75 726c  t.body + msg_url
-00006bc0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-00006bd0: 6620 6973 696e 7374 616e 6365 2865 7665  f isinstance(eve
-00006be0: 6e74 2c20 526f 6f6d 456e 6372 7970 7465  nt, RoomEncrypte
-00006bf0: 6446 696c 6529 3a0a 2020 2020 2020 2020  dFile):.        
-00006c00: 2020 2020 2020 2020 6d73 6720 3d20 2252          msg = "R
-00006c10: 6563 6569 7665 6420 656e 6372 7970 7465  eceived encrypte
-00006c20: 6420 6669 6c65 3a20 2220 2b20 6576 656e  d file: " + even
-00006c30: 742e 626f 6479 202b 206d 7367 5f75 726c  t.body + msg_url
-00006c40: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-00006c50: 6620 6973 696e 7374 616e 6365 2865 7665  f isinstance(eve
-00006c60: 6e74 2c20 526f 6f6d 456e 6372 7970 7465  nt, RoomEncrypte
-00006c70: 6449 6d61 6765 293a 0a20 2020 2020 2020  dImage):.       
-00006c80: 2020 2020 2020 2020 2023 2055 7375 616c           # Usual
-00006c90: 6c79 2062 6f64 7920 6973 2073 6f6d 6574  ly body is somet
-00006ca0: 6869 6e67 206c 696b 6520 2269 6d61 6765  hing like "image
-00006cb0: 2e73 7667 220a 2020 2020 2020 2020 2020  .svg".          
-00006cc0: 2020 2020 2020 6d73 6720 3d20 2252 6563        msg = "Rec
-00006cd0: 6569 7665 6420 656e 6372 7970 7465 6420  eived encrypted 
-00006ce0: 696d 6167 653a 2022 202b 2065 7665 6e74  image: " + event
-00006cf0: 2e62 6f64 7920 2b20 6d73 675f 7572 6c0a  .body + msg_url.
-00006d00: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00006d10: 2069 7369 6e73 7461 6e63 6528 6576 656e   isinstance(even
-00006d20: 742c 2052 6f6f 6d45 6e63 7279 7074 6564  t, RoomEncrypted
-00006d30: 5669 6465 6f29 3a0a 2020 2020 2020 2020  Video):.        
-00006d40: 2020 2020 2020 2020 6d73 6720 3d20 2252          msg = "R
-00006d50: 6563 6569 7665 6420 656e 6372 7970 7465  eceived encrypte
-00006d60: 6420 7669 6465 6f3a 2022 202b 2065 7665  d video: " + eve
-00006d70: 6e74 2e62 6f64 7920 2b20 6d73 675f 7572  nt.body + msg_ur
-00006d80: 6c0a 2020 2020 2020 2020 2020 2020 656c  l.            el
-00006d90: 6966 2069 7369 6e73 7461 6e63 6528 6576  if isinstance(ev
-00006da0: 656e 742c 2052 6f6f 6d4d 6573 7361 6765  ent, RoomMessage
-00006db0: 4d65 6469 6129 3a0a 2020 2020 2020 2020  Media):.        
-00006dc0: 2020 2020 2020 2020 2320 7468 6973 2073          # this s
-00006dd0: 686f 756c 6420 6e65 7665 7220 6265 2072  hould never be r
-00006de0: 6561 6368 6564 2c20 7468 6973 2069 7320  eached, this is 
-00006df0: 6120 6261 7365 2063 6c61 7373 0a20 2020  a base class.   
-00006e00: 2020 2020 2020 2020 2020 2020 2023 2069               # i
-00006e10: 7420 7368 6f75 6c64 2062 6520 6120 6175  t should be a au
-00006e20: 6469 6f2c 2069 6d61 6765 2c20 7669 6465  dio, image, vide
-00006e30: 6f2c 2065 7463 2e0a 2020 2020 2020 2020  o, etc..        
-00006e40: 2020 2020 2020 2020 2320 5075 7420 6865          # Put he
-00006e50: 7265 2061 7420 7468 6520 656e 6420 6173  re at the end as
-00006e60: 2064 6566 656e 7369 7665 2070 726f 6772   defensive progr
-00006e70: 616d 6d69 6e67 0a20 2020 2020 2020 2020  amming.         
-00006e80: 2020 2020 2020 206d 7367 203d 2022 5265         msg = "Re
-00006e90: 6365 6976 6564 206d 6564 6961 3a20 2220  ceived media: " 
-00006ea0: 2b20 6576 656e 742e 626f 6479 202b 206d  + event.body + m
-00006eb0: 7367 5f75 726c 0a20 2020 2020 2020 2020  sg_url.         
-00006ec0: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
-00006ed0: 6365 2865 7665 6e74 2c20 526f 6f6d 456e  ce(event, RoomEn
-00006ee0: 6372 7970 7465 644d 6564 6961 293a 0a20  cryptedMedia):. 
-00006ef0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00006f00: 2074 6869 7320 7368 6f75 6c64 206e 6576   this should nev
-00006f10: 6572 2062 6520 7265 6163 6865 642c 2074  er be reached, t
-00006f20: 6869 7320 6973 2061 2062 6173 6520 636c  his is a base cl
-00006f30: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
-00006f40: 2020 2020 2320 6974 2073 686f 756c 6420      # it should 
-00006f50: 6265 2061 2061 7564 696f 2c20 696d 6167  be a audio, imag
-00006f60: 652c 2076 6964 656f 2c20 6574 632e 0a20  e, video, etc.. 
-00006f70: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00006f80: 2050 7574 2068 6572 6520 6174 2074 6865   Put here at the
-00006f90: 2065 6e64 2061 7320 6465 6665 6e73 6976   end as defensiv
-00006fa0: 6520 7072 6f67 7261 6d6d 696e 670a 2020  e programming.  
-00006fb0: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
-00006fc0: 6720 3d20 2252 6563 6569 7665 6420 656e  g = "Received en
-00006fd0: 6372 7970 7465 6420 6d65 6469 613a 2022  crypted media: "
-00006fe0: 202b 2065 7665 6e74 2e62 6f64 7920 2b20   + event.body + 
-00006ff0: 6d73 675f 7572 6c0a 2020 2020 2020 2020  msg_url.        
-00007000: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-00007010: 6e63 6528 6576 656e 742c 2052 6f6f 6d4d  nce(event, RoomM
-00007020: 656d 6265 7245 7665 6e74 293a 0a20 2020  emberEvent):.   
-00007030: 2020 2020 2020 2020 2020 2020 206d 7367               msg
-00007040: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-00007050: 2020 2020 2020 2020 2022 5265 6365 6976           "Receiv
-00007060: 6564 2072 6f6f 6d2d 6d65 6d62 6572 2065  ed room-member e
-00007070: 7665 6e74 3a20 220a 2020 2020 2020 2020  vent: ".        
-00007080: 2020 2020 2020 2020 2020 2020 6622 7365              f"se
-00007090: 6e64 6572 3a20 7b65 7665 6e74 2e73 656e  nder: {event.sen
-000070a0: 6465 727d 2c20 6f70 6572 6174 696f 6e3a  der}, operation:
-000070b0: 207b 6576 656e 742e 6d65 6d62 6572 7368   {event.membersh
-000070c0: 6970 7d22 0a20 2020 2020 2020 2020 2020  ip}".           
-000070d0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-000070e0: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
-000070f0: 6365 2865 7665 6e74 2c20 526f 6f6d 456e  ce(event, RoomEn
-00007100: 6372 7970 7469 6f6e 4576 656e 7429 3a0a  cryptionEvent):.
-00007110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007120: 6d73 6720 3d20 280a 2020 2020 2020 2020  msg = (.        
-00007130: 2020 2020 2020 2020 2020 2020 2252 6563              "Rec
-00007140: 6569 7665 6420 726f 6f6d 2d65 6e63 7279  eived room-encry
-00007150: 7074 696f 6e20 6576 656e 743a 2022 0a20  ption event: ". 
-00007160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007170: 2020 2066 2273 656e 6465 723a 207b 6576     f"sender: {ev
-00007180: 656e 742e 7365 6e64 6572 7d22 0a20 2020  ent.sender}".   
-00007190: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-000071a0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-000071b0: 6973 696e 7374 616e 6365 2865 7665 6e74  isinstance(event
-000071c0: 2c20 526f 6f6d 416c 6961 7345 7665 6e74  , RoomAliasEvent
-000071d0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000071e0: 2020 206d 7367 203d 2028 0a20 2020 2020     msg = (.     
-000071f0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00007200: 5265 6365 6976 6564 2072 6f6f 6d2d 616c  Received room-al
-00007210: 6961 7320 6576 656e 743a 2073 656e 6465  ias event: sende
-00007220: 723a 2022 0a20 2020 2020 2020 2020 2020  r: ".           
-00007230: 2020 2020 2020 2020 2066 227b 6576 656e           f"{even
-00007240: 742e 7365 6e64 6572 7d2c 2061 6c69 6173  t.sender}, alias
-00007250: 3a20 7b65 7665 6e74 2e63 616e 6f6e 6963  : {event.canonic
-00007260: 616c 5f61 6c69 6173 7d22 0a20 2020 2020  al_alias}".     
-00007270: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00007280: 2020 2020 2020 2020 2065 6c69 6620 6973           elif is
-00007290: 696e 7374 616e 6365 2865 7665 6e74 2c20  instance(event, 
-000072a0: 526f 6f6d 4e61 6d65 4576 656e 7429 3a0a  RoomNameEvent):.
-000072b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000072c0: 6d73 6720 3d20 280a 2020 2020 2020 2020  msg = (.        
-000072d0: 2020 2020 2020 2020 2020 2020 2252 6563              "Rec
-000072e0: 6569 7665 6420 726f 6f6d 2d6e 616d 6520  eived room-name 
-000072f0: 6576 656e 743a 2073 656e 6465 723a 2022  event: sender: "
-00007300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007310: 2020 2020 2066 227b 6576 656e 742e 7365       f"{event.se
-00007320: 6e64 6572 7d2c 2072 6f6f 6d20 6e61 6d65  nder}, room name
-00007330: 3a20 7b65 7665 6e74 2e6e 616d 657d 220a  : {event.name}".
-00007340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007350: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-00007360: 6966 2069 7369 6e73 7461 6e63 6528 6576  if isinstance(ev
-00007370: 656e 742c 2052 6564 6163 7465 6445 7665  ent, RedactedEve
-00007380: 6e74 293a 0a20 2020 2020 2020 2020 2020  nt):.           
-00007390: 2020 2020 206d 7367 203d 2028 0a20 2020       msg = (.   
-000073a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000073b0: 2022 5265 6365 6976 6564 2072 6564 6163   "Received redac
-000073c0: 7465 6420 6576 656e 743a 2022 0a20 2020  ted event: ".   
-000073d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000073e0: 2066 2273 656e 6465 723a 207b 6576 656e   f"sender: {even
-000073f0: 742e 7365 6e64 6572 7d2c 2022 0a20 2020  t.sender}, ".   
-00007400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007410: 2066 2274 7970 653a 207b 6576 656e 742e   f"type: {event.
-00007420: 7479 7065 7d2c 2072 6564 6163 7465 723a  type}, redacter:
-00007430: 207b 6576 656e 742e 7265 6461 6374 6572   {event.redacter
-00007440: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
-00007450: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00007460: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
-00007470: 2865 7665 6e74 2c20 5265 6461 6374 696f  (event, Redactio
-00007480: 6e45 7665 6e74 293a 0a20 2020 2020 2020  nEvent):.       
-00007490: 2020 2020 2020 2020 206d 7367 203d 2028           msg = (
-000074a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000074b0: 2020 2020 2022 5265 6365 6976 6564 2072       "Received r
-000074c0: 6564 6163 7469 6f6e 2065 7665 6e74 3a20  edaction event: 
-000074d0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-000074e0: 2020 2020 2020 6622 7365 6e64 6572 3a20        f"sender: 
-000074f0: 7b65 7665 6e74 2e73 656e 6465 727d 2c20  {event.sender}, 
-00007500: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00007510: 2020 2020 2020 6622 7265 6461 6374 733a        f"redacts:
-00007520: 207b 6576 656e 742e 7265 6461 6374 737d   {event.redacts}
-00007530: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00007540: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00007550: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
-00007560: 6576 656e 742c 2055 6e6b 6e6f 776e 4576  event, UnknownEv
-00007570: 656e 7429 3a0a 2020 2020 2020 2020 2020  ent):.          
-00007580: 2020 2020 2020 6966 2065 7665 6e74 2e74        if event.t
-00007590: 7970 6520 3d3d 2022 6d2e 7265 6163 7469  ype == "m.reacti
-000075a0: 6f6e 223a 0a20 2020 2020 2020 2020 2020  on":.           
-000075b0: 2020 2020 2020 2020 206d 7367 203d 2028           msg = (
-000075c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000075d0: 2020 2020 2020 2020 2022 5265 6365 6976           "Receiv
-000075e0: 6564 2061 2072 6561 6374 696f 6e2c 2061  ed a reaction, a
-000075f0: 6e20 656d 6f6a 693a 2022 0a20 2020 2020  n emoji: ".     
-00007600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007610: 2020 2066 227b 6576 656e 742e 736f 7572     f"{event.sour
-00007620: 6365 5b27 636f 6e74 656e 7427 5d5b 276d  ce['content']['m
-00007630: 2e72 656c 6174 6573 5f74 6f27 5d5b 276b  .relates_to']['k
-00007640: 6579 275d 7d22 0a20 2020 2020 2020 2020  ey']}".         
-00007650: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00007660: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00007670: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00007680: 2020 2020 2020 206d 7367 203d 2066 2252         msg = f"R
-00007690: 6563 6569 7665 6420 756e 6b6e 6f77 6e20  eceived unknown 
-000076a0: 6576 656e 743a 207b 6576 656e 747d 220a  event: {event}".
-000076b0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000076c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000076d0: 2020 6d73 6720 3d20 6622 5265 6365 6976    msg = f"Receiv
-000076e0: 6564 2075 6e6b 6e6f 776e 2065 7665 6e74  ed unknown event
-000076f0: 3a20 7b65 7665 6e74 7d22 0a0a 2020 2020  : {event}"..    
-00007700: 2020 2020 2020 2020 2320 6966 2065 7665          # if eve
-00007710: 6e74 5b27 7479 7065 275d 203d 3d20 226d  nt['type'] == "m
-00007720: 2e72 6f6f 6d2e 6d65 7373 6167 6522 3a0a  .room.message":.
-00007730: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-00007740: 2069 6620 6576 656e 745b 2763 6f6e 7465   if event['conte
-00007750: 6e74 275d 5b27 6d73 6774 7970 6527 5d20  nt']['msgtype'] 
-00007760: 3d3d 2022 6d2e 7465 7874 223a 0a20 2020  == "m.text":.   
-00007770: 2020 2020 2020 2020 2023 2020 2020 2020           #      
-00007780: 2020 636f 6e74 656e 7420 3d20 6576 656e    content = even
-00007790: 745b 2763 6f6e 7465 6e74 275d 5b27 626f  t['content']['bo
-000077a0: 6479 275d 0a20 2020 2020 2020 2020 2020  dy'].           
-000077b0: 2023 2020 2020 656c 7365 3a0a 2020 2020   #    else:.    
-000077c0: 2020 2020 2020 2020 2320 2020 2020 2020          #       
-000077d0: 2064 6f77 6e6c 6f61 645f 7572 6c20 3d20   download_url = 
-000077e0: 6170 692e 6765 745f 646f 776e 6c6f 6164  api.get_download
-000077f0: 5f75 726c 280a 2020 2020 2020 2020 2020  _url(.          
-00007800: 2020 2320 2020 2020 2020 2020 2020 2065    #            e
-00007810: 7665 6e74 5b27 636f 6e74 656e 7427 5d5b  vent['content'][
-00007820: 2775 726c 275d 290a 2020 2020 2020 2020  'url']).        
-00007830: 2020 2020 2320 2020 2020 2020 2063 6f6e      #        con
-00007840: 7465 6e74 203d 2064 6f77 6e6c 6f61 645f  tent = download_
-00007850: 7572 6c0a 2020 2020 2020 2020 2020 2020  url.            
-00007860: 2320 656c 7365 3a0a 2020 2020 2020 2020  # else:.        
-00007870: 2020 2020 2320 2020 2063 6f6e 7465 6e74      #    content
-00007880: 203d 2022 5c6e 7b7b 2022 202b 2065 7665   = "\n{{ " + eve
-00007890: 6e74 5b27 7479 7065 275d 202b 2022 2065  nt['type'] + " e
-000078a0: 7665 6e74 207d 7d5c 6e22 0a20 2020 2020  vent }}\n".     
-000078b0: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-000078c0: 6275 6728 6622 7479 7065 286d 7367 2920  bug(f"type(msg) 
-000078d0: 3d20 7b74 7970 6528 6d73 6729 7d2e 206d  = {type(msg)}. m
-000078e0: 7367 2069 7320 6120 7374 7269 6e67 2229  sg is a string")
-000078f0: 0a20 2020 2020 2020 2020 2020 2073 656e  .            sen
-00007900: 6465 725f 6e69 636b 203d 2072 6f6f 6d2e  der_nick = room.
-00007910: 7573 6572 5f6e 616d 6528 6576 656e 742e  user_name(event.
-00007920: 7365 6e64 6572 290a 2020 2020 2020 2020  sender).        
-00007930: 2020 2020 6966 206e 6f74 2073 656e 6465      if not sende
-00007940: 725f 6e69 636b 3a20 2023 2063 6f6e 7665  r_nick:  # conve
-00007950: 7274 2040 666f 6f3a 6d61 742e 696f 2069  rt @foo:mat.io i
-00007960: 6e74 6f20 666f 6f0a 2020 2020 2020 2020  nto foo.        
-00007970: 2020 2020 2020 2020 7365 6e64 6572 5f6e          sender_n
-00007980: 6963 6b20 3d20 7573 6572 5f69 645f 746f  ick = user_id_to
-00007990: 5f73 686f 7274 5f75 7365 725f 6e61 6d65  _short_user_name
-000079a0: 2865 7665 6e74 2e73 656e 6465 7229 0a20  (event.sender). 
-000079b0: 2020 2020 2020 2020 2020 2072 6f6f 6d5f             room_
-000079c0: 6e69 636b 203d 2072 6f6f 6d2e 6469 7370  nick = room.disp
-000079d0: 6c61 795f 6e61 6d65 0a20 2020 2020 2020  lay_name.       
-000079e0: 2020 2020 2069 6620 726f 6f6d 5f6e 6963       if room_nic
-000079f0: 6b20 696e 2028 4e6f 6e65 2c20 2222 2c20  k in (None, "", 
-00007a00: 2245 6d70 7479 2052 6f6f 6d22 293a 0a20  "Empty Room"):. 
-00007a10: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00007a20: 6f6f 6d5f 6e69 636b 203d 2022 556e 6465  oom_nick = "Unde
-00007a30: 7465 726d 696e 6564 220a 2020 2020 2020  termined".      
-00007a40: 2020 2020 2020 6966 2067 732e 7061 2e70        if gs.pa.p
-00007a50: 7269 6e74 5f65 7665 6e74 5f69 643a 0a20  rint_event_id:. 
-00007a60: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00007a70: 7665 6e74 5f69 645f 6465 7461 696c 203d  vent_id_detail =
-00007a80: 2066 2220 7c20 7b65 7665 6e74 2e65 7665   f" | {event.eve
-00007a90: 6e74 5f69 647d 220a 2020 2020 2020 2020  nt_id}".        
-00007aa0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00007ab0: 2020 2020 2020 2020 2020 6576 656e 745f            event_
-00007ac0: 6964 5f64 6574 6169 6c20 3d20 2222 0a20  id_detail = "". 
-00007ad0: 2020 2020 2020 2020 2020 2023 2050 7265             # Pre
-00007ae0: 7665 6e74 2066 616b 696e 6720 6d65 7373  vent faking mess
-00007af0: 6167 6573 2062 7920 7072 6566 6978 696e  ages by prefixin
-00007b00: 6720 6561 6368 206c 696e 6520 6f66 2061  g each line of a
-00007b10: 206d 756c 7469 6c69 6e65 0a20 2020 2020   multiline.     
-00007b20: 2020 2020 2020 2023 206d 6573 7361 6765         # message
-00007b30: 2077 6974 6820 7370 6163 652e 0a20 2020   with space..   
-00007b40: 2020 2020 2020 2020 2066 6978 6564 5f6d           fixed_m
-00007b50: 7367 203d 2072 652e 7375 6228 225c 6e22  sg = re.sub("\n"
-00007b60: 2c20 225c 6e20 2020 2022 2c20 6d73 6729  , "\n    ", msg)
-00007b70: 0a20 2020 2020 2020 2020 2020 2063 6f6d  .            com
-00007b80: 706c 6574 655f 6d73 6720 3d20 280a 2020  plete_msg = (.  
-00007b90: 2020 2020 2020 2020 2020 2020 2020 224d                "M
-00007ba0: 6573 7361 6765 2072 6563 6569 7665 6420  essage received 
-00007bb0: 666f 7220 726f 6f6d 2022 0a20 2020 2020  for room ".     
-00007bc0: 2020 2020 2020 2020 2020 2066 227b 726f             f"{ro
-00007bd0: 6f6d 5f6e 6963 6b7d 205b 7b72 6f6f 6d2e  om_nick} [{room.
-00007be0: 726f 6f6d 5f69 647d 5d20 7c20 220a 2020  room_id}] | ".  
-00007bf0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00007c00: 7365 6e64 6572 207b 7365 6e64 6572 5f6e  sender {sender_n
-00007c10: 6963 6b7d 2022 0a20 2020 2020 2020 2020  ick} ".         
-00007c20: 2020 2020 2020 2066 225b 7b65 7665 6e74         f"[{event
-00007c30: 2e73 656e 6465 727d 5d20 7c20 7b65 7665  .sender}] | {eve
-00007c40: 6e74 5f64 6174 6574 696d 657d 220a 2020  nt_datetime}".  
-00007c50: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00007c60: 7b65 7665 6e74 5f69 645f 6465 7461 696c  {event_id_detail
-00007c70: 7d20 7c20 7b66 6978 6564 5f6d 7367 7d22  } | {fixed_msg}"
-00007c80: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00007c90: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-00007ca0: 672e 6465 6275 6728 636f 6d70 6c65 7465  g.debug(complete
-00007cb0: 5f6d 7367 290a 2020 2020 2020 2020 2020  _msg).          
-00007cc0: 2020 2320 6f75 7470 7574 2066 6f72 6d61    # output forma
-00007cd0: 7420 636f 6e74 726f 6c6c 6564 2076 6961  t controlled via
-00007ce0: 202d 2d6f 7574 7075 7420 666c 6167 0a20   --output flag. 
-00007cf0: 2020 2020 2020 2020 2020 2074 6578 7420             text 
-00007d00: 3d20 636f 6d70 6c65 7465 5f6d 7367 2020  = complete_msg  
-00007d10: 2320 7072 696e 7420 7468 6520 7265 6365  # print the rece
-00007d20: 6976 6564 206d 6573 7361 6765 0a20 2020  ived message.   
-00007d30: 2020 2020 2020 2020 206a 736f 6e5f 203d           json_ =
-00007d40: 207b 2273 6f75 7263 6522 3a20 6576 656e   {"source": even
-00007d50: 742e 736f 7572 6365 7d0a 2020 2020 2020  t.source}.      
-00007d60: 2020 2020 2020 6a73 6f6e 5f2e 7570 6461        json_.upda
-00007d70: 7465 287b 2272 6f6f 6d22 3a20 726f 6f6d  te({"room": room
-00007d80: 7d29 0a20 2020 2020 2020 2020 2020 206a  }).            j
-00007d90: 736f 6e5f 2e75 7064 6174 6528 7b22 726f  son_.update({"ro
-00007da0: 6f6d 5f64 6973 706c 6179 5f6e 616d 6522  om_display_name"
-00007db0: 3a20 726f 6f6d 2e64 6973 706c 6179 5f6e  : room.display_n
-00007dc0: 616d 657d 290a 2020 2020 2020 2020 2020  ame}).          
-00007dd0: 2020 6a73 6f6e 5f2e 7570 6461 7465 287b    json_.update({
-00007de0: 2273 656e 6465 725f 6e69 636b 223a 2073  "sender_nick": s
-00007df0: 656e 6465 725f 6e69 636b 7d29 0a20 2020  ender_nick}).   
-00007e00: 2020 2020 2020 2020 206a 736f 6e5f 2e75           json_.u
-00007e10: 7064 6174 6528 7b22 6576 656e 745f 6461  pdate({"event_da
-00007e20: 7465 7469 6d65 223a 2065 7665 6e74 5f64  tetime": event_d
-00007e30: 6174 6574 696d 657d 290a 2020 2020 2020  atetime}).      
-00007e40: 2020 2020 2020 6a73 6f6e 5f6d 6178 203d        json_max =
-00007e50: 2065 7665 6e74 2e5f 5f64 6963 745f 5f0a   event.__dict__.
-00007e60: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-00007e70: 5f6d 6178 2e75 7064 6174 6528 7b22 726f  _max.update({"ro
-00007e80: 6f6d 223a 2072 6f6f 6d7d 290a 2020 2020  om": room}).    
-00007e90: 2020 2020 2020 2020 6a73 6f6e 5f6d 6178          json_max
-00007ea0: 2e75 7064 6174 6528 7b22 726f 6f6d 5f64  .update({"room_d
-00007eb0: 6973 706c 6179 5f6e 616d 6522 3a20 726f  isplay_name": ro
-00007ec0: 6f6d 2e64 6973 706c 6179 5f6e 616d 657d  om.display_name}
-00007ed0: 290a 2020 2020 2020 2020 2020 2020 6a73  ).            js
-00007ee0: 6f6e 5f6d 6178 2e75 7064 6174 6528 7b22  on_max.update({"
-00007ef0: 7365 6e64 6572 5f6e 6963 6b22 3a20 7365  sender_nick": se
-00007f00: 6e64 6572 5f6e 6963 6b7d 290a 2020 2020  nder_nick}).    
-00007f10: 2020 2020 2020 2020 6a73 6f6e 5f6d 6178          json_max
-00007f20: 2e75 7064 6174 6528 7b22 6576 656e 745f  .update({"event_
-00007f30: 6461 7465 7469 6d65 223a 2065 7665 6e74  datetime": event
-00007f40: 5f64 6174 6574 696d 657d 290a 2020 2020  _datetime}).    
-00007f50: 2020 2020 2020 2020 6a73 6f6e 5f73 7065          json_spe
-00007f60: 6320 3d20 6576 656e 742e 736f 7572 6365  c = event.source
-00007f70: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00007f80: 6e74 5f6f 7574 7075 7428 0a20 2020 2020  nt_output(.     
-00007f90: 2020 2020 2020 2020 2020 2067 732e 7061             gs.pa
-00007fa0: 2e6f 7574 7075 742c 0a20 2020 2020 2020  .output,.       
-00007fb0: 2020 2020 2020 2020 2074 6578 743d 7465           text=te
-00007fc0: 7874 2c0a 2020 2020 2020 2020 2020 2020  xt,.            
-00007fd0: 2020 2020 6a73 6f6e 5f3d 6a73 6f6e 5f2c      json_=json_,
-00007fe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007ff0: 206a 736f 6e5f 6d61 783d 6a73 6f6e 5f6d   json_max=json_m
-00008000: 6178 2c0a 2020 2020 2020 2020 2020 2020  ax,.            
-00008010: 2020 2020 6a73 6f6e 5f73 7065 633d 6a73      json_spec=js
-00008020: 6f6e 5f73 7065 632c 0a20 2020 2020 2020  on_spec,.       
-00008030: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00008040: 2020 2020 6966 2067 732e 7061 2e6f 735f      if gs.pa.os_
-00008050: 6e6f 7469 6679 3a0a 2020 2020 2020 2020  notify:.        
-00008060: 2020 2020 2020 2020 6176 6174 6172 5f75          avatar_u
-00008070: 726c 203d 2061 7761 6974 2067 6574 5f61  rl = await get_a
-00008080: 7661 7461 725f 7572 6c28 7365 6c66 2e63  vatar_url(self.c
-00008090: 6c69 656e 742c 2065 7665 6e74 2e73 656e  lient, event.sen
-000080a0: 6465 7229 0a20 2020 2020 2020 2020 2020  der).           
-000080b0: 2020 2020 206e 6f74 6966 7928 0a20 2020       notify(.   
-000080c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000080d0: 2066 2246 726f 6d20 7b72 6f6f 6d2e 7573   f"From {room.us
-000080e0: 6572 5f6e 616d 6528 6576 656e 742e 7365  er_name(event.se
-000080f0: 6e64 6572 297d 222c 0a20 2020 2020 2020  nder)}",.       
-00008100: 2020 2020 2020 2020 2020 2020 206d 7367               msg
-00008110: 5b3a 3136 305d 2c0a 2020 2020 2020 2020  [:160],.        
-00008120: 2020 2020 2020 2020 2020 2020 6176 6174              avat
-00008130: 6172 5f75 726c 2c0a 2020 2020 2020 2020  ar_url,.        
-00008140: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00008150: 2020 2065 7863 6570 7420 4261 7365 4578     except BaseEx
-00008160: 6365 7074 696f 6e3a 0a20 2020 2020 2020  ception:.       
-00008170: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-00008180: 6728 2248 6572 6520 6973 2074 6865 2074  g("Here is the t
-00008190: 7261 6365 6261 636b 2e5c 6e22 202b 2074  raceback.\n" + t
-000081a0: 7261 6365 6261 636b 2e66 6f72 6d61 745f  raceback.format_
-000081b0: 6578 6328 2929 0a0a 2020 2020 2320 6163  exc())..    # ac
-000081c0: 636f 7264 696e 6720 746f 206c 696e 7465  cording to linte
-000081d0: 723a 2066 756e 6374 696f 6e20 6973 2074  r: function is t
-000081e0: 6f6f 2063 6f6d 706c 6578 2c20 4339 3031  oo complex, C901
-000081f0: 0a20 2020 2061 7379 6e63 2064 6566 2074  .    async def t
-00008200: 6f5f 6465 7669 6365 5f63 616c 6c62 6163  o_device_callbac
-00008210: 6b28 7365 6c66 2c20 6576 656e 7429 3a20  k(self, event): 
-00008220: 2023 206e 6f71 613a 2043 3930 310a 2020   # noqa: C901.  
-00008230: 2020 2020 2020 2222 2248 616e 646c 6520        """Handle 
-00008240: 6576 656e 7473 2073 656e 7420 746f 2064  events sent to d
-00008250: 6576 6963 652e 2222 220a 2020 2020 2020  evice.""".      
-00008260: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00008270: 2020 2063 6c69 656e 7420 3d20 7365 6c66     client = self
-00008280: 2e63 6c69 656e 740a 0a20 2020 2020 2020  .client..       
-00008290: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-000082a0: 6365 2865 7665 6e74 2c20 4b65 7956 6572  ce(event, KeyVer
-000082b0: 6966 6963 6174 696f 6e53 7461 7274 293a  ificationStart):
-000082c0: 2020 2320 6669 7273 7420 7374 6570 0a20    # first step. 
-000082d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000082e0: 2222 6669 7273 7420 7374 6570 3a20 7265  ""first step: re
-000082f0: 6365 6976 6520 4b65 7956 6572 6966 6963  ceive KeyVerific
-00008300: 6174 696f 6e53 7461 7274 0a20 2020 2020  ationStart.     
-00008310: 2020 2020 2020 2020 2020 204b 6579 5665             KeyVe
-00008320: 7269 6669 6361 7469 6f6e 5374 6172 7428  rificationStart(
-00008330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008340: 2020 2020 2073 6f75 7263 653d 7b27 636f       source={'co
-00008350: 6e74 656e 7427 3a0a 2020 2020 2020 2020  ntent':.        
-00008360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008370: 2020 2020 7b27 6d65 7468 6f64 273a 2027      {'method': '
-00008380: 6d2e 7361 732e 7631 272c 0a20 2020 2020  m.sas.v1',.     
-00008390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000083a0: 2020 2020 2020 2020 2766 726f 6d5f 6465          'from_de
-000083b0: 7669 6365 273a 2027 4445 5649 4345 4944  vice': 'DEVICEID
-000083c0: 5859 272c 0a20 2020 2020 2020 2020 2020  XY',.           
-000083d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000083e0: 2020 276b 6579 5f61 6772 6565 6d65 6e74    'key_agreement
-000083f0: 5f70 726f 746f 636f 6c73 273a 0a20 2020  _protocols':.   
-00008400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008410: 2020 2020 2020 2020 2020 2020 205b 2763               ['c
-00008420: 7572 7665 3235 3531 392d 686b 6466 2d73  urve25519-hkdf-s
-00008430: 6861 3235 3627 2c20 2763 7572 7665 3235  ha256', 'curve25
-00008440: 3531 3927 5d2c 0a20 2020 2020 2020 2020  519'],.         
-00008450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008460: 2020 2020 2768 6173 6865 7327 3a20 5b27      'hashes': ['
-00008470: 7368 6132 3536 275d 2c0a 2020 2020 2020  sha256'],.      
-00008480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008490: 2020 2020 2020 2027 6d65 7373 6167 655f         'message_
-000084a0: 6175 7468 656e 7469 6361 7469 6f6e 5f63  authentication_c
-000084b0: 6f64 6573 273a 0a20 2020 2020 2020 2020  odes':.         
-000084c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000084d0: 2020 2020 2020 205b 2768 6b64 662d 686d         ['hkdf-hm
-000084e0: 6163 2d73 6861 3235 3627 2c20 2768 6d61  ac-sha256', 'hma
-000084f0: 632d 7368 6132 3536 275d 2c0a 2020 2020  c-sha256'],.    
-00008500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008510: 2020 2020 2020 2020 2027 7368 6f72 745f           'short_
-00008520: 6175 7468 656e 7469 6361 7469 6f6e 5f73  authentication_s
-00008530: 7472 696e 6727 3a0a 2020 2020 2020 2020  tring':.        
-00008540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008550: 2020 2020 2020 2020 5b27 6465 6369 6d61          ['decima
-00008560: 6c27 2c20 2765 6d6f 6a69 275d 2c0a 2020  l', 'emoji'],.  
-00008570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008580: 2020 2020 2020 2020 2020 2027 7472 616e             'tran
-00008590: 7361 6374 696f 6e5f 6964 273a 2027 536f  saction_id': 'So
-000085a0: 6d65 5478 4964 270a 2020 2020 2020 2020  meTxId'.        
-000085b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000085c0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-000085d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000085e0: 2020 2020 2774 7970 6527 3a20 276d 2e6b      'type': 'm.k
-000085f0: 6579 2e76 6572 6966 6963 6174 696f 6e2e  ey.verification.
-00008600: 7374 6172 7427 2c0a 2020 2020 2020 2020  start',.        
-00008610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008620: 2020 2020 2773 656e 6465 7227 3a20 2740      'sender': '@
-00008630: 7573 6572 323a 6578 616d 706c 652e 6f72  user2:example.or
-00008640: 6727 0a20 2020 2020 2020 2020 2020 2020  g'.             
-00008650: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00008660: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00008670: 2020 2020 2020 7365 6e64 6572 3d27 4075        sender='@u
-00008680: 7365 7232 3a65 7861 6d70 6c65 2e6f 7267  ser2:example.org
-00008690: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-000086a0: 2020 2020 2020 2074 7261 6e73 6163 7469         transacti
-000086b0: 6f6e 5f69 643d 2753 6f6d 6554 7849 6427  on_id='SomeTxId'
-000086c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000086d0: 2020 2020 2020 6672 6f6d 5f64 6576 6963        from_devic
-000086e0: 653d 2744 4556 4943 4549 4458 5927 2c0a  e='DEVICEIDXY',.
-000086f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008700: 2020 2020 6d65 7468 6f64 3d27 6d2e 7361      method='m.sa
-00008710: 732e 7631 272c 0a20 2020 2020 2020 2020  s.v1',.         
-00008720: 2020 2020 2020 2020 2020 206b 6579 5f61             key_a
-00008730: 6772 6565 6d65 6e74 5f70 726f 746f 636f  greement_protoco
-00008740: 6c73 3d5b 0a20 2020 2020 2020 2020 2020  ls=[.           
-00008750: 2020 2020 2020 2020 2020 2020 2027 6375               'cu
-00008760: 7276 6532 3535 3139 2d68 6b64 662d 7368  rve25519-hkdf-sh
-00008770: 6132 3536 272c 2027 6375 7276 6532 3535  a256', 'curve255
-00008780: 3139 275d 2c0a 2020 2020 2020 2020 2020  19'],.          
-00008790: 2020 2020 2020 2020 2020 6861 7368 6573            hashes
-000087a0: 3d5b 2773 6861 3235 3627 5d2c 0a20 2020  =['sha256'],.   
-000087b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000087c0: 206d 6573 7361 6765 5f61 7574 6865 6e74   message_authent
-000087d0: 6963 6174 696f 6e5f 636f 6465 733d 5b0a  ication_codes=[.
-000087e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000087f0: 2020 2020 2020 2020 2768 6b64 662d 686d          'hkdf-hm
-00008800: 6163 2d73 6861 3235 3627 2c20 2768 6d61  ac-sha256', 'hma
-00008810: 632d 7368 6132 3536 275d 2c0a 2020 2020  c-sha256'],.    
-00008820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008830: 7368 6f72 745f 6175 7468 656e 7469 6361  short_authentica
-00008840: 7469 6f6e 5f73 7472 696e 673d 5b27 6465  tion_string=['de
-00008850: 6369 6d61 6c27 2c20 2765 6d6f 6a69 275d  cimal', 'emoji']
-00008860: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00008870: 2020 2222 220a 0a20 2020 2020 2020 2020    """..         
-00008880: 2020 2020 2020 2069 6620 2265 6d6f 6a69         if "emoji
-00008890: 2220 6e6f 7420 696e 2065 7665 6e74 2e73  " not in event.s
-000088a0: 686f 7274 5f61 7574 6865 6e74 6963 6174  hort_authenticat
-000088b0: 696f 6e5f 7374 7269 6e67 3a0a 2020 2020  ion_string:.    
-000088c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000088d0: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
-000088e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000088f0: 2020 2020 2020 2245 3130 373a 2022 0a20        "E107: ". 
-00008900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008910: 2020 2020 2020 2022 4f74 6865 7220 6465         "Other de
-00008920: 7669 6365 2064 6f65 7320 6e6f 7420 7375  vice does not su
-00008930: 7070 6f72 7420 656d 6f6a 6920 7665 7269  pport emoji veri
-00008940: 6669 6361 7469 6f6e 2e20 220a 2020 2020  fication. ".    
-00008950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008960: 2020 2020 6622 7b65 7665 6e74 2e73 686f      f"{event.sho
-00008970: 7274 5f61 7574 6865 6e74 6963 6174 696f  rt_authenticatio
-00008980: 6e5f 7374 7269 6e67 7d2e 220a 2020 2020  n_string}.".    
-00008990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000089a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000089b0: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-000089c0: 2020 2020 2020 2020 2020 2020 2072 6573               res
-000089d0: 7020 3d20 6177 6169 7420 636c 6965 6e74  p = await client
-000089e0: 2e61 6363 6570 745f 6b65 795f 7665 7269  .accept_key_veri
-000089f0: 6669 6361 7469 6f6e 280a 2020 2020 2020  fication(.      
-00008a00: 2020 2020 2020 2020 2020 2020 2020 6576                ev
-00008a10: 656e 742e 7472 616e 7361 6374 696f 6e5f  ent.transaction_
-00008a20: 6964 0a20 2020 2020 2020 2020 2020 2020  id.             
-00008a30: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00008a40: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-00008a50: 6365 2872 6573 702c 2054 6f44 6576 6963  ce(resp, ToDevic
-00008a60: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-00008a70: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
-00008a80: 6c6f 672e 6572 726f 7228 0a20 2020 2020  log.error(.     
-00008a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008aa0: 2020 2022 4531 3038 3a20 220a 2020 2020     "E108: ".    
-00008ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ac0: 2020 2020 2261 6363 6570 745f 6b65 795f      "accept_key_
-00008ad0: 7665 7269 6669 6361 7469 6f6e 2066 6169  verification fai
-00008ae0: 6c65 6420 7769 7468 2065 7272 6f72 2022  led with error "
-00008af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008b00: 2020 2020 2020 2020 2066 2227 7b70 7269           f"'{pri
-00008b10: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
-00008b20: 7265 7370 2929 7d27 2e22 0a20 2020 2020  resp))}'.".     
-00008b30: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00008b40: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00008b50: 2020 7361 7320 3d20 636c 6965 6e74 2e6b    sas = client.k
-00008b60: 6579 5f76 6572 6966 6963 6174 696f 6e73  ey_verifications
-00008b70: 5b65 7665 6e74 2e74 7261 6e73 6163 7469  [event.transacti
-00008b80: 6f6e 5f69 645d 0a0a 2020 2020 2020 2020  on_id]..        
-00008b90: 2020 2020 2020 2020 746f 6465 7669 6365          todevice
-00008ba0: 5f6d 7367 203d 2073 6173 2e73 6861 7265  _msg = sas.share
-00008bb0: 5f6b 6579 2829 0a20 2020 2020 2020 2020  _key().         
-00008bc0: 2020 2020 2020 2072 6573 7020 3d20 6177         resp = aw
-00008bd0: 6169 7420 636c 6965 6e74 2e74 6f5f 6465  ait client.to_de
-00008be0: 7669 6365 2874 6f64 6576 6963 655f 6d73  vice(todevice_ms
-00008bf0: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
-00008c00: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-00008c10: 2872 6573 702c 2054 6f44 6576 6963 6545  (resp, ToDeviceE
-00008c20: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-00008c30: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-00008c40: 672e 6572 726f 7228 0a20 2020 2020 2020  g.error(.       
-00008c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008c60: 2022 4531 3039 3a20 220a 2020 2020 2020   "E109: ".      
-00008c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008c80: 2020 2274 6f5f 6465 7669 6365 2066 6169    "to_device fai
-00008c90: 6c65 6420 7769 7468 2065 7272 6f72 2022  led with error "
-00008ca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008cb0: 2020 2020 2020 2020 2066 2227 7b70 7269           f"'{pri
-00008cc0: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
-00008cd0: 7265 7370 2929 7d27 2e22 0a20 2020 2020  resp))}'.".     
-00008ce0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00008cf0: 0a0a 2020 2020 2020 2020 2020 2020 656c  ..            el
-00008d00: 6966 2069 7369 6e73 7461 6e63 6528 6576  if isinstance(ev
-00008d10: 656e 742c 204b 6579 5665 7269 6669 6361  ent, KeyVerifica
-00008d20: 7469 6f6e 4361 6e63 656c 293a 2020 2320  tionCancel):  # 
-00008d30: 616e 7974 696d 650a 2020 2020 2020 2020  anytime.        
-00008d40: 2020 2020 2020 2020 2222 2261 7420 616e          """at an
-00008d50: 7920 7469 6d65 3a20 7265 6365 6976 6520  y time: receive 
-00008d60: 4b65 7956 6572 6966 6963 6174 696f 6e43  KeyVerificationC
-00008d70: 616e 6365 6c0a 2020 2020 2020 2020 2020  ancel.          
-00008d80: 2020 2020 2020 4b65 7956 6572 6966 6963        KeyVerific
-00008d90: 6174 696f 6e43 616e 6365 6c28 736f 7572  ationCancel(sour
-00008da0: 6365 3d7b 0a20 2020 2020 2020 2020 2020  ce={.           
-00008db0: 2020 2020 2020 2020 2027 636f 6e74 656e           'conten
-00008dc0: 7427 3a20 7b27 636f 6465 273a 2027 6d2e  t': {'code': 'm.
-00008dd0: 6d69 736d 6174 6368 6564 5f73 6173 272c  mismatched_sas',
-00008de0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000065d0: 2020 2020 2020 2020 2020 2020 2066 696c               fil
+000065e0: 656e 616d 652c 0a20 2020 2020 2020 2020  ename,.         
+000065f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006600: 2020 2020 2020 206e 733d 2828 6576 656e         ns=((even
+00006610: 742e 7365 7276 6572 5f74 696d 6573 7461  t.server_timesta
+00006620: 6d70 202a 2031 3030 3030 3030 2c29 202a  mp * 1000000,) *
+00006630: 2032 292c 0a20 2020 2020 2020 2020 2020   2),.           
+00006640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006650: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00006660: 2020 2020 2020 2020 2020 206d 7367 5f75             msg_u
+00006670: 726c 202b 3d20 280a 2020 2020 2020 2020  rl += (.        
+00006680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006690: 2020 2020 2220 5b44 6f77 6e6c 6f61 6465      " [Downloade
+000066a0: 6420 616e 6420 6465 6372 7970 7465 6420  d and decrypted 
+000066b0: 6d65 6469 6120 220a 2020 2020 2020 2020  media ".        
+000066c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000066d0: 2020 2020 6622 6669 6c65 2074 6f20 7b66      f"file to {f
+000066e0: 696c 656e 616d 657d 5d22 0a20 2020 2020  ilename}]".     
+000066f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006700: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+00006710: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00006720: 6576 656e 742c 2052 6f6f 6d4d 6573 7361  event, RoomMessa
+00006730: 6765 4175 6469 6f29 3a0a 2020 2020 2020  geAudio):.      
+00006740: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
+00006750: 2252 6563 6569 7665 6420 6175 6469 6f3a  "Received audio:
+00006760: 2022 202b 2065 7665 6e74 2e62 6f64 7920   " + event.body 
+00006770: 2b20 6d73 675f 7572 6c0a 2020 2020 2020  + msg_url.      
+00006780: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
+00006790: 7461 6e63 6528 6576 656e 742c 2052 6f6f  tance(event, Roo
+000067a0: 6d4d 6573 7361 6765 456d 6f74 6529 3a0a  mMessageEmote):.
+000067b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000067c0: 6d73 6720 3d20 2252 6563 6569 7665 6420  msg = "Received 
+000067d0: 656d 6f74 653a 2022 202b 2065 7665 6e74  emote: " + event
+000067e0: 2e62 6f64 790a 2020 2020 2020 2020 2020  .body.          
+000067f0: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+00006800: 6528 6576 656e 742c 2052 6f6f 6d4d 6573  e(event, RoomMes
+00006810: 7361 6765 4669 6c65 293a 0a20 2020 2020  sageFile):.     
+00006820: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
+00006830: 2022 5265 6365 6976 6564 2066 696c 653a   "Received file:
+00006840: 2022 202b 2065 7665 6e74 2e62 6f64 7920   " + event.body 
+00006850: 2b20 6d73 675f 7572 6c0a 2020 2020 2020  + msg_url.      
+00006860: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
+00006870: 7461 6e63 6528 6576 656e 742c 2052 6f6f  tance(event, Roo
+00006880: 6d4d 6573 7361 6765 466f 726d 6174 7465  mMessageFormatte
+00006890: 6429 3a0a 2020 2020 2020 2020 2020 2020  d):.            
+000068a0: 2020 2020 6d73 6720 3d20 6576 656e 742e      msg = event.
+000068b0: 626f 6479 0a20 2020 2020 2020 2020 2020  body.           
+000068c0: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
+000068d0: 2865 7665 6e74 2c20 526f 6f6d 4d65 7373  (event, RoomMess
+000068e0: 6167 6549 6d61 6765 293a 0a20 2020 2020  ageImage):.     
+000068f0: 2020 2020 2020 2020 2020 2023 2055 7375             # Usu
+00006900: 616c 6c79 2062 6f64 7920 6973 2073 6f6d  ally body is som
+00006910: 6574 6869 6e67 206c 696b 6520 2269 6d61  ething like "ima
+00006920: 6765 2e73 7667 220a 2020 2020 2020 2020  ge.svg".        
+00006930: 2020 2020 2020 2020 6d73 6720 3d20 2252          msg = "R
+00006940: 6563 6569 7665 6420 696d 6167 653a 2022  eceived image: "
+00006950: 202b 2065 7665 6e74 2e62 6f64 7920 2b20   + event.body + 
+00006960: 6d73 675f 7572 6c0a 2020 2020 2020 2020  msg_url.        
+00006970: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
+00006980: 6e63 6528 6576 656e 742c 2052 6f6f 6d4d  nce(event, RoomM
+00006990: 6573 7361 6765 4e6f 7469 6365 293a 0a20  essageNotice):. 
+000069a0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+000069b0: 7367 203d 2065 7665 6e74 2e62 6f64 7920  sg = event.body 
+000069c0: 2023 2045 7874 7261 6374 2074 6865 206d   # Extract the m
+000069d0: 6573 7361 6765 2074 6578 740a 2020 2020  essage text.    
+000069e0: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
+000069f0: 6e73 7461 6e63 6528 6576 656e 742c 2052  nstance(event, R
+00006a00: 6f6f 6d4d 6573 7361 6765 5465 7874 293a  oomMessageText):
+00006a10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006a20: 206d 7367 203d 2065 7665 6e74 2e62 6f64   msg = event.bod
+00006a30: 7920 2023 2045 7874 7261 6374 2074 6865  y  # Extract the
+00006a40: 206d 6573 7361 6765 2074 6578 740a 2020   message text.  
+00006a50: 2020 2020 2020 2020 2020 656c 6966 2069            elif i
+00006a60: 7369 6e73 7461 6e63 6528 6576 656e 742c  sinstance(event,
+00006a70: 2052 6f6f 6d4d 6573 7361 6765 556e 6b6e   RoomMessageUnkn
+00006a80: 6f77 6e29 3a0a 2020 2020 2020 2020 2020  own):.          
+00006a90: 2020 2020 2020 6d73 6720 3d20 2252 6563        msg = "Rec
+00006aa0: 6569 7665 6420 726f 6f6d 206d 6573 7361  eived room messa
+00006ab0: 6765 206f 6620 756e 6b6e 6f77 6e20 7479  ge of unknown ty
+00006ac0: 7065 3a20 2220 2b20 6576 656e 742e 6d73  pe: " + event.ms
+00006ad0: 6774 7970 650a 2020 2020 2020 2020 2020  gtype.          
+00006ae0: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+00006af0: 6528 6576 656e 742c 2052 6f6f 6d4d 6573  e(event, RoomMes
+00006b00: 7361 6765 5669 6465 6f29 3a0a 2020 2020  sageVideo):.    
+00006b10: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
+00006b20: 3d20 2252 6563 6569 7665 6420 7669 6465  = "Received vide
+00006b30: 6f3a 2022 202b 2065 7665 6e74 2e62 6f64  o: " + event.bod
+00006b40: 7920 2b20 6d73 675f 7572 6c0a 2020 2020  y + msg_url.    
+00006b50: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
+00006b60: 6e73 7461 6e63 6528 6576 656e 742c 2052  nstance(event, R
+00006b70: 6f6f 6d45 6e63 7279 7074 6564 4175 6469  oomEncryptedAudi
+00006b80: 6f29 3a0a 2020 2020 2020 2020 2020 2020  o):.            
+00006b90: 2020 2020 6d73 6720 3d20 2252 6563 6569      msg = "Recei
+00006ba0: 7665 6420 656e 6372 7970 7465 6420 6175  ved encrypted au
+00006bb0: 6469 6f3a 2022 202b 2065 7665 6e74 2e62  dio: " + event.b
+00006bc0: 6f64 7920 2b20 6d73 675f 7572 6c0a 2020  ody + msg_url.  
+00006bd0: 2020 2020 2020 2020 2020 656c 6966 2069            elif i
+00006be0: 7369 6e73 7461 6e63 6528 6576 656e 742c  sinstance(event,
+00006bf0: 2052 6f6f 6d45 6e63 7279 7074 6564 4669   RoomEncryptedFi
+00006c00: 6c65 293a 0a20 2020 2020 2020 2020 2020  le):.           
+00006c10: 2020 2020 206d 7367 203d 2022 5265 6365       msg = "Rece
+00006c20: 6976 6564 2065 6e63 7279 7074 6564 2066  ived encrypted f
+00006c30: 696c 653a 2022 202b 2065 7665 6e74 2e62  ile: " + event.b
+00006c40: 6f64 7920 2b20 6d73 675f 7572 6c0a 2020  ody + msg_url.  
+00006c50: 2020 2020 2020 2020 2020 656c 6966 2069            elif i
+00006c60: 7369 6e73 7461 6e63 6528 6576 656e 742c  sinstance(event,
+00006c70: 2052 6f6f 6d45 6e63 7279 7074 6564 496d   RoomEncryptedIm
+00006c80: 6167 6529 3a0a 2020 2020 2020 2020 2020  age):.          
+00006c90: 2020 2020 2020 2320 5573 7561 6c6c 7920        # Usually 
+00006ca0: 626f 6479 2069 7320 736f 6d65 7468 696e  body is somethin
+00006cb0: 6720 6c69 6b65 2022 696d 6167 652e 7376  g like "image.sv
+00006cc0: 6722 0a20 2020 2020 2020 2020 2020 2020  g".             
+00006cd0: 2020 206d 7367 203d 2022 5265 6365 6976     msg = "Receiv
+00006ce0: 6564 2065 6e63 7279 7074 6564 2069 6d61  ed encrypted ima
+00006cf0: 6765 3a20 2220 2b20 6576 656e 742e 626f  ge: " + event.bo
+00006d00: 6479 202b 206d 7367 5f75 726c 0a20 2020  dy + msg_url.   
+00006d10: 2020 2020 2020 2020 2065 6c69 6620 6973           elif is
+00006d20: 696e 7374 616e 6365 2865 7665 6e74 2c20  instance(event, 
+00006d30: 526f 6f6d 456e 6372 7970 7465 6456 6964  RoomEncryptedVid
+00006d40: 656f 293a 0a20 2020 2020 2020 2020 2020  eo):.           
+00006d50: 2020 2020 206d 7367 203d 2022 5265 6365       msg = "Rece
+00006d60: 6976 6564 2065 6e63 7279 7074 6564 2076  ived encrypted v
+00006d70: 6964 656f 3a20 2220 2b20 6576 656e 742e  ideo: " + event.
+00006d80: 626f 6479 202b 206d 7367 5f75 726c 0a20  body + msg_url. 
+00006d90: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00006da0: 6973 696e 7374 616e 6365 2865 7665 6e74  isinstance(event
+00006db0: 2c20 526f 6f6d 4d65 7373 6167 654d 6564  , RoomMessageMed
+00006dc0: 6961 293a 0a20 2020 2020 2020 2020 2020  ia):.           
+00006dd0: 2020 2020 2023 2074 6869 7320 7368 6f75       # this shou
+00006de0: 6c64 206e 6576 6572 2062 6520 7265 6163  ld never be reac
+00006df0: 6865 642c 2074 6869 7320 6973 2061 2062  hed, this is a b
+00006e00: 6173 6520 636c 6173 730a 2020 2020 2020  ase class.      
+00006e10: 2020 2020 2020 2020 2020 2320 6974 2073            # it s
+00006e20: 686f 756c 6420 6265 2061 2061 7564 696f  hould be a audio
+00006e30: 2c20 696d 6167 652c 2076 6964 656f 2c20  , image, video, 
+00006e40: 6574 632e 0a20 2020 2020 2020 2020 2020  etc..           
+00006e50: 2020 2020 2023 2050 7574 2068 6572 6520       # Put here 
+00006e60: 6174 2074 6865 2065 6e64 2061 7320 6465  at the end as de
+00006e70: 6665 6e73 6976 6520 7072 6f67 7261 6d6d  fensive programm
+00006e80: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
+00006e90: 2020 2020 6d73 6720 3d20 2252 6563 6569      msg = "Recei
+00006ea0: 7665 6420 6d65 6469 613a 2022 202b 2065  ved media: " + e
+00006eb0: 7665 6e74 2e62 6f64 7920 2b20 6d73 675f  vent.body + msg_
+00006ec0: 7572 6c0a 2020 2020 2020 2020 2020 2020  url.            
+00006ed0: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+00006ee0: 6576 656e 742c 2052 6f6f 6d45 6e63 7279  event, RoomEncry
+00006ef0: 7074 6564 4d65 6469 6129 3a0a 2020 2020  ptedMedia):.    
+00006f00: 2020 2020 2020 2020 2020 2020 2320 7468              # th
+00006f10: 6973 2073 686f 756c 6420 6e65 7665 7220  is should never 
+00006f20: 6265 2072 6561 6368 6564 2c20 7468 6973  be reached, this
+00006f30: 2069 7320 6120 6261 7365 2063 6c61 7373   is a base class
+00006f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006f50: 2023 2069 7420 7368 6f75 6c64 2062 6520   # it should be 
+00006f60: 6120 6175 6469 6f2c 2069 6d61 6765 2c20  a audio, image, 
+00006f70: 7669 6465 6f2c 2065 7463 2e0a 2020 2020  video, etc..    
+00006f80: 2020 2020 2020 2020 2020 2020 2320 5075              # Pu
+00006f90: 7420 6865 7265 2061 7420 7468 6520 656e  t here at the en
+00006fa0: 6420 6173 2064 6566 656e 7369 7665 2070  d as defensive p
+00006fb0: 726f 6772 616d 6d69 6e67 0a20 2020 2020  rogramming.     
+00006fc0: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
+00006fd0: 2022 5265 6365 6976 6564 2065 6e63 7279   "Received encry
+00006fe0: 7074 6564 206d 6564 6961 3a20 2220 2b20  pted media: " + 
+00006ff0: 6576 656e 742e 626f 6479 202b 206d 7367  event.body + msg
+00007000: 5f75 726c 0a20 2020 2020 2020 2020 2020  _url.           
+00007010: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
+00007020: 2865 7665 6e74 2c20 526f 6f6d 4d65 6d62  (event, RoomMemb
+00007030: 6572 4576 656e 7429 3a0a 2020 2020 2020  erEvent):.      
+00007040: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
+00007050: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00007060: 2020 2020 2020 2252 6563 6569 7665 6420        "Received 
+00007070: 726f 6f6d 2d6d 656d 6265 7220 6576 656e  room-member even
+00007080: 743a 2022 0a20 2020 2020 2020 2020 2020  t: ".           
+00007090: 2020 2020 2020 2020 2066 2273 656e 6465           f"sende
+000070a0: 723a 207b 6576 656e 742e 7365 6e64 6572  r: {event.sender
+000070b0: 7d2c 206f 7065 7261 7469 6f6e 3a20 7b65  }, operation: {e
+000070c0: 7665 6e74 2e6d 656d 6265 7273 6869 707d  vent.membership}
+000070d0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+000070e0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+000070f0: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+00007100: 6576 656e 742c 2052 6f6f 6d45 6e63 7279  event, RoomEncry
+00007110: 7074 696f 6e45 7665 6e74 293a 0a20 2020  ptionEvent):.   
+00007120: 2020 2020 2020 2020 2020 2020 206d 7367               msg
+00007130: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+00007140: 2020 2020 2020 2020 2022 5265 6365 6976           "Receiv
+00007150: 6564 2072 6f6f 6d2d 656e 6372 7970 7469  ed room-encrypti
+00007160: 6f6e 2065 7665 6e74 3a20 220a 2020 2020  on event: ".    
+00007170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007180: 6622 7365 6e64 6572 3a20 7b65 7665 6e74  f"sender: {event
+00007190: 2e73 656e 6465 727d 220a 2020 2020 2020  .sender}".      
+000071a0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000071b0: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
+000071c0: 6e73 7461 6e63 6528 6576 656e 742c 2052  nstance(event, R
+000071d0: 6f6f 6d41 6c69 6173 4576 656e 7429 3a0a  oomAliasEvent):.
+000071e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000071f0: 6d73 6720 3d20 280a 2020 2020 2020 2020  msg = (.        
+00007200: 2020 2020 2020 2020 2020 2020 2252 6563              "Rec
+00007210: 6569 7665 6420 726f 6f6d 2d61 6c69 6173  eived room-alias
+00007220: 2065 7665 6e74 3a20 7365 6e64 6572 3a20   event: sender: 
+00007230: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00007240: 2020 2020 2020 6622 7b65 7665 6e74 2e73        f"{event.s
+00007250: 656e 6465 727d 2c20 616c 6961 733a 207b  ender}, alias: {
+00007260: 6576 656e 742e 6361 6e6f 6e69 6361 6c5f  event.canonical_
+00007270: 616c 6961 737d 220a 2020 2020 2020 2020  alias}".        
+00007280: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00007290: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
+000072a0: 7461 6e63 6528 6576 656e 742c 2052 6f6f  tance(event, Roo
+000072b0: 6d4e 616d 6545 7665 6e74 293a 0a20 2020  mNameEvent):.   
+000072c0: 2020 2020 2020 2020 2020 2020 206d 7367               msg
+000072d0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+000072e0: 2020 2020 2020 2020 2022 5265 6365 6976           "Receiv
+000072f0: 6564 2072 6f6f 6d2d 6e61 6d65 2065 7665  ed room-name eve
+00007300: 6e74 3a20 7365 6e64 6572 3a20 220a 2020  nt: sender: ".  
+00007310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007320: 2020 6622 7b65 7665 6e74 2e73 656e 6465    f"{event.sende
+00007330: 727d 2c20 726f 6f6d 206e 616d 653a 207b  r}, room name: {
+00007340: 6576 656e 742e 6e61 6d65 7d22 0a20 2020  event.name}".   
+00007350: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00007360: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00007370: 6973 696e 7374 616e 6365 2865 7665 6e74  isinstance(event
+00007380: 2c20 5265 6461 6374 6564 4576 656e 7429  , RedactedEvent)
+00007390: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000073a0: 2020 6d73 6720 3d20 280a 2020 2020 2020    msg = (.      
+000073b0: 2020 2020 2020 2020 2020 2020 2020 2252                "R
+000073c0: 6563 6569 7665 6420 7265 6461 6374 6564  eceived redacted
+000073d0: 2065 7665 6e74 3a20 220a 2020 2020 2020   event: ".      
+000073e0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+000073f0: 7365 6e64 6572 3a20 7b65 7665 6e74 2e73  sender: {event.s
+00007400: 656e 6465 727d 2c20 220a 2020 2020 2020  ender}, ".      
+00007410: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00007420: 7479 7065 3a20 7b65 7665 6e74 2e74 7970  type: {event.typ
+00007430: 657d 2c20 7265 6461 6374 6572 3a20 7b65  e}, redacter: {e
+00007440: 7665 6e74 2e72 6564 6163 7465 727d 220a  vent.redacter}".
+00007450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007460: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00007470: 6966 2069 7369 6e73 7461 6e63 6528 6576  if isinstance(ev
+00007480: 656e 742c 2052 6564 6163 7469 6f6e 4576  ent, RedactionEv
+00007490: 656e 7429 3a0a 2020 2020 2020 2020 2020  ent):.          
+000074a0: 2020 2020 2020 6d73 6720 3d20 280a 2020        msg = (.  
+000074b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000074c0: 2020 2252 6563 6569 7665 6420 7265 6461    "Received reda
+000074d0: 6374 696f 6e20 6576 656e 743a 2022 0a20  ction event: ". 
+000074e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000074f0: 2020 2066 2273 656e 6465 723a 207b 6576     f"sender: {ev
+00007500: 656e 742e 7365 6e64 6572 7d2c 2022 0a20  ent.sender}, ". 
+00007510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007520: 2020 2066 2272 6564 6163 7473 3a20 7b65     f"redacts: {e
+00007530: 7665 6e74 2e72 6564 6163 7473 7d22 0a20  vent.redacts}". 
+00007540: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00007550: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+00007560: 6620 6973 696e 7374 616e 6365 2865 7665  f isinstance(eve
+00007570: 6e74 2c20 556e 6b6e 6f77 6e45 7665 6e74  nt, UnknownEvent
+00007580: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00007590: 2020 2069 6620 6576 656e 742e 7479 7065     if event.type
+000075a0: 203d 3d20 226d 2e72 6561 6374 696f 6e22   == "m.reaction"
+000075b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000075c0: 2020 2020 2020 6d73 6720 3d20 280a 2020        msg = (.  
+000075d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000075e0: 2020 2020 2020 2252 6563 6569 7665 6420        "Received 
+000075f0: 6120 7265 6163 7469 6f6e 2c20 616e 2065  a reaction, an e
+00007600: 6d6f 6a69 3a20 220a 2020 2020 2020 2020  moji: ".        
+00007610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007620: 6622 7b65 7665 6e74 2e73 6f75 7263 655b  f"{event.source[
+00007630: 2763 6f6e 7465 6e74 275d 5b27 6d2e 7265  'content']['m.re
+00007640: 6c61 7465 735f 746f 275d 5b27 6b65 7927  lates_to']['key'
+00007650: 5d7d 220a 2020 2020 2020 2020 2020 2020  ]}".            
+00007660: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00007670: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00007680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007690: 2020 2020 6d73 6720 3d20 6622 5265 6365      msg = f"Rece
+000076a0: 6976 6564 2075 6e6b 6e6f 776e 2065 7665  ived unknown eve
+000076b0: 6e74 3a20 7b65 7665 6e74 7d22 0a20 2020  nt: {event}".   
+000076c0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+000076d0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+000076e0: 7367 203d 2066 2252 6563 6569 7665 6420  sg = f"Received 
+000076f0: 756e 6b6e 6f77 6e20 6576 656e 743a 207b  unknown event: {
+00007700: 6576 656e 747d 220a 0a20 2020 2020 2020  event}"..       
+00007710: 2020 2020 2023 2069 6620 6576 656e 745b       # if event[
+00007720: 2774 7970 6527 5d20 3d3d 2022 6d2e 726f  'type'] == "m.ro
+00007730: 6f6d 2e6d 6573 7361 6765 223a 0a20 2020  om.message":.   
+00007740: 2020 2020 2020 2020 2023 2020 2020 6966           #    if
+00007750: 2065 7665 6e74 5b27 636f 6e74 656e 7427   event['content'
+00007760: 5d5b 276d 7367 7479 7065 275d 203d 3d20  ]['msgtype'] == 
+00007770: 226d 2e74 6578 7422 3a0a 2020 2020 2020  "m.text":.      
+00007780: 2020 2020 2020 2320 2020 2020 2020 2063        #        c
+00007790: 6f6e 7465 6e74 203d 2065 7665 6e74 5b27  ontent = event['
+000077a0: 636f 6e74 656e 7427 5d5b 2762 6f64 7927  content']['body'
+000077b0: 5d0a 2020 2020 2020 2020 2020 2020 2320  ].            # 
+000077c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000077d0: 2020 2020 2023 2020 2020 2020 2020 646f       #        do
+000077e0: 776e 6c6f 6164 5f75 726c 203d 2061 7069  wnload_url = api
+000077f0: 2e67 6574 5f64 6f77 6e6c 6f61 645f 7572  .get_download_ur
+00007800: 6c28 0a20 2020 2020 2020 2020 2020 2023  l(.            #
+00007810: 2020 2020 2020 2020 2020 2020 6576 656e              even
+00007820: 745b 2763 6f6e 7465 6e74 275d 5b27 7572  t['content']['ur
+00007830: 6c27 5d29 0a20 2020 2020 2020 2020 2020  l']).           
+00007840: 2023 2020 2020 2020 2020 636f 6e74 656e   #        conten
+00007850: 7420 3d20 646f 776e 6c6f 6164 5f75 726c  t = download_url
+00007860: 0a20 2020 2020 2020 2020 2020 2023 2065  .            # e
+00007870: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00007880: 2023 2020 2020 636f 6e74 656e 7420 3d20   #    content = 
+00007890: 225c 6e7b 7b20 2220 2b20 6576 656e 745b  "\n{{ " + event[
+000078a0: 2774 7970 6527 5d20 2b20 2220 6576 656e  'type'] + " even
+000078b0: 7420 7d7d 5c6e 220a 2020 2020 2020 2020  t }}\n".        
+000078c0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+000078d0: 2866 2274 7970 6528 6d73 6729 203d 207b  (f"type(msg) = {
+000078e0: 7479 7065 286d 7367 297d 2e20 6d73 6720  type(msg)}. msg 
+000078f0: 6973 2061 2073 7472 696e 6722 290a 2020  is a string").  
+00007900: 2020 2020 2020 2020 2020 7365 6e64 6572            sender
+00007910: 5f6e 6963 6b20 3d20 726f 6f6d 2e75 7365  _nick = room.use
+00007920: 725f 6e61 6d65 2865 7665 6e74 2e73 656e  r_name(event.sen
+00007930: 6465 7229 0a20 2020 2020 2020 2020 2020  der).           
+00007940: 2069 6620 6e6f 7420 7365 6e64 6572 5f6e   if not sender_n
+00007950: 6963 6b3a 2020 2320 636f 6e76 6572 7420  ick:  # convert 
+00007960: 4066 6f6f 3a6d 6174 2e69 6f20 696e 746f  @foo:mat.io into
+00007970: 2066 6f6f 0a20 2020 2020 2020 2020 2020   foo.           
+00007980: 2020 2020 2073 656e 6465 725f 6e69 636b       sender_nick
+00007990: 203d 2075 7365 725f 6964 5f74 6f5f 7368   = user_id_to_sh
+000079a0: 6f72 745f 7573 6572 5f6e 616d 6528 6576  ort_user_name(ev
+000079b0: 656e 742e 7365 6e64 6572 290a 2020 2020  ent.sender).    
+000079c0: 2020 2020 2020 2020 726f 6f6d 5f6e 6963          room_nic
+000079d0: 6b20 3d20 726f 6f6d 2e64 6973 706c 6179  k = room.display
+000079e0: 5f6e 616d 650a 2020 2020 2020 2020 2020  _name.          
+000079f0: 2020 6966 2072 6f6f 6d5f 6e69 636b 2069    if room_nick i
+00007a00: 6e20 284e 6f6e 652c 2022 222c 2022 456d  n (None, "", "Em
+00007a10: 7074 7920 526f 6f6d 2229 3a0a 2020 2020  pty Room"):.    
+00007a20: 2020 2020 2020 2020 2020 2020 726f 6f6d              room
+00007a30: 5f6e 6963 6b20 3d20 2255 6e64 6574 6572  _nick = "Undeter
+00007a40: 6d69 6e65 6422 0a20 2020 2020 2020 2020  mined".         
+00007a50: 2020 2069 6620 6773 2e70 612e 7072 696e     if gs.pa.prin
+00007a60: 745f 6576 656e 745f 6964 3a0a 2020 2020  t_event_id:.    
+00007a70: 2020 2020 2020 2020 2020 2020 6576 656e              even
+00007a80: 745f 6964 5f64 6574 6169 6c20 3d20 6622  t_id_detail = f"
+00007a90: 207c 207b 6576 656e 742e 6576 656e 745f   | {event.event_
+00007aa0: 6964 7d22 0a20 2020 2020 2020 2020 2020  id}".           
+00007ab0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00007ac0: 2020 2020 2020 2065 7665 6e74 5f69 645f         event_id_
+00007ad0: 6465 7461 696c 203d 2022 220a 2020 2020  detail = "".    
+00007ae0: 2020 2020 2020 2020 2320 5072 6576 656e          # Preven
+00007af0: 7420 6661 6b69 6e67 206d 6573 7361 6765  t faking message
+00007b00: 7320 6279 2070 7265 6669 7869 6e67 2065  s by prefixing e
+00007b10: 6163 6820 6c69 6e65 206f 6620 6120 6d75  ach line of a mu
+00007b20: 6c74 696c 696e 650a 2020 2020 2020 2020  ltiline.        
+00007b30: 2020 2020 2320 6d65 7373 6167 6520 7769      # message wi
+00007b40: 7468 2073 7061 6365 2e0a 2020 2020 2020  th space..      
+00007b50: 2020 2020 2020 6669 7865 645f 6d73 6720        fixed_msg 
+00007b60: 3d20 7265 2e73 7562 2822 5c6e 222c 2022  = re.sub("\n", "
+00007b70: 5c6e 2020 2020 222c 206d 7367 290a 2020  \n    ", msg).  
+00007b80: 2020 2020 2020 2020 2020 636f 6d70 6c65            comple
+00007b90: 7465 5f6d 7367 203d 2028 0a20 2020 2020  te_msg = (.     
+00007ba0: 2020 2020 2020 2020 2020 2022 4d65 7373             "Mess
+00007bb0: 6167 6520 7265 6365 6976 6564 2066 6f72  age received for
+00007bc0: 2072 6f6f 6d20 220a 2020 2020 2020 2020   room ".        
+00007bd0: 2020 2020 2020 2020 6622 7b72 6f6f 6d5f          f"{room_
+00007be0: 6e69 636b 7d20 5b7b 726f 6f6d 2e72 6f6f  nick} [{room.roo
+00007bf0: 6d5f 6964 7d5d 207c 2022 0a20 2020 2020  m_id}] | ".     
+00007c00: 2020 2020 2020 2020 2020 2066 2273 656e             f"sen
+00007c10: 6465 7220 7b73 656e 6465 725f 6e69 636b  der {sender_nick
+00007c20: 7d20 220a 2020 2020 2020 2020 2020 2020  } ".            
+00007c30: 2020 2020 6622 5b7b 6576 656e 742e 7365      f"[{event.se
+00007c40: 6e64 6572 7d5d 207c 207b 6576 656e 745f  nder}] | {event_
+00007c50: 6461 7465 7469 6d65 7d22 0a20 2020 2020  datetime}".     
+00007c60: 2020 2020 2020 2020 2020 2066 227b 6576             f"{ev
+00007c70: 656e 745f 6964 5f64 6574 6169 6c7d 207c  ent_id_detail} |
+00007c80: 207b 6669 7865 645f 6d73 677d 220a 2020   {fixed_msg}".  
+00007c90: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00007ca0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+00007cb0: 6562 7567 2863 6f6d 706c 6574 655f 6d73  ebug(complete_ms
+00007cc0: 6729 0a20 2020 2020 2020 2020 2020 2023  g).            #
+00007cd0: 206f 7574 7075 7420 666f 726d 6174 2063   output format c
+00007ce0: 6f6e 7472 6f6c 6c65 6420 7669 6120 2d2d  ontrolled via --
+00007cf0: 6f75 7470 7574 2066 6c61 670a 2020 2020  output flag.    
+00007d00: 2020 2020 2020 2020 7465 7874 203d 2063          text = c
+00007d10: 6f6d 706c 6574 655f 6d73 6720 2023 2070  omplete_msg  # p
+00007d20: 7269 6e74 2074 6865 2072 6563 6569 7665  rint the receive
+00007d30: 6420 6d65 7373 6167 650a 2020 2020 2020  d message.      
+00007d40: 2020 2020 2020 6a73 6f6e 5f20 3d20 7b22        json_ = {"
+00007d50: 736f 7572 6365 223a 2065 7665 6e74 2e73  source": event.s
+00007d60: 6f75 7263 657d 0a20 2020 2020 2020 2020  ource}.         
+00007d70: 2020 206a 736f 6e5f 2e75 7064 6174 6528     json_.update(
+00007d80: 7b22 726f 6f6d 223a 2072 6f6f 6d7d 290a  {"room": room}).
+00007d90: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+00007da0: 5f2e 7570 6461 7465 287b 2272 6f6f 6d5f  _.update({"room_
+00007db0: 6469 7370 6c61 795f 6e61 6d65 223a 2072  display_name": r
+00007dc0: 6f6f 6d2e 6469 7370 6c61 795f 6e61 6d65  oom.display_name
+00007dd0: 7d29 0a20 2020 2020 2020 2020 2020 206a  }).            j
+00007de0: 736f 6e5f 2e75 7064 6174 6528 7b22 7365  son_.update({"se
+00007df0: 6e64 6572 5f6e 6963 6b22 3a20 7365 6e64  nder_nick": send
+00007e00: 6572 5f6e 6963 6b7d 290a 2020 2020 2020  er_nick}).      
+00007e10: 2020 2020 2020 6a73 6f6e 5f2e 7570 6461        json_.upda
+00007e20: 7465 287b 2265 7665 6e74 5f64 6174 6574  te({"event_datet
+00007e30: 696d 6522 3a20 6576 656e 745f 6461 7465  ime": event_date
+00007e40: 7469 6d65 7d29 0a20 2020 2020 2020 2020  time}).         
+00007e50: 2020 206a 736f 6e5f 6d61 7820 3d20 6576     json_max = ev
+00007e60: 656e 742e 5f5f 6469 6374 5f5f 0a20 2020  ent.__dict__.   
+00007e70: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
+00007e80: 782e 7570 6461 7465 287b 2272 6f6f 6d22  x.update({"room"
+00007e90: 3a20 726f 6f6d 7d29 0a20 2020 2020 2020  : room}).       
+00007ea0: 2020 2020 206a 736f 6e5f 6d61 782e 7570       json_max.up
+00007eb0: 6461 7465 287b 2272 6f6f 6d5f 6469 7370  date({"room_disp
+00007ec0: 6c61 795f 6e61 6d65 223a 2072 6f6f 6d2e  lay_name": room.
+00007ed0: 6469 7370 6c61 795f 6e61 6d65 7d29 0a20  display_name}). 
+00007ee0: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+00007ef0: 6d61 782e 7570 6461 7465 287b 2273 656e  max.update({"sen
+00007f00: 6465 725f 6e69 636b 223a 2073 656e 6465  der_nick": sende
+00007f10: 725f 6e69 636b 7d29 0a20 2020 2020 2020  r_nick}).       
+00007f20: 2020 2020 206a 736f 6e5f 6d61 782e 7570       json_max.up
+00007f30: 6461 7465 287b 2265 7665 6e74 5f64 6174  date({"event_dat
+00007f40: 6574 696d 6522 3a20 6576 656e 745f 6461  etime": event_da
+00007f50: 7465 7469 6d65 7d29 0a20 2020 2020 2020  tetime}).       
+00007f60: 2020 2020 206a 736f 6e5f 7370 6563 203d       json_spec =
+00007f70: 2065 7665 6e74 2e73 6f75 7263 650a 2020   event.source.  
+00007f80: 2020 2020 2020 2020 2020 7072 696e 745f            print_
+00007f90: 6f75 7470 7574 280a 2020 2020 2020 2020  output(.        
+00007fa0: 2020 2020 2020 2020 6773 2e70 612e 6f75          gs.pa.ou
+00007fb0: 7470 7574 2c0a 2020 2020 2020 2020 2020  tput,.          
+00007fc0: 2020 2020 2020 7465 7874 3d74 6578 742c        text=text,
+00007fd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007fe0: 206a 736f 6e5f 3d6a 736f 6e5f 2c0a 2020   json_=json_,.  
+00007ff0: 2020 2020 2020 2020 2020 2020 2020 6a73                js
+00008000: 6f6e 5f6d 6178 3d6a 736f 6e5f 6d61 782c  on_max=json_max,
+00008010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008020: 206a 736f 6e5f 7370 6563 3d6a 736f 6e5f   json_spec=json_
+00008030: 7370 6563 2c0a 2020 2020 2020 2020 2020  spec,.          
+00008040: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+00008050: 2069 6620 6773 2e70 612e 6f73 5f6e 6f74   if gs.pa.os_not
+00008060: 6966 793a 0a20 2020 2020 2020 2020 2020  ify:.           
+00008070: 2020 2020 2061 7661 7461 725f 7572 6c20       avatar_url 
+00008080: 3d20 6177 6169 7420 6765 745f 6176 6174  = await get_avat
+00008090: 6172 5f75 726c 2873 656c 662e 636c 6965  ar_url(self.clie
+000080a0: 6e74 2c20 6576 656e 742e 7365 6e64 6572  nt, event.sender
+000080b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000080c0: 2020 6e6f 7469 6679 280a 2020 2020 2020    notify(.      
+000080d0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+000080e0: 4672 6f6d 207b 726f 6f6d 2e75 7365 725f  From {room.user_
+000080f0: 6e61 6d65 2865 7665 6e74 2e73 656e 6465  name(event.sende
+00008100: 7229 7d22 2c0a 2020 2020 2020 2020 2020  r)}",.          
+00008110: 2020 2020 2020 2020 2020 6d73 675b 3a31            msg[:1
+00008120: 3630 5d2c 0a20 2020 2020 2020 2020 2020  60],.           
+00008130: 2020 2020 2020 2020 2061 7661 7461 725f           avatar_
+00008140: 7572 6c2c 0a20 2020 2020 2020 2020 2020  url,.           
+00008150: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00008160: 6578 6365 7074 2042 6173 6545 7863 6570  except BaseExcep
+00008170: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
+00008180: 2020 6773 2e6c 6f67 2e64 6562 7567 2822    gs.log.debug("
+00008190: 4865 7265 2069 7320 7468 6520 7472 6163  Here is the trac
+000081a0: 6562 6163 6b2e 5c6e 2220 2b20 7472 6163  eback.\n" + trac
+000081b0: 6562 6163 6b2e 666f 726d 6174 5f65 7863  eback.format_exc
+000081c0: 2829 290a 0a20 2020 2023 2061 6363 6f72  ())..    # accor
+000081d0: 6469 6e67 2074 6f20 6c69 6e74 6572 3a20  ding to linter: 
+000081e0: 6675 6e63 7469 6f6e 2069 7320 746f 6f20  function is too 
+000081f0: 636f 6d70 6c65 782c 2043 3930 310a 2020  complex, C901.  
+00008200: 2020 6173 796e 6320 6465 6620 746f 5f64    async def to_d
+00008210: 6576 6963 655f 6361 6c6c 6261 636b 2873  evice_callback(s
+00008220: 656c 662c 2065 7665 6e74 293a 2020 2320  elf, event):  # 
+00008230: 6e6f 7161 3a20 4339 3031 0a20 2020 2020  noqa: C901.     
+00008240: 2020 2022 2222 4861 6e64 6c65 2065 7665     """Handle eve
+00008250: 6e74 7320 7365 6e74 2074 6f20 6465 7669  nts sent to devi
+00008260: 6365 2e22 2222 0a20 2020 2020 2020 2074  ce.""".        t
+00008270: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00008280: 636c 6965 6e74 203d 2073 656c 662e 636c  client = self.cl
+00008290: 6965 6e74 0a0a 2020 2020 2020 2020 2020  ient..          
+000082a0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+000082b0: 6576 656e 742c 204b 6579 5665 7269 6669  event, KeyVerifi
+000082c0: 6361 7469 6f6e 5374 6172 7429 3a20 2023  cationStart):  #
+000082d0: 2066 6972 7374 2073 7465 700a 2020 2020   first step.    
+000082e0: 2020 2020 2020 2020 2020 2020 2222 2266              """f
+000082f0: 6972 7374 2073 7465 703a 2072 6563 6569  irst step: recei
+00008300: 7665 204b 6579 5665 7269 6669 6361 7469  ve KeyVerificati
+00008310: 6f6e 5374 6172 740a 2020 2020 2020 2020  onStart.        
+00008320: 2020 2020 2020 2020 4b65 7956 6572 6966          KeyVerif
+00008330: 6963 6174 696f 6e53 7461 7274 280a 2020  icationStart(.  
+00008340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008350: 2020 736f 7572 6365 3d7b 2763 6f6e 7465    source={'conte
+00008360: 6e74 273a 0a20 2020 2020 2020 2020 2020  nt':.           
+00008370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008380: 207b 276d 6574 686f 6427 3a20 276d 2e73   {'method': 'm.s
+00008390: 6173 2e76 3127 2c0a 2020 2020 2020 2020  as.v1',.        
+000083a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000083b0: 2020 2020 2027 6672 6f6d 5f64 6576 6963       'from_devic
+000083c0: 6527 3a20 2744 4556 4943 4549 4458 5927  e': 'DEVICEIDXY'
+000083d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000083e0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+000083f0: 6b65 795f 6167 7265 656d 656e 745f 7072  key_agreement_pr
+00008400: 6f74 6f63 6f6c 7327 3a0a 2020 2020 2020  otocols':.      
+00008410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008420: 2020 2020 2020 2020 2020 5b27 6375 7276            ['curv
+00008430: 6532 3535 3139 2d68 6b64 662d 7368 6132  e25519-hkdf-sha2
+00008440: 3536 272c 2027 6375 7276 6532 3535 3139  56', 'curve25519
+00008450: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
+00008460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008470: 2027 6861 7368 6573 273a 205b 2773 6861   'hashes': ['sha
+00008480: 3235 3627 5d2c 0a20 2020 2020 2020 2020  256'],.         
+00008490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000084a0: 2020 2020 276d 6573 7361 6765 5f61 7574      'message_aut
+000084b0: 6865 6e74 6963 6174 696f 6e5f 636f 6465  hentication_code
+000084c0: 7327 3a0a 2020 2020 2020 2020 2020 2020  s':.            
+000084d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000084e0: 2020 2020 5b27 686b 6466 2d68 6d61 632d      ['hkdf-hmac-
+000084f0: 7368 6132 3536 272c 2027 686d 6163 2d73  sha256', 'hmac-s
+00008500: 6861 3235 3627 5d2c 0a20 2020 2020 2020  ha256'],.       
+00008510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008520: 2020 2020 2020 2773 686f 7274 5f61 7574        'short_aut
+00008530: 6865 6e74 6963 6174 696f 6e5f 7374 7269  hentication_stri
+00008540: 6e67 273a 0a20 2020 2020 2020 2020 2020  ng':.           
+00008550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008560: 2020 2020 205b 2764 6563 696d 616c 272c       ['decimal',
+00008570: 2027 656d 6f6a 6927 5d2c 0a20 2020 2020   'emoji'],.     
+00008580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008590: 2020 2020 2020 2020 2774 7261 6e73 6163          'transac
+000085a0: 7469 6f6e 5f69 6427 3a20 2753 6f6d 6554  tion_id': 'SomeT
+000085b0: 7849 6427 0a20 2020 2020 2020 2020 2020  xId'.           
+000085c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000085d0: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
+000085e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000085f0: 2027 7479 7065 273a 2027 6d2e 6b65 792e   'type': 'm.key.
+00008600: 7665 7269 6669 6361 7469 6f6e 2e73 7461  verification.sta
+00008610: 7274 272c 0a20 2020 2020 2020 2020 2020  rt',.           
+00008620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008630: 2027 7365 6e64 6572 273a 2027 4075 7365   'sender': '@use
+00008640: 7232 3a65 7861 6d70 6c65 2e6f 7267 270a  r2:example.org'.
+00008650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008660: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
+00008670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008680: 2020 2073 656e 6465 723d 2740 7573 6572     sender='@user
+00008690: 323a 6578 616d 706c 652e 6f72 6727 2c0a  2:example.org',.
+000086a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000086b0: 2020 2020 7472 616e 7361 6374 696f 6e5f      transaction_
+000086c0: 6964 3d27 536f 6d65 5478 4964 272c 0a20  id='SomeTxId',. 
+000086d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000086e0: 2020 2066 726f 6d5f 6465 7669 6365 3d27     from_device='
+000086f0: 4445 5649 4345 4944 5859 272c 0a20 2020  DEVICEIDXY',.   
+00008700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008710: 206d 6574 686f 643d 276d 2e73 6173 2e76   method='m.sas.v
+00008720: 3127 2c0a 2020 2020 2020 2020 2020 2020  1',.            
+00008730: 2020 2020 2020 2020 6b65 795f 6167 7265          key_agre
+00008740: 656d 656e 745f 7072 6f74 6f63 6f6c 733d  ement_protocols=
+00008750: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00008760: 2020 2020 2020 2020 2020 2763 7572 7665            'curve
+00008770: 3235 3531 392d 686b 6466 2d73 6861 3235  25519-hkdf-sha25
+00008780: 3627 2c20 2763 7572 7665 3235 3531 3927  6', 'curve25519'
+00008790: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+000087a0: 2020 2020 2020 2068 6173 6865 733d 5b27         hashes=['
+000087b0: 7368 6132 3536 275d 2c0a 2020 2020 2020  sha256'],.      
+000087c0: 2020 2020 2020 2020 2020 2020 2020 6d65                me
+000087d0: 7373 6167 655f 6175 7468 656e 7469 6361  ssage_authentica
+000087e0: 7469 6f6e 5f63 6f64 6573 3d5b 0a20 2020  tion_codes=[.   
+000087f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008800: 2020 2020 2027 686b 6466 2d68 6d61 632d       'hkdf-hmac-
+00008810: 7368 6132 3536 272c 2027 686d 6163 2d73  sha256', 'hmac-s
+00008820: 6861 3235 3627 5d2c 0a20 2020 2020 2020  ha256'],.       
+00008830: 2020 2020 2020 2020 2020 2020 2073 686f               sho
+00008840: 7274 5f61 7574 6865 6e74 6963 6174 696f  rt_authenticatio
+00008850: 6e5f 7374 7269 6e67 3d5b 2764 6563 696d  n_string=['decim
+00008860: 616c 272c 2027 656d 6f6a 6927 5d29 0a20  al', 'emoji']). 
+00008870: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00008880: 2222 0a0a 2020 2020 2020 2020 2020 2020  ""..            
+00008890: 2020 2020 6966 2022 656d 6f6a 6922 206e      if "emoji" n
+000088a0: 6f74 2069 6e20 6576 656e 742e 7368 6f72  ot in event.shor
+000088b0: 745f 6175 7468 656e 7469 6361 7469 6f6e  t_authentication
+000088c0: 5f73 7472 696e 673a 0a20 2020 2020 2020  _string:.       
+000088d0: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
+000088e0: 6c6f 672e 6572 726f 7228 0a20 2020 2020  log.error(.     
+000088f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008900: 2020 2022 4531 3037 3a20 220a 2020 2020     "E107: ".    
+00008910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008920: 2020 2020 224f 7468 6572 2064 6576 6963      "Other devic
+00008930: 6520 646f 6573 206e 6f74 2073 7570 706f  e does not suppo
+00008940: 7274 2065 6d6f 6a69 2076 6572 6966 6963  rt emoji verific
+00008950: 6174 696f 6e2e 2022 0a20 2020 2020 2020  ation. ".       
+00008960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008970: 2066 227b 6576 656e 742e 7368 6f72 745f   f"{event.short_
+00008980: 6175 7468 656e 7469 6361 7469 6f6e 5f73  authentication_s
+00008990: 7472 696e 677d 2e22 0a20 2020 2020 2020  tring}.".       
+000089a0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+000089b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000089c0: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
+000089d0: 2020 2020 2020 2020 2020 7265 7370 203d            resp =
+000089e0: 2061 7761 6974 2063 6c69 656e 742e 6163   await client.ac
+000089f0: 6365 7074 5f6b 6579 5f76 6572 6966 6963  cept_key_verific
+00008a00: 6174 696f 6e28 0a20 2020 2020 2020 2020  ation(.         
+00008a10: 2020 2020 2020 2020 2020 2065 7665 6e74             event
+00008a20: 2e74 7261 6e73 6163 7469 6f6e 5f69 640a  .transaction_id.
+00008a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008a40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00008a50: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00008a60: 7265 7370 2c20 546f 4465 7669 6365 4572  resp, ToDeviceEr
+00008a70: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+00008a80: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
+00008a90: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
+00008aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008ab0: 2245 3130 383a 2022 0a20 2020 2020 2020  "E108: ".       
+00008ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008ad0: 2022 6163 6365 7074 5f6b 6579 5f76 6572   "accept_key_ver
+00008ae0: 6966 6963 6174 696f 6e20 6661 696c 6564  ification failed
+00008af0: 2077 6974 6820 6572 726f 7220 220a 2020   with error ".  
+00008b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008b10: 2020 2020 2020 6622 277b 7072 6976 6163        f"'{privac
+00008b20: 795f 6669 6c74 6572 2873 7472 2872 6573  y_filter(str(res
+00008b30: 7029 297d 272e 220a 2020 2020 2020 2020  p))}'.".        
+00008b40: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00008b50: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00008b60: 6173 203d 2063 6c69 656e 742e 6b65 795f  as = client.key_
+00008b70: 7665 7269 6669 6361 7469 6f6e 735b 6576  verifications[ev
+00008b80: 656e 742e 7472 616e 7361 6374 696f 6e5f  ent.transaction_
+00008b90: 6964 5d0a 0a20 2020 2020 2020 2020 2020  id]..           
+00008ba0: 2020 2020 2074 6f64 6576 6963 655f 6d73       todevice_ms
+00008bb0: 6720 3d20 7361 732e 7368 6172 655f 6b65  g = sas.share_ke
+00008bc0: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
+00008bd0: 2020 2020 7265 7370 203d 2061 7761 6974      resp = await
+00008be0: 2063 6c69 656e 742e 746f 5f64 6576 6963   client.to_devic
+00008bf0: 6528 746f 6465 7669 6365 5f6d 7367 290a  e(todevice_msg).
+00008c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008c10: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
+00008c20: 7370 2c20 546f 4465 7669 6365 4572 726f  sp, ToDeviceErro
+00008c30: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00008c40: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
+00008c50: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+00008c60: 2020 2020 2020 2020 2020 2020 2020 2245                "E
+00008c70: 3130 393a 2022 0a20 2020 2020 2020 2020  109: ".         
+00008c80: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00008c90: 746f 5f64 6576 6963 6520 6661 696c 6564  to_device failed
+00008ca0: 2077 6974 6820 6572 726f 7220 220a 2020   with error ".  
+00008cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008cc0: 2020 2020 2020 6622 277b 7072 6976 6163        f"'{privac
+00008cd0: 795f 6669 6c74 6572 2873 7472 2872 6573  y_filter(str(res
+00008ce0: 7029 297d 272e 220a 2020 2020 2020 2020  p))}'.".        
+00008cf0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00008d00: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00008d10: 6973 696e 7374 616e 6365 2865 7665 6e74  isinstance(event
+00008d20: 2c20 4b65 7956 6572 6966 6963 6174 696f  , KeyVerificatio
+00008d30: 6e43 616e 6365 6c29 3a20 2023 2061 6e79  nCancel):  # any
+00008d40: 7469 6d65 0a20 2020 2020 2020 2020 2020  time.           
+00008d50: 2020 2020 2022 2222 6174 2061 6e79 2074       """at any t
+00008d60: 696d 653a 2072 6563 6569 7665 204b 6579  ime: receive Key
+00008d70: 5665 7269 6669 6361 7469 6f6e 4361 6e63  VerificationCanc
+00008d80: 656c 0a20 2020 2020 2020 2020 2020 2020  el.             
+00008d90: 2020 204b 6579 5665 7269 6669 6361 7469     KeyVerificati
+00008da0: 6f6e 4361 6e63 656c 2873 6f75 7263 653d  onCancel(source=
+00008db0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00008dc0: 2020 2020 2020 2763 6f6e 7465 6e74 273a        'content':
+00008dd0: 207b 2763 6f64 6527 3a20 276d 2e6d 6973   {'code': 'm.mis
+00008de0: 6d61 7463 6865 645f 7361 7327 2c0a 2020  matched_sas',.  
 00008df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008e00: 2027 7265 6173 6f6e 273a 2027 4d69 736d   'reason': 'Mism
-00008e10: 6174 6368 6564 2061 7574 6865 6e74 6963  atched authentic
-00008e20: 6174 696f 6e20 7374 7269 6e67 272c 0a20  ation string',. 
-00008e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008e40: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00008e50: 7472 616e 7361 6374 696f 6e5f 6964 273a  transaction_id':
-00008e60: 2027 536f 6d65 5478 4964 277d 2c0a 2020   'SomeTxId'},.  
-00008e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008e80: 2020 2774 7970 6527 3a20 276d 2e6b 6579    'type': 'm.key
-00008e90: 2e76 6572 6966 6963 6174 696f 6e2e 6361  .verification.ca
-00008ea0: 6e63 656c 272c 0a20 2020 2020 2020 2020  ncel',.         
-00008eb0: 2020 2020 2020 2020 2020 2027 7365 6e64             'send
-00008ec0: 6572 273a 2027 4075 7365 7232 3a65 7861  er': '@user2:exa
-00008ed0: 6d70 6c65 2e6f 7267 277d 2c0a 2020 2020  mple.org'},.    
-00008ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ef0: 7365 6e64 6572 3d27 4075 7365 7232 3a65  sender='@user2:e
-00008f00: 7861 6d70 6c65 2e6f 7267 272c 0a20 2020  xample.org',.   
-00008f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008f20: 2074 7261 6e73 6163 7469 6f6e 5f69 643d   transaction_id=
-00008f30: 2753 6f6d 6554 7849 6427 2c0a 2020 2020  'SomeTxId',.    
-00008f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008f50: 636f 6465 3d27 6d2e 6d69 736d 6174 6368  code='m.mismatch
-00008f60: 6564 5f73 6173 272c 0a20 2020 2020 2020  ed_sas',.       
-00008f70: 2020 2020 2020 2020 2020 2020 2072 6561               rea
-00008f80: 736f 6e3d 274d 6973 6d61 7463 6865 6420  son='Mismatched 
-00008f90: 7368 6f72 7420 6175 7468 656e 7469 6361  short authentica
-00008fa0: 7469 6f6e 2073 7472 696e 6727 290a 2020  tion string').  
-00008fb0: 2020 2020 2020 2020 2020 2020 2020 2222                ""
-00008fc0: 220a 0a20 2020 2020 2020 2020 2020 2020  "..             
-00008fd0: 2020 2023 2054 6865 7265 2069 7320 6e6f     # There is no
-00008fe0: 206e 6565 6420 746f 2069 7373 7565 2061   need to issue a
-00008ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009000: 2023 2063 6c69 656e 742e 6361 6e63 656c   # client.cancel
-00009010: 5f6b 6579 5f76 6572 6966 6963 6174 696f  _key_verificatio
-00009020: 6e28 7478 5f69 642c 2072 656a 6563 743d  n(tx_id, reject=
-00009030: 4661 6c73 6529 0a20 2020 2020 2020 2020  False).         
-00009040: 2020 2020 2020 2023 2068 6572 652e 2054         # here. T
-00009050: 6865 2053 4153 2066 6c6f 7720 6973 2061  he SAS flow is a
-00009060: 6c72 6561 6479 2063 616e 6365 6c6c 6564  lready cancelled
-00009070: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00009080: 2020 2320 5765 206f 6e6c 7920 6e65 6564    # We only need
-00009090: 2074 6f20 696e 666f 726d 2074 6865 2075   to inform the u
-000090a0: 7365 722e 0a20 2020 2020 2020 2020 2020  ser..           
-000090b0: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
-000090c0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-000090d0: 2020 2020 2020 2022 4531 3130 3a20 220a         "E110: ".
-000090e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000090f0: 2020 2020 6622 5665 7269 6669 6361 7469      f"Verificati
-00009100: 6f6e 2068 6173 2062 6565 6e20 6361 6e63  on has been canc
-00009110: 656c 6c65 6420 6279 207b 6576 656e 742e  elled by {event.
-00009120: 7365 6e64 6572 7d20 220a 2020 2020 2020  sender} ".      
-00009130: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00009140: 666f 7220 7265 6173 6f6e 2022 7b65 7665  for reason "{eve
-00009150: 6e74 2e72 6561 736f 6e7d 222e 270a 2020  nt.reason}".'.  
-00009160: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00009170: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-00009180: 6620 6973 696e 7374 616e 6365 2865 7665  f isinstance(eve
-00009190: 6e74 2c20 4b65 7956 6572 6966 6963 6174  nt, KeyVerificat
-000091a0: 696f 6e4b 6579 293a 2020 2320 7365 636f  ionKey):  # seco
-000091b0: 6e64 2073 7465 700a 2020 2020 2020 2020  nd step.        
-000091c0: 2020 2020 2020 2020 2222 2253 6563 6f6e          """Secon
-000091d0: 6420 7374 6570 2069 7320 746f 2072 6563  d step is to rec
-000091e0: 6569 7665 204b 6579 5665 7269 6669 6361  eive KeyVerifica
-000091f0: 7469 6f6e 4b65 790a 2020 2020 2020 2020  tionKey.        
-00009200: 2020 2020 2020 2020 4b65 7956 6572 6966          KeyVerif
-00009210: 6963 6174 696f 6e4b 6579 280a 2020 2020  icationKey(.    
-00009220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009230: 736f 7572 6365 3d7b 2763 6f6e 7465 6e74  source={'content
-00009240: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
-00009250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009260: 2027 6b65 7927 3a20 2753 6f6d 6543 7279   'key': 'SomeCry
-00009270: 7074 6f4b 6579 272c 0a20 2020 2020 2020  ptoKey',.       
-00009280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009290: 2020 2020 2027 7472 616e 7361 6374 696f       'transactio
-000092a0: 6e5f 6964 273a 2027 536f 6d65 5478 4964  n_id': 'SomeTxId
-000092b0: 277d 2c0a 2020 2020 2020 2020 2020 2020  '},.            
-000092c0: 2020 2020 2020 2020 2020 2020 2774 7970              'typ
-000092d0: 6527 3a20 276d 2e6b 6579 2e76 6572 6966  e': 'm.key.verif
-000092e0: 6963 6174 696f 6e2e 6b65 7927 2c0a 2020  ication.key',.  
-000092f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009300: 2020 2020 2020 2773 656e 6465 7227 3a20        'sender': 
-00009310: 2740 7573 6572 323a 6578 616d 706c 652e  '@user2:example.
-00009320: 6f72 6727 0a20 2020 2020 2020 2020 2020  org'.           
-00009330: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
-00009340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009350: 7365 6e64 6572 3d27 4075 7365 7232 3a65  sender='@user2:e
-00009360: 7861 6d70 6c65 2e6f 7267 272c 0a20 2020  xample.org',.   
-00009370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009380: 2074 7261 6e73 6163 7469 6f6e 5f69 643d   transaction_id=
-00009390: 2753 6f6d 6554 7849 6427 2c0a 2020 2020  'SomeTxId',.    
-000093a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000093b0: 6b65 793d 2753 6f6d 6543 7279 7074 6f4b  key='SomeCryptoK
-000093c0: 6579 2729 0a20 2020 2020 2020 2020 2020  ey').           
-000093d0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-000093e0: 2020 2020 2020 2020 2073 6173 203d 2063           sas = c
-000093f0: 6c69 656e 742e 6b65 795f 7665 7269 6669  lient.key_verifi
-00009400: 6361 7469 6f6e 735b 6576 656e 742e 7472  cations[event.tr
-00009410: 616e 7361 6374 696f 6e5f 6964 5d0a 0a20  ansaction_id].. 
-00009420: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00009430: 7269 6e74 280a 2020 2020 2020 2020 2020  rint(.          
-00009440: 2020 2020 2020 2020 2020 6622 7b73 6173            f"{sas
-00009450: 2e67 6574 5f65 6d6f 6a69 2829 7d22 2c0a  .get_emoji()}",.
-00009460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009470: 2020 2020 6669 6c65 3d73 7973 2e73 7464      file=sys.std
-00009480: 6f75 742c 0a20 2020 2020 2020 2020 2020  out,.           
-00009490: 2020 2020 2020 2020 2066 6c75 7368 3d54           flush=T
-000094a0: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-000094b0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-000094c0: 2020 2020 2020 2020 796e 203d 2069 6e70          yn = inp
-000094d0: 7574 2822 446f 2074 6865 2065 6d6f 6a69  ut("Do the emoji
-000094e0: 7320 6d61 7463 683f 2028 592f 4e29 2028  s match? (Y/N) (
-000094f0: 4320 666f 7220 4361 6e63 656c 2920 2229  C for Cancel) ")
-00009500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009510: 2069 6620 796e 2e6c 6f77 6572 2829 203d   if yn.lower() =
-00009520: 3d20 2279 223a 0a20 2020 2020 2020 2020  = "y":.         
-00009530: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00009540: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00009550: 2020 2020 2020 2020 2020 224d 6174 6368            "Match
-00009560: 2120 5468 6520 7665 7269 6669 6361 7469  ! The verificati
-00009570: 6f6e 2066 6f72 2074 6869 7320 220a 2020  on for this ".  
-00009580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009590: 2020 2020 2020 2264 6576 6963 6520 7769        "device wi
-000095a0: 6c6c 2062 6520 6163 6365 7074 6564 2e22  ll be accepted."
-000095b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000095c0: 2020 2020 2020 2020 2020 6669 6c65 3d73            file=s
-000095d0: 7973 2e73 7464 6f75 742c 0a20 2020 2020  ys.stdout,.     
-000095e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000095f0: 2020 2066 6c75 7368 3d54 7275 652c 0a20     flush=True,. 
-00009600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009610: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00009620: 2020 2020 2020 2020 2072 6573 7020 3d20           resp = 
-00009630: 6177 6169 7420 636c 6965 6e74 2e63 6f6e  await client.con
-00009640: 6669 726d 5f73 686f 7274 5f61 7574 685f  firm_short_auth_
-00009650: 7374 7269 6e67 280a 2020 2020 2020 2020  string(.        
-00009660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009670: 6576 656e 742e 7472 616e 7361 6374 696f  event.transactio
-00009680: 6e5f 6964 0a20 2020 2020 2020 2020 2020  n_id.           
-00009690: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000096a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000096b0: 6620 6973 696e 7374 616e 6365 2872 6573  f isinstance(res
-000096c0: 702c 2054 6f44 6576 6963 6545 7272 6f72  p, ToDeviceError
-000096d0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000096e0: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-000096f0: 672e 6572 726f 7228 0a20 2020 2020 2020  g.error(.       
-00009700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009710: 2020 2020 2022 4531 3131 3a20 220a 2020       "E111: ".  
-00009720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009730: 2020 2020 2020 2020 2020 2263 6f6e 6669            "confi
-00009740: 726d 5f73 686f 7274 5f61 7574 685f 7374  rm_short_auth_st
-00009750: 7269 6e67 2066 6169 6c65 6420 7769 7468  ring failed with
-00009760: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00009770: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00009780: 2265 7272 6f72 2027 7b70 7269 7661 6379  "error '{privacy
-00009790: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
-000097a0: 2929 7d27 2e22 0a20 2020 2020 2020 2020  ))}'.".         
-000097b0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-000097c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000097d0: 2065 6c69 6620 796e 2e6c 6f77 6572 2829   elif yn.lower()
-000097e0: 203d 3d20 226e 223a 2020 2320 6e6f 2c20   == "n":  # no, 
-000097f0: 646f 6e27 7420 6d61 7463 682c 2072 656a  don't match, rej
-00009800: 6563 740a 2020 2020 2020 2020 2020 2020  ect.            
-00009810: 2020 2020 2020 2020 7072 696e 7428 0a20          print(. 
-00009820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009830: 2020 2020 2020 2022 4e6f 206d 6174 6368         "No match
-00009840: 2120 4465 7669 6365 2077 696c 6c20 4e4f  ! Device will NO
-00009850: 5420 6265 2076 6572 6966 6965 642e 2022  T be verified. "
-00009860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009870: 2020 2020 2020 2020 2022 5665 7269 6669           "Verifi
-00009880: 6361 7469 6f6e 2077 696c 6c20 6265 2072  cation will be r
-00009890: 656a 6563 7465 642e 222c 0a20 2020 2020  ejected.",.     
-000098a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000098b0: 2020 2066 696c 653d 7379 732e 7374 6465     file=sys.stde
-000098c0: 7272 2c0a 2020 2020 2020 2020 2020 2020  rr,.            
-000098d0: 2020 2020 2020 2020 2020 2020 666c 7573              flus
-000098e0: 683d 5472 7565 2c0a 2020 2020 2020 2020  h=True,.        
-000098f0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00009900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009910: 2020 7265 7370 203d 2061 7761 6974 2063    resp = await c
-00009920: 6c69 656e 742e 6361 6e63 656c 5f6b 6579  lient.cancel_key
-00009930: 5f76 6572 6966 6963 6174 696f 6e28 0a20  _verification(. 
-00009940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009950: 2020 2020 2020 2065 7665 6e74 2e74 7261         event.tra
-00009960: 6e73 6163 7469 6f6e 5f69 642c 2072 656a  nsaction_id, rej
-00009970: 6563 743d 5472 7565 0a20 2020 2020 2020  ect=True.       
-00009980: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00009990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000099a0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-000099b0: 2872 6573 702c 2054 6f44 6576 6963 6545  (resp, ToDeviceE
-000099c0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-000099d0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-000099e0: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
-000099f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009a00: 2020 2020 2020 2020 2022 4531 3132 3a20           "E112: 
-00009a10: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00009a20: 2020 2020 2020 2020 2020 2020 2020 2263                "c
-00009a30: 616e 6365 6c5f 6b65 795f 7665 7269 6669  ancel_key_verifi
-00009a40: 6361 7469 6f6e 2066 6169 6c65 6420 7769  cation failed wi
-00009a50: 7468 2022 0a20 2020 2020 2020 2020 2020  th ".           
-00009a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009a70: 2066 2227 7b70 7269 7661 6379 5f66 696c   f"'{privacy_fil
-00009a80: 7465 7228 7374 7228 7265 7370 2929 7d27  ter(str(resp))}'
-00009a90: 2e22 0a20 2020 2020 2020 2020 2020 2020  .".             
-00009aa0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00009ab0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00009ac0: 653a 2020 2320 4320 6f72 2061 6e79 7468  e:  # C or anyth
-00009ad0: 696e 6720 666f 7220 6361 6e63 656c 0a20  ing for cancel. 
-00009ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009af0: 2020 2070 7269 6e74 280a 2020 2020 2020     print(.      
-00009b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009b10: 2020 2243 616e 6365 6c6c 6564 2062 7920    "Cancelled by 
-00009b20: 7573 6572 2120 5665 7269 6669 6361 7469  user! Verificati
-00009b30: 6f6e 2077 696c 6c20 6265 2063 616e 6365  on will be cance
-00009b40: 6c6c 6564 2e22 2c0a 2020 2020 2020 2020  lled.",.        
-00009b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009b60: 6669 6c65 3d73 7973 2e73 7464 6572 722c  file=sys.stderr,
-00009b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009b80: 2020 2020 2020 2020 2066 6c75 7368 3d54           flush=T
-00009b90: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-00009ba0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00009bb0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00009bc0: 6573 7020 3d20 6177 6169 7420 636c 6965  esp = await clie
-00009bd0: 6e74 2e63 616e 6365 6c5f 6b65 795f 7665  nt.cancel_key_ve
-00009be0: 7269 6669 6361 7469 6f6e 280a 2020 2020  rification(.    
-00009bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c00: 2020 2020 6576 656e 742e 7472 616e 7361      event.transa
-00009c10: 6374 696f 6e5f 6964 2c20 7265 6a65 6374  ction_id, reject
-00009c20: 3d46 616c 7365 0a20 2020 2020 2020 2020  =False.         
-00009c30: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00009c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c50: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
-00009c60: 6573 702c 2054 6f44 6576 6963 6545 7272  esp, ToDeviceErr
-00009c70: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-00009c80: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
-00009c90: 6c6f 672e 6572 726f 7228 0a20 2020 2020  log.error(.     
-00009ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009cb0: 2020 2020 2020 2022 4531 3133 3a20 220a         "E113: ".
-00009cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009cd0: 2020 2020 2020 2020 2020 2020 2263 616e              "can
-00009ce0: 6365 6c5f 6b65 795f 7665 7269 6669 6361  cel_key_verifica
-00009cf0: 7469 6f6e 2066 6169 6c65 6420 7769 7468  tion failed with
-00009d00: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00009d10: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00009d20: 2227 7b70 7269 7661 6379 5f66 696c 7465  "'{privacy_filte
-00009d30: 7228 7374 7228 7265 7370 2929 7d27 2e22  r(str(resp))}'."
-00009d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009d50: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00009d60: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
-00009d70: 6e73 7461 6e63 6528 6576 656e 742c 204b  nstance(event, K
-00009d80: 6579 5665 7269 6669 6361 7469 6f6e 4d61  eyVerificationMa
-00009d90: 6329 3a20 2023 2074 6869 7264 2073 7465  c):  # third ste
-00009da0: 700a 2020 2020 2020 2020 2020 2020 2020  p.              
-00009db0: 2020 2222 2254 6869 7264 2073 7465 7020    """Third step 
-00009dc0: 6973 2074 6f20 7265 6365 6976 6520 4b65  is to receive Ke
-00009dd0: 7956 6572 6966 6963 6174 696f 6e4d 6163  yVerificationMac
-00009de0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009df0: 204b 6579 5665 7269 6669 6361 7469 6f6e   KeyVerification
-00009e00: 4d61 6328 0a20 2020 2020 2020 2020 2020  Mac(.           
-00009e10: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
-00009e20: 7b27 636f 6e74 656e 7427 3a20 7b0a 2020  {'content': {.  
-00009e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e40: 2020 2020 2020 276d 6163 273a 207b 2765        'mac': {'e
-00009e50: 6432 3535 3139 3a44 4556 4943 4549 4458  d25519:DEVICEIDX
-00009e60: 5927 3a20 2753 6f6d 654b 6579 3127 2c0a  Y': 'SomeKey1',.
-00009e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008e00: 2020 2020 2020 2020 2020 2020 2020 2772                'r
+00008e10: 6561 736f 6e27 3a20 274d 6973 6d61 7463  eason': 'Mismatc
+00008e20: 6865 6420 6175 7468 656e 7469 6361 7469  hed authenticati
+00008e30: 6f6e 2073 7472 696e 6727 2c0a 2020 2020  on string',.    
+00008e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008e50: 2020 2020 2020 2020 2020 2020 2774 7261              'tra
+00008e60: 6e73 6163 7469 6f6e 5f69 6427 3a20 2753  nsaction_id': 'S
+00008e70: 6f6d 6554 7849 6427 7d2c 0a20 2020 2020  omeTxId'},.     
+00008e80: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00008e90: 7479 7065 273a 2027 6d2e 6b65 792e 7665  type': 'm.key.ve
+00008ea0: 7269 6669 6361 7469 6f6e 2e63 616e 6365  rification.cance
+00008eb0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00008ec0: 2020 2020 2020 2020 2773 656e 6465 7227          'sender'
+00008ed0: 3a20 2740 7573 6572 323a 6578 616d 706c  : '@user2:exampl
+00008ee0: 652e 6f72 6727 7d2c 0a20 2020 2020 2020  e.org'},.       
+00008ef0: 2020 2020 2020 2020 2020 2020 2073 656e               sen
+00008f00: 6465 723d 2740 7573 6572 323a 6578 616d  der='@user2:exam
+00008f10: 706c 652e 6f72 6727 2c0a 2020 2020 2020  ple.org',.      
+00008f20: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+00008f30: 616e 7361 6374 696f 6e5f 6964 3d27 536f  ansaction_id='So
+00008f40: 6d65 5478 4964 272c 0a20 2020 2020 2020  meTxId',.       
+00008f50: 2020 2020 2020 2020 2020 2020 2063 6f64               cod
+00008f60: 653d 276d 2e6d 6973 6d61 7463 6865 645f  e='m.mismatched_
+00008f70: 7361 7327 2c0a 2020 2020 2020 2020 2020  sas',.          
+00008f80: 2020 2020 2020 2020 2020 7265 6173 6f6e            reason
+00008f90: 3d27 4d69 736d 6174 6368 6564 2073 686f  ='Mismatched sho
+00008fa0: 7274 2061 7574 6865 6e74 6963 6174 696f  rt authenticatio
+00008fb0: 6e20 7374 7269 6e67 2729 0a20 2020 2020  n string').     
+00008fc0: 2020 2020 2020 2020 2020 2022 2222 0a0a             """..
+00008fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008fe0: 2320 5468 6572 6520 6973 206e 6f20 6e65  # There is no ne
+00008ff0: 6564 2074 6f20 6973 7375 6520 610a 2020  ed to issue a.  
+00009000: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00009010: 636c 6965 6e74 2e63 616e 6365 6c5f 6b65  client.cancel_ke
+00009020: 795f 7665 7269 6669 6361 7469 6f6e 2874  y_verification(t
+00009030: 785f 6964 2c20 7265 6a65 6374 3d46 616c  x_id, reject=Fal
+00009040: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
+00009050: 2020 2020 2320 6865 7265 2e20 5468 6520      # here. The 
+00009060: 5341 5320 666c 6f77 2069 7320 616c 7265  SAS flow is alre
+00009070: 6164 7920 6361 6e63 656c 6c65 642e 0a20  ady cancelled.. 
+00009080: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00009090: 2057 6520 6f6e 6c79 206e 6565 6420 746f   We only need to
+000090a0: 2069 6e66 6f72 6d20 7468 6520 7573 6572   inform the user
+000090b0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000090c0: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
+000090d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000090e0: 2020 2020 2245 3131 303a 2022 0a20 2020      "E110: ".   
+000090f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009100: 2066 2256 6572 6966 6963 6174 696f 6e20   f"Verification 
+00009110: 6861 7320 6265 656e 2063 616e 6365 6c6c  has been cancell
+00009120: 6564 2062 7920 7b65 7665 6e74 2e73 656e  ed by {event.sen
+00009130: 6465 727d 2022 0a20 2020 2020 2020 2020  der} ".         
+00009140: 2020 2020 2020 2020 2020 2066 2766 6f72             f'for
+00009150: 2072 6561 736f 6e20 227b 6576 656e 742e   reason "{event.
+00009160: 7265 6173 6f6e 7d22 2e27 0a20 2020 2020  reason}".'.     
+00009170: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00009180: 2020 2020 2020 2020 2020 656c 6966 2069            elif i
+00009190: 7369 6e73 7461 6e63 6528 6576 656e 742c  sinstance(event,
+000091a0: 204b 6579 5665 7269 6669 6361 7469 6f6e   KeyVerification
+000091b0: 4b65 7929 3a20 2023 2073 6563 6f6e 6420  Key):  # second 
+000091c0: 7374 6570 0a20 2020 2020 2020 2020 2020  step.           
+000091d0: 2020 2020 2022 2222 5365 636f 6e64 2073       """Second s
+000091e0: 7465 7020 6973 2074 6f20 7265 6365 6976  tep is to receiv
+000091f0: 6520 4b65 7956 6572 6966 6963 6174 696f  e KeyVerificatio
+00009200: 6e4b 6579 0a20 2020 2020 2020 2020 2020  nKey.           
+00009210: 2020 2020 204b 6579 5665 7269 6669 6361       KeyVerifica
+00009220: 7469 6f6e 4b65 7928 0a20 2020 2020 2020  tionKey(.       
+00009230: 2020 2020 2020 2020 2020 2020 2073 6f75               sou
+00009240: 7263 653d 7b27 636f 6e74 656e 7427 3a20  rce={'content': 
+00009250: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00009260: 2020 2020 2020 2020 2020 2020 2020 276b                'k
+00009270: 6579 273a 2027 536f 6d65 4372 7970 746f  ey': 'SomeCrypto
+00009280: 4b65 7927 2c0a 2020 2020 2020 2020 2020  Key',.          
+00009290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000092a0: 2020 2774 7261 6e73 6163 7469 6f6e 5f69    'transaction_i
+000092b0: 6427 3a20 2753 6f6d 6554 7849 6427 7d2c  d': 'SomeTxId'},
+000092c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000092d0: 2020 2020 2020 2020 2027 7479 7065 273a           'type':
+000092e0: 2027 6d2e 6b65 792e 7665 7269 6669 6361   'm.key.verifica
+000092f0: 7469 6f6e 2e6b 6579 272c 0a20 2020 2020  tion.key',.     
+00009300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009310: 2020 2027 7365 6e64 6572 273a 2027 4075     'sender': '@u
+00009320: 7365 7232 3a65 7861 6d70 6c65 2e6f 7267  ser2:example.org
+00009330: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00009340: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+00009350: 2020 2020 2020 2020 2020 2020 2073 656e               sen
+00009360: 6465 723d 2740 7573 6572 323a 6578 616d  der='@user2:exam
+00009370: 706c 652e 6f72 6727 2c0a 2020 2020 2020  ple.org',.      
+00009380: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+00009390: 616e 7361 6374 696f 6e5f 6964 3d27 536f  ansaction_id='So
+000093a0: 6d65 5478 4964 272c 0a20 2020 2020 2020  meTxId',.       
+000093b0: 2020 2020 2020 2020 2020 2020 206b 6579               key
+000093c0: 3d27 536f 6d65 4372 7970 746f 4b65 7927  ='SomeCryptoKey'
+000093d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000093e0: 2020 2222 220a 2020 2020 2020 2020 2020    """.          
+000093f0: 2020 2020 2020 7361 7320 3d20 636c 6965        sas = clie
+00009400: 6e74 2e6b 6579 5f76 6572 6966 6963 6174  nt.key_verificat
+00009410: 696f 6e73 5b65 7665 6e74 2e74 7261 6e73  ions[event.trans
+00009420: 6163 7469 6f6e 5f69 645d 0a0a 2020 2020  action_id]..    
+00009430: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00009440: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+00009450: 2020 2020 2020 2066 227b 7361 732e 6765         f"{sas.ge
+00009460: 745f 656d 6f6a 6928 297d 222c 0a20 2020  t_emoji()}",.   
+00009470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009480: 2066 696c 653d 7379 732e 7374 646f 7574   file=sys.stdout
+00009490: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000094a0: 2020 2020 2020 666c 7573 683d 5472 7565        flush=True
+000094b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000094c0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+000094d0: 2020 2020 2079 6e20 3d20 696e 7075 7428       yn = input(
+000094e0: 2244 6f20 7468 6520 656d 6f6a 6973 206d  "Do the emojis m
+000094f0: 6174 6368 3f20 2859 2f4e 2920 2843 2066  atch? (Y/N) (C f
+00009500: 6f72 2043 616e 6365 6c29 2022 290a 2020  or Cancel) ").  
+00009510: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00009520: 2079 6e2e 6c6f 7765 7228 2920 3d3d 2022   yn.lower() == "
+00009530: 7922 3a0a 2020 2020 2020 2020 2020 2020  y":.            
+00009540: 2020 2020 2020 2020 7072 696e 7428 0a20          print(. 
+00009550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009560: 2020 2020 2020 2022 4d61 7463 6821 2054         "Match! T
+00009570: 6865 2076 6572 6966 6963 6174 696f 6e20  he verification 
+00009580: 666f 7220 7468 6973 2022 0a20 2020 2020  for this ".     
+00009590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000095a0: 2020 2022 6465 7669 6365 2077 696c 6c20     "device will 
+000095b0: 6265 2061 6363 6570 7465 642e 222c 0a20  be accepted.",. 
+000095c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000095d0: 2020 2020 2020 2066 696c 653d 7379 732e         file=sys.
+000095e0: 7374 646f 7574 2c0a 2020 2020 2020 2020  stdout,.        
+000095f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009600: 666c 7573 683d 5472 7565 2c0a 2020 2020  flush=True,.    
+00009610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009620: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00009630: 2020 2020 2020 7265 7370 203d 2061 7761        resp = awa
+00009640: 6974 2063 6c69 656e 742e 636f 6e66 6972  it client.confir
+00009650: 6d5f 7368 6f72 745f 6175 7468 5f73 7472  m_short_auth_str
+00009660: 696e 6728 0a20 2020 2020 2020 2020 2020  ing(.           
+00009670: 2020 2020 2020 2020 2020 2020 2065 7665               eve
+00009680: 6e74 2e74 7261 6e73 6163 7469 6f6e 5f69  nt.transaction_i
+00009690: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+000096a0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000096b0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+000096c0: 7369 6e73 7461 6e63 6528 7265 7370 2c20  sinstance(resp, 
+000096d0: 546f 4465 7669 6365 4572 726f 7229 3a0a  ToDeviceError):.
+000096e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000096f0: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
+00009700: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+00009710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009720: 2020 2245 3131 313a 2022 0a20 2020 2020    "E111: ".     
+00009730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009740: 2020 2020 2020 2022 636f 6e66 6972 6d5f         "confirm_
+00009750: 7368 6f72 745f 6175 7468 5f73 7472 696e  short_auth_strin
+00009760: 6720 6661 696c 6564 2077 6974 6820 220a  g failed with ".
+00009770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009780: 2020 2020 2020 2020 2020 2020 6622 6572              f"er
+00009790: 726f 7220 277b 7072 6976 6163 795f 6669  ror '{privacy_fi
+000097a0: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
+000097b0: 272e 220a 2020 2020 2020 2020 2020 2020  '.".            
+000097c0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+000097d0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+000097e0: 6966 2079 6e2e 6c6f 7765 7228 2920 3d3d  if yn.lower() ==
+000097f0: 2022 6e22 3a20 2023 206e 6f2c 2064 6f6e   "n":  # no, don
+00009800: 2774 206d 6174 6368 2c20 7265 6a65 6374  't match, reject
+00009810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009820: 2020 2020 2070 7269 6e74 280a 2020 2020       print(.    
+00009830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009840: 2020 2020 224e 6f20 6d61 7463 6821 2044      "No match! D
+00009850: 6576 6963 6520 7769 6c6c 204e 4f54 2062  evice will NOT b
+00009860: 6520 7665 7269 6669 6564 2e20 220a 2020  e verified. ".  
+00009870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009880: 2020 2020 2020 2256 6572 6966 6963 6174        "Verificat
+00009890: 696f 6e20 7769 6c6c 2062 6520 7265 6a65  ion will be reje
+000098a0: 6374 6564 2e22 2c0a 2020 2020 2020 2020  cted.",.        
+000098b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000098c0: 6669 6c65 3d73 7973 2e73 7464 6572 722c  file=sys.stderr,
+000098d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000098e0: 2020 2020 2020 2020 2066 6c75 7368 3d54           flush=T
+000098f0: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
+00009900: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00009910: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00009920: 6573 7020 3d20 6177 6169 7420 636c 6965  esp = await clie
+00009930: 6e74 2e63 616e 6365 6c5f 6b65 795f 7665  nt.cancel_key_ve
+00009940: 7269 6669 6361 7469 6f6e 280a 2020 2020  rification(.    
+00009950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009960: 2020 2020 6576 656e 742e 7472 616e 7361      event.transa
+00009970: 6374 696f 6e5f 6964 2c20 7265 6a65 6374  ction_id, reject
+00009980: 3d54 7275 650a 2020 2020 2020 2020 2020  =True.          
+00009990: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000099a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000099b0: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
+000099c0: 7370 2c20 546f 4465 7669 6365 4572 726f  sp, ToDeviceErro
+000099d0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+000099e0: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+000099f0: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
+00009a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a10: 2020 2020 2020 2245 3131 323a 2022 0a20        "E112: ". 
+00009a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a30: 2020 2020 2020 2020 2020 2022 6361 6e63             "canc
+00009a40: 656c 5f6b 6579 5f76 6572 6966 6963 6174  el_key_verificat
+00009a50: 696f 6e20 6661 696c 6564 2077 6974 6820  ion failed with 
+00009a60: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00009a70: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00009a80: 277b 7072 6976 6163 795f 6669 6c74 6572  '{privacy_filter
+00009a90: 2873 7472 2872 6573 7029 297d 272e 220a  (str(resp))}'.".
+00009aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ab0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00009ac0: 2020 2020 2020 2020 2020 656c 7365 3a20            else: 
+00009ad0: 2023 2043 206f 7220 616e 7974 6869 6e67   # C or anything
+00009ae0: 2066 6f72 2063 616e 6365 6c0a 2020 2020   for cancel.    
+00009af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009b00: 7072 696e 7428 0a20 2020 2020 2020 2020  print(.         
+00009b10: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00009b20: 4361 6e63 656c 6c65 6420 6279 2075 7365  Cancelled by use
+00009b30: 7221 2056 6572 6966 6963 6174 696f 6e20  r! Verification 
+00009b40: 7769 6c6c 2062 6520 6361 6e63 656c 6c65  will be cancelle
+00009b50: 642e 222c 0a20 2020 2020 2020 2020 2020  d.",.           
+00009b60: 2020 2020 2020 2020 2020 2020 2066 696c               fil
+00009b70: 653d 7379 732e 7374 6465 7272 2c0a 2020  e=sys.stderr,.  
+00009b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009b90: 2020 2020 2020 666c 7573 683d 5472 7565        flush=True
+00009ba0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009bb0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00009bc0: 2020 2020 2020 2020 2020 2020 7265 7370              resp
+00009bd0: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+00009be0: 6361 6e63 656c 5f6b 6579 5f76 6572 6966  cancel_key_verif
+00009bf0: 6963 6174 696f 6e28 0a20 2020 2020 2020  ication(.       
+00009c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009c10: 2065 7665 6e74 2e74 7261 6e73 6163 7469   event.transacti
+00009c20: 6f6e 5f69 642c 2072 656a 6563 743d 4661  on_id, reject=Fa
+00009c30: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+00009c40: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00009c50: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00009c60: 2069 7369 6e73 7461 6e63 6528 7265 7370   isinstance(resp
+00009c70: 2c20 546f 4465 7669 6365 4572 726f 7229  , ToDeviceError)
+00009c80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009c90: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
+00009ca0: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
+00009cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009cc0: 2020 2020 2245 3131 333a 2022 0a20 2020      "E113: ".   
+00009cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ce0: 2020 2020 2020 2020 2022 6361 6e63 656c           "cancel
+00009cf0: 5f6b 6579 5f76 6572 6966 6963 6174 696f  _key_verificatio
+00009d00: 6e20 6661 696c 6564 2077 6974 6820 220a  n failed with ".
+00009d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d20: 2020 2020 2020 2020 2020 2020 6622 277b              f"'{
+00009d30: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
+00009d40: 7472 2872 6573 7029 297d 272e 220a 2020  tr(resp))}'.".  
+00009d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d60: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00009d70: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
+00009d80: 616e 6365 2865 7665 6e74 2c20 4b65 7956  ance(event, KeyV
+00009d90: 6572 6966 6963 6174 696f 6e4d 6163 293a  erificationMac):
+00009da0: 2020 2320 7468 6972 6420 7374 6570 0a20    # third step. 
+00009db0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00009dc0: 2222 5468 6972 6420 7374 6570 2069 7320  ""Third step is 
+00009dd0: 746f 2072 6563 6569 7665 204b 6579 5665  to receive KeyVe
+00009de0: 7269 6669 6361 7469 6f6e 4d61 630a 2020  rificationMac.  
+00009df0: 2020 2020 2020 2020 2020 2020 2020 4b65                Ke
+00009e00: 7956 6572 6966 6963 6174 696f 6e4d 6163  yVerificationMac
+00009e10: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00009e20: 2020 2020 2020 736f 7572 6365 3d7b 2763        source={'c
+00009e30: 6f6e 7465 6e74 273a 207b 0a20 2020 2020  ontent': {.     
+00009e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009e50: 2020 2027 6d61 6327 3a20 7b27 6564 3235     'mac': {'ed25
+00009e60: 3531 393a 4445 5649 4345 4944 5859 273a  519:DEVICEIDXY':
+00009e70: 2027 536f 6d65 4b65 7931 272c 0a20 2020   'SomeKey1',.   
 00009e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e90: 2765 6432 3535 3139 3a53 6f6d 654b 6579  'ed25519:SomeKey
-00009ea0: 3227 3a20 2753 6f6d 654b 6579 3327 7d2c  2': 'SomeKey3'},
-00009eb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009ec0: 2020 2020 2020 2020 2027 6b65 7973 273a           'keys':
-00009ed0: 2027 536f 6d65 4372 7970 746f 4b65 7934   'SomeCryptoKey4
-00009ee0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00009ef0: 2020 2020 2020 2020 2020 2027 7472 616e             'tran
-00009f00: 7361 6374 696f 6e5f 6964 273a 2027 536f  saction_id': 'So
-00009f10: 6d65 5478 4964 277d 2c0a 2020 2020 2020  meTxId'},.      
-00009f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009f30: 2020 2774 7970 6527 3a20 276d 2e6b 6579    'type': 'm.key
-00009f40: 2e76 6572 6966 6963 6174 696f 6e2e 6d61  .verification.ma
-00009f50: 6327 2c0a 2020 2020 2020 2020 2020 2020  c',.            
-00009f60: 2020 2020 2020 2020 2020 2020 2773 656e              'sen
-00009f70: 6465 7227 3a20 2740 7573 6572 323a 6578  der': '@user2:ex
-00009f80: 616d 706c 652e 6f72 6727 7d2c 0a20 2020  ample.org'},.   
-00009f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009fa0: 2073 656e 6465 723d 2740 7573 6572 323a   sender='@user2:
-00009fb0: 6578 616d 706c 652e 6f72 6727 2c0a 2020  example.org',.  
-00009fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009fd0: 2020 7472 616e 7361 6374 696f 6e5f 6964    transaction_id
-00009fe0: 3d27 536f 6d65 5478 4964 272c 0a20 2020  ='SomeTxId',.   
-00009ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a000: 206d 6163 3d7b 2765 6432 3535 3139 3a44   mac={'ed25519:D
-0000a010: 4556 4943 4549 4458 5927 3a20 2753 6f6d  EVICEIDXY': 'Som
-0000a020: 654b 6579 3127 2c0a 2020 2020 2020 2020  eKey1',.        
-0000a030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a040: 2027 6564 3235 3531 393a 536f 6d65 4b65   'ed25519:SomeKe
-0000a050: 7932 273a 2027 536f 6d65 4b65 7933 277d  y2': 'SomeKey3'}
-0000a060: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000a070: 2020 2020 2020 6b65 7973 3d27 536f 6d65        keys='Some
-0000a080: 4372 7970 746f 4b65 7934 2729 0a20 2020  CryptoKey4').   
-0000a090: 2020 2020 2020 2020 2020 2020 2022 2222               """
-0000a0a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a0b0: 2073 6173 203d 2063 6c69 656e 742e 6b65   sas = client.ke
-0000a0c0: 795f 7665 7269 6669 6361 7469 6f6e 735b  y_verifications[
-0000a0d0: 6576 656e 742e 7472 616e 7361 6374 696f  event.transactio
-0000a0e0: 6e5f 6964 5d0a 2020 2020 2020 2020 2020  n_id].          
-0000a0f0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0000a100: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000a110: 6f64 6576 6963 655f 6d73 6720 3d20 7361  odevice_msg = sa
-0000a120: 732e 6765 745f 6d61 6328 290a 2020 2020  s.get_mac().    
-0000a130: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-0000a140: 7074 204c 6f63 616c 5072 6f74 6f63 6f6c  pt LocalProtocol
-0000a150: 4572 726f 7220 6173 2065 3a0a 2020 2020  Error as e:.    
-0000a160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a170: 2320 652e 672e 2069 7420 6d69 6768 7420  # e.g. it might 
-0000a180: 6861 7665 2062 6565 6e20 6361 6e63 656c  have been cancel
-0000a190: 6c65 6420 6279 206f 7572 7365 6c76 6573  led by ourselves
-0000a1a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a1b0: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
-0000a1c0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-0000a1d0: 2020 2020 2020 2020 2020 2022 4531 3134             "E114
-0000a1e0: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
-0000a1f0: 2020 2020 2020 2020 2020 2020 6622 4361              f"Ca
-0000a200: 6e63 656c 6c65 6420 6f72 2070 726f 746f  ncelled or proto
-0000a210: 636f 6c20 6572 726f 723a 2052 6561 736f  col error: Reaso
-0000a220: 6e3a 207b 657d 2e5c 6e22 0a20 2020 2020  n: {e}.\n".     
-0000a230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a240: 2020 2066 2256 6572 6966 6963 6174 696f     f"Verificatio
-0000a250: 6e20 7769 7468 207b 6576 656e 742e 7365  n with {event.se
-0000a260: 6e64 6572 7d20 6e6f 7420 636f 6e63 6c75  nder} not conclu
-0000a270: 6465 642e 2022 0a20 2020 2020 2020 2020  ded. ".         
-0000a280: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000a290: 5472 7920 6167 6169 6e3f 220a 2020 2020  Try again?".    
-0000a2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a2b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000a2c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000a2d0: 2020 2020 2020 2020 2020 2020 7265 7370              resp
-0000a2e0: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
-0000a2f0: 746f 5f64 6576 6963 6528 746f 6465 7669  to_device(todevi
-0000a300: 6365 5f6d 7367 290a 2020 2020 2020 2020  ce_msg).        
-0000a310: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-0000a320: 7369 6e73 7461 6e63 6528 7265 7370 2c20  sinstance(resp, 
-0000a330: 546f 4465 7669 6365 4572 726f 7229 3a0a  ToDeviceError):.
-0000a340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a350: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
-0000a360: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-0000a370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a380: 2020 2245 3131 353a 2022 0a20 2020 2020    "E115: ".     
-0000a390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a3a0: 2020 2020 2020 2022 746f 5f64 6576 6963         "to_devic
-0000a3b0: 6520 6661 696c 6564 2077 6974 6820 6572  e failed with er
-0000a3c0: 726f 7220 220a 2020 2020 2020 2020 2020  ror ".          
-0000a3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a3e0: 2020 6622 277b 7072 6976 6163 795f 6669    f"'{privacy_fi
-0000a3f0: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
-0000a400: 272e 220a 2020 2020 2020 2020 2020 2020  '.".            
-0000a410: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0000a420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a430: 2020 6773 2e6c 6f67 2e69 6e66 6f28 0a20    gs.log.info(. 
-0000a440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a450: 2020 2020 2020 2066 2273 6173 2e77 655f         f"sas.we_
-0000a460: 7374 6172 7465 645f 6974 203d 207b 7361  started_it = {sa
-0000a470: 732e 7765 5f73 7461 7274 6564 5f69 747d  s.we_started_it}
-0000a480: 5c6e 220a 2020 2020 2020 2020 2020 2020  \n".            
-0000a490: 2020 2020 2020 2020 2020 2020 6622 7361              f"sa
-0000a4a0: 732e 7361 735f 6163 6365 7074 6564 203d  s.sas_accepted =
-0000a4b0: 207b 7361 732e 7361 735f 6163 6365 7074   {sas.sas_accept
-0000a4c0: 6564 7d5c 6e22 0a20 2020 2020 2020 2020  ed}\n".         
-0000a4d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000a4e0: 2273 6173 2e63 616e 6365 6c65 6420 3d20  "sas.canceled = 
-0000a4f0: 7b73 6173 2e63 616e 6365 6c65 647d 5c6e  {sas.canceled}\n
-0000a500: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0000a510: 2020 2020 2020 2020 2020 6622 7361 732e            f"sas.
-0000a520: 7469 6d65 645f 6f75 7420 3d20 7b73 6173  timed_out = {sas
-0000a530: 2e74 696d 6564 5f6f 7574 7d5c 6e22 0a20  .timed_out}\n". 
-0000a540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a550: 2020 2020 2020 2066 2273 6173 2e76 6572         f"sas.ver
-0000a560: 6966 6965 6420 3d20 7b73 6173 2e76 6572  ified = {sas.ver
-0000a570: 6966 6965 647d 5c6e 220a 2020 2020 2020  ified}\n".      
-0000a580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a590: 2020 6622 7361 732e 7665 7269 6669 6564    f"sas.verified
-0000a5a0: 5f64 6576 6963 6573 203d 207b 7361 732e  _devices = {sas.
-0000a5b0: 7665 7269 6669 6564 5f64 6576 6963 6573  verified_devices
-0000a5c0: 7d5c 6e22 0a20 2020 2020 2020 2020 2020  }\n".           
-0000a5d0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0000a5e0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0000a5f0: 7269 6e74 280a 2020 2020 2020 2020 2020  rint(.          
-0000a600: 2020 2020 2020 2020 2020 2020 2020 2245                "E
-0000a610: 6d6f 6a69 2076 6572 6966 6963 6174 696f  moji verificatio
-0000a620: 6e20 7761 7320 7375 6363 6573 7366 756c  n was successful
-0000a630: 215c 6e22 0a20 2020 2020 2020 2020 2020  !\n".           
-0000a640: 2020 2020 2020 2020 2020 2020 2022 5665               "Ve
-0000a650: 7269 6679 2077 6974 6820 6f74 6865 7220  rify with other 
-0000a660: 6465 7669 6365 7320 6f72 2068 6974 2043  devices or hit C
-0000a670: 6f6e 7472 6f6c 2d43 2074 6f20 220a 2020  ontrol-C to ".  
-0000a680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a690: 2020 2020 2020 2263 6f6e 7469 6e75 652e        "continue.
-0000a6a0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0000a6b0: 2020 2020 2020 2020 2020 2066 696c 653d             file=
-0000a6c0: 7379 732e 7374 646f 7574 2c0a 2020 2020  sys.stdout,.    
-0000a6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a6e0: 2020 2020 666c 7573 683d 5472 7565 2c0a      flush=True,.
-0000a6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a700: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0000a710: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000a720: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
-0000a730: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-0000a740: 2020 2020 2020 2020 2020 2245 3131 363a            "E116:
-0000a750: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-0000a760: 2020 2020 2020 2066 2252 6563 6569 7665         f"Receive
-0000a770: 6420 756e 6578 7065 6374 6564 2065 7665  d unexpected eve
-0000a780: 6e74 2074 7970 6520 7b74 7970 6528 6576  nt type {type(ev
-0000a790: 656e 7429 7d2e 2022 0a20 2020 2020 2020  ent)}. ".       
-0000a7a0: 2020 2020 2020 2020 2020 2020 2066 2245               f"E
-0000a7b0: 7665 6e74 2069 7320 7b65 7665 6e74 7d2e  vent is {event}.
-0000a7c0: 2045 7665 6e74 2077 696c 6c20 6265 2069   Event will be i
-0000a7d0: 676e 6f72 6564 2e22 0a20 2020 2020 2020  gnored.".       
-0000a7e0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0000a7f0: 2020 2065 7863 6570 7420 4261 7365 4578     except BaseEx
-0000a800: 6365 7074 696f 6e3a 0a20 2020 2020 2020  ception:.       
-0000a810: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-0000a820: 6728 2248 6572 6520 6973 2074 6865 2074  g("Here is the t
-0000a830: 7261 6365 6261 636b 2e5c 6e22 202b 2074  raceback.\n" + t
-0000a840: 7261 6365 6261 636b 2e66 6f72 6d61 745f  raceback.format_
-0000a850: 6578 6328 2929 0a0a 0a64 6566 206e 6f74  exc())...def not
-0000a860: 6966 7928 7469 746c 653a 2073 7472 2c20  ify(title: str, 
-0000a870: 636f 6e74 656e 743a 2073 7472 2c20 696d  content: str, im
-0000a880: 6167 655f 7572 6c3a 2073 7472 293a 0a20  age_url: str):. 
-0000a890: 2020 2022 2222 4e6f 7469 6679 204f 5320     """Notify OS 
-0000a8a0: 6f66 206d 6573 7361 6765 2072 6563 6569  of message recei
-0000a8b0: 7074 2e0a 0a20 2020 2049 6620 7468 6520  pt...    If the 
-0000a8c0: 7379 7374 656d 2069 7320 7275 6e6e 696e  system is runnin
-0000a8d0: 6720 6865 6164 6c65 7373 206f 7220 616e  g headless or an
-0000a8e0: 7920 7072 6f62 6c65 6d20 6861 7070 656e  y problem happen
-0000a8f0: 7320 7769 7468 0a20 2020 206f 7065 7261  s with.    opera
-0000a900: 7469 6e67 2073 7973 7465 6d20 6e6f 7469  ting system noti
-0000a910: 6669 6361 7469 6f6e 732c 2069 676e 6f72  fications, ignor
-0000a920: 6520 6974 2e0a 2020 2020 2222 220a 2020  e it..    """.  
-0000a930: 2020 6966 206e 6f74 2048 4156 455f 4e4f    if not HAVE_NO
-0000a940: 5449 4659 3a0a 2020 2020 2020 2020 6773  TIFY:.        gs
-0000a950: 2e6c 6f67 2e77 6172 6e69 6e67 280a 2020  .log.warning(.  
-0000a960: 2020 2020 2020 2020 2020 2257 3130 303a            "W100:
-0000a970: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-0000a980: 6e6f 7469 6679 3220 6f72 2064 6275 7320  notify2 or dbus 
-0000a990: 6973 206e 6f74 2069 6e73 7461 6c6c 6564  is not installed
-0000a9a0: 2e20 4e6f 7469 6669 6361 7469 6f6e 7320  . Notifications 
-0000a9b0: 7769 6c6c 206e 6f74 2062 6520 220a 2020  will not be ".  
-0000a9c0: 2020 2020 2020 2020 2020 2264 6973 706c            "displ
-0000a9d0: 6179 6564 2e20 220a 2020 2020 2020 2020  ayed. ".        
-0000a9e0: 2020 2020 224d 616b 6520 7375 7265 2074      "Make sure t
-0000a9f0: 6861 7420 6e6f 7469 6679 3220 616e 6420  hat notify2 and 
-0000aa00: 6462 7573 2061 7265 2069 6e73 7461 6c6c  dbus are install
-0000aa10: 6564 206f 7220 7265 6d6f 7665 2074 6865  ed or remove the
-0000aa20: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-0000aa30: 2d2d 6f73 2d6e 6f74 6966 7920 6f70 7469  --os-notify opti
-0000aa40: 6f6e 2e22 0a20 2020 2020 2020 2029 0a20  on.".        ). 
-0000aa50: 2020 2020 2020 2067 732e 7761 726e 5f63         gs.warn_c
-0000aa60: 6f75 6e74 202b 3d20 310a 2020 2020 2020  ount += 1.      
-0000aa70: 2020 7265 7475 726e 0a20 2020 2074 7279    return.    try
-0000aa80: 3a0a 2020 2020 2020 2020 6966 2069 6d61  :.        if ima
-0000aa90: 6765 5f75 726c 3a0a 2020 2020 2020 2020  ge_url:.        
-0000aaa0: 2020 2020 6e6f 7475 7365 642c 2061 7661      notused, ava
-0000aab0: 7461 725f 6669 6c65 203d 2074 656d 7066  tar_file = tempf
-0000aac0: 696c 652e 6d6b 7374 656d 7028 290a 2020  ile.mkstemp().  
-0000aad0: 2020 2020 2020 2020 2020 7572 6c6c 6962            urllib
-0000aae0: 2e72 6571 7565 7374 2e75 726c 7265 7472  .request.urlretr
-0000aaf0: 6965 7665 2869 6d61 6765 5f75 726c 2c20  ieve(image_url, 
-0000ab00: 6176 6174 6172 5f66 696c 6529 0a20 2020  avatar_file).   
-0000ab10: 2020 2020 2020 2020 2023 2054 4f44 4f3a           # TODO:
-0000ab20: 2063 6c65 616e 7570 2074 656d 7020 6669   cleanup temp fi
-0000ab30: 6c65 733f 2069 6e20 636c 6561 6e75 7028  les? in cleanup(
-0000ab40: 293f 0a20 2020 2020 2020 2065 6c73 653a  )?.        else:
-0000ab50: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
-0000ab60: 636f 6e20 6e61 6d65 2022 6e6f 7469 6669  con name "notifi
-0000ab70: 6361 7469 6f6e 2d6d 6573 7361 6765 2d49  cation-message-I
-0000ab80: 4d22 2077 696c 6c20 776f 726b 206f 6e20  M" will work on 
-0000ab90: 5562 756e 7475 0a20 2020 2020 2020 2020  Ubuntu.         
-0000aba0: 2020 2023 2062 7574 206e 6f74 2061 6c6c     # but not all
-0000abb0: 2070 6c61 7466 6f72 6d73 0a20 2020 2020   platforms.     
-0000abc0: 2020 2020 2020 2061 7661 7461 725f 6669         avatar_fi
-0000abd0: 6c65 203d 2022 6e6f 7469 6669 6361 7469  le = "notificati
-0000abe0: 6f6e 2d6d 6573 7361 6765 2d49 4d22 0a20  on-message-IM". 
-0000abf0: 2020 2020 2020 206e 6f74 6966 7932 2e69         notify2.i
-0000ac00: 6e69 7428 5052 4f47 5f57 4954 484f 5554  nit(PROG_WITHOUT
-0000ac10: 5f45 5854 290a 2020 2020 2020 2020 6e6f  _EXT).        no
-0000ac20: 7469 6679 322e 4e6f 7469 6669 6361 7469  tify2.Notificati
-0000ac30: 6f6e 2874 6974 6c65 2c20 636f 6e74 656e  on(title, conten
-0000ac40: 742c 2061 7661 7461 725f 6669 6c65 292e  t, avatar_file).
-0000ac50: 7368 6f77 2829 0a20 2020 2020 2020 2067  show().        g
-0000ac60: 732e 6c6f 672e 6465 6275 6728 6622 5368  s.log.debug(f"Sh
-0000ac70: 6f77 6564 206e 6f74 6966 6963 6174 696f  owed notificatio
-0000ac80: 6e20 666f 7220 7b74 6974 6c65 7d2e 2229  n for {title}.")
-0000ac90: 0a20 2020 2065 7863 6570 7420 4578 6365  .    except Exce
-0000aca0: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
-0000acb0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-0000acc0: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
-0000acd0: 5368 6f77 696e 6720 6e6f 7469 6669 6361  Showing notifica
-0000ace0: 7469 6f6e 2066 6f72 207b 7469 746c 657d  tion for {title}
-0000acf0: 2066 6169 6c65 642e 2045 7863 6570 7469   failed. Excepti
-0000ad00: 6f6e 3a20 7b65 7d22 0a20 2020 2020 2020  on: {e}".       
-0000ad10: 2020 2020 2066 225c 6e48 6572 6520 6973       f"\nHere is
-0000ad20: 2074 6865 2074 7261 6365 6261 636b 3a5c   the traceback:\
-0000ad30: 6e7b 7472 6163 6562 6163 6b2e 666f 726d  n{traceback.form
-0000ad40: 6174 5f65 7863 2829 7d22 0a20 2020 2020  at_exc()}".     
-0000ad50: 2020 2029 0a20 2020 2020 2020 2070 6173     ).        pas
-0000ad60: 730a 0a0a 6173 796e 6320 6465 6620 6765  s...async def ge
-0000ad70: 745f 6176 6174 6172 5f75 726c 2863 6c69  t_avatar_url(cli
-0000ad80: 656e 743a 2041 7379 6e63 436c 6965 6e74  ent: AsyncClient
-0000ad90: 2c20 7573 6572 5f69 643a 2073 7472 2920  , user_id: str) 
-0000ada0: 2d3e 2073 7472 3a0a 2020 2020 2222 2247  -> str:.    """G
-0000adb0: 6574 2068 7474 7073 2061 7661 7461 7220  et https avatar 
-0000adc0: 5552 4c20 666f 7220 7573 6572 2075 7365  URL for user use
-0000add0: 725f 6964 2e0a 0a20 2020 2052 6574 7572  r_id...    Retur
-0000ade0: 6e73 2055 524c 206f 7220 4e6f 6e65 2069  ns URL or None i
-0000adf0: 6620 7573 6572 2068 6173 206e 6f20 6176  f user has no av
-0000ae00: 6174 6172 0a20 2020 2022 2222 0a20 2020  atar.    """.   
-0000ae10: 2061 7661 7461 725f 7572 6c20 3d20 4e6f   avatar_url = No
-0000ae20: 6e65 2020 2320 6465 6661 756c 740a 2020  ne  # default.  
-0000ae30: 2020 7265 7370 203d 2061 7761 6974 2063    resp = await c
-0000ae40: 6c69 656e 742e 6765 745f 6176 6174 6172  lient.get_avatar
-0000ae50: 2875 7365 725f 6964 290a 2020 2020 6966  (user_id).    if
-0000ae60: 2069 7369 6e73 7461 6e63 6528 7265 7370   isinstance(resp
-0000ae70: 2c20 5072 6f66 696c 6547 6574 4176 6174  , ProfileGetAvat
-0000ae80: 6172 5265 7370 6f6e 7365 293a 0a20 2020  arResponse):.   
-0000ae90: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-0000aea0: 6728 0a20 2020 2020 2020 2020 2020 2022  g(.            "
-0000aeb0: 5072 6f66 696c 6547 6574 4176 6174 6172  ProfileGetAvatar
-0000aec0: 5265 7370 6f6e 7365 2e20 5265 7370 6f6e  Response. Respon
-0000aed0: 7365 2069 733a 2022 0a20 2020 2020 2020  se is: ".       
-0000aee0: 2020 2020 2066 227b 7072 6976 6163 795f       f"{privacy_
-0000aef0: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
-0000af00: 297d 220a 2020 2020 2020 2020 290a 2020  )}".        ).  
-0000af10: 2020 2020 2020 6176 6174 6172 5f6d 7863        avatar_mxc
-0000af20: 203d 2072 6573 702e 6176 6174 6172 5f75   = resp.avatar_u
-0000af30: 726c 0a20 2020 2020 2020 2067 732e 6c6f  rl.        gs.lo
-0000af40: 672e 6465 6275 6728 6622 6176 6174 6172  g.debug(f"avatar
-0000af50: 5f6d 7863 2069 7320 7b61 7661 7461 725f  _mxc is {avatar_
-0000af60: 6d78 637d 2229 0a20 2020 2020 2020 2069  mxc}").        i
-0000af70: 6620 6176 6174 6172 5f6d 7863 3a20 2023  f avatar_mxc:  #
-0000af80: 2063 6f75 6c64 2062 6520 4e6f 6e65 2069   could be None i
-0000af90: 6620 6e6f 2061 7661 7461 720a 2020 2020  f no avatar.    
-0000afa0: 2020 2020 2020 2020 6176 6174 6172 5f75          avatar_u
-0000afb0: 726c 203d 2061 7761 6974 2063 6c69 656e  rl = await clien
-0000afc0: 742e 6d78 635f 746f 5f68 7474 7028 6176  t.mxc_to_http(av
-0000afd0: 6174 6172 5f6d 7863 290a 2020 2020 656c  atar_mxc).    el
-0000afe0: 7365 3a0a 2020 2020 2020 2020 6773 2e6c  se:.        gs.l
-0000aff0: 6f67 2e69 6e66 6f28 0a20 2020 2020 2020  og.info(.       
-0000b000: 2020 2020 2066 2246 6169 6c65 6420 6765       f"Failed ge
-0000b010: 7474 696e 6720 6176 6174 6172 2066 726f  tting avatar fro
-0000b020: 6d20 7365 7276 6572 2e20 7b70 7269 7661  m server. {priva
-0000b030: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
-0000b040: 7370 2929 7d22 0a20 2020 2020 2020 2029  sp))}".        )
-0000b050: 0a20 2020 2067 732e 6c6f 672e 6465 6275  .    gs.log.debu
-0000b060: 6728 6622 6176 6174 6172 5f75 726c 2069  g(f"avatar_url i
-0000b070: 7320 7b61 7661 7461 725f 7572 6c7d 2229  s {avatar_url}")
-0000b080: 0a20 2020 2072 6574 7572 6e20 6176 6174  .    return avat
-0000b090: 6172 5f75 726c 0a0a 0a64 6566 2063 7265  ar_url...def cre
-0000b0a0: 6174 655f 7069 645f 6669 6c65 2829 202d  ate_pid_file() -
-0000b0b0: 3e20 4e6f 6e65 3a0a 2020 2020 2222 2257  > None:.    """W
-0000b0c0: 7269 7465 2050 4944 2074 6f20 6469 736b  rite PID to disk
-0000b0d0: 2e0a 0a20 2020 2049 6620 706f 7373 6962  ...    If possib
-0000b0e0: 6c65 2063 7265 6174 6520 6120 5049 4420  le create a PID 
-0000b0f0: 6669 6c65 2e20 5468 6973 2069 7320 6e6f  file. This is no
-0000b100: 7420 6573 7365 6e74 6961 6c2e 0a20 2020  t essential..   
-0000b110: 2053 6f2c 2069 6620 6974 2066 6169 6c73   So, if it fails
-0000b120: 2074 6865 7265 2069 7320 6e6f 2070 726f   there is no pro
-0000b130: 626c 656d 2e20 5468 6520 5049 4420 6669  blem. The PID fi
-0000b140: 6c65 2063 616e 0a20 2020 2062 6520 6865  le can.    be he
-0000b150: 6c70 6675 6c20 746f 2073 656e 6420 6120  lpful to send a 
-0000b160: 6b69 6c6c 2073 6967 6e61 6c20 6f72 2073  kill signal or s
-0000b170: 696d 696c 6172 2074 6f20 7468 6520 7072  imilar to the pr
-0000b180: 6f63 6573 732e 0a20 2020 2045 2e67 2e20  ocess..    E.g. 
-0000b190: 746f 2073 746f 7020 6c69 7374 656e 696e  to stop listenin
-0000b1a0: 672e 0a20 2020 2042 6563 6175 7365 2074  g..    Because t
-0000b1b0: 6865 2075 7365 7220 6361 6e20 7374 6172  he user can star
-0000b1c0: 7420 7365 7665 7261 6c20 7072 6f63 6573  t several proces
-0000b1d0: 7365 7320 6174 2074 6865 2073 616d 6520  ses at the same 
-0000b1e0: 7469 6d65 2c0a 2020 2020 6a75 7374 2068  time,.    just h
-0000b1f0: 6176 696e 6720 6f6e 6520 5049 4420 6669  aving one PID fi
-0000b200: 6c65 2069 7320 6e6f 7420 6163 6365 7074  le is not accept
-0000b210: 6162 6c65 2062 6563 6175 7365 2061 206e  able because a n
-0000b220: 6577 6c79 2073 7461 7274 6564 0a20 2020  ewly started.   
-0000b230: 2070 726f 6365 7373 2077 6f75 6c64 206f   process would o
-0000b240: 7665 7277 7269 7465 2074 6865 2070 7265  verwrite the pre
-0000b250: 7669 6f75 7320 5049 4420 6669 6c65 2e20  vious PID file. 
-0000b260: 5765 2075 7365 2055 5549 4473 2074 6f20  We use UUIDs to 
-0000b270: 6d61 6b65 0a20 2020 2065 6163 6820 5049  make.    each PI
-0000b280: 4420 6669 6c65 2075 6e69 7175 652e 0a20  D file unique.. 
-0000b290: 2020 2022 2222 0a20 2020 2074 7279 3a0a     """.    try:.
-0000b2a0: 2020 2020 2020 2020 6966 206e 6f74 206f          if not o
-0000b2b0: 732e 7061 7468 2e65 7869 7374 7328 5049  s.path.exists(PI
-0000b2c0: 445f 4449 525f 4445 4641 554c 5429 3a0a  D_DIR_DEFAULT):.
-0000b2d0: 2020 2020 2020 2020 2020 2020 6f73 2e6d              os.m
-0000b2e0: 6b64 6972 2850 4944 5f44 4952 5f44 4546  kdir(PID_DIR_DEF
-0000b2f0: 4155 4c54 290a 2020 2020 2020 2020 2020  AULT).          
-0000b300: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
-0000b310: 2243 7265 6174 6520 6469 7265 6374 6f72  "Create director
-0000b320: 7920 7b50 4944 5f44 4952 5f44 4546 4155  y {PID_DIR_DEFAU
-0000b330: 4c54 7d20 666f 7220 5049 4420 6669 6c65  LT} for PID file
-0000b340: 2e22 290a 2020 2020 2020 2020 7069 6420  .").        pid 
-0000b350: 3d20 6f73 2e67 6574 7069 6428 290a 2020  = os.getpid().  
-0000b360: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-0000b370: 7567 2866 2254 7279 696e 6720 746f 2063  ug(f"Trying to c
-0000b380: 7265 6174 6520 6120 5049 4420 6669 6c65  reate a PID file
-0000b390: 2074 6f20 7374 6f72 6520 7072 6f63 6573   to store proces
-0000b3a0: 7320 6964 207b 7069 647d 2e22 290a 2020  s id {pid}.").  
-0000b3b0: 2020 2020 2020 7769 7468 206f 7065 6e28        with open(
-0000b3c0: 5049 445f 4649 4c45 5f44 4546 4155 4c54  PID_FILE_DEFAULT
-0000b3d0: 2c20 2277 2229 2061 7320 663a 2020 2320  , "w") as f:  # 
-0000b3e0: 6f76 6572 7772 6974 650a 2020 2020 2020  overwrite.      
-0000b3f0: 2020 2020 2020 662e 7772 6974 6528 7374        f.write(st
-0000b400: 7228 7069 6429 290a 2020 2020 2020 2020  r(pid)).        
-0000b410: 2020 2020 662e 636c 6f73 6528 290a 2020      f.close().  
-0000b420: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-0000b430: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-0000b440: 6627 5375 6363 6573 7366 756c 6c79 2063  f'Successfully c
-0000b450: 7265 6174 6564 2050 4944 2066 696c 6520  reated PID file 
-0000b460: 227b 5049 445f 4649 4c45 5f44 4546 4155  "{PID_FILE_DEFAU
-0000b470: 4c54 7d22 2027 0a20 2020 2020 2020 2020  LT}" '.         
-0000b480: 2020 2066 2274 6f20 7374 6f72 6520 7072     f"to store pr
-0000b490: 6f63 6573 7320 6964 207b 7069 647d 2e22  ocess id {pid}."
-0000b4a0: 0a20 2020 2020 2020 2029 0a20 2020 2065  .        ).    e
-0000b4b0: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
-0000b4c0: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
-0000b4d0: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
-0000b4e0: 2020 2066 2746 6169 6c65 6420 746f 2063     f'Failed to c
-0000b4f0: 7265 6174 6520 5049 4420 6669 6c65 2022  reate PID file "
-0000b500: 7b50 4944 5f46 494c 455f 4445 4641 554c  {PID_FILE_DEFAUL
-0000b510: 547d 2220 270a 2020 2020 2020 2020 2020  T}" '.          
-0000b520: 2020 6622 746f 2073 746f 7265 2070 726f    f"to store pro
-0000b530: 6365 7373 2069 6420 7b6f 732e 6765 7470  cess id {os.getp
-0000b540: 6964 2829 7d2e 220a 2020 2020 2020 2020  id()}.".        
-0000b550: 290a 0a0a 6465 6620 6465 6c65 7465 5f70  )...def delete_p
-0000b560: 6964 5f66 696c 6528 2920 2d3e 204e 6f6e  id_file() -> Non
-0000b570: 653a 0a20 2020 2022 2222 5265 6d6f 7665  e:.    """Remove
-0000b580: 2050 4944 2066 696c 6520 6672 6f6d 2064   PID file from d
-0000b590: 6973 6b2e 0a0a 2020 2020 436c 6561 6e20  isk...    Clean 
-0000b5a0: 7570 2062 7920 7265 6d6f 7669 6e67 2050  up by removing P
-0000b5b0: 4944 2066 696c 652e 0a20 2020 2049 7420  ID file..    It 
-0000b5c0: 6d69 6768 7420 6e6f 7420 6578 6973 742e  might not exist.
-0000b5d0: 2053 6f2c 2069 676e 6f72 6520 6661 696c   So, ignore fail
-0000b5e0: 7572 6573 2e0a 2020 2020 2222 220a 2020  ures..    """.  
-0000b5f0: 2020 7472 793a 0a20 2020 2020 2020 206f    try:.        o
-0000b600: 732e 7265 6d6f 7665 2850 4944 5f46 494c  s.remove(PID_FIL
-0000b610: 455f 4445 4641 554c 5429 0a20 2020 2065  E_DEFAULT).    e
-0000b620: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
-0000b630: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
-0000b640: 6465 6275 6728 6627 4661 696c 6564 2074  debug(f'Failed t
-0000b650: 6f20 7265 6d6f 7665 2050 4944 2066 696c  o remove PID fil
-0000b660: 6520 227b 5049 445f 4649 4c45 5f44 4546  e "{PID_FILE_DEF
-0000b670: 4155 4c54 7d22 2e27 290a 0a0a 6465 6620  AULT}".')...def 
-0000b680: 636c 6561 6e75 7028 2920 2d3e 204e 6f6e  cleanup() -> Non
-0000b690: 653a 0a20 2020 2022 2222 436c 6561 6e75  e:.    """Cleanu
-0000b6a0: 7020 6265 666f 7265 2071 7569 7469 6e67  p before quiting
-0000b6b0: 2070 726f 6772 616d 2e22 2222 0a20 2020   program.""".   
-0000b6c0: 2067 732e 6c6f 672e 6465 6275 6728 2243   gs.log.debug("C
-0000b6d0: 6c65 616e 7570 3a20 636c 6561 6e69 6e67  leanup: cleaning
-0000b6e0: 2075 702e 2229 0a20 2020 2064 656c 6574   up.").    delet
-0000b6f0: 655f 7069 645f 6669 6c65 2829 0a0a 0a64  e_pid_file()...d
-0000b700: 6566 2063 7265 6465 6e74 6961 6c73 5f65  ef credentials_e
-0000b710: 7869 7374 2863 7265 6465 6e74 6961 6c73  xist(credentials
-0000b720: 5f66 696c 655f 7061 7468 3a20 4f70 7469  _file_path: Opti
-0000b730: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
-0000b740: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2022  ) -> bool:.    "
-0000b750: 2222 4465 7465 726d 696e 6520 6966 2063  ""Determine if c
-0000b760: 7265 6465 6e74 6961 6c73 2066 696c 6520  redentials file 
-0000b770: 616c 7265 6164 7920 6578 6973 7473 2e22  already exists."
-0000b780: 2222 0a20 2020 2069 6620 6e6f 7420 6372  "".    if not cr
-0000b790: 6564 656e 7469 616c 735f 6669 6c65 5f70  edentials_file_p
-0000b7a0: 6174 683a 0a20 2020 2020 2020 2063 7265  ath:.        cre
-0000b7b0: 6465 6e74 6961 6c73 5f66 696c 655f 7061  dentials_file_pa
-0000b7c0: 7468 203d 2064 6574 6572 6d69 6e65 5f63  th = determine_c
-0000b7d0: 7265 6465 6e74 6961 6c73 5f66 696c 6528  redentials_file(
-0000b7e0: 290a 2020 2020 7265 7475 726e 206f 732e  ).    return os.
-0000b7f0: 7061 7468 2e65 7869 7374 7328 6372 6564  path.exists(cred
-0000b800: 656e 7469 616c 735f 6669 6c65 5f70 6174  entials_file_pat
-0000b810: 6829 0a0a 0a64 6566 2073 746f 7265 5f65  h)...def store_e
-0000b820: 7869 7374 7328 7374 6f72 655f 6469 725f  xists(store_dir_
-0000b830: 7061 7468 3a20 4f70 7469 6f6e 616c 5b73  path: Optional[s
-0000b840: 7472 5d20 3d20 4e6f 6e65 2920 2d3e 2062  tr] = None) -> b
-0000b850: 6f6f 6c3a 0a20 2020 2022 2222 4465 7465  ool:.    """Dete
-0000b860: 726d 696e 6520 6966 2073 746f 7265 2064  rmine if store d
-0000b870: 6972 2061 6c72 6561 6479 2065 7869 7374  ir already exist
-0000b880: 732e 2222 220a 2020 2020 6966 206e 6f74  s.""".    if not
-0000b890: 2073 746f 7265 5f64 6972 5f70 6174 683a   store_dir_path:
-0000b8a0: 0a20 2020 2020 2020 2073 746f 7265 5f64  .        store_d
-0000b8b0: 6972 5f70 6174 6820 3d20 6465 7465 726d  ir_path = determ
-0000b8c0: 696e 655f 7374 6f72 655f 6469 7228 290a  ine_store_dir().
-0000b8d0: 2020 2020 7265 7475 726e 206f 732e 7061      return os.pa
-0000b8e0: 7468 2e69 7364 6972 2873 746f 7265 5f64  th.isdir(store_d
-0000b8f0: 6972 5f70 6174 6829 0a0a 0a64 6566 2073  ir_path)...def s
-0000b900: 746f 7265 5f63 7265 6174 6528 7374 6f72  tore_create(stor
-0000b910: 655f 6469 725f 7061 7468 3a20 4f70 7469  e_dir_path: Opti
-0000b920: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
-0000b930: 2920 2d3e 204e 6f6e 653a 0a20 2020 2022  ) -> None:.    "
-0000b940: 2222 4372 6561 7465 2073 746f 7265 2064  ""Create store d
-0000b950: 6972 2e22 2222 0a20 2020 2069 6620 6e6f  ir.""".    if no
-0000b960: 7420 7374 6f72 655f 6469 725f 7061 7468  t store_dir_path
-0000b970: 3a0a 2020 2020 2020 2020 7374 6f72 655f  :.        store_
-0000b980: 6469 725f 7061 7468 203d 2064 6574 6572  dir_path = deter
-0000b990: 6d69 6e65 5f73 746f 7265 5f64 6972 2829  mine_store_dir()
-0000b9a0: 0a20 2020 206f 732e 6d61 6b65 6469 7273  .    os.makedirs
-0000b9b0: 2873 746f 7265 5f64 6972 5f70 6174 6829  (store_dir_path)
-0000b9c0: 0a20 2020 2067 732e 6c6f 672e 696e 666f  .    gs.log.info
-0000b9d0: 280a 2020 2020 2020 2020 6622 5468 6520  (.        f"The 
-0000b9e0: 7065 7273 6973 7465 6e74 2073 746f 7261  persistent stora
-0000b9f0: 6765 2064 6972 6563 746f 7279 207b 7374  ge directory {st
-0000ba00: 6f72 655f 6469 725f 7061 7468 7d20 220a  ore_dir_path} ".
-0000ba10: 2020 2020 2020 2020 2277 6173 2063 7265          "was cre
-0000ba20: 6174 6564 2066 6f72 2079 6f75 2e22 0a20  ated for you.". 
-0000ba30: 2020 2029 0a0a 0a64 6566 2073 746f 7265     )...def store
-0000ba40: 5f64 656c 6574 6528 7374 6f72 655f 6469  _delete(store_di
-0000ba50: 725f 7061 7468 3a20 4f70 7469 6f6e 616c  r_path: Optional
-0000ba60: 5b73 7472 5d20 3d20 4e6f 6e65 2920 2d3e  [str] = None) ->
-0000ba70: 204e 6f6e 653a 0a20 2020 2022 2222 4465   None:.    """De
-0000ba80: 6c65 7465 2073 746f 7265 2064 6972 2e22  lete store dir."
-0000ba90: 2222 0a20 2020 2069 6620 6e6f 7420 7374  "".    if not st
-0000baa0: 6f72 655f 6469 725f 7061 7468 3a0a 2020  ore_dir_path:.  
-0000bab0: 2020 2020 2020 7374 6f72 655f 6469 725f        store_dir_
-0000bac0: 7061 7468 203d 2064 6574 6572 6d69 6e65  path = determine
-0000bad0: 5f73 746f 7265 5f64 6972 2829 0a20 2020  _store_dir().   
-0000bae0: 206f 732e 726d 6469 7228 7374 6f72 655f   os.rmdir(store_
-0000baf0: 6469 725f 7061 7468 290a 2020 2020 6773  dir_path).    gs
-0000bb00: 2e6c 6f67 2e69 6e66 6f28 0a20 2020 2020  .log.info(.     
-0000bb10: 2020 2066 2254 6865 2070 6572 7369 7374     f"The persist
-0000bb20: 656e 7420 7374 6f72 6167 6520 6469 7265  ent storage dire
-0000bb30: 6374 6f72 7920 7b73 746f 7265 5f64 6972  ctory {store_dir
-0000bb40: 5f70 6174 687d 2022 0a20 2020 2020 2020  _path} ".       
-0000bb50: 2022 7761 7320 6465 6c65 7465 6420 666f   "was deleted fo
-0000bb60: 7220 796f 752e 220a 2020 2020 290a 0a0a  r you.".    )...
-0000bb70: 6465 6620 7772 6974 655f 6372 6564 656e  def write_creden
-0000bb80: 7469 616c 735f 746f 5f64 6973 6b28 0a20  tials_to_disk(. 
-0000bb90: 2020 2068 6f6d 6573 6572 7665 722c 2075     homeserver, u
-0000bba0: 7365 725f 6964 2c20 6465 7669 6365 5f69  ser_id, device_i
-0000bbb0: 642c 2061 6363 6573 735f 746f 6b65 6e2c  d, access_token,
-0000bbc0: 2072 6f6f 6d5f 6964 2c20 6372 6564 656e   room_id, creden
-0000bbd0: 7469 616c 735f 6669 6c65 0a29 202d 3e20  tials_file.) -> 
-0000bbe0: 4e6f 6e65 3a0a 2020 2020 2222 2257 7269  None:.    """Wri
-0000bbf0: 7465 2074 6865 2072 6571 7569 7265 6420  te the required 
-0000bc00: 6c6f 6769 6e20 6465 7461 696c 7320 746f  login details to
-0000bc10: 2064 6973 6b2e 0a0a 2020 2020 5468 6973   disk...    This
-0000bc20: 2066 696c 6520 6361 6e20 6c61 7465 7220   file can later 
-0000bc30: 6265 2075 7365 6420 666f 7220 6c6f 6767  be used for logg
-0000bc40: 696e 6720 696e 0a20 2020 2077 6974 686f  ing in.    witho
-0000bc50: 7574 2075 7369 6e67 2061 2070 6173 7377  ut using a passw
-0000bc60: 6f72 642e 0a0a 2020 2020 4172 6775 6d65  ord...    Argume
-0000bc70: 6e74 733a 0a20 2020 202d 2d2d 2d2d 2d2d  nts:.    -------
-0000bc80: 2d2d 0a20 2020 2020 2020 2068 6f6d 6573  --.        homes
-0000bc90: 6572 7665 7220 3a20 7374 720a 2020 2020  erver : str.    
-0000bca0: 2020 2020 2020 2020 5552 4c20 6f66 2068          URL of h
-0000bcb0: 6f6d 6573 6572 7665 722c 2065 2e67 2e20  omeserver, e.g. 
-0000bcc0: 2268 7474 7073 3a2f 2f6d 6174 7269 782e  "https://matrix.
-0000bcd0: 6578 616d 706c 652e 6f72 6722 0a20 2020  example.org".   
-0000bce0: 2020 2020 2075 7365 725f 6964 203a 2073       user_id : s
-0000bcf0: 7472 0a20 2020 2020 2020 2020 2020 2066  tr.            f
-0000bd00: 756c 6c20 7573 6572 2069 642c 2065 2e67  ull user id, e.g
-0000bd10: 2e20 2240 7573 6572 3a65 7861 6d70 6c65  . "@user:example
-0000bd20: 2e6f 7267 220a 2020 2020 2020 2020 6465  .org".        de
-0000bd30: 7669 6365 5f69 6420 3a20 7374 720a 2020  vice_id : str.  
-0000bd40: 2020 2020 2020 2020 2020 6465 7669 6365            device
-0000bd50: 2069 642c 2031 3020 7570 7065 7263 6173   id, 10 uppercas
-0000bd60: 6520 6c65 7474 6572 730a 2020 2020 2020  e letters.      
-0000bd70: 2020 6163 6365 7373 5f74 6f6b 656e 203a    access_token :
-0000bd80: 2073 7472 0a20 2020 2020 2020 2020 2020   str.           
-0000bd90: 2061 6363 6573 7320 746f 6b65 6e2c 206c   access token, l
-0000bda0: 6f6e 6720 6372 7970 746f 6772 6170 6869  ong cryptographi
-0000bdb0: 6320 6163 6365 7373 2074 6f6b 656e 0a20  c access token. 
-0000bdc0: 2020 2020 2020 2072 6f6f 6d5f 6964 203a         room_id :
-0000bdd0: 2073 7472 0a20 2020 2020 2020 2020 2020   str.           
-0000bde0: 206e 616d 6520 6f66 2072 6f6f 6d20 7768   name of room wh
-0000bdf0: 6572 6520 6d65 7373 6167 6520 7769 6c6c  ere message will
-0000be00: 2062 6520 7365 6e74 2074 6f2c 0a20 2020   be sent to,.   
-0000be10: 2020 2020 2020 2020 2065 2e67 2e20 2221           e.g. "!
-0000be20: 536f 6d65 526f 6f6d 4964 5374 7269 6e67  SomeRoomIdString
-0000be30: 3a65 7861 6d70 6c65 2e6f 7267 220a 2020  :example.org".  
-0000be40: 2020 2020 2020 2020 2020 7573 6572 206d            user m
-0000be50: 7573 7420 6265 206d 656d 6265 7220 6f66  ust be member of
-0000be60: 2074 6865 2070 726f 7669 6465 6420 726f   the provided ro
-0000be70: 6f6d 0a20 2020 2020 2020 2063 7265 6465  om.        crede
-0000be80: 6e74 6961 6c73 5f66 696c 6520 3a20 7374  ntials_file : st
-0000be90: 720a 2020 2020 2020 2020 2020 2020 6e61  r.            na
-0000bea0: 6d65 2f70 6174 6820 6f66 2066 696c 6520  me/path of file 
-0000beb0: 7768 6572 6520 746f 2073 746f 7265 0a20  where to store. 
-0000bec0: 2020 2020 2020 2020 2020 2063 7265 6465             crede
-0000bed0: 6e74 6961 6c73 2069 6e66 6f72 6d61 7469  ntials informati
-0000bee0: 6f6e 0a0a 2020 2020 2222 220a 2020 2020  on..    """.    
-0000bef0: 2320 6f70 656e 2074 6865 2063 7265 6465  # open the crede
-0000bf00: 6e74 6961 6c73 2066 696c 6520 696e 2077  ntials file in w
-0000bf10: 7269 7465 2d6d 6f64 650a 2020 2020 7769  rite-mode.    wi
-0000bf20: 7468 206f 7065 6e28 6372 6564 656e 7469  th open(credenti
-0000bf30: 616c 735f 6669 6c65 2c20 2277 2229 2061  als_file, "w") a
-0000bf40: 7320 663a 0a20 2020 2020 2020 2023 2077  s f:.        # w
-0000bf50: 7269 7465 2074 6865 206c 6f67 696e 2064  rite the login d
-0000bf60: 6574 6169 6c73 2074 6f20 6469 736b 0a20  etails to disk. 
-0000bf70: 2020 2020 2020 206a 736f 6e2e 6475 6d70         json.dump
-0000bf80: 280a 2020 2020 2020 2020 2020 2020 7b0a  (.            {.
-0000bf90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bfa0: 2320 652e 672e 2022 6874 7470 733a 2f2f  # e.g. "https://
-0000bfb0: 6d61 7472 6978 2e65 7861 6d70 6c65 2e6f  matrix.example.o
-0000bfc0: 7267 220a 2020 2020 2020 2020 2020 2020  rg".            
-0000bfd0: 2020 2020 2268 6f6d 6573 6572 7665 7222      "homeserver"
-0000bfe0: 3a20 686f 6d65 7365 7276 6572 2c0a 2020  : homeserver,.  
-0000bff0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000c000: 6465 7669 6365 2049 442c 2031 3020 7570  device ID, 10 up
-0000c010: 7065 7263 6173 6520 6c65 7474 6572 730a  percase letters.
-0000c020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c030: 2264 6576 6963 655f 6964 223a 2064 6576  "device_id": dev
-0000c040: 6963 655f 6964 2c0a 2020 2020 2020 2020  ice_id,.        
-0000c050: 2020 2020 2020 2020 2320 652e 672e 2022          # e.g. "
-0000c060: 4075 7365 723a 6578 616d 706c 652e 6f72  @user:example.or
-0000c070: 6722 0a20 2020 2020 2020 2020 2020 2020  g".             
-0000c080: 2020 2022 7573 6572 5f69 6422 3a20 7573     "user_id": us
-0000c090: 6572 5f69 642c 0a20 2020 2020 2020 2020  er_id,.         
-0000c0a0: 2020 2020 2020 2023 2065 2e67 2e20 2221         # e.g. "!
-0000c0b0: 536f 6d65 526f 6f6d 4964 5374 7269 6e67  SomeRoomIdString
-0000c0c0: 3a65 7861 6d70 6c65 2e6f 7267 220a 2020  :example.org".  
-0000c0d0: 2020 2020 2020 2020 2020 2020 2020 2272                "r
-0000c0e0: 6f6f 6d5f 6964 223a 2072 6f6f 6d5f 6964  oom_id": room_id
-0000c0f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000c100: 2020 2320 6c6f 6e67 2063 7279 7074 6f67    # long cryptog
-0000c110: 7261 7068 6963 2061 6363 6573 7320 746f  raphic access to
-0000c120: 6b65 6e0a 2020 2020 2020 2020 2020 2020  ken.            
-0000c130: 2020 2020 2261 6363 6573 735f 746f 6b65      "access_toke
-0000c140: 6e22 3a20 6163 6365 7373 5f74 6f6b 656e  n": access_token
-0000c150: 2c0a 2020 2020 2020 2020 2020 2020 7d2c  ,.            },
-0000c160: 0a20 2020 2020 2020 2020 2020 2066 2c0a  .            f,.
-0000c170: 2020 2020 2020 2020 290a 0a0a 6465 6620          )...def 
-0000c180: 7265 6164 5f63 7265 6465 6e74 6961 6c73  read_credentials
-0000c190: 5f66 726f 6d5f 6469 736b 2863 7265 6465  _from_disk(crede
-0000c1a0: 6e74 6961 6c73 5f66 696c 6529 202d 3e20  ntials_file) -> 
-0000c1b0: 6469 6374 3a0a 2020 2020 2222 2252 6561  dict:.    """Rea
-0000c1c0: 6420 7468 6520 7265 7175 6972 6564 206c  d the required l
-0000c1d0: 6f67 696e 2064 6574 6169 6c73 2066 726f  ogin details fro
-0000c1e0: 6d20 6469 736b 2e0a 0a20 2020 2049 7420  m disk...    It 
-0000c1f0: 6361 6e20 7468 656e 2062 6520 7573 6564  can then be used
-0000c200: 2074 6f20 6c6f 6720 696e 2077 6974 686f   to log in witho
-0000c210: 7574 2075 7369 6e67 2061 2070 6173 7377  ut using a passw
-0000c220: 6f72 642e 0a0a 2020 2020 4172 6775 6d65  ord...    Argume
-0000c230: 6e74 733a 0a20 2020 202d 2d2d 2d2d 2d2d  nts:.    -------
-0000c240: 2d2d 0a20 2020 2063 7265 6465 6e74 6961  --.    credentia
-0000c250: 6c73 5f66 696c 6520 3a20 7374 720a 2020  ls_file : str.  
-0000c260: 2020 2020 2020 6e61 6d65 2f70 6174 6820        name/path 
-0000c270: 6f66 2066 696c 6520 746f 2072 6561 6420  of file to read 
-0000c280: 6372 6564 656e 7469 616c 7320 696e 666f  credentials info
-0000c290: 726d 6174 696f 6e20 6672 6f6d 0a0a 2020  rmation from..  
-0000c2a0: 2020 2222 220a 2020 2020 2320 6f70 656e    """.    # open
-0000c2b0: 2074 6865 2066 696c 6520 696e 2072 6561   the file in rea
-0000c2c0: 642d 6f6e 6c79 206d 6f64 650a 2020 2020  d-only mode.    
-0000c2d0: 6773 2e6c 6f67 2e64 6562 7567 2822 5374  gs.log.debug("St
-0000c2e0: 6172 7469 6e67 2074 6f20 7265 6164 2063  arting to read c
-0000c2f0: 7265 6465 6e74 6961 6c73 2066 696c 652e  redentials file.
-0000c300: 2229 0a20 2020 2077 6974 6820 6f70 656e  ").    with open
-0000c310: 2863 7265 6465 6e74 6961 6c73 5f66 696c  (credentials_fil
-0000c320: 652c 2022 7222 2920 6173 2066 3a0a 2020  e, "r") as f:.  
-0000c330: 2020 2020 2020 6364 6963 7420 3d20 6a73        cdict = js
-0000c340: 6f6e 2e6c 6f61 6428 6629 0a20 2020 2067  on.load(f).    g
-0000c350: 732e 6c6f 672e 6465 6275 6728 2246 696e  s.log.debug("Fin
-0000c360: 6973 6865 6420 7265 6164 696e 6720 6372  ished reading cr
-0000c370: 6564 656e 7469 616c 7320 6669 6c65 2e22  edentials file."
-0000c380: 290a 2020 2020 7265 7475 726e 2063 6469  ).    return cdi
-0000c390: 6374 0a0a 0a64 6566 2064 6574 6572 6d69  ct...def determi
-0000c3a0: 6e65 5f63 7265 6465 6e74 6961 6c73 5f66  ne_credentials_f
-0000c3b0: 696c 6528 2920 2d3e 2073 7472 3a0a 2020  ile() -> str:.  
-0000c3c0: 2020 2222 2244 6574 6572 6d69 6e65 2074    """Determine t
-0000c3d0: 6865 2074 7275 6520 6669 6c65 6e61 6d65  he true filename
-0000c3e0: 206f 6620 6372 6564 656e 7469 616c 7320   of credentials 
-0000c3f0: 6669 6c65 2e0a 0a20 2020 2052 6574 7572  file...    Retur
-0000c400: 6e73 2066 696c 656e 616d 6520 7769 7468  ns filename with
-0000c410: 2066 756c 6c20 7061 7468 206f 7220 4e6f   full path or No
-0000c420: 6e65 2e0a 0a20 2020 2054 6869 7320 6675  ne...    This fu
-0000c430: 6e63 7469 6f6e 2063 6865 636b 7320 6966  nction checks if
-0000c440: 2061 2063 7265 6465 6e74 6961 6c73 2066   a credentials f
-0000c450: 696c 6520 6578 6973 7473 2e20 4966 206e  ile exists. If n
-0000c460: 6f2c 2069 7420 7769 6c6c 2061 736b 0a20  o, it will ask. 
-0000c470: 2020 2075 7365 7220 7175 6573 7469 6f6e     user question
-0000c480: 7320 7265 6772 6164 696e 6720 6c6f 6769  s regrading logi
-0000c490: 6e2c 2073 746f 7265 2074 6865 2069 6e66  n, store the inf
-0000c4a0: 6f20 696e 2061 206e 6577 6c79 2063 7265  o in a newly cre
-0000c4b0: 6174 6564 0a20 2020 2063 7265 6465 6e74  ated.    credent
-0000c4c0: 6961 6c73 2066 696c 6520 616e 6420 6578  ials file and ex
-0000c4d0: 6974 2e0a 0a20 2020 2049 6620 6120 6372  it...    If a cr
-0000c4e0: 6564 656e 7469 616c 7320 6669 6c65 2065  edentials file e
-0000c4f0: 7869 7374 732c 2069 7420 7769 6c6c 2072  xists, it will r
-0000c500: 6561 6420 6974 2c20 6c6f 6720 696e 746f  ead it, log into
-0000c510: 204d 6174 7269 782c 0a20 2020 2073 656e   Matrix,.    sen
-0000c520: 6420 6120 6d65 7373 6167 6520 616e 6420  d a message and 
-0000c530: 6578 6974 2e0a 0a20 2020 2054 6865 2063  exit...    The c
-0000c540: 7265 6465 6e74 6961 6c20 6669 6c65 2077  redential file w
-0000c550: 696c 6c20 6265 206c 6f6f 6b65 6420 666f  ill be looked fo
-0000c560: 7220 7468 6520 666f 6c6c 6f77 696e 6720  r the following 
-0000c570: 7761 793a 0a20 2020 2061 2920 6966 2061  way:.    a) if a
-0000c580: 2070 6174 6820 2865 2e67 2e20 222e 2e2f   path (e.g. "../
-0000c590: 6372 6564 2e6a 736f 6e22 2920 6973 2073  cred.json") is s
-0000c5a0: 7065 6369 6669 6564 2077 6974 6820 2d74  pecified with -t
-0000c5b0: 2069 7420 7769 6c6c 2062 6520 6c6f 6f6b   it will be look
-0000c5c0: 6564 0a20 2020 2020 2020 666f 7220 7468  ed.       for th
-0000c5d0: 6572 652e 2045 6e64 206f 6620 7365 6172  ere. End of sear
-0000c5e0: 6368 2e0a 2020 2020 6229 2069 6620 6f6e  ch..    b) if on
-0000c5f0: 6c79 2061 2066 696c 656e 616d 6520 7769  ly a filename wi
-0000c600: 7468 6f75 7420 7061 7468 2028 652e 672e  thout path (e.g.
-0000c610: 2022 6372 6564 2e6a 736f 6e22 2920 6973   "cred.json") is
-0000c620: 2073 7065 6369 6669 6564 0a20 2020 2020   specified.     
-0000c630: 2020 6669 7273 7420 6c6f 6f6b 2069 6e20    first look in 
-0000c640: 7468 6520 6375 7272 656e 7420 6c6f 6361  the current loca
-0000c650: 6c20 6469 7265 6374 6f72 792c 2069 6620  l directory, if 
-0000c660: 666f 756e 6420 7573 6520 6974 0a20 2020  found use it.   
-0000c670: 2063 2920 6966 206f 6e6c 7920 6120 6669   c) if only a fi
-0000c680: 6c65 6e61 6d65 2077 6974 686f 7574 2070  lename without p
-0000c690: 6174 6820 2865 2e67 2e20 2263 7265 642e  ath (e.g. "cred.
-0000c6a0: 6a73 6f6e 2229 2069 7320 7370 6563 6966  json") is specif
-0000c6b0: 6965 640a 2020 2020 2020 2061 6e64 2069  ied.       and i
-0000c6c0: 7420 6361 6e6e 6f74 2062 6520 666f 756e  t cannot be foun
-0000c6d0: 6420 696e 2074 6865 2063 7572 7265 6e74  d in the current
-0000c6e0: 206c 6f63 616c 2064 6972 6563 746f 7279   local directory
-0000c6f0: 2c20 7468 656e 0a20 2020 2020 2020 6c6f  , then.       lo
-0000c700: 6f6b 2066 6f72 2069 7420 696e 2064 6972  ok for it in dir
-0000c710: 6563 746f 7279 2024 484f 4d45 2f2e 636f  ectory $HOME/.co
-0000c720: 6e66 6967 2f6d 6174 7269 782d 636f 6d6d  nfig/matrix-comm
-0000c730: 616e 6465 722f 0a20 2020 2054 4c44 523a  ander/.    TLDR:
-0000c740: 206f 6e20 6669 7273 7420 7275 6e20 6974   on first run it
-0000c750: 2077 696c 6c20 6265 2077 7269 7474 656e   will be written
-0000c760: 2074 6f20 6375 7272 656e 7420 6c6f 6361   to current loca
-0000c770: 6c20 6469 7265 6374 6f72 790a 2020 2020  l directory.    
-0000c780: 2020 206f 7220 746f 2070 6174 6820 7370     or to path sp
-0000c790: 6563 6966 6965 6420 7769 7468 202d 2d63  ecified with --c
-0000c7a0: 7265 6465 6e74 6961 6c73 2063 6f6d 6d61  redentials comma
-0000c7b0: 6e64 206c 696e 6520 6172 6775 6d65 6e74  nd line argument
-0000c7c0: 2e0a 2020 2020 2020 204f 6e20 6675 7274  ..       On furt
-0000c7d0: 6865 7220 7265 6164 732c 2070 726f 6772  her reads, progr
-0000c7e0: 616d 2077 696c 6c20 6c6f 6f6b 2069 6e20  am will look in 
-0000c7f0: 6375 7272 656e 746c 7920 6c6f 6361 6c20  currently local 
-0000c800: 6469 7265 6374 6f72 790a 2020 2020 2020  directory.      
-0000c810: 206f 7220 696e 2070 6174 6820 7370 6563   or in path spec
-0000c820: 6966 6965 6420 7769 7468 202d 2d63 7265  ified with --cre
-0000c830: 6465 6e74 6961 6c73 2063 6f6d 6d61 6e64  dentials command
-0000c840: 206c 696e 6520 6172 6775 6d65 6e74 2e0a   line argument..
-0000c850: 2020 2020 2020 2049 6620 6e6f 7420 666f         If not fo
-0000c860: 756e 6420 7468 6572 6520 2861 6e64 206f  und there (and o
-0000c870: 6e6c 7920 6669 6c65 6e61 6d65 2077 6974  nly filename wit
-0000c880: 686f 7574 2070 6174 6820 6769 7665 6e29  hout path given)
-0000c890: 2c0a 2020 2020 2020 2061 7320 6120 7365  ,.       as a se
-0000c8a0: 636f 6e64 6172 7920 6368 6f69 6365 2070  condary choice p
-0000c8b0: 726f 6772 616d 2077 696c 6c20 6c6f 6f6b  rogram will look
-0000c8c0: 2066 6f72 2069 7420 696e 0a20 2020 2020   for it in.     
-0000c8d0: 2020 6469 7265 6374 6f72 7920 2448 4f4d    directory $HOM
-0000c8e0: 452f 2e63 6f6e 6669 672f 6d61 7472 6978  E/.config/matrix
-0000c8f0: 2d63 6f6d 6d61 6e64 6572 2f0a 0a20 2020  -commander/..   
-0000c900: 2022 2222 0a20 2020 2063 7265 6465 6e74   """.    credent
-0000c910: 6961 6c73 5f66 696c 6520 3d20 6773 2e70  ials_file = gs.p
-0000c920: 612e 6372 6564 656e 7469 616c 7320 2023  a.credentials  #
-0000c930: 2064 6566 6175 6c74 206c 6f63 6174 696f   default locatio
-0000c940: 6e0a 2020 2020 6966 2028 6e6f 7420 6f73  n.    if (not os
-0000c950: 2e70 6174 682e 6973 6669 6c65 2867 732e  .path.isfile(gs.
-0000c960: 7061 2e63 7265 6465 6e74 6961 6c73 2929  pa.credentials))
-0000c970: 2061 6e64 2028 0a20 2020 2020 2020 2067   and (.        g
-0000c980: 732e 7061 2e63 7265 6465 6e74 6961 6c73  s.pa.credentials
-0000c990: 203d 3d20 6f73 2e70 6174 682e 6261 7365   == os.path.base
-0000c9a0: 6e61 6d65 2867 732e 7061 2e63 7265 6465  name(gs.pa.crede
-0000c9b0: 6e74 6961 6c73 290a 2020 2020 293a 0a20  ntials).    ):. 
-0000c9c0: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-0000c9d0: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
-0000c9e0: 2022 4372 6564 656e 7469 616c 7320 6669   "Credentials fi
-0000c9f0: 6c65 2064 6f65 7320 6e6f 7420 6578 6973  le does not exis
-0000ca00: 7420 6c6f 6361 6c6c 792e 2022 0a20 2020  t locally. ".   
-0000ca10: 2020 2020 2020 2020 2022 4669 6c65 206e           "File n
-0000ca20: 616d 6520 6861 7320 6e6f 2070 6174 682e  ame has no path.
-0000ca30: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
-0000ca40: 2020 2020 6372 6564 656e 7469 616c 735f      credentials_
-0000ca50: 6669 6c65 203d 2043 5245 4445 4e54 4941  file = CREDENTIA
-0000ca60: 4c53 5f44 4952 5f4c 4153 5452 4553 4f52  LS_DIR_LASTRESOR
-0000ca70: 5420 2b20 222f 2220 2b20 6773 2e70 612e  T + "/" + gs.pa.
-0000ca80: 6372 6564 656e 7469 616c 730a 2020 2020  credentials.    
-0000ca90: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-0000caa0: 280a 2020 2020 2020 2020 2020 2020 6627  (.            f'
-0000cab0: 5472 7969 6e67 2070 6174 6820 227b 6372  Trying path "{cr
-0000cac0: 6564 656e 7469 616c 735f 6669 6c65 7d22  edentials_file}"
-0000cad0: 2061 7320 6c61 7374 2072 6573 6f72 742e   as last resort.
-0000cae0: 2027 0a20 2020 2020 2020 2020 2020 2022   '.            "
-0000caf0: 5375 6767 6573 7469 6e67 2074 6f20 6c6f  Suggesting to lo
-0000cb00: 6f6b 2066 6f72 2069 7420 7468 6572 652e  ok for it there.
-0000cb10: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
-0000cb20: 2020 2020 6966 206f 732e 7061 7468 2e69      if os.path.i
-0000cb30: 7366 696c 6528 6372 6564 656e 7469 616c  sfile(credential
-0000cb40: 735f 6669 6c65 293a 0a20 2020 2020 2020  s_file):.       
-0000cb50: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-0000cb60: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-0000cb70: 2020 2022 5765 2066 6f75 6e64 2074 6865     "We found the
-0000cb80: 2066 696c 652e 2049 7420 6578 6973 7473   file. It exists
-0000cb90: 2069 6e20 7468 6520 6c61 7374 2072 6573   in the last res
-0000cba0: 6f72 7420 220a 2020 2020 2020 2020 2020  ort ".          
-0000cbb0: 2020 2020 2020 6627 6469 7265 6374 6f72        f'director
-0000cbc0: 7920 227b 6372 6564 656e 7469 616c 735f  y "{credentials_
-0000cbd0: 6669 6c65 7d22 2e20 270a 2020 2020 2020  file}". '.      
-0000cbe0: 2020 2020 2020 2020 2020 2253 7567 6765            "Sugge
-0000cbf0: 7374 696e 6720 746f 2075 7365 2074 6869  sting to use thi
-0000cc00: 7320 6f6e 652e 220a 2020 2020 2020 2020  s one.".        
-0000cc10: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
-0000cc20: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000cc30: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
-0000cc40: 2020 2020 2020 2020 2020 2020 2020 2246                "F
-0000cc50: 696c 6520 646f 6573 206e 6f74 2065 7869  ile does not exi
-0000cc60: 7374 7320 6569 7468 6572 2069 6e20 7468  sts either in th
-0000cc70: 6520 6c61 7374 2072 6573 6f72 7420 220a  e last resort ".
-0000cc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cc90: 2264 6972 6563 746f 7279 206f 7220 7468  "directory or th
-0000cca0: 6520 6c6f 6361 6c20 6469 7265 6374 6f72  e local director
-0000ccb0: 792e 2022 0a20 2020 2020 2020 2020 2020  y. ".           
-0000ccc0: 2020 2020 2022 4669 6c65 206e 6f74 2066       "File not f
-0000ccd0: 6f75 6e64 2061 6e79 7768 6572 652e 204f  ound anywhere. O
-0000cce0: 6e65 2077 696c 6c20 6861 7665 2074 6f20  ne will have to 
-0000ccf0: 6265 2022 0a20 2020 2020 2020 2020 2020  be ".           
-0000cd00: 2020 2020 2022 6372 6561 7465 642e 2053       "created. S
-0000cd10: 6f20 7765 2073 7567 6765 7374 2074 6865  o we suggest the
-0000cd20: 206c 6f63 616c 2064 6972 6563 746f 7279   local directory
-0000cd30: 2e22 0a20 2020 2020 2020 2020 2020 2029  .".            )
-0000cd40: 0a20 2020 2020 2020 2020 2020 2063 7265  .            cre
-0000cd50: 6465 6e74 6961 6c73 5f66 696c 6520 3d20  dentials_file = 
-0000cd60: 6773 2e70 612e 6372 6564 656e 7469 616c  gs.pa.credential
-0000cd70: 730a 2020 2020 656c 7365 3a0a 2020 2020  s.    else:.    
-0000cd80: 2020 2020 6966 206f 732e 7061 7468 2e69      if os.path.i
-0000cd90: 7366 696c 6528 6773 2e70 612e 6372 6564  sfile(gs.pa.cred
-0000cda0: 656e 7469 616c 7329 3a0a 2020 2020 2020  entials):.      
-0000cdb0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-0000cdc0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-0000cdd0: 2020 2020 2243 7265 6465 6e74 6961 6c73      "Credentials
-0000cde0: 2066 696c 6520 6578 6973 7465 642e 2022   file existed. "
-0000cdf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ce00: 2022 536f 2074 6869 7320 6973 2074 6865   "So this is the
-0000ce10: 206f 6e65 2077 6520 7375 6767 6573 7420   one we suggest 
-0000ce20: 746f 2075 7365 2e20 220a 2020 2020 2020  to use. ".      
-0000ce30: 2020 2020 2020 2020 2020 6622 6669 6c65            f"file
-0000ce40: 3a20 7b63 7265 6465 6e74 6961 6c73 5f66  : {credentials_f
-0000ce50: 696c 657d 220a 2020 2020 2020 2020 2020  ile}".          
-0000ce60: 2020 290a 2020 2020 2020 2020 656c 7365    ).        else
-0000ce70: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
-0000ce80: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
-0000ce90: 2020 2020 2020 2020 2020 2020 2243 7265              "Cre
-0000cea0: 6465 6e74 6961 6c73 2066 696c 6520 7761  dentials file wa
-0000ceb0: 7320 7370 6563 6966 6965 6420 7769 7468  s specified with
-0000cec0: 2066 756c 6c20 7061 7468 2e20 220a 2020   full path. ".  
-0000ced0: 2020 2020 2020 2020 2020 2020 2020 2253                "S
-0000cee0: 6f20 7765 2073 7567 6765 7374 2074 6861  o we suggest tha
-0000cef0: 7420 6f6e 652e 2022 0a20 2020 2020 2020  t one. ".       
-0000cf00: 2020 2020 2020 2020 2066 2266 696c 653a           f"file:
-0000cf10: 207b 6372 6564 656e 7469 616c 735f 6669   {credentials_fi
-0000cf20: 6c65 7d22 0a20 2020 2020 2020 2020 2020  le}".           
-0000cf30: 2029 0a20 2020 2023 2054 6865 2072 6574   ).    # The ret
-0000cf40: 7572 6e65 6420 6669 6c65 2028 7769 7468  urned file (with
-0000cf50: 206f 7220 7769 7468 6f75 7420 7061 7468   or without path
-0000cf60: 2920 206d 6967 6874 206f 7220 6d69 6768  )  might or migh
-0000cf70: 7420 6e6f 7420 6578 6973 742e 0a20 2020  t not exist..   
-0000cf80: 2023 2042 7574 2069 6620 6974 2064 6f65   # But if it doe
-0000cf90: 7320 6e6f 7420 6578 6973 742c 2069 7420  s not exist, it 
-0000cfa0: 6973 2065 6974 6865 7220 6120 6675 6c6c  is either a full
-0000cfb0: 2070 6174 682c 206f 7220 6c6f 6361 6c2e   path, or local.
-0000cfc0: 0a20 2020 2023 2057 6520 646f 206e 6f74  .    # We do not
-0000cfd0: 2077 616e 7420 746f 2072 6574 7572 6e20   want to return 
-0000cfe0: 7468 6520 6c61 7374 2072 6573 6f72 7420  the last resort 
-0000cff0: 7061 7468 2069 6620 6974 2064 6f65 7320  path if it does 
-0000d000: 6e6f 7420 6578 6973 742c 0a20 2020 2023  not exist,.    #
-0000d010: 2073 6f20 7468 6174 2077 6865 6e20 6974   so that when it
-0000d020: 2069 7320 6372 6561 7465 6420 6974 2069   is created it i
-0000d030: 7320 6372 6561 7465 6420 7768 6572 6520  s created where 
-0000d040: 7370 6563 6966 6963 616c 6c79 2073 7065  specifically spe
-0000d050: 6369 6669 6564 0a20 2020 2023 206f 7220  cified.    # or 
-0000d060: 696e 206c 6f63 616c 2064 6972 2028 6275  in local dir (bu
-0000d070: 7420 6e6f 7420 696e 206c 6173 7420 7265  t not in last re
-0000d080: 736f 7274 2064 6972 207e 2f2e 636f 6e66  sort dir ~/.conf
-0000d090: 6967 2f2e 2e2e 290a 2020 2020 7265 7475  ig/...).    retu
-0000d0a0: 726e 2063 7265 6465 6e74 6961 6c73 5f66  rn credentials_f
-0000d0b0: 696c 650a 0a0a 6465 6620 6465 7465 726d  ile...def determ
-0000d0c0: 696e 655f 7374 6f72 655f 6469 7228 2920  ine_store_dir() 
-0000d0d0: 2d3e 2073 7472 3a0a 2020 2020 2222 2244  -> str:.    """D
-0000d0e0: 6574 6572 6d69 6e65 2074 6865 2074 7275  etermine the tru
-0000d0f0: 6520 6675 6c6c 2064 6972 6563 746f 7279  e full directory
-0000d100: 206e 616d 6520 6f66 2073 746f 7265 2064   name of store d
-0000d110: 6972 6563 746f 7279 2e0a 0a20 2020 2052  irectory...    R
-0000d120: 6574 7572 6e73 2066 696c 656e 616d 6520  eturns filename 
-0000d130: 7769 7468 2066 756c 6c20 7061 7468 2028  with full path (
-0000d140: 6120 6469 7229 206f 7220 4e6f 6e65 2e0a  a dir) or None..
-0000d150: 0a20 2020 2046 6f72 2068 6973 746f 7269  .    For histori
-0000d160: 6320 7265 6173 6f6e 733a 0a20 2020 2049  c reasons:.    I
-0000d170: 6620 2d2d 656e 6372 7970 7465 6420 2865  f --encrypted (e
-0000d180: 6e63 7279 7074 6564 2920 6973 204e 4f54  ncrypted) is NOT
-0000d190: 2074 7572 6e65 6420 6f6e 2c20 7265 7475   turned on, retu
-0000d1a0: 726e 204e 6f6e 652e 0a0a 2020 2020 5468  rn None...    Th
-0000d1b0: 6520 7374 6f72 6520 7061 7468 2077 696c  e store path wil
-0000d1c0: 6c20 6265 206c 6f6f 6b65 6420 666f 7220  l be looked for 
-0000d1d0: 7468 6520 666f 6c6c 6f77 696e 6720 7761  the following wa
-0000d1e0: 793a 0a20 2020 2067 732e 7061 2e73 746f  y:.    gs.pa.sto
-0000d1f0: 7265 2070 726f 7669 6465 7320 6569 7468  re provides eith
-0000d200: 6572 2064 6566 6175 6c74 2076 616c 7565  er default value
-0000d210: 206f 7220 7573 6572 2073 7065 6369 6669   or user specifi
-0000d220: 6564 2076 616c 7565 0a20 2020 2061 2920  ed value.    a) 
-0000d230: 4669 7273 7420 6c6f 6f6b 6564 2061 7420  First looked at 
-0000d240: 6465 6661 756c 742f 7370 6563 6966 6965  default/specifie
-0000d250: 6420 7661 6c75 652e 2049 6620 6469 7220  d value. If dir 
-0000d260: 6578 6973 7473 2c0a 2020 2020 2020 2075  exists,.       u
-0000d270: 7365 2069 742c 2065 6e64 206f 6620 7365  se it, end of se
-0000d280: 6172 6368 2e0a 2020 2020 6229 2069 6620  arch..    b) if 
-0000d290: 6c61 7374 2d72 6573 6f72 7420 7374 6f72  last-resort stor
-0000d2a0: 6520 6469 7220 6578 6973 7473 2c20 7573  e dir exists, us
-0000d2b0: 6520 6974 2c20 656e 6420 6f66 2073 6561  e it, end of sea
-0000d2c0: 7263 682e 0a20 2020 2063 2920 6966 206f  rch..    c) if o
-0000d2d0: 6e6c 7920 6120 6469 726e 616d 6520 7769  nly a dirname wi
-0000d2e0: 7468 6f75 7420 7061 7468 2028 652e 672e  thout path (e.g.
-0000d2f0: 2022 7374 6f72 6522 2920 6973 2073 7065   "store") is spe
-0000d300: 6369 6669 6564 0a20 2020 2020 2020 616e  cified.       an
-0000d310: 6420 6974 2063 616e 6e6f 7420 6265 2066  d it cannot be f
-0000d320: 6f75 6e64 2069 6e20 7468 6520 6375 7272  ound in the curr
-0000d330: 656e 7420 6c6f 6361 6c20 6469 7265 6374  ent local direct
-0000d340: 6f72 792c 2074 6865 6e0a 2020 2020 2020  ory, then.      
-0000d350: 206c 6f6f 6b20 666f 7220 6974 2069 6e20   look for it in 
-0000d360: 6c61 7374 2d72 6573 6f72 7420 7061 7468  last-resort path
-0000d370: 2e0a 2020 2020 544c 4452 3a20 5468 6520  ..    TLDR: The 
-0000d380: 7072 6f67 7261 6d20 7769 6c6c 206c 6f6f  program will loo
-0000d390: 6b20 696e 2070 6174 6820 7370 6563 6966  k in path specif
-0000d3a0: 6965 6420 7769 7468 202d 2d73 746f 7265  ied with --store
-0000d3b0: 0a20 2020 2020 2020 636f 6d6d 616e 6420  .       command 
-0000d3c0: 6c69 6e65 2061 7267 756d 656e 742e 2049  line argument. I
-0000d3d0: 6620 6e6f 7420 666f 756e 6420 7468 6572  f not found ther
-0000d3e0: 6520 696e 2064 6566 6175 6c74 0a20 2020  e in default.   
-0000d3f0: 2020 2020 6c6f 6361 6c20 6469 722e 2049      local dir. I
-0000d400: 6620 6e6f 7420 666f 756e 6420 7468 6572  f not found ther
-0000d410: 6520 696e 206c 6173 742d 7265 736f 7274  e in last-resort
-0000d420: 2064 6972 2e0a 2020 2020 2020 2049 6620   dir..       If 
-0000d430: 6e6f 7420 666f 756e 6420 7468 6572 6520  not found there 
-0000d440: 2861 6e64 206f 6e6c 7920 6469 726e 616d  (and only dirnam
-0000d450: 6520 7769 7468 6f75 7420 7061 7468 2067  e without path g
-0000d460: 6976 656e 292c 0a20 2020 2020 2020 6173  iven),.       as
-0000d470: 2061 2066 696e 616c 2063 686f 6963 652c   a final choice,
-0000d480: 2074 6865 2070 726f 6772 616d 2077 696c   the program wil
-0000d490: 6c20 6c6f 6f6b 2066 6f72 2069 7420 696e  l look for it in
-0000d4a0: 0a20 2020 2020 2020 6c61 7374 2072 6573  .       last res
-0000d4b0: 6f72 7420 7061 7468 2e0a 2020 2020 4966  ort path..    If
-0000d4c0: 206e 6f74 2066 6f75 6e64 2061 6e79 7768   not found anywh
-0000d4d0: 6572 652c 2069 7420 7769 6c6c 2072 6574  ere, it will ret
-0000d4e0: 7572 6e20 6465 6661 756c 742f 7370 6563  urn default/spec
-0000d4f0: 6966 6965 6420 7661 6c75 652e 0a0a 2020  ified value...  
-0000d500: 2020 2222 220a 2020 2020 6966 206e 6f74    """.    if not
-0000d510: 2067 732e 7061 2e73 746f 7265 3a0a 2020   gs.pa.store:.  
-0000d520: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-0000d530: 650a 2020 2020 6966 206e 6f74 2067 732e  e.    if not gs.
-0000d540: 7061 2e65 6e63 7279 7074 6564 3a0a 2020  pa.encrypted:.  
-0000d550: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-0000d560: 650a 2020 2020 7061 7267 735f 7374 6f72  e.    pargs_stor
-0000d570: 655f 6e6f 726d 203d 206f 732e 7061 7468  e_norm = os.path
-0000d580: 2e6e 6f72 6d70 6174 6828 6773 2e70 612e  .normpath(gs.pa.
-0000d590: 7374 6f72 6529 2020 2320 6e6f 726d 6169  store)  # normai
-0000d5a0: 6c7a 6564 2066 6f72 2068 756d 616e 730a  lzed for humans.
-0000d5b0: 2020 2020 6966 206f 732e 7061 7468 2e69      if os.path.i
-0000d5c0: 7364 6972 2867 732e 7061 2e73 746f 7265  sdir(gs.pa.store
-0000d5d0: 293a 0a20 2020 2020 2020 2067 732e 6c6f  ):.        gs.lo
-0000d5e0: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
-0000d5f0: 2020 2020 2022 466f 756e 6420 616e 2065       "Found an e
-0000d600: 7869 7374 696e 6720 7374 6f72 6520 696e  xisting store in
-0000d610: 2064 6972 6563 746f 7279 2022 0a20 2020   directory ".   
-0000d620: 2020 2020 2020 2020 2066 2722 7b70 6172           f'"{par
-0000d630: 6773 5f73 746f 7265 5f6e 6f72 6d7d 2220  gs_store_norm}" 
-0000d640: 286c 6f63 616c 206f 7220 6172 6775 6d65  (local or argume
-0000d650: 6e74 7329 2e20 270a 2020 2020 2020 2020  nts). '.        
-0000d660: 2020 2020 2249 7420 7769 6c6c 2062 6520      "It will be 
-0000d670: 7573 6564 2e22 0a20 2020 2020 2020 2029  used.".        )
-0000d680: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000d690: 7061 7267 735f 7374 6f72 655f 6e6f 726d  pargs_store_norm
-0000d6a0: 0a20 2020 2069 6620 6773 2e70 612e 7374  .    if gs.pa.st
-0000d6b0: 6f72 6520 213d 2053 544f 5245 5f44 4952  ore != STORE_DIR
-0000d6c0: 5f44 4546 4155 4c54 2061 6e64 2067 732e  _DEFAULT and gs.
-0000d6d0: 7061 2e73 746f 7265 2021 3d20 6f73 2e70  pa.store != os.p
-0000d6e0: 6174 682e 6261 7365 6e61 6d65 280a 2020  ath.basename(.  
-0000d6f0: 2020 2020 2020 6773 2e70 612e 7374 6f72        gs.pa.stor
-0000d700: 650a 2020 2020 293a 0a20 2020 2020 2020  e.    ):.       
-0000d710: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
-0000d720: 2020 2020 2020 2020 2020 2066 2753 746f             f'Sto
-0000d730: 7265 2064 6972 6563 746f 7279 2022 7b70  re directory "{p
-0000d740: 6172 6773 5f73 746f 7265 5f6e 6f72 6d7d  args_store_norm}
-0000d750: 2220 7761 7320 7370 6563 6966 6965 6420  " was specified 
-0000d760: 6279 2027 0a20 2020 2020 2020 2020 2020  by '.           
-0000d770: 2022 7573 6572 2c20 6974 2069 7320 6120   "user, it is a 
-0000d780: 6469 7265 6374 6f72 7920 7769 7468 2061  directory with a
-0000d790: 2070 6174 682c 2062 7574 2074 6865 2064   path, but the d
-0000d7a0: 6972 6563 746f 7279 2022 0a20 2020 2020  irectory ".     
-0000d7b0: 2020 2020 2020 2022 646f 6573 206e 6f74         "does not
-0000d7c0: 2065 7869 7374 2e20 220a 2020 2020 2020   exist. ".      
-0000d7d0: 2020 290a 2020 2020 2020 2020 2320 6661    ).        # fa
-0000d7e0: 6c6c 2074 6872 6f75 6768 2074 6f77 6172  ll through towar
-0000d7f0: 6473 2065 6e64 696e 6720 6f66 2066 756e  ds ending of fun
-0000d800: 6374 696f 6e20 746f 2070 7269 6e74 2061  ction to print a
-0000d810: 6e64 2072 6574 7572 6e20 7661 6c75 650a  nd return value.
-0000d820: 2020 2020 2020 2020 2320 6372 6561 7465          # create
-0000d830: 2069 6e20 7468 6520 7370 6563 6966 6965   in the specifie
-0000d840: 642c 2064 6972 6563 746f 7279 2077 6974  d, directory wit
-0000d850: 6820 7061 7468 0a20 2020 2069 6620 6773  h path.    if gs
-0000d860: 2e70 612e 7374 6f72 6520 3d3d 2053 544f  .pa.store == STO
-0000d870: 5245 5f44 4952 5f44 4546 4155 4c54 2061  RE_DIR_DEFAULT a
-0000d880: 6e64 206f 732e 7061 7468 2e69 7364 6972  nd os.path.isdir
-0000d890: 280a 2020 2020 2020 2020 5354 4f52 455f  (.        STORE_
-0000d8a0: 4449 525f 4c41 5354 5245 534f 5254 0a20  DIR_LASTRESORT. 
-0000d8b0: 2020 2029 3a0a 2020 2020 2020 2020 6773     ):.        gs
-0000d8c0: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
-0000d8d0: 2020 2020 2020 2020 2253 746f 7265 2077          "Store w
-0000d8e0: 6173 206e 6f74 2066 6f75 6e64 2069 6e20  as not found in 
-0000d8f0: 6465 6661 756c 7420 6c6f 6361 6c20 6469  default local di
-0000d900: 7265 6374 6f72 792e 2022 0a20 2020 2020  rectory. ".     
-0000d910: 2020 2020 2020 2022 4275 7420 666f 756e         "But foun
-0000d920: 6420 616e 2065 7869 7374 696e 6720 7374  d an existing st
-0000d930: 6f72 6520 6469 7265 6374 6f72 7920 696e  ore directory in
-0000d940: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
-0000d950: 2722 7b53 544f 5245 5f44 4952 5f4c 4153  '"{STORE_DIR_LAS
-0000d960: 5452 4553 4f52 547d 2220 6469 7265 6374  TRESORT}" direct
-0000d970: 6f72 792e 2027 0a20 2020 2020 2020 2020  ory. '.         
-0000d980: 2020 2022 4974 2077 696c 6c20 6265 2075     "It will be u
-0000d990: 7365 642e 220a 2020 2020 2020 2020 290a  sed.".        ).
-0000d9a0: 2020 2020 2020 2020 7265 7475 726e 2053          return S
-0000d9b0: 544f 5245 5f44 4952 5f4c 4153 5452 4553  TORE_DIR_LASTRES
-0000d9c0: 4f52 540a 0a20 2020 2069 6620 6773 2e70  ORT..    if gs.p
-0000d9d0: 612e 7374 6f72 6520 3d3d 206f 732e 7061  a.store == os.pa
-0000d9e0: 7468 2e62 6173 656e 616d 6528 6773 2e70  th.basename(gs.p
-0000d9f0: 612e 7374 6f72 6529 3a0a 2020 2020 2020  a.store):.      
-0000da00: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
-0000da10: 2020 2020 2020 2020 2020 2020 6627 5374              f'St
-0000da20: 6f72 6520 6469 7265 6374 6f72 7920 227b  ore directory "{
-0000da30: 7061 7267 735f 7374 6f72 655f 6e6f 726d  pargs_store_norm
-0000da40: 7d22 2069 7320 6a75 7374 2061 206e 616d  }" is just a nam
-0000da50: 6520 270a 2020 2020 2020 2020 2020 2020  e '.            
-0000da60: 2277 6974 686f 7574 2061 2070 6174 682e  "without a path.
-0000da70: 2041 6c72 6561 6479 206c 6f6f 6b65 6420   Already looked 
-0000da80: 6c6f 6361 6c6c 792c 2062 7574 206e 6f74  locally, but not
-0000da90: 2066 6f75 6e64 2022 0a20 2020 2020 2020   found ".       
-0000daa0: 2020 2020 2022 6c6f 6361 6c6c 792e 2053       "locally. S
-0000dab0: 6f20 6e6f 7720 6c6f 6f6b 696e 6720 666f  o now looking fo
-0000dac0: 7220 6974 2069 6e20 6c61 7374 2d72 6573  r it in last-res
-0000dad0: 6f72 7420 7061 7468 2e22 0a20 2020 2020  ort path.".     
-0000dae0: 2020 2029 0a20 2020 2020 2020 206c 6173     ).        las
-0000daf0: 745f 7265 736f 7274 203d 206f 732e 7061  t_resort = os.pa
-0000db00: 7468 2e6e 6f72 6d70 6174 6828 0a20 2020  th.normpath(.   
-0000db10: 2020 2020 2020 2020 2053 544f 5245 5f50           STORE_P
-0000db20: 4154 485f 4c41 5354 5245 534f 5254 202b  ATH_LASTRESORT +
-0000db30: 2022 2f22 202b 2067 732e 7061 2e73 746f   "/" + gs.pa.sto
-0000db40: 7265 0a20 2020 2020 2020 2029 0a20 2020  re.        ).   
-0000db50: 2020 2020 2069 6620 6f73 2e70 6174 682e       if os.path.
-0000db60: 6973 6469 7228 6c61 7374 5f72 6573 6f72  isdir(last_resor
-0000db70: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-0000db80: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
-0000db90: 2020 2020 2020 2020 2020 2020 2020 2246                "F
-0000dba0: 6f75 6e64 2061 6e20 6578 6973 7469 6e67  ound an existing
-0000dbb0: 2073 746f 7265 2064 6972 6563 746f 7279   store directory
-0000dbc0: 2069 6e20 220a 2020 2020 2020 2020 2020   in ".          
-0000dbd0: 2020 2020 2020 6627 227b 6c61 7374 5f72        f'"{last_r
-0000dbe0: 6573 6f72 747d 2220 6469 7265 6374 6f72  esort}" director
-0000dbf0: 792e 2049 7420 7769 6c6c 2062 6520 7573  y. It will be us
-0000dc00: 6564 2e27 0a20 2020 2020 2020 2020 2020  ed.'.           
-0000dc10: 2029 0a20 2020 2020 2020 2020 2020 2072   ).            r
-0000dc20: 6574 7572 6e20 6c61 7374 5f72 6573 6f72  eturn last_resor
-0000dc30: 740a 0a20 2020 2067 732e 6c6f 672e 6465  t..    gs.log.de
-0000dc40: 6275 6728 0a20 2020 2020 2020 2022 5374  bug(.        "St
-0000dc50: 6f72 6520 6469 7265 6374 6f72 7920 7761  ore directory wa
-0000dc60: 7320 6e6f 7420 666f 756e 6420 616e 7977  s not found anyw
-0000dc70: 6865 7265 2e20 4865 6e63 652c 2077 6520  here. Hence, we 
-0000dc80: 7769 6c6c 2073 7567 6765 7374 2022 0a20  will suggest ". 
-0000dc90: 2020 2020 2020 2066 2722 7b70 6172 6773         f'"{pargs
-0000dca0: 5f73 746f 7265 5f6e 6f72 6d7d 2220 286c  _store_norm}" (l
-0000dcb0: 6f63 616c 2064 6972 6563 746f 7279 2920  ocal directory) 
-0000dcc0: 6173 2073 746f 7265 2064 6972 6563 746f  as store directo
-0000dcd0: 7279 2e27 0a20 2020 2029 0a20 2020 2072  ry.'.    ).    r
-0000dce0: 6574 7572 6e20 7061 7267 735f 7374 6f72  eturn pargs_stor
-0000dcf0: 655f 6e6f 726d 2020 2320 6372 6561 7465  e_norm  # create
-0000dd00: 2069 6e20 7468 6520 7370 6563 6966 6965   in the specifie
-0000dd10: 642c 206c 6f63 616c 2064 6972 2077 6974  d, local dir wit
-0000dd20: 686f 7574 2070 6174 680a 0a0a 6173 796e  hout path...asyn
-0000dd30: 6320 6465 6620 6465 7465 726d 696e 655f  c def determine_
-0000dd40: 646d 5f72 6f6f 6d73 280a 2020 2020 7573  dm_rooms(.    us
-0000dd50: 6572 733a 206c 6973 742c 2063 6c69 656e  ers: list, clien
-0000dd60: 743a 2041 7379 6e63 436c 6965 6e74 2c20  t: AsyncClient, 
-0000dd70: 6372 6564 656e 7469 616c 733a 2064 6963  credentials: dic
-0000dd80: 740a 2920 2d3e 206c 6973 743a 0a20 2020  t.) -> list:.   
-0000dd90: 2022 2222 4465 7465 726d 696e 6520 7468   """Determine th
-0000dda0: 6520 726f 6f6d 7320 746f 2073 656e 6420  e rooms to send 
-0000ddb0: 746f 2e0a 0a20 2020 2055 7365 7273 2063  to...    Users c
-0000ddc0: 616e 2062 6520 7370 6563 6966 6965 6420  an be specified 
-0000ddd0: 7769 7468 202d 2d75 7365 7220 666f 7220  with --user for 
-0000dde0: 7365 6e64 2061 6e64 206c 6973 7465 6e20  send and listen 
-0000ddf0: 6f70 6572 6174 696f 6e73 2e0a 2020 2020  operations..    
-0000de00: 5468 6573 6520 726f 6f6d 7320 7765 206c  These rooms we l
-0000de10: 6162 656c 2044 4d20 2864 6972 6563 7420  abel DM (direct 
-0000de20: 6d65 7373 6167 696e 6729 2072 6f6f 6d73  messaging) rooms
-0000de30: 2e0a 2020 2020 4279 2074 6861 7420 7765  ..    By that we
-0000de40: 206d 6561 6e73 2072 6f6f 6d73 2074 6861   means rooms tha
-0000de50: 7420 6f6e 6c79 2068 6176 6520 3220 6d65  t only have 2 me
-0000de60: 6d62 6572 732c 2061 6e64 2074 6865 7365  mbers, and these
-0000de70: 2074 776f 0a20 2020 206d 656d 6265 7273   two.    members
-0000de80: 2062 6569 6e67 2074 6865 2073 656e 6465   being the sende
-0000de90: 7220 616e 6420 7468 6520 7265 6369 7069  r and the recipi
-0000dea0: 656e 7420 696e 2071 7565 7374 696f 6e2e  ent in question.
-0000deb0: 0a20 2020 2057 6520 646f 206e 6f74 2063  .    We do not c
-0000dec0: 6172 6520 6162 6f75 7420 2769 735f 6772  are about 'is_gr
-0000ded0: 6f75 7027 206f 7220 2769 735f 6469 7265  oup' or 'is_dire
-0000dee0: 6374 2720 666c 6167 7320 2868 696e 7473  ct' flags (hints
-0000def0: 292e 0a0a 2020 2020 4966 2067 6976 656e  )...    If given
-0000df00: 2061 2075 7365 7220 616e 6420 6b6e 6f77   a user and know
-0000df10: 6e20 7468 6520 7365 6e64 6572 2c20 7765  n the sender, we
-0000df20: 2074 7279 2074 6f20 6669 6e64 2061 206d   try to find a m
-0000df30: 6174 6368 696e 6720 726f 6f6d 2e0a 2020  atching room..  
-0000df40: 2020 5468 6572 6520 6d69 6768 7420 6265    There might be
-0000df50: 2030 2c20 312c 206f 7220 6d6f 7265 206d   0, 1, or more m
-0000df60: 6174 6368 696e 6720 726f 6f6d 732e 2049  atching rooms. I
-0000df70: 6620 302c 2074 6865 6e20 6769 7665 7220  f 0, then giver 
-0000df80: 6572 726f 720a 2020 2020 616e 6420 7468  error.    and th
-0000df90: 6520 7573 6572 2073 686f 756c 6420 7275  e user should ru
-0000dfa0: 6e20 2d2d 726f 6f6d 2d69 6e76 6974 6520  n --room-invite 
-0000dfb0: 6669 7273 742e 2069 6620 3120 666f 756e  first. if 1 foun
-0000dfc0: 642c 2075 7365 2069 742e 0a20 2020 2049  d, use it..    I
-0000dfd0: 6620 6d6f 7265 2074 6861 6e20 3120 666f  f more than 1 fo
-0000dfe0: 756e 642c 206a 7573 7420 7573 6520 3120  und, just use 1 
-0000dff0: 6f66 2074 6865 6d20 6172 6269 7472 6172  of them arbitrar
-0000e000: 696c 792e 0a0a 2020 2020 5468 6520 7374  ily...    The st
-0000e010: 6570 7320 6172 653a 0a20 2020 202d 2067  eps are:.    - g
-0000e020: 6574 2061 6c6c 2072 6f6f 6d73 2077 6865  et all rooms whe
-0000e030: 7265 2073 656e 6465 7220 6973 206d 656d  re sender is mem
-0000e040: 6265 720a 2020 2020 2d20 6765 7420 616c  ber.    - get al
-0000e050: 6c20 6d65 6d62 6572 7320 746f 2074 6865  l members to the
-0000e060: 7365 2072 6f6f 6d73 0a20 2020 202d 2063  se rooms.    - c
-0000e070: 6865 636b 2069 6620 7468 6572 6520 6973  heck if there is
-0000e080: 2061 2072 6f6f 6d20 7769 7468 206a 7573   a room with jus
-0000e090: 7420 3220 6d65 6d62 6572 7320 616e 6420  t 2 members and 
-0000e0a0: 7468 656d 0a20 2020 2020 2062 6569 6e67  them.      being
-0000e0b0: 2073 656e 6465 7220 616e 6420 7265 6369   sender and reci
-0000e0c0: 7069 656e 7420 2875 7365 7220 6672 6f6d  pient (user from
-0000e0d0: 2075 7365 7273 2061 7267 290a 0a20 2020   users arg)..   
-0000e0e0: 2049 6e20 6f72 6465 7220 746f 206d 6174   In order to mat
-0000e0f0: 6368 2061 2075 7365 7220 746f 2061 2052  ch a user to a R
-0000e100: 6f6f 6d4d 656d 6265 7220 7765 2061 6c6c  oomMember we all
-0000e110: 6f77 2033 2063 686f 6963 6573 3a0a 2020  ow 3 choices:.  
-0000e120: 2020 2d20 7573 6572 5f69 643a 2070 6572    - user_id: per
-0000e130: 6665 6374 206d 6174 6368 2c20 6973 2075  fect match, is u
-0000e140: 6e69 7175 652c 2066 756c 6c20 7573 6572  nique, full user
-0000e150: 2069 642c 2065 2e67 2e20 2240 7573 6572   id, e.g. "@user
-0000e160: 3a65 7861 6d70 6c65 2e6f 7267 220a 2020  :example.org".  
-0000e170: 2020 2d20 7573 6572 5f69 6420 7769 7468    - user_id with
-0000e180: 6f75 7420 686f 6d65 7365 7276 6572 2064  out homeserver d
-0000e190: 6f6d 6169 6e3a 2070 6172 7469 616c 2075  omain: partial u
-0000e1a0: 7365 7220 6964 2c20 652e 672e 2022 4075  ser id, e.g. "@u
-0000e1b0: 7365 7222 0a20 2020 2020 2074 6869 7320  ser".      this 
-0000e1c0: 7061 7274 6961 6c20 7573 6572 2077 696c  partial user wil
-0000e1d0: 6c20 6265 2063 6f6d 706c 6574 6564 2062  l be completed b
-0000e1e0: 7920 6164 6469 6e67 2074 6865 2068 6f6d  y adding the hom
-0000e1f0: 6573 6572 7665 7220 6f66 2074 6865 0a20  eserver of the. 
-0000e200: 2020 2020 2073 656e 6465 7220 746f 2074       sender to t
-0000e210: 6865 2065 6e64 2c20 692e 652e 2061 7373  he end, i.e. ass
-0000e220: 756d 696e 6720 7468 6174 2073 656e 6465  uming that sende
-0000e230: 7220 616e 6420 7265 6365 6976 6572 2061  r and receiver a
-0000e240: 7265 206f 6e20 7468 650a 2020 2020 2020  re on the.      
-0000e250: 7361 6d65 2068 6f6d 6573 6572 7665 722e  same homeserver.
-0000e260: 0a20 2020 202d 2064 6973 706c 6179 206e  .    - display n
-0000e270: 616d 653a 2062 6520 6361 7265 6675 6c2c  ame: be careful,
-0000e280: 2064 6973 706c 6179 206e 616d 6573 2061   display names a
-0000e290: 7265 204e 4f54 2075 6e69 7175 652c 2079  re NOT unique, y
-0000e2a0: 6f75 2063 6f75 6c64 2062 650a 2020 2020  ou could be.    
-0000e2b0: 2020 6d69 7374 616b 656e 2061 6e64 2062    mistaken and b
-0000e2c0: 7920 6572 726f 7220 7365 6e64 2074 6f20  y error send to 
-0000e2d0: 7468 6520 7772 6f6e 6720 7065 7273 6f6e  the wrong person
-0000e2e0: 2e0a 2020 2020 2020 272d 2d6a 6f69 6e65  ..      '--joine
-0000e2f0: 642d 6d65 6d62 6572 7320 222a 2227 2073  d-members "*"' s
-0000e300: 686f 7773 2079 6f75 2074 6865 2064 6973  hows you the dis
-0000e310: 706c 6179 206e 616d 6573 2069 6e20 7468  play names in th
-0000e320: 6520 6d69 6464 6c65 2063 6f6c 756d 6e0a  e middle column.
-0000e330: 0a20 2020 2041 7267 756d 656e 7473 3a0a  .    Arguments:.
-0000e340: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d0a 2020      ---------.  
-0000e350: 2020 2020 2020 7573 6572 733a 206c 6973        users: lis
-0000e360: 7428 7374 7229 3a20 6c69 7374 206f 6620  t(str): list of 
-0000e370: 7573 6572 5f69 6473 0a20 2020 2020 2020  user_ids.       
-0000e380: 2020 2020 2074 7279 2074 6f20 6669 6e64       try to find
-0000e390: 2061 206d 6174 6368 696e 6720 444d 2072   a matching DM r
-0000e3a0: 6f6f 6d20 666f 7220 6561 6368 2075 7365  oom for each use
-0000e3b0: 720a 2020 2020 2020 2020 636c 6965 6e74  r.        client
-0000e3c0: 3a20 4173 796e 6343 6c69 656e 743a 2063  : AsyncClient: c
-0000e3d0: 6c69 656e 742c 2061 6c6c 6f77 7320 6173  lient, allows as
-0000e3e0: 2074 6f20 7175 6572 7920 7468 6520 7365   to query the se
-0000e3f0: 7276 6572 0a20 2020 2020 2020 2063 7265  rver.        cre
-0000e400: 6465 6e74 6961 6c73 3a20 6469 6374 3a20  dentials: dict: 
-0000e410: 616c 6c6f 7773 2074 6f20 6765 7420 7468  allows to get th
-0000e420: 6520 7573 6572 5f69 6420 6f66 2073 656e  e user_id of sen
-0000e430: 6465 720a 0a20 2020 2052 6574 7572 6e73  der..    Returns
-0000e440: 2061 206c 6973 7420 6f66 2066 6f75 6e64   a list of found
-0000e450: 2044 4d20 726f 6f6d 732e 204c 6973 7420   DM rooms. List 
-0000e460: 6d61 7920 6265 2065 6d70 7479 2069 6620  may be empty if 
-0000e470: 6e6f 206d 6174 6368 6573 2077 6572 650a  no matches were.
-0000e480: 2020 2020 666f 756e 642e 0a0a 2020 2020      found...    
-0000e490: 2222 220a 2020 2020 726f 6f6d 7320 3d20  """.    rooms = 
-0000e4a0: 5b5d 0a20 2020 2069 6620 6e6f 7420 7573  [].    if not us
-0000e4b0: 6572 733a 0a20 2020 2020 2020 2067 732e  ers:.        gs.
-0000e4c0: 6c6f 672e 6465 6275 6728 6622 526f 6f6d  log.debug(f"Room
-0000e4d0: 2873 2920 6672 6f6d 202d 2d75 7365 723a  (s) from --user:
-0000e4e0: 207b 726f 6f6d 737d 2c20 6e6f 2075 7365   {rooms}, no use
-0000e4f0: 7273 2077 6572 6520 7370 6563 6966 6965  rs were specifie
-0000e500: 642e 2229 0a20 2020 2020 2020 2072 6574  d.").        ret
-0000e510: 7572 6e20 726f 6f6d 730a 2020 2020 7365  urn rooms.    se
-0000e520: 6e64 6572 203d 2063 7265 6465 6e74 6961  nder = credentia
-0000e530: 6c73 5b22 7573 6572 5f69 6422 5d20 2023  ls["user_id"]  #
-0000e540: 2077 686f 2061 6d20 690a 2020 2020 6773   who am i.    gs
-0000e550: 2e6c 6f67 2e64 6562 7567 2866 2254 7279  .log.debug(f"Try
-0000e560: 696e 6720 746f 2067 6574 206d 656d 6265  ing to get membe
-0000e570: 7273 2066 6f72 2061 6c6c 2072 6f6f 6d73  rs for all rooms
-0000e580: 206f 6620 7365 6e64 6572 3a20 7b73 656e   of sender: {sen
-0000e590: 6465 727d 2229 0a20 2020 2072 6573 7020  der}").    resp 
-0000e5a0: 3d20 6177 6169 7420 636c 6965 6e74 2e6a  = await client.j
-0000e5b0: 6f69 6e65 645f 726f 6f6d 7328 290a 2020  oined_rooms().  
-0000e5c0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-0000e5d0: 7265 7370 2c20 4a6f 696e 6564 526f 6f6d  resp, JoinedRoom
-0000e5e0: 7345 7272 6f72 293a 0a20 2020 2020 2020  sError):.       
-0000e5f0: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
-0000e600: 2020 2020 2020 2020 2020 2022 4531 3137             "E117
-0000e610: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
-0000e620: 6622 6a6f 696e 6564 5f72 6f6f 6d73 2066  f"joined_rooms f
-0000e630: 6169 6c65 6420 7769 7468 207b 7072 6976  ailed with {priv
-0000e640: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
-0000e650: 6573 7029 297d 2e20 220a 2020 2020 2020  esp))}. ".      
-0000e660: 2020 2020 2020 224e 6f74 2061 626c 6520        "Not able 
-0000e670: 746f 2022 0a20 2020 2020 2020 2020 2020  to ".           
-0000e680: 2022 6765 7420 616c 6c20 726f 6f6d 732e   "get all rooms.
-0000e690: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
-0000e6a0: 224e 6f74 2061 626c 6520 746f 2066 696e  "Not able to fin
-0000e6b0: 6420 444d 2072 6f6f 6d73 2066 6f72 2073  d DM rooms for s
-0000e6c0: 656e 6465 7220 7b73 656e 6465 727d 2e20  ender {sender}. 
-0000e6d0: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
-0000e6e0: 4e6f 7420 6162 6c65 2074 6f20 7365 6e64  Not able to send
-0000e6f0: 2074 6f20 7265 6365 6976 6572 7320 7b75   to receivers {u
-0000e700: 7365 7273 7d2e 220a 2020 2020 2020 2020  sers}.".        
-0000e710: 290a 2020 2020 2020 2020 6773 2e65 7272  ).        gs.err
-0000e720: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
-0000e730: 2020 2020 7365 6e64 6572 726f 6f6d 7320      senderrooms 
-0000e740: 3d20 5b5d 0a20 2020 2065 6c73 653a 0a20  = [].    else:. 
-0000e750: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-0000e760: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
-0000e770: 2066 226a 6f69 6e65 645f 726f 6f6d 7320   f"joined_rooms 
-0000e780: 7375 6363 6573 7366 756c 2077 6974 6820  successful with 
-0000e790: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
-0000e7a0: 7374 7228 7265 7370 2929 7d22 0a20 2020  str(resp))}".   
-0000e7b0: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
-0000e7c0: 656e 6465 7272 6f6f 6d73 203d 2072 6573  enderrooms = res
-0000e7d0: 702e 726f 6f6d 730a 2020 2020 726f 6f6d  p.rooms.    room
-0000e7e0: 5f66 6f75 6e64 5f66 6f72 5f75 7365 7273  _found_for_users
-0000e7f0: 203d 205b 5d0a 2020 2020 666f 7220 726f   = [].    for ro
-0000e800: 6f6d 2069 6e20 7365 6e64 6572 726f 6f6d  om in senderroom
-0000e810: 733a 0a20 2020 2020 2020 2072 6573 7020  s:.        resp 
-0000e820: 3d20 6177 6169 7420 636c 6965 6e74 2e6a  = await client.j
-0000e830: 6f69 6e65 645f 6d65 6d62 6572 7328 726f  oined_members(ro
-0000e840: 6f6d 290a 2020 2020 2020 2020 6966 2069  om).        if i
-0000e850: 7369 6e73 7461 6e63 6528 7265 7370 2c20  sinstance(resp, 
-0000e860: 4a6f 696e 6564 4d65 6d62 6572 7345 7272  JoinedMembersErr
-0000e870: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-0000e880: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
-0000e890: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000e8a0: 4531 3138 3a20 220a 2020 2020 2020 2020  E118: ".        
-0000e8b0: 2020 2020 2020 2020 6622 6a6f 696e 6564          f"joined
-0000e8c0: 5f6d 656d 6265 7273 2066 6169 6c65 6420  _members failed 
-0000e8d0: 7769 7468 207b 7072 6976 6163 795f 6669  with {privacy_fi
-0000e8e0: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
-0000e8f0: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
-0000e900: 2020 2020 224e 6f74 2061 626c 6520 746f      "Not able to
-0000e910: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-0000e920: 2020 2066 2267 6574 2072 6f6f 6d20 6d65     f"get room me
-0000e930: 6d62 6572 7320 666f 7220 726f 6f6d 207b  mbers for room {
-0000e940: 726f 6f6d 7d2e 2022 0a20 2020 2020 2020  room}. ".       
-0000e950: 2020 2020 2020 2020 2066 224e 6f74 2061           f"Not a
-0000e960: 626c 6520 746f 2066 696e 6420 444d 2072  ble to find DM r
-0000e970: 6f6f 6d73 2066 6f72 2073 656e 6465 7220  ooms for sender 
-0000e980: 7b73 656e 6465 727d 2e20 220a 2020 2020  {sender}. ".    
-0000e990: 2020 2020 2020 2020 2020 2020 6622 4e6f              f"No
-0000e9a0: 7420 6162 6c65 2074 6f20 7365 6e64 2074  t able to send t
-0000e9b0: 6f20 736f 6d65 206f 6620 7468 6573 6520  o some of these 
-0000e9c0: 7265 6365 6976 6572 7320 7b75 7365 7273  receivers {users
-0000e9d0: 7d2e 220a 2020 2020 2020 2020 2020 2020  }.".            
-0000e9e0: 290a 2020 2020 2020 2020 2020 2020 6773  ).            gs
-0000e9f0: 2e65 7272 5f63 6f75 6e74 202b 3d20 310a  .err_count += 1.
-0000ea00: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000ea10: 2020 2020 2020 2020 2020 2320 7265 7370            # resp
-0000ea20: 2e72 6f6f 6d5f 6964 0a20 2020 2020 2020  .room_id.       
-0000ea30: 2020 2020 2023 2072 6573 702e 6d65 6d62       # resp.memb
-0000ea40: 6572 7320 3d20 4c69 7374 5b52 6f6f 6d4d  ers = List[RoomM
-0000ea50: 656d 6265 725d 203b 2052 6f6f 6d4d 656d  ember] ; RoomMem
-0000ea60: 6265 720a 2020 2020 2020 2020 2020 2020  ber.            
-0000ea70: 2320 6d65 6d62 6572 2e75 7365 725f 6964  # member.user_id
-0000ea80: 0a20 2020 2020 2020 2020 2020 2023 206d  .            # m
-0000ea90: 656d 6265 722e 6469 7370 6c61 795f 6e61  ember.display_na
-0000eaa0: 6d65 0a20 2020 2020 2020 2020 2020 2023  me.            #
-0000eab0: 206d 656d 6265 722e 6176 6174 6172 5f75   member.avatar_u
-0000eac0: 726c 0a20 2020 2020 2020 2020 2020 2067  rl.            g
-0000ead0: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
-0000eae0: 2020 2020 2020 2020 2020 2020 2066 226a               f"j
-0000eaf0: 6f69 6e65 645f 6d65 6d62 6572 7320 7375  oined_members su
-0000eb00: 6363 6573 7366 756c 2077 6974 6820 7b70  ccessful with {p
-0000eb10: 7269 7661 6379 5f66 696c 7465 7228 7374  rivacy_filter(st
-0000eb20: 7228 7265 7370 2929 7d22 0a20 2020 2020  r(resp))}".     
-0000eb30: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000eb40: 2020 2020 2069 6620 7265 7370 2e6d 656d       if resp.mem
-0000eb50: 6265 7273 2061 6e64 206c 656e 2872 6573  bers and len(res
-0000eb60: 702e 6d65 6d62 6572 7329 203d 3d20 323a  p.members) == 2:
-0000eb70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000eb80: 2069 6620 7265 7370 2e6d 656d 6265 7273   if resp.members
-0000eb90: 5b30 5d2e 7573 6572 5f69 6420 3d3d 2073  [0].user_id == s
-0000eba0: 656e 6465 723a 0a20 2020 2020 2020 2020  ender:.         
-0000ebb0: 2020 2020 2020 2020 2020 2023 2073 6e64             # snd
-0000ebc0: 7220 3d20 7265 7370 2e6d 656d 6265 7273  r = resp.members
-0000ebd0: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
-0000ebe0: 2020 2020 2020 2020 7263 7672 203d 2072          rcvr = r
-0000ebf0: 6573 702e 6d65 6d62 6572 735b 315d 0a20  esp.members[1]. 
-0000ec00: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000ec10: 6c69 6620 7265 7370 2e6d 656d 6265 7273  lif resp.members
-0000ec20: 5b31 5d2e 7573 6572 5f69 6420 3d3d 2073  [1].user_id == s
-0000ec30: 656e 6465 723a 0a20 2020 2020 2020 2020  ender:.         
-0000ec40: 2020 2020 2020 2020 2020 2023 2073 6e64             # snd
-0000ec50: 7220 3d20 7265 7370 2e6d 656d 6265 7273  r = resp.members
-0000ec60: 5b31 5d0a 2020 2020 2020 2020 2020 2020  [1].            
-0000ec70: 2020 2020 2020 2020 7263 7672 203d 2072          rcvr = r
-0000ec80: 6573 702e 6d65 6d62 6572 735b 305d 0a20  esp.members[0]. 
-0000ec90: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000eca0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000ecb0: 2020 2020 2020 2020 2023 2073 6e64 7220           # sndr 
-0000ecc0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
-0000ecd0: 2020 2020 2020 2020 2020 2072 6376 7220             rcvr 
-0000ece0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
-0000ecf0: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-0000ed00: 672e 6572 726f 7228 0a20 2020 2020 2020  g.error(.       
-0000ed10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ed20: 2022 4531 3139 3a20 220a 2020 2020 2020   "E119: ".      
-0000ed30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ed40: 2020 6622 5365 6e64 6572 2064 6f65 7320    f"Sender does 
-0000ed50: 6e6f 7420 6d61 7463 6820 7b70 7269 7661  not match {priva
-0000ed60: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
-0000ed70: 7370 2929 7d22 0a20 2020 2020 2020 2020  sp))}".         
-0000ed80: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0000ed90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eda0: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
-0000edb0: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
-0000edc0: 2020 2066 6f72 2075 7365 7220 696e 2075     for user in u
-0000edd0: 7365 7273 3a0a 2020 2020 2020 2020 2020  sers:.          
-0000ede0: 2020 2020 2020 2020 2020 6966 2028 0a20            if (. 
-0000edf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee00: 2020 2020 2020 2072 6376 720a 2020 2020         rcvr.    
-0000ee10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee20: 2020 2020 616e 6420 7573 6572 203d 3d20      and user == 
-0000ee30: 7263 7672 2e75 7365 725f 6964 0a20 2020  rcvr.user_id.   
-0000ee40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee50: 2020 2020 206f 7220 7368 6f72 745f 7573       or short_us
-0000ee60: 6572 5f6e 616d 655f 746f 5f75 7365 725f  er_name_to_user_
-0000ee70: 6964 2875 7365 722c 2063 7265 6465 6e74  id(user, credent
-0000ee80: 6961 6c73 290a 2020 2020 2020 2020 2020  ials).          
-0000ee90: 2020 2020 2020 2020 2020 2020 2020 3d3d                ==
-0000eea0: 2072 6376 722e 7573 6572 5f69 640a 2020   rcvr.user_id.  
-0000eeb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eec0: 2020 2020 2020 6f72 2075 7365 7220 3d3d        or user ==
-0000eed0: 2072 6376 722e 6469 7370 6c61 795f 6e61   rcvr.display_na
-0000eee0: 6d65 0a20 2020 2020 2020 2020 2020 2020  me.             
-0000eef0: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
-0000ef00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ef10: 2020 726f 6f6d 5f66 6f75 6e64 5f66 6f72    room_found_for
-0000ef20: 5f75 7365 7273 2e61 7070 656e 6428 7573  _users.append(us
-0000ef30: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
-0000ef40: 2020 2020 2020 2020 2020 2020 726f 6f6d              room
-0000ef50: 732e 6170 7065 6e64 2872 6573 702e 726f  s.append(resp.ro
-0000ef60: 6f6d 5f69 6429 0a20 2020 2066 6f72 2075  om_id).    for u
-0000ef70: 7365 7220 696e 2075 7365 7273 3a0a 2020  ser in users:.  
-0000ef80: 2020 2020 2020 6966 2075 7365 7220 6e6f        if user no
-0000ef90: 7420 696e 2072 6f6f 6d5f 666f 756e 645f  t in room_found_
-0000efa0: 666f 725f 7573 6572 733a 0a20 2020 2020  for_users:.     
-0000efb0: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
-0000efc0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-0000efd0: 2020 2020 2022 4531 3230 3a20 220a 2020       "E120: ".  
-0000efe0: 2020 2020 2020 2020 2020 2020 2020 2252                "R
-0000eff0: 6f6f 6d28 7329 2077 6572 6520 7370 6563  oom(s) were spec
-0000f000: 6966 6965 6420 666f 7220 6120 444d 2028  ified for a DM (
-0000f010: 6469 7265 6374 206d 6573 7361 6769 6e67  direct messaging
-0000f020: 2920 220a 2020 2020 2020 2020 2020 2020  ) ".            
-0000f030: 2020 2020 2273 656e 6420 6f70 6572 6174      "send operat
-0000f040: 696f 6e20 7669 6120 2d2d 726f 6f6d 2e20  ion via --room. 
-0000f050: 4275 7420 6e6f 2044 4d20 726f 6f6d 2077  But no DM room w
-0000f060: 6173 2022 0a20 2020 2020 2020 2020 2020  as ".           
-0000f070: 2020 2020 2066 2266 6f75 6e64 2066 6f72       f"found for
-0000f080: 2075 7365 7220 277b 7573 6572 7d27 2e20   user '{user}'. 
-0000f090: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0000f0a0: 2020 2254 7279 2073 6574 7469 6e67 2075    "Try setting u
-0000f0b0: 7020 6120 726f 6f6d 2066 6972 7374 2076  p a room first v
-0000f0c0: 6961 202d 2d72 6f6f 6d2d 6372 6561 7465  ia --room-create
-0000f0d0: 2061 6e64 2022 0a20 2020 2020 2020 2020   and ".         
-0000f0e0: 2020 2020 2020 2022 2d2d 726f 6f6d 2d69         "--room-i
-0000f0f0: 6e76 6974 6520 6f70 7469 6f6e 206f 7220  nvite option or 
-0000f100: 2d2d 726f 6f6d 2d64 6d2d 6372 6561 7465  --room-dm-create
-0000f110: 2e22 0a20 2020 2020 2020 2020 2020 2029  .".            )
-0000f120: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
-0000f130: 6572 725f 636f 756e 7420 2b3d 2031 0a20  err_count += 1. 
-0000f140: 2020 2072 6f6f 6d73 203d 206c 6973 7428     rooms = list(
-0000f150: 6469 6374 2e66 726f 6d6b 6579 7328 726f  dict.fromkeys(ro
-0000f160: 6f6d 7329 2920 2023 2072 656d 6f76 6520  oms))  # remove 
-0000f170: 6475 706c 6963 6174 6573 2069 6e20 6c69  duplicates in li
-0000f180: 7374 0a20 2020 2067 732e 6c6f 672e 6465  st.    gs.log.de
-0000f190: 6275 6728 6622 526f 6f6d 2873 2920 6672  bug(f"Room(s) fr
-0000f1a0: 6f6d 202d 2d75 7365 723a 207b 726f 6f6d  om --user: {room
-0000f1b0: 737d 2229 0a20 2020 2072 6574 7572 6e20  s}").    return 
-0000f1c0: 726f 6f6d 730a 0a0a 6173 796e 6320 6465  rooms...async de
-0000f1d0: 6620 6465 7465 726d 696e 655f 726f 6f6d  f determine_room
-0000f1e0: 7328 0a20 2020 2072 6f6f 6d5f 6964 3a20  s(.    room_id: 
-0000f1f0: 7374 722c 2063 6c69 656e 743a 2041 7379  str, client: Asy
-0000f200: 6e63 436c 6965 6e74 2c20 6372 6564 656e  ncClient, creden
-0000f210: 7469 616c 733a 2064 6963 740a 2920 2d3e  tials: dict.) ->
-0000f220: 206c 6973 743a 0a20 2020 2022 2222 4465   list:.    """De
-0000f230: 7465 726d 696e 6520 7468 6520 726f 6f6d  termine the room
-0000f240: 2074 6f20 7365 6e64 2074 6f2e 0a0a 2020   to send to...  
-0000f250: 2020 4172 6775 6d65 6e74 733a 0a20 2020    Arguments:.   
-0000f260: 202d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2072   ---------.    r
-0000f270: 6f6f 6d5f 6964 203a 2072 6f6f 6d20 6672  oom_id : room fr
-0000f280: 6f6d 2063 7265 6465 6e74 6961 6c73 2066  om credentials f
-0000f290: 696c 650a 0a20 2020 204c 6f6f 6b20 6174  ile..    Look at
-0000f2a0: 2072 6f6f 6d20 6672 6f6d 2063 7265 6465   room from crede
-0000f2b0: 6e74 6961 6c73 2066 696c 6520 616e 6420  ntials file and 
-0000f2c0: 6174 2072 6f6f 6d73 2066 726f 6d20 636f  at rooms from co
-0000f2d0: 6d6d 616e 6420 6c69 6e65 0a20 2020 2061  mmand line.    a
-0000f2e0: 6e64 2070 7265 7061 7265 7320 6120 6465  nd prepares a de
-0000f2f0: 6669 6e69 7465 206c 6973 7420 6f66 2072  finite list of r
-0000f300: 6f6f 6d73 2e0a 0a20 2020 204e 6577 3a20  ooms...    New: 
-0000f310: 416c 736f 206c 6f6f 6b20 6174 202d 2d75  Also look at --u
-0000f320: 7365 722e 2046 6f72 2044 4d20 2864 6972  ser. For DM (dir
-0000f330: 6563 7420 6d65 7373 6167 696e 6729 2c20  ect messaging), 
-0000f340: 6465 7374 696e 6174 696f 6e73 0a20 2020  destinations.   
-0000f350: 2061 7265 2073 7065 6369 6669 6564 2076   are specified v
-0000f360: 6961 202d 2d75 7365 722e 2046 6f72 2065  ia --user. For e
-0000f370: 7665 7279 2075 7365 7220 666f 756e 642c  very user found,
-0000f380: 2073 6565 2069 6620 7468 6572 6520 6973   see if there is
-0000f390: 2061 0a20 2020 2022 444d 2220 726f 6f6d   a.    "DM" room
-0000f3a0: 2c20 6120 726f 6f6d 2077 6974 6820 6f6e  , a room with on
-0000f3b0: 6c79 2032 206d 656d 6265 7273 2028 7365  ly 2 members (se
-0000f3c0: 6e64 6572 2061 6e64 2072 6563 6970 6965  nder and recipie
-0000f3d0: 6e74 292e 0a20 2020 2049 6620 7375 6368  nt)..    If such
-0000f3e0: 2061 2022 444d 2220 726f 6f6d 2069 7320   a "DM" room is 
-0000f3f0: 666f 756e 642c 2061 6464 2069 7420 746f  found, add it to
-0000f400: 2074 6865 2067 656e 6572 616c 2072 6f6f   the general roo
-0000f410: 6d73 206c 6973 740a 2020 2020 7468 6174  ms list.    that
-0000f420: 2069 7320 7265 7475 726e 6564 2e0a 0a20   is returned... 
-0000f430: 2020 204d 6978 696e 6720 616e 6420 6d61     Mixing and ma
-0000f440: 7463 6869 6e67 206f 6620 2d2d 726f 6f6d  tching of --room
-0000f450: 2061 6e64 202d 2d75 7365 7220 6973 2070   and --user is p
-0000f460: 6f73 7369 626c 652e 0a20 2020 202d 2d72  ossible..    --r
-0000f470: 6f6f 6d20 5231 2052 3220 2d2d 7573 6572  oom R1 R2 --user
-0000f480: 2055 3120 5532 206d 6967 6874 206c 6561   U1 U2 might lea
-0000f490: 6420 746f 2034 2072 6f6f 6d73 2069 6e20  d to 4 rooms in 
-0000f4a0: 746f 7461 6c2e 0a20 2020 2049 6620 6e6f  total..    If no
-0000f4b0: 2022 444d 2220 726f 6f6d 2069 7320 666f   "DM" room is fo
-0000f4c0: 756e 6420 7468 656e 2067 6976 6520 6572  und then give er
-0000f4d0: 726f 7220 616e 6420 7465 6c6c 2075 7365  ror and tell use
-0000f4e0: 7220 746f 2064 6f0a 2020 2020 2d2d 726f  r to do.    --ro
-0000f4f0: 6f6d 2d69 6e76 6974 6520 6669 7273 742e  om-invite first.
-0000f500: 0a0a 2020 2020 5265 7475 726e 206c 6973  ..    Return lis
-0000f510: 7420 6f66 2072 6f6f 6d73 2074 6f20 7365  t of rooms to se
-0000f520: 6e64 2074 6f2e 2052 6574 7572 6e65 6420  nd to. Returned 
-0000f530: 6c69 7374 2069 7320 6e65 7665 7220 656d  list is never em
-0000f540: 7074 792e 0a0a 2020 2020 2222 220a 2020  pty...    """.  
-0000f550: 2020 6966 206e 6f74 2067 732e 7061 2e72    if not gs.pa.r
-0000f560: 6f6f 6d20 616e 6420 6e6f 7420 6773 2e70  oom and not gs.p
-0000f570: 612e 7573 6572 3a0a 2020 2020 2020 2020  a.user:.        
-0000f580: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
-0000f590: 2020 2020 2020 2020 2020 2252 6f6f 6d20            "Room 
-0000f5a0: 6964 2077 6173 2070 726f 7669 6465 6420  id was provided 
-0000f5b0: 7669 6120 6372 6564 656e 7469 616c 7320  via credentials 
-0000f5c0: 6669 6c65 2e20 220a 2020 2020 2020 2020  file. ".        
-0000f5d0: 2020 2020 224e 6f20 726f 6f6d 7320 6769      "No rooms gi
-0000f5e0: 7665 6e20 696e 2063 6f6d 6d61 6e64 7320  ven in commands 
-0000f5f0: 6c69 6e65 2e20 220a 2020 2020 2020 2020  line. ".        
-0000f600: 2020 2020 224e 6f20 7573 6572 7320 6769      "No users gi
-0000f610: 7665 6e20 696e 2063 6f6d 6d61 6e64 206c  ven in command l
-0000f620: 696e 6520 666f 7220 444d 2072 6f6f 6d73  ine for DM rooms
-0000f630: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
-0000f640: 6627 5365 7474 696e 6720 726f 6f6d 7320  f'Setting rooms 
-0000f650: 746f 2022 7b72 6f6f 6d5f 6964 7d22 2e27  to "{room_id}".'
-0000f660: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0000f670: 2020 2072 6574 7572 6e20 5b72 6f6f 6d5f     return [room_
-0000f680: 6964 5d20 2023 206c 6973 7420 6f66 2031  id]  # list of 1
-0000f690: 0a20 2020 2072 6f6f 6d73 203d 205b 5d0a  .    rooms = [].
-0000f6a0: 2020 2020 6966 2067 732e 7061 2e72 6f6f      if gs.pa.roo
-0000f6b0: 6d3a 0a20 2020 2020 2020 2066 6f72 2072  m:.        for r
-0000f6c0: 6f6f 6d20 696e 2067 732e 7061 2e72 6f6f  oom in gs.pa.roo
-0000f6d0: 6d3a 0a20 2020 2020 2020 2020 2020 2072  m:.            r
-0000f6e0: 6f6f 6d5f 6964 203d 2072 6f6f 6d2e 7265  oom_id = room.re
-0000f6f0: 706c 6163 6528 7222 5c21 222c 2022 2122  place(r"\!", "!"
-0000f700: 2920 2023 2072 656d 6f76 6520 706f 7373  )  # remove poss
-0000f710: 6962 6c65 2065 7363 6170 650a 2020 2020  ible escape.    
-0000f720: 2020 2020 2020 2020 726f 6f6d 732e 6170          rooms.ap
-0000f730: 7065 6e64 2872 6f6f 6d5f 6964 290a 2020  pend(room_id).  
-0000f740: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-0000f750: 7567 2866 2252 6f6f 6d28 7329 2066 726f  ug(f"Room(s) fro
-0000f760: 6d20 2d2d 726f 6f6d 3a20 7b72 6f6f 6d73  m --room: {rooms
-0000f770: 7d22 290a 2020 2020 726f 6f6d 7320 2b3d  }").    rooms +=
-0000f780: 2061 7761 6974 2064 6574 6572 6d69 6e65   await determine
-0000f790: 5f64 6d5f 726f 6f6d 7328 6773 2e70 612e  _dm_rooms(gs.pa.
-0000f7a0: 7573 6572 2c20 636c 6965 6e74 2c20 6372  user, client, cr
-0000f7b0: 6564 656e 7469 616c 7329 0a20 2020 2067  edentials).    g
-0000f7c0: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
-0000f7d0: 2020 2020 2022 526f 6f6d 2873 2920 6f72       "Room(s) or
-0000f7e0: 2075 7365 7228 7329 2077 6572 6520 7072   user(s) were pr
-0000f7f0: 6f76 6964 6564 2076 6961 2063 6f6d 6d61  ovided via comma
-0000f800: 6e64 206c 696e 652e 2022 0a20 2020 2020  nd line. ".     
-0000f810: 2020 2022 4f76 6572 7772 6974 696e 6720     "Overwriting 
-0000f820: 726f 6f6d 2069 6420 6672 6f6d 2063 7265  room id from cre
-0000f830: 6465 6e74 6961 6c73 2066 696c 6520 220a  dentials file ".
-0000f840: 2020 2020 2020 2020 6627 7769 7468 2072          f'with r
-0000f850: 6f6f 6d73 2022 7b72 6f6f 6d73 7d22 2027  ooms "{rooms}" '
-0000f860: 0a20 2020 2020 2020 2022 6672 6f6d 2063  .        "from c
-0000f870: 6f6d 6d61 6e64 206c 696e 652e 220a 2020  ommand line.".  
-0000f880: 2020 290a 2020 2020 7265 7475 726e 2072    ).    return r
-0000f890: 6f6f 6d73 0a0a 0a61 7379 6e63 2064 6566  ooms...async def
-0000f8a0: 206d 6170 5f72 6f6f 6d69 6e66 6f5f 746f   map_roominfo_to
-0000f8b0: 5f72 6f6f 6d69 6428 636c 6965 6e74 3a20  _roomid(client: 
-0000f8c0: 4173 796e 6343 6c69 656e 742c 2069 6e66  AsyncClient, inf
-0000f8d0: 6f3a 2073 7472 2920 2d3e 2073 7472 3a0a  o: str) -> str:.
-0000f8e0: 2020 2020 2222 2241 7474 656d 7074 2074      """Attempt t
-0000f8f0: 6f20 636f 6e76 6572 7420 726f 6f6d 2069  o convert room i
-0000f900: 6e66 6f20 746f 2072 6f6f 6d5f 6964 2e0a  nfo to room_id..
-0000f910: 0a20 2020 2041 7267 756d 656e 7473 3a0a  .    Arguments:.
-0000f920: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d0a 2020      ---------.  
-0000f930: 2020 636c 6965 6e74 203a 206e 696f 2063    client : nio c
-0000f940: 6c69 656e 740a 2020 2020 696e 666f 203a  lient.    info :
-0000f950: 2073 7472 0a20 2020 2020 2020 2063 616e   str.        can
-0000f960: 2062 6520 6120 6361 6e6f 6e69 6361 6c20   be a canonical 
-0000f970: 616c 6961 7320 696e 2074 6865 2066 6f72  alias in the for
-0000f980: 6d20 6f66 2027 2373 6f6d 6552 6f6f 6d41  m of '#someRoomA
-0000f990: 6c69 6173 3a65 7861 6d70 6c65 2e63 6f6d  lias:example.com
-0000f9a0: 270a 2020 2020 2020 2020 6361 6e20 6265  '.        can be
-0000f9b0: 2061 2063 616e 6f6e 6963 616c 2072 6f6f   a canonical roo
-0000f9c0: 6d5f 6964 2069 6e20 7468 6520 666f 726d  m_id in the form
-0000f9d0: 206f 6620 2721 736f 6d65 526f 6f6d 4964   of '!someRoomId
-0000f9e0: 3a65 7861 6d70 6c65 2e63 6f6d 270a 2020  :example.com'.  
-0000f9f0: 2020 2020 2020 6361 6e20 6265 2061 2073        can be a s
-0000fa00: 686f 7274 2061 6c69 6173 2069 6e20 7468  hort alias in th
-0000fa10: 6520 666f 726d 206f 6620 2773 6f6d 6552  e form of 'someR
-0000fa20: 6f6f 6d41 6c69 6173 270a 2020 2020 2020  oomAlias'.      
-0000fa30: 2020 6361 6e20 6265 2061 2073 686f 7274    can be a short
-0000fa40: 2061 6c69 6173 2069 6e20 7468 6520 666f   alias in the fo
-0000fa50: 726d 206f 6620 2723 736f 6d65 526f 6f6d  rm of '#someRoom
-0000fa60: 416c 6961 7327 0a20 2020 2020 2020 2063  Alias'.        c
-0000fa70: 616e 2062 6520 6120 7368 6f72 7420 726f  an be a short ro
-0000fa80: 6f6d 2069 6420 696e 2074 6865 2066 6f72  om id in the for
-0000fa90: 6d20 6f66 2027 2173 6f6d 6552 6f6f 6d49  m of '!someRoomI
-0000faa0: 6427 0a0a 2020 2020 5265 7475 726e 2063  d'..    Return c
-0000fab0: 6f72 7265 7370 6f6e 6469 6e67 2066 756c  orresponding ful
-0000fac0: 6c20 726f 6f6d 5f69 6420 2821 6964 3a73  l room_id (!id:s
-0000fad0: 616d 706c 652e 636f 6d29 206f 7220 6f72  ample.com) or or
-0000fae0: 2072 6169 7365 7320 6578 6365 7074 696f   raises exceptio
-0000faf0: 6e2e 0a0a 2020 2020 2222 220a 2020 2020  n...    """.    
-0000fb00: 7269 203d 2069 6e66 6f2e 7374 7269 7028  ri = info.strip(
-0000fb10: 290a 2020 2020 7269 203d 2072 692e 7265  ).    ri = ri.re
-0000fb20: 706c 6163 6528 7222 5c21 222c 2022 2122  place(r"\!", "!"
-0000fb30: 2920 2023 2072 656d 6f76 6520 706f 7373  )  # remove poss
-0000fb40: 6962 6c65 2065 7363 6170 650a 2020 2020  ible escape.    
-0000fb50: 6966 2028 0a20 2020 2020 2020 2072 6920  if (.        ri 
-0000fb60: 696e 2028 4e6f 6e65 2c20 2222 2c20 2221  in (None, "", "!
-0000fb70: 222c 2022 2322 290a 2020 2020 2020 2020  ", "#").        
-0000fb80: 6f72 2072 692e 7374 6172 7473 7769 7468  or ri.startswith
-0000fb90: 2822 3a22 290a 2020 2020 2020 2020 6f72  (":").        or
-0000fba0: 2072 692e 636f 756e 7428 223a 2229 203e   ri.count(":") >
-0000fbb0: 2031 0a20 2020 2020 2020 206f 7220 7269   1.        or ri
-0000fbc0: 2e73 7461 7274 7377 6974 6828 2240 2229  .startswith("@")
-0000fbd0: 0a20 2020 2020 2020 206f 7220 2223 2220  .        or "#" 
-0000fbe0: 696e 2072 695b 313a 5d0a 2020 2020 2020  in ri[1:].      
-0000fbf0: 2020 6f72 2061 6e79 2865 6c65 6d20 696e    or any(elem in
-0000fc00: 2072 6920 666f 7220 656c 656d 2069 6e20   ri for elem in 
-0000fc10: 225b 5d7b 7d20 2229 2020 2320 646f 6573  "[]{} ")  # does
-0000fc20: 2069 7420 636f 6e74 6169 6e20 6261 6420   it contain bad 
-0000fc30: 6368 6172 733f 0a20 2020 2020 2020 206f  chars?.        o
-0000fc40: 7220 280a 2020 2020 2020 2020 2020 2020  r (.            
-0000fc50: 6e6f 7420 7269 2e73 7461 7274 7377 6974  not ri.startswit
-0000fc60: 6828 2221 2229 2061 6e64 206e 6f74 2072  h("!") and not r
-0000fc70: 692e 7374 6172 7473 7769 7468 2822 2322  i.startswith("#"
-0000fc80: 2920 616e 6420 223a 2220 696e 2072 690a  ) and ":" in ri.
-0000fc90: 2020 2020 2020 2020 2920 2023 2061 6c69          )  # ali
-0000fca0: 6173 3a73 616d 706c 652e 636f 6d0a 2020  as:sample.com.  
-0000fcb0: 2020 293a 0a20 2020 2020 2020 2065 7272    ):.        err
-0000fcc0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-0000fcd0: 2022 4531 3231 3a20 220a 2020 2020 2020   "E121: ".      
-0000fce0: 2020 2020 2020 6622 496e 7661 6c69 6420        f"Invalid 
-0000fcf0: 726f 6f6d 2073 7065 6369 6669 6361 7469  room specificati
-0000fd00: 6f6e 2e20 277b 696e 666f 7d27 2028 7b72  on. '{info}' ({r
-0000fd10: 697d 2920 6973 206e 6569 7468 6572 2022  i}) is neither "
-0000fd20: 0a20 2020 2020 2020 2020 2020 2022 6120  .            "a 
-0000fd30: 7661 6c69 6420 726f 6f6d 2069 6420 6e6f  valid room id no
-0000fd40: 7220 6120 7661 6c69 6420 726f 6f6d 2061  r a valid room a
-0000fd50: 6c69 6173 2e22 0a20 2020 2020 2020 2029  lias.".        )
-0000fd60: 0a20 2020 2020 2020 2072 6169 7365 204d  .        raise M
-0000fd70: 6174 7269 7843 6f6d 6d61 6e64 6572 4572  atrixCommanderEr
-0000fd80: 726f 7228 6572 7229 2066 726f 6d20 4e6f  ror(err) from No
-0000fd90: 6e65 0a20 2020 2069 6620 6e6f 7420 7269  ne.    if not ri
-0000fda0: 2e73 7461 7274 7377 6974 6828 2221 2229  .startswith("!")
-0000fdb0: 3a0a 2020 2020 2020 2020 2320 2773 6f6d  :.        # 'som
-0000fdc0: 6552 6f6f 6d41 6c69 6173 2720 6f72 2027  eRoomAlias' or '
-0000fdd0: 2373 6f6d 6552 6f6f 6d41 6c69 6173 2720  #someRoomAlias' 
-0000fde0: 6f72 2027 2373 6f6d 6552 6f6f 6d41 6c69  or '#someRoomAli
-0000fdf0: 6173 3a73 616d 706c 652e 636f 6d27 0a20  as:sample.com'. 
-0000fe00: 2020 2020 2020 2069 6620 223a 2220 6e6f         if ":" no
-0000fe10: 7420 696e 2072 693a 2020 2320 2773 6f6d  t in ri:  # 'som
-0000fe20: 6552 6f6f 6d41 6c69 6173 2720 6f72 2027  eRoomAlias' or '
-0000fe30: 2373 6f6d 6552 6f6f 6d41 6c69 6173 270a  #someRoomAlias'.
-0000fe40: 2020 2020 2020 2020 2020 2020 7269 203d              ri =
-0000fe50: 2073 686f 7274 5f72 6f6f 6d5f 616c 6961   short_room_alia
-0000fe60: 735f 746f 5f72 6f6f 6d5f 616c 6961 7328  s_to_room_alias(
-0000fe70: 7269 2c20 6773 2e63 7265 6465 6e74 6961  ri, gs.credentia
-0000fe80: 6c73 290a 2020 2020 2020 2020 7269 203d  ls).        ri =
-0000fe90: 2061 7761 6974 206d 6170 5f72 6f6f 6d61   await map_rooma
-0000fea0: 6c69 6173 5f74 6f5f 726f 6f6d 6964 2863  lias_to_roomid(c
-0000feb0: 6c69 656e 742c 2072 6929 0a20 2020 2020  lient, ri).     
-0000fec0: 2020 2072 6574 7572 6e20 7269 0a20 2020     return ri.   
-0000fed0: 2069 6620 223a 2220 6e6f 7420 696e 2072   if ":" not in r
-0000fee0: 693a 0a20 2020 2020 2020 2023 2027 2173  i:.        # '!s
-0000fef0: 6f6d 6552 6f6f 6d49 6427 0a20 2020 2020  omeRoomId'.     
-0000ff00: 2020 2072 6920 3d20 7269 202b 2022 3a22     ri = ri + ":"
-0000ff10: 202b 2064 6566 6175 6c74 5f68 6f6d 6573   + default_homes
-0000ff20: 6572 7665 7228 6773 2e63 7265 6465 6e74  erver(gs.credent
-0000ff30: 6961 6c73 290a 2020 2020 7265 7475 726e  ials).    return
-0000ff40: 2072 690a 0a0a 6173 796e 6320 6465 6620   ri...async def 
-0000ff50: 6d61 705f 726f 6f6d 616c 6961 735f 746f  map_roomalias_to
-0000ff60: 5f72 6f6f 6d69 6428 636c 6965 6e74 2c20  _roomid(client, 
-0000ff70: 616c 6961 7329 202d 3e20 7374 723a 0a20  alias) -> str:. 
-0000ff80: 2020 2022 2222 4174 7465 6d70 7420 746f     """Attempt to
-0000ff90: 2063 6f6e 7665 7274 2072 6f6f 6d20 616c   convert room al
-0000ffa0: 6961 7320 746f 2072 6f6f 6d5f 6964 2e0a  ias to room_id..
-0000ffb0: 0a20 2020 2041 7267 756d 656e 7473 3a0a  .    Arguments:.
-0000ffc0: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d0a 2020      ---------.  
-0000ffd0: 2020 636c 6965 6e74 203a 206e 696f 2063    client : nio c
-0000ffe0: 6c69 656e 740a 2020 2020 616c 6961 7320  lient.    alias 
-0000fff0: 3a20 6361 6e20 6265 2061 6e20 616c 6961  : can be an alia
-00010000: 7320 696e 2074 6865 2066 6f72 6d20 6f66  s in the form of
-00010010: 2027 2373 6f6d 6552 6f6f 6d41 6c69 6173   '#someRoomAlias
-00010020: 3a65 7861 6d70 6c65 2e63 6f6d 270a 2020  :example.com'.  
-00010030: 2020 2020 2020 6361 6e20 616c 736f 2062        can also b
-00010040: 6520 6120 726f 6f6d 5f69 6420 696e 2074  e a room_id in t
-00010050: 6865 2066 6f72 6d20 6f66 2027 2173 6f6d  he form of '!som
-00010060: 6552 6f6f 6d49 643a 6578 616d 706c 652e  eRoomId:example.
-00010070: 636f 6d27 0a0a 2020 2020 726f 6f6d 5f69  com'..    room_i
-00010080: 6420 3a20 726f 6f6d 2066 726f 6d20 6372  d : room from cr
-00010090: 6564 656e 7469 616c 7320 6669 6c65 0a0a  edentials file..
-000100a0: 2020 2020 4966 2061 6e20 616c 6961 7320      If an alias 
-000100b0: 7472 7920 746f 2067 6574 2074 6865 2063  try to get the c
-000100c0: 6f72 7265 7370 6f6e 6469 6e67 2072 6f6f  orresponding roo
-000100d0: 6d5f 6964 2e0a 2020 2020 4966 2061 6e79  m_id..    If any
-000100e0: 7468 696e 6720 6661 696c 7320 6974 2072  thing fails it r
-000100f0: 6574 7572 6e73 2074 6865 206f 7269 6769  eturns the origi
-00010100: 6e61 6c20 696e 7075 742e 0a0a 2020 2020  nal input...    
-00010110: 5265 7475 726e 2063 6f72 7265 7370 6f6e  Return correspon
-00010120: 6469 6e67 2072 6f6f 6d5f 6964 206f 7220  ding room_id or 
-00010130: 6f6e 2066 6169 6c75 7265 2074 6865 206f  on failure the o
-00010140: 7269 6769 6e61 6c20 616c 6961 732e 0a0a  riginal alias...
-00010150: 2020 2020 2222 220a 2020 2020 7265 7420      """.    ret 
-00010160: 3d20 616c 6961 730a 2020 2020 6966 2069  = alias.    if i
-00010170: 735f 726f 6f6d 5f61 6c69 6173 2861 6c69  s_room_alias(ali
-00010180: 6173 293a 0a20 2020 2020 2020 2072 6573  as):.        res
-00010190: 7020 3d20 6177 6169 7420 636c 6965 6e74  p = await client
-000101a0: 2e72 6f6f 6d5f 7265 736f 6c76 655f 616c  .room_resolve_al
-000101b0: 6961 7328 616c 6961 7329 0a20 2020 2020  ias(alias).     
-000101c0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-000101d0: 2872 6573 702c 2052 6f6f 6d52 6573 6f6c  (resp, RoomResol
-000101e0: 7665 416c 6961 7345 7272 6f72 293a 0a20  veAliasError):. 
-000101f0: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-00010200: 672e 6572 726f 7228 0a20 2020 2020 2020  g.error(.       
-00010210: 2020 2020 2020 2020 2022 4531 3232 3a20           "E122: 
-00010220: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00010230: 2020 6622 726f 6f6d 5f72 6573 6f6c 7665    f"room_resolve
-00010240: 5f61 6c69 6173 2066 6f72 2061 6c69 6173  _alias for alias
-00010250: 207b 616c 6961 737d 2066 6169 6c65 6420   {alias} failed 
-00010260: 7769 7468 2022 0a20 2020 2020 2020 2020  with ".         
-00010270: 2020 2020 2020 2066 227b 7072 6976 6163         f"{privac
-00010280: 795f 6669 6c74 6572 2873 7472 2872 6573  y_filter(str(res
-00010290: 7029 297d 2e20 220a 2020 2020 2020 2020  p))}. ".        
-000102a0: 2020 2020 2020 2020 6622 5472 7969 6e67          f"Trying
-000102b0: 206f 7065 7261 7469 6f6e 2077 6974 6820   operation with 
-000102c0: 696e 7075 7420 7b61 6c69 6173 7d20 616e  input {alias} an
-000102d0: 7977 6179 2e20 4d69 6768 7420 6661 696c  yway. Might fail
-000102e0: 2e22 0a20 2020 2020 2020 2020 2020 2029  .".            )
-000102f0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
-00010300: 6572 725f 636f 756e 7420 2b3d 2031 0a20  err_count += 1. 
-00010310: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00010320: 2020 2020 2020 2020 2072 6574 203d 2072           ret = r
-00010330: 6573 702e 726f 6f6d 5f69 640a 2020 2020  esp.room_id.    
-00010340: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-00010350: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
-00010360: 2020 2020 2020 6627 4d61 7070 6564 2072        f'Mapped r
-00010370: 6f6f 6d20 616c 6961 7320 227b 616c 6961  oom alias "{alia
-00010380: 737d 2220 746f 2072 6f6f 6d20 6964 2022  s}" to room id "
-00010390: 7b72 6574 7d22 2e20 270a 2020 2020 2020  {ret}". '.      
-000103a0: 2020 2020 2020 2020 2020 6622 287b 7265            f"({re
-000103b0: 7370 2e72 6f6f 6d5f 616c 6961 737d 2c20  sp.room_alias}, 
-000103c0: 7b72 6573 702e 726f 6f6d 5f69 647d 292e  {resp.room_id}).
-000103d0: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-000103e0: 2020 2020 7265 7475 726e 2072 6574 0a0a      return ret..
-000103f0: 0a64 6566 2064 6566 6175 6c74 5f68 6f6d  .def default_hom
-00010400: 6573 6572 7665 7228 6372 6564 656e 7469  eserver(credenti
-00010410: 616c 733a 2064 6963 7429 3a0a 2020 2020  als: dict):.    
-00010420: 2222 2247 6574 2074 6865 2064 6566 6175  """Get the defau
-00010430: 6c74 2068 6f6d 6573 6572 7665 7220 2864  lt homeserver (d
-00010440: 6f6d 6169 6e29 2066 726f 6d20 7468 6520  omain) from the 
-00010450: 6372 6564 656e 7469 616c 7320 6669 6c65  credentials file
-00010460: 2e0a 2020 2020 5573 6520 7468 6520 7573  ..    Use the us
-00010470: 6572 5f69 642c 206e 6f74 2074 6865 2072  er_id, not the r
-00010480: 6f6f 6d5f 6964 2e20 5468 6520 726f 6f6d  oom_id. The room
-00010490: 5f69 6420 636f 756c 6420 6265 206f 6e20  _id could be on 
-000104a0: 610a 2020 2020 6469 6666 6572 656e 7420  a.    different 
-000104b0: 7365 7276 6572 206f 776e 6564 2062 7920  server owned by 
-000104c0: 736f 6d65 6f6e 6520 656c 7365 2e20 7573  someone else. us
-000104d0: 6572 5f69 6420 6d61 6b65 7320 6d6f 7265  er_id makes more
-000104e0: 2073 656e 7365 2e0a 2020 2020 2222 220a   sense..    """.
-000104f0: 2020 2020 7573 6572 203d 2063 7265 6465      user = crede
-00010500: 6e74 6961 6c73 5b22 7573 6572 5f69 6422  ntials["user_id"
-00010510: 5d20 2023 2077 686f 2061 6d20 690a 2020  ]  # who am i.  
-00010520: 2020 686f 6d65 7365 7276 6572 203d 2075    homeserver = u
-00010530: 7365 722e 7061 7274 6974 696f 6e28 223a  ser.partition(":
-00010540: 2229 5b32 5d0a 2020 2020 7265 7475 726e  ")[2].    return
-00010550: 2068 6f6d 6573 6572 7665 7220 2023 206d   homeserver  # m
-00010560: 6174 7269 782e 6578 616d 706c 652e 636f  atrix.example.co
-00010570: 6d0a 0a0a 6465 6620 7368 6f72 745f 726f  m...def short_ro
-00010580: 6f6d 5f61 6c69 6173 5f74 6f5f 726f 6f6d  om_alias_to_room
-00010590: 5f61 6c69 6173 2873 686f 7274 5f72 6f6f  _alias(short_roo
-000105a0: 6d5f 616c 6961 733a 2073 7472 2c20 6372  m_alias: str, cr
-000105b0: 6564 656e 7469 616c 733a 2064 6963 7429  edentials: dict)
-000105c0: 3a0a 2020 2020 2222 2243 6f6e 7665 7274  :.    """Convert
-000105d0: 2027 536f 6d65 526f 6f6d 416c 6961 7327   'SomeRoomAlias'
-000105e0: 2074 6f20 2727 2353 6f6d 6554 6f6f 6d41   to ''#SomeToomA
-000105f0: 6c69 6173 3a6d 6174 7269 782e 6578 616d  lias:matrix.exam
-00010600: 706c 652e 636f 6d27 2e0a 2020 2020 436f  ple.com'..    Co
-00010610: 6e76 6572 7473 2073 686f 7274 2063 616e  nverts short can
-00010620: 6f6e 6963 616c 206c 6f63 616c 2072 6f6f  onical local roo
-00010630: 6d20 616c 6961 7320 746f 2066 756c 6c20  m alias to full 
-00010640: 726f 6f6d 2061 6c69 6173 2e0a 2020 2020  room alias..    
-00010650: 2222 220a 2020 2020 6966 2073 686f 7274  """.    if short
-00010660: 5f72 6f6f 6d5f 616c 6961 7320 696e 2028  _room_alias in (
-00010670: 4e6f 6e65 2c20 2222 293a 0a20 2020 2020  None, ""):.     
-00010680: 2020 2065 7272 203d 2022 4531 3234 3a20     err = "E124: 
-00010690: 2220 2249 6e76 616c 6964 2072 6f6f 6d20  " "Invalid room 
-000106a0: 616c 6961 732e 2041 6c69 6173 2069 7320  alias. Alias is 
-000106b0: 6e6f 6e65 206f 7220 656d 7074 792e 220a  none or empty.".
-000106c0: 2020 2020 2020 2020 7261 6973 6520 4d61          raise Ma
-000106d0: 7472 6978 436f 6d6d 616e 6465 7245 7272  trixCommanderErr
-000106e0: 6f72 2865 7272 2920 6672 6f6d 204e 6f6e  or(err) from Non
-000106f0: 650a 2020 2020 6966 2073 686f 7274 5f72  e.    if short_r
-00010700: 6f6f 6d5f 616c 6961 735b 305d 203d 3d20  oom_alias[0] == 
-00010710: 2223 223a 0a20 2020 2020 2020 2072 6574  "#":.        ret
-00010720: 203d 2073 686f 7274 5f72 6f6f 6d5f 616c   = short_room_al
-00010730: 6961 7320 2b20 223a 2220 2b20 6465 6661  ias + ":" + defa
-00010740: 756c 745f 686f 6d65 7365 7276 6572 2863  ult_homeserver(c
-00010750: 7265 6465 6e74 6961 6c73 290a 2020 2020  redentials).    
-00010760: 656c 7365 3a0a 2020 2020 2020 2020 7265  else:.        re
-00010770: 7420 3d20 2223 2220 2b20 7368 6f72 745f  t = "#" + short_
-00010780: 726f 6f6d 5f61 6c69 6173 202b 2022 3a22  room_alias + ":"
-00010790: 202b 2064 6566 6175 6c74 5f68 6f6d 6573   + default_homes
-000107a0: 6572 7665 7228 6372 6564 656e 7469 616c  erver(credential
-000107b0: 7329 0a20 2020 2072 6574 7572 6e20 7265  s).    return re
-000107c0: 740a 0a0a 6465 6620 726f 6f6d 5f61 6c69  t...def room_ali
-000107d0: 6173 5f74 6f5f 7368 6f72 745f 726f 6f6d  as_to_short_room
-000107e0: 5f61 6c69 6173 2872 6f6f 6d5f 616c 6961  _alias(room_alia
-000107f0: 733a 2073 7472 2c20 6372 6564 656e 7469  s: str, credenti
-00010800: 616c 733a 2064 6963 7429 3a0a 2020 2020  als: dict):.    
-00010810: 2222 2243 6f6e 7665 7274 2027 2353 6f6d  """Convert '#Som
-00010820: 6554 6f6f 6d41 6c69 6173 3a6d 6174 7269  eToomAlias:matri
-00010830: 782e 6578 616d 706c 652e 636f 6d27 2074  x.example.com' t
-00010840: 6f20 2753 6f6d 6552 6f6f 6d41 6c69 6173  o 'SomeRoomAlias
-00010850: 272e 0a20 2020 2043 6f6e 7665 7274 7320  '..    Converts 
-00010860: 6675 6c6c 2072 6f6f 6d20 616c 6961 7320  full room alias 
-00010870: 746f 2073 686f 7274 2063 616e 6f6e 6963  to short canonic
-00010880: 616c 206c 6f63 616c 2072 6f6f 6d20 616c  al local room al
-00010890: 6961 732e 0a20 2020 2022 2222 0a20 2020  ias..    """.   
-000108a0: 2072 6574 7572 6e20 726f 6f6d 5f61 6c69   return room_ali
-000108b0: 6173 2e73 706c 6974 2822 3a22 295b 305d  as.split(":")[0]
-000108c0: 5b31 3a5d 0a0a 0a64 6566 2075 7365 725f  [1:]...def user_
-000108d0: 6964 5f74 6f5f 7368 6f72 745f 7573 6572  id_to_short_user
-000108e0: 5f6e 616d 6528 7573 6572 5f69 643a 2073  _name(user_id: s
-000108f0: 7472 293a 0a20 2020 2022 2222 436f 6e76  tr):.    """Conv
-00010900: 6572 7420 2740 736f 6d65 7573 6572 3a6d  ert '@someuser:m
-00010910: 6174 7269 782e 6578 616d 706c 652e 636f  atrix.example.co
-00010920: 6d27 2074 6f20 2773 6f6d 6575 7365 7227  m' to 'someuser'
-00010930: 2e0a 2020 2020 436f 6e76 6572 7420 6675  ..    Convert fu
-00010940: 6c6c 2075 7365 725f 6964 2074 6f20 7573  ll user_id to us
-00010950: 6572 206e 6963 6b20 6e61 6d65 2e0a 2020  er nick name..  
-00010960: 2020 2222 220a 2020 2020 7265 7475 726e    """.    return
-00010970: 2075 7365 725f 6964 2e73 706c 6974 2822   user_id.split("
-00010980: 3a22 295b 305d 5b31 3a5d 0a0a 0a64 6566  :")[0][1:]...def
-00010990: 2073 686f 7274 5f75 7365 725f 6e61 6d65   short_user_name
-000109a0: 5f74 6f5f 7573 6572 5f69 6428 7368 6f72  _to_user_id(shor
-000109b0: 745f 7573 6572 3a20 7374 722c 2063 7265  t_user: str, cre
-000109c0: 6465 6e74 6961 6c73 3a20 6469 6374 293a  dentials: dict):
-000109d0: 0a20 2020 2022 2222 436f 6e76 6572 7420  .    """Convert 
-000109e0: 2773 6f6d 6575 7365 7227 2074 6f20 2740  'someuser' to '@
-000109f0: 736f 6d65 7573 6572 3a6d 6174 7269 782e  someuser:matrix.
-00010a00: 6578 616d 706c 652e 636f 6d27 2e0a 2020  example.com'..  
-00010a10: 2020 436f 6e76 6572 7420 7573 6572 206e    Convert user n
-00010a20: 6963 6b20 6e61 6d65 2074 6f20 6675 6c6c  ick name to full
-00010a30: 2075 7365 725f 6964 2e0a 2020 2020 2222   user_id..    ""
-00010a40: 220a 2020 2020 7265 7475 726e 2022 4022  ".    return "@"
-00010a50: 202b 2073 686f 7274 5f75 7365 7220 2b20   + short_user + 
-00010a60: 223a 2220 2b20 6465 6661 756c 745f 686f  ":" + default_ho
-00010a70: 6d65 7365 7276 6572 2863 7265 6465 6e74  meserver(credent
-00010a80: 6961 6c73 290a 0a0a 6465 6620 6973 5f72  ials)...def is_r
-00010a90: 6f6f 6d5f 616c 6961 7328 726f 6f6d 5f69  oom_alias(room_i
-00010aa0: 643a 2073 7472 2920 2d3e 2062 6f6f 6c3a  d: str) -> bool:
-00010ab0: 0a20 2020 2022 2222 4465 7465 726d 696e  .    """Determin
-00010ac0: 6520 6966 2072 6f6f 6d20 6964 656e 7469  e if room identi
-00010ad0: 6669 6572 2069 7320 6120 726f 6f6d 2061  fier is a room a
-00010ae0: 6c69 6173 2e0a 0a20 2020 2052 6f6f 6d20  lias...    Room 
-00010af0: 616c 6961 7365 7320 6172 6520 6f66 2073  aliases are of s
-00010b00: 796e 7461 783a 2023 736f 6d65 616c 6961  yntax: #somealia
-00010b10: 733a 736f 6d65 7365 7276 6572 0a20 2020  s:someserver.   
-00010b20: 2054 6869 7320 6973 206e 6f74 2061 6e20   This is not an 
-00010b30: 6578 6861 7573 7469 7665 2063 6865 636b  exhaustive check
-00010b40: 210a 0a20 2020 2022 2222 0a20 2020 2069  !..    """.    i
-00010b50: 6620 280a 2020 2020 2020 2020 726f 6f6d  f (.        room
-00010b60: 5f69 640a 2020 2020 2020 2020 616e 6420  _id.        and 
-00010b70: 6c65 6e28 726f 6f6d 5f69 6429 203e 2033  len(room_id) > 3
-00010b80: 0a20 2020 2020 2020 2061 6e64 2028 726f  .        and (ro
-00010b90: 6f6d 5f69 645b 305d 203d 3d20 2223 2229  om_id[0] == "#")
-00010ba0: 0a20 2020 2020 2020 2061 6e64 2028 2223  .        and ("#
-00010bb0: 2220 6e6f 7420 696e 2072 6f6f 6d5f 6964  " not in room_id
-00010bc0: 5b31 3a5d 290a 2020 2020 2020 2020 616e  [1:]).        an
-00010bd0: 6420 2822 3a22 2069 6e20 726f 6f6d 5f69  d (":" in room_i
-00010be0: 6429 0a20 2020 2020 2020 2061 6e64 2072  d).        and r
-00010bf0: 6f6f 6d5f 6964 2e63 6f75 6e74 2822 3a22  oom_id.count(":"
-00010c00: 2920 3d3d 2031 0a20 2020 2020 2020 2061  ) == 1.        a
-00010c10: 6e64 2028 2220 2220 6e6f 7420 696e 2072  nd (" " not in r
-00010c20: 6f6f 6d5f 6964 290a 2020 2020 2020 2020  oom_id).        
-00010c30: 616e 6420 6e6f 7420 616e 7928 656c 656d  and not any(elem
-00010c40: 2069 6e20 726f 6f6d 5f69 6420 666f 7220   in room_id for 
-00010c50: 656c 656d 2069 6e20 225b 5d7b 7d20 2229  elem in "[]{} ")
-00010c60: 2020 2320 636f 6e74 6169 6e73 2062 6164    # contains bad
-00010c70: 2063 6861 7273 3f0a 2020 2020 293a 0a20   chars?.    ):. 
-00010c80: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
-00010c90: 7565 0a20 2020 2065 6c73 653a 0a20 2020  ue.    else:.   
-00010ca0: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
-00010cb0: 650a 0a0a 6465 6620 6973 5f72 6f6f 6d5f  e...def is_room_
-00010cc0: 6964 2872 6f6f 6d5f 6964 3a20 7374 7229  id(room_id: str)
-00010cd0: 202d 3e20 626f 6f6c 3a0a 2020 2020 2222   -> bool:.    ""
-00010ce0: 2244 6574 6572 6d69 6e65 2069 6620 726f  "Determine if ro
-00010cf0: 6f6d 2069 6465 6e74 6966 6965 7220 6973  om identifier is
-00010d00: 2061 2076 616c 6964 2072 6f6f 6d20 6964   a valid room id
-00010d10: 2e0a 0a20 2020 2052 6f6f 6d20 6964 7320  ...    Room ids 
-00010d20: 6172 6520 6f66 2073 796e 7461 783a 2021  are of syntax: !
-00010d30: 736f 6d65 616c 6961 733a 736f 6d65 7365  somealias:somese
-00010d40: 7276 6572 0a20 2020 2054 6869 7320 6973  rver.    This is
-00010d50: 206e 6f74 2061 6e20 6578 6861 7573 7469   not an exhausti
-00010d60: 7665 2063 6865 636b 210a 0a20 2020 2022  ve check!..    "
-00010d70: 2222 0a20 2020 2069 6620 280a 2020 2020  "".    if (.    
-00010d80: 2020 2020 726f 6f6d 5f69 640a 2020 2020      room_id.    
-00010d90: 2020 2020 616e 6420 6c65 6e28 726f 6f6d      and len(room
-00010da0: 5f69 6429 203e 2033 0a20 2020 2020 2020  _id) > 3.       
-00010db0: 2061 6e64 2028 726f 6f6d 5f69 645b 305d   and (room_id[0]
-00010dc0: 203d 3d20 2221 2229 0a20 2020 2020 2020   == "!").       
-00010dd0: 2061 6e64 2028 2223 2220 6e6f 7420 696e   and ("#" not in
-00010de0: 2072 6f6f 6d5f 6964 290a 2020 2020 2020   room_id).      
-00010df0: 2020 616e 6420 2822 3a22 2069 6e20 726f    and (":" in ro
-00010e00: 6f6d 5f69 6429 0a20 2020 2020 2020 2061  om_id).        a
-00010e10: 6e64 2072 6f6f 6d5f 6964 2e63 6f75 6e74  nd room_id.count
-00010e20: 2822 3a22 2920 3d3d 2031 0a20 2020 2020  (":") == 1.     
-00010e30: 2020 2061 6e64 2028 2220 2220 6e6f 7420     and (" " not 
-00010e40: 696e 2072 6f6f 6d5f 6964 290a 2020 2020  in room_id).    
-00010e50: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-00010e60: 6e20 5472 7565 0a20 2020 2065 6c73 653a  n True.    else:
-00010e70: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00010e80: 4661 6c73 650a 0a0a 6465 6620 6973 5f72  False...def is_r
-00010e90: 6f6f 6d28 726f 6f6d 5f69 643a 2073 7472  oom(room_id: str
-00010ea0: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2022  ) -> bool:.    "
-00010eb0: 2222 4465 7465 726d 696e 6520 6966 2072  ""Determine if r
-00010ec0: 6f6f 6d20 6964 2069 7320 6120 7661 6c69  oom id is a vali
-00010ed0: 6420 726f 6f6d 2069 6420 6f72 2061 2076  d room id or a v
-00010ee0: 616c 6964 2072 6f6f 6d20 616c 6961 732e  alid room alias.
-00010ef0: 0a0a 2020 2020 5468 6973 2069 7320 6e6f  ..    This is no
-00010f00: 7420 616e 2065 7868 6175 7374 6976 6520  t an exhaustive 
-00010f10: 6368 6563 6b21 0a0a 2020 2020 2222 220a  check!..    """.
-00010f20: 2020 2020 7265 7475 726e 2069 735f 726f      return is_ro
-00010f30: 6f6d 5f69 6428 726f 6f6d 5f69 6429 206f  om_id(room_id) o
-00010f40: 7220 6973 5f72 6f6f 6d5f 616c 6961 7328  r is_room_alias(
-00010f50: 726f 6f6d 5f69 6429 0a0a 0a64 6566 2069  room_id)...def i
-00010f60: 735f 7368 6f72 745f 726f 6f6d 5f61 6c69  s_short_room_ali
-00010f70: 6173 2872 6f6f 6d5f 6964 3a20 7374 7229  as(room_id: str)
-00010f80: 202d 3e20 626f 6f6c 3a0a 2020 2020 2222   -> bool:.    ""
-00010f90: 2244 6574 6572 6d69 6e65 2069 6620 726f  "Determine if ro
-00010fa0: 6f6d 2069 6465 6e74 6966 6965 7220 6973  om identifier is
-00010fb0: 2061 206c 6f63 616c 2070 6172 7420 6f66   a local part of
-00010fc0: 2063 616e 6f6e 6963 616c 2072 6f6f 6d20   canonical room 
-00010fd0: 616c 6961 732e 0a0a 2020 2020 4c6f 6361  alias...    Loca
-00010fe0: 6c20 7061 7274 7320 6f66 2063 616e 6f6e  l parts of canon
-00010ff0: 6963 616c 2072 6f6f 6d20 616c 6961 7365  ical room aliase
-00011000: 7320 6172 6520 6f66 2073 796e 7461 783a  s are of syntax:
-00011010: 2073 6f6d 6561 6c69 6173 0a0a 2020 2020   somealias..    
-00011020: 4e6f 7720 616c 736f 2061 6c6c 6f77 696e  Now also allowin
-00011030: 6720 2373 6f6d 6561 6c69 6173 0a0a 2020  g #somealias..  
-00011040: 2020 2222 220a 2020 2020 6966 2028 0a20    """.    if (. 
-00011050: 2020 2020 2020 2072 6f6f 6d5f 6964 0a20         room_id. 
-00011060: 2020 2020 2020 2061 6e64 206c 656e 2872         and len(r
-00011070: 6f6f 6d5f 6964 2920 3e20 300a 2020 2020  oom_id) > 0.    
-00011080: 2020 2020 616e 6420 726f 6f6d 5f69 6420      and room_id 
-00011090: 213d 2022 2322 0a20 2020 2020 2020 2061  != "#".        a
-000110a0: 6e64 2028 223a 2220 6e6f 7420 696e 2072  nd (":" not in r
-000110b0: 6f6f 6d5f 6964 290a 2020 2020 2020 2020  oom_id).        
-000110c0: 616e 6420 2822 2322 206e 6f74 2069 6e20  and ("#" not in 
-000110d0: 726f 6f6d 5f69 645b 313a 5d29 0a20 2020  room_id[1:]).   
-000110e0: 2020 2020 2061 6e64 2028 6e6f 7420 726f       and (not ro
-000110f0: 6f6d 5f69 642e 7374 6172 7473 7769 7468  om_id.startswith
-00011100: 2822 2122 2929 0a20 2020 2020 2020 2061  ("!")).        a
-00011110: 6e64 2028 6e6f 7420 726f 6f6d 5f69 642e  nd (not room_id.
-00011120: 7374 6172 7473 7769 7468 2822 4022 2929  startswith("@"))
-00011130: 0a20 2020 2020 2020 2061 6e64 2028 2220  .        and (" 
-00011140: 2220 6e6f 7420 696e 2072 6f6f 6d5f 6964  " not in room_id
-00011150: 290a 2020 2020 293a 0a20 2020 2020 2020  ).    ):.       
-00011160: 2072 6574 7572 6e20 5472 7565 0a20 2020   return True.   
-00011170: 2065 6c73 653a 0a20 2020 2020 2020 2072   else:.        r
-00011180: 6574 7572 6e20 4661 6c73 650a 0a0a 6465  eturn False...de
-00011190: 6620 6973 5f75 7365 725f 6964 2875 7365  f is_user_id(use
-000111a0: 725f 6964 3a20 7374 7229 202d 3e20 626f  r_id: str) -> bo
-000111b0: 6f6c 3a0a 2020 2020 2222 2244 6574 6572  ol:.    """Deter
-000111c0: 6d69 6e65 2069 6620 7573 6572 2069 6465  mine if user ide
-000111d0: 6e74 6966 6965 7220 6973 2061 2076 616c  ntifier is a val
-000111e0: 6964 2075 7365 7220 6964 2e0a 0a20 2020  id user id...   
-000111f0: 2055 7365 7220 6964 7320 6172 6520 6f66   User ids are of
-00011200: 2073 796e 7461 783a 2040 736f 6d65 7573   syntax: @someus
-00011210: 6572 3a73 6f6d 6573 6572 7665 720a 2020  er:someserver.  
-00011220: 2020 5468 6973 2069 7320 6e6f 7420 616e    This is not an
-00011230: 2065 7868 6175 7374 6976 6520 6368 6563   exhaustive chec
-00011240: 6b21 0a0a 2020 2020 2222 220a 2020 2020  k!..    """.    
-00011250: 6966 2028 0a20 2020 2020 2020 2075 7365  if (.        use
-00011260: 725f 6964 0a20 2020 2020 2020 2061 6e64  r_id.        and
-00011270: 206c 656e 2875 7365 725f 6964 2920 3e20   len(user_id) > 
-00011280: 330a 2020 2020 2020 2020 616e 6420 2875  3.        and (u
-00011290: 7365 725f 6964 5b30 5d20 3d3d 2022 4022  ser_id[0] == "@"
-000112a0: 290a 2020 2020 2020 2020 616e 6420 2822  ).        and ("
-000112b0: 3a22 2069 6e20 7573 6572 5f69 6429 0a20  :" in user_id). 
-000112c0: 2020 2020 2020 2061 6e64 2028 2220 2220         and (" " 
-000112d0: 6e6f 7420 696e 2075 7365 725f 6964 290a  not in user_id).
-000112e0: 2020 2020 293a 0a20 2020 2020 2020 2072      ):.        r
-000112f0: 6574 7572 6e20 5472 7565 0a20 2020 2065  eturn True.    e
-00011300: 6c73 653a 0a20 2020 2020 2020 2072 6574  lse:.        ret
-00011310: 7572 6e20 4661 6c73 650a 0a0a 6465 6620  urn False...def 
-00011320: 6973 5f73 686f 7274 5f75 7365 725f 6964  is_short_user_id
-00011330: 2875 7365 725f 6964 3a20 7374 7229 202d  (user_id: str) -
-00011340: 3e20 626f 6f6c 3a0a 2020 2020 2222 2244  > bool:.    """D
-00011350: 6574 6572 6d69 6e65 2069 6620 7573 6572  etermine if user
-00011360: 2069 6465 6e74 6966 6965 7220 6973 2061   identifier is a
-00011370: 2076 616c 6964 2073 686f 7274 2075 7365   valid short use
-00011380: 7220 6964 2e0a 0a20 2020 2053 686f 7274  r id...    Short
-00011390: 2075 7365 7220 6964 7320 6172 6520 6f66   user ids are of
-000113a0: 2073 796e 7461 783a 2073 6f6d 6575 7365   syntax: someuse
-000113b0: 720a 2020 2020 5468 6973 2069 7320 6e6f  r.    This is no
-000113c0: 7420 616e 2065 7868 6175 7374 6976 6520  t an exhaustive 
-000113d0: 6368 6563 6b21 0a0a 2020 2020 2222 220a  check!..    """.
-000113e0: 2020 2020 6966 2028 0a20 2020 2020 2020      if (.       
-000113f0: 2075 7365 725f 6964 0a20 2020 2020 2020   user_id.       
-00011400: 2061 6e64 206c 656e 2875 7365 725f 6964   and len(user_id
-00011410: 2920 3e20 300a 2020 2020 2020 2020 616e  ) > 0.        an
-00011420: 6420 2822 3a22 206e 6f74 2069 6e20 7573  d (":" not in us
-00011430: 6572 5f69 6429 0a20 2020 2020 2020 2061  er_id).        a
-00011440: 6e64 2028 2240 2220 6e6f 7420 696e 2075  nd ("@" not in u
-00011450: 7365 725f 6964 290a 2020 2020 2020 2020  ser_id).        
-00011460: 616e 6420 2822 2022 206e 6f74 2069 6e20  and (" " not in 
-00011470: 7573 6572 5f69 6429 0a20 2020 2029 3a0a  user_id).    ):.
-00011480: 2020 2020 2020 2020 7265 7475 726e 2054          return T
-00011490: 7275 650a 2020 2020 656c 7365 3a0a 2020  rue.    else:.  
-000114a0: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
-000114b0: 7365 0a0a 0a64 6566 2069 735f 7061 7274  se...def is_part
-000114c0: 6961 6c5f 7573 6572 5f69 6428 7573 6572  ial_user_id(user
-000114d0: 5f69 643a 2073 7472 2920 2d3e 2062 6f6f  _id: str) -> boo
-000114e0: 6c3a 0a20 2020 2022 2222 4465 7465 726d  l:.    """Determ
-000114f0: 696e 6520 6966 2075 7365 7220 6964 656e  ine if user iden
-00011500: 7469 6669 6572 2069 7320 6120 7661 6c69  tifier is a vali
-00011510: 6420 6162 6272 6576 6961 7465 6420 7573  d abbreviated us
-00011520: 6572 2069 642e 0a0a 2020 2020 4162 6272  er id...    Abbr
-00011530: 6576 2e20 7573 6572 2069 6473 2061 7265  ev. user ids are
-00011540: 206f 6620 7379 6e74 6178 3a20 4073 6f6d   of syntax: @som
-00011550: 6575 7365 720a 2020 2020 5468 6973 2069  euser.    This i
-00011560: 7320 6e6f 7420 616e 2065 7868 6175 7374  s not an exhaust
-00011570: 6976 6520 6368 6563 6b21 0a0a 2020 2020  ive check!..    
-00011580: 2222 220a 2020 2020 6966 2028 0a20 2020  """.    if (.   
-00011590: 2020 2020 2075 7365 725f 6964 0a20 2020       user_id.   
-000115a0: 2020 2020 2061 6e64 206c 656e 2875 7365       and len(use
-000115b0: 725f 6964 2920 3e20 310a 2020 2020 2020  r_id) > 1.      
-000115c0: 2020 616e 6420 2875 7365 725f 6964 5b30    and (user_id[0
-000115d0: 5d20 3d3d 2022 4022 290a 2020 2020 2020  ] == "@").      
-000115e0: 2020 616e 6420 2822 3a22 206e 6f74 2069    and (":" not i
-000115f0: 6e20 7573 6572 5f69 6429 0a20 2020 2020  n user_id).     
-00011600: 2020 2061 6e64 2028 2220 2220 6e6f 7420     and (" " not 
-00011610: 696e 2075 7365 725f 6964 290a 2020 2020  in user_id).    
-00011620: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-00011630: 6e20 5472 7565 0a20 2020 2065 6c73 653a  n True.    else:
-00011640: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00011650: 4661 6c73 650a 0a0a 6465 6620 6973 5f75  False...def is_u
-00011660: 7365 7228 7573 6572 5f69 643a 2073 7472  ser(user_id: str
-00011670: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2022  ) -> bool:.    "
-00011680: 2222 4465 7465 726d 696e 6520 6966 2075  ""Determine if u
-00011690: 7365 7220 6964 2069 7320 6120 7661 6c69  ser id is a vali
-000116a0: 6420 7573 6572 2069 6420 6f72 2061 2076  d user id or a v
-000116b0: 616c 6964 2073 686f 7274 2075 7365 7220  alid short user 
-000116c0: 6964 2e0a 0a20 2020 2054 6869 7320 6973  id...    This is
-000116d0: 206e 6f74 2061 6e20 6578 6861 7573 7469   not an exhausti
-000116e0: 7665 2063 6865 636b 210a 0a20 2020 2022  ve check!..    "
-000116f0: 2222 0a20 2020 2072 6574 7572 6e20 280a  "".    return (.
-00011700: 2020 2020 2020 2020 6973 5f75 7365 725f          is_user_
-00011710: 6964 2875 7365 725f 6964 290a 2020 2020  id(user_id).    
-00011720: 2020 2020 6f72 2069 735f 7061 7274 6961      or is_partia
-00011730: 6c5f 7573 6572 5f69 6428 7573 6572 5f69  l_user_id(user_i
-00011740: 6429 0a20 2020 2020 2020 206f 7220 6973  d).        or is
-00011750: 5f73 686f 7274 5f75 7365 725f 6964 2875  _short_user_id(u
-00011760: 7365 725f 6964 290a 2020 2020 290a 0a0a  ser_id).    )...
-00011770: 6173 796e 6320 6465 6620 6163 7469 6f6e  async def action
-00011780: 5f72 6f6f 6d5f 646d 5f63 7265 6174 6528  _room_dm_create(
-00011790: 636c 6965 6e74 3a20 4173 796e 6343 6c69  client: AsyncCli
-000117a0: 656e 742c 2063 7265 6465 6e74 6961 6c73  ent, credentials
-000117b0: 3a20 6469 6374 293a 0a20 2020 2022 2222  : dict):.    """
-000117c0: 4372 6561 7465 2061 2064 6972 6563 7420  Create a direct 
-000117d0: 6d65 7373 6167 6520 2844 4d29 2072 6f6f  message (DM) roo
-000117e0: 6d20 7768 696c 6520 616c 7265 6164 7920  m while already 
-000117f0: 6265 696e 6720 6c6f 6767 6564 2069 6e2e  being logged in.
-00011800: 0a0a 2020 2020 4166 7465 7220 6372 6561  ..    After crea
-00011810: 7469 6e67 2074 6865 2070 7269 7661 7465  ting the private
-00011820: 2044 4d20 726f 6f6d 2069 7420 696e 7669   DM room it invi
-00011830: 7465 7320 7468 6520 6f74 6865 7220 7573  tes the other us
-00011840: 6572 2074 6f20 6974 2e0a 0a20 2020 2041  er to it...    A
-00011850: 7267 756d 656e 7473 3a0a 2020 2020 2d2d  rguments:.    --
-00011860: 2d2d 2d2d 2d2d 2d0a 2020 2020 636c 6965  -------.    clie
-00011870: 6e74 3a20 4173 796e 6343 6c69 656e 743a  nt: AsyncClient:
-00011880: 206e 696f 2063 6c69 656e 742c 2061 6c6c   nio client, all
-00011890: 6f77 7320 6173 2074 6f20 7175 6572 7920  ows as to query 
-000118a0: 7468 6520 7365 7276 6572 0a20 2020 2063  the server.    c
-000118b0: 7265 6465 6e74 6961 6c73 3a20 6469 6374  redentials: dict
-000118c0: 3a20 616c 6c6f 7773 2074 6f20 6765 7420  : allows to get 
-000118d0: 7468 6520 7573 6572 5f69 6420 6f66 2073  the user_id of s
-000118e0: 656e 6465 722c 2065 7463 0a20 2020 2022  ender, etc.    "
-000118f0: 2222 0a20 2020 2023 2075 7365 7273 203a  "".    # users :
-00011900: 206c 6973 7420 6f66 2075 7365 7273 2074   list of users t
-00011910: 6f20 6372 6561 7465 2044 4d20 726f 6f6d  o create DM room
-00011920: 7320 7769 7468 0a20 2020 2023 2072 6f6f  s with.    # roo
-00011930: 6d5f 616c 6961 7365 7320 3a20 6c69 7374  m_aliases : list
-00011940: 206f 6620 726f 6f6d 2061 6c69 6173 6573   of room aliases
-00011950: 2069 6e20 7468 6520 666f 726d 206f 6620   in the form of 
-00011960: 2273 616d 706c 6541 6c69 6173 220a 2020  "sampleAlias".  
-00011970: 2020 2320 2020 2020 2020 2020 5468 6573    #         Thes
-00011980: 6520 616c 6961 7365 7320 7769 6c6c 2074  e aliases will t
-00011990: 6865 6e20 6265 2075 7365 6420 6279 2074  hen be used by t
-000119a0: 6865 2073 6572 7665 7220 616e 640a 2020  he server and.  
-000119b0: 2020 2320 2020 2020 2020 2020 7468 6520    #         the 
-000119c0: 7365 7276 6572 2063 7265 6174 6573 2074  server creates t
-000119d0: 6865 2064 6566 696e 6974 6520 616c 6961  he definite alia
-000119e0: 7320 696e 2074 6865 2066 6f72 6d0a 2020  s in the form.  
-000119f0: 2020 2320 2020 2020 2020 2020 6f66 2022    #         of "
-00011a00: 2373 616d 706c 6541 6c69 6173 3a65 7861  #sampleAlias:exa
-00011a10: 6d70 6c65 2e63 6f6d 2220 6672 6f6d 2069  mple.com" from i
-00011a20: 742e 0a20 2020 2023 2020 2020 2020 2020  t..    #        
-00011a30: 2057 6520 7065 726d 6974 2022 2373 616d   We permit "#sam
-00011a40: 706c 6541 6c69 6173 3a65 7861 6d70 6c65  pleAlias:example
-00011a50: 2e63 6f6d 2220 616e 6420 646f 776e 7363  .com" and downsc
-00011a60: 616c 6520 6974 2074 6f0a 2020 2020 2320  ale it to.    # 
-00011a70: 2020 2020 2020 2020 2273 616d 706c 6541          "sampleA
-00011a80: 6c69 6173 222e 0a20 2020 2023 206e 616d  lias"..    # nam
-00011a90: 6573 203a 206c 6973 7420 6f66 206e 616d  es : list of nam
-00011aa0: 6573 2066 6f72 2072 6f6f 6d73 0a20 2020  es for rooms.   
-00011ab0: 2023 2074 6f70 6963 203a 2072 6f6f 6d20   # topic : room 
-00011ac0: 746f 7069 6373 0a0a 2020 2020 7573 6572  topics..    user
-00011ad0: 7320 3d20 6773 2e70 612e 726f 6f6d 5f64  s = gs.pa.room_d
-00011ae0: 6d5f 6372 6561 7465 0a20 2020 2072 6f6f  m_create.    roo
-00011af0: 6d5f 616c 6961 7365 7320 3d20 6773 2e70  m_aliases = gs.p
-00011b00: 612e 616c 6961 730a 2020 2020 6e61 6d65  a.alias.    name
-00011b10: 7320 3d20 6773 2e70 612e 6e61 6d65 0a20  s = gs.pa.name. 
-00011b20: 2020 2074 6f70 6963 7320 3d20 6773 2e70     topics = gs.p
-00011b30: 612e 746f 7069 630a 2020 2020 7472 793a  a.topic.    try:
-00011b40: 0a20 2020 2020 2020 2069 6e64 6578 203d  .        index =
-00011b50: 2030 0a20 2020 2020 2020 2067 732e 6c6f   0.        gs.lo
-00011b60: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
-00011b70: 2020 2020 2066 2754 7279 696e 6720 746f       f'Trying to
-00011b80: 2063 7265 6174 6520 444d 2072 6f6f 6d73   create DM rooms
-00011b90: 2077 6974 6820 7573 6572 7320 227b 7573   with users "{us
-00011ba0: 6572 737d 222c 2027 0a20 2020 2020 2020  ers}", '.       
-00011bb0: 2020 2020 2066 2772 6f6f 6d20 616c 6961       f'room alia
-00011bc0: 7365 7320 227b 726f 6f6d 5f61 6c69 6173  ses "{room_alias
-00011bd0: 6573 7d22 2c20 270a 2020 2020 2020 2020  es}", '.        
-00011be0: 2020 2020 6627 6e61 6d65 7320 227b 6e61      f'names "{na
-00011bf0: 6d65 737d 222c 2061 6e64 2074 6f70 6963  mes}", and topic
-00011c00: 7320 227b 746f 7069 6373 7d22 2e27 0a20  s "{topics}".'. 
-00011c10: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00011c20: 2066 6f72 2075 7365 7220 696e 2075 7365   for user in use
-00011c30: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-00011c40: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00011c50: 2020 2020 2061 6c69 6173 203d 2072 6f6f       alias = roo
-00011c60: 6d5f 616c 6961 7365 735b 696e 6465 785d  m_aliases[index]
-00011c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011c80: 2061 6c69 6173 203d 2061 6c69 6173 2e72   alias = alias.r
-00011c90: 6570 6c61 6365 2872 225c 2122 2c20 2221  eplace(r"\!", "!
-00011ca0: 2229 2020 2320 7265 6d6f 7665 2070 6f73  ")  # remove pos
-00011cb0: 7369 626c 6520 6573 6361 7065 0a20 2020  sible escape.   
-00011cc0: 2020 2020 2020 2020 2020 2020 2023 2061               # a
-00011cd0: 6c69 6173 2069 7320 6120 7472 7565 2061  lias is a true a
-00011ce0: 6c69 6173 2c20 6e6f 7420 6120 726f 6f6d  lias, not a room
-00011cf0: 2069 640a 2020 2020 2020 2020 2020 2020   id.            
-00011d00: 2020 2020 2320 6966 2062 7920 6d69 7374      # if by mist
-00011d10: 616b 6520 7573 6572 2068 6173 2067 6976  ake user has giv
-00011d20: 656e 2066 756c 6c20 726f 6f6d 2061 6c69  en full room ali
-00011d30: 6173 2c20 7368 6f72 7465 6e20 6974 0a20  as, shorten it. 
-00011d40: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00011d50: 6620 6973 5f72 6f6f 6d5f 616c 6961 7328  f is_room_alias(
-00011d60: 616c 6961 7329 3a0a 2020 2020 2020 2020  alias):.        
-00011d70: 2020 2020 2020 2020 2020 2020 616c 6961              alia
-00011d80: 7320 3d20 726f 6f6d 5f61 6c69 6173 5f74  s = room_alias_t
-00011d90: 6f5f 7368 6f72 745f 726f 6f6d 5f61 6c69  o_short_room_ali
-00011da0: 6173 2861 6c69 6173 2c20 6372 6564 656e  as(alias, creden
-00011db0: 7469 616c 7329 0a20 2020 2020 2020 2020  tials).         
-00011dc0: 2020 2065 7863 6570 7420 2849 6e64 6578     except (Index
-00011dd0: 4572 726f 722c 2054 7970 6545 7272 6f72  Error, TypeError
-00011de0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00011df0: 2020 2061 6c69 6173 203d 2022 220a 2020     alias = "".  
-00011e00: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-00011e10: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00011e20: 616d 6520 3d20 6e61 6d65 735b 696e 6465  ame = names[inde
-00011e30: 785d 0a20 2020 2020 2020 2020 2020 2065  x].            e
-00011e40: 7863 6570 7420 2849 6e64 6578 4572 726f  xcept (IndexErro
-00011e50: 722c 2054 7970 6545 7272 6f72 293a 0a20  r, TypeError):. 
-00011e60: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00011e70: 616d 6520 3d20 2222 0a20 2020 2020 2020  ame = "".       
-00011e80: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00011e90: 2020 2020 2020 2020 2020 746f 7069 6320            topic 
-00011ea0: 3d20 746f 7069 6373 5b69 6e64 6578 5d0a  = topics[index].
-00011eb0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-00011ec0: 7074 2028 496e 6465 7845 7272 6f72 2c20  pt (IndexError, 
-00011ed0: 5479 7065 4572 726f 7229 3a0a 2020 2020  TypeError):.    
-00011ee0: 2020 2020 2020 2020 2020 2020 746f 7069              topi
-00011ef0: 6320 3d20 2222 0a20 2020 2020 2020 2020  c = "".         
-00011f00: 2020 2061 6c69 6173 203d 2061 6c69 6173     alias = alias
-00011f10: 2e73 7472 6970 2829 0a20 2020 2020 2020  .strip().       
-00011f20: 2020 2020 2061 6c69 6173 203d 204e 6f6e       alias = Non
-00011f30: 6520 6966 2061 6c69 6173 203d 3d20 2222  e if alias == ""
-00011f40: 2065 6c73 6520 616c 6961 730a 2020 2020   else alias.    
-00011f50: 2020 2020 2020 2020 6e61 6d65 203d 206e          name = n
-00011f60: 616d 652e 7374 7269 7028 290a 2020 2020  ame.strip().    
-00011f70: 2020 2020 2020 2020 6e61 6d65 203d 204e          name = N
-00011f80: 6f6e 6520 6966 206e 616d 6520 3d3d 2022  one if name == "
-00011f90: 2220 656c 7365 206e 616d 650a 2020 2020  " else name.    
-00011fa0: 2020 2020 2020 2020 746f 7069 6320 3d20          topic = 
-00011fb0: 746f 7069 632e 7374 7269 7028 290a 2020  topic.strip().  
-00011fc0: 2020 2020 2020 2020 2020 746f 7069 6320            topic 
-00011fd0: 3d20 4e6f 6e65 2069 6620 746f 7069 6320  = None if topic 
-00011fe0: 3d3d 2022 2220 656c 7365 2074 6f70 6963  == "" else topic
-00011ff0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00012000: 6773 2e70 612e 706c 6169 6e3a 0a20 2020  gs.pa.plain:.   
-00012010: 2020 2020 2020 2020 2020 2020 2065 6e63               enc
-00012020: 7279 7074 203d 2046 616c 7365 0a20 2020  rypt = False.   
-00012030: 2020 2020 2020 2020 2020 2020 2069 6e69               ini
-00012040: 7469 616c 5f73 7461 7465 203d 2028 290a  tial_state = ().
-00012050: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00012060: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012070: 2020 656e 6372 7970 7420 3d20 5472 7565    encrypt = True
-00012080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012090: 2069 6e69 7469 616c 5f73 7461 7465 203d   initial_state =
-000120a0: 205b 456e 6162 6c65 456e 6372 7970 7469   [EnableEncrypti
-000120b0: 6f6e 4275 696c 6465 7228 292e 6173 5f64  onBuilder().as_d
-000120c0: 6963 7428 295d 0a20 2020 2020 2020 2020  ict()].         
-000120d0: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-000120e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000120f0: 2066 2743 7265 6174 696e 6720 444d 2072   f'Creating DM r
-00012100: 6f6f 6d20 7769 7468 2075 7365 7220 227b  oom with user "{
-00012110: 7573 6572 7d22 2c20 270a 2020 2020 2020  user}", '.      
-00012120: 2020 2020 2020 2020 2020 6627 726f 6f6d            f'room
-00012130: 2061 6c69 6173 2022 7b61 6c69 6173 7d22   alias "{alias}"
-00012140: 2c20 270a 2020 2020 2020 2020 2020 2020  , '.            
-00012150: 2020 2020 6627 6e61 6d65 2022 7b6e 616d      f'name "{nam
-00012160: 657d 222c 2074 6f70 6963 2022 7b74 6f70  e}", topic "{top
-00012170: 6963 7d22 2061 6e64 2027 0a20 2020 2020  ic}" and '.     
-00012180: 2020 2020 2020 2020 2020 2066 2765 6e63             f'enc
-00012190: 7279 7074 6564 2022 7b65 6e63 7279 7074  rypted "{encrypt
-000121a0: 7d22 2e27 0a20 2020 2020 2020 2020 2020  }".'.           
-000121b0: 2029 0a20 2020 2020 2020 2020 2020 2023   ).            #
-000121c0: 206e 696f 2773 2072 6f6f 6d5f 6372 6561   nio's room_crea
-000121d0: 7465 2064 6f65 7320 4e4f 5420 6163 6365  te does NOT acce
-000121e0: 7074 2022 2366 6f6f 3a65 7861 6d70 6c65  pt "#foo:example
-000121f0: 2e63 6f6d 220a 2020 2020 2020 2020 2020  .com".          
-00012200: 2020 7265 7370 203d 2061 7761 6974 2063    resp = await c
-00012210: 6c69 656e 742e 726f 6f6d 5f63 7265 6174  lient.room_creat
-00012220: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-00012230: 2020 2061 6c69 6173 3d61 6c69 6173 2c20     alias=alias, 
-00012240: 2023 2064 6573 6972 6564 2063 616e 6f6e   # desired canon
-00012250: 6963 616c 2061 6c69 6173 206c 6f63 616c  ical alias local
-00012260: 2070 6172 742c 2065 2e67 2e20 666f 6f0a   part, e.g. foo.
-00012270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012280: 7669 7369 6269 6c69 7479 3d52 6f6f 6d56  visibility=RoomV
-00012290: 6973 6962 696c 6974 792e 7072 6976 6174  isibility.privat
-000122a0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-000122b0: 2020 2069 735f 6469 7265 6374 3d54 7275     is_direct=Tru
-000122c0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-000122d0: 2020 2070 7265 7365 743d 526f 6f6d 5072     preset=RoomPr
-000122e0: 6573 6574 2e70 7269 7661 7465 5f63 6861  eset.private_cha
-000122f0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-00012300: 2020 2069 6e76 6974 653d 7b75 7365 727d     invite={user}
-00012310: 2c20 2023 2069 6e76 6974 6520 7468 6520  ,  # invite the 
-00012320: 7573 6572 2074 6f20 7468 6520 444d 0a20  user to the DM. 
-00012330: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00012340: 616d 653d 6e61 6d65 2c20 2023 2072 6f6f  ame=name,  # roo
-00012350: 6d20 6e61 6d65 0a20 2020 2020 2020 2020  m name.         
-00012360: 2020 2020 2020 2074 6f70 6963 3d74 6f70         topic=top
-00012370: 6963 2c20 2023 2072 6f6f 6d20 746f 7069  ic,  # room topi
-00012380: 630a 2020 2020 2020 2020 2020 2020 2020  c.              
-00012390: 2020 696e 6974 6961 6c5f 7374 6174 653d    initial_state=
-000123a0: 696e 6974 6961 6c5f 7374 6174 652c 0a20  initial_state,. 
-000123b0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000123c0: 2020 2020 2020 2020 2023 2022 616c 6961           # "alia
-000123d0: 7331 2220 7769 6c6c 2063 7265 6174 6520  s1" will create 
-000123e0: 6120 2223 616c 6961 7331 3a65 7861 6d70  a "#alias1:examp
-000123f0: 6c65 2e63 6f6d 220a 2020 2020 2020 2020  le.com".        
-00012400: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00012410: 6528 7265 7370 2c20 526f 6f6d 4372 6561  e(resp, RoomCrea
-00012420: 7465 4572 726f 7229 3a0a 2020 2020 2020  teError):.      
-00012430: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-00012440: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
-00012450: 2020 2020 2020 2020 2020 2020 2245 3132              "E12
-00012460: 353a 2022 0a20 2020 2020 2020 2020 2020  5: ".           
-00012470: 2020 2020 2020 2020 2022 526f 6f6d 5f63           "Room_c
-00012480: 7265 6174 6520 6661 696c 6564 2077 6974  reate failed wit
-00012490: 6820 7265 7370 6f6e 7365 3a20 220a 2020  h response: ".  
-000124a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000124b0: 2020 6622 7b70 7269 7661 6379 5f66 696c    f"{privacy_fil
-000124c0: 7465 7228 7374 7228 7265 7370 2929 7d22  ter(str(resp))}"
-000124d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000124e0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-000124f0: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
-00012500: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
-00012510: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00012520: 2020 2020 2020 2069 6620 616c 6961 733a         if alias:
-00012530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012540: 2020 2020 2066 756c 6c5f 616c 6961 7320       full_alias 
-00012550: 3d20 7368 6f72 745f 726f 6f6d 5f61 6c69  = short_room_ali
-00012560: 6173 5f74 6f5f 726f 6f6d 5f61 6c69 6173  as_to_room_alias
-00012570: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00012580: 2020 2020 2020 2020 2020 616c 6961 732c            alias,
-00012590: 2063 7265 6465 6e74 6961 6c73 0a20 2020   credentials.   
-000125a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000125b0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-000125c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000125d0: 2020 2020 2020 2020 2020 2020 2066 756c               ful
-000125e0: 6c5f 616c 6961 7320 3d20 4e6f 6e65 0a20  l_alias = None. 
-000125f0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00012600: 732e 6c6f 672e 696e 666f 280a 2020 2020  s.log.info(.    
-00012610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012620: 6627 4372 6561 7465 6420 444d 2072 6f6f  f'Created DM roo
-00012630: 6d20 7769 7468 2072 6f6f 6d20 6964 2022  m with room id "
-00012640: 7b72 6573 702e 726f 6f6d 5f69 647d 222c  {resp.room_id}",
-00012650: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00012660: 2020 2020 2020 2066 2773 686f 7274 2061         f'short a
-00012670: 6c69 6173 2022 7b7a 6e28 616c 6961 7329  lias "{zn(alias)
-00012680: 7d22 2c20 270a 2020 2020 2020 2020 2020  }", '.          
-00012690: 2020 2020 2020 2020 2020 6627 6675 6c6c            f'full
-000126a0: 2061 6c69 6173 2022 7b7a 6e28 6675 6c6c   alias "{zn(full
-000126b0: 5f61 6c69 6173 297d 2220 616e 6420 270a  _alias)}" and '.
-000126c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000126d0: 2020 2020 6627 656e 6372 7970 7465 6420      f'encrypted 
-000126e0: 227b 656e 6372 7970 747d 222e 270a 2020  "{encrypt}".'.  
-000126f0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00012700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012710: 2320 6f75 7470 7574 2066 6f72 6d61 7420  # output format 
-00012720: 636f 6e74 726f 6c6c 6564 2076 6961 202d  controlled via -
-00012730: 2d6f 7574 7075 7420 666c 6167 0a20 2020  -output flag.   
-00012740: 2020 2020 2020 2020 2020 2020 2074 6578               tex
-00012750: 7420 3d20 280a 2020 2020 2020 2020 2020  t = (.          
-00012760: 2020 2020 2020 2020 2020 6622 7b72 6573            f"{res
-00012770: 702e 726f 6f6d 5f69 647d 7b53 4550 7d7b  p.room_id}{SEP}{
-00012780: 7a6e 2861 6c69 6173 297d 7b53 4550 7d7b  zn(alias)}{SEP}{
-00012790: 7a6e 2866 756c 6c5f 616c 6961 7329 7d22  zn(full_alias)}"
-000127a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000127b0: 2020 2020 2066 227b 5345 507d 7b7a 6e28       f"{SEP}{zn(
-000127c0: 6e61 6d65 297d 7b53 4550 7d7b 7a6e 2874  name)}{SEP}{zn(t
-000127d0: 6f70 6963 297d 7b53 4550 7d7b 656e 6372  opic)}{SEP}{encr
-000127e0: 7970 747d 220a 2020 2020 2020 2020 2020  ypt}".          
-000127f0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00012800: 2020 2020 2020 2020 2320 4f62 6a65 6374          # Object
-00012810: 206f 6620 7479 7065 2052 6f6f 6d43 7265   of type RoomCre
-00012820: 6174 6552 6573 706f 6e73 6520 6973 206e  ateResponse is n
-00012830: 6f74 204a 534f 4e0a 2020 2020 2020 2020  ot JSON.        
-00012840: 2020 2020 2020 2020 2320 7365 7269 616c          # serial
-00012850: 697a 6162 6c65 2c20 6865 6e63 6520 7765  izable, hence we
-00012860: 2075 7365 2074 6865 2064 6963 7469 6f6e   use the diction
-00012870: 6172 792e 0a20 2020 2020 2020 2020 2020  ary..           
-00012880: 2020 2020 206a 736f 6e5f 6d61 7820 3d20       json_max = 
-00012890: 7265 7370 2e5f 5f64 6963 745f 5f0a 2020  resp.__dict__.  
-000128a0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000128b0: 7265 7370 2068 6173 206f 6e6c 7920 3120  resp has only 1 
-000128c0: 7573 6566 756c 2075 7365 6675 6c20 6d65  useful useful me
-000128d0: 6d62 6572 3a20 726f 6f6d 5f69 640a 2020  mber: room_id.  
-000128e0: 2020 2020 2020 2020 2020 2020 2020 6a73                js
-000128f0: 6f6e 5f6d 6178 2e75 7064 6174 6528 7b22  on_max.update({"
-00012900: 616c 6961 7322 3a20 616c 6961 737d 2920  alias": alias}) 
-00012910: 2023 2061 6464 2064 6963 7420 6974 656d   # add dict item
-00012920: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00012930: 2020 6a73 6f6e 5f6d 6178 2e75 7064 6174    json_max.updat
-00012940: 6528 7b22 616c 6961 735f 6675 6c6c 223a  e({"alias_full":
-00012950: 2066 756c 6c5f 616c 6961 737d 290a 2020   full_alias}).  
-00012960: 2020 2020 2020 2020 2020 2020 2020 6a73                js
-00012970: 6f6e 5f6d 6178 2e75 7064 6174 6528 7b22  on_max.update({"
-00012980: 6e61 6d65 223a 206e 616d 657d 290a 2020  name": name}).  
-00012990: 2020 2020 2020 2020 2020 2020 2020 6a73                js
-000129a0: 6f6e 5f6d 6178 2e75 7064 6174 6528 7b22  on_max.update({"
-000129b0: 746f 7069 6322 3a20 746f 7069 637d 290a  topic": topic}).
-000129c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000129d0: 6a73 6f6e 5f6d 6178 2e75 7064 6174 6528  json_max.update(
-000129e0: 7b22 656e 6372 7970 7465 6422 3a20 656e  {"encrypted": en
-000129f0: 6372 7970 747d 290a 2020 2020 2020 2020  crypt}).        
-00012a00: 2020 2020 2020 2020 6a73 6f6e 5f20 3d20          json_ = 
-00012a10: 6a73 6f6e 5f6d 6178 2e63 6f70 7928 290a  json_max.copy().
-00012a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012a30: 6a73 6f6e 5f2e 706f 7028 2274 7261 6e73  json_.pop("trans
-00012a40: 706f 7274 5f72 6573 706f 6e73 6522 290a  port_response").
-00012a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012a60: 6a73 6f6e 5f73 7065 6320 3d20 4e6f 6e65  json_spec = None
-00012a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012a80: 2070 7269 6e74 5f6f 7574 7075 7428 0a20   print_output(. 
-00012a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012aa0: 2020 2067 732e 7061 2e6f 7574 7075 742c     gs.pa.output,
-00012ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012ac0: 2020 2020 2074 6578 743d 7465 7874 2c0a       text=text,.
-00012ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ae0: 2020 2020 6a73 6f6e 5f3d 6a73 6f6e 5f2c      json_=json_,
-00012af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012b00: 2020 2020 206a 736f 6e5f 6d61 783d 6a73       json_max=js
-00012b10: 6f6e 5f6d 6178 2c0a 2020 2020 2020 2020  on_max,.        
-00012b20: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-00012b30: 5f73 7065 633d 6a73 6f6e 5f73 7065 632c  _spec=json_spec,
-00012b40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012b50: 2029 0a20 2020 2020 2020 2020 2020 2069   ).            i
-00012b60: 6e64 6578 203d 2069 6e64 6578 202b 2031  ndex = index + 1
-00012b70: 0a20 2020 2065 7863 6570 7420 4578 6365  .    except Exce
-00012b80: 7074 696f 6e3a 0a20 2020 2020 2020 2067  ption:.        g
-00012b90: 732e 6c6f 672e 6572 726f 7228 2245 3132  s.log.error("E12
-00012ba0: 363a 2022 2022 444d 2072 6f6f 6d20 6372  6: " "DM room cr
-00012bb0: 6561 7469 6f6e 2066 6169 6c65 642e 2053  eation failed. S
-00012bc0: 6f72 7279 2e22 290a 2020 2020 2020 2020  orry.").        
-00012bd0: 6773 2e65 7272 5f63 6f75 6e74 202b 3d20  gs.err_count += 
-00012be0: 310a 2020 2020 2020 2020 6773 2e6c 6f67  1.        gs.log
-00012bf0: 2e64 6562 7567 2822 4865 7265 2069 7320  .debug("Here is 
-00012c00: 7468 6520 7472 6163 6562 6163 6b2e 5c6e  the traceback.\n
-00012c10: 2220 2b20 7472 6163 6562 6163 6b2e 666f  " + traceback.fo
-00012c20: 726d 6174 5f65 7863 2829 290a 0a0a 6173  rmat_exc())...as
-00012c30: 796e 6320 6465 6620 6163 7469 6f6e 5f72  ync def action_r
-00012c40: 6f6f 6d5f 6372 6561 7465 2863 6c69 656e  oom_create(clien
-00012c50: 743a 2041 7379 6e63 436c 6965 6e74 2c20  t: AsyncClient, 
-00012c60: 6372 6564 656e 7469 616c 733a 2064 6963  credentials: dic
-00012c70: 7429 3a0a 2020 2020 2222 2243 7265 6174  t):.    """Creat
-00012c80: 6520 6f6e 6520 6f72 206d 756c 7469 706c  e one or multipl
-00012c90: 6520 726f 6f6d 7320 7768 696c 6520 616c  e rooms while al
-00012ca0: 7265 6164 7920 6265 696e 6720 6c6f 6767  ready being logg
-00012cb0: 6564 2069 6e2e 0a0a 2020 2020 4172 6775  ed in...    Argu
-00012cc0: 6d65 6e74 733a 0a20 2020 202d 2d2d 2d2d  ments:.    -----
-00012cd0: 2d2d 2d2d 0a20 2020 2063 6c69 656e 743a  ----.    client:
-00012ce0: 2041 7379 6e63 436c 6965 6e74 3a20 6e69   AsyncClient: ni
-00012cf0: 6f20 636c 6965 6e74 2c20 616c 6c6f 7773  o client, allows
-00012d00: 2061 7320 746f 2071 7565 7279 2074 6865   as to query the
-00012d10: 2073 6572 7665 720a 2020 2020 6372 6564   server.    cred
-00012d20: 656e 7469 616c 733a 2064 6963 743a 2061  entials: dict: a
-00012d30: 6c6c 6f77 7320 746f 2067 6574 2074 6865  llows to get the
-00012d40: 2075 7365 725f 6964 206f 6620 7365 6e64   user_id of send
-00012d50: 6572 2c20 6574 630a 2020 2020 2222 220a  er, etc.    """.
-00012d60: 2020 2020 2320 726f 6f6d 5f61 6c69 6173      # room_alias
-00012d70: 6573 203a 206c 6973 7420 6f66 2072 6f6f  es : list of roo
-00012d80: 6d20 616c 6961 7365 7320 696e 2074 6865  m aliases in the
-00012d90: 2066 6f72 6d20 6f66 2022 7361 6d70 6c65   form of "sample
-00012da0: 416c 6961 7322 0a20 2020 2023 2020 2020  Alias".    #    
-00012db0: 2020 2020 2054 6865 7365 2061 6c69 6173       These alias
-00012dc0: 6573 2077 696c 6c20 7468 656e 2062 6520  es will then be 
-00012dd0: 7573 6564 2062 7920 7468 6520 7365 7276  used by the serv
-00012de0: 6572 2061 6e64 0a20 2020 2023 2020 2020  er and.    #    
-00012df0: 2020 2020 2074 6865 2073 6572 7665 7220       the server 
-00012e00: 6372 6561 7465 7320 7468 6520 6465 6669  creates the defi
-00012e10: 6e69 7465 2061 6c69 6173 2069 6e20 7468  nite alias in th
-00012e20: 6520 666f 726d 0a20 2020 2023 2020 2020  e form.    #    
-00012e30: 2020 2020 206f 6620 2223 7361 6d70 6c65       of "#sample
-00012e40: 416c 6961 733a 6578 616d 706c 652e 636f  Alias:example.co
-00012e50: 6d22 2066 726f 6d20 6974 2e0a 2020 2020  m" from it..    
-00012e60: 2320 2020 2020 2020 2020 5765 2070 6572  #         We per
-00012e70: 6d69 7420 2223 7361 6d70 6c65 416c 6961  mit "#sampleAlia
-00012e80: 733a 6578 616d 706c 652e 636f 6d22 2061  s:example.com" a
-00012e90: 6e64 2064 6f77 6e73 6361 6c65 2069 7420  nd downscale it 
-00012ea0: 746f 0a20 2020 2023 2020 2020 2020 2020  to.    #        
-00012eb0: 2022 7361 6d70 6c65 416c 6961 7322 2e0a   "sampleAlias"..
-00012ec0: 2020 2020 2320 6e61 6d65 7320 3a20 6c69      # names : li
-00012ed0: 7374 206f 6620 6e61 6d65 7320 666f 7220  st of names for 
-00012ee0: 726f 6f6d 730a 2020 2020 2320 746f 7069  rooms.    # topi
-00012ef0: 6373 203a 206c 6973 7420 6f66 2072 6f6f  cs : list of roo
-00012f00: 6d20 746f 7069 6373 0a0a 2020 2020 726f  m topics..    ro
-00012f10: 6f6d 5f61 6c69 6173 6573 203d 2067 732e  om_aliases = gs.
-00012f20: 7061 2e72 6f6f 6d5f 6372 6561 7465 0a20  pa.room_create. 
-00012f30: 2020 206e 616d 6573 203d 2067 732e 7061     names = gs.pa
-00012f40: 2e6e 616d 650a 2020 2020 746f 7069 6373  .name.    topics
-00012f50: 203d 2067 732e 7061 2e74 6f70 6963 0a20   = gs.pa.topic. 
-00012f60: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00012f70: 696e 6465 7820 3d20 300a 2020 2020 2020  index = 0.      
-00012f80: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
-00012f90: 2020 2020 2020 2020 2020 2020 6627 5472              f'Tr
-00012fa0: 7969 6e67 2074 6f20 6372 6561 7465 2072  ying to create r
-00012fb0: 6f6f 6d73 2077 6974 6820 726f 6f6d 2061  ooms with room a
-00012fc0: 6c69 6173 6573 2022 7b72 6f6f 6d5f 616c  liases "{room_al
-00012fd0: 6961 7365 737d 222c 2027 0a20 2020 2020  iases}", '.     
-00012fe0: 2020 2020 2020 2066 276e 616d 6573 2022         f'names "
-00012ff0: 7b6e 616d 6573 7d22 2c20 616e 6420 746f  {names}", and to
-00013000: 7069 6373 2022 7b74 6f70 6963 737d 222e  pics "{topics}".
-00013010: 270a 2020 2020 2020 2020 290a 2020 2020  '.        ).    
-00013020: 2020 2020 666f 7220 616c 6961 7320 696e      for alias in
-00013030: 2072 6f6f 6d5f 616c 6961 7365 733a 0a20   room_aliases:. 
-00013040: 2020 2020 2020 2020 2020 2061 6c69 6173             alias
-00013050: 203d 2061 6c69 6173 2e72 6570 6c61 6365   = alias.replace
-00013060: 2872 225c 2122 2c20 2221 2229 2020 2320  (r"\!", "!")  # 
-00013070: 7265 6d6f 7665 2070 6f73 7369 626c 6520  remove possible 
-00013080: 6573 6361 7065 0a20 2020 2020 2020 2020  escape.         
-00013090: 2020 2023 2061 6c69 6173 2069 7320 6120     # alias is a 
-000130a0: 7472 7565 2061 6c69 6173 2c20 6e6f 7420  true alias, not 
-000130b0: 6120 726f 6f6d 2069 640a 2020 2020 2020  a room id.      
-000130c0: 2020 2020 2020 2320 6966 2062 7920 6d69        # if by mi
-000130d0: 7374 616b 6520 7573 6572 2068 6173 2067  stake user has g
-000130e0: 6976 656e 2066 756c 6c20 726f 6f6d 2061  iven full room a
-000130f0: 6c69 6173 2c20 7368 6f72 7465 6e20 6974  lias, shorten it
-00013100: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00013110: 6973 5f72 6f6f 6d5f 616c 6961 7328 616c  is_room_alias(al
-00013120: 6961 7329 3a0a 2020 2020 2020 2020 2020  ias):.          
-00013130: 2020 2020 2020 616c 6961 7320 3d20 726f        alias = ro
-00013140: 6f6d 5f61 6c69 6173 5f74 6f5f 7368 6f72  om_alias_to_shor
-00013150: 745f 726f 6f6d 5f61 6c69 6173 2861 6c69  t_room_alias(ali
-00013160: 6173 2c20 6372 6564 656e 7469 616c 7329  as, credentials)
-00013170: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
-00013180: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00013190: 2020 6e61 6d65 203d 206e 616d 6573 5b69    name = names[i
-000131a0: 6e64 6578 5d0a 2020 2020 2020 2020 2020  ndex].          
-000131b0: 2020 6578 6365 7074 2028 496e 6465 7845    except (IndexE
-000131c0: 7272 6f72 2c20 5479 7065 4572 726f 7229  rror, TypeError)
-000131d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000131e0: 2020 6e61 6d65 203d 2022 220a 2020 2020    name = "".    
-000131f0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00013200: 2020 2020 2020 2020 2020 2020 2074 6f70               top
-00013210: 6963 203d 2074 6f70 6963 735b 696e 6465  ic = topics[inde
-00013220: 785d 0a20 2020 2020 2020 2020 2020 2065  x].            e
-00013230: 7863 6570 7420 2849 6e64 6578 4572 726f  xcept (IndexErro
-00013240: 722c 2054 7970 6545 7272 6f72 293a 0a20  r, TypeError):. 
-00013250: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00013260: 6f70 6963 203d 2022 220a 2020 2020 2020  opic = "".      
-00013270: 2020 2020 2020 616c 6961 7320 3d20 616c        alias = al
-00013280: 6961 732e 7374 7269 7028 290a 2020 2020  ias.strip().    
-00013290: 2020 2020 2020 2020 616c 6961 7320 3d20          alias = 
-000132a0: 4e6f 6e65 2069 6620 616c 6961 7320 3d3d  None if alias ==
-000132b0: 2022 2220 656c 7365 2061 6c69 6173 0a20   "" else alias. 
-000132c0: 2020 2020 2020 2020 2020 206e 616d 6520             name 
-000132d0: 3d20 6e61 6d65 2e73 7472 6970 2829 0a20  = name.strip(). 
-000132e0: 2020 2020 2020 2020 2020 206e 616d 6520             name 
-000132f0: 3d20 4e6f 6e65 2069 6620 6e61 6d65 203d  = None if name =
-00013300: 3d20 2222 2065 6c73 6520 6e61 6d65 0a20  = "" else name. 
-00013310: 2020 2020 2020 2020 2020 2074 6f70 6963             topic
-00013320: 203d 2074 6f70 6963 2e73 7472 6970 2829   = topic.strip()
-00013330: 0a20 2020 2020 2020 2020 2020 2074 6f70  .            top
-00013340: 6963 203d 204e 6f6e 6520 6966 2074 6f70  ic = None if top
-00013350: 6963 203d 3d20 2222 2065 6c73 6520 746f  ic == "" else to
-00013360: 7069 630a 2020 2020 2020 2020 2020 2020  pic.            
-00013370: 6966 2067 732e 7061 2e70 6c61 696e 3a0a  if gs.pa.plain:.
-00013380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013390: 656e 6372 7970 7420 3d20 4661 6c73 650a  encrypt = False.
-000133a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000133b0: 696e 6974 6961 6c5f 7374 6174 6520 3d20  initial_state = 
-000133c0: 2829 0a20 2020 2020 2020 2020 2020 2065  ().            e
-000133d0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000133e0: 2020 2020 2065 6e63 7279 7074 203d 2054       encrypt = T
-000133f0: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
-00013400: 2020 2020 696e 6974 6961 6c5f 7374 6174      initial_stat
-00013410: 6520 3d20 5b45 6e61 626c 6545 6e63 7279  e = [EnableEncry
-00013420: 7074 696f 6e42 7569 6c64 6572 2829 2e61  ptionBuilder().a
-00013430: 735f 6469 6374 2829 5d0a 2020 2020 2020  s_dict()].      
-00013440: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-00013450: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-00013460: 2020 2020 6627 4372 6561 7469 6e67 2072      f'Creating r
-00013470: 6f6f 6d20 7769 7468 2072 6f6f 6d20 616c  oom with room al
-00013480: 6961 7320 227b 616c 6961 737d 222c 2027  ias "{alias}", '
-00013490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000134a0: 2066 276e 616d 6520 227b 6e61 6d65 7d22   f'name "{name}"
-000134b0: 2c20 746f 7069 6320 227b 746f 7069 637d  , topic "{topic}
-000134c0: 2220 616e 6420 270a 2020 2020 2020 2020  " and '.        
-000134d0: 2020 2020 2020 2020 6627 656e 6372 7970          f'encryp
-000134e0: 7465 6420 227b 656e 6372 7970 747d 222e  ted "{encrypt}".
-000134f0: 270a 2020 2020 2020 2020 2020 2020 290a  '.            ).
-00013500: 2020 2020 2020 2020 2020 2020 2320 6e69              # ni
-00013510: 6f27 7320 726f 6f6d 5f63 7265 6174 6520  o's room_create 
-00013520: 646f 6573 204e 4f54 2061 6363 6570 7420  does NOT accept 
-00013530: 2223 666f 6f3a 6578 616d 706c 652e 636f  "#foo:example.co
-00013540: 6d22 0a20 2020 2020 2020 2020 2020 2072  m".            r
-00013550: 6573 7020 3d20 6177 6169 7420 636c 6965  esp = await clie
-00013560: 6e74 2e72 6f6f 6d5f 6372 6561 7465 280a  nt.room_create(.
-00013570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013580: 616c 6961 733d 616c 6961 732c 2020 2320  alias=alias,  # 
-00013590: 6465 7369 7265 6420 6361 6e6f 6e69 6361  desired canonica
-000135a0: 6c20 616c 6961 7320 6c6f 6361 6c20 7061  l alias local pa
-000135b0: 7274 2c20 652e 672e 2066 6f6f 0a20 2020  rt, e.g. foo.   
-000135c0: 2020 2020 2020 2020 2020 2020 206e 616d               nam
-000135d0: 653d 6e61 6d65 2c20 2023 2072 6f6f 6d20  e=name,  # room 
-000135e0: 6e61 6d65 0a20 2020 2020 2020 2020 2020  name.           
-000135f0: 2020 2020 2074 6f70 6963 3d74 6f70 6963       topic=topic
-00013600: 2c20 2023 2072 6f6f 6d20 746f 7069 630a  ,  # room topic.
-00013610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013620: 696e 6974 6961 6c5f 7374 6174 653d 696e  initial_state=in
-00013630: 6974 6961 6c5f 7374 6174 652c 0a20 2020  itial_state,.   
-00013640: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00013650: 2020 2020 2020 2023 2022 616c 6961 7331         # "alias1
-00013660: 2220 7769 6c6c 2063 7265 6174 6520 6120  " will create a 
-00013670: 2223 616c 6961 7331 3a65 7861 6d70 6c65  "#alias1:example
-00013680: 2e63 6f6d 220a 2020 2020 2020 2020 2020  .com".          
-00013690: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-000136a0: 7265 7370 2c20 526f 6f6d 4372 6561 7465  resp, RoomCreate
-000136b0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-000136c0: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
-000136d0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-000136e0: 2020 2020 2020 2020 2020 2245 3132 373a            "E127:
-000136f0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00013700: 2020 2020 2020 2022 526f 6f6d 5f63 7265         "Room_cre
-00013710: 6174 6520 6661 696c 6564 2077 6974 6820  ate failed with 
-00013720: 7265 7370 6f6e 7365 3a20 220a 2020 2020  response: ".    
-00013730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013740: 6622 7b70 7269 7661 6379 5f66 696c 7465  f"{privacy_filte
-00013750: 7228 7374 7228 7265 7370 2929 7d22 0a20  r(str(resp))}". 
-00013760: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00013770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013780: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
-00013790: 2031 0a20 2020 2020 2020 2020 2020 2065   1.            e
-000137a0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000137b0: 2020 2020 2069 6620 616c 6961 733a 0a20       if alias:. 
-000137c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000137d0: 2020 2066 756c 6c5f 616c 6961 7320 3d20     full_alias = 
-000137e0: 7368 6f72 745f 726f 6f6d 5f61 6c69 6173  short_room_alias
-000137f0: 5f74 6f5f 726f 6f6d 5f61 6c69 6173 280a  _to_room_alias(.
-00013800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013810: 2020 2020 2020 2020 616c 6961 732c 2063          alias, c
-00013820: 7265 6465 6e74 6961 6c73 0a20 2020 2020  redentials.     
-00013830: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00013840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013850: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00013860: 2020 2020 2020 2020 2020 2066 756c 6c5f             full_
-00013870: 616c 6961 7320 3d20 4e6f 6e65 0a20 2020  alias = None.   
-00013880: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
-00013890: 6c6f 672e 696e 666f 280a 2020 2020 2020  log.info(.      
-000138a0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-000138b0: 4372 6561 7465 6420 726f 6f6d 2077 6974  Created room wit
-000138c0: 6820 726f 6f6d 2069 6420 227b 7265 7370  h room id "{resp
-000138d0: 2e72 6f6f 6d5f 6964 7d22 2c20 270a 2020  .room_id}", '.  
-000138e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000138f0: 2020 6627 7368 6f72 7420 616c 6961 7320    f'short alias 
-00013900: 227b 7a6e 2861 6c69 6173 297d 222c 2027  "{zn(alias)}", '
-00013910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013920: 2020 2020 2066 2766 756c 6c20 616c 6961       f'full alia
-00013930: 7320 227b 7a6e 2866 756c 6c5f 616c 6961  s "{zn(full_alia
-00013940: 7329 7d22 2061 6e64 2027 0a20 2020 2020  s)}" and '.     
-00013950: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00013960: 2765 6e63 7279 7074 6564 2022 7b65 6e63  'encrypted "{enc
-00013970: 7279 7074 7d22 2e27 0a20 2020 2020 2020  rypt}".'.       
-00013980: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00013990: 2020 2020 2020 2020 2020 2023 206f 7574             # out
-000139a0: 7075 7420 666f 726d 6174 2063 6f6e 7472  put format contr
-000139b0: 6f6c 6c65 6420 7669 6120 2d2d 6f75 7470  olled via --outp
-000139c0: 7574 2066 6c61 670a 2020 2020 2020 2020  ut flag.        
-000139d0: 2020 2020 2020 2020 7465 7874 203d 2028          text = (
-000139e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000139f0: 2020 2020 2066 227b 7265 7370 2e72 6f6f       f"{resp.roo
-00013a00: 6d5f 6964 7d7b 5345 507d 7b7a 6e28 616c  m_id}{SEP}{zn(al
-00013a10: 6961 7329 7d7b 5345 507d 7b7a 6e28 6675  ias)}{SEP}{zn(fu
-00013a20: 6c6c 5f61 6c69 6173 297d 220a 2020 2020  ll_alias)}".    
-00013a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013a40: 6622 7b53 4550 7d7b 7a6e 286e 616d 6529  f"{SEP}{zn(name)
-00013a50: 7d7b 5345 507d 7b7a 6e28 746f 7069 6329  }{SEP}{zn(topic)
-00013a60: 7d7b 5345 507d 7b65 6e63 7279 7074 7d22  }{SEP}{encrypt}"
-00013a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013a80: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00013a90: 2020 2023 204f 626a 6563 7420 6f66 2074     # Object of t
-00013aa0: 7970 6520 526f 6f6d 4372 6561 7465 5265  ype RoomCreateRe
-00013ab0: 7370 6f6e 7365 2069 7320 6e6f 7420 4a53  sponse is not JS
-00013ac0: 4f4e 0a20 2020 2020 2020 2020 2020 2020  ON.             
-00013ad0: 2020 2023 2073 6572 6961 6c69 7a61 626c     # serializabl
-00013ae0: 652c 2068 656e 6365 2077 6520 7573 6520  e, hence we use 
-00013af0: 7468 6520 6469 6374 696f 6e61 7279 2e0a  the dictionary..
-00013b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b10: 6a73 6f6e 5f6d 6178 203d 2072 6573 702e  json_max = resp.
-00013b20: 5f5f 6469 6374 5f5f 0a20 2020 2020 2020  __dict__.       
-00013b30: 2020 2020 2020 2020 2023 2072 6573 7020           # resp 
-00013b40: 6861 7320 6f6e 6c79 2031 2075 7365 6675  has only 1 usefu
-00013b50: 6c20 7573 6566 756c 206d 656d 6265 723a  l useful member:
-00013b60: 2072 6f6f 6d5f 6964 0a20 2020 2020 2020   room_id.       
-00013b70: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
-00013b80: 782e 7570 6461 7465 287b 2261 6c69 6173  x.update({"alias
-00013b90: 223a 2061 6c69 6173 7d29 2020 2320 6164  ": alias})  # ad
-00013ba0: 6420 6469 6374 2069 7465 6d73 0a20 2020  d dict items.   
-00013bb0: 2020 2020 2020 2020 2020 2020 206a 736f               jso
-00013bc0: 6e5f 6d61 782e 7570 6461 7465 287b 2261  n_max.update({"a
-00013bd0: 6c69 6173 5f66 756c 6c22 3a20 6675 6c6c  lias_full": full
-00013be0: 5f61 6c69 6173 7d29 0a20 2020 2020 2020  _alias}).       
-00013bf0: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
-00013c00: 782e 7570 6461 7465 287b 226e 616d 6522  x.update({"name"
-00013c10: 3a20 6e61 6d65 7d29 0a20 2020 2020 2020  : name}).       
-00013c20: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
-00013c30: 782e 7570 6461 7465 287b 2274 6f70 6963  x.update({"topic
-00013c40: 223a 2074 6f70 6963 7d29 0a20 2020 2020  ": topic}).     
-00013c50: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-00013c60: 6d61 782e 7570 6461 7465 287b 2265 6e63  max.update({"enc
-00013c70: 7279 7074 6564 223a 2065 6e63 7279 7074  rypted": encrypt
-00013c80: 7d29 0a20 2020 2020 2020 2020 2020 2020  }).             
-00013c90: 2020 206a 736f 6e5f 203d 206a 736f 6e5f     json_ = json_
-00013ca0: 6d61 782e 636f 7079 2829 0a20 2020 2020  max.copy().     
-00013cb0: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-00013cc0: 2e70 6f70 2822 7472 616e 7370 6f72 745f  .pop("transport_
-00013cd0: 7265 7370 6f6e 7365 2229 0a20 2020 2020  response").     
-00013ce0: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-00013cf0: 7370 6563 203d 204e 6f6e 650a 2020 2020  spec = None.    
-00013d00: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00013d10: 745f 6f75 7470 7574 280a 2020 2020 2020  t_output(.      
-00013d20: 2020 2020 2020 2020 2020 2020 2020 6773                gs
-00013d30: 2e70 612e 6f75 7470 7574 2c0a 2020 2020  .pa.output,.    
-00013d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013d50: 7465 7874 3d74 6578 742c 0a20 2020 2020  text=text,.     
-00013d60: 2020 2020 2020 2020 2020 2020 2020 206a                 j
-00013d70: 736f 6e5f 3d6a 736f 6e5f 2c0a 2020 2020  son_=json_,.    
-00013d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013d90: 6a73 6f6e 5f6d 6178 3d6a 736f 6e5f 6d61  json_max=json_ma
-00013da0: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-00013db0: 2020 2020 2020 206a 736f 6e5f 7370 6563         json_spec
-00013dc0: 3d6a 736f 6e5f 7370 6563 2c0a 2020 2020  =json_spec,.    
-00013dd0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00013de0: 2020 2020 2020 2020 2020 696e 6465 7820            index 
-00013df0: 3d20 696e 6465 7820 2b20 310a 2020 2020  = index + 1.    
-00013e00: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-00013e10: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
-00013e20: 2e65 7272 6f72 2822 4531 3238 3a20 2220  .error("E128: " 
-00013e30: 2252 6f6f 6d20 6372 6561 7469 6f6e 2066  "Room creation f
-00013e40: 6169 6c65 642e 2053 6f72 7279 2e22 290a  ailed. Sorry.").
-00013e50: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
-00013e60: 6f75 6e74 202b 3d20 310a 2020 2020 2020  ount += 1.      
-00013e70: 2020 6773 2e6c 6f67 2e64 6562 7567 2822    gs.log.debug("
-00013e80: 4865 7265 2069 7320 7468 6520 7472 6163  Here is the trac
-00013e90: 6562 6163 6b2e 5c6e 2220 2b20 7472 6163  eback.\n" + trac
-00013ea0: 6562 6163 6b2e 666f 726d 6174 5f65 7863  eback.format_exc
-00013eb0: 2829 290a 0a0a 6173 796e 6320 6465 6620  ())...async def 
-00013ec0: 6163 7469 6f6e 5f72 6f6f 6d5f 6a6f 696e  action_room_join
-00013ed0: 2863 6c69 656e 742c 2063 7265 6465 6e74  (client, credent
-00013ee0: 6961 6c73 293a 0a20 2020 2022 2222 4a6f  ials):.    """Jo
-00013ef0: 696e 206f 6e65 206f 7220 6d75 6c74 6970  in one or multip
-00013f00: 6c65 2072 6f6f 6d73 2e22 2222 0a20 2020  le rooms.""".   
-00013f10: 2072 6f6f 6d73 203d 2067 732e 7061 2e72   rooms = gs.pa.r
-00013f20: 6f6f 6d5f 6a6f 696e 0a20 2020 2074 7279  oom_join.    try
-00013f30: 3a0a 2020 2020 2020 2020 666f 7220 726f  :.        for ro
-00013f40: 6f6d 5f69 6420 696e 2072 6f6f 6d73 3a0a  om_id in rooms:.
-00013f50: 2020 2020 2020 2020 2020 2020 2320 726f              # ro
-00013f60: 6f6d 5f69 6420 6361 6e20 6265 2023 726f  om_id can be #ro
-00013f70: 6f6d 416c 6961 7320 6f72 2021 726f 6f6d  omAlias or !room
-00013f80: 4964 0a20 2020 2020 2020 2020 2020 2067  Id.            g
-00013f90: 732e 6c6f 672e 6465 6275 6728 6627 5072  s.log.debug(f'Pr
-00013fa0: 6570 6172 696e 6720 746f 206a 6f69 6e20  eparing to join 
-00013fb0: 726f 6f6d 2022 7b72 6f6f 6d5f 6964 7d22  room "{room_id}"
-00013fc0: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
-00013fd0: 726f 6f6d 5f69 6420 3d20 6177 6169 7420  room_id = await 
-00013fe0: 6d61 705f 726f 6f6d 696e 666f 5f74 6f5f  map_roominfo_to_
-00013ff0: 726f 6f6d 6964 2863 6c69 656e 742c 2072  roomid(client, r
-00014000: 6f6f 6d5f 6964 290a 2020 2020 2020 2020  oom_id).        
-00014010: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-00014020: 2866 274a 6f69 6e69 6e67 2072 6f6f 6d20  (f'Joining room 
-00014030: 227b 726f 6f6d 5f69 647d 222e 2729 0a20  "{room_id}".'). 
-00014040: 2020 2020 2020 2020 2020 2072 6573 7020             resp 
-00014050: 3d20 6177 6169 7420 636c 6965 6e74 2e6a  = await client.j
-00014060: 6f69 6e28 726f 6f6d 5f69 6429 0a20 2020  oin(room_id).   
-00014070: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
-00014080: 7374 616e 6365 2872 6573 702c 204a 6f69  stance(resp, Joi
-00014090: 6e45 7272 6f72 293a 0a20 2020 2020 2020  nError):.       
-000140a0: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
-000140b0: 6572 726f 7228 0a20 2020 2020 2020 2020  error(.         
-000140c0: 2020 2020 2020 2020 2020 2022 4531 3239             "E129
-000140d0: 3a20 2220 6622 6a6f 696e 2066 6169 6c65  : " f"join faile
-000140e0: 6420 7769 7468 207b 7072 6976 6163 795f  d with {privacy_
-000140f0: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
-00014100: 297d 220a 2020 2020 2020 2020 2020 2020  )}".            
-00014110: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00014120: 2020 2020 2020 6773 2e65 7272 5f63 6f75        gs.err_cou
-00014130: 6e74 202b 3d20 310a 2020 2020 2020 2020  nt += 1.        
-00014140: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00014150: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-00014160: 2e69 6e66 6f28 6627 4a6f 696e 6564 2072  .info(f'Joined r
-00014170: 6f6f 6d20 227b 726f 6f6d 5f69 647d 2220  oom "{room_id}" 
-00014180: 7375 6363 6573 7366 756c 6c79 2e27 290a  successfully.').
-00014190: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-000141a0: 7469 6f6e 3a0a 2020 2020 2020 2020 6773  tion:.        gs
-000141b0: 2e6c 6f67 2e65 7272 6f72 2822 4531 3330  .log.error("E130
-000141c0: 3a20 2220 224a 6f69 6e69 6e67 2072 6f6f  : " "Joining roo
-000141d0: 6d73 2066 6169 6c65 642e 2053 6f72 7279  ms failed. Sorry
-000141e0: 2e22 290a 2020 2020 2020 2020 6773 2e65  .").        gs.e
-000141f0: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
-00014200: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-00014210: 7567 2822 4865 7265 2069 7320 7468 6520  ug("Here is the 
-00014220: 7472 6163 6562 6163 6b2e 5c6e 2220 2b20  traceback.\n" + 
-00014230: 7472 6163 6562 6163 6b2e 666f 726d 6174  traceback.format
-00014240: 5f65 7863 2829 290a 0a0a 6173 796e 6320  _exc())...async 
-00014250: 6465 6620 6163 7469 6f6e 5f72 6f6f 6d5f  def action_room_
-00014260: 6c65 6176 6528 636c 6965 6e74 2c20 6372  leave(client, cr
-00014270: 6564 656e 7469 616c 7329 3a0a 2020 2020  edentials):.    
-00014280: 2222 224c 6561 7665 206f 6e65 206f 7220  """Leave one or 
-00014290: 6d75 6c74 6970 6c65 2072 6f6f 6d73 2e22  multiple rooms."
-000142a0: 2222 0a20 2020 2072 6f6f 6d73 203d 2067  "".    rooms = g
-000142b0: 732e 7061 2e72 6f6f 6d5f 6c65 6176 650a  s.pa.room_leave.
-000142c0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-000142d0: 2066 6f72 2072 6f6f 6d5f 6964 2069 6e20   for room_id in 
-000142e0: 726f 6f6d 733a 0a20 2020 2020 2020 2020  rooms:.         
-000142f0: 2020 2023 2072 6f6f 6d5f 6964 2063 616e     # room_id can
-00014300: 2062 6520 2372 6f6f 6d41 6c69 6173 206f   be #roomAlias o
-00014310: 7220 2172 6f6f 6d49 640a 2020 2020 2020  r !roomId.      
-00014320: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-00014330: 7567 2866 2750 7265 7061 7269 6e67 2074  ug(f'Preparing t
-00014340: 6f20 6c65 6176 6520 726f 6f6d 2022 7b72  o leave room "{r
-00014350: 6f6f 6d5f 6964 7d22 2e27 290a 2020 2020  oom_id}".').    
-00014360: 2020 2020 2020 2020 726f 6f6d 5f69 6420          room_id 
-00014370: 3d20 6177 6169 7420 6d61 705f 726f 6f6d  = await map_room
-00014380: 696e 666f 5f74 6f5f 726f 6f6d 6964 2863  info_to_roomid(c
-00014390: 6c69 656e 742c 2072 6f6f 6d5f 6964 290a  lient, room_id).
-000143a0: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
-000143b0: 6f67 2e64 6562 7567 2866 274c 6561 7669  og.debug(f'Leavi
-000143c0: 6e67 2072 6f6f 6d20 227b 726f 6f6d 5f69  ng room "{room_i
-000143d0: 647d 222e 2729 0a20 2020 2020 2020 2020  d}".').         
-000143e0: 2020 2072 6573 7020 3d20 6177 6169 7420     resp = await 
-000143f0: 636c 6965 6e74 2e72 6f6f 6d5f 6c65 6176  client.room_leav
-00014400: 6528 726f 6f6d 5f69 6429 0a20 2020 2020  e(room_id).     
-00014410: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-00014420: 616e 6365 2872 6573 702c 2052 6f6f 6d4c  ance(resp, RoomL
-00014430: 6561 7665 4572 726f 7229 3a0a 2020 2020  eaveError):.    
-00014440: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
-00014450: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
-00014460: 2020 2020 2020 2020 2020 2020 2020 2245                "E
-00014470: 3133 313a 2022 2066 224c 6561 7665 2066  131: " f"Leave f
-00014480: 6169 6c65 6420 7769 7468 207b 7072 6976  ailed with {priv
-00014490: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
-000144a0: 6573 7029 297d 220a 2020 2020 2020 2020  esp))}".        
-000144b0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000144c0: 2020 2020 2020 2020 2020 6773 2e65 7272            gs.err
-000144d0: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
-000144e0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000144f0: 2020 2020 2020 2020 2020 2020 2020 6773                gs
-00014500: 2e6c 6f67 2e69 6e66 6f28 6627 4c65 6674  .log.info(f'Left
-00014510: 2072 6f6f 6d20 227b 726f 6f6d 5f69 647d   room "{room_id}
-00014520: 222e 2729 0a20 2020 2065 7863 6570 7420  ".').    except 
-00014530: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
-00014540: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
-00014550: 2245 3133 323a 2022 2022 526f 6f6d 206c  "E132: " "Room l
-00014560: 6561 7665 2066 6169 6c65 642e 2053 6f72  eave failed. Sor
-00014570: 7279 2e22 290a 2020 2020 2020 2020 6773  ry.").        gs
-00014580: 2e65 7272 5f63 6f75 6e74 202b 3d20 310a  .err_count += 1.
-00014590: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-000145a0: 6562 7567 2822 4865 7265 2069 7320 7468  ebug("Here is th
-000145b0: 6520 7472 6163 6562 6163 6b2e 5c6e 2220  e traceback.\n" 
-000145c0: 2b20 7472 6163 6562 6163 6b2e 666f 726d  + traceback.form
-000145d0: 6174 5f65 7863 2829 290a 0a0a 6173 796e  at_exc())...asyn
-000145e0: 6320 6465 6620 6163 7469 6f6e 5f72 6f6f  c def action_roo
-000145f0: 6d5f 666f 7267 6574 2863 6c69 656e 742c  m_forget(client,
-00014600: 2063 7265 6465 6e74 6961 6c73 293a 0a20   credentials):. 
-00014610: 2020 2022 2222 466f 7267 6574 206f 6e65     """Forget one
-00014620: 206f 7220 6d75 6c74 6970 6c65 2072 6f6f   or multiple roo
-00014630: 6d73 2e22 2222 0a20 2020 2072 6f6f 6d73  ms.""".    rooms
-00014640: 203d 2067 732e 7061 2e72 6f6f 6d5f 666f   = gs.pa.room_fo
-00014650: 7267 6574 0a20 2020 2074 7279 3a0a 2020  rget.    try:.  
-00014660: 2020 2020 2020 666f 7220 726f 6f6d 5f69        for room_i
-00014670: 6420 696e 2072 6f6f 6d73 3a0a 2020 2020  d in rooms:.    
-00014680: 2020 2020 2020 2020 2320 726f 6f6d 5f69          # room_i
-00014690: 6420 6361 6e20 6265 2023 726f 6f6d 416c  d can be #roomAl
-000146a0: 6961 7320 6f72 2021 726f 6f6d 4964 0a20  ias or !roomId. 
-000146b0: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-000146c0: 672e 6465 6275 6728 6627 5072 6570 6172  g.debug(f'Prepar
-000146d0: 696e 6720 746f 2066 6f72 6765 7420 726f  ing to forget ro
-000146e0: 6f6d 2022 7b72 6f6f 6d5f 6964 7d22 2e27  om "{room_id}".'
-000146f0: 290a 2020 2020 2020 2020 2020 2020 726f  ).            ro
-00014700: 6f6d 5f69 6420 3d20 6177 6169 7420 6d61  om_id = await ma
-00014710: 705f 726f 6f6d 696e 666f 5f74 6f5f 726f  p_roominfo_to_ro
-00014720: 6f6d 6964 2863 6c69 656e 742c 2072 6f6f  omid(client, roo
-00014730: 6d5f 6964 290a 2020 2020 2020 2020 2020  m_id).          
-00014740: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
-00014750: 2746 6f72 6765 7474 696e 6720 726f 6f6d  'Forgetting room
-00014760: 2022 7b72 6f6f 6d5f 6964 7d22 2e27 290a   "{room_id}".').
-00014770: 2020 2020 2020 2020 2020 2020 7265 7370              resp
-00014780: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
-00014790: 726f 6f6d 5f66 6f72 6765 7428 726f 6f6d  room_forget(room
-000147a0: 5f69 6429 0a20 2020 2020 2020 2020 2020  _id).           
-000147b0: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
-000147c0: 6573 702c 2052 6f6f 6d46 6f72 6765 7445  esp, RoomForgetE
-000147d0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-000147e0: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
-000147f0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-00014800: 2020 2020 2020 2020 2022 4531 3333 3a20           "E133: 
-00014810: 2220 6622 466f 7267 6574 2066 6169 6c65  " f"Forget faile
-00014820: 6420 7769 7468 207b 7072 6976 6163 795f  d with {privacy_
-00014830: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
-00014840: 297d 220a 2020 2020 2020 2020 2020 2020  )}".            
-00014850: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00014860: 2020 2020 2020 6773 2e65 7272 5f63 6f75        gs.err_cou
-00014870: 6e74 202b 3d20 310a 2020 2020 2020 2020  nt += 1.        
-00014880: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00014890: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-000148a0: 2e69 6e66 6f28 6627 466f 7267 6f74 2072  .info(f'Forgot r
-000148b0: 6f6f 6d20 227b 726f 6f6d 5f69 647d 222e  oom "{room_id}".
-000148c0: 2729 0a20 2020 2065 7863 6570 7420 4578  ').    except Ex
-000148d0: 6365 7074 696f 6e3a 0a20 2020 2020 2020  ception:.       
-000148e0: 2067 732e 6c6f 672e 6572 726f 7228 2245   gs.log.error("E
-000148f0: 3133 343a 2022 2022 526f 6f6d 2066 6f72  134: " "Room for
-00014900: 6765 7420 6661 696c 6564 2e20 536f 7272  get failed. Sorr
-00014910: 792e 2229 0a20 2020 2020 2020 2067 732e  y.").        gs.
-00014920: 6c6f 672e 6465 6275 6728 2248 6572 6520  log.debug("Here 
-00014930: 6973 2074 6865 2074 7261 6365 6261 636b  is the traceback
-00014940: 2e5c 6e22 202b 2074 7261 6365 6261 636b  .\n" + traceback
-00014950: 2e66 6f72 6d61 745f 6578 6328 2929 0a0a  .format_exc())..
-00014960: 0a61 7379 6e63 2064 6566 2061 6374 696f  .async def actio
-00014970: 6e5f 726f 6f6d 5f69 6e76 6974 6528 636c  n_room_invite(cl
-00014980: 6965 6e74 2c20 6372 6564 656e 7469 616c  ient, credential
-00014990: 7329 3a0a 2020 2020 2222 2249 6e76 6974  s):.    """Invit
-000149a0: 6520 6f6e 6520 6f72 206d 756c 7469 706c  e one or multipl
-000149b0: 6520 7573 6572 7320 746f 206f 6e65 206f  e users to one o
-000149c0: 7220 6d75 6c74 6970 6c65 2072 6f6f 6d73  r multiple rooms
-000149d0: 2e22 2222 0a20 2020 2072 6f6f 6d73 203d  .""".    rooms =
-000149e0: 2067 732e 7061 2e72 6f6f 6d5f 696e 7669   gs.pa.room_invi
-000149f0: 7465 0a20 2020 2075 7365 7273 203d 2067  te.    users = g
-00014a00: 732e 7061 2e75 7365 720a 2020 2020 7472  s.pa.user.    tr
-00014a10: 793a 0a20 2020 2020 2020 2066 6f72 2072  y:.        for r
-00014a20: 6f6f 6d5f 6964 2069 6e20 726f 6f6d 733a  oom_id in rooms:
-00014a30: 0a20 2020 2020 2020 2020 2020 2023 2072  .            # r
-00014a40: 6f6f 6d5f 6964 2063 616e 2062 6520 2372  oom_id can be #r
-00014a50: 6f6f 6d41 6c69 6173 206f 7220 2172 6f6f  oomAlias or !roo
-00014a60: 6d49 640a 2020 2020 2020 2020 2020 2020  mId.            
-00014a70: 6773 2e6c 6f67 2e64 6562 7567 2866 2750  gs.log.debug(f'P
-00014a80: 7265 7061 7269 6e67 2074 6f20 696e 7669  reparing to invi
-00014a90: 7465 2074 6f20 726f 6f6d 2022 7b72 6f6f  te to room "{roo
-00014aa0: 6d5f 6964 7d22 2e27 290a 2020 2020 2020  m_id}".').      
-00014ab0: 2020 2020 2020 726f 6f6d 5f69 6420 3d20        room_id = 
-00014ac0: 6177 6169 7420 6d61 705f 726f 6f6d 696e  await map_roomin
-00014ad0: 666f 5f74 6f5f 726f 6f6d 6964 2863 6c69  fo_to_roomid(cli
-00014ae0: 656e 742c 2072 6f6f 6d5f 6964 290a 2020  ent, room_id).  
-00014af0: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-00014b00: 2e64 6562 7567 2866 2749 6e76 6974 696e  .debug(f'Invitin
-00014b10: 6720 746f 2072 6f6f 6d20 227b 726f 6f6d  g to room "{room
-00014b20: 5f69 647d 222e 2729 0a20 2020 2020 2020  _id}".').       
-00014b30: 2020 2020 2066 6f72 2075 7365 7220 696e       for user in
-00014b40: 2075 7365 7273 3a0a 2020 2020 2020 2020   users:.        
-00014b50: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-00014b60: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
-00014b70: 2020 2020 2020 2020 2020 6627 496e 7669            f'Invi
-00014b80: 7469 6e67 2075 7365 7220 227b 7573 6572  ting user "{user
-00014b90: 7d22 2074 6f20 726f 6f6d 2077 6974 6820  }" to room with 
-00014ba0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00014bb0: 2020 2020 2020 6627 726f 6f6d 2061 6c69        f'room ali
-00014bc0: 6173 2022 7b72 6f6f 6d5f 6964 7d22 2e27  as "{room_id}".'
-00014bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014be0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00014bf0: 2020 2072 6573 7020 3d20 6177 6169 7420     resp = await 
-00014c00: 636c 6965 6e74 2e72 6f6f 6d5f 696e 7669  client.room_invi
-00014c10: 7465 2872 6f6f 6d5f 6964 2c20 7573 6572  te(room_id, user
-00014c20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00014c30: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00014c40: 7265 7370 2c20 526f 6f6d 496e 7669 7465  resp, RoomInvite
-00014c50: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-00014c60: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
-00014c70: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
-00014c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014c90: 2020 2245 3133 353a 2022 0a20 2020 2020    "E135: ".     
-00014ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014cb0: 2020 2066 2272 6f6f 6d5f 696e 7669 7465     f"room_invite
-00014cc0: 2066 6169 6c65 6420 7769 7468 207b 7072   failed with {pr
-00014cd0: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
-00014ce0: 2872 6573 7029 297d 220a 2020 2020 2020  (resp))}".      
-00014cf0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00014d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014d10: 2020 2020 6773 2e65 7272 5f63 6f75 6e74      gs.err_count
-00014d20: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
-00014d30: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00014d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014d50: 6773 2e6c 6f67 2e69 6e66 6f28 0a20 2020  gs.log.info(.   
-00014d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014d70: 2020 2020 2066 2755 7365 7220 227b 7573       f'User "{us
-00014d80: 6572 7d22 2077 6173 2073 7563 6365 7373  er}" was success
-00014d90: 6675 6c6c 7920 696e 7669 7465 6420 270a  fully invited '.
-00014da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014db0: 2020 2020 2020 2020 6627 746f 2072 6f6f          f'to roo
-00014dc0: 6d20 227b 726f 6f6d 5f69 647d 222e 270a  m "{room_id}".'.
-00014dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014de0: 2020 2020 290a 2020 2020 6578 6365 7074      ).    except
-00014df0: 2045 7863 6570 7469 6f6e 3a0a 2020 2020   Exception:.    
-00014e00: 2020 2020 6773 2e6c 6f67 2e65 7272 6f72      gs.log.error
-00014e10: 2822 4531 3336 3a20 2220 2255 7365 7220  ("E136: " "User 
-00014e20: 696e 7669 7465 2066 6169 6c65 642e 2053  invite failed. S
-00014e30: 6f72 7279 2e22 290a 2020 2020 2020 2020  orry.").        
-00014e40: 6773 2e6c 6f67 2e64 6562 7567 2822 4865  gs.log.debug("He
-00014e50: 7265 2069 7320 7468 6520 7472 6163 6562  re is the traceb
-00014e60: 6163 6b2e 5c6e 2220 2b20 7472 6163 6562  ack.\n" + traceb
-00014e70: 6163 6b2e 666f 726d 6174 5f65 7863 2829  ack.format_exc()
-00014e80: 290a 0a0a 6173 796e 6320 6465 6620 6163  )...async def ac
-00014e90: 7469 6f6e 5f72 6f6f 6d5f 6261 6e28 636c  tion_room_ban(cl
-00014ea0: 6965 6e74 2c20 6372 6564 656e 7469 616c  ient, credential
-00014eb0: 7329 3a0a 2020 2020 2222 2242 616e 206f  s):.    """Ban o
-00014ec0: 6e65 206f 7220 6d75 6c74 6970 6c65 2075  ne or multiple u
-00014ed0: 7365 7273 2066 726f 6d20 6f6e 6520 6f72  sers from one or
-00014ee0: 206d 756c 7469 706c 6520 726f 6f6d 732e   multiple rooms.
-00014ef0: 2222 220a 2020 2020 726f 6f6d 7320 3d20  """.    rooms = 
-00014f00: 6773 2e70 612e 726f 6f6d 5f62 616e 0a20  gs.pa.room_ban. 
-00014f10: 2020 2075 7365 7273 203d 2067 732e 7061     users = gs.pa
-00014f20: 2e75 7365 720a 2020 2020 7472 793a 0a20  .user.    try:. 
-00014f30: 2020 2020 2020 2066 6f72 2072 6f6f 6d5f         for room_
-00014f40: 6964 2069 6e20 726f 6f6d 733a 0a20 2020  id in rooms:.   
-00014f50: 2020 2020 2020 2020 2023 2072 6f6f 6d5f           # room_
-00014f60: 6964 2063 616e 2062 6520 2372 6f6f 6d41  id can be #roomA
-00014f70: 6c69 6173 206f 7220 2172 6f6f 6d49 640a  lias or !roomId.
-00014f80: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
-00014f90: 6f67 2e64 6562 7567 2866 2750 7265 7061  og.debug(f'Prepa
-00014fa0: 7269 6e67 2074 6f20 6261 6e20 696e 2072  ring to ban in r
-00014fb0: 6f6f 6d20 227b 726f 6f6d 5f69 647d 222e  oom "{room_id}".
-00014fc0: 2729 0a20 2020 2020 2020 2020 2020 2072  ').            r
-00014fd0: 6f6f 6d5f 6964 203d 2061 7761 6974 206d  oom_id = await m
-00014fe0: 6170 5f72 6f6f 6d69 6e66 6f5f 746f 5f72  ap_roominfo_to_r
-00014ff0: 6f6f 6d69 6428 636c 6965 6e74 2c20 726f  oomid(client, ro
-00015000: 6f6d 5f69 6429 0a20 2020 2020 2020 2020  om_id).         
-00015010: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-00015020: 6627 4261 6e6e 696e 6720 746f 2072 6f6f  f'Banning to roo
-00015030: 6d20 227b 726f 6f6d 5f69 647d 222e 2729  m "{room_id}".')
-00015040: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00015050: 2075 7365 7220 696e 2075 7365 7273 3a0a   user in users:.
-00015060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015070: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
-00015080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015090: 2020 6627 4261 6e6e 696e 6720 7573 6572    f'Banning user
-000150a0: 2022 7b75 7365 727d 2220 6672 6f6d 2072   "{user}" from r
-000150b0: 6f6f 6d20 7769 7468 2027 0a20 2020 2020  oom with '.     
-000150c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000150d0: 2772 6f6f 6d20 616c 6961 7320 227b 726f  'room alias "{ro
-000150e0: 6f6d 5f69 647d 222e 270a 2020 2020 2020  om_id}".'.      
-000150f0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00015100: 2020 2020 2020 2020 2020 2020 7265 7370              resp
-00015110: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
-00015120: 726f 6f6d 5f62 616e 2872 6f6f 6d5f 6964  room_ban(room_id
-00015130: 2c20 7573 6572 290a 2020 2020 2020 2020  , user).        
-00015140: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00015150: 7461 6e63 6528 7265 7370 2c20 526f 6f6d  tance(resp, Room
-00015160: 4261 6e45 7272 6f72 293a 0a20 2020 2020  BanError):.     
-00015170: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00015180: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
-00015190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000151a0: 2020 2020 2022 4531 3337 3a20 220a 2020       "E137: ".  
-000151b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000151c0: 2020 2020 2020 6622 726f 6f6d 5f62 616e        f"room_ban
-000151d0: 2066 6169 6c65 6420 7769 7468 207b 7072   failed with {pr
-000151e0: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
-000151f0: 2872 6573 7029 297d 220a 2020 2020 2020  (resp))}".      
-00015200: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00015210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015220: 2020 2020 6773 2e65 7272 5f63 6f75 6e74      gs.err_count
-00015230: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
-00015240: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00015250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015260: 6773 2e6c 6f67 2e69 6e66 6f28 0a20 2020  gs.log.info(.   
-00015270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015280: 2020 2020 2066 2755 7365 7220 227b 7573       f'User "{us
-00015290: 6572 7d22 2077 6173 2073 7563 6365 7373  er}" was success
-000152a0: 6675 6c6c 7920 6261 6e6e 6564 2027 0a20  fully banned '. 
-000152b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000152c0: 2020 2020 2020 2066 2766 726f 6d20 726f         f'from ro
-000152d0: 6f6d 2022 7b72 6f6f 6d5f 6964 7d22 2e27  om "{room_id}".'
-000152e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000152f0: 2020 2020 2029 0a20 2020 2065 7863 6570       ).    excep
-00015300: 7420 4578 6365 7074 696f 6e3a 0a20 2020  t Exception:.   
-00015310: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
-00015320: 7228 2245 3133 383a 2022 2022 5573 6572  r("E138: " "User
-00015330: 2062 616e 2066 6169 6c65 642e 2053 6f72   ban failed. Sor
-00015340: 7279 2e22 290a 2020 2020 2020 2020 6773  ry.").        gs
-00015350: 2e6c 6f67 2e64 6562 7567 2822 4865 7265  .log.debug("Here
-00015360: 2069 7320 7468 6520 7472 6163 6562 6163   is the tracebac
-00015370: 6b2e 5c6e 2220 2b20 7472 6163 6562 6163  k.\n" + tracebac
-00015380: 6b2e 666f 726d 6174 5f65 7863 2829 290a  k.format_exc()).
-00015390: 0a0a 6173 796e 6320 6465 6620 6163 7469  ..async def acti
-000153a0: 6f6e 5f72 6f6f 6d5f 756e 6261 6e28 636c  on_room_unban(cl
-000153b0: 6965 6e74 2c20 6372 6564 656e 7469 616c  ient, credential
-000153c0: 7329 3a0a 2020 2020 2222 2255 6e62 616e  s):.    """Unban
-000153d0: 206f 6e65 206f 7220 6d75 6c74 6970 6c65   one or multiple
-000153e0: 2075 7365 7273 2066 726f 6d20 6f6e 6520   users from one 
-000153f0: 6f72 206d 756c 7469 706c 6520 726f 6f6d  or multiple room
-00015400: 732e 2222 220a 2020 2020 726f 6f6d 7320  s.""".    rooms 
-00015410: 3d20 6773 2e70 612e 726f 6f6d 5f75 6e62  = gs.pa.room_unb
-00015420: 616e 0a20 2020 2075 7365 7273 203d 2067  an.    users = g
-00015430: 732e 7061 2e75 7365 720a 2020 2020 7472  s.pa.user.    tr
-00015440: 793a 0a20 2020 2020 2020 2066 6f72 2072  y:.        for r
-00015450: 6f6f 6d5f 6964 2069 6e20 726f 6f6d 733a  oom_id in rooms:
-00015460: 0a20 2020 2020 2020 2020 2020 2023 2072  .            # r
-00015470: 6f6f 6d5f 6964 2063 616e 2062 6520 2372  oom_id can be #r
-00015480: 6f6f 6d41 6c69 6173 206f 7220 2172 6f6f  oomAlias or !roo
-00015490: 6d49 640a 2020 2020 2020 2020 2020 2020  mId.            
-000154a0: 6773 2e6c 6f67 2e64 6562 7567 2866 2750  gs.log.debug(f'P
-000154b0: 7265 7061 7269 6e67 2074 6f20 756e 6261  reparing to unba
-000154c0: 6e20 696e 2072 6f6f 6d20 227b 726f 6f6d  n in room "{room
-000154d0: 5f69 647d 222e 2729 0a20 2020 2020 2020  _id}".').       
-000154e0: 2020 2020 2072 6f6f 6d5f 6964 203d 2061       room_id = a
-000154f0: 7761 6974 206d 6170 5f72 6f6f 6d69 6e66  wait map_roominf
-00015500: 6f5f 746f 5f72 6f6f 6d69 6428 636c 6965  o_to_roomid(clie
-00015510: 6e74 2c20 726f 6f6d 5f69 6429 0a20 2020  nt, room_id).   
-00015520: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
-00015530: 6465 6275 6728 6627 556e 6261 6e6e 696e  debug(f'Unbannin
-00015540: 6720 746f 2072 6f6f 6d20 227b 726f 6f6d  g to room "{room
-00015550: 5f69 647d 222e 2729 0a20 2020 2020 2020  _id}".').       
-00015560: 2020 2020 2066 6f72 2075 7365 7220 696e       for user in
-00015570: 2075 7365 7273 3a0a 2020 2020 2020 2020   users:.        
-00015580: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-00015590: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
-000155a0: 2020 2020 2020 2020 2020 6627 556e 6261            f'Unba
-000155b0: 6e6e 696e 6720 7573 6572 2022 7b75 7365  nning user "{use
-000155c0: 727d 2220 6672 6f6d 2072 6f6f 6d20 7769  r}" from room wi
-000155d0: 7468 2027 0a20 2020 2020 2020 2020 2020  th '.           
-000155e0: 2020 2020 2020 2020 2066 2772 6f6f 6d20           f'room 
-000155f0: 616c 6961 7320 227b 726f 6f6d 5f69 647d  alias "{room_id}
-00015600: 222e 270a 2020 2020 2020 2020 2020 2020  ".'.            
-00015610: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00015620: 2020 2020 2020 7265 7370 203d 2061 7761        resp = awa
-00015630: 6974 2063 6c69 656e 742e 726f 6f6d 5f75  it client.room_u
-00015640: 6e62 616e 2872 6f6f 6d5f 6964 2c20 7573  nban(room_id, us
-00015650: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
-00015660: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00015670: 6528 7265 7370 2c20 526f 6f6d 556e 6261  e(resp, RoomUnba
-00015680: 6e45 7272 6f72 293a 0a20 2020 2020 2020  nError):.       
-00015690: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
-000156a0: 6c6f 672e 6572 726f 7228 0a20 2020 2020  log.error(.     
-000156b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000156c0: 2020 2022 4531 3339 3a20 220a 2020 2020     "E139: ".    
-000156d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000156e0: 2020 2020 6622 726f 6f6d 5f75 6e62 616e      f"room_unban
-000156f0: 2066 6169 6c65 6420 7769 7468 207b 7072   failed with {pr
-00015700: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
-00015710: 2872 6573 7029 297d 220a 2020 2020 2020  (resp))}".      
-00015720: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00015730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015740: 2020 2020 6773 2e65 7272 5f63 6f75 6e74      gs.err_count
-00015750: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
-00015760: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00015770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015780: 6773 2e6c 6f67 2e69 6e66 6f28 0a20 2020  gs.log.info(.   
-00015790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000157a0: 2020 2020 2066 2755 7365 7220 227b 7573       f'User "{us
-000157b0: 6572 7d22 2077 6173 2073 7563 6365 7373  er}" was success
-000157c0: 6675 6c6c 7920 756e 6261 6e6e 6564 2027  fully unbanned '
-000157d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000157e0: 2020 2020 2020 2020 2066 2766 726f 6d20           f'from 
-000157f0: 726f 6f6d 2022 7b72 6f6f 6d5f 6964 7d22  room "{room_id}"
-00015800: 2e27 0a20 2020 2020 2020 2020 2020 2020  .'.             
-00015810: 2020 2020 2020 2029 0a20 2020 2065 7863         ).    exc
-00015820: 6570 7420 4578 6365 7074 696f 6e3a 0a20  ept Exception:. 
-00015830: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
-00015840: 726f 7228 2245 3134 303a 2022 2022 5573  ror("E140: " "Us
-00015850: 6572 2075 6e62 616e 2066 6169 6c65 642e  er unban failed.
-00015860: 2053 6f72 7279 2e22 290a 2020 2020 2020   Sorry.").      
-00015870: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
-00015880: 3d20 310a 2020 2020 2020 2020 6773 2e6c  = 1.        gs.l
-00015890: 6f67 2e64 6562 7567 2822 4865 7265 2069  og.debug("Here i
-000158a0: 7320 7468 6520 7472 6163 6562 6163 6b2e  s the traceback.
-000158b0: 5c6e 2220 2b20 7472 6163 6562 6163 6b2e  \n" + traceback.
-000158c0: 666f 726d 6174 5f65 7863 2829 290a 0a0a  format_exc())...
-000158d0: 6173 796e 6320 6465 6620 6163 7469 6f6e  async def action
-000158e0: 5f72 6f6f 6d5f 6b69 636b 2863 6c69 656e  _room_kick(clien
-000158f0: 742c 2063 7265 6465 6e74 6961 6c73 293a  t, credentials):
-00015900: 0a20 2020 2022 2222 4b69 636b 206f 6e65  .    """Kick one
-00015910: 206f 7220 6d75 6c74 6970 6c65 2075 7365   or multiple use
-00015920: 7273 2066 726f 6d20 6f6e 6520 6f72 206d  rs from one or m
-00015930: 756c 7469 706c 6520 726f 6f6d 732e 2222  ultiple rooms.""
-00015940: 220a 2020 2020 726f 6f6d 7320 3d20 6773  ".    rooms = gs
-00015950: 2e70 612e 726f 6f6d 5f6b 6963 6b0a 2020  .pa.room_kick.  
-00015960: 2020 7573 6572 7320 3d20 6773 2e70 612e    users = gs.pa.
-00015970: 7573 6572 0a20 2020 2074 7279 3a0a 2020  user.    try:.  
-00015980: 2020 2020 2020 666f 7220 726f 6f6d 5f69        for room_i
-00015990: 6420 696e 2072 6f6f 6d73 3a0a 2020 2020  d in rooms:.    
-000159a0: 2020 2020 2020 2020 2320 726f 6f6d 5f69          # room_i
-000159b0: 6420 6361 6e20 6265 2023 726f 6f6d 416c  d can be #roomAl
-000159c0: 6961 7320 6f72 2021 726f 6f6d 4964 0a20  ias or !roomId. 
-000159d0: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-000159e0: 672e 6465 6275 6728 6627 5072 6570 6172  g.debug(f'Prepar
-000159f0: 696e 6720 746f 206b 6963 6b69 6e67 206f  ing to kicking o
-00015a00: 6666 2072 6f6f 6d20 227b 726f 6f6d 5f69  ff room "{room_i
-00015a10: 647d 222e 2729 0a20 2020 2020 2020 2020  d}".').         
-00015a20: 2020 2072 6f6f 6d5f 6964 203d 2061 7761     room_id = awa
-00015a30: 6974 206d 6170 5f72 6f6f 6d69 6e66 6f5f  it map_roominfo_
-00015a40: 746f 5f72 6f6f 6d69 6428 636c 6965 6e74  to_roomid(client
-00015a50: 2c20 726f 6f6d 5f69 6429 0a20 2020 2020  , room_id).     
-00015a60: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-00015a70: 6275 6728 6627 4b69 636b 696e 6720 6f66  bug(f'Kicking of
-00015a80: 6620 726f 6f6d 2022 7b72 6f6f 6d5f 6964  f room "{room_id
-00015a90: 7d22 2e27 290a 2020 2020 2020 2020 2020  }".').          
-00015aa0: 2020 666f 7220 7573 6572 2069 6e20 7573    for user in us
-00015ab0: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
-00015ac0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-00015ad0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-00015ae0: 2020 2020 2020 2066 274b 6963 6b69 6e67         f'Kicking
-00015af0: 2075 7365 7220 227b 7573 6572 7d22 2066   user "{user}" f
-00015b00: 726f 6d20 726f 6f6d 2077 6974 6820 270a  rom room with '.
-00015b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015b20: 2020 2020 6627 726f 6f6d 2061 6c69 6173      f'room alias
-00015b30: 2022 7b72 6f6f 6d5f 6964 7d22 2e27 0a20   "{room_id}".'. 
-00015b40: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00015b50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015b60: 2072 6573 7020 3d20 6177 6169 7420 636c   resp = await cl
-00015b70: 6965 6e74 2e72 6f6f 6d5f 6b69 636b 2872  ient.room_kick(r
-00015b80: 6f6f 6d5f 6964 2c20 7573 6572 290a 2020  oom_id, user).  
-00015b90: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00015ba0: 2069 7369 6e73 7461 6e63 6528 7265 7370   isinstance(resp
-00015bb0: 2c20 526f 6f6d 4b69 636b 4572 726f 7229  , RoomKickError)
-00015bc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00015bd0: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
-00015be0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00015bf0: 2020 2020 2020 2020 2020 2020 2245 3134              "E14
-00015c00: 313a 2022 0a20 2020 2020 2020 2020 2020  1: ".           
-00015c10: 2020 2020 2020 2020 2020 2020 2066 2272               f"r
-00015c20: 6f6f 6d5f 6b69 636b 2066 6169 6c65 6420  oom_kick failed 
-00015c30: 7769 7468 207b 7072 6976 6163 795f 6669  with {privacy_fi
-00015c40: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
-00015c50: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00015c60: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00015c70: 2020 2020 2020 2020 2020 2020 6773 2e65              gs.e
-00015c80: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
-00015c90: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00015ca0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00015cb0: 2020 2020 2020 2020 6773 2e6c 6f67 2e69          gs.log.i
-00015cc0: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
-00015cd0: 2020 2020 2020 2020 2020 2020 2066 2755               f'U
-00015ce0: 7365 7220 227b 7573 6572 7d22 2077 6173  ser "{user}" was
-00015cf0: 2073 7563 6365 7373 6675 6c6c 7920 6b69   successfully ki
-00015d00: 636b 6564 2027 0a20 2020 2020 2020 2020  cked '.         
-00015d10: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00015d20: 2766 726f 6d20 726f 6f6d 2022 7b72 6f6f  'from room "{roo
-00015d30: 6d5f 6964 7d22 2e27 0a20 2020 2020 2020  m_id}".'.       
-00015d40: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00015d50: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-00015d60: 696f 6e3a 0a20 2020 2020 2020 2067 732e  ion:.        gs.
-00015d70: 6c6f 672e 6572 726f 7228 2245 3134 323a  log.error("E142:
-00015d80: 2022 2022 5573 6572 206b 6963 6b20 6661   " "User kick fa
-00015d90: 696c 6564 2e20 536f 7272 792e 2229 0a20  iled. Sorry."). 
-00015da0: 2020 2020 2020 2067 732e 6572 725f 636f         gs.err_co
-00015db0: 756e 7420 2b3d 2031 0a20 2020 2020 2020  unt += 1.       
-00015dc0: 2067 732e 6c6f 672e 6465 6275 6728 2248   gs.log.debug("H
-00015dd0: 6572 6520 6973 2074 6865 2074 7261 6365  ere is the trace
-00015de0: 6261 636b 2e5c 6e22 202b 2074 7261 6365  back.\n" + trace
-00015df0: 6261 636b 2e66 6f72 6d61 745f 6578 6328  back.format_exc(
-00015e00: 2929 0a0a 0a23 2061 6363 6f72 6469 6e67  ))...# according
-00015e10: 2074 6f20 6c69 6e74 6572 3a20 6675 6e63   to linter: func
-00015e20: 7469 6f6e 2069 7320 746f 6f20 636f 6d70  tion is too comp
-00015e30: 6c65 782c 2043 3930 310a 6173 796e 6320  lex, C901.async 
-00015e40: 6465 6620 7365 6e64 5f65 7665 6e74 2863  def send_event(c
-00015e50: 6c69 656e 742c 2072 6f6f 6d73 2c20 6576  lient, rooms, ev
-00015e60: 656e 7429 3a20 2023 206e 6f71 613a 2043  ent):  # noqa: C
-00015e70: 3930 310a 2020 2020 2222 2250 726f 6365  901.    """Proce
-00015e80: 7373 2065 7665 6e74 2e0a 0a20 2020 2041  ss event...    A
-00015e90: 7267 756d 656e 7473 3a0a 2020 2020 2d2d  rguments:.    --
-00015ea0: 2d2d 2d2d 2d2d 2d0a 2020 2020 636c 6965  -------.    clie
-00015eb0: 6e74 203a 2043 6c69 656e 740a 2020 2020  nt : Client.    
-00015ec0: 726f 6f6d 7320 3a20 6c69 7374 0a20 2020  rooms : list.   
-00015ed0: 2020 2020 206c 6973 7420 6f66 2072 6f6f       list of roo
-00015ee0: 6d5f 6964 2d73 0a20 2020 2065 7665 6e74  m_id-s.    event
-00015ef0: 203a 2073 7472 0a20 2020 2020 2020 2066   : str.        f
-00015f00: 696c 6520 6e61 6d65 206f 6620 6576 656e  ile name of even
-00015f10: 7420 6672 6f6d 202d 2d65 7665 6e74 2061  t from --event a
-00015f20: 7267 756d 656e 740a 0a20 2020 2022 2222  rgument..    """
-00015f30: 0a20 2020 2069 6620 6e6f 7420 726f 6f6d  .    if not room
-00015f40: 733a 0a20 2020 2020 2020 2067 732e 6c6f  s:.        gs.lo
-00015f50: 672e 696e 666f 280a 2020 2020 2020 2020  g.info(.        
-00015f60: 2020 2020 224e 6f20 726f 6f6d 7320 6172      "No rooms ar
-00015f70: 6520 6769 7665 6e2e 2054 6869 7320 7368  e given. This sh
-00015f80: 6f75 6c64 206e 6f74 2068 6170 7065 6e2e  ould not happen.
-00015f90: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-00015fa0: 4d61 7962 6520 796f 7572 2044 4d20 726f  Maybe your DM ro
-00015fb0: 6f6d 7320 7370 6563 6966 6965 6420 7669  oms specified vi
-00015fc0: 6120 2d2d 7573 6572 2077 6572 6520 6e6f  a --user were no
-00015fd0: 7420 666f 756e 642e 2022 0a20 2020 2020  t found. ".     
-00015fe0: 2020 2020 2020 2022 5468 6973 2066 696c         "This fil
-00015ff0: 6520 6973 2062 6569 6e67 2064 726f 7070  e is being dropp
-00016000: 6564 2061 6e64 204e 4f54 2073 656e 742e  ed and NOT sent.
-00016010: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
-00016020: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-00016030: 6966 2065 7665 6e74 203d 3d20 222d 223a  if event == "-":
-00016040: 2020 2320 2d20 6d65 616e 7320 7265 6164    # - means read
-00016050: 2061 7320 7069 7065 2066 726f 6d20 7374   as pipe from st
-00016060: 6469 6e0a 2020 2020 2020 2020 6a73 6f6e  din.        json
-00016070: 6461 7461 203d 2073 7973 2e73 7464 696e  data = sys.stdin
-00016080: 2e62 7566 6665 722e 7265 6164 2829 2e64  .buffer.read().d
-00016090: 6563 6f64 6528 2920 2023 2062 696e 6172  ecode()  # binar
-000160a0: 7920 7265 6164 0a20 2020 2065 6c73 653a  y read.    else:
-000160b0: 0a20 2020 2020 2020 2077 6974 6820 6f70  .        with op
-000160c0: 656e 2865 7665 6e74 2c20 2272 2229 2061  en(event, "r") a
-000160d0: 7320 6669 6c65 3a0a 2020 2020 2020 2020  s file:.        
-000160e0: 2020 2020 6a73 6f6e 6461 7461 203d 2066      jsondata = f
-000160f0: 696c 652e 7265 6164 2829 0a20 2020 2067  ile.read().    g
-00016100: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
-00016110: 2020 2020 2066 227b 6c65 6e28 6a73 6f6e       f"{len(json
-00016120: 6461 7461 297d 2062 7974 6573 206f 6620  data)} bytes of 
-00016130: 6576 656e 7420 6461 7461 2072 6561 6420  event data read 
-00016140: 6672 6f6d 2066 696c 6520 7b65 7665 6e74  from file {event
-00016150: 7d2e 220a 2020 2020 290a 2020 2020 6773  }.".    ).    gs
-00016160: 2e6c 6f67 2e64 6562 7567 2866 2245 7665  .log.debug(f"Eve
-00016170: 6e74 207b 6576 656e 747d 2063 6f6e 7461  nt {event} conta
-00016180: 696e 7320 7468 6973 204a 534f 4e20 6461  ins this JSON da
-00016190: 7461 3a20 7b6a 736f 6e64 6174 617d 2229  ta: {jsondata}")
-000161a0: 0a0a 2020 2020 6966 206e 6f74 206a 736f  ..    if not jso
-000161b0: 6e64 6174 612e 7374 7269 7028 293a 0a20  ndata.strip():. 
-000161c0: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-000161d0: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
-000161e0: 2022 4576 656e 7420 6973 2065 6d70 7479   "Event is empty
-000161f0: 2e20 5468 6973 2065 7665 6e74 2069 7320  . This event is 
-00016200: 6265 696e 6720 6472 6f70 7065 6420 616e  being dropped an
-00016210: 6420 4e4f 5420 7365 6e74 2e22 0a20 2020  d NOT sent.".   
-00016220: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
-00016230: 6574 7572 6e0a 0a20 2020 2074 7279 3a0a  eturn..    try:.
-00016240: 2020 2020 2020 2020 636f 6e74 656e 745f          content_
-00016250: 6a73 6f6e 203d 206a 736f 6e2e 6c6f 6164  json = json.load
-00016260: 7328 6a73 6f6e 6461 7461 290a 2020 2020  s(jsondata).    
-00016270: 2020 2020 6d65 7373 6167 655f 7479 7065      message_type
-00016280: 203d 2063 6f6e 7465 6e74 5f6a 736f 6e5b   = content_json[
-00016290: 2274 7970 6522 5d0a 2020 2020 2020 2020  "type"].        
-000162a0: 636f 6e74 656e 7420 3d20 636f 6e74 656e  content = conten
-000162b0: 745f 6a73 6f6e 5b22 636f 6e74 656e 7422  t_json["content"
-000162c0: 5d0a 2020 2020 6578 6365 7074 2045 7863  ].    except Exc
-000162d0: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-000162e0: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
-000162f0: 2020 2020 2020 2020 2020 2245 3134 333a            "E143:
-00016300: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-00016310: 4576 656e 7420 6973 206e 6f74 2061 2076  Event is not a v
-00016320: 616c 6964 204a 534f 4e20 6f62 6a65 6374  alid JSON object
-00016330: 206f 7220 6e6f 7420 6f66 204d 6174 7269   or not of Matri
-00016340: 7820 4a53 4f4e 2066 6f72 6d61 742e 2022  x JSON format. "
-00016350: 0a20 2020 2020 2020 2020 2020 2022 5468  .            "Th
-00016360: 6973 2065 7665 6e74 2069 7320 6265 696e  is event is bein
-00016370: 6720 6472 6f70 7065 6420 616e 6420 4e4f  g dropped and NO
-00016380: 5420 7365 6e74 2e22 0a20 2020 2020 2020  T sent.".       
-00016390: 2029 0a20 2020 2020 2020 2067 732e 6572   ).        gs.er
-000163a0: 725f 636f 756e 7420 2b3d 2031 0a20 2020  r_count += 1.   
-000163b0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-000163c0: 6728 2248 6572 6520 6973 2074 6865 2074  g("Here is the t
-000163d0: 7261 6365 6261 636b 2e5c 6e22 202b 2074  raceback.\n" + t
-000163e0: 7261 6365 6261 636b 2e66 6f72 6d61 745f  raceback.format_
-000163f0: 6578 6328 2929 0a20 2020 2020 2020 2072  exc()).        r
-00016400: 6574 7572 6e0a 0a20 2020 2074 7279 3a0a  eturn..    try:.
-00016410: 2020 2020 2020 2020 666f 7220 726f 6f6d          for room
-00016420: 5f69 6420 696e 2072 6f6f 6d73 3a0a 2020  _id in rooms:.  
-00016430: 2020 2020 2020 2020 2020 726f 6f6d 5f69            room_i
-00016440: 6420 3d20 6177 6169 7420 6d61 705f 726f  d = await map_ro
-00016450: 6f6d 696e 666f 5f74 6f5f 726f 6f6d 6964  ominfo_to_roomid
-00016460: 2863 6c69 656e 742c 2072 6f6f 6d5f 6964  (client, room_id
-00016470: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00016480: 7370 203d 2061 7761 6974 2063 6c69 656e  sp = await clien
-00016490: 742e 726f 6f6d 5f73 656e 6428 0a20 2020  t.room_send(.   
-000164a0: 2020 2020 2020 2020 2020 2020 2072 6f6f               roo
-000164b0: 6d5f 6964 2c20 6d65 7373 6167 655f 7479  m_id, message_ty
-000164c0: 7065 3d6d 6573 7361 6765 5f74 7970 652c  pe=message_type,
-000164d0: 2063 6f6e 7465 6e74 3d63 6f6e 7465 6e74   content=content
-000164e0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-000164f0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-00016500: 696e 7374 616e 6365 2872 6573 702c 2052  instance(resp, R
-00016510: 6f6f 6d53 656e 6445 7272 6f72 293a 0a20  oomSendError):. 
-00016520: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00016530: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
-00016540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016550: 2022 4531 3434 3a20 220a 2020 2020 2020   "E144: ".      
-00016560: 2020 2020 2020 2020 2020 2020 2020 2272                "r
-00016570: 6f6f 6d5f 7365 6e64 2066 6169 6c65 6420  oom_send failed 
-00016580: 7769 7468 2065 7272 6f72 2022 0a20 2020  with error ".   
-00016590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000165a0: 2066 2227 7b70 7269 7661 6379 5f66 696c   f"'{privacy_fil
-000165b0: 7465 7228 7374 7228 7265 7370 2929 7d27  ter(str(resp))}'
-000165c0: 2e22 0a20 2020 2020 2020 2020 2020 2020  .".             
-000165d0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-000165e0: 2020 2020 2023 2067 732e 6572 725f 636f       # gs.err_co
-000165f0: 756e 7420 2b3d 2031 2023 206e 6f74 206e  unt += 1 # not n
-00016600: 6565 6465 642c 2077 696c 6c20 7261 6973  eeded, will rais
-00016610: 6520 6578 6365 7074 696f 6e0a 2020 2020  e exception.    
-00016620: 2020 2020 2020 2020 2020 2020 2320 696e              # in
-00016630: 2066 6f6c 6c6f 7769 6e67 206c 696e 6520   following line 
-00016640: 6f66 2063 6f64 650a 2020 2020 2020 2020  of code.        
-00016650: 2020 2020 6773 2e6c 6f67 2e69 6e66 6f28      gs.log.info(
-00016660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016670: 2066 2754 6869 7320 6576 656e 7420 7761   f'This event wa
-00016680: 7320 7365 6e74 3a20 227b 6576 656e 747d  s sent: "{event}
-00016690: 2220 746f 2072 6f6f 6d20 227b 7265 7370  " to room "{resp
-000166a0: 2e72 6f6f 6d5f 6964 7d22 2027 0a20 2020  .room_id}" '.   
-000166b0: 2020 2020 2020 2020 2020 2020 2066 2761               f'a
-000166c0: 7320 6576 656e 7420 227b 7265 7370 2e65  s event "{resp.e
-000166d0: 7665 6e74 5f69 647d 222e 270a 2020 2020  vent_id}".'.    
-000166e0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000166f0: 2020 2020 2020 6966 2067 732e 7061 2e70        if gs.pa.p
-00016700: 7269 6e74 5f65 7665 6e74 5f69 643a 0a20  rint_event_id:. 
-00016710: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00016720: 206f 7574 7075 7420 666f 726d 6174 2063   output format c
-00016730: 6f6e 7472 6f6c 6c65 6420 7669 6120 2d2d  ontrolled via --
-00016740: 6f75 7470 7574 2066 6c61 670a 2020 2020  output flag.    
-00016750: 2020 2020 2020 2020 2020 2020 7465 7874              text
-00016760: 203d 2066 227b 7265 7370 2e65 7665 6e74   = f"{resp.event
-00016770: 5f69 647d 7b53 4550 7d7b 7265 7370 2e72  _id}{SEP}{resp.r
-00016780: 6f6f 6d5f 6964 7d7b 5345 507d 7b65 7665  oom_id}{SEP}{eve
-00016790: 6e74 7d22 0a20 2020 2020 2020 2020 2020  nt}".           
-000167a0: 2020 2020 2023 204f 626a 6563 7420 6f66       # Object of
-000167b0: 2074 7970 6520 526f 6f6d 4372 6561 7465   type RoomCreate
-000167c0: 5265 7370 6f6e 7365 2069 7320 6e6f 7420  Response is not 
-000167d0: 4a53 4f4e 0a20 2020 2020 2020 2020 2020  JSON.           
-000167e0: 2020 2020 2023 2073 6572 6961 6c69 7a61       # serializa
-000167f0: 626c 652c 2068 656e 6365 2077 6520 7573  ble, hence we us
-00016800: 6520 7468 6520 6469 6374 696f 6e61 7279  e the dictionary
-00016810: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00016820: 2020 6a73 6f6e 5f6d 6178 203d 2072 6573    json_max = res
-00016830: 702e 5f5f 6469 6374 5f5f 0a20 2020 2020  p.__dict__.     
-00016840: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-00016850: 6d61 782e 7570 6461 7465 287b 2265 7665  max.update({"eve
-00016860: 6e74 223a 2065 7665 6e74 7d29 2020 2320  nt": event})  # 
-00016870: 6164 6420 6469 6374 2069 7465 6d73 0a20  add dict items. 
-00016880: 2020 2020 2020 2020 2020 2020 2020 206a                 j
-00016890: 736f 6e5f 203d 206a 736f 6e5f 6d61 782e  son_ = json_max.
-000168a0: 636f 7079 2829 0a20 2020 2020 2020 2020  copy().         
-000168b0: 2020 2020 2020 206a 736f 6e5f 2e70 6f70         json_.pop
-000168c0: 2822 7472 616e 7370 6f72 745f 7265 7370  ("transport_resp
-000168d0: 6f6e 7365 2229 0a20 2020 2020 2020 2020  onse").         
-000168e0: 2020 2020 2020 206a 736f 6e5f 7370 6563         json_spec
-000168f0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00016900: 2020 2020 2020 2020 7072 696e 745f 6f75          print_ou
-00016910: 7470 7574 280a 2020 2020 2020 2020 2020  tput(.          
-00016920: 2020 2020 2020 2020 2020 6773 2e70 612e            gs.pa.
-00016930: 6f75 7470 7574 2c0a 2020 2020 2020 2020  output,.        
-00016940: 2020 2020 2020 2020 2020 2020 7465 7874              text
-00016950: 3d74 6578 742c 0a20 2020 2020 2020 2020  =text,.         
-00016960: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-00016970: 3d6a 736f 6e5f 2c0a 2020 2020 2020 2020  =json_,.        
-00016980: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-00016990: 5f6d 6178 3d6a 736f 6e5f 6d61 782c 0a20  _max=json_max,. 
-000169a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000169b0: 2020 206a 736f 6e5f 7370 6563 3d6a 736f     json_spec=jso
-000169c0: 6e5f 7370 6563 2c0a 2020 2020 2020 2020  n_spec,.        
-000169d0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000169e0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-000169f0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-00016a00: 2020 2020 6627 5468 6973 2065 7665 6e74      f'This event
-00016a10: 2077 6173 2073 656e 743a 2022 7b65 7665   was sent: "{eve
-00016a20: 6e74 7d22 2028 7b63 6f6e 7465 6e74 7d29  nt}" ({content})
-00016a30: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00016a40: 2020 2066 2774 6f20 726f 6f6d 2022 7b72     f'to room "{r
-00016a50: 6f6f 6d5f 6964 7d22 2e20 270a 2020 2020  oom_id}". '.    
-00016a60: 2020 2020 2020 2020 2020 2020 6622 5265              f"Re
-00016a70: 7370 6f6e 7365 3a20 6576 656e 745f 6964  sponse: event_id
-00016a80: 3d7b 7265 7370 2e65 7665 6e74 5f69 647d  ={resp.event_id}
-00016a90: 2c20 726f 6f6d 5f69 643d 7b72 6573 702e  , room_id={resp.
-00016aa0: 726f 6f6d 5f69 647d 2c20 220a 2020 2020  room_id}, ".    
-00016ab0: 2020 2020 2020 2020 2020 2020 6622 6675              f"fu
-00016ac0: 6c6c 2072 6573 706f 6e73 653a 207b 7072  ll response: {pr
-00016ad0: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
-00016ae0: 2872 6573 7029 297d 2e20 220a 2020 2020  (resp))}. ".    
-00016af0: 2020 2020 2020 2020 290a 2020 2020 6578          ).    ex
-00016b00: 6365 7074 2045 7863 6570 7469 6f6e 3a0a  cept Exception:.
-00016b10: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
-00016b20: 7272 6f72 2822 4531 3435 3a20 2220 6622  rror("E145: " f"
-00016b30: 4576 656e 7420 7365 6e64 206f 6620 6669  Event send of fi
-00016b40: 6c65 207b 6576 656e 747d 2066 6169 6c65  le {event} faile
-00016b50: 642e 2053 6f72 7279 2e22 290a 2020 2020  d. Sorry.").    
-00016b60: 2020 2020 6773 2e65 7272 5f63 6f75 6e74      gs.err_count
-00016b70: 202b 3d20 310a 2020 2020 2020 2020 6773   += 1.        gs
-00016b80: 2e6c 6f67 2e64 6562 7567 2822 4865 7265  .log.debug("Here
-00016b90: 2069 7320 7468 6520 7472 6163 6562 6163   is the tracebac
-00016ba0: 6b2e 5c6e 2220 2b20 7472 6163 6562 6163  k.\n" + tracebac
-00016bb0: 6b2e 666f 726d 6174 5f65 7863 2829 290a  k.format_exc()).
-00016bc0: 0a0a 2320 6163 636f 7264 696e 6720 746f  ..# according to
-00016bd0: 206c 696e 7465 723a 2066 756e 6374 696f   linter: functio
-00016be0: 6e20 6973 2074 6f6f 2063 6f6d 706c 6578  n is too complex
-00016bf0: 2c20 4339 3031 0a61 7379 6e63 2064 6566  , C901.async def
-00016c00: 2073 656e 645f 6669 6c65 2863 6c69 656e   send_file(clien
-00016c10: 742c 2072 6f6f 6d73 2c20 6669 6c65 293a  t, rooms, file):
-00016c20: 2020 2320 6e6f 7161 3a20 4339 3031 0a20    # noqa: C901. 
-00016c30: 2020 2022 2222 5072 6f63 6573 7320 6669     """Process fi
-00016c40: 6c65 2e0a 0a20 2020 2055 706c 6f61 6420  le...    Upload 
-00016c50: 6669 6c65 2074 6f20 7365 7276 6572 2061  file to server a
-00016c60: 6e64 2074 6865 6e20 7365 6e64 206c 696e  nd then send lin
-00016c70: 6b20 746f 2072 6f6f 6d73 2e0a 2020 2020  k to rooms..    
-00016c80: 576f 726b 7320 616e 6420 7465 7374 6564  Works and tested
-00016c90: 2066 6f72 202e 7064 662c 202e 7478 742c   for .pdf, .txt,
-00016ca0: 202e 6f67 672c 202e 7761 762e 0a20 2020   .ogg, .wav..   
-00016cb0: 2041 6c6c 2074 6865 7365 2066 696c 6520   All these file 
-00016cc0: 7479 7065 7320 6172 6520 7472 6561 7465  types are treate
-00016cd0: 6420 7468 6520 7361 6d65 2e0a 0a20 2020  d the same...   
-00016ce0: 2044 6f20 6e6f 7420 7573 6520 7468 6973   Do not use this
-00016cf0: 2066 756e 6374 696f 6e20 666f 7220 696d   function for im
-00016d00: 6167 6573 2e0a 2020 2020 5573 6520 7468  ages..    Use th
-00016d10: 6520 7365 6e64 5f69 6d61 6765 2829 2066  e send_image() f
-00016d20: 756e 6374 696f 6e20 666f 7220 696d 6167  unction for imag
-00016d30: 6573 2e0a 0a20 2020 204d 6174 7269 7820  es...    Matrix 
-00016d40: 6861 7320 7479 7065 7320 666f 7220 6175  has types for au
-00016d50: 6469 6f20 616e 6420 7669 6465 6f20 2861  dio and video (a
-00016d60: 6e64 2069 6d61 6765 2061 6e64 2066 696c  nd image and fil
-00016d70: 6529 2e0a 2020 2020 5365 653a 2022 6d73  e)..    See: "ms
-00016d80: 6774 7970 6522 203d 3d20 226d 2e69 6d61  gtype" == "m.ima
-00016d90: 6765 222c 206d 2e61 7564 696f 2c20 6d2e  ge", m.audio, m.
-00016da0: 7669 6465 6f2c 206d 2e66 696c 650a 0a20  video, m.file.. 
-00016db0: 2020 2041 7267 756d 656e 7473 3a0a 2020     Arguments:.  
-00016dc0: 2020 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020    ---------.    
-00016dd0: 636c 6965 6e74 203a 2043 6c69 656e 740a  client : Client.
-00016de0: 2020 2020 726f 6f6d 7320 3a20 6c69 7374      rooms : list
-00016df0: 0a20 2020 2020 2020 206c 6973 7420 6f66  .        list of
-00016e00: 2072 6f6f 6d5f 6964 2d73 0a20 2020 2066   room_id-s.    f
-00016e10: 696c 6520 3a20 7374 720a 2020 2020 2020  ile : str.      
-00016e20: 2020 6669 6c65 206e 616d 6520 6f66 2066    file name of f
-00016e30: 696c 6520 6672 6f6d 202d 2d66 696c 6520  ile from --file 
-00016e40: 6172 6775 6d65 6e74 0a0a 2020 2020 5468  argument..    Th
-00016e50: 6973 2069 7320 6120 776f 726b 696e 6720  is is a working 
-00016e60: 6578 616d 706c 6520 666f 7220 6120 5044  example for a PD
-00016e70: 4620 6669 6c65 2e0a 2020 2020 4974 2063  F file..    It c
-00016e80: 616e 2062 6520 7669 6577 6564 206f 7220  an be viewed or 
-00016e90: 646f 776e 6c6f 6164 6564 2066 726f 6d3a  downloaded from:
-00016ea0: 0a20 2020 2068 7474 7073 3a2f 2f6d 6174  .    https://mat
-00016eb0: 7269 782e 6578 616d 706c 652e 636f 6d2f  rix.example.com/
-00016ec0: 5f6d 6174 7269 782f 6d65 6469 612f 7230  _matrix/media/r0
-00016ed0: 2f64 6f77 6e6c 6f61 642f 0a20 2020 2020  /download/.     
-00016ee0: 2020 2065 7861 6d70 6c65 2e63 6f6d 2f53     example.com/S
-00016ef0: 6f6d 6553 7472 616e 6765 5572 694b 6579  omeStrangeUriKey
-00016f00: 0a20 2020 207b 0a20 2020 2020 2020 2022  .    {.        "
-00016f10: 7479 7065 223a 2022 6d2e 726f 6f6d 2e6d  type": "m.room.m
-00016f20: 6573 7361 6765 222c 0a20 2020 2020 2020  essage",.       
-00016f30: 2022 7365 6e64 6572 223a 2022 4073 6f6d   "sender": "@som
-00016f40: 6575 7365 723a 6578 616d 706c 652e 636f  euser:example.co
-00016f50: 6d22 2c0a 2020 2020 2020 2020 2263 6f6e  m",.        "con
-00016f60: 7465 6e74 223a 207b 0a20 2020 2020 2020  tent": {.       
-00016f70: 2020 2020 2022 626f 6479 223a 2022 6578       "body": "ex
-00016f80: 616d 706c 652e 7064 6622 2c0a 2020 2020  ample.pdf",.    
-00016f90: 2020 2020 2020 2020 2269 6e66 6f22 3a20          "info": 
-00016fa0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00016fb0: 2020 2273 697a 6522 3a20 3633 3031 3233    "size": 630123
-00016fc0: 342c 0a20 2020 2020 2020 2020 2020 2020  4,.             
-00016fd0: 2020 2022 6d69 6d65 7479 7065 223a 2022     "mimetype": "
-00016fe0: 6170 706c 6963 6174 696f 6e2f 7064 6622  application/pdf"
-00016ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017000: 207d 2c0a 2020 2020 2020 2020 2020 2020   },.            
-00017010: 226d 7367 7479 7065 223a 2022 6d2e 6669  "msgtype": "m.fi
-00017020: 6c65 222c 0a20 2020 2020 2020 2020 2020  le",.           
-00017030: 2022 7572 6c22 3a20 226d 7863 3a2f 2f65   "url": "mxc://e
-00017040: 7861 6d70 6c65 2e63 6f6d 2f53 6f6d 6553  xample.com/SomeS
-00017050: 7472 616e 6765 5572 694b 6579 220a 2020  trangeUriKey".  
-00017060: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-00017070: 2022 6f72 6967 696e 5f73 6572 7665 725f   "origin_server_
-00017080: 7473 223a 2031 3539 3531 3030 3030 3030  ts": 15951000000
-00017090: 3030 2c0a 2020 2020 2020 2020 2275 6e73  00,.        "uns
-000170a0: 6967 6e65 6422 3a20 7b0a 2020 2020 2020  igned": {.      
-000170b0: 2020 2020 2020 2261 6765 223a 2031 3030        "age": 100
-000170c0: 302c 0a20 2020 2020 2020 2020 2020 2022  0,.            "
-000170d0: 7472 616e 7361 6374 696f 6e5f 6964 223a  transaction_id":
-000170e0: 2022 536f 6d65 5478 4964 3031 3233 3435   "SomeTxId012345
-000170f0: 3637 220a 2020 2020 2020 2020 7d2c 0a20  67".        },. 
-00017100: 2020 2020 2020 2022 6576 656e 745f 6964         "event_id
-00017110: 223a 2022 2453 6f6d 6545 7665 6e74 4964  ": "$SomeEventId
-00017120: 3031 3233 3435 3637 3738 3941 6263 6465  01234567789Abcde
-00017130: 6630 3132 3334 3536 3738 222c 0a20 2020  f012345678",.   
-00017140: 2020 2020 2022 726f 6f6d 5f69 6422 3a20       "room_id": 
-00017150: 2221 536f 6d65 526f 6f6d 4964 3a65 7861  "!SomeRoomId:exa
-00017160: 6d70 6c65 2e63 6f6d 220a 2020 2020 7d0a  mple.com".    }.
-00017170: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
-00017180: 6e6f 7420 726f 6f6d 733a 0a20 2020 2020  not rooms:.     
-00017190: 2020 2067 732e 6c6f 672e 696e 666f 280a     gs.log.info(.
-000171a0: 2020 2020 2020 2020 2020 2020 224e 6f20              "No 
-000171b0: 726f 6f6d 7320 6172 6520 6769 7665 6e2e  rooms are given.
-000171c0: 2054 6869 7320 7368 6f75 6c64 206e 6f74   This should not
-000171d0: 2068 6170 7065 6e2e 2022 0a20 2020 2020   happen. ".     
-000171e0: 2020 2020 2020 2022 4d61 7962 6520 796f         "Maybe yo
-000171f0: 7572 2044 4d20 726f 6f6d 7320 7370 6563  ur DM rooms spec
-00017200: 6966 6965 6420 7669 6120 2d2d 7573 6572  ified via --user
-00017210: 2077 6572 6520 6e6f 7420 666f 756e 642e   were not found.
-00017220: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-00017230: 5468 6973 2066 696c 6520 6973 2062 6569  This file is bei
-00017240: 6e67 2064 726f 7070 6564 2061 6e64 204e  ng dropped and N
-00017250: 4f54 2073 656e 742e 220a 2020 2020 2020  OT sent.".      
-00017260: 2020 290a 2020 2020 2020 2020 7265 7475    ).        retu
-00017270: 726e 0a0a 2020 2020 2320 666f 7220 6d6f  rn..    # for mo
-00017280: 7265 2063 6f6d 6d65 6e74 7320 6f6e 2068  re comments on h
-00017290: 6f77 2074 6f20 7472 6561 7420 7069 7065  ow to treat pipe
-000172a0: 206f 6e20 7374 6469 6e20 706c 6561 7365   on stdin please
-000172b0: 2072 6561 6420 7468 650a 2020 2020 2320   read the.    # 
-000172c0: 636f 6d6d 656e 7473 2069 6e20 7365 6e64  comments in send
-000172d0: 5f69 6d61 6765 2829 0a0a 2020 2020 6966  _image()..    if
-000172e0: 2066 696c 6520 3d3d 2022 2d22 3a20 2023   file == "-":  #
-000172f0: 202d 206d 6561 6e73 2072 6561 6420 6173   - means read as
-00017300: 2070 6970 6520 6672 6f6d 2073 7464 696e   pipe from stdin
-00017310: 0a20 2020 2020 2020 2069 7350 6970 6520  .        isPipe 
-00017320: 3d20 5472 7565 0a20 2020 2020 2020 2066  = True.        f
-00017330: 696e 5f62 7566 203d 2073 7973 2e73 7464  in_buf = sys.std
-00017340: 696e 2e62 7566 6665 722e 7265 6164 2829  in.buffer.read()
-00017350: 0a20 2020 2020 2020 206c 656e 5f66 696e  .        len_fin
-00017360: 5f62 7566 203d 206c 656e 2866 696e 5f62  _buf = len(fin_b
-00017370: 7566 290a 2020 2020 2020 2020 6669 6c65  uf).        file
-00017380: 203d 2022 6d63 2d22 202b 2073 7472 2875   = "mc-" + str(u
-00017390: 7569 642e 7575 6964 3428 2929 202b 2022  uid.uuid4()) + "
-000173a0: 2e74 6d70 220a 2020 2020 2020 2020 6773  .tmp".        gs
-000173b0: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
-000173c0: 2020 2020 2020 2020 6622 7b6c 656e 5f66          f"{len_f
-000173d0: 696e 5f62 7566 7d20 6279 7465 7320 6f66  in_buf} bytes of
-000173e0: 2066 696c 6520 6461 7461 2072 6561 6420   file data read 
-000173f0: 6672 6f6d 2073 7464 696e 2e20 220a 2020  from stdin. ".  
-00017400: 2020 2020 2020 2020 2020 6627 5465 6d70            f'Temp
-00017410: 6f72 6172 7920 6669 6c65 2022 7b66 696c  orary file "{fil
-00017420: 657d 2220 7761 7320 6372 6561 7465 6420  e}" was created 
-00017430: 666f 7220 6669 6c65 2e27 0a20 2020 2020  for file.'.     
-00017440: 2020 2029 0a20 2020 2020 2020 2066 6f75     ).        fou
-00017450: 7420 3d20 6f70 656e 2866 696c 652c 2022  t = open(file, "
-00017460: 7762 2229 0a20 2020 2020 2020 2066 6f75  wb").        fou
-00017470: 742e 7772 6974 6528 6669 6e5f 6275 6629  t.write(fin_buf)
-00017480: 0a20 2020 2020 2020 2066 6f75 742e 636c  .        fout.cl
-00017490: 6f73 6528 290a 2020 2020 656c 7365 3a0a  ose().    else:.
-000174a0: 2020 2020 2020 2020 6973 5069 7065 203d          isPipe =
-000174b0: 2046 616c 7365 0a0a 2020 2020 6966 206e   False..    if n
-000174c0: 6f74 206f 732e 7061 7468 2e69 7366 696c  ot os.path.isfil
-000174d0: 6528 6669 6c65 293a 0a20 2020 2020 2020  e(file):.       
-000174e0: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
-000174f0: 2020 2020 2020 2020 2020 2066 2246 696c             f"Fil
-00017500: 6520 7b66 696c 657d 2069 7320 6e6f 7420  e {file} is not 
-00017510: 6120 6669 6c65 2e20 446f 6573 6e27 7420  a file. Doesn't 
-00017520: 6578 6973 7420 6f72 2022 0a20 2020 2020  exist or ".     
-00017530: 2020 2020 2020 2022 6973 2061 2064 6972         "is a dir
-00017540: 6563 746f 7279 2e20 220a 2020 2020 2020  ectory. ".      
-00017550: 2020 2020 2020 2254 6869 7320 6669 6c65        "This file
-00017560: 2069 7320 6265 696e 6720 6472 6f70 7065   is being droppe
-00017570: 6420 616e 6420 4e4f 5420 7365 6e74 2e22  d and NOT sent."
-00017580: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00017590: 2020 2072 6574 7572 6e0a 0a20 2020 2023     return..    #
-000175a0: 2023 2072 6573 7472 6963 7420 746f 2022   # restrict to "
-000175b0: 7478 7422 2c20 2270 6466 222c 2022 6d70  txt", "pdf", "mp
-000175c0: 3322 2c20 226f 6767 222c 2022 7761 7622  3", "ogg", "wav"
-000175d0: 2c20 2e2e 2e0a 2020 2020 2320 6966 206e  , ....    # if n
-000175e0: 6f74 2072 652e 6d61 7463 6828 225e 2e70  ot re.match("^.p
-000175f0: 6466 247c 5e2e 7478 7424 7c5e 2e64 6f63  df$|^.txt$|^.doc
-00017600: 247c 5e2e 786c 7324 7c5e 2e6d 6f62 6924  $|^.xls$|^.mobi$
-00017610: 7c5e 2e6d 7033 2422 2c0a 2020 2020 2320  |^.mp3$",.    # 
-00017620: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00017630: 732e 7061 7468 2e73 706c 6974 6578 7428  s.path.splitext(
-00017640: 6669 6c65 295b 315d 2e6c 6f77 6572 2829  file)[1].lower()
-00017650: 293a 0a20 2020 2023 2020 2020 6773 2e6c  ):.    #    gs.l
-00017660: 6f67 2e64 6562 7567 2866 2246 696c 6520  og.debug(f"File 
-00017670: 7b66 696c 657d 2069 7320 6e6f 7420 6120  {file} is not a 
-00017680: 7065 726d 6974 7465 6420 6669 6c65 2074  permitted file t
-00017690: 7970 652e 2053 686f 756c 6420 6265 2022  ype. Should be "
-000176a0: 0a20 2020 2023 2020 2020 2020 2020 2020  .    #          
-000176b0: 2020 2020 2020 2022 2e70 6466 2c20 2e74         ".pdf, .t
-000176c0: 7874 2c20 2e64 6f63 2c20 2e78 6c73 2c20  xt, .doc, .xls, 
-000176d0: 2e6d 6f62 6920 6f72 202e 6d70 3320 2e2e  .mobi or .mp3 ..
-000176e0: 2e20 220a 2020 2020 2320 2020 2020 2020  . ".    #       
-000176f0: 2020 2020 2020 2020 2020 6622 5b7b 6f73            f"[{os
-00017700: 2e70 6174 682e 7370 6c69 7465 7874 2866  .path.splitext(f
-00017710: 696c 6529 5b31 5d2e 6c6f 7765 7228 297d  ile)[1].lower()}
-00017720: 5d22 0a20 2020 2023 2020 2020 2020 2020  ]".    #        
-00017730: 2020 2020 2020 2020 2022 5468 6973 2066           "This f
-00017740: 696c 6520 6973 2062 6569 6e67 2064 726f  ile is being dro
-00017750: 7070 6564 2061 6e64 204e 4f54 2073 656e  pped and NOT sen
-00017760: 742e 2229 0a20 2020 2023 2020 2020 7265  t.").    #    re
-00017770: 7475 726e 0a0a 2020 2020 2320 2761 7070  turn..    # 'app
-00017780: 6c69 6361 7469 6f6e 2f70 6466 2720 2270  lication/pdf' "p
-00017790: 6c61 696e 2f74 6578 7422 2022 6175 6469  lain/text" "audi
-000177a0: 6f2f 6f67 6722 0a20 2020 206d 696d 655f  o/ogg".    mime_
-000177b0: 7479 7065 203d 206d 6167 6963 2e66 726f  type = magic.fro
-000177c0: 6d5f 6669 6c65 2866 696c 652c 206d 696d  m_file(file, mim
-000177d0: 653d 5472 7565 290a 2020 2020 2320 6966  e=True).    # if
-000177e0: 2028 286e 6f74 206d 696d 655f 7479 7065   ((not mime_type
-000177f0: 2e73 7461 7274 7377 6974 6828 2261 7070  .startswith("app
-00017800: 6c69 6361 7469 6f6e 2f22 2929 2061 6e64  lication/")) and
-00017810: 0a20 2020 2023 2020 2020 2020 2020 286e  .    #        (n
-00017820: 6f74 206d 696d 655f 7479 7065 2e73 7461  ot mime_type.sta
-00017830: 7274 7377 6974 6828 2270 6c61 696e 2f22  rtswith("plain/"
-00017840: 2929 2061 6e64 0a20 2020 2023 2020 2020  )) and.    #    
-00017850: 2020 2020 286e 6f74 206d 696d 655f 7479      (not mime_ty
-00017860: 7065 2e73 7461 7274 7377 6974 6828 2261  pe.startswith("a
-00017870: 7564 696f 2f22 2929 293a 0a20 2020 2023  udio/"))):.    #
-00017880: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-00017890: 2866 2246 696c 6520 7b66 696c 657d 2064  (f"File {file} d
-000178a0: 6f65 7320 6e6f 7420 6861 7665 2061 6e20  oes not have an 
-000178b0: 6163 6365 7074 6564 206d 696d 6520 7479  accepted mime ty
-000178c0: 7065 2e20 220a 2020 2020 2320 2020 2020  pe. ".    #     
-000178d0: 2020 2020 2020 2020 2020 2020 2253 686f              "Sho
-000178e0: 756c 6420 6265 2073 6f6d 6574 6869 6e67  uld be something
-000178f0: 206c 696b 6520 6170 706c 6963 6174 696f   like applicatio
-00017900: 6e2f 7064 662e 2022 0a20 2020 2023 2020  n/pdf. ".    #  
-00017910: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00017920: 2246 6f75 6e64 206d 696d 6520 7479 7065  "Found mime type
-00017930: 207b 6d69 6d65 5f74 7970 657d 2e20 220a   {mime_type}. ".
-00017940: 2020 2020 2320 2020 2020 2020 2020 2020      #           
-00017950: 2020 2020 2020 2254 6869 7320 6669 6c65        "This file
-00017960: 2069 7320 6265 696e 6720 6472 6f70 7065   is being droppe
-00017970: 6420 616e 6420 4e4f 5420 7365 6e74 2e22  d and NOT sent."
-00017980: 290a 2020 2020 2320 2020 2072 6574 7572  ).    #    retur
-00017990: 6e0a 0a20 2020 2023 2066 6972 7374 2064  n..    # first d
-000179a0: 6f20 616e 2075 706c 6f61 6420 6f66 2066  o an upload of f
-000179b0: 696c 652c 2073 6565 2075 706c 6f61 6428  ile, see upload(
-000179c0: 2920 646f 6375 6d65 6e74 6174 696f 6e0a  ) documentation.
-000179d0: 2020 2020 2320 6874 7470 3a2f 2f6d 6174      # http://mat
-000179e0: 7269 782d 6e69 6f2e 7265 6164 7468 6564  rix-nio.readthed
-000179f0: 6f63 732e 696f 2f65 6e2f 6c61 7465 7374  ocs.io/en/latest
-00017a00: 2f6e 696f 2e68 746d 6c23 6e69 6f2e 4173  /nio.html#nio.As
-00017a10: 796e 6343 6c69 656e 742e 7570 6c6f 6164  yncClient.upload
-00017a20: 0a20 2020 2023 2074 6865 6e20 7365 6e64  .    # then send
-00017a30: 2055 5249 206f 6620 7570 6c6f 6164 2074   URI of upload t
-00017a40: 6f20 726f 6f6d 0a0a 2020 2020 6669 6c65  o room..    file
-00017a50: 5f73 7461 7420 3d20 6177 6169 7420 6169  _stat = await ai
-00017a60: 6f66 696c 6573 2e6f 732e 7374 6174 2866  ofiles.os.stat(f
-00017a70: 696c 6529 0a20 2020 2061 7379 6e63 2077  ile).    async w
-00017a80: 6974 6820 6169 6f66 696c 6573 2e6f 7065  ith aiofiles.ope
-00017a90: 6e28 6669 6c65 2c20 2272 2b62 2229 2061  n(file, "r+b") a
-00017aa0: 7320 663a 0a20 2020 2020 2020 2072 6573  s f:.        res
-00017ab0: 702c 2064 6563 7279 7074 696f 6e5f 6b65  p, decryption_ke
-00017ac0: 7973 203d 2061 7761 6974 2063 6c69 656e  ys = await clien
-00017ad0: 742e 7570 6c6f 6164 280a 2020 2020 2020  t.upload(.      
-00017ae0: 2020 2020 2020 662c 0a20 2020 2020 2020        f,.       
-00017af0: 2020 2020 2063 6f6e 7465 6e74 5f74 7970       content_typ
-00017b00: 653d 6d69 6d65 5f74 7970 652c 2020 2320  e=mime_type,  # 
-00017b10: 6170 706c 6963 6174 696f 6e2f 7064 660a  application/pdf.
-00017b20: 2020 2020 2020 2020 2020 2020 6669 6c65              file
-00017b30: 6e61 6d65 3d6f 732e 7061 7468 2e62 6173  name=os.path.bas
-00017b40: 656e 616d 6528 6669 6c65 292c 0a20 2020  ename(file),.   
-00017b50: 2020 2020 2020 2020 2066 696c 6573 697a           filesiz
-00017b60: 653d 6669 6c65 5f73 7461 742e 7374 5f73  e=file_stat.st_s
-00017b70: 697a 652c 0a20 2020 2020 2020 2020 2020  ize,.           
-00017b80: 2065 6e63 7279 7074 3d54 7275 652c 0a20   encrypt=True,. 
-00017b90: 2020 2020 2020 2029 0a20 2020 2069 6620         ).    if 
-00017ba0: 6973 696e 7374 616e 6365 2872 6573 702c  isinstance(resp,
-00017bb0: 2055 706c 6f61 6452 6573 706f 6e73 6529   UploadResponse)
-00017bc0: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
-00017bd0: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-00017be0: 2020 2020 2246 696c 6520 7761 7320 7570      "File was up
-00017bf0: 6c6f 6164 6564 2073 7563 6365 7373 6675  loaded successfu
-00017c00: 6c6c 7920 746f 2073 6572 7665 722e 2052  lly to server. R
-00017c10: 6573 706f 6e73 6520 6973 3a20 220a 2020  esponse is: ".  
-00017c20: 2020 2020 2020 2020 2020 6622 7b70 7269            f"{pri
-00017c30: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
-00017c40: 7265 7370 2929 7d22 0a20 2020 2020 2020  resp))}".       
-00017c50: 2029 0a20 2020 2065 6c73 653a 0a20 2020   ).    else:.   
-00017c60: 2020 2020 2067 732e 6c6f 672e 696e 666f       gs.log.info
-00017c70: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
-00017c80: 5468 6520 7072 6f67 7261 6d20 7b50 524f  The program {PRO
-00017c90: 475f 5749 5448 5f45 5854 7d20 6661 696c  G_WITH_EXT} fail
-00017ca0: 6564 2074 6f20 7570 6c6f 6164 2e20 220a  ed to upload. ".
-00017cb0: 2020 2020 2020 2020 2020 2020 2250 6c65              "Ple
-00017cc0: 6173 6520 7265 7472 792e 2054 6869 7320  ase retry. This 
-00017cd0: 636f 756c 6420 6265 2074 656d 706f 7261  could be tempora
-00017ce0: 7279 2069 7373 7565 206f 6e20 220a 2020  ry issue on ".  
-00017cf0: 2020 2020 2020 2020 2020 2279 6f75 7220            "your 
-00017d00: 7365 7276 6572 2e20 220a 2020 2020 2020  server. ".      
-00017d10: 2020 2020 2020 2253 6f72 7279 2e22 0a20        "Sorry.". 
-00017d20: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00017d30: 2067 732e 6c6f 672e 696e 666f 280a 2020   gs.log.info(.  
-00017d40: 2020 2020 2020 2020 2020 6627 6669 6c65            f'file
-00017d50: 3d22 7b66 696c 657d 223b 206d 696d 655f  ="{file}"; mime_
-00017d60: 7479 7065 3d22 7b6d 696d 655f 7479 7065  type="{mime_type
-00017d70: 7d22 3b20 270a 2020 2020 2020 2020 2020  }"; '.          
-00017d80: 2020 6627 6669 6c65 7373 697a 653d 227b    f'filessize="{
-00017d90: 6669 6c65 5f73 7461 742e 7374 5f73 697a  file_stat.st_siz
-00017da0: 657d 2227 0a20 2020 2020 2020 2020 2020  e}"'.           
-00017db0: 2066 2246 6169 6c65 6420 746f 2075 706c   f"Failed to upl
-00017dc0: 6f61 643a 207b 7072 6976 6163 795f 6669  oad: {privacy_fi
-00017dd0: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
-00017de0: 220a 2020 2020 2020 2020 290a 0a20 2020  ".        )..   
-00017df0: 2023 2064 6574 6572 6d69 6e65 206d 7367   # determine msg
-00017e00: 5f74 7970 653a 0a20 2020 2069 6620 6d69  _type:.    if mi
-00017e10: 6d65 5f74 7970 652e 7374 6172 7473 7769  me_type.startswi
-00017e20: 7468 2822 6175 6469 6f2f 2229 3a0a 2020  th("audio/"):.  
-00017e30: 2020 2020 2020 6d73 675f 7479 7065 203d        msg_type =
-00017e40: 2022 6d2e 6175 6469 6f22 0a20 2020 2065   "m.audio".    e
-00017e50: 6c69 6620 6d69 6d65 5f74 7970 652e 7374  lif mime_type.st
-00017e60: 6172 7473 7769 7468 2822 7669 6465 6f2f  artswith("video/
-00017e70: 2229 3a0a 2020 2020 2020 2020 6d73 675f  "):.        msg_
-00017e80: 7479 7065 203d 2022 6d2e 7669 6465 6f22  type = "m.video"
-00017e90: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00017ea0: 2020 206d 7367 5f74 7970 6520 3d20 226d     msg_type = "m
-00017eb0: 2e66 696c 6522 0a0a 2020 2020 636f 6e74  .file"..    cont
-00017ec0: 656e 7420 3d20 7b0a 2020 2020 2020 2020  ent = {.        
-00017ed0: 2262 6f64 7922 3a20 6f73 2e70 6174 682e  "body": os.path.
-00017ee0: 6261 7365 6e61 6d65 2866 696c 6529 2c20  basename(file), 
-00017ef0: 2023 2064 6573 6372 6970 7469 7665 2074   # descriptive t
-00017f00: 6974 6c65 0a20 2020 2020 2020 2022 696e  itle.        "in
-00017f10: 666f 223a 207b 2273 697a 6522 3a20 6669  fo": {"size": fi
-00017f20: 6c65 5f73 7461 742e 7374 5f73 697a 652c  le_stat.st_size,
-00017f30: 2022 6d69 6d65 7479 7065 223a 206d 696d   "mimetype": mim
-00017f40: 655f 7479 7065 7d2c 0a20 2020 2020 2020  e_type},.       
-00017f50: 2022 6d73 6774 7970 6522 3a20 6d73 675f   "msgtype": msg_
-00017f60: 7479 7065 2c0a 2020 2020 2020 2020 2266  type,.        "f
-00017f70: 696c 6522 3a20 7b0a 2020 2020 2020 2020  ile": {.        
-00017f80: 2020 2020 2275 726c 223a 2072 6573 702e      "url": resp.
-00017f90: 636f 6e74 656e 745f 7572 692c 0a20 2020  content_uri,.   
-00017fa0: 2020 2020 2020 2020 2022 6b65 7922 3a20           "key": 
-00017fb0: 6465 6372 7970 7469 6f6e 5f6b 6579 735b  decryption_keys[
-00017fc0: 226b 6579 225d 2c0a 2020 2020 2020 2020  "key"],.        
-00017fd0: 2020 2020 2269 7622 3a20 6465 6372 7970      "iv": decryp
-00017fe0: 7469 6f6e 5f6b 6579 735b 2269 7622 5d2c  tion_keys["iv"],
-00017ff0: 0a20 2020 2020 2020 2020 2020 2022 6861  .            "ha
-00018000: 7368 6573 223a 2064 6563 7279 7074 696f  shes": decryptio
-00018010: 6e5f 6b65 7973 5b22 6861 7368 6573 225d  n_keys["hashes"]
-00018020: 2c0a 2020 2020 2020 2020 2020 2020 2276  ,.            "v
-00018030: 223a 2064 6563 7279 7074 696f 6e5f 6b65  ": decryption_ke
-00018040: 7973 5b22 7622 5d2c 0a20 2020 2020 2020  ys["v"],.       
-00018050: 207d 2c0a 2020 2020 7d0a 0a20 2020 2069   },.    }..    i
-00018060: 6620 6973 5069 7065 3a0a 2020 2020 2020  f isPipe:.      
-00018070: 2020 2320 726d 2074 656d 7020 6669 6c65    # rm temp file
-00018080: 0a20 2020 2020 2020 206f 732e 7265 6d6f  .        os.remo
-00018090: 7665 2866 696c 6529 0a0a 2020 2020 7472  ve(file)..    tr
-000180a0: 793a 0a20 2020 2020 2020 2066 6f72 2072  y:.        for r
-000180b0: 6f6f 6d5f 6964 2069 6e20 726f 6f6d 733a  oom_id in rooms:
-000180c0: 0a20 2020 2020 2020 2020 2020 2072 6f6f  .            roo
-000180d0: 6d5f 6964 203d 2061 7761 6974 206d 6170  m_id = await map
-000180e0: 5f72 6f6f 6d69 6e66 6f5f 746f 5f72 6f6f  _roominfo_to_roo
-000180f0: 6d69 6428 636c 6965 6e74 2c20 726f 6f6d  mid(client, room
-00018100: 5f69 6429 0a20 2020 2020 2020 2020 2020  _id).           
-00018110: 2072 6573 7020 3d20 6177 6169 7420 636c   resp = await cl
-00018120: 6965 6e74 2e72 6f6f 6d5f 7365 6e64 280a  ient.room_send(.
-00018130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018140: 726f 6f6d 5f69 642c 206d 6573 7361 6765  room_id, message
-00018150: 5f74 7970 653d 226d 2e72 6f6f 6d2e 6d65  _type="m.room.me
-00018160: 7373 6167 6522 2c20 636f 6e74 656e 743d  ssage", content=
-00018170: 636f 6e74 656e 740a 2020 2020 2020 2020  content.        
-00018180: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00018190: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-000181a0: 7265 7370 2c20 526f 6f6d 5365 6e64 4572  resp, RoomSendEr
-000181b0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-000181c0: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
-000181d0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-000181e0: 2020 2020 2020 2020 2245 3134 363a 2022          "E146: "
-000181f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018200: 2020 2020 2022 726f 6f6d 5f73 656e 6420       "room_send 
-00018210: 6661 696c 6564 2077 6974 6820 6572 726f  failed with erro
-00018220: 7220 220a 2020 2020 2020 2020 2020 2020  r ".            
-00018230: 2020 2020 2020 2020 6622 277b 7072 6976          f"'{priv
-00018240: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
-00018250: 6573 7029 297d 272e 220a 2020 2020 2020  esp))}'.".      
-00018260: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00018270: 2020 2020 2020 2020 2020 2020 2320 6773              # gs
-00018280: 2e65 7272 5f63 6f75 6e74 202b 3d20 3120  .err_count += 1 
-00018290: 2320 6e6f 7420 6e65 6564 6564 2c20 7769  # not needed, wi
-000182a0: 6c6c 2072 6169 7365 2065 7863 6570 7469  ll raise excepti
-000182b0: 6f6e 0a20 2020 2020 2020 2020 2020 2020  on.             
-000182c0: 2020 2023 2069 6e20 666f 6c6c 6f77 696e     # in followin
-000182d0: 6720 6c69 6e65 206f 6620 636f 6465 0a20  g line of code. 
-000182e0: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-000182f0: 672e 696e 666f 280a 2020 2020 2020 2020  g.info(.        
-00018300: 2020 2020 2020 2020 6627 5468 6973 2066          f'This f
-00018310: 696c 6520 7761 7320 7365 6e74 3a20 227b  ile was sent: "{
-00018320: 6669 6c65 7d22 2074 6f20 726f 6f6d 2022  file}" to room "
-00018330: 7b72 6573 702e 726f 6f6d 5f69 647d 2220  {resp.room_id}" 
-00018340: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00018350: 2020 6627 6173 2065 7665 6e74 2022 7b72    f'as event "{r
-00018360: 6573 702e 6576 656e 745f 6964 7d22 2e27  esp.event_id}".'
-00018370: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00018380: 2020 2020 2020 2020 2020 2069 6620 6773             if gs
-00018390: 2e70 612e 7072 696e 745f 6576 656e 745f  .pa.print_event_
-000183a0: 6964 3a0a 2020 2020 2020 2020 2020 2020  id:.            
-000183b0: 2020 2020 2320 6f75 7470 7574 2066 6f72      # output for
-000183c0: 6d61 7420 636f 6e74 726f 6c6c 6564 2076  mat controlled v
-000183d0: 6961 202d 2d6f 7574 7075 7420 666c 6167  ia --output flag
-000183e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000183f0: 2074 6578 7420 3d20 6622 7b72 6573 702e   text = f"{resp.
-00018400: 6576 656e 745f 6964 7d7b 5345 507d 7b72  event_id}{SEP}{r
-00018410: 6573 702e 726f 6f6d 5f69 647d 7b53 4550  esp.room_id}{SEP
-00018420: 7d7b 6669 6c65 7d22 0a20 2020 2020 2020  }{file}".       
-00018430: 2020 2020 2020 2020 2023 204f 626a 6563           # Objec
-00018440: 7420 6f66 2074 7970 6520 526f 6f6d 4372  t of type RoomCr
-00018450: 6561 7465 5265 7370 6f6e 7365 2069 7320  eateResponse is 
-00018460: 6e6f 7420 4a53 4f4e 0a20 2020 2020 2020  not JSON.       
-00018470: 2020 2020 2020 2020 2023 2073 6572 6961           # seria
-00018480: 6c69 7a61 626c 652c 2068 656e 6365 2077  lizable, hence w
-00018490: 6520 7573 6520 7468 6520 6469 6374 696f  e use the dictio
-000184a0: 6e61 7279 2e0a 2020 2020 2020 2020 2020  nary..          
-000184b0: 2020 2020 2020 6a73 6f6e 5f6d 6178 203d        json_max =
-000184c0: 2072 6573 702e 5f5f 6469 6374 5f5f 0a20   resp.__dict__. 
-000184d0: 2020 2020 2020 2020 2020 2020 2020 206a                 j
-000184e0: 736f 6e5f 6d61 782e 7570 6461 7465 287b  son_max.update({
-000184f0: 2266 696c 6522 3a20 6669 6c65 7d29 2020  "file": file})  
-00018500: 2320 6164 6420 6469 6374 2069 7465 6d73  # add dict items
-00018510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018520: 206a 736f 6e5f 203d 206a 736f 6e5f 6d61   json_ = json_ma
-00018530: 782e 636f 7079 2829 0a20 2020 2020 2020  x.copy().       
-00018540: 2020 2020 2020 2020 206a 736f 6e5f 2e70           json_.p
-00018550: 6f70 2822 7472 616e 7370 6f72 745f 7265  op("transport_re
-00018560: 7370 6f6e 7365 2229 0a20 2020 2020 2020  sponse").       
-00018570: 2020 2020 2020 2020 206a 736f 6e5f 7370           json_sp
-00018580: 6563 203d 204e 6f6e 650a 2020 2020 2020  ec = None.      
-00018590: 2020 2020 2020 2020 2020 7072 696e 745f            print_
-000185a0: 6f75 7470 7574 280a 2020 2020 2020 2020  output(.        
-000185b0: 2020 2020 2020 2020 2020 2020 6773 2e70              gs.p
-000185c0: 612e 6f75 7470 7574 2c0a 2020 2020 2020  a.output,.      
-000185d0: 2020 2020 2020 2020 2020 2020 2020 7465                te
-000185e0: 7874 3d74 6578 742c 0a20 2020 2020 2020  xt=text,.       
-000185f0: 2020 2020 2020 2020 2020 2020 206a 736f               jso
-00018600: 6e5f 3d6a 736f 6e5f 2c0a 2020 2020 2020  n_=json_,.      
-00018610: 2020 2020 2020 2020 2020 2020 2020 6a73                js
-00018620: 6f6e 5f6d 6178 3d6a 736f 6e5f 6d61 782c  on_max=json_max,
-00018630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018640: 2020 2020 206a 736f 6e5f 7370 6563 3d6a       json_spec=j
-00018650: 736f 6e5f 7370 6563 2c0a 2020 2020 2020  son_spec,.      
-00018660: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00018670: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-00018680: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
-00018690: 2020 2020 2020 6627 5468 6973 2066 696c        f'This fil
-000186a0: 6520 7761 7320 7365 6e74 3a20 227b 6669  e was sent: "{fi
-000186b0: 6c65 7d22 2074 6f20 726f 6f6d 2022 7b72  le}" to room "{r
-000186c0: 6f6f 6d5f 6964 7d22 2e20 270a 2020 2020  oom_id}". '.    
-000186d0: 2020 2020 2020 2020 2020 2020 6622 5265              f"Re
-000186e0: 7370 6f6e 7365 3a20 6576 656e 745f 6964  sponse: event_id
-000186f0: 3d7b 7265 7370 2e65 7665 6e74 5f69 647d  ={resp.event_id}
-00018700: 2c20 726f 6f6d 5f69 643d 7b72 6573 702e  , room_id={resp.
-00018710: 726f 6f6d 5f69 647d 2c20 220a 2020 2020  room_id}, ".    
-00018720: 2020 2020 2020 2020 2020 2020 6622 6675              f"fu
-00018730: 6c6c 2072 6573 706f 6e73 653a 207b 7072  ll response: {pr
-00018740: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
-00018750: 2872 6573 7029 297d 2e20 220a 2020 2020  (resp))}. ".    
-00018760: 2020 2020 2020 2020 290a 2020 2020 6578          ).    ex
-00018770: 6365 7074 2045 7863 6570 7469 6f6e 3a0a  cept Exception:.
-00018780: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
-00018790: 7272 6f72 2822 4531 3437 3a20 2220 6622  rror("E147: " f"
-000187a0: 4669 6c65 2073 656e 6420 6f66 2066 696c  File send of fil
-000187b0: 6520 7b66 696c 657d 2066 6169 6c65 642e  e {file} failed.
-000187c0: 2053 6f72 7279 2e22 290a 2020 2020 2020   Sorry.").      
-000187d0: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
-000187e0: 3d20 310a 2020 2020 2020 2020 6773 2e6c  = 1.        gs.l
-000187f0: 6f67 2e64 6562 7567 2822 4865 7265 2069  og.debug("Here i
-00018800: 7320 7468 6520 7472 6163 6562 6163 6b2e  s the traceback.
-00018810: 5c6e 2220 2b20 7472 6163 6562 6163 6b2e  \n" + traceback.
-00018820: 666f 726d 6174 5f65 7863 2829 290a 0a0a  format_exc())...
-00018830: 2320 6163 636f 7264 696e 6720 746f 206c  # according to l
-00018840: 696e 7465 723a 2066 756e 6374 696f 6e20  inter: function 
-00018850: 6973 2074 6f6f 2063 6f6d 706c 6578 2c20  is too complex, 
-00018860: 4339 3031 0a61 7379 6e63 2064 6566 2073  C901.async def s
-00018870: 656e 645f 696d 6167 6528 636c 6965 6e74  end_image(client
-00018880: 2c20 726f 6f6d 732c 2069 6d61 6765 293a  , rooms, image):
-00018890: 2020 2320 6e6f 7161 3a20 4339 3031 0a20    # noqa: C901. 
-000188a0: 2020 2022 2222 5072 6f63 6573 7320 696d     """Process im
-000188b0: 6167 652e 0a0a 2020 2020 4172 6775 6d65  age...    Argume
-000188c0: 6e74 733a 0a20 2020 202d 2d2d 2d2d 2d2d  nts:.    -------
-000188d0: 2d2d 0a20 2020 2063 6c69 656e 7420 3a20  --.    client : 
-000188e0: 436c 6965 6e74 0a20 2020 2072 6f6f 6d73  Client.    rooms
-000188f0: 203a 206c 6973 740a 2020 2020 2020 2020   : list.        
-00018900: 6c69 7374 206f 6620 726f 6f6d 5f69 642d  list of room_id-
-00018910: 730a 2020 2020 696d 6167 6520 3a20 7374  s.    image : st
-00018920: 720a 2020 2020 2020 2020 6669 6c65 206e  r.        file n
-00018930: 616d 6520 6f66 2069 6d61 6765 2066 726f  ame of image fro
-00018940: 6d20 2d2d 696d 6167 6520 6172 6775 6d65  m --image argume
-00018950: 6e74 0a0a 2020 2020 5468 6973 2069 7320  nt..    This is 
-00018960: 6120 776f 726b 696e 6720 6578 616d 706c  a working exampl
-00018970: 6520 666f 7220 6120 4a50 4720 696d 6167  e for a JPG imag
-00018980: 652e 0a20 2020 2049 7420 6361 6e20 6265  e..    It can be
-00018990: 2076 6965 7765 6420 6f72 2064 6f77 6e6c   viewed or downl
-000189a0: 6f61 6465 6420 6672 6f6d 3a0a 2020 2020  oaded from:.    
-000189b0: 6874 7470 733a 2f2f 6d61 7472 6978 2e65  https://matrix.e
-000189c0: 7861 6d70 6c65 2e63 6f6d 2f5f 6d61 7472  xample.com/_matr
-000189d0: 6978 2f6d 6564 6961 2f72 302f 646f 776e  ix/media/r0/down
-000189e0: 6c6f 6164 2f0a 2020 2020 2020 2020 6578  load/.        ex
-000189f0: 616d 706c 652e 636f 6d2f 536f 6d65 5374  ample.com/SomeSt
-00018a00: 7261 6e67 6555 7269 4b65 790a 2020 2020  rangeUriKey.    
-00018a10: 7b0a 2020 2020 2020 2020 2274 7970 6522  {.        "type"
-00018a20: 3a20 226d 2e72 6f6f 6d2e 6d65 7373 6167  : "m.room.messag
-00018a30: 6522 2c0a 2020 2020 2020 2020 2273 656e  e",.        "sen
-00018a40: 6465 7222 3a20 2240 736f 6d65 7573 6572  der": "@someuser
-00018a50: 3a65 7861 6d70 6c65 2e63 6f6d 222c 0a20  :example.com",. 
-00018a60: 2020 2020 2020 2022 636f 6e74 656e 7422         "content"
-00018a70: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-00018a80: 2262 6f64 7922 3a20 2273 6f6d 6569 6d61  "body": "someima
-00018a90: 6765 2e6a 7067 222c 0a20 2020 2020 2020  ge.jpg",.       
-00018aa0: 2020 2020 2022 696e 666f 223a 207b 0a20       "info": {. 
-00018ab0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00018ac0: 7369 7a65 223a 2035 3432 302c 0a20 2020  size": 5420,.   
-00018ad0: 2020 2020 2020 2020 2020 2020 2022 6d69               "mi
-00018ae0: 6d65 7479 7065 223a 2022 696d 6167 652f  metype": "image/
-00018af0: 6a70 6567 222c 0a20 2020 2020 2020 2020  jpeg",.         
-00018b00: 2020 2020 2020 2022 7468 756d 626e 6169         "thumbnai
-00018b10: 6c5f 696e 666f 223a 207b 0a20 2020 2020  l_info": {.     
-00018b20: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00018b30: 7722 3a20 3130 302c 0a20 2020 2020 2020  w": 100,.       
-00018b40: 2020 2020 2020 2020 2020 2020 2022 6822               "h"
-00018b50: 3a20 3130 302c 0a20 2020 2020 2020 2020  : 100,.         
-00018b60: 2020 2020 2020 2020 2020 2022 6d69 6d65             "mime
-00018b70: 7479 7065 223a 2022 696d 6167 652f 6a70  type": "image/jp
-00018b80: 6567 222c 0a20 2020 2020 2020 2020 2020  eg",.           
-00018b90: 2020 2020 2020 2020 2022 7369 7a65 223a           "size":
-00018ba0: 2032 3130 360a 2020 2020 2020 2020 2020   2106.          
-00018bb0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-00018bc0: 2020 2020 2020 2020 2022 7722 3a20 3130           "w": 10
-00018bd0: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
-00018be0: 2020 2022 6822 3a20 3130 302c 0a20 2020     "h": 100,.   
-00018bf0: 2020 2020 2020 2020 2020 2020 2022 7468               "th
-00018c00: 756d 626e 6169 6c5f 7572 6c22 3a20 226d  umbnail_url": "m
-00018c10: 7863 3a2f 2f65 7861 6d70 6c65 2e63 6f6d  xc://example.com
-00018c20: 2f53 6f6d 6553 7472 616e 6765 5468 756d  /SomeStrangeThum
-00018c30: 626e 6169 6c55 7269 4b65 7922 0a20 2020  bnailUriKey".   
-00018c40: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
-00018c50: 2020 2020 2020 2020 226d 7367 7479 7065          "msgtype
-00018c60: 223a 2022 6d2e 696d 6167 6522 2c0a 2020  ": "m.image",.  
-00018c70: 2020 2020 2020 2020 2020 2275 726c 223a            "url":
-00018c80: 2022 6d78 633a 2f2f 6578 616d 706c 652e   "mxc://example.
-00018c90: 636f 6d2f 536f 6d65 5374 7261 6e67 6555  com/SomeStrangeU
-00018ca0: 7269 4b65 7922 0a20 2020 2020 2020 207d  riKey".        }
-00018cb0: 2c0a 2020 2020 2020 2020 226f 7269 6769  ,.        "origi
-00018cc0: 6e5f 7365 7276 6572 5f74 7322 3a20 3132  n_server_ts": 12
-00018cd0: 3334 3536 3738 3930 3132 3334 3537 362c  345678901234576,
-00018ce0: 0a20 2020 2020 2020 2022 756e 7369 676e  .        "unsign
-00018cf0: 6564 223a 207b 0a20 2020 2020 2020 2020  ed": {.         
-00018d00: 2020 2022 6167 6522 3a20 3236 380a 2020     "age": 268.  
-00018d10: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-00018d20: 2022 6576 656e 745f 6964 223a 2022 2473   "event_id": "$s
-00018d30: 6b64 6847 4a4b 6867 7972 3534 3836 3534  kdhGJKhgyr548654
-00018d40: 5954 7237 3635 5969 7935 3854 5952 222c  YTr765Yiy58TYR",
-00018d50: 0a20 2020 2020 2020 2022 726f 6f6d 5f69  .        "room_i
-00018d60: 6422 3a20 2221 4a4b 4867 7948 4766 7974  d": "!JKHgyHGfyt
-00018d70: 4847 466a 6867 6659 3a65 7861 6d70 6c65  HGFjhgfY:example
-00018d80: 2e63 6f6d 220a 2020 2020 7d0a 0a20 2020  .com".    }..   
-00018d90: 2022 2222 0a20 2020 2069 6620 6e6f 7420   """.    if not 
-00018da0: 726f 6f6d 733a 0a20 2020 2020 2020 2067  rooms:.        g
-00018db0: 732e 6c6f 672e 7761 726e 696e 6728 0a20  s.log.warning(. 
-00018dc0: 2020 2020 2020 2020 2020 2022 5731 3031             "W101
-00018dd0: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
-00018de0: 224e 6f20 726f 6f6d 7320 6172 6520 6769  "No rooms are gi
-00018df0: 7665 6e2e 2054 6869 7320 7368 6f75 6c64  ven. This should
-00018e00: 206e 6f74 2068 6170 7065 6e2e 2022 0a20   not happen. ". 
-00018e10: 2020 2020 2020 2020 2020 2022 4d61 7962             "Mayb
-00018e20: 6520 796f 7572 2044 4d20 726f 6f6d 7320  e your DM rooms 
-00018e30: 7370 6563 6966 6965 6420 7669 6120 2d2d  specified via --
-00018e40: 7573 6572 2077 6572 6520 6e6f 7420 666f  user were not fo
-00018e50: 756e 642e 2022 0a20 2020 2020 2020 2020  und. ".         
-00018e60: 2020 2022 5468 6973 2069 6d61 6765 2069     "This image i
-00018e70: 7320 6265 696e 6720 6472 6f70 7065 6420  s being dropped 
-00018e80: 616e 6420 4e4f 5420 7365 6e74 2e22 0a20  and NOT sent.". 
-00018e90: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00018ea0: 2067 732e 7761 726e 5f63 6f75 6e74 202b   gs.warn_count +
-00018eb0: 3d20 310a 2020 2020 2020 2020 7265 7475  = 1.        retu
-00018ec0: 726e 0a0a 2020 2020 2320 686f 7720 746f  rn..    # how to
-00018ed0: 2074 7265 6174 2070 6970 6520 6f6e 2073   treat pipe on s
-00018ee0: 7464 696e 3f0a 2020 2020 2320 6169 6f66  tdin?.    # aiof
-00018ef0: 696c 6573 2e6f 7065 6e28 7379 732e 7374  iles.open(sys.st
-00018f00: 6469 6e2c 2022 722b 6222 2920 646f 6573  din, "r+b") does
-00018f10: 206e 6f74 2077 6f72 6b2c 2077 726f 6e67   not work, wrong
-00018f20: 2074 7970 652e 0a20 2020 2023 2061 696f   type..    # aio
-00018f30: 6669 6c65 732e 6f70 656e 2873 7973 2e73  files.open(sys.s
-00018f40: 7464 696e 2e62 7566 6665 722c 2022 722b  tdin.buffer, "r+
-00018f50: 6222 2920 646f 6573 206e 6f74 2077 6f72  b") does not wor
-00018f60: 6b2c 2077 726f 6e67 2074 7970 652e 0a20  k, wrong type.. 
-00018f70: 2020 2023 2061 696f 6669 6c65 732e 6f70     # aiofiles.op
-00018f80: 656e 2827 2f64 6576 2f73 7464 696e 272c  en('/dev/stdin',
-00018f90: 206d 6f64 653d 2772 6227 2920 6661 696c   mode='rb') fail
-00018fa0: 7320 7769 7468 2065 7272 6f72 3a0a 2020  s with error:.  
-00018fb0: 2020 2320 2020 2069 6f2e 556e 7375 7070    #    io.Unsupp
-00018fc0: 6f72 7465 644f 7065 7261 7469 6f6e 3a20  ortedOperation: 
-00018fd0: 4669 6c65 206f 7220 7374 7265 616d 2069  File or stream i
-00018fe0: 7320 6e6f 7420 7365 656b 6162 6c65 0a20  s not seekable. 
-00018ff0: 2020 2023 2073 7464 696e 2c20 5f20 3d20     # stdin, _ = 
-00019000: 6177 6169 7420 6169 6f63 6f6e 736f 6c65  await aioconsole
-00019010: 2e67 6574 5f73 7461 6e64 6172 645f 7374  .get_standard_st
-00019020: 7265 616d 7328 2920 616c 736f 2066 6169  reams() also fai
-00019030: 6c65 730a 2020 2020 2320 4865 6e63 6520  les.    # Hence 
-00019040: 4920 7365 6520 6e6f 2077 6179 2074 6f20  I see no way to 
-00019050: 6469 7265 6374 6c79 2068 616e 6420 7374  directly hand st
-00019060: 6469 6e20 746f 2061 696f 6669 6c65 732e  din to aiofiles.
-00019070: 0a20 2020 2023 2050 726f 626c 656d 3a20  .    # Problem: 
-00019080: 4920 6361 6e6e 6f74 2063 6f6d 6269 6e65  I cannot combine
-00019090: 2074 6865 2033 2074 6869 6e67 733a 0a20   the 3 things:. 
-000190a0: 2020 2023 2020 2020 7374 6469 6e20 2b20     #    stdin + 
-000190b0: 6169 6f66 696c 6573 202b 206e 696f 2e41  aiofiles + nio.A
-000190c0: 7379 6e63 436c 6965 6e74 2e75 706c 6f61  syncClient.uploa
-000190d0: 6428 290a 2020 2020 2320 5369 6e63 6520  d().    # Since 
-000190e0: 4920 636f 756c 6420 6e6f 7420 6f76 6572  I could not over
-000190f0: 636f 6d65 2074 6869 7320 7072 6f62 6c65  come this proble
-00019100: 6d20 4920 6765 6e65 7261 7465 2061 2074  m I generate a t
-00019110: 656d 706f 7261 7279 2066 696c 650a 0a20  emporary file.. 
-00019120: 2020 2069 6620 696d 6167 6520 3d3d 2022     if image == "
-00019130: 2d22 3a20 2023 202d 206d 6561 6e73 2072  -":  # - means r
-00019140: 6561 6420 6173 2070 6970 6520 6672 6f6d  ead as pipe from
-00019150: 2073 7464 696e 0a20 2020 2020 2020 2069   stdin.        i
-00019160: 7350 6970 6520 3d20 5472 7565 0a20 2020  sPipe = True.   
-00019170: 2020 2020 2066 696e 5f62 7566 203d 2073       fin_buf = s
-00019180: 7973 2e73 7464 696e 2e62 7566 6665 722e  ys.stdin.buffer.
-00019190: 7265 6164 2829 0a20 2020 2020 2020 206c  read().        l
-000191a0: 656e 5f66 696e 5f62 7566 203d 206c 656e  en_fin_buf = len
-000191b0: 2866 696e 5f62 7566 290a 2020 2020 2020  (fin_buf).      
-000191c0: 2020 696d 6167 6520 3d20 226d 632d 2220    image = "mc-" 
-000191d0: 2b20 7374 7228 7575 6964 2e75 7569 6434  + str(uuid.uuid4
-000191e0: 2829 2920 2b20 222e 746d 7022 0a20 2020  ()) + ".tmp".   
-000191f0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-00019200: 6728 0a20 2020 2020 2020 2020 2020 2066  g(.            f
-00019210: 227b 6c65 6e5f 6669 6e5f 6275 667d 2062  "{len_fin_buf} b
-00019220: 7974 6573 206f 6620 696d 6167 6520 6461  ytes of image da
-00019230: 7461 2072 6561 6420 6672 6f6d 2073 7464  ta read from std
-00019240: 696e 2e20 220a 2020 2020 2020 2020 2020  in. ".          
-00019250: 2020 6627 5465 6d70 6f72 6172 7920 6669    f'Temporary fi
-00019260: 6c65 2022 7b69 6d61 6765 7d22 2077 6173  le "{image}" was
-00019270: 2063 7265 6174 6564 2066 6f72 2069 6d61   created for ima
-00019280: 6765 2e27 0a20 2020 2020 2020 2029 0a20  ge.'.        ). 
-00019290: 2020 2020 2020 2066 6f75 7420 3d20 6f70         fout = op
-000192a0: 656e 2869 6d61 6765 2c20 2277 6222 290a  en(image, "wb").
-000192b0: 2020 2020 2020 2020 666f 7574 2e77 7269          fout.wri
-000192c0: 7465 2866 696e 5f62 7566 290a 2020 2020  te(fin_buf).    
-000192d0: 2020 2020 666f 7574 2e63 6c6f 7365 2829      fout.close()
-000192e0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-000192f0: 2020 2069 7350 6970 6520 3d20 4661 6c73     isPipe = Fals
-00019300: 650a 0a20 2020 2069 6620 6e6f 7420 6f73  e..    if not os
-00019310: 2e70 6174 682e 6973 6669 6c65 2869 6d61  .path.isfile(ima
-00019320: 6765 293a 0a20 2020 2020 2020 2067 732e  ge):.        gs.
-00019330: 6c6f 672e 7761 726e 696e 6728 0a20 2020  log.warning(.   
-00019340: 2020 2020 2020 2020 2022 5731 3032 3a20           "W102: 
-00019350: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
-00019360: 496d 6167 6520 6669 6c65 207b 696d 6167  Image file {imag
-00019370: 657d 2069 7320 6e6f 7420 6120 6669 6c65  e} is not a file
-00019380: 2e20 446f 6573 6e27 7420 6578 6973 7420  . Doesn't exist 
-00019390: 6f72 2022 0a20 2020 2020 2020 2020 2020  or ".           
-000193a0: 2022 6973 2061 2064 6972 6563 746f 7279   "is a directory
-000193b0: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
-000193c0: 2254 6869 7320 696d 6167 6520 6973 2062  "This image is b
-000193d0: 6569 6e67 2064 726f 7070 6564 2061 6e64  eing dropped and
-000193e0: 204e 4f54 2073 656e 742e 220a 2020 2020   NOT sent.".    
-000193f0: 2020 2020 290a 2020 2020 2020 2020 6773      ).        gs
-00019400: 2e77 6172 6e5f 636f 756e 7420 2b3d 2031  .warn_count += 1
-00019410: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
-00019420: 0a20 2020 2023 2022 626d 7022 2c20 2267  .    # "bmp", "g
-00019430: 6966 222c 2022 6a70 6722 2c20 226a 7065  if", "jpg", "jpe
-00019440: 6722 2c20 2270 6e67 222c 2022 7062 6d22  g", "png", "pbm"
-00019450: 2c20 2270 676d 222c 2022 7070 6d22 2c20  , "pgm", "ppm", 
-00019460: 2278 626d 222c 2022 7870 6d22 2c0a 2020  "xbm", "xpm",.  
-00019470: 2020 2320 2274 6966 6622 2c20 2277 6562    # "tiff", "web
-00019480: 7022 2c20 2273 7667 222c 0a0a 2020 2020  p", "svg",..    
-00019490: 2320 7376 6720 6669 6c65 7320 6172 6520  # svg files are 
-000194a0: 6e6f 7420 7368 6f77 6e20 696e 2045 6c65  not shown in Ele
-000194b0: 6d65 6e74 2c20 6865 6e63 6520 7365 6e64  ment, hence send
-000194c0: 2053 5647 2066 696c 6573 2061 7320 6669   SVG files as fi
-000194d0: 6c65 7320 7769 7468 202d 660a 2020 2020  les with -f.    
-000194e0: 6966 206e 6f74 2069 7350 6970 6520 616e  if not isPipe an
-000194f0: 6420 6e6f 7420 7265 2e6d 6174 6368 280a  d not re.match(.
-00019500: 2020 2020 2020 2020 225e 2e6a 7067 247c          "^.jpg$|
-00019510: 5e2e 6a70 6567 247c 5e2e 6769 6624 7c5e  ^.jpeg$|^.gif$|^
-00019520: 2e70 6e67 247c 5e2e 7376 6724 222c 0a20  .png$|^.svg$",. 
-00019530: 2020 2020 2020 206f 732e 7061 7468 2e73         os.path.s
-00019540: 706c 6974 6578 7428 696d 6167 6529 5b31  plitext(image)[1
-00019550: 5d2e 6c6f 7765 7228 292c 0a20 2020 2029  ].lower(),.    )
-00019560: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
-00019570: 2e77 6172 6e69 6e67 280a 2020 2020 2020  .warning(.      
-00019580: 2020 2020 2020 2257 3130 333a 2022 0a20        "W103: ". 
-00019590: 2020 2020 2020 2020 2020 2066 2249 6d61             f"Ima
-000195a0: 6765 2066 696c 6520 7b69 6d61 6765 7d20  ge file {image} 
-000195b0: 6973 206e 6f74 2061 6e20 696d 6167 6520  is not an image 
-000195c0: 6669 6c65 2e20 5368 6f75 6c64 2062 6520  file. Should be 
-000195d0: 220a 2020 2020 2020 2020 2020 2020 222e  ".            ".
-000195e0: 6a70 672c 202e 6a70 6567 2c20 2e67 6966  jpg, .jpeg, .gif
-000195f0: 2c20 6f72 202e 706e 672e 2022 0a20 2020  , or .png. ".   
-00019600: 2020 2020 2020 2020 2066 2246 6f75 6e64           f"Found
-00019610: 205b 7b6f 732e 7061 7468 2e73 706c 6974   [{os.path.split
-00019620: 6578 7428 696d 6167 6529 5b31 5d2e 6c6f  ext(image)[1].lo
-00019630: 7765 7228 297d 5d2e 2022 0a20 2020 2020  wer()}]. ".     
-00019640: 2020 2020 2020 2022 5468 6973 2069 6d61         "This ima
-00019650: 6765 2069 7320 6265 696e 6720 6472 6f70  ge is being drop
-00019660: 7065 6420 616e 6420 4e4f 5420 7365 6e74  ped and NOT sent
-00019670: 2e22 0a20 2020 2020 2020 2029 0a20 2020  .".        ).   
-00019680: 2020 2020 2067 732e 7761 726e 5f63 6f75       gs.warn_cou
-00019690: 6e74 202b 3d20 310a 2020 2020 2020 2020  nt += 1.        
-000196a0: 7265 7475 726e 0a0a 2020 2020 2320 2761  return..    # 'a
-000196b0: 7070 6c69 6361 7469 6f6e 2f70 6466 2720  pplication/pdf' 
-000196c0: 2269 6d61 6765 2f6a 7065 6722 0a20 2020  "image/jpeg".   
-000196d0: 2023 2073 7667 206d 696d 652d 7479 7065   # svg mime-type
-000196e0: 2069 7320 2269 6d61 6765 2f73 7667 2b78   is "image/svg+x
-000196f0: 6d6c 220a 2020 2020 6d69 6d65 5f74 7970  ml".    mime_typ
-00019700: 6520 3d20 6d61 6769 632e 6672 6f6d 5f66  e = magic.from_f
-00019710: 696c 6528 696d 6167 652c 206d 696d 653d  ile(image, mime=
-00019720: 5472 7565 290a 2020 2020 6773 2e6c 6f67  True).    gs.log
-00019730: 2e64 6562 7567 2866 2249 6d61 6765 2066  .debug(f"Image f
-00019740: 696c 6520 6d69 6d65 2d74 7970 6520 6973  ile mime-type is
-00019750: 207b 6d69 6d65 5f74 7970 657d 2229 0a20   {mime_type}"). 
-00019760: 2020 2069 6620 6e6f 7420 6d69 6d65 5f74     if not mime_t
-00019770: 7970 652e 7374 6172 7473 7769 7468 2822  ype.startswith("
-00019780: 696d 6167 652f 2229 3a0a 2020 2020 2020  image/"):.      
-00019790: 2020 6773 2e6c 6f67 2e77 6172 6e69 6e67    gs.log.warning
-000197a0: 280a 2020 2020 2020 2020 2020 2020 2257  (.            "W
-000197b0: 3130 343a 2022 0a20 2020 2020 2020 2020  104: ".         
-000197c0: 2020 2066 2249 6d61 6765 2066 696c 6520     f"Image file 
-000197d0: 7b69 6d61 6765 7d20 646f 6573 206e 6f74  {image} does not
-000197e0: 2068 6176 6520 616e 2069 6d61 6765 206d   have an image m
-000197f0: 696d 6520 7479 7065 2e20 220a 2020 2020  ime type. ".    
-00019800: 2020 2020 2020 2020 2253 686f 756c 6420          "Should 
-00019810: 6265 2073 6f6d 6574 6869 6e67 206c 696b  be something lik
-00019820: 6520 696d 6167 652f 6a70 6567 2e20 220a  e image/jpeg. ".
-00019830: 2020 2020 2020 2020 2020 2020 6622 466f              f"Fo
-00019840: 756e 6420 6d69 6d65 2074 7970 6520 7b6d  und mime type {m
-00019850: 696d 655f 7479 7065 7d2e 2022 0a20 2020  ime_type}. ".   
-00019860: 2020 2020 2020 2020 2022 5468 6973 2069           "This i
-00019870: 6d61 6765 2069 7320 6265 696e 6720 6472  mage is being dr
-00019880: 6f70 7065 6420 616e 6420 4e4f 5420 7365  opped and NOT se
-00019890: 6e74 2e22 0a20 2020 2020 2020 2029 0a20  nt.".        ). 
-000198a0: 2020 2020 2020 2067 732e 7761 726e 5f63         gs.warn_c
-000198b0: 6f75 6e74 202b 3d20 310a 2020 2020 2020  ount += 1.      
-000198c0: 2020 7265 7475 726e 0a0a 2020 2020 6966    return..    if
-000198d0: 206d 696d 655f 7479 7065 2e73 7461 7274   mime_type.start
-000198e0: 7377 6974 6828 2269 6d61 6765 2f73 7667  swith("image/svg
-000198f0: 2229 3a0a 2020 2020 2020 2020 6773 2e6c  "):.        gs.l
-00019900: 6f67 2e77 6172 6e69 6e67 280a 2020 2020  og.warning(.    
-00019910: 2020 2020 2020 2020 2257 3130 353a 2022          "W105: "
-00019920: 0a20 2020 2020 2020 2020 2020 2022 5468  .            "Th
-00019930: 6572 6520 6973 2061 2062 7567 2069 6e20  ere is a bug in 
-00019940: 456c 656d 656e 7420 7072 6576 656e 7469  Element preventi
-00019950: 6e67 2070 7265 7669 6577 7320 6f66 2053  ng previews of S
-00019960: 5647 2069 6d61 6765 732e 2022 0a20 2020  VG images. ".   
-00019970: 2020 2020 2020 2020 2022 416c 7465 726e           "Altern
-00019980: 6174 6976 656c 7920 796f 7520 6d61 7920  atively you may 
-00019990: 7365 6e64 2053 5647 2066 696c 6573 2061  send SVG files a
-000199a0: 7320 6669 6c65 7320 7669 6120 2d66 2e22  s files via -f."
-000199b0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-000199c0: 2020 2077 6964 7468 203d 2031 3030 2020     width = 100  
-000199d0: 2320 696e 2070 6978 656c 0a20 2020 2020  # in pixel.     
-000199e0: 2020 2068 6569 6768 7420 3d20 3130 300a     height = 100.
-000199f0: 2020 2020 2020 2020 2320 5079 7468 6f6e          # Python
-00019a00: 2062 6c75 7268 6173 6820 7061 636b 6167   blurhash packag
-00019a10: 6520 646f 6573 206e 6f74 2077 6f72 6b20  e does not work 
-00019a20: 6f6e 2053 5647 0a20 2020 2020 2020 2023  on SVG.        #
-00019a30: 2062 6c75 7268 6173 683a 2073 6f6d 6520   blurhash: some 
-00019a40: 7261 6e64 6f6d 2063 6f6c 6f72 6675 6c20  random colorful 
-00019a50: 696d 6167 650a 2020 2020 2020 2020 626c  image.        bl
-00019a60: 7572 6861 7368 203d 2022 554c 485f 433a  urhash = "ULH_C:
-00019a70: 3048 4746 7d42 2e24 6b3a 504c 5647 387a  0HGF}B.$k:PLVG8z
-00019a80: 7d24 343b 6f3f 7e49 513a 3924 7942 220a  }$4;o?~IQ:9$yB".
-00019a90: 2020 2020 2020 2020 626c 7572 6861 7368          blurhash
-00019aa0: 203d 204e 6f6e 6520 2023 2073 686f 7773   = None  # shows
-00019ab0: 2074 7572 6e69 6e67 2063 6972 636c 6520   turning circle 
-00019ac0: 666f 7265 7665 7220 696e 2045 6c65 6d65  forever in Eleme
-00019ad0: 6e74 2064 7565 2074 6f20 6275 670a 2020  nt due to bug.  
-00019ae0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00019af0: 696d 203d 2049 6d61 6765 2e6f 7065 6e28  im = Image.open(
-00019b00: 696d 6167 6529 2020 2320 7468 6973 2077  image)  # this w
-00019b10: 696c 6c20 6661 696c 2066 6f72 2053 5647  ill fail for SVG
-00019b20: 2066 696c 6573 0a20 2020 2020 2020 2028   files.        (
-00019b30: 7769 6474 682c 2068 6569 6768 7429 203d  width, height) =
-00019b40: 2069 6d2e 7369 7a65 2020 2320 696d 2e73   im.size  # im.s
-00019b50: 697a 6520 7265 7475 726e 7320 2877 6964  ize returns (wid
-00019b60: 7468 2c68 6569 6768 7429 2074 7570 6c65  th,height) tuple
-00019b70: 0a20 2020 2020 2020 2062 6c75 7268 6173  .        blurhas
-00019b80: 6820 3d20 4e6f 6e65 0a0a 2020 2020 2320  h = None..    # 
-00019b90: 6669 7273 7420 646f 2061 6e20 7570 6c6f  first do an uplo
-00019ba0: 6164 206f 6620 696d 6167 652c 2073 6565  ad of image, see
-00019bb0: 2075 706c 6f61 6428 2920 646f 6375 6d65   upload() docume
-00019bc0: 6e74 6174 696f 6e0a 2020 2020 2320 6874  ntation.    # ht
-00019bd0: 7470 3a2f 2f6d 6174 7269 782d 6e69 6f2e  tp://matrix-nio.
-00019be0: 7265 6164 7468 6564 6f63 732e 696f 2f65  readthedocs.io/e
-00019bf0: 6e2f 6c61 7465 7374 2f6e 696f 2e68 746d  n/latest/nio.htm
-00019c00: 6c23 6e69 6f2e 4173 796e 6343 6c69 656e  l#nio.AsyncClien
-00019c10: 742e 7570 6c6f 6164 0a20 2020 2023 2074  t.upload.    # t
-00019c20: 6865 6e20 7365 6e64 2055 5249 206f 6620  hen send URI of 
-00019c30: 7570 6c6f 6164 2074 6f20 726f 6f6d 0a20  upload to room. 
-00019c40: 2020 2023 204e 6f74 6520 7468 6174 2065     # Note that e
-00019c50: 6e63 7279 7074 6564 2075 706c 6f61 6420  ncrypted upload 
-00019c60: 776f 726b 7320 6576 656e 2077 6974 6820  works even with 
-00019c70: 756e 656e 6372 7970 7465 642f 706c 6169  unencrypted/plai
-00019c80: 6e20 726f 6f6d 733b 2074 6865 0a20 2020  n rooms; the.   
-00019c90: 2023 2064 6563 7279 7074 696f 6e20 6b65   # decryption ke
-00019ca0: 7973 2077 696c 6c20 6e6f 7420 6265 2070  ys will not be p
-00019cb0: 726f 7465 6374 6564 2c20 6f62 7669 6f75  rotected, obviou
-00019cc0: 736c 792c 2062 7574 206e 6f20 7370 6563  sly, but no spec
-00019cd0: 6961 6c0a 2020 2020 2320 7472 6561 746d  ial.    # treatm
-00019ce0: 656e 7420 6973 2072 6571 7569 7265 642e  ent is required.
-00019cf0: 0a0a 2020 2020 6669 6c65 5f73 7461 7420  ..    file_stat 
-00019d00: 3d20 6177 6169 7420 6169 6f66 696c 6573  = await aiofiles
-00019d10: 2e6f 732e 7374 6174 2869 6d61 6765 290a  .os.stat(image).
-00019d20: 2020 2020 6173 796e 6320 7769 7468 2061      async with a
-00019d30: 696f 6669 6c65 732e 6f70 656e 2869 6d61  iofiles.open(ima
-00019d40: 6765 2c20 2272 2b62 2229 2061 7320 663a  ge, "r+b") as f:
-00019d50: 0a20 2020 2020 2020 2072 6573 702c 2064  .        resp, d
-00019d60: 6563 7279 7074 696f 6e5f 6b65 7973 203d  ecryption_keys =
-00019d70: 2061 7761 6974 2063 6c69 656e 742e 7570   await client.up
-00019d80: 6c6f 6164 280a 2020 2020 2020 2020 2020  load(.          
-00019d90: 2020 662c 0a20 2020 2020 2020 2020 2020    f,.           
-00019da0: 2063 6f6e 7465 6e74 5f74 7970 653d 6d69   content_type=mi
-00019db0: 6d65 5f74 7970 652c 2020 2320 696d 6167  me_type,  # imag
-00019dc0: 652f 6a70 6567 0a20 2020 2020 2020 2020  e/jpeg.         
-00019dd0: 2020 2066 696c 656e 616d 653d 6f73 2e70     filename=os.p
-00019de0: 6174 682e 6261 7365 6e61 6d65 2869 6d61  ath.basename(ima
-00019df0: 6765 292c 0a20 2020 2020 2020 2020 2020  ge),.           
-00019e00: 2066 696c 6573 697a 653d 6669 6c65 5f73   filesize=file_s
-00019e10: 7461 742e 7374 5f73 697a 652c 0a20 2020  tat.st_size,.   
-00019e20: 2020 2020 2020 2020 2065 6e63 7279 7074           encrypt
-00019e30: 3d54 7275 652c 0a20 2020 2020 2020 2029  =True,.        )
-00019e40: 0a20 2020 2069 6620 6973 696e 7374 616e  .    if isinstan
-00019e50: 6365 2872 6573 702c 2055 706c 6f61 6452  ce(resp, UploadR
-00019e60: 6573 706f 6e73 6529 3a0a 2020 2020 2020  esponse):.      
-00019e70: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
-00019e80: 2020 2020 2020 2020 2020 2020 2249 6d61              "Ima
-00019e90: 6765 2077 6173 2075 706c 6f61 6465 6420  ge was uploaded 
-00019ea0: 7375 6363 6573 7366 756c 6c79 2074 6f20  successfully to 
-00019eb0: 7365 7276 6572 2e20 220a 2020 2020 2020  server. ".      
-00019ec0: 2020 2020 2020 6622 5265 7370 6f6e 7365        f"Response
-00019ed0: 2069 733a 207b 7072 6976 6163 795f 6669   is: {privacy_fi
-00019ee0: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
-00019ef0: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
-00019f00: 656c 7365 3a0a 2020 2020 2020 2020 6773  else:.        gs
-00019f10: 2e6c 6f67 2e69 6e66 6f28 0a20 2020 2020  .log.info(.     
-00019f20: 2020 2020 2020 2066 2254 6865 2070 726f         f"The pro
-00019f30: 6772 616d 207b 5052 4f47 5f57 4954 485f  gram {PROG_WITH_
-00019f40: 4558 547d 2066 6169 6c65 6420 746f 2075  EXT} failed to u
-00019f50: 706c 6f61 642e 2022 0a20 2020 2020 2020  pload. ".       
-00019f60: 2020 2020 2022 506c 6561 7365 2072 6574       "Please ret
-00019f70: 7279 2e20 5468 6973 2063 6f75 6c64 2062  ry. This could b
-00019f80: 6520 7465 6d70 6f72 6172 7920 6973 7375  e temporary issu
-00019f90: 6520 6f6e 2022 0a20 2020 2020 2020 2020  e on ".         
-00019fa0: 2020 2022 796f 7572 2073 6572 7665 722e     "your server.
-00019fb0: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-00019fc0: 536f 7272 792e 220a 2020 2020 2020 2020  Sorry.".        
-00019fd0: 290a 2020 2020 2020 2020 6773 2e6c 6f67  ).        gs.log
-00019fe0: 2e69 6e66 6f28 0a20 2020 2020 2020 2020  .info(.         
-00019ff0: 2020 2066 2766 696c 653d 227b 696d 6167     f'file="{imag
-0001a000: 657d 223b 206d 696d 655f 7479 7065 3d22  e}"; mime_type="
-0001a010: 7b6d 696d 655f 7479 7065 7d22 3b20 270a  {mime_type}"; '.
-0001a020: 2020 2020 2020 2020 2020 2020 6627 6669              f'fi
-0001a030: 6c65 7373 697a 653d 227b 6669 6c65 5f73  lessize="{file_s
-0001a040: 7461 742e 7374 5f73 697a 657d 2227 0a20  tat.st_size}"'. 
-0001a050: 2020 2020 2020 2020 2020 2066 2246 6169             f"Fai
-0001a060: 6c65 6420 746f 2075 706c 6f61 643a 207b  led to upload: {
-0001a070: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
-0001a080: 7472 2872 6573 7029 297d 220a 2020 2020  tr(resp))}".    
-0001a090: 2020 2020 290a 0a20 2020 2023 2054 4f44      )..    # TOD
-0001a0a0: 4f20 636f 6d70 7574 6520 7468 756d 626e  O compute thumbn
-0001a0b0: 6169 6c2c 2075 706c 6f61 6420 7468 756d  ail, upload thum
-0001a0c0: 626e 6169 6c20 746f 2053 6572 7665 720a  bnail to Server.
-0001a0d0: 2020 2020 2320 544f 444f 2061 6464 2074      # TODO add t
-0001a0e0: 6875 6d62 6e61 696c 2069 6e66 6f20 746f  humbnail info to
-0001a0f0: 2060 636f 6e74 656e 7460 0a0a 2020 2020   `content`..    
-0001a100: 636f 6e74 656e 7420 3d20 7b0a 2020 2020  content = {.    
-0001a110: 2020 2020 2262 6f64 7922 3a20 6f73 2e70      "body": os.p
-0001a120: 6174 682e 6261 7365 6e61 6d65 2869 6d61  ath.basename(ima
-0001a130: 6765 292c 2020 2320 6465 7363 7269 7074  ge),  # descript
-0001a140: 6976 6520 7469 746c 650a 2020 2020 2020  ive title.      
-0001a150: 2020 2269 6e66 6f22 3a20 7b0a 2020 2020    "info": {.    
-0001a160: 2020 2020 2020 2020 2273 697a 6522 3a20          "size": 
-0001a170: 6669 6c65 5f73 7461 742e 7374 5f73 697a  file_stat.st_siz
-0001a180: 652c 0a20 2020 2020 2020 2020 2020 2022  e,.            "
-0001a190: 6d69 6d65 7479 7065 223a 206d 696d 655f  mimetype": mime_
-0001a1a0: 7479 7065 2c0a 2020 2020 2020 2020 2020  type,.          
-0001a1b0: 2020 2320 2274 6875 6d62 6e61 696c 5f69    # "thumbnail_i
-0001a1c0: 6e66 6f22 3a20 4e6f 6e65 2c20 2023 2054  nfo": None,  # T
-0001a1d0: 4f44 4f0a 2020 2020 2020 2020 2020 2020  ODO.            
-0001a1e0: 2277 223a 2077 6964 7468 2c20 2023 2077  "w": width,  # w
-0001a1f0: 6964 7468 2069 6e20 7069 7865 6c0a 2020  idth in pixel.  
-0001a200: 2020 2020 2020 2020 2020 2268 223a 2068            "h": h
-0001a210: 6569 6768 742c 2020 2320 6865 6967 6874  eight,  # height
-0001a220: 2069 6e20 7069 7865 6c0a 2020 2020 2020   in pixel.      
-0001a230: 2020 2020 2020 2320 2274 6875 6d62 6e61        # "thumbna
-0001a240: 696c 5f75 726c 223a 204e 6f6e 652c 2020  il_url": None,  
-0001a250: 2320 544f 444f 0a20 2020 2020 2020 2020  # TODO.         
-0001a260: 2020 2022 7879 7a2e 616d 6f72 6761 6e2e     "xyz.amorgan.
-0001a270: 626c 7572 6861 7368 223a 2062 6c75 7268  blurhash": blurh
-0001a280: 6173 680a 2020 2020 2020 2020 2020 2020  ash.            
-0001a290: 2320 2274 6875 6d62 6e61 696c 5f66 696c  # "thumbnail_fil
-0001a2a0: 6522 3a20 4e6f 6e65 2c0a 2020 2020 2020  e": None,.      
-0001a2b0: 2020 7d2c 0a20 2020 2020 2020 2022 6d73    },.        "ms
-0001a2c0: 6774 7970 6522 3a20 226d 2e69 6d61 6765  gtype": "m.image
-0001a2d0: 222c 0a20 2020 2020 2020 2022 6669 6c65  ",.        "file
-0001a2e0: 223a 207b 0a20 2020 2020 2020 2020 2020  ": {.           
-0001a2f0: 2022 7572 6c22 3a20 7265 7370 2e63 6f6e   "url": resp.con
-0001a300: 7465 6e74 5f75 7269 2c0a 2020 2020 2020  tent_uri,.      
-0001a310: 2020 2020 2020 226b 6579 223a 2064 6563        "key": dec
-0001a320: 7279 7074 696f 6e5f 6b65 7973 5b22 6b65  ryption_keys["ke
-0001a330: 7922 5d2c 0a20 2020 2020 2020 2020 2020  y"],.           
-0001a340: 2022 6976 223a 2064 6563 7279 7074 696f   "iv": decryptio
-0001a350: 6e5f 6b65 7973 5b22 6976 225d 2c0a 2020  n_keys["iv"],.  
-0001a360: 2020 2020 2020 2020 2020 2268 6173 6865            "hashe
-0001a370: 7322 3a20 6465 6372 7970 7469 6f6e 5f6b  s": decryption_k
-0001a380: 6579 735b 2268 6173 6865 7322 5d2c 0a20  eys["hashes"],. 
-0001a390: 2020 2020 2020 2020 2020 2022 7622 3a20             "v": 
-0001a3a0: 6465 6372 7970 7469 6f6e 5f6b 6579 735b  decryption_keys[
-0001a3b0: 2276 225d 2c0a 2020 2020 2020 2020 7d2c  "v"],.        },
-0001a3c0: 0a20 2020 207d 0a0a 2020 2020 6966 2069  .    }..    if i
-0001a3d0: 7350 6970 653a 0a20 2020 2020 2020 2023  sPipe:.        #
-0001a3e0: 2072 6d20 7465 6d70 2066 696c 650a 2020   rm temp file.  
-0001a3f0: 2020 2020 2020 6f73 2e72 656d 6f76 6528        os.remove(
-0001a400: 696d 6167 6529 0a0a 2020 2020 7472 793a  image)..    try:
-0001a410: 0a20 2020 2020 2020 2066 6f72 2072 6f6f  .        for roo
-0001a420: 6d5f 6964 2069 6e20 726f 6f6d 733a 0a20  m_id in rooms:. 
-0001a430: 2020 2020 2020 2020 2020 2072 6f6f 6d5f             room_
-0001a440: 6964 203d 2061 7761 6974 206d 6170 5f72  id = await map_r
-0001a450: 6f6f 6d69 6e66 6f5f 746f 5f72 6f6f 6d69  oominfo_to_roomi
-0001a460: 6428 636c 6965 6e74 2c20 726f 6f6d 5f69  d(client, room_i
-0001a470: 6429 0a20 2020 2020 2020 2020 2020 2072  d).            r
-0001a480: 6573 7020 3d20 6177 6169 7420 636c 6965  esp = await clie
-0001a490: 6e74 2e72 6f6f 6d5f 7365 6e64 280a 2020  nt.room_send(.  
-0001a4a0: 2020 2020 2020 2020 2020 2020 2020 726f                ro
-0001a4b0: 6f6d 5f69 642c 206d 6573 7361 6765 5f74  om_id, message_t
-0001a4c0: 7970 653d 226d 2e72 6f6f 6d2e 6d65 7373  ype="m.room.mess
-0001a4d0: 6167 6522 2c20 636f 6e74 656e 743d 636f  age", content=co
-0001a4e0: 6e74 656e 740a 2020 2020 2020 2020 2020  ntent.          
-0001a4f0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0001a500: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
-0001a510: 7370 2c20 526f 6f6d 5365 6e64 4572 726f  sp, RoomSendErro
-0001a520: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-0001a530: 2020 2020 6773 2e6c 6f67 2e65 7272 6f72      gs.log.error
-0001a540: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001a550: 2020 2020 2020 2245 3134 383a 2022 0a20        "E148: ". 
-0001a560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a570: 2020 2022 726f 6f6d 5f73 656e 6420 6661     "room_send fa
-0001a580: 696c 6564 2077 6974 6820 6572 726f 7220  iled with error 
-0001a590: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0001a5a0: 2020 2020 2020 6622 277b 7072 6976 6163        f"'{privac
-0001a5b0: 795f 6669 6c74 6572 2873 7472 2872 6573  y_filter(str(res
-0001a5c0: 7029 297d 272e 220a 2020 2020 2020 2020  p))}'.".        
-0001a5d0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001a5e0: 2020 2020 2020 2020 2020 2320 6773 2e65            # gs.e
-0001a5f0: 7272 5f63 6f75 6e74 202b 3d20 3120 2320  rr_count += 1 # 
-0001a600: 6e6f 7420 6e65 6564 6564 2c20 7769 6c6c  not needed, will
-0001a610: 2072 6169 7365 2065 7863 6570 7469 6f6e   raise exception
-0001a620: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a630: 2023 2069 6e20 666f 6c6c 6f77 696e 6720   # in following 
-0001a640: 6c69 6e65 206f 6620 636f 6465 0a20 2020  line of code.   
-0001a650: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
-0001a660: 696e 666f 280a 2020 2020 2020 2020 2020  info(.          
-0001a670: 2020 2020 2020 6627 5468 6973 2069 6d61        f'This ima
-0001a680: 6765 2066 696c 6520 7761 7320 7365 6e74  ge file was sent
-0001a690: 3a20 227b 696d 6167 657d 2220 270a 2020  : "{image}" '.  
-0001a6a0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-0001a6b0: 746f 2072 6f6f 6d20 227b 7265 7370 2e72  to room "{resp.r
-0001a6c0: 6f6f 6d5f 6964 7d22 2027 0a20 2020 2020  oom_id}" '.     
-0001a6d0: 2020 2020 2020 2020 2020 2066 2761 7320             f'as 
-0001a6e0: 6576 656e 7420 227b 7265 7370 2e65 7665  event "{resp.eve
-0001a6f0: 6e74 5f69 647d 222e 270a 2020 2020 2020  nt_id}".'.      
-0001a700: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0001a710: 2020 2020 6966 2067 732e 7061 2e70 7269      if gs.pa.pri
-0001a720: 6e74 5f65 7665 6e74 5f69 643a 0a20 2020  nt_event_id:.   
-0001a730: 2020 2020 2020 2020 2020 2020 2023 206f               # o
-0001a740: 7574 7075 7420 666f 726d 6174 2063 6f6e  utput format con
-0001a750: 7472 6f6c 6c65 6420 7669 6120 2d2d 6f75  trolled via --ou
-0001a760: 7470 7574 2066 6c61 670a 2020 2020 2020  tput flag.      
-0001a770: 2020 2020 2020 2020 2020 7465 7874 203d            text =
-0001a780: 2066 227b 7265 7370 2e65 7665 6e74 5f69   f"{resp.event_i
-0001a790: 647d 7b53 4550 7d7b 7265 7370 2e72 6f6f  d}{SEP}{resp.roo
-0001a7a0: 6d5f 6964 7d7b 5345 507d 7b69 6d61 6765  m_id}{SEP}{image
-0001a7b0: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
-0001a7c0: 2020 2023 204f 626a 6563 7420 6f66 2074     # Object of t
-0001a7d0: 7970 6520 526f 6f6d 4372 6561 7465 5265  ype RoomCreateRe
-0001a7e0: 7370 6f6e 7365 2069 7320 6e6f 7420 4a53  sponse is not JS
-0001a7f0: 4f4e 0a20 2020 2020 2020 2020 2020 2020  ON.             
-0001a800: 2020 2023 2073 6572 6961 6c69 7a61 626c     # serializabl
-0001a810: 652c 2068 656e 6365 2077 6520 7573 6520  e, hence we use 
-0001a820: 7468 6520 6469 6374 696f 6e61 7279 2e0a  the dictionary..
-0001a830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a840: 6a73 6f6e 5f6d 6178 203d 2072 6573 702e  json_max = resp.
-0001a850: 5f5f 6469 6374 5f5f 0a20 2020 2020 2020  __dict__.       
-0001a860: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
-0001a870: 782e 7570 6461 7465 287b 2269 6d61 6765  x.update({"image
-0001a880: 223a 2069 6d61 6765 7d29 2020 2320 6164  ": image})  # ad
-0001a890: 6420 6469 6374 2069 7465 6d73 0a20 2020  d dict items.   
-0001a8a0: 2020 2020 2020 2020 2020 2020 206a 736f               jso
-0001a8b0: 6e5f 203d 206a 736f 6e5f 6d61 782e 636f  n_ = json_max.co
-0001a8c0: 7079 2829 0a20 2020 2020 2020 2020 2020  py().           
-0001a8d0: 2020 2020 206a 736f 6e5f 2e70 6f70 2822       json_.pop("
-0001a8e0: 7472 616e 7370 6f72 745f 7265 7370 6f6e  transport_respon
-0001a8f0: 7365 2229 0a20 2020 2020 2020 2020 2020  se").           
-0001a900: 2020 2020 206a 736f 6e5f 7370 6563 203d       json_spec =
-0001a910: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-0001a920: 2020 2020 2020 7072 696e 745f 6f75 7470        print_outp
-0001a930: 7574 280a 2020 2020 2020 2020 2020 2020  ut(.            
-0001a940: 2020 2020 2020 2020 6773 2e70 612e 6f75          gs.pa.ou
-0001a950: 7470 7574 2c0a 2020 2020 2020 2020 2020  tput,.          
-0001a960: 2020 2020 2020 2020 2020 7465 7874 3d74            text=t
-0001a970: 6578 742c 0a20 2020 2020 2020 2020 2020  ext,.           
-0001a980: 2020 2020 2020 2020 206a 736f 6e5f 3d6a           json_=j
-0001a990: 736f 6e5f 2c0a 2020 2020 2020 2020 2020  son_,.          
-0001a9a0: 2020 2020 2020 2020 2020 6a73 6f6e 5f6d            json_m
-0001a9b0: 6178 3d6a 736f 6e5f 6d61 782c 0a20 2020  ax=json_max,.   
-0001a9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a9d0: 206a 736f 6e5f 7370 6563 3d6a 736f 6e5f   json_spec=json_
-0001a9e0: 7370 6563 2c0a 2020 2020 2020 2020 2020  spec,.          
-0001a9f0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0001aa00: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-0001aa10: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001aa20: 2020 6627 5468 6973 2069 6d61 6765 2066    f'This image f
-0001aa30: 696c 6520 7761 7320 7365 6e74 3a20 227b  ile was sent: "{
-0001aa40: 696d 6167 657d 2220 270a 2020 2020 2020  image}" '.      
-0001aa50: 2020 2020 2020 2020 2020 6627 746f 2072            f'to r
-0001aa60: 6f6f 6d20 227b 726f 6f6d 5f69 647d 222e  oom "{room_id}".
-0001aa70: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0001aa80: 2020 2066 2252 6573 706f 6e73 653a 2065     f"Response: e
-0001aa90: 7665 6e74 5f69 643d 7b72 6573 702e 6576  vent_id={resp.ev
-0001aaa0: 656e 745f 6964 7d2c 2072 6f6f 6d5f 6964  ent_id}, room_id
-0001aab0: 3d7b 7265 7370 2e72 6f6f 6d5f 6964 7d2c  ={resp.room_id},
-0001aac0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-0001aad0: 2020 2066 2266 756c 6c20 7265 7370 6f6e     f"full respon
-0001aae0: 7365 3a20 7b70 7269 7661 6379 5f66 696c  se: {privacy_fil
-0001aaf0: 7465 7228 7374 7228 7265 7370 2929 7d2e  ter(str(resp))}.
-0001ab00: 2022 0a20 2020 2020 2020 2020 2020 2029   ".            )
-0001ab10: 0a20 2020 2065 7863 6570 7420 4578 6365  .    except Exce
-0001ab20: 7074 696f 6e3a 0a20 2020 2020 2020 2067  ption:.        g
-0001ab30: 732e 6c6f 672e 6572 726f 7228 2245 3134  s.log.error("E14
-0001ab40: 393a 2022 2066 2249 6d61 6765 2073 656e  9: " f"Image sen
-0001ab50: 6420 6f66 2066 696c 6520 7b69 6d61 6765  d of file {image
-0001ab60: 7d20 6661 696c 6564 2e20 536f 7272 792e  } failed. Sorry.
-0001ab70: 2229 0a20 2020 2020 2020 2067 732e 6572  ").        gs.er
-0001ab80: 725f 636f 756e 7420 2b3d 2031 0a20 2020  r_count += 1.   
-0001ab90: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-0001aba0: 6728 2248 6572 6520 6973 2074 6865 2074  g("Here is the t
-0001abb0: 7261 6365 6261 636b 2e5c 6e22 202b 2074  raceback.\n" + t
-0001abc0: 7261 6365 6261 636b 2e66 6f72 6d61 745f  raceback.format_
-0001abd0: 6578 6328 2929 0a0a 0a23 2061 6363 6f72  exc())...# accor
-0001abe0: 6469 6e67 2074 6f20 6c69 6e74 6572 3a20  ding to linter: 
-0001abf0: 6675 6e63 7469 6f6e 2069 7320 746f 6f20  function is too 
-0001ac00: 636f 6d70 6c65 782c 2043 3930 310a 6173  complex, C901.as
-0001ac10: 796e 6320 6465 6620 7365 6e64 5f6d 6573  ync def send_mes
-0001ac20: 7361 6765 2863 6c69 656e 742c 2072 6f6f  sage(client, roo
-0001ac30: 6d73 2c20 6d65 7373 6167 6529 3a20 2023  ms, message):  #
-0001ac40: 206e 6f71 613a 2043 3930 310a 2020 2020   noqa: C901.    
-0001ac50: 2222 2250 726f 6365 7373 206d 6573 7361  """Process messa
-0001ac60: 6765 2e0a 0a20 2020 2046 6f72 6d61 7420  ge...    Format 
-0001ac70: 6d65 7373 6167 6520 6163 636f 7264 696e  message accordin
-0001ac80: 6720 746f 2069 6e73 7472 7563 7469 6f6e  g to instruction
-0001ac90: 7320 6672 6f6d 2063 6f6d 6d61 6e64 206c  s from command l
-0001aca0: 696e 6520 6172 6775 6d65 6e74 732e 0a20  ine arguments.. 
-0001acb0: 2020 2054 6865 6e20 7365 6e64 2074 6865     Then send the
-0001acc0: 206f 6e65 206d 6573 7361 6765 2074 6f20   one message to 
-0001acd0: 616c 6c20 726f 6f6d 732e 0a0a 2020 2020  all rooms...    
-0001ace0: 4172 6775 6d65 6e74 733a 0a20 2020 202d  Arguments:.    -
-0001acf0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063 6c69  --------.    cli
-0001ad00: 656e 7420 3a20 436c 6965 6e74 0a20 2020  ent : Client.   
-0001ad10: 2072 6f6f 6d73 203a 206c 6973 740a 2020   rooms : list.  
-0001ad20: 2020 2020 2020 6c69 7374 206f 6620 726f        list of ro
-0001ad30: 6f6d 5f69 642d 730a 2020 2020 6d65 7373  om_id-s.    mess
-0001ad40: 6167 6520 3a20 7374 720a 2020 2020 2020  age : str.      
-0001ad50: 2020 6d65 7373 6167 6520 746f 2073 656e    message to sen
-0001ad60: 6420 6173 2072 6561 6420 6672 6f6d 202d  d as read from -
-0001ad70: 6d2c 2070 6970 6520 6f72 206b 6579 626f  m, pipe or keybo
-0001ad80: 6172 640a 2020 2020 2020 2020 6d65 7373  ard.        mess
-0001ad90: 6167 6520 6973 2077 6974 686f 7574 206d  age is without m
-0001ada0: 696d 6520 666f 726d 6174 7469 6e67 0a0a  ime formatting..
-0001adb0: 2020 2020 2222 220a 2020 2020 6966 206e      """.    if n
-0001adc0: 6f74 2072 6f6f 6d73 3a0a 2020 2020 2020  ot rooms:.      
-0001add0: 2020 6773 2e6c 6f67 2e69 6e66 6f28 0a20    gs.log.info(. 
-0001ade0: 2020 2020 2020 2020 2020 2022 4e6f 2072             "No r
-0001adf0: 6f6f 6d73 2061 7265 2067 6976 656e 2e20  ooms are given. 
-0001ae00: 5468 6973 2073 686f 756c 6420 6e6f 7420  This should not 
-0001ae10: 6861 7070 656e 2e20 220a 2020 2020 2020  happen. ".      
-0001ae20: 2020 2020 2020 224d 6179 6265 2079 6f75        "Maybe you
-0001ae30: 7220 444d 2072 6f6f 6d73 2073 7065 6369  r DM rooms speci
-0001ae40: 6669 6564 2076 6961 202d 2d75 7365 7220  fied via --user 
-0001ae50: 7765 7265 206e 6f74 2066 6f75 6e64 2e20  were not found. 
-0001ae60: 220a 2020 2020 2020 2020 2020 2020 2254  ".            "T
-0001ae70: 6869 7320 7465 7874 206d 6573 7361 6765  his text message
-0001ae80: 2069 7320 6265 696e 6720 6472 6f70 7065   is being droppe
-0001ae90: 6420 616e 6420 4e4f 5420 7365 6e74 2e22  d and NOT sent."
-0001aea0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0001aeb0: 2020 2072 6574 7572 6e0a 2020 2020 2320     return.    # 
-0001aec0: 7265 6d6f 7665 206c 6561 6469 6e67 2041  remove leading A
-0001aed0: 4e44 2074 7261 696c 696e 6720 6e65 776c  ND trailing newl
-0001aee0: 696e 6573 2074 6f20 6265 6175 7469 6679  ines to beautify
-0001aef0: 0a20 2020 206d 6573 7361 6765 203d 206d  .    message = m
-0001af00: 6573 7361 6765 2e73 7472 6970 2822 5c6e  essage.strip("\n
-0001af10: 2229 0a0a 2020 2020 6966 206d 6573 7361  ")..    if messa
-0001af20: 6765 2e73 7472 6970 2829 203d 3d20 2222  ge.strip() == ""
-0001af30: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
-0001af40: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-0001af50: 2020 2020 2254 6865 206d 6573 7361 6765      "The message
-0001af60: 2069 7320 656d 7074 792e 2022 0a20 2020   is empty. ".   
-0001af70: 2020 2020 2020 2020 2022 5468 6973 206d           "This m
-0001af80: 6573 7361 6765 2069 7320 6265 696e 6720  essage is being 
-0001af90: 6472 6f70 7065 6420 616e 6420 4e4f 5420  dropped and NOT 
-0001afa0: 7365 6e74 2e22 0a20 2020 2020 2020 2029  sent.".        )
-0001afb0: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
-0001afc0: 0a20 2020 2069 6620 6773 2e70 612e 6e6f  .    if gs.pa.no
-0001afd0: 7469 6365 3a0a 2020 2020 2020 2020 636f  tice:.        co
-0001afe0: 6e74 656e 7420 3d20 7b22 6d73 6774 7970  ntent = {"msgtyp
-0001aff0: 6522 3a20 226d 2e6e 6f74 6963 6522 7d0a  e": "m.notice"}.
-0001b000: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001b010: 2020 636f 6e74 656e 7420 3d20 7b22 6d73    content = {"ms
-0001b020: 6774 7970 6522 3a20 226d 2e74 6578 7422  gtype": "m.text"
-0001b030: 7d0a 0a20 2020 2069 6620 6773 2e70 612e  }..    if gs.pa.
-0001b040: 636f 6465 3a0a 2020 2020 2020 2020 6773  code:.        gs
-0001b050: 2e6c 6f67 2e64 6562 7567 2827 5365 6e64  .log.debug('Send
-0001b060: 696e 6720 6d65 7373 6167 6520 696e 2066  ing message in f
-0001b070: 6f72 6d61 7420 2263 6f64 6522 2e27 290a  ormat "code".').
-0001b080: 2020 2020 2020 2020 666f 726d 6174 7465          formatte
-0001b090: 645f 6d65 7373 6167 6520 3d20 223c 7072  d_message = "<pr
-0001b0a0: 653e 3c63 6f64 653e 2220 2b20 6d65 7373  e><code>" + mess
-0001b0b0: 6167 6520 2b20 225c 6e3c 2f63 6f64 653e  age + "\n</code>
-0001b0c0: 3c2f 7072 653e 5c6e 220a 2020 2020 2020  </pre>\n".      
-0001b0d0: 2020 636f 6e74 656e 745b 2266 6f72 6d61    content["forma
-0001b0e0: 7422 5d20 3d20 226f 7267 2e6d 6174 7269  t"] = "org.matri
-0001b0f0: 782e 6375 7374 6f6d 2e68 746d 6c22 2020  x.custom.html"  
-0001b100: 2320 6164 6420 746f 2064 6963 740a 2020  # add to dict.  
-0001b110: 2020 2020 2020 636f 6e74 656e 745b 2266        content["f
-0001b120: 6f72 6d61 7474 6564 5f62 6f64 7922 5d20  ormatted_body"] 
-0001b130: 3d20 666f 726d 6174 7465 645f 6d65 7373  = formatted_mess
-0001b140: 6167 650a 2020 2020 2020 2020 2320 6e65  age.        # ne
-0001b150: 7874 206c 696e 653a 2077 6f72 6b2d 6172  xt line: work-ar
-0001b160: 6f75 6e64 2066 6f72 2045 6c65 6d65 6e74  ound for Element
-0001b170: 2041 6e64 726f 6964 0a20 2020 2020 2020   Android.       
-0001b180: 206d 6573 7361 6765 203d 2022 6060 605c   message = "```\
-0001b190: 6e22 202b 206d 6573 7361 6765 202b 2022  n" + message + "
-0001b1a0: 5c6e 6060 6022 2020 2320 746f 2066 6f72  \n```"  # to for
-0001b1b0: 6d61 7420 6974 2061 7320 636f 6465 0a20  mat it as code. 
-0001b1c0: 2020 2065 6c69 6620 6773 2e70 612e 6d61     elif gs.pa.ma
-0001b1d0: 726b 646f 776e 3a0a 2020 2020 2020 2020  rkdown:.        
-0001b1e0: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
-0001b1f0: 2020 2020 2020 2020 2020 2243 6f6e 7665            "Conve
-0001b200: 7274 696e 6720 6d65 7373 6167 6520 6672  rting message fr
-0001b210: 6f6d 204d 6172 6b44 6f77 6e20 696e 746f  om MarkDown into
-0001b220: 2048 544d 4c2e 2022 0a20 2020 2020 2020   HTML. ".       
-0001b230: 2020 2020 2027 5365 6e64 696e 6720 6d65       'Sending me
-0001b240: 7373 6167 6520 696e 2066 6f72 6d61 7420  ssage in format 
-0001b250: 226d 6172 6b64 6f77 6e22 2e27 0a20 2020  "markdown".'.   
-0001b260: 2020 2020 2029 0a20 2020 2020 2020 2023       ).        #
-0001b270: 2065 2e67 2e20 636f 6e76 6572 7473 2066   e.g. converts f
-0001b280: 726f 6d20 222d 6162 6322 2074 6f20 223c  rom "-abc" to "<
-0001b290: 756c 3e3c 6c69 3e61 6263 3c2f 6c69 3e3c  ul><li>abc</li><
-0001b2a0: 2f75 6c3e 220a 2020 2020 2020 2020 666f  /ul>".        fo
-0001b2b0: 726d 6174 7465 645f 6d65 7373 6167 6520  rmatted_message 
-0001b2c0: 3d20 6d61 726b 646f 776e 286d 6573 7361  = markdown(messa
-0001b2d0: 6765 290a 2020 2020 2020 2020 636f 6e74  ge).        cont
-0001b2e0: 656e 745b 2266 6f72 6d61 7422 5d20 3d20  ent["format"] = 
-0001b2f0: 226f 7267 2e6d 6174 7269 782e 6375 7374  "org.matrix.cust
-0001b300: 6f6d 2e68 746d 6c22 2020 2320 6164 6420  om.html"  # add 
-0001b310: 746f 2064 6963 740a 2020 2020 2020 2020  to dict.        
-0001b320: 636f 6e74 656e 745b 2266 6f72 6d61 7474  content["formatt
-0001b330: 6564 5f62 6f64 7922 5d20 3d20 666f 726d  ed_body"] = form
-0001b340: 6174 7465 645f 6d65 7373 6167 650a 2020  atted_message.  
-0001b350: 2020 656c 6966 2067 732e 7061 2e68 746d    elif gs.pa.htm
-0001b360: 6c3a 0a20 2020 2020 2020 2067 732e 6c6f  l:.        gs.lo
-0001b370: 672e 6465 6275 6728 2753 656e 6469 6e67  g.debug('Sending
-0001b380: 206d 6573 7361 6765 2069 6e20 666f 726d   message in form
-0001b390: 6174 2022 6874 6d6c 222e 2729 0a20 2020  at "html".').   
-0001b3a0: 2020 2020 2066 6f72 6d61 7474 6564 5f6d       formatted_m
-0001b3b0: 6573 7361 6765 203d 206d 6573 7361 6765  essage = message
-0001b3c0: 2020 2320 7468 6520 7361 6d65 2066 6f72    # the same for
-0001b3d0: 2074 6865 2074 696d 6520 6265 696e 670a   the time being.
-0001b3e0: 2020 2020 2020 2020 636f 6e74 656e 745b          content[
-0001b3f0: 2266 6f72 6d61 7422 5d20 3d20 226f 7267  "format"] = "org
-0001b400: 2e6d 6174 7269 782e 6375 7374 6f6d 2e68  .matrix.custom.h
-0001b410: 746d 6c22 2020 2320 6164 6420 746f 2064  tml"  # add to d
-0001b420: 6963 740a 2020 2020 2020 2020 636f 6e74  ict.        cont
-0001b430: 656e 745b 2266 6f72 6d61 7474 6564 5f62  ent["formatted_b
-0001b440: 6f64 7922 5d20 3d20 666f 726d 6174 7465  ody"] = formatte
-0001b450: 645f 6d65 7373 6167 650a 2020 2020 656c  d_message.    el
-0001b460: 7365 3a0a 2020 2020 2020 2020 6773 2e6c  se:.        gs.l
-0001b470: 6f67 2e64 6562 7567 2827 5365 6e64 696e  og.debug('Sendin
-0001b480: 6720 6d65 7373 6167 6520 696e 2066 6f72  g message in for
-0001b490: 6d61 7420 2274 6578 7422 2e27 290a 2020  mat "text".').  
-0001b4a0: 2020 636f 6e74 656e 745b 2262 6f64 7922    content["body"
-0001b4b0: 5d20 3d20 6d65 7373 6167 650a 0a20 2020  ] = message..   
-0001b4c0: 2074 7279 3a0a 2020 2020 2020 2020 666f   try:.        fo
-0001b4d0: 7220 726f 6f6d 5f69 6420 696e 2072 6f6f  r room_id in roo
-0001b4e0: 6d73 3a0a 2020 2020 2020 2020 2020 2020  ms:.            
-0001b4f0: 726f 6f6d 5f69 6420 3d20 6177 6169 7420  room_id = await 
-0001b500: 6d61 705f 726f 6f6d 696e 666f 5f74 6f5f  map_roominfo_to_
-0001b510: 726f 6f6d 6964 2863 6c69 656e 742c 2072  roomid(client, r
-0001b520: 6f6f 6d5f 6964 290a 2020 2020 2020 2020  oom_id).        
-0001b530: 2020 2020 7265 7370 203d 2061 7761 6974      resp = await
-0001b540: 2063 6c69 656e 742e 726f 6f6d 5f73 656e   client.room_sen
-0001b550: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
-0001b560: 2020 2072 6f6f 6d5f 6964 2c0a 2020 2020     room_id,.    
-0001b570: 2020 2020 2020 2020 2020 2020 6d65 7373              mess
-0001b580: 6167 655f 7479 7065 3d22 6d2e 726f 6f6d  age_type="m.room
-0001b590: 2e6d 6573 7361 6765 222c 0a20 2020 2020  .message",.     
-0001b5a0: 2020 2020 2020 2020 2020 2063 6f6e 7465             conte
-0001b5b0: 6e74 3d63 6f6e 7465 6e74 2c0a 2020 2020  nt=content,.    
-0001b5c0: 2020 2020 2020 2020 2020 2020 6967 6e6f              igno
-0001b5d0: 7265 5f75 6e76 6572 6966 6965 645f 6465  re_unverified_de
-0001b5e0: 7669 6365 733d 5472 7565 2c0a 2020 2020  vices=True,.    
-0001b5f0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001b600: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-0001b610: 6e63 6528 7265 7370 2c20 526f 6f6d 5365  nce(resp, RoomSe
-0001b620: 6e64 4572 726f 7229 3a0a 2020 2020 2020  ndError):.      
-0001b630: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-0001b640: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
-0001b650: 2020 2020 2020 2020 2020 2020 2245 3135              "E15
-0001b660: 303a 2022 0a20 2020 2020 2020 2020 2020  0: ".           
-0001b670: 2020 2020 2020 2020 2022 726f 6f6d 5f73           "room_s
-0001b680: 656e 6420 6661 696c 6564 2077 6974 6820  end failed with 
-0001b690: 6572 726f 7220 220a 2020 2020 2020 2020  error ".        
-0001b6a0: 2020 2020 2020 2020 2020 2020 6622 277b              f"'{
-0001b6b0: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
-0001b6c0: 7472 2872 6573 7029 297d 272e 220a 2020  tr(resp))}'.".  
-0001b6d0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0001b6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b6f0: 2320 6773 2e65 7272 5f63 6f75 6e74 202b  # gs.err_count +
-0001b700: 3d20 3120 2320 6e6f 7420 6e65 6564 6564  = 1 # not needed
-0001b710: 2c20 7769 6c6c 2072 6169 7365 2065 7863  , will raise exc
-0001b720: 6570 7469 6f6e 0a20 2020 2020 2020 2020  eption.         
-0001b730: 2020 2020 2020 2023 2069 6e20 666f 6c6c         # in foll
-0001b740: 6f77 696e 6720 6c69 6e65 206f 6620 636f  owing line of co
-0001b750: 6465 0a20 2020 2020 2020 2020 2020 2067  de.            g
-0001b760: 732e 6c6f 672e 696e 666f 280a 2020 2020  s.log.info(.    
-0001b770: 2020 2020 2020 2020 2020 2020 6627 5468              f'Th
-0001b780: 6973 206d 6573 7361 6765 2077 6173 2073  is message was s
-0001b790: 656e 743a 2022 7b6d 6573 7361 6765 7d22  ent: "{message}"
-0001b7a0: 2074 6f20 726f 6f6d 2022 7b72 6573 702e   to room "{resp.
-0001b7b0: 726f 6f6d 5f69 647d 2220 270a 2020 2020  room_id}" '.    
-0001b7c0: 2020 2020 2020 2020 2020 2020 6627 6173              f'as
-0001b7d0: 2065 7665 6e74 2022 7b72 6573 702e 6576   event "{resp.ev
-0001b7e0: 656e 745f 6964 7d22 2e27 0a20 2020 2020  ent_id}".'.     
-0001b7f0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001b800: 2020 2020 2069 6620 6773 2e70 612e 7072       if gs.pa.pr
-0001b810: 696e 745f 6576 656e 745f 6964 3a0a 2020  int_event_id:.  
-0001b820: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0001b830: 6f75 7470 7574 2066 6f72 6d61 7420 636f  output format co
-0001b840: 6e74 726f 6c6c 6564 2076 6961 202d 2d6f  ntrolled via --o
-0001b850: 7574 7075 7420 666c 6167 0a20 2020 2020  utput flag.     
-0001b860: 2020 2020 2020 2020 2020 2074 6578 7420             text 
-0001b870: 3d20 6622 7b72 6573 702e 6576 656e 745f  = f"{resp.event_
-0001b880: 6964 7d7b 5345 507d 7b72 6573 702e 726f  id}{SEP}{resp.ro
-0001b890: 6f6d 5f69 647d 7b53 4550 7d7b 6d65 7373  om_id}{SEP}{mess
-0001b8a0: 6167 657d 220a 2020 2020 2020 2020 2020  age}".          
-0001b8b0: 2020 2020 2020 2320 4f62 6a65 6374 206f        # Object o
-0001b8c0: 6620 7479 7065 2052 6f6f 6d43 7265 6174  f type RoomCreat
-0001b8d0: 6552 6573 706f 6e73 6520 6973 206e 6f74  eResponse is not
-0001b8e0: 204a 534f 4e0a 2020 2020 2020 2020 2020   JSON.          
-0001b8f0: 2020 2020 2020 2320 7365 7269 616c 697a        # serializ
-0001b900: 6162 6c65 2c20 6865 6e63 6520 7765 2075  able, hence we u
-0001b910: 7365 2074 6865 2064 6963 7469 6f6e 6172  se the dictionar
-0001b920: 792e 0a20 2020 2020 2020 2020 2020 2020  y..             
-0001b930: 2020 206a 736f 6e5f 6d61 7820 3d20 7265     json_max = re
-0001b940: 7370 2e5f 5f64 6963 745f 5f0a 2020 2020  sp.__dict__.    
-0001b950: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-0001b960: 5f6d 6178 2e75 7064 6174 6528 7b22 6d65  _max.update({"me
-0001b970: 7373 6167 6522 3a20 6d65 7373 6167 657d  ssage": message}
-0001b980: 2920 2023 2061 6464 2064 6963 7420 6974  )  # add dict it
-0001b990: 656d 730a 2020 2020 2020 2020 2020 2020  ems.            
-0001b9a0: 2020 2020 6a73 6f6e 5f20 3d20 6a73 6f6e      json_ = json
-0001b9b0: 5f6d 6178 2e63 6f70 7928 290a 2020 2020  _max.copy().    
-0001b9c0: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-0001b9d0: 5f2e 706f 7028 2274 7261 6e73 706f 7274  _.pop("transport
-0001b9e0: 5f72 6573 706f 6e73 6522 290a 2020 2020  _response").    
-0001b9f0: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-0001ba00: 5f73 7065 6320 3d20 4e6f 6e65 0a20 2020  _spec = None.   
-0001ba10: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0001ba20: 6e74 5f6f 7574 7075 7428 0a20 2020 2020  nt_output(.     
-0001ba30: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-0001ba40: 732e 7061 2e6f 7574 7075 742c 0a20 2020  s.pa.output,.   
-0001ba50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ba60: 2074 6578 743d 7465 7874 2c0a 2020 2020   text=text,.    
-0001ba70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ba80: 6a73 6f6e 5f3d 6a73 6f6e 5f2c 0a20 2020  json_=json_,.   
-0001ba90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001baa0: 206a 736f 6e5f 6d61 783d 6a73 6f6e 5f6d   json_max=json_m
-0001bab0: 6178 2c0a 2020 2020 2020 2020 2020 2020  ax,.            
-0001bac0: 2020 2020 2020 2020 6a73 6f6e 5f73 7065          json_spe
-0001bad0: 633d 6a73 6f6e 5f73 7065 632c 0a20 2020  c=json_spec,.   
-0001bae0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-0001baf0: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-0001bb00: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
-0001bb10: 2020 2020 2020 2020 2066 2754 6869 7320           f'This 
-0001bb20: 6d65 7373 6167 6520 7761 7320 7365 6e74  message was sent
-0001bb30: 3a20 227b 6d65 7373 6167 657d 2220 746f  : "{message}" to
-0001bb40: 2072 6f6f 6d20 227b 726f 6f6d 5f69 647d   room "{room_id}
-0001bb50: 222e 2027 0a20 2020 2020 2020 2020 2020  ". '.           
-0001bb60: 2020 2020 2066 2252 6573 706f 6e73 653a       f"Response:
-0001bb70: 2065 7665 6e74 5f69 643d 7b72 6573 702e   event_id={resp.
-0001bb80: 6576 656e 745f 6964 7d2c 2072 6f6f 6d5f  event_id}, room_
-0001bb90: 6964 3d7b 7265 7370 2e72 6f6f 6d5f 6964  id={resp.room_id
-0001bba0: 7d2c 2022 0a20 2020 2020 2020 2020 2020  }, ".           
-0001bbb0: 2020 2020 2066 2266 756c 6c20 7265 7370       f"full resp
-0001bbc0: 6f6e 7365 3a20 7b70 7269 7661 6379 5f66  onse: {privacy_f
-0001bbd0: 696c 7465 7228 7374 7228 7265 7370 2929  ilter(str(resp))
-0001bbe0: 7d2e 2022 0a20 2020 2020 2020 2020 2020  }. ".           
-0001bbf0: 2029 0a20 2020 2065 7863 6570 7420 4578   ).    except Ex
-0001bc00: 6365 7074 696f 6e3a 0a20 2020 2020 2020  ception:.       
-0001bc10: 2067 732e 6c6f 672e 6572 726f 7228 2245   gs.log.error("E
-0001bc20: 3135 313a 2022 2022 4d65 7373 6167 6520  151: " "Message 
-0001bc30: 7365 6e64 2066 6169 6c65 642e 2053 6f72  send failed. Sor
-0001bc40: 7279 2e22 290a 2020 2020 2020 2020 6773  ry.").        gs
-0001bc50: 2e65 7272 5f63 6f75 6e74 202b 3d20 310a  .err_count += 1.
-0001bc60: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-0001bc70: 6562 7567 2822 4865 7265 2069 7320 7468  ebug("Here is th
-0001bc80: 6520 7472 6163 6562 6163 6b2e 5c6e 2220  e traceback.\n" 
-0001bc90: 2b20 7472 6163 6562 6163 6b2e 666f 726d  + traceback.form
-0001bca0: 6174 5f65 7863 2829 290a 0a0a 6173 796e  at_exc())...asyn
-0001bcb0: 6320 6465 6620 7374 7265 616d 5f6d 6573  c def stream_mes
-0001bcc0: 7361 6765 735f 6672 6f6d 5f70 6970 6528  sages_from_pipe(
-0001bcd0: 636c 6965 6e74 2c20 726f 6f6d 7329 3a0a  client, rooms):.
-0001bce0: 2020 2020 2222 2252 6561 6420 696e 7075      """Read inpu
-0001bcf0: 7420 6672 6f6d 2070 6970 6520 6966 2061  t from pipe if a
-0001bd00: 7661 696c 6162 6c65 2e0a 0a20 2020 2052  vailable...    R
-0001bd10: 6561 6420 7069 7065 206c 696e 6520 6279  ead pipe line by
-0001bd20: 206c 696e 652e 2046 6f72 2065 6163 6820   line. For each 
-0001bd30: 6c69 6e65 2072 6563 6569 7665 642c 2069  line received, i
-0001bd40: 6d6d 6564 6961 7465 6c79 0a20 2020 2073  mmediately.    s
-0001bd50: 656e 6420 6974 2e0a 0a20 2020 2041 7267  end it...    Arg
-0001bd60: 756d 656e 7473 3a0a 2020 2020 2d2d 2d2d  uments:.    ----
-0001bd70: 2d2d 2d2d 2d0a 2020 2020 636c 6965 6e74  -----.    client
-0001bd80: 203a 2043 6c69 656e 740a 2020 2020 726f   : Client.    ro
-0001bd90: 6f6d 7320 3a20 6c69 7374 206f 6620 726f  oms : list of ro
-0001bda0: 6f6d 5f69 6473 0a0a 2020 2020 2222 220a  om_ids..    """.
-0001bdb0: 2020 2020 7374 6469 6e5f 7265 6164 7920      stdin_ready 
-0001bdc0: 3d20 7365 6c65 6374 2e73 656c 6563 7428  = select.select(
-0001bdd0: 5b73 7973 2e73 7464 696e 2c5d 2c20 5b5d  [sys.stdin,], []
-0001bde0: 2c20 5b5d 2c20 302e 3029 5b20 2023 206e  , [], 0.0)[  # n
-0001bdf0: 6f71 610a 2020 2020 2020 2020 300a 2020  oqa.        0.  
-0001be00: 2020 5d20 2023 206e 6f71 610a 2020 2020    ]  # noqa.    
-0001be10: 6966 206e 6f74 2073 7464 696e 5f72 6561  if not stdin_rea
-0001be20: 6479 3a0a 2020 2020 2020 2020 6773 2e6c  dy:.        gs.l
-0001be30: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
-0001be40: 2020 2020 2020 2273 7464 696e 2069 7320        "stdin is 
-0001be50: 6e6f 7420 7265 6164 7920 666f 7220 7374  not ready for st
-0001be60: 7265 616d 696e 672e 2022 0a20 2020 2020  reaming. ".     
-0001be70: 2020 2020 2020 2022 4120 7069 7065 2063         "A pipe c
-0001be80: 6f75 6c64 2062 6520 7573 6564 2c20 6275  ould be used, bu
-0001be90: 7420 7069 7065 2063 6f75 6c64 2062 6520  t pipe could be 
-0001bea0: 656d 7074 792c 2022 0a20 2020 2020 2020  empty, ".       
-0001beb0: 2020 2020 2022 7374 6469 6e20 636f 756c       "stdin coul
-0001bec0: 6420 616c 736f 2062 6520 6120 6b65 7962  d also be a keyb
-0001bed0: 6f61 7264 2e22 0a20 2020 2020 2020 2029  oard.".        )
-0001bee0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-0001bef0: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-0001bf00: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
-0001bf10: 6469 6e20 6973 2072 6561 6479 2e20 536f  din is ready. So
-0001bf20: 6d65 7468 696e 6720 220a 2020 2020 2020  mething ".      
-0001bf30: 2020 2020 2020 2269 7320 6465 6669 6e69        "is defini
-0001bf40: 7465 6c79 2070 6970 6564 2069 6e74 6f20  tely piped into 
-0001bf50: 7072 6f67 7261 6d20 6672 6f6d 2073 7464  program from std
-0001bf60: 696e 2e20 220a 2020 2020 2020 2020 2020  in. ".          
-0001bf70: 2020 2252 6561 6469 6e67 206d 6573 7361    "Reading messa
-0001bf80: 6765 2066 726f 6d20 7374 6469 6e20 7069  ge from stdin pi
-0001bf90: 7065 2e22 0a20 2020 2020 2020 2029 0a20  pe.".        ). 
-0001bfa0: 2020 2069 6620 2828 6e6f 7420 7374 6469     if ((not stdi
-0001bfb0: 6e5f 7265 6164 7929 2061 6e64 2028 6e6f  n_ready) and (no
-0001bfc0: 7420 7379 732e 7374 6469 6e2e 6973 6174  t sys.stdin.isat
-0001bfd0: 7479 2829 2929 206f 7220 7374 6469 6e5f  ty())) or stdin_
-0001bfe0: 7265 6164 793a 0a20 2020 2020 2020 2069  ready:.        i
-0001bff0: 6620 6e6f 7420 7379 732e 7374 6469 6e2e  f not sys.stdin.
-0001c000: 6973 6174 7479 2829 3a0a 2020 2020 2020  isatty():.      
-0001c010: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-0001c020: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-0001c030: 2020 2020 2250 6970 6520 7761 7320 6465      "Pipe was de
-0001c040: 6669 6e69 7465 6c79 2075 7365 642c 2062  finitely used, b
-0001c050: 7574 2070 6970 6520 6d69 6768 7420 6265  ut pipe might be
-0001c060: 2065 6d70 7479 2e20 220a 2020 2020 2020   empty. ".      
-0001c070: 2020 2020 2020 2020 2020 2254 7279 696e            "Tryin
-0001c080: 6720 746f 2072 6561 6420 6672 6f6d 2070  g to read from p
-0001c090: 6970 6520 696e 2061 6e79 2063 6173 652e  ipe in any case.
-0001c0a0: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-0001c0b0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0001c0c0: 2020 2020 2020 2020 2066 6f72 206c 696e           for lin
-0001c0d0: 6520 696e 2073 7973 2e73 7464 696e 3a0a  e in sys.stdin:.
-0001c0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c0f0: 6177 6169 7420 7365 6e64 5f6d 6573 7361  await send_messa
-0001c100: 6765 2863 6c69 656e 742c 2072 6f6f 6d73  ge(client, rooms
-0001c110: 2c20 6c69 6e65 290a 2020 2020 2020 2020  , line).        
-0001c120: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-0001c130: 6562 7567 2822 5573 696e 6720 6461 7461  ebug("Using data
-0001c140: 2066 726f 6d20 7374 6469 6e20 7069 7065   from stdin pipe
-0001c150: 2073 7472 6561 6d20 6173 206d 6573 7361   stream as messa
-0001c160: 6765 2e22 290a 2020 2020 2020 2020 6578  ge.").        ex
-0001c170: 6365 7074 2045 4f46 4572 726f 723a 2020  cept EOFError:  
-0001c180: 2320 454f 4620 7768 656e 2072 6561 6469  # EOF when readi
-0001c190: 6e67 2061 206c 696e 650a 2020 2020 2020  ng a line.      
-0001c1a0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-0001c1b0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-0001c1c0: 2020 2020 2252 6561 6469 6e67 2066 726f      "Reading fro
-0001c1d0: 6d20 7374 6469 6e20 7265 7375 6c74 6564  m stdin resulted
-0001c1e0: 2069 6e20 454f 462e 2054 6869 7320 6361   in EOF. This ca
-0001c1f0: 6e20 6861 7070 656e 2022 0a20 2020 2020  n happen ".     
-0001c200: 2020 2020 2020 2020 2020 2022 7768 656e             "when
-0001c210: 2061 2070 6970 6520 7761 7320 7573 6564   a pipe was used
-0001c220: 2c20 6275 7420 7468 6520 7069 7065 2069  , but the pipe i
-0001c230: 7320 656d 7074 792e 2022 0a20 2020 2020  s empty. ".     
-0001c240: 2020 2020 2020 2020 2020 2022 4e6f 206d             "No m
-0001c250: 6573 7361 6765 2077 696c 6c20 6265 2067  essage will be g
-0001c260: 656e 6572 6174 6564 2e22 0a20 2020 2020  enerated.".     
-0001c270: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001c280: 2065 7863 6570 7420 556e 6963 6f64 6544   except UnicodeD
-0001c290: 6563 6f64 6545 7272 6f72 3a0a 2020 2020  ecodeError:.    
-0001c2a0: 2020 2020 2020 2020 6773 2e6c 6f67 2e69          gs.log.i
-0001c2b0: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
-0001c2c0: 2020 2020 2022 5265 6164 696e 6720 6672       "Reading fr
-0001c2d0: 6f6d 2073 7464 696e 2072 6573 756c 7465  om stdin resulte
-0001c2e0: 6420 696e 2055 6e69 636f 6465 4465 636f  d in UnicodeDeco
-0001c2f0: 6465 4572 726f 722e 2054 6869 7320 220a  deError. This ".
-0001c300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c310: 2263 616e 2068 6170 7065 6e20 6966 2079  "can happen if y
-0001c320: 6f75 2074 7279 2074 6f20 7069 7065 2062  ou try to pipe b
-0001c330: 696e 6172 7920 6461 7461 2066 6f72 2061  inary data for a
-0001c340: 2074 6578 7420 220a 2020 2020 2020 2020   text ".        
-0001c350: 2020 2020 2020 2020 226d 6573 7361 6765          "message
-0001c360: 2e20 466f 7220 6120 7465 7874 206d 6573  . For a text mes
-0001c370: 7361 6765 206f 6e6c 7920 7069 7065 2074  sage only pipe t
-0001c380: 6578 7420 7669 6120 7374 6469 6e2c 2022  ext via stdin, "
-0001c390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c3a0: 2022 6e6f 7420 6269 6e61 7279 2064 6174   "not binary dat
-0001c3b0: 612e 204e 6f20 6d65 7373 6167 6520 7769  a. No message wi
-0001c3c0: 6c6c 2062 6520 6765 6e65 7261 7465 642e  ll be generated.
-0001c3d0: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-0001c3e0: 0a0a 6465 6620 6765 745f 6d65 7373 6167  ..def get_messag
-0001c3f0: 6573 5f66 726f 6d5f 7069 7065 2829 202d  es_from_pipe() -
-0001c400: 3e20 6c69 7374 3a0a 2020 2020 2222 2252  > list:.    """R
-0001c410: 6561 6420 696e 7075 7420 6672 6f6d 2070  ead input from p
-0001c420: 6970 6520 6966 2061 7661 696c 6162 6c65  ipe if available
-0001c430: 2e0a 0a20 2020 2052 6574 7572 6e20 5b5d  ...    Return []
-0001c440: 2069 6620 6e6f 2069 6e70 7574 2061 7661   if no input ava
-0001c450: 696c 6162 6c65 206f 6e20 7069 7065 2073  ilable on pipe s
-0001c460: 7464 696e 2e0a 2020 2020 5265 7475 726e  tdin..    Return
-0001c470: 205b 2273 6f6d 652d 6d73 6722 5d20 6966   ["some-msg"] if
-0001c480: 2069 6e70 7574 2069 7320 6176 6169 6c62   input is availb
-0001c490: 6c65 2e0a 2020 2020 4d69 6768 7420 616c  le..    Might al
-0001c4a0: 736f 2072 6574 7572 6e20 5b22 225d 206f  so return [""] o
-0001c4b0: 6620 636f 7572 7365 2069 6620 2222 2077  f course if "" w
-0001c4c0: 6173 2069 6e20 7069 7065 2e0a 2020 2020  as in pipe..    
-0001c4d0: 4375 7272 656e 746c 7920 7468 6572 6520  Currently there 
-0001c4e0: 6973 2061 7420 6d6f 7374 2031 206d 7367  is at most 1 msg
-0001c4f0: 2069 6e20 7468 6520 7265 7475 726e 6564   in the returned
-0001c500: 206c 6973 742e 0a20 2020 2022 2222 0a20   list..    """. 
-0001c510: 2020 206d 6573 7361 6765 7320 3d20 5b5d     messages = []
-0001c520: 0a20 2020 2073 7464 696e 5f72 6561 6479  .    stdin_ready
-0001c530: 203d 2073 656c 6563 742e 7365 6c65 6374   = select.select
-0001c540: 285b 7379 732e 7374 6469 6e2c 5d2c 205b  ([sys.stdin,], [
-0001c550: 5d2c 205b 5d2c 2030 2e30 295b 2020 2320  ], [], 0.0)[  # 
-0001c560: 6e6f 7161 0a20 2020 2020 2020 2030 0a20  noqa.        0. 
-0001c570: 2020 205d 2020 2320 6e6f 7161 0a20 2020     ]  # noqa.   
-0001c580: 2069 6620 6e6f 7420 7374 6469 6e5f 7265   if not stdin_re
-0001c590: 6164 793a 0a20 2020 2020 2020 2067 732e  ady:.        gs.
-0001c5a0: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
-0001c5b0: 2020 2020 2020 2022 7374 6469 6e20 6973         "stdin is
-0001c5c0: 206e 6f74 2072 6561 6479 2066 6f72 2072   not ready for r
-0001c5d0: 6561 6469 6e67 2e20 220a 2020 2020 2020  eading. ".      
-0001c5e0: 2020 2020 2020 2241 2070 6970 6520 636f        "A pipe co
-0001c5f0: 756c 6420 6265 2075 7365 642c 2062 7574  uld be used, but
-0001c600: 2070 6970 6520 636f 756c 6420 6265 2065   pipe could be e
-0001c610: 6d70 7479 2c20 220a 2020 2020 2020 2020  mpty, ".        
-0001c620: 2020 2020 2273 7464 696e 2063 6f75 6c64      "stdin could
-0001c630: 2061 6c73 6f20 6265 2061 206b 6579 626f   also be a keybo
-0001c640: 6172 642e 220a 2020 2020 2020 2020 290a  ard.".        ).
-0001c650: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001c660: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
-0001c670: 2020 2020 2020 2020 2020 2020 2273 7464              "std
-0001c680: 696e 2069 7320 7265 6164 792e 2053 6f6d  in is ready. Som
-0001c690: 6574 6869 6e67 2022 0a20 2020 2020 2020  ething ".       
-0001c6a0: 2020 2020 2022 6973 2064 6566 696e 6974       "is definit
-0001c6b0: 656c 7920 7069 7065 6420 696e 746f 2070  ely piped into p
-0001c6c0: 726f 6772 616d 2066 726f 6d20 7374 6469  rogram from stdi
-0001c6d0: 6e2e 2022 0a20 2020 2020 2020 2020 2020  n. ".           
-0001c6e0: 2022 5265 6164 696e 6720 6d65 7373 6167   "Reading messag
-0001c6f0: 6520 6672 6f6d 2073 7464 696e 2070 6970  e from stdin pip
-0001c700: 652e 220a 2020 2020 2020 2020 290a 2020  e.".        ).  
-0001c710: 2020 6966 2028 286e 6f74 2073 7464 696e    if ((not stdin
-0001c720: 5f72 6561 6479 2920 616e 6420 286e 6f74  _ready) and (not
-0001c730: 2073 7973 2e73 7464 696e 2e69 7361 7474   sys.stdin.isatt
-0001c740: 7928 2929 2920 6f72 2073 7464 696e 5f72  y())) or stdin_r
-0001c750: 6561 6479 3a0a 2020 2020 2020 2020 6966  eady:.        if
-0001c760: 206e 6f74 2073 7973 2e73 7464 696e 2e69   not sys.stdin.i
-0001c770: 7361 7474 7928 293a 0a20 2020 2020 2020  satty():.       
-0001c780: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-0001c790: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-0001c7a0: 2020 2022 5069 7065 2077 6173 2064 6566     "Pipe was def
-0001c7b0: 696e 6974 656c 7920 7573 6564 2c20 6275  initely used, bu
-0001c7c0: 7420 7069 7065 206d 6967 6874 2062 6520  t pipe might be 
-0001c7d0: 656d 7074 792e 2022 0a20 2020 2020 2020  empty. ".       
-0001c7e0: 2020 2020 2020 2020 2022 5472 7969 6e67           "Trying
-0001c7f0: 2074 6f20 7265 6164 2066 726f 6d20 7069   to read from pi
-0001c800: 7065 2069 6e20 616e 7920 6361 7365 2e22  pe in any case."
-0001c810: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0001c820: 2020 2020 2020 206d 6573 7361 6765 203d         message =
-0001c830: 2022 220a 2020 2020 2020 2020 7472 793a   "".        try:
-0001c840: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0001c850: 206c 696e 6520 696e 2073 7973 2e73 7464   line in sys.std
-0001c860: 696e 3a0a 2020 2020 2020 2020 2020 2020  in:.            
-0001c870: 2020 2020 6d65 7373 6167 6520 2b3d 206c      message += l
-0001c880: 696e 650a 2020 2020 2020 2020 2020 2020  ine.            
-0001c890: 6773 2e6c 6f67 2e64 6562 7567 2822 5573  gs.log.debug("Us
-0001c8a0: 696e 6720 6461 7461 2066 726f 6d20 7374  ing data from st
-0001c8b0: 6469 6e20 7069 7065 2061 7320 6d65 7373  din pipe as mess
-0001c8c0: 6167 652e 2229 0a20 2020 2020 2020 2020  age.").         
-0001c8d0: 2020 206d 6573 7361 6765 732e 6170 7065     messages.appe
-0001c8e0: 6e64 286d 6573 7361 6765 290a 2020 2020  nd(message).    
-0001c8f0: 2020 2020 6578 6365 7074 2045 4f46 4572      except EOFEr
-0001c900: 726f 723a 2020 2320 454f 4620 7768 656e  ror:  # EOF when
-0001c910: 2072 6561 6469 6e67 2061 206c 696e 650a   reading a line.
-0001c920: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
-0001c930: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
-0001c940: 2020 2020 2020 2020 2020 2252 6561 6469            "Readi
-0001c950: 6e67 2066 726f 6d20 7374 6469 6e20 7265  ng from stdin re
-0001c960: 7375 6c74 6564 2069 6e20 454f 462e 2054  sulted in EOF. T
-0001c970: 6869 7320 6361 6e20 6861 7070 656e 2022  his can happen "
-0001c980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c990: 2022 7768 656e 2061 2070 6970 6520 7761   "when a pipe wa
-0001c9a0: 7320 7573 6564 2c20 6275 7420 7468 6520  s used, but the 
-0001c9b0: 7069 7065 2069 7320 656d 7074 792e 2022  pipe is empty. "
-0001c9c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c9d0: 2022 4e6f 206d 6573 7361 6765 2077 696c   "No message wil
-0001c9e0: 6c20 6265 2067 656e 6572 6174 6564 2e22  l be generated."
-0001c9f0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0001ca00: 2020 2020 2020 2065 7863 6570 7420 556e         except Un
-0001ca10: 6963 6f64 6544 6563 6f64 6545 7272 6f72  icodeDecodeError
-0001ca20: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
-0001ca30: 2e6c 6f67 2e69 6e66 6f28 0a20 2020 2020  .log.info(.     
-0001ca40: 2020 2020 2020 2020 2020 2022 5265 6164             "Read
-0001ca50: 696e 6720 6672 6f6d 2073 7464 696e 2072  ing from stdin r
-0001ca60: 6573 756c 7465 6420 696e 2055 6e69 636f  esulted in Unico
-0001ca70: 6465 4465 636f 6465 4572 726f 722e 2054  deDecodeError. T
-0001ca80: 6869 7320 220a 2020 2020 2020 2020 2020  his ".          
-0001ca90: 2020 2020 2020 2263 616e 2068 6170 7065        "can happe
-0001caa0: 6e20 6966 2079 6f75 2074 7279 2074 6f20  n if you try to 
-0001cab0: 7069 7065 2062 696e 6172 7920 6461 7461  pipe binary data
-0001cac0: 2066 6f72 2061 2074 6578 7420 220a 2020   for a text ".  
-0001cad0: 2020 2020 2020 2020 2020 2020 2020 226d                "m
-0001cae0: 6573 7361 6765 2e20 466f 7220 6120 7465  essage. For a te
-0001caf0: 7874 206d 6573 7361 6765 206f 6e6c 7920  xt message only 
-0001cb00: 7069 7065 2074 6578 7420 7669 6120 7374  pipe text via st
-0001cb10: 6469 6e2c 2022 0a20 2020 2020 2020 2020  din, ".         
-0001cb20: 2020 2020 2020 2022 6e6f 7420 6269 6e61         "not bina
-0001cb30: 7279 2064 6174 612e 204e 6f20 6d65 7373  ry data. No mess
-0001cb40: 6167 6520 7769 6c6c 2062 6520 6765 6e65  age will be gene
-0001cb50: 7261 7465 642e 220a 2020 2020 2020 2020  rated.".        
-0001cb60: 2020 2020 290a 2020 2020 7265 7475 726e      ).    return
-0001cb70: 206d 6573 7361 6765 730a 0a0a 6465 6620   messages...def 
-0001cb80: 6765 745f 6d65 7373 6167 6573 5f66 726f  get_messages_fro
-0001cb90: 6d5f 6b65 7962 6f61 7264 2829 202d 3e20  m_keyboard() -> 
-0001cba0: 6c69 7374 3a0a 2020 2020 2222 2252 6561  list:.    """Rea
-0001cbb0: 6420 696e 7075 7420 6672 6f6d 206b 6579  d input from key
-0001cbc0: 626f 6172 6420 6275 7420 6f6e 6c79 2069  board but only i
-0001cbd0: 6620 6e6f 206f 7468 6572 206d 6573 7361  f no other messa
-0001cbe0: 6765 7320 6172 6520 6176 6169 6c61 626c  ges are availabl
-0001cbf0: 652e 0a0a 2020 2020 4966 2074 6865 7265  e...    If there
-0001cc00: 2069 7320 6120 6d65 7373 6167 6520 7072   is a message pr
-0001cc10: 6f76 6964 6564 2076 6961 202d 2d6d 6573  ovided via --mes
-0001cc20: 7361 6765 2061 7267 756d 656e 742c 206e  sage argument, n
-0001cc30: 6f20 6d65 7373 6167 650a 2020 2020 7769  o message.    wi
-0001cc40: 6c6c 2062 6520 7265 6164 2066 726f 6d20  ll be read from 
-0001cc50: 6b65 7962 6f61 7264 2e0a 2020 2020 4966  keyboard..    If
-0001cc60: 2074 6865 7265 2061 7265 206f 7468 6572   there are other
-0001cc70: 2073 656e 6420 6f70 6572 6174 696f 6e73   send operations
-0001cc80: 206c 696b 6520 2d2d 696d 6167 652c 202d   like --image, -
-0001cc90: 2d66 696c 652c 2065 7463 2e20 6172 650a  -file, etc. are.
-0001cca0: 2020 2020 7573 6564 2c20 6e6f 206d 6573      used, no mes
-0001ccb0: 7361 6765 2077 696c 6c20 6265 2072 6561  sage will be rea
-0001ccc0: 6420 6672 6f6d 206b 6579 626f 6172 642e  d from keyboard.
-0001ccd0: 0a20 2020 2049 6620 7468 6572 6520 6973  .    If there is
-0001cce0: 2061 206d 6573 7361 6765 2070 726f 7669   a message provi
-0001ccf0: 6465 6420 7669 6120 7374 6469 6e20 696e  ded via stdin in
-0001cd00: 7075 7420 7069 7065 2c20 6e6f 206d 6573  put pipe, no mes
-0001cd10: 7361 6765 0a20 2020 2077 696c 6c20 6265  sage.    will be
-0001cd20: 2072 6561 6420 6672 6f6d 206b 6579 626f   read from keybo
-0001cd30: 6172 642e 0a20 2020 2049 6e20 7368 6f72  ard..    In shor
-0001cd40: 742c 2077 6520 6f6e 6c79 2072 6561 6420  t, we only read 
-0001cd50: 6672 6f6d 206b 6579 626f 6172 6420 6173  from keyboard as
-0001cd60: 206c 6173 7420 7265 736f 7274 2c20 6966   last resort, if
-0001cd70: 206e 6f20 6d65 7373 6167 6573 2061 7265   no messages are
-0001cd80: 0a20 2020 2073 7065 6369 6669 6564 206f  .    specified o
-0001cd90: 7220 7072 6f76 6964 6564 2061 6e79 7768  r provided anywh
-0001cda0: 6572 6520 616e 6420 6e6f 206f 7468 6572  ere and no other
-0001cdb0: 2073 656e 642d 6f70 6572 6174 696f 6e73   send-operations
-0001cdc0: 206c 696b 650a 2020 2020 2d2d 696d 6167   like.    --imag
-0001cdd0: 652c 202d 2d65 7665 6e74 2c20 6574 632e  e, --event, etc.
-0001cde0: 2061 7265 2070 6572 666f 726d 6564 2e0a   are performed..
-0001cdf0: 0a20 2020 2052 6574 7572 6e20 5b5d 2069  .    Return [] i
-0001ce00: 6620 6e6f 2069 6e70 7574 2061 7661 696c  f no input avail
-0001ce10: 6162 6c65 206f 6e20 6b65 7962 6f61 7264  able on keyboard
-0001ce20: 2e0a 2020 2020 5265 7475 726e 205b 2273  ..    Return ["s
-0001ce30: 6f6d 652d 6d73 6722 5d20 6966 2069 6e70  ome-msg"] if inp
-0001ce40: 7574 2069 7320 6176 6169 6c62 6c65 206f  ut is availble o
-0001ce50: 6e20 6b65 7962 6f61 7264 2e0a 2020 2020  n keyboard..    
-0001ce60: 4d69 6768 7420 616c 736f 2072 6574 7572  Might also retur
-0001ce70: 6e20 5b22 225d 206f 6620 636f 7572 7365  n [""] of course
-0001ce80: 2069 6620 2222 206b 6579 626f 6172 6420   if "" keyboard 
-0001ce90: 656e 7472 7920 7761 7320 656d 7074 792e  entry was empty.
-0001cea0: 0a20 2020 2043 7572 7265 6e74 6c79 2074  .    Currently t
-0001ceb0: 6865 7265 2069 7320 6174 206d 6f73 7420  here is at most 
-0001cec0: 3120 6d73 6720 696e 2074 6865 2072 6574  1 msg in the ret
-0001ced0: 7572 6e65 6420 6c69 7374 2e0a 2020 2020  urned list..    
-0001cee0: 2222 220a 2020 2020 6d65 7373 6167 6573  """.    messages
-0001cef0: 203d 205b 5d0a 2020 2020 6966 2067 732e   = [].    if gs.
-0001cf00: 7061 2e6d 6573 7361 6765 3a0a 2020 2020  pa.message:.    
-0001cf10: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-0001cf20: 280a 2020 2020 2020 2020 2020 2020 2244  (.            "D
-0001cf30: 6f6e 2774 2072 6561 6420 6672 6f6d 206b  on't read from k
-0001cf40: 6579 626f 6172 6420 6265 6361 7573 6520  eyboard because 
-0001cf50: 7468 6572 6520 6172 6520 220a 2020 2020  there are ".    
-0001cf60: 2020 2020 2020 2020 226d 6573 7361 6765          "message
-0001cf70: 7320 7072 6f76 6964 6564 2069 6e20 6172  s provided in ar
-0001cf80: 6775 6d65 6e74 7320 7769 7468 202d 6d2e  guments with -m.
-0001cf90: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
-0001cfa0: 2020 2020 7265 7475 726e 206d 6573 7361      return messa
-0001cfb0: 6765 7320 2023 2072 6574 7572 6e20 656d  ges  # return em
-0001cfc0: 7074 7920 6c69 7374 2062 6563 6175 7365  pty list because
-0001cfd0: 206d 6573 6773 2069 6e20 2d6d 0a20 2020   mesgs in -m.   
-0001cfe0: 2069 6620 280a 2020 2020 2020 2020 6773   if (.        gs
-0001cff0: 2e70 612e 696d 6167 650a 2020 2020 2020  .pa.image.      
-0001d000: 2020 6f72 2067 732e 7061 2e61 7564 696f    or gs.pa.audio
-0001d010: 0a20 2020 2020 2020 206f 7220 6773 2e70  .        or gs.p
-0001d020: 612e 6669 6c65 0a20 2020 2020 2020 206f  a.file.        o
-0001d030: 7220 6773 2e70 612e 6576 656e 740a 2020  r gs.pa.event.  
-0001d040: 2020 2020 2020 6f72 2067 732e 7061 2e76        or gs.pa.v
-0001d050: 6572 7369 6f6e 0a20 2020 2029 3a0a 2020  ersion.    ):.  
-0001d060: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-0001d070: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-0001d080: 2244 6f6e 2774 2072 6561 6420 6672 6f6d  "Don't read from
-0001d090: 206b 6579 626f 6172 6420 6265 6361 7573   keyboard becaus
-0001d0a0: 6520 7468 6572 6520 6172 6520 220a 2020  e there are ".  
-0001d0b0: 2020 2020 2020 2020 2020 226f 7468 6572            "other
-0001d0c0: 2073 656e 6420 6f70 6572 6174 696f 6e73   send operations
-0001d0d0: 206f 7220 2d2d 7665 7273 696f 6e20 7072   or --version pr
-0001d0e0: 6f76 6964 6564 2069 6e20 6172 6775 6d65  ovided in argume
-0001d0f0: 6e74 732e 220a 2020 2020 2020 2020 290a  nts.".        ).
-0001d100: 2020 2020 2020 2020 7265 7475 726e 206d          return m
-0001d110: 6573 7361 6765 7320 2023 2072 6574 7572  essages  # retur
-0001d120: 6e20 656d 7074 7920 6c69 7374 2062 6563  n empty list bec
-0001d130: 6175 7365 206d 6573 6773 2069 6e20 2d6d  ause mesgs in -m
-0001d140: 0a20 2020 2073 7464 696e 5f72 6561 6479  .    stdin_ready
-0001d150: 203d 2073 656c 6563 742e 7365 6c65 6374   = select.select
-0001d160: 285b 7379 732e 7374 6469 6e2c 5d2c 205b  ([sys.stdin,], [
-0001d170: 5d2c 205b 5d2c 2030 2e30 295b 2020 2320  ], [], 0.0)[  # 
-0001d180: 6e6f 7161 0a20 2020 2020 2020 2030 0a20  noqa.        0. 
-0001d190: 2020 205d 2020 2320 6e6f 7161 0a20 2020     ]  # noqa.   
-0001d1a0: 2069 6620 6e6f 7420 7374 6469 6e5f 7265   if not stdin_re
-0001d1b0: 6164 793a 0a20 2020 2020 2020 2067 732e  ady:.        gs.
-0001d1c0: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
-0001d1d0: 2020 2020 2020 2022 7374 6469 6e20 6973         "stdin is
-0001d1e0: 206e 6f74 2072 6561 6479 2066 6f72 206b   not ready for k
-0001d1f0: 6579 626f 6172 6420 696e 7465 7261 6374  eyboard interact
-0001d200: 696f 6e2e 2022 0a20 2020 2020 2020 2020  ion. ".         
-0001d210: 2020 2022 4120 7069 7065 2063 6f75 6c64     "A pipe could
-0001d220: 2062 6520 7573 6564 2c20 6275 7420 7069   be used, but pi
-0001d230: 7065 2063 6f75 6c64 2062 6520 656d 7074  pe could be empt
-0001d240: 792c 2022 0a20 2020 2020 2020 2020 2020  y, ".           
-0001d250: 2022 7374 6469 6e20 636f 756c 6420 616c   "stdin could al
-0001d260: 736f 2062 6520 6120 6b65 7962 6f61 7264  so be a keyboard
-0001d270: 2e22 0a20 2020 2020 2020 2029 0a20 2020  .".        ).   
-0001d280: 2065 6c73 653a 0a20 2020 2020 2020 2067   else:.        g
-0001d290: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
-0001d2a0: 2020 2020 2020 2020 2022 7374 6469 6e20           "stdin 
-0001d2b0: 6973 2072 6561 6479 2e20 536f 6d65 7468  is ready. Someth
-0001d2c0: 696e 6720 220a 2020 2020 2020 2020 2020  ing ".          
-0001d2d0: 2020 2269 7320 6465 6669 6e69 7465 6c79    "is definitely
-0001d2e0: 2070 6970 6564 2069 6e74 6f20 7072 6f67   piped into prog
-0001d2f0: 7261 6d20 6672 6f6d 2073 7464 696e 2e20  ram from stdin. 
-0001d300: 220a 2020 2020 2020 2020 2020 2020 2252  ".            "R
-0001d310: 6561 6469 6e67 206d 6573 7361 6765 2066  eading message f
-0001d320: 726f 6d20 7374 6469 6e20 7069 7065 2e22  rom stdin pipe."
-0001d330: 0a20 2020 2020 2020 2029 0a20 2020 2069  .        ).    i
-0001d340: 6620 286e 6f74 2073 7464 696e 5f72 6561  f (not stdin_rea
-0001d350: 6479 2920 616e 6420 2873 7973 2e73 7464  dy) and (sys.std
-0001d360: 696e 2e69 7361 7474 7928 2929 3a0a 2020  in.isatty()):.  
-0001d370: 2020 2020 2020 2320 6265 6361 7573 6520        # because 
-0001d380: 7379 732e 7374 6469 6e2e 6973 6174 7479  sys.stdin.isatty
-0001d390: 2829 2069 7320 7472 7565 0a20 2020 2020  () is true.     
-0001d3a0: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-0001d3b0: 0a20 2020 2020 2020 2020 2020 2022 4e6f  .            "No
-0001d3c0: 2070 6970 6520 7761 7320 7573 6564 2c20   pipe was used, 
-0001d3d0: 736f 2072 6561 6420 696e 7075 7420 6672  so read input fr
-0001d3e0: 6f6d 206b 6579 626f 6172 642e 2022 0a20  om keyboard. ". 
-0001d3f0: 2020 2020 2020 2020 2020 2022 5265 6164             "Read
-0001d400: 696e 6720 6d65 7373 6167 6520 6672 6f6d  ing message from
-0001d410: 206b 6579 626f 6172 6422 0a20 2020 2020   keyboard".     
-0001d420: 2020 2029 0a20 2020 2020 2020 2074 7279     ).        try
-0001d430: 3a0a 2020 2020 2020 2020 2020 2020 6d65  :.            me
-0001d440: 7373 6167 6520 3d20 696e 7075 7428 2245  ssage = input("E
-0001d450: 6e74 6572 206d 6573 7361 6765 2074 6f20  nter message to 
-0001d460: 7365 6e64 3a20 2229 0a20 2020 2020 2020  send: ").       
-0001d470: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-0001d480: 6728 2255 7369 6e67 2064 6174 6120 6672  g("Using data fr
-0001d490: 6f6d 2073 7464 696e 206b 6579 626f 6172  om stdin keyboar
-0001d4a0: 6420 6173 206d 6573 7361 6765 2e22 290a  d as message.").
-0001d4b0: 2020 2020 2020 2020 2020 2020 6d65 7373              mess
-0001d4c0: 6167 6573 2e61 7070 656e 6428 6d65 7373  ages.append(mess
-0001d4d0: 6167 6529 0a20 2020 2020 2020 2065 7863  age).        exc
-0001d4e0: 6570 7420 454f 4645 7272 6f72 3a20 2023  ept EOFError:  #
-0001d4f0: 2045 4f46 2077 6865 6e20 7265 6164 696e   EOF when readin
-0001d500: 6720 6120 6c69 6e65 0a20 2020 2020 2020  g a line.       
-0001d510: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-0001d520: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-0001d530: 2020 2022 5265 6164 696e 6720 6672 6f6d     "Reading from
-0001d540: 2073 7464 696e 2072 6573 756c 7465 6420   stdin resulted 
-0001d550: 696e 2045 4f46 2e20 220a 2020 2020 2020  in EOF. ".      
-0001d560: 2020 2020 2020 2020 2020 2252 6561 6469            "Readi
-0001d570: 6e67 2066 726f 6d20 6b65 7962 6f61 7264  ng from keyboard
-0001d580: 2066 6169 6c65 642e 2022 0a20 2020 2020   failed. ".     
-0001d590: 2020 2020 2020 2020 2020 2022 4e6f 206d             "No m
-0001d5a0: 6573 7361 6765 2077 696c 6c20 6265 2067  essage will be g
-0001d5b0: 656e 6572 6174 6564 2e22 0a20 2020 2020  enerated.".     
-0001d5c0: 2020 2020 2020 2029 0a20 2020 2072 6574         ).    ret
-0001d5d0: 7572 6e20 6d65 7373 6167 6573 0a0a 0a61  urn messages...a
-0001d5e0: 7379 6e63 2064 6566 2073 656e 645f 6d65  sync def send_me
-0001d5f0: 7373 6167 6573 5f61 6e64 5f66 696c 6573  ssages_and_files
-0001d600: 2863 6c69 656e 742c 2072 6f6f 6d73 2c20  (client, rooms, 
-0001d610: 6d65 7373 6167 6573 293a 0a20 2020 2022  messages):.    "
-0001d620: 2222 5365 6e64 2074 6578 7420 6d65 7373  ""Send text mess
-0001d630: 6167 6573 2061 6e64 2066 696c 6573 2e0a  ages and files..
-0001d640: 0a20 2020 2046 6972 7374 2069 6d61 6765  .    First image
-0001d650: 732c 2061 7564 696f 2c20 6574 632c 2074  s, audio, etc, t
-0001d660: 6865 6e20 7465 7874 206d 6573 7361 6765  hen text message
-0001d670: 642e 0a0a 2020 2020 4172 6775 6d65 6e74  d...    Argument
-0001d680: 733a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  s:.    ---------
-0001d690: 0a20 2020 2063 6c69 656e 7420 3a20 436c  .    client : Cl
-0001d6a0: 6965 6e74 0a20 2020 2072 6f6f 6d73 203a  ient.    rooms :
-0001d6b0: 206c 6973 7420 6f66 2072 6f6f 6d5f 6964   list of room_id
-0001d6c0: 730a 2020 2020 6d65 7373 6167 6573 203a  s.    messages :
-0001d6d0: 206c 6973 7420 6f66 206d 6573 7361 6765   list of message
-0001d6e0: 7320 746f 2073 656e 640a 0a20 2020 2022  s to send..    "
-0001d6f0: 2222 0a20 2020 2069 6620 6773 2e70 612e  "".    if gs.pa.
-0001d700: 696d 6167 653a 0a20 2020 2020 2020 2066  image:.        f
-0001d710: 6f72 2069 6d61 6765 2069 6e20 6773 2e70  or image in gs.p
-0001d720: 612e 696d 6167 653a 0a20 2020 2020 2020  a.image:.       
-0001d730: 2020 2020 2061 7761 6974 2073 656e 645f       await send_
-0001d740: 696d 6167 6528 636c 6965 6e74 2c20 726f  image(client, ro
-0001d750: 6f6d 732c 2069 6d61 6765 290a 0a20 2020  oms, image)..   
-0001d760: 2069 6620 6773 2e70 612e 6175 6469 6f3a   if gs.pa.audio:
-0001d770: 0a20 2020 2020 2020 2066 6f72 2061 7564  .        for aud
-0001d780: 696f 2069 6e20 6773 2e70 612e 6175 6469  io in gs.pa.audi
-0001d790: 6f3a 0a20 2020 2020 2020 2020 2020 2023  o:.            #
-0001d7a0: 2061 7564 696f 2066 696c 6520 6361 6e20   audio file can 
-0001d7b0: 6265 2073 656e 7420 6c69 6b65 206f 7468  be sent like oth
-0001d7c0: 6572 2066 696c 6573 0a20 2020 2020 2020  er files.       
-0001d7d0: 2020 2020 2061 7761 6974 2073 656e 645f       await send_
-0001d7e0: 6669 6c65 2863 6c69 656e 742c 2072 6f6f  file(client, roo
-0001d7f0: 6d73 2c20 6175 6469 6f29 0a0a 2020 2020  ms, audio)..    
-0001d800: 6966 2067 732e 7061 2e66 696c 653a 0a20  if gs.pa.file:. 
-0001d810: 2020 2020 2020 2066 6f72 2066 696c 6520         for file 
-0001d820: 696e 2067 732e 7061 2e66 696c 653a 0a20  in gs.pa.file:. 
-0001d830: 2020 2020 2020 2020 2020 2061 7761 6974             await
-0001d840: 2073 656e 645f 6669 6c65 2863 6c69 656e   send_file(clien
-0001d850: 742c 2072 6f6f 6d73 2c20 6669 6c65 290a  t, rooms, file).
-0001d860: 0a20 2020 2069 6620 6773 2e70 612e 6576  .    if gs.pa.ev
-0001d870: 656e 743a 0a20 2020 2020 2020 2066 6f72  ent:.        for
-0001d880: 2065 7665 6e74 2069 6e20 6773 2e70 612e   event in gs.pa.
-0001d890: 6576 656e 743a 0a20 2020 2020 2020 2020  event:.         
-0001d8a0: 2020 2061 7761 6974 2073 656e 645f 6576     await send_ev
-0001d8b0: 656e 7428 636c 6965 6e74 2c20 726f 6f6d  ent(client, room
-0001d8c0: 732c 2065 7665 6e74 290a 0a20 2020 2066  s, event)..    f
-0001d8d0: 6f72 206d 6573 7361 6765 2069 6e20 6d65  or message in me
-0001d8e0: 7373 6167 6573 3a0a 2020 2020 2020 2020  ssages:.        
-0001d8f0: 6177 6169 7420 7365 6e64 5f6d 6573 7361  await send_messa
-0001d900: 6765 2863 6c69 656e 742c 2072 6f6f 6d73  ge(client, rooms
-0001d910: 2c20 6d65 7373 6167 6529 0a0a 0a61 7379  , message)...asy
-0001d920: 6e63 2064 6566 2070 726f 6365 7373 5f61  nc def process_a
-0001d930: 7267 756d 656e 7473 5f61 6e64 5f69 6e70  rguments_and_inp
-0001d940: 7574 2863 6c69 656e 742c 2072 6f6f 6d73  ut(client, rooms
-0001d950: 293a 0a20 2020 2022 2222 5072 6f63 6573  ):.    """Proces
-0001d960: 7320 6172 6775 6d65 6e74 7320 616e 6420  s arguments and 
-0001d970: 616c 6c20 696e 7075 742e 0a0a 2020 2020  all input...    
-0001d980: 5072 6f63 6573 7320 616c 6c20 696e 7075  Process all inpu
-0001d990: 743a 2074 6578 7420 6d65 7373 6167 6573  t: text messages
-0001d9a0: 2c20 6574 632e 0a20 2020 2050 7265 7061  , etc..    Prepa
-0001d9b0: 7265 2061 206c 6973 7420 6f66 206d 6573  re a list of mes
-0001d9c0: 7361 6765 7320 6672 6f6d 2061 6c6c 2073  sages from all s
-0001d9d0: 6f75 7263 6573 2061 6e64 2074 6865 6e20  ources and then 
-0001d9e0: 7365 6e64 2074 6865 6d2e 0a0a 2020 2020  send them...    
-0001d9f0: 4172 6775 6d65 6e74 733a 0a20 2020 202d  Arguments:.    -
-0001da00: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063 6c69  --------.    cli
-0001da10: 656e 7420 3a20 436c 6965 6e74 0a20 2020  ent : Client.   
-0001da20: 2072 6f6f 6d73 203a 206c 6973 7420 6f66   rooms : list of
-0001da30: 2072 6f6f 6d5f 6964 730a 0a20 2020 2022   room_ids..    "
-0001da40: 2222 0a20 2020 2073 7472 6561 6d69 6e67  "".    streaming
-0001da50: 203d 2046 616c 7365 0a20 2020 206d 6573   = False.    mes
-0001da60: 7361 6765 735f 6672 6f6d 5f70 6970 6520  sages_from_pipe 
-0001da70: 3d20 5b5d 0a20 2020 2069 6620 6773 2e73  = [].    if gs.s
-0001da80: 7464 696e 5f75 7365 203d 3d20 226e 6f6e  tdin_use == "non
-0001da90: 6522 3a20 2023 2053 5444 494e 2069 7320  e":  # STDIN is 
-0001daa0: 756e 7573 6564 0a20 2020 2020 2020 206d  unused.        m
-0001dab0: 6573 7361 6765 735f 6672 6f6d 5f70 6970  essages_from_pip
-0001dac0: 6520 3d20 6765 745f 6d65 7373 6167 6573  e = get_messages
-0001dad0: 5f66 726f 6d5f 7069 7065 2829 0a20 2020  _from_pipe().   
-0001dae0: 206d 6573 7361 6765 735f 6672 6f6d 5f6b   messages_from_k
-0001daf0: 6579 626f 6172 6420 3d20 6765 745f 6d65  eyboard = get_me
-0001db00: 7373 6167 6573 5f66 726f 6d5f 6b65 7962  ssages_from_keyb
-0001db10: 6f61 7264 2829 0a20 2020 2069 6620 6e6f  oard().    if no
-0001db20: 7420 6773 2e70 612e 6d65 7373 6167 653a  t gs.pa.message:
-0001db30: 0a20 2020 2020 2020 206d 6573 7361 6765  .        message
-0001db40: 735f 6672 6f6d 5f63 6f6d 6d61 6e64 6c69  s_from_commandli
-0001db50: 6e65 203d 205b 5d0a 2020 2020 656c 7365  ne = [].    else
-0001db60: 3a0a 2020 2020 2020 2020 6d65 7373 6167  :.        messag
-0001db70: 6573 5f66 726f 6d5f 636f 6d6d 616e 646c  es_from_commandl
-0001db80: 696e 6520 3d20 5b5d 0a20 2020 2020 2020  ine = [].       
-0001db90: 2066 6f72 206d 2069 6e20 6773 2e70 612e   for m in gs.pa.
-0001dba0: 6d65 7373 6167 653a 0a20 2020 2020 2020  message:.       
-0001dbb0: 2020 2020 2069 6620 6d20 3d3d 2022 5c5c       if m == "\\
-0001dbc0: 2d22 3a20 2023 2065 7363 6170 6564 202d  -":  # escaped -
-0001dbd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001dbe0: 206d 6573 7361 6765 735f 6672 6f6d 5f63   messages_from_c
-0001dbf0: 6f6d 6d61 6e64 6c69 6e65 202b 3d20 5b22  ommandline += ["
-0001dc00: 2d22 5d0a 2020 2020 2020 2020 2020 2020  -"].            
-0001dc10: 656c 6966 206d 203d 3d20 225c 5c5f 223a  elif m == "\\_":
-0001dc20: 2020 2320 6573 6361 7065 6420 5f0a 2020    # escaped _.  
-0001dc30: 2020 2020 2020 2020 2020 2020 2020 6d65                me
-0001dc40: 7373 6167 6573 5f66 726f 6d5f 636f 6d6d  ssages_from_comm
-0001dc50: 616e 646c 696e 6520 2b3d 205b 225f 225d  andline += ["_"]
-0001dc60: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-0001dc70: 6620 6d20 3d3d 2022 2d22 3a0a 2020 2020  f m == "-":.    
-0001dc80: 2020 2020 2020 2020 2020 2020 2320 7374              # st
-0001dc90: 6469 6e20 7069 7065 2c20 7265 6164 2061  din pipe, read a
-0001dca0: 6e64 2070 726f 6365 7373 2065 7665 7279  nd process every
-0001dcb0: 7468 696e 6720 696e 2070 6970 6520 6173  thing in pipe as
-0001dcc0: 2031 206d 7367 0a20 2020 2020 2020 2020   1 msg.         
-0001dcd0: 2020 2020 2020 206d 6573 7361 6765 735f         messages_
-0001dce0: 6672 6f6d 5f63 6f6d 6d61 6e64 6c69 6e65  from_commandline
-0001dcf0: 202b 3d20 6765 745f 6d65 7373 6167 6573   += get_messages
-0001dd00: 5f66 726f 6d5f 7069 7065 2829 0a20 2020  _from_pipe().   
-0001dd10: 2020 2020 2020 2020 2065 6c69 6620 6d20           elif m 
-0001dd20: 3d3d 2022 5f22 3a0a 2020 2020 2020 2020  == "_":.        
-0001dd30: 2020 2020 2020 2020 2320 7374 7265 616d          # stream
-0001dd40: 696e 6720 7669 6120 7069 7065 206f 6e20  ing via pipe on 
-0001dd50: 7374 6469 6e0a 2020 2020 2020 2020 2020  stdin.          
-0001dd60: 2020 2020 2020 2320 7374 6469 6e20 7069        # stdin pi
-0001dd70: 7065 2c20 7265 6164 2061 6e64 2070 726f  pe, read and pro
-0001dd80: 6365 7373 2065 7665 7279 7468 696e 6720  cess everything 
-0001dd90: 696e 2070 6970 6520 6c69 6e65 2062 7920  in pipe line by 
-0001dda0: 6c69 6e65 0a20 2020 2020 2020 2020 2020  line.           
-0001ddb0: 2020 2020 2073 7472 6561 6d69 6e67 203d       streaming =
-0001ddc0: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
-0001ddd0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001dde0: 2020 2020 2020 2020 6d65 7373 6167 6573          messages
-0001ddf0: 5f66 726f 6d5f 636f 6d6d 616e 646c 696e  _from_commandlin
-0001de00: 6520 2b3d 205b 6d5d 0a0a 2020 2020 6773  e += [m]..    gs
-0001de10: 2e6c 6f67 2e64 6562 7567 2866 224d 6573  .log.debug(f"Mes
-0001de20: 7361 6765 7320 6672 6f6d 2070 6970 653a  sages from pipe:
-0001de30: 2020 2020 2020 2020 207b 6d65 7373 6167           {messag
-0001de40: 6573 5f66 726f 6d5f 7069 7065 7d22 290a  es_from_pipe}").
-0001de50: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-0001de60: 2866 224d 6573 7361 6765 7320 6672 6f6d  (f"Messages from
-0001de70: 206b 6579 626f 6172 643a 2020 2020 207b   keyboard:     {
-0001de80: 6d65 7373 6167 6573 5f66 726f 6d5f 6b65  messages_from_ke
-0001de90: 7962 6f61 7264 7d22 290a 2020 2020 6773  yboard}").    gs
-0001dea0: 2e6c 6f67 2e64 6562 7567 2866 224d 6573  .log.debug(f"Mes
-0001deb0: 7361 6765 7320 6672 6f6d 2063 6f6d 6d61  sages from comma
-0001dec0: 6e64 2d6c 696e 653a 207b 6d65 7373 6167  nd-line: {messag
-0001ded0: 6573 5f66 726f 6d5f 636f 6d6d 616e 646c  es_from_commandl
-0001dee0: 696e 657d 2229 0a0a 2020 2020 6d65 7373  ine}")..    mess
-0001def0: 6167 6573 5f61 6c6c 203d 2028 0a20 2020  ages_all = (.   
-0001df00: 2020 2020 206d 6573 7361 6765 735f 6672       messages_fr
-0001df10: 6f6d 5f63 6f6d 6d61 6e64 6c69 6e65 202b  om_commandline +
-0001df20: 206d 6573 7361 6765 735f 6672 6f6d 5f70   messages_from_p
-0001df30: 6970 6520 2b20 6d65 7373 6167 6573 5f66  ipe + messages_f
-0001df40: 726f 6d5f 6b65 7962 6f61 7264 0a20 2020  rom_keyboard.   
-0001df50: 2029 2020 2320 6b65 7962 6f61 7264 2061   )  # keyboard a
-0001df60: 7420 656e 640a 0a20 2020 2023 206c 6f6f  t end..    # loo
-0001df70: 7020 7468 7275 2061 6c6c 206d 7367 7320  p thru all msgs 
-0001df80: 616e 6420 7370 6c69 7420 7468 656d 0a20  and split them. 
-0001df90: 2020 2069 6620 6773 2e70 612e 7370 6c69     if gs.pa.spli
-0001dfa0: 743a 0a20 2020 2020 2020 2023 2067 732e  t:.        # gs.
-0001dfb0: 7061 2e73 706c 6974 2063 616e 2068 6176  pa.split can hav
-0001dfc0: 6520 6573 6361 7065 2063 6861 7261 6374  e escape charact
-0001dfd0: 6572 732c 2069 7420 6861 7320 746f 2062  ers, it has to b
-0001dfe0: 6520 6465 2d65 7363 6170 6564 0a20 2020  e de-escaped.   
-0001dff0: 2020 2020 2064 6563 6f64 6564 5f73 7472       decoded_str
-0001e000: 696e 6720 3d20 6279 7465 7328 6773 2e70  ing = bytes(gs.p
-0001e010: 612e 7370 6c69 742c 2022 7574 662d 3822  a.split, "utf-8"
-0001e020: 292e 6465 636f 6465 2822 756e 6963 6f64  ).decode("unicod
-0001e030: 655f 6573 6361 7065 2229 0a20 2020 2020  e_escape").     
-0001e040: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-0001e050: 6627 5374 7269 6e67 2075 7365 6420 666f  f'String used fo
-0001e060: 7220 7370 6c69 7474 696e 6720 6973 3a20  r splitting is: 
-0001e070: 227b 6465 636f 6465 645f 7374 7269 6e67  "{decoded_string
-0001e080: 7d22 2729 0a20 2020 2020 2020 206d 6573  }"').        mes
-0001e090: 7361 6765 735f 616c 6c5f 7370 6c69 7420  sages_all_split 
-0001e0a0: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
-0001e0b0: 206d 2069 6e20 6d65 7373 6167 6573 5f61   m in messages_a
-0001e0c0: 6c6c 3a0a 2020 2020 2020 2020 2020 2020  ll:.            
-0001e0d0: 6d65 7373 6167 6573 5f61 6c6c 5f73 706c  messages_all_spl
-0001e0e0: 6974 202b 3d20 6d2e 7370 6c69 7428 6465  it += m.split(de
-0001e0f0: 636f 6465 645f 7374 7269 6e67 290a 2020  coded_string).  
-0001e100: 2020 656c 7365 3a20 2023 206e 6f74 2067    else:  # not g
-0001e110: 732e 7061 2e73 706c 6974 0a20 2020 2020  s.pa.split.     
-0001e120: 2020 206d 6573 7361 6765 735f 616c 6c5f     messages_all_
-0001e130: 7370 6c69 7420 3d20 6d65 7373 6167 6573  split = messages
-0001e140: 5f61 6c6c 0a0a 2020 2020 6177 6169 7420  _all..    await 
-0001e150: 7365 6e64 5f6d 6573 7361 6765 735f 616e  send_messages_an
-0001e160: 645f 6669 6c65 7328 636c 6965 6e74 2c20  d_files(client, 
-0001e170: 726f 6f6d 732c 206d 6573 7361 6765 735f  rooms, messages_
-0001e180: 616c 6c5f 7370 6c69 7429 0a20 2020 2023  all_split).    #
-0001e190: 206e 6f77 2077 6520 6172 6520 646f 6e65   now we are done
-0001e1a0: 2077 6974 6820 616c 6c20 7468 6520 7573   with all the us
-0001e1b0: 7561 6c20 7365 6e64 732c 206e 6f77 2077  ual sends, now w
-0001e1c0: 6520 7374 6172 7420 7374 7265 616d 696e  e start streamin
-0001e1d0: 670a 2020 2020 6966 2073 7472 6561 6d69  g.    if streami
-0001e1e0: 6e67 3a0a 2020 2020 2020 2020 6177 6169  ng:.        awai
-0001e1f0: 7420 7374 7265 616d 5f6d 6573 7361 6765  t stream_message
-0001e200: 735f 6672 6f6d 5f70 6970 6528 636c 6965  s_from_pipe(clie
-0001e210: 6e74 2c20 726f 6f6d 7329 0a0a 0a61 7379  nt, rooms)...asy
-0001e220: 6e63 2064 6566 206c 6f67 696e 5f75 7369  nc def login_usi
-0001e230: 6e67 5f63 7265 6465 6e74 6961 6c73 5f66  ng_credentials_f
-0001e240: 696c 6528 0a20 2020 2063 7265 6465 6e74  ile(.    credent
-0001e250: 6961 6c73 5f66 696c 653a 204f 7074 696f  ials_file: Optio
-0001e260: 6e61 6c5b 7374 725d 203d 204e 6f6e 652c  nal[str] = None,
-0001e270: 2073 746f 7265 5f64 6972 3a20 4f70 7469   store_dir: Opti
-0001e280: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
-0001e290: 0a29 202d 3e20 2841 7379 6e63 436c 6965  .) -> (AsyncClie
-0001e2a0: 6e74 2c20 6469 6374 293a 0a20 2020 2022  nt, dict):.    "
-0001e2b0: 2222 4c6f 6720 696e 2062 7920 7573 696e  ""Log in by usin
-0001e2c0: 6720 6176 6169 6c61 626c 6520 6372 6564  g available cred
-0001e2d0: 656e 7469 616c 7320 6669 6c65 2e0a 0a20  entials file... 
-0001e2e0: 2020 2041 7267 756d 656e 7473 3a0a 2020     Arguments:.  
-0001e2f0: 2020 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020    ---------.    
-0001e300: 2020 2020 6372 6564 656e 7469 616c 735f      credentials_
-0001e310: 6669 6c65 3a20 7374 7220 3a20 6c6f 6361  file: str : loca
-0001e320: 7469 6f6e 206f 6620 6372 6564 656e 7469  tion of credenti
-0001e330: 616c 7320 6669 6c65 0a20 2020 2020 2020  als file.       
-0001e340: 2020 2020 2063 6f6d 7075 7465 2069 7420       compute it 
-0001e350: 6966 206e 6f74 2070 726f 7669 6465 640a  if not provided.
-0001e360: 2020 2020 2020 2020 7374 6f72 655f 6469          store_di
-0001e370: 723a 2073 7472 203a 206c 6f63 6174 696f  r: str : locatio
-0001e380: 6e20 6f66 2070 6572 7369 7374 656e 7420  n of persistent 
-0001e390: 7374 6f72 6167 6520 7374 6f72 6520 6469  storage store di
-0001e3a0: 7265 6374 6f72 790a 2020 2020 2020 2020  rectory.        
-0001e3b0: 2020 2020 636f 6d70 7574 6520 6974 2069      compute it i
-0001e3c0: 6620 6e6f 7420 7072 6f76 6964 6564 0a0a  f not provided..
-0001e3d0: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-0001e3e0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-0001e3f0: 4173 796e 6343 6c69 656e 7420 3a20 7468  AsyncClient : th
-0001e400: 6520 6372 6561 7465 6420 4e49 4f20 636c  e created NIO cl
-0001e410: 6965 6e74 0a20 2020 2020 2020 2064 6963  ient.        dic
-0001e420: 7420 3a20 7468 6520 6372 6564 656e 7469  t : the credenti
-0001e430: 616c 7320 6469 6374 696f 6e61 7279 2066  als dictionary f
-0001e440: 726f 6d20 7468 6520 6372 6564 656e 7469  rom the credenti
-0001e450: 616c 7320 6669 6c65 0a0a 2020 2020 2222  als file..    ""
-0001e460: 220a 0a20 2020 2069 6620 6e6f 7420 6372  "..    if not cr
-0001e470: 6564 656e 7469 616c 735f 6669 6c65 3a0a  edentials_file:.
-0001e480: 2020 2020 2020 2020 6372 6564 656e 7469          credenti
-0001e490: 616c 735f 6669 6c65 203d 2064 6574 6572  als_file = deter
-0001e4a0: 6d69 6e65 5f63 7265 6465 6e74 6961 6c73  mine_credentials
-0001e4b0: 5f66 696c 6528 290a 2020 2020 6966 206e  _file().    if n
-0001e4c0: 6f74 2073 746f 7265 5f64 6972 3a0a 2020  ot store_dir:.  
-0001e4d0: 2020 2020 2020 7374 6f72 655f 6469 7220        store_dir 
-0001e4e0: 3d20 6465 7465 726d 696e 655f 7374 6f72  = determine_stor
-0001e4f0: 655f 6469 7228 290a 0a20 2020 2069 6620  e_dir()..    if 
-0001e500: 6e6f 7420 6372 6564 656e 7469 616c 735f  not credentials_
-0001e510: 6578 6973 7428 6372 6564 656e 7469 616c  exist(credential
-0001e520: 735f 6669 6c65 293a 0a20 2020 2020 2020  s_file):.       
-0001e530: 2072 6169 7365 204d 6174 7269 7843 6f6d   raise MatrixCom
-0001e540: 6d61 6e64 6572 4572 726f 7228 0a20 2020  manderError(.   
-0001e550: 2020 2020 2020 2020 2022 4531 3533 3a20           "E153: 
-0001e560: 220a 2020 2020 2020 2020 2020 2020 2243  ".            "C
-0001e570: 7265 6465 6e74 6961 6c73 2066 696c 6520  redentials file 
-0001e580: 7761 7320 6e6f 7420 666f 756e 642e 2050  was not found. P
-0001e590: 726f 7669 6465 2063 7265 6465 6e74 6961  rovide credentia
-0001e5a0: 6c73 2066 696c 6520 6f72 2022 0a20 2020  ls file or ".   
-0001e5b0: 2020 2020 2020 2020 2022 7573 6520 2d2d           "use --
-0001e5c0: 6c6f 6769 6e20 746f 2063 7265 6174 6520  login to create 
-0001e5d0: 6120 6372 6564 656e 7469 616c 7320 6669  a credentials fi
-0001e5e0: 6c65 2e22 0a20 2020 2020 2020 2029 2066  le.".        ) f
-0001e5f0: 726f 6d20 4e6f 6e65 0a20 2020 2069 6620  rom None.    if 
-0001e600: 6e6f 7420 7374 6f72 655f 6578 6973 7473  not store_exists
-0001e610: 2873 746f 7265 5f64 6972 293a 0a20 2020  (store_dir):.   
-0001e620: 2020 2020 2072 6169 7365 204d 6174 7269       raise Matri
-0001e630: 7843 6f6d 6d61 6e64 6572 4572 726f 7228  xCommanderError(
-0001e640: 0a20 2020 2020 2020 2020 2020 2022 4531  .            "E1
-0001e650: 3534 3a20 220a 2020 2020 2020 2020 2020  54: ".          
-0001e660: 2020 2253 746f 7265 2064 6972 6563 746f    "Store directo
-0001e670: 7279 2077 6173 206e 6f74 2066 6f75 6e64  ry was not found
-0001e680: 2e20 5072 6f76 6964 6520 7374 6f72 6520  . Provide store 
-0001e690: 6469 7265 6374 6f72 7920 6f72 2022 0a20  directory or ". 
-0001e6a0: 2020 2020 2020 2020 2020 2022 7573 6520             "use 
-0001e6b0: 2d2d 6c6f 6769 6e20 746f 2063 7265 6174  --login to creat
-0001e6c0: 6520 6120 7374 6f72 6520 6469 7265 6374  e a store direct
-0001e6d0: 6f72 792e 220a 2020 2020 2020 2020 2920  ory.".        ) 
-0001e6e0: 6672 6f6d 204e 6f6e 650a 0a20 2020 2063  from None..    c
-0001e6f0: 7265 6465 6e74 6961 6c73 203d 2072 6561  redentials = rea
-0001e700: 645f 6372 6564 656e 7469 616c 735f 6672  d_credentials_fr
-0001e710: 6f6d 5f64 6973 6b28 6372 6564 656e 7469  om_disk(credenti
-0001e720: 616c 735f 6669 6c65 290a 2020 2020 6773  als_file).    gs
-0001e730: 2e63 7265 6465 6e74 6961 6c73 203d 2063  .credentials = c
-0001e740: 7265 6465 6e74 6961 6c73 0a0a 2020 2020  redentials..    
-0001e750: 6773 2e6c 6f67 2e64 6562 7567 2822 4162  gs.log.debug("Ab
-0001e760: 6f75 7420 746f 2063 6f6e 6669 6775 7265  out to configure
-0001e770: 204d 6174 7269 7820 4173 796e 6320 436c   Matrix Async Cl
-0001e780: 6965 6e74 2e22 290a 2020 2020 2320 436f  ient.").    # Co
-0001e790: 6e66 6967 7572 6174 696f 6e20 6f70 7469  nfiguration opti
-0001e7a0: 6f6e 7320 666f 7220 7468 6520 4173 796e  ons for the Asyn
-0001e7b0: 6343 6c69 656e 740a 2020 2020 636c 6965  cClient.    clie
-0001e7c0: 6e74 5f63 6f6e 6669 6720 3d20 4173 796e  nt_config = Asyn
-0001e7d0: 6343 6c69 656e 7443 6f6e 6669 6728 0a20  cClientConfig(. 
-0001e7e0: 2020 2020 2020 206d 6178 5f6c 696d 6974         max_limit
-0001e7f0: 5f65 7863 6565 6465 643d 302c 0a20 2020  _exceeded=0,.   
-0001e800: 2020 2020 206d 6178 5f74 696d 656f 7574       max_timeout
-0001e810: 733d 302c 0a20 2020 2020 2020 2073 746f  s=0,.        sto
-0001e820: 7265 5f73 796e 635f 746f 6b65 6e73 3d54  re_sync_tokens=T
-0001e830: 7275 652c 0a20 2020 2020 2020 2065 6e63  rue,.        enc
-0001e840: 7279 7074 696f 6e5f 656e 6162 6c65 643d  ryption_enabled=
-0001e850: 5472 7565 2c0a 2020 2020 290a 2020 2020  True,.    ).    
-0001e860: 6773 2e6c 6f67 2e64 6562 7567 2822 4162  gs.log.debug("Ab
-0001e870: 6f75 7420 746f 2069 6e69 7469 616c 697a  out to initializ
-0001e880: 6520 4d61 7472 6978 2041 7379 6e63 2043  e Matrix Async C
-0001e890: 6c69 656e 742e 2229 0a20 2020 2023 2049  lient.").    # I
-0001e8a0: 6e69 7469 616c 697a 6520 7468 6520 6d61  nitialize the ma
-0001e8b0: 7472 6978 2063 6c69 656e 7420 6261 7365  trix client base
-0001e8c0: 6420 6f6e 2063 7265 6465 6e74 6961 6c73  d on credentials
-0001e8d0: 2066 726f 6d20 6669 6c65 0a20 2020 2063   from file.    c
-0001e8e0: 6c69 656e 7420 3d20 4173 796e 6343 6c69  lient = AsyncCli
-0001e8f0: 656e 7428 0a20 2020 2020 2020 2063 7265  ent(.        cre
-0001e900: 6465 6e74 6961 6c73 5b22 686f 6d65 7365  dentials["homese
-0001e910: 7276 6572 225d 2c0a 2020 2020 2020 2020  rver"],.        
-0001e920: 6372 6564 656e 7469 616c 735b 2275 7365  credentials["use
-0001e930: 725f 6964 225d 2c0a 2020 2020 2020 2020  r_id"],.        
-0001e940: 6465 7669 6365 5f69 643d 6372 6564 656e  device_id=creden
-0001e950: 7469 616c 735b 2264 6576 6963 655f 6964  tials["device_id
-0001e960: 225d 2c0a 2020 2020 2020 2020 7374 6f72  "],.        stor
-0001e970: 655f 7061 7468 3d73 746f 7265 5f64 6972  e_path=store_dir
-0001e980: 2c0a 2020 2020 2020 2020 636f 6e66 6967  ,.        config
-0001e990: 3d63 6c69 656e 745f 636f 6e66 6967 2c0a  =client_config,.
-0001e9a0: 2020 2020 2020 2020 7373 6c3d 6773 2e73          ssl=gs.s
-0001e9b0: 736c 2c0a 2020 2020 2020 2020 7072 6f78  sl,.        prox
-0001e9c0: 793d 6773 2e70 612e 7072 6f78 792c 0a20  y=gs.pa.proxy,. 
-0001e9d0: 2020 2029 0a20 2020 2069 6620 6773 2e70     ).    if gs.p
-0001e9e0: 612e 7072 6f78 793a 0a20 2020 2020 2020  a.proxy:.       
-0001e9f0: 2067 732e 6c6f 672e 6465 6275 6728 6622   gs.log.debug(f"
-0001ea00: 5072 6f78 7920 7b67 732e 7061 2e70 726f  Proxy {gs.pa.pro
-0001ea10: 7879 7d20 7769 6c6c 2062 6520 7573 6564  xy} will be used
-0001ea20: 2066 6f72 2063 6f6e 6e65 6374 6976 6974   for connectivit
-0001ea30: 792e 2229 0a0a 2020 2020 6773 2e6c 6f67  y.")..    gs.log
-0001ea40: 2e64 6562 7567 2822 4162 6f75 7420 746f  .debug("About to
-0001ea50: 2072 6573 746f 7265 206c 6f67 696e 2e22   restore login."
-0001ea60: 290a 2020 2020 2320 7265 7374 6f72 655f  ).    # restore_
-0001ea70: 6c6f 6769 6e28 2920 616c 7761 7973 2072  login() always r
-0001ea80: 6574 7572 6e73 204e 6f6e 652c 206f 6e20  eturns None, on 
-0001ea90: 7375 6363 6573 7320 6f72 2066 6169 6c75  success or failu
-0001eaa0: 7265 0a20 2020 2023 2072 6573 746f 7265  re.    # restore
-0001eab0: 5f6c 6f67 696e 2829 2064 6f65 7320 6e6f  _login() does no
-0001eac0: 7420 676f 2074 6f20 7468 6520 7365 7276  t go to the serv
-0001ead0: 6572 2c20 6974 206a 7573 7420 7365 7473  er, it just sets
-0001eae0: 2073 6f6d 6520 6c6f 6361 6c20 7661 6c75   some local valu
-0001eaf0: 6573 0a20 2020 2023 2054 4f44 4f3a 2070  es.    # TODO: p
-0001eb00: 6572 666f 726d 616e 6365 0a20 2020 2023  erformance.    #
-0001eb10: 2072 6573 746f 7265 5f6c 6f67 696e 2829   restore_login()
-0001eb20: 2069 7320 6120 736c 6f77 206f 7065 7261   is a slow opera
-0001eb30: 7469 6f6e 2e20 312e 3573 2074 6f20 3273  tion. 1.5s to 2s
-0001eb40: 2e20 5768 793f 0a20 2020 2023 2042 6563  . Why?.    # Bec
-0001eb50: 6175 7365 2069 7420 6973 2072 6561 6469  ause it is readi
-0001eb60: 6e67 2074 6865 2073 746f 7265 2066 696c  ng the store fil
-0001eb70: 6520 6461 7461 6261 7365 2e0a 2020 2020  e database..    
-0001eb80: 2320 5365 7474 696e 6720 7374 6f72 655f  # Setting store_
-0001eb90: 7379 6e63 5f74 6f6b 656e 733d 4661 6c73  sync_tokens=Fals
-0001eba0: 6520 6162 6f76 6520 7769 6c6c 206e 6f74  e above will not
-0001ebb0: 206d 616b 6520 6974 2067 6f20 616e 7920   make it go any 
-0001ebc0: 6661 7374 6572 2e0a 2020 2020 636c 6965  faster..    clie
-0001ebd0: 6e74 2e72 6573 746f 7265 5f6c 6f67 696e  nt.restore_login
-0001ebe0: 280a 2020 2020 2020 2020 7573 6572 5f69  (.        user_i
-0001ebf0: 643d 6372 6564 656e 7469 616c 735b 2275  d=credentials["u
-0001ec00: 7365 725f 6964 225d 2c0a 2020 2020 2020  ser_id"],.      
-0001ec10: 2020 6465 7669 6365 5f69 643d 6372 6564    device_id=cred
-0001ec20: 656e 7469 616c 735b 2264 6576 6963 655f  entials["device_
-0001ec30: 6964 225d 2c0a 2020 2020 2020 2020 6163  id"],.        ac
-0001ec40: 6365 7373 5f74 6f6b 656e 3d63 7265 6465  cess_token=crede
-0001ec50: 6e74 6961 6c73 5b22 6163 6365 7373 5f74  ntials["access_t
-0001ec60: 6f6b 656e 225d 2c0a 2020 2020 290a 2020  oken"],.    ).  
-0001ec70: 2020 6773 2e6c 6f67 2e64 6562 7567 2822    gs.log.debug("
-0001ec80: 4669 6e69 7368 6564 2072 6573 746f 7269  Finished restori
-0001ec90: 6e67 206c 6f67 696e 2e22 290a 2020 2020  ng login.").    
-0001eca0: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
-0001ecb0: 2020 2020 2020 224c 6f67 696e 2077 696c        "Login wil
-0001ecc0: 6c20 6265 2075 7369 6e67 2073 746f 7265  l be using store
-0001ecd0: 6420 6372 6564 656e 7469 616c 7320 6672  d credentials fr
-0001ece0: 6f6d 2022 0a20 2020 2020 2020 2066 2763  om ".        f'c
-0001ecf0: 7265 6465 6e74 6961 6c73 2066 696c 6520  redentials file 
-0001ed00: 227b 6372 6564 656e 7469 616c 735f 6669  "{credentials_fi
-0001ed10: 6c65 7d22 2e20 270a 2020 2020 2020 2020  le}". '.        
-0001ed20: 6627 726f 6f6d 5f69 6420 3d20 7b63 7265  f'room_id = {cre
-0001ed30: 6465 6e74 6961 6c73 5b22 726f 6f6d 5f69  dentials["room_i
-0001ed40: 6422 5d7d 2c20 270a 2020 2020 2020 2020  d"]}, '.        
-0001ed50: 6627 6465 7669 6365 5f69 6420 3d20 7b63  f'device_id = {c
-0001ed60: 7265 6465 6e74 6961 6c73 5b22 6465 7669  redentials["devi
-0001ed70: 6365 5f69 6422 5d7d 2c20 270a 2020 2020  ce_id"]}, '.    
-0001ed80: 2020 2020 6627 6163 6365 7373 5f74 6f6b      f'access_tok
-0001ed90: 656e 203d 207b 6372 6564 656e 7469 616c  en = {credential
-0001eda0: 735b 2261 6363 6573 735f 746f 6b65 6e22  s["access_token"
-0001edb0: 5d5b 303a 315d 7d2a 2a2a 270a 2020 2020  ][0:1]}***'.    
-0001edc0: 2020 2020 6627 7b63 7265 6465 6e74 6961      f'{credentia
-0001edd0: 6c73 5b22 6163 6365 7373 5f74 6f6b 656e  ls["access_token
-0001ede0: 225d 5b2d 313a 5d7d 2e27 0a20 2020 2029  "][-1:]}.'.    )
-0001edf0: 0a20 2020 2069 6620 6773 2e70 612e 6465  .    if gs.pa.de
-0001ee00: 6275 6720 3e20 303a 0a20 2020 2020 2020  bug > 0:.       
-0001ee10: 2067 732e 6c6f 672e 6465 6275 6728 2241   gs.log.debug("A
-0001ee20: 626f 7574 2074 6f20 636f 6e6e 6563 7420  bout to connect 
-0001ee30: 746f 2073 6572 7665 7220 746f 2076 6572  to server to ver
-0001ee40: 6966 7920 636f 6e6e 6563 7469 6f6e 2e22  ify connection."
-0001ee50: 290a 2020 2020 2020 2020 2320 6773 2e6c  ).        # gs.l
-0001ee60: 6f67 2e64 6562 7567 2866 224c 6f67 6765  og.debug(f"Logge
-0001ee70: 645f 696e 2829 3d7b 636c 6965 6e74 2e6c  d_in()={client.l
-0001ee80: 6f67 6765 645f 696e 7d22 2920 6973 2061  ogged_in}") is a
-0001ee90: 6c77 6179 7320 5472 7565 2e0a 2020 2020  lways True..    
-0001eea0: 2020 2020 2320 4a75 7374 2062 6563 6175      # Just becau
-0001eeb0: 7365 2063 6c69 656e 742e 6c6f 6767 6564  se client.logged
-0001eec0: 5f69 6e20 6973 2054 7275 6520 646f 6573  _in is True does
-0001eed0: 206e 6f74 206d 6561 6e20 7765 2061 7265   not mean we are
-0001eee0: 206c 6f67 6765 6420 696e 2e0a 2020 2020   logged in..    
-0001eef0: 2020 2020 2320 5468 6174 206a 7573 7420      # That just 
-0001ef00: 6d65 616e 7320 7468 6520 6461 7461 2073  means the data s
-0001ef10: 7472 7563 7475 7265 2069 7320 6669 6c6c  tructure is fill
-0001ef20: 6564 2e0a 2020 2020 2020 2020 2320 486f  ed..        # Ho
-0001ef30: 7720 746f 206b 6e6f 7720 6966 206c 6f67  w to know if log
-0001ef40: 696e 2077 6173 2073 7563 6365 7373 6675  in was successfu
-0001ef50: 6c3f 0a20 2020 2020 2020 2023 2044 6f20  l?.        # Do 
-0001ef60: 616e 2061 6374 7561 6c20 4150 4920 6361  an actual API ca
-0001ef70: 6c6c 2061 6761 696e 7374 2074 6865 2073  ll against the s
-0001ef80: 6572 7665 722e 2045 2e67 2e20 7768 6f61  erver. E.g. whoa
-0001ef90: 6d69 2e0a 2020 2020 2020 2020 2320 5765  mi..        # We
-0001efa0: 2064 6f6e 2774 2077 616e 7420 746f 2064   don't want to d
-0001efb0: 6f20 7468 6973 2061 6c77 6179 7320 666f  o this always fo
-0001efc0: 7220 7065 7266 6f72 6d61 6e63 6520 7265  r performance re
-0001efd0: 6173 6f6e 732c 2073 6f20 7765 206f 6e6c  asons, so we onl
-0001efe0: 790a 2020 2020 2020 2020 2320 646f 2069  y.        # do i
-0001eff0: 7420 696e 2064 6562 7567 206d 6f64 652e  t in debug mode.
-0001f000: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-0001f010: 2020 2020 2020 2020 2020 7265 7370 203d            resp =
-0001f020: 2061 7761 6974 2063 6c69 656e 742e 7768   await client.wh
-0001f030: 6f61 6d69 2829 0a20 2020 2020 2020 2065  oami().        e
-0001f040: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
-0001f050: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-0001f060: 2020 6177 6169 7420 636c 6965 6e74 2e63    await client.c
-0001f070: 6c6f 7365 2829 0a20 2020 2020 2020 2020  lose().         
-0001f080: 2020 2063 6c69 656e 7420 3d20 4e6f 6e65     client = None
-0001f090: 0a20 2020 2020 2020 2020 2020 2063 7265  .            cre
-0001f0a0: 6465 6e74 6961 6c73 203d 204e 6f6e 650a  dentials = None.
-0001f0b0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0001f0c0: 6520 2865 290a 2020 2020 2020 2020 6966  e (e).        if
-0001f0d0: 2069 7369 6e73 7461 6e63 6528 7265 7370   isinstance(resp
-0001f0e0: 2c20 7265 7370 6f6e 7365 732e 5768 6f61  , responses.Whoa
-0001f0f0: 6d69 4572 726f 7229 3a0a 2020 2020 2020  miError):.      
-0001f100: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
-0001f110: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-0001f120: 2020 2020 2245 3135 353a 2022 0a20 2020      "E155: ".   
-0001f130: 2020 2020 2020 2020 2020 2020 2022 7265               "re
-0001f140: 7374 6f72 655f 6c6f 6769 6e20 6661 696c  store_login fail
-0001f150: 6564 2e20 4469 6420 796f 7520 7065 7266  ed. Did you perf
-0001f160: 6f72 6d20 2d2d 6c6f 676f 7574 2022 0a20  orm --logout ". 
-0001f170: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001f180: 6265 666f 7265 3f20 4c6f 6f6b 7320 6c69  before? Looks li
-0001f190: 6b65 2079 6f75 7220 6163 6365 7373 2d74  ke your access-t
-0001f1a0: 6f6b 656e 2065 7870 6972 6564 2e20 4d61  oken expired. Ma
-0001f1b0: 7962 6520 220a 2020 2020 2020 2020 2020  ybe ".          
-0001f1c0: 2020 2020 2020 2264 656c 6574 6520 6372        "delete cr
-0001f1d0: 6564 656e 7469 616c 7320 6669 6c65 2061  edentials file a
-0001f1e0: 6e64 2073 746f 7265 2061 6e64 2070 6572  nd store and per
-0001f1f0: 666f 726d 2061 2022 0a20 2020 2020 2020  form a ".       
-0001f200: 2020 2020 2020 2020 2066 226e 6577 202d           f"new -
-0001f210: 2d6c 6f67 696e 2e20 5265 7370 6f6e 7365  -login. Response
-0001f220: 2069 733a 207b 7072 6976 6163 795f 6669   is: {privacy_fi
-0001f230: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
-0001f240: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-0001f250: 2020 2020 2020 2020 2020 2020 6773 2e65              gs.e
-0001f260: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
-0001f270: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-0001f280: 636c 6965 6e74 2e63 6c6f 7365 2829 0a20  client.close(). 
-0001f290: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
-0001f2a0: 7420 3d20 4e6f 6e65 0a20 2020 2020 2020  t = None.       
-0001f2b0: 2020 2020 2063 7265 6465 6e74 6961 6c73       credentials
-0001f2c0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-0001f2d0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001f2e0: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
-0001f2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f300: 2272 6573 746f 7265 5f6c 6f67 696e 2073  "restore_login s
-0001f310: 7563 6365 7373 6675 6c2e 2053 7563 6365  uccessful. Succe
-0001f320: 7373 6675 6c6c 7920 220a 2020 2020 2020  ssfully ".      
-0001f330: 2020 2020 2020 2020 2020 6622 6c6f 6767            f"logg
-0001f340: 6564 2069 6e20 6173 2075 7365 7220 7b72  ed in as user {r
-0001f350: 6573 702e 7573 6572 5f69 647d 2076 6961  esp.user_id} via
-0001f360: 2072 6573 746f 7265 5f6c 6f67 696e 2e20   restore_login. 
-0001f370: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0001f380: 2020 6622 5265 7370 6f6e 7365 2069 733a    f"Response is:
-0001f390: 207b 7072 6976 6163 795f 6669 6c74 6572   {privacy_filter
-0001f3a0: 2873 7472 2872 6573 7029 297d 220a 2020  (str(resp))}".  
-0001f3b0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0001f3c0: 656c 7365 3a0a 2020 2020 2020 2020 7061  else:.        pa
-0001f3d0: 7373 0a20 2020 2020 2020 2023 206c 6f67  ss.        # log
-0001f3e0: 696e 206d 6967 6874 206f 7220 6d69 6768  in might or migh
-0001f3f0: 7420 6e6f 7420 6661 696c 206c 6174 6572  t not fail later
-0001f400: 2c0a 2020 2020 2020 2020 2320 6966 2069  ,.        # if i
-0001f410: 7420 6661 696c 7320 736f 6d65 2065 7863  t fails some exc
-0001f420: 6570 7469 6f6e 2077 696c 6c20 6265 2072  eption will be r
-0001f430: 6169 7365 642c 2074 6865 2065 7863 6570  aised, the excep
-0001f440: 7469 6f6e 2074 6578 740a 2020 2020 2020  tion text.      
-0001f450: 2020 2320 6d69 6768 7420 6e6f 7420 6578    # might not ex
-0001f460: 706c 6169 6e20 7468 6520 7072 6f62 6c65  plain the proble
-0001f470: 6d20 7765 6c6c 2c20 6275 7420 7468 6973  m well, but this
-0001f480: 2077 6179 2077 6520 7370 6565 6420 7570   way we speed up
-0001f490: 0a20 2020 2020 2020 2023 2070 6572 666f  .        # perfo
-0001f4a0: 726d 616e 6365 2062 7920 6973 7375 696e  rmance by issuin
-0001f4b0: 6720 6f6e 6520 4150 4920 6c65 7373 2061  g one API less a
-0001f4c0: 6761 696e 7374 2074 6865 2073 6572 7665  gainst the serve
-0001f4d0: 722e 0a20 2020 2072 6574 7572 6e20 2863  r..    return (c
-0001f4e0: 6c69 656e 742c 2063 7265 6465 6e74 6961  lient, credentia
-0001f4f0: 6c73 290a 0a0a 6173 796e 6320 6465 6620  ls)...async def 
-0001f500: 6c69 7374 656e 5f66 6f72 6576 6572 2863  listen_forever(c
-0001f510: 6c69 656e 743a 2041 7379 6e63 436c 6965  lient: AsyncClie
-0001f520: 6e74 2920 2d3e 204e 6f6e 653a 0a20 2020  nt) -> None:.   
-0001f530: 2022 2222 4c69 7374 656e 2066 6f72 6576   """Listen forev
-0001f540: 6572 206f 7220 756e 7469 6c20 436f 6e74  er or until Cont
-0001f550: 726f 6c2d 432e 2222 220a 2020 2020 2320  rol-C.""".    # 
-0001f560: 5365 7420 7570 2065 7665 6e74 2063 616c  Set up event cal
-0001f570: 6c62 6163 6b73 0a20 2020 2063 616c 6c62  lbacks.    callb
-0001f580: 6163 6b73 203d 2043 616c 6c62 6163 6b73  acks = Callbacks
-0001f590: 2863 6c69 656e 7429 0a20 2020 2063 6c69  (client).    cli
-0001f5a0: 656e 742e 6164 645f 6576 656e 745f 6361  ent.add_event_ca
-0001f5b0: 6c6c 6261 636b 280a 2020 2020 2020 2020  llback(.        
-0001f5c0: 6361 6c6c 6261 636b 732e 6d65 7373 6167  callbacks.messag
-0001f5d0: 655f 6361 6c6c 6261 636b 2c0a 2020 2020  e_callback,.    
-0001f5e0: 2020 2020 280a 2020 2020 2020 2020 2020      (.          
-0001f5f0: 2020 526f 6f6d 4d65 7373 6167 652c 0a20    RoomMessage,. 
-0001f600: 2020 2020 2020 2020 2020 2052 6564 6163             Redac
-0001f610: 7465 6445 7665 6e74 2c0a 2020 2020 2020  tedEvent,.      
-0001f620: 2020 2020 2020 5265 6461 6374 696f 6e45        RedactionE
-0001f630: 7665 6e74 2c0a 2020 2020 2020 2020 292c  vent,.        ),
-0001f640: 0a20 2020 2029 0a20 2020 2070 7269 6e74  .    ).    print
-0001f650: 280a 2020 2020 2020 2020 2254 6869 7320  (.        "This 
-0001f660: 7072 6f67 7261 6d20 6973 2072 6561 6479  program is ready
-0001f670: 2061 6e64 206c 6973 7465 6e69 6e67 2066   and listening f
-0001f680: 6f72 2069 7473 204d 6174 7269 7820 6d65  or its Matrix me
-0001f690: 7373 6167 6573 2e20 220a 2020 2020 2020  ssages. ".      
-0001f6a0: 2020 2254 6f20 7374 6f70 2070 726f 6772    "To stop progr
-0001f6b0: 616d 2074 7970 6520 436f 6e74 726f 6c2d  am type Control-
-0001f6c0: 4320 6f6e 206b 6579 626f 6172 6420 6f72  C on keyboard or
-0001f6d0: 2073 656e 6420 7369 676e 616c 2022 0a20   send signal ". 
-0001f6e0: 2020 2020 2020 2066 2274 6f20 7072 6f63         f"to proc
-0001f6f0: 6573 7320 7b6f 732e 6765 7470 6964 2829  ess {os.getpid()
-0001f700: 7d2e 2050 4944 2063 616e 2061 6c73 6f20  }. PID can also 
-0001f710: 6265 2066 6f75 6e64 2069 6e20 220a 2020  be found in ".  
-0001f720: 2020 2020 2020 6627 6669 6c65 2022 7b50        f'file "{P
-0001f730: 4944 5f46 494c 455f 4445 4641 554c 547d  ID_FILE_DEFAULT}
-0001f740: 222e 272c 0a20 2020 2020 2020 2066 696c  ".',.        fil
-0001f750: 653d 7379 732e 7374 6465 7272 2c0a 2020  e=sys.stderr,.  
-0001f760: 2020 2020 2020 666c 7573 683d 5472 7565        flush=True
-0001f770: 2c0a 2020 2020 290a 2020 2020 2320 7468  ,.    ).    # th
-0001f780: 6520 7379 6e63 5f6c 6f6f 7020 7769 6c6c  e sync_loop will
-0001f790: 2062 6520 7465 726d 696e 6174 6564 2062   be terminated b
-0001f7a0: 7920 7573 6572 2068 6974 7469 6e67 2043  y user hitting C
-0001f7b0: 6f6e 7472 6f6c 2d43 2074 6f20 7374 6f70  ontrol-C to stop
-0001f7c0: 0a20 2020 2061 7761 6974 2063 6c69 656e  .    await clien
-0001f7d0: 742e 7379 6e63 5f66 6f72 6576 6572 2874  t.sync_forever(t
-0001f7e0: 696d 656f 7574 3d33 3030 3030 2c20 6675  imeout=30000, fu
-0001f7f0: 6c6c 5f73 7461 7465 3d54 7275 6529 0a0a  ll_state=True)..
-0001f800: 0a61 7379 6e63 2064 6566 206c 6973 7465  .async def liste
-0001f810: 6e5f 6f6e 6365 2863 6c69 656e 743a 2041  n_once(client: A
-0001f820: 7379 6e63 436c 6965 6e74 2920 2d3e 204e  syncClient) -> N
-0001f830: 6f6e 653a 0a20 2020 2022 2222 4c69 7374  one:.    """List
-0001f840: 656e 206f 6e63 652c 2074 6865 6e20 7175  en once, then qu
-0001f850: 6974 2e0a 0a20 2020 2047 6574 2061 6c6c  it...    Get all
-0001f860: 2074 6865 206d 6573 7361 6765 7320 7468   the messages th
-0001f870: 6174 2061 7265 2063 7572 7265 6e74 6c79  at are currently
-0001f880: 2071 7565 7565 6420 7570 2061 6e64 2077   queued up and w
-0001f890: 6169 7469 6e67 2e0a 2020 2020 5072 696e  aiting..    Prin
-0001f8a0: 7420 7468 656d 2e20 5468 656e 206c 6561  t them. Then lea
-0001f8b0: 7665 2e0a 2020 2020 2222 220a 2020 2020  ve..    """.    
-0001f8c0: 2320 5365 7420 7570 2065 7665 6e74 2063  # Set up event c
-0001f8d0: 616c 6c62 6163 6b73 0a20 2020 2063 616c  allbacks.    cal
-0001f8e0: 6c62 6163 6b73 203d 2043 616c 6c62 6163  lbacks = Callbac
-0001f8f0: 6b73 2863 6c69 656e 7429 0a20 2020 2063  ks(client).    c
-0001f900: 6c69 656e 742e 6164 645f 6576 656e 745f  lient.add_event_
-0001f910: 6361 6c6c 6261 636b 2863 616c 6c62 6163  callback(callbac
-0001f920: 6b73 2e6d 6573 7361 6765 5f63 616c 6c62  ks.message_callb
-0001f930: 6163 6b2c 2028 526f 6f6d 4d65 7373 6167  ack, (RoomMessag
-0001f940: 652c 2929 0a20 2020 2023 2057 6520 7761  e,)).    # We wa
-0001f950: 6e74 2074 6f20 6765 7420 6f75 7420 7175  nt to get out qu
-0001f960: 6963 6b6c 792c 2073 6f20 7765 2072 6564  ickly, so we red
-0001f970: 7563 6564 2074 696d 656f 7574 2074 6f20  uced timeout to 
-0001f980: 3130 2073 6563 2e0a 2020 2020 2320 5765  10 sec..    # We
-0001f990: 2077 616e 7420 746f 2067 6574 206d 6573   want to get mes
-0001f9a0: 7361 6765 7320 616e 6420 7175 6974 2c20  sages and quit, 
-0001f9b0: 736f 2077 6520 6361 6c6c 2073 796e 6328  so we call sync(
-0001f9c0: 2920 696e 7374 6561 6420 6f66 0a20 2020  ) instead of.   
-0001f9d0: 2023 2073 796e 635f 666f 7265 7665 7228   # sync_forever(
-0001f9e0: 292e 0a20 2020 2072 6573 7020 3d20 6177  )..    resp = aw
-0001f9f0: 6169 7420 636c 6965 6e74 2e73 796e 6328  ait client.sync(
-0001fa00: 7469 6d65 6f75 743d 3130 3030 302c 2066  timeout=10000, f
-0001fa10: 756c 6c5f 7374 6174 653d 4661 6c73 6529  ull_state=False)
-0001fa20: 0a20 2020 2069 6620 6973 696e 7374 616e  .    if isinstan
-0001fa30: 6365 2872 6573 702c 2053 796e 6352 6573  ce(resp, SyncRes
-0001fa40: 706f 6e73 6529 3a0a 2020 2020 2020 2020  ponse):.        
-0001fa50: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
-0001fa60: 2020 2020 2020 2020 2020 6622 5379 6e63            f"Sync
-0001fa70: 2073 7563 6365 7373 6675 6c2e 2052 6573   successful. Res
-0001fa80: 706f 6e73 6520 6973 3a20 7b70 7269 7661  ponse is: {priva
-0001fa90: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
-0001faa0: 7370 2929 7d22 0a20 2020 2020 2020 2029  sp))}".        )
-0001fab0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-0001fac0: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
-0001fad0: 0a20 2020 2020 2020 2020 2020 2022 4531  .            "E1
-0001fae0: 3630 3a20 2220 6622 5379 6e63 2066 6169  60: " f"Sync fai
-0001faf0: 6c65 642e 2045 7272 6f72 2069 733a 207b  led. Error is: {
-0001fb00: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
-0001fb10: 7472 2872 6573 7029 297d 220a 2020 2020  tr(resp))}".    
-0001fb20: 2020 2020 290a 2020 2020 2320 7379 6e63      ).    # sync
-0001fb30: 2829 2066 6f72 6365 7320 7468 6520 6d65  () forces the me
-0001fb40: 7373 6167 655f 6361 6c6c 6261 636b 2829  ssage_callback()
-0001fb50: 2074 6f20 6669 7265 0a20 2020 2023 2066   to fire.    # f
-0001fb60: 6f72 2065 6163 6820 6e65 7720 6d65 7373  or each new mess
-0001fb70: 6167 6520 7072 6573 656e 7465 6420 696e  age presented in
-0001fb80: 2074 6865 2073 796e 6328 292e 0a0a 0a61   the sync()....a
-0001fb90: 7379 6e63 2064 6566 206c 6973 7465 6e5f  sync def listen_
-0001fba0: 6f6e 6365 5f61 6c74 6572 6e61 7469 7665  once_alternative
-0001fbb0: 2863 6c69 656e 743a 2041 7379 6e63 436c  (client: AsyncCl
-0001fbc0: 6965 6e74 2920 2d3e 204e 6f6e 653a 0a20  ient) -> None:. 
-0001fbd0: 2020 2022 2222 4c69 7374 656e 206f 6e63     """Listen onc
-0001fbe0: 652c 2074 6865 6e20 7175 6974 2e0a 0a20  e, then quit... 
-0001fbf0: 2020 2047 6574 2061 6c6c 2074 6865 206d     Get all the m
-0001fc00: 6573 7361 6765 7320 7468 6174 2061 7265  essages that are
-0001fc10: 2063 7572 7265 6e74 6c79 2071 7565 7565   currently queue
-0001fc20: 6420 7570 2061 6e64 2077 6169 7469 6e67  d up and waiting
-0001fc30: 2e0a 2020 2020 5072 696e 7420 7468 656d  ..    Print them
-0001fc40: 2e20 5468 656e 206c 6561 7665 2e0a 0a20  . Then leave... 
-0001fc50: 2020 2041 6c74 6572 6e61 7469 7665 2069     Alternative i
-0001fc60: 6d70 6c65 6d65 6e74 6174 696f 6e20 6f66  mplementation of
-0001fc70: 206c 6973 7465 6e5f 6f6e 6365 2829 2e0a   listen_once()..
-0001fc80: 2020 2020 5765 2064 6f6e 2774 2075 7365      We don't use
-0001fc90: 2061 6e79 2063 616c 6c62 6163 6b73 2061   any callbacks a
-0001fca0: 6e64 2077 6520 6a75 7374 2063 616c 6c20  nd we just call 
-0001fcb0: 7379 6e63 2829 2061 6e64 2067 6574 2061  sync() and get a
-0001fcc0: 6c6c 0a20 2020 206f 6620 7468 6520 4d65  ll.    of the Me
-0001fcd0: 7373 6167 6545 7665 6e74 7320 6672 6f6d  ssageEvents from
-0001fce0: 2074 6865 2074 696d 656c 696e 6520 6f66   the timeline of
-0001fcf0: 2074 6865 2072 6570 6c79 2070 726f 7669   the reply provi
-0001fd00: 6465 6420 6279 0a20 2020 2073 796e 6328  ded by.    sync(
-0001fd10: 292e 2054 6869 7320 6973 206d 6f72 6520  ). This is more 
-0001fd20: 776f 726b 2074 6861 6e20 6c69 7374 656e  work than listen
-0001fd30: 5f6f 6e63 6528 2920 6275 7420 6974 2069  _once() but it i
-0001fd40: 7320 696e 7465 7265 7374 696e 670a 2020  s interesting.  
-0001fd50: 2020 6361 7365 2073 7475 6479 2074 6f20    case study to 
-0001fd60: 756e 6465 7273 7461 6e64 2073 796e 6328  understand sync(
-0001fd70: 292e 0a0a 2020 2020 7379 6e63 2829 2072  )...    sync() r
-0001fd80: 6573 706f 6e73 6520 696e 636c 7564 6573  esponse includes
-0001fd90: 2074 6865 206d 656d 6265 7220 6072 6f6f   the member `roo
-0001fda0: 6d73 6020 286f 6620 636c 6173 7320 6e69  ms` (of class ni
-0001fdb0: 6f2e 7265 7370 6f6e 7365 732e 526f 6f6d  o.responses.Room
-0001fdc0: 7329 2e0a 2020 2020 526f 6f6d 7320 6861  s)..    Rooms ha
-0001fdd0: 7665 2033 2074 6f70 2064 6963 7473 2e0a  ve 3 top dicts..
-0001fde0: 2020 2020 526f 6f6d 7328 696e 7669 7465      Rooms(invite
-0001fdf0: 3d7b 7d2c 206a 6f69 6e3d 7b2e 2e2e 7d2c  ={}, join={...},
-0001fe00: 206c 6561 7665 3d7b 7d29 0a20 2020 206a   leave={}).    j
-0001fe10: 6f69 6e20 6861 7320 6120 6469 6374 2065  oin has a dict e
-0001fe20: 6e74 7279 206f 6620 7479 7065 2052 6f6f  ntry of type Roo
-0001fe30: 6d49 6e66 6f20 666f 720a 2020 2020 6561  mInfo for.    ea
-0001fe40: 6368 2072 6f6f 6d2e 2041 6e64 2074 6865  ch room. And the
-0001fe50: 2052 6f6f 6d49 6e66 6f20 6861 7320 6120   RoomInfo has a 
-0001fe60: 7469 6d65 6c69 6e65 2028 6f66 2063 6c61  timeline (of cla
-0001fe70: 7373 2054 696d 654c 696e 6529 2077 6974  ss TimeLine) wit
-0001fe80: 680a 2020 2020 616c 6c20 6375 7272 656e  h.    all curren
-0001fe90: 746c 7920 7175 6575 6564 2075 7020 6576  tly queued up ev
-0001fea0: 656e 7473 2e20 536f 2c20 7469 6d65 6c69  ents. So, timeli
-0001feb0: 6e65 2068 6173 2061 206c 6973 7420 6f66  ne has a list of
-0001fec0: 2065 7665 6e74 730a 2020 2020 7375 6368   events.    such
-0001fed0: 2061 7320 526f 6f6d 4d65 7373 6167 6554   as RoomMessageT
-0001fee0: 6578 742c 2052 6f6f 6d4d 6573 7361 6765  ext, RoomMessage
-0001fef0: 4e6f 7469 6365 2c20 6574 632e 204f 6e65  Notice, etc. One
-0001ff00: 2063 616e 2067 6f20 7468 726f 7567 680a   can go through.
-0001ff10: 2020 2020 7468 6573 6520 7469 6d65 6c69      these timeli
-0001ff20: 6e65 2065 7665 6e74 206c 6973 7473 2061  ne event lists a
-0001ff30: 6e64 2070 726f 6365 7373 2065 6163 6820  nd process each 
-0001ff40: 7175 6575 6564 2075 7020 6d65 7373 6167  queued up messag
-0001ff50: 652e 0a0a 2020 2020 5468 6973 2069 7320  e...    This is 
-0001ff60: 616e 2065 7861 6d70 6c65 2052 6f6f 6d73  an example Rooms
-0001ff70: 206f 626a 6563 7420 7468 6174 2069 7320   object that is 
-0001ff80: 7061 7274 206f 6620 6120 7379 6e63 2829  part of a sync()
-0001ff90: 2072 6573 706f 6e73 652e 0a20 2020 2054   response..    T
-0001ffa0: 6869 7320 6578 616d 706c 6520 6769 7665  his example give
-0001ffb0: 7320 7468 6520 6465 7461 696c 7320 6f6e  s the details on
-0001ffc0: 2032 2063 7572 7265 6e74 6c79 2071 7565   2 currently que
-0001ffd0: 7565 6420 7570 206d 6573 7361 6765 732e  ued up messages.
-0001ffe0: 0a0a 2020 2020 526f 6f6d 7328 0a20 2020  ..    Rooms(.   
-0001fff0: 2069 6e76 6974 653d 7b7d 2c0a 2020 2020   invite={},.    
-00020000: 6a6f 696e 3d7b 2721 536f 6d65 526f 6f6d  join={'!SomeRoom
-00020010: 4964 3a65 7861 6d70 6c65 2e6f 7267 273a  Id:example.org':
-00020020: 0a20 2020 2020 2020 2052 6f6f 6d49 6e66  .        RoomInf
-00020030: 6f28 0a20 2020 2020 2020 2074 696d 656c  o(.        timel
-00020040: 696e 653d 5469 6d65 6c69 6e65 280a 2020  ine=Timeline(.  
-00020050: 2020 2020 2020 2020 2020 6576 656e 7473            events
-00020060: 3d5b 0a20 2020 2020 2020 2020 2020 2020  =[.             
-00020070: 2020 2052 6f6f 6d4d 6573 7361 6765 5465     RoomMessageTe
-00020080: 7874 2873 6f75 7263 653d 7b0a 2020 2020  xt(source={.    
-00020090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000200a0: 2772 6f6f 6d5f 6964 273a 2027 2153 6f6d  'room_id': '!Som
-000200b0: 6552 6f6f 6d49 643a 6578 616d 706c 652e  eRoomId:example.
-000200c0: 6f72 6727 2c0a 2020 2020 2020 2020 2020  org',.          
-000200d0: 2020 2020 2020 2020 2020 2774 7970 6527            'type'
-000200e0: 3a20 276d 2e72 6f6f 6d2e 6d65 7373 6167  : 'm.room.messag
-000200f0: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
-00020100: 2020 2020 2020 2020 2763 6f6e 7465 6e74          'content
-00020110: 273a 207b 276d 7367 7479 7065 273a 2027  ': {'msgtype': '
-00020120: 6d2e 7465 7874 272c 2027 626f 6479 273a  m.text', 'body':
-00020130: 2027 4869 2074 6865 7265 277d 2c0a 2020   'Hi there'},.  
-00020140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020150: 2020 2765 7665 6e74 5f69 6427 3a20 2753    'event_id': 'S
-00020160: 6f6d 6545 7665 6e74 4964 3127 2c0a 2020  omeEventId1',.  
-00020170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020180: 2020 2773 656e 6465 7227 3a20 2740 7573    'sender': '@us
-00020190: 6572 313a 6578 616d 706c 652e 6f72 6727  er1:example.org'
-000201a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000201b0: 2020 2020 2020 276f 7269 6769 6e5f 7365        'origin_se
-000201c0: 7276 6572 5f74 7327 3a20 3135 3931 3233  rver_ts': 159123
-000201d0: 3438 3936 3731 327d 2c0a 2020 2020 2020  4896712},.      
-000201e0: 2020 2020 2020 2020 2020 6576 656e 745f            event_
-000201f0: 6964 3d27 536f 6d65 4576 656e 7449 6431  id='SomeEventId1
-00020200: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00020210: 2020 2073 656e 6465 723d 2740 7573 6572     sender='@user
-00020220: 313a 6578 616d 706c 652e 6f72 6727 2c0a  1:example.org',.
-00020230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020240: 7365 7276 6572 5f74 696d 6573 7461 6d70  server_timestamp
-00020250: 3d31 3539 3132 3334 3839 3637 3132 2c0a  =1591234896712,.
-00020260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020270: 6465 6372 7970 7465 643d 5472 7565 2c20  decrypted=True, 
-00020280: 7665 7269 6669 6564 3d46 616c 7365 2c0a  verified=False,.
-00020290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000202a0: 7365 6e64 6572 5f6b 6579 3d27 536f 6d65  sender_key='Some
-000202b0: 5365 6e64 6572 4b65 7931 272c 0a20 2020  SenderKey1',.   
-000202c0: 2020 2020 2020 2020 2020 2020 2073 6573               ses
-000202d0: 7369 6f6e 5f69 643d 2753 6f6d 6553 6573  sion_id='SomeSes
-000202e0: 7369 6f6e 4964 3127 2c0a 2020 2020 2020  sionId1',.      
-000202f0: 2020 2020 2020 2020 2020 7472 616e 7361            transa
-00020300: 6374 696f 6e5f 6964 3d4e 6f6e 652c 0a20  ction_id=None,. 
-00020310: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-00020320: 6f64 793d 2748 6920 7468 6572 6527 2c0a  ody='Hi there',.
-00020330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020340: 666f 726d 6174 7465 645f 626f 6479 3d4e  formatted_body=N
-00020350: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-00020360: 2020 2020 2066 6f72 6d61 743d 4e6f 6e65       format=None
-00020370: 292c 0a0a 2020 2020 2020 2020 2020 2020  ),..            
-00020380: 2020 2020 526f 6f6d 4d65 7373 6167 654e      RoomMessageN
-00020390: 6f74 6963 6528 736f 7572 6365 3d7b 2763  otice(source={'c
-000203a0: 6f6e 7465 6e74 273a 207b 276d 7367 7479  ontent': {'msgty
-000203b0: 7065 273a 2027 6d2e 6e6f 7469 6365 272c  pe': 'm.notice',
-000203c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000203d0: 2020 2020 2027 626f 6479 273a 2027 4865       'body': 'He
-000203e0: 6c6c 6f27 2c0a 2020 2020 2020 2020 2020  llo',.          
-000203f0: 2020 2020 2020 2020 2020 2766 6f72 6d61            'forma
-00020400: 7427 3a20 276f 7267 2e6d 6174 7269 782e  t': 'org.matrix.
-00020410: 6375 7374 6f6d 2e68 746d 6c27 2c0a 2020  custom.html',.  
-00020420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020430: 2020 2766 6f72 6d61 7474 6564 5f62 6f64    'formatted_bod
-00020440: 7927 3a20 273c 703e 4865 6c6c 6f3c 2f70  y': '<p>Hello</p
-00020450: 3e27 0a20 2020 2020 2020 2020 2020 2020  >'.             
-00020460: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-00020470: 2020 2020 2020 2020 2020 2020 2020 2774                't
-00020480: 7970 6527 3a20 276d 2e72 6f6f 6d2e 6d65  ype': 'm.room.me
-00020490: 7373 6167 6527 2c0a 2020 2020 2020 2020  ssage',.        
-000204a0: 2020 2020 2020 2020 2020 2020 2772 6f6f              'roo
-000204b0: 6d5f 6964 273a 2027 2153 6f6d 6552 6f6f  m_id': '!SomeRoo
-000204c0: 6d49 643a 6578 616d 706c 652e 6f72 6727  mId:example.org'
-000204d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000204e0: 2020 2020 2020 2765 7665 6e74 5f69 6427        'event_id'
-000204f0: 3a20 2753 6f6d 6545 7665 6e74 4964 3227  : 'SomeEventId2'
-00020500: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00020510: 2020 2020 2020 2773 656e 6465 7227 3a20        'sender': 
-00020520: 2740 7573 6572 323a 6578 616d 706c 652e  '@user2:example.
-00020530: 6f72 6727 2c0a 2020 2020 2020 2020 2020  org',.          
-00020540: 2020 2020 2020 2020 2020 276f 7269 6769            'origi
-00020550: 6e5f 7365 7276 6572 5f74 7327 3a20 3135  n_server_ts': 15
-00020560: 3931 3233 3438 3937 3037 397d 2c0a 2020  91234897079},.  
-00020570: 2020 2020 2020 2020 2020 2020 2020 6576                ev
-00020580: 656e 745f 6964 3d27 536f 6d65 4576 656e  ent_id='SomeEven
-00020590: 7449 6432 272c 0a20 2020 2020 2020 2020  tId2',.         
-000205a0: 2020 2020 2020 2073 656e 6465 723d 2740         sender='@
-000205b0: 7573 6572 323a 6578 616d 706c 652e 6f72  user2:example.or
-000205c0: 6727 2c0a 2020 2020 2020 2020 2020 2020  g',.            
-000205d0: 2020 2020 7365 7276 6572 5f74 696d 6573      server_times
-000205e0: 7461 6d70 3d31 3539 3132 3334 3839 3730  tamp=15912348970
-000205f0: 3739 2c20 6465 6372 7970 7465 643d 5472  79, decrypted=Tr
-00020600: 7565 2c20 7665 7269 6669 6564 3d46 616c  ue, verified=Fal
-00020610: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
-00020620: 2020 2020 7365 6e64 6572 5f6b 6579 3d27      sender_key='
-00020630: 536f 6d65 5365 6e64 6572 4b65 7932 272c  SomeSenderKey2',
-00020640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020650: 2073 6573 7369 6f6e 5f69 643d 2753 6f6d   session_id='Som
-00020660: 6553 6573 7369 6f6e 4964 3227 2c0a 2020  eSessionId2',.  
-00020670: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-00020680: 616e 7361 6374 696f 6e5f 6964 3d4e 6f6e  ansaction_id=Non
-00020690: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-000206a0: 2020 2062 6f64 793d 273c 703e 4865 6c6c     body='<p>Hell
-000206b0: 6f3c 2f70 3e27 2c0a 2020 2020 2020 2020  o</p>',.        
-000206c0: 2020 2020 2020 2020 666f 726d 6174 3d27          format='
-000206d0: 6f72 672e 6d61 7472 6978 2e63 7573 746f  org.matrix.custo
-000206e0: 6d2e 6874 6d6c 2729 0a20 2020 2020 2020  m.html').       
-000206f0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00020700: 2020 2020 6c69 6d69 7465 643d 4661 6c73      limited=Fals
-00020710: 652c 0a20 2020 2020 2020 2020 2020 2070  e,.            p
-00020720: 7265 765f 6261 7463 683d 2773 3136 3635  rev_batch='s1665
-00020730: 305f 3236 3437 3436 5f37 3332 5f31 3233  0_264746_732_123
-00020740: 345f 3830 3530 5f32 5f38 3236 305f 3433  4_8050_2_8260_43
-00020750: 395f 3127 292c 0a20 2020 2020 2020 2073  9_1'),.        s
-00020760: 7461 7465 3d5b 5d2c 0a20 2020 2020 2020  tate=[],.       
-00020770: 2065 7068 656d 6572 616c 3d5b 5479 7069   ephemeral=[Typi
-00020780: 6e67 4e6f 7469 6365 4576 656e 7428 7573  ngNoticeEvent(us
-00020790: 6572 733d 5b5d 292c 2052 6563 6569 7074  ers=[]), Receipt
-000207a0: 4576 656e 7428 2e2e 2e29 5d2c 0a20 2020  Event(...)],.   
-000207b0: 2020 2020 2061 6363 6f75 6e74 5f64 6174       account_dat
-000207c0: 613d 5b5d 2c0a 2020 2020 2020 2020 7375  a=[],.        su
-000207d0: 6d6d 6172 793d 526f 6f6d 5375 6d6d 6172  mmary=RoomSummar
-000207e0: 7928 2e2e 2e29 2c0a 2020 2020 2020 2020  y(...),.        
-000207f0: 756e 7265 6164 5f6e 6f74 6966 6963 6174  unread_notificat
-00020800: 696f 6e73 3d55 6e72 6561 644e 6f74 6966  ions=UnreadNotif
-00020810: 6963 6174 696f 6e73 282e 2e2e 290a 2020  ications(...).  
-00020820: 2020 2020 2020 290a 2020 2020 7d2c 0a20        ).    },. 
-00020830: 2020 206c 6561 7665 3d7b 7d29 0a0a 2020     leave={})..  
-00020840: 2020 2222 220a 2020 2020 7265 7370 5f73    """.    resp_s
-00020850: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
-00020860: 7379 6e63 2874 696d 656f 7574 3d31 3030  sync(timeout=100
-00020870: 3030 2c20 6675 6c6c 5f73 7461 7465 3d46  00, full_state=F
-00020880: 616c 7365 290a 2020 2020 2320 7468 6973  alse).    # this
-00020890: 2070 7269 6e74 7320 6120 7375 6d6d 6172   prints a summar
-000208a0: 7920 6f66 2061 6c6c 206e 6577 206d 6573  y of all new mes
-000208b0: 7361 6765 7320 6375 7272 656e 746c 7920  sages currently 
-000208c0: 7761 6974 696e 6720 696e 2074 6865 2071  waiting in the q
-000208d0: 7565 7565 0a20 2020 2067 732e 6c6f 672e  ueue.    gs.log.
-000208e0: 6465 6275 6728 6622 7379 6e63 2072 6573  debug(f"sync res
-000208f0: 706f 6e73 6520 3d20 7b74 7970 6528 7265  ponse = {type(re
-00020900: 7370 5f73 297d 203a 3a20 7b72 6573 705f  sp_s)} :: {resp_
-00020910: 737d 2229 0a20 2020 2067 732e 6c6f 672e  s}").    gs.log.
-00020920: 6465 6275 6728 6622 7379 6e63 206e 6578  debug(f"sync nex
-00020930: 745f 6261 7463 6820 3d20 2873 7472 2920  t_batch = (str) 
-00020940: 7b72 6573 705f 732e 6e65 7874 5f62 6174  {resp_s.next_bat
-00020950: 6368 7d22 290a 2020 2020 6773 2e6c 6f67  ch}").    gs.log
-00020960: 2e64 6562 7567 2866 2273 796e 6320 726f  .debug(f"sync ro
-00020970: 6f6d 7320 3d20 286e 696f 2e72 6573 706f  oms = (nio.respo
-00020980: 6e73 6573 2e52 6f6f 6d73 2920 7b72 6573  nses.Rooms) {res
-00020990: 705f 732e 726f 6f6d 737d 2229 0a20 2020  p_s.rooms}").   
-000209a0: 2023 2053 6574 2075 7020 6576 656e 7420   # Set up event 
-000209b0: 6361 6c6c 6261 636b 730a 2020 2020 6361  callbacks.    ca
-000209c0: 6c6c 6261 636b 7320 3d20 4361 6c6c 6261  llbacks = Callba
-000209d0: 636b 7328 636c 6965 6e74 290a 2020 2020  cks(client).    
-000209e0: 2320 4e6f 7465 3a20 7765 2061 7265 204e  # Note: we are N
-000209f0: 4f54 2072 6567 6973 7465 7269 6e67 2061  OT registering a
-00020a00: 2063 616c 6c62 6163 6b20 6675 6e74 696f   callback funtio
-00020a10: 6e21 0a20 2020 2023 204c 6f6f 7020 7468  n!.    # Loop th
-00020a20: 726f 7567 6820 7468 6520 6a6f 696e 2064  rough the join d
-00020a30: 6963 7469 6f6e 6172 790a 2020 2020 666f  ictionary.    fo
-00020a40: 7220 726f 6f6d 5f69 642c 2072 6f6f 6d5f  r room_id, room_
-00020a50: 696e 666f 2069 6e20 7265 7370 5f73 2e72  info in resp_s.r
-00020a60: 6f6f 6d73 2e6a 6f69 6e2e 6974 656d 7328  ooms.join.items(
-00020a70: 293a 0a20 2020 2020 2020 2065 7665 6e74  ):.        event
-00020a80: 5f6c 6973 7420 3d20 726f 6f6d 5f69 6e66  _list = room_inf
-00020a90: 6f2e 7469 6d65 6c69 6e65 2e65 7665 6e74  o.timeline.event
-00020aa0: 730a 2020 2020 2020 2020 666f 7220 6576  s.        for ev
-00020ab0: 656e 7420 696e 2065 7665 6e74 5f6c 6973  ent in event_lis
-00020ac0: 743a 0a20 2020 2020 2020 2020 2020 2067  t:.            g
-00020ad0: 732e 6c6f 672e 6465 6275 6728 6622 7365  s.log.debug(f"se
-00020ae0: 6e64 696e 6720 6576 656e 7420 746f 2063  nding event to c
-00020af0: 616c 6c62 6163 6b20 3d20 7b65 7665 6e74  allback = {event
-00020b00: 7d2e 2229 0a20 2020 2020 2020 2020 2020  }.").           
-00020b10: 2023 2062 6563 6175 7365 206f 6620 6675   # because of fu
-00020b20: 6c6c 5f73 7461 7465 3d46 616c 7365 2069  ll_state=False i
-00020b30: 6e20 7379 6e63 2829 2074 6865 0a20 2020  n sync() the.   
-00020b40: 2020 2020 2020 2020 2023 2072 6f6f 6d73           # rooms
-00020b50: 206f 626a 6563 7420 6973 206e 6f74 2066   object is not f
-00020b60: 756c 6c79 2070 6f70 756c 6174 6564 2061  ully populated a
-00020b70: 6e64 206d 6973 7369 6e67 2074 6865 0a20  nd missing the. 
-00020b80: 2020 2020 2020 2020 2020 2023 2072 6f6f             # roo
-00020b90: 6d20 6e61 6d65 732e 0a20 2020 2020 2020  m names..       
-00020ba0: 2020 2020 2072 6f6f 6d20 3d20 636c 6965       room = clie
-00020bb0: 6e74 2e72 6f6f 6d73 5b72 6f6f 6d5f 6964  nt.rooms[room_id
-00020bc0: 5d0a 2020 2020 2020 2020 2020 2020 6177  ].            aw
-00020bd0: 6169 7420 6361 6c6c 6261 636b 732e 6d65  ait callbacks.me
-00020be0: 7373 6167 655f 6361 6c6c 6261 636b 2872  ssage_callback(r
-00020bf0: 6f6f 6d2c 2065 7665 6e74 290a 2020 2020  oom, event).    
-00020c00: 2020 2020 6966 2065 7665 6e74 5f6c 6973      if event_lis
-00020c10: 743a 2020 2320 6c69 7374 206e 6f74 2065  t:  # list not e
-00020c20: 6d70 7479 0a20 2020 2020 2020 2020 2020  mpty.           
-00020c30: 206c 6173 745f 6576 656e 7420 3d20 6576   last_event = ev
-00020c40: 656e 745f 6c69 7374 5b2d 315d 0a20 2020  ent_list[-1].   
-00020c50: 2020 2020 2020 2020 2072 6573 7020 3d20           resp = 
-00020c60: 6177 6169 7420 636c 6965 6e74 2e72 6f6f  await client.roo
-00020c70: 6d5f 7265 6164 5f6d 6172 6b65 7273 280a  m_read_markers(.
-00020c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020c90: 726f 6f6d 5f69 643d 726f 6f6d 5f69 642c  room_id=room_id,
-00020ca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020cb0: 2066 756c 6c79 5f72 6561 645f 6576 656e   fully_read_even
-00020cc0: 743d 6c61 7374 5f65 7665 6e74 2e65 7665  t=last_event.eve
-00020cd0: 6e74 5f69 642c 0a20 2020 2020 2020 2020  nt_id,.         
-00020ce0: 2020 2020 2020 2072 6561 645f 6576 656e         read_even
-00020cf0: 743d 6c61 7374 5f65 7665 6e74 2e65 7665  t=last_event.eve
-00020d00: 6e74 5f69 642c 0a20 2020 2020 2020 2020  nt_id,.         
-00020d10: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00020d20: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
-00020d30: 6573 702c 2052 6f6f 6d52 6561 644d 6172  esp, RoomReadMar
-00020d40: 6b65 7273 4572 726f 7229 3a0a 2020 2020  kersError):.    
-00020d50: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
-00020d60: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
-00020d70: 2020 2020 2020 2020 2020 2020 2020 2272                "r
-00020d80: 6f6f 6d5f 7265 6164 5f6d 6172 6b65 7273  oom_read_markers
-00020d90: 2066 6169 6c65 6420 7769 7468 2072 6573   failed with res
-00020da0: 706f 6e73 6520 220a 2020 2020 2020 2020  ponse ".        
-00020db0: 2020 2020 2020 2020 2020 2020 6622 7b70              f"{p
-00020dc0: 7269 7661 6379 5f66 696c 7465 7228 7374  rivacy_filter(st
-00020dd0: 7228 7265 7370 2929 7d2e 220a 2020 2020  r(resp))}.".    
-00020de0: 2020 2020 2020 2020 2020 2020 290a 0a0a              )...
-00020df0: 2320 6163 636f 7264 696e 6720 746f 2070  # according to p
-00020e00: 796c 616d 613a 2066 756e 6374 696f 6e20  ylama: function 
-00020e10: 746f 6f20 636f 6d70 6c65 783a 2043 3930  too complex: C90
-00020e20: 3120 2320 6e6f 7161 3a20 4339 3031 0a61  1 # noqa: C901.a
-00020e30: 7379 6e63 2064 6566 206c 6973 7465 6e5f  sync def listen_
-00020e40: 7461 696c 2820 2023 206e 6f71 613a 2043  tail(  # noqa: C
-00020e50: 3930 310a 2020 2020 636c 6965 6e74 3a20  901.    client: 
-00020e60: 4173 796e 6343 6c69 656e 742c 2063 7265  AsyncClient, cre
-00020e70: 6465 6e74 6961 6c73 3a20 6469 6374 0a29  dentials: dict.)
-00020e80: 202d 3e20 4e6f 6e65 3a20 2023 206e 6f71   -> None:  # noq
-00020e90: 613a 2043 3930 310a 2020 2020 2222 2247  a: C901.    """G
-00020ea0: 6574 2074 6865 206c 6173 7420 4e20 6d65  et the last N me
-00020eb0: 7373 6167 6573 2c20 7468 656e 2071 7569  ssages, then qui
-00020ec0: 742e 0a0a 2020 2020 4172 6775 6d65 6e74  t...    Argument
-00020ed0: 733a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  s:.    ---------
-00020ee0: 0a20 2020 2020 2020 2063 6c69 656e 743a  .        client:
-00020ef0: 2041 7379 6e63 436c 6965 6e74 203a 2074   AsyncClient : t
-00020f00: 6865 2063 7265 6174 6564 204e 494f 2063  he created NIO c
-00020f10: 6c69 656e 740a 2020 2020 2020 2020 6372  lient.        cr
-00020f20: 6564 656e 7469 616c 733a 2064 6963 7420  edentials: dict 
-00020f30: 3a20 6372 6564 656e 7469 616c 7320 6469  : credentials di
-00020f40: 6374 696f 6e61 7279 2066 726f 6d20 7468  ctionary from th
-00020f50: 6520 6372 6564 656e 7469 616c 7320 6669  e credentials fi
-00020f60: 6c65 0a0a 2020 2020 4765 7420 7468 6520  le..    Get the 
-00020f70: 6c61 7374 204e 206d 6573 7361 6765 732e  last N messages.
-00020f80: 2053 6f6d 6520 6d69 6768 7420 6265 206f   Some might be o
-00020f90: 6c64 2c20 692e 652e 2061 6c72 6561 6479  ld, i.e. already
-00020fa0: 0a20 2020 2072 6561 6420 6265 666f 7265  .    read before
-00020fb0: 2c20 736f 6d65 206d 6967 6874 2062 6520  , some might be 
-00020fc0: 6e65 772c 2069 2e65 2e20 6e65 7665 7220  new, i.e. never 
-00020fd0: 7265 6164 2062 6566 6f72 652e 0a20 2020  read before..   
-00020fe0: 2050 7269 6e74 2074 6865 6d2e 2054 6865   Print them. The
-00020ff0: 6e20 6c65 6176 652e 0a0a 2020 2020 4966  n leave...    If
-00021000: 2074 6865 7265 2061 7265 206c 6573 7320   there are less 
-00021010: 7468 616e 204e 206d 6573 7361 6765 732c  than N messages,
-00021020: 2067 6574 2075 7020 746f 204e 2e0a 0a20   get up to N... 
-00021030: 2020 2054 6865 2066 756e 6374 696f 6e20     The function 
-00021040: 726f 6f6d 5f6d 6573 7361 6765 7328 2920  room_messages() 
-00021050: 6973 2075 7365 6420 746f 2067 6574 0a20  is used to get. 
-00021060: 2020 2074 6865 206c 6173 7420 4e20 6d65     the last N me
-00021070: 7373 6167 6573 2e0a 0a20 2020 2022 2222  ssages...    """
-00021080: 0a20 2020 2023 2077 6520 6361 6c6c 2073  .    # we call s
-00021090: 796e 6328 2920 746f 2067 6574 2074 6865  ync() to get the
-000210a0: 206e 6578 745f 6261 7463 6820 6d61 726b   next_batch mark
-000210b0: 6572 0a20 2020 2023 2077 6520 7365 7420  er.    # we set 
-000210c0: 6675 6c6c 5f73 7461 7465 3d54 7275 6520  full_state=True 
-000210d0: 746f 2067 6574 2061 6c6c 2072 6f6f 6d5f  to get all room_
-000210e0: 6964 730a 2020 2020 7265 7370 5f73 203d  ids.    resp_s =
-000210f0: 2061 7761 6974 2073 796e 6368 726f 6e69   await synchroni
-00021100: 7a65 2863 6c69 656e 7429 2020 2320 7379  ze(client)  # sy
-00021110: 6e63 2829 2074 6f20 6765 7420 726f 6f6d  nc() to get room
-00021120: 730a 2020 2020 2320 7468 6973 2070 7269  s.    # this pri
-00021130: 6e74 7320 6120 7375 6d6d 6172 7920 6f66  nts a summary of
-00021140: 2061 6c6c 206e 6577 206d 6573 7361 6765   all new message
-00021150: 7320 6375 7272 656e 746c 7920 7761 6974  s currently wait
-00021160: 696e 6720 696e 2074 6865 2071 7565 7565  ing in the queue
-00021170: 0a20 2020 2067 732e 6c6f 672e 6465 6275  .    gs.log.debu
-00021180: 6728 6622 7379 6e63 2072 6573 706f 6e73  g(f"sync respons
-00021190: 6520 3d20 7b74 7970 6528 7265 7370 5f73  e = {type(resp_s
-000211a0: 297d 203a 3a20 7b72 6573 705f 737d 2229  )} :: {resp_s}")
-000211b0: 0a20 2020 2067 732e 6c6f 672e 6465 6275  .    gs.log.debu
-000211c0: 6728 6622 636c 6965 6e74 2e6e 6578 745f  g(f"client.next_
-000211d0: 6261 7463 6820 6166 7465 7220 3d20 2873  batch after = (s
-000211e0: 7472 2920 7b63 6c69 656e 742e 6e65 7874  tr) {client.next
-000211f0: 5f62 6174 6368 7d22 290a 2020 2020 6773  _batch}").    gs
-00021200: 2e6c 6f67 2e64 6562 7567 2866 2273 796e  .log.debug(f"syn
-00021210: 6320 6e65 7874 5f62 6174 6368 203d 2028  c next_batch = (
-00021220: 7374 7229 207b 7265 7370 5f73 2e6e 6578  str) {resp_s.nex
-00021230: 745f 6261 7463 687d 2229 0a20 2020 2067  t_batch}").    g
-00021240: 732e 6c6f 672e 6465 6275 6728 6622 7379  s.log.debug(f"sy
-00021250: 6e63 2072 6f6f 6d73 203d 2028 6e69 6f2e  nc rooms = (nio.
-00021260: 7265 7370 6f6e 7365 732e 526f 6f6d 7329  responses.Rooms)
-00021270: 207b 7265 7370 5f73 2e72 6f6f 6d73 7d22   {resp_s.rooms}"
-00021280: 290a 2020 2020 6773 2e6c 6f67 2e64 6562  ).    gs.log.deb
-00021290: 7567 2866 2263 6c69 656e 742e 726f 6f6d  ug(f"client.room
-000212a0: 7320 3d20 7b63 6c69 656e 742e 726f 6f6d  s = {client.room
-000212b0: 737d 2229 0a20 2020 2069 6620 6e6f 7420  s}").    if not 
-000212c0: 7265 7370 5f73 2e72 6f6f 6d73 2e6a 6f69  resp_s.rooms.joi
-000212d0: 6e3a 2020 2320 6e6f 2052 6f6f 6d73 210a  n:  # no Rooms!.
-000212e0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-000212f0: 6562 7567 2866 2273 796e 6320 7265 7475  ebug(f"sync retu
-00021300: 726e 6564 206e 6f20 726f 6f6d 7320 3d20  rned no rooms = 
-00021310: 7b72 6573 705f 732e 726f 6f6d 732e 6a6f  {resp_s.rooms.jo
-00021320: 696e 7d22 290a 2020 2020 2020 2020 7265  in}").        re
-00021330: 7475 726e 0a0a 2020 2020 2320 5365 7420  turn..    # Set 
-00021340: 7570 2065 7665 6e74 2063 616c 6c62 6163  up event callbac
-00021350: 6b73 0a20 2020 2063 616c 6c62 6163 6b73  ks.    callbacks
-00021360: 203d 2043 616c 6c62 6163 6b73 2863 6c69   = Callbacks(cli
-00021370: 656e 7429 0a20 2020 2023 204e 6f74 653a  ent).    # Note:
-00021380: 2077 6520 6172 6520 4e4f 5420 7265 6769   we are NOT regi
-00021390: 7374 6572 696e 6720 6120 6361 6c6c 6261  stering a callba
-000213a0: 636b 2066 756e 7469 6f6e 210a 0a20 2020  ck funtion!..   
-000213b0: 2023 2072 6f6f 6d5f 6964 203d 206c 6973   # room_id = lis
-000213c0: 7428 7265 7370 5f73 2e72 6f6f 6d73 2e6a  t(resp_s.rooms.j
-000213d0: 6f69 6e2e 6b65 7973 2829 295b 305d 2020  oin.keys())[0]  
-000213e0: 2320 6669 7273 7420 726f 6f6d 5f69 6420  # first room_id 
-000213f0: 6672 6f6d 2064 6963 740a 2020 2020 2320  from dict.    # 
-00021400: 616c 7465 726e 6174 6976 6520 7761 7920  alternative way 
-00021410: 6f66 2067 6574 7469 6e67 2072 6f6f 6d5f  of getting room_
-00021420: 6964 2c20 636c 6965 6e74 2e72 6f6f 6d73  id, client.rooms
-00021430: 2069 7320 616c 736f 2061 2064 6963 740a   is also a dict.
-00021440: 2020 2020 2320 726f 6f6d 5f69 6420 3d20      # room_id = 
-00021450: 6c69 7374 2863 6c69 656e 742e 726f 6f6d  list(client.room
-00021460: 732e 6b65 7973 2829 295b 305d 2020 2320  s.keys())[0]  # 
-00021470: 6669 7273 7420 726f 6f6d 5f69 6420 6672  first room_id fr
-00021480: 6f6d 2064 6963 740a 0a20 2020 2023 2067  om dict..    # g
-00021490: 6574 2072 6f6f 6d73 2061 7320 7370 6563  et rooms as spec
-000214a0: 6966 6965 6420 6279 2074 6865 2075 7365  ified by the use
-000214b0: 7220 7468 7275 2061 7267 7320 6f72 2063  r thru args or c
-000214c0: 7265 6465 6e74 6961 6c20 6669 6c65 0a20  redential file. 
-000214d0: 2020 2072 6f6f 6d73 203d 2061 7761 6974     rooms = await
-000214e0: 2064 6574 6572 6d69 6e65 5f72 6f6f 6d73   determine_rooms
-000214f0: 2863 7265 6465 6e74 6961 6c73 5b22 726f  (credentials["ro
-00021500: 6f6d 5f69 6422 5d2c 2063 6c69 656e 742c  om_id"], client,
-00021510: 2063 7265 6465 6e74 6961 6c73 290a 2020   credentials).  
-00021520: 2020 6c69 6d69 7420 3d20 6773 2e70 612e    limit = gs.pa.
-00021530: 7461 696c 0a20 2020 2067 732e 6c6f 672e  tail.    gs.log.
-00021540: 6465 6275 6728 6622 526f 6f6d 7320 6172  debug(f"Rooms ar
-00021550: 653a 207b 726f 6f6d 737d 2c20 6c69 6d69  e: {rooms}, limi
-00021560: 7420 6973 207b 6c69 6d69 747d 2229 0a20  t is {limit}"). 
-00021570: 2020 2023 2054 6f20 6c6f 6f70 206f 7665     # To loop ove
-00021580: 7220 616c 6c20 726f 6f6d 732c 206f 6e65  r all rooms, one
-00021590: 2063 616e 206c 6f6f 7020 7468 726f 7567   can loop throug
-000215a0: 6820 7468 6520 6a6f 696e 2064 6963 7469  h the join dicti
-000215b0: 6f6e 6172 792e 2069 2e65 2e0a 2020 2020  onary. i.e..    
-000215c0: 2320 666f 7220 726f 6f6d 5f69 642c 2072  # for room_id, r
-000215d0: 6f6f 6d5f 696e 666f 2069 6e20 7265 7370  oom_info in resp
-000215e0: 5f73 2e72 6f6f 6d73 2e6a 6f69 6e2e 6974  _s.rooms.join.it
-000215f0: 656d 7328 293a 2020 2320 6c6f 6f70 2061  ems():  # loop a
-00021600: 6c6c 2072 6f6f 6d73 0a20 2020 2066 6f72  ll rooms.    for
-00021610: 2072 6f6f 6d5f 6964 2069 6e20 726f 6f6d   room_id in room
-00021620: 733a 2020 2320 6c6f 6f70 206f 6e6c 7920  s:  # loop only 
-00021630: 6f76 6572 2075 7365 7220 7370 6563 6966  over user specif
-00021640: 6965 6420 726f 6f6d 730a 2020 2020 2020  ied rooms.      
-00021650: 2020 7265 7370 203d 2061 7761 6974 2063    resp = await c
-00021660: 6c69 656e 742e 726f 6f6d 5f6d 6573 7361  lient.room_messa
-00021670: 6765 7328 0a20 2020 2020 2020 2020 2020  ges(.           
-00021680: 2072 6f6f 6d5f 6964 2c20 7374 6172 743d   room_id, start=
-00021690: 7265 7370 5f73 2e6e 6578 745f 6261 7463  resp_s.next_batc
-000216a0: 682c 206c 696d 6974 3d6c 696d 6974 0a20  h, limit=limit. 
-000216b0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000216c0: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
-000216d0: 6573 702c 2052 6f6f 6d4d 6573 7361 6765  esp, RoomMessage
-000216e0: 7345 7272 6f72 293a 0a20 2020 2020 2020  sError):.       
-000216f0: 2020 2020 2067 732e 6c6f 672e 7761 726e       gs.log.warn
-00021700: 696e 6728 0a20 2020 2020 2020 2020 2020  ing(.           
-00021710: 2020 2020 2022 5731 3036 3a20 220a 2020       "W106: ".  
-00021720: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00021730: 726f 6f6d 5f6d 6573 7361 6765 7320 6661  room_messages fa
-00021740: 696c 6564 2077 6974 6820 7265 7370 6f6e  iled with respon
-00021750: 7365 2022 0a20 2020 2020 2020 2020 2020  se ".           
-00021760: 2020 2020 2066 227b 7072 6976 6163 795f       f"{privacy_
-00021770: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
-00021780: 297d 2e20 220a 2020 2020 2020 2020 2020  )}. ".          
-00021790: 2020 2020 2020 2250 726f 6365 7373 696e        "Processin
-000217a0: 6720 636f 6e74 696e 7565 732e 220a 2020  g continues.".  
-000217b0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000217c0: 2020 2020 2020 2020 6773 2e77 6172 6e5f          gs.warn_
-000217d0: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
-000217e0: 2020 2020 2020 2063 6f6e 7469 6e75 6520         continue 
-000217f0: 2023 2073 6b69 7020 7468 6973 2072 6f6f   # skip this roo
-00021800: 6d0a 2020 2020 2020 2020 6773 2e6c 6f67  m.        gs.log
-00021810: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-00021820: 2020 2020 6622 726f 6f6d 5f6d 6573 7361      f"room_messa
-00021830: 6765 7320 7265 7370 6f6e 7365 203d 207b  ges response = {
-00021840: 7479 7065 2872 6573 7029 7d20 3a3a 2022  type(resp)} :: "
-00021850: 0a20 2020 2020 2020 2020 2020 2066 227b  .            f"{
-00021860: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
-00021870: 7472 2872 6573 7029 297d 2e22 0a20 2020  tr(resp))}.".   
-00021880: 2020 2020 2029 0a20 2020 2020 2020 2067       ).        g
-00021890: 732e 6c6f 672e 6465 6275 6728 6622 726f  s.log.debug(f"ro
-000218a0: 6f6d 5f6d 6573 7361 6765 7320 726f 6f6d  om_messages room
-000218b0: 5f69 6420 3d20 7b72 6573 702e 726f 6f6d  _id = {resp.room
-000218c0: 5f69 647d 2e22 290a 2020 2020 2020 2020  _id}.").        
-000218d0: 6773 2e6c 6f67 2e64 6562 7567 2866 2272  gs.log.debug(f"r
-000218e0: 6f6f 6d5f 6d65 7373 6167 6573 2073 7461  oom_messages sta
-000218f0: 7274 203d 2028 7374 7229 207b 7265 7370  rt = (str) {resp
-00021900: 2e73 7461 7274 7d2e 2229 0a20 2020 2020  .start}.").     
-00021910: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-00021920: 6622 726f 6f6d 5f6d 6573 7361 6765 7320  f"room_messages 
-00021930: 656e 6420 3d20 2873 7472 2920 3a3a 207b  end = (str) :: {
-00021940: 7265 7370 2e65 6e64 7d2e 2229 0a20 2020  resp.end}.").   
-00021950: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-00021960: 6728 6622 726f 6f6d 5f6d 6573 7361 6765  g(f"room_message
-00021970: 7320 6368 756e 6b20 3d20 286c 6973 7429  s chunk = (list)
-00021980: 203a 3a20 7b72 6573 702e 6368 756e 6b7d   :: {resp.chunk}
-00021990: 2e22 290a 2020 2020 2020 2020 2320 6368  .").        # ch
-000219a0: 756e 6b20 6973 206a 7573 7420 6120 6c69  unk is just a li
-000219b0: 7374 206f 6620 526f 6f6d 4d65 7373 6167  st of RoomMessag
-000219c0: 6520 6576 656e 7473 206c 696b 6520 7468  e events like th
-000219d0: 6973 2065 7861 6d70 6c65 3a0a 2020 2020  is example:.    
-000219e0: 2020 2020 2320 6368 756e 6b3d 5b52 6f6f      # chunk=[Roo
-000219f0: 6d4d 6573 7361 6765 5465 7874 282e 2e2e  mMessageText(...
-00021a00: 295d 0a0a 2020 2020 2020 2020 666f 7220  )]..        for 
-00021a10: 6576 656e 7420 696e 2072 6573 702e 6368  event in resp.ch
-00021a20: 756e 6b3a 0a20 2020 2020 2020 2020 2020  unk:.           
-00021a30: 2067 732e 6c6f 672e 6465 6275 6728 6622   gs.log.debug(f"
-00021a40: 7365 6e64 696e 6720 6576 656e 7420 746f  sending event to
-00021a50: 2063 616c 6c62 6163 6b20 3d20 7b65 7665   callback = {eve
-00021a60: 6e74 7d2e 2229 0a20 2020 2020 2020 2020  nt}.").         
-00021a70: 2020 2069 6620 636c 6965 6e74 2e72 6f6f     if client.roo
-00021a80: 6d73 2061 6e64 2063 6c69 656e 742e 726f  ms and client.ro
-00021a90: 6f6d 735b 726f 6f6d 5f69 645d 3a0a 2020  oms[room_id]:.  
-00021aa0: 2020 2020 2020 2020 2020 2020 2020 726f                ro
-00021ab0: 6f6d 203d 2063 6c69 656e 742e 726f 6f6d  om = client.room
-00021ac0: 735b 726f 6f6d 5f69 645d 0a20 2020 2020  s[room_id].     
-00021ad0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00021ae0: 2020 2020 2020 2020 2020 2020 2072 6f6f               roo
-00021af0: 6d20 3d20 4d61 7472 6978 526f 6f6d 2872  m = MatrixRoom(r
-00021b00: 6f6f 6d5f 6964 2c20 4e6f 6e65 2c20 5472  oom_id, None, Tr
-00021b10: 7565 2920 2023 2064 756d 6d79 5f72 6f6f  ue)  # dummy_roo
-00021b20: 6d0a 2020 2020 2020 2020 2020 2020 6177  m.            aw
-00021b30: 6169 7420 6361 6c6c 6261 636b 732e 6d65  ait callbacks.me
-00021b40: 7373 6167 655f 6361 6c6c 6261 636b 2872  ssage_callback(r
-00021b50: 6f6f 6d2c 2065 7665 6e74 290a 2020 2020  oom, event).    
-00021b60: 2020 2020 6966 2072 6573 702e 6368 756e      if resp.chun
-00021b70: 6b3a 2020 2320 6c69 7374 206e 6f74 2065  k:  # list not e
-00021b80: 6d70 7479 0a20 2020 2020 2020 2020 2020  mpty.           
-00021b90: 2023 206f 7264 6572 2069 7320 7265 7665   # order is reve
-00021ba0: 7273 6564 2c20 6669 7273 7420 656c 656d  rsed, first elem
-00021bb0: 656e 7420 6973 2074 696d 6577 6973 6520  ent is timewise 
-00021bc0: 7468 6520 6e65 7765 7374 0a20 2020 2020  the newest.     
-00021bd0: 2020 2020 2020 2066 6972 7374 5f65 7665         first_eve
-00021be0: 6e74 203d 2072 6573 702e 6368 756e 6b5b  nt = resp.chunk[
-00021bf0: 305d 0a20 2020 2020 2020 2020 2020 2072  0].            r
-00021c00: 6573 7020 3d20 6177 6169 7420 636c 6965  esp = await clie
-00021c10: 6e74 2e72 6f6f 6d5f 7265 6164 5f6d 6172  nt.room_read_mar
-00021c20: 6b65 7273 280a 2020 2020 2020 2020 2020  kers(.          
-00021c30: 2020 2020 2020 726f 6f6d 5f69 643d 726f        room_id=ro
-00021c40: 6f6d 5f69 642c 0a20 2020 2020 2020 2020  om_id,.         
-00021c50: 2020 2020 2020 2066 756c 6c79 5f72 6561         fully_rea
-00021c60: 645f 6576 656e 743d 6669 7273 745f 6576  d_event=first_ev
-00021c70: 656e 742e 6576 656e 745f 6964 2c0a 2020  ent.event_id,.  
-00021c80: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00021c90: 6164 5f65 7665 6e74 3d66 6972 7374 5f65  ad_event=first_e
-00021ca0: 7665 6e74 2e65 7665 6e74 5f69 642c 0a20  vent.event_id,. 
-00021cb0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00021cc0: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
-00021cd0: 7374 616e 6365 2872 6573 702c 2052 6f6f  stance(resp, Roo
-00021ce0: 6d52 6561 644d 6172 6b65 7273 4572 726f  mReadMarkersErro
-00021cf0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00021d00: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-00021d10: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00021d20: 2020 2020 2020 2272 6f6f 6d5f 7265 6164        "room_read
-00021d30: 5f6d 6172 6b65 7273 2066 6169 6c65 6420  _markers failed 
-00021d40: 7769 7468 2072 6573 706f 6e73 6520 220a  with response ".
-00021d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021d60: 2020 2020 6622 7b70 7269 7661 6379 5f66      f"{privacy_f
-00021d70: 696c 7465 7228 7374 7228 7265 7370 2929  ilter(str(resp))
-00021d80: 7d2e 220a 2020 2020 2020 2020 2020 2020  }.".            
-00021d90: 2020 2020 290a 0a0a 6173 796e 6320 6465      )...async de
-00021da0: 6620 7265 6164 5f61 6c6c 5f65 7665 6e74  f read_all_event
-00021db0: 735f 696e 5f64 6972 6563 7469 6f6e 280a  s_in_direction(.
-00021dc0: 2020 2020 636c 6965 6e74 3a20 4173 796e      client: Asyn
-00021dd0: 6343 6c69 656e 742c 0a20 2020 2072 6f6f  cClient,.    roo
-00021de0: 6d5f 6964 3a20 7374 722c 0a20 2020 2073  m_id: str,.    s
-00021df0: 7461 7274 5f74 6f6b 656e 3a20 7374 722c  tart_token: str,
-00021e00: 0a20 2020 2064 6972 6563 7469 6f6e 3a20  .    direction: 
-00021e10: 4d65 7373 6167 6544 6972 6563 7469 6f6e  MessageDirection
-00021e20: 203d 204d 6573 7361 6765 4469 7265 6374   = MessageDirect
-00021e30: 696f 6e2e 6261 636b 2c0a 2920 2d3e 206c  ion.back,.) -> l
-00021e40: 6973 743a 0a20 2020 2022 2222 5265 6164  ist:.    """Read
-00021e50: 2061 6c6c 2065 7665 6e74 7320 6672 6f6d   all events from
-00021e60: 2061 2067 6976 656e 2072 6f6f 6d20 696e   a given room in
-00021e70: 2063 6572 7461 696e 2064 6972 6563 7469   certain directi
-00021e80: 6f6e 2e0a 0a20 2020 2041 7267 756d 656e  on...    Argumen
-00021e90: 7473 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  ts:.    --------
-00021ea0: 2d0a 2020 2020 2020 2020 636c 6965 6e74  -.        client
-00021eb0: 3a20 4173 796e 6343 6c69 656e 7420 3a20  : AsyncClient : 
-00021ec0: 5468 6520 6372 6561 7465 6420 4e49 4f20  The created NIO 
-00021ed0: 636c 6965 6e74 0a20 2020 2020 2020 2072  client.        r
-00021ee0: 6f6f 6d5f 6964 3a20 7374 7220 3a20 5468  oom_id: str : Th
-00021ef0: 6520 726f 6f6d 2069 6420 6f66 2074 6865  e room id of the
-00021f00: 2072 6f6f 6d20 666f 7220 7768 6963 6820   room for which 
-00021f10: 7765 0a20 2020 2020 2020 2020 2020 2077  we.            w
-00021f20: 6f75 6c64 206c 696b 6520 746f 2066 6574  ould like to fet
-00021f30: 6368 2074 6865 206d 6573 7361 6765 732e  ch the messages.
-00021f40: 0a20 2020 2020 2020 2073 7461 7274 5f74  .        start_t
-00021f50: 6f6b 656e 3a20 7374 7220 3a20 2054 6865  oken: str :  The
-00021f60: 2074 6f6b 656e 2074 6f20 7374 6172 7420   token to start 
-00021f70: 7265 7475 726e 696e 6720 6576 656e 7473  returning events
-00021f80: 2066 726f 6d2e 0a20 2020 2020 2020 2020   from..         
-00021f90: 2020 2054 6869 7320 746f 6b65 6e20 6361     This token ca
-00021fa0: 6e20 6265 206f 6274 6169 6e65 6420 6672  n be obtained fr
-00021fb0: 6f6d 2061 2070 7265 765f 6261 7463 6820  om a prev_batch 
-00021fc0: 746f 6b65 6e20 7265 7475 726e 6564 2066  token returned f
-00021fd0: 6f72 0a20 2020 2020 2020 2020 2020 2065  or.            e
-00021fe0: 6163 6820 726f 6f6d 2062 7920 7468 6520  ach room by the 
-00021ff0: 7379 6e63 2829 2041 5049 2c20 6f72 2066  sync() API, or f
-00022000: 726f 6d20 6120 7374 6172 7420 6f72 2065  rom a start or e
-00022010: 6e64 2074 6f6b 656e 2072 6574 7572 6e65  nd token returne
-00022020: 640a 2020 2020 2020 2020 2020 2020 6279  d.            by
-00022030: 2061 2070 7265 7669 6f75 7320 7265 7175   a previous requ
-00022040: 6573 7420 746f 2072 6f6f 6d5f 6d65 7373  est to room_mess
-00022050: 6167 6573 2829 2e0a 2020 2020 2020 2020  ages()..        
-00022060: 6469 7265 6374 696f 6e3a 204d 6573 7361  direction: Messa
-00022070: 6765 4469 7265 6374 696f 6e20 286f 7074  geDirection (opt
-00022080: 696f 6e61 6c29 3a20 5468 6520 6469 7265  ional): The dire
-00022090: 6374 696f 6e20 746f 2072 6574 7572 6e0a  ction to return.
-000220a0: 2020 2020 2020 2020 2020 2020 6576 656e              even
-000220b0: 7473 2066 726f 6d2e 2044 6566 6175 6c74  ts from. Default
-000220c0: 7320 746f 204d 6573 7361 6765 4469 7265  s to MessageDire
-000220d0: 6374 696f 6e2e 6261 636b 2e0a 0a20 2020  ction.back...   
-000220e0: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
-000220f0: 2d2d 2d2d 0a20 2020 2020 2020 206c 6973  ----.        lis
-00022100: 743a 206c 6973 7420 6f66 2052 6f6f 6d4d  t: list of RoomM
-00022110: 6573 7361 6765 2065 7665 6e74 732c 2063  essage events, c
-00022120: 6f75 6c64 2062 6520 656d 7074 790a 0a20  ould be empty.. 
-00022130: 2020 2052 6561 6420 616c 6c20 6d65 7373     Read all mess
-00022140: 6167 6573 206f 6620 6120 726f 6f6d 2062  ages of a room b
-00022150: 6567 696e 6e69 6e67 2066 726f 6d20 7468  eginning from th
-00022160: 6520 7061 7374 5f74 6f6b 656e 0a20 2020  e past_token.   
-00022170: 2074 6f20 6f6c 6465 7374 206f 7220 6e65   to oldest or ne
-00022180: 7765 7374 206d 6573 7361 6765 2028 6465  west message (de
-00022190: 7065 6e64 696e 6720 6f6e 2074 6865 2064  pending on the d
-000221a0: 6972 6563 7469 6f6e 292e 0a0a 2020 2020  irection)...    
-000221b0: 2222 220a 2020 2020 616c 6c5f 6576 656e  """.    all_even
-000221c0: 7473 203d 205b 5d0a 2020 2020 6375 7272  ts = [].    curr
-000221d0: 656e 745f 7374 6172 745f 746f 6b65 6e20  ent_start_token 
-000221e0: 3d20 7374 6172 745f 746f 6b65 6e0a 2020  = start_token.  
-000221f0: 2020 2320 6973 2063 6170 7065 6420 6174    # is capped at
-00022200: 2031 3030 3020 6174 2073 6572 7665 7220   1000 at server 
-00022210: 7369 6465 0a20 2020 2023 2031 3020 7365  side.    # 10 se
-00022220: 656d 7320 746f 6f20 736d 616c 6c2c 2069  ems too small, i
-00022230: 2e65 2e20 746f 6f20 736c 6f77 0a20 2020  .e. too slow.   
-00022240: 2023 2031 3030 2074 6f20 3530 3020 7365   # 100 to 500 se
-00022250: 656d 2067 6f6f 6420 7661 6c75 6573 2c20  em good values, 
-00022260: 6465 7065 6e64 7320 6f6e 206e 6574 776f  depends on netwo
-00022270: 726b 2073 7065 6564 2c20 7365 7276 6572  rk speed, server
-00022280: 206c 6f61 642c 202e 2e2e 0a20 2020 2023   load, ....    #
-00022290: 2065 7861 6d70 6c65 2072 756e 3a20 3235   example run: 25
-000222a0: 302d 2d3e 376d 696e 3330 732c 2035 3030  0-->7min30s, 500
-000222b0: 2d2d 3e34 6d69 6e33 3073 0a20 2020 206d  -->4min30s.    m
-000222c0: 6178 5f6d 7367 5f70 6572 5f70 756c 6c20  ax_msg_per_pull 
-000222d0: 3d20 3530 300a 2020 2020 7768 696c 6520  = 500.    while 
-000222e0: 5472 7565 3a0a 2020 2020 2020 2020 7472  True:.        tr
-000222f0: 793a 0a20 2020 2020 2020 2020 2020 2072  y:.            r
-00022300: 6573 7020 3d20 6177 6169 7420 636c 6965  esp = await clie
-00022310: 6e74 2e72 6f6f 6d5f 6d65 7373 6167 6573  nt.room_messages
-00022320: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00022330: 2020 726f 6f6d 5f69 642c 0a20 2020 2020    room_id,.     
-00022340: 2020 2020 2020 2020 2020 2063 7572 7265             curre
-00022350: 6e74 5f73 7461 7274 5f74 6f6b 656e 2c0a  nt_start_token,.
-00022360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022370: 6c69 6d69 743d 6d61 785f 6d73 675f 7065  limit=max_msg_pe
-00022380: 725f 7075 6c6c 2c0a 2020 2020 2020 2020  r_pull,.        
-00022390: 2020 2020 2020 2020 6469 7265 6374 696f          directio
-000223a0: 6e3d 6469 7265 6374 696f 6e2c 0a20 2020  n=direction,.   
-000223b0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000223c0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-000223d0: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
-000223e0: 2020 2020 2020 2320 6475 7269 6e67 2074        # during t
-000223f0: 6573 7469 6e67 2049 206f 6273 6572 7665  esting I observe
-00022400: 6420 7468 6174 2073 6f6d 6574 696d 6573  d that sometimes
-00022410: 2061 6e20 6578 6365 7074 696f 6e20 6973   an exception is
-00022420: 2072 6169 7365 642c 0a20 2020 2020 2020   raised,.       
-00022430: 2020 2020 2023 2062 7574 2065 2069 7320       # but e is 
-00022440: 656d 7074 792e 2053 7461 636b 7472 6163  empty. Stacktrac
-00022450: 6520 6861 6420 6173 796e 6369 6f2e 6578  e had asyncio.ex
-00022460: 6365 7074 696f 6e73 2e54 696d 656f 7574  ceptions.Timeout
-00022470: 4572 726f 722e 0a20 2020 2020 2020 2020  Error..         
-00022480: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
-00022490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000224a0: 2022 4531 3631 3a20 220a 2020 2020 2020   "E161: ".      
-000224b0: 2020 2020 2020 2020 2020 2245 7272 6f72            "Error
-000224c0: 2064 7572 696e 6720 6765 7474 696e 6720   during getting 
-000224d0: 6d65 7373 6167 6573 2e20 220a 2020 2020  messages. ".    
-000224e0: 2020 2020 2020 2020 2020 2020 2242 7574              "But
-000224f0: 2070 726f 6772 616d 2077 696c 6c20 636f   program will co
-00022500: 6e74 696e 7565 2061 6e79 7761 792c 2064  ntinue anyway, d
-00022510: 6573 7069 7465 2074 6865 2065 7272 6f72  espite the error
-00022520: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
-00022530: 2020 2020 224e 6f74 2061 6c6c 206d 6573      "Not all mes
-00022540: 7361 6765 7320 6d69 6768 7420 6861 7665  sages might have
-00022550: 2062 6565 6e20 7265 7472 6965 7665 6420   been retrieved 
-00022560: 6672 6f6d 2073 6572 7665 722e 2022 0a20  from server. ". 
-00022570: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00022580: 2242 6520 7761 726e 6564 2120 476f 7420  "Be warned! Got 
-00022590: 7b6c 656e 2861 6c6c 5f65 7665 6e74 7329  {len(all_events)
-000225a0: 7d20 6d65 7373 6167 6573 2073 6f20 6661  } messages so fa
-000225b0: 722e 220a 2020 2020 2020 2020 2020 2020  r.".            
-000225c0: 2020 2020 6622 4578 6365 7074 696f 6e3a      f"Exception:
-000225d0: 207b 7479 7065 2865 297d 207b 657d 220a   {type(e)} {e}".
-000225e0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-000225f0: 2020 2020 2020 2020 2020 6773 2e65 7272            gs.err
-00022600: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
-00022610: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-00022620: 6562 7567 2822 4865 7265 2069 7320 7468  ebug("Here is th
-00022630: 6520 7472 6163 6562 6163 6b2e 5c6e 2220  e traceback.\n" 
-00022640: 2b20 7472 6163 6562 6163 6b2e 666f 726d  + traceback.form
-00022650: 6174 5f65 7863 2829 290a 2020 2020 2020  at_exc()).      
-00022660: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
-00022670: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00022680: 6528 7265 7370 2c20 526f 6f6d 4d65 7373  e(resp, RoomMess
-00022690: 6167 6573 4572 726f 7229 3a0a 2020 2020  agesError):.    
-000226a0: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
-000226b0: 6f75 6e74 202b 3d20 310a 2020 2020 2020  ount += 1.      
-000226c0: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
-000226d0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-000226e0: 2020 2020 2245 3136 323a 2022 0a20 2020      "E162: ".   
-000226f0: 2020 2020 2020 2020 2020 2020 2066 2272               f"r
-00022700: 6f6f 6d5f 6d65 7373 6167 6573 2066 6169  oom_messages fai
-00022710: 6c65 6420 7769 7468 2072 6573 7020 3d20  led with resp = 
-00022720: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
-00022730: 7374 7228 7265 7370 2929 7d22 0a20 2020  str(resp))}".   
-00022740: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00022750: 2020 2020 2020 2062 7265 616b 2020 2320         break  # 
-00022760: 736b 6970 2074 6f20 656e 6420 6f66 2066  skip to end of f
-00022770: 756e 6374 696f 6e0a 2020 2020 2020 2020  unction.        
-00022780: 6773 2e6c 6f67 2e64 6562 7567 2866 2247  gs.log.debug(f"G
-00022790: 6f74 207b 6c65 6e28 616c 6c5f 6576 656e  ot {len(all_even
-000227a0: 7473 292b 6c65 6e28 7265 7370 2e63 6875  ts)+len(resp.chu
-000227b0: 6e6b 297d 206d 6573 7361 6765 7320 736f  nk)} messages so
-000227c0: 2066 6172 2e22 290a 2020 2020 2020 2020   far.").        
-000227d0: 6773 2e6c 6f67 2e64 6562 7567 2866 2252  gs.log.debug(f"R
-000227e0: 6563 6569 7665 6420 7b6c 656e 2872 6573  eceived {len(res
-000227f0: 702e 6368 756e 6b29 7d20 6576 656e 7473  p.chunk)} events
-00022800: 2e22 290a 2020 2020 2020 2020 6773 2e6c  .").        gs.l
-00022810: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
-00022820: 2020 2020 2020 6622 726f 6f6d 5f6d 6573        f"room_mes
-00022830: 7361 6765 7320 7265 7370 6f6e 7365 203d  sages response =
-00022840: 207b 7479 7065 2872 6573 7029 7d20 3a3a   {type(resp)} ::
-00022850: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
-00022860: 227b 7072 6976 6163 795f 6669 6c74 6572  "{privacy_filter
-00022870: 2873 7472 2872 6573 7029 297d 2e22 0a20  (str(resp))}.". 
-00022880: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00022890: 2067 732e 6c6f 672e 6465 6275 6728 6622   gs.log.debug(f"
-000228a0: 726f 6f6d 5f6d 6573 7361 6765 7320 726f  room_messages ro
-000228b0: 6f6d 5f69 6420 3d20 7b72 6573 702e 726f  om_id = {resp.ro
-000228c0: 6f6d 5f69 647d 2e22 290a 2020 2020 2020  om_id}.").      
-000228d0: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
-000228e0: 2272 6f6f 6d5f 6d65 7373 6167 6573 2073  "room_messages s
-000228f0: 7461 7274 203d 2028 7374 7229 207b 7265  tart = (str) {re
-00022900: 7370 2e73 7461 7274 7d2e 2229 0a20 2020  sp.start}.").   
-00022910: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-00022920: 6728 6622 726f 6f6d 5f6d 6573 7361 6765  g(f"room_message
-00022930: 7320 656e 6420 3d20 2873 7472 2920 3a3a  s end = (str) ::
-00022940: 207b 7265 7370 2e65 6e64 7d2e 2229 0a20   {resp.end}."). 
-00022950: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-00022960: 6275 6728 6622 726f 6f6d 5f6d 6573 7361  bug(f"room_messa
-00022970: 6765 7320 6368 756e 6b20 3d20 286c 6973  ges chunk = (lis
-00022980: 7429 203a 3a20 7b72 6573 702e 6368 756e  t) :: {resp.chun
-00022990: 6b7d 2e22 290a 2020 2020 2020 2020 2320  k}.").        # 
-000229a0: 7265 7370 2e63 6875 6e6b 2069 7320 6a75  resp.chunk is ju
-000229b0: 7374 2061 206c 6973 7420 6f66 2052 6f6f  st a list of Roo
-000229c0: 6d4d 6573 7361 6765 2065 7665 6e74 7320  mMessage events 
-000229d0: 6c69 6b65 2074 6869 7320 6578 616d 706c  like this exampl
-000229e0: 653a 0a20 2020 2020 2020 2023 2063 6875  e:.        # chu
-000229f0: 6e6b 3d5b 526f 6f6d 4d65 7373 6167 6554  nk=[RoomMessageT
-00022a00: 6578 7428 2e2e 2e29 5d0a 2020 2020 2020  ext(...)].      
-00022a10: 2020 6375 7272 656e 745f 7374 6172 745f    current_start_
-00022a20: 746f 6b65 6e20 3d20 7265 7370 2e65 6e64  token = resp.end
-00022a30: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-00022a40: 7265 7370 2e63 6875 6e6b 2920 3d3d 2030  resp.chunk) == 0
-00022a50: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
-00022a60: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
-00022a70: 2020 2020 2020 2020 2020 2020 2241 6c6c              "All
-00022a80: 206d 6573 7361 6765 7320 6861 7665 2062   messages have b
-00022a90: 6565 6e20 7265 7472 6965 7665 6420 6672  een retrieved fr
-00022aa0: 6f6d 2073 6572 7665 7220 7375 6363 6573  om server succes
-00022ab0: 7366 756c 6c79 2e20 220a 2020 2020 2020  sfully. ".      
-00022ac0: 2020 2020 2020 2020 2020 6622 7b6c 656e            f"{len
-00022ad0: 2861 6c6c 5f65 7665 6e74 7329 7d20 6d65  (all_events)} me
-00022ae0: 7373 6167 6573 2077 6572 6520 7075 6c6c  ssages were pull
-00022af0: 6564 2066 726f 6d20 7365 7276 6572 2e22  ed from server."
-00022b00: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00022b10: 2020 2020 2020 2020 2020 2062 7265 616b             break
-00022b20: 0a20 2020 2020 2020 2061 6c6c 5f65 7665  .        all_eve
-00022b30: 6e74 7320 3d20 616c 6c5f 6576 656e 7473  nts = all_events
-00022b40: 202b 2072 6573 702e 6368 756e 6b0a 2020   + resp.chunk.  
-00022b50: 2020 7265 7475 726e 2061 6c6c 5f65 7665    return all_eve
-00022b60: 6e74 730a 0a0a 2320 6163 636f 7264 696e  nts...# accordin
-00022b70: 6720 746f 2070 796c 616d 613a 2066 756e  g to pylama: fun
-00022b80: 6374 696f 6e20 746f 6f20 636f 6d70 6c65  ction too comple
-00022b90: 783a 2043 3930 3120 2320 6e6f 7161 3a20  x: C901 # noqa: 
-00022ba0: 4339 3031 0a61 7379 6e63 2064 6566 206c  C901.async def l
-00022bb0: 6973 7465 6e5f 616c 6c28 2020 2320 6e6f  isten_all(  # no
-00022bc0: 7161 3a20 4339 3031 0a20 2020 2063 6c69  qa: C901.    cli
-00022bd0: 656e 743a 2041 7379 6e63 436c 6965 6e74  ent: AsyncClient
-00022be0: 2c20 6372 6564 656e 7469 616c 733a 2064  , credentials: d
-00022bf0: 6963 740a 2920 2d3e 204e 6f6e 653a 2020  ict.) -> None:  
-00022c00: 2320 6e6f 7161 3a20 4339 3031 0a20 2020  # noqa: C901.   
-00022c10: 2022 2222 4765 7420 616c 6c20 6d65 7373   """Get all mess
-00022c20: 6167 6573 2c20 7468 656e 2071 7569 742e  ages, then quit.
-00022c30: 0a0a 2020 2020 4172 6775 6d65 6e74 733a  ..    Arguments:
-00022c40: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 0a20  .    ---------. 
-00022c50: 2020 2020 2020 2063 6c69 656e 743a 2041         client: A
-00022c60: 7379 6e63 436c 6965 6e74 203a 2074 6865  syncClient : the
-00022c70: 2063 7265 6174 6564 204e 494f 2063 6c69   created NIO cli
-00022c80: 656e 740a 2020 2020 2020 2020 6372 6564  ent.        cred
-00022c90: 656e 7469 616c 733a 2064 6963 7420 3a20  entials: dict : 
-00022ca0: 6372 6564 656e 7469 616c 7320 6469 6374  credentials dict
-00022cb0: 696f 6e61 7279 2066 726f 6d20 7468 6520  ionary from the 
-00022cc0: 6372 6564 656e 7469 616c 7320 6669 6c65  credentials file
-00022cd0: 0a0a 2020 2020 4765 7420 616c 6c20 6d65  ..    Get all me
-00022ce0: 7373 6167 6573 2e20 536f 6d65 206d 6967  ssages. Some mig
-00022cf0: 6874 2062 6520 6f6c 642c 2069 2e65 2e20  ht be old, i.e. 
-00022d00: 616c 7265 6164 790a 2020 2020 7265 6164  already.    read
-00022d10: 2062 6566 6f72 652c 2073 6f6d 6520 6d69   before, some mi
-00022d20: 6768 7420 6265 206e 6577 2c20 692e 652e  ght be new, i.e.
-00022d30: 206e 6576 6572 2072 6561 6420 6265 666f   never read befo
-00022d40: 7265 2e0a 2020 2020 5072 696e 7420 7468  re..    Print th
-00022d50: 656d 2e20 5468 656e 206c 6561 7665 2e0a  em. Then leave..
-00022d60: 0a20 2020 2054 6865 2066 756e 6374 696f  .    The functio
-00022d70: 6e20 726f 6f6d 5f6d 6573 7361 6765 7328  n room_messages(
-00022d80: 2920 6973 2075 7365 6420 746f 2067 6574  ) is used to get
-00022d90: 2061 6c6c 206d 6573 7361 6765 732e 0a0a   all messages...
-00022da0: 2020 2020 2222 220a 2020 2020 2320 7765      """.    # we
-00022db0: 2063 616c 6c20 7379 6e63 2829 2074 6f20   call sync() to 
-00022dc0: 6765 7420 7468 6520 6e65 7874 5f62 6174  get the next_bat
-00022dd0: 6368 206d 6172 6b65 720a 2020 2020 2320  ch marker.    # 
-00022de0: 7765 2073 6574 2066 756c 6c5f 7374 6174  we set full_stat
-00022df0: 653d 5472 7565 2074 6f20 6765 7420 616c  e=True to get al
-00022e00: 6c20 726f 6f6d 5f69 6473 0a20 2020 2072  l room_ids.    r
-00022e10: 6573 705f 7320 3d20 6177 6169 7420 7379  esp_s = await sy
-00022e20: 6e63 6872 6f6e 697a 6528 636c 6965 6e74  nchronize(client
-00022e30: 2920 2023 2073 796e 6328 2920 746f 2067  )  # sync() to g
-00022e40: 6574 2072 6f6f 6d73 0a20 2020 2023 2074  et rooms.    # t
-00022e50: 6869 7320 7072 696e 7473 2061 2073 756d  his prints a sum
-00022e60: 6d61 7279 206f 6620 616c 6c20 6e65 7720  mary of all new 
-00022e70: 6d65 7373 6167 6573 2063 7572 7265 6e74  messages current
-00022e80: 6c79 2077 6169 7469 6e67 2069 6e20 7468  ly waiting in th
-00022e90: 6520 7175 6575 650a 2020 2020 6773 2e6c  e queue.    gs.l
-00022ea0: 6f67 2e64 6562 7567 2866 2273 796e 6320  og.debug(f"sync 
-00022eb0: 7265 7370 6f6e 7365 203d 207b 7479 7065  response = {type
-00022ec0: 2872 6573 705f 7329 7d20 3a3a 207b 7265  (resp_s)} :: {re
-00022ed0: 7370 5f73 7d22 290a 2020 2020 6773 2e6c  sp_s}").    gs.l
-00022ee0: 6f67 2e64 6562 7567 2866 2263 6c69 656e  og.debug(f"clien
-00022ef0: 742e 6e65 7874 5f62 6174 6368 2061 6674  t.next_batch aft
-00022f00: 6572 203d 2028 7374 7229 207b 636c 6965  er = (str) {clie
-00022f10: 6e74 2e6e 6578 745f 6261 7463 687d 2229  nt.next_batch}")
-00022f20: 0a20 2020 2067 732e 6c6f 672e 6465 6275  .    gs.log.debu
-00022f30: 6728 6622 7379 6e63 206e 6578 745f 6261  g(f"sync next_ba
-00022f40: 7463 6820 3d20 2873 7472 2920 7b72 6573  tch = (str) {res
-00022f50: 705f 732e 6e65 7874 5f62 6174 6368 7d22  p_s.next_batch}"
-00022f60: 290a 2020 2020 6773 2e6c 6f67 2e64 6562  ).    gs.log.deb
-00022f70: 7567 2866 2273 796e 6320 726f 6f6d 7320  ug(f"sync rooms 
-00022f80: 3d20 286e 696f 2e72 6573 706f 6e73 6573  = (nio.responses
-00022f90: 2e52 6f6f 6d73 2920 7b72 6573 705f 732e  .Rooms) {resp_s.
-00022fa0: 726f 6f6d 737d 2229 0a20 2020 2067 732e  rooms}").    gs.
-00022fb0: 6c6f 672e 6465 6275 6728 6622 636c 6965  log.debug(f"clie
-00022fc0: 6e74 2e72 6f6f 6d73 203d 207b 636c 6965  nt.rooms = {clie
-00022fd0: 6e74 2e72 6f6f 6d73 7d22 290a 2020 2020  nt.rooms}").    
-00022fe0: 6966 206e 6f74 2072 6573 705f 732e 726f  if not resp_s.ro
-00022ff0: 6f6d 732e 6a6f 696e 3a20 2023 206e 6f20  oms.join:  # no 
-00023000: 526f 6f6d 7321 0a20 2020 2020 2020 2067  Rooms!.        g
-00023010: 732e 6c6f 672e 6465 6275 6728 6622 7379  s.log.debug(f"sy
-00023020: 6e63 2072 6574 7572 6e65 6420 6e6f 2072  nc returned no r
-00023030: 6f6f 6d73 203d 207b 7265 7370 5f73 2e72  ooms = {resp_s.r
-00023040: 6f6f 6d73 2e6a 6f69 6e7d 2229 0a20 2020  ooms.join}").   
-00023050: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-00023060: 2023 2053 6574 2075 7020 6576 656e 7420   # Set up event 
-00023070: 6361 6c6c 6261 636b 730a 2020 2020 6361  callbacks.    ca
-00023080: 6c6c 6261 636b 7320 3d20 4361 6c6c 6261  llbacks = Callba
-00023090: 636b 7328 636c 6965 6e74 290a 2020 2020  cks(client).    
-000230a0: 2320 4e6f 7465 3a20 7765 2061 7265 204e  # Note: we are N
-000230b0: 4f54 2072 6567 6973 7465 7269 6e67 2061  OT registering a
-000230c0: 2063 616c 6c62 6163 6b20 6675 6e74 696f   callback funtio
-000230d0: 6e21 0a0a 2020 2020 2320 726f 6f6d 5f69  n!..    # room_i
-000230e0: 6420 3d20 6c69 7374 2872 6573 705f 732e  d = list(resp_s.
-000230f0: 726f 6f6d 732e 6a6f 696e 2e6b 6579 7328  rooms.join.keys(
-00023100: 2929 5b30 5d20 2023 2066 6972 7374 2072  ))[0]  # first r
-00023110: 6f6f 6d5f 6964 2066 726f 6d20 6469 6374  oom_id from dict
-00023120: 0a20 2020 2023 2061 6c74 6572 6e61 7469  .    # alternati
-00023130: 7665 2077 6179 206f 6620 6765 7474 696e  ve way of gettin
-00023140: 6720 726f 6f6d 5f69 642c 2063 6c69 656e  g room_id, clien
-00023150: 742e 726f 6f6d 7320 6973 2061 6c73 6f20  t.rooms is also 
-00023160: 6120 6469 6374 0a20 2020 2023 2072 6f6f  a dict.    # roo
-00023170: 6d5f 6964 203d 206c 6973 7428 636c 6965  m_id = list(clie
-00023180: 6e74 2e72 6f6f 6d73 2e6b 6579 7328 2929  nt.rooms.keys())
-00023190: 5b30 5d20 2023 2066 6972 7374 2072 6f6f  [0]  # first roo
-000231a0: 6d5f 6964 2066 726f 6d20 6469 6374 0a0a  m_id from dict..
-000231b0: 2020 2020 2320 6765 7420 726f 6f6d 7320      # get rooms 
-000231c0: 6173 2073 7065 6369 6669 6564 2062 7920  as specified by 
-000231d0: 7468 6520 7573 6572 2074 6872 7520 6172  the user thru ar
-000231e0: 6773 206f 7220 6372 6564 656e 7469 616c  gs or credential
-000231f0: 2066 696c 650a 2020 2020 726f 6f6d 7320   file.    rooms 
-00023200: 3d20 6177 6169 7420 6465 7465 726d 696e  = await determin
-00023210: 655f 726f 6f6d 7328 6372 6564 656e 7469  e_rooms(credenti
-00023220: 616c 735b 2272 6f6f 6d5f 6964 225d 2c20  als["room_id"], 
-00023230: 636c 6965 6e74 2c20 6372 6564 656e 7469  client, credenti
-00023240: 616c 7329 0a20 2020 2067 732e 6c6f 672e  als).    gs.log.
-00023250: 6465 6275 6728 6622 526f 6f6d 7320 6172  debug(f"Rooms ar
-00023260: 653a 207b 726f 6f6d 737d 2229 0a0a 2020  e: {rooms}")..  
-00023270: 2020 2320 546f 206c 6f6f 7020 6f76 6572    # To loop over
-00023280: 2061 6c6c 2072 6f6f 6d73 2c20 6f6e 6520   all rooms, one 
-00023290: 6361 6e20 6c6f 6f70 2074 6872 6f75 6768  can loop through
-000232a0: 2074 6865 206a 6f69 6e20 6469 6374 696f   the join dictio
-000232b0: 6e61 7279 2e20 692e 652e 0a20 2020 2023  nary. i.e..    #
-000232c0: 2066 6f72 2072 6f6f 6d5f 6964 2c20 726f   for room_id, ro
-000232d0: 6f6d 5f69 6e66 6f20 696e 2072 6573 705f  om_info in resp_
-000232e0: 732e 726f 6f6d 732e 6a6f 696e 2e69 7465  s.rooms.join.ite
-000232f0: 6d73 2829 3a20 2023 206c 6f6f 7020 616c  ms():  # loop al
-00023300: 6c20 726f 6f6d 730a 2020 2020 666f 7220  l rooms.    for 
-00023310: 726f 6f6d 5f69 6420 696e 2072 6f6f 6d73  room_id in rooms
-00023320: 3a20 2023 206c 6f6f 7020 6f6e 6c79 206f  :  # loop only o
-00023330: 7665 7220 7573 6572 2073 7065 6369 6669  ver user specifi
-00023340: 6564 2072 6f6f 6d73 0a20 2020 2020 2020  ed rooms.       
-00023350: 2070 7265 765f 6261 7463 6820 3d20 7265   prev_batch = re
-00023360: 7370 5f73 2e72 6f6f 6d73 2e6a 6f69 6e5b  sp_s.rooms.join[
-00023370: 726f 6f6d 5f69 645d 2e74 696d 656c 696e  room_id].timelin
-00023380: 652e 7072 6576 5f62 6174 6368 0a20 2020  e.prev_batch.   
-00023390: 2020 2020 2062 6163 6b5f 6576 656e 7473       back_events
-000233a0: 203d 2061 7761 6974 2072 6561 645f 616c   = await read_al
-000233b0: 6c5f 6576 656e 7473 5f69 6e5f 6469 7265  l_events_in_dire
-000233c0: 6374 696f 6e28 0a20 2020 2020 2020 2020  ction(.         
-000233d0: 2020 2063 6c69 656e 742c 2072 6f6f 6d5f     client, room_
-000233e0: 6964 2c20 7072 6576 5f62 6174 6368 2c20  id, prev_batch, 
-000233f0: 4d65 7373 6167 6544 6972 6563 7469 6f6e  MessageDirection
-00023400: 2e62 6163 6b0a 2020 2020 2020 2020 290a  .back.        ).
-00023410: 2020 2020 2020 2020 6672 6f6e 745f 6576          front_ev
-00023420: 656e 7473 203d 2061 7761 6974 2072 6561  ents = await rea
-00023430: 645f 616c 6c5f 6576 656e 7473 5f69 6e5f  d_all_events_in_
-00023440: 6469 7265 6374 696f 6e28 0a20 2020 2020  direction(.     
-00023450: 2020 2020 2020 2063 6c69 656e 742c 2072         client, r
-00023460: 6f6f 6d5f 6964 2c20 7072 6576 5f62 6174  oom_id, prev_bat
-00023470: 6368 2c20 4d65 7373 6167 6544 6972 6563  ch, MessageDirec
-00023480: 7469 6f6e 2e66 726f 6e74 0a20 2020 2020  tion.front.     
-00023490: 2020 2029 0a0a 2020 2020 2020 2020 2320     )..        # 
-000234a0: 5765 2068 6176 6520 746f 2072 6576 6572  We have to rever
-000234b0: 7365 2074 6865 2066 6972 7374 206c 6973  se the first lis
-000234c0: 7420 7369 6e63 6520 7765 2061 7265 2067  t since we are g
-000234d0: 6f69 6e67 2062 6163 6b77 6172 6473 2028  oing backwards (
-000234e0: 6275 740a 2020 2020 2020 2020 2320 7765  but.        # we
-000234f0: 2077 616e 7420 746f 2068 6176 6520 6120   want to have a 
-00023500: 6368 726f 6e6f 6c6f 6769 6361 6c20 6f72  chronological or
-00023510: 6465 7229 0a20 2020 2020 2020 2061 6c6c  der).        all
-00023520: 5f65 7665 6e74 7320 3d20 6261 636b 5f65  _events = back_e
-00023530: 7665 6e74 735b 3a3a 2d31 5d20 2b20 6672  vents[::-1] + fr
-00023540: 6f6e 745f 6576 656e 7473 0a0a 2020 2020  ont_events..    
-00023550: 2020 2020 666f 7220 6576 656e 7420 696e      for event in
-00023560: 2061 6c6c 5f65 7665 6e74 733a 0a20 2020   all_events:.   
-00023570: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
-00023580: 6465 6275 6728 6622 7365 6e64 696e 6720  debug(f"sending 
-00023590: 6576 656e 7420 746f 2063 616c 6c62 6163  event to callbac
-000235a0: 6b20 3d20 7b65 7665 6e74 7d2e 2229 0a20  k = {event}."). 
-000235b0: 2020 2020 2020 2020 2020 2069 6620 636c             if cl
-000235c0: 6965 6e74 2e72 6f6f 6d73 2061 6e64 2063  ient.rooms and c
-000235d0: 6c69 656e 742e 726f 6f6d 735b 726f 6f6d  lient.rooms[room
-000235e0: 5f69 645d 3a0a 2020 2020 2020 2020 2020  _id]:.          
-000235f0: 2020 2020 2020 726f 6f6d 203d 2063 6c69        room = cli
-00023600: 656e 742e 726f 6f6d 735b 726f 6f6d 5f69  ent.rooms[room_i
-00023610: 645d 0a20 2020 2020 2020 2020 2020 2065  d].            e
-00023620: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00023630: 2020 2020 2072 6f6f 6d20 3d20 4d61 7472       room = Matr
-00023640: 6978 526f 6f6d 2872 6f6f 6d5f 6964 2c20  ixRoom(room_id, 
-00023650: 4e6f 6e65 2c20 5472 7565 2920 2023 2064  None, True)  # d
-00023660: 756d 6d79 5f72 6f6f 6d0a 2020 2020 2020  ummy_room.      
-00023670: 2020 2020 2020 6177 6169 7420 6361 6c6c        await call
-00023680: 6261 636b 732e 6d65 7373 6167 655f 6361  backs.message_ca
-00023690: 6c6c 6261 636b 2872 6f6f 6d2c 2065 7665  llback(room, eve
-000236a0: 6e74 290a 2020 2020 2020 2020 6966 2061  nt).        if a
-000236b0: 6c6c 5f65 7665 6e74 733a 2020 2320 6c69  ll_events:  # li
-000236c0: 7374 206e 6f74 2065 6d70 7479 0a20 2020  st not empty.   
-000236d0: 2020 2020 2020 2020 206c 6173 745f 6576           last_ev
-000236e0: 656e 7420 3d20 616c 6c5f 6576 656e 7473  ent = all_events
-000236f0: 5b2d 315d 0a20 2020 2020 2020 2020 2020  [-1].           
-00023700: 2072 6573 7020 3d20 6177 6169 7420 636c   resp = await cl
-00023710: 6965 6e74 2e72 6f6f 6d5f 7265 6164 5f6d  ient.room_read_m
-00023720: 6172 6b65 7273 280a 2020 2020 2020 2020  arkers(.        
-00023730: 2020 2020 2020 2020 726f 6f6d 5f69 643d          room_id=
-00023740: 726f 6f6d 5f69 642c 0a20 2020 2020 2020  room_id,.       
-00023750: 2020 2020 2020 2020 2066 756c 6c79 5f72           fully_r
-00023760: 6561 645f 6576 656e 743d 6c61 7374 5f65  ead_event=last_e
-00023770: 7665 6e74 2e65 7665 6e74 5f69 642c 0a20  vent.event_id,. 
-00023780: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00023790: 6561 645f 6576 656e 743d 6c61 7374 5f65  ead_event=last_e
-000237a0: 7665 6e74 2e65 7665 6e74 5f69 642c 0a20  vent.event_id,. 
-000237b0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000237c0: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
-000237d0: 7374 616e 6365 2872 6573 702c 2052 6f6f  stance(resp, Roo
-000237e0: 6d52 6561 644d 6172 6b65 7273 4572 726f  mReadMarkersErro
-000237f0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00023800: 2020 2020 6773 2e6c 6f67 2e65 7272 6f72      gs.log.error
-00023810: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00023820: 2020 2020 2020 2245 3136 333a 2022 0a20        "E163: ". 
-00023830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023840: 2020 2022 726f 6f6d 5f72 6561 645f 6d61     "room_read_ma
-00023850: 726b 6572 7320 6661 696c 6564 2077 6974  rkers failed wit
-00023860: 6820 7265 7370 6f6e 7365 2022 0a20 2020  h response ".   
-00023870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023880: 2066 227b 7072 6976 6163 795f 6669 6c74   f"{privacy_filt
-00023890: 6572 2873 7472 2872 6573 7029 297d 2e22  er(str(resp))}."
-000238a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000238b0: 2029 0a0a 0a61 7379 6e63 2064 6566 2061   )...async def a
-000238c0: 6374 696f 6e5f 6c69 7374 656e 2829 202d  ction_listen() -
-000238d0: 3e20 4e6f 6e65 3a0a 2020 2020 2222 224c  > None:.    """L
-000238e0: 6973 7465 6e20 7768 696c 6520 6265 696e  isten while bein
-000238f0: 6720 6c6f 6767 6564 2069 6e2e 2222 220a  g logged in.""".
-00023900: 2020 2020 6966 206e 6f74 2067 732e 636c      if not gs.cl
-00023910: 6965 6e74 2061 6e64 206e 6f74 2067 732e  ient and not gs.
-00023920: 6372 6564 656e 7469 616c 733a 0a20 2020  credentials:.   
-00023930: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
-00023940: 7228 0a20 2020 2020 2020 2020 2020 2022  r(.            "
-00023950: 4531 3634 3a20 2220 2243 6c69 656e 7420  E164: " "Client 
-00023960: 6f72 2063 7265 6465 6e74 6961 6c73 206e  or credentials n
-00023970: 6f74 2073 6574 2e20 536b 6970 7069 6e67  ot set. Skipping
-00023980: 2061 6374 696f 6e2e 220a 2020 2020 2020   action.".      
-00023990: 2020 290a 2020 2020 2020 2020 6773 2e65    ).        gs.e
-000239a0: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
-000239b0: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-000239c0: 2074 7279 3a0a 2020 2020 2020 2020 2320   try:.        # 
-000239d0: 5379 6e63 2065 6e63 7279 7074 696f 6e20  Sync encryption 
-000239e0: 6b65 7973 2077 6974 6820 7468 6520 7365  keys with the se
-000239f0: 7276 6572 0a20 2020 2020 2020 2023 2052  rver.        # R
-00023a00: 6571 7569 7265 6420 666f 7220 7061 7274  equired for part
-00023a10: 6963 6970 6174 696e 6720 696e 2065 6e63  icipating in enc
-00023a20: 7279 7074 6564 2072 6f6f 6d73 0a20 2020  rypted rooms.   
-00023a30: 2020 2020 2069 6620 6773 2e63 6c69 656e       if gs.clien
-00023a40: 742e 7368 6f75 6c64 5f75 706c 6f61 645f  t.should_upload_
-00023a50: 6b65 7973 3a0a 2020 2020 2020 2020 2020  keys:.          
-00023a60: 2020 6177 6169 7420 6773 2e63 6c69 656e    await gs.clien
-00023a70: 742e 6b65 7973 5f75 706c 6f61 6428 290a  t.keys_upload().
-00023a80: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-00023a90: 6562 7567 2866 224c 6973 7465 6e69 6e67  ebug(f"Listening
-00023aa0: 2074 7970 653a 207b 6773 2e70 612e 6c69   type: {gs.pa.li
-00023ab0: 7374 656e 7d22 290a 2020 2020 2020 2020  sten}").        
-00023ac0: 6966 2067 732e 7061 2e6c 6973 7465 6e20  if gs.pa.listen 
-00023ad0: 3d3d 2046 4f52 4556 4552 3a0a 2020 2020  == FOREVER:.    
-00023ae0: 2020 2020 2020 2020 6177 6169 7420 6c69          await li
-00023af0: 7374 656e 5f66 6f72 6576 6572 2867 732e  sten_forever(gs.
-00023b00: 636c 6965 6e74 290a 2020 2020 2020 2020  client).        
-00023b10: 656c 6966 2067 732e 7061 2e6c 6973 7465  elif gs.pa.liste
-00023b20: 6e20 3d3d 204f 4e43 453a 0a20 2020 2020  n == ONCE:.     
-00023b30: 2020 2020 2020 2061 7761 6974 206c 6973         await lis
-00023b40: 7465 6e5f 6f6e 6365 2867 732e 636c 6965  ten_once(gs.clie
-00023b50: 6e74 290a 2020 2020 2020 2020 2020 2020  nt).            
-00023b60: 2320 636f 756c 6420 7573 6520 2761 7761  # could use 'awa
-00023b70: 6974 206c 6973 7465 6e5f 6f6e 6365 5f61  it listen_once_a
-00023b80: 6c74 6572 6e61 7469 7665 2867 732e 636c  lternative(gs.cl
-00023b90: 6965 6e74 2927 0a20 2020 2020 2020 2020  ient)'.         
-00023ba0: 2020 2023 2061 7320 616e 2061 6c74 6572     # as an alter
-00023bb0: 6e61 7469 7665 2069 6d70 6c65 6d65 6e74  native implement
-00023bc0: 6174 696f 6e0a 2020 2020 2020 2020 656c  ation.        el
-00023bd0: 6966 2067 732e 7061 2e6c 6973 7465 6e20  if gs.pa.listen 
-00023be0: 3d3d 2054 4149 4c3a 0a20 2020 2020 2020  == TAIL:.       
-00023bf0: 2020 2020 2061 7761 6974 206c 6973 7465       await liste
-00023c00: 6e5f 7461 696c 2867 732e 636c 6965 6e74  n_tail(gs.client
-00023c10: 2c20 6773 2e63 7265 6465 6e74 6961 6c73  , gs.credentials
-00023c20: 290a 2020 2020 2020 2020 656c 6966 2067  ).        elif g
-00023c30: 732e 7061 2e6c 6973 7465 6e20 3d3d 2041  s.pa.listen == A
-00023c40: 4c4c 3a0a 2020 2020 2020 2020 2020 2020  LL:.            
-00023c50: 6177 6169 7420 6c69 7374 656e 5f61 6c6c  await listen_all
-00023c60: 2867 732e 636c 6965 6e74 2c20 6773 2e63  (gs.client, gs.c
-00023c70: 7265 6465 6e74 6961 6c73 290a 2020 2020  redentials).    
-00023c80: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00023c90: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
-00023ca0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00023cb0: 2020 2020 2245 3136 353a 2022 0a20 2020      "E165: ".   
-00023cc0: 2020 2020 2020 2020 2020 2020 2066 2755               f'U
-00023cd0: 6e72 6563 6f67 6e69 7a65 6420 6c69 7374  nrecognized list
-00023ce0: 656e 696e 6720 7479 7065 2022 7b67 732e  ening type "{gs.
-00023cf0: 7061 2e6c 6973 7465 6e7d 222e 2027 0a20  pa.listen}". '. 
-00023d00: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00023d10: 536b 6970 7069 6e67 206c 6973 7465 6e69  Skipping listeni
-00023d20: 6e67 2e22 0a20 2020 2020 2020 2020 2020  ng.".           
-00023d30: 2029 0a20 2020 2020 2020 2020 2020 2067   ).            g
-00023d40: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
-00023d50: 0a20 2020 2065 7863 6570 7420 4578 6365  .    except Exce
-00023d60: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
-00023d70: 2020 2020 6773 2e6c 6f67 2e65 7272 6f72      gs.log.error
-00023d80: 280a 2020 2020 2020 2020 2020 2020 2245  (.            "E
-00023d90: 3136 363a 2022 0a20 2020 2020 2020 2020  166: ".         
-00023da0: 2020 2022 4572 726f 7220 6475 7269 6e67     "Error during
-00023db0: 206c 6973 7465 6e69 6e67 2e20 436f 6e74   listening. Cont
-00023dc0: 696e 7569 6e67 2064 6573 7069 7465 2065  inuing despite e
-00023dd0: 7272 6f72 2e20 220a 2020 2020 2020 2020  rror. ".        
-00023de0: 2020 2020 6622 4578 6365 7074 696f 6e3a      f"Exception:
-00023df0: 207b 657d 220a 2020 2020 2020 2020 290a   {e}".        ).
-00023e00: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-00023e10: 6562 7567 2822 4865 7265 2069 7320 7468  ebug("Here is th
-00023e20: 6520 7472 6163 6562 6163 6b2e 5c6e 2220  e traceback.\n" 
-00023e30: 2b20 7472 6163 6562 6163 6b2e 666f 726d  + traceback.form
-00023e40: 6174 5f65 7863 2829 290a 2020 2020 2020  at_exc()).      
-00023e50: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
-00023e60: 3d20 310a 0a0a 6173 796e 6320 6465 6620  = 1...async def 
-00023e70: 6163 7469 6f6e 5f73 6574 5f64 6576 6963  action_set_devic
-00023e80: 655f 6e61 6d65 280a 2020 2020 636c 6965  e_name(.    clie
-00023e90: 6e74 3a20 4173 796e 6343 6c69 656e 742c  nt: AsyncClient,
-00023ea0: 2063 7265 6465 6e74 6961 6c73 3a20 6469   credentials: di
-00023eb0: 6374 0a29 202d 3e20 4e6f 6e65 3a0a 2020  ct.) -> None:.  
-00023ec0: 2020 2222 2253 6574 2c20 7265 6e61 6d65    """Set, rename
-00023ed0: 2074 6865 2064 6576 6963 6520 6e61 6d65   the device name
-00023ee0: 206f 6620 6974 7365 6c66 2077 6869 6c65   of itself while
-00023ef0: 2061 6c72 6561 6479 2062 6569 6e67 206c   already being l
-00023f00: 6f67 6765 6420 696e 2e22 2222 0a20 2020  ogged in.""".   
-00023f10: 2063 6f6e 7465 6e74 203d 207b 2264 6576   content = {"dev
-00023f20: 6963 655f 6e61 6d65 223a 2067 732e 7061  ice_name": gs.pa
-00023f30: 2e73 6574 5f64 6576 6963 655f 6e61 6d65  .set_device_name
-00023f40: 7d0a 2020 2020 7265 7370 203d 2061 7761  }.    resp = awa
-00023f50: 6974 2063 6c69 656e 742e 7570 6461 7465  it client.update
-00023f60: 5f64 6576 6963 6528 6372 6564 656e 7469  _device(credenti
-00023f70: 616c 735b 2264 6576 6963 655f 6964 225d  als["device_id"]
-00023f80: 2c20 636f 6e74 656e 7429 0a20 2020 2069  , content).    i
-00023f90: 6620 6973 696e 7374 616e 6365 2872 6573  f isinstance(res
-00023fa0: 702c 2055 7064 6174 6544 6576 6963 6545  p, UpdateDeviceE
-00023fb0: 7272 6f72 293a 0a20 2020 2020 2020 2067  rror):.        g
-00023fc0: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
-00023fd0: 2020 2020 2020 2020 2022 4531 3637 3a20           "E167: 
-00023fe0: 2220 6622 7570 6461 7465 5f64 6576 6963  " f"update_devic
-00023ff0: 6520 6661 696c 6564 2077 6974 6820 7b70  e failed with {p
-00024000: 7269 7661 6379 5f66 696c 7465 7228 7374  rivacy_filter(st
-00024010: 7228 7265 7370 2929 7d22 0a20 2020 2020  r(resp))}".     
-00024020: 2020 2029 0a20 2020 2020 2020 2067 732e     ).        gs.
-00024030: 6572 725f 636f 756e 7420 2b3d 2031 0a20  err_count += 1. 
-00024040: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00024050: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
-00024060: 2020 2020 2020 2020 2020 2066 2275 7064             f"upd
-00024070: 6174 655f 6465 7669 6365 2073 7563 6365  ate_device succe
-00024080: 7373 6675 6c20 7769 7468 207b 7072 6976  ssful with {priv
-00024090: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
-000240a0: 6573 7029 297d 220a 2020 2020 2020 2020  esp))}".        
-000240b0: 290a 0a0a 6173 796e 6320 6465 6620 6163  )...async def ac
-000240c0: 7469 6f6e 5f73 6574 5f64 6973 706c 6179  tion_set_display
-000240d0: 5f6e 616d 6528 0a20 2020 2063 6c69 656e  _name(.    clien
-000240e0: 743a 2041 7379 6e63 436c 6965 6e74 2c20  t: AsyncClient, 
-000240f0: 6372 6564 656e 7469 616c 733a 2064 6963  credentials: dic
-00024100: 740a 2920 2d3e 204e 6f6e 653a 0a20 2020  t.) -> None:.   
-00024110: 2022 2222 5365 742c 2072 656e 616d 6520   """Set, rename 
-00024120: 7468 6520 6c6f 6767 6564 2069 6e20 7573  the logged in us
-00024130: 6572 2773 2064 6973 706c 6179 206e 616d  er's display nam
-00024140: 652e 2043 6861 6e67 6520 6d79 206f 776e  e. Change my own
-00024150: 0a20 2020 2064 6973 706c 6179 206e 616d  .    display nam
-00024160: 652e 0a20 2020 2052 656e 616d 6520 7468  e..    Rename th
-00024170: 6520 7573 6572 2062 7920 6368 616e 6769  e user by changi
-00024180: 6e67 2064 6973 706c 6179 206e 616d 652e  ng display name.
-00024190: 0a20 2020 2041 7373 756d 6573 2074 6861  .    Assumes tha
-000241a0: 7420 7573 6572 2069 7320 616c 7265 6164  t user is alread
-000241b0: 7920 6c6f 6767 6564 2069 6e2e 0a20 2020  y logged in..   
-000241c0: 2022 2222 0a20 2020 2072 6573 7020 3d20   """.    resp = 
-000241d0: 6177 6169 7420 636c 6965 6e74 2e73 6574  await client.set
-000241e0: 5f64 6973 706c 6179 6e61 6d65 2867 732e  _displayname(gs.
-000241f0: 7061 2e73 6574 5f64 6973 706c 6179 5f6e  pa.set_display_n
-00024200: 616d 6529 0a20 2020 2069 6620 6973 696e  ame).    if isin
-00024210: 7374 616e 6365 2872 6573 702c 2050 726f  stance(resp, Pro
-00024220: 6669 6c65 5365 7444 6973 706c 6179 4e61  fileSetDisplayNa
-00024230: 6d65 4572 726f 7229 3a0a 2020 2020 2020  meError):.      
-00024240: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
-00024250: 2020 2020 2020 2020 2020 2020 2245 3136              "E16
-00024260: 383a 2022 2066 2273 6574 5f64 6973 706c  8: " f"set_displ
-00024270: 6179 6e61 6d65 2066 6169 6c65 6420 7769  ayname failed wi
-00024280: 7468 207b 7072 6976 6163 795f 6669 6c74  th {privacy_filt
-00024290: 6572 2873 7472 2872 6573 7029 297d 220a  er(str(resp))}".
-000242a0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000242b0: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
-000242c0: 3d20 310a 2020 2020 656c 7365 3a0a 2020  = 1.    else:.  
-000242d0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-000242e0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-000242f0: 6622 7365 745f 6469 7370 6c61 796e 616d  f"set_displaynam
-00024300: 6520 7375 6363 6573 7366 756c 2077 6974  e successful wit
-00024310: 6820 7b70 7269 7661 6379 5f66 696c 7465  h {privacy_filte
-00024320: 7228 7374 7228 7265 7370 2929 7d22 0a20  r(str(resp))}". 
-00024330: 2020 2020 2020 2029 0a0a 0a61 7379 6e63         )...async
-00024340: 2064 6566 2061 6374 696f 6e5f 6765 745f   def action_get_
-00024350: 6469 7370 6c61 795f 6e61 6d65 280a 2020  display_name(.  
-00024360: 2020 636c 6965 6e74 3a20 4173 796e 6343    client: AsyncC
-00024370: 6c69 656e 742c 2063 7265 6465 6e74 6961  lient, credentia
-00024380: 6c73 3a20 6469 6374 0a29 202d 3e20 4e6f  ls: dict.) -> No
-00024390: 6e65 3a0a 2020 2020 2222 2247 6574 2064  ne:.    """Get d
-000243a0: 6973 706c 6179 206e 616d 6528 7329 2077  isplay name(s) w
-000243b0: 6869 6c65 2061 6c72 6561 6479 206c 6f67  hile already log
-000243c0: 6765 6420 696e 2e22 2222 0a20 2020 2069  ged in.""".    i
-000243d0: 6620 6e6f 7420 6773 2e70 612e 7573 6572  f not gs.pa.user
-000243e0: 3a0a 2020 2020 2020 2020 2320 6765 7420  :.        # get 
-000243f0: 6469 7370 6c61 7920 6e61 6d65 206f 6620  display name of 
-00024400: 6d79 7365 6c66 0a20 2020 2020 2020 2077  myself.        w
-00024410: 686f 616d 6920 3d20 6372 6564 656e 7469  hoami = credenti
-00024420: 616c 735b 2275 7365 725f 6964 225d 0a20  als["user_id"]. 
-00024430: 2020 2020 2020 2075 7365 7273 203d 205b         users = [
-00024440: 7768 6f61 6d69 5d0a 2020 2020 656c 7365  whoami].    else
-00024450: 3a0a 2020 2020 2020 2020 7573 6572 7320  :.        users 
-00024460: 3d20 6773 2e70 612e 7573 6572 0a20 2020  = gs.pa.user.   
-00024470: 2075 7365 7273 203d 206c 6973 7428 6469   users = list(di
-00024480: 6374 2e66 726f 6d6b 6579 7328 7573 6572  ct.fromkeys(user
-00024490: 7329 2920 2023 2072 656d 6f76 6520 6475  s))  # remove du
-000244a0: 706c 6963 6174 6573 2069 6e20 6c69 7374  plicates in list
-000244b0: 0a20 2020 2066 6f72 2075 7365 7220 696e  .    for user in
-000244c0: 2075 7365 7273 3a0a 2020 2020 2020 2020   users:.        
-000244d0: 7265 7370 203d 2061 7761 6974 2063 6c69  resp = await cli
-000244e0: 656e 742e 6765 745f 6469 7370 6c61 796e  ent.get_displayn
-000244f0: 616d 6528 7573 6572 290a 2020 2020 2020  ame(user).      
-00024500: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00024510: 7265 7370 2c20 5072 6f66 696c 6547 6574  resp, ProfileGet
-00024520: 4469 7370 6c61 794e 616d 6545 7272 6f72  DisplayNameError
-00024530: 293a 0a20 2020 2020 2020 2020 2020 2067  ):.            g
-00024540: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
-00024550: 2020 2020 2020 2020 2020 2020 2022 4531               "E1
-00024560: 3639 3a20 220a 2020 2020 2020 2020 2020  69: ".          
-00024570: 2020 2020 2020 6622 6765 745f 6469 7370        f"get_disp
-00024580: 6c61 796e 616d 6520 6661 696c 6564 2077  layname failed w
-00024590: 6974 6820 7b70 7269 7661 6379 5f66 696c  ith {privacy_fil
-000245a0: 7465 7228 7374 7228 7265 7370 2929 7d22  ter(str(resp))}"
-000245b0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-000245c0: 2020 2020 2020 2020 2020 2067 732e 6572             gs.er
-000245d0: 725f 636f 756e 7420 2b3d 2031 0a20 2020  r_count += 1.   
-000245e0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000245f0: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-00024600: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
-00024610: 2020 2020 2066 2267 6574 5f64 6973 706c       f"get_displ
-00024620: 6179 6e61 6d65 2073 7563 6365 7373 6675  ayname successfu
-00024630: 6c20 7769 7468 207b 7072 6976 6163 795f  l with {privacy_
-00024640: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
-00024650: 297d 220a 2020 2020 2020 2020 2020 2020  )}".            
-00024660: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
-00024670: 7265 7370 2e64 6973 706c 6179 6e61 6d65  resp.displayname
-00024680: 2069 7320 7374 7220 6f72 204e 6f6e 6520   is str or None 
-00024690: 2868 6173 206e 6f20 6469 7370 6c61 7920  (has no display 
-000246a0: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
-000246b0: 2020 6966 206e 6f74 2072 6573 702e 6469    if not resp.di
-000246c0: 7370 6c61 796e 616d 653a 0a20 2020 2020  splayname:.     
-000246d0: 2020 2020 2020 2020 2020 2064 6973 706c             displ
-000246e0: 6179 6e61 6d65 203d 2022 2220 2023 206d  ayname = ""  # m
-000246f0: 6561 6e73 206e 6f20 6469 7370 6c61 7920  eans no display 
-00024700: 6e61 6d65 2069 7320 7365 740a 2020 2020  name is set.    
-00024710: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00024720: 2020 2020 2020 2020 2020 2020 2020 6469                di
-00024730: 7370 6c61 796e 616d 6520 3d20 7265 7370  splayname = resp
-00024740: 2e64 6973 706c 6179 6e61 6d65 0a20 2020  .displayname.   
-00024750: 2020 2020 2020 2020 2023 206f 7574 7075           # outpu
-00024760: 7420 666f 726d 6174 2063 6f6e 7472 6f6c  t format control
-00024770: 6c65 6420 7669 6120 2d2d 6f75 7470 7574  led via --output
-00024780: 2066 6c61 670a 2020 2020 2020 2020 2020   flag.          
-00024790: 2020 7465 7874 203d 2066 227b 7573 6572    text = f"{user
-000247a0: 7d7b 5345 507d 7b64 6973 706c 6179 6e61  }{SEP}{displayna
-000247b0: 6d65 7d22 0a20 2020 2020 2020 2020 2020  me}".           
-000247c0: 2023 204f 626a 6563 7420 6f66 2074 7970   # Object of typ
-000247d0: 6520 526f 6f6d 4372 6561 7465 5265 7370  e RoomCreateResp
-000247e0: 6f6e 7365 2069 7320 6e6f 7420 4a53 4f4e  onse is not JSON
-000247f0: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
-00024800: 6572 6961 6c69 7a61 626c 652c 2068 656e  erializable, hen
-00024810: 6365 2077 6520 7573 6520 7468 6520 6469  ce we use the di
-00024820: 6374 696f 6e61 7279 2e0a 2020 2020 2020  ctionary..      
-00024830: 2020 2020 2020 6a73 6f6e 5f6d 6178 203d        json_max =
-00024840: 2072 6573 702e 5f5f 6469 6374 5f5f 0a20   resp.__dict__. 
-00024850: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-00024860: 6d61 782e 7570 6461 7465 287b 2275 7365  max.update({"use
-00024870: 7222 3a20 7573 6572 7d29 2020 2320 6164  r": user})  # ad
-00024880: 6420 6469 6374 2069 7465 6d73 0a20 2020  d dict items.   
-00024890: 2020 2020 2020 2020 206a 736f 6e5f 203d           json_ =
-000248a0: 206a 736f 6e5f 6d61 782e 636f 7079 2829   json_max.copy()
-000248b0: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
-000248c0: 6e5f 2e70 6f70 2822 7472 616e 7370 6f72  n_.pop("transpor
-000248d0: 745f 7265 7370 6f6e 7365 2229 0a20 2020  t_response").   
-000248e0: 2020 2020 2020 2020 206a 736f 6e5f 7370           json_sp
-000248f0: 6563 203d 204e 6f6e 650a 2020 2020 2020  ec = None.      
-00024900: 2020 2020 2020 7072 696e 745f 6f75 7470        print_outp
-00024910: 7574 280a 2020 2020 2020 2020 2020 2020  ut(.            
-00024920: 2020 2020 6773 2e70 612e 6f75 7470 7574      gs.pa.output
-00024930: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00024940: 2020 7465 7874 3d74 6578 742c 0a20 2020    text=text,.   
-00024950: 2020 2020 2020 2020 2020 2020 206a 736f               jso
-00024960: 6e5f 3d6a 736f 6e5f 2c0a 2020 2020 2020  n_=json_,.      
-00024970: 2020 2020 2020 2020 2020 6a73 6f6e 5f6d            json_m
-00024980: 6178 3d6a 736f 6e5f 6d61 782c 0a20 2020  ax=json_max,.   
-00024990: 2020 2020 2020 2020 2020 2020 206a 736f               jso
-000249a0: 6e5f 7370 6563 3d6a 736f 6e5f 7370 6563  n_spec=json_spec
-000249b0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-000249c0: 0a0a 6173 796e 6320 6465 6620 6163 7469  ..async def acti
-000249d0: 6f6e 5f73 6574 5f70 7265 7365 6e63 6528  on_set_presence(
-000249e0: 636c 6965 6e74 3a20 4173 796e 6343 6c69  client: AsyncCli
-000249f0: 656e 742c 2063 7265 6465 6e74 6961 6c73  ent, credentials
-00024a00: 3a20 6469 6374 2920 2d3e 204e 6f6e 653a  : dict) -> None:
-00024a10: 0a20 2020 2022 2222 5365 7420 7468 6520  .    """Set the 
-00024a20: 6c6f 6767 6564 2069 6e20 7573 6572 2773  logged in user's
-00024a30: 2070 7265 7365 6e63 652e 2043 6861 6e67   presence. Chang
-00024a40: 6520 6d79 206f 776e 2070 7265 7365 6e63  e my own presenc
-00024a50: 652e 0a20 2020 2041 7373 756d 6573 2074  e..    Assumes t
-00024a60: 6861 7420 7573 6572 2069 7320 616c 7265  hat user is alre
-00024a70: 6164 7920 6c6f 6767 6564 2069 6e2e 0a20  ady logged in.. 
-00024a80: 2020 2022 2222 0a20 2020 2073 7461 7465     """.    state
-00024a90: 203d 2067 732e 7061 2e73 6574 5f70 7265   = gs.pa.set_pre
-00024aa0: 7365 6e63 652e 7374 7269 7028 292e 6c6f  sence.strip().lo
-00024ab0: 7765 7228 290a 2020 2020 6773 2e6c 6f67  wer().    gs.log
-00024ac0: 2e64 6562 7567 2866 2253 6574 7469 6e67  .debug(f"Setting
-00024ad0: 2070 7265 7365 6e63 6520 746f 207b 7374   presence to {st
-00024ae0: 6174 657d 205b 7b67 732e 7061 2e73 6574  ate} [{gs.pa.set
-00024af0: 5f70 7265 7365 6e63 657d 5d2e 2229 0a20  _presence}]."). 
-00024b00: 2020 2072 6573 7020 3d20 6177 6169 7420     resp = await 
-00024b10: 636c 6965 6e74 2e73 6574 5f70 7265 7365  client.set_prese
-00024b20: 6e63 6528 7374 6174 6529 0a20 2020 2069  nce(state).    i
-00024b30: 6620 6973 696e 7374 616e 6365 2872 6573  f isinstance(res
-00024b40: 702c 2050 7265 7365 6e63 6553 6574 4572  p, PresenceSetEr
-00024b50: 726f 7229 3a0a 2020 2020 2020 2020 6773  ror):.        gs
-00024b60: 2e6c 6f67 2e65 7272 6f72 280a 2020 2020  .log.error(.    
-00024b70: 2020 2020 2020 2020 2245 3137 303a 2022          "E170: "
-00024b80: 2066 2273 6574 5f70 7265 7365 6e63 6520   f"set_presence 
-00024b90: 6661 696c 6564 2077 6974 6820 7b70 7269  failed with {pri
-00024ba0: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
-00024bb0: 7265 7370 2929 7d22 0a20 2020 2020 2020  resp))}".       
-00024bc0: 2029 0a20 2020 2020 2020 2067 732e 6572   ).        gs.er
-00024bd0: 725f 636f 756e 7420 2b3d 2031 0a20 2020  r_count += 1.   
-00024be0: 2065 6c73 653a 0a20 2020 2020 2020 2067   else:.        g
-00024bf0: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
-00024c00: 2020 2020 2020 2020 2066 2273 6574 5f70           f"set_p
-00024c10: 7265 7365 6e63 6520 7375 6363 6573 7366  resence successf
-00024c20: 756c 2077 6974 6820 7b70 7269 7661 6379  ul with {privacy
-00024c30: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
-00024c40: 2929 7d22 0a20 2020 2020 2020 2029 0a0a  ))}".        )..
-00024c50: 0a61 7379 6e63 2064 6566 2061 6374 696f  .async def actio
-00024c60: 6e5f 6765 745f 7072 6573 656e 6365 2863  n_get_presence(c
-00024c70: 6c69 656e 743a 2041 7379 6e63 436c 6965  lient: AsyncClie
-00024c80: 6e74 2c20 6372 6564 656e 7469 616c 733a  nt, credentials:
-00024c90: 2064 6963 7429 202d 3e20 4e6f 6e65 3a0a   dict) -> None:.
-00024ca0: 2020 2020 2222 2247 6574 2070 7265 7365      """Get prese
-00024cb0: 6e63 6528 7329 2077 6869 6c65 2061 6c72  nce(s) while alr
-00024cc0: 6561 6479 206c 6f67 6765 6420 696e 2e22  eady logged in."
-00024cd0: 2222 0a20 2020 2069 6620 6e6f 7420 6773  "".    if not gs
-00024ce0: 2e70 612e 7573 6572 3a0a 2020 2020 2020  .pa.user:.      
-00024cf0: 2020 2320 6765 7420 7072 6573 656e 6365    # get presence
-00024d00: 206e 616d 6520 6f66 206d 7973 656c 660a   name of myself.
-00024d10: 2020 2020 2020 2020 7768 6f61 6d69 203d          whoami =
-00024d20: 2063 7265 6465 6e74 6961 6c73 5b22 7573   credentials["us
-00024d30: 6572 5f69 6422 5d0a 2020 2020 2020 2020  er_id"].        
-00024d40: 7573 6572 7320 3d20 5b77 686f 616d 695d  users = [whoami]
-00024d50: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00024d60: 2020 2075 7365 7273 203d 2067 732e 7061     users = gs.pa
-00024d70: 2e75 7365 720a 2020 2020 7573 6572 7320  .user.    users 
-00024d80: 3d20 6c69 7374 2864 6963 742e 6672 6f6d  = list(dict.from
-00024d90: 6b65 7973 2875 7365 7273 2929 2020 2320  keys(users))  # 
-00024da0: 7265 6d6f 7665 2064 7570 6c69 6361 7465  remove duplicate
-00024db0: 7320 696e 206c 6973 740a 2020 2020 666f  s in list.    fo
-00024dc0: 7220 7573 6572 2069 6e20 7573 6572 733a  r user in users:
-00024dd0: 0a20 2020 2020 2020 2072 6573 7020 3d20  .        resp = 
-00024de0: 6177 6169 7420 636c 6965 6e74 2e67 6574  await client.get
-00024df0: 5f70 7265 7365 6e63 6528 7573 6572 290a  _presence(user).
-00024e00: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00024e10: 7461 6e63 6528 7265 7370 2c20 5072 6573  tance(resp, Pres
-00024e20: 656e 6365 4765 7445 7272 6f72 293a 0a20  enceGetError):. 
-00024e30: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-00024e40: 672e 6572 726f 7228 0a20 2020 2020 2020  g.error(.       
-00024e50: 2020 2020 2020 2020 2022 4531 3731 3a20           "E171: 
-00024e60: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00024e70: 2020 6622 6765 745f 7072 6573 656e 6365    f"get_presence
-00024e80: 2066 6169 6c65 6420 7769 7468 207b 7072   failed with {pr
-00024e90: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
-00024ea0: 2872 6573 7029 297d 220a 2020 2020 2020  (resp))}".      
-00024eb0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00024ec0: 2020 2020 6773 2e65 7272 5f63 6f75 6e74      gs.err_count
-00024ed0: 202b 3d20 310a 2020 2020 2020 2020 656c   += 1.        el
-00024ee0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00024ef0: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
-00024f00: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00024f10: 6765 745f 7072 6573 656e 6365 2073 7563  get_presence suc
-00024f20: 6365 7373 6675 6c20 7769 7468 207b 7072  cessful with {pr
-00024f30: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
-00024f40: 2872 6573 7029 297d 220a 2020 2020 2020  (resp))}".      
-00024f50: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00024f60: 2020 2020 6966 206e 6f74 2072 6573 702e      if not resp.
-00024f70: 6c61 7374 5f61 6374 6976 655f 6167 6f3a  last_active_ago:
-00024f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024f90: 206c 6173 745f 6163 7469 7665 5f61 676f   last_active_ago
-00024fa0: 203d 2030 2020 2320 6d65 616e 7320 6375   = 0  # means cu
-00024fb0: 7272 656e 746c 795f 6163 7469 7665 2069  rrently_active i
-00024fc0: 7320 6e6f 7420 7365 740a 2020 2020 2020  s not set.      
-00024fd0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00024fe0: 2020 2020 2020 2020 2020 2020 6c61 7374              last
-00024ff0: 5f61 6374 6976 655f 6167 6f20 3d20 7265  _active_ago = re
-00025000: 7370 2e6c 6173 745f 6163 7469 7665 5f61  sp.last_active_a
-00025010: 676f 0a20 2020 2020 2020 2020 2020 2069  go.            i
-00025020: 6620 6e6f 7420 7265 7370 2e63 7572 7265  f not resp.curre
-00025030: 6e74 6c79 5f61 6374 6976 653a 0a20 2020  ntly_active:.   
-00025040: 2020 2020 2020 2020 2020 2020 2063 7572               cur
-00025050: 7265 6e74 6c79 5f61 6374 6976 6520 3d20  rently_active = 
-00025060: 4661 6c73 6520 2023 206d 6561 6e73 2063  False  # means c
-00025070: 7572 7265 6e74 6c79 5f61 6374 6976 6520  urrently_active 
-00025080: 6973 206e 6f74 2073 6574 0a20 2020 2020  is not set.     
-00025090: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000250a0: 2020 2020 2020 2020 2020 2020 2063 7572               cur
-000250b0: 7265 6e74 6c79 5f61 6374 6976 6520 3d20  rently_active = 
-000250c0: 7265 7370 2e63 7572 7265 6e74 6c79 5f61  resp.currently_a
-000250d0: 6374 6976 650a 2020 2020 2020 2020 2020  ctive.          
-000250e0: 2020 6966 206e 6f74 2072 6573 702e 7374    if not resp.st
-000250f0: 6174 7573 5f6d 7367 3a0a 2020 2020 2020  atus_msg:.      
-00025100: 2020 2020 2020 2020 2020 7374 6174 7573            status
-00025110: 5f6d 7367 203d 2022 2220 2023 206d 6561  _msg = ""  # mea
-00025120: 6e73 206e 6f20 7374 6174 7573 5f6d 7367  ns no status_msg
-00025130: 2069 7320 7365 740a 2020 2020 2020 2020   is set.        
-00025140: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00025150: 2020 2020 2020 2020 2020 7374 6174 7573            status
-00025160: 5f6d 7367 203d 2072 6573 702e 7374 6174  _msg = resp.stat
-00025170: 7573 5f6d 7367 0a20 2020 2020 2020 2020  us_msg.         
-00025180: 2020 2023 206f 7574 7075 7420 666f 726d     # output form
-00025190: 6174 2063 6f6e 7472 6f6c 6c65 6420 7669  at controlled vi
-000251a0: 6120 2d2d 6f75 7470 7574 2066 6c61 670a  a --output flag.
-000251b0: 2020 2020 2020 2020 2020 2020 7465 7874              text
-000251c0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-000251d0: 2020 2020 2066 227b 7265 7370 2e75 7365       f"{resp.use
-000251e0: 725f 6964 7d7b 5345 507d 7b72 6573 702e  r_id}{SEP}{resp.
-000251f0: 7072 6573 656e 6365 7d7b 5345 507d 7b6c  presence}{SEP}{l
-00025200: 6173 745f 6163 7469 7665 5f61 676f 7d22  ast_active_ago}"
-00025210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025220: 2066 227b 5345 507d 7b63 7572 7265 6e74   f"{SEP}{current
-00025230: 6c79 5f61 6374 6976 657d 7b53 4550 7d7b  ly_active}{SEP}{
-00025240: 7374 6174 7573 5f6d 7367 7d22 0a20 2020  status_msg}".   
-00025250: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00025260: 2020 2020 2020 2023 204f 626a 6563 7420         # Object 
-00025270: 6f66 2074 7970 6520 7878 7852 6573 706f  of type xxxRespo
-00025280: 6e73 6520 6973 206e 6f74 204a 534f 4e0a  nse is not JSON.
-00025290: 2020 2020 2020 2020 2020 2020 2320 7365              # se
-000252a0: 7269 616c 697a 6162 6c65 2c20 6865 6e63  rializable, henc
-000252b0: 6520 7765 2075 7365 2074 6865 2064 6963  e we use the dic
-000252c0: 7469 6f6e 6172 792e 0a20 2020 2020 2020  tionary..       
-000252d0: 2020 2020 206a 736f 6e5f 6d61 7820 3d20       json_max = 
-000252e0: 7265 7370 2e5f 5f64 6963 745f 5f0a 2020  resp.__dict__.  
-000252f0: 2020 2020 2020 2020 2020 2320 6a73 6f6e            # json
-00025300: 5f6d 6178 2e75 7064 6174 6528 7b22 6b65  _max.update({"ke
-00025310: 7922 3a20 7661 6c75 657d 2920 2023 2061  y": value})  # a
-00025320: 6464 2064 6963 7420 6974 656d 730a 2020  dd dict items.  
-00025330: 2020 2020 2020 2020 2020 6a73 6f6e 5f20            json_ 
-00025340: 3d20 6a73 6f6e 5f6d 6178 2e63 6f70 7928  = json_max.copy(
-00025350: 290a 2020 2020 2020 2020 2020 2020 6a73  ).            js
-00025360: 6f6e 5f2e 706f 7028 2274 7261 6e73 706f  on_.pop("transpo
-00025370: 7274 5f72 6573 706f 6e73 6522 290a 2020  rt_response").  
-00025380: 2020 2020 2020 2020 2020 6a73 6f6e 5f73            json_s
-00025390: 7065 6320 3d20 4e6f 6e65 0a20 2020 2020  pec = None.     
-000253a0: 2020 2020 2020 2070 7269 6e74 5f6f 7574         print_out
-000253b0: 7075 7428 0a20 2020 2020 2020 2020 2020  put(.           
-000253c0: 2020 2020 2067 732e 7061 2e6f 7574 7075       gs.pa.outpu
-000253d0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-000253e0: 2020 2074 6578 743d 7465 7874 2c0a 2020     text=text,.  
-000253f0: 2020 2020 2020 2020 2020 2020 2020 6a73                js
-00025400: 6f6e 5f3d 6a73 6f6e 5f2c 0a20 2020 2020  on_=json_,.     
-00025410: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-00025420: 6d61 783d 6a73 6f6e 5f6d 6178 2c0a 2020  max=json_max,.  
-00025430: 2020 2020 2020 2020 2020 2020 2020 6a73                js
-00025440: 6f6e 5f73 7065 633d 6a73 6f6e 5f73 7065  on_spec=json_spe
-00025450: 632c 0a20 2020 2020 2020 2020 2020 2029  c,.            )
-00025460: 0a0a 0a61 7379 6e63 2064 6566 2061 6374  ...async def act
-00025470: 696f 6e5f 7570 6c6f 6164 2863 6c69 656e  ion_upload(clien
-00025480: 743a 2041 7379 6e63 436c 6965 6e74 2c20  t: AsyncClient, 
-00025490: 6372 6564 656e 7469 616c 733a 2064 6963  credentials: dic
-000254a0: 7429 202d 3e20 4e6f 6e65 3a0a 2020 2020  t) -> None:.    
-000254b0: 2222 2255 706c 6f61 6420 6f6e 6520 6f72  """Upload one or
-000254c0: 206d 6f72 6520 6669 6c65 7320 746f 2063   more files to c
-000254d0: 6f6e 7465 6e74 2072 6570 6f73 6974 6f72  ontent repositor
-000254e0: 7920 6f66 204d 6174 7269 7820 7365 7276  y of Matrix serv
-000254f0: 6572 2e0a 2020 2020 4173 7375 6d65 7320  er..    Assumes 
-00025500: 7468 6174 2075 7365 7220 6973 2061 6c72  that user is alr
-00025510: 6561 6479 206c 6f67 6765 6420 696e 2e0a  eady logged in..
-00025520: 2020 2020 2222 220a 2020 2020 666f 7220      """.    for 
-00025530: 6669 6c65 6e61 6d65 2069 6e20 6773 2e70  filename in gs.p
-00025540: 612e 7570 6c6f 6164 3a0a 2020 2020 2020  a.upload:.      
-00025550: 2020 6669 6c65 6e61 6d65 203d 2066 696c    filename = fil
-00025560: 656e 616d 652e 7374 7269 7028 290a 2020  ename.strip().  
-00025570: 2020 2020 2020 656e 6372 7970 7420 3d20        encrypt = 
-00025580: 4661 6c73 6520 6966 2067 732e 7061 2e70  False if gs.pa.p
-00025590: 6c61 696e 2065 6c73 6520 5472 7565 0a20  lain else True. 
-000255a0: 2020 2020 2020 206d 696d 655f 7479 7065         mime_type
-000255b0: 203d 206d 6167 6963 2e66 726f 6d5f 6669   = magic.from_fi
-000255c0: 6c65 2866 696c 656e 616d 652c 206d 696d  le(filename, mim
-000255d0: 653d 5472 7565 290a 2020 2020 2020 2020  e=True).        
-000255e0: 6669 6c65 5f73 7461 7420 3d20 6177 6169  file_stat = awai
-000255f0: 7420 6169 6f66 696c 6573 2e6f 732e 7374  t aiofiles.os.st
-00025600: 6174 2866 696c 656e 616d 6529 0a20 2020  at(filename).   
-00025610: 2020 2020 2061 7379 6e63 2077 6974 6820       async with 
-00025620: 6169 6f66 696c 6573 2e6f 7065 6e28 6669  aiofiles.open(fi
-00025630: 6c65 6e61 6d65 2c20 2272 2b62 2229 2061  lename, "r+b") a
-00025640: 7320 663a 0a20 2020 2020 2020 2020 2020  s f:.           
-00025650: 2072 6573 702c 2064 6563 7279 7074 696f   resp, decryptio
-00025660: 6e5f 6469 6374 203d 2061 7761 6974 2063  n_dict = await c
-00025670: 6c69 656e 742e 7570 6c6f 6164 280a 2020  lient.upload(.  
-00025680: 2020 2020 2020 2020 2020 2020 2020 662c                f,
-00025690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000256a0: 2063 6f6e 7465 6e74 5f74 7970 653d 6d69   content_type=mi
-000256b0: 6d65 5f74 7970 652c 2020 2320 652e 672e  me_type,  # e.g.
-000256c0: 2061 7070 6c69 6361 7469 6f6e 2f70 6466   application/pdf
-000256d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000256e0: 2066 696c 656e 616d 653d 6f73 2e70 6174   filename=os.pat
-000256f0: 682e 6261 7365 6e61 6d65 2866 696c 656e  h.basename(filen
-00025700: 616d 6529 2c0a 2020 2020 2020 2020 2020  ame),.          
-00025710: 2020 2020 2020 656e 6372 7970 743d 656e        encrypt=en
-00025720: 6372 7970 742c 0a20 2020 2020 2020 2020  crypt,.         
-00025730: 2020 2020 2020 2066 696c 6573 697a 653d         filesize=
-00025740: 6669 6c65 5f73 7461 742e 7374 5f73 697a  file_stat.st_siz
-00025750: 652c 0a20 2020 2020 2020 2020 2020 2029  e,.            )
-00025760: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-00025770: 7374 616e 6365 2872 6573 702c 2055 706c  stance(resp, Upl
-00025780: 6f61 6445 7272 6f72 293a 0a20 2020 2020  oadError):.     
-00025790: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
-000257a0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-000257b0: 2020 2020 2022 4531 3732 3a20 220a 2020       "E172: ".  
-000257c0: 2020 2020 2020 2020 2020 2020 2020 2246                "F
-000257d0: 6169 6c65 6420 746f 2075 706c 6f61 642e  ailed to upload.
-000257e0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-000257f0: 2020 2066 2766 696c 653d 227b 6669 6c65     f'file="{file
-00025800: 6e61 6d65 7d22 3b20 6d69 6d65 5f74 7970  name}"; mime_typ
-00025810: 653d 227b 6d69 6d65 5f74 7970 657d 223b  e="{mime_type}";
-00025820: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00025830: 2020 2066 2266 696c 6573 7369 7a65 3d7b     f"filessize={
-00025840: 6669 6c65 5f73 7461 742e 7374 5f73 697a  file_stat.st_siz
-00025850: 657d 3b20 656e 6372 7970 743d 7b65 6e63  e}; encrypt={enc
-00025860: 7279 7074 7d22 0a20 2020 2020 2020 2020  rypt}".         
-00025870: 2020 2020 2020 2066 2253 6572 7665 7220         f"Server 
-00025880: 7265 7370 6f6e 7365 3a20 7b70 7269 7661  response: {priva
-00025890: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
-000258a0: 7370 2929 7d22 0a20 2020 2020 2020 2020  sp))}".         
-000258b0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-000258c0: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
-000258d0: 2031 0a20 2020 2020 2020 2065 6c73 653a   1.        else:
-000258e0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
-000258f0: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
-00025900: 2020 2020 2020 2020 2020 2066 2246 696c             f"Fil
-00025910: 6520 7b66 696c 656e 616d 657d 2c20 6d69  e {filename}, mi
-00025920: 6d65 3d7b 6d69 6d65 5f74 7970 657d 2c20  me={mime_type}, 
-00025930: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00025940: 2020 6622 7b66 696c 655f 7374 6174 2e73    f"{file_stat.s
-00025950: 745f 7369 7a65 7d20 6279 7465 732c 2065  t_size} bytes, e
-00025960: 6e63 7279 7074 3d7b 656e 6372 7970 747d  ncrypt={encrypt}
-00025970: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00025980: 2020 2022 7761 7320 7375 6363 6573 7366     "was successf
-00025990: 756c 6c79 2075 706c 6f61 6465 6420 746f  ully uploaded to
-000259a0: 2073 6572 7665 722e 2052 6573 706f 6e73   server. Respons
-000259b0: 6520 6973 3a20 220a 2020 2020 2020 2020  e is: ".        
-000259c0: 2020 2020 2020 2020 6622 7b70 7269 7661          f"{priva
-000259d0: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
-000259e0: 7370 2929 7d2e 220a 2020 2020 2020 2020  sp))}.".        
-000259f0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00025a00: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
-00025a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025a20: 6622 5552 4920 6f66 2075 706c 6f61 6465  f"URI of uploade
-00025a30: 6420 6669 6c65 207b 6669 6c65 6e61 6d65  d file {filename
-00025a40: 7d20 6973 3a20 7b72 6573 702e 636f 6e74  } is: {resp.cont
-00025a50: 656e 745f 7572 697d 220a 2020 2020 2020  ent_uri}".      
-00025a60: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00025a70: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-00025a80: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00025a90: 2020 6622 4465 6372 7970 7469 6f6e 206b    f"Decryption k
-00025aa0: 6579 2028 6469 6374 696f 6e61 7279 2920  ey (dictionary) 
-00025ab0: 6f66 2075 706c 6f61 6465 6420 6669 6c65  of uploaded file
-00025ac0: 207b 6669 6c65 6e61 6d65 7d20 6973 3a20   {filename} is: 
-00025ad0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00025ae0: 2020 2227 2a2a 2a20 6869 6464 656e 2074    "'*** hidden t
-00025af0: 6f20 7072 6576 656e 7420 6c65 616b 7327  o prevent leaks'
-00025b00: 2220 2023 2066 227b 6465 6372 7970 7469  "  # f"{decrypti
-00025b10: 6f6e 5f64 6963 747d 220a 2020 2020 2020  on_dict}".      
-00025b20: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00025b30: 2020 2020 2320 6465 6372 7970 7469 6f6e      # decryption
-00025b40: 5f64 6963 7420 7769 6c6c 2062 6520 4e6f  _dict will be No
-00025b50: 6e65 2069 6e20 6361 7365 206f 6620 706c  ne in case of pl
-00025b60: 6169 6e2d 7465 7874 0a20 2020 2020 2020  ain-text.       
-00025b70: 2020 2020 2023 2074 6865 2055 5249 2061       # the URI a
-00025b80: 6e64 206b 6579 7320 7769 6c6c 2062 6520  nd keys will be 
-00025b90: 6e65 6564 6564 206c 6174 6572 2e20 536f  needed later. So
-00025ba0: 2074 6869 7320 7072 696e 7420 6973 2061   this print is a
-00025bb0: 206d 7573 740a 2020 2020 2020 2020 2020   must.          
-00025bc0: 2020 2320 6f75 7470 7574 2066 6f72 6d61    # output forma
-00025bd0: 7420 636f 6e74 726f 6c6c 6564 2076 6961  t controlled via
-00025be0: 202d 2d6f 7574 7075 7420 666c 6167 0a20   --output flag. 
-00025bf0: 2020 2020 2020 2020 2020 2074 6578 7420             text 
-00025c00: 3d20 6622 7b72 6573 702e 636f 6e74 656e  = f"{resp.conten
-00025c10: 745f 7572 697d 7b53 4550 7d7b 6465 6372  t_uri}{SEP}{decr
-00025c20: 7970 7469 6f6e 5f64 6963 747d 220a 2020  yption_dict}".  
-00025c30: 2020 2020 2020 2020 2020 2320 4f62 6a65            # Obje
-00025c40: 6374 206f 6620 7479 7065 2078 7878 5265  ct of type xxxRe
-00025c50: 7370 6f6e 7365 2069 7320 6e6f 7420 4a53  sponse is not JS
-00025c60: 4f4e 0a20 2020 2020 2020 2020 2020 2023  ON.            #
-00025c70: 2073 6572 6961 6c69 7a61 626c 652c 2068   serializable, h
-00025c80: 656e 6365 2077 6520 7573 6520 7468 6520  ence we use the 
-00025c90: 6469 6374 696f 6e61 7279 2e0a 2020 2020  dictionary..    
-00025ca0: 2020 2020 2020 2020 6a73 6f6e 5f6d 6178          json_max
-00025cb0: 203d 2072 6573 702e 5f5f 6469 6374 5f5f   = resp.__dict__
-00025cc0: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
-00025cd0: 6e5f 6d61 782e 7570 6461 7465 280a 2020  n_max.update(.  
-00025ce0: 2020 2020 2020 2020 2020 2020 2020 7b22                {"
-00025cf0: 6465 6372 7970 7469 6f6e 5f64 6963 7422  decryption_dict"
-00025d00: 3a20 6465 6372 7970 7469 6f6e 5f64 6963  : decryption_dic
-00025d10: 747d 0a20 2020 2020 2020 2020 2020 2029  t}.            )
-00025d20: 2020 2320 6164 6420 6469 6374 2069 7465    # add dict ite
-00025d30: 6d73 0a20 2020 2020 2020 2020 2020 206a  ms.            j
-00025d40: 736f 6e5f 203d 206a 736f 6e5f 6d61 782e  son_ = json_max.
-00025d50: 636f 7079 2829 0a20 2020 2020 2020 2020  copy().         
-00025d60: 2020 206a 736f 6e5f 2e70 6f70 2822 7472     json_.pop("tr
-00025d70: 616e 7370 6f72 745f 7265 7370 6f6e 7365  ansport_response
-00025d80: 2229 0a20 2020 2020 2020 2020 2020 206a  ").            j
-00025d90: 736f 6e5f 7370 6563 203d 204e 6f6e 650a  son_spec = None.
-00025da0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00025db0: 745f 6f75 7470 7574 280a 2020 2020 2020  t_output(.      
-00025dc0: 2020 2020 2020 2020 2020 6773 2e70 612e            gs.pa.
-00025dd0: 6f75 7470 7574 2c0a 2020 2020 2020 2020  output,.        
-00025de0: 2020 2020 2020 2020 7465 7874 3d74 6578          text=tex
-00025df0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-00025e00: 2020 206a 736f 6e5f 3d6a 736f 6e5f 2c0a     json_=json_,.
-00025e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025e20: 6a73 6f6e 5f6d 6178 3d6a 736f 6e5f 6d61  json_max=json_ma
-00025e30: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-00025e40: 2020 206a 736f 6e5f 7370 6563 3d6a 736f     json_spec=jso
-00025e50: 6e5f 7370 6563 2c0a 2020 2020 2020 2020  n_spec,.        
-00025e60: 2020 2020 290a 0a0a 6173 796e 6320 6465      )...async de
-00025e70: 6620 6163 7469 6f6e 5f64 656c 6574 655f  f action_delete_
-00025e80: 6d78 6328 636c 6965 6e74 3a20 4173 796e  mxc(client: Asyn
-00025e90: 6343 6c69 656e 742c 2063 7265 6465 6e74  cClient, credent
-00025ea0: 6961 6c73 3a20 6469 6374 2920 2d3e 204e  ials: dict) -> N
-00025eb0: 6f6e 653a 0a20 2020 2022 2222 4465 6c65  one:.    """Dele
-00025ec0: 7465 206f 6e65 206f 7220 6d6f 7265 2066  te one or more f
-00025ed0: 696c 6573 2066 726f 6d20 636f 6e74 656e  iles from conten
-00025ee0: 7420 7265 706f 7369 746f 7279 206f 6620  t repository of 
-00025ef0: 4d61 7472 6978 2073 6572 7665 722e 0a20  Matrix server.. 
-00025f00: 2020 2041 7373 756d 6573 2074 6861 7420     Assumes that 
-00025f10: 7573 6572 2069 7320 616c 7265 6164 7920  user is already 
-00025f20: 6c6f 6767 6564 2069 6e2e 0a20 2020 2022  logged in..    "
-00025f30: 2222 0a20 2020 2023 2073 6565 3a20 6874  "".    # see: ht
-00025f40: 7470 733a 2f2f 646f 6373 2e61 696f 6874  tps://docs.aioht
-00025f50: 7470 2e6f 7267 2f65 6e2f 7374 6162 6c65  tp.org/en/stable
-00025f60: 2f63 6c69 656e 745f 7175 6963 6b73 7461  /client_quicksta
-00025f70: 7274 2e68 746d 6c0a 2020 2020 2320 7765  rt.html.    # we
-00025f80: 206d 7573 7420 656d 756c 6174 6520 6120   must emulate a 
-00025f90: 6375 726c 206c 696b 6520 7468 6973 3a0a  curl like this:.
-00025fa0: 2020 2020 2320 6375 726c 202d 5844 454c      # curl -XDEL
-00025fb0: 4554 4520 2022 6874 7470 733a 2f2f 5345  ETE  "https://SE
-00025fc0: 5256 4552 4845 5245 2f5f 7379 6e61 7073  RVERHERE/_synaps
-00025fd0: 652f 6164 6d69 6e2f 7631 2f6d 6564 6961  e/admin/v1/media
-00025fe0: 2f53 4552 5645 5248 4552 452f 0a20 2020  /SERVERHERE/.   
-00025ff0: 2023 2020 2020 2020 4d58 4349 4448 4552   #      MXCIDHER
-00026000: 453f 6163 6365 7373 5f74 6f6b 656e 3d41  E?access_token=A
-00026010: 4343 4553 535f 544f 4b45 4e5f 4845 5245  CCESS_TOKEN_HERE
-00026020: 220a 2020 2020 666f 7220 6d78 6320 696e  ".    for mxc in
-00026030: 2067 732e 7061 2e64 656c 6574 655f 6d78   gs.pa.delete_mx
-00026040: 633a 0a20 2020 2020 2020 206d 7863 203d  c:.        mxc =
-00026050: 206d 7863 2e73 7472 6970 2829 0a20 2020   mxc.strip().   
-00026060: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-00026070: 6728 6622 5072 6570 6172 696e 6720 746f  g(f"Preparing to
-00026080: 2064 656c 6574 6520 4d58 4320 7b6d 7863   delete MXC {mxc
-00026090: 7d2e 2229 0a20 2020 2020 2020 2023 2077  }.").        # w
-000260a0: 6520 616c 6c6f 7720 6d78 6320 746f 2062  e allow mxc to b
-000260b0: 6520 6129 206d 7863 3a2f 2f73 6572 7665  e a) mxc://serve
-000260c0: 722f 6d78 632d 6964 206f 7220 6a75 7374  r/mxc-id or just
-000260d0: 206d 7863 2d69 640a 2020 2020 2020 2020   mxc-id.        
-000260e0: 6966 2075 726c 7061 7273 6528 6d78 6329  if urlparse(mxc)
-000260f0: 2e73 6368 656d 6520 3d3d 2022 6d78 6322  .scheme == "mxc"
-00026100: 3a0a 2020 2020 2020 2020 2020 2020 6d78  :.            mx
-00026110: 6320 3d20 7572 6c70 6172 7365 286d 7863  c = urlparse(mxc
-00026120: 292e 7061 7468 2e72 6570 6c61 6365 2822  ).path.replace("
-00026130: 2f22 2c20 2222 290a 2020 2020 2020 2020  /", "").        
-00026140: 6773 2e6c 6f67 2e64 6562 7567 2866 2250  gs.log.debug(f"P
-00026150: 7265 7061 7269 6e67 2074 6f20 6465 6c65  reparing to dele
-00026160: 7465 204d 5843 2049 4420 7b6d 7863 7d2e  te MXC ID {mxc}.
-00026170: 2229 0a20 2020 2020 2020 2069 6620 6773  ").        if gs
-00026180: 2e70 612e 6163 6365 7373 5f74 6f6b 656e  .pa.access_token
-00026190: 3a0a 2020 2020 2020 2020 2020 2020 6174  :.            at
-000261a0: 203d 2067 732e 7061 2e61 6363 6573 735f   = gs.pa.access_
-000261b0: 746f 6b65 6e0a 2020 2020 2020 2020 2020  token.          
-000261c0: 2020 6773 2e6c 6f67 2e64 6562 7567 2822    gs.log.debug("
-000261d0: 5573 696e 6720 6163 6365 7373 2074 6f6b  Using access tok
-000261e0: 656e 2066 726f 6d20 2d2d 6163 6365 7373  en from --access
-000261f0: 2d74 6f6b 656e 2061 7267 756d 656e 742e  -token argument.
-00026200: 2229 0a20 2020 2020 2020 2065 6c73 653a  ").        else:
-00026210: 0a20 2020 2020 2020 2020 2020 2061 7420  .            at 
-00026220: 3d20 6372 6564 656e 7469 616c 735b 2261  = credentials["a
-00026230: 6363 6573 735f 746f 6b65 6e22 5d0a 2020  ccess_token"].  
-00026240: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-00026250: 2e64 6562 7567 2822 5573 696e 6720 6163  .debug("Using ac
-00026260: 6365 7373 2074 6f6b 656e 2066 726f 6d20  cess token from 
-00026270: 6372 6564 656e 7469 616c 7320 6669 6c65  credentials file
-00026280: 2e22 290a 2020 2020 2020 2020 7372 765f  .").        srv_
-00026290: 6675 6c6c 203d 2063 7265 6465 6e74 6961  full = credentia
-000262a0: 6c73 5b22 686f 6d65 7365 7276 6572 225d  ls["homeserver"]
-000262b0: 2020 2320 6874 7470 733a 2f2f 6578 616d    # https://exam
-000262c0: 706c 652e 6d61 7472 6978 2e6f 7267 0a20  ple.matrix.org. 
-000262d0: 2020 2020 2020 2073 7276 5f68 6f73 7420         srv_host 
-000262e0: 3d20 7572 6c70 6172 7365 2873 7276 5f66  = urlparse(srv_f
-000262f0: 756c 6c29 2e68 6f73 746e 616d 6520 2023  ull).hostname  #
-00026300: 2065 7861 6d70 6c65 2e6d 6174 7269 782e   example.matrix.
-00026310: 6f72 670a 2020 2020 2020 2020 7265 7374  org.        rest
-00026320: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-00026330: 2073 7276 5f66 756c 6c0a 2020 2020 2020   srv_full.      
-00026340: 2020 2020 2020 2b20 222f 5f73 796e 6170        + "/_synap
-00026350: 7365 2f61 646d 696e 2f76 312f 6d65 6469  se/admin/v1/medi
-00026360: 612f 220a 2020 2020 2020 2020 2020 2020  a/".            
-00026370: 2b20 7372 765f 686f 7374 0a20 2020 2020  + srv_host.     
-00026380: 2020 2020 2020 202b 2022 2f22 0a20 2020         + "/".   
-00026390: 2020 2020 2020 2020 202b 206d 7863 0a20           + mxc. 
-000263a0: 2020 2020 2020 2020 2020 202b 2022 3f61             + "?a
-000263b0: 6363 6573 735f 746f 6b65 6e3d 220a 2020  ccess_token=".  
-000263c0: 2020 2020 2020 2020 2020 2b20 6174 0a20            + at. 
-000263d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000263e0: 2067 732e 6c6f 672e 6465 6275 6728 6622   gs.log.debug(f"
-000263f0: 4973 7375 696e 6720 5245 5354 204d 6174  Issuing REST Mat
-00026400: 7269 7820 4150 4920 6361 6c6c 3a20 4445  rix API call: DE
-00026410: 4c45 5445 207b 7265 7374 7d22 290a 2020  LETE {rest}").  
-00026420: 2020 2020 2020 636f 6e6e 6563 746f 7220        connector 
-00026430: 3d20 5443 5043 6f6e 6e65 6374 6f72 2873  = TCPConnector(s
-00026440: 736c 3d67 732e 7373 6c29 2020 2320 7365  sl=gs.ssl)  # se
-00026450: 7474 696e 6720 7373 6c63 6f6e 7465 7874  tting sslcontext
-00026460: 0a20 2020 2020 2020 2061 7379 6e63 2077  .        async w
-00026470: 6974 6820 436c 6965 6e74 5365 7373 696f  ith ClientSessio
-00026480: 6e28 636f 6e6e 6563 746f 723d 636f 6e6e  n(connector=conn
-00026490: 6563 746f 7229 2061 7320 7365 7373 696f  ector) as sessio
-000264a0: 6e3a 2020 2320 6169 6f68 7474 700a 2020  n:  # aiohttp.  
-000264b0: 2020 2020 2020 2020 2020 6173 796e 6320            async 
-000264c0: 7769 7468 2073 6573 7369 6f6e 2e64 656c  with session.del
-000264d0: 6574 6528 7265 7374 2920 6173 2072 6573  ete(rest) as res
-000264e0: 703a 0a20 2020 2020 2020 2020 2020 2020  p:.             
-000264f0: 2020 2073 7461 7475 7320 3d20 7265 7370     status = resp
-00026500: 2e73 7461 7475 7320 2023 2069 6e74 2c20  .status  # int, 
-00026510: 3230 3020 7375 6363 6573 730a 2020 2020  200 success.    
-00026520: 2020 2020 2020 2020 2020 2020 7478 7420              txt 
-00026530: 3d20 6177 6169 7420 7265 7370 2e74 6578  = await resp.tex
-00026540: 7428 2920 2023 2073 7472 2069 6e20 6469  t()  # str in di
-00026550: 6374 2066 6f72 6d61 740a 2020 2020 2020  ct format.      
-00026560: 2020 6966 2073 7461 7475 7320 213d 2032    if status != 2
-00026570: 3030 3a0a 2020 2020 2020 2020 2020 2020  00:.            
-00026580: 2320 7478 7420 6973 2073 7472 206c 696b  # txt is str lik
-00026590: 6520 7468 6973 3a0a 2020 2020 2020 2020  e this:.        
-000265a0: 2020 2020 2320 7b22 6572 7263 6f64 6522      # {"errcode"
-000265b0: 3a22 4d5f 464f 5242 4944 4445 4e22 2c22  :"M_FORBIDDEN","
-000265c0: 6572 726f 7222 3a22 596f 7520 6172 6520  error":"You are 
-000265d0: 6e6f 7420 6120 7365 7276 6572 2061 646d  not a server adm
-000265e0: 696e 227d 0a20 2020 2020 2020 2020 2020  in"}.           
-000265f0: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
-00026600: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00026610: 4531 3733 3a20 220a 2020 2020 2020 2020  E173: ".        
-00026620: 2020 2020 2020 2020 6622 4661 696c 6564          f"Failed
-00026630: 2074 6f20 6465 6c65 7465 206f 626a 6563   to delete objec
-00026640: 7420 286d 7863 2920 277b 6d78 637d 2720  t (mxc) '{mxc}' 
-00026650: 6672 6f6d 2073 6572 7665 7220 220a 2020  from server ".  
-00026660: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00026670: 277b 7372 765f 6675 6c6c 7d27 2e20 4661  '{srv_full}'. Fa
-00026680: 696c 6564 2077 6974 6820 6572 726f 7220  iled with error 
-00026690: 636f 6465 207b 7374 6174 7573 7d20 616e  code {status} an
-000266a0: 6420 220a 2020 2020 2020 2020 2020 2020  d ".            
-000266b0: 2020 2020 6622 6572 726f 7220 7465 7874      f"error text
-000266c0: 207b 7478 747d 2e22 0a20 2020 2020 2020   {txt}.".       
-000266d0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-000266e0: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
-000266f0: 2b3d 2031 0a20 2020 2020 2020 2065 6c73  += 1.        els
-00026700: 653a 0a20 2020 2020 2020 2020 2020 2067  e:.            g
-00026710: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
-00026720: 2020 2020 2020 2020 2020 2020 2066 224d               f"M
-00026730: 5843 206f 626a 6563 7420 7b6d 7863 7d20  XC object {mxc} 
-00026740: 7761 7320 7375 6363 6573 7366 756c 6c79  was successfully
-00026750: 2064 656c 6574 6564 2066 726f 6d20 7365   deleted from se
-00026760: 7276 6572 2022 0a20 2020 2020 2020 2020  rver ".         
-00026770: 2020 2020 2020 2066 227b 7372 765f 6675         f"{srv_fu
-00026780: 6c6c 7d2e 2052 6573 706f 6e73 6520 6973  ll}. Response is
-00026790: 3a20 7b74 7874 7d2e 220a 2020 2020 2020  : {txt}.".      
-000267a0: 2020 2020 2020 290a 0a0a 6173 796e 6320        )...async 
-000267b0: 6465 6620 6163 7469 6f6e 5f64 656c 6574  def action_delet
-000267c0: 655f 6d78 635f 6265 666f 7265 280a 2020  e_mxc_before(.  
-000267d0: 2020 636c 6965 6e74 3a20 4173 796e 6343    client: AsyncC
-000267e0: 6c69 656e 742c 2063 7265 6465 6e74 6961  lient, credentia
-000267f0: 6c73 3a20 6469 6374 0a29 202d 3e20 4e6f  ls: dict.) -> No
-00026800: 6e65 3a0a 2020 2020 2222 2244 656c 6574  ne:.    """Delet
-00026810: 6520 6669 6c65 7320 6f6c 6465 7220 616e  e files older an
-00026820: 6420 6c61 7267 6572 2066 726f 6d20 636f  d larger from co
-00026830: 6e74 656e 7420 7265 706f 7369 746f 7279  ntent repository
-00026840: 206f 6620 4d61 7472 6978 2073 6572 7665   of Matrix serve
-00026850: 722e 0a20 2020 2041 7373 756d 6573 2074  r..    Assumes t
-00026860: 6861 7420 7573 6572 2069 7320 616c 7265  hat user is alre
-00026870: 6164 7920 6c6f 6767 6564 2069 6e2e 0a20  ady logged in.. 
-00026880: 2020 2022 2222 0a20 2020 2023 2068 7474     """.    # htt
-00026890: 7073 3a2f 2f6d 6174 7269 782d 6f72 672e  ps://matrix-org.
-000268a0: 6769 7468 7562 2e69 6f2f 7379 6e61 7073  github.io/synaps
-000268b0: 652f 6c61 7465 7374 2f61 646d 696e 5f61  e/latest/admin_a
-000268c0: 7069 2f0a 2020 2020 2320 2020 6d65 6469  pi/.    #   medi
-000268d0: 615f 6164 6d69 6e5f 6170 692e 6874 6d6c  a_admin_api.html
-000268e0: 2364 656c 6574 652d 6c6f 6361 6c2d 6d65  #delete-local-me
-000268f0: 6469 612d 6279 2d64 6174 652d 6f72 2d73  dia-by-date-or-s
-00026900: 697a 650a 2020 2020 2320 504f 5354 202f  ize.    # POST /
-00026910: 5f73 796e 6170 7365 2f61 646d 696e 2f76  _synapse/admin/v
-00026920: 312f 6d65 6469 612f 3c73 6572 7665 725f  1/media/<server_
-00026930: 6e61 6d65 3e2f 6465 6c65 7465 3f62 6566  name>/delete?bef
-00026940: 6f72 655f 7473 3d3c 6265 666f 7265 5f74  ore_ts=<before_t
-00026950: 733e 0a20 2020 2023 2026 7369 7a65 5f67  s>.    # &size_g
-00026960: 743d 3c73 697a 653e 0a20 2020 2069 6620  t=<size>.    if 
-00026970: 6c65 6e28 6773 2e70 612e 6465 6c65 7465  len(gs.pa.delete
-00026980: 5f6d 7863 5f62 6566 6f72 6529 203e 2032  _mxc_before) > 2
-00026990: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
-000269a0: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
-000269b0: 2020 2020 2245 3137 343a 2022 0a20 2020      "E174: ".   
-000269c0: 2020 2020 2020 2020 2022 496e 636f 7272           "Incorr
-000269d0: 6563 7420 6e75 6d62 6572 206f 6620 6172  ect number of ar
-000269e0: 6775 6d65 6e74 7320 666f 7220 2d2d 6465  guments for --de
-000269f0: 6c65 7465 5f6d 7863 5f62 6566 6f72 652e  lete_mxc_before.
-00026a00: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-00026a10: 5468 6572 6520 6d75 7374 2062 6520 3120  There must be 1 
-00026a20: 6f72 2032 2061 7267 756d 656e 7473 202c  or 2 arguments ,
-00026a30: 2062 7574 2066 6f75 6e64 2022 0a20 2020   but found ".   
-00026a40: 2020 2020 2020 2020 2066 227b 6c65 6e28           f"{len(
-00026a50: 6773 2e70 612e 6465 6c65 7465 5f6d 7863  gs.pa.delete_mxc
-00026a60: 5f62 6566 6f72 6529 7d20 6172 6775 6d65  _before)} argume
-00026a70: 6e74 732e 220a 2020 2020 2020 2020 290a  nts.".        ).
-00026a80: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
-00026a90: 6f75 6e74 202b 3d20 310a 2020 2020 2020  ount += 1.      
-00026aa0: 2020 7265 7475 726e 0a20 2020 2073 697a    return.    siz
-00026ab0: 6520 3d20 300a 2020 2020 6966 206c 656e  e = 0.    if len
-00026ac0: 2867 732e 7061 2e64 656c 6574 655f 6d78  (gs.pa.delete_mx
-00026ad0: 635f 6265 666f 7265 2920 3d3d 2032 3a0a  c_before) == 2:.
-00026ae0: 2020 2020 2020 2020 7369 7a65 203d 2067          size = g
-00026af0: 732e 7061 2e64 656c 6574 655f 6d78 635f  s.pa.delete_mxc_
-00026b00: 6265 666f 7265 5b31 5d0a 2020 2020 6265  before[1].    be
-00026b10: 666f 7265 5f73 7472 203d 2067 732e 7061  fore_str = gs.pa
-00026b20: 2e64 656c 6574 655f 6d78 635f 6265 666f  .delete_mxc_befo
-00026b30: 7265 5b30 5d0a 2020 2020 6d69 6c6c 6973  re[0].    millis
-00026b40: 6563 203d 2069 6e74 280a 2020 2020 2020  ec = int(.      
-00026b50: 2020 6461 7465 7469 6d65 2e64 6174 6574    datetime.datet
-00026b60: 696d 652e 7374 7270 7469 6d65 2862 6566  ime.strptime(bef
-00026b70: 6f72 655f 7374 722c 2022 2564 2e25 6d2e  ore_str, "%d.%m.
-00026b80: 2559 2025 483a 254d 3a25 5322 292e 7469  %Y %H:%M:%S").ti
-00026b90: 6d65 7374 616d 7028 290a 2020 2020 2020  mestamp().      
-00026ba0: 2020 2a20 3130 3030 0a20 2020 2029 0a0a    * 1000.    )..
-00026bb0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-00026bc0: 280a 2020 2020 2020 2020 6622 5072 6570  (.        f"Prep
-00026bd0: 6172 696e 6720 746f 2064 656c 6574 6520  aring to delete 
-00026be0: 6f62 6a65 6374 7320 6f6c 6465 7220 7468  objects older th
-00026bf0: 616e 207b 6265 666f 7265 5f73 7472 7d20  an {before_str} 
-00026c00: 220a 2020 2020 2020 2020 6622 2855 6e69  ".        f"(Uni
-00026c10: 7820 7469 6d65 207b 6d69 6c6c 6973 6563  x time {millisec
-00026c20: 7d29 2061 6e64 206c 6172 6765 7220 7468  }) and larger th
-00026c30: 616e 207b 7369 7a65 7d2e 220a 2020 2020  an {size}.".    
-00026c40: 290a 2020 2020 6966 2067 732e 7061 2e61  ).    if gs.pa.a
-00026c50: 6363 6573 735f 746f 6b65 6e3a 0a20 2020  ccess_token:.   
-00026c60: 2020 2020 2061 7420 3d20 6773 2e70 612e       at = gs.pa.
-00026c70: 6163 6365 7373 5f74 6f6b 656e 0a20 2020  access_token.   
-00026c80: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-00026c90: 6728 2255 7369 6e67 2061 6363 6573 7320  g("Using access 
-00026ca0: 746f 6b65 6e20 6672 6f6d 202d 2d61 6363  token from --acc
-00026cb0: 6573 732d 746f 6b65 6e20 6172 6775 6d65  ess-token argume
-00026cc0: 6e74 2e22 290a 2020 2020 656c 7365 3a0a  nt.").    else:.
-00026cd0: 2020 2020 2020 2020 6174 203d 2063 7265          at = cre
-00026ce0: 6465 6e74 6961 6c73 5b22 6163 6365 7373  dentials["access
-00026cf0: 5f74 6f6b 656e 225d 0a20 2020 2020 2020  _token"].       
-00026d00: 2067 732e 6c6f 672e 6465 6275 6728 2255   gs.log.debug("U
-00026d10: 7369 6e67 2061 6363 6573 7320 746f 6b65  sing access toke
-00026d20: 6e20 6672 6f6d 2063 7265 6465 6e74 6961  n from credentia
-00026d30: 6c73 2066 696c 652e 2229 0a20 2020 2073  ls file.").    s
-00026d40: 7276 5f66 756c 6c20 3d20 6372 6564 656e  rv_full = creden
-00026d50: 7469 616c 735b 2268 6f6d 6573 6572 7665  tials["homeserve
-00026d60: 7222 5d20 2023 2068 7474 7073 3a2f 2f65  r"]  # https://e
-00026d70: 7861 6d70 6c65 2e6d 6174 7269 782e 6f72  xample.matrix.or
-00026d80: 670a 2020 2020 7372 765f 686f 7374 203d  g.    srv_host =
-00026d90: 2075 726c 7061 7273 6528 7372 765f 6675   urlparse(srv_fu
-00026da0: 6c6c 292e 686f 7374 6e61 6d65 2020 2320  ll).hostname  # 
-00026db0: 6578 616d 706c 652e 6d61 7472 6978 2e6f  example.matrix.o
-00026dc0: 7267 0a20 2020 2072 6573 7420 3d20 280a  rg.    rest = (.
-00026dd0: 2020 2020 2020 2020 7372 765f 6675 6c6c          srv_full
-00026de0: 0a20 2020 2020 2020 202b 2022 2f5f 7379  .        + "/_sy
-00026df0: 6e61 7073 652f 6164 6d69 6e2f 7631 2f6d  napse/admin/v1/m
-00026e00: 6564 6961 2f22 0a20 2020 2020 2020 202b  edia/".        +
-00026e10: 2073 7276 5f68 6f73 740a 2020 2020 2020   srv_host.      
-00026e20: 2020 2b20 222f 6465 6c65 7465 3f62 6566    + "/delete?bef
-00026e30: 6f72 655f 7473 3d22 0a20 2020 2020 2020  ore_ts=".       
-00026e40: 202b 2073 7472 286d 696c 6c69 7365 6329   + str(millisec)
-00026e50: 0a20 2020 2020 2020 202b 2022 2673 697a  .        + "&siz
-00026e60: 655f 6774 3d22 0a20 2020 2020 2020 202b  e_gt=".        +
-00026e70: 2073 7472 2873 697a 6529 0a20 2020 2020   str(size).     
-00026e80: 2020 202b 2022 2661 6363 6573 735f 746f     + "&access_to
-00026e90: 6b65 6e3d 220a 2020 2020 2020 2020 2b20  ken=".        + 
-00026ea0: 6174 0a20 2020 2029 0a20 2020 2067 732e  at.    ).    gs.
-00026eb0: 6c6f 672e 6465 6275 6728 6622 4973 7375  log.debug(f"Issu
-00026ec0: 696e 6720 5245 5354 204d 6174 7269 7820  ing REST Matrix 
-00026ed0: 4150 4920 6361 6c6c 3a20 504f 5354 207b  API call: POST {
-00026ee0: 7265 7374 7d22 290a 2020 2020 636f 6e6e  rest}").    conn
-00026ef0: 6563 746f 7220 3d20 5443 5043 6f6e 6e65  ector = TCPConne
-00026f00: 6374 6f72 2873 736c 3d67 732e 7373 6c29  ctor(ssl=gs.ssl)
-00026f10: 2020 2320 7365 7474 696e 6720 7373 6c63    # setting sslc
-00026f20: 6f6e 7465 7874 0a20 2020 2061 7379 6e63  ontext.    async
-00026f30: 2077 6974 6820 436c 6965 6e74 5365 7373   with ClientSess
-00026f40: 696f 6e28 636f 6e6e 6563 746f 723d 636f  ion(connector=co
-00026f50: 6e6e 6563 746f 7229 2061 7320 7365 7373  nnector) as sess
-00026f60: 696f 6e3a 2020 2320 6169 6f68 7474 700a  ion:  # aiohttp.
-00026f70: 2020 2020 2020 2020 6173 796e 6320 7769          async wi
-00026f80: 7468 2073 6573 7369 6f6e 2e70 6f73 7428  th session.post(
-00026f90: 7265 7374 2920 6173 2072 6573 703a 0a20  rest) as resp:. 
-00026fa0: 2020 2020 2020 2020 2020 2073 7461 7475             statu
-00026fb0: 7320 3d20 7265 7370 2e73 7461 7475 7320  s = resp.status 
-00026fc0: 2023 2069 6e74 2c20 3230 3020 7375 6363   # int, 200 succ
-00026fd0: 6573 730a 2020 2020 2020 2020 2020 2020  ess.            
-00026fe0: 7478 7420 3d20 6177 6169 7420 7265 7370  txt = await resp
-00026ff0: 2e74 6578 7428 2920 2023 2073 7472 2069  .text()  # str i
-00027000: 6e20 6469 6374 2066 6f72 6d61 740a 2020  n dict format.  
-00027010: 2020 6966 2073 7461 7475 7320 213d 2032    if status != 2
-00027020: 3030 3a0a 2020 2020 2020 2020 2320 7478  00:.        # tx
-00027030: 7420 6973 2073 7472 206c 696b 6520 7468  t is str like th
-00027040: 6973 3a0a 2020 2020 2020 2020 2320 7b22  is:.        # {"
-00027050: 6572 7263 6f64 6522 3a22 4d5f 464f 5242  errcode":"M_FORB
-00027060: 4944 4445 4e22 2c22 6572 726f 7222 3a22  IDDEN","error":"
-00027070: 596f 7520 6172 6520 6e6f 7420 6120 7365  You are not a se
-00027080: 7276 6572 2061 646d 696e 227d 0a20 2020  rver admin"}.   
-00027090: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
-000270a0: 7228 0a20 2020 2020 2020 2020 2020 2022  r(.            "
-000270b0: 4531 3735 3a20 220a 2020 2020 2020 2020  E175: ".        
-000270c0: 2020 2020 6622 4661 696c 6564 2074 6f20      f"Failed to 
-000270d0: 6465 6c65 7465 206f 626a 6563 7473 2062  delete objects b
-000270e0: 6566 6f72 6520 277b 6265 666f 7265 5f73  efore '{before_s
-000270f0: 7472 7d27 2066 726f 6d20 7365 7276 6572  tr}' from server
-00027100: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
-00027110: 2227 7b73 7276 5f66 756c 6c7d 272e 2046  "'{srv_full}'. F
-00027120: 6169 6c65 6420 7769 7468 2065 7272 6f72  ailed with error
-00027130: 2063 6f64 6520 7b73 7461 7475 737d 2061   code {status} a
-00027140: 6e64 2022 0a20 2020 2020 2020 2020 2020  nd ".           
-00027150: 2066 2265 7272 6f72 2074 6578 7420 7b74   f"error text {t
-00027160: 7874 7d2e 220a 2020 2020 2020 2020 290a  xt}.".        ).
-00027170: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
-00027180: 6f75 6e74 202b 3d20 310a 2020 2020 656c  ount += 1.    el
-00027190: 7365 3a0a 2020 2020 2020 2020 6773 2e6c  se:.        gs.l
-000271a0: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
-000271b0: 2020 2020 2020 6622 4f62 6a65 6374 7320        f"Objects 
-000271c0: 6f6c 6465 7220 7468 616e 207b 6265 666f  older than {befo
-000271d0: 7265 5f73 7472 7d20 616e 6420 6c61 7267  re_str} and larg
-000271e0: 6572 2074 6861 6e20 7b73 697a 657d 2022  er than {size} "
-000271f0: 0a20 2020 2020 2020 2020 2020 2022 7765  .            "we
-00027200: 7265 2073 7563 6365 7373 6675 6c6c 7920  re successfully 
-00027210: 6465 6c65 7465 6420 6672 6f6d 2073 6572  deleted from ser
-00027220: 7665 7220 220a 2020 2020 2020 2020 2020  ver ".          
-00027230: 2020 6622 7b73 7276 5f66 756c 6c7d 2e20    f"{srv_full}. 
-00027240: 5265 7370 6f6e 7365 2069 733a 205c 6e7b  Response is: \n{
-00027250: 7478 747d 2e22 0a20 2020 2020 2020 2029  txt}.".        )
-00027260: 0a0a 0a61 7379 6e63 2064 6566 2061 6374  ...async def act
-00027270: 696f 6e5f 646f 776e 6c6f 6164 2863 6c69  ion_download(cli
-00027280: 656e 743a 2041 7379 6e63 436c 6965 6e74  ent: AsyncClient
-00027290: 2c20 6372 6564 656e 7469 616c 733a 2064  , credentials: d
-000272a0: 6963 7429 202d 3e20 4e6f 6e65 3a0a 2020  ict) -> None:.  
-000272b0: 2020 2222 2244 6f77 6e6c 6f61 6420 6120    """Download a 
-000272c0: 6669 6c65 2066 726f 6d20 636f 6e74 656e  file from conten
-000272d0: 7420 7265 706f 7369 746f 7279 206f 6620  t repository of 
-000272e0: 4d61 7472 6978 2073 6572 7665 722e 0a20  Matrix server.. 
-000272f0: 2020 2041 7373 756d 6573 2074 6861 7420     Assumes that 
-00027300: 7573 6572 2069 7320 616c 7265 6164 7920  user is already 
-00027310: 6c6f 6767 6564 2069 6e2e 0a20 2020 2022  logged in..    "
-00027320: 2222 0a20 2020 2069 6620 6e6f 7420 6773  "".    if not gs
-00027330: 2e70 612e 646f 776e 6c6f 6164 3a0a 2020  .pa.download:.  
-00027340: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-00027350: 7567 2822 446f 776e 6c6f 6164 206c 6973  ug("Download lis
-00027360: 7420 6973 2065 6d70 7479 2e20 4e6f 7468  t is empty. Noth
-00027370: 696e 6720 746f 2064 6f77 6e6c 6f61 642e  ing to download.
-00027380: 2053 6b69 7070 696e 672e 2229 0a20 2020   Skipping.").   
-00027390: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
-000273a0: 6669 6c65 6e61 6d65 7320 3d20 6773 2e70  filenames = gs.p
-000273b0: 612e 6669 6c65 5f6e 616d 650a 2020 2020  a.file_name.    
-000273c0: 6966 2066 696c 656e 616d 6573 3a0a 2020  if filenames:.  
-000273d0: 2020 2020 2020 7768 696c 6520 6c65 6e28        while len(
-000273e0: 6669 6c65 6e61 6d65 7329 203c 206c 656e  filenames) < len
-000273f0: 2867 732e 7061 2e64 6f77 6e6c 6f61 6429  (gs.pa.download)
-00027400: 3a0a 2020 2020 2020 2020 2020 2020 6669  :.            fi
-00027410: 6c65 6e61 6d65 732e 6170 7065 6e64 284e  lenames.append(N
-00027420: 6f6e 6529 0a20 2020 2064 6563 7279 7074  one).    decrypt
-00027430: 696f 6e5f 7374 7269 6e67 7320 3d20 6773  ion_strings = gs
-00027440: 2e70 612e 6b65 795f 6469 6374 0a20 2020  .pa.key_dict.   
-00027450: 2069 6620 6465 6372 7970 7469 6f6e 5f73   if decryption_s
-00027460: 7472 696e 6773 3a0a 2020 2020 2020 2020  trings:.        
-00027470: 7768 696c 6520 6c65 6e28 6465 6372 7970  while len(decryp
-00027480: 7469 6f6e 5f73 7472 696e 6773 2920 3c20  tion_strings) < 
-00027490: 6c65 6e28 6773 2e70 612e 6b65 795f 6469  len(gs.pa.key_di
-000274a0: 6374 293a 0a20 2020 2020 2020 2020 2020  ct):.           
-000274b0: 2064 6563 7279 7074 696f 6e5f 7374 7269   decryption_stri
-000274c0: 6e67 732e 6170 7065 6e64 284e 6f6e 6529  ngs.append(None)
-000274d0: 0a20 2020 2023 2066 696c 656e 616d 6573  .    # filenames
-000274e0: 2069 7320 6e6f 7720 4e6f 6e65 206f 7220   is now None or 
-000274f0: 6c69 7374 2061 7420 6c65 6173 7420 6173  list at least as
-00027500: 206c 6f6e 6720 6173 2064 6f77 6e6c 6f61   long as downloa
-00027510: 6473 0a20 2020 2023 2064 6563 7279 7074  ds.    # decrypt
-00027520: 696f 6e5f 7374 7269 6e67 7320 6973 206e  ion_strings is n
-00027530: 6f77 204e 6f6e 6520 6f72 206c 6973 7420  ow None or list 
-00027540: 6174 206c 6561 7374 2061 7320 6c6f 6e67  at least as long
-00027550: 2061 7320 646f 776e 6c6f 6164 730a 2020   as downloads.  
-00027560: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
-00027570: 2246 696c 6520 6e61 6d65 7320 7072 6f76  "File names prov
-00027580: 6964 6564 2069 6e20 6172 6775 6d65 6e74  ided in argument
-00027590: 733a 207b 6669 6c65 6e61 6d65 737d 2229  s: {filenames}")
-000275a0: 0a20 2020 2067 732e 6c6f 672e 6465 6275  .    gs.log.debu
-000275b0: 6728 0a20 2020 2020 2020 2022 4465 6372  g(.        "Decr
-000275c0: 7970 7469 6f6e 2073 7472 696e 6773 2070  yption strings p
-000275d0: 726f 7669 6465 6420 696e 2061 7267 756d  rovided in argum
-000275e0: 656e 7473 3a20 220a 2020 2020 2020 2020  ents: ".        
-000275f0: 2227 2a2a 2a20 6869 6464 656e 2074 6f20  "'*** hidden to 
-00027600: 7072 6576 656e 7420 6c65 616b 7327 220a  prevent leaks'".
-00027610: 2020 2020 2020 2020 2320 6622 7b64 6563          # f"{dec
-00027620: 7279 7074 696f 6e5f 7374 7269 6e67 737d  ryption_strings}
-00027630: 220a 2020 2020 290a 2020 2020 6969 203d  ".    ).    ii =
-00027640: 2030 0a20 2020 2066 6f72 2064 6f77 6e6c   0.    for downl
-00027650: 6f61 6420 696e 2067 732e 7061 2e64 6f77  oad in gs.pa.dow
-00027660: 6e6c 6f61 643a 0a20 2020 2020 2020 2069  nload:.        i
-00027670: 6620 6773 2e70 612e 6669 6c65 5f6e 616d  f gs.pa.file_nam
-00027680: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
-00027690: 696c 656e 616d 6520 3d20 6669 6c65 6e61  ilename = filena
-000276a0: 6d65 735b 6969 5d20 2023 2031 7374 2063  mes[ii]  # 1st c
-000276b0: 686f 6963 650a 2020 2020 2020 2020 656c  hoice.        el
-000276c0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000276d0: 2320 326e 6420 6368 6f69 6365 3b20 6765  # 2nd choice; ge
-000276e0: 7420 6669 6c65 6e61 6d65 2066 726f 6d20  t filename from 
-000276f0: 7365 7276 6572 0a20 2020 2020 2020 2020  server.         
-00027700: 2020 2023 2069 2e65 2e20 7573 6520 7468     # i.e. use th
-00027710: 6520 6f72 6967 696e 616c 2066 696c 656e  e original filen
-00027720: 616d 6520 6672 6f6d 2075 706c 6f61 640a  ame from upload.
-00027730: 2020 2020 2020 2020 2020 2020 6669 6c65              file
-00027740: 6e61 6d65 203d 204e 6f6e 650a 2020 2020  name = None.    
-00027750: 2020 2020 6966 2067 732e 7061 2e6b 6579      if gs.pa.key
-00027760: 5f64 6963 743a 0a20 2020 2020 2020 2020  _dict:.         
-00027770: 2020 2064 6563 7279 7074 696f 6e5f 7374     decryption_st
-00027780: 7220 3d20 6465 6372 7970 7469 6f6e 5f73  r = decryption_s
-00027790: 7472 696e 6773 5b69 695d 0a20 2020 2020  trings[ii].     
-000277a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000277b0: 2020 2020 2064 6563 7279 7074 696f 6e5f       decryption_
-000277c0: 7374 7220 3d20 4e6f 6e65 0a20 2020 2020  str = None.     
-000277d0: 2020 2065 6e63 7279 7074 6564 203d 2054     encrypted = T
-000277e0: 7275 6520 6966 2064 6563 7279 7074 696f  rue if decryptio
-000277f0: 6e5f 7374 7220 656c 7365 2046 616c 7365  n_str else False
-00027800: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00027810: 656e 6372 7970 7465 643a 0a20 2020 2020  encrypted:.     
-00027820: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-00027830: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
-00027840: 2020 2020 2022 4e6f 206b 6579 2064 6963       "No key dic
-00027850: 7469 6f6e 6172 7920 7370 6563 6966 6965  tionary specifie
-00027860: 6420 7769 7468 202d 2d6b 6579 2d64 6963  d with --key-dic
-00027870: 742e 2053 6f2c 2069 7420 6973 2022 0a20  t. So, it is ". 
-00027880: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00027890: 6173 7375 6d65 6420 7468 6174 2074 6865  assumed that the
-000278a0: 2064 6f77 6e6c 6f61 6420 6973 206e 6f74   download is not
-000278b0: 2065 6e63 7279 7074 6564 2022 0a20 2020   encrypted ".   
-000278c0: 2020 2020 2020 2020 2020 2020 2022 2869               "(i
-000278d0: 2e65 2e20 706c 6169 6e2d 7465 7874 292e  .e. plain-text).
-000278e0: 204e 6f20 6465 6372 7970 7469 6f6e 2077   No decryption w
-000278f0: 696c 6c20 6265 2061 7474 656d 7074 6564  ill be attempted
-00027900: 2e22 0a20 2020 2020 2020 2020 2020 2029  .".            )
-00027910: 0a20 2020 2020 2020 206d 7863 203d 2064  .        mxc = d
-00027920: 6f77 6e6c 6f61 640a 2020 2020 2020 2020  ownload.        
-00027930: 7265 7370 203d 2061 7761 6974 2064 6f77  resp = await dow
-00027940: 6e6c 6f61 645f 6d78 6328 636c 6965 6e74  nload_mxc(client
-00027950: 2c20 6d78 633d 6d78 632c 2066 696c 656e  , mxc=mxc, filen
-00027960: 616d 653d 6669 6c65 6e61 6d65 290a 2020  ame=filename).  
-00027970: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00027980: 6e63 6528 7265 7370 2c20 446f 776e 6c6f  nce(resp, Downlo
-00027990: 6164 4572 726f 7229 3a0a 2020 2020 2020  adError):.      
-000279a0: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
-000279b0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-000279c0: 2020 2020 2245 3137 363a 2022 0a20 2020      "E176: ".   
-000279d0: 2020 2020 2020 2020 2020 2020 2066 2264               f"d
-000279e0: 6f77 6e6c 6f61 6420 6f66 2055 5249 2027  ownload of URI '
-000279f0: 7b6d 7863 7d27 2074 6f20 6c6f 6361 6c20  {mxc}' to local 
-00027a00: 6669 6c65 2027 7b66 696c 656e 616d 657d  file '{filename}
-00027a10: 2720 220a 2020 2020 2020 2020 2020 2020  ' ".            
-00027a20: 2020 2020 6622 6661 696c 6564 2077 6974      f"failed wit
-00027a30: 6820 7265 7370 6f6e 7365 207b 7072 6976  h response {priv
-00027a40: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
-00027a50: 6573 7029 297d 220a 2020 2020 2020 2020  esp))}".        
-00027a60: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00027a70: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
-00027a80: 3d20 310a 2020 2020 2020 2020 656c 7365  = 1.        else
-00027a90: 3a0a 2020 2020 2020 2020 2020 2020 7572  :.            ur
-00027aa0: 6c20 3d20 7572 6c70 6172 7365 286d 7863  l = urlparse(mxc
-00027ab0: 290a 2020 2020 2020 2020 2020 2020 6d65  ).            me
-00027ac0: 6469 615f 6964 203d 2075 726c 2e70 6174  dia_id = url.pat
-00027ad0: 682e 7374 7269 7028 222f 2229 0a20 2020  h.strip("/").   
-00027ae0: 2020 2020 2020 2020 2069 6620 6669 6c65           if file
-00027af0: 6e61 6d65 203d 3d20 2222 3a0a 2020 2020  name == "":.    
-00027b00: 2020 2020 2020 2020 2020 2020 6669 6c65              file
-00027b10: 6e61 6d65 203d 2022 6d78 632d 2220 2b20  name = "mxc-" + 
-00027b20: 4d58 435f 4944 5f50 4c41 4345 484f 4c44  MXC_ID_PLACEHOLD
-00027b30: 4552 0a20 2020 2020 2020 2020 2020 2069  ER.            i
-00027b40: 6620 6e6f 7420 6669 6c65 6e61 6d65 3a0a  f not filename:.
-00027b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027b60: 6669 6c65 6e61 6d65 203d 2072 6573 702e  filename = resp.
-00027b70: 6669 6c65 6e61 6d65 2020 2320 326e 6420  filename  # 2nd 
-00027b80: 6368 6f69 6365 2c20 6672 6f6d 2073 6572  choice, from ser
-00027b90: 7665 720a 2020 2020 2020 2020 2020 2020  ver.            
-00027ba0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-00027bb0: 2866 2246 696c 6520 6e61 6d65 206f 6e20  (f"File name on 
-00027bc0: 7365 7276 6572 3a20 7b66 696c 656e 616d  server: {filenam
-00027bd0: 6573 7d22 290a 2020 2020 2020 2020 2020  es}").          
-00027be0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00027bf0: 2020 2020 2020 2020 6669 6c65 6e61 6d65          filename
-00027c00: 203d 2066 696c 656e 616d 652e 7265 706c   = filename.repl
-00027c10: 6163 6528 4d58 435f 4944 5f50 4c41 4345  ace(MXC_ID_PLACE
-00027c20: 484f 4c44 4552 2c20 6d65 6469 615f 6964  HOLDER, media_id
-00027c30: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00027c40: 206e 6f74 2066 696c 656e 616d 653a 0a20   not filename:. 
-00027c50: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00027c60: 696c 656e 616d 6520 3d20 226d 7863 2d22  ilename = "mxc-"
-00027c70: 202b 206d 6564 6961 5f69 6420 2023 2033   + media_id  # 3
-00027c80: 7264 2063 686f 6963 652c 206d 7863 5f69  rd choice, mxc_i
-00027c90: 640a 2020 2020 2020 2020 2020 2020 6773  d.            gs
-00027ca0: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
-00027cb0: 2020 2020 2020 2020 2020 2020 6622 446f              f"Do
-00027cc0: 776e 6c6f 6164 206f 6620 5552 4920 277b  wnload of URI '{
-00027cd0: 6d78 637d 2720 746f 206c 6f63 616c 2066  mxc}' to local f
-00027ce0: 696c 6520 277b 6669 6c65 6e61 6d65 7d27  ile '{filename}'
-00027cf0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00027d00: 2020 2066 2273 7563 6365 7373 6675 6c20     f"successful 
-00027d10: 7769 7468 207b 6c65 6e28 7265 7370 2e62  with {len(resp.b
-00027d20: 6f64 7929 7d20 6279 7465 7320 6f66 2064  ody)} bytes of d
-00027d30: 6174 6120 646f 776e 6c6f 6164 6564 2c20  ata downloaded, 
-00027d40: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00027d50: 2020 6622 636f 6e74 656e 745f 7479 7065    f"content_type
-00027d60: 207b 7265 7370 2e63 6f6e 7465 6e74 5f74   {resp.content_t
-00027d70: 7970 657d 3b20 220a 2020 2020 2020 2020  ype}; ".        
-00027d80: 2020 2020 2020 2020 6622 7265 6d6f 7465          f"remote
-00027d90: 2066 696c 656e 616d 6520 7b72 6573 702e   filename {resp.
-00027da0: 6669 6c65 6e61 6d65 7d3b 2022 0a20 2020  filename}; ".   
-00027db0: 2020 2020 2020 2020 2020 2020 2066 2265               f"e
-00027dc0: 6e63 7279 7074 6564 207b 656e 6372 7970  ncrypted {encryp
-00027dd0: 7465 647d 3b20 220a 2020 2020 2020 2020  ted}; ".        
-00027de0: 2020 2020 2020 2020 226b 6579 2064 6963          "key dic
-00027df0: 7469 6f6e 6172 7920 272a 2a2a 2068 6964  tionary '*** hid
-00027e00: 6465 6e20 746f 2070 7265 7665 6e74 206c  den to prevent l
-00027e10: 6561 6b73 272e 2022 0a20 2020 2020 2020  eaks'. ".       
-00027e20: 2020 2020 2020 2020 2023 2066 226b 6579           # f"key
-00027e30: 2064 6963 7469 6f6e 6172 7920 7b64 6563   dictionary {dec
-00027e40: 7279 7074 696f 6e5f 7374 727d 2e20 220a  ryption_str}. ".
-00027e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027e60: 2254 7279 696e 6720 746f 2073 6176 6520  "Trying to save 
-00027e70: 6461 7461 206e 6f77 2e22 0a20 2020 2020  data now.".     
-00027e80: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00027e90: 2020 2020 2069 6620 656e 6372 7970 7465       if encrypte
-00027ea0: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
-00027eb0: 2020 2064 6563 7279 7074 696f 6e5f 6469     decryption_di
-00027ec0: 6374 203d 2061 7374 2e6c 6974 6572 616c  ct = ast.literal
-00027ed0: 5f65 7661 6c28 6465 6372 7970 7469 6f6e  _eval(decryption
-00027ee0: 5f73 7472 290a 2020 2020 2020 2020 2020  _str).          
-00027ef0: 2020 2020 2020 7769 7468 206f 7065 6e28        with open(
-00027f00: 6669 6c65 6e61 6d65 2c20 2277 6222 2920  filename, "wb") 
-00027f10: 6173 2066 696c 653a 0a20 2020 2020 2020  as file:.       
-00027f20: 2020 2020 2020 2020 2020 2020 2066 696c               fil
-00027f30: 652e 7772 6974 6528 0a20 2020 2020 2020  e.write(.       
-00027f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027f50: 2063 7279 7074 6f2e 6174 7461 6368 6d65   crypto.attachme
-00027f60: 6e74 732e 6465 6372 7970 745f 6174 7461  nts.decrypt_atta
-00027f70: 6368 6d65 6e74 280a 2020 2020 2020 2020  chment(.        
-00027f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027f90: 2020 2020 7265 7370 2e62 6f64 792c 0a20      resp.body,. 
-00027fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027fb0: 2020 2020 2020 2020 2020 2064 6563 7279             decry
-00027fc0: 7074 696f 6e5f 6469 6374 5b22 6b65 7922  ption_dict["key"
-00027fd0: 5d5b 226b 225d 2c0a 2020 2020 2020 2020  ]["k"],.        
-00027fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027ff0: 2020 2020 6465 6372 7970 7469 6f6e 5f64      decryption_d
-00028000: 6963 745b 2268 6173 6865 7322 5d5b 2273  ict["hashes"]["s
-00028010: 6861 3235 3622 5d2c 0a20 2020 2020 2020  ha256"],.       
-00028020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028030: 2020 2020 2064 6563 7279 7074 696f 6e5f       decryption_
-00028040: 6469 6374 5b22 6976 225d 2c0a 2020 2020  dict["iv"],.    
+00009e90: 2020 2020 2020 2020 2020 2020 2027 6564               'ed
+00009ea0: 3235 3531 393a 536f 6d65 4b65 7932 273a  25519:SomeKey2':
+00009eb0: 2027 536f 6d65 4b65 7933 277d 2c0a 2020   'SomeKey3'},.  
+00009ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ed0: 2020 2020 2020 276b 6579 7327 3a20 2753        'keys': 'S
+00009ee0: 6f6d 6543 7279 7074 6f4b 6579 3427 2c0a  omeCryptoKey4',.
+00009ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009f00: 2020 2020 2020 2020 2774 7261 6e73 6163          'transac
+00009f10: 7469 6f6e 5f69 6427 3a20 2753 6f6d 6554  tion_id': 'SomeT
+00009f20: 7849 6427 7d2c 0a20 2020 2020 2020 2020  xId'},.         
+00009f30: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00009f40: 7479 7065 273a 2027 6d2e 6b65 792e 7665  type': 'm.key.ve
+00009f50: 7269 6669 6361 7469 6f6e 2e6d 6163 272c  rification.mac',
+00009f60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009f70: 2020 2020 2020 2020 2027 7365 6e64 6572           'sender
+00009f80: 273a 2027 4075 7365 7232 3a65 7861 6d70  ': '@user2:examp
+00009f90: 6c65 2e6f 7267 277d 2c0a 2020 2020 2020  le.org'},.      
+00009fa0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00009fb0: 6e64 6572 3d27 4075 7365 7232 3a65 7861  nder='@user2:exa
+00009fc0: 6d70 6c65 2e6f 7267 272c 0a20 2020 2020  mple.org',.     
+00009fd0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00009fe0: 7261 6e73 6163 7469 6f6e 5f69 643d 2753  ransaction_id='S
+00009ff0: 6f6d 6554 7849 6427 2c0a 2020 2020 2020  omeTxId',.      
+0000a000: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+0000a010: 633d 7b27 6564 3235 3531 393a 4445 5649  c={'ed25519:DEVI
+0000a020: 4345 4944 5859 273a 2027 536f 6d65 4b65  CEIDXY': 'SomeKe
+0000a030: 7931 272c 0a20 2020 2020 2020 2020 2020  y1',.           
+0000a040: 2020 2020 2020 2020 2020 2020 2020 2765                'e
+0000a050: 6432 3535 3139 3a53 6f6d 654b 6579 3227  d25519:SomeKey2'
+0000a060: 3a20 2753 6f6d 654b 6579 3327 7d2c 0a20  : 'SomeKey3'},. 
+0000a070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a080: 2020 206b 6579 733d 2753 6f6d 6543 7279     keys='SomeCry
+0000a090: 7074 6f4b 6579 3427 290a 2020 2020 2020  ptoKey4').      
+0000a0a0: 2020 2020 2020 2020 2020 2222 220a 2020            """.  
+0000a0b0: 2020 2020 2020 2020 2020 2020 2020 7361                sa
+0000a0c0: 7320 3d20 636c 6965 6e74 2e6b 6579 5f76  s = client.key_v
+0000a0d0: 6572 6966 6963 6174 696f 6e73 5b65 7665  erifications[eve
+0000a0e0: 6e74 2e74 7261 6e73 6163 7469 6f6e 5f69  nt.transaction_i
+0000a0f0: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
+0000a100: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0000a110: 2020 2020 2020 2020 2020 2020 746f 6465              tode
+0000a120: 7669 6365 5f6d 7367 203d 2073 6173 2e67  vice_msg = sas.g
+0000a130: 6574 5f6d 6163 2829 0a20 2020 2020 2020  et_mac().       
+0000a140: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+0000a150: 4c6f 6361 6c50 726f 746f 636f 6c45 7272  LocalProtocolErr
+0000a160: 6f72 2061 7320 653a 0a20 2020 2020 2020  or as e:.       
+0000a170: 2020 2020 2020 2020 2020 2020 2023 2065               # e
+0000a180: 2e67 2e20 6974 206d 6967 6874 2068 6176  .g. it might hav
+0000a190: 6520 6265 656e 2063 616e 6365 6c6c 6564  e been cancelled
+0000a1a0: 2062 7920 6f75 7273 656c 7665 730a 2020   by ourselves.  
+0000a1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a1c0: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
+0000a1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a1e0: 2020 2020 2020 2020 2245 3131 343a 2022          "E114: "
+0000a1f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a200: 2020 2020 2020 2020 2066 2243 616e 6365           f"Cance
+0000a210: 6c6c 6564 206f 7220 7072 6f74 6f63 6f6c  lled or protocol
+0000a220: 2065 7272 6f72 3a20 5265 6173 6f6e 3a20   error: Reason: 
+0000a230: 7b65 7d2e 5c6e 220a 2020 2020 2020 2020  {e}.\n".        
+0000a240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a250: 6622 5665 7269 6669 6361 7469 6f6e 2077  f"Verification w
+0000a260: 6974 6820 7b65 7665 6e74 2e73 656e 6465  ith {event.sende
+0000a270: 727d 206e 6f74 2063 6f6e 636c 7564 6564  r} not concluded
+0000a280: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
+0000a290: 2020 2020 2020 2020 2020 2020 2254 7279              "Try
+0000a2a0: 2061 6761 696e 3f22 0a20 2020 2020 2020   again?".       
+0000a2b0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+0000a2c0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0000a2d0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000a2e0: 2020 2020 2020 2020 2072 6573 7020 3d20           resp = 
+0000a2f0: 6177 6169 7420 636c 6965 6e74 2e74 6f5f  await client.to_
+0000a300: 6465 7669 6365 2874 6f64 6576 6963 655f  device(todevice_
+0000a310: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
+0000a320: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
+0000a330: 7374 616e 6365 2872 6573 702c 2054 6f44  stance(resp, ToD
+0000a340: 6576 6963 6545 7272 6f72 293a 0a20 2020  eviceError):.   
+0000a350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a360: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
+0000a370: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+0000a380: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0000a390: 4531 3135 3a20 220a 2020 2020 2020 2020  E115: ".        
+0000a3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a3b0: 2020 2020 2274 6f5f 6465 7669 6365 2066      "to_device f
+0000a3c0: 6169 6c65 6420 7769 7468 2065 7272 6f72  ailed with error
+0000a3d0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+0000a3e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000a3f0: 2227 7b70 7269 7661 6379 5f66 696c 7465  "'{privacy_filte
+0000a400: 7228 7374 7228 7265 7370 2929 7d27 2e22  r(str(resp))}'."
+0000a410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a420: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000a430: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0000a440: 732e 6c6f 672e 696e 666f 280a 2020 2020  s.log.info(.    
+0000a450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a460: 2020 2020 6622 7361 732e 7765 5f73 7461      f"sas.we_sta
+0000a470: 7274 6564 5f69 7420 3d20 7b73 6173 2e77  rted_it = {sas.w
+0000a480: 655f 7374 6172 7465 645f 6974 7d5c 6e22  e_started_it}\n"
+0000a490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a4a0: 2020 2020 2020 2020 2066 2273 6173 2e73           f"sas.s
+0000a4b0: 6173 5f61 6363 6570 7465 6420 3d20 7b73  as_accepted = {s
+0000a4c0: 6173 2e73 6173 5f61 6363 6570 7465 647d  as.sas_accepted}
+0000a4d0: 5c6e 220a 2020 2020 2020 2020 2020 2020  \n".            
+0000a4e0: 2020 2020 2020 2020 2020 2020 6622 7361              f"sa
+0000a4f0: 732e 6361 6e63 656c 6564 203d 207b 7361  s.canceled = {sa
+0000a500: 732e 6361 6e63 656c 6564 7d5c 6e22 0a20  s.canceled}\n". 
+0000a510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a520: 2020 2020 2020 2066 2273 6173 2e74 696d         f"sas.tim
+0000a530: 6564 5f6f 7574 203d 207b 7361 732e 7469  ed_out = {sas.ti
+0000a540: 6d65 645f 6f75 747d 5c6e 220a 2020 2020  med_out}\n".    
+0000a550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a560: 2020 2020 6622 7361 732e 7665 7269 6669      f"sas.verifi
+0000a570: 6564 203d 207b 7361 732e 7665 7269 6669  ed = {sas.verifi
+0000a580: 6564 7d5c 6e22 0a20 2020 2020 2020 2020  ed}\n".         
+0000a590: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000a5a0: 2273 6173 2e76 6572 6966 6965 645f 6465  "sas.verified_de
+0000a5b0: 7669 6365 7320 3d20 7b73 6173 2e76 6572  vices = {sas.ver
+0000a5c0: 6966 6965 645f 6465 7669 6365 737d 5c6e  ified_devices}\n
+0000a5d0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0000a5e0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000a5f0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0000a600: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+0000a610: 2020 2020 2020 2020 2020 2022 456d 6f6a             "Emoj
+0000a620: 6920 7665 7269 6669 6361 7469 6f6e 2077  i verification w
+0000a630: 6173 2073 7563 6365 7373 6675 6c21 5c6e  as successful!\n
+0000a640: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0000a650: 2020 2020 2020 2020 2020 2256 6572 6966            "Verif
+0000a660: 7920 7769 7468 206f 7468 6572 2064 6576  y with other dev
+0000a670: 6963 6573 206f 7220 6869 7420 436f 6e74  ices or hit Cont
+0000a680: 726f 6c2d 4320 746f 2022 0a20 2020 2020  rol-C to ".     
+0000a690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a6a0: 2020 2022 636f 6e74 696e 7565 2e22 2c0a     "continue.",.
+0000a6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a6c0: 2020 2020 2020 2020 6669 6c65 3d73 7973          file=sys
+0000a6d0: 2e73 7464 6f75 742c 0a20 2020 2020 2020  .stdout,.       
+0000a6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a6f0: 2066 6c75 7368 3d54 7275 652c 0a20 2020   flush=True,.   
+0000a700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a710: 2029 0a20 2020 2020 2020 2020 2020 2065   ).            e
+0000a720: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000a730: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
+0000a740: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+0000a750: 2020 2020 2020 2022 4531 3136 3a20 220a         "E116: ".
+0000a760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a770: 2020 2020 6622 5265 6365 6976 6564 2075      f"Received u
+0000a780: 6e65 7870 6563 7465 6420 6576 656e 7420  nexpected event 
+0000a790: 7479 7065 207b 7479 7065 2865 7665 6e74  type {type(event
+0000a7a0: 297d 2e20 220a 2020 2020 2020 2020 2020  )}. ".          
+0000a7b0: 2020 2020 2020 2020 2020 6622 4576 656e            f"Even
+0000a7c0: 7420 6973 207b 6576 656e 747d 2e20 4576  t is {event}. Ev
+0000a7d0: 656e 7420 7769 6c6c 2062 6520 6967 6e6f  ent will be igno
+0000a7e0: 7265 642e 220a 2020 2020 2020 2020 2020  red.".          
+0000a7f0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000a800: 6578 6365 7074 2042 6173 6545 7863 6570  except BaseExcep
+0000a810: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
+0000a820: 2020 6773 2e6c 6f67 2e64 6562 7567 2822    gs.log.debug("
+0000a830: 4865 7265 2069 7320 7468 6520 7472 6163  Here is the trac
+0000a840: 6562 6163 6b2e 5c6e 2220 2b20 7472 6163  eback.\n" + trac
+0000a850: 6562 6163 6b2e 666f 726d 6174 5f65 7863  eback.format_exc
+0000a860: 2829 290a 0a0a 6465 6620 6e6f 7469 6679  ())...def notify
+0000a870: 2874 6974 6c65 3a20 7374 722c 2063 6f6e  (title: str, con
+0000a880: 7465 6e74 3a20 7374 722c 2069 6d61 6765  tent: str, image
+0000a890: 5f75 726c 3a20 7374 7229 3a0a 2020 2020  _url: str):.    
+0000a8a0: 2222 224e 6f74 6966 7920 4f53 206f 6620  """Notify OS of 
+0000a8b0: 6d65 7373 6167 6520 7265 6365 6970 742e  message receipt.
+0000a8c0: 0a0a 2020 2020 4966 2074 6865 2073 7973  ..    If the sys
+0000a8d0: 7465 6d20 6973 2072 756e 6e69 6e67 2068  tem is running h
+0000a8e0: 6561 646c 6573 7320 6f72 2061 6e79 2070  eadless or any p
+0000a8f0: 726f 626c 656d 2068 6170 7065 6e73 2077  roblem happens w
+0000a900: 6974 680a 2020 2020 6f70 6572 6174 696e  ith.    operatin
+0000a910: 6720 7379 7374 656d 206e 6f74 6966 6963  g system notific
+0000a920: 6174 696f 6e73 2c20 6967 6e6f 7265 2069  ations, ignore i
+0000a930: 742e 0a20 2020 2022 2222 0a20 2020 2069  t..    """.    i
+0000a940: 6620 6e6f 7420 4841 5645 5f4e 4f54 4946  f not HAVE_NOTIF
+0000a950: 593a 0a20 2020 2020 2020 2067 732e 6c6f  Y:.        gs.lo
+0000a960: 672e 7761 726e 696e 6728 0a20 2020 2020  g.warning(.     
+0000a970: 2020 2020 2020 2022 5731 3030 3a20 220a         "W100: ".
+0000a980: 2020 2020 2020 2020 2020 2020 226e 6f74              "not
+0000a990: 6966 7932 206f 7220 6462 7573 2069 7320  ify2 or dbus is 
+0000a9a0: 6e6f 7420 696e 7374 616c 6c65 642e 204e  not installed. N
+0000a9b0: 6f74 6966 6963 6174 696f 6e73 2077 696c  otifications wil
+0000a9c0: 6c20 6e6f 7420 6265 2022 0a20 2020 2020  l not be ".     
+0000a9d0: 2020 2020 2020 2022 6469 7370 6c61 7965         "displaye
+0000a9e0: 642e 2022 0a20 2020 2020 2020 2020 2020  d. ".           
+0000a9f0: 2022 4d61 6b65 2073 7572 6520 7468 6174   "Make sure that
+0000aa00: 206e 6f74 6966 7932 2061 6e64 2064 6275   notify2 and dbu
+0000aa10: 7320 6172 6520 696e 7374 616c 6c65 6420  s are installed 
+0000aa20: 6f72 2072 656d 6f76 6520 7468 6520 220a  or remove the ".
+0000aa30: 2020 2020 2020 2020 2020 2020 222d 2d6f              "--o
+0000aa40: 732d 6e6f 7469 6679 206f 7074 696f 6e2e  s-notify option.
+0000aa50: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
+0000aa60: 2020 2020 6773 2e77 6172 6e5f 636f 756e      gs.warn_coun
+0000aa70: 7420 2b3d 2031 0a20 2020 2020 2020 2072  t += 1.        r
+0000aa80: 6574 7572 6e0a 2020 2020 7472 793a 0a20  eturn.    try:. 
+0000aa90: 2020 2020 2020 2069 6620 696d 6167 655f         if image_
+0000aaa0: 7572 6c3a 0a20 2020 2020 2020 2020 2020  url:.           
+0000aab0: 206e 6f74 7573 6564 2c20 6176 6174 6172   notused, avatar
+0000aac0: 5f66 696c 6520 3d20 7465 6d70 6669 6c65  _file = tempfile
+0000aad0: 2e6d 6b73 7465 6d70 2829 0a20 2020 2020  .mkstemp().     
+0000aae0: 2020 2020 2020 2075 726c 6c69 622e 7265         urllib.re
+0000aaf0: 7175 6573 742e 7572 6c72 6574 7269 6576  quest.urlretriev
+0000ab00: 6528 696d 6167 655f 7572 6c2c 2061 7661  e(image_url, ava
+0000ab10: 7461 725f 6669 6c65 290a 2020 2020 2020  tar_file).      
+0000ab20: 2020 2020 2020 2320 544f 444f 3a20 636c        # TODO: cl
+0000ab30: 6561 6e75 7020 7465 6d70 2066 696c 6573  eanup temp files
+0000ab40: 3f20 696e 2063 6c65 616e 7570 2829 3f0a  ? in cleanup()?.
+0000ab50: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000ab60: 2020 2020 2020 2020 2020 2320 4963 6f6e            # Icon
+0000ab70: 206e 616d 6520 226e 6f74 6966 6963 6174   name "notificat
+0000ab80: 696f 6e2d 6d65 7373 6167 652d 494d 2220  ion-message-IM" 
+0000ab90: 7769 6c6c 2077 6f72 6b20 6f6e 2055 6275  will work on Ubu
+0000aba0: 6e74 750a 2020 2020 2020 2020 2020 2020  ntu.            
+0000abb0: 2320 6275 7420 6e6f 7420 616c 6c20 706c  # but not all pl
+0000abc0: 6174 666f 726d 730a 2020 2020 2020 2020  atforms.        
+0000abd0: 2020 2020 6176 6174 6172 5f66 696c 6520      avatar_file 
+0000abe0: 3d20 226e 6f74 6966 6963 6174 696f 6e2d  = "notification-
+0000abf0: 6d65 7373 6167 652d 494d 220a 2020 2020  message-IM".    
+0000ac00: 2020 2020 6e6f 7469 6679 322e 696e 6974      notify2.init
+0000ac10: 2850 524f 475f 5749 5448 4f55 545f 4558  (PROG_WITHOUT_EX
+0000ac20: 5429 0a20 2020 2020 2020 206e 6f74 6966  T).        notif
+0000ac30: 7932 2e4e 6f74 6966 6963 6174 696f 6e28  y2.Notification(
+0000ac40: 7469 746c 652c 2063 6f6e 7465 6e74 2c20  title, content, 
+0000ac50: 6176 6174 6172 5f66 696c 6529 2e73 686f  avatar_file).sho
+0000ac60: 7728 290a 2020 2020 2020 2020 6773 2e6c  w().        gs.l
+0000ac70: 6f67 2e64 6562 7567 2866 2253 686f 7765  og.debug(f"Showe
+0000ac80: 6420 6e6f 7469 6669 6361 7469 6f6e 2066  d notification f
+0000ac90: 6f72 207b 7469 746c 657d 2e22 290a 2020  or {title}.").  
+0000aca0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+0000acb0: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
+0000acc0: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
+0000acd0: 2020 2020 2020 2020 2020 2066 2253 686f             f"Sho
+0000ace0: 7769 6e67 206e 6f74 6966 6963 6174 696f  wing notificatio
+0000acf0: 6e20 666f 7220 7b74 6974 6c65 7d20 6661  n for {title} fa
+0000ad00: 696c 6564 2e20 4578 6365 7074 696f 6e3a  iled. Exception:
+0000ad10: 207b 657d 220a 2020 2020 2020 2020 2020   {e}".          
+0000ad20: 2020 6622 5c6e 4865 7265 2069 7320 7468    f"\nHere is th
+0000ad30: 6520 7472 6163 6562 6163 6b3a 5c6e 7b74  e traceback:\n{t
+0000ad40: 7261 6365 6261 636b 2e66 6f72 6d61 745f  raceback.format_
+0000ad50: 6578 6328 297d 220a 2020 2020 2020 2020  exc()}".        
+0000ad60: 290a 2020 2020 2020 2020 7061 7373 0a0a  ).        pass..
+0000ad70: 0a61 7379 6e63 2064 6566 2067 6574 5f61  .async def get_a
+0000ad80: 7661 7461 725f 7572 6c28 636c 6965 6e74  vatar_url(client
+0000ad90: 3a20 4173 796e 6343 6c69 656e 742c 2075  : AsyncClient, u
+0000ada0: 7365 725f 6964 3a20 7374 7229 202d 3e20  ser_id: str) -> 
+0000adb0: 7374 723a 0a20 2020 2022 2222 4765 7420  str:.    """Get 
+0000adc0: 6874 7470 7320 6176 6174 6172 2055 524c  https avatar URL
+0000add0: 2066 6f72 2075 7365 7220 7573 6572 5f69   for user user_i
+0000ade0: 642e 0a0a 2020 2020 5265 7475 726e 7320  d...    Returns 
+0000adf0: 5552 4c20 6f72 204e 6f6e 6520 6966 2075  URL or None if u
+0000ae00: 7365 7220 6861 7320 6e6f 2061 7661 7461  ser has no avata
+0000ae10: 720a 2020 2020 2222 220a 2020 2020 6176  r.    """.    av
+0000ae20: 6174 6172 5f75 726c 203d 204e 6f6e 6520  atar_url = None 
+0000ae30: 2023 2064 6566 6175 6c74 0a20 2020 2072   # default.    r
+0000ae40: 6573 7020 3d20 6177 6169 7420 636c 6965  esp = await clie
+0000ae50: 6e74 2e67 6574 5f61 7661 7461 7228 7573  nt.get_avatar(us
+0000ae60: 6572 5f69 6429 0a20 2020 2069 6620 6973  er_id).    if is
+0000ae70: 696e 7374 616e 6365 2872 6573 702c 2050  instance(resp, P
+0000ae80: 726f 6669 6c65 4765 7441 7661 7461 7252  rofileGetAvatarR
+0000ae90: 6573 706f 6e73 6529 3a0a 2020 2020 2020  esponse):.      
+0000aea0: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
+0000aeb0: 2020 2020 2020 2020 2020 2020 2250 726f              "Pro
+0000aec0: 6669 6c65 4765 7441 7661 7461 7252 6573  fileGetAvatarRes
+0000aed0: 706f 6e73 652e 2052 6573 706f 6e73 6520  ponse. Response 
+0000aee0: 6973 3a20 220a 2020 2020 2020 2020 2020  is: ".          
+0000aef0: 2020 6622 7b70 7269 7661 6379 5f66 696c    f"{privacy_fil
+0000af00: 7465 7228 7374 7228 7265 7370 2929 7d22  ter(str(resp))}"
+0000af10: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0000af20: 2020 2061 7661 7461 725f 6d78 6320 3d20     avatar_mxc = 
+0000af30: 7265 7370 2e61 7661 7461 725f 7572 6c0a  resp.avatar_url.
+0000af40: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+0000af50: 6562 7567 2866 2261 7661 7461 725f 6d78  ebug(f"avatar_mx
+0000af60: 6320 6973 207b 6176 6174 6172 5f6d 7863  c is {avatar_mxc
+0000af70: 7d22 290a 2020 2020 2020 2020 6966 2061  }").        if a
+0000af80: 7661 7461 725f 6d78 633a 2020 2320 636f  vatar_mxc:  # co
+0000af90: 756c 6420 6265 204e 6f6e 6520 6966 206e  uld be None if n
+0000afa0: 6f20 6176 6174 6172 0a20 2020 2020 2020  o avatar.       
+0000afb0: 2020 2020 2061 7661 7461 725f 7572 6c20       avatar_url 
+0000afc0: 3d20 6177 6169 7420 636c 6965 6e74 2e6d  = await client.m
+0000afd0: 7863 5f74 6f5f 6874 7470 2861 7661 7461  xc_to_http(avata
+0000afe0: 725f 6d78 6329 0a20 2020 2065 6c73 653a  r_mxc).    else:
+0000aff0: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
+0000b000: 696e 666f 280a 2020 2020 2020 2020 2020  info(.          
+0000b010: 2020 6622 4661 696c 6564 2067 6574 7469    f"Failed getti
+0000b020: 6e67 2061 7661 7461 7220 6672 6f6d 2073  ng avatar from s
+0000b030: 6572 7665 722e 207b 7072 6976 6163 795f  erver. {privacy_
+0000b040: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
+0000b050: 297d 220a 2020 2020 2020 2020 290a 2020  )}".        ).  
+0000b060: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
+0000b070: 2261 7661 7461 725f 7572 6c20 6973 207b  "avatar_url is {
+0000b080: 6176 6174 6172 5f75 726c 7d22 290a 2020  avatar_url}").  
+0000b090: 2020 7265 7475 726e 2061 7661 7461 725f    return avatar_
+0000b0a0: 7572 6c0a 0a0a 6465 6620 6372 6561 7465  url...def create
+0000b0b0: 5f70 6964 5f66 696c 6528 2920 2d3e 204e  _pid_file() -> N
+0000b0c0: 6f6e 653a 0a20 2020 2022 2222 5772 6974  one:.    """Writ
+0000b0d0: 6520 5049 4420 746f 2064 6973 6b2e 0a0a  e PID to disk...
+0000b0e0: 2020 2020 4966 2070 6f73 7369 626c 6520      If possible 
+0000b0f0: 6372 6561 7465 2061 2050 4944 2066 696c  create a PID fil
+0000b100: 652e 2054 6869 7320 6973 206e 6f74 2065  e. This is not e
+0000b110: 7373 656e 7469 616c 2e0a 2020 2020 536f  ssential..    So
+0000b120: 2c20 6966 2069 7420 6661 696c 7320 7468  , if it fails th
+0000b130: 6572 6520 6973 206e 6f20 7072 6f62 6c65  ere is no proble
+0000b140: 6d2e 2054 6865 2050 4944 2066 696c 6520  m. The PID file 
+0000b150: 6361 6e0a 2020 2020 6265 2068 656c 7066  can.    be helpf
+0000b160: 756c 2074 6f20 7365 6e64 2061 206b 696c  ul to send a kil
+0000b170: 6c20 7369 676e 616c 206f 7220 7369 6d69  l signal or simi
+0000b180: 6c61 7220 746f 2074 6865 2070 726f 6365  lar to the proce
+0000b190: 7373 2e0a 2020 2020 452e 672e 2074 6f20  ss..    E.g. to 
+0000b1a0: 7374 6f70 206c 6973 7465 6e69 6e67 2e0a  stop listening..
+0000b1b0: 2020 2020 4265 6361 7573 6520 7468 6520      Because the 
+0000b1c0: 7573 6572 2063 616e 2073 7461 7274 2073  user can start s
+0000b1d0: 6576 6572 616c 2070 726f 6365 7373 6573  everal processes
+0000b1e0: 2061 7420 7468 6520 7361 6d65 2074 696d   at the same tim
+0000b1f0: 652c 0a20 2020 206a 7573 7420 6861 7669  e,.    just havi
+0000b200: 6e67 206f 6e65 2050 4944 2066 696c 6520  ng one PID file 
+0000b210: 6973 206e 6f74 2061 6363 6570 7461 626c  is not acceptabl
+0000b220: 6520 6265 6361 7573 6520 6120 6e65 776c  e because a newl
+0000b230: 7920 7374 6172 7465 640a 2020 2020 7072  y started.    pr
+0000b240: 6f63 6573 7320 776f 756c 6420 6f76 6572  ocess would over
+0000b250: 7772 6974 6520 7468 6520 7072 6576 696f  write the previo
+0000b260: 7573 2050 4944 2066 696c 652e 2057 6520  us PID file. We 
+0000b270: 7573 6520 5555 4944 7320 746f 206d 616b  use UUIDs to mak
+0000b280: 650a 2020 2020 6561 6368 2050 4944 2066  e.    each PID f
+0000b290: 696c 6520 756e 6971 7565 2e0a 2020 2020  ile unique..    
+0000b2a0: 2222 220a 2020 2020 7472 793a 0a20 2020  """.    try:.   
+0000b2b0: 2020 2020 2069 6620 6e6f 7420 6f73 2e70       if not os.p
+0000b2c0: 6174 682e 6578 6973 7473 2850 4944 5f44  ath.exists(PID_D
+0000b2d0: 4952 5f44 4546 4155 4c54 293a 0a20 2020  IR_DEFAULT):.   
+0000b2e0: 2020 2020 2020 2020 206f 732e 6d6b 6469           os.mkdi
+0000b2f0: 7228 5049 445f 4449 525f 4445 4641 554c  r(PID_DIR_DEFAUL
+0000b300: 5429 0a20 2020 2020 2020 2020 2020 2067  T).            g
+0000b310: 732e 6c6f 672e 6465 6275 6728 6622 4372  s.log.debug(f"Cr
+0000b320: 6561 7465 2064 6972 6563 746f 7279 207b  eate directory {
+0000b330: 5049 445f 4449 525f 4445 4641 554c 547d  PID_DIR_DEFAULT}
+0000b340: 2066 6f72 2050 4944 2066 696c 652e 2229   for PID file.")
+0000b350: 0a20 2020 2020 2020 2070 6964 203d 206f  .        pid = o
+0000b360: 732e 6765 7470 6964 2829 0a20 2020 2020  s.getpid().     
+0000b370: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+0000b380: 6622 5472 7969 6e67 2074 6f20 6372 6561  f"Trying to crea
+0000b390: 7465 2061 2050 4944 2066 696c 6520 746f  te a PID file to
+0000b3a0: 2073 746f 7265 2070 726f 6365 7373 2069   store process i
+0000b3b0: 6420 7b70 6964 7d2e 2229 0a20 2020 2020  d {pid}.").     
+0000b3c0: 2020 2077 6974 6820 6f70 656e 2850 4944     with open(PID
+0000b3d0: 5f46 494c 455f 4445 4641 554c 542c 2022  _FILE_DEFAULT, "
+0000b3e0: 7722 2920 6173 2066 3a20 2023 206f 7665  w") as f:  # ove
+0000b3f0: 7277 7269 7465 0a20 2020 2020 2020 2020  rwrite.         
+0000b400: 2020 2066 2e77 7269 7465 2873 7472 2870     f.write(str(p
+0000b410: 6964 2929 0a20 2020 2020 2020 2020 2020  id)).           
+0000b420: 2066 2e63 6c6f 7365 2829 0a20 2020 2020   f.close().     
+0000b430: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+0000b440: 0a20 2020 2020 2020 2020 2020 2066 2753  .            f'S
+0000b450: 7563 6365 7373 6675 6c6c 7920 6372 6561  uccessfully crea
+0000b460: 7465 6420 5049 4420 6669 6c65 2022 7b50  ted PID file "{P
+0000b470: 4944 5f46 494c 455f 4445 4641 554c 547d  ID_FILE_DEFAULT}
+0000b480: 2220 270a 2020 2020 2020 2020 2020 2020  " '.            
+0000b490: 6622 746f 2073 746f 7265 2070 726f 6365  f"to store proce
+0000b4a0: 7373 2069 6420 7b70 6964 7d2e 220a 2020  ss id {pid}.".  
+0000b4b0: 2020 2020 2020 290a 2020 2020 6578 6365        ).    exce
+0000b4c0: 7074 2045 7863 6570 7469 6f6e 3a0a 2020  pt Exception:.  
+0000b4d0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+0000b4e0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+0000b4f0: 6627 4661 696c 6564 2074 6f20 6372 6561  f'Failed to crea
+0000b500: 7465 2050 4944 2066 696c 6520 227b 5049  te PID file "{PI
+0000b510: 445f 4649 4c45 5f44 4546 4155 4c54 7d22  D_FILE_DEFAULT}"
+0000b520: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
+0000b530: 2274 6f20 7374 6f72 6520 7072 6f63 6573  "to store proces
+0000b540: 7320 6964 207b 6f73 2e67 6574 7069 6428  s id {os.getpid(
+0000b550: 297d 2e22 0a20 2020 2020 2020 2029 0a0a  )}.".        )..
+0000b560: 0a64 6566 2064 656c 6574 655f 7069 645f  .def delete_pid_
+0000b570: 6669 6c65 2829 202d 3e20 4e6f 6e65 3a0a  file() -> None:.
+0000b580: 2020 2020 2222 2252 656d 6f76 6520 5049      """Remove PI
+0000b590: 4420 6669 6c65 2066 726f 6d20 6469 736b  D file from disk
+0000b5a0: 2e0a 0a20 2020 2043 6c65 616e 2075 7020  ...    Clean up 
+0000b5b0: 6279 2072 656d 6f76 696e 6720 5049 4420  by removing PID 
+0000b5c0: 6669 6c65 2e0a 2020 2020 4974 206d 6967  file..    It mig
+0000b5d0: 6874 206e 6f74 2065 7869 7374 2e20 536f  ht not exist. So
+0000b5e0: 2c20 6967 6e6f 7265 2066 6169 6c75 7265  , ignore failure
+0000b5f0: 732e 0a20 2020 2022 2222 0a20 2020 2074  s..    """.    t
+0000b600: 7279 3a0a 2020 2020 2020 2020 6f73 2e72  ry:.        os.r
+0000b610: 656d 6f76 6528 5049 445f 4649 4c45 5f44  emove(PID_FILE_D
+0000b620: 4546 4155 4c54 290a 2020 2020 6578 6365  EFAULT).    exce
+0000b630: 7074 2045 7863 6570 7469 6f6e 3a0a 2020  pt Exception:.  
+0000b640: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+0000b650: 7567 2866 2746 6169 6c65 6420 746f 2072  ug(f'Failed to r
+0000b660: 656d 6f76 6520 5049 4420 6669 6c65 2022  emove PID file "
+0000b670: 7b50 4944 5f46 494c 455f 4445 4641 554c  {PID_FILE_DEFAUL
+0000b680: 547d 222e 2729 0a0a 0a64 6566 2063 6c65  T}".')...def cle
+0000b690: 616e 7570 2829 202d 3e20 4e6f 6e65 3a0a  anup() -> None:.
+0000b6a0: 2020 2020 2222 2243 6c65 616e 7570 2062      """Cleanup b
+0000b6b0: 6566 6f72 6520 7175 6974 696e 6720 7072  efore quiting pr
+0000b6c0: 6f67 7261 6d2e 2222 220a 2020 2020 6773  ogram.""".    gs
+0000b6d0: 2e6c 6f67 2e64 6562 7567 2822 436c 6561  .log.debug("Clea
+0000b6e0: 6e75 703a 2063 6c65 616e 696e 6720 7570  nup: cleaning up
+0000b6f0: 2e22 290a 2020 2020 6465 6c65 7465 5f70  .").    delete_p
+0000b700: 6964 5f66 696c 6528 290a 0a0a 6465 6620  id_file()...def 
+0000b710: 6372 6564 656e 7469 616c 735f 6578 6973  credentials_exis
+0000b720: 7428 6372 6564 656e 7469 616c 735f 6669  t(credentials_fi
+0000b730: 6c65 5f70 6174 683a 204f 7074 696f 6e61  le_path: Optiona
+0000b740: 6c5b 7374 725d 203d 204e 6f6e 6529 202d  l[str] = None) -
+0000b750: 3e20 626f 6f6c 3a0a 2020 2020 2222 2244  > bool:.    """D
+0000b760: 6574 6572 6d69 6e65 2069 6620 6372 6564  etermine if cred
+0000b770: 656e 7469 616c 7320 6669 6c65 2061 6c72  entials file alr
+0000b780: 6561 6479 2065 7869 7374 732e 2222 220a  eady exists.""".
+0000b790: 2020 2020 6966 206e 6f74 2063 7265 6465      if not crede
+0000b7a0: 6e74 6961 6c73 5f66 696c 655f 7061 7468  ntials_file_path
+0000b7b0: 3a0a 2020 2020 2020 2020 6372 6564 656e  :.        creden
+0000b7c0: 7469 616c 735f 6669 6c65 5f70 6174 6820  tials_file_path 
+0000b7d0: 3d20 6465 7465 726d 696e 655f 6372 6564  = determine_cred
+0000b7e0: 656e 7469 616c 735f 6669 6c65 2829 0a20  entials_file(). 
+0000b7f0: 2020 2072 6574 7572 6e20 6f73 2e70 6174     return os.pat
+0000b800: 682e 6578 6973 7473 2863 7265 6465 6e74  h.exists(credent
+0000b810: 6961 6c73 5f66 696c 655f 7061 7468 290a  ials_file_path).
+0000b820: 0a0a 6465 6620 7374 6f72 655f 6578 6973  ..def store_exis
+0000b830: 7473 2873 746f 7265 5f64 6972 5f70 6174  ts(store_dir_pat
+0000b840: 683a 204f 7074 696f 6e61 6c5b 7374 725d  h: Optional[str]
+0000b850: 203d 204e 6f6e 6529 202d 3e20 626f 6f6c   = None) -> bool
+0000b860: 3a0a 2020 2020 2222 2244 6574 6572 6d69  :.    """Determi
+0000b870: 6e65 2069 6620 7374 6f72 6520 6469 7220  ne if store dir 
+0000b880: 616c 7265 6164 7920 6578 6973 7473 2e22  already exists."
+0000b890: 2222 0a20 2020 2069 6620 6e6f 7420 7374  "".    if not st
+0000b8a0: 6f72 655f 6469 725f 7061 7468 3a0a 2020  ore_dir_path:.  
+0000b8b0: 2020 2020 2020 7374 6f72 655f 6469 725f        store_dir_
+0000b8c0: 7061 7468 203d 2064 6574 6572 6d69 6e65  path = determine
+0000b8d0: 5f73 746f 7265 5f64 6972 2829 0a20 2020  _store_dir().   
+0000b8e0: 2072 6574 7572 6e20 6f73 2e70 6174 682e   return os.path.
+0000b8f0: 6973 6469 7228 7374 6f72 655f 6469 725f  isdir(store_dir_
+0000b900: 7061 7468 290a 0a0a 6465 6620 7374 6f72  path)...def stor
+0000b910: 655f 6372 6561 7465 2873 746f 7265 5f64  e_create(store_d
+0000b920: 6972 5f70 6174 683a 204f 7074 696f 6e61  ir_path: Optiona
+0000b930: 6c5b 7374 725d 203d 204e 6f6e 6529 202d  l[str] = None) -
+0000b940: 3e20 4e6f 6e65 3a0a 2020 2020 2222 2243  > None:.    """C
+0000b950: 7265 6174 6520 7374 6f72 6520 6469 722e  reate store dir.
+0000b960: 2222 220a 2020 2020 6966 206e 6f74 2073  """.    if not s
+0000b970: 746f 7265 5f64 6972 5f70 6174 683a 0a20  tore_dir_path:. 
+0000b980: 2020 2020 2020 2073 746f 7265 5f64 6972         store_dir
+0000b990: 5f70 6174 6820 3d20 6465 7465 726d 696e  _path = determin
+0000b9a0: 655f 7374 6f72 655f 6469 7228 290a 2020  e_store_dir().  
+0000b9b0: 2020 6f73 2e6d 616b 6564 6972 7328 7374    os.makedirs(st
+0000b9c0: 6f72 655f 6469 725f 7061 7468 290a 2020  ore_dir_path).  
+0000b9d0: 2020 6773 2e6c 6f67 2e69 6e66 6f28 0a20    gs.log.info(. 
+0000b9e0: 2020 2020 2020 2066 2254 6865 2070 6572         f"The per
+0000b9f0: 7369 7374 656e 7420 7374 6f72 6167 6520  sistent storage 
+0000ba00: 6469 7265 6374 6f72 7920 7b73 746f 7265  directory {store
+0000ba10: 5f64 6972 5f70 6174 687d 2022 0a20 2020  _dir_path} ".   
+0000ba20: 2020 2020 2022 7761 7320 6372 6561 7465       "was create
+0000ba30: 6420 666f 7220 796f 752e 220a 2020 2020  d for you.".    
+0000ba40: 290a 0a0a 6465 6620 7374 6f72 655f 6465  )...def store_de
+0000ba50: 6c65 7465 2873 746f 7265 5f64 6972 5f70  lete(store_dir_p
+0000ba60: 6174 683a 204f 7074 696f 6e61 6c5b 7374  ath: Optional[st
+0000ba70: 725d 203d 204e 6f6e 6529 202d 3e20 4e6f  r] = None) -> No
+0000ba80: 6e65 3a0a 2020 2020 2222 2244 656c 6574  ne:.    """Delet
+0000ba90: 6520 7374 6f72 6520 6469 722e 2222 220a  e store dir.""".
+0000baa0: 2020 2020 6966 206e 6f74 2073 746f 7265      if not store
+0000bab0: 5f64 6972 5f70 6174 683a 0a20 2020 2020  _dir_path:.     
+0000bac0: 2020 2073 746f 7265 5f64 6972 5f70 6174     store_dir_pat
+0000bad0: 6820 3d20 6465 7465 726d 696e 655f 7374  h = determine_st
+0000bae0: 6f72 655f 6469 7228 290a 2020 2020 6f73  ore_dir().    os
+0000baf0: 2e72 6d64 6972 2873 746f 7265 5f64 6972  .rmdir(store_dir
+0000bb00: 5f70 6174 6829 0a20 2020 2067 732e 6c6f  _path).    gs.lo
+0000bb10: 672e 696e 666f 280a 2020 2020 2020 2020  g.info(.        
+0000bb20: 6622 5468 6520 7065 7273 6973 7465 6e74  f"The persistent
+0000bb30: 2073 746f 7261 6765 2064 6972 6563 746f   storage directo
+0000bb40: 7279 207b 7374 6f72 655f 6469 725f 7061  ry {store_dir_pa
+0000bb50: 7468 7d20 220a 2020 2020 2020 2020 2277  th} ".        "w
+0000bb60: 6173 2064 656c 6574 6564 2066 6f72 2079  as deleted for y
+0000bb70: 6f75 2e22 0a20 2020 2029 0a0a 0a64 6566  ou.".    )...def
+0000bb80: 2077 7269 7465 5f63 7265 6465 6e74 6961   write_credentia
+0000bb90: 6c73 5f74 6f5f 6469 736b 280a 2020 2020  ls_to_disk(.    
+0000bba0: 686f 6d65 7365 7276 6572 2c20 7573 6572  homeserver, user
+0000bbb0: 5f69 642c 2064 6576 6963 655f 6964 2c20  _id, device_id, 
+0000bbc0: 6163 6365 7373 5f74 6f6b 656e 2c20 726f  access_token, ro
+0000bbd0: 6f6d 5f69 642c 2063 7265 6465 6e74 6961  om_id, credentia
+0000bbe0: 6c73 5f66 696c 650a 2920 2d3e 204e 6f6e  ls_file.) -> Non
+0000bbf0: 653a 0a20 2020 2022 2222 5772 6974 6520  e:.    """Write 
+0000bc00: 7468 6520 7265 7175 6972 6564 206c 6f67  the required log
+0000bc10: 696e 2064 6574 6169 6c73 2074 6f20 6469  in details to di
+0000bc20: 736b 2e0a 0a20 2020 2054 6869 7320 6669  sk...    This fi
+0000bc30: 6c65 2063 616e 206c 6174 6572 2062 6520  le can later be 
+0000bc40: 7573 6564 2066 6f72 206c 6f67 6769 6e67  used for logging
+0000bc50: 2069 6e0a 2020 2020 7769 7468 6f75 7420   in.    without 
+0000bc60: 7573 696e 6720 6120 7061 7373 776f 7264  using a password
+0000bc70: 2e0a 0a20 2020 2041 7267 756d 656e 7473  ...    Arguments
+0000bc80: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d0a  :.    ---------.
+0000bc90: 2020 2020 2020 2020 686f 6d65 7365 7276          homeserv
+0000bca0: 6572 203a 2073 7472 0a20 2020 2020 2020  er : str.       
+0000bcb0: 2020 2020 2055 524c 206f 6620 686f 6d65       URL of home
+0000bcc0: 7365 7276 6572 2c20 652e 672e 2022 6874  server, e.g. "ht
+0000bcd0: 7470 733a 2f2f 6d61 7472 6978 2e65 7861  tps://matrix.exa
+0000bce0: 6d70 6c65 2e6f 7267 220a 2020 2020 2020  mple.org".      
+0000bcf0: 2020 7573 6572 5f69 6420 3a20 7374 720a    user_id : str.
+0000bd00: 2020 2020 2020 2020 2020 2020 6675 6c6c              full
+0000bd10: 2075 7365 7220 6964 2c20 652e 672e 2022   user id, e.g. "
+0000bd20: 4075 7365 723a 6578 616d 706c 652e 6f72  @user:example.or
+0000bd30: 6722 0a20 2020 2020 2020 2064 6576 6963  g".        devic
+0000bd40: 655f 6964 203a 2073 7472 0a20 2020 2020  e_id : str.     
+0000bd50: 2020 2020 2020 2064 6576 6963 6520 6964         device id
+0000bd60: 2c20 3130 2075 7070 6572 6361 7365 206c  , 10 uppercase l
+0000bd70: 6574 7465 7273 0a20 2020 2020 2020 2061  etters.        a
+0000bd80: 6363 6573 735f 746f 6b65 6e20 3a20 7374  ccess_token : st
+0000bd90: 720a 2020 2020 2020 2020 2020 2020 6163  r.            ac
+0000bda0: 6365 7373 2074 6f6b 656e 2c20 6c6f 6e67  cess token, long
+0000bdb0: 2063 7279 7074 6f67 7261 7068 6963 2061   cryptographic a
+0000bdc0: 6363 6573 7320 746f 6b65 6e0a 2020 2020  ccess token.    
+0000bdd0: 2020 2020 726f 6f6d 5f69 6420 3a20 7374      room_id : st
+0000bde0: 720a 2020 2020 2020 2020 2020 2020 6e61  r.            na
+0000bdf0: 6d65 206f 6620 726f 6f6d 2077 6865 7265  me of room where
+0000be00: 206d 6573 7361 6765 2077 696c 6c20 6265   message will be
+0000be10: 2073 656e 7420 746f 2c0a 2020 2020 2020   sent to,.      
+0000be20: 2020 2020 2020 652e 672e 2022 2153 6f6d        e.g. "!Som
+0000be30: 6552 6f6f 6d49 6453 7472 696e 673a 6578  eRoomIdString:ex
+0000be40: 616d 706c 652e 6f72 6722 0a20 2020 2020  ample.org".     
+0000be50: 2020 2020 2020 2075 7365 7220 6d75 7374         user must
+0000be60: 2062 6520 6d65 6d62 6572 206f 6620 7468   be member of th
+0000be70: 6520 7072 6f76 6964 6564 2072 6f6f 6d0a  e provided room.
+0000be80: 2020 2020 2020 2020 6372 6564 656e 7469          credenti
+0000be90: 616c 735f 6669 6c65 203a 2073 7472 0a20  als_file : str. 
+0000bea0: 2020 2020 2020 2020 2020 206e 616d 652f             name/
+0000beb0: 7061 7468 206f 6620 6669 6c65 2077 6865  path of file whe
+0000bec0: 7265 2074 6f20 7374 6f72 650a 2020 2020  re to store.    
+0000bed0: 2020 2020 2020 2020 6372 6564 656e 7469          credenti
+0000bee0: 616c 7320 696e 666f 726d 6174 696f 6e0a  als information.
+0000bef0: 0a20 2020 2022 2222 0a20 2020 2023 206f  .    """.    # o
+0000bf00: 7065 6e20 7468 6520 6372 6564 656e 7469  pen the credenti
+0000bf10: 616c 7320 6669 6c65 2069 6e20 7772 6974  als file in writ
+0000bf20: 652d 6d6f 6465 0a20 2020 2077 6974 6820  e-mode.    with 
+0000bf30: 6f70 656e 2863 7265 6465 6e74 6961 6c73  open(credentials
+0000bf40: 5f66 696c 652c 2022 7722 2920 6173 2066  _file, "w") as f
+0000bf50: 3a0a 2020 2020 2020 2020 2320 7772 6974  :.        # writ
+0000bf60: 6520 7468 6520 6c6f 6769 6e20 6465 7461  e the login deta
+0000bf70: 696c 7320 746f 2064 6973 6b0a 2020 2020  ils to disk.    
+0000bf80: 2020 2020 6a73 6f6e 2e64 756d 7028 0a20      json.dump(. 
+0000bf90: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0000bfa0: 2020 2020 2020 2020 2020 2020 2023 2065               # e
+0000bfb0: 2e67 2e20 2268 7474 7073 3a2f 2f6d 6174  .g. "https://mat
+0000bfc0: 7269 782e 6578 616d 706c 652e 6f72 6722  rix.example.org"
+0000bfd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bfe0: 2022 686f 6d65 7365 7276 6572 223a 2068   "homeserver": h
+0000bff0: 6f6d 6573 6572 7665 722c 0a20 2020 2020  omeserver,.     
+0000c000: 2020 2020 2020 2020 2020 2023 2064 6576             # dev
+0000c010: 6963 6520 4944 2c20 3130 2075 7070 6572  ice ID, 10 upper
+0000c020: 6361 7365 206c 6574 7465 7273 0a20 2020  case letters.   
+0000c030: 2020 2020 2020 2020 2020 2020 2022 6465               "de
+0000c040: 7669 6365 5f69 6422 3a20 6465 7669 6365  vice_id": device
+0000c050: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
+0000c060: 2020 2020 2023 2065 2e67 2e20 2240 7573       # e.g. "@us
+0000c070: 6572 3a65 7861 6d70 6c65 2e6f 7267 220a  er:example.org".
+0000c080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c090: 2275 7365 725f 6964 223a 2075 7365 725f  "user_id": user_
+0000c0a0: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+0000c0b0: 2020 2020 2320 652e 672e 2022 2153 6f6d      # e.g. "!Som
+0000c0c0: 6552 6f6f 6d49 6453 7472 696e 673a 6578  eRoomIdString:ex
+0000c0d0: 616d 706c 652e 6f72 6722 0a20 2020 2020  ample.org".     
+0000c0e0: 2020 2020 2020 2020 2020 2022 726f 6f6d             "room
+0000c0f0: 5f69 6422 3a20 726f 6f6d 5f69 642c 0a20  _id": room_id,. 
+0000c100: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000c110: 206c 6f6e 6720 6372 7970 746f 6772 6170   long cryptograp
+0000c120: 6869 6320 6163 6365 7373 2074 6f6b 656e  hic access token
+0000c130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c140: 2022 6163 6365 7373 5f74 6f6b 656e 223a   "access_token":
+0000c150: 2061 6363 6573 735f 746f 6b65 6e2c 0a20   access_token,. 
+0000c160: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
+0000c170: 2020 2020 2020 2020 2020 662c 0a20 2020            f,.   
+0000c180: 2020 2020 2029 0a0a 0a64 6566 2072 6561       )...def rea
+0000c190: 645f 6372 6564 656e 7469 616c 735f 6672  d_credentials_fr
+0000c1a0: 6f6d 5f64 6973 6b28 6372 6564 656e 7469  om_disk(credenti
+0000c1b0: 616c 735f 6669 6c65 2920 2d3e 2064 6963  als_file) -> dic
+0000c1c0: 743a 0a20 2020 2022 2222 5265 6164 2074  t:.    """Read t
+0000c1d0: 6865 2072 6571 7569 7265 6420 6c6f 6769  he required logi
+0000c1e0: 6e20 6465 7461 696c 7320 6672 6f6d 2064  n details from d
+0000c1f0: 6973 6b2e 0a0a 2020 2020 4974 2063 616e  isk...    It can
+0000c200: 2074 6865 6e20 6265 2075 7365 6420 746f   then be used to
+0000c210: 206c 6f67 2069 6e20 7769 7468 6f75 7420   log in without 
+0000c220: 7573 696e 6720 6120 7061 7373 776f 7264  using a password
+0000c230: 2e0a 0a20 2020 2041 7267 756d 656e 7473  ...    Arguments
+0000c240: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d0a  :.    ---------.
+0000c250: 2020 2020 6372 6564 656e 7469 616c 735f      credentials_
+0000c260: 6669 6c65 203a 2073 7472 0a20 2020 2020  file : str.     
+0000c270: 2020 206e 616d 652f 7061 7468 206f 6620     name/path of 
+0000c280: 6669 6c65 2074 6f20 7265 6164 2063 7265  file to read cre
+0000c290: 6465 6e74 6961 6c73 2069 6e66 6f72 6d61  dentials informa
+0000c2a0: 7469 6f6e 2066 726f 6d0a 0a20 2020 2022  tion from..    "
+0000c2b0: 2222 0a20 2020 2023 206f 7065 6e20 7468  "".    # open th
+0000c2c0: 6520 6669 6c65 2069 6e20 7265 6164 2d6f  e file in read-o
+0000c2d0: 6e6c 7920 6d6f 6465 0a20 2020 2067 732e  nly mode.    gs.
+0000c2e0: 6c6f 672e 6465 6275 6728 2253 7461 7274  log.debug("Start
+0000c2f0: 696e 6720 746f 2072 6561 6420 6372 6564  ing to read cred
+0000c300: 656e 7469 616c 7320 6669 6c65 2e22 290a  entials file.").
+0000c310: 2020 2020 7769 7468 206f 7065 6e28 6372      with open(cr
+0000c320: 6564 656e 7469 616c 735f 6669 6c65 2c20  edentials_file, 
+0000c330: 2272 2229 2061 7320 663a 0a20 2020 2020  "r") as f:.     
+0000c340: 2020 2063 6469 6374 203d 206a 736f 6e2e     cdict = json.
+0000c350: 6c6f 6164 2866 290a 2020 2020 6773 2e6c  load(f).    gs.l
+0000c360: 6f67 2e64 6562 7567 2822 4669 6e69 7368  og.debug("Finish
+0000c370: 6564 2072 6561 6469 6e67 2063 7265 6465  ed reading crede
+0000c380: 6e74 6961 6c73 2066 696c 652e 2229 0a20  ntials file."). 
+0000c390: 2020 2072 6574 7572 6e20 6364 6963 740a     return cdict.
+0000c3a0: 0a0a 6465 6620 6465 7465 726d 696e 655f  ..def determine_
+0000c3b0: 6372 6564 656e 7469 616c 735f 6669 6c65  credentials_file
+0000c3c0: 2829 202d 3e20 7374 723a 0a20 2020 2022  () -> str:.    "
+0000c3d0: 2222 4465 7465 726d 696e 6520 7468 6520  ""Determine the 
+0000c3e0: 7472 7565 2066 696c 656e 616d 6520 6f66  true filename of
+0000c3f0: 2063 7265 6465 6e74 6961 6c73 2066 696c   credentials fil
+0000c400: 652e 0a0a 2020 2020 5265 7475 726e 7320  e...    Returns 
+0000c410: 6669 6c65 6e61 6d65 2077 6974 6820 6675  filename with fu
+0000c420: 6c6c 2070 6174 6820 6f72 204e 6f6e 652e  ll path or None.
+0000c430: 0a0a 2020 2020 5468 6973 2066 756e 6374  ..    This funct
+0000c440: 696f 6e20 6368 6563 6b73 2069 6620 6120  ion checks if a 
+0000c450: 6372 6564 656e 7469 616c 7320 6669 6c65  credentials file
+0000c460: 2065 7869 7374 732e 2049 6620 6e6f 2c20   exists. If no, 
+0000c470: 6974 2077 696c 6c20 6173 6b0a 2020 2020  it will ask.    
+0000c480: 7573 6572 2071 7565 7374 696f 6e73 2072  user questions r
+0000c490: 6567 7261 6469 6e67 206c 6f67 696e 2c20  egrading login, 
+0000c4a0: 7374 6f72 6520 7468 6520 696e 666f 2069  store the info i
+0000c4b0: 6e20 6120 6e65 776c 7920 6372 6561 7465  n a newly create
+0000c4c0: 640a 2020 2020 6372 6564 656e 7469 616c  d.    credential
+0000c4d0: 7320 6669 6c65 2061 6e64 2065 7869 742e  s file and exit.
+0000c4e0: 0a0a 2020 2020 4966 2061 2063 7265 6465  ..    If a crede
+0000c4f0: 6e74 6961 6c73 2066 696c 6520 6578 6973  ntials file exis
+0000c500: 7473 2c20 6974 2077 696c 6c20 7265 6164  ts, it will read
+0000c510: 2069 742c 206c 6f67 2069 6e74 6f20 4d61   it, log into Ma
+0000c520: 7472 6978 2c0a 2020 2020 7365 6e64 2061  trix,.    send a
+0000c530: 206d 6573 7361 6765 2061 6e64 2065 7869   message and exi
+0000c540: 742e 0a0a 2020 2020 5468 6520 6372 6564  t...    The cred
+0000c550: 656e 7469 616c 2066 696c 6520 7769 6c6c  ential file will
+0000c560: 2062 6520 6c6f 6f6b 6564 2066 6f72 2074   be looked for t
+0000c570: 6865 2066 6f6c 6c6f 7769 6e67 2077 6179  he following way
+0000c580: 3a0a 2020 2020 6129 2069 6620 6120 7061  :.    a) if a pa
+0000c590: 7468 2028 652e 672e 2022 2e2e 2f63 7265  th (e.g. "../cre
+0000c5a0: 642e 6a73 6f6e 2229 2069 7320 7370 6563  d.json") is spec
+0000c5b0: 6966 6965 6420 7769 7468 202d 7420 6974  ified with -t it
+0000c5c0: 2077 696c 6c20 6265 206c 6f6f 6b65 640a   will be looked.
+0000c5d0: 2020 2020 2020 2066 6f72 2074 6865 7265         for there
+0000c5e0: 2e20 456e 6420 6f66 2073 6561 7263 682e  . End of search.
+0000c5f0: 0a20 2020 2062 2920 6966 206f 6e6c 7920  .    b) if only 
+0000c600: 6120 6669 6c65 6e61 6d65 2077 6974 686f  a filename witho
+0000c610: 7574 2070 6174 6820 2865 2e67 2e20 2263  ut path (e.g. "c
+0000c620: 7265 642e 6a73 6f6e 2229 2069 7320 7370  red.json") is sp
+0000c630: 6563 6966 6965 640a 2020 2020 2020 2066  ecified.       f
+0000c640: 6972 7374 206c 6f6f 6b20 696e 2074 6865  irst look in the
+0000c650: 2063 7572 7265 6e74 206c 6f63 616c 2064   current local d
+0000c660: 6972 6563 746f 7279 2c20 6966 2066 6f75  irectory, if fou
+0000c670: 6e64 2075 7365 2069 740a 2020 2020 6329  nd use it.    c)
+0000c680: 2069 6620 6f6e 6c79 2061 2066 696c 656e   if only a filen
+0000c690: 616d 6520 7769 7468 6f75 7420 7061 7468  ame without path
+0000c6a0: 2028 652e 672e 2022 6372 6564 2e6a 736f   (e.g. "cred.jso
+0000c6b0: 6e22 2920 6973 2073 7065 6369 6669 6564  n") is specified
+0000c6c0: 0a20 2020 2020 2020 616e 6420 6974 2063  .       and it c
+0000c6d0: 616e 6e6f 7420 6265 2066 6f75 6e64 2069  annot be found i
+0000c6e0: 6e20 7468 6520 6375 7272 656e 7420 6c6f  n the current lo
+0000c6f0: 6361 6c20 6469 7265 6374 6f72 792c 2074  cal directory, t
+0000c700: 6865 6e0a 2020 2020 2020 206c 6f6f 6b20  hen.       look 
+0000c710: 666f 7220 6974 2069 6e20 6469 7265 6374  for it in direct
+0000c720: 6f72 7920 2448 4f4d 452f 2e63 6f6e 6669  ory $HOME/.confi
+0000c730: 672f 6d61 7472 6978 2d63 6f6d 6d61 6e64  g/matrix-command
+0000c740: 6572 2f0a 2020 2020 544c 4452 3a20 6f6e  er/.    TLDR: on
+0000c750: 2066 6972 7374 2072 756e 2069 7420 7769   first run it wi
+0000c760: 6c6c 2062 6520 7772 6974 7465 6e20 746f  ll be written to
+0000c770: 2063 7572 7265 6e74 206c 6f63 616c 2064   current local d
+0000c780: 6972 6563 746f 7279 0a20 2020 2020 2020  irectory.       
+0000c790: 6f72 2074 6f20 7061 7468 2073 7065 6369  or to path speci
+0000c7a0: 6669 6564 2077 6974 6820 2d2d 6372 6564  fied with --cred
+0000c7b0: 656e 7469 616c 7320 636f 6d6d 616e 6420  entials command 
+0000c7c0: 6c69 6e65 2061 7267 756d 656e 742e 0a20  line argument.. 
+0000c7d0: 2020 2020 2020 4f6e 2066 7572 7468 6572        On further
+0000c7e0: 2072 6561 6473 2c20 7072 6f67 7261 6d20   reads, program 
+0000c7f0: 7769 6c6c 206c 6f6f 6b20 696e 2063 7572  will look in cur
+0000c800: 7265 6e74 6c79 206c 6f63 616c 2064 6972  rently local dir
+0000c810: 6563 746f 7279 0a20 2020 2020 2020 6f72  ectory.       or
+0000c820: 2069 6e20 7061 7468 2073 7065 6369 6669   in path specifi
+0000c830: 6564 2077 6974 6820 2d2d 6372 6564 656e  ed with --creden
+0000c840: 7469 616c 7320 636f 6d6d 616e 6420 6c69  tials command li
+0000c850: 6e65 2061 7267 756d 656e 742e 0a20 2020  ne argument..   
+0000c860: 2020 2020 4966 206e 6f74 2066 6f75 6e64      If not found
+0000c870: 2074 6865 7265 2028 616e 6420 6f6e 6c79   there (and only
+0000c880: 2066 696c 656e 616d 6520 7769 7468 6f75   filename withou
+0000c890: 7420 7061 7468 2067 6976 656e 292c 0a20  t path given),. 
+0000c8a0: 2020 2020 2020 6173 2061 2073 6563 6f6e        as a secon
+0000c8b0: 6461 7279 2063 686f 6963 6520 7072 6f67  dary choice prog
+0000c8c0: 7261 6d20 7769 6c6c 206c 6f6f 6b20 666f  ram will look fo
+0000c8d0: 7220 6974 2069 6e0a 2020 2020 2020 2064  r it in.       d
+0000c8e0: 6972 6563 746f 7279 2024 484f 4d45 2f2e  irectory $HOME/.
+0000c8f0: 636f 6e66 6967 2f6d 6174 7269 782d 636f  config/matrix-co
+0000c900: 6d6d 616e 6465 722f 0a0a 2020 2020 2222  mmander/..    ""
+0000c910: 220a 2020 2020 6372 6564 656e 7469 616c  ".    credential
+0000c920: 735f 6669 6c65 203d 2067 732e 7061 2e63  s_file = gs.pa.c
+0000c930: 7265 6465 6e74 6961 6c73 2020 2320 6465  redentials  # de
+0000c940: 6661 756c 7420 6c6f 6361 7469 6f6e 0a20  fault location. 
+0000c950: 2020 2069 6620 286e 6f74 206f 732e 7061     if (not os.pa
+0000c960: 7468 2e69 7366 696c 6528 6773 2e70 612e  th.isfile(gs.pa.
+0000c970: 6372 6564 656e 7469 616c 7329 2920 616e  credentials)) an
+0000c980: 6420 280a 2020 2020 2020 2020 6773 2e70  d (.        gs.p
+0000c990: 612e 6372 6564 656e 7469 616c 7320 3d3d  a.credentials ==
+0000c9a0: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
+0000c9b0: 6528 6773 2e70 612e 6372 6564 656e 7469  e(gs.pa.credenti
+0000c9c0: 616c 7329 0a20 2020 2029 3a0a 2020 2020  als).    ):.    
+0000c9d0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+0000c9e0: 280a 2020 2020 2020 2020 2020 2020 2243  (.            "C
+0000c9f0: 7265 6465 6e74 6961 6c73 2066 696c 6520  redentials file 
+0000ca00: 646f 6573 206e 6f74 2065 7869 7374 206c  does not exist l
+0000ca10: 6f63 616c 6c79 2e20 220a 2020 2020 2020  ocally. ".      
+0000ca20: 2020 2020 2020 2246 696c 6520 6e61 6d65        "File name
+0000ca30: 2068 6173 206e 6f20 7061 7468 2e22 0a20   has no path.". 
+0000ca40: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000ca50: 2063 7265 6465 6e74 6961 6c73 5f66 696c   credentials_fil
+0000ca60: 6520 3d20 4352 4544 454e 5449 414c 535f  e = CREDENTIALS_
+0000ca70: 4449 525f 4c41 5354 5245 534f 5254 202b  DIR_LASTRESORT +
+0000ca80: 2022 2f22 202b 2067 732e 7061 2e63 7265   "/" + gs.pa.cre
+0000ca90: 6465 6e74 6961 6c73 0a20 2020 2020 2020  dentials.       
+0000caa0: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
+0000cab0: 2020 2020 2020 2020 2020 2066 2754 7279             f'Try
+0000cac0: 696e 6720 7061 7468 2022 7b63 7265 6465  ing path "{crede
+0000cad0: 6e74 6961 6c73 5f66 696c 657d 2220 6173  ntials_file}" as
+0000cae0: 206c 6173 7420 7265 736f 7274 2e20 270a   last resort. '.
+0000caf0: 2020 2020 2020 2020 2020 2020 2253 7567              "Sug
+0000cb00: 6765 7374 696e 6720 746f 206c 6f6f 6b20  gesting to look 
+0000cb10: 666f 7220 6974 2074 6865 7265 2e22 0a20  for it there.". 
+0000cb20: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000cb30: 2069 6620 6f73 2e70 6174 682e 6973 6669   if os.path.isfi
+0000cb40: 6c65 2863 7265 6465 6e74 6961 6c73 5f66  le(credentials_f
+0000cb50: 696c 6529 3a0a 2020 2020 2020 2020 2020  ile):.          
+0000cb60: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
+0000cb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cb80: 2257 6520 666f 756e 6420 7468 6520 6669  "We found the fi
+0000cb90: 6c65 2e20 4974 2065 7869 7374 7320 696e  le. It exists in
+0000cba0: 2074 6865 206c 6173 7420 7265 736f 7274   the last resort
+0000cbb0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+0000cbc0: 2020 2066 2764 6972 6563 746f 7279 2022     f'directory "
+0000cbd0: 7b63 7265 6465 6e74 6961 6c73 5f66 696c  {credentials_fil
+0000cbe0: 657d 222e 2027 0a20 2020 2020 2020 2020  e}". '.         
+0000cbf0: 2020 2020 2020 2022 5375 6767 6573 7469         "Suggesti
+0000cc00: 6e67 2074 6f20 7573 6520 7468 6973 206f  ng to use this o
+0000cc10: 6e65 2e22 0a20 2020 2020 2020 2020 2020  ne.".           
+0000cc20: 2029 0a20 2020 2020 2020 2065 6c73 653a   ).        else:
+0000cc30: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+0000cc40: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
+0000cc50: 2020 2020 2020 2020 2020 2022 4669 6c65             "File
+0000cc60: 2064 6f65 7320 6e6f 7420 6578 6973 7473   does not exists
+0000cc70: 2065 6974 6865 7220 696e 2074 6865 206c   either in the l
+0000cc80: 6173 7420 7265 736f 7274 2022 0a20 2020  ast resort ".   
+0000cc90: 2020 2020 2020 2020 2020 2020 2022 6469               "di
+0000cca0: 7265 6374 6f72 7920 6f72 2074 6865 206c  rectory or the l
+0000ccb0: 6f63 616c 2064 6972 6563 746f 7279 2e20  ocal directory. 
+0000ccc0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0000ccd0: 2020 2246 696c 6520 6e6f 7420 666f 756e    "File not foun
+0000cce0: 6420 616e 7977 6865 7265 2e20 4f6e 6520  d anywhere. One 
+0000ccf0: 7769 6c6c 2068 6176 6520 746f 2062 6520  will have to be 
+0000cd00: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0000cd10: 2020 2263 7265 6174 6564 2e20 536f 2077    "created. So w
+0000cd20: 6520 7375 6767 6573 7420 7468 6520 6c6f  e suggest the lo
+0000cd30: 6361 6c20 6469 7265 6374 6f72 792e 220a  cal directory.".
+0000cd40: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0000cd50: 2020 2020 2020 2020 2020 6372 6564 656e            creden
+0000cd60: 7469 616c 735f 6669 6c65 203d 2067 732e  tials_file = gs.
+0000cd70: 7061 2e63 7265 6465 6e74 6961 6c73 0a20  pa.credentials. 
+0000cd80: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000cd90: 2069 6620 6f73 2e70 6174 682e 6973 6669   if os.path.isfi
+0000cda0: 6c65 2867 732e 7061 2e63 7265 6465 6e74  le(gs.pa.credent
+0000cdb0: 6961 6c73 293a 0a20 2020 2020 2020 2020  ials):.         
+0000cdc0: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+0000cdd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000cde0: 2022 4372 6564 656e 7469 616c 7320 6669   "Credentials fi
+0000cdf0: 6c65 2065 7869 7374 6564 2e20 220a 2020  le existed. ".  
+0000ce00: 2020 2020 2020 2020 2020 2020 2020 2253                "S
+0000ce10: 6f20 7468 6973 2069 7320 7468 6520 6f6e  o this is the on
+0000ce20: 6520 7765 2073 7567 6765 7374 2074 6f20  e we suggest to 
+0000ce30: 7573 652e 2022 0a20 2020 2020 2020 2020  use. ".         
+0000ce40: 2020 2020 2020 2066 2266 696c 653a 207b         f"file: {
+0000ce50: 6372 6564 656e 7469 616c 735f 6669 6c65  credentials_file
+0000ce60: 7d22 0a20 2020 2020 2020 2020 2020 2029  }".            )
+0000ce70: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0000ce80: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
+0000ce90: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
+0000cea0: 2020 2020 2020 2020 2022 4372 6564 656e           "Creden
+0000ceb0: 7469 616c 7320 6669 6c65 2077 6173 2073  tials file was s
+0000cec0: 7065 6369 6669 6564 2077 6974 6820 6675  pecified with fu
+0000ced0: 6c6c 2070 6174 682e 2022 0a20 2020 2020  ll path. ".     
+0000cee0: 2020 2020 2020 2020 2020 2022 536f 2077             "So w
+0000cef0: 6520 7375 6767 6573 7420 7468 6174 206f  e suggest that o
+0000cf00: 6e65 2e20 220a 2020 2020 2020 2020 2020  ne. ".          
+0000cf10: 2020 2020 2020 6622 6669 6c65 3a20 7b63        f"file: {c
+0000cf20: 7265 6465 6e74 6961 6c73 5f66 696c 657d  redentials_file}
+0000cf30: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+0000cf40: 2020 2020 2320 5468 6520 7265 7475 726e      # The return
+0000cf50: 6564 2066 696c 6520 2877 6974 6820 6f72  ed file (with or
+0000cf60: 2077 6974 686f 7574 2070 6174 6829 2020   without path)  
+0000cf70: 6d69 6768 7420 6f72 206d 6967 6874 206e  might or might n
+0000cf80: 6f74 2065 7869 7374 2e0a 2020 2020 2320  ot exist..    # 
+0000cf90: 4275 7420 6966 2069 7420 646f 6573 206e  But if it does n
+0000cfa0: 6f74 2065 7869 7374 2c20 6974 2069 7320  ot exist, it is 
+0000cfb0: 6569 7468 6572 2061 2066 756c 6c20 7061  either a full pa
+0000cfc0: 7468 2c20 6f72 206c 6f63 616c 2e0a 2020  th, or local..  
+0000cfd0: 2020 2320 5765 2064 6f20 6e6f 7420 7761    # We do not wa
+0000cfe0: 6e74 2074 6f20 7265 7475 726e 2074 6865  nt to return the
+0000cff0: 206c 6173 7420 7265 736f 7274 2070 6174   last resort pat
+0000d000: 6820 6966 2069 7420 646f 6573 206e 6f74  h if it does not
+0000d010: 2065 7869 7374 2c0a 2020 2020 2320 736f   exist,.    # so
+0000d020: 2074 6861 7420 7768 656e 2069 7420 6973   that when it is
+0000d030: 2063 7265 6174 6564 2069 7420 6973 2063   created it is c
+0000d040: 7265 6174 6564 2077 6865 7265 2073 7065  reated where spe
+0000d050: 6369 6669 6361 6c6c 7920 7370 6563 6966  cifically specif
+0000d060: 6965 640a 2020 2020 2320 6f72 2069 6e20  ied.    # or in 
+0000d070: 6c6f 6361 6c20 6469 7220 2862 7574 206e  local dir (but n
+0000d080: 6f74 2069 6e20 6c61 7374 2072 6573 6f72  ot in last resor
+0000d090: 7420 6469 7220 7e2f 2e63 6f6e 6669 672f  t dir ~/.config/
+0000d0a0: 2e2e 2e29 0a20 2020 2072 6574 7572 6e20  ...).    return 
+0000d0b0: 6372 6564 656e 7469 616c 735f 6669 6c65  credentials_file
+0000d0c0: 0a0a 0a64 6566 2064 6574 6572 6d69 6e65  ...def determine
+0000d0d0: 5f73 746f 7265 5f64 6972 2829 202d 3e20  _store_dir() -> 
+0000d0e0: 7374 723a 0a20 2020 2022 2222 4465 7465  str:.    """Dete
+0000d0f0: 726d 696e 6520 7468 6520 7472 7565 2066  rmine the true f
+0000d100: 756c 6c20 6469 7265 6374 6f72 7920 6e61  ull directory na
+0000d110: 6d65 206f 6620 7374 6f72 6520 6469 7265  me of store dire
+0000d120: 6374 6f72 792e 0a0a 2020 2020 5265 7475  ctory...    Retu
+0000d130: 726e 7320 6669 6c65 6e61 6d65 2077 6974  rns filename wit
+0000d140: 6820 6675 6c6c 2070 6174 6820 2861 2064  h full path (a d
+0000d150: 6972 2920 6f72 204e 6f6e 652e 0a0a 2020  ir) or None...  
+0000d160: 2020 466f 7220 6869 7374 6f72 6963 2072    For historic r
+0000d170: 6561 736f 6e73 3a0a 2020 2020 4966 202d  easons:.    If -
+0000d180: 2d65 6e63 7279 7074 6564 2028 656e 6372  -encrypted (encr
+0000d190: 7970 7465 6429 2069 7320 4e4f 5420 7475  ypted) is NOT tu
+0000d1a0: 726e 6564 206f 6e2c 2072 6574 7572 6e20  rned on, return 
+0000d1b0: 4e6f 6e65 2e0a 0a20 2020 2054 6865 2073  None...    The s
+0000d1c0: 746f 7265 2070 6174 6820 7769 6c6c 2062  tore path will b
+0000d1d0: 6520 6c6f 6f6b 6564 2066 6f72 2074 6865  e looked for the
+0000d1e0: 2066 6f6c 6c6f 7769 6e67 2077 6179 3a0a   following way:.
+0000d1f0: 2020 2020 6773 2e70 612e 7374 6f72 6520      gs.pa.store 
+0000d200: 7072 6f76 6964 6573 2065 6974 6865 7220  provides either 
+0000d210: 6465 6661 756c 7420 7661 6c75 6520 6f72  default value or
+0000d220: 2075 7365 7220 7370 6563 6966 6965 6420   user specified 
+0000d230: 7661 6c75 650a 2020 2020 6129 2046 6972  value.    a) Fir
+0000d240: 7374 206c 6f6f 6b65 6420 6174 2064 6566  st looked at def
+0000d250: 6175 6c74 2f73 7065 6369 6669 6564 2076  ault/specified v
+0000d260: 616c 7565 2e20 4966 2064 6972 2065 7869  alue. If dir exi
+0000d270: 7374 732c 0a20 2020 2020 2020 7573 6520  sts,.       use 
+0000d280: 6974 2c20 656e 6420 6f66 2073 6561 7263  it, end of searc
+0000d290: 682e 0a20 2020 2062 2920 6966 206c 6173  h..    b) if las
+0000d2a0: 742d 7265 736f 7274 2073 746f 7265 2064  t-resort store d
+0000d2b0: 6972 2065 7869 7374 732c 2075 7365 2069  ir exists, use i
+0000d2c0: 742c 2065 6e64 206f 6620 7365 6172 6368  t, end of search
+0000d2d0: 2e0a 2020 2020 6329 2069 6620 6f6e 6c79  ..    c) if only
+0000d2e0: 2061 2064 6972 6e61 6d65 2077 6974 686f   a dirname witho
+0000d2f0: 7574 2070 6174 6820 2865 2e67 2e20 2273  ut path (e.g. "s
+0000d300: 746f 7265 2229 2069 7320 7370 6563 6966  tore") is specif
+0000d310: 6965 640a 2020 2020 2020 2061 6e64 2069  ied.       and i
+0000d320: 7420 6361 6e6e 6f74 2062 6520 666f 756e  t cannot be foun
+0000d330: 6420 696e 2074 6865 2063 7572 7265 6e74  d in the current
+0000d340: 206c 6f63 616c 2064 6972 6563 746f 7279   local directory
+0000d350: 2c20 7468 656e 0a20 2020 2020 2020 6c6f  , then.       lo
+0000d360: 6f6b 2066 6f72 2069 7420 696e 206c 6173  ok for it in las
+0000d370: 742d 7265 736f 7274 2070 6174 682e 0a20  t-resort path.. 
+0000d380: 2020 2054 4c44 523a 2054 6865 2070 726f     TLDR: The pro
+0000d390: 6772 616d 2077 696c 6c20 6c6f 6f6b 2069  gram will look i
+0000d3a0: 6e20 7061 7468 2073 7065 6369 6669 6564  n path specified
+0000d3b0: 2077 6974 6820 2d2d 7374 6f72 650a 2020   with --store.  
+0000d3c0: 2020 2020 2063 6f6d 6d61 6e64 206c 696e       command lin
+0000d3d0: 6520 6172 6775 6d65 6e74 2e20 4966 206e  e argument. If n
+0000d3e0: 6f74 2066 6f75 6e64 2074 6865 7265 2069  ot found there i
+0000d3f0: 6e20 6465 6661 756c 740a 2020 2020 2020  n default.      
+0000d400: 206c 6f63 616c 2064 6972 2e20 4966 206e   local dir. If n
+0000d410: 6f74 2066 6f75 6e64 2074 6865 7265 2069  ot found there i
+0000d420: 6e20 6c61 7374 2d72 6573 6f72 7420 6469  n last-resort di
+0000d430: 722e 0a20 2020 2020 2020 4966 206e 6f74  r..       If not
+0000d440: 2066 6f75 6e64 2074 6865 7265 2028 616e   found there (an
+0000d450: 6420 6f6e 6c79 2064 6972 6e61 6d65 2077  d only dirname w
+0000d460: 6974 686f 7574 2070 6174 6820 6769 7665  ithout path give
+0000d470: 6e29 2c0a 2020 2020 2020 2061 7320 6120  n),.       as a 
+0000d480: 6669 6e61 6c20 6368 6f69 6365 2c20 7468  final choice, th
+0000d490: 6520 7072 6f67 7261 6d20 7769 6c6c 206c  e program will l
+0000d4a0: 6f6f 6b20 666f 7220 6974 2069 6e0a 2020  ook for it in.  
+0000d4b0: 2020 2020 206c 6173 7420 7265 736f 7274       last resort
+0000d4c0: 2070 6174 682e 0a20 2020 2049 6620 6e6f   path..    If no
+0000d4d0: 7420 666f 756e 6420 616e 7977 6865 7265  t found anywhere
+0000d4e0: 2c20 6974 2077 696c 6c20 7265 7475 726e  , it will return
+0000d4f0: 2064 6566 6175 6c74 2f73 7065 6369 6669   default/specifi
+0000d500: 6564 2076 616c 7565 2e0a 0a20 2020 2022  ed value...    "
+0000d510: 2222 0a20 2020 2069 6620 6e6f 7420 6773  "".    if not gs
+0000d520: 2e70 612e 7374 6f72 653a 0a20 2020 2020  .pa.store:.     
+0000d530: 2020 2072 6574 7572 6e20 4e6f 6e65 0a20     return None. 
+0000d540: 2020 2069 6620 6e6f 7420 6773 2e70 612e     if not gs.pa.
+0000d550: 656e 6372 7970 7465 643a 0a20 2020 2020  encrypted:.     
+0000d560: 2020 2072 6574 7572 6e20 4e6f 6e65 0a20     return None. 
+0000d570: 2020 2070 6172 6773 5f73 746f 7265 5f6e     pargs_store_n
+0000d580: 6f72 6d20 3d20 6f73 2e70 6174 682e 6e6f  orm = os.path.no
+0000d590: 726d 7061 7468 2867 732e 7061 2e73 746f  rmpath(gs.pa.sto
+0000d5a0: 7265 2920 2023 206e 6f72 6d61 696c 7a65  re)  # normailze
+0000d5b0: 6420 666f 7220 6875 6d61 6e73 0a20 2020  d for humans.   
+0000d5c0: 2069 6620 6f73 2e70 6174 682e 6973 6469   if os.path.isdi
+0000d5d0: 7228 6773 2e70 612e 7374 6f72 6529 3a0a  r(gs.pa.store):.
+0000d5e0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+0000d5f0: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
+0000d600: 2020 2246 6f75 6e64 2061 6e20 6578 6973    "Found an exis
+0000d610: 7469 6e67 2073 746f 7265 2069 6e20 6469  ting store in di
+0000d620: 7265 6374 6f72 7920 220a 2020 2020 2020  rectory ".      
+0000d630: 2020 2020 2020 6627 227b 7061 7267 735f        f'"{pargs_
+0000d640: 7374 6f72 655f 6e6f 726d 7d22 2028 6c6f  store_norm}" (lo
+0000d650: 6361 6c20 6f72 2061 7267 756d 656e 7473  cal or arguments
+0000d660: 292e 2027 0a20 2020 2020 2020 2020 2020  ). '.           
+0000d670: 2022 4974 2077 696c 6c20 6265 2075 7365   "It will be use
+0000d680: 642e 220a 2020 2020 2020 2020 290a 2020  d.".        ).  
+0000d690: 2020 2020 2020 7265 7475 726e 2070 6172        return par
+0000d6a0: 6773 5f73 746f 7265 5f6e 6f72 6d0a 2020  gs_store_norm.  
+0000d6b0: 2020 6966 2067 732e 7061 2e73 746f 7265    if gs.pa.store
+0000d6c0: 2021 3d20 5354 4f52 455f 4449 525f 4445   != STORE_DIR_DE
+0000d6d0: 4641 554c 5420 616e 6420 6773 2e70 612e  FAULT and gs.pa.
+0000d6e0: 7374 6f72 6520 213d 206f 732e 7061 7468  store != os.path
+0000d6f0: 2e62 6173 656e 616d 6528 0a20 2020 2020  .basename(.     
+0000d700: 2020 2067 732e 7061 2e73 746f 7265 0a20     gs.pa.store. 
+0000d710: 2020 2029 3a0a 2020 2020 2020 2020 6773     ):.        gs
+0000d720: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
+0000d730: 2020 2020 2020 2020 6627 5374 6f72 6520          f'Store 
+0000d740: 6469 7265 6374 6f72 7920 227b 7061 7267  directory "{parg
+0000d750: 735f 7374 6f72 655f 6e6f 726d 7d22 2077  s_store_norm}" w
+0000d760: 6173 2073 7065 6369 6669 6564 2062 7920  as specified by 
+0000d770: 270a 2020 2020 2020 2020 2020 2020 2275  '.            "u
+0000d780: 7365 722c 2069 7420 6973 2061 2064 6972  ser, it is a dir
+0000d790: 6563 746f 7279 2077 6974 6820 6120 7061  ectory with a pa
+0000d7a0: 7468 2c20 6275 7420 7468 6520 6469 7265  th, but the dire
+0000d7b0: 6374 6f72 7920 220a 2020 2020 2020 2020  ctory ".        
+0000d7c0: 2020 2020 2264 6f65 7320 6e6f 7420 6578      "does not ex
+0000d7d0: 6973 742e 2022 0a20 2020 2020 2020 2029  ist. ".        )
+0000d7e0: 0a20 2020 2020 2020 2023 2066 616c 6c20  .        # fall 
+0000d7f0: 7468 726f 7567 6820 746f 7761 7264 7320  through towards 
+0000d800: 656e 6469 6e67 206f 6620 6675 6e63 7469  ending of functi
+0000d810: 6f6e 2074 6f20 7072 696e 7420 616e 6420  on to print and 
+0000d820: 7265 7475 726e 2076 616c 7565 0a20 2020  return value.   
+0000d830: 2020 2020 2023 2063 7265 6174 6520 696e       # create in
+0000d840: 2074 6865 2073 7065 6369 6669 6564 2c20   the specified, 
+0000d850: 6469 7265 6374 6f72 7920 7769 7468 2070  directory with p
+0000d860: 6174 680a 2020 2020 6966 2067 732e 7061  ath.    if gs.pa
+0000d870: 2e73 746f 7265 203d 3d20 5354 4f52 455f  .store == STORE_
+0000d880: 4449 525f 4445 4641 554c 5420 616e 6420  DIR_DEFAULT and 
+0000d890: 6f73 2e70 6174 682e 6973 6469 7228 0a20  os.path.isdir(. 
+0000d8a0: 2020 2020 2020 2053 544f 5245 5f44 4952         STORE_DIR
+0000d8b0: 5f4c 4153 5452 4553 4f52 540a 2020 2020  _LASTRESORT.    
+0000d8c0: 293a 0a20 2020 2020 2020 2067 732e 6c6f  ):.        gs.lo
+0000d8d0: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
+0000d8e0: 2020 2020 2022 5374 6f72 6520 7761 7320       "Store was 
+0000d8f0: 6e6f 7420 666f 756e 6420 696e 2064 6566  not found in def
+0000d900: 6175 6c74 206c 6f63 616c 2064 6972 6563  ault local direc
+0000d910: 746f 7279 2e20 220a 2020 2020 2020 2020  tory. ".        
+0000d920: 2020 2020 2242 7574 2066 6f75 6e64 2061      "But found a
+0000d930: 6e20 6578 6973 7469 6e67 2073 746f 7265  n existing store
+0000d940: 2064 6972 6563 746f 7279 2069 6e20 220a   directory in ".
+0000d950: 2020 2020 2020 2020 2020 2020 6627 227b              f'"{
+0000d960: 5354 4f52 455f 4449 525f 4c41 5354 5245  STORE_DIR_LASTRE
+0000d970: 534f 5254 7d22 2064 6972 6563 746f 7279  SORT}" directory
+0000d980: 2e20 270a 2020 2020 2020 2020 2020 2020  . '.            
+0000d990: 2249 7420 7769 6c6c 2062 6520 7573 6564  "It will be used
+0000d9a0: 2e22 0a20 2020 2020 2020 2029 0a20 2020  .".        ).   
+0000d9b0: 2020 2020 2072 6574 7572 6e20 5354 4f52       return STOR
+0000d9c0: 455f 4449 525f 4c41 5354 5245 534f 5254  E_DIR_LASTRESORT
+0000d9d0: 0a0a 2020 2020 6966 2067 732e 7061 2e73  ..    if gs.pa.s
+0000d9e0: 746f 7265 203d 3d20 6f73 2e70 6174 682e  tore == os.path.
+0000d9f0: 6261 7365 6e61 6d65 2867 732e 7061 2e73  basename(gs.pa.s
+0000da00: 746f 7265 293a 0a20 2020 2020 2020 2067  tore):.        g
+0000da10: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
+0000da20: 2020 2020 2020 2020 2066 2753 746f 7265           f'Store
+0000da30: 2064 6972 6563 746f 7279 2022 7b70 6172   directory "{par
+0000da40: 6773 5f73 746f 7265 5f6e 6f72 6d7d 2220  gs_store_norm}" 
+0000da50: 6973 206a 7573 7420 6120 6e61 6d65 2027  is just a name '
+0000da60: 0a20 2020 2020 2020 2020 2020 2022 7769  .            "wi
+0000da70: 7468 6f75 7420 6120 7061 7468 2e20 416c  thout a path. Al
+0000da80: 7265 6164 7920 6c6f 6f6b 6564 206c 6f63  ready looked loc
+0000da90: 616c 6c79 2c20 6275 7420 6e6f 7420 666f  ally, but not fo
+0000daa0: 756e 6420 220a 2020 2020 2020 2020 2020  und ".          
+0000dab0: 2020 226c 6f63 616c 6c79 2e20 536f 206e    "locally. So n
+0000dac0: 6f77 206c 6f6f 6b69 6e67 2066 6f72 2069  ow looking for i
+0000dad0: 7420 696e 206c 6173 742d 7265 736f 7274  t in last-resort
+0000dae0: 2070 6174 682e 220a 2020 2020 2020 2020   path.".        
+0000daf0: 290a 2020 2020 2020 2020 6c61 7374 5f72  ).        last_r
+0000db00: 6573 6f72 7420 3d20 6f73 2e70 6174 682e  esort = os.path.
+0000db10: 6e6f 726d 7061 7468 280a 2020 2020 2020  normpath(.      
+0000db20: 2020 2020 2020 5354 4f52 455f 5041 5448        STORE_PATH
+0000db30: 5f4c 4153 5452 4553 4f52 5420 2b20 222f  _LASTRESORT + "/
+0000db40: 2220 2b20 6773 2e70 612e 7374 6f72 650a  " + gs.pa.store.
+0000db50: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000db60: 2020 6966 206f 732e 7061 7468 2e69 7364    if os.path.isd
+0000db70: 6972 286c 6173 745f 7265 736f 7274 293a  ir(last_resort):
+0000db80: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+0000db90: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
+0000dba0: 2020 2020 2020 2020 2020 2022 466f 756e             "Foun
+0000dbb0: 6420 616e 2065 7869 7374 696e 6720 7374  d an existing st
+0000dbc0: 6f72 6520 6469 7265 6374 6f72 7920 696e  ore directory in
+0000dbd0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+0000dbe0: 2020 2066 2722 7b6c 6173 745f 7265 736f     f'"{last_reso
+0000dbf0: 7274 7d22 2064 6972 6563 746f 7279 2e20  rt}" directory. 
+0000dc00: 4974 2077 696c 6c20 6265 2075 7365 642e  It will be used.
+0000dc10: 270a 2020 2020 2020 2020 2020 2020 290a  '.            ).
+0000dc20: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000dc30: 726e 206c 6173 745f 7265 736f 7274 0a0a  rn last_resort..
+0000dc40: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+0000dc50: 280a 2020 2020 2020 2020 2253 746f 7265  (.        "Store
+0000dc60: 2064 6972 6563 746f 7279 2077 6173 206e   directory was n
+0000dc70: 6f74 2066 6f75 6e64 2061 6e79 7768 6572  ot found anywher
+0000dc80: 652e 2048 656e 6365 2c20 7765 2077 696c  e. Hence, we wil
+0000dc90: 6c20 7375 6767 6573 7420 220a 2020 2020  l suggest ".    
+0000dca0: 2020 2020 6627 227b 7061 7267 735f 7374      f'"{pargs_st
+0000dcb0: 6f72 655f 6e6f 726d 7d22 2028 6c6f 6361  ore_norm}" (loca
+0000dcc0: 6c20 6469 7265 6374 6f72 7929 2061 7320  l directory) as 
+0000dcd0: 7374 6f72 6520 6469 7265 6374 6f72 792e  store directory.
+0000dce0: 270a 2020 2020 290a 2020 2020 7265 7475  '.    ).    retu
+0000dcf0: 726e 2070 6172 6773 5f73 746f 7265 5f6e  rn pargs_store_n
+0000dd00: 6f72 6d20 2023 2063 7265 6174 6520 696e  orm  # create in
+0000dd10: 2074 6865 2073 7065 6369 6669 6564 2c20   the specified, 
+0000dd20: 6c6f 6361 6c20 6469 7220 7769 7468 6f75  local dir withou
+0000dd30: 7420 7061 7468 0a0a 0a61 7379 6e63 2064  t path...async d
+0000dd40: 6566 2064 6574 6572 6d69 6e65 5f64 6d5f  ef determine_dm_
+0000dd50: 726f 6f6d 7328 0a20 2020 2075 7365 7273  rooms(.    users
+0000dd60: 3a20 6c69 7374 2c20 636c 6965 6e74 3a20  : list, client: 
+0000dd70: 4173 796e 6343 6c69 656e 742c 2063 7265  AsyncClient, cre
+0000dd80: 6465 6e74 6961 6c73 3a20 6469 6374 0a29  dentials: dict.)
+0000dd90: 202d 3e20 6c69 7374 3a0a 2020 2020 2222   -> list:.    ""
+0000dda0: 2244 6574 6572 6d69 6e65 2074 6865 2072  "Determine the r
+0000ddb0: 6f6f 6d73 2074 6f20 7365 6e64 2074 6f2e  ooms to send to.
+0000ddc0: 0a0a 2020 2020 5573 6572 7320 6361 6e20  ..    Users can 
+0000ddd0: 6265 2073 7065 6369 6669 6564 2077 6974  be specified wit
+0000dde0: 6820 2d2d 7573 6572 2066 6f72 2073 656e  h --user for sen
+0000ddf0: 6420 616e 6420 6c69 7374 656e 206f 7065  d and listen ope
+0000de00: 7261 7469 6f6e 732e 0a20 2020 2054 6865  rations..    The
+0000de10: 7365 2072 6f6f 6d73 2077 6520 6c61 6265  se rooms we labe
+0000de20: 6c20 444d 2028 6469 7265 6374 206d 6573  l DM (direct mes
+0000de30: 7361 6769 6e67 2920 726f 6f6d 732e 0a20  saging) rooms.. 
+0000de40: 2020 2042 7920 7468 6174 2077 6520 6d65     By that we me
+0000de50: 616e 7320 726f 6f6d 7320 7468 6174 206f  ans rooms that o
+0000de60: 6e6c 7920 6861 7665 2032 206d 656d 6265  nly have 2 membe
+0000de70: 7273 2c20 616e 6420 7468 6573 6520 7477  rs, and these tw
+0000de80: 6f0a 2020 2020 6d65 6d62 6572 7320 6265  o.    members be
+0000de90: 696e 6720 7468 6520 7365 6e64 6572 2061  ing the sender a
+0000dea0: 6e64 2074 6865 2072 6563 6970 6965 6e74  nd the recipient
+0000deb0: 2069 6e20 7175 6573 7469 6f6e 2e0a 2020   in question..  
+0000dec0: 2020 5765 2064 6f20 6e6f 7420 6361 7265    We do not care
+0000ded0: 2061 626f 7574 2027 6973 5f67 726f 7570   about 'is_group
+0000dee0: 2720 6f72 2027 6973 5f64 6972 6563 7427  ' or 'is_direct'
+0000def0: 2066 6c61 6773 2028 6869 6e74 7329 2e0a   flags (hints)..
+0000df00: 0a20 2020 2049 6620 6769 7665 6e20 6120  .    If given a 
+0000df10: 7573 6572 2061 6e64 206b 6e6f 776e 2074  user and known t
+0000df20: 6865 2073 656e 6465 722c 2077 6520 7472  he sender, we tr
+0000df30: 7920 746f 2066 696e 6420 6120 6d61 7463  y to find a matc
+0000df40: 6869 6e67 2072 6f6f 6d2e 0a20 2020 2054  hing room..    T
+0000df50: 6865 7265 206d 6967 6874 2062 6520 302c  here might be 0,
+0000df60: 2031 2c20 6f72 206d 6f72 6520 6d61 7463   1, or more matc
+0000df70: 6869 6e67 2072 6f6f 6d73 2e20 4966 2030  hing rooms. If 0
+0000df80: 2c20 7468 656e 2067 6976 6572 2065 7272  , then giver err
+0000df90: 6f72 0a20 2020 2061 6e64 2074 6865 2075  or.    and the u
+0000dfa0: 7365 7220 7368 6f75 6c64 2072 756e 202d  ser should run -
+0000dfb0: 2d72 6f6f 6d2d 696e 7669 7465 2066 6972  -room-invite fir
+0000dfc0: 7374 2e20 6966 2031 2066 6f75 6e64 2c20  st. if 1 found, 
+0000dfd0: 7573 6520 6974 2e0a 2020 2020 4966 206d  use it..    If m
+0000dfe0: 6f72 6520 7468 616e 2031 2066 6f75 6e64  ore than 1 found
+0000dff0: 2c20 6a75 7374 2075 7365 2031 206f 6620  , just use 1 of 
+0000e000: 7468 656d 2061 7262 6974 7261 7269 6c79  them arbitrarily
+0000e010: 2e0a 0a20 2020 2054 6865 2073 7465 7073  ...    The steps
+0000e020: 2061 7265 3a0a 2020 2020 2d20 6765 7420   are:.    - get 
+0000e030: 616c 6c20 726f 6f6d 7320 7768 6572 6520  all rooms where 
+0000e040: 7365 6e64 6572 2069 7320 6d65 6d62 6572  sender is member
+0000e050: 0a20 2020 202d 2067 6574 2061 6c6c 206d  .    - get all m
+0000e060: 656d 6265 7273 2074 6f20 7468 6573 6520  embers to these 
+0000e070: 726f 6f6d 730a 2020 2020 2d20 6368 6563  rooms.    - chec
+0000e080: 6b20 6966 2074 6865 7265 2069 7320 6120  k if there is a 
+0000e090: 726f 6f6d 2077 6974 6820 6a75 7374 2032  room with just 2
+0000e0a0: 206d 656d 6265 7273 2061 6e64 2074 6865   members and the
+0000e0b0: 6d0a 2020 2020 2020 6265 696e 6720 7365  m.      being se
+0000e0c0: 6e64 6572 2061 6e64 2072 6563 6970 6965  nder and recipie
+0000e0d0: 6e74 2028 7573 6572 2066 726f 6d20 7573  nt (user from us
+0000e0e0: 6572 7320 6172 6729 0a0a 2020 2020 496e  ers arg)..    In
+0000e0f0: 206f 7264 6572 2074 6f20 6d61 7463 6820   order to match 
+0000e100: 6120 7573 6572 2074 6f20 6120 526f 6f6d  a user to a Room
+0000e110: 4d65 6d62 6572 2077 6520 616c 6c6f 7720  Member we allow 
+0000e120: 3320 6368 6f69 6365 733a 0a20 2020 202d  3 choices:.    -
+0000e130: 2075 7365 725f 6964 3a20 7065 7266 6563   user_id: perfec
+0000e140: 7420 6d61 7463 682c 2069 7320 756e 6971  t match, is uniq
+0000e150: 7565 2c20 6675 6c6c 2075 7365 7220 6964  ue, full user id
+0000e160: 2c20 652e 672e 2022 4075 7365 723a 6578  , e.g. "@user:ex
+0000e170: 616d 706c 652e 6f72 6722 0a20 2020 202d  ample.org".    -
+0000e180: 2075 7365 725f 6964 2077 6974 686f 7574   user_id without
+0000e190: 2068 6f6d 6573 6572 7665 7220 646f 6d61   homeserver doma
+0000e1a0: 696e 3a20 7061 7274 6961 6c20 7573 6572  in: partial user
+0000e1b0: 2069 642c 2065 2e67 2e20 2240 7573 6572   id, e.g. "@user
+0000e1c0: 220a 2020 2020 2020 7468 6973 2070 6172  ".      this par
+0000e1d0: 7469 616c 2075 7365 7220 7769 6c6c 2062  tial user will b
+0000e1e0: 6520 636f 6d70 6c65 7465 6420 6279 2061  e completed by a
+0000e1f0: 6464 696e 6720 7468 6520 686f 6d65 7365  dding the homese
+0000e200: 7276 6572 206f 6620 7468 650a 2020 2020  rver of the.    
+0000e210: 2020 7365 6e64 6572 2074 6f20 7468 6520    sender to the 
+0000e220: 656e 642c 2069 2e65 2e20 6173 7375 6d69  end, i.e. assumi
+0000e230: 6e67 2074 6861 7420 7365 6e64 6572 2061  ng that sender a
+0000e240: 6e64 2072 6563 6569 7665 7220 6172 6520  nd receiver are 
+0000e250: 6f6e 2074 6865 0a20 2020 2020 2073 616d  on the.      sam
+0000e260: 6520 686f 6d65 7365 7276 6572 2e0a 2020  e homeserver..  
+0000e270: 2020 2d20 6469 7370 6c61 7920 6e61 6d65    - display name
+0000e280: 3a20 6265 2063 6172 6566 756c 2c20 6469  : be careful, di
+0000e290: 7370 6c61 7920 6e61 6d65 7320 6172 6520  splay names are 
+0000e2a0: 4e4f 5420 756e 6971 7565 2c20 796f 7520  NOT unique, you 
+0000e2b0: 636f 756c 6420 6265 0a20 2020 2020 206d  could be.      m
+0000e2c0: 6973 7461 6b65 6e20 616e 6420 6279 2065  istaken and by e
+0000e2d0: 7272 6f72 2073 656e 6420 746f 2074 6865  rror send to the
+0000e2e0: 2077 726f 6e67 2070 6572 736f 6e2e 0a20   wrong person.. 
+0000e2f0: 2020 2020 2027 2d2d 6a6f 696e 6564 2d6d       '--joined-m
+0000e300: 656d 6265 7273 2022 2a22 2720 7368 6f77  embers "*"' show
+0000e310: 7320 796f 7520 7468 6520 6469 7370 6c61  s you the displa
+0000e320: 7920 6e61 6d65 7320 696e 2074 6865 206d  y names in the m
+0000e330: 6964 646c 6520 636f 6c75 6d6e 0a0a 2020  iddle column..  
+0000e340: 2020 4172 6775 6d65 6e74 733a 0a20 2020    Arguments:.   
+0000e350: 202d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020   ---------.     
+0000e360: 2020 2075 7365 7273 3a20 6c69 7374 2873     users: list(s
+0000e370: 7472 293a 206c 6973 7420 6f66 2075 7365  tr): list of use
+0000e380: 725f 6964 730a 2020 2020 2020 2020 2020  r_ids.          
+0000e390: 2020 7472 7920 746f 2066 696e 6420 6120    try to find a 
+0000e3a0: 6d61 7463 6869 6e67 2044 4d20 726f 6f6d  matching DM room
+0000e3b0: 2066 6f72 2065 6163 6820 7573 6572 0a20   for each user. 
+0000e3c0: 2020 2020 2020 2063 6c69 656e 743a 2041         client: A
+0000e3d0: 7379 6e63 436c 6965 6e74 3a20 636c 6965  syncClient: clie
+0000e3e0: 6e74 2c20 616c 6c6f 7773 2061 7320 746f  nt, allows as to
+0000e3f0: 2071 7565 7279 2074 6865 2073 6572 7665   query the serve
+0000e400: 720a 2020 2020 2020 2020 6372 6564 656e  r.        creden
+0000e410: 7469 616c 733a 2064 6963 743a 2061 6c6c  tials: dict: all
+0000e420: 6f77 7320 746f 2067 6574 2074 6865 2075  ows to get the u
+0000e430: 7365 725f 6964 206f 6620 7365 6e64 6572  ser_id of sender
+0000e440: 0a0a 2020 2020 5265 7475 726e 7320 6120  ..    Returns a 
+0000e450: 6c69 7374 206f 6620 666f 756e 6420 444d  list of found DM
+0000e460: 2072 6f6f 6d73 2e20 4c69 7374 206d 6179   rooms. List may
+0000e470: 2062 6520 656d 7074 7920 6966 206e 6f20   be empty if no 
+0000e480: 6d61 7463 6865 7320 7765 7265 0a20 2020  matches were.   
+0000e490: 2066 6f75 6e64 2e0a 0a20 2020 2022 2222   found...    """
+0000e4a0: 0a20 2020 2072 6f6f 6d73 203d 205b 5d0a  .    rooms = [].
+0000e4b0: 2020 2020 6966 206e 6f74 2075 7365 7273      if not users
+0000e4c0: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
+0000e4d0: 2e64 6562 7567 2866 2252 6f6f 6d28 7329  .debug(f"Room(s)
+0000e4e0: 2066 726f 6d20 2d2d 7573 6572 3a20 7b72   from --user: {r
+0000e4f0: 6f6f 6d73 7d2c 206e 6f20 7573 6572 7320  ooms}, no users 
+0000e500: 7765 7265 2073 7065 6369 6669 6564 2e22  were specified."
+0000e510: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+0000e520: 2072 6f6f 6d73 0a20 2020 2073 656e 6465   rooms.    sende
+0000e530: 7220 3d20 6372 6564 656e 7469 616c 735b  r = credentials[
+0000e540: 2275 7365 725f 6964 225d 2020 2320 7768  "user_id"]  # wh
+0000e550: 6f20 616d 2069 0a20 2020 2067 732e 6c6f  o am i.    gs.lo
+0000e560: 672e 6465 6275 6728 6622 5472 7969 6e67  g.debug(f"Trying
+0000e570: 2074 6f20 6765 7420 6d65 6d62 6572 7320   to get members 
+0000e580: 666f 7220 616c 6c20 726f 6f6d 7320 6f66  for all rooms of
+0000e590: 2073 656e 6465 723a 207b 7365 6e64 6572   sender: {sender
+0000e5a0: 7d22 290a 2020 2020 7265 7370 203d 2061  }").    resp = a
+0000e5b0: 7761 6974 2063 6c69 656e 742e 6a6f 696e  wait client.join
+0000e5c0: 6564 5f72 6f6f 6d73 2829 0a20 2020 2069  ed_rooms().    i
+0000e5d0: 6620 6973 696e 7374 616e 6365 2872 6573  f isinstance(res
+0000e5e0: 702c 204a 6f69 6e65 6452 6f6f 6d73 4572  p, JoinedRoomsEr
+0000e5f0: 726f 7229 3a0a 2020 2020 2020 2020 6773  ror):.        gs
+0000e600: 2e6c 6f67 2e65 7272 6f72 280a 2020 2020  .log.error(.    
+0000e610: 2020 2020 2020 2020 2245 3131 373a 2022          "E117: "
+0000e620: 0a20 2020 2020 2020 2020 2020 2066 226a  .            f"j
+0000e630: 6f69 6e65 645f 726f 6f6d 7320 6661 696c  oined_rooms fail
+0000e640: 6564 2077 6974 6820 7b70 7269 7661 6379  ed with {privacy
+0000e650: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
+0000e660: 2929 7d2e 2022 0a20 2020 2020 2020 2020  ))}. ".         
+0000e670: 2020 2022 4e6f 7420 6162 6c65 2074 6f20     "Not able to 
+0000e680: 220a 2020 2020 2020 2020 2020 2020 2267  ".            "g
+0000e690: 6574 2061 6c6c 2072 6f6f 6d73 2e20 220a  et all rooms. ".
+0000e6a0: 2020 2020 2020 2020 2020 2020 6622 4e6f              f"No
+0000e6b0: 7420 6162 6c65 2074 6f20 6669 6e64 2044  t able to find D
+0000e6c0: 4d20 726f 6f6d 7320 666f 7220 7365 6e64  M rooms for send
+0000e6d0: 6572 207b 7365 6e64 6572 7d2e 2022 0a20  er {sender}. ". 
+0000e6e0: 2020 2020 2020 2020 2020 2066 224e 6f74             f"Not
+0000e6f0: 2061 626c 6520 746f 2073 656e 6420 746f   able to send to
+0000e700: 2072 6563 6569 7665 7273 207b 7573 6572   receivers {user
+0000e710: 737d 2e22 0a20 2020 2020 2020 2029 0a20  s}.".        ). 
+0000e720: 2020 2020 2020 2067 732e 6572 725f 636f         gs.err_co
+0000e730: 756e 7420 2b3d 2031 0a20 2020 2020 2020  unt += 1.       
+0000e740: 2073 656e 6465 7272 6f6f 6d73 203d 205b   senderrooms = [
+0000e750: 5d0a 2020 2020 656c 7365 3a0a 2020 2020  ].    else:.    
+0000e760: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+0000e770: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
+0000e780: 6a6f 696e 6564 5f72 6f6f 6d73 2073 7563  joined_rooms suc
+0000e790: 6365 7373 6675 6c20 7769 7468 207b 7072  cessful with {pr
+0000e7a0: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
+0000e7b0: 2872 6573 7029 297d 220a 2020 2020 2020  (resp))}".      
+0000e7c0: 2020 290a 2020 2020 2020 2020 7365 6e64    ).        send
+0000e7d0: 6572 726f 6f6d 7320 3d20 7265 7370 2e72  errooms = resp.r
+0000e7e0: 6f6f 6d73 0a20 2020 2072 6f6f 6d5f 666f  ooms.    room_fo
+0000e7f0: 756e 645f 666f 725f 7573 6572 7320 3d20  und_for_users = 
+0000e800: 5b5d 0a20 2020 2066 6f72 2072 6f6f 6d20  [].    for room 
+0000e810: 696e 2073 656e 6465 7272 6f6f 6d73 3a0a  in senderrooms:.
+0000e820: 2020 2020 2020 2020 7265 7370 203d 2061          resp = a
+0000e830: 7761 6974 2063 6c69 656e 742e 6a6f 696e  wait client.join
+0000e840: 6564 5f6d 656d 6265 7273 2872 6f6f 6d29  ed_members(room)
+0000e850: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+0000e860: 7374 616e 6365 2872 6573 702c 204a 6f69  stance(resp, Joi
+0000e870: 6e65 644d 656d 6265 7273 4572 726f 7229  nedMembersError)
+0000e880: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
+0000e890: 2e6c 6f67 2e65 7272 6f72 280a 2020 2020  .log.error(.    
+0000e8a0: 2020 2020 2020 2020 2020 2020 2245 3131              "E11
+0000e8b0: 383a 2022 0a20 2020 2020 2020 2020 2020  8: ".           
+0000e8c0: 2020 2020 2066 226a 6f69 6e65 645f 6d65       f"joined_me
+0000e8d0: 6d62 6572 7320 6661 696c 6564 2077 6974  mbers failed wit
+0000e8e0: 6820 7b70 7269 7661 6379 5f66 696c 7465  h {privacy_filte
+0000e8f0: 7228 7374 7228 7265 7370 2929 7d2e 2022  r(str(resp))}. "
+0000e900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e910: 2022 4e6f 7420 6162 6c65 2074 6f20 220a   "Not able to ".
+0000e920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e930: 6622 6765 7420 726f 6f6d 206d 656d 6265  f"get room membe
+0000e940: 7273 2066 6f72 2072 6f6f 6d20 7b72 6f6f  rs for room {roo
+0000e950: 6d7d 2e20 220a 2020 2020 2020 2020 2020  m}. ".          
+0000e960: 2020 2020 2020 6622 4e6f 7420 6162 6c65        f"Not able
+0000e970: 2074 6f20 6669 6e64 2044 4d20 726f 6f6d   to find DM room
+0000e980: 7320 666f 7220 7365 6e64 6572 207b 7365  s for sender {se
+0000e990: 6e64 6572 7d2e 2022 0a20 2020 2020 2020  nder}. ".       
+0000e9a0: 2020 2020 2020 2020 2066 224e 6f74 2061           f"Not a
+0000e9b0: 626c 6520 746f 2073 656e 6420 746f 2073  ble to send to s
+0000e9c0: 6f6d 6520 6f66 2074 6865 7365 2072 6563  ome of these rec
+0000e9d0: 6569 7665 7273 207b 7573 6572 737d 2e22  eivers {users}."
+0000e9e0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0000e9f0: 2020 2020 2020 2020 2020 2067 732e 6572             gs.er
+0000ea00: 725f 636f 756e 7420 2b3d 2031 0a20 2020  r_count += 1.   
+0000ea10: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000ea20: 2020 2020 2020 2023 2072 6573 702e 726f         # resp.ro
+0000ea30: 6f6d 5f69 640a 2020 2020 2020 2020 2020  om_id.          
+0000ea40: 2020 2320 7265 7370 2e6d 656d 6265 7273    # resp.members
+0000ea50: 203d 204c 6973 745b 526f 6f6d 4d65 6d62   = List[RoomMemb
+0000ea60: 6572 5d20 3b20 526f 6f6d 4d65 6d62 6572  er] ; RoomMember
+0000ea70: 0a20 2020 2020 2020 2020 2020 2023 206d  .            # m
+0000ea80: 656d 6265 722e 7573 6572 5f69 640a 2020  ember.user_id.  
+0000ea90: 2020 2020 2020 2020 2020 2320 6d65 6d62            # memb
+0000eaa0: 6572 2e64 6973 706c 6179 5f6e 616d 650a  er.display_name.
+0000eab0: 2020 2020 2020 2020 2020 2020 2320 6d65              # me
+0000eac0: 6d62 6572 2e61 7661 7461 725f 7572 6c0a  mber.avatar_url.
+0000ead0: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+0000eae0: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
+0000eaf0: 2020 2020 2020 2020 2020 6622 6a6f 696e            f"join
+0000eb00: 6564 5f6d 656d 6265 7273 2073 7563 6365  ed_members succe
+0000eb10: 7373 6675 6c20 7769 7468 207b 7072 6976  ssful with {priv
+0000eb20: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
+0000eb30: 6573 7029 297d 220a 2020 2020 2020 2020  esp))}".        
+0000eb40: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0000eb50: 2020 6966 2072 6573 702e 6d65 6d62 6572    if resp.member
+0000eb60: 7320 616e 6420 6c65 6e28 7265 7370 2e6d  s and len(resp.m
+0000eb70: 656d 6265 7273 2920 3d3d 2032 3a0a 2020  embers) == 2:.  
+0000eb80: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000eb90: 2072 6573 702e 6d65 6d62 6572 735b 305d   resp.members[0]
+0000eba0: 2e75 7365 725f 6964 203d 3d20 7365 6e64  .user_id == send
+0000ebb0: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
+0000ebc0: 2020 2020 2020 2020 2320 736e 6472 203d          # sndr =
+0000ebd0: 2072 6573 702e 6d65 6d62 6572 735b 305d   resp.members[0]
+0000ebe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ebf0: 2020 2020 2072 6376 7220 3d20 7265 7370       rcvr = resp
+0000ec00: 2e6d 656d 6265 7273 5b31 5d0a 2020 2020  .members[1].    
+0000ec10: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+0000ec20: 2072 6573 702e 6d65 6d62 6572 735b 315d   resp.members[1]
+0000ec30: 2e75 7365 725f 6964 203d 3d20 7365 6e64  .user_id == send
+0000ec40: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
+0000ec50: 2020 2020 2020 2020 2320 736e 6472 203d          # sndr =
+0000ec60: 2072 6573 702e 6d65 6d62 6572 735b 315d   resp.members[1]
+0000ec70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ec80: 2020 2020 2072 6376 7220 3d20 7265 7370       rcvr = resp
+0000ec90: 2e6d 656d 6265 7273 5b30 5d0a 2020 2020  .members[0].    
+0000eca0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0000ecb0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000ecc0: 2020 2020 2020 2320 736e 6472 203d 204e        # sndr = N
+0000ecd0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+0000ece0: 2020 2020 2020 2020 7263 7672 203d 204e          rcvr = N
+0000ecf0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+0000ed00: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
+0000ed10: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+0000ed20: 2020 2020 2020 2020 2020 2020 2020 2245                "E
+0000ed30: 3131 393a 2022 0a20 2020 2020 2020 2020  119: ".         
+0000ed40: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000ed50: 2253 656e 6465 7220 646f 6573 206e 6f74  "Sender does not
+0000ed60: 206d 6174 6368 207b 7072 6976 6163 795f   match {privacy_
+0000ed70: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
+0000ed80: 297d 220a 2020 2020 2020 2020 2020 2020  )}".            
+0000ed90: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000eda0: 2020 2020 2020 2020 2020 2020 2020 6773                gs
+0000edb0: 2e65 7272 5f63 6f75 6e74 202b 3d20 310a  .err_count += 1.
+0000edc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000edd0: 666f 7220 7573 6572 2069 6e20 7573 6572  for user in user
+0000ede0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0000edf0: 2020 2020 2020 2069 6620 280a 2020 2020         if (.    
+0000ee00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee10: 2020 2020 7263 7672 0a20 2020 2020 2020      rcvr.       
+0000ee20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee30: 2061 6e64 2075 7365 7220 3d3d 2072 6376   and user == rcv
+0000ee40: 722e 7573 6572 5f69 640a 2020 2020 2020  r.user_id.      
+0000ee50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee60: 2020 6f72 2073 686f 7274 5f75 7365 725f    or short_user_
+0000ee70: 6e61 6d65 5f74 6f5f 7573 6572 5f69 6428  name_to_user_id(
+0000ee80: 7573 6572 2c20 6372 6564 656e 7469 616c  user, credential
+0000ee90: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+0000eea0: 2020 2020 2020 2020 2020 203d 3d20 7263             == rc
+0000eeb0: 7672 2e75 7365 725f 6964 0a20 2020 2020  vr.user_id.     
+0000eec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eed0: 2020 206f 7220 7573 6572 203d 3d20 7263     or user == rc
+0000eee0: 7672 2e64 6973 706c 6179 5f6e 616d 650a  vr.display_name.
+0000eef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ef00: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
+0000ef10: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000ef20: 6f6f 6d5f 666f 756e 645f 666f 725f 7573  oom_found_for_us
+0000ef30: 6572 732e 6170 7065 6e64 2875 7365 7229  ers.append(user)
+0000ef40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ef50: 2020 2020 2020 2020 2072 6f6f 6d73 2e61           rooms.a
+0000ef60: 7070 656e 6428 7265 7370 2e72 6f6f 6d5f  ppend(resp.room_
+0000ef70: 6964 290a 2020 2020 666f 7220 7573 6572  id).    for user
+0000ef80: 2069 6e20 7573 6572 733a 0a20 2020 2020   in users:.     
+0000ef90: 2020 2069 6620 7573 6572 206e 6f74 2069     if user not i
+0000efa0: 6e20 726f 6f6d 5f66 6f75 6e64 5f66 6f72  n room_found_for
+0000efb0: 5f75 7365 7273 3a0a 2020 2020 2020 2020  _users:.        
+0000efc0: 2020 2020 6773 2e6c 6f67 2e65 7272 6f72      gs.log.error
+0000efd0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000efe0: 2020 2245 3132 303a 2022 0a20 2020 2020    "E120: ".     
+0000eff0: 2020 2020 2020 2020 2020 2022 526f 6f6d             "Room
+0000f000: 2873 2920 7765 7265 2073 7065 6369 6669  (s) were specifi
+0000f010: 6564 2066 6f72 2061 2044 4d20 2864 6972  ed for a DM (dir
+0000f020: 6563 7420 6d65 7373 6167 696e 6729 2022  ect messaging) "
+0000f030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f040: 2022 7365 6e64 206f 7065 7261 7469 6f6e   "send operation
+0000f050: 2076 6961 202d 2d72 6f6f 6d2e 2042 7574   via --room. But
+0000f060: 206e 6f20 444d 2072 6f6f 6d20 7761 7320   no DM room was 
+0000f070: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0000f080: 2020 6622 666f 756e 6420 666f 7220 7573    f"found for us
+0000f090: 6572 2027 7b75 7365 727d 272e 2022 0a20  er '{user}'. ". 
+0000f0a0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0000f0b0: 5472 7920 7365 7474 696e 6720 7570 2061  Try setting up a
+0000f0c0: 2072 6f6f 6d20 6669 7273 7420 7669 6120   room first via 
+0000f0d0: 2d2d 726f 6f6d 2d63 7265 6174 6520 616e  --room-create an
+0000f0e0: 6420 220a 2020 2020 2020 2020 2020 2020  d ".            
+0000f0f0: 2020 2020 222d 2d72 6f6f 6d2d 696e 7669      "--room-invi
+0000f100: 7465 206f 7074 696f 6e20 6f72 202d 2d72  te option or --r
+0000f110: 6f6f 6d2d 646d 2d63 7265 6174 652e 220a  oom-dm-create.".
+0000f120: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0000f130: 2020 2020 2020 2020 2020 6773 2e65 7272            gs.err
+0000f140: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
+0000f150: 726f 6f6d 7320 3d20 6c69 7374 2864 6963  rooms = list(dic
+0000f160: 742e 6672 6f6d 6b65 7973 2872 6f6f 6d73  t.fromkeys(rooms
+0000f170: 2929 2020 2320 7265 6d6f 7665 2064 7570  ))  # remove dup
+0000f180: 6c69 6361 7465 7320 696e 206c 6973 740a  licates in list.
+0000f190: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+0000f1a0: 2866 2252 6f6f 6d28 7329 2066 726f 6d20  (f"Room(s) from 
+0000f1b0: 2d2d 7573 6572 3a20 7b72 6f6f 6d73 7d22  --user: {rooms}"
+0000f1c0: 290a 2020 2020 7265 7475 726e 2072 6f6f  ).    return roo
+0000f1d0: 6d73 0a0a 0a61 7379 6e63 2064 6566 2064  ms...async def d
+0000f1e0: 6574 6572 6d69 6e65 5f72 6f6f 6d73 280a  etermine_rooms(.
+0000f1f0: 2020 2020 726f 6f6d 5f69 643a 2073 7472      room_id: str
+0000f200: 2c20 636c 6965 6e74 3a20 4173 796e 6343  , client: AsyncC
+0000f210: 6c69 656e 742c 2063 7265 6465 6e74 6961  lient, credentia
+0000f220: 6c73 3a20 6469 6374 0a29 202d 3e20 6c69  ls: dict.) -> li
+0000f230: 7374 3a0a 2020 2020 2222 2244 6574 6572  st:.    """Deter
+0000f240: 6d69 6e65 2074 6865 2072 6f6f 6d20 746f  mine the room to
+0000f250: 2073 656e 6420 746f 2e0a 0a20 2020 2041   send to...    A
+0000f260: 7267 756d 656e 7473 3a0a 2020 2020 2d2d  rguments:.    --
+0000f270: 2d2d 2d2d 2d2d 2d0a 2020 2020 726f 6f6d  -------.    room
+0000f280: 5f69 6420 3a20 726f 6f6d 2066 726f 6d20  _id : room from 
+0000f290: 6372 6564 656e 7469 616c 7320 6669 6c65  credentials file
+0000f2a0: 0a0a 2020 2020 4c6f 6f6b 2061 7420 726f  ..    Look at ro
+0000f2b0: 6f6d 2066 726f 6d20 6372 6564 656e 7469  om from credenti
+0000f2c0: 616c 7320 6669 6c65 2061 6e64 2061 7420  als file and at 
+0000f2d0: 726f 6f6d 7320 6672 6f6d 2063 6f6d 6d61  rooms from comma
+0000f2e0: 6e64 206c 696e 650a 2020 2020 616e 6420  nd line.    and 
+0000f2f0: 7072 6570 6172 6573 2061 2064 6566 696e  prepares a defin
+0000f300: 6974 6520 6c69 7374 206f 6620 726f 6f6d  ite list of room
+0000f310: 732e 0a0a 2020 2020 4e65 773a 2041 6c73  s...    New: Als
+0000f320: 6f20 6c6f 6f6b 2061 7420 2d2d 7573 6572  o look at --user
+0000f330: 2e20 466f 7220 444d 2028 6469 7265 6374  . For DM (direct
+0000f340: 206d 6573 7361 6769 6e67 292c 2064 6573   messaging), des
+0000f350: 7469 6e61 7469 6f6e 730a 2020 2020 6172  tinations.    ar
+0000f360: 6520 7370 6563 6966 6965 6420 7669 6120  e specified via 
+0000f370: 2d2d 7573 6572 2e20 466f 7220 6576 6572  --user. For ever
+0000f380: 7920 7573 6572 2066 6f75 6e64 2c20 7365  y user found, se
+0000f390: 6520 6966 2074 6865 7265 2069 7320 610a  e if there is a.
+0000f3a0: 2020 2020 2244 4d22 2072 6f6f 6d2c 2061      "DM" room, a
+0000f3b0: 2072 6f6f 6d20 7769 7468 206f 6e6c 7920   room with only 
+0000f3c0: 3220 6d65 6d62 6572 7320 2873 656e 6465  2 members (sende
+0000f3d0: 7220 616e 6420 7265 6369 7069 656e 7429  r and recipient)
+0000f3e0: 2e0a 2020 2020 4966 2073 7563 6820 6120  ..    If such a 
+0000f3f0: 2244 4d22 2072 6f6f 6d20 6973 2066 6f75  "DM" room is fou
+0000f400: 6e64 2c20 6164 6420 6974 2074 6f20 7468  nd, add it to th
+0000f410: 6520 6765 6e65 7261 6c20 726f 6f6d 7320  e general rooms 
+0000f420: 6c69 7374 0a20 2020 2074 6861 7420 6973  list.    that is
+0000f430: 2072 6574 7572 6e65 642e 0a0a 2020 2020   returned...    
+0000f440: 4d69 7869 6e67 2061 6e64 206d 6174 6368  Mixing and match
+0000f450: 696e 6720 6f66 202d 2d72 6f6f 6d20 616e  ing of --room an
+0000f460: 6420 2d2d 7573 6572 2069 7320 706f 7373  d --user is poss
+0000f470: 6962 6c65 2e0a 2020 2020 2d2d 726f 6f6d  ible..    --room
+0000f480: 2052 3120 5232 202d 2d75 7365 7220 5531   R1 R2 --user U1
+0000f490: 2055 3220 6d69 6768 7420 6c65 6164 2074   U2 might lead t
+0000f4a0: 6f20 3420 726f 6f6d 7320 696e 2074 6f74  o 4 rooms in tot
+0000f4b0: 616c 2e0a 2020 2020 4966 206e 6f20 2244  al..    If no "D
+0000f4c0: 4d22 2072 6f6f 6d20 6973 2066 6f75 6e64  M" room is found
+0000f4d0: 2074 6865 6e20 6769 7665 2065 7272 6f72   then give error
+0000f4e0: 2061 6e64 2074 656c 6c20 7573 6572 2074   and tell user t
+0000f4f0: 6f20 646f 0a20 2020 202d 2d72 6f6f 6d2d  o do.    --room-
+0000f500: 696e 7669 7465 2066 6972 7374 2e0a 0a20  invite first... 
+0000f510: 2020 2052 6574 7572 6e20 6c69 7374 206f     Return list o
+0000f520: 6620 726f 6f6d 7320 746f 2073 656e 6420  f rooms to send 
+0000f530: 746f 2e20 5265 7475 726e 6564 206c 6973  to. Returned lis
+0000f540: 7420 6973 206e 6576 6572 2065 6d70 7479  t is never empty
+0000f550: 2e0a 0a20 2020 2022 2222 0a20 2020 2069  ...    """.    i
+0000f560: 6620 6e6f 7420 6773 2e70 612e 726f 6f6d  f not gs.pa.room
+0000f570: 2061 6e64 206e 6f74 2067 732e 7061 2e75   and not gs.pa.u
+0000f580: 7365 723a 0a20 2020 2020 2020 2067 732e  ser:.        gs.
+0000f590: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
+0000f5a0: 2020 2020 2020 2022 526f 6f6d 2069 6420         "Room id 
+0000f5b0: 7761 7320 7072 6f76 6964 6564 2076 6961  was provided via
+0000f5c0: 2063 7265 6465 6e74 6961 6c73 2066 696c   credentials fil
+0000f5d0: 652e 2022 0a20 2020 2020 2020 2020 2020  e. ".           
+0000f5e0: 2022 4e6f 2072 6f6f 6d73 2067 6976 656e   "No rooms given
+0000f5f0: 2069 6e20 636f 6d6d 616e 6473 206c 696e   in commands lin
+0000f600: 652e 2022 0a20 2020 2020 2020 2020 2020  e. ".           
+0000f610: 2022 4e6f 2075 7365 7273 2067 6976 656e   "No users given
+0000f620: 2069 6e20 636f 6d6d 616e 6420 6c69 6e65   in command line
+0000f630: 2066 6f72 2044 4d20 726f 6f6d 732e 2022   for DM rooms. "
+0000f640: 0a20 2020 2020 2020 2020 2020 2066 2753  .            f'S
+0000f650: 6574 7469 6e67 2072 6f6f 6d73 2074 6f20  etting rooms to 
+0000f660: 227b 726f 6f6d 5f69 647d 222e 270a 2020  "{room_id}".'.  
+0000f670: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000f680: 7265 7475 726e 205b 726f 6f6d 5f69 645d  return [room_id]
+0000f690: 2020 2320 6c69 7374 206f 6620 310a 2020    # list of 1.  
+0000f6a0: 2020 726f 6f6d 7320 3d20 5b5d 0a20 2020    rooms = [].   
+0000f6b0: 2069 6620 6773 2e70 612e 726f 6f6d 3a0a   if gs.pa.room:.
+0000f6c0: 2020 2020 2020 2020 666f 7220 726f 6f6d          for room
+0000f6d0: 2069 6e20 6773 2e70 612e 726f 6f6d 3a0a   in gs.pa.room:.
+0000f6e0: 2020 2020 2020 2020 2020 2020 726f 6f6d              room
+0000f6f0: 5f69 6420 3d20 726f 6f6d 2e72 6570 6c61  _id = room.repla
+0000f700: 6365 2872 225c 2122 2c20 2221 2229 2020  ce(r"\!", "!")  
+0000f710: 2320 7265 6d6f 7665 2070 6f73 7369 626c  # remove possibl
+0000f720: 6520 6573 6361 7065 0a20 2020 2020 2020  e escape.       
+0000f730: 2020 2020 2072 6f6f 6d73 2e61 7070 656e       rooms.appen
+0000f740: 6428 726f 6f6d 5f69 6429 0a20 2020 2020  d(room_id).     
+0000f750: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+0000f760: 6622 526f 6f6d 2873 2920 6672 6f6d 202d  f"Room(s) from -
+0000f770: 2d72 6f6f 6d3a 207b 726f 6f6d 737d 2229  -room: {rooms}")
+0000f780: 0a20 2020 2072 6f6f 6d73 202b 3d20 6177  .    rooms += aw
+0000f790: 6169 7420 6465 7465 726d 696e 655f 646d  ait determine_dm
+0000f7a0: 5f72 6f6f 6d73 2867 732e 7061 2e75 7365  _rooms(gs.pa.use
+0000f7b0: 722c 2063 6c69 656e 742c 2063 7265 6465  r, client, crede
+0000f7c0: 6e74 6961 6c73 290a 2020 2020 6773 2e6c  ntials).    gs.l
+0000f7d0: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
+0000f7e0: 2020 2252 6f6f 6d28 7329 206f 7220 7573    "Room(s) or us
+0000f7f0: 6572 2873 2920 7765 7265 2070 726f 7669  er(s) were provi
+0000f800: 6465 6420 7669 6120 636f 6d6d 616e 6420  ded via command 
+0000f810: 6c69 6e65 2e20 220a 2020 2020 2020 2020  line. ".        
+0000f820: 224f 7665 7277 7269 7469 6e67 2072 6f6f  "Overwriting roo
+0000f830: 6d20 6964 2066 726f 6d20 6372 6564 656e  m id from creden
+0000f840: 7469 616c 7320 6669 6c65 2022 0a20 2020  tials file ".   
+0000f850: 2020 2020 2066 2777 6974 6820 726f 6f6d       f'with room
+0000f860: 7320 227b 726f 6f6d 737d 2220 270a 2020  s "{rooms}" '.  
+0000f870: 2020 2020 2020 2266 726f 6d20 636f 6d6d        "from comm
+0000f880: 616e 6420 6c69 6e65 2e22 0a20 2020 2029  and line.".    )
+0000f890: 0a20 2020 2072 6574 7572 6e20 726f 6f6d  .    return room
+0000f8a0: 730a 0a0a 6173 796e 6320 6465 6620 6d61  s...async def ma
+0000f8b0: 705f 726f 6f6d 696e 666f 5f74 6f5f 726f  p_roominfo_to_ro
+0000f8c0: 6f6d 6964 2863 6c69 656e 743a 2041 7379  omid(client: Asy
+0000f8d0: 6e63 436c 6965 6e74 2c20 696e 666f 3a20  ncClient, info: 
+0000f8e0: 7374 7229 202d 3e20 7374 723a 0a20 2020  str) -> str:.   
+0000f8f0: 2022 2222 4174 7465 6d70 7420 746f 2063   """Attempt to c
+0000f900: 6f6e 7665 7274 2072 6f6f 6d20 696e 666f  onvert room info
+0000f910: 2074 6f20 726f 6f6d 5f69 642e 0a0a 2020   to room_id...  
+0000f920: 2020 4172 6775 6d65 6e74 733a 0a20 2020    Arguments:.   
+0000f930: 202d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063   ---------.    c
+0000f940: 6c69 656e 7420 3a20 6e69 6f20 636c 6965  lient : nio clie
+0000f950: 6e74 0a20 2020 2069 6e66 6f20 3a20 7374  nt.    info : st
+0000f960: 720a 2020 2020 2020 2020 6361 6e20 6265  r.        can be
+0000f970: 2061 2063 616e 6f6e 6963 616c 2061 6c69   a canonical ali
+0000f980: 6173 2069 6e20 7468 6520 666f 726d 206f  as in the form o
+0000f990: 6620 2723 736f 6d65 526f 6f6d 416c 6961  f '#someRoomAlia
+0000f9a0: 733a 6578 616d 706c 652e 636f 6d27 0a20  s:example.com'. 
+0000f9b0: 2020 2020 2020 2063 616e 2062 6520 6120         can be a 
+0000f9c0: 6361 6e6f 6e69 6361 6c20 726f 6f6d 5f69  canonical room_i
+0000f9d0: 6420 696e 2074 6865 2066 6f72 6d20 6f66  d in the form of
+0000f9e0: 2027 2173 6f6d 6552 6f6f 6d49 643a 6578   '!someRoomId:ex
+0000f9f0: 616d 706c 652e 636f 6d27 0a20 2020 2020  ample.com'.     
+0000fa00: 2020 2063 616e 2062 6520 6120 7368 6f72     can be a shor
+0000fa10: 7420 616c 6961 7320 696e 2074 6865 2066  t alias in the f
+0000fa20: 6f72 6d20 6f66 2027 736f 6d65 526f 6f6d  orm of 'someRoom
+0000fa30: 416c 6961 7327 0a20 2020 2020 2020 2063  Alias'.        c
+0000fa40: 616e 2062 6520 6120 7368 6f72 7420 616c  an be a short al
+0000fa50: 6961 7320 696e 2074 6865 2066 6f72 6d20  ias in the form 
+0000fa60: 6f66 2027 2373 6f6d 6552 6f6f 6d41 6c69  of '#someRoomAli
+0000fa70: 6173 270a 2020 2020 2020 2020 6361 6e20  as'.        can 
+0000fa80: 6265 2061 2073 686f 7274 2072 6f6f 6d20  be a short room 
+0000fa90: 6964 2069 6e20 7468 6520 666f 726d 206f  id in the form o
+0000faa0: 6620 2721 736f 6d65 526f 6f6d 4964 270a  f '!someRoomId'.
+0000fab0: 0a20 2020 2052 6574 7572 6e20 636f 7272  .    Return corr
+0000fac0: 6573 706f 6e64 696e 6720 6675 6c6c 2072  esponding full r
+0000fad0: 6f6f 6d5f 6964 2028 2169 643a 7361 6d70  oom_id (!id:samp
+0000fae0: 6c65 2e63 6f6d 2920 6f72 206f 7220 7261  le.com) or or ra
+0000faf0: 6973 6573 2065 7863 6570 7469 6f6e 2e0a  ises exception..
+0000fb00: 0a20 2020 2022 2222 0a20 2020 2072 6920  .    """.    ri 
+0000fb10: 3d20 696e 666f 2e73 7472 6970 2829 0a20  = info.strip(). 
+0000fb20: 2020 2072 6920 3d20 7269 2e72 6570 6c61     ri = ri.repla
+0000fb30: 6365 2872 225c 2122 2c20 2221 2229 2020  ce(r"\!", "!")  
+0000fb40: 2320 7265 6d6f 7665 2070 6f73 7369 626c  # remove possibl
+0000fb50: 6520 6573 6361 7065 0a20 2020 2069 6620  e escape.    if 
+0000fb60: 280a 2020 2020 2020 2020 7269 2069 6e20  (.        ri in 
+0000fb70: 284e 6f6e 652c 2022 222c 2022 2122 2c20  (None, "", "!", 
+0000fb80: 2223 2229 0a20 2020 2020 2020 206f 7220  "#").        or 
+0000fb90: 7269 2e73 7461 7274 7377 6974 6828 223a  ri.startswith(":
+0000fba0: 2229 0a20 2020 2020 2020 206f 7220 7269  ").        or ri
+0000fbb0: 2e63 6f75 6e74 2822 3a22 2920 3e20 310a  .count(":") > 1.
+0000fbc0: 2020 2020 2020 2020 6f72 2072 692e 7374          or ri.st
+0000fbd0: 6172 7473 7769 7468 2822 4022 290a 2020  artswith("@").  
+0000fbe0: 2020 2020 2020 6f72 2022 2322 2069 6e20        or "#" in 
+0000fbf0: 7269 5b31 3a5d 0a20 2020 2020 2020 206f  ri[1:].        o
+0000fc00: 7220 616e 7928 656c 656d 2069 6e20 7269  r any(elem in ri
+0000fc10: 2066 6f72 2065 6c65 6d20 696e 2022 5b5d   for elem in "[]
+0000fc20: 7b7d 2022 2920 2023 2064 6f65 7320 6974  {} ")  # does it
+0000fc30: 2063 6f6e 7461 696e 2062 6164 2063 6861   contain bad cha
+0000fc40: 7273 3f0a 2020 2020 2020 2020 6f72 2028  rs?.        or (
+0000fc50: 0a20 2020 2020 2020 2020 2020 206e 6f74  .            not
+0000fc60: 2072 692e 7374 6172 7473 7769 7468 2822   ri.startswith("
+0000fc70: 2122 2920 616e 6420 6e6f 7420 7269 2e73  !") and not ri.s
+0000fc80: 7461 7274 7377 6974 6828 2223 2229 2061  tartswith("#") a
+0000fc90: 6e64 2022 3a22 2069 6e20 7269 0a20 2020  nd ":" in ri.   
+0000fca0: 2020 2020 2029 2020 2320 616c 6961 733a       )  # alias:
+0000fcb0: 7361 6d70 6c65 2e63 6f6d 0a20 2020 2029  sample.com.    )
+0000fcc0: 3a0a 2020 2020 2020 2020 6572 7220 3d20  :.        err = 
+0000fcd0: 280a 2020 2020 2020 2020 2020 2020 2245  (.            "E
+0000fce0: 3132 313a 2022 0a20 2020 2020 2020 2020  121: ".         
+0000fcf0: 2020 2066 2249 6e76 616c 6964 2072 6f6f     f"Invalid roo
+0000fd00: 6d20 7370 6563 6966 6963 6174 696f 6e2e  m specification.
+0000fd10: 2027 7b69 6e66 6f7d 2720 287b 7269 7d29   '{info}' ({ri})
+0000fd20: 2069 7320 6e65 6974 6865 7220 220a 2020   is neither ".  
+0000fd30: 2020 2020 2020 2020 2020 2261 2076 616c            "a val
+0000fd40: 6964 2072 6f6f 6d20 6964 206e 6f72 2061  id room id nor a
+0000fd50: 2076 616c 6964 2072 6f6f 6d20 616c 6961   valid room alia
+0000fd60: 732e 220a 2020 2020 2020 2020 290a 2020  s.".        ).  
+0000fd70: 2020 2020 2020 7261 6973 6520 4d61 7472        raise Matr
+0000fd80: 6978 436f 6d6d 616e 6465 7245 7272 6f72  ixCommanderError
+0000fd90: 2865 7272 2920 6672 6f6d 204e 6f6e 650a  (err) from None.
+0000fda0: 2020 2020 6966 206e 6f74 2072 692e 7374      if not ri.st
+0000fdb0: 6172 7473 7769 7468 2822 2122 293a 0a20  artswith("!"):. 
+0000fdc0: 2020 2020 2020 2023 2027 736f 6d65 526f         # 'someRo
+0000fdd0: 6f6d 416c 6961 7327 206f 7220 2723 736f  omAlias' or '#so
+0000fde0: 6d65 526f 6f6d 416c 6961 7327 206f 7220  meRoomAlias' or 
+0000fdf0: 2723 736f 6d65 526f 6f6d 416c 6961 733a  '#someRoomAlias:
+0000fe00: 7361 6d70 6c65 2e63 6f6d 270a 2020 2020  sample.com'.    
+0000fe10: 2020 2020 6966 2022 3a22 206e 6f74 2069      if ":" not i
+0000fe20: 6e20 7269 3a20 2023 2027 736f 6d65 526f  n ri:  # 'someRo
+0000fe30: 6f6d 416c 6961 7327 206f 7220 2723 736f  omAlias' or '#so
+0000fe40: 6d65 526f 6f6d 416c 6961 7327 0a20 2020  meRoomAlias'.   
+0000fe50: 2020 2020 2020 2020 2072 6920 3d20 7368           ri = sh
+0000fe60: 6f72 745f 726f 6f6d 5f61 6c69 6173 5f74  ort_room_alias_t
+0000fe70: 6f5f 726f 6f6d 5f61 6c69 6173 2872 692c  o_room_alias(ri,
+0000fe80: 2067 732e 6372 6564 656e 7469 616c 7329   gs.credentials)
+0000fe90: 0a20 2020 2020 2020 2072 6920 3d20 6177  .        ri = aw
+0000fea0: 6169 7420 6d61 705f 726f 6f6d 616c 6961  ait map_roomalia
+0000feb0: 735f 746f 5f72 6f6f 6d69 6428 636c 6965  s_to_roomid(clie
+0000fec0: 6e74 2c20 7269 290a 2020 2020 2020 2020  nt, ri).        
+0000fed0: 7265 7475 726e 2072 690a 2020 2020 6966  return ri.    if
+0000fee0: 2022 3a22 206e 6f74 2069 6e20 7269 3a0a   ":" not in ri:.
+0000fef0: 2020 2020 2020 2020 2320 2721 736f 6d65          # '!some
+0000ff00: 526f 6f6d 4964 270a 2020 2020 2020 2020  RoomId'.        
+0000ff10: 7269 203d 2072 6920 2b20 223a 2220 2b20  ri = ri + ":" + 
+0000ff20: 6465 6661 756c 745f 686f 6d65 7365 7276  default_homeserv
+0000ff30: 6572 2867 732e 6372 6564 656e 7469 616c  er(gs.credential
+0000ff40: 7329 0a20 2020 2072 6574 7572 6e20 7269  s).    return ri
+0000ff50: 0a0a 0a61 7379 6e63 2064 6566 206d 6170  ...async def map
+0000ff60: 5f72 6f6f 6d61 6c69 6173 5f74 6f5f 726f  _roomalias_to_ro
+0000ff70: 6f6d 6964 2863 6c69 656e 742c 2061 6c69  omid(client, ali
+0000ff80: 6173 2920 2d3e 2073 7472 3a0a 2020 2020  as) -> str:.    
+0000ff90: 2222 2241 7474 656d 7074 2074 6f20 636f  """Attempt to co
+0000ffa0: 6e76 6572 7420 726f 6f6d 2061 6c69 6173  nvert room alias
+0000ffb0: 2074 6f20 726f 6f6d 5f69 642e 0a0a 2020   to room_id...  
+0000ffc0: 2020 4172 6775 6d65 6e74 733a 0a20 2020    Arguments:.   
+0000ffd0: 202d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063   ---------.    c
+0000ffe0: 6c69 656e 7420 3a20 6e69 6f20 636c 6965  lient : nio clie
+0000fff0: 6e74 0a20 2020 2061 6c69 6173 203a 2063  nt.    alias : c
+00010000: 616e 2062 6520 616e 2061 6c69 6173 2069  an be an alias i
+00010010: 6e20 7468 6520 666f 726d 206f 6620 2723  n the form of '#
+00010020: 736f 6d65 526f 6f6d 416c 6961 733a 6578  someRoomAlias:ex
+00010030: 616d 706c 652e 636f 6d27 0a20 2020 2020  ample.com'.     
+00010040: 2020 2063 616e 2061 6c73 6f20 6265 2061     can also be a
+00010050: 2072 6f6f 6d5f 6964 2069 6e20 7468 6520   room_id in the 
+00010060: 666f 726d 206f 6620 2721 736f 6d65 526f  form of '!someRo
+00010070: 6f6d 4964 3a65 7861 6d70 6c65 2e63 6f6d  omId:example.com
+00010080: 270a 0a20 2020 2072 6f6f 6d5f 6964 203a  '..    room_id :
+00010090: 2072 6f6f 6d20 6672 6f6d 2063 7265 6465   room from crede
+000100a0: 6e74 6961 6c73 2066 696c 650a 0a20 2020  ntials file..   
+000100b0: 2049 6620 616e 2061 6c69 6173 2074 7279   If an alias try
+000100c0: 2074 6f20 6765 7420 7468 6520 636f 7272   to get the corr
+000100d0: 6573 706f 6e64 696e 6720 726f 6f6d 5f69  esponding room_i
+000100e0: 642e 0a20 2020 2049 6620 616e 7974 6869  d..    If anythi
+000100f0: 6e67 2066 6169 6c73 2069 7420 7265 7475  ng fails it retu
+00010100: 726e 7320 7468 6520 6f72 6967 696e 616c  rns the original
+00010110: 2069 6e70 7574 2e0a 0a20 2020 2052 6574   input...    Ret
+00010120: 7572 6e20 636f 7272 6573 706f 6e64 696e  urn correspondin
+00010130: 6720 726f 6f6d 5f69 6420 6f72 206f 6e20  g room_id or on 
+00010140: 6661 696c 7572 6520 7468 6520 6f72 6967  failure the orig
+00010150: 696e 616c 2061 6c69 6173 2e0a 0a20 2020  inal alias...   
+00010160: 2022 2222 0a20 2020 2072 6574 203d 2061   """.    ret = a
+00010170: 6c69 6173 0a20 2020 2069 6620 6973 5f72  lias.    if is_r
+00010180: 6f6f 6d5f 616c 6961 7328 616c 6961 7329  oom_alias(alias)
+00010190: 3a0a 2020 2020 2020 2020 7265 7370 203d  :.        resp =
+000101a0: 2061 7761 6974 2063 6c69 656e 742e 726f   await client.ro
+000101b0: 6f6d 5f72 6573 6f6c 7665 5f61 6c69 6173  om_resolve_alias
+000101c0: 2861 6c69 6173 290a 2020 2020 2020 2020  (alias).        
+000101d0: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
+000101e0: 7370 2c20 526f 6f6d 5265 736f 6c76 6541  sp, RoomResolveA
+000101f0: 6c69 6173 4572 726f 7229 3a0a 2020 2020  liasError):.    
+00010200: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
+00010210: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+00010220: 2020 2020 2020 2245 3132 323a 2022 0a20        "E122: ". 
+00010230: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00010240: 2272 6f6f 6d5f 7265 736f 6c76 655f 616c  "room_resolve_al
+00010250: 6961 7320 666f 7220 616c 6961 7320 7b61  ias for alias {a
+00010260: 6c69 6173 7d20 6661 696c 6564 2077 6974  lias} failed wit
+00010270: 6820 220a 2020 2020 2020 2020 2020 2020  h ".            
+00010280: 2020 2020 6622 7b70 7269 7661 6379 5f66      f"{privacy_f
+00010290: 696c 7465 7228 7374 7228 7265 7370 2929  ilter(str(resp))
+000102a0: 7d2e 2022 0a20 2020 2020 2020 2020 2020  }. ".           
+000102b0: 2020 2020 2066 2254 7279 696e 6720 6f70       f"Trying op
+000102c0: 6572 6174 696f 6e20 7769 7468 2069 6e70  eration with inp
+000102d0: 7574 207b 616c 6961 737d 2061 6e79 7761  ut {alias} anywa
+000102e0: 792e 204d 6967 6874 2066 6169 6c2e 220a  y. Might fail.".
+000102f0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00010300: 2020 2020 2020 2020 2020 6773 2e65 7272            gs.err
+00010310: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
+00010320: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00010330: 2020 2020 2020 7265 7420 3d20 7265 7370        ret = resp
+00010340: 2e72 6f6f 6d5f 6964 0a20 2020 2020 2020  .room_id.       
+00010350: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
+00010360: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+00010370: 2020 2066 274d 6170 7065 6420 726f 6f6d     f'Mapped room
+00010380: 2061 6c69 6173 2022 7b61 6c69 6173 7d22   alias "{alias}"
+00010390: 2074 6f20 726f 6f6d 2069 6420 227b 7265   to room id "{re
+000103a0: 747d 222e 2027 0a20 2020 2020 2020 2020  t}". '.         
+000103b0: 2020 2020 2020 2066 2228 7b72 6573 702e         f"({resp.
+000103c0: 726f 6f6d 5f61 6c69 6173 7d2c 207b 7265  room_alias}, {re
+000103d0: 7370 2e72 6f6f 6d5f 6964 7d29 2e22 0a20  sp.room_id}).". 
+000103e0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+000103f0: 2072 6574 7572 6e20 7265 740a 0a0a 6465   return ret...de
+00010400: 6620 6465 6661 756c 745f 686f 6d65 7365  f default_homese
+00010410: 7276 6572 2863 7265 6465 6e74 6961 6c73  rver(credentials
+00010420: 3a20 6469 6374 293a 0a20 2020 2022 2222  : dict):.    """
+00010430: 4765 7420 7468 6520 6465 6661 756c 7420  Get the default 
+00010440: 686f 6d65 7365 7276 6572 2028 646f 6d61  homeserver (doma
+00010450: 696e 2920 6672 6f6d 2074 6865 2063 7265  in) from the cre
+00010460: 6465 6e74 6961 6c73 2066 696c 652e 0a20  dentials file.. 
+00010470: 2020 2055 7365 2074 6865 2075 7365 725f     Use the user_
+00010480: 6964 2c20 6e6f 7420 7468 6520 726f 6f6d  id, not the room
+00010490: 5f69 642e 2054 6865 2072 6f6f 6d5f 6964  _id. The room_id
+000104a0: 2063 6f75 6c64 2062 6520 6f6e 2061 0a20   could be on a. 
+000104b0: 2020 2064 6966 6665 7265 6e74 2073 6572     different ser
+000104c0: 7665 7220 6f77 6e65 6420 6279 2073 6f6d  ver owned by som
+000104d0: 656f 6e65 2065 6c73 652e 2075 7365 725f  eone else. user_
+000104e0: 6964 206d 616b 6573 206d 6f72 6520 7365  id makes more se
+000104f0: 6e73 652e 0a20 2020 2022 2222 0a20 2020  nse..    """.   
+00010500: 2075 7365 7220 3d20 6372 6564 656e 7469   user = credenti
+00010510: 616c 735b 2275 7365 725f 6964 225d 2020  als["user_id"]  
+00010520: 2320 7768 6f20 616d 2069 0a20 2020 2068  # who am i.    h
+00010530: 6f6d 6573 6572 7665 7220 3d20 7573 6572  omeserver = user
+00010540: 2e70 6172 7469 7469 6f6e 2822 3a22 295b  .partition(":")[
+00010550: 325d 0a20 2020 2072 6574 7572 6e20 686f  2].    return ho
+00010560: 6d65 7365 7276 6572 2020 2320 6d61 7472  meserver  # matr
+00010570: 6978 2e65 7861 6d70 6c65 2e63 6f6d 0a0a  ix.example.com..
+00010580: 0a64 6566 2073 686f 7274 5f72 6f6f 6d5f  .def short_room_
+00010590: 616c 6961 735f 746f 5f72 6f6f 6d5f 616c  alias_to_room_al
+000105a0: 6961 7328 7368 6f72 745f 726f 6f6d 5f61  ias(short_room_a
+000105b0: 6c69 6173 3a20 7374 722c 2063 7265 6465  lias: str, crede
+000105c0: 6e74 6961 6c73 3a20 6469 6374 293a 0a20  ntials: dict):. 
+000105d0: 2020 2022 2222 436f 6e76 6572 7420 2753     """Convert 'S
+000105e0: 6f6d 6552 6f6f 6d41 6c69 6173 2720 746f  omeRoomAlias' to
+000105f0: 2027 2723 536f 6d65 546f 6f6d 416c 6961   ''#SomeToomAlia
+00010600: 733a 6d61 7472 6978 2e65 7861 6d70 6c65  s:matrix.example
+00010610: 2e63 6f6d 272e 0a20 2020 2043 6f6e 7665  .com'..    Conve
+00010620: 7274 7320 7368 6f72 7420 6361 6e6f 6e69  rts short canoni
+00010630: 6361 6c20 6c6f 6361 6c20 726f 6f6d 2061  cal local room a
+00010640: 6c69 6173 2074 6f20 6675 6c6c 2072 6f6f  lias to full roo
+00010650: 6d20 616c 6961 732e 0a20 2020 2022 2222  m alias..    """
+00010660: 0a20 2020 2069 6620 7368 6f72 745f 726f  .    if short_ro
+00010670: 6f6d 5f61 6c69 6173 2069 6e20 284e 6f6e  om_alias in (Non
+00010680: 652c 2022 2229 3a0a 2020 2020 2020 2020  e, ""):.        
+00010690: 6572 7220 3d20 2245 3132 343a 2022 2022  err = "E124: " "
+000106a0: 496e 7661 6c69 6420 726f 6f6d 2061 6c69  Invalid room ali
+000106b0: 6173 2e20 416c 6961 7320 6973 206e 6f6e  as. Alias is non
+000106c0: 6520 6f72 2065 6d70 7479 2e22 0a20 2020  e or empty.".   
+000106d0: 2020 2020 2072 6169 7365 204d 6174 7269       raise Matri
+000106e0: 7843 6f6d 6d61 6e64 6572 4572 726f 7228  xCommanderError(
+000106f0: 6572 7229 2066 726f 6d20 4e6f 6e65 0a20  err) from None. 
+00010700: 2020 2069 6620 7368 6f72 745f 726f 6f6d     if short_room
+00010710: 5f61 6c69 6173 5b30 5d20 3d3d 2022 2322  _alias[0] == "#"
+00010720: 3a0a 2020 2020 2020 2020 7265 7420 3d20  :.        ret = 
+00010730: 7368 6f72 745f 726f 6f6d 5f61 6c69 6173  short_room_alias
+00010740: 202b 2022 3a22 202b 2064 6566 6175 6c74   + ":" + default
+00010750: 5f68 6f6d 6573 6572 7665 7228 6372 6564  _homeserver(cred
+00010760: 656e 7469 616c 7329 0a20 2020 2065 6c73  entials).    els
+00010770: 653a 0a20 2020 2020 2020 2072 6574 203d  e:.        ret =
+00010780: 2022 2322 202b 2073 686f 7274 5f72 6f6f   "#" + short_roo
+00010790: 6d5f 616c 6961 7320 2b20 223a 2220 2b20  m_alias + ":" + 
+000107a0: 6465 6661 756c 745f 686f 6d65 7365 7276  default_homeserv
+000107b0: 6572 2863 7265 6465 6e74 6961 6c73 290a  er(credentials).
+000107c0: 2020 2020 7265 7475 726e 2072 6574 0a0a      return ret..
+000107d0: 0a64 6566 2072 6f6f 6d5f 616c 6961 735f  .def room_alias_
+000107e0: 746f 5f73 686f 7274 5f72 6f6f 6d5f 616c  to_short_room_al
+000107f0: 6961 7328 726f 6f6d 5f61 6c69 6173 3a20  ias(room_alias: 
+00010800: 7374 722c 2063 7265 6465 6e74 6961 6c73  str, credentials
+00010810: 3a20 6469 6374 293a 0a20 2020 2022 2222  : dict):.    """
+00010820: 436f 6e76 6572 7420 2723 536f 6d65 546f  Convert '#SomeTo
+00010830: 6f6d 416c 6961 733a 6d61 7472 6978 2e65  omAlias:matrix.e
+00010840: 7861 6d70 6c65 2e63 6f6d 2720 746f 2027  xample.com' to '
+00010850: 536f 6d65 526f 6f6d 416c 6961 7327 2e0a  SomeRoomAlias'..
+00010860: 2020 2020 436f 6e76 6572 7473 2066 756c      Converts ful
+00010870: 6c20 726f 6f6d 2061 6c69 6173 2074 6f20  l room alias to 
+00010880: 7368 6f72 7420 6361 6e6f 6e69 6361 6c20  short canonical 
+00010890: 6c6f 6361 6c20 726f 6f6d 2061 6c69 6173  local room alias
+000108a0: 2e0a 2020 2020 2222 220a 2020 2020 7265  ..    """.    re
+000108b0: 7475 726e 2072 6f6f 6d5f 616c 6961 732e  turn room_alias.
+000108c0: 7370 6c69 7428 223a 2229 5b30 5d5b 313a  split(":")[0][1:
+000108d0: 5d0a 0a0a 6465 6620 7573 6572 5f69 645f  ]...def user_id_
+000108e0: 746f 5f73 686f 7274 5f75 7365 725f 6e61  to_short_user_na
+000108f0: 6d65 2875 7365 725f 6964 3a20 7374 7229  me(user_id: str)
+00010900: 3a0a 2020 2020 2222 2243 6f6e 7665 7274  :.    """Convert
+00010910: 2027 4073 6f6d 6575 7365 723a 6d61 7472   '@someuser:matr
+00010920: 6978 2e65 7861 6d70 6c65 2e63 6f6d 2720  ix.example.com' 
+00010930: 746f 2027 736f 6d65 7573 6572 272e 0a20  to 'someuser'.. 
+00010940: 2020 2043 6f6e 7665 7274 2066 756c 6c20     Convert full 
+00010950: 7573 6572 5f69 6420 746f 2075 7365 7220  user_id to user 
+00010960: 6e69 636b 206e 616d 652e 0a20 2020 2022  nick name..    "
+00010970: 2222 0a20 2020 2072 6574 7572 6e20 7573  "".    return us
+00010980: 6572 5f69 642e 7370 6c69 7428 223a 2229  er_id.split(":")
+00010990: 5b30 5d5b 313a 5d0a 0a0a 6465 6620 7368  [0][1:]...def sh
+000109a0: 6f72 745f 7573 6572 5f6e 616d 655f 746f  ort_user_name_to
+000109b0: 5f75 7365 725f 6964 2873 686f 7274 5f75  _user_id(short_u
+000109c0: 7365 723a 2073 7472 2c20 6372 6564 656e  ser: str, creden
+000109d0: 7469 616c 733a 2064 6963 7429 3a0a 2020  tials: dict):.  
+000109e0: 2020 2222 2243 6f6e 7665 7274 2027 736f    """Convert 'so
+000109f0: 6d65 7573 6572 2720 746f 2027 4073 6f6d  meuser' to '@som
+00010a00: 6575 7365 723a 6d61 7472 6978 2e65 7861  euser:matrix.exa
+00010a10: 6d70 6c65 2e63 6f6d 272e 0a20 2020 2043  mple.com'..    C
+00010a20: 6f6e 7665 7274 2075 7365 7220 6e69 636b  onvert user nick
+00010a30: 206e 616d 6520 746f 2066 756c 6c20 7573   name to full us
+00010a40: 6572 5f69 642e 0a20 2020 2022 2222 0a20  er_id..    """. 
+00010a50: 2020 2072 6574 7572 6e20 2240 2220 2b20     return "@" + 
+00010a60: 7368 6f72 745f 7573 6572 202b 2022 3a22  short_user + ":"
+00010a70: 202b 2064 6566 6175 6c74 5f68 6f6d 6573   + default_homes
+00010a80: 6572 7665 7228 6372 6564 656e 7469 616c  erver(credential
+00010a90: 7329 0a0a 0a64 6566 2069 735f 726f 6f6d  s)...def is_room
+00010aa0: 5f61 6c69 6173 2872 6f6f 6d5f 6964 3a20  _alias(room_id: 
+00010ab0: 7374 7229 202d 3e20 626f 6f6c 3a0a 2020  str) -> bool:.  
+00010ac0: 2020 2222 2244 6574 6572 6d69 6e65 2069    """Determine i
+00010ad0: 6620 726f 6f6d 2069 6465 6e74 6966 6965  f room identifie
+00010ae0: 7220 6973 2061 2072 6f6f 6d20 616c 6961  r is a room alia
+00010af0: 732e 0a0a 2020 2020 526f 6f6d 2061 6c69  s...    Room ali
+00010b00: 6173 6573 2061 7265 206f 6620 7379 6e74  ases are of synt
+00010b10: 6178 3a20 2373 6f6d 6561 6c69 6173 3a73  ax: #somealias:s
+00010b20: 6f6d 6573 6572 7665 720a 2020 2020 5468  omeserver.    Th
+00010b30: 6973 2069 7320 6e6f 7420 616e 2065 7868  is is not an exh
+00010b40: 6175 7374 6976 6520 6368 6563 6b21 0a0a  austive check!..
+00010b50: 2020 2020 2222 220a 2020 2020 6966 2028      """.    if (
+00010b60: 0a20 2020 2020 2020 2072 6f6f 6d5f 6964  .        room_id
+00010b70: 0a20 2020 2020 2020 2061 6e64 206c 656e  .        and len
+00010b80: 2872 6f6f 6d5f 6964 2920 3e20 330a 2020  (room_id) > 3.  
+00010b90: 2020 2020 2020 616e 6420 2872 6f6f 6d5f        and (room_
+00010ba0: 6964 5b30 5d20 3d3d 2022 2322 290a 2020  id[0] == "#").  
+00010bb0: 2020 2020 2020 616e 6420 2822 2322 206e        and ("#" n
+00010bc0: 6f74 2069 6e20 726f 6f6d 5f69 645b 313a  ot in room_id[1:
+00010bd0: 5d29 0a20 2020 2020 2020 2061 6e64 2028  ]).        and (
+00010be0: 223a 2220 696e 2072 6f6f 6d5f 6964 290a  ":" in room_id).
+00010bf0: 2020 2020 2020 2020 616e 6420 726f 6f6d          and room
+00010c00: 5f69 642e 636f 756e 7428 223a 2229 203d  _id.count(":") =
+00010c10: 3d20 310a 2020 2020 2020 2020 616e 6420  = 1.        and 
+00010c20: 2822 2022 206e 6f74 2069 6e20 726f 6f6d  (" " not in room
+00010c30: 5f69 6429 0a20 2020 2020 2020 2061 6e64  _id).        and
+00010c40: 206e 6f74 2061 6e79 2865 6c65 6d20 696e   not any(elem in
+00010c50: 2072 6f6f 6d5f 6964 2066 6f72 2065 6c65   room_id for ele
+00010c60: 6d20 696e 2022 5b5d 7b7d 2022 2920 2023  m in "[]{} ")  #
+00010c70: 2063 6f6e 7461 696e 7320 6261 6420 6368   contains bad ch
+00010c80: 6172 733f 0a20 2020 2029 3a0a 2020 2020  ars?.    ):.    
+00010c90: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
+00010ca0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00010cb0: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
+00010cc0: 0a64 6566 2069 735f 726f 6f6d 5f69 6428  .def is_room_id(
+00010cd0: 726f 6f6d 5f69 643a 2073 7472 2920 2d3e  room_id: str) ->
+00010ce0: 2062 6f6f 6c3a 0a20 2020 2022 2222 4465   bool:.    """De
+00010cf0: 7465 726d 696e 6520 6966 2072 6f6f 6d20  termine if room 
+00010d00: 6964 656e 7469 6669 6572 2069 7320 6120  identifier is a 
+00010d10: 7661 6c69 6420 726f 6f6d 2069 642e 0a0a  valid room id...
+00010d20: 2020 2020 526f 6f6d 2069 6473 2061 7265      Room ids are
+00010d30: 206f 6620 7379 6e74 6178 3a20 2173 6f6d   of syntax: !som
+00010d40: 6561 6c69 6173 3a73 6f6d 6573 6572 7665  ealias:someserve
+00010d50: 720a 2020 2020 5468 6973 2069 7320 6e6f  r.    This is no
+00010d60: 7420 616e 2065 7868 6175 7374 6976 6520  t an exhaustive 
+00010d70: 6368 6563 6b21 0a0a 2020 2020 2222 220a  check!..    """.
+00010d80: 2020 2020 6966 2028 0a20 2020 2020 2020      if (.       
+00010d90: 2072 6f6f 6d5f 6964 0a20 2020 2020 2020   room_id.       
+00010da0: 2061 6e64 206c 656e 2872 6f6f 6d5f 6964   and len(room_id
+00010db0: 2920 3e20 330a 2020 2020 2020 2020 616e  ) > 3.        an
+00010dc0: 6420 2872 6f6f 6d5f 6964 5b30 5d20 3d3d  d (room_id[0] ==
+00010dd0: 2022 2122 290a 2020 2020 2020 2020 616e   "!").        an
+00010de0: 6420 2822 2322 206e 6f74 2069 6e20 726f  d ("#" not in ro
+00010df0: 6f6d 5f69 6429 0a20 2020 2020 2020 2061  om_id).        a
+00010e00: 6e64 2028 223a 2220 696e 2072 6f6f 6d5f  nd (":" in room_
+00010e10: 6964 290a 2020 2020 2020 2020 616e 6420  id).        and 
+00010e20: 726f 6f6d 5f69 642e 636f 756e 7428 223a  room_id.count(":
+00010e30: 2229 203d 3d20 310a 2020 2020 2020 2020  ") == 1.        
+00010e40: 616e 6420 2822 2022 206e 6f74 2069 6e20  and (" " not in 
+00010e50: 726f 6f6d 5f69 6429 0a20 2020 2029 3a0a  room_id).    ):.
+00010e60: 2020 2020 2020 2020 7265 7475 726e 2054          return T
+00010e70: 7275 650a 2020 2020 656c 7365 3a0a 2020  rue.    else:.  
+00010e80: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
+00010e90: 7365 0a0a 0a64 6566 2069 735f 726f 6f6d  se...def is_room
+00010ea0: 2872 6f6f 6d5f 6964 3a20 7374 7229 202d  (room_id: str) -
+00010eb0: 3e20 626f 6f6c 3a0a 2020 2020 2222 2244  > bool:.    """D
+00010ec0: 6574 6572 6d69 6e65 2069 6620 726f 6f6d  etermine if room
+00010ed0: 2069 6420 6973 2061 2076 616c 6964 2072   id is a valid r
+00010ee0: 6f6f 6d20 6964 206f 7220 6120 7661 6c69  oom id or a vali
+00010ef0: 6420 726f 6f6d 2061 6c69 6173 2e0a 0a20  d room alias... 
+00010f00: 2020 2054 6869 7320 6973 206e 6f74 2061     This is not a
+00010f10: 6e20 6578 6861 7573 7469 7665 2063 6865  n exhaustive che
+00010f20: 636b 210a 0a20 2020 2022 2222 0a20 2020  ck!..    """.   
+00010f30: 2072 6574 7572 6e20 6973 5f72 6f6f 6d5f   return is_room_
+00010f40: 6964 2872 6f6f 6d5f 6964 2920 6f72 2069  id(room_id) or i
+00010f50: 735f 726f 6f6d 5f61 6c69 6173 2872 6f6f  s_room_alias(roo
+00010f60: 6d5f 6964 290a 0a0a 6465 6620 6973 5f73  m_id)...def is_s
+00010f70: 686f 7274 5f72 6f6f 6d5f 616c 6961 7328  hort_room_alias(
+00010f80: 726f 6f6d 5f69 643a 2073 7472 2920 2d3e  room_id: str) ->
+00010f90: 2062 6f6f 6c3a 0a20 2020 2022 2222 4465   bool:.    """De
+00010fa0: 7465 726d 696e 6520 6966 2072 6f6f 6d20  termine if room 
+00010fb0: 6964 656e 7469 6669 6572 2069 7320 6120  identifier is a 
+00010fc0: 6c6f 6361 6c20 7061 7274 206f 6620 6361  local part of ca
+00010fd0: 6e6f 6e69 6361 6c20 726f 6f6d 2061 6c69  nonical room ali
+00010fe0: 6173 2e0a 0a20 2020 204c 6f63 616c 2070  as...    Local p
+00010ff0: 6172 7473 206f 6620 6361 6e6f 6e69 6361  arts of canonica
+00011000: 6c20 726f 6f6d 2061 6c69 6173 6573 2061  l room aliases a
+00011010: 7265 206f 6620 7379 6e74 6178 3a20 736f  re of syntax: so
+00011020: 6d65 616c 6961 730a 0a20 2020 204e 6f77  mealias..    Now
+00011030: 2061 6c73 6f20 616c 6c6f 7769 6e67 2023   also allowing #
+00011040: 736f 6d65 616c 6961 730a 0a20 2020 2022  somealias..    "
+00011050: 2222 0a20 2020 2069 6620 280a 2020 2020  "".    if (.    
+00011060: 2020 2020 726f 6f6d 5f69 640a 2020 2020      room_id.    
+00011070: 2020 2020 616e 6420 6c65 6e28 726f 6f6d      and len(room
+00011080: 5f69 6429 203e 2030 0a20 2020 2020 2020  _id) > 0.       
+00011090: 2061 6e64 2072 6f6f 6d5f 6964 2021 3d20   and room_id != 
+000110a0: 2223 220a 2020 2020 2020 2020 616e 6420  "#".        and 
+000110b0: 2822 3a22 206e 6f74 2069 6e20 726f 6f6d  (":" not in room
+000110c0: 5f69 6429 0a20 2020 2020 2020 2061 6e64  _id).        and
+000110d0: 2028 2223 2220 6e6f 7420 696e 2072 6f6f   ("#" not in roo
+000110e0: 6d5f 6964 5b31 3a5d 290a 2020 2020 2020  m_id[1:]).      
+000110f0: 2020 616e 6420 286e 6f74 2072 6f6f 6d5f    and (not room_
+00011100: 6964 2e73 7461 7274 7377 6974 6828 2221  id.startswith("!
+00011110: 2229 290a 2020 2020 2020 2020 616e 6420  ")).        and 
+00011120: 286e 6f74 2072 6f6f 6d5f 6964 2e73 7461  (not room_id.sta
+00011130: 7274 7377 6974 6828 2240 2229 290a 2020  rtswith("@")).  
+00011140: 2020 2020 2020 616e 6420 2822 2022 206e        and (" " n
+00011150: 6f74 2069 6e20 726f 6f6d 5f69 6429 0a20  ot in room_id). 
+00011160: 2020 2029 3a0a 2020 2020 2020 2020 7265     ):.        re
+00011170: 7475 726e 2054 7275 650a 2020 2020 656c  turn True.    el
+00011180: 7365 3a0a 2020 2020 2020 2020 7265 7475  se:.        retu
+00011190: 726e 2046 616c 7365 0a0a 0a64 6566 2069  rn False...def i
+000111a0: 735f 7573 6572 5f69 6428 7573 6572 5f69  s_user_id(user_i
+000111b0: 643a 2073 7472 2920 2d3e 2062 6f6f 6c3a  d: str) -> bool:
+000111c0: 0a20 2020 2022 2222 4465 7465 726d 696e  .    """Determin
+000111d0: 6520 6966 2075 7365 7220 6964 656e 7469  e if user identi
+000111e0: 6669 6572 2069 7320 6120 7661 6c69 6420  fier is a valid 
+000111f0: 7573 6572 2069 642e 0a0a 2020 2020 5573  user id...    Us
+00011200: 6572 2069 6473 2061 7265 206f 6620 7379  er ids are of sy
+00011210: 6e74 6178 3a20 4073 6f6d 6575 7365 723a  ntax: @someuser:
+00011220: 736f 6d65 7365 7276 6572 0a20 2020 2054  someserver.    T
+00011230: 6869 7320 6973 206e 6f74 2061 6e20 6578  his is not an ex
+00011240: 6861 7573 7469 7665 2063 6865 636b 210a  haustive check!.
+00011250: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
+00011260: 280a 2020 2020 2020 2020 7573 6572 5f69  (.        user_i
+00011270: 640a 2020 2020 2020 2020 616e 6420 6c65  d.        and le
+00011280: 6e28 7573 6572 5f69 6429 203e 2033 0a20  n(user_id) > 3. 
+00011290: 2020 2020 2020 2061 6e64 2028 7573 6572         and (user
+000112a0: 5f69 645b 305d 203d 3d20 2240 2229 0a20  _id[0] == "@"). 
+000112b0: 2020 2020 2020 2061 6e64 2028 223a 2220         and (":" 
+000112c0: 696e 2075 7365 725f 6964 290a 2020 2020  in user_id).    
+000112d0: 2020 2020 616e 6420 2822 2022 206e 6f74      and (" " not
+000112e0: 2069 6e20 7573 6572 5f69 6429 0a20 2020   in user_id).   
+000112f0: 2029 3a0a 2020 2020 2020 2020 7265 7475   ):.        retu
+00011300: 726e 2054 7275 650a 2020 2020 656c 7365  rn True.    else
+00011310: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00011320: 2046 616c 7365 0a0a 0a64 6566 2069 735f   False...def is_
+00011330: 7368 6f72 745f 7573 6572 5f69 6428 7573  short_user_id(us
+00011340: 6572 5f69 643a 2073 7472 2920 2d3e 2062  er_id: str) -> b
+00011350: 6f6f 6c3a 0a20 2020 2022 2222 4465 7465  ool:.    """Dete
+00011360: 726d 696e 6520 6966 2075 7365 7220 6964  rmine if user id
+00011370: 656e 7469 6669 6572 2069 7320 6120 7661  entifier is a va
+00011380: 6c69 6420 7368 6f72 7420 7573 6572 2069  lid short user i
+00011390: 642e 0a0a 2020 2020 5368 6f72 7420 7573  d...    Short us
+000113a0: 6572 2069 6473 2061 7265 206f 6620 7379  er ids are of sy
+000113b0: 6e74 6178 3a20 736f 6d65 7573 6572 0a20  ntax: someuser. 
+000113c0: 2020 2054 6869 7320 6973 206e 6f74 2061     This is not a
+000113d0: 6e20 6578 6861 7573 7469 7665 2063 6865  n exhaustive che
+000113e0: 636b 210a 0a20 2020 2022 2222 0a20 2020  ck!..    """.   
+000113f0: 2069 6620 280a 2020 2020 2020 2020 7573   if (.        us
+00011400: 6572 5f69 640a 2020 2020 2020 2020 616e  er_id.        an
+00011410: 6420 6c65 6e28 7573 6572 5f69 6429 203e  d len(user_id) >
+00011420: 2030 0a20 2020 2020 2020 2061 6e64 2028   0.        and (
+00011430: 223a 2220 6e6f 7420 696e 2075 7365 725f  ":" not in user_
+00011440: 6964 290a 2020 2020 2020 2020 616e 6420  id).        and 
+00011450: 2822 4022 206e 6f74 2069 6e20 7573 6572  ("@" not in user
+00011460: 5f69 6429 0a20 2020 2020 2020 2061 6e64  _id).        and
+00011470: 2028 2220 2220 6e6f 7420 696e 2075 7365   (" " not in use
+00011480: 725f 6964 290a 2020 2020 293a 0a20 2020  r_id).    ):.   
+00011490: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
+000114a0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+000114b0: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+000114c0: 0a0a 6465 6620 6973 5f70 6172 7469 616c  ..def is_partial
+000114d0: 5f75 7365 725f 6964 2875 7365 725f 6964  _user_id(user_id
+000114e0: 3a20 7374 7229 202d 3e20 626f 6f6c 3a0a  : str) -> bool:.
+000114f0: 2020 2020 2222 2244 6574 6572 6d69 6e65      """Determine
+00011500: 2069 6620 7573 6572 2069 6465 6e74 6966   if user identif
+00011510: 6965 7220 6973 2061 2076 616c 6964 2061  ier is a valid a
+00011520: 6262 7265 7669 6174 6564 2075 7365 7220  bbreviated user 
+00011530: 6964 2e0a 0a20 2020 2041 6262 7265 762e  id...    Abbrev.
+00011540: 2075 7365 7220 6964 7320 6172 6520 6f66   user ids are of
+00011550: 2073 796e 7461 783a 2040 736f 6d65 7573   syntax: @someus
+00011560: 6572 0a20 2020 2054 6869 7320 6973 206e  er.    This is n
+00011570: 6f74 2061 6e20 6578 6861 7573 7469 7665  ot an exhaustive
+00011580: 2063 6865 636b 210a 0a20 2020 2022 2222   check!..    """
+00011590: 0a20 2020 2069 6620 280a 2020 2020 2020  .    if (.      
+000115a0: 2020 7573 6572 5f69 640a 2020 2020 2020    user_id.      
+000115b0: 2020 616e 6420 6c65 6e28 7573 6572 5f69    and len(user_i
+000115c0: 6429 203e 2031 0a20 2020 2020 2020 2061  d) > 1.        a
+000115d0: 6e64 2028 7573 6572 5f69 645b 305d 203d  nd (user_id[0] =
+000115e0: 3d20 2240 2229 0a20 2020 2020 2020 2061  = "@").        a
+000115f0: 6e64 2028 223a 2220 6e6f 7420 696e 2075  nd (":" not in u
+00011600: 7365 725f 6964 290a 2020 2020 2020 2020  ser_id).        
+00011610: 616e 6420 2822 2022 206e 6f74 2069 6e20  and (" " not in 
+00011620: 7573 6572 5f69 6429 0a20 2020 2029 3a0a  user_id).    ):.
+00011630: 2020 2020 2020 2020 7265 7475 726e 2054          return T
+00011640: 7275 650a 2020 2020 656c 7365 3a0a 2020  rue.    else:.  
+00011650: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
+00011660: 7365 0a0a 0a64 6566 2069 735f 7573 6572  se...def is_user
+00011670: 2875 7365 725f 6964 3a20 7374 7229 202d  (user_id: str) -
+00011680: 3e20 626f 6f6c 3a0a 2020 2020 2222 2244  > bool:.    """D
+00011690: 6574 6572 6d69 6e65 2069 6620 7573 6572  etermine if user
+000116a0: 2069 6420 6973 2061 2076 616c 6964 2075   id is a valid u
+000116b0: 7365 7220 6964 206f 7220 6120 7661 6c69  ser id or a vali
+000116c0: 6420 7368 6f72 7420 7573 6572 2069 642e  d short user id.
+000116d0: 0a0a 2020 2020 5468 6973 2069 7320 6e6f  ..    This is no
+000116e0: 7420 616e 2065 7868 6175 7374 6976 6520  t an exhaustive 
+000116f0: 6368 6563 6b21 0a0a 2020 2020 2222 220a  check!..    """.
+00011700: 2020 2020 7265 7475 726e 2028 0a20 2020      return (.   
+00011710: 2020 2020 2069 735f 7573 6572 5f69 6428       is_user_id(
+00011720: 7573 6572 5f69 6429 0a20 2020 2020 2020  user_id).       
+00011730: 206f 7220 6973 5f70 6172 7469 616c 5f75   or is_partial_u
+00011740: 7365 725f 6964 2875 7365 725f 6964 290a  ser_id(user_id).
+00011750: 2020 2020 2020 2020 6f72 2069 735f 7368          or is_sh
+00011760: 6f72 745f 7573 6572 5f69 6428 7573 6572  ort_user_id(user
+00011770: 5f69 6429 0a20 2020 2029 0a0a 0a61 7379  _id).    )...asy
+00011780: 6e63 2064 6566 2061 6374 696f 6e5f 726f  nc def action_ro
+00011790: 6f6d 5f64 6d5f 6372 6561 7465 2863 6c69  om_dm_create(cli
+000117a0: 656e 743a 2041 7379 6e63 436c 6965 6e74  ent: AsyncClient
+000117b0: 2c20 6372 6564 656e 7469 616c 733a 2064  , credentials: d
+000117c0: 6963 7429 3a0a 2020 2020 2222 2243 7265  ict):.    """Cre
+000117d0: 6174 6520 6120 6469 7265 6374 206d 6573  ate a direct mes
+000117e0: 7361 6765 2028 444d 2920 726f 6f6d 2077  sage (DM) room w
+000117f0: 6869 6c65 2061 6c72 6561 6479 2062 6569  hile already bei
+00011800: 6e67 206c 6f67 6765 6420 696e 2e0a 0a20  ng logged in... 
+00011810: 2020 2041 6674 6572 2063 7265 6174 696e     After creatin
+00011820: 6720 7468 6520 7072 6976 6174 6520 444d  g the private DM
+00011830: 2072 6f6f 6d20 6974 2069 6e76 6974 6573   room it invites
+00011840: 2074 6865 206f 7468 6572 2075 7365 7220   the other user 
+00011850: 746f 2069 742e 0a0a 2020 2020 4172 6775  to it...    Argu
+00011860: 6d65 6e74 733a 0a20 2020 202d 2d2d 2d2d  ments:.    -----
+00011870: 2d2d 2d2d 0a20 2020 2063 6c69 656e 743a  ----.    client:
+00011880: 2041 7379 6e63 436c 6965 6e74 3a20 6e69   AsyncClient: ni
+00011890: 6f20 636c 6965 6e74 2c20 616c 6c6f 7773  o client, allows
+000118a0: 2061 7320 746f 2071 7565 7279 2074 6865   as to query the
+000118b0: 2073 6572 7665 720a 2020 2020 6372 6564   server.    cred
+000118c0: 656e 7469 616c 733a 2064 6963 743a 2061  entials: dict: a
+000118d0: 6c6c 6f77 7320 746f 2067 6574 2074 6865  llows to get the
+000118e0: 2075 7365 725f 6964 206f 6620 7365 6e64   user_id of send
+000118f0: 6572 2c20 6574 630a 2020 2020 2222 220a  er, etc.    """.
+00011900: 2020 2020 2320 7573 6572 7320 3a20 6c69      # users : li
+00011910: 7374 206f 6620 7573 6572 7320 746f 2063  st of users to c
+00011920: 7265 6174 6520 444d 2072 6f6f 6d73 2077  reate DM rooms w
+00011930: 6974 680a 2020 2020 2320 726f 6f6d 5f61  ith.    # room_a
+00011940: 6c69 6173 6573 203a 206c 6973 7420 6f66  liases : list of
+00011950: 2072 6f6f 6d20 616c 6961 7365 7320 696e   room aliases in
+00011960: 2074 6865 2066 6f72 6d20 6f66 2022 7361   the form of "sa
+00011970: 6d70 6c65 416c 6961 7322 0a20 2020 2023  mpleAlias".    #
+00011980: 2020 2020 2020 2020 2054 6865 7365 2061           These a
+00011990: 6c69 6173 6573 2077 696c 6c20 7468 656e  liases will then
+000119a0: 2062 6520 7573 6564 2062 7920 7468 6520   be used by the 
+000119b0: 7365 7276 6572 2061 6e64 0a20 2020 2023  server and.    #
+000119c0: 2020 2020 2020 2020 2074 6865 2073 6572           the ser
+000119d0: 7665 7220 6372 6561 7465 7320 7468 6520  ver creates the 
+000119e0: 6465 6669 6e69 7465 2061 6c69 6173 2069  definite alias i
+000119f0: 6e20 7468 6520 666f 726d 0a20 2020 2023  n the form.    #
+00011a00: 2020 2020 2020 2020 206f 6620 2223 7361           of "#sa
+00011a10: 6d70 6c65 416c 6961 733a 6578 616d 706c  mpleAlias:exampl
+00011a20: 652e 636f 6d22 2066 726f 6d20 6974 2e0a  e.com" from it..
+00011a30: 2020 2020 2320 2020 2020 2020 2020 5765      #         We
+00011a40: 2070 6572 6d69 7420 2223 7361 6d70 6c65   permit "#sample
+00011a50: 416c 6961 733a 6578 616d 706c 652e 636f  Alias:example.co
+00011a60: 6d22 2061 6e64 2064 6f77 6e73 6361 6c65  m" and downscale
+00011a70: 2069 7420 746f 0a20 2020 2023 2020 2020   it to.    #    
+00011a80: 2020 2020 2022 7361 6d70 6c65 416c 6961       "sampleAlia
+00011a90: 7322 2e0a 2020 2020 2320 6e61 6d65 7320  s"..    # names 
+00011aa0: 3a20 6c69 7374 206f 6620 6e61 6d65 7320  : list of names 
+00011ab0: 666f 7220 726f 6f6d 730a 2020 2020 2320  for rooms.    # 
+00011ac0: 746f 7069 6320 3a20 726f 6f6d 2074 6f70  topic : room top
+00011ad0: 6963 730a 0a20 2020 2075 7365 7273 203d  ics..    users =
+00011ae0: 2067 732e 7061 2e72 6f6f 6d5f 646d 5f63   gs.pa.room_dm_c
+00011af0: 7265 6174 650a 2020 2020 726f 6f6d 5f61  reate.    room_a
+00011b00: 6c69 6173 6573 203d 2067 732e 7061 2e61  liases = gs.pa.a
+00011b10: 6c69 6173 0a20 2020 206e 616d 6573 203d  lias.    names =
+00011b20: 2067 732e 7061 2e6e 616d 650a 2020 2020   gs.pa.name.    
+00011b30: 746f 7069 6373 203d 2067 732e 7061 2e74  topics = gs.pa.t
+00011b40: 6f70 6963 0a20 2020 2074 7279 3a0a 2020  opic.    try:.  
+00011b50: 2020 2020 2020 696e 6465 7820 3d20 300a        index = 0.
+00011b60: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+00011b70: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
+00011b80: 2020 6627 5472 7969 6e67 2074 6f20 6372    f'Trying to cr
+00011b90: 6561 7465 2044 4d20 726f 6f6d 7320 7769  eate DM rooms wi
+00011ba0: 7468 2075 7365 7273 2022 7b75 7365 7273  th users "{users
+00011bb0: 7d22 2c20 270a 2020 2020 2020 2020 2020  }", '.          
+00011bc0: 2020 6627 726f 6f6d 2061 6c69 6173 6573    f'room aliases
+00011bd0: 2022 7b72 6f6f 6d5f 616c 6961 7365 737d   "{room_aliases}
+00011be0: 222c 2027 0a20 2020 2020 2020 2020 2020  ", '.           
+00011bf0: 2066 276e 616d 6573 2022 7b6e 616d 6573   f'names "{names
+00011c00: 7d22 2c20 616e 6420 746f 7069 6373 2022  }", and topics "
+00011c10: 7b74 6f70 6963 737d 222e 270a 2020 2020  {topics}".'.    
+00011c20: 2020 2020 290a 2020 2020 2020 2020 666f      ).        fo
+00011c30: 7220 7573 6572 2069 6e20 7573 6572 733a  r user in users:
+00011c40: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
+00011c50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00011c60: 2020 616c 6961 7320 3d20 726f 6f6d 5f61    alias = room_a
+00011c70: 6c69 6173 6573 5b69 6e64 6578 5d0a 2020  liases[index].  
+00011c80: 2020 2020 2020 2020 2020 2020 2020 616c                al
+00011c90: 6961 7320 3d20 616c 6961 732e 7265 706c  ias = alias.repl
+00011ca0: 6163 6528 7222 5c21 222c 2022 2122 2920  ace(r"\!", "!") 
+00011cb0: 2023 2072 656d 6f76 6520 706f 7373 6962   # remove possib
+00011cc0: 6c65 2065 7363 6170 650a 2020 2020 2020  le escape.      
+00011cd0: 2020 2020 2020 2020 2020 2320 616c 6961            # alia
+00011ce0: 7320 6973 2061 2074 7275 6520 616c 6961  s is a true alia
+00011cf0: 732c 206e 6f74 2061 2072 6f6f 6d20 6964  s, not a room id
+00011d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011d10: 2023 2069 6620 6279 206d 6973 7461 6b65   # if by mistake
+00011d20: 2075 7365 7220 6861 7320 6769 7665 6e20   user has given 
+00011d30: 6675 6c6c 2072 6f6f 6d20 616c 6961 732c  full room alias,
+00011d40: 2073 686f 7274 656e 2069 740a 2020 2020   shorten it.    
+00011d50: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+00011d60: 735f 726f 6f6d 5f61 6c69 6173 2861 6c69  s_room_alias(ali
+00011d70: 6173 293a 0a20 2020 2020 2020 2020 2020  as):.           
+00011d80: 2020 2020 2020 2020 2061 6c69 6173 203d           alias =
+00011d90: 2072 6f6f 6d5f 616c 6961 735f 746f 5f73   room_alias_to_s
+00011da0: 686f 7274 5f72 6f6f 6d5f 616c 6961 7328  hort_room_alias(
+00011db0: 616c 6961 732c 2063 7265 6465 6e74 6961  alias, credentia
+00011dc0: 6c73 290a 2020 2020 2020 2020 2020 2020  ls).            
+00011dd0: 6578 6365 7074 2028 496e 6465 7845 7272  except (IndexErr
+00011de0: 6f72 2c20 5479 7065 4572 726f 7229 3a0a  or, TypeError):.
+00011df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011e00: 616c 6961 7320 3d20 2222 0a20 2020 2020  alias = "".     
+00011e10: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00011e20: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+00011e30: 203d 206e 616d 6573 5b69 6e64 6578 5d0a   = names[index].
+00011e40: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+00011e50: 7074 2028 496e 6465 7845 7272 6f72 2c20  pt (IndexError, 
+00011e60: 5479 7065 4572 726f 7229 3a0a 2020 2020  TypeError):.    
+00011e70: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+00011e80: 203d 2022 220a 2020 2020 2020 2020 2020   = "".          
+00011e90: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00011ea0: 2020 2020 2020 2074 6f70 6963 203d 2074         topic = t
+00011eb0: 6f70 6963 735b 696e 6465 785d 0a20 2020  opics[index].   
+00011ec0: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+00011ed0: 2849 6e64 6578 4572 726f 722c 2054 7970  (IndexError, Typ
+00011ee0: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+00011ef0: 2020 2020 2020 2020 2074 6f70 6963 203d           topic =
+00011f00: 2022 220a 2020 2020 2020 2020 2020 2020   "".            
+00011f10: 616c 6961 7320 3d20 616c 6961 732e 7374  alias = alias.st
+00011f20: 7269 7028 290a 2020 2020 2020 2020 2020  rip().          
+00011f30: 2020 616c 6961 7320 3d20 4e6f 6e65 2069    alias = None i
+00011f40: 6620 616c 6961 7320 3d3d 2022 2220 656c  f alias == "" el
+00011f50: 7365 2061 6c69 6173 0a20 2020 2020 2020  se alias.       
+00011f60: 2020 2020 206e 616d 6520 3d20 6e61 6d65       name = name
+00011f70: 2e73 7472 6970 2829 0a20 2020 2020 2020  .strip().       
+00011f80: 2020 2020 206e 616d 6520 3d20 4e6f 6e65       name = None
+00011f90: 2069 6620 6e61 6d65 203d 3d20 2222 2065   if name == "" e
+00011fa0: 6c73 6520 6e61 6d65 0a20 2020 2020 2020  lse name.       
+00011fb0: 2020 2020 2074 6f70 6963 203d 2074 6f70       topic = top
+00011fc0: 6963 2e73 7472 6970 2829 0a20 2020 2020  ic.strip().     
+00011fd0: 2020 2020 2020 2074 6f70 6963 203d 204e         topic = N
+00011fe0: 6f6e 6520 6966 2074 6f70 6963 203d 3d20  one if topic == 
+00011ff0: 2222 2065 6c73 6520 746f 7069 630a 2020  "" else topic.  
+00012000: 2020 2020 2020 2020 2020 6966 2067 732e            if gs.
+00012010: 7061 2e70 6c61 696e 3a0a 2020 2020 2020  pa.plain:.      
+00012020: 2020 2020 2020 2020 2020 656e 6372 7970            encryp
+00012030: 7420 3d20 4661 6c73 650a 2020 2020 2020  t = False.      
+00012040: 2020 2020 2020 2020 2020 696e 6974 6961            initia
+00012050: 6c5f 7374 6174 6520 3d20 2829 0a20 2020  l_state = ().   
+00012060: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00012070: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00012080: 6e63 7279 7074 203d 2054 7275 650a 2020  ncrypt = True.  
+00012090: 2020 2020 2020 2020 2020 2020 2020 696e                in
+000120a0: 6974 6961 6c5f 7374 6174 6520 3d20 5b45  itial_state = [E
+000120b0: 6e61 626c 6545 6e63 7279 7074 696f 6e42  nableEncryptionB
+000120c0: 7569 6c64 6572 2829 2e61 735f 6469 6374  uilder().as_dict
+000120d0: 2829 5d0a 2020 2020 2020 2020 2020 2020  ()].            
+000120e0: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
+000120f0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00012100: 4372 6561 7469 6e67 2044 4d20 726f 6f6d  Creating DM room
+00012110: 2077 6974 6820 7573 6572 2022 7b75 7365   with user "{use
+00012120: 727d 222c 2027 0a20 2020 2020 2020 2020  r}", '.         
+00012130: 2020 2020 2020 2066 2772 6f6f 6d20 616c         f'room al
+00012140: 6961 7320 227b 616c 6961 737d 222c 2027  ias "{alias}", '
+00012150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012160: 2066 276e 616d 6520 227b 6e61 6d65 7d22   f'name "{name}"
+00012170: 2c20 746f 7069 6320 227b 746f 7069 637d  , topic "{topic}
+00012180: 2220 616e 6420 270a 2020 2020 2020 2020  " and '.        
+00012190: 2020 2020 2020 2020 6627 656e 6372 7970          f'encryp
+000121a0: 7465 6420 227b 656e 6372 7970 747d 222e  ted "{encrypt}".
+000121b0: 270a 2020 2020 2020 2020 2020 2020 290a  '.            ).
+000121c0: 2020 2020 2020 2020 2020 2020 2320 6e69              # ni
+000121d0: 6f27 7320 726f 6f6d 5f63 7265 6174 6520  o's room_create 
+000121e0: 646f 6573 204e 4f54 2061 6363 6570 7420  does NOT accept 
+000121f0: 2223 666f 6f3a 6578 616d 706c 652e 636f  "#foo:example.co
+00012200: 6d22 0a20 2020 2020 2020 2020 2020 2072  m".            r
+00012210: 6573 7020 3d20 6177 6169 7420 636c 6965  esp = await clie
+00012220: 6e74 2e72 6f6f 6d5f 6372 6561 7465 280a  nt.room_create(.
+00012230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012240: 616c 6961 733d 616c 6961 732c 2020 2320  alias=alias,  # 
+00012250: 6465 7369 7265 6420 6361 6e6f 6e69 6361  desired canonica
+00012260: 6c20 616c 6961 7320 6c6f 6361 6c20 7061  l alias local pa
+00012270: 7274 2c20 652e 672e 2066 6f6f 0a20 2020  rt, e.g. foo.   
+00012280: 2020 2020 2020 2020 2020 2020 2076 6973               vis
+00012290: 6962 696c 6974 793d 526f 6f6d 5669 7369  ibility=RoomVisi
+000122a0: 6269 6c69 7479 2e70 7269 7661 7465 2c0a  bility.private,.
+000122b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000122c0: 6973 5f64 6972 6563 743d 5472 7565 2c0a  is_direct=True,.
+000122d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000122e0: 7072 6573 6574 3d52 6f6f 6d50 7265 7365  preset=RoomPrese
+000122f0: 742e 7072 6976 6174 655f 6368 6174 2c0a  t.private_chat,.
+00012300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012310: 696e 7669 7465 3d7b 7573 6572 7d2c 2020  invite={user},  
+00012320: 2320 696e 7669 7465 2074 6865 2075 7365  # invite the use
+00012330: 7220 746f 2074 6865 2044 4d0a 2020 2020  r to the DM.    
+00012340: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+00012350: 3d6e 616d 652c 2020 2320 726f 6f6d 206e  =name,  # room n
+00012360: 616d 650a 2020 2020 2020 2020 2020 2020  ame.            
+00012370: 2020 2020 746f 7069 633d 746f 7069 632c      topic=topic,
+00012380: 2020 2320 726f 6f6d 2074 6f70 6963 0a20    # room topic. 
+00012390: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000123a0: 6e69 7469 616c 5f73 7461 7465 3d69 6e69  nitial_state=ini
+000123b0: 7469 616c 5f73 7461 7465 2c0a 2020 2020  tial_state,.    
+000123c0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000123d0: 2020 2020 2020 2320 2261 6c69 6173 3122        # "alias1"
+000123e0: 2077 696c 6c20 6372 6561 7465 2061 2022   will create a "
+000123f0: 2361 6c69 6173 313a 6578 616d 706c 652e  #alias1:example.
+00012400: 636f 6d22 0a20 2020 2020 2020 2020 2020  com".           
+00012410: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
+00012420: 6573 702c 2052 6f6f 6d43 7265 6174 6545  esp, RoomCreateE
+00012430: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+00012440: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
+00012450: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+00012460: 2020 2020 2020 2020 2022 4531 3235 3a20           "E125: 
+00012470: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00012480: 2020 2020 2020 2252 6f6f 6d5f 6372 6561        "Room_crea
+00012490: 7465 2066 6169 6c65 6420 7769 7468 2072  te failed with r
+000124a0: 6573 706f 6e73 653a 2022 0a20 2020 2020  esponse: ".     
+000124b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000124c0: 227b 7072 6976 6163 795f 6669 6c74 6572  "{privacy_filter
+000124d0: 2873 7472 2872 6573 7029 297d 220a 2020  (str(resp))}".  
+000124e0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+000124f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012500: 6773 2e65 7272 5f63 6f75 6e74 202b 3d20  gs.err_count += 
+00012510: 310a 2020 2020 2020 2020 2020 2020 656c  1.            el
+00012520: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00012530: 2020 2020 6966 2061 6c69 6173 3a0a 2020      if alias:.  
+00012540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012550: 2020 6675 6c6c 5f61 6c69 6173 203d 2073    full_alias = s
+00012560: 686f 7274 5f72 6f6f 6d5f 616c 6961 735f  hort_room_alias_
+00012570: 746f 5f72 6f6f 6d5f 616c 6961 7328 0a20  to_room_alias(. 
+00012580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012590: 2020 2020 2020 2061 6c69 6173 2c20 6372         alias, cr
+000125a0: 6564 656e 7469 616c 730a 2020 2020 2020  edentials.      
+000125b0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+000125c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000125d0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000125e0: 2020 2020 2020 2020 2020 6675 6c6c 5f61            full_a
+000125f0: 6c69 6173 203d 204e 6f6e 650a 2020 2020  lias = None.    
+00012600: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+00012610: 6f67 2e69 6e66 6f28 0a20 2020 2020 2020  og.info(.       
+00012620: 2020 2020 2020 2020 2020 2020 2066 2743               f'C
+00012630: 7265 6174 6564 2044 4d20 726f 6f6d 2077  reated DM room w
+00012640: 6974 6820 726f 6f6d 2069 6420 227b 7265  ith room id "{re
+00012650: 7370 2e72 6f6f 6d5f 6964 7d22 2c20 270a  sp.room_id}", '.
+00012660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012670: 2020 2020 6627 7368 6f72 7420 616c 6961      f'short alia
+00012680: 7320 227b 7a6e 2861 6c69 6173 297d 222c  s "{zn(alias)}",
+00012690: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+000126a0: 2020 2020 2020 2066 2766 756c 6c20 616c         f'full al
+000126b0: 6961 7320 227b 7a6e 2866 756c 6c5f 616c  ias "{zn(full_al
+000126c0: 6961 7329 7d22 2061 6e64 2027 0a20 2020  ias)}" and '.   
+000126d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000126e0: 2066 2765 6e63 7279 7074 6564 2022 7b65   f'encrypted "{e
+000126f0: 6e63 7279 7074 7d22 2e27 0a20 2020 2020  ncrypt}".'.     
+00012700: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00012710: 2020 2020 2020 2020 2020 2020 2023 206f               # o
+00012720: 7574 7075 7420 666f 726d 6174 2063 6f6e  utput format con
+00012730: 7472 6f6c 6c65 6420 7669 6120 2d2d 6f75  trolled via --ou
+00012740: 7470 7574 2066 6c61 670a 2020 2020 2020  tput flag.      
+00012750: 2020 2020 2020 2020 2020 7465 7874 203d            text =
+00012760: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00012770: 2020 2020 2020 2066 227b 7265 7370 2e72         f"{resp.r
+00012780: 6f6f 6d5f 6964 7d7b 5345 507d 7b7a 6e28  oom_id}{SEP}{zn(
+00012790: 616c 6961 7329 7d7b 5345 507d 7b7a 6e28  alias)}{SEP}{zn(
+000127a0: 6675 6c6c 5f61 6c69 6173 297d 220a 2020  full_alias)}".  
+000127b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000127c0: 2020 6622 7b53 4550 7d7b 7a6e 286e 616d    f"{SEP}{zn(nam
+000127d0: 6529 7d7b 5345 507d 7b7a 6e28 746f 7069  e)}{SEP}{zn(topi
+000127e0: 6329 7d7b 5345 507d 7b65 6e63 7279 7074  c)}{SEP}{encrypt
+000127f0: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
+00012800: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00012810: 2020 2020 2023 204f 626a 6563 7420 6f66       # Object of
+00012820: 2074 7970 6520 526f 6f6d 4372 6561 7465   type RoomCreate
+00012830: 5265 7370 6f6e 7365 2069 7320 6e6f 7420  Response is not 
+00012840: 4a53 4f4e 0a20 2020 2020 2020 2020 2020  JSON.           
+00012850: 2020 2020 2023 2073 6572 6961 6c69 7a61       # serializa
+00012860: 626c 652c 2068 656e 6365 2077 6520 7573  ble, hence we us
+00012870: 6520 7468 6520 6469 6374 696f 6e61 7279  e the dictionary
+00012880: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00012890: 2020 6a73 6f6e 5f6d 6178 203d 2072 6573    json_max = res
+000128a0: 702e 5f5f 6469 6374 5f5f 0a20 2020 2020  p.__dict__.     
+000128b0: 2020 2020 2020 2020 2020 2023 2072 6573             # res
+000128c0: 7020 6861 7320 6f6e 6c79 2031 2075 7365  p has only 1 use
+000128d0: 6675 6c20 7573 6566 756c 206d 656d 6265  ful useful membe
+000128e0: 723a 2072 6f6f 6d5f 6964 0a20 2020 2020  r: room_id.     
+000128f0: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+00012900: 6d61 782e 7570 6461 7465 287b 2261 6c69  max.update({"ali
+00012910: 6173 223a 2061 6c69 6173 7d29 2020 2320  as": alias})  # 
+00012920: 6164 6420 6469 6374 2069 7465 6d73 0a20  add dict items. 
+00012930: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+00012940: 736f 6e5f 6d61 782e 7570 6461 7465 287b  son_max.update({
+00012950: 2261 6c69 6173 5f66 756c 6c22 3a20 6675  "alias_full": fu
+00012960: 6c6c 5f61 6c69 6173 7d29 0a20 2020 2020  ll_alias}).     
+00012970: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+00012980: 6d61 782e 7570 6461 7465 287b 226e 616d  max.update({"nam
+00012990: 6522 3a20 6e61 6d65 7d29 0a20 2020 2020  e": name}).     
+000129a0: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+000129b0: 6d61 782e 7570 6461 7465 287b 2274 6f70  max.update({"top
+000129c0: 6963 223a 2074 6f70 6963 7d29 0a20 2020  ic": topic}).   
+000129d0: 2020 2020 2020 2020 2020 2020 206a 736f               jso
+000129e0: 6e5f 6d61 782e 7570 6461 7465 287b 2265  n_max.update({"e
+000129f0: 6e63 7279 7074 6564 223a 2065 6e63 7279  ncrypted": encry
+00012a00: 7074 7d29 0a20 2020 2020 2020 2020 2020  pt}).           
+00012a10: 2020 2020 206a 736f 6e5f 203d 206a 736f       json_ = jso
+00012a20: 6e5f 6d61 782e 636f 7079 2829 0a20 2020  n_max.copy().   
+00012a30: 2020 2020 2020 2020 2020 2020 206a 736f               jso
+00012a40: 6e5f 2e70 6f70 2822 7472 616e 7370 6f72  n_.pop("transpor
+00012a50: 745f 7265 7370 6f6e 7365 2229 0a20 2020  t_response").   
+00012a60: 2020 2020 2020 2020 2020 2020 206a 736f               jso
+00012a70: 6e5f 7370 6563 203d 204e 6f6e 650a 2020  n_spec = None.  
+00012a80: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00012a90: 696e 745f 6f75 7470 7574 280a 2020 2020  int_output(.    
+00012aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ab0: 6773 2e70 612e 6f75 7470 7574 2c0a 2020  gs.pa.output,.  
+00012ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ad0: 2020 7465 7874 3d74 6578 742c 0a20 2020    text=text,.   
+00012ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012af0: 206a 736f 6e5f 3d6a 736f 6e5f 2c0a 2020   json_=json_,.  
+00012b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012b10: 2020 6a73 6f6e 5f6d 6178 3d6a 736f 6e5f    json_max=json_
+00012b20: 6d61 782c 0a20 2020 2020 2020 2020 2020  max,.           
+00012b30: 2020 2020 2020 2020 206a 736f 6e5f 7370           json_sp
+00012b40: 6563 3d6a 736f 6e5f 7370 6563 2c0a 2020  ec=json_spec,.  
+00012b50: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00012b60: 2020 2020 2020 2020 2020 2020 696e 6465              inde
+00012b70: 7820 3d20 696e 6465 7820 2b20 310a 2020  x = index + 1.  
+00012b80: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+00012b90: 6f6e 3a0a 2020 2020 2020 2020 6773 2e6c  on:.        gs.l
+00012ba0: 6f67 2e65 7272 6f72 2822 4531 3236 3a20  og.error("E126: 
+00012bb0: 2220 2244 4d20 726f 6f6d 2063 7265 6174  " "DM room creat
+00012bc0: 696f 6e20 6661 696c 6564 2e20 536f 7272  ion failed. Sorr
+00012bd0: 792e 2229 0a20 2020 2020 2020 2067 732e  y.").        gs.
+00012be0: 6572 725f 636f 756e 7420 2b3d 2031 0a20  err_count += 1. 
+00012bf0: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+00012c00: 6275 6728 2248 6572 6520 6973 2074 6865  bug("Here is the
+00012c10: 2074 7261 6365 6261 636b 2e5c 6e22 202b   traceback.\n" +
+00012c20: 2074 7261 6365 6261 636b 2e66 6f72 6d61   traceback.forma
+00012c30: 745f 6578 6328 2929 0a0a 0a61 7379 6e63  t_exc())...async
+00012c40: 2064 6566 2061 6374 696f 6e5f 726f 6f6d   def action_room
+00012c50: 5f63 7265 6174 6528 636c 6965 6e74 3a20  _create(client: 
+00012c60: 4173 796e 6343 6c69 656e 742c 2063 7265  AsyncClient, cre
+00012c70: 6465 6e74 6961 6c73 3a20 6469 6374 293a  dentials: dict):
+00012c80: 0a20 2020 2022 2222 4372 6561 7465 206f  .    """Create o
+00012c90: 6e65 206f 7220 6d75 6c74 6970 6c65 2072  ne or multiple r
+00012ca0: 6f6f 6d73 2077 6869 6c65 2061 6c72 6561  ooms while alrea
+00012cb0: 6479 2062 6569 6e67 206c 6f67 6765 6420  dy being logged 
+00012cc0: 696e 2e0a 0a20 2020 2041 7267 756d 656e  in...    Argumen
+00012cd0: 7473 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  ts:.    --------
+00012ce0: 2d0a 2020 2020 636c 6965 6e74 3a20 4173  -.    client: As
+00012cf0: 796e 6343 6c69 656e 743a 206e 696f 2063  yncClient: nio c
+00012d00: 6c69 656e 742c 2061 6c6c 6f77 7320 6173  lient, allows as
+00012d10: 2074 6f20 7175 6572 7920 7468 6520 7365   to query the se
+00012d20: 7276 6572 0a20 2020 2063 7265 6465 6e74  rver.    credent
+00012d30: 6961 6c73 3a20 6469 6374 3a20 616c 6c6f  ials: dict: allo
+00012d40: 7773 2074 6f20 6765 7420 7468 6520 7573  ws to get the us
+00012d50: 6572 5f69 6420 6f66 2073 656e 6465 722c  er_id of sender,
+00012d60: 2065 7463 0a20 2020 2022 2222 0a20 2020   etc.    """.   
+00012d70: 2023 2072 6f6f 6d5f 616c 6961 7365 7320   # room_aliases 
+00012d80: 3a20 6c69 7374 206f 6620 726f 6f6d 2061  : list of room a
+00012d90: 6c69 6173 6573 2069 6e20 7468 6520 666f  liases in the fo
+00012da0: 726d 206f 6620 2273 616d 706c 6541 6c69  rm of "sampleAli
+00012db0: 6173 220a 2020 2020 2320 2020 2020 2020  as".    #       
+00012dc0: 2020 5468 6573 6520 616c 6961 7365 7320    These aliases 
+00012dd0: 7769 6c6c 2074 6865 6e20 6265 2075 7365  will then be use
+00012de0: 6420 6279 2074 6865 2073 6572 7665 7220  d by the server 
+00012df0: 616e 640a 2020 2020 2320 2020 2020 2020  and.    #       
+00012e00: 2020 7468 6520 7365 7276 6572 2063 7265    the server cre
+00012e10: 6174 6573 2074 6865 2064 6566 696e 6974  ates the definit
+00012e20: 6520 616c 6961 7320 696e 2074 6865 2066  e alias in the f
+00012e30: 6f72 6d0a 2020 2020 2320 2020 2020 2020  orm.    #       
+00012e40: 2020 6f66 2022 2373 616d 706c 6541 6c69    of "#sampleAli
+00012e50: 6173 3a65 7861 6d70 6c65 2e63 6f6d 2220  as:example.com" 
+00012e60: 6672 6f6d 2069 742e 0a20 2020 2023 2020  from it..    #  
+00012e70: 2020 2020 2020 2057 6520 7065 726d 6974         We permit
+00012e80: 2022 2373 616d 706c 6541 6c69 6173 3a65   "#sampleAlias:e
+00012e90: 7861 6d70 6c65 2e63 6f6d 2220 616e 6420  xample.com" and 
+00012ea0: 646f 776e 7363 616c 6520 6974 2074 6f0a  downscale it to.
+00012eb0: 2020 2020 2320 2020 2020 2020 2020 2273      #         "s
+00012ec0: 616d 706c 6541 6c69 6173 222e 0a20 2020  ampleAlias"..   
+00012ed0: 2023 206e 616d 6573 203a 206c 6973 7420   # names : list 
+00012ee0: 6f66 206e 616d 6573 2066 6f72 2072 6f6f  of names for roo
+00012ef0: 6d73 0a20 2020 2023 2074 6f70 6963 7320  ms.    # topics 
+00012f00: 3a20 6c69 7374 206f 6620 726f 6f6d 2074  : list of room t
+00012f10: 6f70 6963 730a 0a20 2020 2072 6f6f 6d5f  opics..    room_
+00012f20: 616c 6961 7365 7320 3d20 6773 2e70 612e  aliases = gs.pa.
+00012f30: 726f 6f6d 5f63 7265 6174 650a 2020 2020  room_create.    
+00012f40: 6e61 6d65 7320 3d20 6773 2e70 612e 6e61  names = gs.pa.na
+00012f50: 6d65 0a20 2020 2074 6f70 6963 7320 3d20  me.    topics = 
+00012f60: 6773 2e70 612e 746f 7069 630a 2020 2020  gs.pa.topic.    
+00012f70: 7472 793a 0a20 2020 2020 2020 2069 6e64  try:.        ind
+00012f80: 6578 203d 2030 0a20 2020 2020 2020 2067  ex = 0.        g
+00012f90: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
+00012fa0: 2020 2020 2020 2020 2066 2754 7279 696e           f'Tryin
+00012fb0: 6720 746f 2063 7265 6174 6520 726f 6f6d  g to create room
+00012fc0: 7320 7769 7468 2072 6f6f 6d20 616c 6961  s with room alia
+00012fd0: 7365 7320 227b 726f 6f6d 5f61 6c69 6173  ses "{room_alias
+00012fe0: 6573 7d22 2c20 270a 2020 2020 2020 2020  es}", '.        
+00012ff0: 2020 2020 6627 6e61 6d65 7320 227b 6e61      f'names "{na
+00013000: 6d65 737d 222c 2061 6e64 2074 6f70 6963  mes}", and topic
+00013010: 7320 227b 746f 7069 6373 7d22 2e27 0a20  s "{topics}".'. 
+00013020: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00013030: 2066 6f72 2061 6c69 6173 2069 6e20 726f   for alias in ro
+00013040: 6f6d 5f61 6c69 6173 6573 3a0a 2020 2020  om_aliases:.    
+00013050: 2020 2020 2020 2020 616c 6961 7320 3d20          alias = 
+00013060: 616c 6961 732e 7265 706c 6163 6528 7222  alias.replace(r"
+00013070: 5c21 222c 2022 2122 2920 2023 2072 656d  \!", "!")  # rem
+00013080: 6f76 6520 706f 7373 6962 6c65 2065 7363  ove possible esc
+00013090: 6170 650a 2020 2020 2020 2020 2020 2020  ape.            
+000130a0: 2320 616c 6961 7320 6973 2061 2074 7275  # alias is a tru
+000130b0: 6520 616c 6961 732c 206e 6f74 2061 2072  e alias, not a r
+000130c0: 6f6f 6d20 6964 0a20 2020 2020 2020 2020  oom id.         
+000130d0: 2020 2023 2069 6620 6279 206d 6973 7461     # if by mista
+000130e0: 6b65 2075 7365 7220 6861 7320 6769 7665  ke user has give
+000130f0: 6e20 6675 6c6c 2072 6f6f 6d20 616c 6961  n full room alia
+00013100: 732c 2073 686f 7274 656e 2069 740a 2020  s, shorten it.  
+00013110: 2020 2020 2020 2020 2020 6966 2069 735f            if is_
+00013120: 726f 6f6d 5f61 6c69 6173 2861 6c69 6173  room_alias(alias
+00013130: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00013140: 2020 2061 6c69 6173 203d 2072 6f6f 6d5f     alias = room_
+00013150: 616c 6961 735f 746f 5f73 686f 7274 5f72  alias_to_short_r
+00013160: 6f6f 6d5f 616c 6961 7328 616c 6961 732c  oom_alias(alias,
+00013170: 2063 7265 6465 6e74 6961 6c73 290a 2020   credentials).  
+00013180: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00013190: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+000131a0: 616d 6520 3d20 6e61 6d65 735b 696e 6465  ame = names[inde
+000131b0: 785d 0a20 2020 2020 2020 2020 2020 2065  x].            e
+000131c0: 7863 6570 7420 2849 6e64 6578 4572 726f  xcept (IndexErro
+000131d0: 722c 2054 7970 6545 7272 6f72 293a 0a20  r, TypeError):. 
+000131e0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+000131f0: 616d 6520 3d20 2222 0a20 2020 2020 2020  ame = "".       
+00013200: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00013210: 2020 2020 2020 2020 2020 746f 7069 6320            topic 
+00013220: 3d20 746f 7069 6373 5b69 6e64 6578 5d0a  = topics[index].
+00013230: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+00013240: 7074 2028 496e 6465 7845 7272 6f72 2c20  pt (IndexError, 
+00013250: 5479 7065 4572 726f 7229 3a0a 2020 2020  TypeError):.    
+00013260: 2020 2020 2020 2020 2020 2020 746f 7069              topi
+00013270: 6320 3d20 2222 0a20 2020 2020 2020 2020  c = "".         
+00013280: 2020 2061 6c69 6173 203d 2061 6c69 6173     alias = alias
+00013290: 2e73 7472 6970 2829 0a20 2020 2020 2020  .strip().       
+000132a0: 2020 2020 2061 6c69 6173 203d 204e 6f6e       alias = Non
+000132b0: 6520 6966 2061 6c69 6173 203d 3d20 2222  e if alias == ""
+000132c0: 2065 6c73 6520 616c 6961 730a 2020 2020   else alias.    
+000132d0: 2020 2020 2020 2020 6e61 6d65 203d 206e          name = n
+000132e0: 616d 652e 7374 7269 7028 290a 2020 2020  ame.strip().    
+000132f0: 2020 2020 2020 2020 6e61 6d65 203d 204e          name = N
+00013300: 6f6e 6520 6966 206e 616d 6520 3d3d 2022  one if name == "
+00013310: 2220 656c 7365 206e 616d 650a 2020 2020  " else name.    
+00013320: 2020 2020 2020 2020 746f 7069 6320 3d20          topic = 
+00013330: 746f 7069 632e 7374 7269 7028 290a 2020  topic.strip().  
+00013340: 2020 2020 2020 2020 2020 746f 7069 6320            topic 
+00013350: 3d20 4e6f 6e65 2069 6620 746f 7069 6320  = None if topic 
+00013360: 3d3d 2022 2220 656c 7365 2074 6f70 6963  == "" else topic
+00013370: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00013380: 6773 2e70 612e 706c 6169 6e3a 0a20 2020  gs.pa.plain:.   
+00013390: 2020 2020 2020 2020 2020 2020 2065 6e63               enc
+000133a0: 7279 7074 203d 2046 616c 7365 0a20 2020  rypt = False.   
+000133b0: 2020 2020 2020 2020 2020 2020 2069 6e69               ini
+000133c0: 7469 616c 5f73 7461 7465 203d 2028 290a  tial_state = ().
+000133d0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000133e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000133f0: 2020 656e 6372 7970 7420 3d20 5472 7565    encrypt = True
+00013400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013410: 2069 6e69 7469 616c 5f73 7461 7465 203d   initial_state =
+00013420: 205b 456e 6162 6c65 456e 6372 7970 7469   [EnableEncrypti
+00013430: 6f6e 4275 696c 6465 7228 292e 6173 5f64  onBuilder().as_d
+00013440: 6963 7428 295d 0a20 2020 2020 2020 2020  ict()].         
+00013450: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+00013460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013470: 2066 2743 7265 6174 696e 6720 726f 6f6d   f'Creating room
+00013480: 2077 6974 6820 726f 6f6d 2061 6c69 6173   with room alias
+00013490: 2022 7b61 6c69 6173 7d22 2c20 270a 2020   "{alias}", '.  
+000134a0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+000134b0: 6e61 6d65 2022 7b6e 616d 657d 222c 2074  name "{name}", t
+000134c0: 6f70 6963 2022 7b74 6f70 6963 7d22 2061  opic "{topic}" a
+000134d0: 6e64 2027 0a20 2020 2020 2020 2020 2020  nd '.           
+000134e0: 2020 2020 2066 2765 6e63 7279 7074 6564       f'encrypted
+000134f0: 2022 7b65 6e63 7279 7074 7d22 2e27 0a20   "{encrypt}".'. 
+00013500: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00013510: 2020 2020 2020 2020 2023 206e 696f 2773           # nio's
+00013520: 2072 6f6f 6d5f 6372 6561 7465 2064 6f65   room_create doe
+00013530: 7320 4e4f 5420 6163 6365 7074 2022 2366  s NOT accept "#f
+00013540: 6f6f 3a65 7861 6d70 6c65 2e63 6f6d 220a  oo:example.com".
+00013550: 2020 2020 2020 2020 2020 2020 7265 7370              resp
+00013560: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+00013570: 726f 6f6d 5f63 7265 6174 6528 0a20 2020  room_create(.   
+00013580: 2020 2020 2020 2020 2020 2020 2061 6c69               ali
+00013590: 6173 3d61 6c69 6173 2c20 2023 2064 6573  as=alias,  # des
+000135a0: 6972 6564 2063 616e 6f6e 6963 616c 2061  ired canonical a
+000135b0: 6c69 6173 206c 6f63 616c 2070 6172 742c  lias local part,
+000135c0: 2065 2e67 2e20 666f 6f0a 2020 2020 2020   e.g. foo.      
+000135d0: 2020 2020 2020 2020 2020 6e61 6d65 3d6e            name=n
+000135e0: 616d 652c 2020 2320 726f 6f6d 206e 616d  ame,  # room nam
+000135f0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00013600: 2020 746f 7069 633d 746f 7069 632c 2020    topic=topic,  
+00013610: 2320 726f 6f6d 2074 6f70 6963 0a20 2020  # room topic.   
+00013620: 2020 2020 2020 2020 2020 2020 2069 6e69               ini
+00013630: 7469 616c 5f73 7461 7465 3d69 6e69 7469  tial_state=initi
+00013640: 616c 5f73 7461 7465 2c0a 2020 2020 2020  al_state,.      
+00013650: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00013660: 2020 2020 2320 2261 6c69 6173 3122 2077      # "alias1" w
+00013670: 696c 6c20 6372 6561 7465 2061 2022 2361  ill create a "#a
+00013680: 6c69 6173 313a 6578 616d 706c 652e 636f  lias1:example.co
+00013690: 6d22 0a20 2020 2020 2020 2020 2020 2069  m".            i
+000136a0: 6620 6973 696e 7374 616e 6365 2872 6573  f isinstance(res
+000136b0: 702c 2052 6f6f 6d43 7265 6174 6545 7272  p, RoomCreateErr
+000136c0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+000136d0: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
+000136e0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+000136f0: 2020 2020 2020 2022 4531 3237 3a20 220a         "E127: ".
+00013700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013710: 2020 2020 2252 6f6f 6d5f 6372 6561 7465      "Room_create
+00013720: 2066 6169 6c65 6420 7769 7468 2072 6573   failed with res
+00013730: 706f 6e73 653a 2022 0a20 2020 2020 2020  ponse: ".       
+00013740: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
+00013750: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
+00013760: 7472 2872 6573 7029 297d 220a 2020 2020  tr(resp))}".    
+00013770: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00013780: 2020 2020 2020 2020 2020 2020 2020 6773                gs
+00013790: 2e65 7272 5f63 6f75 6e74 202b 3d20 310a  .err_count += 1.
+000137a0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000137b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000137c0: 2020 6966 2061 6c69 6173 3a0a 2020 2020    if alias:.    
+000137d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000137e0: 6675 6c6c 5f61 6c69 6173 203d 2073 686f  full_alias = sho
+000137f0: 7274 5f72 6f6f 6d5f 616c 6961 735f 746f  rt_room_alias_to
+00013800: 5f72 6f6f 6d5f 616c 6961 7328 0a20 2020  _room_alias(.   
+00013810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013820: 2020 2020 2061 6c69 6173 2c20 6372 6564       alias, cred
+00013830: 656e 7469 616c 730a 2020 2020 2020 2020  entials.        
+00013840: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00013850: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00013860: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00013870: 2020 2020 2020 2020 6675 6c6c 5f61 6c69          full_ali
+00013880: 6173 203d 204e 6f6e 650a 2020 2020 2020  as = None.      
+00013890: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
+000138a0: 2e69 6e66 6f28 0a20 2020 2020 2020 2020  .info(.         
+000138b0: 2020 2020 2020 2020 2020 2066 2743 7265             f'Cre
+000138c0: 6174 6564 2072 6f6f 6d20 7769 7468 2072  ated room with r
+000138d0: 6f6f 6d20 6964 2022 7b72 6573 702e 726f  oom id "{resp.ro
+000138e0: 6f6d 5f69 647d 222c 2027 0a20 2020 2020  om_id}", '.     
+000138f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00013900: 2773 686f 7274 2061 6c69 6173 2022 7b7a  'short alias "{z
+00013910: 6e28 616c 6961 7329 7d22 2c20 270a 2020  n(alias)}", '.  
+00013920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013930: 2020 6627 6675 6c6c 2061 6c69 6173 2022    f'full alias "
+00013940: 7b7a 6e28 6675 6c6c 5f61 6c69 6173 297d  {zn(full_alias)}
+00013950: 2220 616e 6420 270a 2020 2020 2020 2020  " and '.        
+00013960: 2020 2020 2020 2020 2020 2020 6627 656e              f'en
+00013970: 6372 7970 7465 6420 227b 656e 6372 7970  crypted "{encryp
+00013980: 747d 222e 270a 2020 2020 2020 2020 2020  t}".'.          
+00013990: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000139a0: 2020 2020 2020 2020 2320 6f75 7470 7574          # output
+000139b0: 2066 6f72 6d61 7420 636f 6e74 726f 6c6c   format controll
+000139c0: 6564 2076 6961 202d 2d6f 7574 7075 7420  ed via --output 
+000139d0: 666c 6167 0a20 2020 2020 2020 2020 2020  flag.           
+000139e0: 2020 2020 2074 6578 7420 3d20 280a 2020       text = (.  
+000139f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013a00: 2020 6622 7b72 6573 702e 726f 6f6d 5f69    f"{resp.room_i
+00013a10: 647d 7b53 4550 7d7b 7a6e 2861 6c69 6173  d}{SEP}{zn(alias
+00013a20: 297d 7b53 4550 7d7b 7a6e 2866 756c 6c5f  )}{SEP}{zn(full_
+00013a30: 616c 6961 7329 7d22 0a20 2020 2020 2020  alias)}".       
+00013a40: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
+00013a50: 5345 507d 7b7a 6e28 6e61 6d65 297d 7b53  SEP}{zn(name)}{S
+00013a60: 4550 7d7b 7a6e 2874 6f70 6963 297d 7b53  EP}{zn(topic)}{S
+00013a70: 4550 7d7b 656e 6372 7970 747d 220a 2020  EP}{encrypt}".  
+00013a80: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00013a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013aa0: 2320 4f62 6a65 6374 206f 6620 7479 7065  # Object of type
+00013ab0: 2052 6f6f 6d43 7265 6174 6552 6573 706f   RoomCreateRespo
+00013ac0: 6e73 6520 6973 206e 6f74 204a 534f 4e0a  nse is not JSON.
+00013ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013ae0: 2320 7365 7269 616c 697a 6162 6c65 2c20  # serializable, 
+00013af0: 6865 6e63 6520 7765 2075 7365 2074 6865  hence we use the
+00013b00: 2064 6963 7469 6f6e 6172 792e 0a20 2020   dictionary..   
+00013b10: 2020 2020 2020 2020 2020 2020 206a 736f               jso
+00013b20: 6e5f 6d61 7820 3d20 7265 7370 2e5f 5f64  n_max = resp.__d
+00013b30: 6963 745f 5f0a 2020 2020 2020 2020 2020  ict__.          
+00013b40: 2020 2020 2020 2320 7265 7370 2068 6173        # resp has
+00013b50: 206f 6e6c 7920 3120 7573 6566 756c 2075   only 1 useful u
+00013b60: 7365 6675 6c20 6d65 6d62 6572 3a20 726f  seful member: ro
+00013b70: 6f6d 5f69 640a 2020 2020 2020 2020 2020  om_id.          
+00013b80: 2020 2020 2020 6a73 6f6e 5f6d 6178 2e75        json_max.u
+00013b90: 7064 6174 6528 7b22 616c 6961 7322 3a20  pdate({"alias": 
+00013ba0: 616c 6961 737d 2920 2023 2061 6464 2064  alias})  # add d
+00013bb0: 6963 7420 6974 656d 730a 2020 2020 2020  ict items.      
+00013bc0: 2020 2020 2020 2020 2020 6a73 6f6e 5f6d            json_m
+00013bd0: 6178 2e75 7064 6174 6528 7b22 616c 6961  ax.update({"alia
+00013be0: 735f 6675 6c6c 223a 2066 756c 6c5f 616c  s_full": full_al
+00013bf0: 6961 737d 290a 2020 2020 2020 2020 2020  ias}).          
+00013c00: 2020 2020 2020 6a73 6f6e 5f6d 6178 2e75        json_max.u
+00013c10: 7064 6174 6528 7b22 6e61 6d65 223a 206e  pdate({"name": n
+00013c20: 616d 657d 290a 2020 2020 2020 2020 2020  ame}).          
+00013c30: 2020 2020 2020 6a73 6f6e 5f6d 6178 2e75        json_max.u
+00013c40: 7064 6174 6528 7b22 746f 7069 6322 3a20  pdate({"topic": 
+00013c50: 746f 7069 637d 290a 2020 2020 2020 2020  topic}).        
+00013c60: 2020 2020 2020 2020 6a73 6f6e 5f6d 6178          json_max
+00013c70: 2e75 7064 6174 6528 7b22 656e 6372 7970  .update({"encryp
+00013c80: 7465 6422 3a20 656e 6372 7970 747d 290a  ted": encrypt}).
+00013c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013ca0: 6a73 6f6e 5f20 3d20 6a73 6f6e 5f6d 6178  json_ = json_max
+00013cb0: 2e63 6f70 7928 290a 2020 2020 2020 2020  .copy().        
+00013cc0: 2020 2020 2020 2020 6a73 6f6e 5f2e 706f          json_.po
+00013cd0: 7028 2274 7261 6e73 706f 7274 5f72 6573  p("transport_res
+00013ce0: 706f 6e73 6522 290a 2020 2020 2020 2020  ponse").        
+00013cf0: 2020 2020 2020 2020 6a73 6f6e 5f73 7065          json_spe
+00013d00: 6320 3d20 4e6f 6e65 0a20 2020 2020 2020  c = None.       
+00013d10: 2020 2020 2020 2020 2070 7269 6e74 5f6f           print_o
+00013d20: 7574 7075 7428 0a20 2020 2020 2020 2020  utput(.         
+00013d30: 2020 2020 2020 2020 2020 2067 732e 7061             gs.pa
+00013d40: 2e6f 7574 7075 742c 0a20 2020 2020 2020  .output,.       
+00013d50: 2020 2020 2020 2020 2020 2020 2074 6578               tex
+00013d60: 743d 7465 7874 2c0a 2020 2020 2020 2020  t=text,.        
+00013d70: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+00013d80: 5f3d 6a73 6f6e 5f2c 0a20 2020 2020 2020  _=json_,.       
+00013d90: 2020 2020 2020 2020 2020 2020 206a 736f               jso
+00013da0: 6e5f 6d61 783d 6a73 6f6e 5f6d 6178 2c0a  n_max=json_max,.
+00013db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013dc0: 2020 2020 6a73 6f6e 5f73 7065 633d 6a73      json_spec=js
+00013dd0: 6f6e 5f73 7065 632c 0a20 2020 2020 2020  on_spec,.       
+00013de0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00013df0: 2020 2020 2020 2069 6e64 6578 203d 2069         index = i
+00013e00: 6e64 6578 202b 2031 0a20 2020 2065 7863  ndex + 1.    exc
+00013e10: 6570 7420 4578 6365 7074 696f 6e3a 0a20  ept Exception:. 
+00013e20: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
+00013e30: 726f 7228 2245 3132 383a 2022 2022 526f  ror("E128: " "Ro
+00013e40: 6f6d 2063 7265 6174 696f 6e20 6661 696c  om creation fail
+00013e50: 6564 2e20 536f 7272 792e 2229 0a20 2020  ed. Sorry.").   
+00013e60: 2020 2020 2067 732e 6572 725f 636f 756e       gs.err_coun
+00013e70: 7420 2b3d 2031 0a20 2020 2020 2020 2067  t += 1.        g
+00013e80: 732e 6c6f 672e 6465 6275 6728 2248 6572  s.log.debug("Her
+00013e90: 6520 6973 2074 6865 2074 7261 6365 6261  e is the traceba
+00013ea0: 636b 2e5c 6e22 202b 2074 7261 6365 6261  ck.\n" + traceba
+00013eb0: 636b 2e66 6f72 6d61 745f 6578 6328 2929  ck.format_exc())
+00013ec0: 0a0a 0a61 7379 6e63 2064 6566 2061 6374  ...async def act
+00013ed0: 696f 6e5f 726f 6f6d 5f6a 6f69 6e28 636c  ion_room_join(cl
+00013ee0: 6965 6e74 2c20 6372 6564 656e 7469 616c  ient, credential
+00013ef0: 7329 3a0a 2020 2020 2222 224a 6f69 6e20  s):.    """Join 
+00013f00: 6f6e 6520 6f72 206d 756c 7469 706c 6520  one or multiple 
+00013f10: 726f 6f6d 732e 2222 220a 2020 2020 726f  rooms.""".    ro
+00013f20: 6f6d 7320 3d20 6773 2e70 612e 726f 6f6d  oms = gs.pa.room
+00013f30: 5f6a 6f69 6e0a 2020 2020 7472 793a 0a20  _join.    try:. 
+00013f40: 2020 2020 2020 2066 6f72 2072 6f6f 6d5f         for room_
+00013f50: 6964 2069 6e20 726f 6f6d 733a 0a20 2020  id in rooms:.   
+00013f60: 2020 2020 2020 2020 2023 2072 6f6f 6d5f           # room_
+00013f70: 6964 2063 616e 2062 6520 2372 6f6f 6d41  id can be #roomA
+00013f80: 6c69 6173 206f 7220 2172 6f6f 6d49 640a  lias or !roomId.
+00013f90: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+00013fa0: 6f67 2e64 6562 7567 2866 2750 7265 7061  og.debug(f'Prepa
+00013fb0: 7269 6e67 2074 6f20 6a6f 696e 2072 6f6f  ring to join roo
+00013fc0: 6d20 227b 726f 6f6d 5f69 647d 222e 2729  m "{room_id}".')
+00013fd0: 0a20 2020 2020 2020 2020 2020 2072 6f6f  .            roo
+00013fe0: 6d5f 6964 203d 2061 7761 6974 206d 6170  m_id = await map
+00013ff0: 5f72 6f6f 6d69 6e66 6f5f 746f 5f72 6f6f  _roominfo_to_roo
+00014000: 6d69 6428 636c 6965 6e74 2c20 726f 6f6d  mid(client, room
+00014010: 5f69 6429 0a20 2020 2020 2020 2020 2020  _id).           
+00014020: 2067 732e 6c6f 672e 6465 6275 6728 6627   gs.log.debug(f'
+00014030: 4a6f 696e 696e 6720 726f 6f6d 2022 7b72  Joining room "{r
+00014040: 6f6f 6d5f 6964 7d22 2e27 290a 2020 2020  oom_id}".').    
+00014050: 2020 2020 2020 2020 7265 7370 203d 2061          resp = a
+00014060: 7761 6974 2063 6c69 656e 742e 6a6f 696e  wait client.join
+00014070: 2872 6f6f 6d5f 6964 290a 2020 2020 2020  (room_id).      
+00014080: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00014090: 6e63 6528 7265 7370 2c20 4a6f 696e 4572  nce(resp, JoinEr
+000140a0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+000140b0: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
+000140c0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+000140d0: 2020 2020 2020 2020 2245 3132 393a 2022          "E129: "
+000140e0: 2066 226a 6f69 6e20 6661 696c 6564 2077   f"join failed w
+000140f0: 6974 6820 7b70 7269 7661 6379 5f66 696c  ith {privacy_fil
+00014100: 7465 7228 7374 7228 7265 7370 2929 7d22  ter(str(resp))}"
+00014110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014120: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00014130: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
+00014140: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
+00014150: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00014160: 2020 2020 2020 2067 732e 6c6f 672e 696e         gs.log.in
+00014170: 666f 2866 274a 6f69 6e65 6420 726f 6f6d  fo(f'Joined room
+00014180: 2022 7b72 6f6f 6d5f 6964 7d22 2073 7563   "{room_id}" suc
+00014190: 6365 7373 6675 6c6c 792e 2729 0a20 2020  cessfully.').   
+000141a0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+000141b0: 6e3a 0a20 2020 2020 2020 2067 732e 6c6f  n:.        gs.lo
+000141c0: 672e 6572 726f 7228 2245 3133 303a 2022  g.error("E130: "
+000141d0: 2022 4a6f 696e 696e 6720 726f 6f6d 7320   "Joining rooms 
+000141e0: 6661 696c 6564 2e20 536f 7272 792e 2229  failed. Sorry.")
+000141f0: 0a20 2020 2020 2020 2067 732e 6572 725f  .        gs.err_
+00014200: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
+00014210: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+00014220: 2248 6572 6520 6973 2074 6865 2074 7261  "Here is the tra
+00014230: 6365 6261 636b 2e5c 6e22 202b 2074 7261  ceback.\n" + tra
+00014240: 6365 6261 636b 2e66 6f72 6d61 745f 6578  ceback.format_ex
+00014250: 6328 2929 0a0a 0a61 7379 6e63 2064 6566  c())...async def
+00014260: 2061 6374 696f 6e5f 726f 6f6d 5f6c 6561   action_room_lea
+00014270: 7665 2863 6c69 656e 742c 2063 7265 6465  ve(client, crede
+00014280: 6e74 6961 6c73 293a 0a20 2020 2022 2222  ntials):.    """
+00014290: 4c65 6176 6520 6f6e 6520 6f72 206d 756c  Leave one or mul
+000142a0: 7469 706c 6520 726f 6f6d 732e 2222 220a  tiple rooms.""".
+000142b0: 2020 2020 726f 6f6d 7320 3d20 6773 2e70      rooms = gs.p
+000142c0: 612e 726f 6f6d 5f6c 6561 7665 0a20 2020  a.room_leave.   
+000142d0: 2074 7279 3a0a 2020 2020 2020 2020 666f   try:.        fo
+000142e0: 7220 726f 6f6d 5f69 6420 696e 2072 6f6f  r room_id in roo
+000142f0: 6d73 3a0a 2020 2020 2020 2020 2020 2020  ms:.            
+00014300: 2320 726f 6f6d 5f69 6420 6361 6e20 6265  # room_id can be
+00014310: 2023 726f 6f6d 416c 6961 7320 6f72 2021   #roomAlias or !
+00014320: 726f 6f6d 4964 0a20 2020 2020 2020 2020  roomId.         
+00014330: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+00014340: 6627 5072 6570 6172 696e 6720 746f 206c  f'Preparing to l
+00014350: 6561 7665 2072 6f6f 6d20 227b 726f 6f6d  eave room "{room
+00014360: 5f69 647d 222e 2729 0a20 2020 2020 2020  _id}".').       
+00014370: 2020 2020 2072 6f6f 6d5f 6964 203d 2061       room_id = a
+00014380: 7761 6974 206d 6170 5f72 6f6f 6d69 6e66  wait map_roominf
+00014390: 6f5f 746f 5f72 6f6f 6d69 6428 636c 6965  o_to_roomid(clie
+000143a0: 6e74 2c20 726f 6f6d 5f69 6429 0a20 2020  nt, room_id).   
+000143b0: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
+000143c0: 6465 6275 6728 6627 4c65 6176 696e 6720  debug(f'Leaving 
+000143d0: 726f 6f6d 2022 7b72 6f6f 6d5f 6964 7d22  room "{room_id}"
+000143e0: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
+000143f0: 7265 7370 203d 2061 7761 6974 2063 6c69  resp = await cli
+00014400: 656e 742e 726f 6f6d 5f6c 6561 7665 2872  ent.room_leave(r
+00014410: 6f6f 6d5f 6964 290a 2020 2020 2020 2020  oom_id).        
+00014420: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00014430: 6528 7265 7370 2c20 526f 6f6d 4c65 6176  e(resp, RoomLeav
+00014440: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+00014450: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
+00014460: 6572 726f 7228 0a20 2020 2020 2020 2020  error(.         
+00014470: 2020 2020 2020 2020 2020 2022 4531 3331             "E131
+00014480: 3a20 2220 6622 4c65 6176 6520 6661 696c  : " f"Leave fail
+00014490: 6564 2077 6974 6820 7b70 7269 7661 6379  ed with {privacy
+000144a0: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
+000144b0: 2929 7d22 0a20 2020 2020 2020 2020 2020  ))}".           
+000144c0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+000144d0: 2020 2020 2020 2067 732e 6572 725f 636f         gs.err_co
+000144e0: 756e 7420 2b3d 2031 0a20 2020 2020 2020  unt += 1.       
+000144f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00014500: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
+00014510: 672e 696e 666f 2866 274c 6566 7420 726f  g.info(f'Left ro
+00014520: 6f6d 2022 7b72 6f6f 6d5f 6964 7d22 2e27  om "{room_id}".'
+00014530: 290a 2020 2020 6578 6365 7074 2045 7863  ).    except Exc
+00014540: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
+00014550: 6773 2e6c 6f67 2e65 7272 6f72 2822 4531  gs.log.error("E1
+00014560: 3332 3a20 2220 2252 6f6f 6d20 6c65 6176  32: " "Room leav
+00014570: 6520 6661 696c 6564 2e20 536f 7272 792e  e failed. Sorry.
+00014580: 2229 0a20 2020 2020 2020 2067 732e 6572  ").        gs.er
+00014590: 725f 636f 756e 7420 2b3d 2031 0a20 2020  r_count += 1.   
+000145a0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
+000145b0: 6728 2248 6572 6520 6973 2074 6865 2074  g("Here is the t
+000145c0: 7261 6365 6261 636b 2e5c 6e22 202b 2074  raceback.\n" + t
+000145d0: 7261 6365 6261 636b 2e66 6f72 6d61 745f  raceback.format_
+000145e0: 6578 6328 2929 0a0a 0a61 7379 6e63 2064  exc())...async d
+000145f0: 6566 2061 6374 696f 6e5f 726f 6f6d 5f66  ef action_room_f
+00014600: 6f72 6765 7428 636c 6965 6e74 2c20 6372  orget(client, cr
+00014610: 6564 656e 7469 616c 7329 3a0a 2020 2020  edentials):.    
+00014620: 2222 2246 6f72 6765 7420 6f6e 6520 6f72  """Forget one or
+00014630: 206d 756c 7469 706c 6520 726f 6f6d 732e   multiple rooms.
+00014640: 2222 220a 2020 2020 726f 6f6d 7320 3d20  """.    rooms = 
+00014650: 6773 2e70 612e 726f 6f6d 5f66 6f72 6765  gs.pa.room_forge
+00014660: 740a 2020 2020 7472 793a 0a20 2020 2020  t.    try:.     
+00014670: 2020 2066 6f72 2072 6f6f 6d5f 6964 2069     for room_id i
+00014680: 6e20 726f 6f6d 733a 0a20 2020 2020 2020  n rooms:.       
+00014690: 2020 2020 2023 2072 6f6f 6d5f 6964 2063       # room_id c
+000146a0: 616e 2062 6520 2372 6f6f 6d41 6c69 6173  an be #roomAlias
+000146b0: 206f 7220 2172 6f6f 6d49 640a 2020 2020   or !roomId.    
+000146c0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+000146d0: 6562 7567 2866 2750 7265 7061 7269 6e67  ebug(f'Preparing
+000146e0: 2074 6f20 666f 7267 6574 2072 6f6f 6d20   to forget room 
+000146f0: 227b 726f 6f6d 5f69 647d 222e 2729 0a20  "{room_id}".'). 
+00014700: 2020 2020 2020 2020 2020 2072 6f6f 6d5f             room_
+00014710: 6964 203d 2061 7761 6974 206d 6170 5f72  id = await map_r
+00014720: 6f6f 6d69 6e66 6f5f 746f 5f72 6f6f 6d69  oominfo_to_roomi
+00014730: 6428 636c 6965 6e74 2c20 726f 6f6d 5f69  d(client, room_i
+00014740: 6429 0a20 2020 2020 2020 2020 2020 2067  d).            g
+00014750: 732e 6c6f 672e 6465 6275 6728 6627 466f  s.log.debug(f'Fo
+00014760: 7267 6574 7469 6e67 2072 6f6f 6d20 227b  rgetting room "{
+00014770: 726f 6f6d 5f69 647d 222e 2729 0a20 2020  room_id}".').   
+00014780: 2020 2020 2020 2020 2072 6573 7020 3d20           resp = 
+00014790: 6177 6169 7420 636c 6965 6e74 2e72 6f6f  await client.roo
+000147a0: 6d5f 666f 7267 6574 2872 6f6f 6d5f 6964  m_forget(room_id
+000147b0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+000147c0: 2069 7369 6e73 7461 6e63 6528 7265 7370   isinstance(resp
+000147d0: 2c20 526f 6f6d 466f 7267 6574 4572 726f  , RoomForgetErro
+000147e0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+000147f0: 2020 2020 6773 2e6c 6f67 2e65 7272 6f72      gs.log.error
+00014800: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00014810: 2020 2020 2020 2245 3133 333a 2022 2066        "E133: " f
+00014820: 2246 6f72 6765 7420 6661 696c 6564 2077  "Forget failed w
+00014830: 6974 6820 7b70 7269 7661 6379 5f66 696c  ith {privacy_fil
+00014840: 7465 7228 7374 7228 7265 7370 2929 7d22  ter(str(resp))}"
+00014850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014860: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00014870: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
+00014880: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
+00014890: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000148a0: 2020 2020 2020 2067 732e 6c6f 672e 696e         gs.log.in
+000148b0: 666f 2866 2746 6f72 676f 7420 726f 6f6d  fo(f'Forgot room
+000148c0: 2022 7b72 6f6f 6d5f 6964 7d22 2e27 290a   "{room_id}".').
+000148d0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+000148e0: 7469 6f6e 3a0a 2020 2020 2020 2020 6773  tion:.        gs
+000148f0: 2e6c 6f67 2e65 7272 6f72 2822 4531 3334  .log.error("E134
+00014900: 3a20 2220 2252 6f6f 6d20 666f 7267 6574  : " "Room forget
+00014910: 2066 6169 6c65 642e 2053 6f72 7279 2e22   failed. Sorry."
+00014920: 290a 2020 2020 2020 2020 6773 2e6c 6f67  ).        gs.log
+00014930: 2e64 6562 7567 2822 4865 7265 2069 7320  .debug("Here is 
+00014940: 7468 6520 7472 6163 6562 6163 6b2e 5c6e  the traceback.\n
+00014950: 2220 2b20 7472 6163 6562 6163 6b2e 666f  " + traceback.fo
+00014960: 726d 6174 5f65 7863 2829 290a 0a0a 6173  rmat_exc())...as
+00014970: 796e 6320 6465 6620 6163 7469 6f6e 5f72  ync def action_r
+00014980: 6f6f 6d5f 696e 7669 7465 2863 6c69 656e  oom_invite(clien
+00014990: 742c 2063 7265 6465 6e74 6961 6c73 293a  t, credentials):
+000149a0: 0a20 2020 2022 2222 496e 7669 7465 206f  .    """Invite o
+000149b0: 6e65 206f 7220 6d75 6c74 6970 6c65 2075  ne or multiple u
+000149c0: 7365 7273 2074 6f20 6f6e 6520 6f72 206d  sers to one or m
+000149d0: 756c 7469 706c 6520 726f 6f6d 732e 2222  ultiple rooms.""
+000149e0: 220a 2020 2020 726f 6f6d 7320 3d20 6773  ".    rooms = gs
+000149f0: 2e70 612e 726f 6f6d 5f69 6e76 6974 650a  .pa.room_invite.
+00014a00: 2020 2020 7573 6572 7320 3d20 6773 2e70      users = gs.p
+00014a10: 612e 7573 6572 0a20 2020 2074 7279 3a0a  a.user.    try:.
+00014a20: 2020 2020 2020 2020 666f 7220 726f 6f6d          for room
+00014a30: 5f69 6420 696e 2072 6f6f 6d73 3a0a 2020  _id in rooms:.  
+00014a40: 2020 2020 2020 2020 2020 2320 726f 6f6d            # room
+00014a50: 5f69 6420 6361 6e20 6265 2023 726f 6f6d  _id can be #room
+00014a60: 416c 6961 7320 6f72 2021 726f 6f6d 4964  Alias or !roomId
+00014a70: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+00014a80: 6c6f 672e 6465 6275 6728 6627 5072 6570  log.debug(f'Prep
+00014a90: 6172 696e 6720 746f 2069 6e76 6974 6520  aring to invite 
+00014aa0: 746f 2072 6f6f 6d20 227b 726f 6f6d 5f69  to room "{room_i
+00014ab0: 647d 222e 2729 0a20 2020 2020 2020 2020  d}".').         
+00014ac0: 2020 2072 6f6f 6d5f 6964 203d 2061 7761     room_id = awa
+00014ad0: 6974 206d 6170 5f72 6f6f 6d69 6e66 6f5f  it map_roominfo_
+00014ae0: 746f 5f72 6f6f 6d69 6428 636c 6965 6e74  to_roomid(client
+00014af0: 2c20 726f 6f6d 5f69 6429 0a20 2020 2020  , room_id).     
+00014b00: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+00014b10: 6275 6728 6627 496e 7669 7469 6e67 2074  bug(f'Inviting t
+00014b20: 6f20 726f 6f6d 2022 7b72 6f6f 6d5f 6964  o room "{room_id
+00014b30: 7d22 2e27 290a 2020 2020 2020 2020 2020  }".').          
+00014b40: 2020 666f 7220 7573 6572 2069 6e20 7573    for user in us
+00014b50: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+00014b60: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
+00014b70: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+00014b80: 2020 2020 2020 2066 2749 6e76 6974 696e         f'Invitin
+00014b90: 6720 7573 6572 2022 7b75 7365 727d 2220  g user "{user}" 
+00014ba0: 746f 2072 6f6f 6d20 7769 7468 2027 0a20  to room with '. 
+00014bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014bc0: 2020 2066 2772 6f6f 6d20 616c 6961 7320     f'room alias 
+00014bd0: 227b 726f 6f6d 5f69 647d 222e 270a 2020  "{room_id}".'.  
+00014be0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00014bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014c00: 7265 7370 203d 2061 7761 6974 2063 6c69  resp = await cli
+00014c10: 656e 742e 726f 6f6d 5f69 6e76 6974 6528  ent.room_invite(
+00014c20: 726f 6f6d 5f69 642c 2075 7365 7229 0a20  room_id, user). 
+00014c30: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00014c40: 6620 6973 696e 7374 616e 6365 2872 6573  f isinstance(res
+00014c50: 702c 2052 6f6f 6d49 6e76 6974 6545 7272  p, RoomInviteErr
+00014c60: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+00014c70: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
+00014c80: 6572 726f 7228 0a20 2020 2020 2020 2020  error(.         
+00014c90: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00014ca0: 4531 3335 3a20 220a 2020 2020 2020 2020  E135: ".        
+00014cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014cc0: 6622 726f 6f6d 5f69 6e76 6974 6520 6661  f"room_invite fa
+00014cd0: 696c 6564 2077 6974 6820 7b70 7269 7661  iled with {priva
+00014ce0: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
+00014cf0: 7370 2929 7d22 0a20 2020 2020 2020 2020  sp))}".         
+00014d00: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00014d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014d20: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
+00014d30: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
+00014d40: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00014d50: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
+00014d60: 6c6f 672e 696e 666f 280a 2020 2020 2020  log.info(.      
+00014d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014d80: 2020 6627 5573 6572 2022 7b75 7365 727d    f'User "{user}
+00014d90: 2220 7761 7320 7375 6363 6573 7366 756c  " was successful
+00014da0: 6c79 2069 6e76 6974 6564 2027 0a20 2020  ly invited '.   
+00014db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014dc0: 2020 2020 2066 2774 6f20 726f 6f6d 2022       f'to room "
+00014dd0: 7b72 6f6f 6d5f 6964 7d22 2e27 0a20 2020  {room_id}".'.   
+00014de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014df0: 2029 0a20 2020 2065 7863 6570 7420 4578   ).    except Ex
+00014e00: 6365 7074 696f 6e3a 0a20 2020 2020 2020  ception:.       
+00014e10: 2067 732e 6c6f 672e 6572 726f 7228 2245   gs.log.error("E
+00014e20: 3133 363a 2022 2022 5573 6572 2069 6e76  136: " "User inv
+00014e30: 6974 6520 6661 696c 6564 2e20 536f 7272  ite failed. Sorr
+00014e40: 792e 2229 0a20 2020 2020 2020 2067 732e  y.").        gs.
+00014e50: 6c6f 672e 6465 6275 6728 2248 6572 6520  log.debug("Here 
+00014e60: 6973 2074 6865 2074 7261 6365 6261 636b  is the traceback
+00014e70: 2e5c 6e22 202b 2074 7261 6365 6261 636b  .\n" + traceback
+00014e80: 2e66 6f72 6d61 745f 6578 6328 2929 0a0a  .format_exc())..
+00014e90: 0a61 7379 6e63 2064 6566 2061 6374 696f  .async def actio
+00014ea0: 6e5f 726f 6f6d 5f62 616e 2863 6c69 656e  n_room_ban(clien
+00014eb0: 742c 2063 7265 6465 6e74 6961 6c73 293a  t, credentials):
+00014ec0: 0a20 2020 2022 2222 4261 6e20 6f6e 6520  .    """Ban one 
+00014ed0: 6f72 206d 756c 7469 706c 6520 7573 6572  or multiple user
+00014ee0: 7320 6672 6f6d 206f 6e65 206f 7220 6d75  s from one or mu
+00014ef0: 6c74 6970 6c65 2072 6f6f 6d73 2e22 2222  ltiple rooms."""
+00014f00: 0a20 2020 2072 6f6f 6d73 203d 2067 732e  .    rooms = gs.
+00014f10: 7061 2e72 6f6f 6d5f 6261 6e0a 2020 2020  pa.room_ban.    
+00014f20: 7573 6572 7320 3d20 6773 2e70 612e 7573  users = gs.pa.us
+00014f30: 6572 0a20 2020 2074 7279 3a0a 2020 2020  er.    try:.    
+00014f40: 2020 2020 666f 7220 726f 6f6d 5f69 6420      for room_id 
+00014f50: 696e 2072 6f6f 6d73 3a0a 2020 2020 2020  in rooms:.      
+00014f60: 2020 2020 2020 2320 726f 6f6d 5f69 6420        # room_id 
+00014f70: 6361 6e20 6265 2023 726f 6f6d 416c 6961  can be #roomAlia
+00014f80: 7320 6f72 2021 726f 6f6d 4964 0a20 2020  s or !roomId.   
+00014f90: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
+00014fa0: 6465 6275 6728 6627 5072 6570 6172 696e  debug(f'Preparin
+00014fb0: 6720 746f 2062 616e 2069 6e20 726f 6f6d  g to ban in room
+00014fc0: 2022 7b72 6f6f 6d5f 6964 7d22 2e27 290a   "{room_id}".').
+00014fd0: 2020 2020 2020 2020 2020 2020 726f 6f6d              room
+00014fe0: 5f69 6420 3d20 6177 6169 7420 6d61 705f  _id = await map_
+00014ff0: 726f 6f6d 696e 666f 5f74 6f5f 726f 6f6d  roominfo_to_room
+00015000: 6964 2863 6c69 656e 742c 2072 6f6f 6d5f  id(client, room_
+00015010: 6964 290a 2020 2020 2020 2020 2020 2020  id).            
+00015020: 6773 2e6c 6f67 2e64 6562 7567 2866 2742  gs.log.debug(f'B
+00015030: 616e 6e69 6e67 2074 6f20 726f 6f6d 2022  anning to room "
+00015040: 7b72 6f6f 6d5f 6964 7d22 2e27 290a 2020  {room_id}".').  
+00015050: 2020 2020 2020 2020 2020 666f 7220 7573            for us
+00015060: 6572 2069 6e20 7573 6572 733a 0a20 2020  er in users:.   
+00015070: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
+00015080: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
+00015090: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000150a0: 2742 616e 6e69 6e67 2075 7365 7220 227b  'Banning user "{
+000150b0: 7573 6572 7d22 2066 726f 6d20 726f 6f6d  user}" from room
+000150c0: 2077 6974 6820 270a 2020 2020 2020 2020   with '.        
+000150d0: 2020 2020 2020 2020 2020 2020 6627 726f              f'ro
+000150e0: 6f6d 2061 6c69 6173 2022 7b72 6f6f 6d5f  om alias "{room_
+000150f0: 6964 7d22 2e27 0a20 2020 2020 2020 2020  id}".'.         
+00015100: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00015110: 2020 2020 2020 2020 2072 6573 7020 3d20           resp = 
+00015120: 6177 6169 7420 636c 6965 6e74 2e72 6f6f  await client.roo
+00015130: 6d5f 6261 6e28 726f 6f6d 5f69 642c 2075  m_ban(room_id, u
+00015140: 7365 7229 0a20 2020 2020 2020 2020 2020  ser).           
+00015150: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+00015160: 6365 2872 6573 702c 2052 6f6f 6d42 616e  ce(resp, RoomBan
+00015170: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+00015180: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+00015190: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
+000151a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000151b0: 2020 2245 3133 373a 2022 0a20 2020 2020    "E137: ".     
+000151c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000151d0: 2020 2066 2272 6f6f 6d5f 6261 6e20 6661     f"room_ban fa
+000151e0: 696c 6564 2077 6974 6820 7b70 7269 7661  iled with {priva
+000151f0: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
+00015200: 7370 2929 7d22 0a20 2020 2020 2020 2020  sp))}".         
+00015210: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00015220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015230: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
+00015240: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
+00015250: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00015260: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
+00015270: 6c6f 672e 696e 666f 280a 2020 2020 2020  log.info(.      
+00015280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015290: 2020 6627 5573 6572 2022 7b75 7365 727d    f'User "{user}
+000152a0: 2220 7761 7320 7375 6363 6573 7366 756c  " was successful
+000152b0: 6c79 2062 616e 6e65 6420 270a 2020 2020  ly banned '.    
+000152c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000152d0: 2020 2020 6627 6672 6f6d 2072 6f6f 6d20      f'from room 
+000152e0: 227b 726f 6f6d 5f69 647d 222e 270a 2020  "{room_id}".'.  
+000152f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015300: 2020 290a 2020 2020 6578 6365 7074 2045    ).    except E
+00015310: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
+00015320: 2020 6773 2e6c 6f67 2e65 7272 6f72 2822    gs.log.error("
+00015330: 4531 3338 3a20 2220 2255 7365 7220 6261  E138: " "User ba
+00015340: 6e20 6661 696c 6564 2e20 536f 7272 792e  n failed. Sorry.
+00015350: 2229 0a20 2020 2020 2020 2067 732e 6c6f  ").        gs.lo
+00015360: 672e 6465 6275 6728 2248 6572 6520 6973  g.debug("Here is
+00015370: 2074 6865 2074 7261 6365 6261 636b 2e5c   the traceback.\
+00015380: 6e22 202b 2074 7261 6365 6261 636b 2e66  n" + traceback.f
+00015390: 6f72 6d61 745f 6578 6328 2929 0a0a 0a61  ormat_exc())...a
+000153a0: 7379 6e63 2064 6566 2061 6374 696f 6e5f  sync def action_
+000153b0: 726f 6f6d 5f75 6e62 616e 2863 6c69 656e  room_unban(clien
+000153c0: 742c 2063 7265 6465 6e74 6961 6c73 293a  t, credentials):
+000153d0: 0a20 2020 2022 2222 556e 6261 6e20 6f6e  .    """Unban on
+000153e0: 6520 6f72 206d 756c 7469 706c 6520 7573  e or multiple us
+000153f0: 6572 7320 6672 6f6d 206f 6e65 206f 7220  ers from one or 
+00015400: 6d75 6c74 6970 6c65 2072 6f6f 6d73 2e22  multiple rooms."
+00015410: 2222 0a20 2020 2072 6f6f 6d73 203d 2067  "".    rooms = g
+00015420: 732e 7061 2e72 6f6f 6d5f 756e 6261 6e0a  s.pa.room_unban.
+00015430: 2020 2020 7573 6572 7320 3d20 6773 2e70      users = gs.p
+00015440: 612e 7573 6572 0a20 2020 2074 7279 3a0a  a.user.    try:.
+00015450: 2020 2020 2020 2020 666f 7220 726f 6f6d          for room
+00015460: 5f69 6420 696e 2072 6f6f 6d73 3a0a 2020  _id in rooms:.  
+00015470: 2020 2020 2020 2020 2020 2320 726f 6f6d            # room
+00015480: 5f69 6420 6361 6e20 6265 2023 726f 6f6d  _id can be #room
+00015490: 416c 6961 7320 6f72 2021 726f 6f6d 4964  Alias or !roomId
+000154a0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+000154b0: 6c6f 672e 6465 6275 6728 6627 5072 6570  log.debug(f'Prep
+000154c0: 6172 696e 6720 746f 2075 6e62 616e 2069  aring to unban i
+000154d0: 6e20 726f 6f6d 2022 7b72 6f6f 6d5f 6964  n room "{room_id
+000154e0: 7d22 2e27 290a 2020 2020 2020 2020 2020  }".').          
+000154f0: 2020 726f 6f6d 5f69 6420 3d20 6177 6169    room_id = awai
+00015500: 7420 6d61 705f 726f 6f6d 696e 666f 5f74  t map_roominfo_t
+00015510: 6f5f 726f 6f6d 6964 2863 6c69 656e 742c  o_roomid(client,
+00015520: 2072 6f6f 6d5f 6964 290a 2020 2020 2020   room_id).      
+00015530: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+00015540: 7567 2866 2755 6e62 616e 6e69 6e67 2074  ug(f'Unbanning t
+00015550: 6f20 726f 6f6d 2022 7b72 6f6f 6d5f 6964  o room "{room_id
+00015560: 7d22 2e27 290a 2020 2020 2020 2020 2020  }".').          
+00015570: 2020 666f 7220 7573 6572 2069 6e20 7573    for user in us
+00015580: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+00015590: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
+000155a0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+000155b0: 2020 2020 2020 2066 2755 6e62 616e 6e69         f'Unbanni
+000155c0: 6e67 2075 7365 7220 227b 7573 6572 7d22  ng user "{user}"
+000155d0: 2066 726f 6d20 726f 6f6d 2077 6974 6820   from room with 
+000155e0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+000155f0: 2020 2020 2020 6627 726f 6f6d 2061 6c69        f'room ali
+00015600: 6173 2022 7b72 6f6f 6d5f 6964 7d22 2e27  as "{room_id}".'
+00015610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015620: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00015630: 2020 2072 6573 7020 3d20 6177 6169 7420     resp = await 
+00015640: 636c 6965 6e74 2e72 6f6f 6d5f 756e 6261  client.room_unba
+00015650: 6e28 726f 6f6d 5f69 642c 2075 7365 7229  n(room_id, user)
+00015660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015670: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
+00015680: 6573 702c 2052 6f6f 6d55 6e62 616e 4572  esp, RoomUnbanEr
+00015690: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+000156a0: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
+000156b0: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
+000156c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000156d0: 2245 3133 393a 2022 0a20 2020 2020 2020  "E139: ".       
+000156e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000156f0: 2066 2272 6f6f 6d5f 756e 6261 6e20 6661   f"room_unban fa
+00015700: 696c 6564 2077 6974 6820 7b70 7269 7661  iled with {priva
+00015710: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
+00015720: 7370 2929 7d22 0a20 2020 2020 2020 2020  sp))}".         
+00015730: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00015740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015750: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
+00015760: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
+00015770: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00015780: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
+00015790: 6c6f 672e 696e 666f 280a 2020 2020 2020  log.info(.      
+000157a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000157b0: 2020 6627 5573 6572 2022 7b75 7365 727d    f'User "{user}
+000157c0: 2220 7761 7320 7375 6363 6573 7366 756c  " was successful
+000157d0: 6c79 2075 6e62 616e 6e65 6420 270a 2020  ly unbanned '.  
+000157e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000157f0: 2020 2020 2020 6627 6672 6f6d 2072 6f6f        f'from roo
+00015800: 6d20 227b 726f 6f6d 5f69 647d 222e 270a  m "{room_id}".'.
+00015810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015820: 2020 2020 290a 2020 2020 6578 6365 7074      ).    except
+00015830: 2045 7863 6570 7469 6f6e 3a0a 2020 2020   Exception:.    
+00015840: 2020 2020 6773 2e6c 6f67 2e65 7272 6f72      gs.log.error
+00015850: 2822 4531 3430 3a20 2220 2255 7365 7220  ("E140: " "User 
+00015860: 756e 6261 6e20 6661 696c 6564 2e20 536f  unban failed. So
+00015870: 7272 792e 2229 0a20 2020 2020 2020 2067  rry.").        g
+00015880: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
+00015890: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
+000158a0: 6465 6275 6728 2248 6572 6520 6973 2074  debug("Here is t
+000158b0: 6865 2074 7261 6365 6261 636b 2e5c 6e22  he traceback.\n"
+000158c0: 202b 2074 7261 6365 6261 636b 2e66 6f72   + traceback.for
+000158d0: 6d61 745f 6578 6328 2929 0a0a 0a61 7379  mat_exc())...asy
+000158e0: 6e63 2064 6566 2061 6374 696f 6e5f 726f  nc def action_ro
+000158f0: 6f6d 5f6b 6963 6b28 636c 6965 6e74 2c20  om_kick(client, 
+00015900: 6372 6564 656e 7469 616c 7329 3a0a 2020  credentials):.  
+00015910: 2020 2222 224b 6963 6b20 6f6e 6520 6f72    """Kick one or
+00015920: 206d 756c 7469 706c 6520 7573 6572 7320   multiple users 
+00015930: 6672 6f6d 206f 6e65 206f 7220 6d75 6c74  from one or mult
+00015940: 6970 6c65 2072 6f6f 6d73 2e22 2222 0a20  iple rooms.""". 
+00015950: 2020 2072 6f6f 6d73 203d 2067 732e 7061     rooms = gs.pa
+00015960: 2e72 6f6f 6d5f 6b69 636b 0a20 2020 2075  .room_kick.    u
+00015970: 7365 7273 203d 2067 732e 7061 2e75 7365  sers = gs.pa.use
+00015980: 720a 2020 2020 7472 793a 0a20 2020 2020  r.    try:.     
+00015990: 2020 2066 6f72 2072 6f6f 6d5f 6964 2069     for room_id i
+000159a0: 6e20 726f 6f6d 733a 0a20 2020 2020 2020  n rooms:.       
+000159b0: 2020 2020 2023 2072 6f6f 6d5f 6964 2063       # room_id c
+000159c0: 616e 2062 6520 2372 6f6f 6d41 6c69 6173  an be #roomAlias
+000159d0: 206f 7220 2172 6f6f 6d49 640a 2020 2020   or !roomId.    
+000159e0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+000159f0: 6562 7567 2866 2750 7265 7061 7269 6e67  ebug(f'Preparing
+00015a00: 2074 6f20 6b69 636b 696e 6720 6f66 6620   to kicking off 
+00015a10: 726f 6f6d 2022 7b72 6f6f 6d5f 6964 7d22  room "{room_id}"
+00015a20: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
+00015a30: 726f 6f6d 5f69 6420 3d20 6177 6169 7420  room_id = await 
+00015a40: 6d61 705f 726f 6f6d 696e 666f 5f74 6f5f  map_roominfo_to_
+00015a50: 726f 6f6d 6964 2863 6c69 656e 742c 2072  roomid(client, r
+00015a60: 6f6f 6d5f 6964 290a 2020 2020 2020 2020  oom_id).        
+00015a70: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+00015a80: 2866 274b 6963 6b69 6e67 206f 6666 2072  (f'Kicking off r
+00015a90: 6f6f 6d20 227b 726f 6f6d 5f69 647d 222e  oom "{room_id}".
+00015aa0: 2729 0a20 2020 2020 2020 2020 2020 2066  ').            f
+00015ab0: 6f72 2075 7365 7220 696e 2075 7365 7273  or user in users
+00015ac0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00015ad0: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
+00015ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015af0: 2020 2020 6627 4b69 636b 696e 6720 7573      f'Kicking us
+00015b00: 6572 2022 7b75 7365 727d 2220 6672 6f6d  er "{user}" from
+00015b10: 2072 6f6f 6d20 7769 7468 2027 0a20 2020   room with '.   
+00015b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015b30: 2066 2772 6f6f 6d20 616c 6961 7320 227b   f'room alias "{
+00015b40: 726f 6f6d 5f69 647d 222e 270a 2020 2020  room_id}".'.    
+00015b50: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00015b60: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00015b70: 7370 203d 2061 7761 6974 2063 6c69 656e  sp = await clien
+00015b80: 742e 726f 6f6d 5f6b 6963 6b28 726f 6f6d  t.room_kick(room
+00015b90: 5f69 642c 2075 7365 7229 0a20 2020 2020  _id, user).     
+00015ba0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00015bb0: 696e 7374 616e 6365 2872 6573 702c 2052  instance(resp, R
+00015bc0: 6f6f 6d4b 6963 6b45 7272 6f72 293a 0a20  oomKickError):. 
+00015bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015be0: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
+00015bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015c00: 2020 2020 2020 2020 2022 4531 3431 3a20           "E141: 
+00015c10: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00015c20: 2020 2020 2020 2020 2020 6622 726f 6f6d            f"room
+00015c30: 5f6b 6963 6b20 6661 696c 6564 2077 6974  _kick failed wit
+00015c40: 6820 7b70 7269 7661 6379 5f66 696c 7465  h {privacy_filte
+00015c50: 7228 7374 7228 7265 7370 2929 7d22 0a20  r(str(resp))}". 
+00015c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015c70: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00015c80: 2020 2020 2020 2020 2067 732e 6572 725f           gs.err_
+00015c90: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
+00015ca0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00015cb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015cc0: 2020 2020 2067 732e 6c6f 672e 696e 666f       gs.log.info
+00015cd0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00015ce0: 2020 2020 2020 2020 2020 6627 5573 6572            f'User
+00015cf0: 2022 7b75 7365 727d 2220 7761 7320 7375   "{user}" was su
+00015d00: 6363 6573 7366 756c 6c79 206b 6963 6b65  ccessfully kicke
+00015d10: 6420 270a 2020 2020 2020 2020 2020 2020  d '.            
+00015d20: 2020 2020 2020 2020 2020 2020 6627 6672              f'fr
+00015d30: 6f6d 2072 6f6f 6d20 227b 726f 6f6d 5f69  om room "{room_i
+00015d40: 647d 222e 270a 2020 2020 2020 2020 2020  d}".'.          
+00015d50: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00015d60: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+00015d70: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
+00015d80: 2e65 7272 6f72 2822 4531 3432 3a20 2220  .error("E142: " 
+00015d90: 2255 7365 7220 6b69 636b 2066 6169 6c65  "User kick faile
+00015da0: 642e 2053 6f72 7279 2e22 290a 2020 2020  d. Sorry.").    
+00015db0: 2020 2020 6773 2e65 7272 5f63 6f75 6e74      gs.err_count
+00015dc0: 202b 3d20 310a 2020 2020 2020 2020 6773   += 1.        gs
+00015dd0: 2e6c 6f67 2e64 6562 7567 2822 4865 7265  .log.debug("Here
+00015de0: 2069 7320 7468 6520 7472 6163 6562 6163   is the tracebac
+00015df0: 6b2e 5c6e 2220 2b20 7472 6163 6562 6163  k.\n" + tracebac
+00015e00: 6b2e 666f 726d 6174 5f65 7863 2829 290a  k.format_exc()).
+00015e10: 0a0a 2320 6163 636f 7264 696e 6720 746f  ..# according to
+00015e20: 206c 696e 7465 723a 2066 756e 6374 696f   linter: functio
+00015e30: 6e20 6973 2074 6f6f 2063 6f6d 706c 6578  n is too complex
+00015e40: 2c20 4339 3031 0a61 7379 6e63 2064 6566  , C901.async def
+00015e50: 2073 656e 645f 6576 656e 7428 636c 6965   send_event(clie
+00015e60: 6e74 2c20 726f 6f6d 732c 2065 7665 6e74  nt, rooms, event
+00015e70: 293a 2020 2320 6e6f 7161 3a20 4339 3031  ):  # noqa: C901
+00015e80: 0a20 2020 2022 2222 5072 6f63 6573 7320  .    """Process 
+00015e90: 6576 656e 742e 0a0a 2020 2020 4172 6775  event...    Argu
+00015ea0: 6d65 6e74 733a 0a20 2020 202d 2d2d 2d2d  ments:.    -----
+00015eb0: 2d2d 2d2d 0a20 2020 2063 6c69 656e 7420  ----.    client 
+00015ec0: 3a20 436c 6965 6e74 0a20 2020 2072 6f6f  : Client.    roo
+00015ed0: 6d73 203a 206c 6973 740a 2020 2020 2020  ms : list.      
+00015ee0: 2020 6c69 7374 206f 6620 726f 6f6d 5f69    list of room_i
+00015ef0: 642d 730a 2020 2020 6576 656e 7420 3a20  d-s.    event : 
+00015f00: 7374 720a 2020 2020 2020 2020 6669 6c65  str.        file
+00015f10: 206e 616d 6520 6f66 2065 7665 6e74 2066   name of event f
+00015f20: 726f 6d20 2d2d 6576 656e 7420 6172 6775  rom --event argu
+00015f30: 6d65 6e74 0a0a 2020 2020 2222 220a 2020  ment..    """.  
+00015f40: 2020 6966 206e 6f74 2072 6f6f 6d73 3a0a    if not rooms:.
+00015f50: 2020 2020 2020 2020 6773 2e6c 6f67 2e69          gs.log.i
+00015f60: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
+00015f70: 2022 4e6f 2072 6f6f 6d73 2061 7265 2067   "No rooms are g
+00015f80: 6976 656e 2e20 5468 6973 2073 686f 756c  iven. This shoul
+00015f90: 6420 6e6f 7420 6861 7070 656e 2e20 220a  d not happen. ".
+00015fa0: 2020 2020 2020 2020 2020 2020 224d 6179              "May
+00015fb0: 6265 2079 6f75 7220 444d 2072 6f6f 6d73  be your DM rooms
+00015fc0: 2073 7065 6369 6669 6564 2076 6961 202d   specified via -
+00015fd0: 2d75 7365 7220 7765 7265 206e 6f74 2066  -user were not f
+00015fe0: 6f75 6e64 2e20 220a 2020 2020 2020 2020  ound. ".        
+00015ff0: 2020 2020 2254 6869 7320 6669 6c65 2069      "This file i
+00016000: 7320 6265 696e 6720 6472 6f70 7065 6420  s being dropped 
+00016010: 616e 6420 4e4f 5420 7365 6e74 2e22 0a20  and NOT sent.". 
+00016020: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00016030: 2072 6574 7572 6e0a 0a20 2020 2069 6620   return..    if 
+00016040: 6576 656e 7420 3d3d 2022 2d22 3a20 2023  event == "-":  #
+00016050: 202d 206d 6561 6e73 2072 6561 6420 6173   - means read as
+00016060: 2070 6970 6520 6672 6f6d 2073 7464 696e   pipe from stdin
+00016070: 0a20 2020 2020 2020 206a 736f 6e64 6174  .        jsondat
+00016080: 6120 3d20 7379 732e 7374 6469 6e2e 6275  a = sys.stdin.bu
+00016090: 6666 6572 2e72 6561 6428 292e 6465 636f  ffer.read().deco
+000160a0: 6465 2829 2020 2320 6269 6e61 7279 2072  de()  # binary r
+000160b0: 6561 640a 2020 2020 656c 7365 3a0a 2020  ead.    else:.  
+000160c0: 2020 2020 2020 7769 7468 206f 7065 6e28        with open(
+000160d0: 6576 656e 742c 2022 7222 2920 6173 2066  event, "r") as f
+000160e0: 696c 653a 0a20 2020 2020 2020 2020 2020  ile:.           
+000160f0: 206a 736f 6e64 6174 6120 3d20 6669 6c65   jsondata = file
+00016100: 2e72 6561 6428 290a 2020 2020 6773 2e6c  .read().    gs.l
+00016110: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
+00016120: 2020 6622 7b6c 656e 286a 736f 6e64 6174    f"{len(jsondat
+00016130: 6129 7d20 6279 7465 7320 6f66 2065 7665  a)} bytes of eve
+00016140: 6e74 2064 6174 6120 7265 6164 2066 726f  nt data read fro
+00016150: 6d20 6669 6c65 207b 6576 656e 747d 2e22  m file {event}."
+00016160: 0a20 2020 2029 0a20 2020 2067 732e 6c6f  .    ).    gs.lo
+00016170: 672e 6465 6275 6728 6622 4576 656e 7420  g.debug(f"Event 
+00016180: 7b65 7665 6e74 7d20 636f 6e74 6169 6e73  {event} contains
+00016190: 2074 6869 7320 4a53 4f4e 2064 6174 613a   this JSON data:
+000161a0: 207b 6a73 6f6e 6461 7461 7d22 290a 0a20   {jsondata}").. 
+000161b0: 2020 2069 6620 6e6f 7420 6a73 6f6e 6461     if not jsonda
+000161c0: 7461 2e73 7472 6970 2829 3a0a 2020 2020  ta.strip():.    
+000161d0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+000161e0: 280a 2020 2020 2020 2020 2020 2020 2245  (.            "E
+000161f0: 7665 6e74 2069 7320 656d 7074 792e 2054  vent is empty. T
+00016200: 6869 7320 6576 656e 7420 6973 2062 6569  his event is bei
+00016210: 6e67 2064 726f 7070 6564 2061 6e64 204e  ng dropped and N
+00016220: 4f54 2073 656e 742e 220a 2020 2020 2020  OT sent.".      
+00016230: 2020 290a 2020 2020 2020 2020 7265 7475    ).        retu
+00016240: 726e 0a0a 2020 2020 7472 793a 0a20 2020  rn..    try:.   
+00016250: 2020 2020 2063 6f6e 7465 6e74 5f6a 736f       content_jso
+00016260: 6e20 3d20 6a73 6f6e 2e6c 6f61 6473 286a  n = json.loads(j
+00016270: 736f 6e64 6174 6129 0a20 2020 2020 2020  sondata).       
+00016280: 206d 6573 7361 6765 5f74 7970 6520 3d20   message_type = 
+00016290: 636f 6e74 656e 745f 6a73 6f6e 5b22 7479  content_json["ty
+000162a0: 7065 225d 0a20 2020 2020 2020 2063 6f6e  pe"].        con
+000162b0: 7465 6e74 203d 2063 6f6e 7465 6e74 5f6a  tent = content_j
+000162c0: 736f 6e5b 2263 6f6e 7465 6e74 225d 0a20  son["content"]. 
+000162d0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+000162e0: 696f 6e3a 0a20 2020 2020 2020 2067 732e  ion:.        gs.
+000162f0: 6c6f 672e 6572 726f 7228 0a20 2020 2020  log.error(.     
+00016300: 2020 2020 2020 2022 4531 3433 3a20 220a         "E143: ".
+00016310: 2020 2020 2020 2020 2020 2020 2245 7665              "Eve
+00016320: 6e74 2069 7320 6e6f 7420 6120 7661 6c69  nt is not a vali
+00016330: 6420 4a53 4f4e 206f 626a 6563 7420 6f72  d JSON object or
+00016340: 206e 6f74 206f 6620 4d61 7472 6978 204a   not of Matrix J
+00016350: 534f 4e20 666f 726d 6174 2e20 220a 2020  SON format. ".  
+00016360: 2020 2020 2020 2020 2020 2254 6869 7320            "This 
+00016370: 6576 656e 7420 6973 2062 6569 6e67 2064  event is being d
+00016380: 726f 7070 6564 2061 6e64 204e 4f54 2073  ropped and NOT s
+00016390: 656e 742e 220a 2020 2020 2020 2020 290a  ent.".        ).
+000163a0: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
+000163b0: 6f75 6e74 202b 3d20 310a 2020 2020 2020  ount += 1.      
+000163c0: 2020 6773 2e6c 6f67 2e64 6562 7567 2822    gs.log.debug("
+000163d0: 4865 7265 2069 7320 7468 6520 7472 6163  Here is the trac
+000163e0: 6562 6163 6b2e 5c6e 2220 2b20 7472 6163  eback.\n" + trac
+000163f0: 6562 6163 6b2e 666f 726d 6174 5f65 7863  eback.format_exc
+00016400: 2829 290a 2020 2020 2020 2020 7265 7475  ()).        retu
+00016410: 726e 0a0a 2020 2020 7472 793a 0a20 2020  rn..    try:.   
+00016420: 2020 2020 2066 6f72 2072 6f6f 6d5f 6964       for room_id
+00016430: 2069 6e20 726f 6f6d 733a 0a20 2020 2020   in rooms:.     
+00016440: 2020 2020 2020 2072 6f6f 6d5f 6964 203d         room_id =
+00016450: 2061 7761 6974 206d 6170 5f72 6f6f 6d69   await map_roomi
+00016460: 6e66 6f5f 746f 5f72 6f6f 6d69 6428 636c  nfo_to_roomid(cl
+00016470: 6965 6e74 2c20 726f 6f6d 5f69 6429 0a20  ient, room_id). 
+00016480: 2020 2020 2020 2020 2020 2072 6573 7020             resp 
+00016490: 3d20 6177 6169 7420 636c 6965 6e74 2e72  = await client.r
+000164a0: 6f6f 6d5f 7365 6e64 280a 2020 2020 2020  oom_send(.      
+000164b0: 2020 2020 2020 2020 2020 726f 6f6d 5f69            room_i
+000164c0: 642c 206d 6573 7361 6765 5f74 7970 653d  d, message_type=
+000164d0: 6d65 7373 6167 655f 7479 7065 2c20 636f  message_type, co
+000164e0: 6e74 656e 743d 636f 6e74 656e 740a 2020  ntent=content.  
+000164f0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00016500: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00016510: 7461 6e63 6528 7265 7370 2c20 526f 6f6d  tance(resp, Room
+00016520: 5365 6e64 4572 726f 7229 3a0a 2020 2020  SendError):.    
+00016530: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+00016540: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
+00016550: 2020 2020 2020 2020 2020 2020 2020 2245                "E
+00016560: 3134 343a 2022 0a20 2020 2020 2020 2020  144: ".         
+00016570: 2020 2020 2020 2020 2020 2022 726f 6f6d             "room
+00016580: 5f73 656e 6420 6661 696c 6564 2077 6974  _send failed wit
+00016590: 6820 6572 726f 7220 220a 2020 2020 2020  h error ".      
+000165a0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+000165b0: 277b 7072 6976 6163 795f 6669 6c74 6572  '{privacy_filter
+000165c0: 2873 7472 2872 6573 7029 297d 272e 220a  (str(resp))}'.".
+000165d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000165e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000165f0: 2020 2320 6773 2e65 7272 5f63 6f75 6e74    # gs.err_count
+00016600: 202b 3d20 3120 2320 6e6f 7420 6e65 6564   += 1 # not need
+00016610: 6564 2c20 7769 6c6c 2072 6169 7365 2065  ed, will raise e
+00016620: 7863 6570 7469 6f6e 0a20 2020 2020 2020  xception.       
+00016630: 2020 2020 2020 2020 2023 2069 6e20 666f           # in fo
+00016640: 6c6c 6f77 696e 6720 6c69 6e65 206f 6620  llowing line of 
+00016650: 636f 6465 0a20 2020 2020 2020 2020 2020  code.           
+00016660: 2067 732e 6c6f 672e 696e 666f 280a 2020   gs.log.info(.  
+00016670: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00016680: 5468 6973 2065 7665 6e74 2077 6173 2073  This event was s
+00016690: 656e 743a 2022 7b65 7665 6e74 7d22 2074  ent: "{event}" t
+000166a0: 6f20 726f 6f6d 2022 7b72 6573 702e 726f  o room "{resp.ro
+000166b0: 6f6d 5f69 647d 2220 270a 2020 2020 2020  om_id}" '.      
+000166c0: 2020 2020 2020 2020 2020 6627 6173 2065            f'as e
+000166d0: 7665 6e74 2022 7b72 6573 702e 6576 656e  vent "{resp.even
+000166e0: 745f 6964 7d22 2e27 0a20 2020 2020 2020  t_id}".'.       
+000166f0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00016700: 2020 2069 6620 6773 2e70 612e 7072 696e     if gs.pa.prin
+00016710: 745f 6576 656e 745f 6964 3a0a 2020 2020  t_event_id:.    
+00016720: 2020 2020 2020 2020 2020 2020 2320 6f75              # ou
+00016730: 7470 7574 2066 6f72 6d61 7420 636f 6e74  tput format cont
+00016740: 726f 6c6c 6564 2076 6961 202d 2d6f 7574  rolled via --out
+00016750: 7075 7420 666c 6167 0a20 2020 2020 2020  put flag.       
+00016760: 2020 2020 2020 2020 2074 6578 7420 3d20           text = 
+00016770: 6622 7b72 6573 702e 6576 656e 745f 6964  f"{resp.event_id
+00016780: 7d7b 5345 507d 7b72 6573 702e 726f 6f6d  }{SEP}{resp.room
+00016790: 5f69 647d 7b53 4550 7d7b 6576 656e 747d  _id}{SEP}{event}
+000167a0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+000167b0: 2020 2320 4f62 6a65 6374 206f 6620 7479    # Object of ty
+000167c0: 7065 2052 6f6f 6d43 7265 6174 6552 6573  pe RoomCreateRes
+000167d0: 706f 6e73 6520 6973 206e 6f74 204a 534f  ponse is not JSO
+000167e0: 4e0a 2020 2020 2020 2020 2020 2020 2020  N.              
+000167f0: 2020 2320 7365 7269 616c 697a 6162 6c65    # serializable
+00016800: 2c20 6865 6e63 6520 7765 2075 7365 2074  , hence we use t
+00016810: 6865 2064 6963 7469 6f6e 6172 792e 0a20  he dictionary.. 
+00016820: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+00016830: 736f 6e5f 6d61 7820 3d20 7265 7370 2e5f  son_max = resp._
+00016840: 5f64 6963 745f 5f0a 2020 2020 2020 2020  _dict__.        
+00016850: 2020 2020 2020 2020 6a73 6f6e 5f6d 6178          json_max
+00016860: 2e75 7064 6174 6528 7b22 6576 656e 7422  .update({"event"
+00016870: 3a20 6576 656e 747d 2920 2023 2061 6464  : event})  # add
+00016880: 2064 6963 7420 6974 656d 730a 2020 2020   dict items.    
+00016890: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+000168a0: 5f20 3d20 6a73 6f6e 5f6d 6178 2e63 6f70  _ = json_max.cop
+000168b0: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
+000168c0: 2020 2020 6a73 6f6e 5f2e 706f 7028 2274      json_.pop("t
+000168d0: 7261 6e73 706f 7274 5f72 6573 706f 6e73  ransport_respons
+000168e0: 6522 290a 2020 2020 2020 2020 2020 2020  e").            
+000168f0: 2020 2020 6a73 6f6e 5f73 7065 6320 3d20      json_spec = 
+00016900: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+00016910: 2020 2020 2070 7269 6e74 5f6f 7574 7075       print_outpu
+00016920: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+00016930: 2020 2020 2020 2067 732e 7061 2e6f 7574         gs.pa.out
+00016940: 7075 742c 0a20 2020 2020 2020 2020 2020  put,.           
+00016950: 2020 2020 2020 2020 2074 6578 743d 7465           text=te
+00016960: 7874 2c0a 2020 2020 2020 2020 2020 2020  xt,.            
+00016970: 2020 2020 2020 2020 6a73 6f6e 5f3d 6a73          json_=js
+00016980: 6f6e 5f2c 0a20 2020 2020 2020 2020 2020  on_,.           
+00016990: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
+000169a0: 783d 6a73 6f6e 5f6d 6178 2c0a 2020 2020  x=json_max,.    
+000169b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000169c0: 6a73 6f6e 5f73 7065 633d 6a73 6f6e 5f73  json_spec=json_s
+000169d0: 7065 632c 0a20 2020 2020 2020 2020 2020  pec,.           
+000169e0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+000169f0: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+00016a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016a10: 2066 2754 6869 7320 6576 656e 7420 7761   f'This event wa
+00016a20: 7320 7365 6e74 3a20 227b 6576 656e 747d  s sent: "{event}
+00016a30: 2220 287b 636f 6e74 656e 747d 2920 270a  " ({content}) '.
+00016a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016a50: 6627 746f 2072 6f6f 6d20 227b 726f 6f6d  f'to room "{room
+00016a60: 5f69 647d 222e 2027 0a20 2020 2020 2020  _id}". '.       
+00016a70: 2020 2020 2020 2020 2066 2252 6573 706f           f"Respo
+00016a80: 6e73 653a 2065 7665 6e74 5f69 643d 7b72  nse: event_id={r
+00016a90: 6573 702e 6576 656e 745f 6964 7d2c 2072  esp.event_id}, r
+00016aa0: 6f6f 6d5f 6964 3d7b 7265 7370 2e72 6f6f  oom_id={resp.roo
+00016ab0: 6d5f 6964 7d2c 2022 0a20 2020 2020 2020  m_id}, ".       
+00016ac0: 2020 2020 2020 2020 2066 2266 756c 6c20           f"full 
+00016ad0: 7265 7370 6f6e 7365 3a20 7b70 7269 7661  response: {priva
+00016ae0: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
+00016af0: 7370 2929 7d2e 2022 0a20 2020 2020 2020  sp))}. ".       
+00016b00: 2020 2020 2029 0a20 2020 2065 7863 6570       ).    excep
+00016b10: 7420 4578 6365 7074 696f 6e3a 0a20 2020  t Exception:.   
+00016b20: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
+00016b30: 7228 2245 3134 353a 2022 2066 2245 7665  r("E145: " f"Eve
+00016b40: 6e74 2073 656e 6420 6f66 2066 696c 6520  nt send of file 
+00016b50: 7b65 7665 6e74 7d20 6661 696c 6564 2e20  {event} failed. 
+00016b60: 536f 7272 792e 2229 0a20 2020 2020 2020  Sorry.").       
+00016b70: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
+00016b80: 2031 0a20 2020 2020 2020 2067 732e 6c6f   1.        gs.lo
+00016b90: 672e 6465 6275 6728 2248 6572 6520 6973  g.debug("Here is
+00016ba0: 2074 6865 2074 7261 6365 6261 636b 2e5c   the traceback.\
+00016bb0: 6e22 202b 2074 7261 6365 6261 636b 2e66  n" + traceback.f
+00016bc0: 6f72 6d61 745f 6578 6328 2929 0a0a 0a23  ormat_exc())...#
+00016bd0: 2061 6363 6f72 6469 6e67 2074 6f20 6c69   according to li
+00016be0: 6e74 6572 3a20 6675 6e63 7469 6f6e 2069  nter: function i
+00016bf0: 7320 746f 6f20 636f 6d70 6c65 782c 2043  s too complex, C
+00016c00: 3930 310a 6173 796e 6320 6465 6620 7365  901.async def se
+00016c10: 6e64 5f66 696c 6528 636c 6965 6e74 2c20  nd_file(client, 
+00016c20: 726f 6f6d 732c 2066 696c 6529 3a20 2023  rooms, file):  #
+00016c30: 206e 6f71 613a 2043 3930 310a 2020 2020   noqa: C901.    
+00016c40: 2222 2250 726f 6365 7373 2066 696c 652e  """Process file.
+00016c50: 0a0a 2020 2020 5570 6c6f 6164 2066 696c  ..    Upload fil
+00016c60: 6520 746f 2073 6572 7665 7220 616e 6420  e to server and 
+00016c70: 7468 656e 2073 656e 6420 6c69 6e6b 2074  then send link t
+00016c80: 6f20 726f 6f6d 732e 0a20 2020 2057 6f72  o rooms..    Wor
+00016c90: 6b73 2061 6e64 2074 6573 7465 6420 666f  ks and tested fo
+00016ca0: 7220 2e70 6466 2c20 2e74 7874 2c20 2e6f  r .pdf, .txt, .o
+00016cb0: 6767 2c20 2e77 6176 2e0a 2020 2020 416c  gg, .wav..    Al
+00016cc0: 6c20 7468 6573 6520 6669 6c65 2074 7970  l these file typ
+00016cd0: 6573 2061 7265 2074 7265 6174 6564 2074  es are treated t
+00016ce0: 6865 2073 616d 652e 0a0a 2020 2020 446f  he same...    Do
+00016cf0: 206e 6f74 2075 7365 2074 6869 7320 6675   not use this fu
+00016d00: 6e63 7469 6f6e 2066 6f72 2069 6d61 6765  nction for image
+00016d10: 732e 0a20 2020 2055 7365 2074 6865 2073  s..    Use the s
+00016d20: 656e 645f 696d 6167 6528 2920 6675 6e63  end_image() func
+00016d30: 7469 6f6e 2066 6f72 2069 6d61 6765 732e  tion for images.
+00016d40: 0a0a 2020 2020 4d61 7472 6978 2068 6173  ..    Matrix has
+00016d50: 2074 7970 6573 2066 6f72 2061 7564 696f   types for audio
+00016d60: 2061 6e64 2076 6964 656f 2028 616e 6420   and video (and 
+00016d70: 696d 6167 6520 616e 6420 6669 6c65 292e  image and file).
+00016d80: 0a20 2020 2053 6565 3a20 226d 7367 7479  .    See: "msgty
+00016d90: 7065 2220 3d3d 2022 6d2e 696d 6167 6522  pe" == "m.image"
+00016da0: 2c20 6d2e 6175 6469 6f2c 206d 2e76 6964  , m.audio, m.vid
+00016db0: 656f 2c20 6d2e 6669 6c65 0a0a 2020 2020  eo, m.file..    
+00016dc0: 4172 6775 6d65 6e74 733a 0a20 2020 202d  Arguments:.    -
+00016dd0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063 6c69  --------.    cli
+00016de0: 656e 7420 3a20 436c 6965 6e74 0a20 2020  ent : Client.   
+00016df0: 2072 6f6f 6d73 203a 206c 6973 740a 2020   rooms : list.  
+00016e00: 2020 2020 2020 6c69 7374 206f 6620 726f        list of ro
+00016e10: 6f6d 5f69 642d 730a 2020 2020 6669 6c65  om_id-s.    file
+00016e20: 203a 2073 7472 0a20 2020 2020 2020 2066   : str.        f
+00016e30: 696c 6520 6e61 6d65 206f 6620 6669 6c65  ile name of file
+00016e40: 2066 726f 6d20 2d2d 6669 6c65 2061 7267   from --file arg
+00016e50: 756d 656e 740a 0a20 2020 2054 6869 7320  ument..    This 
+00016e60: 6973 2061 2077 6f72 6b69 6e67 2065 7861  is a working exa
+00016e70: 6d70 6c65 2066 6f72 2061 2050 4446 2066  mple for a PDF f
+00016e80: 696c 652e 0a20 2020 2049 7420 6361 6e20  ile..    It can 
+00016e90: 6265 2076 6965 7765 6420 6f72 2064 6f77  be viewed or dow
+00016ea0: 6e6c 6f61 6465 6420 6672 6f6d 3a0a 2020  nloaded from:.  
+00016eb0: 2020 6874 7470 733a 2f2f 6d61 7472 6978    https://matrix
+00016ec0: 2e65 7861 6d70 6c65 2e63 6f6d 2f5f 6d61  .example.com/_ma
+00016ed0: 7472 6978 2f6d 6564 6961 2f72 302f 646f  trix/media/r0/do
+00016ee0: 776e 6c6f 6164 2f0a 2020 2020 2020 2020  wnload/.        
+00016ef0: 6578 616d 706c 652e 636f 6d2f 536f 6d65  example.com/Some
+00016f00: 5374 7261 6e67 6555 7269 4b65 790a 2020  StrangeUriKey.  
+00016f10: 2020 7b0a 2020 2020 2020 2020 2274 7970    {.        "typ
+00016f20: 6522 3a20 226d 2e72 6f6f 6d2e 6d65 7373  e": "m.room.mess
+00016f30: 6167 6522 2c0a 2020 2020 2020 2020 2273  age",.        "s
+00016f40: 656e 6465 7222 3a20 2240 736f 6d65 7573  ender": "@someus
+00016f50: 6572 3a65 7861 6d70 6c65 2e63 6f6d 222c  er:example.com",
+00016f60: 0a20 2020 2020 2020 2022 636f 6e74 656e  .        "conten
+00016f70: 7422 3a20 7b0a 2020 2020 2020 2020 2020  t": {.          
+00016f80: 2020 2262 6f64 7922 3a20 2265 7861 6d70    "body": "examp
+00016f90: 6c65 2e70 6466 222c 0a20 2020 2020 2020  le.pdf",.       
+00016fa0: 2020 2020 2022 696e 666f 223a 207b 0a20       "info": {. 
+00016fb0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00016fc0: 7369 7a65 223a 2036 3330 3132 3334 2c0a  size": 6301234,.
+00016fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016fe0: 226d 696d 6574 7970 6522 3a20 2261 7070  "mimetype": "app
+00016ff0: 6c69 6361 7469 6f6e 2f70 6466 220a 2020  lication/pdf".  
+00017000: 2020 2020 2020 2020 2020 2020 2020 7d2c                },
+00017010: 0a20 2020 2020 2020 2020 2020 2022 6d73  .            "ms
+00017020: 6774 7970 6522 3a20 226d 2e66 696c 6522  gtype": "m.file"
+00017030: 2c0a 2020 2020 2020 2020 2020 2020 2275  ,.            "u
+00017040: 726c 223a 2022 6d78 633a 2f2f 6578 616d  rl": "mxc://exam
+00017050: 706c 652e 636f 6d2f 536f 6d65 5374 7261  ple.com/SomeStra
+00017060: 6e67 6555 7269 4b65 7922 0a20 2020 2020  ngeUriKey".     
+00017070: 2020 207d 2c0a 2020 2020 2020 2020 226f     },.        "o
+00017080: 7269 6769 6e5f 7365 7276 6572 5f74 7322  rigin_server_ts"
+00017090: 3a20 3135 3935 3130 3030 3030 3030 302c  : 1595100000000,
+000170a0: 0a20 2020 2020 2020 2022 756e 7369 676e  .        "unsign
+000170b0: 6564 223a 207b 0a20 2020 2020 2020 2020  ed": {.         
+000170c0: 2020 2022 6167 6522 3a20 3130 3030 2c0a     "age": 1000,.
+000170d0: 2020 2020 2020 2020 2020 2020 2274 7261              "tra
+000170e0: 6e73 6163 7469 6f6e 5f69 6422 3a20 2253  nsaction_id": "S
+000170f0: 6f6d 6554 7849 6430 3132 3334 3536 3722  omeTxId01234567"
+00017100: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
+00017110: 2020 2020 2265 7665 6e74 5f69 6422 3a20      "event_id": 
+00017120: 2224 536f 6d65 4576 656e 7449 6430 3132  "$SomeEventId012
+00017130: 3334 3536 3737 3839 4162 6364 6566 3031  34567789Abcdef01
+00017140: 3233 3435 3637 3822 2c0a 2020 2020 2020  2345678",.      
+00017150: 2020 2272 6f6f 6d5f 6964 223a 2022 2153    "room_id": "!S
+00017160: 6f6d 6552 6f6f 6d49 643a 6578 616d 706c  omeRoomId:exampl
+00017170: 652e 636f 6d22 0a20 2020 207d 0a0a 2020  e.com".    }..  
+00017180: 2020 2222 220a 2020 2020 6966 206e 6f74    """.    if not
+00017190: 2072 6f6f 6d73 3a0a 2020 2020 2020 2020   rooms:.        
+000171a0: 6773 2e6c 6f67 2e69 6e66 6f28 0a20 2020  gs.log.info(.   
+000171b0: 2020 2020 2020 2020 2022 4e6f 2072 6f6f           "No roo
+000171c0: 6d73 2061 7265 2067 6976 656e 2e20 5468  ms are given. Th
+000171d0: 6973 2073 686f 756c 6420 6e6f 7420 6861  is should not ha
+000171e0: 7070 656e 2e20 220a 2020 2020 2020 2020  ppen. ".        
+000171f0: 2020 2020 224d 6179 6265 2079 6f75 7220      "Maybe your 
+00017200: 444d 2072 6f6f 6d73 2073 7065 6369 6669  DM rooms specifi
+00017210: 6564 2076 6961 202d 2d75 7365 7220 7765  ed via --user we
+00017220: 7265 206e 6f74 2066 6f75 6e64 2e20 220a  re not found. ".
+00017230: 2020 2020 2020 2020 2020 2020 2254 6869              "Thi
+00017240: 7320 6669 6c65 2069 7320 6265 696e 6720  s file is being 
+00017250: 6472 6f70 7065 6420 616e 6420 4e4f 5420  dropped and NOT 
+00017260: 7365 6e74 2e22 0a20 2020 2020 2020 2029  sent.".        )
+00017270: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
+00017280: 0a20 2020 2023 2066 6f72 206d 6f72 6520  .    # for more 
+00017290: 636f 6d6d 656e 7473 206f 6e20 686f 7720  comments on how 
+000172a0: 746f 2074 7265 6174 2070 6970 6520 6f6e  to treat pipe on
+000172b0: 2073 7464 696e 2070 6c65 6173 6520 7265   stdin please re
+000172c0: 6164 2074 6865 0a20 2020 2023 2063 6f6d  ad the.    # com
+000172d0: 6d65 6e74 7320 696e 2073 656e 645f 696d  ments in send_im
+000172e0: 6167 6528 290a 0a20 2020 2069 6620 6669  age()..    if fi
+000172f0: 6c65 203d 3d20 222d 223a 2020 2320 2d20  le == "-":  # - 
+00017300: 6d65 616e 7320 7265 6164 2061 7320 7069  means read as pi
+00017310: 7065 2066 726f 6d20 7374 6469 6e0a 2020  pe from stdin.  
+00017320: 2020 2020 2020 6973 5069 7065 203d 2054        isPipe = T
+00017330: 7275 650a 2020 2020 2020 2020 6669 6e5f  rue.        fin_
+00017340: 6275 6620 3d20 7379 732e 7374 6469 6e2e  buf = sys.stdin.
+00017350: 6275 6666 6572 2e72 6561 6428 290a 2020  buffer.read().  
+00017360: 2020 2020 2020 6c65 6e5f 6669 6e5f 6275        len_fin_bu
+00017370: 6620 3d20 6c65 6e28 6669 6e5f 6275 6629  f = len(fin_buf)
+00017380: 0a20 2020 2020 2020 2066 696c 6520 3d20  .        file = 
+00017390: 226d 632d 2220 2b20 7374 7228 7575 6964  "mc-" + str(uuid
+000173a0: 2e75 7569 6434 2829 2920 2b20 222e 746d  .uuid4()) + ".tm
+000173b0: 7022 0a20 2020 2020 2020 2067 732e 6c6f  p".        gs.lo
+000173c0: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
+000173d0: 2020 2020 2066 227b 6c65 6e5f 6669 6e5f       f"{len_fin_
+000173e0: 6275 667d 2062 7974 6573 206f 6620 6669  buf} bytes of fi
+000173f0: 6c65 2064 6174 6120 7265 6164 2066 726f  le data read fro
+00017400: 6d20 7374 6469 6e2e 2022 0a20 2020 2020  m stdin. ".     
+00017410: 2020 2020 2020 2066 2754 656d 706f 7261         f'Tempora
+00017420: 7279 2066 696c 6520 227b 6669 6c65 7d22  ry file "{file}"
+00017430: 2077 6173 2063 7265 6174 6564 2066 6f72   was created for
+00017440: 2066 696c 652e 270a 2020 2020 2020 2020   file.'.        
+00017450: 290a 2020 2020 2020 2020 666f 7574 203d  ).        fout =
+00017460: 206f 7065 6e28 6669 6c65 2c20 2277 6222   open(file, "wb"
+00017470: 290a 2020 2020 2020 2020 666f 7574 2e77  ).        fout.w
+00017480: 7269 7465 2866 696e 5f62 7566 290a 2020  rite(fin_buf).  
+00017490: 2020 2020 2020 666f 7574 2e63 6c6f 7365        fout.close
+000174a0: 2829 0a20 2020 2065 6c73 653a 0a20 2020  ().    else:.   
+000174b0: 2020 2020 2069 7350 6970 6520 3d20 4661       isPipe = Fa
+000174c0: 6c73 650a 0a20 2020 2069 6620 6e6f 7420  lse..    if not 
+000174d0: 6f73 2e70 6174 682e 6973 6669 6c65 2866  os.path.isfile(f
+000174e0: 696c 6529 3a0a 2020 2020 2020 2020 6773  ile):.        gs
+000174f0: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
+00017500: 2020 2020 2020 2020 6622 4669 6c65 207b          f"File {
+00017510: 6669 6c65 7d20 6973 206e 6f74 2061 2066  file} is not a f
+00017520: 696c 652e 2044 6f65 736e 2774 2065 7869  ile. Doesn't exi
+00017530: 7374 206f 7220 220a 2020 2020 2020 2020  st or ".        
+00017540: 2020 2020 2269 7320 6120 6469 7265 6374      "is a direct
+00017550: 6f72 792e 2022 0a20 2020 2020 2020 2020  ory. ".         
+00017560: 2020 2022 5468 6973 2066 696c 6520 6973     "This file is
+00017570: 2062 6569 6e67 2064 726f 7070 6564 2061   being dropped a
+00017580: 6e64 204e 4f54 2073 656e 742e 220a 2020  nd NOT sent.".  
+00017590: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000175a0: 7265 7475 726e 0a0a 2020 2020 2320 2320  return..    # # 
+000175b0: 7265 7374 7269 6374 2074 6f20 2274 7874  restrict to "txt
+000175c0: 222c 2022 7064 6622 2c20 226d 7033 222c  ", "pdf", "mp3",
+000175d0: 2022 6f67 6722 2c20 2277 6176 222c 202e   "ogg", "wav", .
+000175e0: 2e2e 0a20 2020 2023 2069 6620 6e6f 7420  ...    # if not 
+000175f0: 7265 2e6d 6174 6368 2822 5e2e 7064 6624  re.match("^.pdf$
+00017600: 7c5e 2e74 7874 247c 5e2e 646f 6324 7c5e  |^.txt$|^.doc$|^
+00017610: 2e78 6c73 247c 5e2e 6d6f 6269 247c 5e2e  .xls$|^.mobi$|^.
+00017620: 6d70 3324 222c 0a20 2020 2023 2020 2020  mp3$",.    #    
+00017630: 2020 2020 2020 2020 2020 2020 6f73 2e70              os.p
+00017640: 6174 682e 7370 6c69 7465 7874 2866 696c  ath.splitext(fil
+00017650: 6529 5b31 5d2e 6c6f 7765 7228 2929 3a0a  e)[1].lower()):.
+00017660: 2020 2020 2320 2020 2067 732e 6c6f 672e      #    gs.log.
+00017670: 6465 6275 6728 6622 4669 6c65 207b 6669  debug(f"File {fi
+00017680: 6c65 7d20 6973 206e 6f74 2061 2070 6572  le} is not a per
+00017690: 6d69 7474 6564 2066 696c 6520 7479 7065  mitted file type
+000176a0: 2e20 5368 6f75 6c64 2062 6520 220a 2020  . Should be ".  
+000176b0: 2020 2320 2020 2020 2020 2020 2020 2020    #             
+000176c0: 2020 2020 222e 7064 662c 202e 7478 742c      ".pdf, .txt,
+000176d0: 202e 646f 632c 202e 786c 732c 202e 6d6f   .doc, .xls, .mo
+000176e0: 6269 206f 7220 2e6d 7033 202e 2e2e 2022  bi or .mp3 ... "
+000176f0: 0a20 2020 2023 2020 2020 2020 2020 2020  .    #          
+00017700: 2020 2020 2020 2066 225b 7b6f 732e 7061         f"[{os.pa
+00017710: 7468 2e73 706c 6974 6578 7428 6669 6c65  th.splitext(file
+00017720: 295b 315d 2e6c 6f77 6572 2829 7d5d 220a  )[1].lower()}]".
+00017730: 2020 2020 2320 2020 2020 2020 2020 2020      #           
+00017740: 2020 2020 2020 2254 6869 7320 6669 6c65        "This file
+00017750: 2069 7320 6265 696e 6720 6472 6f70 7065   is being droppe
+00017760: 6420 616e 6420 4e4f 5420 7365 6e74 2e22  d and NOT sent."
+00017770: 290a 2020 2020 2320 2020 2072 6574 7572  ).    #    retur
+00017780: 6e0a 0a20 2020 2023 2027 6170 706c 6963  n..    # 'applic
+00017790: 6174 696f 6e2f 7064 6627 2022 706c 6169  ation/pdf' "plai
+000177a0: 6e2f 7465 7874 2220 2261 7564 696f 2f6f  n/text" "audio/o
+000177b0: 6767 220a 2020 2020 6d69 6d65 5f74 7970  gg".    mime_typ
+000177c0: 6520 3d20 6d61 6769 632e 6672 6f6d 5f66  e = magic.from_f
+000177d0: 696c 6528 6669 6c65 2c20 6d69 6d65 3d54  ile(file, mime=T
+000177e0: 7275 6529 0a20 2020 2023 2069 6620 2828  rue).    # if ((
+000177f0: 6e6f 7420 6d69 6d65 5f74 7970 652e 7374  not mime_type.st
+00017800: 6172 7473 7769 7468 2822 6170 706c 6963  artswith("applic
+00017810: 6174 696f 6e2f 2229 2920 616e 640a 2020  ation/")) and.  
+00017820: 2020 2320 2020 2020 2020 2028 6e6f 7420    #        (not 
+00017830: 6d69 6d65 5f74 7970 652e 7374 6172 7473  mime_type.starts
+00017840: 7769 7468 2822 706c 6169 6e2f 2229 2920  with("plain/")) 
+00017850: 616e 640a 2020 2020 2320 2020 2020 2020  and.    #       
+00017860: 2028 6e6f 7420 6d69 6d65 5f74 7970 652e   (not mime_type.
+00017870: 7374 6172 7473 7769 7468 2822 6175 6469  startswith("audi
+00017880: 6f2f 2229 2929 3a0a 2020 2020 2320 2020  o/"))):.    #   
+00017890: 2067 732e 6c6f 672e 6465 6275 6728 6622   gs.log.debug(f"
+000178a0: 4669 6c65 207b 6669 6c65 7d20 646f 6573  File {file} does
+000178b0: 206e 6f74 2068 6176 6520 616e 2061 6363   not have an acc
+000178c0: 6570 7465 6420 6d69 6d65 2074 7970 652e  epted mime type.
+000178d0: 2022 0a20 2020 2023 2020 2020 2020 2020   ".    #        
+000178e0: 2020 2020 2020 2020 2022 5368 6f75 6c64           "Should
+000178f0: 2062 6520 736f 6d65 7468 696e 6720 6c69   be something li
+00017900: 6b65 2061 7070 6c69 6361 7469 6f6e 2f70  ke application/p
+00017910: 6466 2e20 220a 2020 2020 2320 2020 2020  df. ".    #     
+00017920: 2020 2020 2020 2020 2020 2020 6622 466f              f"Fo
+00017930: 756e 6420 6d69 6d65 2074 7970 6520 7b6d  und mime type {m
+00017940: 696d 655f 7479 7065 7d2e 2022 0a20 2020  ime_type}. ".   
+00017950: 2023 2020 2020 2020 2020 2020 2020 2020   #              
+00017960: 2020 2022 5468 6973 2066 696c 6520 6973     "This file is
+00017970: 2062 6569 6e67 2064 726f 7070 6564 2061   being dropped a
+00017980: 6e64 204e 4f54 2073 656e 742e 2229 0a20  nd NOT sent."). 
+00017990: 2020 2023 2020 2020 7265 7475 726e 0a0a     #    return..
+000179a0: 2020 2020 2320 6669 7273 7420 646f 2061      # first do a
+000179b0: 6e20 7570 6c6f 6164 206f 6620 6669 6c65  n upload of file
+000179c0: 2c20 7365 6520 7570 6c6f 6164 2829 2064  , see upload() d
+000179d0: 6f63 756d 656e 7461 7469 6f6e 0a20 2020  ocumentation.   
+000179e0: 2023 2068 7474 703a 2f2f 6d61 7472 6978   # http://matrix
+000179f0: 2d6e 696f 2e72 6561 6474 6865 646f 6373  -nio.readthedocs
+00017a00: 2e69 6f2f 656e 2f6c 6174 6573 742f 6e69  .io/en/latest/ni
+00017a10: 6f2e 6874 6d6c 236e 696f 2e41 7379 6e63  o.html#nio.Async
+00017a20: 436c 6965 6e74 2e75 706c 6f61 640a 2020  Client.upload.  
+00017a30: 2020 2320 7468 656e 2073 656e 6420 5552    # then send UR
+00017a40: 4920 6f66 2075 706c 6f61 6420 746f 2072  I of upload to r
+00017a50: 6f6f 6d0a 0a20 2020 2066 696c 655f 7374  oom..    file_st
+00017a60: 6174 203d 2061 7761 6974 2061 696f 6669  at = await aiofi
+00017a70: 6c65 732e 6f73 2e73 7461 7428 6669 6c65  les.os.stat(file
+00017a80: 290a 2020 2020 6173 796e 6320 7769 7468  ).    async with
+00017a90: 2061 696f 6669 6c65 732e 6f70 656e 2866   aiofiles.open(f
+00017aa0: 696c 652c 2022 722b 6222 2920 6173 2066  ile, "r+b") as f
+00017ab0: 3a0a 2020 2020 2020 2020 7265 7370 2c20  :.        resp, 
+00017ac0: 6465 6372 7970 7469 6f6e 5f6b 6579 7320  decryption_keys 
+00017ad0: 3d20 6177 6169 7420 636c 6965 6e74 2e75  = await client.u
+00017ae0: 706c 6f61 6428 0a20 2020 2020 2020 2020  pload(.         
+00017af0: 2020 2066 2c0a 2020 2020 2020 2020 2020     f,.          
+00017b00: 2020 636f 6e74 656e 745f 7479 7065 3d6d    content_type=m
+00017b10: 696d 655f 7479 7065 2c20 2023 2061 7070  ime_type,  # app
+00017b20: 6c69 6361 7469 6f6e 2f70 6466 0a20 2020  lication/pdf.   
+00017b30: 2020 2020 2020 2020 2066 696c 656e 616d           filenam
+00017b40: 653d 6f73 2e70 6174 682e 6261 7365 6e61  e=os.path.basena
+00017b50: 6d65 2866 696c 6529 2c0a 2020 2020 2020  me(file),.      
+00017b60: 2020 2020 2020 6669 6c65 7369 7a65 3d66        filesize=f
+00017b70: 696c 655f 7374 6174 2e73 745f 7369 7a65  ile_stat.st_size
+00017b80: 2c0a 2020 2020 2020 2020 2020 2020 656e  ,.            en
+00017b90: 6372 7970 743d 5472 7565 2c0a 2020 2020  crypt=True,.    
+00017ba0: 2020 2020 290a 2020 2020 6966 2069 7369      ).    if isi
+00017bb0: 6e73 7461 6e63 6528 7265 7370 2c20 5570  nstance(resp, Up
+00017bc0: 6c6f 6164 5265 7370 6f6e 7365 293a 0a20  loadResponse):. 
+00017bd0: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+00017be0: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
+00017bf0: 2022 4669 6c65 2077 6173 2075 706c 6f61   "File was uploa
+00017c00: 6465 6420 7375 6363 6573 7366 756c 6c79  ded successfully
+00017c10: 2074 6f20 7365 7276 6572 2e20 5265 7370   to server. Resp
+00017c20: 6f6e 7365 2069 733a 2022 0a20 2020 2020  onse is: ".     
+00017c30: 2020 2020 2020 2066 227b 7072 6976 6163         f"{privac
+00017c40: 795f 6669 6c74 6572 2873 7472 2872 6573  y_filter(str(res
+00017c50: 7029 297d 220a 2020 2020 2020 2020 290a  p))}".        ).
+00017c60: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00017c70: 2020 6773 2e6c 6f67 2e69 6e66 6f28 0a20    gs.log.info(. 
+00017c80: 2020 2020 2020 2020 2020 2066 2254 6865             f"The
+00017c90: 2070 726f 6772 616d 207b 5052 4f47 5f57   program {PROG_W
+00017ca0: 4954 485f 4558 547d 2066 6169 6c65 6420  ITH_EXT} failed 
+00017cb0: 746f 2075 706c 6f61 642e 2022 0a20 2020  to upload. ".   
+00017cc0: 2020 2020 2020 2020 2022 506c 6561 7365           "Please
+00017cd0: 2072 6574 7279 2e20 5468 6973 2063 6f75   retry. This cou
+00017ce0: 6c64 2062 6520 7465 6d70 6f72 6172 7920  ld be temporary 
+00017cf0: 6973 7375 6520 6f6e 2022 0a20 2020 2020  issue on ".     
+00017d00: 2020 2020 2020 2022 796f 7572 2073 6572         "your ser
+00017d10: 7665 722e 2022 0a20 2020 2020 2020 2020  ver. ".         
+00017d20: 2020 2022 536f 7272 792e 220a 2020 2020     "Sorry.".    
+00017d30: 2020 2020 290a 2020 2020 2020 2020 6773      ).        gs
+00017d40: 2e6c 6f67 2e69 6e66 6f28 0a20 2020 2020  .log.info(.     
+00017d50: 2020 2020 2020 2066 2766 696c 653d 227b         f'file="{
+00017d60: 6669 6c65 7d22 3b20 6d69 6d65 5f74 7970  file}"; mime_typ
+00017d70: 653d 227b 6d69 6d65 5f74 7970 657d 223b  e="{mime_type}";
+00017d80: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
+00017d90: 2766 696c 6573 7369 7a65 3d22 7b66 696c  'filessize="{fil
+00017da0: 655f 7374 6174 2e73 745f 7369 7a65 7d22  e_stat.st_size}"
+00017db0: 270a 2020 2020 2020 2020 2020 2020 6622  '.            f"
+00017dc0: 4661 696c 6564 2074 6f20 7570 6c6f 6164  Failed to upload
+00017dd0: 3a20 7b70 7269 7661 6379 5f66 696c 7465  : {privacy_filte
+00017de0: 7228 7374 7228 7265 7370 2929 7d22 0a20  r(str(resp))}". 
+00017df0: 2020 2020 2020 2029 0a0a 2020 2020 2320         )..    # 
+00017e00: 6465 7465 726d 696e 6520 6d73 675f 7479  determine msg_ty
+00017e10: 7065 3a0a 2020 2020 6966 206d 696d 655f  pe:.    if mime_
+00017e20: 7479 7065 2e73 7461 7274 7377 6974 6828  type.startswith(
+00017e30: 2261 7564 696f 2f22 293a 0a20 2020 2020  "audio/"):.     
+00017e40: 2020 206d 7367 5f74 7970 6520 3d20 226d     msg_type = "m
+00017e50: 2e61 7564 696f 220a 2020 2020 656c 6966  .audio".    elif
+00017e60: 206d 696d 655f 7479 7065 2e73 7461 7274   mime_type.start
+00017e70: 7377 6974 6828 2276 6964 656f 2f22 293a  swith("video/"):
+00017e80: 0a20 2020 2020 2020 206d 7367 5f74 7970  .        msg_typ
+00017e90: 6520 3d20 226d 2e76 6964 656f 220a 2020  e = "m.video".  
+00017ea0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00017eb0: 6d73 675f 7479 7065 203d 2022 6d2e 6669  msg_type = "m.fi
+00017ec0: 6c65 220a 0a20 2020 2063 6f6e 7465 6e74  le"..    content
+00017ed0: 203d 207b 0a20 2020 2020 2020 2022 626f   = {.        "bo
+00017ee0: 6479 223a 206f 732e 7061 7468 2e62 6173  dy": os.path.bas
+00017ef0: 656e 616d 6528 6669 6c65 292c 2020 2320  ename(file),  # 
+00017f00: 6465 7363 7269 7074 6976 6520 7469 746c  descriptive titl
+00017f10: 650a 2020 2020 2020 2020 2269 6e66 6f22  e.        "info"
+00017f20: 3a20 7b22 7369 7a65 223a 2066 696c 655f  : {"size": file_
+00017f30: 7374 6174 2e73 745f 7369 7a65 2c20 226d  stat.st_size, "m
+00017f40: 696d 6574 7970 6522 3a20 6d69 6d65 5f74  imetype": mime_t
+00017f50: 7970 657d 2c0a 2020 2020 2020 2020 226d  ype},.        "m
+00017f60: 7367 7479 7065 223a 206d 7367 5f74 7970  sgtype": msg_typ
+00017f70: 652c 0a20 2020 2020 2020 2022 6669 6c65  e,.        "file
+00017f80: 223a 207b 0a20 2020 2020 2020 2020 2020  ": {.           
+00017f90: 2022 7572 6c22 3a20 7265 7370 2e63 6f6e   "url": resp.con
+00017fa0: 7465 6e74 5f75 7269 2c0a 2020 2020 2020  tent_uri,.      
+00017fb0: 2020 2020 2020 226b 6579 223a 2064 6563        "key": dec
+00017fc0: 7279 7074 696f 6e5f 6b65 7973 5b22 6b65  ryption_keys["ke
+00017fd0: 7922 5d2c 0a20 2020 2020 2020 2020 2020  y"],.           
+00017fe0: 2022 6976 223a 2064 6563 7279 7074 696f   "iv": decryptio
+00017ff0: 6e5f 6b65 7973 5b22 6976 225d 2c0a 2020  n_keys["iv"],.  
+00018000: 2020 2020 2020 2020 2020 2268 6173 6865            "hashe
+00018010: 7322 3a20 6465 6372 7970 7469 6f6e 5f6b  s": decryption_k
+00018020: 6579 735b 2268 6173 6865 7322 5d2c 0a20  eys["hashes"],. 
+00018030: 2020 2020 2020 2020 2020 2022 7622 3a20             "v": 
+00018040: 6465 6372 7970 7469 6f6e 5f6b 6579 735b  decryption_keys[
+00018050: 2276 225d 2c0a 2020 2020 2020 2020 7d2c  "v"],.        },
+00018060: 0a20 2020 207d 0a0a 2020 2020 6966 2069  .    }..    if i
+00018070: 7350 6970 653a 0a20 2020 2020 2020 2023  sPipe:.        #
+00018080: 2072 6d20 7465 6d70 2066 696c 650a 2020   rm temp file.  
+00018090: 2020 2020 2020 6f73 2e72 656d 6f76 6528        os.remove(
+000180a0: 6669 6c65 290a 0a20 2020 2074 7279 3a0a  file)..    try:.
+000180b0: 2020 2020 2020 2020 666f 7220 726f 6f6d          for room
+000180c0: 5f69 6420 696e 2072 6f6f 6d73 3a0a 2020  _id in rooms:.  
+000180d0: 2020 2020 2020 2020 2020 726f 6f6d 5f69            room_i
+000180e0: 6420 3d20 6177 6169 7420 6d61 705f 726f  d = await map_ro
+000180f0: 6f6d 696e 666f 5f74 6f5f 726f 6f6d 6964  ominfo_to_roomid
+00018100: 2863 6c69 656e 742c 2072 6f6f 6d5f 6964  (client, room_id
+00018110: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00018120: 7370 203d 2061 7761 6974 2063 6c69 656e  sp = await clien
+00018130: 742e 726f 6f6d 5f73 656e 6428 0a20 2020  t.room_send(.   
+00018140: 2020 2020 2020 2020 2020 2020 2072 6f6f               roo
+00018150: 6d5f 6964 2c20 6d65 7373 6167 655f 7479  m_id, message_ty
+00018160: 7065 3d22 6d2e 726f 6f6d 2e6d 6573 7361  pe="m.room.messa
+00018170: 6765 222c 2063 6f6e 7465 6e74 3d63 6f6e  ge", content=con
+00018180: 7465 6e74 0a20 2020 2020 2020 2020 2020  tent.           
+00018190: 2029 0a20 2020 2020 2020 2020 2020 2069   ).            i
+000181a0: 6620 6973 696e 7374 616e 6365 2872 6573  f isinstance(res
+000181b0: 702c 2052 6f6f 6d53 656e 6445 7272 6f72  p, RoomSendError
+000181c0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000181d0: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
+000181e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000181f0: 2020 2020 2022 4531 3436 3a20 220a 2020       "E146: ".  
+00018200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018210: 2020 2272 6f6f 6d5f 7365 6e64 2066 6169    "room_send fai
+00018220: 6c65 6420 7769 7468 2065 7272 6f72 2022  led with error "
+00018230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018240: 2020 2020 2066 2227 7b70 7269 7661 6379       f"'{privacy
+00018250: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
+00018260: 2929 7d27 2e22 0a20 2020 2020 2020 2020  ))}'.".         
+00018270: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00018280: 2020 2020 2020 2020 2023 2067 732e 6572           # gs.er
+00018290: 725f 636f 756e 7420 2b3d 2031 2023 206e  r_count += 1 # n
+000182a0: 6f74 206e 6565 6465 642c 2077 696c 6c20  ot needed, will 
+000182b0: 7261 6973 6520 6578 6365 7074 696f 6e0a  raise exception.
+000182c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000182d0: 2320 696e 2066 6f6c 6c6f 7769 6e67 206c  # in following l
+000182e0: 696e 6520 6f66 2063 6f64 650a 2020 2020  ine of code.    
+000182f0: 2020 2020 2020 2020 6773 2e6c 6f67 2e69          gs.log.i
+00018300: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
+00018310: 2020 2020 2066 2754 6869 7320 6669 6c65       f'This file
+00018320: 2077 6173 2073 656e 743a 2022 7b66 696c   was sent: "{fil
+00018330: 657d 2220 746f 2072 6f6f 6d20 227b 7265  e}" to room "{re
+00018340: 7370 2e72 6f6f 6d5f 6964 7d22 2027 0a20  sp.room_id}" '. 
+00018350: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00018360: 2761 7320 6576 656e 7420 227b 7265 7370  'as event "{resp
+00018370: 2e65 7665 6e74 5f69 647d 222e 270a 2020  .event_id}".'.  
+00018380: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00018390: 2020 2020 2020 2020 6966 2067 732e 7061          if gs.pa
+000183a0: 2e70 7269 6e74 5f65 7665 6e74 5f69 643a  .print_event_id:
+000183b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000183c0: 2023 206f 7574 7075 7420 666f 726d 6174   # output format
+000183d0: 2063 6f6e 7472 6f6c 6c65 6420 7669 6120   controlled via 
+000183e0: 2d2d 6f75 7470 7574 2066 6c61 670a 2020  --output flag.  
+000183f0: 2020 2020 2020 2020 2020 2020 2020 7465                te
+00018400: 7874 203d 2066 227b 7265 7370 2e65 7665  xt = f"{resp.eve
+00018410: 6e74 5f69 647d 7b53 4550 7d7b 7265 7370  nt_id}{SEP}{resp
+00018420: 2e72 6f6f 6d5f 6964 7d7b 5345 507d 7b66  .room_id}{SEP}{f
+00018430: 696c 657d 220a 2020 2020 2020 2020 2020  ile}".          
+00018440: 2020 2020 2020 2320 4f62 6a65 6374 206f        # Object o
+00018450: 6620 7479 7065 2052 6f6f 6d43 7265 6174  f type RoomCreat
+00018460: 6552 6573 706f 6e73 6520 6973 206e 6f74  eResponse is not
+00018470: 204a 534f 4e0a 2020 2020 2020 2020 2020   JSON.          
+00018480: 2020 2020 2020 2320 7365 7269 616c 697a        # serializ
+00018490: 6162 6c65 2c20 6865 6e63 6520 7765 2075  able, hence we u
+000184a0: 7365 2074 6865 2064 6963 7469 6f6e 6172  se the dictionar
+000184b0: 792e 0a20 2020 2020 2020 2020 2020 2020  y..             
+000184c0: 2020 206a 736f 6e5f 6d61 7820 3d20 7265     json_max = re
+000184d0: 7370 2e5f 5f64 6963 745f 5f0a 2020 2020  sp.__dict__.    
+000184e0: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+000184f0: 5f6d 6178 2e75 7064 6174 6528 7b22 6669  _max.update({"fi
+00018500: 6c65 223a 2066 696c 657d 2920 2023 2061  le": file})  # a
+00018510: 6464 2064 6963 7420 6974 656d 730a 2020  dd dict items.  
+00018520: 2020 2020 2020 2020 2020 2020 2020 6a73                js
+00018530: 6f6e 5f20 3d20 6a73 6f6e 5f6d 6178 2e63  on_ = json_max.c
+00018540: 6f70 7928 290a 2020 2020 2020 2020 2020  opy().          
+00018550: 2020 2020 2020 6a73 6f6e 5f2e 706f 7028        json_.pop(
+00018560: 2274 7261 6e73 706f 7274 5f72 6573 706f  "transport_respo
+00018570: 6e73 6522 290a 2020 2020 2020 2020 2020  nse").          
+00018580: 2020 2020 2020 6a73 6f6e 5f73 7065 6320        json_spec 
+00018590: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
+000185a0: 2020 2020 2020 2070 7269 6e74 5f6f 7574         print_out
+000185b0: 7075 7428 0a20 2020 2020 2020 2020 2020  put(.           
+000185c0: 2020 2020 2020 2020 2067 732e 7061 2e6f           gs.pa.o
+000185d0: 7574 7075 742c 0a20 2020 2020 2020 2020  utput,.         
+000185e0: 2020 2020 2020 2020 2020 2074 6578 743d             text=
+000185f0: 7465 7874 2c0a 2020 2020 2020 2020 2020  text,.          
+00018600: 2020 2020 2020 2020 2020 6a73 6f6e 5f3d            json_=
+00018610: 6a73 6f6e 5f2c 0a20 2020 2020 2020 2020  json_,.         
+00018620: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+00018630: 6d61 783d 6a73 6f6e 5f6d 6178 2c0a 2020  max=json_max,.  
+00018640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018650: 2020 6a73 6f6e 5f73 7065 633d 6a73 6f6e    json_spec=json
+00018660: 5f73 7065 632c 0a20 2020 2020 2020 2020  _spec,.         
+00018670: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00018680: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
+00018690: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+000186a0: 2020 2066 2754 6869 7320 6669 6c65 2077     f'This file w
+000186b0: 6173 2073 656e 743a 2022 7b66 696c 657d  as sent: "{file}
+000186c0: 2220 746f 2072 6f6f 6d20 227b 726f 6f6d  " to room "{room
+000186d0: 5f69 647d 222e 2027 0a20 2020 2020 2020  _id}". '.       
+000186e0: 2020 2020 2020 2020 2066 2252 6573 706f           f"Respo
+000186f0: 6e73 653a 2065 7665 6e74 5f69 643d 7b72  nse: event_id={r
+00018700: 6573 702e 6576 656e 745f 6964 7d2c 2072  esp.event_id}, r
+00018710: 6f6f 6d5f 6964 3d7b 7265 7370 2e72 6f6f  oom_id={resp.roo
+00018720: 6d5f 6964 7d2c 2022 0a20 2020 2020 2020  m_id}, ".       
+00018730: 2020 2020 2020 2020 2066 2266 756c 6c20           f"full 
+00018740: 7265 7370 6f6e 7365 3a20 7b70 7269 7661  response: {priva
+00018750: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
+00018760: 7370 2929 7d2e 2022 0a20 2020 2020 2020  sp))}. ".       
+00018770: 2020 2020 2029 0a20 2020 2065 7863 6570       ).    excep
+00018780: 7420 4578 6365 7074 696f 6e3a 0a20 2020  t Exception:.   
+00018790: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
+000187a0: 7228 2245 3134 373a 2022 2066 2246 696c  r("E147: " f"Fil
+000187b0: 6520 7365 6e64 206f 6620 6669 6c65 207b  e send of file {
+000187c0: 6669 6c65 7d20 6661 696c 6564 2e20 536f  file} failed. So
+000187d0: 7272 792e 2229 0a20 2020 2020 2020 2067  rry.").        g
+000187e0: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
+000187f0: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
+00018800: 6465 6275 6728 2248 6572 6520 6973 2074  debug("Here is t
+00018810: 6865 2074 7261 6365 6261 636b 2e5c 6e22  he traceback.\n"
+00018820: 202b 2074 7261 6365 6261 636b 2e66 6f72   + traceback.for
+00018830: 6d61 745f 6578 6328 2929 0a0a 0a23 2061  mat_exc())...# a
+00018840: 6363 6f72 6469 6e67 2074 6f20 6c69 6e74  ccording to lint
+00018850: 6572 3a20 6675 6e63 7469 6f6e 2069 7320  er: function is 
+00018860: 746f 6f20 636f 6d70 6c65 782c 2043 3930  too complex, C90
+00018870: 310a 6173 796e 6320 6465 6620 7365 6e64  1.async def send
+00018880: 5f69 6d61 6765 2863 6c69 656e 742c 2072  _image(client, r
+00018890: 6f6f 6d73 2c20 696d 6167 6529 3a20 2023  ooms, image):  #
+000188a0: 206e 6f71 613a 2043 3930 310a 2020 2020   noqa: C901.    
+000188b0: 2222 2250 726f 6365 7373 2069 6d61 6765  """Process image
+000188c0: 2e0a 0a20 2020 2041 7267 756d 656e 7473  ...    Arguments
+000188d0: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d0a  :.    ---------.
+000188e0: 2020 2020 636c 6965 6e74 203a 2043 6c69      client : Cli
+000188f0: 656e 740a 2020 2020 726f 6f6d 7320 3a20  ent.    rooms : 
+00018900: 6c69 7374 0a20 2020 2020 2020 206c 6973  list.        lis
+00018910: 7420 6f66 2072 6f6f 6d5f 6964 2d73 0a20  t of room_id-s. 
+00018920: 2020 2069 6d61 6765 203a 2073 7472 0a20     image : str. 
+00018930: 2020 2020 2020 2066 696c 6520 6e61 6d65         file name
+00018940: 206f 6620 696d 6167 6520 6672 6f6d 202d   of image from -
+00018950: 2d69 6d61 6765 2061 7267 756d 656e 740a  -image argument.
+00018960: 0a20 2020 2054 6869 7320 6973 2061 2077  .    This is a w
+00018970: 6f72 6b69 6e67 2065 7861 6d70 6c65 2066  orking example f
+00018980: 6f72 2061 204a 5047 2069 6d61 6765 2e0a  or a JPG image..
+00018990: 2020 2020 4974 2063 616e 2062 6520 7669      It can be vi
+000189a0: 6577 6564 206f 7220 646f 776e 6c6f 6164  ewed or download
+000189b0: 6564 2066 726f 6d3a 0a20 2020 2068 7474  ed from:.    htt
+000189c0: 7073 3a2f 2f6d 6174 7269 782e 6578 616d  ps://matrix.exam
+000189d0: 706c 652e 636f 6d2f 5f6d 6174 7269 782f  ple.com/_matrix/
+000189e0: 6d65 6469 612f 7230 2f64 6f77 6e6c 6f61  media/r0/downloa
+000189f0: 642f 0a20 2020 2020 2020 2065 7861 6d70  d/.        examp
+00018a00: 6c65 2e63 6f6d 2f53 6f6d 6553 7472 616e  le.com/SomeStran
+00018a10: 6765 5572 694b 6579 0a20 2020 207b 0a20  geUriKey.    {. 
+00018a20: 2020 2020 2020 2022 7479 7065 223a 2022         "type": "
+00018a30: 6d2e 726f 6f6d 2e6d 6573 7361 6765 222c  m.room.message",
+00018a40: 0a20 2020 2020 2020 2022 7365 6e64 6572  .        "sender
+00018a50: 223a 2022 4073 6f6d 6575 7365 723a 6578  ": "@someuser:ex
+00018a60: 616d 706c 652e 636f 6d22 2c0a 2020 2020  ample.com",.    
+00018a70: 2020 2020 2263 6f6e 7465 6e74 223a 207b      "content": {
+00018a80: 0a20 2020 2020 2020 2020 2020 2022 626f  .            "bo
+00018a90: 6479 223a 2022 736f 6d65 696d 6167 652e  dy": "someimage.
+00018aa0: 6a70 6722 2c0a 2020 2020 2020 2020 2020  jpg",.          
+00018ab0: 2020 2269 6e66 6f22 3a20 7b0a 2020 2020    "info": {.    
+00018ac0: 2020 2020 2020 2020 2020 2020 2273 697a              "siz
+00018ad0: 6522 3a20 3534 3230 2c0a 2020 2020 2020  e": 5420,.      
+00018ae0: 2020 2020 2020 2020 2020 226d 696d 6574            "mimet
+00018af0: 7970 6522 3a20 2269 6d61 6765 2f6a 7065  ype": "image/jpe
+00018b00: 6722 2c0a 2020 2020 2020 2020 2020 2020  g",.            
+00018b10: 2020 2020 2274 6875 6d62 6e61 696c 5f69      "thumbnail_i
+00018b20: 6e66 6f22 3a20 7b0a 2020 2020 2020 2020  nfo": {.        
+00018b30: 2020 2020 2020 2020 2020 2020 2277 223a              "w":
+00018b40: 2031 3030 2c0a 2020 2020 2020 2020 2020   100,.          
+00018b50: 2020 2020 2020 2020 2020 2268 223a 2031            "h": 1
+00018b60: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
+00018b70: 2020 2020 2020 2020 226d 696d 6574 7970          "mimetyp
+00018b80: 6522 3a20 2269 6d61 6765 2f6a 7065 6722  e": "image/jpeg"
+00018b90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00018ba0: 2020 2020 2020 2273 697a 6522 3a20 3231        "size": 21
+00018bb0: 3036 0a20 2020 2020 2020 2020 2020 2020  06.             
+00018bc0: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
+00018bd0: 2020 2020 2020 2277 223a 2031 3030 2c0a        "w": 100,.
+00018be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018bf0: 2268 223a 2031 3030 2c0a 2020 2020 2020  "h": 100,.      
+00018c00: 2020 2020 2020 2020 2020 2274 6875 6d62            "thumb
+00018c10: 6e61 696c 5f75 726c 223a 2022 6d78 633a  nail_url": "mxc:
+00018c20: 2f2f 6578 616d 706c 652e 636f 6d2f 536f  //example.com/So
+00018c30: 6d65 5374 7261 6e67 6554 6875 6d62 6e61  meStrangeThumbna
+00018c40: 696c 5572 694b 6579 220a 2020 2020 2020  ilUriKey".      
+00018c50: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+00018c60: 2020 2020 2022 6d73 6774 7970 6522 3a20       "msgtype": 
+00018c70: 226d 2e69 6d61 6765 222c 0a20 2020 2020  "m.image",.     
+00018c80: 2020 2020 2020 2022 7572 6c22 3a20 226d         "url": "m
+00018c90: 7863 3a2f 2f65 7861 6d70 6c65 2e63 6f6d  xc://example.com
+00018ca0: 2f53 6f6d 6553 7472 616e 6765 5572 694b  /SomeStrangeUriK
+00018cb0: 6579 220a 2020 2020 2020 2020 7d2c 0a20  ey".        },. 
+00018cc0: 2020 2020 2020 2022 6f72 6967 696e 5f73         "origin_s
+00018cd0: 6572 7665 725f 7473 223a 2031 3233 3435  erver_ts": 12345
+00018ce0: 3637 3839 3031 3233 3435 3736 2c0a 2020  678901234576,.  
+00018cf0: 2020 2020 2020 2275 6e73 6967 6e65 6422        "unsigned"
+00018d00: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+00018d10: 2261 6765 223a 2032 3638 0a20 2020 2020  "age": 268.     
+00018d20: 2020 207d 2c0a 2020 2020 2020 2020 2265     },.        "e
+00018d30: 7665 6e74 5f69 6422 3a20 2224 736b 6468  vent_id": "$skdh
+00018d40: 474a 4b68 6779 7235 3438 3635 3459 5472  GJKhgyr548654YTr
+00018d50: 3736 3559 6979 3538 5459 5222 2c0a 2020  765Yiy58TYR",.  
+00018d60: 2020 2020 2020 2272 6f6f 6d5f 6964 223a        "room_id":
+00018d70: 2022 214a 4b48 6779 4847 6679 7448 4746   "!JKHgyHGfytHGF
+00018d80: 6a68 6766 593a 6578 616d 706c 652e 636f  jhgfY:example.co
+00018d90: 6d22 0a20 2020 207d 0a0a 2020 2020 2222  m".    }..    ""
+00018da0: 220a 2020 2020 6966 206e 6f74 2072 6f6f  ".    if not roo
+00018db0: 6d73 3a0a 2020 2020 2020 2020 6773 2e6c  ms:.        gs.l
+00018dc0: 6f67 2e77 6172 6e69 6e67 280a 2020 2020  og.warning(.    
+00018dd0: 2020 2020 2020 2020 2257 3130 313a 2022          "W101: "
+00018de0: 0a20 2020 2020 2020 2020 2020 2022 4e6f  .            "No
+00018df0: 2072 6f6f 6d73 2061 7265 2067 6976 656e   rooms are given
+00018e00: 2e20 5468 6973 2073 686f 756c 6420 6e6f  . This should no
+00018e10: 7420 6861 7070 656e 2e20 220a 2020 2020  t happen. ".    
+00018e20: 2020 2020 2020 2020 224d 6179 6265 2079          "Maybe y
+00018e30: 6f75 7220 444d 2072 6f6f 6d73 2073 7065  our DM rooms spe
+00018e40: 6369 6669 6564 2076 6961 202d 2d75 7365  cified via --use
+00018e50: 7220 7765 7265 206e 6f74 2066 6f75 6e64  r were not found
+00018e60: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
+00018e70: 2254 6869 7320 696d 6167 6520 6973 2062  "This image is b
+00018e80: 6569 6e67 2064 726f 7070 6564 2061 6e64  eing dropped and
+00018e90: 204e 4f54 2073 656e 742e 220a 2020 2020   NOT sent.".    
+00018ea0: 2020 2020 290a 2020 2020 2020 2020 6773      ).        gs
+00018eb0: 2e77 6172 6e5f 636f 756e 7420 2b3d 2031  .warn_count += 1
+00018ec0: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
+00018ed0: 0a20 2020 2023 2068 6f77 2074 6f20 7472  .    # how to tr
+00018ee0: 6561 7420 7069 7065 206f 6e20 7374 6469  eat pipe on stdi
+00018ef0: 6e3f 0a20 2020 2023 2061 696f 6669 6c65  n?.    # aiofile
+00018f00: 732e 6f70 656e 2873 7973 2e73 7464 696e  s.open(sys.stdin
+00018f10: 2c20 2272 2b62 2229 2064 6f65 7320 6e6f  , "r+b") does no
+00018f20: 7420 776f 726b 2c20 7772 6f6e 6720 7479  t work, wrong ty
+00018f30: 7065 2e0a 2020 2020 2320 6169 6f66 696c  pe..    # aiofil
+00018f40: 6573 2e6f 7065 6e28 7379 732e 7374 6469  es.open(sys.stdi
+00018f50: 6e2e 6275 6666 6572 2c20 2272 2b62 2229  n.buffer, "r+b")
+00018f60: 2064 6f65 7320 6e6f 7420 776f 726b 2c20   does not work, 
+00018f70: 7772 6f6e 6720 7479 7065 2e0a 2020 2020  wrong type..    
+00018f80: 2320 6169 6f66 696c 6573 2e6f 7065 6e28  # aiofiles.open(
+00018f90: 272f 6465 762f 7374 6469 6e27 2c20 6d6f  '/dev/stdin', mo
+00018fa0: 6465 3d27 7262 2729 2066 6169 6c73 2077  de='rb') fails w
+00018fb0: 6974 6820 6572 726f 723a 0a20 2020 2023  ith error:.    #
+00018fc0: 2020 2020 696f 2e55 6e73 7570 706f 7274      io.Unsupport
+00018fd0: 6564 4f70 6572 6174 696f 6e3a 2046 696c  edOperation: Fil
+00018fe0: 6520 6f72 2073 7472 6561 6d20 6973 206e  e or stream is n
+00018ff0: 6f74 2073 6565 6b61 626c 650a 2020 2020  ot seekable.    
+00019000: 2320 7374 6469 6e2c 205f 203d 2061 7761  # stdin, _ = awa
+00019010: 6974 2061 696f 636f 6e73 6f6c 652e 6765  it aioconsole.ge
+00019020: 745f 7374 616e 6461 7264 5f73 7472 6561  t_standard_strea
+00019030: 6d73 2829 2061 6c73 6f20 6661 696c 6573  ms() also failes
+00019040: 0a20 2020 2023 2048 656e 6365 2049 2073  .    # Hence I s
+00019050: 6565 206e 6f20 7761 7920 746f 2064 6972  ee no way to dir
+00019060: 6563 746c 7920 6861 6e64 2073 7464 696e  ectly hand stdin
+00019070: 2074 6f20 6169 6f66 696c 6573 2e0a 2020   to aiofiles..  
+00019080: 2020 2320 5072 6f62 6c65 6d3a 2049 2063    # Problem: I c
+00019090: 616e 6e6f 7420 636f 6d62 696e 6520 7468  annot combine th
+000190a0: 6520 3320 7468 696e 6773 3a0a 2020 2020  e 3 things:.    
+000190b0: 2320 2020 2073 7464 696e 202b 2061 696f  #    stdin + aio
+000190c0: 6669 6c65 7320 2b20 6e69 6f2e 4173 796e  files + nio.Asyn
+000190d0: 6343 6c69 656e 742e 7570 6c6f 6164 2829  cClient.upload()
+000190e0: 0a20 2020 2023 2053 696e 6365 2049 2063  .    # Since I c
+000190f0: 6f75 6c64 206e 6f74 206f 7665 7263 6f6d  ould not overcom
+00019100: 6520 7468 6973 2070 726f 626c 656d 2049  e this problem I
+00019110: 2067 656e 6572 6174 6520 6120 7465 6d70   generate a temp
+00019120: 6f72 6172 7920 6669 6c65 0a0a 2020 2020  orary file..    
+00019130: 6966 2069 6d61 6765 203d 3d20 222d 223a  if image == "-":
+00019140: 2020 2320 2d20 6d65 616e 7320 7265 6164    # - means read
+00019150: 2061 7320 7069 7065 2066 726f 6d20 7374   as pipe from st
+00019160: 6469 6e0a 2020 2020 2020 2020 6973 5069  din.        isPi
+00019170: 7065 203d 2054 7275 650a 2020 2020 2020  pe = True.      
+00019180: 2020 6669 6e5f 6275 6620 3d20 7379 732e    fin_buf = sys.
+00019190: 7374 6469 6e2e 6275 6666 6572 2e72 6561  stdin.buffer.rea
+000191a0: 6428 290a 2020 2020 2020 2020 6c65 6e5f  d().        len_
+000191b0: 6669 6e5f 6275 6620 3d20 6c65 6e28 6669  fin_buf = len(fi
+000191c0: 6e5f 6275 6629 0a20 2020 2020 2020 2069  n_buf).        i
+000191d0: 6d61 6765 203d 2022 6d63 2d22 202b 2073  mage = "mc-" + s
+000191e0: 7472 2875 7569 642e 7575 6964 3428 2929  tr(uuid.uuid4())
+000191f0: 202b 2022 2e74 6d70 220a 2020 2020 2020   + ".tmp".      
+00019200: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
+00019210: 2020 2020 2020 2020 2020 2020 6622 7b6c              f"{l
+00019220: 656e 5f66 696e 5f62 7566 7d20 6279 7465  en_fin_buf} byte
+00019230: 7320 6f66 2069 6d61 6765 2064 6174 6120  s of image data 
+00019240: 7265 6164 2066 726f 6d20 7374 6469 6e2e  read from stdin.
+00019250: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
+00019260: 2754 656d 706f 7261 7279 2066 696c 6520  'Temporary file 
+00019270: 227b 696d 6167 657d 2220 7761 7320 6372  "{image}" was cr
+00019280: 6561 7465 6420 666f 7220 696d 6167 652e  eated for image.
+00019290: 270a 2020 2020 2020 2020 290a 2020 2020  '.        ).    
+000192a0: 2020 2020 666f 7574 203d 206f 7065 6e28      fout = open(
+000192b0: 696d 6167 652c 2022 7762 2229 0a20 2020  image, "wb").   
+000192c0: 2020 2020 2066 6f75 742e 7772 6974 6528       fout.write(
+000192d0: 6669 6e5f 6275 6629 0a20 2020 2020 2020  fin_buf).       
+000192e0: 2066 6f75 742e 636c 6f73 6528 290a 2020   fout.close().  
+000192f0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00019300: 6973 5069 7065 203d 2046 616c 7365 0a0a  isPipe = False..
+00019310: 2020 2020 6966 206e 6f74 206f 732e 7061      if not os.pa
+00019320: 7468 2e69 7366 696c 6528 696d 6167 6529  th.isfile(image)
+00019330: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
+00019340: 2e77 6172 6e69 6e67 280a 2020 2020 2020  .warning(.      
+00019350: 2020 2020 2020 2257 3130 323a 2022 0a20        "W102: ". 
+00019360: 2020 2020 2020 2020 2020 2066 2249 6d61             f"Ima
+00019370: 6765 2066 696c 6520 7b69 6d61 6765 7d20  ge file {image} 
+00019380: 6973 206e 6f74 2061 2066 696c 652e 2044  is not a file. D
+00019390: 6f65 736e 2774 2065 7869 7374 206f 7220  oesn't exist or 
+000193a0: 220a 2020 2020 2020 2020 2020 2020 2269  ".            "i
+000193b0: 7320 6120 6469 7265 6374 6f72 792e 2022  s a directory. "
+000193c0: 0a20 2020 2020 2020 2020 2020 2022 5468  .            "Th
+000193d0: 6973 2069 6d61 6765 2069 7320 6265 696e  is image is bein
+000193e0: 6720 6472 6f70 7065 6420 616e 6420 4e4f  g dropped and NO
+000193f0: 5420 7365 6e74 2e22 0a20 2020 2020 2020  T sent.".       
+00019400: 2029 0a20 2020 2020 2020 2067 732e 7761   ).        gs.wa
+00019410: 726e 5f63 6f75 6e74 202b 3d20 310a 2020  rn_count += 1.  
+00019420: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+00019430: 2020 2320 2262 6d70 222c 2022 6769 6622    # "bmp", "gif"
+00019440: 2c20 226a 7067 222c 2022 6a70 6567 222c  , "jpg", "jpeg",
+00019450: 2022 706e 6722 2c20 2270 626d 222c 2022   "png", "pbm", "
+00019460: 7067 6d22 2c20 2270 706d 222c 2022 7862  pgm", "ppm", "xb
+00019470: 6d22 2c20 2278 706d 222c 0a20 2020 2023  m", "xpm",.    #
+00019480: 2022 7469 6666 222c 2022 7765 6270 222c   "tiff", "webp",
+00019490: 2022 7376 6722 2c0a 0a20 2020 2023 2073   "svg",..    # s
+000194a0: 7667 2066 696c 6573 2061 7265 206e 6f74  vg files are not
+000194b0: 2073 686f 776e 2069 6e20 456c 656d 656e   shown in Elemen
+000194c0: 742c 2068 656e 6365 2073 656e 6420 5356  t, hence send SV
+000194d0: 4720 6669 6c65 7320 6173 2066 696c 6573  G files as files
+000194e0: 2077 6974 6820 2d66 0a20 2020 2069 6620   with -f.    if 
+000194f0: 6e6f 7420 6973 5069 7065 2061 6e64 206e  not isPipe and n
+00019500: 6f74 2072 652e 6d61 7463 6828 0a20 2020  ot re.match(.   
+00019510: 2020 2020 2022 5e2e 6a70 6724 7c5e 2e6a       "^.jpg$|^.j
+00019520: 7065 6724 7c5e 2e67 6966 247c 5e2e 706e  peg$|^.gif$|^.pn
+00019530: 6724 7c5e 2e73 7667 2422 2c0a 2020 2020  g$|^.svg$",.    
+00019540: 2020 2020 6f73 2e70 6174 682e 7370 6c69      os.path.spli
+00019550: 7465 7874 2869 6d61 6765 295b 315d 2e6c  text(image)[1].l
+00019560: 6f77 6572 2829 2c0a 2020 2020 293a 0a20  ower(),.    ):. 
+00019570: 2020 2020 2020 2067 732e 6c6f 672e 7761         gs.log.wa
+00019580: 726e 696e 6728 0a20 2020 2020 2020 2020  rning(.         
+00019590: 2020 2022 5731 3033 3a20 220a 2020 2020     "W103: ".    
+000195a0: 2020 2020 2020 2020 6622 496d 6167 6520          f"Image 
+000195b0: 6669 6c65 207b 696d 6167 657d 2069 7320  file {image} is 
+000195c0: 6e6f 7420 616e 2069 6d61 6765 2066 696c  not an image fil
+000195d0: 652e 2053 686f 756c 6420 6265 2022 0a20  e. Should be ". 
+000195e0: 2020 2020 2020 2020 2020 2022 2e6a 7067             ".jpg
+000195f0: 2c20 2e6a 7065 672c 202e 6769 662c 206f  , .jpeg, .gif, o
+00019600: 7220 2e70 6e67 2e20 220a 2020 2020 2020  r .png. ".      
+00019610: 2020 2020 2020 6622 466f 756e 6420 5b7b        f"Found [{
+00019620: 6f73 2e70 6174 682e 7370 6c69 7465 7874  os.path.splitext
+00019630: 2869 6d61 6765 295b 315d 2e6c 6f77 6572  (image)[1].lower
+00019640: 2829 7d5d 2e20 220a 2020 2020 2020 2020  ()}]. ".        
+00019650: 2020 2020 2254 6869 7320 696d 6167 6520      "This image 
+00019660: 6973 2062 6569 6e67 2064 726f 7070 6564  is being dropped
+00019670: 2061 6e64 204e 4f54 2073 656e 742e 220a   and NOT sent.".
+00019680: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00019690: 2020 6773 2e77 6172 6e5f 636f 756e 7420    gs.warn_count 
+000196a0: 2b3d 2031 0a20 2020 2020 2020 2072 6574  += 1.        ret
+000196b0: 7572 6e0a 0a20 2020 2023 2027 6170 706c  urn..    # 'appl
+000196c0: 6963 6174 696f 6e2f 7064 6627 2022 696d  ication/pdf' "im
+000196d0: 6167 652f 6a70 6567 220a 2020 2020 2320  age/jpeg".    # 
+000196e0: 7376 6720 6d69 6d65 2d74 7970 6520 6973  svg mime-type is
+000196f0: 2022 696d 6167 652f 7376 672b 786d 6c22   "image/svg+xml"
+00019700: 0a20 2020 206d 696d 655f 7479 7065 203d  .    mime_type =
+00019710: 206d 6167 6963 2e66 726f 6d5f 6669 6c65   magic.from_file
+00019720: 2869 6d61 6765 2c20 6d69 6d65 3d54 7275  (image, mime=Tru
+00019730: 6529 0a20 2020 2067 732e 6c6f 672e 6465  e).    gs.log.de
+00019740: 6275 6728 6622 496d 6167 6520 6669 6c65  bug(f"Image file
+00019750: 206d 696d 652d 7479 7065 2069 7320 7b6d   mime-type is {m
+00019760: 696d 655f 7479 7065 7d22 290a 2020 2020  ime_type}").    
+00019770: 6966 206e 6f74 206d 696d 655f 7479 7065  if not mime_type
+00019780: 2e73 7461 7274 7377 6974 6828 2269 6d61  .startswith("ima
+00019790: 6765 2f22 293a 0a20 2020 2020 2020 2067  ge/"):.        g
+000197a0: 732e 6c6f 672e 7761 726e 696e 6728 0a20  s.log.warning(. 
+000197b0: 2020 2020 2020 2020 2020 2022 5731 3034             "W104
+000197c0: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
+000197d0: 6622 496d 6167 6520 6669 6c65 207b 696d  f"Image file {im
+000197e0: 6167 657d 2064 6f65 7320 6e6f 7420 6861  age} does not ha
+000197f0: 7665 2061 6e20 696d 6167 6520 6d69 6d65  ve an image mime
+00019800: 2074 7970 652e 2022 0a20 2020 2020 2020   type. ".       
+00019810: 2020 2020 2022 5368 6f75 6c64 2062 6520       "Should be 
+00019820: 736f 6d65 7468 696e 6720 6c69 6b65 2069  something like i
+00019830: 6d61 6765 2f6a 7065 672e 2022 0a20 2020  mage/jpeg. ".   
+00019840: 2020 2020 2020 2020 2066 2246 6f75 6e64           f"Found
+00019850: 206d 696d 6520 7479 7065 207b 6d69 6d65   mime type {mime
+00019860: 5f74 7970 657d 2e20 220a 2020 2020 2020  _type}. ".      
+00019870: 2020 2020 2020 2254 6869 7320 696d 6167        "This imag
+00019880: 6520 6973 2062 6569 6e67 2064 726f 7070  e is being dropp
+00019890: 6564 2061 6e64 204e 4f54 2073 656e 742e  ed and NOT sent.
+000198a0: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
+000198b0: 2020 2020 6773 2e77 6172 6e5f 636f 756e      gs.warn_coun
+000198c0: 7420 2b3d 2031 0a20 2020 2020 2020 2072  t += 1.        r
+000198d0: 6574 7572 6e0a 0a20 2020 2069 6620 6d69  eturn..    if mi
+000198e0: 6d65 5f74 7970 652e 7374 6172 7473 7769  me_type.startswi
+000198f0: 7468 2822 696d 6167 652f 7376 6722 293a  th("image/svg"):
+00019900: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
+00019910: 7761 726e 696e 6728 0a20 2020 2020 2020  warning(.       
+00019920: 2020 2020 2022 5731 3035 3a20 220a 2020       "W105: ".  
+00019930: 2020 2020 2020 2020 2020 2254 6865 7265            "There
+00019940: 2069 7320 6120 6275 6720 696e 2045 6c65   is a bug in Ele
+00019950: 6d65 6e74 2070 7265 7665 6e74 696e 6720  ment preventing 
+00019960: 7072 6576 6965 7773 206f 6620 5356 4720  previews of SVG 
+00019970: 696d 6167 6573 2e20 220a 2020 2020 2020  images. ".      
+00019980: 2020 2020 2020 2241 6c74 6572 6e61 7469        "Alternati
+00019990: 7665 6c79 2079 6f75 206d 6179 2073 656e  vely you may sen
+000199a0: 6420 5356 4720 6669 6c65 7320 6173 2066  d SVG files as f
+000199b0: 696c 6573 2076 6961 202d 662e 220a 2020  iles via -f.".  
+000199c0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000199d0: 7769 6474 6820 3d20 3130 3020 2023 2069  width = 100  # i
+000199e0: 6e20 7069 7865 6c0a 2020 2020 2020 2020  n pixel.        
+000199f0: 6865 6967 6874 203d 2031 3030 0a20 2020  height = 100.   
+00019a00: 2020 2020 2023 2050 7974 686f 6e20 626c       # Python bl
+00019a10: 7572 6861 7368 2070 6163 6b61 6765 2064  urhash package d
+00019a20: 6f65 7320 6e6f 7420 776f 726b 206f 6e20  oes not work on 
+00019a30: 5356 470a 2020 2020 2020 2020 2320 626c  SVG.        # bl
+00019a40: 7572 6861 7368 3a20 736f 6d65 2072 616e  urhash: some ran
+00019a50: 646f 6d20 636f 6c6f 7266 756c 2069 6d61  dom colorful ima
+00019a60: 6765 0a20 2020 2020 2020 2062 6c75 7268  ge.        blurh
+00019a70: 6173 6820 3d20 2255 4c48 5f43 3a30 4847  ash = "ULH_C:0HG
+00019a80: 467d 422e 246b 3a50 4c56 4738 7a7d 2434  F}B.$k:PLVG8z}$4
+00019a90: 3b6f 3f7e 4951 3a39 2479 4222 0a20 2020  ;o?~IQ:9$yB".   
+00019aa0: 2020 2020 2062 6c75 7268 6173 6820 3d20       blurhash = 
+00019ab0: 4e6f 6e65 2020 2320 7368 6f77 7320 7475  None  # shows tu
+00019ac0: 726e 696e 6720 6369 7263 6c65 2066 6f72  rning circle for
+00019ad0: 6576 6572 2069 6e20 456c 656d 656e 7420  ever in Element 
+00019ae0: 6475 6520 746f 2062 7567 0a20 2020 2065  due to bug.    e
+00019af0: 6c73 653a 0a20 2020 2020 2020 2069 6d20  lse:.        im 
+00019b00: 3d20 496d 6167 652e 6f70 656e 2869 6d61  = Image.open(ima
+00019b10: 6765 2920 2023 2074 6869 7320 7769 6c6c  ge)  # this will
+00019b20: 2066 6169 6c20 666f 7220 5356 4720 6669   fail for SVG fi
+00019b30: 6c65 730a 2020 2020 2020 2020 2877 6964  les.        (wid
+00019b40: 7468 2c20 6865 6967 6874 2920 3d20 696d  th, height) = im
+00019b50: 2e73 697a 6520 2023 2069 6d2e 7369 7a65  .size  # im.size
+00019b60: 2072 6574 7572 6e73 2028 7769 6474 682c   returns (width,
+00019b70: 6865 6967 6874 2920 7475 706c 650a 2020  height) tuple.  
+00019b80: 2020 2020 2020 626c 7572 6861 7368 203d        blurhash =
+00019b90: 204e 6f6e 650a 0a20 2020 2023 2066 6972   None..    # fir
+00019ba0: 7374 2064 6f20 616e 2075 706c 6f61 6420  st do an upload 
+00019bb0: 6f66 2069 6d61 6765 2c20 7365 6520 7570  of image, see up
+00019bc0: 6c6f 6164 2829 2064 6f63 756d 656e 7461  load() documenta
+00019bd0: 7469 6f6e 0a20 2020 2023 2068 7474 703a  tion.    # http:
+00019be0: 2f2f 6d61 7472 6978 2d6e 696f 2e72 6561  //matrix-nio.rea
+00019bf0: 6474 6865 646f 6373 2e69 6f2f 656e 2f6c  dthedocs.io/en/l
+00019c00: 6174 6573 742f 6e69 6f2e 6874 6d6c 236e  atest/nio.html#n
+00019c10: 696f 2e41 7379 6e63 436c 6965 6e74 2e75  io.AsyncClient.u
+00019c20: 706c 6f61 640a 2020 2020 2320 7468 656e  pload.    # then
+00019c30: 2073 656e 6420 5552 4920 6f66 2075 706c   send URI of upl
+00019c40: 6f61 6420 746f 2072 6f6f 6d0a 2020 2020  oad to room.    
+00019c50: 2320 4e6f 7465 2074 6861 7420 656e 6372  # Note that encr
+00019c60: 7970 7465 6420 7570 6c6f 6164 2077 6f72  ypted upload wor
+00019c70: 6b73 2065 7665 6e20 7769 7468 2075 6e65  ks even with une
+00019c80: 6e63 7279 7074 6564 2f70 6c61 696e 2072  ncrypted/plain r
+00019c90: 6f6f 6d73 3b20 7468 650a 2020 2020 2320  ooms; the.    # 
+00019ca0: 6465 6372 7970 7469 6f6e 206b 6579 7320  decryption keys 
+00019cb0: 7769 6c6c 206e 6f74 2062 6520 7072 6f74  will not be prot
+00019cc0: 6563 7465 642c 206f 6276 696f 7573 6c79  ected, obviously
+00019cd0: 2c20 6275 7420 6e6f 2073 7065 6369 616c  , but no special
+00019ce0: 0a20 2020 2023 2074 7265 6174 6d65 6e74  .    # treatment
+00019cf0: 2069 7320 7265 7175 6972 6564 2e0a 0a20   is required... 
+00019d00: 2020 2066 696c 655f 7374 6174 203d 2061     file_stat = a
+00019d10: 7761 6974 2061 696f 6669 6c65 732e 6f73  wait aiofiles.os
+00019d20: 2e73 7461 7428 696d 6167 6529 0a20 2020  .stat(image).   
+00019d30: 2061 7379 6e63 2077 6974 6820 6169 6f66   async with aiof
+00019d40: 696c 6573 2e6f 7065 6e28 696d 6167 652c  iles.open(image,
+00019d50: 2022 722b 6222 2920 6173 2066 3a0a 2020   "r+b") as f:.  
+00019d60: 2020 2020 2020 7265 7370 2c20 6465 6372        resp, decr
+00019d70: 7970 7469 6f6e 5f6b 6579 7320 3d20 6177  yption_keys = aw
+00019d80: 6169 7420 636c 6965 6e74 2e75 706c 6f61  ait client.uploa
+00019d90: 6428 0a20 2020 2020 2020 2020 2020 2066  d(.            f
+00019da0: 2c0a 2020 2020 2020 2020 2020 2020 636f  ,.            co
+00019db0: 6e74 656e 745f 7479 7065 3d6d 696d 655f  ntent_type=mime_
+00019dc0: 7479 7065 2c20 2023 2069 6d61 6765 2f6a  type,  # image/j
+00019dd0: 7065 670a 2020 2020 2020 2020 2020 2020  peg.            
+00019de0: 6669 6c65 6e61 6d65 3d6f 732e 7061 7468  filename=os.path
+00019df0: 2e62 6173 656e 616d 6528 696d 6167 6529  .basename(image)
+00019e00: 2c0a 2020 2020 2020 2020 2020 2020 6669  ,.            fi
+00019e10: 6c65 7369 7a65 3d66 696c 655f 7374 6174  lesize=file_stat
+00019e20: 2e73 745f 7369 7a65 2c0a 2020 2020 2020  .st_size,.      
+00019e30: 2020 2020 2020 656e 6372 7970 743d 5472        encrypt=Tr
+00019e40: 7565 2c0a 2020 2020 2020 2020 290a 2020  ue,.        ).  
+00019e50: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00019e60: 7265 7370 2c20 5570 6c6f 6164 5265 7370  resp, UploadResp
+00019e70: 6f6e 7365 293a 0a20 2020 2020 2020 2067  onse):.        g
+00019e80: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
+00019e90: 2020 2020 2020 2020 2022 496d 6167 6520           "Image 
+00019ea0: 7761 7320 7570 6c6f 6164 6564 2073 7563  was uploaded suc
+00019eb0: 6365 7373 6675 6c6c 7920 746f 2073 6572  cessfully to ser
+00019ec0: 7665 722e 2022 0a20 2020 2020 2020 2020  ver. ".         
+00019ed0: 2020 2066 2252 6573 706f 6e73 6520 6973     f"Response is
+00019ee0: 3a20 7b70 7269 7661 6379 5f66 696c 7465  : {privacy_filte
+00019ef0: 7228 7374 7228 7265 7370 2929 7d22 0a20  r(str(resp))}". 
+00019f00: 2020 2020 2020 2029 0a20 2020 2065 6c73         ).    els
+00019f10: 653a 0a20 2020 2020 2020 2067 732e 6c6f  e:.        gs.lo
+00019f20: 672e 696e 666f 280a 2020 2020 2020 2020  g.info(.        
+00019f30: 2020 2020 6622 5468 6520 7072 6f67 7261      f"The progra
+00019f40: 6d20 7b50 524f 475f 5749 5448 5f45 5854  m {PROG_WITH_EXT
+00019f50: 7d20 6661 696c 6564 2074 6f20 7570 6c6f  } failed to uplo
+00019f60: 6164 2e20 220a 2020 2020 2020 2020 2020  ad. ".          
+00019f70: 2020 2250 6c65 6173 6520 7265 7472 792e    "Please retry.
+00019f80: 2054 6869 7320 636f 756c 6420 6265 2074   This could be t
+00019f90: 656d 706f 7261 7279 2069 7373 7565 206f  emporary issue o
+00019fa0: 6e20 220a 2020 2020 2020 2020 2020 2020  n ".            
+00019fb0: 2279 6f75 7220 7365 7276 6572 2e20 220a  "your server. ".
+00019fc0: 2020 2020 2020 2020 2020 2020 2253 6f72              "Sor
+00019fd0: 7279 2e22 0a20 2020 2020 2020 2029 0a20  ry.".        ). 
+00019fe0: 2020 2020 2020 2067 732e 6c6f 672e 696e         gs.log.in
+00019ff0: 666f 280a 2020 2020 2020 2020 2020 2020  fo(.            
+0001a000: 6627 6669 6c65 3d22 7b69 6d61 6765 7d22  f'file="{image}"
+0001a010: 3b20 6d69 6d65 5f74 7970 653d 227b 6d69  ; mime_type="{mi
+0001a020: 6d65 5f74 7970 657d 223b 2027 0a20 2020  me_type}"; '.   
+0001a030: 2020 2020 2020 2020 2066 2766 696c 6573           f'files
+0001a040: 7369 7a65 3d22 7b66 696c 655f 7374 6174  size="{file_stat
+0001a050: 2e73 745f 7369 7a65 7d22 270a 2020 2020  .st_size}"'.    
+0001a060: 2020 2020 2020 2020 6622 4661 696c 6564          f"Failed
+0001a070: 2074 6f20 7570 6c6f 6164 3a20 7b70 7269   to upload: {pri
+0001a080: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
+0001a090: 7265 7370 2929 7d22 0a20 2020 2020 2020  resp))}".       
+0001a0a0: 2029 0a0a 2020 2020 2320 544f 444f 2063   )..    # TODO c
+0001a0b0: 6f6d 7075 7465 2074 6875 6d62 6e61 696c  ompute thumbnail
+0001a0c0: 2c20 7570 6c6f 6164 2074 6875 6d62 6e61  , upload thumbna
+0001a0d0: 696c 2074 6f20 5365 7276 6572 0a20 2020  il to Server.   
+0001a0e0: 2023 2054 4f44 4f20 6164 6420 7468 756d   # TODO add thum
+0001a0f0: 626e 6169 6c20 696e 666f 2074 6f20 6063  bnail info to `c
+0001a100: 6f6e 7465 6e74 600a 0a20 2020 2063 6f6e  ontent`..    con
+0001a110: 7465 6e74 203d 207b 0a20 2020 2020 2020  tent = {.       
+0001a120: 2022 626f 6479 223a 206f 732e 7061 7468   "body": os.path
+0001a130: 2e62 6173 656e 616d 6528 696d 6167 6529  .basename(image)
+0001a140: 2c20 2023 2064 6573 6372 6970 7469 7665  ,  # descriptive
+0001a150: 2074 6974 6c65 0a20 2020 2020 2020 2022   title.        "
+0001a160: 696e 666f 223a 207b 0a20 2020 2020 2020  info": {.       
+0001a170: 2020 2020 2022 7369 7a65 223a 2066 696c       "size": fil
+0001a180: 655f 7374 6174 2e73 745f 7369 7a65 2c0a  e_stat.st_size,.
+0001a190: 2020 2020 2020 2020 2020 2020 226d 696d              "mim
+0001a1a0: 6574 7970 6522 3a20 6d69 6d65 5f74 7970  etype": mime_typ
+0001a1b0: 652c 0a20 2020 2020 2020 2020 2020 2023  e,.            #
+0001a1c0: 2022 7468 756d 626e 6169 6c5f 696e 666f   "thumbnail_info
+0001a1d0: 223a 204e 6f6e 652c 2020 2320 544f 444f  ": None,  # TODO
+0001a1e0: 0a20 2020 2020 2020 2020 2020 2022 7722  .            "w"
+0001a1f0: 3a20 7769 6474 682c 2020 2320 7769 6474  : width,  # widt
+0001a200: 6820 696e 2070 6978 656c 0a20 2020 2020  h in pixel.     
+0001a210: 2020 2020 2020 2022 6822 3a20 6865 6967         "h": heig
+0001a220: 6874 2c20 2023 2068 6569 6768 7420 696e  ht,  # height in
+0001a230: 2070 6978 656c 0a20 2020 2020 2020 2020   pixel.         
+0001a240: 2020 2023 2022 7468 756d 626e 6169 6c5f     # "thumbnail_
+0001a250: 7572 6c22 3a20 4e6f 6e65 2c20 2023 2054  url": None,  # T
+0001a260: 4f44 4f0a 2020 2020 2020 2020 2020 2020  ODO.            
+0001a270: 2278 797a 2e61 6d6f 7267 616e 2e62 6c75  "xyz.amorgan.blu
+0001a280: 7268 6173 6822 3a20 626c 7572 6861 7368  rhash": blurhash
+0001a290: 0a20 2020 2020 2020 2020 2020 2023 2022  .            # "
+0001a2a0: 7468 756d 626e 6169 6c5f 6669 6c65 223a  thumbnail_file":
+0001a2b0: 204e 6f6e 652c 0a20 2020 2020 2020 207d   None,.        }
+0001a2c0: 2c0a 2020 2020 2020 2020 226d 7367 7479  ,.        "msgty
+0001a2d0: 7065 223a 2022 6d2e 696d 6167 6522 2c0a  pe": "m.image",.
+0001a2e0: 2020 2020 2020 2020 2266 696c 6522 3a20          "file": 
+0001a2f0: 7b0a 2020 2020 2020 2020 2020 2020 2275  {.            "u
+0001a300: 726c 223a 2072 6573 702e 636f 6e74 656e  rl": resp.conten
+0001a310: 745f 7572 692c 0a20 2020 2020 2020 2020  t_uri,.         
+0001a320: 2020 2022 6b65 7922 3a20 6465 6372 7970     "key": decryp
+0001a330: 7469 6f6e 5f6b 6579 735b 226b 6579 225d  tion_keys["key"]
+0001a340: 2c0a 2020 2020 2020 2020 2020 2020 2269  ,.            "i
+0001a350: 7622 3a20 6465 6372 7970 7469 6f6e 5f6b  v": decryption_k
+0001a360: 6579 735b 2269 7622 5d2c 0a20 2020 2020  eys["iv"],.     
+0001a370: 2020 2020 2020 2022 6861 7368 6573 223a         "hashes":
+0001a380: 2064 6563 7279 7074 696f 6e5f 6b65 7973   decryption_keys
+0001a390: 5b22 6861 7368 6573 225d 2c0a 2020 2020  ["hashes"],.    
+0001a3a0: 2020 2020 2020 2020 2276 223a 2064 6563          "v": dec
+0001a3b0: 7279 7074 696f 6e5f 6b65 7973 5b22 7622  ryption_keys["v"
+0001a3c0: 5d2c 0a20 2020 2020 2020 207d 2c0a 2020  ],.        },.  
+0001a3d0: 2020 7d0a 0a20 2020 2069 6620 6973 5069    }..    if isPi
+0001a3e0: 7065 3a0a 2020 2020 2020 2020 2320 726d  pe:.        # rm
+0001a3f0: 2074 656d 7020 6669 6c65 0a20 2020 2020   temp file.     
+0001a400: 2020 206f 732e 7265 6d6f 7665 2869 6d61     os.remove(ima
+0001a410: 6765 290a 0a20 2020 2074 7279 3a0a 2020  ge)..    try:.  
+0001a420: 2020 2020 2020 666f 7220 726f 6f6d 5f69        for room_i
+0001a430: 6420 696e 2072 6f6f 6d73 3a0a 2020 2020  d in rooms:.    
+0001a440: 2020 2020 2020 2020 726f 6f6d 5f69 6420          room_id 
+0001a450: 3d20 6177 6169 7420 6d61 705f 726f 6f6d  = await map_room
+0001a460: 696e 666f 5f74 6f5f 726f 6f6d 6964 2863  info_to_roomid(c
+0001a470: 6c69 656e 742c 2072 6f6f 6d5f 6964 290a  lient, room_id).
+0001a480: 2020 2020 2020 2020 2020 2020 7265 7370              resp
+0001a490: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+0001a4a0: 726f 6f6d 5f73 656e 6428 0a20 2020 2020  room_send(.     
+0001a4b0: 2020 2020 2020 2020 2020 2072 6f6f 6d5f             room_
+0001a4c0: 6964 2c20 6d65 7373 6167 655f 7479 7065  id, message_type
+0001a4d0: 3d22 6d2e 726f 6f6d 2e6d 6573 7361 6765  ="m.room.message
+0001a4e0: 222c 2063 6f6e 7465 6e74 3d63 6f6e 7465  ", content=conte
+0001a4f0: 6e74 0a20 2020 2020 2020 2020 2020 2029  nt.            )
+0001a500: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001a510: 6973 696e 7374 616e 6365 2872 6573 702c  isinstance(resp,
+0001a520: 2052 6f6f 6d53 656e 6445 7272 6f72 293a   RoomSendError):
+0001a530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a540: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
+0001a550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a560: 2020 2022 4531 3438 3a20 220a 2020 2020     "E148: ".    
+0001a570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a580: 2272 6f6f 6d5f 7365 6e64 2066 6169 6c65  "room_send faile
+0001a590: 6420 7769 7468 2065 7272 6f72 2022 0a20  d with error ". 
+0001a5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a5b0: 2020 2066 2227 7b70 7269 7661 6379 5f66     f"'{privacy_f
+0001a5c0: 696c 7465 7228 7374 7228 7265 7370 2929  ilter(str(resp))
+0001a5d0: 7d27 2e22 0a20 2020 2020 2020 2020 2020  }'.".           
+0001a5e0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0001a5f0: 2020 2020 2020 2023 2067 732e 6572 725f         # gs.err_
+0001a600: 636f 756e 7420 2b3d 2031 2023 206e 6f74  count += 1 # not
+0001a610: 206e 6565 6465 642c 2077 696c 6c20 7261   needed, will ra
+0001a620: 6973 6520 6578 6365 7074 696f 6e0a 2020  ise exception.  
+0001a630: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0001a640: 696e 2066 6f6c 6c6f 7769 6e67 206c 696e  in following lin
+0001a650: 6520 6f66 2063 6f64 650a 2020 2020 2020  e of code.      
+0001a660: 2020 2020 2020 6773 2e6c 6f67 2e69 6e66        gs.log.inf
+0001a670: 6f28 0a20 2020 2020 2020 2020 2020 2020  o(.             
+0001a680: 2020 2066 2754 6869 7320 696d 6167 6520     f'This image 
+0001a690: 6669 6c65 2077 6173 2073 656e 743a 2022  file was sent: "
+0001a6a0: 7b69 6d61 6765 7d22 2027 0a20 2020 2020  {image}" '.     
+0001a6b0: 2020 2020 2020 2020 2020 2066 2774 6f20             f'to 
+0001a6c0: 726f 6f6d 2022 7b72 6573 702e 726f 6f6d  room "{resp.room
+0001a6d0: 5f69 647d 2220 270a 2020 2020 2020 2020  _id}" '.        
+0001a6e0: 2020 2020 2020 2020 6627 6173 2065 7665          f'as eve
+0001a6f0: 6e74 2022 7b72 6573 702e 6576 656e 745f  nt "{resp.event_
+0001a700: 6964 7d22 2e27 0a20 2020 2020 2020 2020  id}".'.         
+0001a710: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0001a720: 2069 6620 6773 2e70 612e 7072 696e 745f   if gs.pa.print_
+0001a730: 6576 656e 745f 6964 3a0a 2020 2020 2020  event_id:.      
+0001a740: 2020 2020 2020 2020 2020 2320 6f75 7470            # outp
+0001a750: 7574 2066 6f72 6d61 7420 636f 6e74 726f  ut format contro
+0001a760: 6c6c 6564 2076 6961 202d 2d6f 7574 7075  lled via --outpu
+0001a770: 7420 666c 6167 0a20 2020 2020 2020 2020  t flag.         
+0001a780: 2020 2020 2020 2074 6578 7420 3d20 6622         text = f"
+0001a790: 7b72 6573 702e 6576 656e 745f 6964 7d7b  {resp.event_id}{
+0001a7a0: 5345 507d 7b72 6573 702e 726f 6f6d 5f69  SEP}{resp.room_i
+0001a7b0: 647d 7b53 4550 7d7b 696d 6167 657d 220a  d}{SEP}{image}".
+0001a7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a7d0: 2320 4f62 6a65 6374 206f 6620 7479 7065  # Object of type
+0001a7e0: 2052 6f6f 6d43 7265 6174 6552 6573 706f   RoomCreateRespo
+0001a7f0: 6e73 6520 6973 206e 6f74 204a 534f 4e0a  nse is not JSON.
+0001a800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a810: 2320 7365 7269 616c 697a 6162 6c65 2c20  # serializable, 
+0001a820: 6865 6e63 6520 7765 2075 7365 2074 6865  hence we use the
+0001a830: 2064 6963 7469 6f6e 6172 792e 0a20 2020   dictionary..   
+0001a840: 2020 2020 2020 2020 2020 2020 206a 736f               jso
+0001a850: 6e5f 6d61 7820 3d20 7265 7370 2e5f 5f64  n_max = resp.__d
+0001a860: 6963 745f 5f0a 2020 2020 2020 2020 2020  ict__.          
+0001a870: 2020 2020 2020 6a73 6f6e 5f6d 6178 2e75        json_max.u
+0001a880: 7064 6174 6528 7b22 696d 6167 6522 3a20  pdate({"image": 
+0001a890: 696d 6167 657d 2920 2023 2061 6464 2064  image})  # add d
+0001a8a0: 6963 7420 6974 656d 730a 2020 2020 2020  ict items.      
+0001a8b0: 2020 2020 2020 2020 2020 6a73 6f6e 5f20            json_ 
+0001a8c0: 3d20 6a73 6f6e 5f6d 6178 2e63 6f70 7928  = json_max.copy(
+0001a8d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001a8e0: 2020 6a73 6f6e 5f2e 706f 7028 2274 7261    json_.pop("tra
+0001a8f0: 6e73 706f 7274 5f72 6573 706f 6e73 6522  nsport_response"
+0001a900: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001a910: 2020 6a73 6f6e 5f73 7065 6320 3d20 4e6f    json_spec = No
+0001a920: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
+0001a930: 2020 2070 7269 6e74 5f6f 7574 7075 7428     print_output(
+0001a940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a950: 2020 2020 2067 732e 7061 2e6f 7574 7075       gs.pa.outpu
+0001a960: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+0001a970: 2020 2020 2020 2074 6578 743d 7465 7874         text=text
+0001a980: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001a990: 2020 2020 2020 6a73 6f6e 5f3d 6a73 6f6e        json_=json
+0001a9a0: 5f2c 0a20 2020 2020 2020 2020 2020 2020  _,.             
+0001a9b0: 2020 2020 2020 206a 736f 6e5f 6d61 783d         json_max=
+0001a9c0: 6a73 6f6e 5f6d 6178 2c0a 2020 2020 2020  json_max,.      
+0001a9d0: 2020 2020 2020 2020 2020 2020 2020 6a73                js
+0001a9e0: 6f6e 5f73 7065 633d 6a73 6f6e 5f73 7065  on_spec=json_spe
+0001a9f0: 632c 0a20 2020 2020 2020 2020 2020 2020  c,.             
+0001aa00: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0001aa10: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
+0001aa20: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001aa30: 2754 6869 7320 696d 6167 6520 6669 6c65  'This image file
+0001aa40: 2077 6173 2073 656e 743a 2022 7b69 6d61   was sent: "{ima
+0001aa50: 6765 7d22 2027 0a20 2020 2020 2020 2020  ge}" '.         
+0001aa60: 2020 2020 2020 2066 2774 6f20 726f 6f6d         f'to room
+0001aa70: 2022 7b72 6f6f 6d5f 6964 7d22 2e20 270a   "{room_id}". '.
+0001aa80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aa90: 6622 5265 7370 6f6e 7365 3a20 6576 656e  f"Response: even
+0001aaa0: 745f 6964 3d7b 7265 7370 2e65 7665 6e74  t_id={resp.event
+0001aab0: 5f69 647d 2c20 726f 6f6d 5f69 643d 7b72  _id}, room_id={r
+0001aac0: 6573 702e 726f 6f6d 5f69 647d 2c20 220a  esp.room_id}, ".
+0001aad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aae0: 6622 6675 6c6c 2072 6573 706f 6e73 653a  f"full response:
+0001aaf0: 207b 7072 6976 6163 795f 6669 6c74 6572   {privacy_filter
+0001ab00: 2873 7472 2872 6573 7029 297d 2e20 220a  (str(resp))}. ".
+0001ab10: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0001ab20: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+0001ab30: 6f6e 3a0a 2020 2020 2020 2020 6773 2e6c  on:.        gs.l
+0001ab40: 6f67 2e65 7272 6f72 2822 4531 3439 3a20  og.error("E149: 
+0001ab50: 2220 6622 496d 6167 6520 7365 6e64 206f  " f"Image send o
+0001ab60: 6620 6669 6c65 207b 696d 6167 657d 2066  f file {image} f
+0001ab70: 6169 6c65 642e 2053 6f72 7279 2e22 290a  ailed. Sorry.").
+0001ab80: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
+0001ab90: 6f75 6e74 202b 3d20 310a 2020 2020 2020  ount += 1.      
+0001aba0: 2020 6773 2e6c 6f67 2e64 6562 7567 2822    gs.log.debug("
+0001abb0: 4865 7265 2069 7320 7468 6520 7472 6163  Here is the trac
+0001abc0: 6562 6163 6b2e 5c6e 2220 2b20 7472 6163  eback.\n" + trac
+0001abd0: 6562 6163 6b2e 666f 726d 6174 5f65 7863  eback.format_exc
+0001abe0: 2829 290a 0a0a 2320 6163 636f 7264 696e  ())...# accordin
+0001abf0: 6720 746f 206c 696e 7465 723a 2066 756e  g to linter: fun
+0001ac00: 6374 696f 6e20 6973 2074 6f6f 2063 6f6d  ction is too com
+0001ac10: 706c 6578 2c20 4339 3031 0a61 7379 6e63  plex, C901.async
+0001ac20: 2064 6566 2073 656e 645f 6d65 7373 6167   def send_messag
+0001ac30: 6528 636c 6965 6e74 2c20 726f 6f6d 732c  e(client, rooms,
+0001ac40: 206d 6573 7361 6765 293a 2020 2320 6e6f   message):  # no
+0001ac50: 7161 3a20 4339 3031 0a20 2020 2022 2222  qa: C901.    """
+0001ac60: 5072 6f63 6573 7320 6d65 7373 6167 652e  Process message.
+0001ac70: 0a0a 2020 2020 466f 726d 6174 206d 6573  ..    Format mes
+0001ac80: 7361 6765 2061 6363 6f72 6469 6e67 2074  sage according t
+0001ac90: 6f20 696e 7374 7275 6374 696f 6e73 2066  o instructions f
+0001aca0: 726f 6d20 636f 6d6d 616e 6420 6c69 6e65  rom command line
+0001acb0: 2061 7267 756d 656e 7473 2e0a 2020 2020   arguments..    
+0001acc0: 5468 656e 2073 656e 6420 7468 6520 6f6e  Then send the on
+0001acd0: 6520 6d65 7373 6167 6520 746f 2061 6c6c  e message to all
+0001ace0: 2072 6f6f 6d73 2e0a 0a20 2020 2041 7267   rooms...    Arg
+0001acf0: 756d 656e 7473 3a0a 2020 2020 2d2d 2d2d  uments:.    ----
+0001ad00: 2d2d 2d2d 2d0a 2020 2020 636c 6965 6e74  -----.    client
+0001ad10: 203a 2043 6c69 656e 740a 2020 2020 726f   : Client.    ro
+0001ad20: 6f6d 7320 3a20 6c69 7374 0a20 2020 2020  oms : list.     
+0001ad30: 2020 206c 6973 7420 6f66 2072 6f6f 6d5f     list of room_
+0001ad40: 6964 2d73 0a20 2020 206d 6573 7361 6765  id-s.    message
+0001ad50: 203a 2073 7472 0a20 2020 2020 2020 206d   : str.        m
+0001ad60: 6573 7361 6765 2074 6f20 7365 6e64 2061  essage to send a
+0001ad70: 7320 7265 6164 2066 726f 6d20 2d6d 2c20  s read from -m, 
+0001ad80: 7069 7065 206f 7220 6b65 7962 6f61 7264  pipe or keyboard
+0001ad90: 0a20 2020 2020 2020 206d 6573 7361 6765  .        message
+0001ada0: 2069 7320 7769 7468 6f75 7420 6d69 6d65   is without mime
+0001adb0: 2066 6f72 6d61 7474 696e 670a 0a20 2020   formatting..   
+0001adc0: 2022 2222 0a20 2020 2069 6620 6e6f 7420   """.    if not 
+0001add0: 726f 6f6d 733a 0a20 2020 2020 2020 2067  rooms:.        g
+0001ade0: 732e 6c6f 672e 696e 666f 280a 2020 2020  s.log.info(.    
+0001adf0: 2020 2020 2020 2020 224e 6f20 726f 6f6d          "No room
+0001ae00: 7320 6172 6520 6769 7665 6e2e 2054 6869  s are given. Thi
+0001ae10: 7320 7368 6f75 6c64 206e 6f74 2068 6170  s should not hap
+0001ae20: 7065 6e2e 2022 0a20 2020 2020 2020 2020  pen. ".         
+0001ae30: 2020 2022 4d61 7962 6520 796f 7572 2044     "Maybe your D
+0001ae40: 4d20 726f 6f6d 7320 7370 6563 6966 6965  M rooms specifie
+0001ae50: 6420 7669 6120 2d2d 7573 6572 2077 6572  d via --user wer
+0001ae60: 6520 6e6f 7420 666f 756e 642e 2022 0a20  e not found. ". 
+0001ae70: 2020 2020 2020 2020 2020 2022 5468 6973             "This
+0001ae80: 2074 6578 7420 6d65 7373 6167 6520 6973   text message is
+0001ae90: 2062 6569 6e67 2064 726f 7070 6564 2061   being dropped a
+0001aea0: 6e64 204e 4f54 2073 656e 742e 220a 2020  nd NOT sent.".  
+0001aeb0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0001aec0: 7265 7475 726e 0a20 2020 2023 2072 656d  return.    # rem
+0001aed0: 6f76 6520 6c65 6164 696e 6720 414e 4420  ove leading AND 
+0001aee0: 7472 6169 6c69 6e67 206e 6577 6c69 6e65  trailing newline
+0001aef0: 7320 746f 2062 6561 7574 6966 790a 2020  s to beautify.  
+0001af00: 2020 6d65 7373 6167 6520 3d20 6d65 7373    message = mess
+0001af10: 6167 652e 7374 7269 7028 225c 6e22 290a  age.strip("\n").
+0001af20: 0a20 2020 2069 6620 6d65 7373 6167 652e  .    if message.
+0001af30: 7374 7269 7028 2920 3d3d 2022 223a 0a20  strip() == "":. 
+0001af40: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+0001af50: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
+0001af60: 2022 5468 6520 6d65 7373 6167 6520 6973   "The message is
+0001af70: 2065 6d70 7479 2e20 220a 2020 2020 2020   empty. ".      
+0001af80: 2020 2020 2020 2254 6869 7320 6d65 7373        "This mess
+0001af90: 6167 6520 6973 2062 6569 6e67 2064 726f  age is being dro
+0001afa0: 7070 6564 2061 6e64 204e 4f54 2073 656e  pped and NOT sen
+0001afb0: 742e 220a 2020 2020 2020 2020 290a 2020  t.".        ).  
+0001afc0: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+0001afd0: 2020 6966 2067 732e 7061 2e6e 6f74 6963    if gs.pa.notic
+0001afe0: 653a 0a20 2020 2020 2020 2063 6f6e 7465  e:.        conte
+0001aff0: 6e74 203d 207b 226d 7367 7479 7065 223a  nt = {"msgtype":
+0001b000: 2022 6d2e 6e6f 7469 6365 227d 0a20 2020   "m.notice"}.   
+0001b010: 2065 6c73 653a 0a20 2020 2020 2020 2063   else:.        c
+0001b020: 6f6e 7465 6e74 203d 207b 226d 7367 7479  ontent = {"msgty
+0001b030: 7065 223a 2022 6d2e 7465 7874 227d 0a0a  pe": "m.text"}..
+0001b040: 2020 2020 6966 2067 732e 7061 2e63 6f64      if gs.pa.cod
+0001b050: 653a 0a20 2020 2020 2020 2067 732e 6c6f  e:.        gs.lo
+0001b060: 672e 6465 6275 6728 2753 656e 6469 6e67  g.debug('Sending
+0001b070: 206d 6573 7361 6765 2069 6e20 666f 726d   message in form
+0001b080: 6174 2022 636f 6465 222e 2729 0a20 2020  at "code".').   
+0001b090: 2020 2020 2066 6f72 6d61 7474 6564 5f6d       formatted_m
+0001b0a0: 6573 7361 6765 203d 2022 3c70 7265 3e3c  essage = "<pre><
+0001b0b0: 636f 6465 3e22 202b 206d 6573 7361 6765  code>" + message
+0001b0c0: 202b 2022 5c6e 3c2f 636f 6465 3e3c 2f70   + "\n</code></p
+0001b0d0: 7265 3e5c 6e22 0a20 2020 2020 2020 2063  re>\n".        c
+0001b0e0: 6f6e 7465 6e74 5b22 666f 726d 6174 225d  ontent["format"]
+0001b0f0: 203d 2022 6f72 672e 6d61 7472 6978 2e63   = "org.matrix.c
+0001b100: 7573 746f 6d2e 6874 6d6c 2220 2023 2061  ustom.html"  # a
+0001b110: 6464 2074 6f20 6469 6374 0a20 2020 2020  dd to dict.     
+0001b120: 2020 2063 6f6e 7465 6e74 5b22 666f 726d     content["form
+0001b130: 6174 7465 645f 626f 6479 225d 203d 2066  atted_body"] = f
+0001b140: 6f72 6d61 7474 6564 5f6d 6573 7361 6765  ormatted_message
+0001b150: 0a20 2020 2020 2020 2023 206e 6578 7420  .        # next 
+0001b160: 6c69 6e65 3a20 776f 726b 2d61 726f 756e  line: work-aroun
+0001b170: 6420 666f 7220 456c 656d 656e 7420 416e  d for Element An
+0001b180: 6472 6f69 640a 2020 2020 2020 2020 6d65  droid.        me
+0001b190: 7373 6167 6520 3d20 2260 6060 5c6e 2220  ssage = "```\n" 
+0001b1a0: 2b20 6d65 7373 6167 6520 2b20 225c 6e60  + message + "\n`
+0001b1b0: 6060 2220 2023 2074 6f20 666f 726d 6174  ``"  # to format
+0001b1c0: 2069 7420 6173 2063 6f64 650a 2020 2020   it as code.    
+0001b1d0: 656c 6966 2067 732e 7061 2e6d 6172 6b64  elif gs.pa.markd
+0001b1e0: 6f77 6e3a 0a20 2020 2020 2020 2067 732e  own:.        gs.
+0001b1f0: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
+0001b200: 2020 2020 2020 2022 436f 6e76 6572 7469         "Converti
+0001b210: 6e67 206d 6573 7361 6765 2066 726f 6d20  ng message from 
+0001b220: 4d61 726b 446f 776e 2069 6e74 6f20 4854  MarkDown into HT
+0001b230: 4d4c 2e20 220a 2020 2020 2020 2020 2020  ML. ".          
+0001b240: 2020 2753 656e 6469 6e67 206d 6573 7361    'Sending messa
+0001b250: 6765 2069 6e20 666f 726d 6174 2022 6d61  ge in format "ma
+0001b260: 726b 646f 776e 222e 270a 2020 2020 2020  rkdown".'.      
+0001b270: 2020 290a 2020 2020 2020 2020 2320 652e    ).        # e.
+0001b280: 672e 2063 6f6e 7665 7274 7320 6672 6f6d  g. converts from
+0001b290: 2022 2d61 6263 2220 746f 2022 3c75 6c3e   "-abc" to "<ul>
+0001b2a0: 3c6c 693e 6162 633c 2f6c 693e 3c2f 756c  <li>abc</li></ul
+0001b2b0: 3e22 0a20 2020 2020 2020 2066 6f72 6d61  >".        forma
+0001b2c0: 7474 6564 5f6d 6573 7361 6765 203d 206d  tted_message = m
+0001b2d0: 6172 6b64 6f77 6e28 6d65 7373 6167 6529  arkdown(message)
+0001b2e0: 0a20 2020 2020 2020 2063 6f6e 7465 6e74  .        content
+0001b2f0: 5b22 666f 726d 6174 225d 203d 2022 6f72  ["format"] = "or
+0001b300: 672e 6d61 7472 6978 2e63 7573 746f 6d2e  g.matrix.custom.
+0001b310: 6874 6d6c 2220 2023 2061 6464 2074 6f20  html"  # add to 
+0001b320: 6469 6374 0a20 2020 2020 2020 2063 6f6e  dict.        con
+0001b330: 7465 6e74 5b22 666f 726d 6174 7465 645f  tent["formatted_
+0001b340: 626f 6479 225d 203d 2066 6f72 6d61 7474  body"] = formatt
+0001b350: 6564 5f6d 6573 7361 6765 0a20 2020 2065  ed_message.    e
+0001b360: 6c69 6620 6773 2e70 612e 6874 6d6c 3a0a  lif gs.pa.html:.
+0001b370: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+0001b380: 6562 7567 2827 5365 6e64 696e 6720 6d65  ebug('Sending me
+0001b390: 7373 6167 6520 696e 2066 6f72 6d61 7420  ssage in format 
+0001b3a0: 2268 746d 6c22 2e27 290a 2020 2020 2020  "html".').      
+0001b3b0: 2020 666f 726d 6174 7465 645f 6d65 7373    formatted_mess
+0001b3c0: 6167 6520 3d20 6d65 7373 6167 6520 2023  age = message  #
+0001b3d0: 2074 6865 2073 616d 6520 666f 7220 7468   the same for th
+0001b3e0: 6520 7469 6d65 2062 6569 6e67 0a20 2020  e time being.   
+0001b3f0: 2020 2020 2063 6f6e 7465 6e74 5b22 666f       content["fo
+0001b400: 726d 6174 225d 203d 2022 6f72 672e 6d61  rmat"] = "org.ma
+0001b410: 7472 6978 2e63 7573 746f 6d2e 6874 6d6c  trix.custom.html
+0001b420: 2220 2023 2061 6464 2074 6f20 6469 6374  "  # add to dict
+0001b430: 0a20 2020 2020 2020 2063 6f6e 7465 6e74  .        content
+0001b440: 5b22 666f 726d 6174 7465 645f 626f 6479  ["formatted_body
+0001b450: 225d 203d 2066 6f72 6d61 7474 6564 5f6d  "] = formatted_m
+0001b460: 6573 7361 6765 0a20 2020 2065 6c69 6620  essage.    elif 
+0001b470: 6773 2e70 612e 656d 6f6a 697a 653a 0a20  gs.pa.emojize:. 
+0001b480: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+0001b490: 6275 6728 2753 656e 6469 6e67 206d 6573  bug('Sending mes
+0001b4a0: 7361 6765 2069 6e20 666f 726d 6174 2022  sage in format "
+0001b4b0: 656d 6f6a 697a 6564 222e 2729 0a20 2020  emojized".').   
+0001b4c0: 2020 2020 2066 6f72 6d61 7474 6564 5f6d       formatted_m
+0001b4d0: 6573 7361 6765 203d 2065 6d6f 6a69 2e65  essage = emoji.e
+0001b4e0: 6d6f 6a69 7a65 286d 6573 7361 6765 2920  mojize(message) 
+0001b4f0: 2023 2063 6f6e 7665 7274 2065 6d6f 6a69   # convert emoji
+0001b500: 2073 686f 7274 636f 6465 7320 6966 2070   shortcodes if p
+0001b510: 7265 7365 6e74 0a20 2020 2020 2020 2063  resent.        c
+0001b520: 6f6e 7465 6e74 5b22 666f 726d 6174 225d  ontent["format"]
+0001b530: 203d 2022 6f72 672e 6d61 7472 6978 2e63   = "org.matrix.c
+0001b540: 7573 746f 6d2e 6874 6d6c 2220 2023 2061  ustom.html"  # a
+0001b550: 6464 2074 6f20 6469 6374 0a20 2020 2020  dd to dict.     
+0001b560: 2020 2063 6f6e 7465 6e74 5b22 666f 726d     content["form
+0001b570: 6174 7465 645f 626f 6479 225d 203d 2066  atted_body"] = f
+0001b580: 6f72 6d61 7474 6564 5f6d 6573 7361 6765  ormatted_message
+0001b590: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+0001b5a0: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+0001b5b0: 2753 656e 6469 6e67 206d 6573 7361 6765  'Sending message
+0001b5c0: 2069 6e20 666f 726d 6174 2022 7465 7874   in format "text
+0001b5d0: 222e 2729 0a20 2020 2063 6f6e 7465 6e74  ".').    content
+0001b5e0: 5b22 626f 6479 225d 203d 206d 6573 7361  ["body"] = messa
+0001b5f0: 6765 0a0a 2020 2020 7472 793a 0a20 2020  ge..    try:.   
+0001b600: 2020 2020 2066 6f72 2072 6f6f 6d5f 6964       for room_id
+0001b610: 2069 6e20 726f 6f6d 733a 0a20 2020 2020   in rooms:.     
+0001b620: 2020 2020 2020 2072 6f6f 6d5f 6964 203d         room_id =
+0001b630: 2061 7761 6974 206d 6170 5f72 6f6f 6d69   await map_roomi
+0001b640: 6e66 6f5f 746f 5f72 6f6f 6d69 6428 636c  nfo_to_roomid(cl
+0001b650: 6965 6e74 2c20 726f 6f6d 5f69 6429 0a20  ient, room_id). 
+0001b660: 2020 2020 2020 2020 2020 2072 6573 7020             resp 
+0001b670: 3d20 6177 6169 7420 636c 6965 6e74 2e72  = await client.r
+0001b680: 6f6f 6d5f 7365 6e64 280a 2020 2020 2020  oom_send(.      
+0001b690: 2020 2020 2020 2020 2020 726f 6f6d 5f69            room_i
+0001b6a0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0001b6b0: 2020 206d 6573 7361 6765 5f74 7970 653d     message_type=
+0001b6c0: 226d 2e72 6f6f 6d2e 6d65 7373 6167 6522  "m.room.message"
+0001b6d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001b6e0: 2020 636f 6e74 656e 743d 636f 6e74 656e    content=conten
+0001b6f0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+0001b700: 2020 2069 676e 6f72 655f 756e 7665 7269     ignore_unveri
+0001b710: 6669 6564 5f64 6576 6963 6573 3d54 7275  fied_devices=Tru
+0001b720: 652c 0a20 2020 2020 2020 2020 2020 2029  e,.            )
+0001b730: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001b740: 6973 696e 7374 616e 6365 2872 6573 702c  isinstance(resp,
+0001b750: 2052 6f6f 6d53 656e 6445 7272 6f72 293a   RoomSendError):
+0001b760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b770: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
+0001b780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b790: 2020 2022 4531 3530 3a20 220a 2020 2020     "E150: ".    
+0001b7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b7b0: 2272 6f6f 6d5f 7365 6e64 2066 6169 6c65  "room_send faile
+0001b7c0: 6420 7769 7468 2065 7272 6f72 2022 0a20  d with error ". 
+0001b7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b7e0: 2020 2066 2227 7b70 7269 7661 6379 5f66     f"'{privacy_f
+0001b7f0: 696c 7465 7228 7374 7228 7265 7370 2929  ilter(str(resp))
+0001b800: 7d27 2e22 0a20 2020 2020 2020 2020 2020  }'.".           
+0001b810: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0001b820: 2020 2020 2020 2023 2067 732e 6572 725f         # gs.err_
+0001b830: 636f 756e 7420 2b3d 2031 2023 206e 6f74  count += 1 # not
+0001b840: 206e 6565 6465 642c 2077 696c 6c20 7261   needed, will ra
+0001b850: 6973 6520 6578 6365 7074 696f 6e0a 2020  ise exception.  
+0001b860: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0001b870: 696e 2066 6f6c 6c6f 7769 6e67 206c 696e  in following lin
+0001b880: 6520 6f66 2063 6f64 650a 2020 2020 2020  e of code.      
+0001b890: 2020 2020 2020 6773 2e6c 6f67 2e69 6e66        gs.log.inf
+0001b8a0: 6f28 0a20 2020 2020 2020 2020 2020 2020  o(.             
+0001b8b0: 2020 2066 2754 6869 7320 6d65 7373 6167     f'This messag
+0001b8c0: 6520 7761 7320 7365 6e74 3a20 227b 6d65  e was sent: "{me
+0001b8d0: 7373 6167 657d 2220 746f 2072 6f6f 6d20  ssage}" to room 
+0001b8e0: 227b 7265 7370 2e72 6f6f 6d5f 6964 7d22  "{resp.room_id}"
+0001b8f0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0001b900: 2020 2066 2761 7320 6576 656e 7420 227b     f'as event "{
+0001b910: 7265 7370 2e65 7665 6e74 5f69 647d 222e  resp.event_id}".
+0001b920: 270a 2020 2020 2020 2020 2020 2020 290a  '.            ).
+0001b930: 2020 2020 2020 2020 2020 2020 6966 2067              if g
+0001b940: 732e 7061 2e70 7269 6e74 5f65 7665 6e74  s.pa.print_event
+0001b950: 5f69 643a 0a20 2020 2020 2020 2020 2020  _id:.           
+0001b960: 2020 2020 2023 206f 7574 7075 7420 666f       # output fo
+0001b970: 726d 6174 2063 6f6e 7472 6f6c 6c65 6420  rmat controlled 
+0001b980: 7669 6120 2d2d 6f75 7470 7574 2066 6c61  via --output fla
+0001b990: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
+0001b9a0: 2020 7465 7874 203d 2066 227b 7265 7370    text = f"{resp
+0001b9b0: 2e65 7665 6e74 5f69 647d 7b53 4550 7d7b  .event_id}{SEP}{
+0001b9c0: 7265 7370 2e72 6f6f 6d5f 6964 7d7b 5345  resp.room_id}{SE
+0001b9d0: 507d 7b6d 6573 7361 6765 7d22 0a20 2020  P}{message}".   
+0001b9e0: 2020 2020 2020 2020 2020 2020 2023 204f               # O
+0001b9f0: 626a 6563 7420 6f66 2074 7970 6520 526f  bject of type Ro
+0001ba00: 6f6d 4372 6561 7465 5265 7370 6f6e 7365  omCreateResponse
+0001ba10: 2069 7320 6e6f 7420 4a53 4f4e 0a20 2020   is not JSON.   
+0001ba20: 2020 2020 2020 2020 2020 2020 2023 2073               # s
+0001ba30: 6572 6961 6c69 7a61 626c 652c 2068 656e  erializable, hen
+0001ba40: 6365 2077 6520 7573 6520 7468 6520 6469  ce we use the di
+0001ba50: 6374 696f 6e61 7279 2e0a 2020 2020 2020  ctionary..      
+0001ba60: 2020 2020 2020 2020 2020 6a73 6f6e 5f6d            json_m
+0001ba70: 6178 203d 2072 6573 702e 5f5f 6469 6374  ax = resp.__dict
+0001ba80: 5f5f 0a20 2020 2020 2020 2020 2020 2020  __.             
+0001ba90: 2020 206a 736f 6e5f 6d61 782e 7570 6461     json_max.upda
+0001baa0: 7465 287b 226d 6573 7361 6765 223a 206d  te({"message": m
+0001bab0: 6573 7361 6765 7d29 2020 2320 6164 6420  essage})  # add 
+0001bac0: 6469 6374 2069 7465 6d73 0a20 2020 2020  dict items.     
+0001bad0: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+0001bae0: 203d 206a 736f 6e5f 6d61 782e 636f 7079   = json_max.copy
+0001baf0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0001bb00: 2020 206a 736f 6e5f 2e70 6f70 2822 7472     json_.pop("tr
+0001bb10: 616e 7370 6f72 745f 7265 7370 6f6e 7365  ansport_response
+0001bb20: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+0001bb30: 2020 206a 736f 6e5f 7370 6563 203d 204e     json_spec = N
+0001bb40: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+0001bb50: 2020 2020 7072 696e 745f 6f75 7470 7574      print_output
+0001bb60: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001bb70: 2020 2020 2020 6773 2e70 612e 6f75 7470        gs.pa.outp
+0001bb80: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
+0001bb90: 2020 2020 2020 2020 7465 7874 3d74 6578          text=tex
+0001bba0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+0001bbb0: 2020 2020 2020 206a 736f 6e5f 3d6a 736f         json_=jso
+0001bbc0: 6e5f 2c0a 2020 2020 2020 2020 2020 2020  n_,.            
+0001bbd0: 2020 2020 2020 2020 6a73 6f6e 5f6d 6178          json_max
+0001bbe0: 3d6a 736f 6e5f 6d61 782c 0a20 2020 2020  =json_max,.     
+0001bbf0: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+0001bc00: 736f 6e5f 7370 6563 3d6a 736f 6e5f 7370  son_spec=json_sp
+0001bc10: 6563 2c0a 2020 2020 2020 2020 2020 2020  ec,.            
+0001bc20: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0001bc30: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
+0001bc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bc50: 6627 5468 6973 206d 6573 7361 6765 2077  f'This message w
+0001bc60: 6173 2073 656e 743a 2022 7b6d 6573 7361  as sent: "{messa
+0001bc70: 6765 7d22 2074 6f20 726f 6f6d 2022 7b72  ge}" to room "{r
+0001bc80: 6f6f 6d5f 6964 7d22 2e20 270a 2020 2020  oom_id}". '.    
+0001bc90: 2020 2020 2020 2020 2020 2020 6622 5265              f"Re
+0001bca0: 7370 6f6e 7365 3a20 6576 656e 745f 6964  sponse: event_id
+0001bcb0: 3d7b 7265 7370 2e65 7665 6e74 5f69 647d  ={resp.event_id}
+0001bcc0: 2c20 726f 6f6d 5f69 643d 7b72 6573 702e  , room_id={resp.
+0001bcd0: 726f 6f6d 5f69 647d 2c20 220a 2020 2020  room_id}, ".    
+0001bce0: 2020 2020 2020 2020 2020 2020 6622 6675              f"fu
+0001bcf0: 6c6c 2072 6573 706f 6e73 653a 207b 7072  ll response: {pr
+0001bd00: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
+0001bd10: 2872 6573 7029 297d 2e20 220a 2020 2020  (resp))}. ".    
+0001bd20: 2020 2020 2020 2020 290a 2020 2020 6578          ).    ex
+0001bd30: 6365 7074 2045 7863 6570 7469 6f6e 3a0a  cept Exception:.
+0001bd40: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
+0001bd50: 7272 6f72 2822 4531 3531 3a20 2220 224d  rror("E151: " "M
+0001bd60: 6573 7361 6765 2073 656e 6420 6661 696c  essage send fail
+0001bd70: 6564 2e20 536f 7272 792e 2229 0a20 2020  ed. Sorry.").   
+0001bd80: 2020 2020 2067 732e 6572 725f 636f 756e       gs.err_coun
+0001bd90: 7420 2b3d 2031 0a20 2020 2020 2020 2067  t += 1.        g
+0001bda0: 732e 6c6f 672e 6465 6275 6728 2248 6572  s.log.debug("Her
+0001bdb0: 6520 6973 2074 6865 2074 7261 6365 6261  e is the traceba
+0001bdc0: 636b 2e5c 6e22 202b 2074 7261 6365 6261  ck.\n" + traceba
+0001bdd0: 636b 2e66 6f72 6d61 745f 6578 6328 2929  ck.format_exc())
+0001bde0: 0a0a 0a61 7379 6e63 2064 6566 2073 7472  ...async def str
+0001bdf0: 6561 6d5f 6d65 7373 6167 6573 5f66 726f  eam_messages_fro
+0001be00: 6d5f 7069 7065 2863 6c69 656e 742c 2072  m_pipe(client, r
+0001be10: 6f6f 6d73 293a 0a20 2020 2022 2222 5265  ooms):.    """Re
+0001be20: 6164 2069 6e70 7574 2066 726f 6d20 7069  ad input from pi
+0001be30: 7065 2069 6620 6176 6169 6c61 626c 652e  pe if available.
+0001be40: 0a0a 2020 2020 5265 6164 2070 6970 6520  ..    Read pipe 
+0001be50: 6c69 6e65 2062 7920 6c69 6e65 2e20 466f  line by line. Fo
+0001be60: 7220 6561 6368 206c 696e 6520 7265 6365  r each line rece
+0001be70: 6976 6564 2c20 696d 6d65 6469 6174 656c  ived, immediatel
+0001be80: 790a 2020 2020 7365 6e64 2069 742e 0a0a  y.    send it...
+0001be90: 2020 2020 4172 6775 6d65 6e74 733a 0a20      Arguments:. 
+0001bea0: 2020 202d 2d2d 2d2d 2d2d 2d2d 0a20 2020     ---------.   
+0001beb0: 2063 6c69 656e 7420 3a20 436c 6965 6e74   client : Client
+0001bec0: 0a20 2020 2072 6f6f 6d73 203a 206c 6973  .    rooms : lis
+0001bed0: 7420 6f66 2072 6f6f 6d5f 6964 730a 0a20  t of room_ids.. 
+0001bee0: 2020 2022 2222 0a20 2020 2073 7464 696e     """.    stdin
+0001bef0: 5f72 6561 6479 203d 2073 656c 6563 742e  _ready = select.
+0001bf00: 7365 6c65 6374 285b 7379 732e 7374 6469  select([sys.stdi
+0001bf10: 6e2c 5d2c 205b 5d2c 205b 5d2c 2030 2e30  n,], [], [], 0.0
+0001bf20: 295b 2020 2320 6e6f 7161 0a20 2020 2020  )[  # noqa.     
+0001bf30: 2020 2030 0a20 2020 205d 2020 2320 6e6f     0.    ]  # no
+0001bf40: 7161 0a20 2020 2069 6620 6e6f 7420 7374  qa.    if not st
+0001bf50: 6469 6e5f 7265 6164 793a 0a20 2020 2020  din_ready:.     
+0001bf60: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+0001bf70: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
+0001bf80: 6469 6e20 6973 206e 6f74 2072 6561 6479  din is not ready
+0001bf90: 2066 6f72 2073 7472 6561 6d69 6e67 2e20   for streaming. 
+0001bfa0: 220a 2020 2020 2020 2020 2020 2020 2241  ".            "A
+0001bfb0: 2070 6970 6520 636f 756c 6420 6265 2075   pipe could be u
+0001bfc0: 7365 642c 2062 7574 2070 6970 6520 636f  sed, but pipe co
+0001bfd0: 756c 6420 6265 2065 6d70 7479 2c20 220a  uld be empty, ".
+0001bfe0: 2020 2020 2020 2020 2020 2020 2273 7464              "std
+0001bff0: 696e 2063 6f75 6c64 2061 6c73 6f20 6265  in could also be
+0001c000: 2061 206b 6579 626f 6172 642e 220a 2020   a keyboard.".  
+0001c010: 2020 2020 2020 290a 2020 2020 656c 7365        ).    else
+0001c020: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
+0001c030: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+0001c040: 2020 2020 2273 7464 696e 2069 7320 7265      "stdin is re
+0001c050: 6164 792e 2053 6f6d 6574 6869 6e67 2022  ady. Something "
+0001c060: 0a20 2020 2020 2020 2020 2020 2022 6973  .            "is
+0001c070: 2064 6566 696e 6974 656c 7920 7069 7065   definitely pipe
+0001c080: 6420 696e 746f 2070 726f 6772 616d 2066  d into program f
+0001c090: 726f 6d20 7374 6469 6e2e 2022 0a20 2020  rom stdin. ".   
+0001c0a0: 2020 2020 2020 2020 2022 5265 6164 696e           "Readin
+0001c0b0: 6720 6d65 7373 6167 6520 6672 6f6d 2073  g message from s
+0001c0c0: 7464 696e 2070 6970 652e 220a 2020 2020  tdin pipe.".    
+0001c0d0: 2020 2020 290a 2020 2020 6966 2028 286e      ).    if ((n
+0001c0e0: 6f74 2073 7464 696e 5f72 6561 6479 2920  ot stdin_ready) 
+0001c0f0: 616e 6420 286e 6f74 2073 7973 2e73 7464  and (not sys.std
+0001c100: 696e 2e69 7361 7474 7928 2929 2920 6f72  in.isatty())) or
+0001c110: 2073 7464 696e 5f72 6561 6479 3a0a 2020   stdin_ready:.  
+0001c120: 2020 2020 2020 6966 206e 6f74 2073 7973        if not sys
+0001c130: 2e73 7464 696e 2e69 7361 7474 7928 293a  .stdin.isatty():
+0001c140: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+0001c150: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
+0001c160: 2020 2020 2020 2020 2020 2022 5069 7065             "Pipe
+0001c170: 2077 6173 2064 6566 696e 6974 656c 7920   was definitely 
+0001c180: 7573 6564 2c20 6275 7420 7069 7065 206d  used, but pipe m
+0001c190: 6967 6874 2062 6520 656d 7074 792e 2022  ight be empty. "
+0001c1a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c1b0: 2022 5472 7969 6e67 2074 6f20 7265 6164   "Trying to read
+0001c1c0: 2066 726f 6d20 7069 7065 2069 6e20 616e   from pipe in an
+0001c1d0: 7920 6361 7365 2e22 0a20 2020 2020 2020  y case.".       
+0001c1e0: 2020 2020 2029 0a20 2020 2020 2020 2074       ).        t
+0001c1f0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0001c200: 666f 7220 6c69 6e65 2069 6e20 7379 732e  for line in sys.
+0001c210: 7374 6469 6e3a 0a20 2020 2020 2020 2020  stdin:.         
+0001c220: 2020 2020 2020 2061 7761 6974 2073 656e         await sen
+0001c230: 645f 6d65 7373 6167 6528 636c 6965 6e74  d_message(client
+0001c240: 2c20 726f 6f6d 732c 206c 696e 6529 0a20  , rooms, line). 
+0001c250: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0001c260: 732e 6c6f 672e 6465 6275 6728 2255 7369  s.log.debug("Usi
+0001c270: 6e67 2064 6174 6120 6672 6f6d 2073 7464  ng data from std
+0001c280: 696e 2070 6970 6520 7374 7265 616d 2061  in pipe stream a
+0001c290: 7320 6d65 7373 6167 652e 2229 0a20 2020  s message.").   
+0001c2a0: 2020 2020 2065 7863 6570 7420 454f 4645       except EOFE
+0001c2b0: 7272 6f72 3a20 2023 2045 4f46 2077 6865  rror:  # EOF whe
+0001c2c0: 6e20 7265 6164 696e 6720 6120 6c69 6e65  n reading a line
+0001c2d0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+0001c2e0: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
+0001c2f0: 2020 2020 2020 2020 2020 2022 5265 6164             "Read
+0001c300: 696e 6720 6672 6f6d 2073 7464 696e 2072  ing from stdin r
+0001c310: 6573 756c 7465 6420 696e 2045 4f46 2e20  esulted in EOF. 
+0001c320: 5468 6973 2063 616e 2068 6170 7065 6e20  This can happen 
+0001c330: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0001c340: 2020 2277 6865 6e20 6120 7069 7065 2077    "when a pipe w
+0001c350: 6173 2075 7365 642c 2062 7574 2074 6865  as used, but the
+0001c360: 2070 6970 6520 6973 2065 6d70 7479 2e20   pipe is empty. 
+0001c370: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0001c380: 2020 224e 6f20 6d65 7373 6167 6520 7769    "No message wi
+0001c390: 6c6c 2062 6520 6765 6e65 7261 7465 642e  ll be generated.
+0001c3a0: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+0001c3b0: 2020 2020 2020 2020 6578 6365 7074 2055          except U
+0001c3c0: 6e69 636f 6465 4465 636f 6465 4572 726f  nicodeDecodeErro
+0001c3d0: 723a 0a20 2020 2020 2020 2020 2020 2067  r:.            g
+0001c3e0: 732e 6c6f 672e 696e 666f 280a 2020 2020  s.log.info(.    
+0001c3f0: 2020 2020 2020 2020 2020 2020 2252 6561              "Rea
+0001c400: 6469 6e67 2066 726f 6d20 7374 6469 6e20  ding from stdin 
+0001c410: 7265 7375 6c74 6564 2069 6e20 556e 6963  resulted in Unic
+0001c420: 6f64 6544 6563 6f64 6545 7272 6f72 2e20  odeDecodeError. 
+0001c430: 5468 6973 2022 0a20 2020 2020 2020 2020  This ".         
+0001c440: 2020 2020 2020 2022 6361 6e20 6861 7070         "can happ
+0001c450: 656e 2069 6620 796f 7520 7472 7920 746f  en if you try to
+0001c460: 2070 6970 6520 6269 6e61 7279 2064 6174   pipe binary dat
+0001c470: 6120 666f 7220 6120 7465 7874 2022 0a20  a for a text ". 
+0001c480: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0001c490: 6d65 7373 6167 652e 2046 6f72 2061 2074  message. For a t
+0001c4a0: 6578 7420 6d65 7373 6167 6520 6f6e 6c79  ext message only
+0001c4b0: 2070 6970 6520 7465 7874 2076 6961 2073   pipe text via s
+0001c4c0: 7464 696e 2c20 220a 2020 2020 2020 2020  tdin, ".        
+0001c4d0: 2020 2020 2020 2020 226e 6f74 2062 696e          "not bin
+0001c4e0: 6172 7920 6461 7461 2e20 4e6f 206d 6573  ary data. No mes
+0001c4f0: 7361 6765 2077 696c 6c20 6265 2067 656e  sage will be gen
+0001c500: 6572 6174 6564 2e22 0a20 2020 2020 2020  erated.".       
+0001c510: 2020 2020 2029 0a0a 0a64 6566 2067 6574       )...def get
+0001c520: 5f6d 6573 7361 6765 735f 6672 6f6d 5f70  _messages_from_p
+0001c530: 6970 6528 2920 2d3e 206c 6973 743a 0a20  ipe() -> list:. 
+0001c540: 2020 2022 2222 5265 6164 2069 6e70 7574     """Read input
+0001c550: 2066 726f 6d20 7069 7065 2069 6620 6176   from pipe if av
+0001c560: 6169 6c61 626c 652e 0a0a 2020 2020 5265  ailable...    Re
+0001c570: 7475 726e 205b 5d20 6966 206e 6f20 696e  turn [] if no in
+0001c580: 7075 7420 6176 6169 6c61 626c 6520 6f6e  put available on
+0001c590: 2070 6970 6520 7374 6469 6e2e 0a20 2020   pipe stdin..   
+0001c5a0: 2052 6574 7572 6e20 5b22 736f 6d65 2d6d   Return ["some-m
+0001c5b0: 7367 225d 2069 6620 696e 7075 7420 6973  sg"] if input is
+0001c5c0: 2061 7661 696c 626c 652e 0a20 2020 204d   availble..    M
+0001c5d0: 6967 6874 2061 6c73 6f20 7265 7475 726e  ight also return
+0001c5e0: 205b 2222 5d20 6f66 2063 6f75 7273 6520   [""] of course 
+0001c5f0: 6966 2022 2220 7761 7320 696e 2070 6970  if "" was in pip
+0001c600: 652e 0a20 2020 2043 7572 7265 6e74 6c79  e..    Currently
+0001c610: 2074 6865 7265 2069 7320 6174 206d 6f73   there is at mos
+0001c620: 7420 3120 6d73 6720 696e 2074 6865 2072  t 1 msg in the r
+0001c630: 6574 7572 6e65 6420 6c69 7374 2e0a 2020  eturned list..  
+0001c640: 2020 2222 220a 2020 2020 6d65 7373 6167    """.    messag
+0001c650: 6573 203d 205b 5d0a 2020 2020 7374 6469  es = [].    stdi
+0001c660: 6e5f 7265 6164 7920 3d20 7365 6c65 6374  n_ready = select
+0001c670: 2e73 656c 6563 7428 5b73 7973 2e73 7464  .select([sys.std
+0001c680: 696e 2c5d 2c20 5b5d 2c20 5b5d 2c20 302e  in,], [], [], 0.
+0001c690: 3029 5b20 2023 206e 6f71 610a 2020 2020  0)[  # noqa.    
+0001c6a0: 2020 2020 300a 2020 2020 5d20 2023 206e      0.    ]  # n
+0001c6b0: 6f71 610a 2020 2020 6966 206e 6f74 2073  oqa.    if not s
+0001c6c0: 7464 696e 5f72 6561 6479 3a0a 2020 2020  tdin_ready:.    
+0001c6d0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+0001c6e0: 280a 2020 2020 2020 2020 2020 2020 2273  (.            "s
+0001c6f0: 7464 696e 2069 7320 6e6f 7420 7265 6164  tdin is not read
+0001c700: 7920 666f 7220 7265 6164 696e 672e 2022  y for reading. "
+0001c710: 0a20 2020 2020 2020 2020 2020 2022 4120  .            "A 
+0001c720: 7069 7065 2063 6f75 6c64 2062 6520 7573  pipe could be us
+0001c730: 6564 2c20 6275 7420 7069 7065 2063 6f75  ed, but pipe cou
+0001c740: 6c64 2062 6520 656d 7074 792c 2022 0a20  ld be empty, ". 
+0001c750: 2020 2020 2020 2020 2020 2022 7374 6469             "stdi
+0001c760: 6e20 636f 756c 6420 616c 736f 2062 6520  n could also be 
+0001c770: 6120 6b65 7962 6f61 7264 2e22 0a20 2020  a keyboard.".   
+0001c780: 2020 2020 2029 0a20 2020 2065 6c73 653a       ).    else:
+0001c790: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
+0001c7a0: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
+0001c7b0: 2020 2022 7374 6469 6e20 6973 2072 6561     "stdin is rea
+0001c7c0: 6479 2e20 536f 6d65 7468 696e 6720 220a  dy. Something ".
+0001c7d0: 2020 2020 2020 2020 2020 2020 2269 7320              "is 
+0001c7e0: 6465 6669 6e69 7465 6c79 2070 6970 6564  definitely piped
+0001c7f0: 2069 6e74 6f20 7072 6f67 7261 6d20 6672   into program fr
+0001c800: 6f6d 2073 7464 696e 2e20 220a 2020 2020  om stdin. ".    
+0001c810: 2020 2020 2020 2020 2252 6561 6469 6e67          "Reading
+0001c820: 206d 6573 7361 6765 2066 726f 6d20 7374   message from st
+0001c830: 6469 6e20 7069 7065 2e22 0a20 2020 2020  din pipe.".     
+0001c840: 2020 2029 0a20 2020 2069 6620 2828 6e6f     ).    if ((no
+0001c850: 7420 7374 6469 6e5f 7265 6164 7929 2061  t stdin_ready) a
+0001c860: 6e64 2028 6e6f 7420 7379 732e 7374 6469  nd (not sys.stdi
+0001c870: 6e2e 6973 6174 7479 2829 2929 206f 7220  n.isatty())) or 
+0001c880: 7374 6469 6e5f 7265 6164 793a 0a20 2020  stdin_ready:.   
+0001c890: 2020 2020 2069 6620 6e6f 7420 7379 732e       if not sys.
+0001c8a0: 7374 6469 6e2e 6973 6174 7479 2829 3a0a  stdin.isatty():.
+0001c8b0: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+0001c8c0: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
+0001c8d0: 2020 2020 2020 2020 2020 2250 6970 6520            "Pipe 
+0001c8e0: 7761 7320 6465 6669 6e69 7465 6c79 2075  was definitely u
+0001c8f0: 7365 642c 2062 7574 2070 6970 6520 6d69  sed, but pipe mi
+0001c900: 6768 7420 6265 2065 6d70 7479 2e20 220a  ght be empty. ".
+0001c910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c920: 2254 7279 696e 6720 746f 2072 6561 6420  "Trying to read 
+0001c930: 6672 6f6d 2070 6970 6520 696e 2061 6e79  from pipe in any
+0001c940: 2063 6173 652e 220a 2020 2020 2020 2020   case.".        
+0001c950: 2020 2020 290a 2020 2020 2020 2020 6d65      ).        me
+0001c960: 7373 6167 6520 3d20 2222 0a20 2020 2020  ssage = "".     
+0001c970: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0001c980: 2020 2020 666f 7220 6c69 6e65 2069 6e20      for line in 
+0001c990: 7379 732e 7374 6469 6e3a 0a20 2020 2020  sys.stdin:.     
+0001c9a0: 2020 2020 2020 2020 2020 206d 6573 7361             messa
+0001c9b0: 6765 202b 3d20 6c69 6e65 0a20 2020 2020  ge += line.     
+0001c9c0: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+0001c9d0: 6275 6728 2255 7369 6e67 2064 6174 6120  bug("Using data 
+0001c9e0: 6672 6f6d 2073 7464 696e 2070 6970 6520  from stdin pipe 
+0001c9f0: 6173 206d 6573 7361 6765 2e22 290a 2020  as message.").  
+0001ca00: 2020 2020 2020 2020 2020 6d65 7373 6167            messag
+0001ca10: 6573 2e61 7070 656e 6428 6d65 7373 6167  es.append(messag
+0001ca20: 6529 0a20 2020 2020 2020 2065 7863 6570  e).        excep
+0001ca30: 7420 454f 4645 7272 6f72 3a20 2023 2045  t EOFError:  # E
+0001ca40: 4f46 2077 6865 6e20 7265 6164 696e 6720  OF when reading 
+0001ca50: 6120 6c69 6e65 0a20 2020 2020 2020 2020  a line.         
+0001ca60: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+0001ca70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ca80: 2022 5265 6164 696e 6720 6672 6f6d 2073   "Reading from s
+0001ca90: 7464 696e 2072 6573 756c 7465 6420 696e  tdin resulted in
+0001caa0: 2045 4f46 2e20 5468 6973 2063 616e 2068   EOF. This can h
+0001cab0: 6170 7065 6e20 220a 2020 2020 2020 2020  appen ".        
+0001cac0: 2020 2020 2020 2020 2277 6865 6e20 6120          "when a 
+0001cad0: 7069 7065 2077 6173 2075 7365 642c 2062  pipe was used, b
+0001cae0: 7574 2074 6865 2070 6970 6520 6973 2065  ut the pipe is e
+0001caf0: 6d70 7479 2e20 220a 2020 2020 2020 2020  mpty. ".        
+0001cb00: 2020 2020 2020 2020 224e 6f20 6d65 7373          "No mess
+0001cb10: 6167 6520 7769 6c6c 2062 6520 6765 6e65  age will be gene
+0001cb20: 7261 7465 642e 220a 2020 2020 2020 2020  rated.".        
+0001cb30: 2020 2020 290a 2020 2020 2020 2020 6578      ).        ex
+0001cb40: 6365 7074 2055 6e69 636f 6465 4465 636f  cept UnicodeDeco
+0001cb50: 6465 4572 726f 723a 0a20 2020 2020 2020  deError:.       
+0001cb60: 2020 2020 2067 732e 6c6f 672e 696e 666f       gs.log.info
+0001cb70: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001cb80: 2020 2252 6561 6469 6e67 2066 726f 6d20    "Reading from 
+0001cb90: 7374 6469 6e20 7265 7375 6c74 6564 2069  stdin resulted i
+0001cba0: 6e20 556e 6963 6f64 6544 6563 6f64 6545  n UnicodeDecodeE
+0001cbb0: 7272 6f72 2e20 5468 6973 2022 0a20 2020  rror. This ".   
+0001cbc0: 2020 2020 2020 2020 2020 2020 2022 6361               "ca
+0001cbd0: 6e20 6861 7070 656e 2069 6620 796f 7520  n happen if you 
+0001cbe0: 7472 7920 746f 2070 6970 6520 6269 6e61  try to pipe bina
+0001cbf0: 7279 2064 6174 6120 666f 7220 6120 7465  ry data for a te
+0001cc00: 7874 2022 0a20 2020 2020 2020 2020 2020  xt ".           
+0001cc10: 2020 2020 2022 6d65 7373 6167 652e 2046       "message. F
+0001cc20: 6f72 2061 2074 6578 7420 6d65 7373 6167  or a text messag
+0001cc30: 6520 6f6e 6c79 2070 6970 6520 7465 7874  e only pipe text
+0001cc40: 2076 6961 2073 7464 696e 2c20 220a 2020   via stdin, ".  
+0001cc50: 2020 2020 2020 2020 2020 2020 2020 226e                "n
+0001cc60: 6f74 2062 696e 6172 7920 6461 7461 2e20  ot binary data. 
+0001cc70: 4e6f 206d 6573 7361 6765 2077 696c 6c20  No message will 
+0001cc80: 6265 2067 656e 6572 6174 6564 2e22 0a20  be generated.". 
+0001cc90: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0001cca0: 2072 6574 7572 6e20 6d65 7373 6167 6573   return messages
+0001ccb0: 0a0a 0a64 6566 2067 6574 5f6d 6573 7361  ...def get_messa
+0001ccc0: 6765 735f 6672 6f6d 5f6b 6579 626f 6172  ges_from_keyboar
+0001ccd0: 6428 2920 2d3e 206c 6973 743a 0a20 2020  d() -> list:.   
+0001cce0: 2022 2222 5265 6164 2069 6e70 7574 2066   """Read input f
+0001ccf0: 726f 6d20 6b65 7962 6f61 7264 2062 7574  rom keyboard but
+0001cd00: 206f 6e6c 7920 6966 206e 6f20 6f74 6865   only if no othe
+0001cd10: 7220 6d65 7373 6167 6573 2061 7265 2061  r messages are a
+0001cd20: 7661 696c 6162 6c65 2e0a 0a20 2020 2049  vailable...    I
+0001cd30: 6620 7468 6572 6520 6973 2061 206d 6573  f there is a mes
+0001cd40: 7361 6765 2070 726f 7669 6465 6420 7669  sage provided vi
+0001cd50: 6120 2d2d 6d65 7373 6167 6520 6172 6775  a --message argu
+0001cd60: 6d65 6e74 2c20 6e6f 206d 6573 7361 6765  ment, no message
+0001cd70: 0a20 2020 2077 696c 6c20 6265 2072 6561  .    will be rea
+0001cd80: 6420 6672 6f6d 206b 6579 626f 6172 642e  d from keyboard.
+0001cd90: 0a20 2020 2049 6620 7468 6572 6520 6172  .    If there ar
+0001cda0: 6520 6f74 6865 7220 7365 6e64 206f 7065  e other send ope
+0001cdb0: 7261 7469 6f6e 7320 6c69 6b65 202d 2d69  rations like --i
+0001cdc0: 6d61 6765 2c20 2d2d 6669 6c65 2c20 6574  mage, --file, et
+0001cdd0: 632e 2061 7265 0a20 2020 2075 7365 642c  c. are.    used,
+0001cde0: 206e 6f20 6d65 7373 6167 6520 7769 6c6c   no message will
+0001cdf0: 2062 6520 7265 6164 2066 726f 6d20 6b65   be read from ke
+0001ce00: 7962 6f61 7264 2e0a 2020 2020 4966 2074  yboard..    If t
+0001ce10: 6865 7265 2069 7320 6120 6d65 7373 6167  here is a messag
+0001ce20: 6520 7072 6f76 6964 6564 2076 6961 2073  e provided via s
+0001ce30: 7464 696e 2069 6e70 7574 2070 6970 652c  tdin input pipe,
+0001ce40: 206e 6f20 6d65 7373 6167 650a 2020 2020   no message.    
+0001ce50: 7769 6c6c 2062 6520 7265 6164 2066 726f  will be read fro
+0001ce60: 6d20 6b65 7962 6f61 7264 2e0a 2020 2020  m keyboard..    
+0001ce70: 496e 2073 686f 7274 2c20 7765 206f 6e6c  In short, we onl
+0001ce80: 7920 7265 6164 2066 726f 6d20 6b65 7962  y read from keyb
+0001ce90: 6f61 7264 2061 7320 6c61 7374 2072 6573  oard as last res
+0001cea0: 6f72 742c 2069 6620 6e6f 206d 6573 7361  ort, if no messa
+0001ceb0: 6765 7320 6172 650a 2020 2020 7370 6563  ges are.    spec
+0001cec0: 6966 6965 6420 6f72 2070 726f 7669 6465  ified or provide
+0001ced0: 6420 616e 7977 6865 7265 2061 6e64 206e  d anywhere and n
+0001cee0: 6f20 6f74 6865 7220 7365 6e64 2d6f 7065  o other send-ope
+0001cef0: 7261 7469 6f6e 7320 6c69 6b65 0a20 2020  rations like.   
+0001cf00: 202d 2d69 6d61 6765 2c20 2d2d 6576 656e   --image, --even
+0001cf10: 742c 2065 7463 2e20 6172 6520 7065 7266  t, etc. are perf
+0001cf20: 6f72 6d65 642e 0a0a 2020 2020 5265 7475  ormed...    Retu
+0001cf30: 726e 205b 5d20 6966 206e 6f20 696e 7075  rn [] if no inpu
+0001cf40: 7420 6176 6169 6c61 626c 6520 6f6e 206b  t available on k
+0001cf50: 6579 626f 6172 642e 0a20 2020 2052 6574  eyboard..    Ret
+0001cf60: 7572 6e20 5b22 736f 6d65 2d6d 7367 225d  urn ["some-msg"]
+0001cf70: 2069 6620 696e 7075 7420 6973 2061 7661   if input is ava
+0001cf80: 696c 626c 6520 6f6e 206b 6579 626f 6172  ilble on keyboar
+0001cf90: 642e 0a20 2020 204d 6967 6874 2061 6c73  d..    Might als
+0001cfa0: 6f20 7265 7475 726e 205b 2222 5d20 6f66  o return [""] of
+0001cfb0: 2063 6f75 7273 6520 6966 2022 2220 6b65   course if "" ke
+0001cfc0: 7962 6f61 7264 2065 6e74 7279 2077 6173  yboard entry was
+0001cfd0: 2065 6d70 7479 2e0a 2020 2020 4375 7272   empty..    Curr
+0001cfe0: 656e 746c 7920 7468 6572 6520 6973 2061  ently there is a
+0001cff0: 7420 6d6f 7374 2031 206d 7367 2069 6e20  t most 1 msg in 
+0001d000: 7468 6520 7265 7475 726e 6564 206c 6973  the returned lis
+0001d010: 742e 0a20 2020 2022 2222 0a20 2020 206d  t..    """.    m
+0001d020: 6573 7361 6765 7320 3d20 5b5d 0a20 2020  essages = [].   
+0001d030: 2069 6620 6773 2e70 612e 6d65 7373 6167   if gs.pa.messag
+0001d040: 653a 0a20 2020 2020 2020 2067 732e 6c6f  e:.        gs.lo
+0001d050: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
+0001d060: 2020 2020 2022 446f 6e27 7420 7265 6164       "Don't read
+0001d070: 2066 726f 6d20 6b65 7962 6f61 7264 2062   from keyboard b
+0001d080: 6563 6175 7365 2074 6865 7265 2061 7265  ecause there are
+0001d090: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
+0001d0a0: 6d65 7373 6167 6573 2070 726f 7669 6465  messages provide
+0001d0b0: 6420 696e 2061 7267 756d 656e 7473 2077  d in arguments w
+0001d0c0: 6974 6820 2d6d 2e22 0a20 2020 2020 2020  ith -m.".       
+0001d0d0: 2029 0a20 2020 2020 2020 2072 6574 7572   ).        retur
+0001d0e0: 6e20 6d65 7373 6167 6573 2020 2320 7265  n messages  # re
+0001d0f0: 7475 726e 2065 6d70 7479 206c 6973 7420  turn empty list 
+0001d100: 6265 6361 7573 6520 6d65 7367 7320 696e  because mesgs in
+0001d110: 202d 6d0a 2020 2020 6966 2028 0a20 2020   -m.    if (.   
+0001d120: 2020 2020 2067 732e 7061 2e69 6d61 6765       gs.pa.image
+0001d130: 0a20 2020 2020 2020 206f 7220 6773 2e70  .        or gs.p
+0001d140: 612e 6175 6469 6f0a 2020 2020 2020 2020  a.audio.        
+0001d150: 6f72 2067 732e 7061 2e66 696c 650a 2020  or gs.pa.file.  
+0001d160: 2020 2020 2020 6f72 2067 732e 7061 2e65        or gs.pa.e
+0001d170: 7665 6e74 0a20 2020 2020 2020 206f 7220  vent.        or 
+0001d180: 6773 2e70 612e 7665 7273 696f 6e0a 2020  gs.pa.version.  
+0001d190: 2020 293a 0a20 2020 2020 2020 2067 732e    ):.        gs.
+0001d1a0: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
+0001d1b0: 2020 2020 2020 2022 446f 6e27 7420 7265         "Don't re
+0001d1c0: 6164 2066 726f 6d20 6b65 7962 6f61 7264  ad from keyboard
+0001d1d0: 2062 6563 6175 7365 2074 6865 7265 2061   because there a
+0001d1e0: 7265 2022 0a20 2020 2020 2020 2020 2020  re ".           
+0001d1f0: 2022 6f74 6865 7220 7365 6e64 206f 7065   "other send ope
+0001d200: 7261 7469 6f6e 7320 6f72 202d 2d76 6572  rations or --ver
+0001d210: 7369 6f6e 2070 726f 7669 6465 6420 696e  sion provided in
+0001d220: 2061 7267 756d 656e 7473 2e22 0a20 2020   arguments.".   
+0001d230: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+0001d240: 6574 7572 6e20 6d65 7373 6167 6573 2020  eturn messages  
+0001d250: 2320 7265 7475 726e 2065 6d70 7479 206c  # return empty l
+0001d260: 6973 7420 6265 6361 7573 6520 6d65 7367  ist because mesg
+0001d270: 7320 696e 202d 6d0a 2020 2020 7374 6469  s in -m.    stdi
+0001d280: 6e5f 7265 6164 7920 3d20 7365 6c65 6374  n_ready = select
+0001d290: 2e73 656c 6563 7428 5b73 7973 2e73 7464  .select([sys.std
+0001d2a0: 696e 2c5d 2c20 5b5d 2c20 5b5d 2c20 302e  in,], [], [], 0.
+0001d2b0: 3029 5b20 2023 206e 6f71 610a 2020 2020  0)[  # noqa.    
+0001d2c0: 2020 2020 300a 2020 2020 5d20 2023 206e      0.    ]  # n
+0001d2d0: 6f71 610a 2020 2020 6966 206e 6f74 2073  oqa.    if not s
+0001d2e0: 7464 696e 5f72 6561 6479 3a0a 2020 2020  tdin_ready:.    
+0001d2f0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+0001d300: 280a 2020 2020 2020 2020 2020 2020 2273  (.            "s
+0001d310: 7464 696e 2069 7320 6e6f 7420 7265 6164  tdin is not read
+0001d320: 7920 666f 7220 6b65 7962 6f61 7264 2069  y for keyboard i
+0001d330: 6e74 6572 6163 7469 6f6e 2e20 220a 2020  nteraction. ".  
+0001d340: 2020 2020 2020 2020 2020 2241 2070 6970            "A pip
+0001d350: 6520 636f 756c 6420 6265 2075 7365 642c  e could be used,
+0001d360: 2062 7574 2070 6970 6520 636f 756c 6420   but pipe could 
+0001d370: 6265 2065 6d70 7479 2c20 220a 2020 2020  be empty, ".    
+0001d380: 2020 2020 2020 2020 2273 7464 696e 2063          "stdin c
+0001d390: 6f75 6c64 2061 6c73 6f20 6265 2061 206b  ould also be a k
+0001d3a0: 6579 626f 6172 642e 220a 2020 2020 2020  eyboard.".      
+0001d3b0: 2020 290a 2020 2020 656c 7365 3a0a 2020    ).    else:.  
+0001d3c0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+0001d3d0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+0001d3e0: 2273 7464 696e 2069 7320 7265 6164 792e  "stdin is ready.
+0001d3f0: 2053 6f6d 6574 6869 6e67 2022 0a20 2020   Something ".   
+0001d400: 2020 2020 2020 2020 2022 6973 2064 6566           "is def
+0001d410: 696e 6974 656c 7920 7069 7065 6420 696e  initely piped in
+0001d420: 746f 2070 726f 6772 616d 2066 726f 6d20  to program from 
+0001d430: 7374 6469 6e2e 2022 0a20 2020 2020 2020  stdin. ".       
+0001d440: 2020 2020 2022 5265 6164 696e 6720 6d65       "Reading me
+0001d450: 7373 6167 6520 6672 6f6d 2073 7464 696e  ssage from stdin
+0001d460: 2070 6970 652e 220a 2020 2020 2020 2020   pipe.".        
+0001d470: 290a 2020 2020 6966 2028 6e6f 7420 7374  ).    if (not st
+0001d480: 6469 6e5f 7265 6164 7929 2061 6e64 2028  din_ready) and (
+0001d490: 7379 732e 7374 6469 6e2e 6973 6174 7479  sys.stdin.isatty
+0001d4a0: 2829 293a 0a20 2020 2020 2020 2023 2062  ()):.        # b
+0001d4b0: 6563 6175 7365 2073 7973 2e73 7464 696e  ecause sys.stdin
+0001d4c0: 2e69 7361 7474 7928 2920 6973 2074 7275  .isatty() is tru
+0001d4d0: 650a 2020 2020 2020 2020 6773 2e6c 6f67  e.        gs.log
+0001d4e0: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+0001d4f0: 2020 2020 224e 6f20 7069 7065 2077 6173      "No pipe was
+0001d500: 2075 7365 642c 2073 6f20 7265 6164 2069   used, so read i
+0001d510: 6e70 7574 2066 726f 6d20 6b65 7962 6f61  nput from keyboa
+0001d520: 7264 2e20 220a 2020 2020 2020 2020 2020  rd. ".          
+0001d530: 2020 2252 6561 6469 6e67 206d 6573 7361    "Reading messa
+0001d540: 6765 2066 726f 6d20 6b65 7962 6f61 7264  ge from keyboard
+0001d550: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
+0001d560: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0001d570: 2020 2020 206d 6573 7361 6765 203d 2069       message = i
+0001d580: 6e70 7574 2822 456e 7465 7220 6d65 7373  nput("Enter mess
+0001d590: 6167 6520 746f 2073 656e 643a 2022 290a  age to send: ").
+0001d5a0: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+0001d5b0: 6f67 2e64 6562 7567 2822 5573 696e 6720  og.debug("Using 
+0001d5c0: 6461 7461 2066 726f 6d20 7374 6469 6e20  data from stdin 
+0001d5d0: 6b65 7962 6f61 7264 2061 7320 6d65 7373  keyboard as mess
+0001d5e0: 6167 652e 2229 0a20 2020 2020 2020 2020  age.").         
+0001d5f0: 2020 206d 6573 7361 6765 732e 6170 7065     messages.appe
+0001d600: 6e64 286d 6573 7361 6765 290a 2020 2020  nd(message).    
+0001d610: 2020 2020 6578 6365 7074 2045 4f46 4572      except EOFEr
+0001d620: 726f 723a 2020 2320 454f 4620 7768 656e  ror:  # EOF when
+0001d630: 2072 6561 6469 6e67 2061 206c 696e 650a   reading a line.
+0001d640: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+0001d650: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
+0001d660: 2020 2020 2020 2020 2020 2252 6561 6469            "Readi
+0001d670: 6e67 2066 726f 6d20 7374 6469 6e20 7265  ng from stdin re
+0001d680: 7375 6c74 6564 2069 6e20 454f 462e 2022  sulted in EOF. "
+0001d690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d6a0: 2022 5265 6164 696e 6720 6672 6f6d 206b   "Reading from k
+0001d6b0: 6579 626f 6172 6420 6661 696c 6564 2e20  eyboard failed. 
+0001d6c0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0001d6d0: 2020 224e 6f20 6d65 7373 6167 6520 7769    "No message wi
+0001d6e0: 6c6c 2062 6520 6765 6e65 7261 7465 642e  ll be generated.
+0001d6f0: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+0001d700: 2020 2020 7265 7475 726e 206d 6573 7361      return messa
+0001d710: 6765 730a 0a0a 6173 796e 6320 6465 6620  ges...async def 
+0001d720: 7365 6e64 5f6d 6573 7361 6765 735f 616e  send_messages_an
+0001d730: 645f 6669 6c65 7328 636c 6965 6e74 2c20  d_files(client, 
+0001d740: 726f 6f6d 732c 206d 6573 7361 6765 7329  rooms, messages)
+0001d750: 3a0a 2020 2020 2222 2253 656e 6420 7465  :.    """Send te
+0001d760: 7874 206d 6573 7361 6765 7320 616e 6420  xt messages and 
+0001d770: 6669 6c65 732e 0a0a 2020 2020 4669 7273  files...    Firs
+0001d780: 7420 696d 6167 6573 2c20 6175 6469 6f2c  t images, audio,
+0001d790: 2065 7463 2c20 7468 656e 2074 6578 7420   etc, then text 
+0001d7a0: 6d65 7373 6167 6564 2e0a 0a20 2020 2041  messaged...    A
+0001d7b0: 7267 756d 656e 7473 3a0a 2020 2020 2d2d  rguments:.    --
+0001d7c0: 2d2d 2d2d 2d2d 2d0a 2020 2020 636c 6965  -------.    clie
+0001d7d0: 6e74 203a 2043 6c69 656e 740a 2020 2020  nt : Client.    
+0001d7e0: 726f 6f6d 7320 3a20 6c69 7374 206f 6620  rooms : list of 
+0001d7f0: 726f 6f6d 5f69 6473 0a20 2020 206d 6573  room_ids.    mes
+0001d800: 7361 6765 7320 3a20 6c69 7374 206f 6620  sages : list of 
+0001d810: 6d65 7373 6167 6573 2074 6f20 7365 6e64  messages to send
+0001d820: 0a0a 2020 2020 2222 220a 2020 2020 6966  ..    """.    if
+0001d830: 2067 732e 7061 2e69 6d61 6765 3a0a 2020   gs.pa.image:.  
+0001d840: 2020 2020 2020 666f 7220 696d 6167 6520        for image 
+0001d850: 696e 2067 732e 7061 2e69 6d61 6765 3a0a  in gs.pa.image:.
+0001d860: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+0001d870: 7420 7365 6e64 5f69 6d61 6765 2863 6c69  t send_image(cli
+0001d880: 656e 742c 2072 6f6f 6d73 2c20 696d 6167  ent, rooms, imag
+0001d890: 6529 0a0a 2020 2020 6966 2067 732e 7061  e)..    if gs.pa
+0001d8a0: 2e61 7564 696f 3a0a 2020 2020 2020 2020  .audio:.        
+0001d8b0: 666f 7220 6175 6469 6f20 696e 2067 732e  for audio in gs.
+0001d8c0: 7061 2e61 7564 696f 3a0a 2020 2020 2020  pa.audio:.      
+0001d8d0: 2020 2020 2020 2320 6175 6469 6f20 6669        # audio fi
+0001d8e0: 6c65 2063 616e 2062 6520 7365 6e74 206c  le can be sent l
+0001d8f0: 696b 6520 6f74 6865 7220 6669 6c65 730a  ike other files.
+0001d900: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+0001d910: 7420 7365 6e64 5f66 696c 6528 636c 6965  t send_file(clie
+0001d920: 6e74 2c20 726f 6f6d 732c 2061 7564 696f  nt, rooms, audio
+0001d930: 290a 0a20 2020 2069 6620 6773 2e70 612e  )..    if gs.pa.
+0001d940: 6669 6c65 3a0a 2020 2020 2020 2020 666f  file:.        fo
+0001d950: 7220 6669 6c65 2069 6e20 6773 2e70 612e  r file in gs.pa.
+0001d960: 6669 6c65 3a0a 2020 2020 2020 2020 2020  file:.          
+0001d970: 2020 6177 6169 7420 7365 6e64 5f66 696c    await send_fil
+0001d980: 6528 636c 6965 6e74 2c20 726f 6f6d 732c  e(client, rooms,
+0001d990: 2066 696c 6529 0a0a 2020 2020 6966 2067   file)..    if g
+0001d9a0: 732e 7061 2e65 7665 6e74 3a0a 2020 2020  s.pa.event:.    
+0001d9b0: 2020 2020 666f 7220 6576 656e 7420 696e      for event in
+0001d9c0: 2067 732e 7061 2e65 7665 6e74 3a0a 2020   gs.pa.event:.  
+0001d9d0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+0001d9e0: 7365 6e64 5f65 7665 6e74 2863 6c69 656e  send_event(clien
+0001d9f0: 742c 2072 6f6f 6d73 2c20 6576 656e 7429  t, rooms, event)
+0001da00: 0a0a 2020 2020 666f 7220 6d65 7373 6167  ..    for messag
+0001da10: 6520 696e 206d 6573 7361 6765 733a 0a20  e in messages:. 
+0001da20: 2020 2020 2020 2061 7761 6974 2073 656e         await sen
+0001da30: 645f 6d65 7373 6167 6528 636c 6965 6e74  d_message(client
+0001da40: 2c20 726f 6f6d 732c 206d 6573 7361 6765  , rooms, message
+0001da50: 290a 0a0a 6173 796e 6320 6465 6620 7072  )...async def pr
+0001da60: 6f63 6573 735f 6172 6775 6d65 6e74 735f  ocess_arguments_
+0001da70: 616e 645f 696e 7075 7428 636c 6965 6e74  and_input(client
+0001da80: 2c20 726f 6f6d 7329 3a0a 2020 2020 2222  , rooms):.    ""
+0001da90: 2250 726f 6365 7373 2061 7267 756d 656e  "Process argumen
+0001daa0: 7473 2061 6e64 2061 6c6c 2069 6e70 7574  ts and all input
+0001dab0: 2e0a 0a20 2020 2050 726f 6365 7373 2061  ...    Process a
+0001dac0: 6c6c 2069 6e70 7574 3a20 7465 7874 206d  ll input: text m
+0001dad0: 6573 7361 6765 732c 2065 7463 2e0a 2020  essages, etc..  
+0001dae0: 2020 5072 6570 6172 6520 6120 6c69 7374    Prepare a list
+0001daf0: 206f 6620 6d65 7373 6167 6573 2066 726f   of messages fro
+0001db00: 6d20 616c 6c20 736f 7572 6365 7320 616e  m all sources an
+0001db10: 6420 7468 656e 2073 656e 6420 7468 656d  d then send them
+0001db20: 2e0a 0a20 2020 2041 7267 756d 656e 7473  ...    Arguments
+0001db30: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d0a  :.    ---------.
+0001db40: 2020 2020 636c 6965 6e74 203a 2043 6c69      client : Cli
+0001db50: 656e 740a 2020 2020 726f 6f6d 7320 3a20  ent.    rooms : 
+0001db60: 6c69 7374 206f 6620 726f 6f6d 5f69 6473  list of room_ids
+0001db70: 0a0a 2020 2020 2222 220a 2020 2020 7374  ..    """.    st
+0001db80: 7265 616d 696e 6720 3d20 4661 6c73 650a  reaming = False.
+0001db90: 2020 2020 6d65 7373 6167 6573 5f66 726f      messages_fro
+0001dba0: 6d5f 7069 7065 203d 205b 5d0a 2020 2020  m_pipe = [].    
+0001dbb0: 6966 2067 732e 7374 6469 6e5f 7573 6520  if gs.stdin_use 
+0001dbc0: 3d3d 2022 6e6f 6e65 223a 2020 2320 5354  == "none":  # ST
+0001dbd0: 4449 4e20 6973 2075 6e75 7365 640a 2020  DIN is unused.  
+0001dbe0: 2020 2020 2020 6d65 7373 6167 6573 5f66        messages_f
+0001dbf0: 726f 6d5f 7069 7065 203d 2067 6574 5f6d  rom_pipe = get_m
+0001dc00: 6573 7361 6765 735f 6672 6f6d 5f70 6970  essages_from_pip
+0001dc10: 6528 290a 2020 2020 6d65 7373 6167 6573  e().    messages
+0001dc20: 5f66 726f 6d5f 6b65 7962 6f61 7264 203d  _from_keyboard =
+0001dc30: 2067 6574 5f6d 6573 7361 6765 735f 6672   get_messages_fr
+0001dc40: 6f6d 5f6b 6579 626f 6172 6428 290a 2020  om_keyboard().  
+0001dc50: 2020 6966 206e 6f74 2067 732e 7061 2e6d    if not gs.pa.m
+0001dc60: 6573 7361 6765 3a0a 2020 2020 2020 2020  essage:.        
+0001dc70: 6d65 7373 6167 6573 5f66 726f 6d5f 636f  messages_from_co
+0001dc80: 6d6d 616e 646c 696e 6520 3d20 5b5d 0a20  mmandline = []. 
+0001dc90: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001dca0: 206d 6573 7361 6765 735f 6672 6f6d 5f63   messages_from_c
+0001dcb0: 6f6d 6d61 6e64 6c69 6e65 203d 205b 5d0a  ommandline = [].
+0001dcc0: 2020 2020 2020 2020 666f 7220 6d20 696e          for m in
+0001dcd0: 2067 732e 7061 2e6d 6573 7361 6765 3a0a   gs.pa.message:.
+0001dce0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+0001dcf0: 203d 3d20 225c 5c2d 223a 2020 2320 6573   == "\\-":  # es
+0001dd00: 6361 7065 6420 2d0a 2020 2020 2020 2020  caped -.        
+0001dd10: 2020 2020 2020 2020 6d65 7373 6167 6573          messages
+0001dd20: 5f66 726f 6d5f 636f 6d6d 616e 646c 696e  _from_commandlin
+0001dd30: 6520 2b3d 205b 222d 225d 0a20 2020 2020  e += ["-"].     
+0001dd40: 2020 2020 2020 2065 6c69 6620 6d20 3d3d         elif m ==
+0001dd50: 2022 5c5c 5f22 3a20 2023 2065 7363 6170   "\\_":  # escap
+0001dd60: 6564 205f 0a20 2020 2020 2020 2020 2020  ed _.           
+0001dd70: 2020 2020 206d 6573 7361 6765 735f 6672       messages_fr
+0001dd80: 6f6d 5f63 6f6d 6d61 6e64 6c69 6e65 202b  om_commandline +
+0001dd90: 3d20 5b22 5f22 5d0a 2020 2020 2020 2020  = ["_"].        
+0001dda0: 2020 2020 656c 6966 206d 203d 3d20 222d      elif m == "-
+0001ddb0: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
+0001ddc0: 2020 2023 2073 7464 696e 2070 6970 652c     # stdin pipe,
+0001ddd0: 2072 6561 6420 616e 6420 7072 6f63 6573   read and proces
+0001dde0: 7320 6576 6572 7974 6869 6e67 2069 6e20  s everything in 
+0001ddf0: 7069 7065 2061 7320 3120 6d73 670a 2020  pipe as 1 msg.  
+0001de00: 2020 2020 2020 2020 2020 2020 2020 6d65                me
+0001de10: 7373 6167 6573 5f66 726f 6d5f 636f 6d6d  ssages_from_comm
+0001de20: 616e 646c 696e 6520 2b3d 2067 6574 5f6d  andline += get_m
+0001de30: 6573 7361 6765 735f 6672 6f6d 5f70 6970  essages_from_pip
+0001de40: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+0001de50: 656c 6966 206d 203d 3d20 225f 223a 0a20  elif m == "_":. 
+0001de60: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001de70: 2073 7472 6561 6d69 6e67 2076 6961 2070   streaming via p
+0001de80: 6970 6520 6f6e 2073 7464 696e 0a20 2020  ipe on stdin.   
+0001de90: 2020 2020 2020 2020 2020 2020 2023 2073               # s
+0001dea0: 7464 696e 2070 6970 652c 2072 6561 6420  tdin pipe, read 
+0001deb0: 616e 6420 7072 6f63 6573 7320 6576 6572  and process ever
+0001dec0: 7974 6869 6e67 2069 6e20 7069 7065 206c  ything in pipe l
+0001ded0: 696e 6520 6279 206c 696e 650a 2020 2020  ine by line.    
+0001dee0: 2020 2020 2020 2020 2020 2020 7374 7265              stre
+0001def0: 616d 696e 6720 3d20 5472 7565 0a20 2020  aming = True.   
+0001df00: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0001df10: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0001df20: 6573 7361 6765 735f 6672 6f6d 5f63 6f6d  essages_from_com
+0001df30: 6d61 6e64 6c69 6e65 202b 3d20 5b6d 5d0a  mandline += [m].
+0001df40: 0a20 2020 2067 732e 6c6f 672e 6465 6275  .    gs.log.debu
+0001df50: 6728 6622 4d65 7373 6167 6573 2066 726f  g(f"Messages fro
+0001df60: 6d20 7069 7065 3a20 2020 2020 2020 2020  m pipe:         
+0001df70: 7b6d 6573 7361 6765 735f 6672 6f6d 5f70  {messages_from_p
+0001df80: 6970 657d 2229 0a20 2020 2067 732e 6c6f  ipe}").    gs.lo
+0001df90: 672e 6465 6275 6728 6622 4d65 7373 6167  g.debug(f"Messag
+0001dfa0: 6573 2066 726f 6d20 6b65 7962 6f61 7264  es from keyboard
+0001dfb0: 3a20 2020 2020 7b6d 6573 7361 6765 735f  :     {messages_
+0001dfc0: 6672 6f6d 5f6b 6579 626f 6172 647d 2229  from_keyboard}")
+0001dfd0: 0a20 2020 2067 732e 6c6f 672e 6465 6275  .    gs.log.debu
+0001dfe0: 6728 6622 4d65 7373 6167 6573 2066 726f  g(f"Messages fro
+0001dff0: 6d20 636f 6d6d 616e 642d 6c69 6e65 3a20  m command-line: 
+0001e000: 7b6d 6573 7361 6765 735f 6672 6f6d 5f63  {messages_from_c
+0001e010: 6f6d 6d61 6e64 6c69 6e65 7d22 290a 0a20  ommandline}").. 
+0001e020: 2020 206d 6573 7361 6765 735f 616c 6c20     messages_all 
+0001e030: 3d20 280a 2020 2020 2020 2020 6d65 7373  = (.        mess
+0001e040: 6167 6573 5f66 726f 6d5f 636f 6d6d 616e  ages_from_comman
+0001e050: 646c 696e 6520 2b20 6d65 7373 6167 6573  dline + messages
+0001e060: 5f66 726f 6d5f 7069 7065 202b 206d 6573  _from_pipe + mes
+0001e070: 7361 6765 735f 6672 6f6d 5f6b 6579 626f  sages_from_keybo
+0001e080: 6172 640a 2020 2020 2920 2023 206b 6579  ard.    )  # key
+0001e090: 626f 6172 6420 6174 2065 6e64 0a0a 2020  board at end..  
+0001e0a0: 2020 2320 6c6f 6f70 2074 6872 7520 616c    # loop thru al
+0001e0b0: 6c20 6d73 6773 2061 6e64 2073 706c 6974  l msgs and split
+0001e0c0: 2074 6865 6d0a 2020 2020 6966 2067 732e   them.    if gs.
+0001e0d0: 7061 2e73 706c 6974 3a0a 2020 2020 2020  pa.split:.      
+0001e0e0: 2020 2320 6773 2e70 612e 7370 6c69 7420    # gs.pa.split 
+0001e0f0: 6361 6e20 6861 7665 2065 7363 6170 6520  can have escape 
+0001e100: 6368 6172 6163 7465 7273 2c20 6974 2068  characters, it h
+0001e110: 6173 2074 6f20 6265 2064 652d 6573 6361  as to be de-esca
+0001e120: 7065 640a 2020 2020 2020 2020 6465 636f  ped.        deco
+0001e130: 6465 645f 7374 7269 6e67 203d 2062 7974  ded_string = byt
+0001e140: 6573 2867 732e 7061 2e73 706c 6974 2c20  es(gs.pa.split, 
+0001e150: 2275 7466 2d38 2229 2e64 6563 6f64 6528  "utf-8").decode(
+0001e160: 2275 6e69 636f 6465 5f65 7363 6170 6522  "unicode_escape"
+0001e170: 290a 2020 2020 2020 2020 6773 2e6c 6f67  ).        gs.log
+0001e180: 2e64 6562 7567 2866 2753 7472 696e 6720  .debug(f'String 
+0001e190: 7573 6564 2066 6f72 2073 706c 6974 7469  used for splitti
+0001e1a0: 6e67 2069 733a 2022 7b64 6563 6f64 6564  ng is: "{decoded
+0001e1b0: 5f73 7472 696e 677d 2227 290a 2020 2020  _string}"').    
+0001e1c0: 2020 2020 6d65 7373 6167 6573 5f61 6c6c      messages_all
+0001e1d0: 5f73 706c 6974 203d 205b 5d0a 2020 2020  _split = [].    
+0001e1e0: 2020 2020 666f 7220 6d20 696e 206d 6573      for m in mes
+0001e1f0: 7361 6765 735f 616c 6c3a 0a20 2020 2020  sages_all:.     
+0001e200: 2020 2020 2020 206d 6573 7361 6765 735f         messages_
+0001e210: 616c 6c5f 7370 6c69 7420 2b3d 206d 2e73  all_split += m.s
+0001e220: 706c 6974 2864 6563 6f64 6564 5f73 7472  plit(decoded_str
+0001e230: 696e 6729 0a20 2020 2065 6c73 653a 2020  ing).    else:  
+0001e240: 2320 6e6f 7420 6773 2e70 612e 7370 6c69  # not gs.pa.spli
+0001e250: 740a 2020 2020 2020 2020 6d65 7373 6167  t.        messag
+0001e260: 6573 5f61 6c6c 5f73 706c 6974 203d 206d  es_all_split = m
+0001e270: 6573 7361 6765 735f 616c 6c0a 0a20 2020  essages_all..   
+0001e280: 2061 7761 6974 2073 656e 645f 6d65 7373   await send_mess
+0001e290: 6167 6573 5f61 6e64 5f66 696c 6573 2863  ages_and_files(c
+0001e2a0: 6c69 656e 742c 2072 6f6f 6d73 2c20 6d65  lient, rooms, me
+0001e2b0: 7373 6167 6573 5f61 6c6c 5f73 706c 6974  ssages_all_split
+0001e2c0: 290a 2020 2020 2320 6e6f 7720 7765 2061  ).    # now we a
+0001e2d0: 7265 2064 6f6e 6520 7769 7468 2061 6c6c  re done with all
+0001e2e0: 2074 6865 2075 7375 616c 2073 656e 6473   the usual sends
+0001e2f0: 2c20 6e6f 7720 7765 2073 7461 7274 2073  , now we start s
+0001e300: 7472 6561 6d69 6e67 0a20 2020 2069 6620  treaming.    if 
+0001e310: 7374 7265 616d 696e 673a 0a20 2020 2020  streaming:.     
+0001e320: 2020 2061 7761 6974 2073 7472 6561 6d5f     await stream_
+0001e330: 6d65 7373 6167 6573 5f66 726f 6d5f 7069  messages_from_pi
+0001e340: 7065 2863 6c69 656e 742c 2072 6f6f 6d73  pe(client, rooms
+0001e350: 290a 0a0a 6173 796e 6320 6465 6620 6c6f  )...async def lo
+0001e360: 6769 6e5f 7573 696e 675f 6372 6564 656e  gin_using_creden
+0001e370: 7469 616c 735f 6669 6c65 280a 2020 2020  tials_file(.    
+0001e380: 6372 6564 656e 7469 616c 735f 6669 6c65  credentials_file
+0001e390: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
+0001e3a0: 3d20 4e6f 6e65 2c20 7374 6f72 655f 6469  = None, store_di
+0001e3b0: 723a 204f 7074 696f 6e61 6c5b 7374 725d  r: Optional[str]
+0001e3c0: 203d 204e 6f6e 650a 2920 2d3e 2028 4173   = None.) -> (As
+0001e3d0: 796e 6343 6c69 656e 742c 2064 6963 7429  yncClient, dict)
+0001e3e0: 3a0a 2020 2020 2222 224c 6f67 2069 6e20  :.    """Log in 
+0001e3f0: 6279 2075 7369 6e67 2061 7661 696c 6162  by using availab
+0001e400: 6c65 2063 7265 6465 6e74 6961 6c73 2066  le credentials f
+0001e410: 696c 652e 0a0a 2020 2020 4172 6775 6d65  ile...    Argume
+0001e420: 6e74 733a 0a20 2020 202d 2d2d 2d2d 2d2d  nts:.    -------
+0001e430: 2d2d 0a20 2020 2020 2020 2063 7265 6465  --.        crede
+0001e440: 6e74 6961 6c73 5f66 696c 653a 2073 7472  ntials_file: str
+0001e450: 203a 206c 6f63 6174 696f 6e20 6f66 2063   : location of c
+0001e460: 7265 6465 6e74 6961 6c73 2066 696c 650a  redentials file.
+0001e470: 2020 2020 2020 2020 2020 2020 636f 6d70              comp
+0001e480: 7574 6520 6974 2069 6620 6e6f 7420 7072  ute it if not pr
+0001e490: 6f76 6964 6564 0a20 2020 2020 2020 2073  ovided.        s
+0001e4a0: 746f 7265 5f64 6972 3a20 7374 7220 3a20  tore_dir: str : 
+0001e4b0: 6c6f 6361 7469 6f6e 206f 6620 7065 7273  location of pers
+0001e4c0: 6973 7465 6e74 2073 746f 7261 6765 2073  istent storage s
+0001e4d0: 746f 7265 2064 6972 6563 746f 7279 0a20  tore directory. 
+0001e4e0: 2020 2020 2020 2020 2020 2063 6f6d 7075             compu
+0001e4f0: 7465 2069 7420 6966 206e 6f74 2070 726f  te it if not pro
+0001e500: 7669 6465 640a 0a20 2020 2052 6574 7572  vided..    Retur
+0001e510: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
+0001e520: 2020 2020 2020 2041 7379 6e63 436c 6965         AsyncClie
+0001e530: 6e74 203a 2074 6865 2063 7265 6174 6564  nt : the created
+0001e540: 204e 494f 2063 6c69 656e 740a 2020 2020   NIO client.    
+0001e550: 2020 2020 6469 6374 203a 2074 6865 2063      dict : the c
+0001e560: 7265 6465 6e74 6961 6c73 2064 6963 7469  redentials dicti
+0001e570: 6f6e 6172 7920 6672 6f6d 2074 6865 2063  onary from the c
+0001e580: 7265 6465 6e74 6961 6c73 2066 696c 650a  redentials file.
+0001e590: 0a20 2020 2022 2222 0a0a 2020 2020 6966  .    """..    if
+0001e5a0: 206e 6f74 2063 7265 6465 6e74 6961 6c73   not credentials
+0001e5b0: 5f66 696c 653a 0a20 2020 2020 2020 2063  _file:.        c
+0001e5c0: 7265 6465 6e74 6961 6c73 5f66 696c 6520  redentials_file 
+0001e5d0: 3d20 6465 7465 726d 696e 655f 6372 6564  = determine_cred
+0001e5e0: 656e 7469 616c 735f 6669 6c65 2829 0a20  entials_file(). 
+0001e5f0: 2020 2069 6620 6e6f 7420 7374 6f72 655f     if not store_
+0001e600: 6469 723a 0a20 2020 2020 2020 2073 746f  dir:.        sto
+0001e610: 7265 5f64 6972 203d 2064 6574 6572 6d69  re_dir = determi
+0001e620: 6e65 5f73 746f 7265 5f64 6972 2829 0a0a  ne_store_dir()..
+0001e630: 2020 2020 6966 206e 6f74 2063 7265 6465      if not crede
+0001e640: 6e74 6961 6c73 5f65 7869 7374 2863 7265  ntials_exist(cre
+0001e650: 6465 6e74 6961 6c73 5f66 696c 6529 3a0a  dentials_file):.
+0001e660: 2020 2020 2020 2020 7261 6973 6520 4d61          raise Ma
+0001e670: 7472 6978 436f 6d6d 616e 6465 7245 7272  trixCommanderErr
+0001e680: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+0001e690: 2245 3135 333a 2022 0a20 2020 2020 2020  "E153: ".       
+0001e6a0: 2020 2020 2022 4372 6564 656e 7469 616c       "Credential
+0001e6b0: 7320 6669 6c65 2077 6173 206e 6f74 2066  s file was not f
+0001e6c0: 6f75 6e64 2e20 5072 6f76 6964 6520 6372  ound. Provide cr
+0001e6d0: 6564 656e 7469 616c 7320 6669 6c65 206f  edentials file o
+0001e6e0: 7220 220a 2020 2020 2020 2020 2020 2020  r ".            
+0001e6f0: 2275 7365 202d 2d6c 6f67 696e 2074 6f20  "use --login to 
+0001e700: 6372 6561 7465 2061 2063 7265 6465 6e74  create a credent
+0001e710: 6961 6c73 2066 696c 652e 220a 2020 2020  ials file.".    
+0001e720: 2020 2020 2920 6672 6f6d 204e 6f6e 650a      ) from None.
+0001e730: 2020 2020 6966 206e 6f74 2073 746f 7265      if not store
+0001e740: 5f65 7869 7374 7328 7374 6f72 655f 6469  _exists(store_di
+0001e750: 7229 3a0a 2020 2020 2020 2020 7261 6973  r):.        rais
+0001e760: 6520 4d61 7472 6978 436f 6d6d 616e 6465  e MatrixCommande
+0001e770: 7245 7272 6f72 280a 2020 2020 2020 2020  rError(.        
+0001e780: 2020 2020 2245 3135 343a 2022 0a20 2020      "E154: ".   
+0001e790: 2020 2020 2020 2020 2022 5374 6f72 6520           "Store 
+0001e7a0: 6469 7265 6374 6f72 7920 7761 7320 6e6f  directory was no
+0001e7b0: 7420 666f 756e 642e 2050 726f 7669 6465  t found. Provide
+0001e7c0: 2073 746f 7265 2064 6972 6563 746f 7279   store directory
+0001e7d0: 206f 7220 220a 2020 2020 2020 2020 2020   or ".          
+0001e7e0: 2020 2275 7365 202d 2d6c 6f67 696e 2074    "use --login t
+0001e7f0: 6f20 6372 6561 7465 2061 2073 746f 7265  o create a store
+0001e800: 2064 6972 6563 746f 7279 2e22 0a20 2020   directory.".   
+0001e810: 2020 2020 2029 2066 726f 6d20 4e6f 6e65       ) from None
+0001e820: 0a0a 2020 2020 6372 6564 656e 7469 616c  ..    credential
+0001e830: 7320 3d20 7265 6164 5f63 7265 6465 6e74  s = read_credent
+0001e840: 6961 6c73 5f66 726f 6d5f 6469 736b 2863  ials_from_disk(c
+0001e850: 7265 6465 6e74 6961 6c73 5f66 696c 6529  redentials_file)
+0001e860: 0a20 2020 2067 732e 6372 6564 656e 7469  .    gs.credenti
+0001e870: 616c 7320 3d20 6372 6564 656e 7469 616c  als = credential
+0001e880: 730a 0a20 2020 2067 732e 6c6f 672e 6465  s..    gs.log.de
+0001e890: 6275 6728 2241 626f 7574 2074 6f20 636f  bug("About to co
+0001e8a0: 6e66 6967 7572 6520 4d61 7472 6978 2041  nfigure Matrix A
+0001e8b0: 7379 6e63 2043 6c69 656e 742e 2229 0a20  sync Client."). 
+0001e8c0: 2020 2023 2043 6f6e 6669 6775 7261 7469     # Configurati
+0001e8d0: 6f6e 206f 7074 696f 6e73 2066 6f72 2074  on options for t
+0001e8e0: 6865 2041 7379 6e63 436c 6965 6e74 0a20  he AsyncClient. 
+0001e8f0: 2020 2063 6c69 656e 745f 636f 6e66 6967     client_config
+0001e900: 203d 2041 7379 6e63 436c 6965 6e74 436f   = AsyncClientCo
+0001e910: 6e66 6967 280a 2020 2020 2020 2020 6d61  nfig(.        ma
+0001e920: 785f 6c69 6d69 745f 6578 6365 6564 6564  x_limit_exceeded
+0001e930: 3d30 2c0a 2020 2020 2020 2020 6d61 785f  =0,.        max_
+0001e940: 7469 6d65 6f75 7473 3d30 2c0a 2020 2020  timeouts=0,.    
+0001e950: 2020 2020 7374 6f72 655f 7379 6e63 5f74      store_sync_t
+0001e960: 6f6b 656e 733d 5472 7565 2c0a 2020 2020  okens=True,.    
+0001e970: 2020 2020 656e 6372 7970 7469 6f6e 5f65      encryption_e
+0001e980: 6e61 626c 6564 3d54 7275 652c 0a20 2020  nabled=True,.   
+0001e990: 2029 0a20 2020 2067 732e 6c6f 672e 6465   ).    gs.log.de
+0001e9a0: 6275 6728 2241 626f 7574 2074 6f20 696e  bug("About to in
+0001e9b0: 6974 6961 6c69 7a65 204d 6174 7269 7820  itialize Matrix 
+0001e9c0: 4173 796e 6320 436c 6965 6e74 2e22 290a  Async Client.").
+0001e9d0: 2020 2020 2320 496e 6974 6961 6c69 7a65      # Initialize
+0001e9e0: 2074 6865 206d 6174 7269 7820 636c 6965   the matrix clie
+0001e9f0: 6e74 2062 6173 6564 206f 6e20 6372 6564  nt based on cred
+0001ea00: 656e 7469 616c 7320 6672 6f6d 2066 696c  entials from fil
+0001ea10: 650a 2020 2020 636c 6965 6e74 203d 2041  e.    client = A
+0001ea20: 7379 6e63 436c 6965 6e74 280a 2020 2020  syncClient(.    
+0001ea30: 2020 2020 6372 6564 656e 7469 616c 735b      credentials[
+0001ea40: 2268 6f6d 6573 6572 7665 7222 5d2c 0a20  "homeserver"],. 
+0001ea50: 2020 2020 2020 2063 7265 6465 6e74 6961         credentia
+0001ea60: 6c73 5b22 7573 6572 5f69 6422 5d2c 0a20  ls["user_id"],. 
+0001ea70: 2020 2020 2020 2064 6576 6963 655f 6964         device_id
+0001ea80: 3d63 7265 6465 6e74 6961 6c73 5b22 6465  =credentials["de
+0001ea90: 7669 6365 5f69 6422 5d2c 0a20 2020 2020  vice_id"],.     
+0001eaa0: 2020 2073 746f 7265 5f70 6174 683d 7374     store_path=st
+0001eab0: 6f72 655f 6469 722c 0a20 2020 2020 2020  ore_dir,.       
+0001eac0: 2063 6f6e 6669 673d 636c 6965 6e74 5f63   config=client_c
+0001ead0: 6f6e 6669 672c 0a20 2020 2020 2020 2073  onfig,.        s
+0001eae0: 736c 3d67 732e 7373 6c2c 0a20 2020 2020  sl=gs.ssl,.     
+0001eaf0: 2020 2070 726f 7879 3d67 732e 7061 2e70     proxy=gs.pa.p
+0001eb00: 726f 7879 2c0a 2020 2020 290a 2020 2020  roxy,.    ).    
+0001eb10: 6966 2067 732e 7061 2e70 726f 7879 3a0a  if gs.pa.proxy:.
+0001eb20: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+0001eb30: 6562 7567 2866 2250 726f 7879 207b 6773  ebug(f"Proxy {gs
+0001eb40: 2e70 612e 7072 6f78 797d 2077 696c 6c20  .pa.proxy} will 
+0001eb50: 6265 2075 7365 6420 666f 7220 636f 6e6e  be used for conn
+0001eb60: 6563 7469 7669 7479 2e22 290a 0a20 2020  ectivity.")..   
+0001eb70: 2067 732e 6c6f 672e 6465 6275 6728 2241   gs.log.debug("A
+0001eb80: 626f 7574 2074 6f20 7265 7374 6f72 6520  bout to restore 
+0001eb90: 6c6f 6769 6e2e 2229 0a20 2020 2023 2072  login.").    # r
+0001eba0: 6573 746f 7265 5f6c 6f67 696e 2829 2061  estore_login() a
+0001ebb0: 6c77 6179 7320 7265 7475 726e 7320 4e6f  lways returns No
+0001ebc0: 6e65 2c20 6f6e 2073 7563 6365 7373 206f  ne, on success o
+0001ebd0: 7220 6661 696c 7572 650a 2020 2020 2320  r failure.    # 
+0001ebe0: 7265 7374 6f72 655f 6c6f 6769 6e28 2920  restore_login() 
+0001ebf0: 646f 6573 206e 6f74 2067 6f20 746f 2074  does not go to t
+0001ec00: 6865 2073 6572 7665 722c 2069 7420 6a75  he server, it ju
+0001ec10: 7374 2073 6574 7320 736f 6d65 206c 6f63  st sets some loc
+0001ec20: 616c 2076 616c 7565 730a 2020 2020 2320  al values.    # 
+0001ec30: 544f 444f 3a20 7065 7266 6f72 6d61 6e63  TODO: performanc
+0001ec40: 650a 2020 2020 2320 7265 7374 6f72 655f  e.    # restore_
+0001ec50: 6c6f 6769 6e28 2920 6973 2061 2073 6c6f  login() is a slo
+0001ec60: 7720 6f70 6572 6174 696f 6e2e 2031 2e35  w operation. 1.5
+0001ec70: 7320 746f 2032 732e 2057 6879 3f0a 2020  s to 2s. Why?.  
+0001ec80: 2020 2320 4265 6361 7573 6520 6974 2069    # Because it i
+0001ec90: 7320 7265 6164 696e 6720 7468 6520 7374  s reading the st
+0001eca0: 6f72 6520 6669 6c65 2064 6174 6162 6173  ore file databas
+0001ecb0: 652e 0a20 2020 2023 2053 6574 7469 6e67  e..    # Setting
+0001ecc0: 2073 746f 7265 5f73 796e 635f 746f 6b65   store_sync_toke
+0001ecd0: 6e73 3d46 616c 7365 2061 626f 7665 2077  ns=False above w
+0001ece0: 696c 6c20 6e6f 7420 6d61 6b65 2069 7420  ill not make it 
+0001ecf0: 676f 2061 6e79 2066 6173 7465 722e 0a20  go any faster.. 
+0001ed00: 2020 2063 6c69 656e 742e 7265 7374 6f72     client.restor
+0001ed10: 655f 6c6f 6769 6e28 0a20 2020 2020 2020  e_login(.       
+0001ed20: 2075 7365 725f 6964 3d63 7265 6465 6e74   user_id=credent
+0001ed30: 6961 6c73 5b22 7573 6572 5f69 6422 5d2c  ials["user_id"],
+0001ed40: 0a20 2020 2020 2020 2064 6576 6963 655f  .        device_
+0001ed50: 6964 3d63 7265 6465 6e74 6961 6c73 5b22  id=credentials["
+0001ed60: 6465 7669 6365 5f69 6422 5d2c 0a20 2020  device_id"],.   
+0001ed70: 2020 2020 2061 6363 6573 735f 746f 6b65       access_toke
+0001ed80: 6e3d 6372 6564 656e 7469 616c 735b 2261  n=credentials["a
+0001ed90: 6363 6573 735f 746f 6b65 6e22 5d2c 0a20  ccess_token"],. 
+0001eda0: 2020 2029 0a20 2020 2067 732e 6c6f 672e     ).    gs.log.
+0001edb0: 6465 6275 6728 2246 696e 6973 6865 6420  debug("Finished 
+0001edc0: 7265 7374 6f72 696e 6720 6c6f 6769 6e2e  restoring login.
+0001edd0: 2229 0a20 2020 2067 732e 6c6f 672e 6465  ").    gs.log.de
+0001ede0: 6275 6728 0a20 2020 2020 2020 2022 4c6f  bug(.        "Lo
+0001edf0: 6769 6e20 7769 6c6c 2062 6520 7573 696e  gin will be usin
+0001ee00: 6720 7374 6f72 6564 2063 7265 6465 6e74  g stored credent
+0001ee10: 6961 6c73 2066 726f 6d20 220a 2020 2020  ials from ".    
+0001ee20: 2020 2020 6627 6372 6564 656e 7469 616c      f'credential
+0001ee30: 7320 6669 6c65 2022 7b63 7265 6465 6e74  s file "{credent
+0001ee40: 6961 6c73 5f66 696c 657d 222e 2027 0a20  ials_file}". '. 
+0001ee50: 2020 2020 2020 2066 2772 6f6f 6d5f 6964         f'room_id
+0001ee60: 203d 207b 6372 6564 656e 7469 616c 735b   = {credentials[
+0001ee70: 2272 6f6f 6d5f 6964 225d 7d2c 2027 0a20  "room_id"]}, '. 
+0001ee80: 2020 2020 2020 2066 2764 6576 6963 655f         f'device_
+0001ee90: 6964 203d 207b 6372 6564 656e 7469 616c  id = {credential
+0001eea0: 735b 2264 6576 6963 655f 6964 225d 7d2c  s["device_id"]},
+0001eeb0: 2027 0a20 2020 2020 2020 2066 2761 6363   '.        f'acc
+0001eec0: 6573 735f 746f 6b65 6e20 3d20 7b63 7265  ess_token = {cre
+0001eed0: 6465 6e74 6961 6c73 5b22 6163 6365 7373  dentials["access
+0001eee0: 5f74 6f6b 656e 225d 5b30 3a31 5d7d 2a2a  _token"][0:1]}**
+0001eef0: 2a27 0a20 2020 2020 2020 2066 277b 6372  *'.        f'{cr
+0001ef00: 6564 656e 7469 616c 735b 2261 6363 6573  edentials["acces
+0001ef10: 735f 746f 6b65 6e22 5d5b 2d31 3a5d 7d2e  s_token"][-1:]}.
+0001ef20: 270a 2020 2020 290a 2020 2020 6966 2067  '.    ).    if g
+0001ef30: 732e 7061 2e64 6562 7567 203e 2030 3a0a  s.pa.debug > 0:.
+0001ef40: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+0001ef50: 6562 7567 2822 4162 6f75 7420 746f 2063  ebug("About to c
+0001ef60: 6f6e 6e65 6374 2074 6f20 7365 7276 6572  onnect to server
+0001ef70: 2074 6f20 7665 7269 6679 2063 6f6e 6e65   to verify conne
+0001ef80: 6374 696f 6e2e 2229 0a20 2020 2020 2020  ction.").       
+0001ef90: 2023 2067 732e 6c6f 672e 6465 6275 6728   # gs.log.debug(
+0001efa0: 6622 4c6f 6767 6564 5f69 6e28 293d 7b63  f"Logged_in()={c
+0001efb0: 6c69 656e 742e 6c6f 6767 6564 5f69 6e7d  lient.logged_in}
+0001efc0: 2229 2069 7320 616c 7761 7973 2054 7275  ") is always Tru
+0001efd0: 652e 0a20 2020 2020 2020 2023 204a 7573  e..        # Jus
+0001efe0: 7420 6265 6361 7573 6520 636c 6965 6e74  t because client
+0001eff0: 2e6c 6f67 6765 645f 696e 2069 7320 5472  .logged_in is Tr
+0001f000: 7565 2064 6f65 7320 6e6f 7420 6d65 616e  ue does not mean
+0001f010: 2077 6520 6172 6520 6c6f 6767 6564 2069   we are logged i
+0001f020: 6e2e 0a20 2020 2020 2020 2023 2054 6861  n..        # Tha
+0001f030: 7420 6a75 7374 206d 6561 6e73 2074 6865  t just means the
+0001f040: 2064 6174 6120 7374 7275 6374 7572 6520   data structure 
+0001f050: 6973 2066 696c 6c65 642e 0a20 2020 2020  is filled..     
+0001f060: 2020 2023 2048 6f77 2074 6f20 6b6e 6f77     # How to know
+0001f070: 2069 6620 6c6f 6769 6e20 7761 7320 7375   if login was su
+0001f080: 6363 6573 7366 756c 3f0a 2020 2020 2020  ccessful?.      
+0001f090: 2020 2320 446f 2061 6e20 6163 7475 616c    # Do an actual
+0001f0a0: 2041 5049 2063 616c 6c20 6167 6169 6e73   API call agains
+0001f0b0: 7420 7468 6520 7365 7276 6572 2e20 452e  t the server. E.
+0001f0c0: 672e 2077 686f 616d 692e 0a20 2020 2020  g. whoami..     
+0001f0d0: 2020 2023 2057 6520 646f 6e27 7420 7761     # We don't wa
+0001f0e0: 6e74 2074 6f20 646f 2074 6869 7320 616c  nt to do this al
+0001f0f0: 7761 7973 2066 6f72 2070 6572 666f 726d  ways for perform
+0001f100: 616e 6365 2072 6561 736f 6e73 2c20 736f  ance reasons, so
+0001f110: 2077 6520 6f6e 6c79 0a20 2020 2020 2020   we only.       
+0001f120: 2023 2064 6f20 6974 2069 6e20 6465 6275   # do it in debu
+0001f130: 6720 6d6f 6465 2e0a 2020 2020 2020 2020  g mode..        
+0001f140: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0001f150: 2072 6573 7020 3d20 6177 6169 7420 636c   resp = await cl
+0001f160: 6965 6e74 2e77 686f 616d 6928 290a 2020  ient.whoami().  
+0001f170: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+0001f180: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
+0001f190: 2020 2020 2020 2020 2061 7761 6974 2063           await c
+0001f1a0: 6c69 656e 742e 636c 6f73 6528 290a 2020  lient.close().  
+0001f1b0: 2020 2020 2020 2020 2020 636c 6965 6e74            client
+0001f1c0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+0001f1d0: 2020 2020 6372 6564 656e 7469 616c 7320      credentials 
+0001f1e0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
+0001f1f0: 2020 2072 6169 7365 2028 6529 0a20 2020     raise (e).   
+0001f200: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+0001f210: 6365 2872 6573 702c 2072 6573 706f 6e73  ce(resp, respons
+0001f220: 6573 2e57 686f 616d 6945 7272 6f72 293a  es.WhoamiError):
+0001f230: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+0001f240: 6c6f 672e 6572 726f 7228 0a20 2020 2020  log.error(.     
+0001f250: 2020 2020 2020 2020 2020 2022 4531 3535             "E155
+0001f260: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
+0001f270: 2020 2020 2272 6573 746f 7265 5f6c 6f67      "restore_log
+0001f280: 696e 2066 6169 6c65 642e 2044 6964 2079  in failed. Did y
+0001f290: 6f75 2070 6572 666f 726d 202d 2d6c 6f67  ou perform --log
+0001f2a0: 6f75 7420 220a 2020 2020 2020 2020 2020  out ".          
+0001f2b0: 2020 2020 2020 2262 6566 6f72 653f 204c        "before? L
+0001f2c0: 6f6f 6b73 206c 696b 6520 796f 7572 2061  ooks like your a
+0001f2d0: 6363 6573 732d 746f 6b65 6e20 6578 7069  ccess-token expi
+0001f2e0: 7265 642e 204d 6179 6265 2022 0a20 2020  red. Maybe ".   
+0001f2f0: 2020 2020 2020 2020 2020 2020 2022 6465               "de
+0001f300: 6c65 7465 2063 7265 6465 6e74 6961 6c73  lete credentials
+0001f310: 2066 696c 6520 616e 6420 7374 6f72 6520   file and store 
+0001f320: 616e 6420 7065 7266 6f72 6d20 6120 220a  and perform a ".
+0001f330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f340: 6622 6e65 7720 2d2d 6c6f 6769 6e2e 2052  f"new --login. R
+0001f350: 6573 706f 6e73 6520 6973 3a20 7b70 7269  esponse is: {pri
+0001f360: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
+0001f370: 7265 7370 2929 7d22 0a20 2020 2020 2020  resp))}".       
+0001f380: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0001f390: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
+0001f3a0: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
+0001f3b0: 2061 7761 6974 2063 6c69 656e 742e 636c   await client.cl
+0001f3c0: 6f73 6528 290a 2020 2020 2020 2020 2020  ose().          
+0001f3d0: 2020 636c 6965 6e74 203d 204e 6f6e 650a    client = None.
+0001f3e0: 2020 2020 2020 2020 2020 2020 6372 6564              cred
+0001f3f0: 656e 7469 616c 7320 3d20 4e6f 6e65 0a20  entials = None. 
+0001f400: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0001f410: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
+0001f420: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
+0001f430: 2020 2020 2020 2022 7265 7374 6f72 655f         "restore_
+0001f440: 6c6f 6769 6e20 7375 6363 6573 7366 756c  login successful
+0001f450: 2e20 5375 6363 6573 7366 756c 6c79 2022  . Successfully "
+0001f460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001f470: 2066 226c 6f67 6765 6420 696e 2061 7320   f"logged in as 
+0001f480: 7573 6572 207b 7265 7370 2e75 7365 725f  user {resp.user_
+0001f490: 6964 7d20 7669 6120 7265 7374 6f72 655f  id} via restore_
+0001f4a0: 6c6f 6769 6e2e 2022 0a20 2020 2020 2020  login. ".       
+0001f4b0: 2020 2020 2020 2020 2066 2252 6573 706f           f"Respo
+0001f4c0: 6e73 6520 6973 3a20 7b70 7269 7661 6379  nse is: {privacy
+0001f4d0: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
+0001f4e0: 2929 7d22 0a20 2020 2020 2020 2020 2020  ))}".           
+0001f4f0: 2029 0a20 2020 2065 6c73 653a 0a20 2020   ).    else:.   
+0001f500: 2020 2020 2070 6173 730a 2020 2020 2020       pass.      
+0001f510: 2020 2320 6c6f 6769 6e20 6d69 6768 7420    # login might 
+0001f520: 6f72 206d 6967 6874 206e 6f74 2066 6169  or might not fai
+0001f530: 6c20 6c61 7465 722c 0a20 2020 2020 2020  l later,.       
+0001f540: 2023 2069 6620 6974 2066 6169 6c73 2073   # if it fails s
+0001f550: 6f6d 6520 6578 6365 7074 696f 6e20 7769  ome exception wi
+0001f560: 6c6c 2062 6520 7261 6973 6564 2c20 7468  ll be raised, th
+0001f570: 6520 6578 6365 7074 696f 6e20 7465 7874  e exception text
+0001f580: 0a20 2020 2020 2020 2023 206d 6967 6874  .        # might
+0001f590: 206e 6f74 2065 7870 6c61 696e 2074 6865   not explain the
+0001f5a0: 2070 726f 626c 656d 2077 656c 6c2c 2062   problem well, b
+0001f5b0: 7574 2074 6869 7320 7761 7920 7765 2073  ut this way we s
+0001f5c0: 7065 6564 2075 700a 2020 2020 2020 2020  peed up.        
+0001f5d0: 2320 7065 7266 6f72 6d61 6e63 6520 6279  # performance by
+0001f5e0: 2069 7373 7569 6e67 206f 6e65 2041 5049   issuing one API
+0001f5f0: 206c 6573 7320 6167 6169 6e73 7420 7468   less against th
+0001f600: 6520 7365 7276 6572 2e0a 2020 2020 7265  e server..    re
+0001f610: 7475 726e 2028 636c 6965 6e74 2c20 6372  turn (client, cr
+0001f620: 6564 656e 7469 616c 7329 0a0a 0a61 7379  edentials)...asy
+0001f630: 6e63 2064 6566 206c 6973 7465 6e5f 666f  nc def listen_fo
+0001f640: 7265 7665 7228 636c 6965 6e74 3a20 4173  rever(client: As
+0001f650: 796e 6343 6c69 656e 7429 202d 3e20 4e6f  yncClient) -> No
+0001f660: 6e65 3a0a 2020 2020 2222 224c 6973 7465  ne:.    """Liste
+0001f670: 6e20 666f 7265 7665 7220 6f72 2075 6e74  n forever or unt
+0001f680: 696c 2043 6f6e 7472 6f6c 2d43 2e22 2222  il Control-C."""
+0001f690: 0a20 2020 2023 2053 6574 2075 7020 6576  .    # Set up ev
+0001f6a0: 656e 7420 6361 6c6c 6261 636b 730a 2020  ent callbacks.  
+0001f6b0: 2020 6361 6c6c 6261 636b 7320 3d20 4361    callbacks = Ca
+0001f6c0: 6c6c 6261 636b 7328 636c 6965 6e74 290a  llbacks(client).
+0001f6d0: 2020 2020 636c 6965 6e74 2e61 6464 5f65      client.add_e
+0001f6e0: 7665 6e74 5f63 616c 6c62 6163 6b28 0a20  vent_callback(. 
+0001f6f0: 2020 2020 2020 2063 616c 6c62 6163 6b73         callbacks
+0001f700: 2e6d 6573 7361 6765 5f63 616c 6c62 6163  .message_callbac
+0001f710: 6b2c 0a20 2020 2020 2020 2028 0a20 2020  k,.        (.   
+0001f720: 2020 2020 2020 2020 2052 6f6f 6d4d 6573           RoomMes
+0001f730: 7361 6765 2c0a 2020 2020 2020 2020 2020  sage,.          
+0001f740: 2020 5265 6461 6374 6564 4576 656e 742c    RedactedEvent,
+0001f750: 0a20 2020 2020 2020 2020 2020 2052 6564  .            Red
+0001f760: 6163 7469 6f6e 4576 656e 742c 0a20 2020  actionEvent,.   
+0001f770: 2020 2020 2029 2c0a 2020 2020 290a 2020       ),.    ).  
+0001f780: 2020 7072 696e 7428 0a20 2020 2020 2020    print(.       
+0001f790: 2022 5468 6973 2070 726f 6772 616d 2069   "This program i
+0001f7a0: 7320 7265 6164 7920 616e 6420 6c69 7374  s ready and list
+0001f7b0: 656e 696e 6720 666f 7220 6974 7320 4d61  ening for its Ma
+0001f7c0: 7472 6978 206d 6573 7361 6765 732e 2022  trix messages. "
+0001f7d0: 0a20 2020 2020 2020 2022 546f 2073 746f  .        "To sto
+0001f7e0: 7020 7072 6f67 7261 6d20 7479 7065 2043  p program type C
+0001f7f0: 6f6e 7472 6f6c 2d43 206f 6e20 6b65 7962  ontrol-C on keyb
+0001f800: 6f61 7264 206f 7220 7365 6e64 2073 6967  oard or send sig
+0001f810: 6e61 6c20 220a 2020 2020 2020 2020 6622  nal ".        f"
+0001f820: 746f 2070 726f 6365 7373 207b 6f73 2e67  to process {os.g
+0001f830: 6574 7069 6428 297d 2e20 5049 4420 6361  etpid()}. PID ca
+0001f840: 6e20 616c 736f 2062 6520 666f 756e 6420  n also be found 
+0001f850: 696e 2022 0a20 2020 2020 2020 2066 2766  in ".        f'f
+0001f860: 696c 6520 227b 5049 445f 4649 4c45 5f44  ile "{PID_FILE_D
+0001f870: 4546 4155 4c54 7d22 2e27 2c0a 2020 2020  EFAULT}".',.    
+0001f880: 2020 2020 6669 6c65 3d73 7973 2e73 7464      file=sys.std
+0001f890: 6572 722c 0a20 2020 2020 2020 2066 6c75  err,.        flu
+0001f8a0: 7368 3d54 7275 652c 0a20 2020 2029 0a20  sh=True,.    ). 
+0001f8b0: 2020 2023 2074 6865 2073 796e 635f 6c6f     # the sync_lo
+0001f8c0: 6f70 2077 696c 6c20 6265 2074 6572 6d69  op will be termi
+0001f8d0: 6e61 7465 6420 6279 2075 7365 7220 6869  nated by user hi
+0001f8e0: 7474 696e 6720 436f 6e74 726f 6c2d 4320  tting Control-C 
+0001f8f0: 746f 2073 746f 700a 2020 2020 6177 6169  to stop.    awai
+0001f900: 7420 636c 6965 6e74 2e73 796e 635f 666f  t client.sync_fo
+0001f910: 7265 7665 7228 7469 6d65 6f75 743d 3330  rever(timeout=30
+0001f920: 3030 302c 2066 756c 6c5f 7374 6174 653d  000, full_state=
+0001f930: 5472 7565 290a 0a0a 6173 796e 6320 6465  True)...async de
+0001f940: 6620 6c69 7374 656e 5f6f 6e63 6528 636c  f listen_once(cl
+0001f950: 6965 6e74 3a20 4173 796e 6343 6c69 656e  ient: AsyncClien
+0001f960: 7429 202d 3e20 4e6f 6e65 3a0a 2020 2020  t) -> None:.    
+0001f970: 2222 224c 6973 7465 6e20 6f6e 6365 2c20  """Listen once, 
+0001f980: 7468 656e 2071 7569 742e 0a0a 2020 2020  then quit...    
+0001f990: 4765 7420 616c 6c20 7468 6520 6d65 7373  Get all the mess
+0001f9a0: 6167 6573 2074 6861 7420 6172 6520 6375  ages that are cu
+0001f9b0: 7272 656e 746c 7920 7175 6575 6564 2075  rrently queued u
+0001f9c0: 7020 616e 6420 7761 6974 696e 672e 0a20  p and waiting.. 
+0001f9d0: 2020 2050 7269 6e74 2074 6865 6d2e 2054     Print them. T
+0001f9e0: 6865 6e20 6c65 6176 652e 0a20 2020 2022  hen leave..    "
+0001f9f0: 2222 0a20 2020 2023 2053 6574 2075 7020  "".    # Set up 
+0001fa00: 6576 656e 7420 6361 6c6c 6261 636b 730a  event callbacks.
+0001fa10: 2020 2020 6361 6c6c 6261 636b 7320 3d20      callbacks = 
+0001fa20: 4361 6c6c 6261 636b 7328 636c 6965 6e74  Callbacks(client
+0001fa30: 290a 2020 2020 636c 6965 6e74 2e61 6464  ).    client.add
+0001fa40: 5f65 7665 6e74 5f63 616c 6c62 6163 6b28  _event_callback(
+0001fa50: 6361 6c6c 6261 636b 732e 6d65 7373 6167  callbacks.messag
+0001fa60: 655f 6361 6c6c 6261 636b 2c20 2852 6f6f  e_callback, (Roo
+0001fa70: 6d4d 6573 7361 6765 2c29 290a 2020 2020  mMessage,)).    
+0001fa80: 2320 5765 2077 616e 7420 746f 2067 6574  # We want to get
+0001fa90: 206f 7574 2071 7569 636b 6c79 2c20 736f   out quickly, so
+0001faa0: 2077 6520 7265 6475 6365 6420 7469 6d65   we reduced time
+0001fab0: 6f75 7420 746f 2031 3020 7365 632e 0a20  out to 10 sec.. 
+0001fac0: 2020 2023 2057 6520 7761 6e74 2074 6f20     # We want to 
+0001fad0: 6765 7420 6d65 7373 6167 6573 2061 6e64  get messages and
+0001fae0: 2071 7569 742c 2073 6f20 7765 2063 616c   quit, so we cal
+0001faf0: 6c20 7379 6e63 2829 2069 6e73 7465 6164  l sync() instead
+0001fb00: 206f 660a 2020 2020 2320 7379 6e63 5f66   of.    # sync_f
+0001fb10: 6f72 6576 6572 2829 2e0a 2020 2020 7265  orever()..    re
+0001fb20: 7370 203d 2061 7761 6974 2063 6c69 656e  sp = await clien
+0001fb30: 742e 7379 6e63 2874 696d 656f 7574 3d31  t.sync(timeout=1
+0001fb40: 3030 3030 2c20 6675 6c6c 5f73 7461 7465  0000, full_state
+0001fb50: 3d46 616c 7365 290a 2020 2020 6966 2069  =False).    if i
+0001fb60: 7369 6e73 7461 6e63 6528 7265 7370 2c20  sinstance(resp, 
+0001fb70: 5379 6e63 5265 7370 6f6e 7365 293a 0a20  SyncResponse):. 
+0001fb80: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+0001fb90: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
+0001fba0: 2066 2253 796e 6320 7375 6363 6573 7366   f"Sync successf
+0001fbb0: 756c 2e20 5265 7370 6f6e 7365 2069 733a  ul. Response is:
+0001fbc0: 207b 7072 6976 6163 795f 6669 6c74 6572   {privacy_filter
+0001fbd0: 2873 7472 2872 6573 7029 297d 220a 2020  (str(resp))}".  
+0001fbe0: 2020 2020 2020 290a 2020 2020 656c 7365        ).    else
+0001fbf0: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
+0001fc00: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
+0001fc10: 2020 2020 2245 3136 303a 2022 2066 2253      "E160: " f"S
+0001fc20: 796e 6320 6661 696c 6564 2e20 4572 726f  ync failed. Erro
+0001fc30: 7220 6973 3a20 7b70 7269 7661 6379 5f66  r is: {privacy_f
+0001fc40: 696c 7465 7228 7374 7228 7265 7370 2929  ilter(str(resp))
+0001fc50: 7d22 0a20 2020 2020 2020 2029 0a20 2020  }".        ).   
+0001fc60: 2023 2073 796e 6328 2920 666f 7263 6573   # sync() forces
+0001fc70: 2074 6865 206d 6573 7361 6765 5f63 616c   the message_cal
+0001fc80: 6c62 6163 6b28 2920 746f 2066 6972 650a  lback() to fire.
+0001fc90: 2020 2020 2320 666f 7220 6561 6368 206e      # for each n
+0001fca0: 6577 206d 6573 7361 6765 2070 7265 7365  ew message prese
+0001fcb0: 6e74 6564 2069 6e20 7468 6520 7379 6e63  nted in the sync
+0001fcc0: 2829 2e0a 0a0a 6173 796e 6320 6465 6620  ()....async def 
+0001fcd0: 6c69 7374 656e 5f6f 6e63 655f 616c 7465  listen_once_alte
+0001fce0: 726e 6174 6976 6528 636c 6965 6e74 3a20  rnative(client: 
+0001fcf0: 4173 796e 6343 6c69 656e 7429 202d 3e20  AsyncClient) -> 
+0001fd00: 4e6f 6e65 3a0a 2020 2020 2222 224c 6973  None:.    """Lis
+0001fd10: 7465 6e20 6f6e 6365 2c20 7468 656e 2071  ten once, then q
+0001fd20: 7569 742e 0a0a 2020 2020 4765 7420 616c  uit...    Get al
+0001fd30: 6c20 7468 6520 6d65 7373 6167 6573 2074  l the messages t
+0001fd40: 6861 7420 6172 6520 6375 7272 656e 746c  hat are currentl
+0001fd50: 7920 7175 6575 6564 2075 7020 616e 6420  y queued up and 
+0001fd60: 7761 6974 696e 672e 0a20 2020 2050 7269  waiting..    Pri
+0001fd70: 6e74 2074 6865 6d2e 2054 6865 6e20 6c65  nt them. Then le
+0001fd80: 6176 652e 0a0a 2020 2020 416c 7465 726e  ave...    Altern
+0001fd90: 6174 6976 6520 696d 706c 656d 656e 7461  ative implementa
+0001fda0: 7469 6f6e 206f 6620 6c69 7374 656e 5f6f  tion of listen_o
+0001fdb0: 6e63 6528 292e 0a20 2020 2057 6520 646f  nce()..    We do
+0001fdc0: 6e27 7420 7573 6520 616e 7920 6361 6c6c  n't use any call
+0001fdd0: 6261 636b 7320 616e 6420 7765 206a 7573  backs and we jus
+0001fde0: 7420 6361 6c6c 2073 796e 6328 2920 616e  t call sync() an
+0001fdf0: 6420 6765 7420 616c 6c0a 2020 2020 6f66  d get all.    of
+0001fe00: 2074 6865 204d 6573 7361 6765 4576 656e   the MessageEven
+0001fe10: 7473 2066 726f 6d20 7468 6520 7469 6d65  ts from the time
+0001fe20: 6c69 6e65 206f 6620 7468 6520 7265 706c  line of the repl
+0001fe30: 7920 7072 6f76 6964 6564 2062 790a 2020  y provided by.  
+0001fe40: 2020 7379 6e63 2829 2e20 5468 6973 2069    sync(). This i
+0001fe50: 7320 6d6f 7265 2077 6f72 6b20 7468 616e  s more work than
+0001fe60: 206c 6973 7465 6e5f 6f6e 6365 2829 2062   listen_once() b
+0001fe70: 7574 2069 7420 6973 2069 6e74 6572 6573  ut it is interes
+0001fe80: 7469 6e67 0a20 2020 2063 6173 6520 7374  ting.    case st
+0001fe90: 7564 7920 746f 2075 6e64 6572 7374 616e  udy to understan
+0001fea0: 6420 7379 6e63 2829 2e0a 0a20 2020 2073  d sync()...    s
+0001feb0: 796e 6328 2920 7265 7370 6f6e 7365 2069  ync() response i
+0001fec0: 6e63 6c75 6465 7320 7468 6520 6d65 6d62  ncludes the memb
+0001fed0: 6572 2060 726f 6f6d 7360 2028 6f66 2063  er `rooms` (of c
+0001fee0: 6c61 7373 206e 696f 2e72 6573 706f 6e73  lass nio.respons
+0001fef0: 6573 2e52 6f6f 6d73 292e 0a20 2020 2052  es.Rooms)..    R
+0001ff00: 6f6f 6d73 2068 6176 6520 3320 746f 7020  ooms have 3 top 
+0001ff10: 6469 6374 732e 0a20 2020 2052 6f6f 6d73  dicts..    Rooms
+0001ff20: 2869 6e76 6974 653d 7b7d 2c20 6a6f 696e  (invite={}, join
+0001ff30: 3d7b 2e2e 2e7d 2c20 6c65 6176 653d 7b7d  ={...}, leave={}
+0001ff40: 290a 2020 2020 6a6f 696e 2068 6173 2061  ).    join has a
+0001ff50: 2064 6963 7420 656e 7472 7920 6f66 2074   dict entry of t
+0001ff60: 7970 6520 526f 6f6d 496e 666f 2066 6f72  ype RoomInfo for
+0001ff70: 0a20 2020 2065 6163 6820 726f 6f6d 2e20  .    each room. 
+0001ff80: 416e 6420 7468 6520 526f 6f6d 496e 666f  And the RoomInfo
+0001ff90: 2068 6173 2061 2074 696d 656c 696e 6520   has a timeline 
+0001ffa0: 286f 6620 636c 6173 7320 5469 6d65 4c69  (of class TimeLi
+0001ffb0: 6e65 2920 7769 7468 0a20 2020 2061 6c6c  ne) with.    all
+0001ffc0: 2063 7572 7265 6e74 6c79 2071 7565 7565   currently queue
+0001ffd0: 6420 7570 2065 7665 6e74 732e 2053 6f2c  d up events. So,
+0001ffe0: 2074 696d 656c 696e 6520 6861 7320 6120   timeline has a 
+0001fff0: 6c69 7374 206f 6620 6576 656e 7473 0a20  list of events. 
+00020000: 2020 2073 7563 6820 6173 2052 6f6f 6d4d     such as RoomM
+00020010: 6573 7361 6765 5465 7874 2c20 526f 6f6d  essageText, Room
+00020020: 4d65 7373 6167 654e 6f74 6963 652c 2065  MessageNotice, e
+00020030: 7463 2e20 4f6e 6520 6361 6e20 676f 2074  tc. One can go t
+00020040: 6872 6f75 6768 0a20 2020 2074 6865 7365  hrough.    these
+00020050: 2074 696d 656c 696e 6520 6576 656e 7420   timeline event 
+00020060: 6c69 7374 7320 616e 6420 7072 6f63 6573  lists and proces
+00020070: 7320 6561 6368 2071 7565 7565 6420 7570  s each queued up
+00020080: 206d 6573 7361 6765 2e0a 0a20 2020 2054   message...    T
+00020090: 6869 7320 6973 2061 6e20 6578 616d 706c  his is an exampl
+000200a0: 6520 526f 6f6d 7320 6f62 6a65 6374 2074  e Rooms object t
+000200b0: 6861 7420 6973 2070 6172 7420 6f66 2061  hat is part of a
+000200c0: 2073 796e 6328 2920 7265 7370 6f6e 7365   sync() response
+000200d0: 2e0a 2020 2020 5468 6973 2065 7861 6d70  ..    This examp
+000200e0: 6c65 2067 6976 6573 2074 6865 2064 6574  le gives the det
+000200f0: 6169 6c73 206f 6e20 3220 6375 7272 656e  ails on 2 curren
+00020100: 746c 7920 7175 6575 6564 2075 7020 6d65  tly queued up me
+00020110: 7373 6167 6573 2e0a 0a20 2020 2052 6f6f  ssages...    Roo
+00020120: 6d73 280a 2020 2020 696e 7669 7465 3d7b  ms(.    invite={
+00020130: 7d2c 0a20 2020 206a 6f69 6e3d 7b27 2153  },.    join={'!S
+00020140: 6f6d 6552 6f6f 6d49 643a 6578 616d 706c  omeRoomId:exampl
+00020150: 652e 6f72 6727 3a0a 2020 2020 2020 2020  e.org':.        
+00020160: 526f 6f6d 496e 666f 280a 2020 2020 2020  RoomInfo(.      
+00020170: 2020 7469 6d65 6c69 6e65 3d54 696d 656c    timeline=Timel
+00020180: 696e 6528 0a20 2020 2020 2020 2020 2020  ine(.           
+00020190: 2065 7665 6e74 733d 5b0a 2020 2020 2020   events=[.      
+000201a0: 2020 2020 2020 2020 2020 526f 6f6d 4d65            RoomMe
+000201b0: 7373 6167 6554 6578 7428 736f 7572 6365  ssageText(source
+000201c0: 3d7b 0a20 2020 2020 2020 2020 2020 2020  ={.             
+000201d0: 2020 2020 2020 2027 726f 6f6d 5f69 6427         'room_id'
+000201e0: 3a20 2721 536f 6d65 526f 6f6d 4964 3a65  : '!SomeRoomId:e
+000201f0: 7861 6d70 6c65 2e6f 7267 272c 0a20 2020  xample.org',.   
+00020200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020210: 2027 7479 7065 273a 2027 6d2e 726f 6f6d   'type': 'm.room
+00020220: 2e6d 6573 7361 6765 272c 0a20 2020 2020  .message',.     
+00020230: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00020240: 636f 6e74 656e 7427 3a20 7b27 6d73 6774  content': {'msgt
+00020250: 7970 6527 3a20 276d 2e74 6578 7427 2c20  ype': 'm.text', 
+00020260: 2762 6f64 7927 3a20 2748 6920 7468 6572  'body': 'Hi ther
+00020270: 6527 7d2c 0a20 2020 2020 2020 2020 2020  e'},.           
+00020280: 2020 2020 2020 2020 2027 6576 656e 745f           'event_
+00020290: 6964 273a 2027 536f 6d65 4576 656e 7449  id': 'SomeEventI
+000202a0: 6431 272c 0a20 2020 2020 2020 2020 2020  d1',.           
+000202b0: 2020 2020 2020 2020 2027 7365 6e64 6572           'sender
+000202c0: 273a 2027 4075 7365 7231 3a65 7861 6d70  ': '@user1:examp
+000202d0: 6c65 2e6f 7267 272c 0a20 2020 2020 2020  le.org',.       
+000202e0: 2020 2020 2020 2020 2020 2020 2027 6f72               'or
+000202f0: 6967 696e 5f73 6572 7665 725f 7473 273a  igin_server_ts':
+00020300: 2031 3539 3132 3334 3839 3637 3132 7d2c   1591234896712},
+00020310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020320: 2065 7665 6e74 5f69 643d 2753 6f6d 6545   event_id='SomeE
+00020330: 7665 6e74 4964 3127 2c0a 2020 2020 2020  ventId1',.      
+00020340: 2020 2020 2020 2020 2020 7365 6e64 6572            sender
+00020350: 3d27 4075 7365 7231 3a65 7861 6d70 6c65  ='@user1:example
+00020360: 2e6f 7267 272c 0a20 2020 2020 2020 2020  .org',.         
+00020370: 2020 2020 2020 2073 6572 7665 725f 7469         server_ti
+00020380: 6d65 7374 616d 703d 3135 3931 3233 3438  mestamp=15912348
+00020390: 3936 3731 322c 0a20 2020 2020 2020 2020  96712,.         
+000203a0: 2020 2020 2020 2064 6563 7279 7074 6564         decrypted
+000203b0: 3d54 7275 652c 2076 6572 6966 6965 643d  =True, verified=
+000203c0: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
+000203d0: 2020 2020 2020 2073 656e 6465 725f 6b65         sender_ke
+000203e0: 793d 2753 6f6d 6553 656e 6465 724b 6579  y='SomeSenderKey
+000203f0: 3127 2c0a 2020 2020 2020 2020 2020 2020  1',.            
+00020400: 2020 2020 7365 7373 696f 6e5f 6964 3d27      session_id='
+00020410: 536f 6d65 5365 7373 696f 6e49 6431 272c  SomeSessionId1',
+00020420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020430: 2074 7261 6e73 6163 7469 6f6e 5f69 643d   transaction_id=
+00020440: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+00020450: 2020 2020 2020 626f 6479 3d27 4869 2074        body='Hi t
+00020460: 6865 7265 272c 0a20 2020 2020 2020 2020  here',.         
+00020470: 2020 2020 2020 2066 6f72 6d61 7474 6564         formatted
+00020480: 5f62 6f64 793d 4e6f 6e65 2c0a 2020 2020  _body=None,.    
+00020490: 2020 2020 2020 2020 2020 2020 666f 726d              form
+000204a0: 6174 3d4e 6f6e 6529 2c0a 0a20 2020 2020  at=None),..     
+000204b0: 2020 2020 2020 2020 2020 2052 6f6f 6d4d             RoomM
+000204c0: 6573 7361 6765 4e6f 7469 6365 2873 6f75  essageNotice(sou
+000204d0: 7263 653d 7b27 636f 6e74 656e 7427 3a20  rce={'content': 
+000204e0: 7b27 6d73 6774 7970 6527 3a20 276d 2e6e  {'msgtype': 'm.n
+000204f0: 6f74 6963 6527 2c0a 2020 2020 2020 2020  otice',.        
+00020500: 2020 2020 2020 2020 2020 2020 2762 6f64              'bod
+00020510: 7927 3a20 2748 656c 6c6f 272c 0a20 2020  y': 'Hello',.   
+00020520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020530: 2027 666f 726d 6174 273a 2027 6f72 672e   'format': 'org.
+00020540: 6d61 7472 6978 2e63 7573 746f 6d2e 6874  matrix.custom.ht
+00020550: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00020560: 2020 2020 2020 2020 2027 666f 726d 6174           'format
+00020570: 7465 645f 626f 6479 273a 2027 3c70 3e48  ted_body': '<p>H
+00020580: 656c 6c6f 3c2f 703e 270a 2020 2020 2020  ello</p>'.      
+00020590: 2020 2020 2020 2020 2020 2020 2020 7d2c                },
+000205a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000205b0: 2020 2020 2027 7479 7065 273a 2027 6d2e       'type': 'm.
+000205c0: 726f 6f6d 2e6d 6573 7361 6765 272c 0a20  room.message',. 
+000205d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000205e0: 2020 2027 726f 6f6d 5f69 6427 3a20 2721     'room_id': '!
+000205f0: 536f 6d65 526f 6f6d 4964 3a65 7861 6d70  SomeRoomId:examp
+00020600: 6c65 2e6f 7267 272c 0a20 2020 2020 2020  le.org',.       
+00020610: 2020 2020 2020 2020 2020 2020 2027 6576               'ev
+00020620: 656e 745f 6964 273a 2027 536f 6d65 4576  ent_id': 'SomeEv
+00020630: 656e 7449 6432 272c 0a20 2020 2020 2020  entId2',.       
+00020640: 2020 2020 2020 2020 2020 2020 2027 7365               'se
+00020650: 6e64 6572 273a 2027 4075 7365 7232 3a65  nder': '@user2:e
+00020660: 7861 6d70 6c65 2e6f 7267 272c 0a20 2020  xample.org',.   
+00020670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020680: 2027 6f72 6967 696e 5f73 6572 7665 725f   'origin_server_
+00020690: 7473 273a 2031 3539 3132 3334 3839 3730  ts': 15912348970
+000206a0: 3739 7d2c 0a20 2020 2020 2020 2020 2020  79},.           
+000206b0: 2020 2020 2065 7665 6e74 5f69 643d 2753       event_id='S
+000206c0: 6f6d 6545 7665 6e74 4964 3227 2c0a 2020  omeEventId2',.  
+000206d0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000206e0: 6e64 6572 3d27 4075 7365 7232 3a65 7861  nder='@user2:exa
+000206f0: 6d70 6c65 2e6f 7267 272c 0a20 2020 2020  mple.org',.     
+00020700: 2020 2020 2020 2020 2020 2073 6572 7665             serve
+00020710: 725f 7469 6d65 7374 616d 703d 3135 3931  r_timestamp=1591
+00020720: 3233 3438 3937 3037 392c 2064 6563 7279  234897079, decry
+00020730: 7074 6564 3d54 7275 652c 2076 6572 6966  pted=True, verif
+00020740: 6965 643d 4661 6c73 652c 0a20 2020 2020  ied=False,.     
+00020750: 2020 2020 2020 2020 2020 2073 656e 6465             sende
+00020760: 725f 6b65 793d 2753 6f6d 6553 656e 6465  r_key='SomeSende
+00020770: 724b 6579 3227 2c0a 2020 2020 2020 2020  rKey2',.        
+00020780: 2020 2020 2020 2020 7365 7373 696f 6e5f          session_
+00020790: 6964 3d27 536f 6d65 5365 7373 696f 6e49  id='SomeSessionI
+000207a0: 6432 272c 0a20 2020 2020 2020 2020 2020  d2',.           
+000207b0: 2020 2020 2074 7261 6e73 6163 7469 6f6e       transaction
+000207c0: 5f69 643d 4e6f 6e65 2c0a 2020 2020 2020  _id=None,.      
+000207d0: 2020 2020 2020 2020 2020 626f 6479 3d27            body='
+000207e0: 3c70 3e48 656c 6c6f 3c2f 703e 272c 0a20  <p>Hello</p>',. 
+000207f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00020800: 6f72 6d61 743d 276f 7267 2e6d 6174 7269  ormat='org.matri
+00020810: 782e 6375 7374 6f6d 2e68 746d 6c27 290a  x.custom.html').
+00020820: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
+00020830: 2020 2020 2020 2020 2020 206c 696d 6974             limit
+00020840: 6564 3d46 616c 7365 2c0a 2020 2020 2020  ed=False,.      
+00020850: 2020 2020 2020 7072 6576 5f62 6174 6368        prev_batch
+00020860: 3d27 7331 3636 3530 5f32 3634 3734 365f  ='s16650_264746_
+00020870: 3733 325f 3132 3334 5f38 3035 305f 325f  732_1234_8050_2_
+00020880: 3832 3630 5f34 3339 5f31 2729 2c0a 2020  8260_439_1'),.  
+00020890: 2020 2020 2020 7374 6174 653d 5b5d 2c0a        state=[],.
+000208a0: 2020 2020 2020 2020 6570 6865 6d65 7261          ephemera
+000208b0: 6c3d 5b54 7970 696e 674e 6f74 6963 6545  l=[TypingNoticeE
+000208c0: 7665 6e74 2875 7365 7273 3d5b 5d29 2c20  vent(users=[]), 
+000208d0: 5265 6365 6970 7445 7665 6e74 282e 2e2e  ReceiptEvent(...
+000208e0: 295d 2c0a 2020 2020 2020 2020 6163 636f  )],.        acco
+000208f0: 756e 745f 6461 7461 3d5b 5d2c 0a20 2020  unt_data=[],.   
+00020900: 2020 2020 2073 756d 6d61 7279 3d52 6f6f       summary=Roo
+00020910: 6d53 756d 6d61 7279 282e 2e2e 292c 0a20  mSummary(...),. 
+00020920: 2020 2020 2020 2075 6e72 6561 645f 6e6f         unread_no
+00020930: 7469 6669 6361 7469 6f6e 733d 556e 7265  tifications=Unre
+00020940: 6164 4e6f 7469 6669 6361 7469 6f6e 7328  adNotifications(
+00020950: 2e2e 2e29 0a20 2020 2020 2020 2029 0a20  ...).        ). 
+00020960: 2020 207d 2c0a 2020 2020 6c65 6176 653d     },.    leave=
+00020970: 7b7d 290a 0a20 2020 2022 2222 0a20 2020  {})..    """.   
+00020980: 2072 6573 705f 7320 3d20 6177 6169 7420   resp_s = await 
+00020990: 636c 6965 6e74 2e73 796e 6328 7469 6d65  client.sync(time
+000209a0: 6f75 743d 3130 3030 302c 2066 756c 6c5f  out=10000, full_
+000209b0: 7374 6174 653d 4661 6c73 6529 0a20 2020  state=False).   
+000209c0: 2023 2074 6869 7320 7072 696e 7473 2061   # this prints a
+000209d0: 2073 756d 6d61 7279 206f 6620 616c 6c20   summary of all 
+000209e0: 6e65 7720 6d65 7373 6167 6573 2063 7572  new messages cur
+000209f0: 7265 6e74 6c79 2077 6169 7469 6e67 2069  rently waiting i
+00020a00: 6e20 7468 6520 7175 6575 650a 2020 2020  n the queue.    
+00020a10: 6773 2e6c 6f67 2e64 6562 7567 2866 2273  gs.log.debug(f"s
+00020a20: 796e 6320 7265 7370 6f6e 7365 203d 207b  ync response = {
+00020a30: 7479 7065 2872 6573 705f 7329 7d20 3a3a  type(resp_s)} ::
+00020a40: 207b 7265 7370 5f73 7d22 290a 2020 2020   {resp_s}").    
+00020a50: 6773 2e6c 6f67 2e64 6562 7567 2866 2273  gs.log.debug(f"s
+00020a60: 796e 6320 6e65 7874 5f62 6174 6368 203d  ync next_batch =
+00020a70: 2028 7374 7229 207b 7265 7370 5f73 2e6e   (str) {resp_s.n
+00020a80: 6578 745f 6261 7463 687d 2229 0a20 2020  ext_batch}").   
+00020a90: 2067 732e 6c6f 672e 6465 6275 6728 6622   gs.log.debug(f"
+00020aa0: 7379 6e63 2072 6f6f 6d73 203d 2028 6e69  sync rooms = (ni
+00020ab0: 6f2e 7265 7370 6f6e 7365 732e 526f 6f6d  o.responses.Room
+00020ac0: 7329 207b 7265 7370 5f73 2e72 6f6f 6d73  s) {resp_s.rooms
+00020ad0: 7d22 290a 2020 2020 2320 5365 7420 7570  }").    # Set up
+00020ae0: 2065 7665 6e74 2063 616c 6c62 6163 6b73   event callbacks
+00020af0: 0a20 2020 2063 616c 6c62 6163 6b73 203d  .    callbacks =
+00020b00: 2043 616c 6c62 6163 6b73 2863 6c69 656e   Callbacks(clien
+00020b10: 7429 0a20 2020 2023 204e 6f74 653a 2077  t).    # Note: w
+00020b20: 6520 6172 6520 4e4f 5420 7265 6769 7374  e are NOT regist
+00020b30: 6572 696e 6720 6120 6361 6c6c 6261 636b  ering a callback
+00020b40: 2066 756e 7469 6f6e 210a 2020 2020 2320   funtion!.    # 
+00020b50: 4c6f 6f70 2074 6872 6f75 6768 2074 6865  Loop through the
+00020b60: 206a 6f69 6e20 6469 6374 696f 6e61 7279   join dictionary
+00020b70: 0a20 2020 2066 6f72 2072 6f6f 6d5f 6964  .    for room_id
+00020b80: 2c20 726f 6f6d 5f69 6e66 6f20 696e 2072  , room_info in r
+00020b90: 6573 705f 732e 726f 6f6d 732e 6a6f 696e  esp_s.rooms.join
+00020ba0: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+00020bb0: 2020 6576 656e 745f 6c69 7374 203d 2072    event_list = r
+00020bc0: 6f6f 6d5f 696e 666f 2e74 696d 656c 696e  oom_info.timelin
+00020bd0: 652e 6576 656e 7473 0a20 2020 2020 2020  e.events.       
+00020be0: 2066 6f72 2065 7665 6e74 2069 6e20 6576   for event in ev
+00020bf0: 656e 745f 6c69 7374 3a0a 2020 2020 2020  ent_list:.      
+00020c00: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+00020c10: 7567 2866 2273 656e 6469 6e67 2065 7665  ug(f"sending eve
+00020c20: 6e74 2074 6f20 6361 6c6c 6261 636b 203d  nt to callback =
+00020c30: 207b 6576 656e 747d 2e22 290a 2020 2020   {event}.").    
+00020c40: 2020 2020 2020 2020 2320 6265 6361 7573          # becaus
+00020c50: 6520 6f66 2066 756c 6c5f 7374 6174 653d  e of full_state=
+00020c60: 4661 6c73 6520 696e 2073 796e 6328 2920  False in sync() 
+00020c70: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
+00020c80: 2320 726f 6f6d 7320 6f62 6a65 6374 2069  # rooms object i
+00020c90: 7320 6e6f 7420 6675 6c6c 7920 706f 7075  s not fully popu
+00020ca0: 6c61 7465 6420 616e 6420 6d69 7373 696e  lated and missin
+00020cb0: 6720 7468 650a 2020 2020 2020 2020 2020  g the.          
+00020cc0: 2020 2320 726f 6f6d 206e 616d 6573 2e0a    # room names..
+00020cd0: 2020 2020 2020 2020 2020 2020 726f 6f6d              room
+00020ce0: 203d 2063 6c69 656e 742e 726f 6f6d 735b   = client.rooms[
+00020cf0: 726f 6f6d 5f69 645d 0a20 2020 2020 2020  room_id].       
+00020d00: 2020 2020 2061 7761 6974 2063 616c 6c62       await callb
+00020d10: 6163 6b73 2e6d 6573 7361 6765 5f63 616c  acks.message_cal
+00020d20: 6c62 6163 6b28 726f 6f6d 2c20 6576 656e  lback(room, even
+00020d30: 7429 0a20 2020 2020 2020 2069 6620 6576  t).        if ev
+00020d40: 656e 745f 6c69 7374 3a20 2023 206c 6973  ent_list:  # lis
+00020d50: 7420 6e6f 7420 656d 7074 790a 2020 2020  t not empty.    
+00020d60: 2020 2020 2020 2020 6c61 7374 5f65 7665          last_eve
+00020d70: 6e74 203d 2065 7665 6e74 5f6c 6973 745b  nt = event_list[
+00020d80: 2d31 5d0a 2020 2020 2020 2020 2020 2020  -1].            
+00020d90: 7265 7370 203d 2061 7761 6974 2063 6c69  resp = await cli
+00020da0: 656e 742e 726f 6f6d 5f72 6561 645f 6d61  ent.room_read_ma
+00020db0: 726b 6572 7328 0a20 2020 2020 2020 2020  rkers(.         
+00020dc0: 2020 2020 2020 2072 6f6f 6d5f 6964 3d72         room_id=r
+00020dd0: 6f6f 6d5f 6964 2c0a 2020 2020 2020 2020  oom_id,.        
+00020de0: 2020 2020 2020 2020 6675 6c6c 795f 7265          fully_re
+00020df0: 6164 5f65 7665 6e74 3d6c 6173 745f 6576  ad_event=last_ev
+00020e00: 656e 742e 6576 656e 745f 6964 2c0a 2020  ent.event_id,.  
+00020e10: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00020e20: 6164 5f65 7665 6e74 3d6c 6173 745f 6576  ad_event=last_ev
+00020e30: 656e 742e 6576 656e 745f 6964 2c0a 2020  ent.event_id,.  
+00020e40: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00020e50: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00020e60: 7461 6e63 6528 7265 7370 2c20 526f 6f6d  tance(resp, Room
+00020e70: 5265 6164 4d61 726b 6572 7345 7272 6f72  ReadMarkersError
+00020e80: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00020e90: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+00020ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020eb0: 2020 2020 2022 726f 6f6d 5f72 6561 645f       "room_read_
+00020ec0: 6d61 726b 6572 7320 6661 696c 6564 2077  markers failed w
+00020ed0: 6974 6820 7265 7370 6f6e 7365 2022 0a20  ith response ". 
+00020ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020ef0: 2020 2066 227b 7072 6976 6163 795f 6669     f"{privacy_fi
+00020f00: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
+00020f10: 2e22 0a20 2020 2020 2020 2020 2020 2020  .".             
+00020f20: 2020 2029 0a0a 0a23 2061 6363 6f72 6469     )...# accordi
+00020f30: 6e67 2074 6f20 7079 6c61 6d61 3a20 6675  ng to pylama: fu
+00020f40: 6e63 7469 6f6e 2074 6f6f 2063 6f6d 706c  nction too compl
+00020f50: 6578 3a20 4339 3031 2023 206e 6f71 613a  ex: C901 # noqa:
+00020f60: 2043 3930 310a 6173 796e 6320 6465 6620   C901.async def 
+00020f70: 6c69 7374 656e 5f74 6169 6c28 2020 2320  listen_tail(  # 
+00020f80: 6e6f 7161 3a20 4339 3031 0a20 2020 2063  noqa: C901.    c
+00020f90: 6c69 656e 743a 2041 7379 6e63 436c 6965  lient: AsyncClie
+00020fa0: 6e74 2c20 6372 6564 656e 7469 616c 733a  nt, credentials:
+00020fb0: 2064 6963 740a 2920 2d3e 204e 6f6e 653a   dict.) -> None:
+00020fc0: 2020 2320 6e6f 7161 3a20 4339 3031 0a20    # noqa: C901. 
+00020fd0: 2020 2022 2222 4765 7420 7468 6520 6c61     """Get the la
+00020fe0: 7374 204e 206d 6573 7361 6765 732c 2074  st N messages, t
+00020ff0: 6865 6e20 7175 6974 2e0a 0a20 2020 2041  hen quit...    A
+00021000: 7267 756d 656e 7473 3a0a 2020 2020 2d2d  rguments:.    --
+00021010: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+00021020: 636c 6965 6e74 3a20 4173 796e 6343 6c69  client: AsyncCli
+00021030: 656e 7420 3a20 7468 6520 6372 6561 7465  ent : the create
+00021040: 6420 4e49 4f20 636c 6965 6e74 0a20 2020  d NIO client.   
+00021050: 2020 2020 2063 7265 6465 6e74 6961 6c73       credentials
+00021060: 3a20 6469 6374 203a 2063 7265 6465 6e74  : dict : credent
+00021070: 6961 6c73 2064 6963 7469 6f6e 6172 7920  ials dictionary 
+00021080: 6672 6f6d 2074 6865 2063 7265 6465 6e74  from the credent
+00021090: 6961 6c73 2066 696c 650a 0a20 2020 2047  ials file..    G
+000210a0: 6574 2074 6865 206c 6173 7420 4e20 6d65  et the last N me
+000210b0: 7373 6167 6573 2e20 536f 6d65 206d 6967  ssages. Some mig
+000210c0: 6874 2062 6520 6f6c 642c 2069 2e65 2e20  ht be old, i.e. 
+000210d0: 616c 7265 6164 790a 2020 2020 7265 6164  already.    read
+000210e0: 2062 6566 6f72 652c 2073 6f6d 6520 6d69   before, some mi
+000210f0: 6768 7420 6265 206e 6577 2c20 692e 652e  ght be new, i.e.
+00021100: 206e 6576 6572 2072 6561 6420 6265 666f   never read befo
+00021110: 7265 2e0a 2020 2020 5072 696e 7420 7468  re..    Print th
+00021120: 656d 2e20 5468 656e 206c 6561 7665 2e0a  em. Then leave..
+00021130: 0a20 2020 2049 6620 7468 6572 6520 6172  .    If there ar
+00021140: 6520 6c65 7373 2074 6861 6e20 4e20 6d65  e less than N me
+00021150: 7373 6167 6573 2c20 6765 7420 7570 2074  ssages, get up t
+00021160: 6f20 4e2e 0a0a 2020 2020 5468 6520 6675  o N...    The fu
+00021170: 6e63 7469 6f6e 2072 6f6f 6d5f 6d65 7373  nction room_mess
+00021180: 6167 6573 2829 2069 7320 7573 6564 2074  ages() is used t
+00021190: 6f20 6765 740a 2020 2020 7468 6520 6c61  o get.    the la
+000211a0: 7374 204e 206d 6573 7361 6765 732e 0a0a  st N messages...
+000211b0: 2020 2020 2222 220a 2020 2020 2320 7765      """.    # we
+000211c0: 2063 616c 6c20 7379 6e63 2829 2074 6f20   call sync() to 
+000211d0: 6765 7420 7468 6520 6e65 7874 5f62 6174  get the next_bat
+000211e0: 6368 206d 6172 6b65 720a 2020 2020 2320  ch marker.    # 
+000211f0: 7765 2073 6574 2066 756c 6c5f 7374 6174  we set full_stat
+00021200: 653d 5472 7565 2074 6f20 6765 7420 616c  e=True to get al
+00021210: 6c20 726f 6f6d 5f69 6473 0a20 2020 2072  l room_ids.    r
+00021220: 6573 705f 7320 3d20 6177 6169 7420 7379  esp_s = await sy
+00021230: 6e63 6872 6f6e 697a 6528 636c 6965 6e74  nchronize(client
+00021240: 2920 2023 2073 796e 6328 2920 746f 2067  )  # sync() to g
+00021250: 6574 2072 6f6f 6d73 0a20 2020 2023 2074  et rooms.    # t
+00021260: 6869 7320 7072 696e 7473 2061 2073 756d  his prints a sum
+00021270: 6d61 7279 206f 6620 616c 6c20 6e65 7720  mary of all new 
+00021280: 6d65 7373 6167 6573 2063 7572 7265 6e74  messages current
+00021290: 6c79 2077 6169 7469 6e67 2069 6e20 7468  ly waiting in th
+000212a0: 6520 7175 6575 650a 2020 2020 6773 2e6c  e queue.    gs.l
+000212b0: 6f67 2e64 6562 7567 2866 2273 796e 6320  og.debug(f"sync 
+000212c0: 7265 7370 6f6e 7365 203d 207b 7479 7065  response = {type
+000212d0: 2872 6573 705f 7329 7d20 3a3a 207b 7265  (resp_s)} :: {re
+000212e0: 7370 5f73 7d22 290a 2020 2020 6773 2e6c  sp_s}").    gs.l
+000212f0: 6f67 2e64 6562 7567 2866 2263 6c69 656e  og.debug(f"clien
+00021300: 742e 6e65 7874 5f62 6174 6368 2061 6674  t.next_batch aft
+00021310: 6572 203d 2028 7374 7229 207b 636c 6965  er = (str) {clie
+00021320: 6e74 2e6e 6578 745f 6261 7463 687d 2229  nt.next_batch}")
+00021330: 0a20 2020 2067 732e 6c6f 672e 6465 6275  .    gs.log.debu
+00021340: 6728 6622 7379 6e63 206e 6578 745f 6261  g(f"sync next_ba
+00021350: 7463 6820 3d20 2873 7472 2920 7b72 6573  tch = (str) {res
+00021360: 705f 732e 6e65 7874 5f62 6174 6368 7d22  p_s.next_batch}"
+00021370: 290a 2020 2020 6773 2e6c 6f67 2e64 6562  ).    gs.log.deb
+00021380: 7567 2866 2273 796e 6320 726f 6f6d 7320  ug(f"sync rooms 
+00021390: 3d20 286e 696f 2e72 6573 706f 6e73 6573  = (nio.responses
+000213a0: 2e52 6f6f 6d73 2920 7b72 6573 705f 732e  .Rooms) {resp_s.
+000213b0: 726f 6f6d 737d 2229 0a20 2020 2067 732e  rooms}").    gs.
+000213c0: 6c6f 672e 6465 6275 6728 6622 636c 6965  log.debug(f"clie
+000213d0: 6e74 2e72 6f6f 6d73 203d 207b 636c 6965  nt.rooms = {clie
+000213e0: 6e74 2e72 6f6f 6d73 7d22 290a 2020 2020  nt.rooms}").    
+000213f0: 6966 206e 6f74 2072 6573 705f 732e 726f  if not resp_s.ro
+00021400: 6f6d 732e 6a6f 696e 3a20 2023 206e 6f20  oms.join:  # no 
+00021410: 526f 6f6d 7321 0a20 2020 2020 2020 2067  Rooms!.        g
+00021420: 732e 6c6f 672e 6465 6275 6728 6622 7379  s.log.debug(f"sy
+00021430: 6e63 2072 6574 7572 6e65 6420 6e6f 2072  nc returned no r
+00021440: 6f6f 6d73 203d 207b 7265 7370 5f73 2e72  ooms = {resp_s.r
+00021450: 6f6f 6d73 2e6a 6f69 6e7d 2229 0a20 2020  ooms.join}").   
+00021460: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+00021470: 2023 2053 6574 2075 7020 6576 656e 7420   # Set up event 
+00021480: 6361 6c6c 6261 636b 730a 2020 2020 6361  callbacks.    ca
+00021490: 6c6c 6261 636b 7320 3d20 4361 6c6c 6261  llbacks = Callba
+000214a0: 636b 7328 636c 6965 6e74 290a 2020 2020  cks(client).    
+000214b0: 2320 4e6f 7465 3a20 7765 2061 7265 204e  # Note: we are N
+000214c0: 4f54 2072 6567 6973 7465 7269 6e67 2061  OT registering a
+000214d0: 2063 616c 6c62 6163 6b20 6675 6e74 696f   callback funtio
+000214e0: 6e21 0a0a 2020 2020 2320 726f 6f6d 5f69  n!..    # room_i
+000214f0: 6420 3d20 6c69 7374 2872 6573 705f 732e  d = list(resp_s.
+00021500: 726f 6f6d 732e 6a6f 696e 2e6b 6579 7328  rooms.join.keys(
+00021510: 2929 5b30 5d20 2023 2066 6972 7374 2072  ))[0]  # first r
+00021520: 6f6f 6d5f 6964 2066 726f 6d20 6469 6374  oom_id from dict
+00021530: 0a20 2020 2023 2061 6c74 6572 6e61 7469  .    # alternati
+00021540: 7665 2077 6179 206f 6620 6765 7474 696e  ve way of gettin
+00021550: 6720 726f 6f6d 5f69 642c 2063 6c69 656e  g room_id, clien
+00021560: 742e 726f 6f6d 7320 6973 2061 6c73 6f20  t.rooms is also 
+00021570: 6120 6469 6374 0a20 2020 2023 2072 6f6f  a dict.    # roo
+00021580: 6d5f 6964 203d 206c 6973 7428 636c 6965  m_id = list(clie
+00021590: 6e74 2e72 6f6f 6d73 2e6b 6579 7328 2929  nt.rooms.keys())
+000215a0: 5b30 5d20 2023 2066 6972 7374 2072 6f6f  [0]  # first roo
+000215b0: 6d5f 6964 2066 726f 6d20 6469 6374 0a0a  m_id from dict..
+000215c0: 2020 2020 2320 6765 7420 726f 6f6d 7320      # get rooms 
+000215d0: 6173 2073 7065 6369 6669 6564 2062 7920  as specified by 
+000215e0: 7468 6520 7573 6572 2074 6872 7520 6172  the user thru ar
+000215f0: 6773 206f 7220 6372 6564 656e 7469 616c  gs or credential
+00021600: 2066 696c 650a 2020 2020 726f 6f6d 7320   file.    rooms 
+00021610: 3d20 6177 6169 7420 6465 7465 726d 696e  = await determin
+00021620: 655f 726f 6f6d 7328 6372 6564 656e 7469  e_rooms(credenti
+00021630: 616c 735b 2272 6f6f 6d5f 6964 225d 2c20  als["room_id"], 
+00021640: 636c 6965 6e74 2c20 6372 6564 656e 7469  client, credenti
+00021650: 616c 7329 0a20 2020 206c 696d 6974 203d  als).    limit =
+00021660: 2067 732e 7061 2e74 6169 6c0a 2020 2020   gs.pa.tail.    
+00021670: 6773 2e6c 6f67 2e64 6562 7567 2866 2252  gs.log.debug(f"R
+00021680: 6f6f 6d73 2061 7265 3a20 7b72 6f6f 6d73  ooms are: {rooms
+00021690: 7d2c 206c 696d 6974 2069 7320 7b6c 696d  }, limit is {lim
+000216a0: 6974 7d22 290a 2020 2020 2320 546f 206c  it}").    # To l
+000216b0: 6f6f 7020 6f76 6572 2061 6c6c 2072 6f6f  oop over all roo
+000216c0: 6d73 2c20 6f6e 6520 6361 6e20 6c6f 6f70  ms, one can loop
+000216d0: 2074 6872 6f75 6768 2074 6865 206a 6f69   through the joi
+000216e0: 6e20 6469 6374 696f 6e61 7279 2e20 692e  n dictionary. i.
+000216f0: 652e 0a20 2020 2023 2066 6f72 2072 6f6f  e..    # for roo
+00021700: 6d5f 6964 2c20 726f 6f6d 5f69 6e66 6f20  m_id, room_info 
+00021710: 696e 2072 6573 705f 732e 726f 6f6d 732e  in resp_s.rooms.
+00021720: 6a6f 696e 2e69 7465 6d73 2829 3a20 2023  join.items():  #
+00021730: 206c 6f6f 7020 616c 6c20 726f 6f6d 730a   loop all rooms.
+00021740: 2020 2020 666f 7220 726f 6f6d 5f69 6420      for room_id 
+00021750: 696e 2072 6f6f 6d73 3a20 2023 206c 6f6f  in rooms:  # loo
+00021760: 7020 6f6e 6c79 206f 7665 7220 7573 6572  p only over user
+00021770: 2073 7065 6369 6669 6564 2072 6f6f 6d73   specified rooms
+00021780: 0a20 2020 2020 2020 2072 6573 7020 3d20  .        resp = 
+00021790: 6177 6169 7420 636c 6965 6e74 2e72 6f6f  await client.roo
+000217a0: 6d5f 6d65 7373 6167 6573 280a 2020 2020  m_messages(.    
+000217b0: 2020 2020 2020 2020 726f 6f6d 5f69 642c          room_id,
+000217c0: 2073 7461 7274 3d72 6573 705f 732e 6e65   start=resp_s.ne
+000217d0: 7874 5f62 6174 6368 2c20 6c69 6d69 743d  xt_batch, limit=
+000217e0: 6c69 6d69 740a 2020 2020 2020 2020 290a  limit.        ).
+000217f0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00021800: 7461 6e63 6528 7265 7370 2c20 526f 6f6d  tance(resp, Room
+00021810: 4d65 7373 6167 6573 4572 726f 7229 3a0a  MessagesError):.
+00021820: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+00021830: 6f67 2e77 6172 6e69 6e67 280a 2020 2020  og.warning(.    
+00021840: 2020 2020 2020 2020 2020 2020 2257 3130              "W10
+00021850: 363a 2022 0a20 2020 2020 2020 2020 2020  6: ".           
+00021860: 2020 2020 2066 2272 6f6f 6d5f 6d65 7373       f"room_mess
+00021870: 6167 6573 2066 6169 6c65 6420 7769 7468  ages failed with
+00021880: 2072 6573 706f 6e73 6520 220a 2020 2020   response ".    
+00021890: 2020 2020 2020 2020 2020 2020 6622 7b70              f"{p
+000218a0: 7269 7661 6379 5f66 696c 7465 7228 7374  rivacy_filter(st
+000218b0: 7228 7265 7370 2929 7d2e 2022 0a20 2020  r(resp))}. ".   
+000218c0: 2020 2020 2020 2020 2020 2020 2022 5072               "Pr
+000218d0: 6f63 6573 7369 6e67 2063 6f6e 7469 6e75  ocessing continu
+000218e0: 6573 2e22 0a20 2020 2020 2020 2020 2020  es.".           
+000218f0: 2029 0a20 2020 2020 2020 2020 2020 2067   ).            g
+00021900: 732e 7761 726e 5f63 6f75 6e74 202b 3d20  s.warn_count += 
+00021910: 310a 2020 2020 2020 2020 2020 2020 636f  1.            co
+00021920: 6e74 696e 7565 2020 2320 736b 6970 2074  ntinue  # skip t
+00021930: 6869 7320 726f 6f6d 0a20 2020 2020 2020  his room.       
+00021940: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
+00021950: 2020 2020 2020 2020 2020 2066 2272 6f6f             f"roo
+00021960: 6d5f 6d65 7373 6167 6573 2072 6573 706f  m_messages respo
+00021970: 6e73 6520 3d20 7b74 7970 6528 7265 7370  nse = {type(resp
+00021980: 297d 203a 3a20 220a 2020 2020 2020 2020  )} :: ".        
+00021990: 2020 2020 6622 7b70 7269 7661 6379 5f66      f"{privacy_f
+000219a0: 696c 7465 7228 7374 7228 7265 7370 2929  ilter(str(resp))
+000219b0: 7d2e 220a 2020 2020 2020 2020 290a 2020  }.".        ).  
+000219c0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+000219d0: 7567 2866 2272 6f6f 6d5f 6d65 7373 6167  ug(f"room_messag
+000219e0: 6573 2072 6f6f 6d5f 6964 203d 207b 7265  es room_id = {re
+000219f0: 7370 2e72 6f6f 6d5f 6964 7d2e 2229 0a20  sp.room_id}."). 
+00021a00: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+00021a10: 6275 6728 6622 726f 6f6d 5f6d 6573 7361  bug(f"room_messa
+00021a20: 6765 7320 7374 6172 7420 3d20 2873 7472  ges start = (str
+00021a30: 2920 7b72 6573 702e 7374 6172 747d 2e22  ) {resp.start}."
+00021a40: 290a 2020 2020 2020 2020 6773 2e6c 6f67  ).        gs.log
+00021a50: 2e64 6562 7567 2866 2272 6f6f 6d5f 6d65  .debug(f"room_me
+00021a60: 7373 6167 6573 2065 6e64 203d 2028 7374  ssages end = (st
+00021a70: 7229 203a 3a20 7b72 6573 702e 656e 647d  r) :: {resp.end}
+00021a80: 2e22 290a 2020 2020 2020 2020 6773 2e6c  .").        gs.l
+00021a90: 6f67 2e64 6562 7567 2866 2272 6f6f 6d5f  og.debug(f"room_
+00021aa0: 6d65 7373 6167 6573 2063 6875 6e6b 203d  messages chunk =
+00021ab0: 2028 6c69 7374 2920 3a3a 207b 7265 7370   (list) :: {resp
+00021ac0: 2e63 6875 6e6b 7d2e 2229 0a20 2020 2020  .chunk}.").     
+00021ad0: 2020 2023 2063 6875 6e6b 2069 7320 6a75     # chunk is ju
+00021ae0: 7374 2061 206c 6973 7420 6f66 2052 6f6f  st a list of Roo
+00021af0: 6d4d 6573 7361 6765 2065 7665 6e74 7320  mMessage events 
+00021b00: 6c69 6b65 2074 6869 7320 6578 616d 706c  like this exampl
+00021b10: 653a 0a20 2020 2020 2020 2023 2063 6875  e:.        # chu
+00021b20: 6e6b 3d5b 526f 6f6d 4d65 7373 6167 6554  nk=[RoomMessageT
+00021b30: 6578 7428 2e2e 2e29 5d0a 0a20 2020 2020  ext(...)]..     
+00021b40: 2020 2066 6f72 2065 7665 6e74 2069 6e20     for event in 
+00021b50: 7265 7370 2e63 6875 6e6b 3a0a 2020 2020  resp.chunk:.    
+00021b60: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+00021b70: 6562 7567 2866 2273 656e 6469 6e67 2065  ebug(f"sending e
+00021b80: 7665 6e74 2074 6f20 6361 6c6c 6261 636b  vent to callback
+00021b90: 203d 207b 6576 656e 747d 2e22 290a 2020   = {event}.").  
+00021ba0: 2020 2020 2020 2020 2020 6966 2063 6c69            if cli
+00021bb0: 656e 742e 726f 6f6d 7320 616e 6420 636c  ent.rooms and cl
+00021bc0: 6965 6e74 2e72 6f6f 6d73 5b72 6f6f 6d5f  ient.rooms[room_
+00021bd0: 6964 5d3a 0a20 2020 2020 2020 2020 2020  id]:.           
+00021be0: 2020 2020 2072 6f6f 6d20 3d20 636c 6965       room = clie
+00021bf0: 6e74 2e72 6f6f 6d73 5b72 6f6f 6d5f 6964  nt.rooms[room_id
+00021c00: 5d0a 2020 2020 2020 2020 2020 2020 656c  ].            el
+00021c10: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00021c20: 2020 2020 726f 6f6d 203d 204d 6174 7269      room = Matri
+00021c30: 7852 6f6f 6d28 726f 6f6d 5f69 642c 204e  xRoom(room_id, N
+00021c40: 6f6e 652c 2054 7275 6529 2020 2320 6475  one, True)  # du
+00021c50: 6d6d 795f 726f 6f6d 0a20 2020 2020 2020  mmy_room.       
+00021c60: 2020 2020 2061 7761 6974 2063 616c 6c62       await callb
+00021c70: 6163 6b73 2e6d 6573 7361 6765 5f63 616c  acks.message_cal
+00021c80: 6c62 6163 6b28 726f 6f6d 2c20 6576 656e  lback(room, even
+00021c90: 7429 0a20 2020 2020 2020 2069 6620 7265  t).        if re
+00021ca0: 7370 2e63 6875 6e6b 3a20 2023 206c 6973  sp.chunk:  # lis
+00021cb0: 7420 6e6f 7420 656d 7074 790a 2020 2020  t not empty.    
+00021cc0: 2020 2020 2020 2020 2320 6f72 6465 7220          # order 
+00021cd0: 6973 2072 6576 6572 7365 642c 2066 6972  is reversed, fir
+00021ce0: 7374 2065 6c65 6d65 6e74 2069 7320 7469  st element is ti
+00021cf0: 6d65 7769 7365 2074 6865 206e 6577 6573  mewise the newes
+00021d00: 740a 2020 2020 2020 2020 2020 2020 6669  t.            fi
+00021d10: 7273 745f 6576 656e 7420 3d20 7265 7370  rst_event = resp
+00021d20: 2e63 6875 6e6b 5b30 5d0a 2020 2020 2020  .chunk[0].      
+00021d30: 2020 2020 2020 7265 7370 203d 2061 7761        resp = awa
+00021d40: 6974 2063 6c69 656e 742e 726f 6f6d 5f72  it client.room_r
+00021d50: 6561 645f 6d61 726b 6572 7328 0a20 2020  ead_markers(.   
+00021d60: 2020 2020 2020 2020 2020 2020 2072 6f6f               roo
+00021d70: 6d5f 6964 3d72 6f6f 6d5f 6964 2c0a 2020  m_id=room_id,.  
+00021d80: 2020 2020 2020 2020 2020 2020 2020 6675                fu
+00021d90: 6c6c 795f 7265 6164 5f65 7665 6e74 3d66  lly_read_event=f
+00021da0: 6972 7374 5f65 7665 6e74 2e65 7665 6e74  irst_event.event
+00021db0: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
+00021dc0: 2020 2020 2072 6561 645f 6576 656e 743d       read_event=
+00021dd0: 6669 7273 745f 6576 656e 742e 6576 656e  first_event.even
+00021de0: 745f 6964 2c0a 2020 2020 2020 2020 2020  t_id,.          
+00021df0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00021e00: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
+00021e10: 7370 2c20 526f 6f6d 5265 6164 4d61 726b  sp, RoomReadMark
+00021e20: 6572 7345 7272 6f72 293a 0a20 2020 2020  ersError):.     
+00021e30: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
+00021e40: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
+00021e50: 2020 2020 2020 2020 2020 2020 2022 726f               "ro
+00021e60: 6f6d 5f72 6561 645f 6d61 726b 6572 7320  om_read_markers 
+00021e70: 6661 696c 6564 2077 6974 6820 7265 7370  failed with resp
+00021e80: 6f6e 7365 2022 0a20 2020 2020 2020 2020  onse ".         
+00021e90: 2020 2020 2020 2020 2020 2066 227b 7072             f"{pr
+00021ea0: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
+00021eb0: 2872 6573 7029 297d 2e22 0a20 2020 2020  (resp))}.".     
+00021ec0: 2020 2020 2020 2020 2020 2029 0a0a 0a61             )...a
+00021ed0: 7379 6e63 2064 6566 2072 6561 645f 616c  sync def read_al
+00021ee0: 6c5f 6576 656e 7473 5f69 6e5f 6469 7265  l_events_in_dire
+00021ef0: 6374 696f 6e28 0a20 2020 2063 6c69 656e  ction(.    clien
+00021f00: 743a 2041 7379 6e63 436c 6965 6e74 2c0a  t: AsyncClient,.
+00021f10: 2020 2020 726f 6f6d 5f69 643a 2073 7472      room_id: str
+00021f20: 2c0a 2020 2020 7374 6172 745f 746f 6b65  ,.    start_toke
+00021f30: 6e3a 2073 7472 2c0a 2020 2020 6469 7265  n: str,.    dire
+00021f40: 6374 696f 6e3a 204d 6573 7361 6765 4469  ction: MessageDi
+00021f50: 7265 6374 696f 6e20 3d20 4d65 7373 6167  rection = Messag
+00021f60: 6544 6972 6563 7469 6f6e 2e62 6163 6b2c  eDirection.back,
+00021f70: 0a29 202d 3e20 6c69 7374 3a0a 2020 2020  .) -> list:.    
+00021f80: 2222 2252 6561 6420 616c 6c20 6576 656e  """Read all even
+00021f90: 7473 2066 726f 6d20 6120 6769 7665 6e20  ts from a given 
+00021fa0: 726f 6f6d 2069 6e20 6365 7274 6169 6e20  room in certain 
+00021fb0: 6469 7265 6374 696f 6e2e 0a0a 2020 2020  direction...    
+00021fc0: 4172 6775 6d65 6e74 733a 0a20 2020 202d  Arguments:.    -
+00021fd0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
+00021fe0: 2063 6c69 656e 743a 2041 7379 6e63 436c   client: AsyncCl
+00021ff0: 6965 6e74 203a 2054 6865 2063 7265 6174  ient : The creat
+00022000: 6564 204e 494f 2063 6c69 656e 740a 2020  ed NIO client.  
+00022010: 2020 2020 2020 726f 6f6d 5f69 643a 2073        room_id: s
+00022020: 7472 203a 2054 6865 2072 6f6f 6d20 6964  tr : The room id
+00022030: 206f 6620 7468 6520 726f 6f6d 2066 6f72   of the room for
+00022040: 2077 6869 6368 2077 650a 2020 2020 2020   which we.      
+00022050: 2020 2020 2020 776f 756c 6420 6c69 6b65        would like
+00022060: 2074 6f20 6665 7463 6820 7468 6520 6d65   to fetch the me
+00022070: 7373 6167 6573 2e0a 2020 2020 2020 2020  ssages..        
+00022080: 7374 6172 745f 746f 6b65 6e3a 2073 7472  start_token: str
+00022090: 203a 2020 5468 6520 746f 6b65 6e20 746f   :  The token to
+000220a0: 2073 7461 7274 2072 6574 7572 6e69 6e67   start returning
+000220b0: 2065 7665 6e74 7320 6672 6f6d 2e0a 2020   events from..  
+000220c0: 2020 2020 2020 2020 2020 5468 6973 2074            This t
+000220d0: 6f6b 656e 2063 616e 2062 6520 6f62 7461  oken can be obta
+000220e0: 696e 6564 2066 726f 6d20 6120 7072 6576  ined from a prev
+000220f0: 5f62 6174 6368 2074 6f6b 656e 2072 6574  _batch token ret
+00022100: 7572 6e65 6420 666f 720a 2020 2020 2020  urned for.      
+00022110: 2020 2020 2020 6561 6368 2072 6f6f 6d20        each room 
+00022120: 6279 2074 6865 2073 796e 6328 2920 4150  by the sync() AP
+00022130: 492c 206f 7220 6672 6f6d 2061 2073 7461  I, or from a sta
+00022140: 7274 206f 7220 656e 6420 746f 6b65 6e20  rt or end token 
+00022150: 7265 7475 726e 6564 0a20 2020 2020 2020  returned.       
+00022160: 2020 2020 2062 7920 6120 7072 6576 696f       by a previo
+00022170: 7573 2072 6571 7565 7374 2074 6f20 726f  us request to ro
+00022180: 6f6d 5f6d 6573 7361 6765 7328 292e 0a20  om_messages().. 
+00022190: 2020 2020 2020 2064 6972 6563 7469 6f6e         direction
+000221a0: 3a20 4d65 7373 6167 6544 6972 6563 7469  : MessageDirecti
+000221b0: 6f6e 2028 6f70 7469 6f6e 616c 293a 2054  on (optional): T
+000221c0: 6865 2064 6972 6563 7469 6f6e 2074 6f20  he direction to 
+000221d0: 7265 7475 726e 0a20 2020 2020 2020 2020  return.         
+000221e0: 2020 2065 7665 6e74 7320 6672 6f6d 2e20     events from. 
+000221f0: 4465 6661 756c 7473 2074 6f20 4d65 7373  Defaults to Mess
+00022200: 6167 6544 6972 6563 7469 6f6e 2e62 6163  ageDirection.bac
+00022210: 6b2e 0a0a 2020 2020 5265 7475 726e 730a  k...    Returns.
+00022220: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+00022230: 2020 2020 6c69 7374 3a20 6c69 7374 206f      list: list o
+00022240: 6620 526f 6f6d 4d65 7373 6167 6520 6576  f RoomMessage ev
+00022250: 656e 7473 2c20 636f 756c 6420 6265 2065  ents, could be e
+00022260: 6d70 7479 0a0a 2020 2020 5265 6164 2061  mpty..    Read a
+00022270: 6c6c 206d 6573 7361 6765 7320 6f66 2061  ll messages of a
+00022280: 2072 6f6f 6d20 6265 6769 6e6e 696e 6720   room beginning 
+00022290: 6672 6f6d 2074 6865 2070 6173 745f 746f  from the past_to
+000222a0: 6b65 6e0a 2020 2020 746f 206f 6c64 6573  ken.    to oldes
+000222b0: 7420 6f72 206e 6577 6573 7420 6d65 7373  t or newest mess
+000222c0: 6167 6520 2864 6570 656e 6469 6e67 206f  age (depending o
+000222d0: 6e20 7468 6520 6469 7265 6374 696f 6e29  n the direction)
+000222e0: 2e0a 0a20 2020 2022 2222 0a20 2020 2061  ...    """.    a
+000222f0: 6c6c 5f65 7665 6e74 7320 3d20 5b5d 0a20  ll_events = []. 
+00022300: 2020 2063 7572 7265 6e74 5f73 7461 7274     current_start
+00022310: 5f74 6f6b 656e 203d 2073 7461 7274 5f74  _token = start_t
+00022320: 6f6b 656e 0a20 2020 2023 2069 7320 6361  oken.    # is ca
+00022330: 7070 6564 2061 7420 3130 3030 2061 7420  pped at 1000 at 
+00022340: 7365 7276 6572 2073 6964 650a 2020 2020  server side.    
+00022350: 2320 3130 2073 6565 6d73 2074 6f6f 2073  # 10 seems too s
+00022360: 6d61 6c6c 2c20 692e 652e 2074 6f6f 2073  mall, i.e. too s
+00022370: 6c6f 770a 2020 2020 2320 3130 3020 746f  low.    # 100 to
+00022380: 2035 3030 2073 6565 6d20 676f 6f64 2076   500 seem good v
+00022390: 616c 7565 732c 2064 6570 656e 6473 206f  alues, depends o
+000223a0: 6e20 6e65 7477 6f72 6b20 7370 6565 642c  n network speed,
+000223b0: 2073 6572 7665 7220 6c6f 6164 2c20 2e2e   server load, ..
+000223c0: 2e0a 2020 2020 2320 6578 616d 706c 6520  ..    # example 
+000223d0: 7275 6e3a 2032 3530 2d2d 3e37 6d69 6e33  run: 250-->7min3
+000223e0: 3073 2c20 3530 302d 2d3e 346d 696e 3330  0s, 500-->4min30
+000223f0: 730a 2020 2020 6d61 785f 6d73 675f 7065  s.    max_msg_pe
+00022400: 725f 7075 6c6c 203d 2035 3030 0a20 2020  r_pull = 500.   
+00022410: 2077 6869 6c65 2054 7275 653a 0a20 2020   while True:.   
+00022420: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00022430: 2020 2020 2020 7265 7370 203d 2061 7761        resp = awa
+00022440: 6974 2063 6c69 656e 742e 726f 6f6d 5f6d  it client.room_m
+00022450: 6573 7361 6765 7328 0a20 2020 2020 2020  essages(.       
+00022460: 2020 2020 2020 2020 2072 6f6f 6d5f 6964           room_id
+00022470: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00022480: 2020 6375 7272 656e 745f 7374 6172 745f    current_start_
+00022490: 746f 6b65 6e2c 0a20 2020 2020 2020 2020  token,.         
+000224a0: 2020 2020 2020 206c 696d 6974 3d6d 6178         limit=max
+000224b0: 5f6d 7367 5f70 6572 5f70 756c 6c2c 0a20  _msg_per_pull,. 
+000224c0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000224d0: 6972 6563 7469 6f6e 3d64 6972 6563 7469  irection=directi
+000224e0: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
+000224f0: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+00022500: 2045 7863 6570 7469 6f6e 2061 7320 653a   Exception as e:
+00022510: 0a20 2020 2020 2020 2020 2020 2023 2064  .            # d
+00022520: 7572 696e 6720 7465 7374 696e 6720 4920  uring testing I 
+00022530: 6f62 7365 7276 6564 2074 6861 7420 736f  observed that so
+00022540: 6d65 7469 6d65 7320 616e 2065 7863 6570  metimes an excep
+00022550: 7469 6f6e 2069 7320 7261 6973 6564 2c0a  tion is raised,.
+00022560: 2020 2020 2020 2020 2020 2020 2320 6275              # bu
+00022570: 7420 6520 6973 2065 6d70 7479 2e20 5374  t e is empty. St
+00022580: 6163 6b74 7261 6365 2068 6164 2061 7379  acktrace had asy
+00022590: 6e63 696f 2e65 7863 6570 7469 6f6e 732e  ncio.exceptions.
+000225a0: 5469 6d65 6f75 7445 7272 6f72 2e0a 2020  TimeoutError..  
+000225b0: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
+000225c0: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
+000225d0: 2020 2020 2020 2020 2245 3136 313a 2022          "E161: "
+000225e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000225f0: 2022 4572 726f 7220 6475 7269 6e67 2067   "Error during g
+00022600: 6574 7469 6e67 206d 6573 7361 6765 732e  etting messages.
+00022610: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00022620: 2020 2022 4275 7420 7072 6f67 7261 6d20     "But program 
+00022630: 7769 6c6c 2063 6f6e 7469 6e75 6520 616e  will continue an
+00022640: 7977 6179 2c20 6465 7370 6974 6520 7468  yway, despite th
+00022650: 6520 6572 726f 722e 2022 0a20 2020 2020  e error. ".     
+00022660: 2020 2020 2020 2020 2020 2022 4e6f 7420             "Not 
+00022670: 616c 6c20 6d65 7373 6167 6573 206d 6967  all messages mig
+00022680: 6874 2068 6176 6520 6265 656e 2072 6574  ht have been ret
+00022690: 7269 6576 6564 2066 726f 6d20 7365 7276  rieved from serv
+000226a0: 6572 2e20 220a 2020 2020 2020 2020 2020  er. ".          
+000226b0: 2020 2020 2020 6622 4265 2077 6172 6e65        f"Be warne
+000226c0: 6421 2047 6f74 207b 6c65 6e28 616c 6c5f  d! Got {len(all_
+000226d0: 6576 656e 7473 297d 206d 6573 7361 6765  events)} message
+000226e0: 7320 736f 2066 6172 2e22 0a20 2020 2020  s so far.".     
+000226f0: 2020 2020 2020 2020 2020 2066 2245 7863             f"Exc
+00022700: 6570 7469 6f6e 3a20 7b74 7970 6528 6529  eption: {type(e)
+00022710: 7d20 7b65 7d22 0a20 2020 2020 2020 2020  } {e}".         
+00022720: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00022730: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
+00022740: 2031 0a20 2020 2020 2020 2020 2020 2067   1.            g
+00022750: 732e 6c6f 672e 6465 6275 6728 2248 6572  s.log.debug("Her
+00022760: 6520 6973 2074 6865 2074 7261 6365 6261  e is the traceba
+00022770: 636b 2e5c 6e22 202b 2074 7261 6365 6261  ck.\n" + traceba
+00022780: 636b 2e66 6f72 6d61 745f 6578 6328 2929  ck.format_exc())
+00022790: 0a20 2020 2020 2020 2020 2020 2062 7265  .            bre
+000227a0: 616b 0a20 2020 2020 2020 2069 6620 6973  ak.        if is
+000227b0: 696e 7374 616e 6365 2872 6573 702c 2052  instance(resp, R
+000227c0: 6f6f 6d4d 6573 7361 6765 7345 7272 6f72  oomMessagesError
+000227d0: 293a 0a20 2020 2020 2020 2020 2020 2067  ):.            g
+000227e0: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
+000227f0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+00022800: 6c6f 672e 6572 726f 7228 0a20 2020 2020  log.error(.     
+00022810: 2020 2020 2020 2020 2020 2022 4531 3632             "E162
+00022820: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
+00022830: 2020 2020 6622 726f 6f6d 5f6d 6573 7361      f"room_messa
+00022840: 6765 7320 6661 696c 6564 2077 6974 6820  ges failed with 
+00022850: 7265 7370 203d 207b 7072 6976 6163 795f  resp = {privacy_
+00022860: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
+00022870: 297d 220a 2020 2020 2020 2020 2020 2020  )}".            
+00022880: 290a 2020 2020 2020 2020 2020 2020 6272  ).            br
+00022890: 6561 6b20 2023 2073 6b69 7020 746f 2065  eak  # skip to e
+000228a0: 6e64 206f 6620 6675 6e63 7469 6f6e 0a20  nd of function. 
+000228b0: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+000228c0: 6275 6728 6622 476f 7420 7b6c 656e 2861  bug(f"Got {len(a
+000228d0: 6c6c 5f65 7665 6e74 7329 2b6c 656e 2872  ll_events)+len(r
+000228e0: 6573 702e 6368 756e 6b29 7d20 6d65 7373  esp.chunk)} mess
+000228f0: 6167 6573 2073 6f20 6661 722e 2229 0a20  ages so far."). 
+00022900: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+00022910: 6275 6728 6622 5265 6365 6976 6564 207b  bug(f"Received {
+00022920: 6c65 6e28 7265 7370 2e63 6875 6e6b 297d  len(resp.chunk)}
+00022930: 2065 7665 6e74 732e 2229 0a20 2020 2020   events.").     
+00022940: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+00022950: 0a20 2020 2020 2020 2020 2020 2066 2272  .            f"r
+00022960: 6f6f 6d5f 6d65 7373 6167 6573 2072 6573  oom_messages res
+00022970: 706f 6e73 6520 3d20 7b74 7970 6528 7265  ponse = {type(re
+00022980: 7370 297d 203a 3a20 220a 2020 2020 2020  sp)} :: ".      
+00022990: 2020 2020 2020 6622 7b70 7269 7661 6379        f"{privacy
+000229a0: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
+000229b0: 2929 7d2e 220a 2020 2020 2020 2020 290a  ))}.".        ).
+000229c0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+000229d0: 6562 7567 2866 2272 6f6f 6d5f 6d65 7373  ebug(f"room_mess
+000229e0: 6167 6573 2072 6f6f 6d5f 6964 203d 207b  ages room_id = {
+000229f0: 7265 7370 2e72 6f6f 6d5f 6964 7d2e 2229  resp.room_id}.")
+00022a00: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
+00022a10: 6465 6275 6728 6622 726f 6f6d 5f6d 6573  debug(f"room_mes
+00022a20: 7361 6765 7320 7374 6172 7420 3d20 2873  sages start = (s
+00022a30: 7472 2920 7b72 6573 702e 7374 6172 747d  tr) {resp.start}
+00022a40: 2e22 290a 2020 2020 2020 2020 6773 2e6c  .").        gs.l
+00022a50: 6f67 2e64 6562 7567 2866 2272 6f6f 6d5f  og.debug(f"room_
+00022a60: 6d65 7373 6167 6573 2065 6e64 203d 2028  messages end = (
+00022a70: 7374 7229 203a 3a20 7b72 6573 702e 656e  str) :: {resp.en
+00022a80: 647d 2e22 290a 2020 2020 2020 2020 6773  d}.").        gs
+00022a90: 2e6c 6f67 2e64 6562 7567 2866 2272 6f6f  .log.debug(f"roo
+00022aa0: 6d5f 6d65 7373 6167 6573 2063 6875 6e6b  m_messages chunk
+00022ab0: 203d 2028 6c69 7374 2920 3a3a 207b 7265   = (list) :: {re
+00022ac0: 7370 2e63 6875 6e6b 7d2e 2229 0a20 2020  sp.chunk}.").   
+00022ad0: 2020 2020 2023 2072 6573 702e 6368 756e       # resp.chun
+00022ae0: 6b20 6973 206a 7573 7420 6120 6c69 7374  k is just a list
+00022af0: 206f 6620 526f 6f6d 4d65 7373 6167 6520   of RoomMessage 
+00022b00: 6576 656e 7473 206c 696b 6520 7468 6973  events like this
+00022b10: 2065 7861 6d70 6c65 3a0a 2020 2020 2020   example:.      
+00022b20: 2020 2320 6368 756e 6b3d 5b52 6f6f 6d4d    # chunk=[RoomM
+00022b30: 6573 7361 6765 5465 7874 282e 2e2e 295d  essageText(...)]
+00022b40: 0a20 2020 2020 2020 2063 7572 7265 6e74  .        current
+00022b50: 5f73 7461 7274 5f74 6f6b 656e 203d 2072  _start_token = r
+00022b60: 6573 702e 656e 640a 2020 2020 2020 2020  esp.end.        
+00022b70: 6966 206c 656e 2872 6573 702e 6368 756e  if len(resp.chun
+00022b80: 6b29 203d 3d20 303a 0a20 2020 2020 2020  k) == 0:.       
+00022b90: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
+00022ba0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+00022bb0: 2020 2022 416c 6c20 6d65 7373 6167 6573     "All messages
+00022bc0: 2068 6176 6520 6265 656e 2072 6574 7269   have been retri
+00022bd0: 6576 6564 2066 726f 6d20 7365 7276 6572  eved from server
+00022be0: 2073 7563 6365 7373 6675 6c6c 792e 2022   successfully. "
+00022bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022c00: 2066 227b 6c65 6e28 616c 6c5f 6576 656e   f"{len(all_even
+00022c10: 7473 297d 206d 6573 7361 6765 7320 7765  ts)} messages we
+00022c20: 7265 2070 756c 6c65 6420 6672 6f6d 2073  re pulled from s
+00022c30: 6572 7665 722e 220a 2020 2020 2020 2020  erver.".        
+00022c40: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00022c50: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
+00022c60: 616c 6c5f 6576 656e 7473 203d 2061 6c6c  all_events = all
+00022c70: 5f65 7665 6e74 7320 2b20 7265 7370 2e63  _events + resp.c
+00022c80: 6875 6e6b 0a20 2020 2072 6574 7572 6e20  hunk.    return 
+00022c90: 616c 6c5f 6576 656e 7473 0a0a 0a23 2061  all_events...# a
+00022ca0: 6363 6f72 6469 6e67 2074 6f20 7079 6c61  ccording to pyla
+00022cb0: 6d61 3a20 6675 6e63 7469 6f6e 2074 6f6f  ma: function too
+00022cc0: 2063 6f6d 706c 6578 3a20 4339 3031 2023   complex: C901 #
+00022cd0: 206e 6f71 613a 2043 3930 310a 6173 796e   noqa: C901.asyn
+00022ce0: 6320 6465 6620 6c69 7374 656e 5f61 6c6c  c def listen_all
+00022cf0: 2820 2023 206e 6f71 613a 2043 3930 310a  (  # noqa: C901.
+00022d00: 2020 2020 636c 6965 6e74 3a20 4173 796e      client: Asyn
+00022d10: 6343 6c69 656e 742c 2063 7265 6465 6e74  cClient, credent
+00022d20: 6961 6c73 3a20 6469 6374 0a29 202d 3e20  ials: dict.) -> 
+00022d30: 4e6f 6e65 3a20 2023 206e 6f71 613a 2043  None:  # noqa: C
+00022d40: 3930 310a 2020 2020 2222 2247 6574 2061  901.    """Get a
+00022d50: 6c6c 206d 6573 7361 6765 732c 2074 6865  ll messages, the
+00022d60: 6e20 7175 6974 2e0a 0a20 2020 2041 7267  n quit...    Arg
+00022d70: 756d 656e 7473 3a0a 2020 2020 2d2d 2d2d  uments:.    ----
+00022d80: 2d2d 2d2d 2d0a 2020 2020 2020 2020 636c  -----.        cl
+00022d90: 6965 6e74 3a20 4173 796e 6343 6c69 656e  ient: AsyncClien
+00022da0: 7420 3a20 7468 6520 6372 6561 7465 6420  t : the created 
+00022db0: 4e49 4f20 636c 6965 6e74 0a20 2020 2020  NIO client.     
+00022dc0: 2020 2063 7265 6465 6e74 6961 6c73 3a20     credentials: 
+00022dd0: 6469 6374 203a 2063 7265 6465 6e74 6961  dict : credentia
+00022de0: 6c73 2064 6963 7469 6f6e 6172 7920 6672  ls dictionary fr
+00022df0: 6f6d 2074 6865 2063 7265 6465 6e74 6961  om the credentia
+00022e00: 6c73 2066 696c 650a 0a20 2020 2047 6574  ls file..    Get
+00022e10: 2061 6c6c 206d 6573 7361 6765 732e 2053   all messages. S
+00022e20: 6f6d 6520 6d69 6768 7420 6265 206f 6c64  ome might be old
+00022e30: 2c20 692e 652e 2061 6c72 6561 6479 0a20  , i.e. already. 
+00022e40: 2020 2072 6561 6420 6265 666f 7265 2c20     read before, 
+00022e50: 736f 6d65 206d 6967 6874 2062 6520 6e65  some might be ne
+00022e60: 772c 2069 2e65 2e20 6e65 7665 7220 7265  w, i.e. never re
+00022e70: 6164 2062 6566 6f72 652e 0a20 2020 2050  ad before..    P
+00022e80: 7269 6e74 2074 6865 6d2e 2054 6865 6e20  rint them. Then 
+00022e90: 6c65 6176 652e 0a0a 2020 2020 5468 6520  leave...    The 
+00022ea0: 6675 6e63 7469 6f6e 2072 6f6f 6d5f 6d65  function room_me
+00022eb0: 7373 6167 6573 2829 2069 7320 7573 6564  ssages() is used
+00022ec0: 2074 6f20 6765 7420 616c 6c20 6d65 7373   to get all mess
+00022ed0: 6167 6573 2e0a 0a20 2020 2022 2222 0a20  ages...    """. 
+00022ee0: 2020 2023 2077 6520 6361 6c6c 2073 796e     # we call syn
+00022ef0: 6328 2920 746f 2067 6574 2074 6865 206e  c() to get the n
+00022f00: 6578 745f 6261 7463 6820 6d61 726b 6572  ext_batch marker
+00022f10: 0a20 2020 2023 2077 6520 7365 7420 6675  .    # we set fu
+00022f20: 6c6c 5f73 7461 7465 3d54 7275 6520 746f  ll_state=True to
+00022f30: 2067 6574 2061 6c6c 2072 6f6f 6d5f 6964   get all room_id
+00022f40: 730a 2020 2020 7265 7370 5f73 203d 2061  s.    resp_s = a
+00022f50: 7761 6974 2073 796e 6368 726f 6e69 7a65  wait synchronize
+00022f60: 2863 6c69 656e 7429 2020 2320 7379 6e63  (client)  # sync
+00022f70: 2829 2074 6f20 6765 7420 726f 6f6d 730a  () to get rooms.
+00022f80: 2020 2020 2320 7468 6973 2070 7269 6e74      # this print
+00022f90: 7320 6120 7375 6d6d 6172 7920 6f66 2061  s a summary of a
+00022fa0: 6c6c 206e 6577 206d 6573 7361 6765 7320  ll new messages 
+00022fb0: 6375 7272 656e 746c 7920 7761 6974 696e  currently waitin
+00022fc0: 6720 696e 2074 6865 2071 7565 7565 0a20  g in the queue. 
+00022fd0: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+00022fe0: 6622 7379 6e63 2072 6573 706f 6e73 6520  f"sync response 
+00022ff0: 3d20 7b74 7970 6528 7265 7370 5f73 297d  = {type(resp_s)}
+00023000: 203a 3a20 7b72 6573 705f 737d 2229 0a20   :: {resp_s}"). 
+00023010: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+00023020: 6622 636c 6965 6e74 2e6e 6578 745f 6261  f"client.next_ba
+00023030: 7463 6820 6166 7465 7220 3d20 2873 7472  tch after = (str
+00023040: 2920 7b63 6c69 656e 742e 6e65 7874 5f62  ) {client.next_b
+00023050: 6174 6368 7d22 290a 2020 2020 6773 2e6c  atch}").    gs.l
+00023060: 6f67 2e64 6562 7567 2866 2273 796e 6320  og.debug(f"sync 
+00023070: 6e65 7874 5f62 6174 6368 203d 2028 7374  next_batch = (st
+00023080: 7229 207b 7265 7370 5f73 2e6e 6578 745f  r) {resp_s.next_
+00023090: 6261 7463 687d 2229 0a20 2020 2067 732e  batch}").    gs.
+000230a0: 6c6f 672e 6465 6275 6728 6622 7379 6e63  log.debug(f"sync
+000230b0: 2072 6f6f 6d73 203d 2028 6e69 6f2e 7265   rooms = (nio.re
+000230c0: 7370 6f6e 7365 732e 526f 6f6d 7329 207b  sponses.Rooms) {
+000230d0: 7265 7370 5f73 2e72 6f6f 6d73 7d22 290a  resp_s.rooms}").
+000230e0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+000230f0: 2866 2263 6c69 656e 742e 726f 6f6d 7320  (f"client.rooms 
+00023100: 3d20 7b63 6c69 656e 742e 726f 6f6d 737d  = {client.rooms}
+00023110: 2229 0a20 2020 2069 6620 6e6f 7420 7265  ").    if not re
+00023120: 7370 5f73 2e72 6f6f 6d73 2e6a 6f69 6e3a  sp_s.rooms.join:
+00023130: 2020 2320 6e6f 2052 6f6f 6d73 210a 2020    # no Rooms!.  
+00023140: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+00023150: 7567 2866 2273 796e 6320 7265 7475 726e  ug(f"sync return
+00023160: 6564 206e 6f20 726f 6f6d 7320 3d20 7b72  ed no rooms = {r
+00023170: 6573 705f 732e 726f 6f6d 732e 6a6f 696e  esp_s.rooms.join
+00023180: 7d22 290a 2020 2020 2020 2020 7265 7475  }").        retu
+00023190: 726e 0a0a 2020 2020 2320 5365 7420 7570  rn..    # Set up
+000231a0: 2065 7665 6e74 2063 616c 6c62 6163 6b73   event callbacks
+000231b0: 0a20 2020 2063 616c 6c62 6163 6b73 203d  .    callbacks =
+000231c0: 2043 616c 6c62 6163 6b73 2863 6c69 656e   Callbacks(clien
+000231d0: 7429 0a20 2020 2023 204e 6f74 653a 2077  t).    # Note: w
+000231e0: 6520 6172 6520 4e4f 5420 7265 6769 7374  e are NOT regist
+000231f0: 6572 696e 6720 6120 6361 6c6c 6261 636b  ering a callback
+00023200: 2066 756e 7469 6f6e 210a 0a20 2020 2023   funtion!..    #
+00023210: 2072 6f6f 6d5f 6964 203d 206c 6973 7428   room_id = list(
+00023220: 7265 7370 5f73 2e72 6f6f 6d73 2e6a 6f69  resp_s.rooms.joi
+00023230: 6e2e 6b65 7973 2829 295b 305d 2020 2320  n.keys())[0]  # 
+00023240: 6669 7273 7420 726f 6f6d 5f69 6420 6672  first room_id fr
+00023250: 6f6d 2064 6963 740a 2020 2020 2320 616c  om dict.    # al
+00023260: 7465 726e 6174 6976 6520 7761 7920 6f66  ternative way of
+00023270: 2067 6574 7469 6e67 2072 6f6f 6d5f 6964   getting room_id
+00023280: 2c20 636c 6965 6e74 2e72 6f6f 6d73 2069  , client.rooms i
+00023290: 7320 616c 736f 2061 2064 6963 740a 2020  s also a dict.  
+000232a0: 2020 2320 726f 6f6d 5f69 6420 3d20 6c69    # room_id = li
+000232b0: 7374 2863 6c69 656e 742e 726f 6f6d 732e  st(client.rooms.
+000232c0: 6b65 7973 2829 295b 305d 2020 2320 6669  keys())[0]  # fi
+000232d0: 7273 7420 726f 6f6d 5f69 6420 6672 6f6d  rst room_id from
+000232e0: 2064 6963 740a 0a20 2020 2023 2067 6574   dict..    # get
+000232f0: 2072 6f6f 6d73 2061 7320 7370 6563 6966   rooms as specif
+00023300: 6965 6420 6279 2074 6865 2075 7365 7220  ied by the user 
+00023310: 7468 7275 2061 7267 7320 6f72 2063 7265  thru args or cre
+00023320: 6465 6e74 6961 6c20 6669 6c65 0a20 2020  dential file.   
+00023330: 2072 6f6f 6d73 203d 2061 7761 6974 2064   rooms = await d
+00023340: 6574 6572 6d69 6e65 5f72 6f6f 6d73 2863  etermine_rooms(c
+00023350: 7265 6465 6e74 6961 6c73 5b22 726f 6f6d  redentials["room
+00023360: 5f69 6422 5d2c 2063 6c69 656e 742c 2063  _id"], client, c
+00023370: 7265 6465 6e74 6961 6c73 290a 2020 2020  redentials).    
+00023380: 6773 2e6c 6f67 2e64 6562 7567 2866 2252  gs.log.debug(f"R
+00023390: 6f6f 6d73 2061 7265 3a20 7b72 6f6f 6d73  ooms are: {rooms
+000233a0: 7d22 290a 0a20 2020 2023 2054 6f20 6c6f  }")..    # To lo
+000233b0: 6f70 206f 7665 7220 616c 6c20 726f 6f6d  op over all room
+000233c0: 732c 206f 6e65 2063 616e 206c 6f6f 7020  s, one can loop 
+000233d0: 7468 726f 7567 6820 7468 6520 6a6f 696e  through the join
+000233e0: 2064 6963 7469 6f6e 6172 792e 2069 2e65   dictionary. i.e
+000233f0: 2e0a 2020 2020 2320 666f 7220 726f 6f6d  ..    # for room
+00023400: 5f69 642c 2072 6f6f 6d5f 696e 666f 2069  _id, room_info i
+00023410: 6e20 7265 7370 5f73 2e72 6f6f 6d73 2e6a  n resp_s.rooms.j
+00023420: 6f69 6e2e 6974 656d 7328 293a 2020 2320  oin.items():  # 
+00023430: 6c6f 6f70 2061 6c6c 2072 6f6f 6d73 0a20  loop all rooms. 
+00023440: 2020 2066 6f72 2072 6f6f 6d5f 6964 2069     for room_id i
+00023450: 6e20 726f 6f6d 733a 2020 2320 6c6f 6f70  n rooms:  # loop
+00023460: 206f 6e6c 7920 6f76 6572 2075 7365 7220   only over user 
+00023470: 7370 6563 6966 6965 6420 726f 6f6d 730a  specified rooms.
+00023480: 2020 2020 2020 2020 7072 6576 5f62 6174          prev_bat
+00023490: 6368 203d 2072 6573 705f 732e 726f 6f6d  ch = resp_s.room
+000234a0: 732e 6a6f 696e 5b72 6f6f 6d5f 6964 5d2e  s.join[room_id].
+000234b0: 7469 6d65 6c69 6e65 2e70 7265 765f 6261  timeline.prev_ba
+000234c0: 7463 680a 2020 2020 2020 2020 6261 636b  tch.        back
+000234d0: 5f65 7665 6e74 7320 3d20 6177 6169 7420  _events = await 
+000234e0: 7265 6164 5f61 6c6c 5f65 7665 6e74 735f  read_all_events_
+000234f0: 696e 5f64 6972 6563 7469 6f6e 280a 2020  in_direction(.  
+00023500: 2020 2020 2020 2020 2020 636c 6965 6e74            client
+00023510: 2c20 726f 6f6d 5f69 642c 2070 7265 765f  , room_id, prev_
+00023520: 6261 7463 682c 204d 6573 7361 6765 4469  batch, MessageDi
+00023530: 7265 6374 696f 6e2e 6261 636b 0a20 2020  rection.back.   
+00023540: 2020 2020 2029 0a20 2020 2020 2020 2066       ).        f
+00023550: 726f 6e74 5f65 7665 6e74 7320 3d20 6177  ront_events = aw
+00023560: 6169 7420 7265 6164 5f61 6c6c 5f65 7665  ait read_all_eve
+00023570: 6e74 735f 696e 5f64 6972 6563 7469 6f6e  nts_in_direction
+00023580: 280a 2020 2020 2020 2020 2020 2020 636c  (.            cl
+00023590: 6965 6e74 2c20 726f 6f6d 5f69 642c 2070  ient, room_id, p
+000235a0: 7265 765f 6261 7463 682c 204d 6573 7361  rev_batch, Messa
+000235b0: 6765 4469 7265 6374 696f 6e2e 6672 6f6e  geDirection.fron
+000235c0: 740a 2020 2020 2020 2020 290a 0a20 2020  t.        )..   
+000235d0: 2020 2020 2023 2057 6520 6861 7665 2074       # We have t
+000235e0: 6f20 7265 7665 7273 6520 7468 6520 6669  o reverse the fi
+000235f0: 7273 7420 6c69 7374 2073 696e 6365 2077  rst list since w
+00023600: 6520 6172 6520 676f 696e 6720 6261 636b  e are going back
+00023610: 7761 7264 7320 2862 7574 0a20 2020 2020  wards (but.     
+00023620: 2020 2023 2077 6520 7761 6e74 2074 6f20     # we want to 
+00023630: 6861 7665 2061 2063 6872 6f6e 6f6c 6f67  have a chronolog
+00023640: 6963 616c 206f 7264 6572 290a 2020 2020  ical order).    
+00023650: 2020 2020 616c 6c5f 6576 656e 7473 203d      all_events =
+00023660: 2062 6163 6b5f 6576 656e 7473 5b3a 3a2d   back_events[::-
+00023670: 315d 202b 2066 726f 6e74 5f65 7665 6e74  1] + front_event
+00023680: 730a 0a20 2020 2020 2020 2066 6f72 2065  s..        for e
+00023690: 7665 6e74 2069 6e20 616c 6c5f 6576 656e  vent in all_even
+000236a0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+000236b0: 6773 2e6c 6f67 2e64 6562 7567 2866 2273  gs.log.debug(f"s
+000236c0: 656e 6469 6e67 2065 7665 6e74 2074 6f20  ending event to 
+000236d0: 6361 6c6c 6261 636b 203d 207b 6576 656e  callback = {even
+000236e0: 747d 2e22 290a 2020 2020 2020 2020 2020  t}.").          
+000236f0: 2020 6966 2063 6c69 656e 742e 726f 6f6d    if client.room
+00023700: 7320 616e 6420 636c 6965 6e74 2e72 6f6f  s and client.roo
+00023710: 6d73 5b72 6f6f 6d5f 6964 5d3a 0a20 2020  ms[room_id]:.   
+00023720: 2020 2020 2020 2020 2020 2020 2072 6f6f               roo
+00023730: 6d20 3d20 636c 6965 6e74 2e72 6f6f 6d73  m = client.rooms
+00023740: 5b72 6f6f 6d5f 6964 5d0a 2020 2020 2020  [room_id].      
+00023750: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00023760: 2020 2020 2020 2020 2020 2020 726f 6f6d              room
+00023770: 203d 204d 6174 7269 7852 6f6f 6d28 726f   = MatrixRoom(ro
+00023780: 6f6d 5f69 642c 204e 6f6e 652c 2054 7275  om_id, None, Tru
+00023790: 6529 2020 2320 6475 6d6d 795f 726f 6f6d  e)  # dummy_room
+000237a0: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+000237b0: 6974 2063 616c 6c62 6163 6b73 2e6d 6573  it callbacks.mes
+000237c0: 7361 6765 5f63 616c 6c62 6163 6b28 726f  sage_callback(ro
+000237d0: 6f6d 2c20 6576 656e 7429 0a20 2020 2020  om, event).     
+000237e0: 2020 2069 6620 616c 6c5f 6576 656e 7473     if all_events
+000237f0: 3a20 2023 206c 6973 7420 6e6f 7420 656d  :  # list not em
+00023800: 7074 790a 2020 2020 2020 2020 2020 2020  pty.            
+00023810: 6c61 7374 5f65 7665 6e74 203d 2061 6c6c  last_event = all
+00023820: 5f65 7665 6e74 735b 2d31 5d0a 2020 2020  _events[-1].    
+00023830: 2020 2020 2020 2020 7265 7370 203d 2061          resp = a
+00023840: 7761 6974 2063 6c69 656e 742e 726f 6f6d  wait client.room
+00023850: 5f72 6561 645f 6d61 726b 6572 7328 0a20  _read_markers(. 
+00023860: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00023870: 6f6f 6d5f 6964 3d72 6f6f 6d5f 6964 2c0a  oom_id=room_id,.
+00023880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023890: 6675 6c6c 795f 7265 6164 5f65 7665 6e74  fully_read_event
+000238a0: 3d6c 6173 745f 6576 656e 742e 6576 656e  =last_event.even
+000238b0: 745f 6964 2c0a 2020 2020 2020 2020 2020  t_id,.          
+000238c0: 2020 2020 2020 7265 6164 5f65 7665 6e74        read_event
+000238d0: 3d6c 6173 745f 6576 656e 742e 6576 656e  =last_event.even
+000238e0: 745f 6964 2c0a 2020 2020 2020 2020 2020  t_id,.          
+000238f0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00023900: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
+00023910: 7370 2c20 526f 6f6d 5265 6164 4d61 726b  sp, RoomReadMark
+00023920: 6572 7345 7272 6f72 293a 0a20 2020 2020  ersError):.     
+00023930: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
+00023940: 672e 6572 726f 7228 0a20 2020 2020 2020  g.error(.       
+00023950: 2020 2020 2020 2020 2020 2020 2022 4531               "E1
+00023960: 3633 3a20 220a 2020 2020 2020 2020 2020  63: ".          
+00023970: 2020 2020 2020 2020 2020 2272 6f6f 6d5f            "room_
+00023980: 7265 6164 5f6d 6172 6b65 7273 2066 6169  read_markers fai
+00023990: 6c65 6420 7769 7468 2072 6573 706f 6e73  led with respons
+000239a0: 6520 220a 2020 2020 2020 2020 2020 2020  e ".            
+000239b0: 2020 2020 2020 2020 6622 7b70 7269 7661          f"{priva
+000239c0: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
+000239d0: 7370 2929 7d2e 220a 2020 2020 2020 2020  sp))}.".        
+000239e0: 2020 2020 2020 2020 290a 0a0a 6173 796e          )...asyn
+000239f0: 6320 6465 6620 6163 7469 6f6e 5f6c 6973  c def action_lis
+00023a00: 7465 6e28 2920 2d3e 204e 6f6e 653a 0a20  ten() -> None:. 
+00023a10: 2020 2022 2222 4c69 7374 656e 2077 6869     """Listen whi
+00023a20: 6c65 2062 6569 6e67 206c 6f67 6765 6420  le being logged 
+00023a30: 696e 2e22 2222 0a20 2020 2069 6620 6e6f  in.""".    if no
+00023a40: 7420 6773 2e63 6c69 656e 7420 616e 6420  t gs.client and 
+00023a50: 6e6f 7420 6773 2e63 7265 6465 6e74 6961  not gs.credentia
+00023a60: 6c73 3a0a 2020 2020 2020 2020 6773 2e6c  ls:.        gs.l
+00023a70: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
+00023a80: 2020 2020 2020 2245 3136 343a 2022 2022        "E164: " "
+00023a90: 436c 6965 6e74 206f 7220 6372 6564 656e  Client or creden
+00023aa0: 7469 616c 7320 6e6f 7420 7365 742e 2053  tials not set. S
+00023ab0: 6b69 7070 696e 6720 6163 7469 6f6e 2e22  kipping action."
+00023ac0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00023ad0: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
+00023ae0: 2b3d 2031 0a20 2020 2020 2020 2072 6574  += 1.        ret
+00023af0: 7572 6e0a 2020 2020 7472 793a 0a20 2020  urn.    try:.   
+00023b00: 2020 2020 2023 2053 796e 6320 656e 6372       # Sync encr
+00023b10: 7970 7469 6f6e 206b 6579 7320 7769 7468  yption keys with
+00023b20: 2074 6865 2073 6572 7665 720a 2020 2020   the server.    
+00023b30: 2020 2020 2320 5265 7175 6972 6564 2066      # Required f
+00023b40: 6f72 2070 6172 7469 6369 7061 7469 6e67  or participating
+00023b50: 2069 6e20 656e 6372 7970 7465 6420 726f   in encrypted ro
+00023b60: 6f6d 730a 2020 2020 2020 2020 6966 2067  oms.        if g
+00023b70: 732e 636c 6965 6e74 2e73 686f 756c 645f  s.client.should_
+00023b80: 7570 6c6f 6164 5f6b 6579 733a 0a20 2020  upload_keys:.   
+00023b90: 2020 2020 2020 2020 2061 7761 6974 2067           await g
+00023ba0: 732e 636c 6965 6e74 2e6b 6579 735f 7570  s.client.keys_up
+00023bb0: 6c6f 6164 2829 0a20 2020 2020 2020 2067  load().        g
+00023bc0: 732e 6c6f 672e 6465 6275 6728 6622 4c69  s.log.debug(f"Li
+00023bd0: 7374 656e 696e 6720 7479 7065 3a20 7b67  stening type: {g
+00023be0: 732e 7061 2e6c 6973 7465 6e7d 2229 0a20  s.pa.listen}"). 
+00023bf0: 2020 2020 2020 2069 6620 6773 2e70 612e         if gs.pa.
+00023c00: 6c69 7374 656e 203d 3d20 464f 5245 5645  listen == FOREVE
+00023c10: 523a 0a20 2020 2020 2020 2020 2020 2061  R:.            a
+00023c20: 7761 6974 206c 6973 7465 6e5f 666f 7265  wait listen_fore
+00023c30: 7665 7228 6773 2e63 6c69 656e 7429 0a20  ver(gs.client). 
+00023c40: 2020 2020 2020 2065 6c69 6620 6773 2e70         elif gs.p
+00023c50: 612e 6c69 7374 656e 203d 3d20 4f4e 4345  a.listen == ONCE
+00023c60: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
+00023c70: 6169 7420 6c69 7374 656e 5f6f 6e63 6528  ait listen_once(
+00023c80: 6773 2e63 6c69 656e 7429 0a20 2020 2020  gs.client).     
+00023c90: 2020 2020 2020 2023 2063 6f75 6c64 2075         # could u
+00023ca0: 7365 2027 6177 6169 7420 6c69 7374 656e  se 'await listen
+00023cb0: 5f6f 6e63 655f 616c 7465 726e 6174 6976  _once_alternativ
+00023cc0: 6528 6773 2e63 6c69 656e 7429 270a 2020  e(gs.client)'.  
+00023cd0: 2020 2020 2020 2020 2020 2320 6173 2061            # as a
+00023ce0: 6e20 616c 7465 726e 6174 6976 6520 696d  n alternative im
+00023cf0: 706c 656d 656e 7461 7469 6f6e 0a20 2020  plementation.   
+00023d00: 2020 2020 2065 6c69 6620 6773 2e70 612e       elif gs.pa.
+00023d10: 6c69 7374 656e 203d 3d20 5441 494c 3a0a  listen == TAIL:.
+00023d20: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+00023d30: 7420 6c69 7374 656e 5f74 6169 6c28 6773  t listen_tail(gs
+00023d40: 2e63 6c69 656e 742c 2067 732e 6372 6564  .client, gs.cred
+00023d50: 656e 7469 616c 7329 0a20 2020 2020 2020  entials).       
+00023d60: 2065 6c69 6620 6773 2e70 612e 6c69 7374   elif gs.pa.list
+00023d70: 656e 203d 3d20 414c 4c3a 0a20 2020 2020  en == ALL:.     
+00023d80: 2020 2020 2020 2061 7761 6974 206c 6973         await lis
+00023d90: 7465 6e5f 616c 6c28 6773 2e63 6c69 656e  ten_all(gs.clien
+00023da0: 742c 2067 732e 6372 6564 656e 7469 616c  t, gs.credential
+00023db0: 7329 0a20 2020 2020 2020 2065 6c73 653a  s).        else:
+00023dc0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+00023dd0: 6c6f 672e 6572 726f 7228 0a20 2020 2020  log.error(.     
+00023de0: 2020 2020 2020 2020 2020 2022 4531 3635             "E165
+00023df0: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
+00023e00: 2020 2020 6627 556e 7265 636f 676e 697a      f'Unrecogniz
+00023e10: 6564 206c 6973 7465 6e69 6e67 2074 7970  ed listening typ
+00023e20: 6520 227b 6773 2e70 612e 6c69 7374 656e  e "{gs.pa.listen
+00023e30: 7d22 2e20 270a 2020 2020 2020 2020 2020  }". '.          
+00023e40: 2020 2020 2020 2253 6b69 7070 696e 6720        "Skipping 
+00023e50: 6c69 7374 656e 696e 672e 220a 2020 2020  listening.".    
+00023e60: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00023e70: 2020 2020 2020 6773 2e65 7272 5f63 6f75        gs.err_cou
+00023e80: 6e74 202b 3d20 310a 2020 2020 6578 6365  nt += 1.    exce
+00023e90: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
+00023ea0: 653a 0a20 2020 2020 2020 2067 732e 6c6f  e:.        gs.lo
+00023eb0: 672e 6572 726f 7228 0a20 2020 2020 2020  g.error(.       
+00023ec0: 2020 2020 2022 4531 3636 3a20 220a 2020       "E166: ".  
+00023ed0: 2020 2020 2020 2020 2020 2245 7272 6f72            "Error
+00023ee0: 2064 7572 696e 6720 6c69 7374 656e 696e   during listenin
+00023ef0: 672e 2043 6f6e 7469 6e75 696e 6720 6465  g. Continuing de
+00023f00: 7370 6974 6520 6572 726f 722e 2022 0a20  spite error. ". 
+00023f10: 2020 2020 2020 2020 2020 2066 2245 7863             f"Exc
+00023f20: 6570 7469 6f6e 3a20 7b65 7d22 0a20 2020  eption: {e}".   
+00023f30: 2020 2020 2029 0a20 2020 2020 2020 2067       ).        g
+00023f40: 732e 6c6f 672e 6465 6275 6728 2248 6572  s.log.debug("Her
+00023f50: 6520 6973 2074 6865 2074 7261 6365 6261  e is the traceba
+00023f60: 636b 2e5c 6e22 202b 2074 7261 6365 6261  ck.\n" + traceba
+00023f70: 636b 2e66 6f72 6d61 745f 6578 6328 2929  ck.format_exc())
+00023f80: 0a20 2020 2020 2020 2067 732e 6572 725f  .        gs.err_
+00023f90: 636f 756e 7420 2b3d 2031 0a0a 0a61 7379  count += 1...asy
+00023fa0: 6e63 2064 6566 2061 6374 696f 6e5f 7365  nc def action_se
+00023fb0: 745f 6465 7669 6365 5f6e 616d 6528 0a20  t_device_name(. 
+00023fc0: 2020 2063 6c69 656e 743a 2041 7379 6e63     client: Async
+00023fd0: 436c 6965 6e74 2c20 6372 6564 656e 7469  Client, credenti
+00023fe0: 616c 733a 2064 6963 740a 2920 2d3e 204e  als: dict.) -> N
+00023ff0: 6f6e 653a 0a20 2020 2022 2222 5365 742c  one:.    """Set,
+00024000: 2072 656e 616d 6520 7468 6520 6465 7669   rename the devi
+00024010: 6365 206e 616d 6520 6f66 2069 7473 656c  ce name of itsel
+00024020: 6620 7768 696c 6520 616c 7265 6164 7920  f while already 
+00024030: 6265 696e 6720 6c6f 6767 6564 2069 6e2e  being logged in.
+00024040: 2222 220a 2020 2020 636f 6e74 656e 7420  """.    content 
+00024050: 3d20 7b22 6465 7669 6365 5f6e 616d 6522  = {"device_name"
+00024060: 3a20 6773 2e70 612e 7365 745f 6465 7669  : gs.pa.set_devi
+00024070: 6365 5f6e 616d 657d 0a20 2020 2072 6573  ce_name}.    res
+00024080: 7020 3d20 6177 6169 7420 636c 6965 6e74  p = await client
+00024090: 2e75 7064 6174 655f 6465 7669 6365 2863  .update_device(c
+000240a0: 7265 6465 6e74 6961 6c73 5b22 6465 7669  redentials["devi
+000240b0: 6365 5f69 6422 5d2c 2063 6f6e 7465 6e74  ce_id"], content
+000240c0: 290a 2020 2020 6966 2069 7369 6e73 7461  ).    if isinsta
+000240d0: 6e63 6528 7265 7370 2c20 5570 6461 7465  nce(resp, Update
+000240e0: 4465 7669 6365 4572 726f 7229 3a0a 2020  DeviceError):.  
+000240f0: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
+00024100: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00024110: 2245 3136 373a 2022 2066 2275 7064 6174  "E167: " f"updat
+00024120: 655f 6465 7669 6365 2066 6169 6c65 6420  e_device failed 
+00024130: 7769 7468 207b 7072 6976 6163 795f 6669  with {privacy_fi
+00024140: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
+00024150: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
+00024160: 2020 2020 6773 2e65 7272 5f63 6f75 6e74      gs.err_count
+00024170: 202b 3d20 310a 2020 2020 656c 7365 3a0a   += 1.    else:.
+00024180: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+00024190: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
+000241a0: 2020 6622 7570 6461 7465 5f64 6576 6963    f"update_devic
+000241b0: 6520 7375 6363 6573 7366 756c 2077 6974  e successful wit
+000241c0: 6820 7b70 7269 7661 6379 5f66 696c 7465  h {privacy_filte
+000241d0: 7228 7374 7228 7265 7370 2929 7d22 0a20  r(str(resp))}". 
+000241e0: 2020 2020 2020 2029 0a0a 0a61 7379 6e63         )...async
+000241f0: 2064 6566 2061 6374 696f 6e5f 7365 745f   def action_set_
+00024200: 6469 7370 6c61 795f 6e61 6d65 280a 2020  display_name(.  
+00024210: 2020 636c 6965 6e74 3a20 4173 796e 6343    client: AsyncC
+00024220: 6c69 656e 742c 2063 7265 6465 6e74 6961  lient, credentia
+00024230: 6c73 3a20 6469 6374 0a29 202d 3e20 4e6f  ls: dict.) -> No
+00024240: 6e65 3a0a 2020 2020 2222 2253 6574 2c20  ne:.    """Set, 
+00024250: 7265 6e61 6d65 2074 6865 206c 6f67 6765  rename the logge
+00024260: 6420 696e 2075 7365 7227 7320 6469 7370  d in user's disp
+00024270: 6c61 7920 6e61 6d65 2e20 4368 616e 6765  lay name. Change
+00024280: 206d 7920 6f77 6e0a 2020 2020 6469 7370   my own.    disp
+00024290: 6c61 7920 6e61 6d65 2e0a 2020 2020 5265  lay name..    Re
+000242a0: 6e61 6d65 2074 6865 2075 7365 7220 6279  name the user by
+000242b0: 2063 6861 6e67 696e 6720 6469 7370 6c61   changing displa
+000242c0: 7920 6e61 6d65 2e0a 2020 2020 4173 7375  y name..    Assu
+000242d0: 6d65 7320 7468 6174 2075 7365 7220 6973  mes that user is
+000242e0: 2061 6c72 6561 6479 206c 6f67 6765 6420   already logged 
+000242f0: 696e 2e0a 2020 2020 2222 220a 2020 2020  in..    """.    
+00024300: 7265 7370 203d 2061 7761 6974 2063 6c69  resp = await cli
+00024310: 656e 742e 7365 745f 6469 7370 6c61 796e  ent.set_displayn
+00024320: 616d 6528 6773 2e70 612e 7365 745f 6469  ame(gs.pa.set_di
+00024330: 7370 6c61 795f 6e61 6d65 290a 2020 2020  splay_name).    
+00024340: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
+00024350: 7370 2c20 5072 6f66 696c 6553 6574 4469  sp, ProfileSetDi
+00024360: 7370 6c61 794e 616d 6545 7272 6f72 293a  splayNameError):
+00024370: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
+00024380: 6572 726f 7228 0a20 2020 2020 2020 2020  error(.         
+00024390: 2020 2022 4531 3638 3a20 2220 6622 7365     "E168: " f"se
+000243a0: 745f 6469 7370 6c61 796e 616d 6520 6661  t_displayname fa
+000243b0: 696c 6564 2077 6974 6820 7b70 7269 7661  iled with {priva
+000243c0: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
+000243d0: 7370 2929 7d22 0a20 2020 2020 2020 2029  sp))}".        )
+000243e0: 0a20 2020 2020 2020 2067 732e 6572 725f  .        gs.err_
+000243f0: 636f 756e 7420 2b3d 2031 0a20 2020 2065  count += 1.    e
+00024400: 6c73 653a 0a20 2020 2020 2020 2067 732e  lse:.        gs.
+00024410: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
+00024420: 2020 2020 2020 2066 2273 6574 5f64 6973         f"set_dis
+00024430: 706c 6179 6e61 6d65 2073 7563 6365 7373  playname success
+00024440: 6675 6c20 7769 7468 207b 7072 6976 6163  ful with {privac
+00024450: 795f 6669 6c74 6572 2873 7472 2872 6573  y_filter(str(res
+00024460: 7029 297d 220a 2020 2020 2020 2020 290a  p))}".        ).
+00024470: 0a0a 6173 796e 6320 6465 6620 6163 7469  ..async def acti
+00024480: 6f6e 5f67 6574 5f64 6973 706c 6179 5f6e  on_get_display_n
+00024490: 616d 6528 0a20 2020 2063 6c69 656e 743a  ame(.    client:
+000244a0: 2041 7379 6e63 436c 6965 6e74 2c20 6372   AsyncClient, cr
+000244b0: 6564 656e 7469 616c 733a 2064 6963 740a  edentials: dict.
+000244c0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2022  ) -> None:.    "
+000244d0: 2222 4765 7420 6469 7370 6c61 7920 6e61  ""Get display na
+000244e0: 6d65 2873 2920 7768 696c 6520 616c 7265  me(s) while alre
+000244f0: 6164 7920 6c6f 6767 6564 2069 6e2e 2222  ady logged in.""
+00024500: 220a 2020 2020 6966 206e 6f74 2067 732e  ".    if not gs.
+00024510: 7061 2e75 7365 723a 0a20 2020 2020 2020  pa.user:.       
+00024520: 2023 2067 6574 2064 6973 706c 6179 206e   # get display n
+00024530: 616d 6520 6f66 206d 7973 656c 660a 2020  ame of myself.  
+00024540: 2020 2020 2020 7768 6f61 6d69 203d 2063        whoami = c
+00024550: 7265 6465 6e74 6961 6c73 5b22 7573 6572  redentials["user
+00024560: 5f69 6422 5d0a 2020 2020 2020 2020 7573  _id"].        us
+00024570: 6572 7320 3d20 5b77 686f 616d 695d 0a20  ers = [whoami]. 
+00024580: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00024590: 2075 7365 7273 203d 2067 732e 7061 2e75   users = gs.pa.u
+000245a0: 7365 720a 2020 2020 7573 6572 7320 3d20  ser.    users = 
+000245b0: 6c69 7374 2864 6963 742e 6672 6f6d 6b65  list(dict.fromke
+000245c0: 7973 2875 7365 7273 2929 2020 2320 7265  ys(users))  # re
+000245d0: 6d6f 7665 2064 7570 6c69 6361 7465 7320  move duplicates 
+000245e0: 696e 206c 6973 740a 2020 2020 666f 7220  in list.    for 
+000245f0: 7573 6572 2069 6e20 7573 6572 733a 0a20  user in users:. 
+00024600: 2020 2020 2020 2072 6573 7020 3d20 6177         resp = aw
+00024610: 6169 7420 636c 6965 6e74 2e67 6574 5f64  ait client.get_d
+00024620: 6973 706c 6179 6e61 6d65 2875 7365 7229  isplayname(user)
+00024630: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+00024640: 7374 616e 6365 2872 6573 702c 2050 726f  stance(resp, Pro
+00024650: 6669 6c65 4765 7444 6973 706c 6179 4e61  fileGetDisplayNa
+00024660: 6d65 4572 726f 7229 3a0a 2020 2020 2020  meError):.      
+00024670: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
+00024680: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00024690: 2020 2020 2245 3136 393a 2022 0a20 2020      "E169: ".   
+000246a0: 2020 2020 2020 2020 2020 2020 2066 2267               f"g
+000246b0: 6574 5f64 6973 706c 6179 6e61 6d65 2066  et_displayname f
+000246c0: 6169 6c65 6420 7769 7468 207b 7072 6976  ailed with {priv
+000246d0: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
+000246e0: 6573 7029 297d 220a 2020 2020 2020 2020  esp))}".        
+000246f0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00024700: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
+00024710: 3d20 310a 2020 2020 2020 2020 656c 7365  = 1.        else
+00024720: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
+00024730: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
+00024740: 2020 2020 2020 2020 2020 2020 6622 6765              f"ge
+00024750: 745f 6469 7370 6c61 796e 616d 6520 7375  t_displayname su
+00024760: 6363 6573 7366 756c 2077 6974 6820 7b70  ccessful with {p
+00024770: 7269 7661 6379 5f66 696c 7465 7228 7374  rivacy_filter(st
+00024780: 7228 7265 7370 2929 7d22 0a20 2020 2020  r(resp))}".     
+00024790: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000247a0: 2020 2020 2023 2072 6573 702e 6469 7370       # resp.disp
+000247b0: 6c61 796e 616d 6520 6973 2073 7472 206f  layname is str o
+000247c0: 7220 4e6f 6e65 2028 6861 7320 6e6f 2064  r None (has no d
+000247d0: 6973 706c 6179 206e 616d 6529 0a20 2020  isplay name).   
+000247e0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+000247f0: 7265 7370 2e64 6973 706c 6179 6e61 6d65  resp.displayname
+00024800: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00024810: 2020 6469 7370 6c61 796e 616d 6520 3d20    displayname = 
+00024820: 2222 2020 2320 6d65 616e 7320 6e6f 2064  ""  # means no d
+00024830: 6973 706c 6179 206e 616d 6520 6973 2073  isplay name is s
+00024840: 6574 0a20 2020 2020 2020 2020 2020 2065  et.            e
+00024850: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00024860: 2020 2020 2064 6973 706c 6179 6e61 6d65       displayname
+00024870: 203d 2072 6573 702e 6469 7370 6c61 796e   = resp.displayn
+00024880: 616d 650a 2020 2020 2020 2020 2020 2020  ame.            
+00024890: 2320 6f75 7470 7574 2066 6f72 6d61 7420  # output format 
+000248a0: 636f 6e74 726f 6c6c 6564 2076 6961 202d  controlled via -
+000248b0: 2d6f 7574 7075 7420 666c 6167 0a20 2020  -output flag.   
+000248c0: 2020 2020 2020 2020 2074 6578 7420 3d20           text = 
+000248d0: 6622 7b75 7365 727d 7b53 4550 7d7b 6469  f"{user}{SEP}{di
+000248e0: 7370 6c61 796e 616d 657d 220a 2020 2020  splayname}".    
+000248f0: 2020 2020 2020 2020 2320 4f62 6a65 6374          # Object
+00024900: 206f 6620 7479 7065 2052 6f6f 6d43 7265   of type RoomCre
+00024910: 6174 6552 6573 706f 6e73 6520 6973 206e  ateResponse is n
+00024920: 6f74 204a 534f 4e0a 2020 2020 2020 2020  ot JSON.        
+00024930: 2020 2020 2320 7365 7269 616c 697a 6162      # serializab
+00024940: 6c65 2c20 6865 6e63 6520 7765 2075 7365  le, hence we use
+00024950: 2074 6865 2064 6963 7469 6f6e 6172 792e   the dictionary.
+00024960: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
+00024970: 6e5f 6d61 7820 3d20 7265 7370 2e5f 5f64  n_max = resp.__d
+00024980: 6963 745f 5f0a 2020 2020 2020 2020 2020  ict__.          
+00024990: 2020 6a73 6f6e 5f6d 6178 2e75 7064 6174    json_max.updat
+000249a0: 6528 7b22 7573 6572 223a 2075 7365 727d  e({"user": user}
+000249b0: 2920 2023 2061 6464 2064 6963 7420 6974  )  # add dict it
+000249c0: 656d 730a 2020 2020 2020 2020 2020 2020  ems.            
+000249d0: 6a73 6f6e 5f20 3d20 6a73 6f6e 5f6d 6178  json_ = json_max
+000249e0: 2e63 6f70 7928 290a 2020 2020 2020 2020  .copy().        
+000249f0: 2020 2020 6a73 6f6e 5f2e 706f 7028 2274      json_.pop("t
+00024a00: 7261 6e73 706f 7274 5f72 6573 706f 6e73  ransport_respons
+00024a10: 6522 290a 2020 2020 2020 2020 2020 2020  e").            
+00024a20: 6a73 6f6e 5f73 7065 6320 3d20 4e6f 6e65  json_spec = None
+00024a30: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+00024a40: 6e74 5f6f 7574 7075 7428 0a20 2020 2020  nt_output(.     
+00024a50: 2020 2020 2020 2020 2020 2067 732e 7061             gs.pa
+00024a60: 2e6f 7574 7075 742c 0a20 2020 2020 2020  .output,.       
+00024a70: 2020 2020 2020 2020 2074 6578 743d 7465           text=te
+00024a80: 7874 2c0a 2020 2020 2020 2020 2020 2020  xt,.            
+00024a90: 2020 2020 6a73 6f6e 5f3d 6a73 6f6e 5f2c      json_=json_,
+00024aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024ab0: 206a 736f 6e5f 6d61 783d 6a73 6f6e 5f6d   json_max=json_m
+00024ac0: 6178 2c0a 2020 2020 2020 2020 2020 2020  ax,.            
+00024ad0: 2020 2020 6a73 6f6e 5f73 7065 633d 6a73      json_spec=js
+00024ae0: 6f6e 5f73 7065 632c 0a20 2020 2020 2020  on_spec,.       
+00024af0: 2020 2020 2029 0a0a 0a61 7379 6e63 2064       )...async d
+00024b00: 6566 2061 6374 696f 6e5f 7365 745f 7072  ef action_set_pr
+00024b10: 6573 656e 6365 2863 6c69 656e 743a 2041  esence(client: A
+00024b20: 7379 6e63 436c 6965 6e74 2c20 6372 6564  syncClient, cred
+00024b30: 656e 7469 616c 733a 2064 6963 7429 202d  entials: dict) -
+00024b40: 3e20 4e6f 6e65 3a0a 2020 2020 2222 2253  > None:.    """S
+00024b50: 6574 2074 6865 206c 6f67 6765 6420 696e  et the logged in
+00024b60: 2075 7365 7227 7320 7072 6573 656e 6365   user's presence
+00024b70: 2e20 4368 616e 6765 206d 7920 6f77 6e20  . Change my own 
+00024b80: 7072 6573 656e 6365 2e0a 2020 2020 4173  presence..    As
+00024b90: 7375 6d65 7320 7468 6174 2075 7365 7220  sumes that user 
+00024ba0: 6973 2061 6c72 6561 6479 206c 6f67 6765  is already logge
+00024bb0: 6420 696e 2e0a 2020 2020 2222 220a 2020  d in..    """.  
+00024bc0: 2020 7374 6174 6520 3d20 6773 2e70 612e    state = gs.pa.
+00024bd0: 7365 745f 7072 6573 656e 6365 2e73 7472  set_presence.str
+00024be0: 6970 2829 2e6c 6f77 6572 2829 0a20 2020  ip().lower().   
+00024bf0: 2067 732e 6c6f 672e 6465 6275 6728 6622   gs.log.debug(f"
+00024c00: 5365 7474 696e 6720 7072 6573 656e 6365  Setting presence
+00024c10: 2074 6f20 7b73 7461 7465 7d20 5b7b 6773   to {state} [{gs
+00024c20: 2e70 612e 7365 745f 7072 6573 656e 6365  .pa.set_presence
+00024c30: 7d5d 2e22 290a 2020 2020 7265 7370 203d  }].").    resp =
+00024c40: 2061 7761 6974 2063 6c69 656e 742e 7365   await client.se
+00024c50: 745f 7072 6573 656e 6365 2873 7461 7465  t_presence(state
+00024c60: 290a 2020 2020 6966 2069 7369 6e73 7461  ).    if isinsta
+00024c70: 6e63 6528 7265 7370 2c20 5072 6573 656e  nce(resp, Presen
+00024c80: 6365 5365 7445 7272 6f72 293a 0a20 2020  ceSetError):.   
+00024c90: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
+00024ca0: 7228 0a20 2020 2020 2020 2020 2020 2022  r(.            "
+00024cb0: 4531 3730 3a20 2220 6622 7365 745f 7072  E170: " f"set_pr
+00024cc0: 6573 656e 6365 2066 6169 6c65 6420 7769  esence failed wi
+00024cd0: 7468 207b 7072 6976 6163 795f 6669 6c74  th {privacy_filt
+00024ce0: 6572 2873 7472 2872 6573 7029 297d 220a  er(str(resp))}".
+00024cf0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00024d00: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
+00024d10: 3d20 310a 2020 2020 656c 7365 3a0a 2020  = 1.    else:.  
+00024d20: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+00024d30: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+00024d40: 6622 7365 745f 7072 6573 656e 6365 2073  f"set_presence s
+00024d50: 7563 6365 7373 6675 6c20 7769 7468 207b  uccessful with {
+00024d60: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
+00024d70: 7472 2872 6573 7029 297d 220a 2020 2020  tr(resp))}".    
+00024d80: 2020 2020 290a 0a0a 6173 796e 6320 6465      )...async de
+00024d90: 6620 6163 7469 6f6e 5f67 6574 5f70 7265  f action_get_pre
+00024da0: 7365 6e63 6528 636c 6965 6e74 3a20 4173  sence(client: As
+00024db0: 796e 6343 6c69 656e 742c 2063 7265 6465  yncClient, crede
+00024dc0: 6e74 6961 6c73 3a20 6469 6374 2920 2d3e  ntials: dict) ->
+00024dd0: 204e 6f6e 653a 0a20 2020 2022 2222 4765   None:.    """Ge
+00024de0: 7420 7072 6573 656e 6365 2873 2920 7768  t presence(s) wh
+00024df0: 696c 6520 616c 7265 6164 7920 6c6f 6767  ile already logg
+00024e00: 6564 2069 6e2e 2222 220a 2020 2020 6966  ed in.""".    if
+00024e10: 206e 6f74 2067 732e 7061 2e75 7365 723a   not gs.pa.user:
+00024e20: 0a20 2020 2020 2020 2023 2067 6574 2070  .        # get p
+00024e30: 7265 7365 6e63 6520 6e61 6d65 206f 6620  resence name of 
+00024e40: 6d79 7365 6c66 0a20 2020 2020 2020 2077  myself.        w
+00024e50: 686f 616d 6920 3d20 6372 6564 656e 7469  hoami = credenti
+00024e60: 616c 735b 2275 7365 725f 6964 225d 0a20  als["user_id"]. 
+00024e70: 2020 2020 2020 2075 7365 7273 203d 205b         users = [
+00024e80: 7768 6f61 6d69 5d0a 2020 2020 656c 7365  whoami].    else
+00024e90: 3a0a 2020 2020 2020 2020 7573 6572 7320  :.        users 
+00024ea0: 3d20 6773 2e70 612e 7573 6572 0a20 2020  = gs.pa.user.   
+00024eb0: 2075 7365 7273 203d 206c 6973 7428 6469   users = list(di
+00024ec0: 6374 2e66 726f 6d6b 6579 7328 7573 6572  ct.fromkeys(user
+00024ed0: 7329 2920 2023 2072 656d 6f76 6520 6475  s))  # remove du
+00024ee0: 706c 6963 6174 6573 2069 6e20 6c69 7374  plicates in list
+00024ef0: 0a20 2020 2066 6f72 2075 7365 7220 696e  .    for user in
+00024f00: 2075 7365 7273 3a0a 2020 2020 2020 2020   users:.        
+00024f10: 7265 7370 203d 2061 7761 6974 2063 6c69  resp = await cli
+00024f20: 656e 742e 6765 745f 7072 6573 656e 6365  ent.get_presence
+00024f30: 2875 7365 7229 0a20 2020 2020 2020 2069  (user).        i
+00024f40: 6620 6973 696e 7374 616e 6365 2872 6573  f isinstance(res
+00024f50: 702c 2050 7265 7365 6e63 6547 6574 4572  p, PresenceGetEr
+00024f60: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+00024f70: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
+00024f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024f90: 2245 3137 313a 2022 0a20 2020 2020 2020  "E171: ".       
+00024fa0: 2020 2020 2020 2020 2066 2267 6574 5f70           f"get_p
+00024fb0: 7265 7365 6e63 6520 6661 696c 6564 2077  resence failed w
+00024fc0: 6974 6820 7b70 7269 7661 6379 5f66 696c  ith {privacy_fil
+00024fd0: 7465 7228 7374 7228 7265 7370 2929 7d22  ter(str(resp))}"
+00024fe0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00024ff0: 2020 2020 2020 2020 2020 2067 732e 6572             gs.er
+00025000: 725f 636f 756e 7420 2b3d 2031 0a20 2020  r_count += 1.   
+00025010: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00025020: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+00025030: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
+00025040: 2020 2020 2066 2267 6574 5f70 7265 7365       f"get_prese
+00025050: 6e63 6520 7375 6363 6573 7366 756c 2077  nce successful w
+00025060: 6974 6820 7b70 7269 7661 6379 5f66 696c  ith {privacy_fil
+00025070: 7465 7228 7374 7228 7265 7370 2929 7d22  ter(str(resp))}"
+00025080: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00025090: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+000250a0: 7420 7265 7370 2e6c 6173 745f 6163 7469  t resp.last_acti
+000250b0: 7665 5f61 676f 3a0a 2020 2020 2020 2020  ve_ago:.        
+000250c0: 2020 2020 2020 2020 6c61 7374 5f61 6374          last_act
+000250d0: 6976 655f 6167 6f20 3d20 3020 2023 206d  ive_ago = 0  # m
+000250e0: 6561 6e73 2063 7572 7265 6e74 6c79 5f61  eans currently_a
+000250f0: 6374 6976 6520 6973 206e 6f74 2073 6574  ctive is not set
+00025100: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00025110: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00025120: 2020 206c 6173 745f 6163 7469 7665 5f61     last_active_a
+00025130: 676f 203d 2072 6573 702e 6c61 7374 5f61  go = resp.last_a
+00025140: 6374 6976 655f 6167 6f0a 2020 2020 2020  ctive_ago.      
+00025150: 2020 2020 2020 6966 206e 6f74 2072 6573        if not res
+00025160: 702e 6375 7272 656e 746c 795f 6163 7469  p.currently_acti
+00025170: 7665 3a0a 2020 2020 2020 2020 2020 2020  ve:.            
+00025180: 2020 2020 6375 7272 656e 746c 795f 6163      currently_ac
+00025190: 7469 7665 203d 2046 616c 7365 2020 2320  tive = False  # 
+000251a0: 6d65 616e 7320 6375 7272 656e 746c 795f  means currently_
+000251b0: 6163 7469 7665 2069 7320 6e6f 7420 7365  active is not se
+000251c0: 740a 2020 2020 2020 2020 2020 2020 656c  t.            el
+000251d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000251e0: 2020 2020 6375 7272 656e 746c 795f 6163      currently_ac
+000251f0: 7469 7665 203d 2072 6573 702e 6375 7272  tive = resp.curr
+00025200: 656e 746c 795f 6163 7469 7665 0a20 2020  ently_active.   
+00025210: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00025220: 7265 7370 2e73 7461 7475 735f 6d73 673a  resp.status_msg:
+00025230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025240: 2073 7461 7475 735f 6d73 6720 3d20 2222   status_msg = ""
+00025250: 2020 2320 6d65 616e 7320 6e6f 2073 7461    # means no sta
+00025260: 7475 735f 6d73 6720 6973 2073 6574 0a20  tus_msg is set. 
+00025270: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00025280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025290: 2073 7461 7475 735f 6d73 6720 3d20 7265   status_msg = re
+000252a0: 7370 2e73 7461 7475 735f 6d73 670a 2020  sp.status_msg.  
+000252b0: 2020 2020 2020 2020 2020 2320 6f75 7470            # outp
+000252c0: 7574 2066 6f72 6d61 7420 636f 6e74 726f  ut format contro
+000252d0: 6c6c 6564 2076 6961 202d 2d6f 7574 7075  lled via --outpu
+000252e0: 7420 666c 6167 0a20 2020 2020 2020 2020  t flag.         
+000252f0: 2020 2074 6578 7420 3d20 280a 2020 2020     text = (.    
+00025300: 2020 2020 2020 2020 2020 2020 6622 7b72              f"{r
+00025310: 6573 702e 7573 6572 5f69 647d 7b53 4550  esp.user_id}{SEP
+00025320: 7d7b 7265 7370 2e70 7265 7365 6e63 657d  }{resp.presence}
+00025330: 7b53 4550 7d7b 6c61 7374 5f61 6374 6976  {SEP}{last_activ
+00025340: 655f 6167 6f7d 220a 2020 2020 2020 2020  e_ago}".        
+00025350: 2020 2020 2020 2020 6622 7b53 4550 7d7b          f"{SEP}{
+00025360: 6375 7272 656e 746c 795f 6163 7469 7665  currently_active
+00025370: 7d7b 5345 507d 7b73 7461 7475 735f 6d73  }{SEP}{status_ms
+00025380: 677d 220a 2020 2020 2020 2020 2020 2020  g}".            
+00025390: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+000253a0: 4f62 6a65 6374 206f 6620 7479 7065 2078  Object of type x
+000253b0: 7878 5265 7370 6f6e 7365 2069 7320 6e6f  xxResponse is no
+000253c0: 7420 4a53 4f4e 0a20 2020 2020 2020 2020  t JSON.         
+000253d0: 2020 2023 2073 6572 6961 6c69 7a61 626c     # serializabl
+000253e0: 652c 2068 656e 6365 2077 6520 7573 6520  e, hence we use 
+000253f0: 7468 6520 6469 6374 696f 6e61 7279 2e0a  the dictionary..
+00025400: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+00025410: 5f6d 6178 203d 2072 6573 702e 5f5f 6469  _max = resp.__di
+00025420: 6374 5f5f 0a20 2020 2020 2020 2020 2020  ct__.           
+00025430: 2023 206a 736f 6e5f 6d61 782e 7570 6461   # json_max.upda
+00025440: 7465 287b 226b 6579 223a 2076 616c 7565  te({"key": value
+00025450: 7d29 2020 2320 6164 6420 6469 6374 2069  })  # add dict i
+00025460: 7465 6d73 0a20 2020 2020 2020 2020 2020  tems.           
+00025470: 206a 736f 6e5f 203d 206a 736f 6e5f 6d61   json_ = json_ma
+00025480: 782e 636f 7079 2829 0a20 2020 2020 2020  x.copy().       
+00025490: 2020 2020 206a 736f 6e5f 2e70 6f70 2822       json_.pop("
+000254a0: 7472 616e 7370 6f72 745f 7265 7370 6f6e  transport_respon
+000254b0: 7365 2229 0a20 2020 2020 2020 2020 2020  se").           
+000254c0: 206a 736f 6e5f 7370 6563 203d 204e 6f6e   json_spec = Non
+000254d0: 650a 2020 2020 2020 2020 2020 2020 7072  e.            pr
+000254e0: 696e 745f 6f75 7470 7574 280a 2020 2020  int_output(.    
+000254f0: 2020 2020 2020 2020 2020 2020 6773 2e70              gs.p
+00025500: 612e 6f75 7470 7574 2c0a 2020 2020 2020  a.output,.      
+00025510: 2020 2020 2020 2020 2020 7465 7874 3d74            text=t
+00025520: 6578 742c 0a20 2020 2020 2020 2020 2020  ext,.           
+00025530: 2020 2020 206a 736f 6e5f 3d6a 736f 6e5f       json_=json_
+00025540: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00025550: 2020 6a73 6f6e 5f6d 6178 3d6a 736f 6e5f    json_max=json_
+00025560: 6d61 782c 0a20 2020 2020 2020 2020 2020  max,.           
+00025570: 2020 2020 206a 736f 6e5f 7370 6563 3d6a       json_spec=j
+00025580: 736f 6e5f 7370 6563 2c0a 2020 2020 2020  son_spec,.      
+00025590: 2020 2020 2020 290a 0a0a 6173 796e 6320        )...async 
+000255a0: 6465 6620 6163 7469 6f6e 5f75 706c 6f61  def action_uploa
+000255b0: 6428 636c 6965 6e74 3a20 4173 796e 6343  d(client: AsyncC
+000255c0: 6c69 656e 742c 2063 7265 6465 6e74 6961  lient, credentia
+000255d0: 6c73 3a20 6469 6374 2920 2d3e 204e 6f6e  ls: dict) -> Non
+000255e0: 653a 0a20 2020 2022 2222 5570 6c6f 6164  e:.    """Upload
+000255f0: 206f 6e65 206f 7220 6d6f 7265 2066 696c   one or more fil
+00025600: 6573 2074 6f20 636f 6e74 656e 7420 7265  es to content re
+00025610: 706f 7369 746f 7279 206f 6620 4d61 7472  pository of Matr
+00025620: 6978 2073 6572 7665 722e 0a20 2020 2041  ix server..    A
+00025630: 7373 756d 6573 2074 6861 7420 7573 6572  ssumes that user
+00025640: 2069 7320 616c 7265 6164 7920 6c6f 6767   is already logg
+00025650: 6564 2069 6e2e 0a20 2020 2022 2222 0a20  ed in..    """. 
+00025660: 2020 2066 6f72 2066 696c 656e 616d 6520     for filename 
+00025670: 696e 2067 732e 7061 2e75 706c 6f61 643a  in gs.pa.upload:
+00025680: 0a20 2020 2020 2020 2066 696c 656e 616d  .        filenam
+00025690: 6520 3d20 6669 6c65 6e61 6d65 2e73 7472  e = filename.str
+000256a0: 6970 2829 0a20 2020 2020 2020 2065 6e63  ip().        enc
+000256b0: 7279 7074 203d 2046 616c 7365 2069 6620  rypt = False if 
+000256c0: 6773 2e70 612e 706c 6169 6e20 656c 7365  gs.pa.plain else
+000256d0: 2054 7275 650a 2020 2020 2020 2020 6d69   True.        mi
+000256e0: 6d65 5f74 7970 6520 3d20 6d61 6769 632e  me_type = magic.
+000256f0: 6672 6f6d 5f66 696c 6528 6669 6c65 6e61  from_file(filena
+00025700: 6d65 2c20 6d69 6d65 3d54 7275 6529 0a20  me, mime=True). 
+00025710: 2020 2020 2020 2066 696c 655f 7374 6174         file_stat
+00025720: 203d 2061 7761 6974 2061 696f 6669 6c65   = await aiofile
+00025730: 732e 6f73 2e73 7461 7428 6669 6c65 6e61  s.os.stat(filena
+00025740: 6d65 290a 2020 2020 2020 2020 6173 796e  me).        asyn
+00025750: 6320 7769 7468 2061 696f 6669 6c65 732e  c with aiofiles.
+00025760: 6f70 656e 2866 696c 656e 616d 652c 2022  open(filename, "
+00025770: 722b 6222 2920 6173 2066 3a0a 2020 2020  r+b") as f:.    
+00025780: 2020 2020 2020 2020 7265 7370 2c20 6465          resp, de
+00025790: 6372 7970 7469 6f6e 5f64 6963 7420 3d20  cryption_dict = 
+000257a0: 6177 6169 7420 636c 6965 6e74 2e75 706c  await client.upl
+000257b0: 6f61 6428 0a20 2020 2020 2020 2020 2020  oad(.           
+000257c0: 2020 2020 2066 2c0a 2020 2020 2020 2020       f,.        
+000257d0: 2020 2020 2020 2020 636f 6e74 656e 745f          content_
+000257e0: 7479 7065 3d6d 696d 655f 7479 7065 2c20  type=mime_type, 
+000257f0: 2023 2065 2e67 2e20 6170 706c 6963 6174   # e.g. applicat
+00025800: 696f 6e2f 7064 660a 2020 2020 2020 2020  ion/pdf.        
+00025810: 2020 2020 2020 2020 6669 6c65 6e61 6d65          filename
+00025820: 3d6f 732e 7061 7468 2e62 6173 656e 616d  =os.path.basenam
+00025830: 6528 6669 6c65 6e61 6d65 292c 0a20 2020  e(filename),.   
+00025840: 2020 2020 2020 2020 2020 2020 2065 6e63               enc
+00025850: 7279 7074 3d65 6e63 7279 7074 2c0a 2020  rypt=encrypt,.  
+00025860: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+00025870: 6c65 7369 7a65 3d66 696c 655f 7374 6174  lesize=file_stat
+00025880: 2e73 745f 7369 7a65 2c0a 2020 2020 2020  .st_size,.      
+00025890: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000258a0: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
+000258b0: 7370 2c20 5570 6c6f 6164 4572 726f 7229  sp, UploadError)
+000258c0: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
+000258d0: 2e6c 6f67 2e65 7272 6f72 280a 2020 2020  .log.error(.    
+000258e0: 2020 2020 2020 2020 2020 2020 2245 3137              "E17
+000258f0: 323a 2022 0a20 2020 2020 2020 2020 2020  2: ".           
+00025900: 2020 2020 2022 4661 696c 6564 2074 6f20       "Failed to 
+00025910: 7570 6c6f 6164 2e20 220a 2020 2020 2020  upload. ".      
+00025920: 2020 2020 2020 2020 2020 6627 6669 6c65            f'file
+00025930: 3d22 7b66 696c 656e 616d 657d 223b 206d  ="{filename}"; m
+00025940: 696d 655f 7479 7065 3d22 7b6d 696d 655f  ime_type="{mime_
+00025950: 7479 7065 7d22 3b20 270a 2020 2020 2020  type}"; '.      
+00025960: 2020 2020 2020 2020 2020 6622 6669 6c65            f"file
+00025970: 7373 697a 653d 7b66 696c 655f 7374 6174  ssize={file_stat
+00025980: 2e73 745f 7369 7a65 7d3b 2065 6e63 7279  .st_size}; encry
+00025990: 7074 3d7b 656e 6372 7970 747d 220a 2020  pt={encrypt}".  
+000259a0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+000259b0: 5365 7276 6572 2072 6573 706f 6e73 653a  Server response:
+000259c0: 207b 7072 6976 6163 795f 6669 6c74 6572   {privacy_filter
+000259d0: 2873 7472 2872 6573 7029 297d 220a 2020  (str(resp))}".  
+000259e0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000259f0: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
+00025a00: 6f75 6e74 202b 3d20 310a 2020 2020 2020  ount += 1.      
+00025a10: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00025a20: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+00025a30: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00025a40: 2020 6622 4669 6c65 207b 6669 6c65 6e61    f"File {filena
+00025a50: 6d65 7d2c 206d 696d 653d 7b6d 696d 655f  me}, mime={mime_
+00025a60: 7479 7065 7d2c 2022 0a20 2020 2020 2020  type}, ".       
+00025a70: 2020 2020 2020 2020 2066 227b 6669 6c65           f"{file
+00025a80: 5f73 7461 742e 7374 5f73 697a 657d 2062  _stat.st_size} b
+00025a90: 7974 6573 2c20 656e 6372 7970 743d 7b65  ytes, encrypt={e
+00025aa0: 6e63 7279 7074 7d20 220a 2020 2020 2020  ncrypt} ".      
+00025ab0: 2020 2020 2020 2020 2020 2277 6173 2073            "was s
+00025ac0: 7563 6365 7373 6675 6c6c 7920 7570 6c6f  uccessfully uplo
+00025ad0: 6164 6564 2074 6f20 7365 7276 6572 2e20  aded to server. 
+00025ae0: 5265 7370 6f6e 7365 2069 733a 2022 0a20  Response is: ". 
+00025af0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00025b00: 227b 7072 6976 6163 795f 6669 6c74 6572  "{privacy_filter
+00025b10: 2873 7472 2872 6573 7029 297d 2e22 0a20  (str(resp))}.". 
+00025b20: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00025b30: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
+00025b40: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
+00025b50: 2020 2020 2020 2066 2255 5249 206f 6620         f"URI of 
+00025b60: 7570 6c6f 6164 6564 2066 696c 6520 7b66  uploaded file {f
+00025b70: 696c 656e 616d 657d 2069 733a 207b 7265  ilename} is: {re
+00025b80: 7370 2e63 6f6e 7465 6e74 5f75 7269 7d22  sp.content_uri}"
+00025b90: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00025ba0: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
+00025bb0: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
+00025bc0: 2020 2020 2020 2020 2066 2244 6563 7279           f"Decry
+00025bd0: 7074 696f 6e20 6b65 7920 2864 6963 7469  ption key (dicti
+00025be0: 6f6e 6172 7929 206f 6620 7570 6c6f 6164  onary) of upload
+00025bf0: 6564 2066 696c 6520 7b66 696c 656e 616d  ed file {filenam
+00025c00: 657d 2069 733a 2022 0a20 2020 2020 2020  e} is: ".       
+00025c10: 2020 2020 2020 2020 2022 272a 2a2a 2068           "'*** h
+00025c20: 6964 6465 6e20 746f 2070 7265 7665 6e74  idden to prevent
+00025c30: 206c 6561 6b73 2722 2020 2320 6622 7b64   leaks'"  # f"{d
+00025c40: 6563 7279 7074 696f 6e5f 6469 6374 7d22  ecryption_dict}"
+00025c50: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00025c60: 2020 2020 2020 2020 2020 2023 2064 6563             # dec
+00025c70: 7279 7074 696f 6e5f 6469 6374 2077 696c  ryption_dict wil
+00025c80: 6c20 6265 204e 6f6e 6520 696e 2063 6173  l be None in cas
+00025c90: 6520 6f66 2070 6c61 696e 2d74 6578 740a  e of plain-text.
+00025ca0: 2020 2020 2020 2020 2020 2020 2320 7468              # th
+00025cb0: 6520 5552 4920 616e 6420 6b65 7973 2077  e URI and keys w
+00025cc0: 696c 6c20 6265 206e 6565 6465 6420 6c61  ill be needed la
+00025cd0: 7465 722e 2053 6f20 7468 6973 2070 7269  ter. So this pri
+00025ce0: 6e74 2069 7320 6120 6d75 7374 0a20 2020  nt is a must.   
+00025cf0: 2020 2020 2020 2020 2023 206f 7574 7075           # outpu
+00025d00: 7420 666f 726d 6174 2063 6f6e 7472 6f6c  t format control
+00025d10: 6c65 6420 7669 6120 2d2d 6f75 7470 7574  led via --output
+00025d20: 2066 6c61 670a 2020 2020 2020 2020 2020   flag.          
+00025d30: 2020 7465 7874 203d 2066 227b 7265 7370    text = f"{resp
+00025d40: 2e63 6f6e 7465 6e74 5f75 7269 7d7b 5345  .content_uri}{SE
+00025d50: 507d 7b64 6563 7279 7074 696f 6e5f 6469  P}{decryption_di
+00025d60: 6374 7d22 0a20 2020 2020 2020 2020 2020  ct}".           
+00025d70: 2023 204f 626a 6563 7420 6f66 2074 7970   # Object of typ
+00025d80: 6520 7878 7852 6573 706f 6e73 6520 6973  e xxxResponse is
+00025d90: 206e 6f74 204a 534f 4e0a 2020 2020 2020   not JSON.      
+00025da0: 2020 2020 2020 2320 7365 7269 616c 697a        # serializ
+00025db0: 6162 6c65 2c20 6865 6e63 6520 7765 2075  able, hence we u
+00025dc0: 7365 2074 6865 2064 6963 7469 6f6e 6172  se the dictionar
+00025dd0: 792e 0a20 2020 2020 2020 2020 2020 206a  y..            j
+00025de0: 736f 6e5f 6d61 7820 3d20 7265 7370 2e5f  son_max = resp._
+00025df0: 5f64 6963 745f 5f0a 2020 2020 2020 2020  _dict__.        
+00025e00: 2020 2020 6a73 6f6e 5f6d 6178 2e75 7064      json_max.upd
+00025e10: 6174 6528 0a20 2020 2020 2020 2020 2020  ate(.           
+00025e20: 2020 2020 207b 2264 6563 7279 7074 696f       {"decryptio
+00025e30: 6e5f 6469 6374 223a 2064 6563 7279 7074  n_dict": decrypt
+00025e40: 696f 6e5f 6469 6374 7d0a 2020 2020 2020  ion_dict}.      
+00025e50: 2020 2020 2020 2920 2023 2061 6464 2064        )  # add d
+00025e60: 6963 7420 6974 656d 730a 2020 2020 2020  ict items.      
+00025e70: 2020 2020 2020 6a73 6f6e 5f20 3d20 6a73        json_ = js
+00025e80: 6f6e 5f6d 6178 2e63 6f70 7928 290a 2020  on_max.copy().  
+00025e90: 2020 2020 2020 2020 2020 6a73 6f6e 5f2e            json_.
+00025ea0: 706f 7028 2274 7261 6e73 706f 7274 5f72  pop("transport_r
+00025eb0: 6573 706f 6e73 6522 290a 2020 2020 2020  esponse").      
+00025ec0: 2020 2020 2020 6a73 6f6e 5f73 7065 6320        json_spec 
+00025ed0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
+00025ee0: 2020 2070 7269 6e74 5f6f 7574 7075 7428     print_output(
+00025ef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025f00: 2067 732e 7061 2e6f 7574 7075 742c 0a20   gs.pa.output,. 
+00025f10: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00025f20: 6578 743d 7465 7874 2c0a 2020 2020 2020  ext=text,.      
+00025f30: 2020 2020 2020 2020 2020 6a73 6f6e 5f3d            json_=
+00025f40: 6a73 6f6e 5f2c 0a20 2020 2020 2020 2020  json_,.         
+00025f50: 2020 2020 2020 206a 736f 6e5f 6d61 783d         json_max=
+00025f60: 6a73 6f6e 5f6d 6178 2c0a 2020 2020 2020  json_max,.      
+00025f70: 2020 2020 2020 2020 2020 6a73 6f6e 5f73            json_s
+00025f80: 7065 633d 6a73 6f6e 5f73 7065 632c 0a20  pec=json_spec,. 
+00025f90: 2020 2020 2020 2020 2020 2029 0a0a 0a61             )...a
+00025fa0: 7379 6e63 2064 6566 2061 6374 696f 6e5f  sync def action_
+00025fb0: 6465 6c65 7465 5f6d 7863 2863 6c69 656e  delete_mxc(clien
+00025fc0: 743a 2041 7379 6e63 436c 6965 6e74 2c20  t: AsyncClient, 
+00025fd0: 6372 6564 656e 7469 616c 733a 2064 6963  credentials: dic
+00025fe0: 7429 202d 3e20 4e6f 6e65 3a0a 2020 2020  t) -> None:.    
+00025ff0: 2222 2244 656c 6574 6520 6f6e 6520 6f72  """Delete one or
+00026000: 206d 6f72 6520 6669 6c65 7320 6672 6f6d   more files from
+00026010: 2063 6f6e 7465 6e74 2072 6570 6f73 6974   content reposit
+00026020: 6f72 7920 6f66 204d 6174 7269 7820 7365  ory of Matrix se
+00026030: 7276 6572 2e0a 2020 2020 4173 7375 6d65  rver..    Assume
+00026040: 7320 7468 6174 2075 7365 7220 6973 2061  s that user is a
+00026050: 6c72 6561 6479 206c 6f67 6765 6420 696e  lready logged in
+00026060: 2e0a 2020 2020 2222 220a 2020 2020 2320  ..    """.    # 
+00026070: 7365 653a 2068 7474 7073 3a2f 2f64 6f63  see: https://doc
+00026080: 732e 6169 6f68 7474 702e 6f72 672f 656e  s.aiohttp.org/en
+00026090: 2f73 7461 626c 652f 636c 6965 6e74 5f71  /stable/client_q
+000260a0: 7569 636b 7374 6172 742e 6874 6d6c 0a20  uickstart.html. 
+000260b0: 2020 2023 2077 6520 6d75 7374 2065 6d75     # we must emu
+000260c0: 6c61 7465 2061 2063 7572 6c20 6c69 6b65  late a curl like
+000260d0: 2074 6869 733a 0a20 2020 2023 2063 7572   this:.    # cur
+000260e0: 6c20 2d58 4445 4c45 5445 2020 2268 7474  l -XDELETE  "htt
+000260f0: 7073 3a2f 2f53 4552 5645 5248 4552 452f  ps://SERVERHERE/
+00026100: 5f73 796e 6170 7365 2f61 646d 696e 2f76  _synapse/admin/v
+00026110: 312f 6d65 6469 612f 5345 5256 4552 4845  1/media/SERVERHE
+00026120: 5245 2f0a 2020 2020 2320 2020 2020 204d  RE/.    #      M
+00026130: 5843 4944 4845 5245 3f61 6363 6573 735f  XCIDHERE?access_
+00026140: 746f 6b65 6e3d 4143 4345 5353 5f54 4f4b  token=ACCESS_TOK
+00026150: 454e 5f48 4552 4522 0a20 2020 2066 6f72  EN_HERE".    for
+00026160: 206d 7863 2069 6e20 6773 2e70 612e 6465   mxc in gs.pa.de
+00026170: 6c65 7465 5f6d 7863 3a0a 2020 2020 2020  lete_mxc:.      
+00026180: 2020 6d78 6320 3d20 6d78 632e 7374 7269    mxc = mxc.stri
+00026190: 7028 290a 2020 2020 2020 2020 6773 2e6c  p().        gs.l
+000261a0: 6f67 2e64 6562 7567 2866 2250 7265 7061  og.debug(f"Prepa
+000261b0: 7269 6e67 2074 6f20 6465 6c65 7465 204d  ring to delete M
+000261c0: 5843 207b 6d78 637d 2e22 290a 2020 2020  XC {mxc}.").    
+000261d0: 2020 2020 2320 7765 2061 6c6c 6f77 206d      # we allow m
+000261e0: 7863 2074 6f20 6265 2061 2920 6d78 633a  xc to be a) mxc:
+000261f0: 2f2f 7365 7276 6572 2f6d 7863 2d69 6420  //server/mxc-id 
+00026200: 6f72 206a 7573 7420 6d78 632d 6964 0a20  or just mxc-id. 
+00026210: 2020 2020 2020 2069 6620 7572 6c70 6172         if urlpar
+00026220: 7365 286d 7863 292e 7363 6865 6d65 203d  se(mxc).scheme =
+00026230: 3d20 226d 7863 223a 0a20 2020 2020 2020  = "mxc":.       
+00026240: 2020 2020 206d 7863 203d 2075 726c 7061       mxc = urlpa
+00026250: 7273 6528 6d78 6329 2e70 6174 682e 7265  rse(mxc).path.re
+00026260: 706c 6163 6528 222f 222c 2022 2229 0a20  place("/", ""). 
+00026270: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+00026280: 6275 6728 6622 5072 6570 6172 696e 6720  bug(f"Preparing 
+00026290: 746f 2064 656c 6574 6520 4d58 4320 4944  to delete MXC ID
+000262a0: 207b 6d78 637d 2e22 290a 2020 2020 2020   {mxc}.").      
+000262b0: 2020 6966 2067 732e 7061 2e61 6363 6573    if gs.pa.acces
+000262c0: 735f 746f 6b65 6e3a 0a20 2020 2020 2020  s_token:.       
+000262d0: 2020 2020 2061 7420 3d20 6773 2e70 612e       at = gs.pa.
+000262e0: 6163 6365 7373 5f74 6f6b 656e 0a20 2020  access_token.   
+000262f0: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
+00026300: 6465 6275 6728 2255 7369 6e67 2061 6363  debug("Using acc
+00026310: 6573 7320 746f 6b65 6e20 6672 6f6d 202d  ess token from -
+00026320: 2d61 6363 6573 732d 746f 6b65 6e20 6172  -access-token ar
+00026330: 6775 6d65 6e74 2e22 290a 2020 2020 2020  gument.").      
+00026340: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00026350: 2020 2020 6174 203d 2063 7265 6465 6e74      at = credent
+00026360: 6961 6c73 5b22 6163 6365 7373 5f74 6f6b  ials["access_tok
+00026370: 656e 225d 0a20 2020 2020 2020 2020 2020  en"].           
+00026380: 2067 732e 6c6f 672e 6465 6275 6728 2255   gs.log.debug("U
+00026390: 7369 6e67 2061 6363 6573 7320 746f 6b65  sing access toke
+000263a0: 6e20 6672 6f6d 2063 7265 6465 6e74 6961  n from credentia
+000263b0: 6c73 2066 696c 652e 2229 0a20 2020 2020  ls file.").     
+000263c0: 2020 2073 7276 5f66 756c 6c20 3d20 6372     srv_full = cr
+000263d0: 6564 656e 7469 616c 735b 2268 6f6d 6573  edentials["homes
+000263e0: 6572 7665 7222 5d20 2023 2068 7474 7073  erver"]  # https
+000263f0: 3a2f 2f65 7861 6d70 6c65 2e6d 6174 7269  ://example.matri
+00026400: 782e 6f72 670a 2020 2020 2020 2020 7372  x.org.        sr
+00026410: 765f 686f 7374 203d 2075 726c 7061 7273  v_host = urlpars
+00026420: 6528 7372 765f 6675 6c6c 292e 686f 7374  e(srv_full).host
+00026430: 6e61 6d65 2020 2320 6578 616d 706c 652e  name  # example.
+00026440: 6d61 7472 6978 2e6f 7267 0a20 2020 2020  matrix.org.     
+00026450: 2020 2072 6573 7420 3d20 280a 2020 2020     rest = (.    
+00026460: 2020 2020 2020 2020 7372 765f 6675 6c6c          srv_full
+00026470: 0a20 2020 2020 2020 2020 2020 202b 2022  .            + "
+00026480: 2f5f 7379 6e61 7073 652f 6164 6d69 6e2f  /_synapse/admin/
+00026490: 7631 2f6d 6564 6961 2f22 0a20 2020 2020  v1/media/".     
+000264a0: 2020 2020 2020 202b 2073 7276 5f68 6f73         + srv_hos
+000264b0: 740a 2020 2020 2020 2020 2020 2020 2b20  t.            + 
+000264c0: 222f 220a 2020 2020 2020 2020 2020 2020  "/".            
+000264d0: 2b20 6d78 630a 2020 2020 2020 2020 2020  + mxc.          
+000264e0: 2020 2b20 223f 6163 6365 7373 5f74 6f6b    + "?access_tok
+000264f0: 656e 3d22 0a20 2020 2020 2020 2020 2020  en=".           
+00026500: 202b 2061 740a 2020 2020 2020 2020 290a   + at.        ).
+00026510: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+00026520: 6562 7567 2866 2249 7373 7569 6e67 2052  ebug(f"Issuing R
+00026530: 4553 5420 4d61 7472 6978 2041 5049 2063  EST Matrix API c
+00026540: 616c 6c3a 2044 454c 4554 4520 7b72 6573  all: DELETE {res
+00026550: 747d 2229 0a20 2020 2020 2020 2063 6f6e  t}").        con
+00026560: 6e65 6374 6f72 203d 2054 4350 436f 6e6e  nector = TCPConn
+00026570: 6563 746f 7228 7373 6c3d 6773 2e73 736c  ector(ssl=gs.ssl
+00026580: 2920 2023 2073 6574 7469 6e67 2073 736c  )  # setting ssl
+00026590: 636f 6e74 6578 740a 2020 2020 2020 2020  context.        
+000265a0: 6173 796e 6320 7769 7468 2043 6c69 656e  async with Clien
+000265b0: 7453 6573 7369 6f6e 2863 6f6e 6e65 6374  tSession(connect
+000265c0: 6f72 3d63 6f6e 6e65 6374 6f72 2920 6173  or=connector) as
+000265d0: 2073 6573 7369 6f6e 3a20 2023 2061 696f   session:  # aio
+000265e0: 6874 7470 0a20 2020 2020 2020 2020 2020  http.           
+000265f0: 2061 7379 6e63 2077 6974 6820 7365 7373   async with sess
+00026600: 696f 6e2e 6465 6c65 7465 2872 6573 7429  ion.delete(rest)
+00026610: 2061 7320 7265 7370 3a0a 2020 2020 2020   as resp:.      
+00026620: 2020 2020 2020 2020 2020 7374 6174 7573            status
+00026630: 203d 2072 6573 702e 7374 6174 7573 2020   = resp.status  
+00026640: 2320 696e 742c 2032 3030 2073 7563 6365  # int, 200 succe
+00026650: 7373 0a20 2020 2020 2020 2020 2020 2020  ss.             
+00026660: 2020 2074 7874 203d 2061 7761 6974 2072     txt = await r
+00026670: 6573 702e 7465 7874 2829 2020 2320 7374  esp.text()  # st
+00026680: 7220 696e 2064 6963 7420 666f 726d 6174  r in dict format
+00026690: 0a20 2020 2020 2020 2069 6620 7374 6174  .        if stat
+000266a0: 7573 2021 3d20 3230 303a 0a20 2020 2020  us != 200:.     
+000266b0: 2020 2020 2020 2023 2074 7874 2069 7320         # txt is 
+000266c0: 7374 7220 6c69 6b65 2074 6869 733a 0a20  str like this:. 
+000266d0: 2020 2020 2020 2020 2020 2023 207b 2265             # {"e
+000266e0: 7272 636f 6465 223a 224d 5f46 4f52 4249  rrcode":"M_FORBI
+000266f0: 4444 454e 222c 2265 7272 6f72 223a 2259  DDEN","error":"Y
+00026700: 6f75 2061 7265 206e 6f74 2061 2073 6572  ou are not a ser
+00026710: 7665 7220 6164 6d69 6e22 7d0a 2020 2020  ver admin"}.    
+00026720: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
+00026730: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+00026740: 2020 2020 2020 2245 3137 333a 2022 0a20        "E173: ". 
+00026750: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00026760: 2246 6169 6c65 6420 746f 2064 656c 6574  "Failed to delet
+00026770: 6520 6f62 6a65 6374 2028 6d78 6329 2027  e object (mxc) '
+00026780: 7b6d 7863 7d27 2066 726f 6d20 7365 7276  {mxc}' from serv
+00026790: 6572 2022 0a20 2020 2020 2020 2020 2020  er ".           
+000267a0: 2020 2020 2066 2227 7b73 7276 5f66 756c       f"'{srv_ful
+000267b0: 6c7d 272e 2046 6169 6c65 6420 7769 7468  l}'. Failed with
+000267c0: 2065 7272 6f72 2063 6f64 6520 7b73 7461   error code {sta
+000267d0: 7475 737d 2061 6e64 2022 0a20 2020 2020  tus} and ".     
+000267e0: 2020 2020 2020 2020 2020 2066 2265 7272             f"err
+000267f0: 6f72 2074 6578 7420 7b74 7874 7d2e 220a  or text {txt}.".
+00026800: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00026810: 2020 2020 2020 2020 2020 6773 2e65 7272            gs.err
+00026820: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
+00026830: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00026840: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+00026850: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+00026860: 2020 2020 6622 4d58 4320 6f62 6a65 6374      f"MXC object
+00026870: 207b 6d78 637d 2077 6173 2073 7563 6365   {mxc} was succe
+00026880: 7373 6675 6c6c 7920 6465 6c65 7465 6420  ssfully deleted 
+00026890: 6672 6f6d 2073 6572 7665 7220 220a 2020  from server ".  
+000268a0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+000268b0: 7b73 7276 5f66 756c 6c7d 2e20 5265 7370  {srv_full}. Resp
+000268c0: 6f6e 7365 2069 733a 207b 7478 747d 2e22  onse is: {txt}."
+000268d0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+000268e0: 0a61 7379 6e63 2064 6566 2061 6374 696f  .async def actio
+000268f0: 6e5f 6465 6c65 7465 5f6d 7863 5f62 6566  n_delete_mxc_bef
+00026900: 6f72 6528 0a20 2020 2063 6c69 656e 743a  ore(.    client:
+00026910: 2041 7379 6e63 436c 6965 6e74 2c20 6372   AsyncClient, cr
+00026920: 6564 656e 7469 616c 733a 2064 6963 740a  edentials: dict.
+00026930: 2920 2d3e 204e 6f6e 653a 0a20 2020 2022  ) -> None:.    "
+00026940: 2222 4465 6c65 7465 2066 696c 6573 206f  ""Delete files o
+00026950: 6c64 6572 2061 6e64 206c 6172 6765 7220  lder and larger 
+00026960: 6672 6f6d 2063 6f6e 7465 6e74 2072 6570  from content rep
+00026970: 6f73 6974 6f72 7920 6f66 204d 6174 7269  ository of Matri
+00026980: 7820 7365 7276 6572 2e0a 2020 2020 4173  x server..    As
+00026990: 7375 6d65 7320 7468 6174 2075 7365 7220  sumes that user 
+000269a0: 6973 2061 6c72 6561 6479 206c 6f67 6765  is already logge
+000269b0: 6420 696e 2e0a 2020 2020 2222 220a 2020  d in..    """.  
+000269c0: 2020 2320 6874 7470 733a 2f2f 6d61 7472    # https://matr
+000269d0: 6978 2d6f 7267 2e67 6974 6875 622e 696f  ix-org.github.io
+000269e0: 2f73 796e 6170 7365 2f6c 6174 6573 742f  /synapse/latest/
+000269f0: 6164 6d69 6e5f 6170 692f 0a20 2020 2023  admin_api/.    #
+00026a00: 2020 206d 6564 6961 5f61 646d 696e 5f61     media_admin_a
+00026a10: 7069 2e68 746d 6c23 6465 6c65 7465 2d6c  pi.html#delete-l
+00026a20: 6f63 616c 2d6d 6564 6961 2d62 792d 6461  ocal-media-by-da
+00026a30: 7465 2d6f 722d 7369 7a65 0a20 2020 2023  te-or-size.    #
+00026a40: 2050 4f53 5420 2f5f 7379 6e61 7073 652f   POST /_synapse/
+00026a50: 6164 6d69 6e2f 7631 2f6d 6564 6961 2f3c  admin/v1/media/<
+00026a60: 7365 7276 6572 5f6e 616d 653e 2f64 656c  server_name>/del
+00026a70: 6574 653f 6265 666f 7265 5f74 733d 3c62  ete?before_ts=<b
+00026a80: 6566 6f72 655f 7473 3e0a 2020 2020 2320  efore_ts>.    # 
+00026a90: 2673 697a 655f 6774 3d3c 7369 7a65 3e0a  &size_gt=<size>.
+00026aa0: 2020 2020 6966 206c 656e 2867 732e 7061      if len(gs.pa
+00026ab0: 2e64 656c 6574 655f 6d78 635f 6265 666f  .delete_mxc_befo
+00026ac0: 7265 2920 3e20 323a 0a20 2020 2020 2020  re) > 2:.       
+00026ad0: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
+00026ae0: 2020 2020 2020 2020 2020 2022 4531 3734             "E174
+00026af0: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
+00026b00: 2249 6e63 6f72 7265 6374 206e 756d 6265  "Incorrect numbe
+00026b10: 7220 6f66 2061 7267 756d 656e 7473 2066  r of arguments f
+00026b20: 6f72 202d 2d64 656c 6574 655f 6d78 635f  or --delete_mxc_
+00026b30: 6265 666f 7265 2e20 220a 2020 2020 2020  before. ".      
+00026b40: 2020 2020 2020 2254 6865 7265 206d 7573        "There mus
+00026b50: 7420 6265 2031 206f 7220 3220 6172 6775  t be 1 or 2 argu
+00026b60: 6d65 6e74 7320 2c20 6275 7420 666f 756e  ments , but foun
+00026b70: 6420 220a 2020 2020 2020 2020 2020 2020  d ".            
+00026b80: 6622 7b6c 656e 2867 732e 7061 2e64 656c  f"{len(gs.pa.del
+00026b90: 6574 655f 6d78 635f 6265 666f 7265 297d  ete_mxc_before)}
+00026ba0: 2061 7267 756d 656e 7473 2e22 0a20 2020   arguments.".   
+00026bb0: 2020 2020 2029 0a20 2020 2020 2020 2067       ).        g
+00026bc0: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
+00026bd0: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
+00026be0: 2020 2020 7369 7a65 203d 2030 0a20 2020      size = 0.   
+00026bf0: 2069 6620 6c65 6e28 6773 2e70 612e 6465   if len(gs.pa.de
+00026c00: 6c65 7465 5f6d 7863 5f62 6566 6f72 6529  lete_mxc_before)
+00026c10: 203d 3d20 323a 0a20 2020 2020 2020 2073   == 2:.        s
+00026c20: 697a 6520 3d20 6773 2e70 612e 6465 6c65  ize = gs.pa.dele
+00026c30: 7465 5f6d 7863 5f62 6566 6f72 655b 315d  te_mxc_before[1]
+00026c40: 0a20 2020 2062 6566 6f72 655f 7374 7220  .    before_str 
+00026c50: 3d20 6773 2e70 612e 6465 6c65 7465 5f6d  = gs.pa.delete_m
+00026c60: 7863 5f62 6566 6f72 655b 305d 0a20 2020  xc_before[0].   
+00026c70: 206d 696c 6c69 7365 6320 3d20 696e 7428   millisec = int(
+00026c80: 0a20 2020 2020 2020 2064 6174 6574 696d  .        datetim
+00026c90: 652e 6461 7465 7469 6d65 2e73 7472 7074  e.datetime.strpt
+00026ca0: 696d 6528 6265 666f 7265 5f73 7472 2c20  ime(before_str, 
+00026cb0: 2225 642e 256d 2e25 5920 2548 3a25 4d3a  "%d.%m.%Y %H:%M:
+00026cc0: 2553 2229 2e74 696d 6573 7461 6d70 2829  %S").timestamp()
+00026cd0: 0a20 2020 2020 2020 202a 2031 3030 300a  .        * 1000.
+00026ce0: 2020 2020 290a 0a20 2020 2067 732e 6c6f      )..    gs.lo
+00026cf0: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
+00026d00: 2066 2250 7265 7061 7269 6e67 2074 6f20   f"Preparing to 
+00026d10: 6465 6c65 7465 206f 626a 6563 7473 206f  delete objects o
+00026d20: 6c64 6572 2074 6861 6e20 7b62 6566 6f72  lder than {befor
+00026d30: 655f 7374 727d 2022 0a20 2020 2020 2020  e_str} ".       
+00026d40: 2066 2228 556e 6978 2074 696d 6520 7b6d   f"(Unix time {m
+00026d50: 696c 6c69 7365 637d 2920 616e 6420 6c61  illisec}) and la
+00026d60: 7267 6572 2074 6861 6e20 7b73 697a 657d  rger than {size}
+00026d70: 2e22 0a20 2020 2029 0a20 2020 2069 6620  .".    ).    if 
+00026d80: 6773 2e70 612e 6163 6365 7373 5f74 6f6b  gs.pa.access_tok
+00026d90: 656e 3a0a 2020 2020 2020 2020 6174 203d  en:.        at =
+00026da0: 2067 732e 7061 2e61 6363 6573 735f 746f   gs.pa.access_to
+00026db0: 6b65 6e0a 2020 2020 2020 2020 6773 2e6c  ken.        gs.l
+00026dc0: 6f67 2e64 6562 7567 2822 5573 696e 6720  og.debug("Using 
+00026dd0: 6163 6365 7373 2074 6f6b 656e 2066 726f  access token fro
+00026de0: 6d20 2d2d 6163 6365 7373 2d74 6f6b 656e  m --access-token
+00026df0: 2061 7267 756d 656e 742e 2229 0a20 2020   argument.").   
+00026e00: 2065 6c73 653a 0a20 2020 2020 2020 2061   else:.        a
+00026e10: 7420 3d20 6372 6564 656e 7469 616c 735b  t = credentials[
+00026e20: 2261 6363 6573 735f 746f 6b65 6e22 5d0a  "access_token"].
+00026e30: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+00026e40: 6562 7567 2822 5573 696e 6720 6163 6365  ebug("Using acce
+00026e50: 7373 2074 6f6b 656e 2066 726f 6d20 6372  ss token from cr
+00026e60: 6564 656e 7469 616c 7320 6669 6c65 2e22  edentials file."
+00026e70: 290a 2020 2020 7372 765f 6675 6c6c 203d  ).    srv_full =
+00026e80: 2063 7265 6465 6e74 6961 6c73 5b22 686f   credentials["ho
+00026e90: 6d65 7365 7276 6572 225d 2020 2320 6874  meserver"]  # ht
+00026ea0: 7470 733a 2f2f 6578 616d 706c 652e 6d61  tps://example.ma
+00026eb0: 7472 6978 2e6f 7267 0a20 2020 2073 7276  trix.org.    srv
+00026ec0: 5f68 6f73 7420 3d20 7572 6c70 6172 7365  _host = urlparse
+00026ed0: 2873 7276 5f66 756c 6c29 2e68 6f73 746e  (srv_full).hostn
+00026ee0: 616d 6520 2023 2065 7861 6d70 6c65 2e6d  ame  # example.m
+00026ef0: 6174 7269 782e 6f72 670a 2020 2020 7265  atrix.org.    re
+00026f00: 7374 203d 2028 0a20 2020 2020 2020 2073  st = (.        s
+00026f10: 7276 5f66 756c 6c0a 2020 2020 2020 2020  rv_full.        
+00026f20: 2b20 222f 5f73 796e 6170 7365 2f61 646d  + "/_synapse/adm
+00026f30: 696e 2f76 312f 6d65 6469 612f 220a 2020  in/v1/media/".  
+00026f40: 2020 2020 2020 2b20 7372 765f 686f 7374        + srv_host
+00026f50: 0a20 2020 2020 2020 202b 2022 2f64 656c  .        + "/del
+00026f60: 6574 653f 6265 666f 7265 5f74 733d 220a  ete?before_ts=".
+00026f70: 2020 2020 2020 2020 2b20 7374 7228 6d69          + str(mi
+00026f80: 6c6c 6973 6563 290a 2020 2020 2020 2020  llisec).        
+00026f90: 2b20 2226 7369 7a65 5f67 743d 220a 2020  + "&size_gt=".  
+00026fa0: 2020 2020 2020 2b20 7374 7228 7369 7a65        + str(size
+00026fb0: 290a 2020 2020 2020 2020 2b20 2226 6163  ).        + "&ac
+00026fc0: 6365 7373 5f74 6f6b 656e 3d22 0a20 2020  cess_token=".   
+00026fd0: 2020 2020 202b 2061 740a 2020 2020 290a       + at.    ).
+00026fe0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+00026ff0: 2866 2249 7373 7569 6e67 2052 4553 5420  (f"Issuing REST 
+00027000: 4d61 7472 6978 2041 5049 2063 616c 6c3a  Matrix API call:
+00027010: 2050 4f53 5420 7b72 6573 747d 2229 0a20   POST {rest}"). 
+00027020: 2020 2063 6f6e 6e65 6374 6f72 203d 2054     connector = T
+00027030: 4350 436f 6e6e 6563 746f 7228 7373 6c3d  CPConnector(ssl=
+00027040: 6773 2e73 736c 2920 2023 2073 6574 7469  gs.ssl)  # setti
+00027050: 6e67 2073 736c 636f 6e74 6578 740a 2020  ng sslcontext.  
+00027060: 2020 6173 796e 6320 7769 7468 2043 6c69    async with Cli
+00027070: 656e 7453 6573 7369 6f6e 2863 6f6e 6e65  entSession(conne
+00027080: 6374 6f72 3d63 6f6e 6e65 6374 6f72 2920  ctor=connector) 
+00027090: 6173 2073 6573 7369 6f6e 3a20 2023 2061  as session:  # a
+000270a0: 696f 6874 7470 0a20 2020 2020 2020 2061  iohttp.        a
+000270b0: 7379 6e63 2077 6974 6820 7365 7373 696f  sync with sessio
+000270c0: 6e2e 706f 7374 2872 6573 7429 2061 7320  n.post(rest) as 
+000270d0: 7265 7370 3a0a 2020 2020 2020 2020 2020  resp:.          
+000270e0: 2020 7374 6174 7573 203d 2072 6573 702e    status = resp.
+000270f0: 7374 6174 7573 2020 2320 696e 742c 2032  status  # int, 2
+00027100: 3030 2073 7563 6365 7373 0a20 2020 2020  00 success.     
+00027110: 2020 2020 2020 2074 7874 203d 2061 7761         txt = awa
+00027120: 6974 2072 6573 702e 7465 7874 2829 2020  it resp.text()  
+00027130: 2320 7374 7220 696e 2064 6963 7420 666f  # str in dict fo
+00027140: 726d 6174 0a20 2020 2069 6620 7374 6174  rmat.    if stat
+00027150: 7573 2021 3d20 3230 303a 0a20 2020 2020  us != 200:.     
+00027160: 2020 2023 2074 7874 2069 7320 7374 7220     # txt is str 
+00027170: 6c69 6b65 2074 6869 733a 0a20 2020 2020  like this:.     
+00027180: 2020 2023 207b 2265 7272 636f 6465 223a     # {"errcode":
+00027190: 224d 5f46 4f52 4249 4444 454e 222c 2265  "M_FORBIDDEN","e
+000271a0: 7272 6f72 223a 2259 6f75 2061 7265 206e  rror":"You are n
+000271b0: 6f74 2061 2073 6572 7665 7220 6164 6d69  ot a server admi
+000271c0: 6e22 7d0a 2020 2020 2020 2020 6773 2e6c  n"}.        gs.l
+000271d0: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
+000271e0: 2020 2020 2020 2245 3137 353a 2022 0a20        "E175: ". 
+000271f0: 2020 2020 2020 2020 2020 2066 2246 6169             f"Fai
+00027200: 6c65 6420 746f 2064 656c 6574 6520 6f62  led to delete ob
+00027210: 6a65 6374 7320 6265 666f 7265 2027 7b62  jects before '{b
+00027220: 6566 6f72 655f 7374 727d 2720 6672 6f6d  efore_str}' from
+00027230: 2073 6572 7665 7220 220a 2020 2020 2020   server ".      
+00027240: 2020 2020 2020 6622 277b 7372 765f 6675        f"'{srv_fu
+00027250: 6c6c 7d27 2e20 4661 696c 6564 2077 6974  ll}'. Failed wit
+00027260: 6820 6572 726f 7220 636f 6465 207b 7374  h error code {st
+00027270: 6174 7573 7d20 616e 6420 220a 2020 2020  atus} and ".    
+00027280: 2020 2020 2020 2020 6622 6572 726f 7220          f"error 
+00027290: 7465 7874 207b 7478 747d 2e22 0a20 2020  text {txt}.".   
+000272a0: 2020 2020 2029 0a20 2020 2020 2020 2067       ).        g
+000272b0: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
+000272c0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+000272d0: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+000272e0: 0a20 2020 2020 2020 2020 2020 2066 224f  .            f"O
+000272f0: 626a 6563 7473 206f 6c64 6572 2074 6861  bjects older tha
+00027300: 6e20 7b62 6566 6f72 655f 7374 727d 2061  n {before_str} a
+00027310: 6e64 206c 6172 6765 7220 7468 616e 207b  nd larger than {
+00027320: 7369 7a65 7d20 220a 2020 2020 2020 2020  size} ".        
+00027330: 2020 2020 2277 6572 6520 7375 6363 6573      "were succes
+00027340: 7366 756c 6c79 2064 656c 6574 6564 2066  sfully deleted f
+00027350: 726f 6d20 7365 7276 6572 2022 0a20 2020  rom server ".   
+00027360: 2020 2020 2020 2020 2066 227b 7372 765f           f"{srv_
+00027370: 6675 6c6c 7d2e 2052 6573 706f 6e73 6520  full}. Response 
+00027380: 6973 3a20 5c6e 7b74 7874 7d2e 220a 2020  is: \n{txt}.".  
+00027390: 2020 2020 2020 290a 0a0a 6173 796e 6320        )...async 
+000273a0: 6465 6620 6163 7469 6f6e 5f64 6f77 6e6c  def action_downl
+000273b0: 6f61 6428 636c 6965 6e74 3a20 4173 796e  oad(client: Asyn
+000273c0: 6343 6c69 656e 742c 2063 7265 6465 6e74  cClient, credent
+000273d0: 6961 6c73 3a20 6469 6374 2920 2d3e 204e  ials: dict) -> N
+000273e0: 6f6e 653a 0a20 2020 2022 2222 446f 776e  one:.    """Down
+000273f0: 6c6f 6164 2061 2066 696c 6520 6672 6f6d  load a file from
+00027400: 2063 6f6e 7465 6e74 2072 6570 6f73 6974   content reposit
+00027410: 6f72 7920 6f66 204d 6174 7269 7820 7365  ory of Matrix se
+00027420: 7276 6572 2e0a 2020 2020 4173 7375 6d65  rver..    Assume
+00027430: 7320 7468 6174 2075 7365 7220 6973 2061  s that user is a
+00027440: 6c72 6561 6479 206c 6f67 6765 6420 696e  lready logged in
+00027450: 2e0a 2020 2020 2222 220a 2020 2020 6966  ..    """.    if
+00027460: 206e 6f74 2067 732e 7061 2e64 6f77 6e6c   not gs.pa.downl
+00027470: 6f61 643a 0a20 2020 2020 2020 2067 732e  oad:.        gs.
+00027480: 6c6f 672e 6465 6275 6728 2244 6f77 6e6c  log.debug("Downl
+00027490: 6f61 6420 6c69 7374 2069 7320 656d 7074  oad list is empt
+000274a0: 792e 204e 6f74 6869 6e67 2074 6f20 646f  y. Nothing to do
+000274b0: 776e 6c6f 6164 2e20 536b 6970 7069 6e67  wnload. Skipping
+000274c0: 2e22 290a 2020 2020 2020 2020 7265 7475  .").        retu
+000274d0: 726e 0a20 2020 2066 696c 656e 616d 6573  rn.    filenames
+000274e0: 203d 2067 732e 7061 2e66 696c 655f 6e61   = gs.pa.file_na
+000274f0: 6d65 0a20 2020 2069 6620 6669 6c65 6e61  me.    if filena
+00027500: 6d65 733a 0a20 2020 2020 2020 2077 6869  mes:.        whi
+00027510: 6c65 206c 656e 2866 696c 656e 616d 6573  le len(filenames
+00027520: 2920 3c20 6c65 6e28 6773 2e70 612e 646f  ) < len(gs.pa.do
+00027530: 776e 6c6f 6164 293a 0a20 2020 2020 2020  wnload):.       
+00027540: 2020 2020 2066 696c 656e 616d 6573 2e61       filenames.a
+00027550: 7070 656e 6428 4e6f 6e65 290a 2020 2020  ppend(None).    
+00027560: 6465 6372 7970 7469 6f6e 5f73 7472 696e  decryption_strin
+00027570: 6773 203d 2067 732e 7061 2e6b 6579 5f64  gs = gs.pa.key_d
+00027580: 6963 740a 2020 2020 6966 2064 6563 7279  ict.    if decry
+00027590: 7074 696f 6e5f 7374 7269 6e67 733a 0a20  ption_strings:. 
+000275a0: 2020 2020 2020 2077 6869 6c65 206c 656e         while len
+000275b0: 2864 6563 7279 7074 696f 6e5f 7374 7269  (decryption_stri
+000275c0: 6e67 7329 203c 206c 656e 2867 732e 7061  ngs) < len(gs.pa
+000275d0: 2e6b 6579 5f64 6963 7429 3a0a 2020 2020  .key_dict):.    
+000275e0: 2020 2020 2020 2020 6465 6372 7970 7469          decrypti
+000275f0: 6f6e 5f73 7472 696e 6773 2e61 7070 656e  on_strings.appen
+00027600: 6428 4e6f 6e65 290a 2020 2020 2320 6669  d(None).    # fi
+00027610: 6c65 6e61 6d65 7320 6973 206e 6f77 204e  lenames is now N
+00027620: 6f6e 6520 6f72 206c 6973 7420 6174 206c  one or list at l
+00027630: 6561 7374 2061 7320 6c6f 6e67 2061 7320  east as long as 
+00027640: 646f 776e 6c6f 6164 730a 2020 2020 2320  downloads.    # 
+00027650: 6465 6372 7970 7469 6f6e 5f73 7472 696e  decryption_strin
+00027660: 6773 2069 7320 6e6f 7720 4e6f 6e65 206f  gs is now None o
+00027670: 7220 6c69 7374 2061 7420 6c65 6173 7420  r list at least 
+00027680: 6173 206c 6f6e 6720 6173 2064 6f77 6e6c  as long as downl
+00027690: 6f61 6473 0a20 2020 2067 732e 6c6f 672e  oads.    gs.log.
+000276a0: 6465 6275 6728 6622 4669 6c65 206e 616d  debug(f"File nam
+000276b0: 6573 2070 726f 7669 6465 6420 696e 2061  es provided in a
+000276c0: 7267 756d 656e 7473 3a20 7b66 696c 656e  rguments: {filen
+000276d0: 616d 6573 7d22 290a 2020 2020 6773 2e6c  ames}").    gs.l
+000276e0: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
+000276f0: 2020 2244 6563 7279 7074 696f 6e20 7374    "Decryption st
+00027700: 7269 6e67 7320 7072 6f76 6964 6564 2069  rings provided i
+00027710: 6e20 6172 6775 6d65 6e74 733a 2022 0a20  n arguments: ". 
+00027720: 2020 2020 2020 2022 272a 2a2a 2068 6964         "'*** hid
+00027730: 6465 6e20 746f 2070 7265 7665 6e74 206c  den to prevent l
+00027740: 6561 6b73 2722 0a20 2020 2020 2020 2023  eaks'".        #
+00027750: 2066 227b 6465 6372 7970 7469 6f6e 5f73   f"{decryption_s
+00027760: 7472 696e 6773 7d22 0a20 2020 2029 0a20  trings}".    ). 
+00027770: 2020 2069 6920 3d20 300a 2020 2020 666f     ii = 0.    fo
+00027780: 7220 646f 776e 6c6f 6164 2069 6e20 6773  r download in gs
+00027790: 2e70 612e 646f 776e 6c6f 6164 3a0a 2020  .pa.download:.  
+000277a0: 2020 2020 2020 6966 2067 732e 7061 2e66        if gs.pa.f
+000277b0: 696c 655f 6e61 6d65 3a0a 2020 2020 2020  ile_name:.      
+000277c0: 2020 2020 2020 6669 6c65 6e61 6d65 203d        filename =
+000277d0: 2066 696c 656e 616d 6573 5b69 695d 2020   filenames[ii]  
+000277e0: 2320 3173 7420 6368 6f69 6365 0a20 2020  # 1st choice.   
+000277f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00027800: 2020 2020 2020 2023 2032 6e64 2063 686f         # 2nd cho
+00027810: 6963 653b 2067 6574 2066 696c 656e 616d  ice; get filenam
+00027820: 6520 6672 6f6d 2073 6572 7665 720a 2020  e from server.  
+00027830: 2020 2020 2020 2020 2020 2320 692e 652e            # i.e.
+00027840: 2075 7365 2074 6865 206f 7269 6769 6e61   use the origina
+00027850: 6c20 6669 6c65 6e61 6d65 2066 726f 6d20  l filename from 
+00027860: 7570 6c6f 6164 0a20 2020 2020 2020 2020  upload.         
+00027870: 2020 2066 696c 656e 616d 6520 3d20 4e6f     filename = No
+00027880: 6e65 0a20 2020 2020 2020 2069 6620 6773  ne.        if gs
+00027890: 2e70 612e 6b65 795f 6469 6374 3a0a 2020  .pa.key_dict:.  
+000278a0: 2020 2020 2020 2020 2020 6465 6372 7970            decryp
+000278b0: 7469 6f6e 5f73 7472 203d 2064 6563 7279  tion_str = decry
+000278c0: 7074 696f 6e5f 7374 7269 6e67 735b 6969  ption_strings[ii
+000278d0: 5d0a 2020 2020 2020 2020 656c 7365 3a0a  ].        else:.
+000278e0: 2020 2020 2020 2020 2020 2020 6465 6372              decr
+000278f0: 7970 7469 6f6e 5f73 7472 203d 204e 6f6e  yption_str = Non
+00027900: 650a 2020 2020 2020 2020 656e 6372 7970  e.        encryp
+00027910: 7465 6420 3d20 5472 7565 2069 6620 6465  ted = True if de
+00027920: 6372 7970 7469 6f6e 5f73 7472 2065 6c73  cryption_str els
+00027930: 6520 4661 6c73 650a 2020 2020 2020 2020  e False.        
+00027940: 6966 206e 6f74 2065 6e63 7279 7074 6564  if not encrypted
+00027950: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
+00027960: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
+00027970: 2020 2020 2020 2020 2020 2020 224e 6f20              "No 
+00027980: 6b65 7920 6469 6374 696f 6e61 7279 2073  key dictionary s
+00027990: 7065 6369 6669 6564 2077 6974 6820 2d2d  pecified with --
+000279a0: 6b65 792d 6469 6374 2e20 536f 2c20 6974  key-dict. So, it
+000279b0: 2069 7320 220a 2020 2020 2020 2020 2020   is ".          
+000279c0: 2020 2020 2020 2261 7373 756d 6564 2074        "assumed t
+000279d0: 6861 7420 7468 6520 646f 776e 6c6f 6164  hat the download
+000279e0: 2069 7320 6e6f 7420 656e 6372 7970 7465   is not encrypte
+000279f0: 6420 220a 2020 2020 2020 2020 2020 2020  d ".            
+00027a00: 2020 2020 2228 692e 652e 2070 6c61 696e      "(i.e. plain
+00027a10: 2d74 6578 7429 2e20 4e6f 2064 6563 7279  -text). No decry
+00027a20: 7074 696f 6e20 7769 6c6c 2062 6520 6174  ption will be at
+00027a30: 7465 6d70 7465 642e 220a 2020 2020 2020  tempted.".      
+00027a40: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00027a50: 6d78 6320 3d20 646f 776e 6c6f 6164 0a20  mxc = download. 
+00027a60: 2020 2020 2020 2072 6573 7020 3d20 6177         resp = aw
+00027a70: 6169 7420 646f 776e 6c6f 6164 5f6d 7863  ait download_mxc
+00027a80: 2863 6c69 656e 742c 206d 7863 3d6d 7863  (client, mxc=mxc
+00027a90: 2c20 6669 6c65 6e61 6d65 3d66 696c 656e  , filename=filen
+00027aa0: 616d 6529 0a20 2020 2020 2020 2069 6620  ame).        if 
+00027ab0: 6973 696e 7374 616e 6365 2872 6573 702c  isinstance(resp,
+00027ac0: 2044 6f77 6e6c 6f61 6445 7272 6f72 293a   DownloadError):
+00027ad0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+00027ae0: 6c6f 672e 6572 726f 7228 0a20 2020 2020  log.error(.     
+00027af0: 2020 2020 2020 2020 2020 2022 4531 3736             "E176
+00027b00: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
+00027b10: 2020 2020 6622 646f 776e 6c6f 6164 206f      f"download o
+00027b20: 6620 5552 4920 277b 6d78 637d 2720 746f  f URI '{mxc}' to
+00027b30: 206c 6f63 616c 2066 696c 6520 277b 6669   local file '{fi
+00027b40: 6c65 6e61 6d65 7d27 2022 0a20 2020 2020  lename}' ".     
+00027b50: 2020 2020 2020 2020 2020 2066 2266 6169             f"fai
+00027b60: 6c65 6420 7769 7468 2072 6573 706f 6e73  led with respons
+00027b70: 6520 7b70 7269 7661 6379 5f66 696c 7465  e {privacy_filte
+00027b80: 7228 7374 7228 7265 7370 2929 7d22 0a20  r(str(resp))}". 
+00027b90: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00027ba0: 2020 2020 2020 2020 2067 732e 6572 725f           gs.err_
+00027bb0: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
+00027bc0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00027bd0: 2020 2020 2075 726c 203d 2075 726c 7061       url = urlpa
+00027be0: 7273 6528 6d78 6329 0a20 2020 2020 2020  rse(mxc).       
+00027bf0: 2020 2020 206d 6564 6961 5f69 6420 3d20       media_id = 
+00027c00: 7572 6c2e 7061 7468 2e73 7472 6970 2822  url.path.strip("
+00027c10: 2f22 290a 2020 2020 2020 2020 2020 2020  /").            
+00027c20: 6966 2066 696c 656e 616d 6520 3d3d 2022  if filename == "
+00027c30: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
+00027c40: 2020 2066 696c 656e 616d 6520 3d20 226d     filename = "m
+00027c50: 7863 2d22 202b 204d 5843 5f49 445f 504c  xc-" + MXC_ID_PL
+00027c60: 4143 4548 4f4c 4445 520a 2020 2020 2020  ACEHOLDER.      
+00027c70: 2020 2020 2020 6966 206e 6f74 2066 696c        if not fil
+00027c80: 656e 616d 653a 0a20 2020 2020 2020 2020  ename:.         
+00027c90: 2020 2020 2020 2066 696c 656e 616d 6520         filename 
+00027ca0: 3d20 7265 7370 2e66 696c 656e 616d 6520  = resp.filename 
+00027cb0: 2023 2032 6e64 2063 686f 6963 652c 2066   # 2nd choice, f
+00027cc0: 726f 6d20 7365 7276 6572 0a20 2020 2020  rom server.     
+00027cd0: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
+00027ce0: 672e 6465 6275 6728 6622 4669 6c65 206e  g.debug(f"File n
+00027cf0: 616d 6520 6f6e 2073 6572 7665 723a 207b  ame on server: {
+00027d00: 6669 6c65 6e61 6d65 737d 2229 0a20 2020  filenames}").   
+00027d10: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00027d20: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00027d30: 696c 656e 616d 6520 3d20 6669 6c65 6e61  ilename = filena
+00027d40: 6d65 2e72 6570 6c61 6365 284d 5843 5f49  me.replace(MXC_I
+00027d50: 445f 504c 4143 4548 4f4c 4445 522c 206d  D_PLACEHOLDER, m
+00027d60: 6564 6961 5f69 6429 0a20 2020 2020 2020  edia_id).       
+00027d70: 2020 2020 2069 6620 6e6f 7420 6669 6c65       if not file
+00027d80: 6e61 6d65 3a0a 2020 2020 2020 2020 2020  name:.          
+00027d90: 2020 2020 2020 6669 6c65 6e61 6d65 203d        filename =
+00027da0: 2022 6d78 632d 2220 2b20 6d65 6469 615f   "mxc-" + media_
+00027db0: 6964 2020 2320 3372 6420 6368 6f69 6365  id  # 3rd choice
+00027dc0: 2c20 6d78 635f 6964 0a20 2020 2020 2020  , mxc_id.       
+00027dd0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
+00027de0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+00027df0: 2020 2066 2244 6f77 6e6c 6f61 6420 6f66     f"Download of
+00027e00: 2055 5249 2027 7b6d 7863 7d27 2074 6f20   URI '{mxc}' to 
+00027e10: 6c6f 6361 6c20 6669 6c65 2027 7b66 696c  local file '{fil
+00027e20: 656e 616d 657d 2720 220a 2020 2020 2020  ename}' ".      
+00027e30: 2020 2020 2020 2020 2020 6622 7375 6363            f"succ
+00027e40: 6573 7366 756c 2077 6974 6820 7b6c 656e  essful with {len
+00027e50: 2872 6573 702e 626f 6479 297d 2062 7974  (resp.body)} byt
+00027e60: 6573 206f 6620 6461 7461 2064 6f77 6e6c  es of data downl
+00027e70: 6f61 6465 642c 2022 0a20 2020 2020 2020  oaded, ".       
+00027e80: 2020 2020 2020 2020 2066 2263 6f6e 7465           f"conte
+00027e90: 6e74 5f74 7970 6520 7b72 6573 702e 636f  nt_type {resp.co
+00027ea0: 6e74 656e 745f 7479 7065 7d3b 2022 0a20  ntent_type}; ". 
+00027eb0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00027ec0: 2272 656d 6f74 6520 6669 6c65 6e61 6d65  "remote filename
+00027ed0: 207b 7265 7370 2e66 696c 656e 616d 657d   {resp.filename}
+00027ee0: 3b20 220a 2020 2020 2020 2020 2020 2020  ; ".            
+00027ef0: 2020 2020 6622 656e 6372 7970 7465 6420      f"encrypted 
+00027f00: 7b65 6e63 7279 7074 6564 7d3b 2022 0a20  {encrypted}; ". 
+00027f10: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00027f20: 6b65 7920 6469 6374 696f 6e61 7279 2027  key dictionary '
+00027f30: 2a2a 2a20 6869 6464 656e 2074 6f20 7072  *** hidden to pr
+00027f40: 6576 656e 7420 6c65 616b 7327 2e20 220a  event leaks'. ".
+00027f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027f60: 2320 6622 6b65 7920 6469 6374 696f 6e61  # f"key dictiona
+00027f70: 7279 207b 6465 6372 7970 7469 6f6e 5f73  ry {decryption_s
+00027f80: 7472 7d2e 2022 0a20 2020 2020 2020 2020  tr}. ".         
+00027f90: 2020 2020 2020 2022 5472 7969 6e67 2074         "Trying t
+00027fa0: 6f20 7361 7665 2064 6174 6120 6e6f 772e  o save data now.
+00027fb0: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+00027fc0: 2020 2020 2020 2020 2020 2020 6966 2065              if e
+00027fd0: 6e63 7279 7074 6564 3a0a 2020 2020 2020  ncrypted:.      
+00027fe0: 2020 2020 2020 2020 2020 6465 6372 7970            decryp
+00027ff0: 7469 6f6e 5f64 6963 7420 3d20 6173 742e  tion_dict = ast.
+00028000: 6c69 7465 7261 6c5f 6576 616c 2864 6563  literal_eval(dec
+00028010: 7279 7074 696f 6e5f 7374 7229 0a20 2020  ryption_str).   
+00028020: 2020 2020 2020 2020 2020 2020 2077 6974               wit
+00028030: 6820 6f70 656e 2866 696c 656e 616d 652c  h open(filename,
+00028040: 2022 7762 2229 2061 7320 6669 6c65 3a0a   "wb") as file:.
 00028050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028060: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00028070: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00028080: 2020 2020 2020 2020 656c 7365 3a20 2023          else:  #
-00028090: 2070 6c61 696e 2c20 756e 656e 6372 7970   plain, unencryp
-000280a0: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
-000280b0: 2020 2020 7769 7468 206f 7065 6e28 6669      with open(fi
-000280c0: 6c65 6e61 6d65 2c20 2277 6222 2920 6173  lename, "wb") as
-000280d0: 2066 696c 653a 0a20 2020 2020 2020 2020   file:.         
-000280e0: 2020 2020 2020 2020 2020 2066 696c 652e             file.
-000280f0: 7772 6974 6528 7265 7370 2e62 6f64 7929  write(resp.body)
-00028100: 0a20 2020 2020 2020 2069 6920 2b3d 2031  .        ii += 1
-00028110: 0a0a 0a61 7379 6e63 2064 6566 2061 6374  ...async def act
-00028120: 696f 6e5f 6a6f 696e 6564 5f72 6f6f 6d73  ion_joined_rooms
-00028130: 2863 6c69 656e 743a 2041 7379 6e63 436c  (client: AsyncCl
-00028140: 6965 6e74 2c20 6372 6564 656e 7469 616c  ient, credential
-00028150: 733a 2064 6963 7429 202d 3e20 4e6f 6e65  s: dict) -> None
-00028160: 3a0a 2020 2020 2222 2247 6574 206a 6f69  :.    """Get joi
-00028170: 6e65 6420 726f 6f6d 7320 7768 696c 6520  ned rooms while 
-00028180: 616c 7265 6164 7920 6c6f 6767 6564 2069  already logged i
-00028190: 6e2e 2222 220a 2020 2020 7265 7370 203d  n.""".    resp =
-000281a0: 2061 7761 6974 2063 6c69 656e 742e 6a6f   await client.jo
-000281b0: 696e 6564 5f72 6f6f 6d73 2829 0a20 2020  ined_rooms().   
-000281c0: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
-000281d0: 6573 702c 204a 6f69 6e65 6452 6f6f 6d73  esp, JoinedRooms
-000281e0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-000281f0: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
-00028200: 2020 2020 2020 2020 2020 2245 3137 373a            "E177:
-00028210: 2022 2066 226a 6f69 6e65 645f 726f 6f6d   " f"joined_room
-00028220: 7320 6661 696c 6564 2077 6974 6820 7b70  s failed with {p
-00028230: 7269 7661 6379 5f66 696c 7465 7228 7374  rivacy_filter(st
-00028240: 7228 7265 7370 2929 7d22 0a20 2020 2020  r(resp))}".     
-00028250: 2020 2029 0a20 2020 2020 2020 2067 732e     ).        gs.
-00028260: 6572 725f 636f 756e 7420 2b3d 2031 0a20  err_count += 1. 
-00028270: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00028280: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
-00028290: 2020 2020 2020 2020 2020 2066 226a 6f69             f"joi
-000282a0: 6e65 645f 726f 6f6d 7320 7375 6363 6573  ned_rooms succes
-000282b0: 7366 756c 2077 6974 6820 7b70 7269 7661  sful with {priva
-000282c0: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
-000282d0: 7370 2929 7d22 0a20 2020 2020 2020 2029  sp))}".        )
-000282e0: 0a20 2020 2020 2020 2023 206f 7574 7075  .        # outpu
-000282f0: 7420 666f 726d 6174 2063 6f6e 7472 6f6c  t format control
-00028300: 6c65 6420 7669 6120 2d2d 6f75 7470 7574  led via --output
-00028310: 2066 6c61 670a 2020 2020 2020 2020 7465   flag.        te
-00028320: 7874 203d 2022 220a 2020 2020 2020 2020  xt = "".        
-00028330: 666f 7220 7272 2069 6e20 7265 7370 2e72  for rr in resp.r
-00028340: 6f6f 6d73 3a0a 2020 2020 2020 2020 2020  ooms:.          
-00028350: 2020 7465 7874 202b 3d20 7272 202b 2022    text += rr + "
-00028360: 5c6e 220a 2020 2020 2020 2020 7465 7874  \n".        text
-00028370: 203d 2074 6578 742e 7374 7269 7028 290a   = text.strip().
-00028380: 2020 2020 2020 2020 2320 4f62 6a65 6374          # Object
-00028390: 206f 6620 7479 7065 2078 7878 5265 7370   of type xxxResp
-000283a0: 6f6e 7365 2069 7320 6e6f 7420 4a53 4f4e  onse is not JSON
-000283b0: 0a20 2020 2020 2020 2023 2073 6572 6961  .        # seria
-000283c0: 6c69 7a61 626c 652c 2068 656e 6365 2077  lizable, hence w
-000283d0: 6520 7573 6520 7468 6520 6469 6374 696f  e use the dictio
-000283e0: 6e61 7279 2e0a 2020 2020 2020 2020 6a73  nary..        js
-000283f0: 6f6e 5f6d 6178 203d 2072 6573 702e 5f5f  on_max = resp.__
-00028400: 6469 6374 5f5f 0a20 2020 2020 2020 2023  dict__.        #
-00028410: 206a 736f 6e5f 6d61 782e 7570 6461 7465   json_max.update
-00028420: 287b 226b 6579 223a 2076 616c 7565 7d29  ({"key": value})
-00028430: 2020 2320 6164 6420 6469 6374 2069 7465    # add dict ite
-00028440: 6d73 0a20 2020 2020 2020 206a 736f 6e5f  ms.        json_
-00028450: 203d 206a 736f 6e5f 6d61 782e 636f 7079   = json_max.copy
-00028460: 2829 0a20 2020 2020 2020 206a 736f 6e5f  ().        json_
-00028470: 2e70 6f70 2822 7472 616e 7370 6f72 745f  .pop("transport_
-00028480: 7265 7370 6f6e 7365 2229 0a20 2020 2020  response").     
-00028490: 2020 206a 736f 6e5f 7370 6563 203d 204e     json_spec = N
-000284a0: 6f6e 650a 2020 2020 2020 2020 7072 696e  one.        prin
-000284b0: 745f 6f75 7470 7574 280a 2020 2020 2020  t_output(.      
-000284c0: 2020 2020 2020 6773 2e70 612e 6f75 7470        gs.pa.outp
-000284d0: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
-000284e0: 7465 7874 3d74 6578 742c 0a20 2020 2020  text=text,.     
-000284f0: 2020 2020 2020 206a 736f 6e5f 3d6a 736f         json_=jso
-00028500: 6e5f 2c0a 2020 2020 2020 2020 2020 2020  n_,.            
-00028510: 6a73 6f6e 5f6d 6178 3d6a 736f 6e5f 6d61  json_max=json_ma
-00028520: 782c 0a20 2020 2020 2020 2020 2020 206a  x,.            j
-00028530: 736f 6e5f 7370 6563 3d6a 736f 6e5f 7370  son_spec=json_sp
-00028540: 6563 2c0a 2020 2020 2020 2020 290a 0a0a  ec,.        )...
-00028550: 6173 796e 6320 6465 6620 6163 7469 6f6e  async def action
-00028560: 5f6a 6f69 6e65 645f 6d65 6d62 6572 7328  _joined_members(
-00028570: 0a20 2020 2063 6c69 656e 743a 2041 7379  .    client: Asy
-00028580: 6e63 436c 6965 6e74 2c20 6372 6564 656e  ncClient, creden
-00028590: 7469 616c 733a 2064 6963 740a 2920 2d3e  tials: dict.) ->
-000285a0: 204e 6f6e 653a 0a20 2020 2022 2222 4765   None:.    """Ge
-000285b0: 7420 6d65 6d62 6572 7320 6f66 2067 6976  t members of giv
-000285c0: 656e 2072 6f6f 6d73 2077 6869 6c65 2061  en rooms while a
-000285d0: 6c72 6561 6479 2062 6569 6e67 206c 6f67  lready being log
-000285e0: 6765 6420 696e 2e22 2222 0a20 2020 2072  ged in.""".    r
-000285f0: 6f6f 6d73 203d 2067 732e 7061 2e6a 6f69  ooms = gs.pa.joi
-00028600: 6e65 645f 6d65 6d62 6572 730a 2020 2020  ned_members.    
-00028610: 6966 206e 6f74 2072 6f6f 6d73 3a0a 2020  if not rooms:.  
-00028620: 2020 2020 2020 6773 2e6c 6f67 2e77 6172        gs.log.war
-00028630: 6e69 6e67 280a 2020 2020 2020 2020 2020  ning(.          
-00028640: 2020 2257 3130 373a 2022 0a20 2020 2020    "W107: ".     
-00028650: 2020 2020 2020 2022 4e6f 206d 656d 6265         "No membe
-00028660: 7273 6869 7020 6163 7469 6f6e 2873 2920  rship action(s) 
-00028670: 7765 7265 2070 6572 666f 726d 6564 2062  were performed b
-00028680: 6563 6175 7365 206e 6f20 726f 6f6d 7320  ecause no rooms 
-00028690: 220a 2020 2020 2020 2020 2020 2020 2277  ".            "w
-000286a0: 6572 6520 7370 6563 6966 6965 642e 2055  ere specified. U
-000286b0: 7365 202d 2d6a 6f69 6e65 642d 6d65 6d62  se --joined-memb
-000286c0: 6572 7320 6f70 7469 6f6e 2061 6e64 2073  ers option and s
-000286d0: 7065 6369 6679 2072 6f6f 6d73 2e22 0a20  pecify rooms.". 
-000286e0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000286f0: 2067 732e 7761 726e 5f63 6f75 6e74 202b   gs.warn_count +
-00028700: 3d20 310a 2020 2020 2020 2020 7265 7475  = 1.        retu
-00028710: 726e 0a0a 2020 2020 6773 2e6c 6f67 2e64  rn..    gs.log.d
-00028720: 6562 7567 2866 2254 7279 696e 6720 746f  ebug(f"Trying to
-00028730: 2067 6574 206d 656d 6265 7273 2066 6f72   get members for
-00028740: 2074 6865 7365 2072 6f6f 6d73 3a20 7b72   these rooms: {r
-00028750: 6f6f 6d73 7d22 290a 2020 2020 6966 2022  ooms}").    if "
-00028760: 2a22 2069 6e20 726f 6f6d 733a 0a20 2020  *" in rooms:.   
-00028770: 2020 2020 2072 6573 7020 3d20 6177 6169       resp = awai
-00028780: 7420 636c 6965 6e74 2e6a 6f69 6e65 645f  t client.joined_
-00028790: 726f 6f6d 7328 290a 2020 2020 2020 2020  rooms().        
-000287a0: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
-000287b0: 7370 2c20 4a6f 696e 6564 526f 6f6d 7345  sp, JoinedRoomsE
-000287c0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-000287d0: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
-000287e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000287f0: 2022 4531 3738 3a20 220a 2020 2020 2020   "E178: ".      
-00028800: 2020 2020 2020 2020 2020 226a 6f69 6e65            "joine
-00028810: 645f 726f 6f6d 7320 6661 696c 6564 2077  d_rooms failed w
-00028820: 6974 6820 220a 2020 2020 2020 2020 2020  ith ".          
-00028830: 2020 2020 2020 6622 7b70 7269 7661 6379        f"{privacy
-00028840: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
-00028850: 2929 7d2e 204e 6f74 2061 626c 6520 746f  ))}. Not able to
-00028860: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00028870: 2020 2022 6765 7420 616c 6c20 726f 6f6d     "get all room
-00028880: 7320 6173 2073 7065 6369 6669 6564 2062  s as specified b
-00028890: 7920 272a 272e 2022 0a20 2020 2020 2020  y '*'. ".       
-000288a0: 2020 2020 2020 2020 2022 5468 6520 6d65           "The me
-000288b0: 6d62 6572 206c 6973 7469 6e67 2077 696c  mber listing wil
-000288c0: 6c20 6265 2069 6e63 6f6d 706c 6574 6520  l be incomplete 
-000288d0: 6f72 206d 6973 7369 6e67 2e22 0a20 2020  or missing.".   
-000288e0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000288f0: 2020 2020 2020 2067 732e 6572 725f 636f         gs.err_co
-00028900: 756e 7420 2b3d 2031 0a20 2020 2020 2020  unt += 1.       
-00028910: 2020 2020 2023 2073 696e 6365 2077 6520       # since we 
-00028920: 6361 6e27 7420 6765 7420 616c 6c20 726f  can't get all ro
-00028930: 6f6d 7320 6c65 6176 6520 726f 6f6d 206c  oms leave room l
-00028940: 6973 7420 6173 2069 730a 2020 2020 2020  ist as is.      
-00028950: 2020 2020 2020 726f 6f6d 7320 3d20 6669        rooms = fi
-00028960: 6c74 6572 286c 616d 6264 6120 7661 6c3a  lter(lambda val:
-00028970: 2076 616c 2021 3d20 222a 222c 2072 6f6f   val != "*", roo
-00028980: 6d73 2920 2023 2072 656d 6f76 6520 616c  ms)  # remove al
-00028990: 6c20 2a0a 2020 2020 2020 2020 656c 7365  l *.        else
-000289a0: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
-000289b0: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
-000289c0: 2020 2020 2020 2020 2020 2020 6622 6a6f              f"jo
-000289d0: 696e 6564 5f72 6f6f 6d73 2073 7563 6365  ined_rooms succe
-000289e0: 7373 6675 6c20 7769 7468 207b 7072 6976  ssful with {priv
-000289f0: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
-00028a00: 6573 7029 297d 220a 2020 2020 2020 2020  esp))}".        
-00028a10: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00028a20: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
-00028a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028a40: 2252 6f6f 6d20 6c69 7374 2068 6173 2062  "Room list has b
-00028a50: 6565 6e20 7375 6363 6573 7366 756c 6c79  een successfully
-00028a60: 206f 7665 7277 7269 7474 656e 2077 6974   overwritten wit
-00028a70: 6820 272a 2722 0a20 2020 2020 2020 2020  h '*'".         
-00028a80: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00028a90: 2072 6f6f 6d73 203d 2072 6573 702e 726f   rooms = resp.ro
-00028aa0: 6f6d 7320 2023 206f 7665 7277 7269 7465  oms  # overwrite
-00028ab0: 2061 7267 7320 7769 7468 2066 756c 6c20   args with full 
-00028ac0: 6c69 7374 0a20 2020 2066 6f72 2072 6f6f  list.    for roo
-00028ad0: 6d20 696e 2072 6f6f 6d73 3a0a 2020 2020  m in rooms:.    
-00028ae0: 2020 2020 726f 6f6d 203d 2072 6f6f 6d2e      room = room.
-00028af0: 7265 706c 6163 6528 7222 5c21 222c 2022  replace(r"\!", "
-00028b00: 2122 2920 2023 2072 656d 6f76 6520 706f  !")  # remove po
-00028b10: 7373 6962 6c65 2065 7363 6170 650a 2020  ssible escape.  
-00028b20: 2020 2020 2020 7265 7370 203d 2061 7761        resp = awa
-00028b30: 6974 2063 6c69 656e 742e 6a6f 696e 6564  it client.joined
-00028b40: 5f6d 656d 6265 7273 2872 6f6f 6d29 0a20  _members(room). 
-00028b50: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-00028b60: 616e 6365 2872 6573 702c 204a 6f69 6e65  ance(resp, Joine
-00028b70: 644d 656d 6265 7273 4572 726f 7229 3a0a  dMembersError):.
-00028b80: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
-00028b90: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
-00028ba0: 2020 2020 2020 2020 2020 2245 3137 393a            "E179:
-00028bb0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00028bc0: 2020 2066 226a 6f69 6e65 645f 6d65 6d62     f"joined_memb
-00028bd0: 6572 7320 6661 696c 6564 2077 6974 6820  ers failed with 
-00028be0: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
-00028bf0: 7374 7228 7265 7370 2929 7d22 0a20 2020  str(resp))}".   
-00028c00: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00028c10: 2020 2020 2020 2067 732e 6572 725f 636f         gs.err_co
-00028c20: 756e 7420 2b3d 2031 0a20 2020 2020 2020  unt += 1.       
-00028c30: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00028c40: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-00028c50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028c60: 2066 226a 6f69 6e65 645f 6d65 6d62 6572   f"joined_member
-00028c70: 7320 7375 6363 6573 7366 756c 2077 6974  s successful wit
-00028c80: 6820 7b70 7269 7661 6379 5f66 696c 7465  h {privacy_filte
-00028c90: 7228 7374 7228 7265 7370 2929 7d22 0a20  r(str(resp))}". 
-00028ca0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00028cb0: 2020 2020 2020 2020 2023 206d 656d 6265           # membe
-00028cc0: 7273 203d 204c 6973 745b 526f 6f6d 4d65  rs = List[RoomMe
-00028cd0: 6d62 6572 5d20 3b20 526f 6f6d 4d65 6d62  mber] ; RoomMemb
-00028ce0: 6572 0a20 2020 2020 2020 2020 2020 2023  er.            #
-00028cf0: 206f 7574 7075 7420 666f 726d 6174 2063   output format c
-00028d00: 6f6e 7472 6f6c 6c65 6420 7669 6120 2d2d  ontrolled via --
-00028d10: 6f75 7470 7574 2066 6c61 670a 2020 2020  output flag.    
-00028d20: 2020 2020 2020 2020 7465 7874 203d 2072          text = r
-00028d30: 6573 702e 726f 6f6d 5f69 6420 2b20 225c  esp.room_id + "\
-00028d40: 6e22 0a20 2020 2020 2020 2020 2020 2066  n".            f
-00028d50: 6f72 206d 656d 6265 7220 696e 2072 6573  or member in res
-00028d60: 702e 6d65 6d62 6572 733a 0a20 2020 2020  p.members:.     
-00028d70: 2020 2020 2020 2020 2020 2023 2063 6f6e             # con
-00028d80: 7665 7274 204e 6f6e 6520 746f 2027 270a  vert None to ''.
-00028d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028da0: 7465 7874 202b 3d20 280a 2020 2020 2020  text += (.      
-00028db0: 2020 2020 2020 2020 2020 2020 2020 5345                SE
-00028dc0: 500a 2020 2020 2020 2020 2020 2020 2020  P.              
-00028dd0: 2020 2020 2020 2b20 6d65 6d62 6572 2e75        + member.u
-00028de0: 7365 725f 6964 0a20 2020 2020 2020 2020  ser_id.         
-00028df0: 2020 2020 2020 2020 2020 202b 2053 4550             + SEP
-00028e00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028e10: 2020 2020 202b 207a 6e28 6d65 6d62 6572       + zn(member
-00028e20: 2e64 6973 706c 6179 5f6e 616d 6529 0a20  .display_name). 
-00028e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028e40: 2020 202b 2053 4550 0a20 2020 2020 2020     + SEP.       
-00028e50: 2020 2020 2020 2020 2020 2020 202b 207a               + z
-00028e60: 6e28 6d65 6d62 6572 2e61 7661 7461 725f  n(member.avatar_
-00028e70: 7572 6c29 0a20 2020 2020 2020 2020 2020  url).           
-00028e80: 2020 2020 2020 2020 202b 2022 5c6e 220a           + "\n".
-00028e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028ea0: 290a 2020 2020 2020 2020 2020 2020 7465  ).            te
-00028eb0: 7874 203d 2074 6578 742e 7374 7269 7028  xt = text.strip(
-00028ec0: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
-00028ed0: 4f62 6a65 6374 206f 6620 7479 7065 2078  Object of type x
-00028ee0: 7878 5265 7370 6f6e 7365 2069 7320 6e6f  xxResponse is no
-00028ef0: 7420 4a53 4f4e 0a20 2020 2020 2020 2020  t JSON.         
-00028f00: 2020 2023 2073 6572 6961 6c69 7a61 626c     # serializabl
-00028f10: 652c 2068 656e 6365 2077 6520 7573 6520  e, hence we use 
-00028f20: 7468 6520 6469 6374 696f 6e61 7279 2e0a  the dictionary..
-00028f30: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-00028f40: 5f6d 6178 203d 2072 6573 702e 5f5f 6469  _max = resp.__di
-00028f50: 6374 5f5f 0a20 2020 2020 2020 2020 2020  ct__.           
-00028f60: 2023 206a 736f 6e5f 6d61 782e 7570 6461   # json_max.upda
-00028f70: 7465 287b 226b 6579 223a 2076 616c 7565  te({"key": value
-00028f80: 7d29 2020 2320 6164 6420 6469 6374 2069  })  # add dict i
-00028f90: 7465 6d73 0a20 2020 2020 2020 2020 2020  tems.           
-00028fa0: 206a 736f 6e5f 203d 206a 736f 6e5f 6d61   json_ = json_ma
-00028fb0: 782e 636f 7079 2829 0a20 2020 2020 2020  x.copy().       
-00028fc0: 2020 2020 206a 736f 6e5f 2e70 6f70 2822       json_.pop("
-00028fd0: 7472 616e 7370 6f72 745f 7265 7370 6f6e  transport_respon
-00028fe0: 7365 2229 0a20 2020 2020 2020 2020 2020  se").           
-00028ff0: 206a 736f 6e5f 7370 6563 203d 204e 6f6e   json_spec = Non
-00029000: 650a 2020 2020 2020 2020 2020 2020 7072  e.            pr
-00029010: 696e 745f 6f75 7470 7574 280a 2020 2020  int_output(.    
-00029020: 2020 2020 2020 2020 2020 2020 6773 2e70              gs.p
-00029030: 612e 6f75 7470 7574 2c0a 2020 2020 2020  a.output,.      
-00029040: 2020 2020 2020 2020 2020 7465 7874 3d74            text=t
-00029050: 6578 742c 0a20 2020 2020 2020 2020 2020  ext,.           
-00029060: 2020 2020 206a 736f 6e5f 3d6a 736f 6e5f       json_=json_
-00029070: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00029080: 2020 6a73 6f6e 5f6d 6178 3d6a 736f 6e5f    json_max=json_
-00029090: 6d61 782c 0a20 2020 2020 2020 2020 2020  max,.           
-000290a0: 2020 2020 206a 736f 6e5f 7370 6563 3d6a       json_spec=j
-000290b0: 736f 6e5f 7370 6563 2c0a 2020 2020 2020  son_spec,.      
-000290c0: 2020 2020 2020 290a 0a0a 6173 796e 6320        )...async 
-000290d0: 6465 6620 6163 7469 6f6e 5f6d 7863 5f74  def action_mxc_t
-000290e0: 6f5f 6874 7470 2863 6c69 656e 743a 2041  o_http(client: A
-000290f0: 7379 6e63 436c 6965 6e74 2c20 6372 6564  syncClient, cred
-00029100: 656e 7469 616c 733a 2064 6963 7429 202d  entials: dict) -
-00029110: 3e20 4e6f 6e65 3a0a 2020 2020 2222 2243  > None:.    """C
-00029120: 6f6e 7665 7274 204d 5843 2055 5249 2074  onvert MXC URI t
-00029130: 6f20 4854 5450 2055 524c 2077 6869 6c65  o HTTP URL while
-00029140: 2061 6c72 6561 6479 206c 6f67 6765 6420   already logged 
-00029150: 696e 2e22 2222 0a20 2020 2066 6f72 206d  in.""".    for m
-00029160: 7863 2069 6e20 6773 2e70 612e 6d78 635f  xc in gs.pa.mxc_
-00029170: 746f 5f68 7474 703a 0a20 2020 2020 2020  to_http:.       
-00029180: 206d 7863 203d 206d 7863 2e73 7472 6970   mxc = mxc.strip
-00029190: 2829 0a20 2020 2020 2020 2068 7474 7020  ().        http 
-000291a0: 3d20 6177 6169 7420 636c 6965 6e74 2e6d  = await client.m
-000291b0: 7863 5f74 6f5f 6874 7470 286d 7863 2920  xc_to_http(mxc) 
-000291c0: 2023 2072 6574 7572 6e73 204e 6f6e 6520   # returns None 
-000291d0: 6f72 2073 7472 0a20 2020 2020 2020 2023  or str.        #
-000291e0: 206f 7574 7075 7420 666f 726d 6174 2063   output format c
-000291f0: 6f6e 7472 6f6c 6c65 6420 7669 6120 2d2d  ontrolled via --
-00029200: 6f75 7470 7574 2066 6c61 670a 2020 2020  output flag.    
-00029210: 2020 2020 7465 7874 203d 2066 227b 6d78      text = f"{mx
-00029220: 637d 7b53 4550 7d7b 6874 7470 7d22 0a20  c}{SEP}{http}". 
-00029230: 2020 2020 2020 206a 736f 6e5f 6d61 7820         json_max 
-00029240: 3d20 7b22 6d78 6322 3a20 6d78 632c 2022  = {"mxc": mxc, "
-00029250: 6874 7470 223a 2068 7474 707d 0a20 2020  http": http}.   
-00029260: 2020 2020 2023 206a 736f 6e5f 6d61 782e       # json_max.
-00029270: 7570 6461 7465 287b 226b 6579 223a 2076  update({"key": v
-00029280: 616c 7565 7d29 2020 2320 6164 6420 6469  alue})  # add di
-00029290: 6374 2069 7465 6d73 0a20 2020 2020 2020  ct items.       
-000292a0: 206a 736f 6e5f 203d 206a 736f 6e5f 6d61   json_ = json_ma
-000292b0: 782e 636f 7079 2829 0a20 2020 2020 2020  x.copy().       
-000292c0: 2023 206a 736f 6e5f 2e70 6f70 2822 6b65   # json_.pop("ke
-000292d0: 7922 290a 2020 2020 2020 2020 6a73 6f6e  y").        json
-000292e0: 5f73 7065 6320 3d20 4e6f 6e65 0a20 2020  _spec = None.   
-000292f0: 2020 2020 2070 7269 6e74 5f6f 7574 7075       print_outpu
-00029300: 7428 0a20 2020 2020 2020 2020 2020 2067  t(.            g
-00029310: 732e 7061 2e6f 7574 7075 742c 0a20 2020  s.pa.output,.   
-00029320: 2020 2020 2020 2020 2074 6578 743d 7465           text=te
-00029330: 7874 2c0a 2020 2020 2020 2020 2020 2020  xt,.            
-00029340: 6a73 6f6e 5f3d 6a73 6f6e 5f2c 0a20 2020  json_=json_,.   
-00029350: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
-00029360: 783d 6a73 6f6e 5f6d 6178 2c0a 2020 2020  x=json_max,.    
-00029370: 2020 2020 2020 2020 6a73 6f6e 5f73 7065          json_spe
-00029380: 633d 6a73 6f6e 5f73 7065 632c 0a20 2020  c=json_spec,.   
-00029390: 2020 2020 2029 0a0a 0a61 7379 6e63 2064       )...async d
-000293a0: 6566 2061 6374 696f 6e5f 6465 7669 6365  ef action_device
-000293b0: 7328 636c 6965 6e74 3a20 4173 796e 6343  s(client: AsyncC
-000293c0: 6c69 656e 742c 2063 7265 6465 6e74 6961  lient, credentia
-000293d0: 6c73 3a20 6469 6374 2920 2d3e 204e 6f6e  ls: dict) -> Non
-000293e0: 653a 0a20 2020 2022 2222 4c69 7374 2064  e:.    """List d
-000293f0: 6576 6963 6573 206f 6620 6163 636f 756e  evices of accoun
-00029400: 7420 7768 696c 6520 616c 7265 6164 7920  t while already 
-00029410: 6c6f 6767 6564 2069 6e2e 2222 220a 2020  logged in.""".  
-00029420: 2020 7265 7370 203d 2061 7761 6974 2063    resp = await c
-00029430: 6c69 656e 742e 6465 7669 6365 7328 290a  lient.devices().
-00029440: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00029450: 6528 7265 7370 2c20 4465 7669 6365 7345  e(resp, DevicesE
-00029460: 7272 6f72 293a 0a20 2020 2020 2020 2067  rror):.        g
-00029470: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
-00029480: 2020 2020 2020 2020 2022 4531 3830 3a20           "E180: 
-00029490: 2220 6622 6465 7669 6365 7320 6661 696c  " f"devices fail
-000294a0: 6564 2077 6974 6820 7b70 7269 7661 6379  ed with {privacy
-000294b0: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
-000294c0: 2929 7d22 0a20 2020 2020 2020 2029 0a20  ))}".        ). 
-000294d0: 2020 2020 2020 2067 732e 6572 725f 636f         gs.err_co
-000294e0: 756e 7420 2b3d 2031 0a20 2020 2065 6c73  unt += 1.    els
-000294f0: 653a 0a20 2020 2020 2020 2067 732e 6c6f  e:.        gs.lo
-00029500: 672e 6465 6275 6728 6622 6465 7669 6365  g.debug(f"device
-00029510: 7320 7375 6363 6573 7366 756c 2077 6974  s successful wit
-00029520: 6820 7b70 7269 7661 6379 5f66 696c 7465  h {privacy_filte
-00029530: 7228 7374 7228 7265 7370 2929 7d22 290a  r(str(resp))}").
-00029540: 2020 2020 2020 2020 2320 6f75 7470 7574          # output
-00029550: 2066 6f72 6d61 7420 636f 6e74 726f 6c6c   format controll
-00029560: 6564 2076 6961 202d 2d6f 7574 7075 7420  ed via --output 
-00029570: 666c 6167 0a20 2020 2020 2020 2074 6578  flag.        tex
-00029580: 7420 3d20 2222 0a20 2020 2020 2020 2066  t = "".        f
-00029590: 6f72 2072 7220 696e 2072 6573 702e 6465  or rr in resp.de
-000295a0: 7669 6365 733a 0a20 2020 2020 2020 2020  vices:.         
-000295b0: 2020 2074 6578 7420 2b3d 2028 0a20 2020     text += (.   
-000295c0: 2020 2020 2020 2020 2020 2020 2072 722e               rr.
-000295d0: 6964 0a20 2020 2020 2020 2020 2020 2020  id.             
-000295e0: 2020 202b 2053 4550 0a20 2020 2020 2020     + SEP.       
-000295f0: 2020 2020 2020 2020 202b 2072 722e 6469           + rr.di
-00029600: 7370 6c61 795f 6e61 6d65 0a20 2020 2020  splay_name.     
-00029610: 2020 2020 2020 2020 2020 202b 2053 4550             + SEP
-00029620: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029630: 202b 2072 722e 6c61 7374 5f73 6565 6e5f   + rr.last_seen_
-00029640: 6970 0a20 2020 2020 2020 2020 2020 2020  ip.             
-00029650: 2020 202b 2053 4550 0a20 2020 2020 2020     + SEP.       
-00029660: 2020 2020 2020 2020 202b 2073 7472 2872           + str(r
-00029670: 722e 6c61 7374 5f73 6565 6e5f 6461 7465  r.last_seen_date
-00029680: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00029690: 2020 2b20 225c 6e22 0a20 2020 2020 2020    + "\n".       
-000296a0: 2020 2020 2029 0a20 2020 2020 2020 2074       ).        t
-000296b0: 6578 7420 3d20 7465 7874 2e73 7472 6970  ext = text.strip
-000296c0: 2829 0a20 2020 2020 2020 2023 204f 626a  ().        # Obj
-000296d0: 6563 7420 6f66 2074 7970 6520 7878 7852  ect of type xxxR
-000296e0: 6573 706f 6e73 6520 6973 206e 6f74 204a  esponse is not J
-000296f0: 534f 4e0a 2020 2020 2020 2020 2320 7365  SON.        # se
-00029700: 7269 616c 697a 6162 6c65 2c20 6865 6e63  rializable, henc
-00029710: 6520 7765 2075 7365 2074 6865 2064 6963  e we use the dic
-00029720: 7469 6f6e 6172 792e 0a20 2020 2020 2020  tionary..       
-00029730: 206a 736f 6e5f 6d61 7820 3d20 7265 7370   json_max = resp
-00029740: 2e5f 5f64 6963 745f 5f0a 2020 2020 2020  .__dict__.      
-00029750: 2020 2320 6a73 6f6e 5f6d 6178 2e75 7064    # json_max.upd
-00029760: 6174 6528 7b22 6b65 7922 3a20 7661 6c75  ate({"key": valu
-00029770: 657d 2920 2023 2061 6464 2064 6963 7420  e})  # add dict 
-00029780: 6974 656d 730a 2020 2020 2020 2020 6a73  items.        js
-00029790: 6f6e 5f20 3d20 6a73 6f6e 5f6d 6178 2e63  on_ = json_max.c
-000297a0: 6f70 7928 290a 2020 2020 2020 2020 6a73  opy().        js
-000297b0: 6f6e 5f2e 706f 7028 2274 7261 6e73 706f  on_.pop("transpo
-000297c0: 7274 5f72 6573 706f 6e73 6522 290a 2020  rt_response").  
-000297d0: 2020 2020 2020 6a73 6f6e 5f73 7065 6320        json_spec 
-000297e0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2070  = None.        p
-000297f0: 7269 6e74 5f6f 7574 7075 7428 0a20 2020  rint_output(.   
-00029800: 2020 2020 2020 2020 2067 732e 7061 2e6f           gs.pa.o
-00029810: 7574 7075 742c 0a20 2020 2020 2020 2020  utput,.         
-00029820: 2020 2074 6578 743d 7465 7874 2c0a 2020     text=text,.  
-00029830: 2020 2020 2020 2020 2020 6a73 6f6e 5f3d            json_=
-00029840: 6a73 6f6e 5f2c 0a20 2020 2020 2020 2020  json_,.         
-00029850: 2020 206a 736f 6e5f 6d61 783d 6a73 6f6e     json_max=json
-00029860: 5f6d 6178 2c0a 2020 2020 2020 2020 2020  _max,.          
-00029870: 2020 6a73 6f6e 5f73 7065 633d 6a73 6f6e    json_spec=json
-00029880: 5f73 7065 632c 0a20 2020 2020 2020 2029  _spec,.        )
-00029890: 0a0a 0a61 7379 6e63 2064 6566 2061 6374  ...async def act
-000298a0: 696f 6e5f 6469 7363 6f76 6572 795f 696e  ion_discovery_in
-000298b0: 666f 280a 2020 2020 636c 6965 6e74 3a20  fo(.    client: 
-000298c0: 4173 796e 6343 6c69 656e 742c 2063 7265  AsyncClient, cre
-000298d0: 6465 6e74 6961 6c73 3a20 6469 6374 0a29  dentials: dict.)
-000298e0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2222   -> None:.    ""
-000298f0: 224c 6973 7420 6469 7363 6f76 6572 795f  "List discovery_
-00029900: 696e 666f 206f 6620 686f 6d65 2073 6572  info of home ser
-00029910: 7665 7220 7768 696c 6520 616c 7265 6164  ver while alread
-00029920: 7920 6c6f 6767 6564 2069 6e2e 2222 220a  y logged in.""".
-00029930: 2020 2020 7265 7370 203d 2061 7761 6974      resp = await
-00029940: 2063 6c69 656e 742e 6469 7363 6f76 6572   client.discover
-00029950: 795f 696e 666f 2829 0a20 2020 2069 6620  y_info().    if 
-00029960: 6973 696e 7374 616e 6365 2872 6573 702c  isinstance(resp,
-00029970: 2044 6973 636f 7665 7279 496e 666f 4572   DiscoveryInfoEr
-00029980: 726f 7229 3a0a 2020 2020 2020 2020 6773  ror):.        gs
-00029990: 2e6c 6f67 2e65 7272 6f72 280a 2020 2020  .log.error(.    
-000299a0: 2020 2020 2020 2020 2245 3138 313a 2022          "E181: "
-000299b0: 2066 2264 6973 636f 7665 7279 5f69 6e66   f"discovery_inf
-000299c0: 6f20 6661 696c 6564 2077 6974 6820 7b70  o failed with {p
-000299d0: 7269 7661 6379 5f66 696c 7465 7228 7374  rivacy_filter(st
-000299e0: 7228 7265 7370 2929 7d22 0a20 2020 2020  r(resp))}".     
-000299f0: 2020 2029 0a20 2020 2020 2020 2067 732e     ).        gs.
-00029a00: 6572 725f 636f 756e 7420 2b3d 2031 0a20  err_count += 1. 
-00029a10: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00029a20: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
-00029a30: 2020 2020 2020 2020 2020 2066 2264 6973             f"dis
-00029a40: 636f 7665 7279 5f69 6e66 6f20 7375 6363  covery_info succ
-00029a50: 6573 7366 756c 2077 6974 6820 7b70 7269  essful with {pri
-00029a60: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
-00029a70: 7265 7370 2929 7d22 0a20 2020 2020 2020  resp))}".       
-00029a80: 2029 0a20 2020 2020 2020 2023 206f 7574   ).        # out
-00029a90: 7075 7420 666f 726d 6174 2063 6f6e 7472  put format contr
-00029aa0: 6f6c 6c65 6420 7669 6120 2d2d 6f75 7470  olled via --outp
-00029ab0: 7574 2066 6c61 670a 2020 2020 2020 2020  ut flag.        
-00029ac0: 7465 7874 203d 2066 227b 7265 7370 2e68  text = f"{resp.h
-00029ad0: 6f6d 6573 6572 7665 725f 7572 6c7d 7b53  omeserver_url}{S
-00029ae0: 4550 7d7b 7265 7370 2e69 6465 6e74 6974  EP}{resp.identit
-00029af0: 795f 7365 7276 6572 5f75 726c 7d22 0a20  y_server_url}". 
-00029b00: 2020 2020 2020 2023 204f 626a 6563 7420         # Object 
-00029b10: 6f66 2074 7970 6520 7878 7852 6573 706f  of type xxxRespo
-00029b20: 6e73 6520 6973 206e 6f74 204a 534f 4e0a  nse is not JSON.
-00029b30: 2020 2020 2020 2020 2320 7365 7269 616c          # serial
-00029b40: 697a 6162 6c65 2c20 6865 6e63 6520 7765  izable, hence we
-00029b50: 2075 7365 2074 6865 2064 6963 7469 6f6e   use the diction
-00029b60: 6172 792e 0a20 2020 2020 2020 206a 736f  ary..        jso
-00029b70: 6e5f 6d61 7820 3d20 7265 7370 2e5f 5f64  n_max = resp.__d
-00029b80: 6963 745f 5f0a 2020 2020 2020 2020 2320  ict__.        # 
-00029b90: 6a73 6f6e 5f6d 6178 2e75 7064 6174 6528  json_max.update(
-00029ba0: 7b22 6b65 7922 3a20 7661 6c75 657d 2920  {"key": value}) 
-00029bb0: 2023 2061 6464 2064 6963 7420 6974 656d   # add dict item
-00029bc0: 730a 2020 2020 2020 2020 6a73 6f6e 5f20  s.        json_ 
-00029bd0: 3d20 6a73 6f6e 5f6d 6178 2e63 6f70 7928  = json_max.copy(
-00029be0: 290a 2020 2020 2020 2020 6a73 6f6e 5f2e  ).        json_.
-00029bf0: 706f 7028 2274 7261 6e73 706f 7274 5f72  pop("transport_r
-00029c00: 6573 706f 6e73 6522 290a 2020 2020 2020  esponse").      
-00029c10: 2020 6a73 6f6e 5f73 7065 6320 3d20 4e6f    json_spec = No
-00029c20: 6e65 0a20 2020 2020 2020 2070 7269 6e74  ne.        print
-00029c30: 5f6f 7574 7075 7428 0a20 2020 2020 2020  _output(.       
-00029c40: 2020 2020 2067 732e 7061 2e6f 7574 7075       gs.pa.outpu
-00029c50: 742c 0a20 2020 2020 2020 2020 2020 2074  t,.            t
-00029c60: 6578 743d 7465 7874 2c0a 2020 2020 2020  ext=text,.      
-00029c70: 2020 2020 2020 6a73 6f6e 5f3d 6a73 6f6e        json_=json
-00029c80: 5f2c 0a20 2020 2020 2020 2020 2020 206a  _,.            j
-00029c90: 736f 6e5f 6d61 783d 6a73 6f6e 5f6d 6178  son_max=json_max
-00029ca0: 2c0a 2020 2020 2020 2020 2020 2020 6a73  ,.            js
-00029cb0: 6f6e 5f73 7065 633d 6a73 6f6e 5f73 7065  on_spec=json_spe
-00029cc0: 632c 0a20 2020 2020 2020 2029 0a0a 0a61  c,.        )...a
-00029cd0: 7379 6e63 2064 6566 2061 6374 696f 6e5f  sync def action_
-00029ce0: 6c6f 6769 6e5f 696e 666f 2863 6c69 656e  login_info(clien
-00029cf0: 743a 2041 7379 6e63 436c 6965 6e74 2c20  t: AsyncClient, 
-00029d00: 6372 6564 656e 7469 616c 733a 2064 6963  credentials: dic
-00029d10: 7429 202d 3e20 4e6f 6e65 3a0a 2020 2020  t) -> None:.    
-00029d20: 2222 224c 6973 7420 6c6f 6769 6e20 6d65  """List login me
-00029d30: 7468 6f64 7320 6f66 2068 6f6d 6520 7365  thods of home se
-00029d40: 7276 6572 2077 6869 6c65 2061 6c72 6561  rver while alrea
-00029d50: 6479 206c 6f67 6765 6420 696e 2e22 2222  dy logged in."""
-00029d60: 0a20 2020 2072 6573 7020 3d20 6177 6169  .    resp = awai
-00029d70: 7420 636c 6965 6e74 2e6c 6f67 696e 5f69  t client.login_i
-00029d80: 6e66 6f28 290a 2020 2020 6966 2069 7369  nfo().    if isi
-00029d90: 6e73 7461 6e63 6528 7265 7370 2c20 4c6f  nstance(resp, Lo
-00029da0: 6769 6e49 6e66 6f45 7272 6f72 293a 0a20  ginInfoError):. 
-00029db0: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
-00029dc0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-00029dd0: 2022 4531 3832 3a20 2220 6622 6c6f 6769   "E182: " f"logi
-00029de0: 6e5f 696e 666f 2066 6169 6c65 6420 7769  n_info failed wi
-00029df0: 7468 207b 7072 6976 6163 795f 6669 6c74  th {privacy_filt
-00029e00: 6572 2873 7472 2872 6573 7029 297d 220a  er(str(resp))}".
-00029e10: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00029e20: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
-00029e30: 3d20 310a 2020 2020 656c 7365 3a0a 2020  = 1.    else:.  
-00029e40: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-00029e50: 7567 2866 226c 6f67 696e 5f69 6e66 6f20  ug(f"login_info 
-00029e60: 7375 6363 6573 7366 756c 2077 6974 6820  successful with 
-00029e70: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
-00029e80: 7374 7228 7265 7370 2929 7d22 290a 2020  str(resp))}").  
-00029e90: 2020 2020 2020 2320 6f75 7470 7574 2066        # output f
-00029ea0: 6f72 6d61 7420 636f 6e74 726f 6c6c 6564  ormat controlled
-00029eb0: 2076 6961 202d 2d6f 7574 7075 7420 666c   via --output fl
-00029ec0: 6167 0a20 2020 2020 2020 2074 6578 7420  ag.        text 
-00029ed0: 3d20 2222 0a20 2020 2020 2020 2066 6f72  = "".        for
-00029ee0: 2072 7220 696e 2072 6573 702e 666c 6f77   rr in resp.flow
-00029ef0: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
-00029f00: 6578 7420 2b3d 2073 7472 2872 7229 202b  ext += str(rr) +
-00029f10: 2022 5c6e 220a 2020 2020 2020 2020 7465   "\n".        te
-00029f20: 7874 203d 2074 6578 742e 7374 7269 7028  xt = text.strip(
-00029f30: 290a 2020 2020 2020 2020 2320 4f62 6a65  ).        # Obje
-00029f40: 6374 206f 6620 7479 7065 2078 7878 5265  ct of type xxxRe
-00029f50: 7370 6f6e 7365 2069 7320 6e6f 7420 4a53  sponse is not JS
-00029f60: 4f4e 0a20 2020 2020 2020 2023 2073 6572  ON.        # ser
-00029f70: 6961 6c69 7a61 626c 652c 2068 656e 6365  ializable, hence
-00029f80: 2077 6520 7573 6520 7468 6520 6469 6374   we use the dict
-00029f90: 696f 6e61 7279 2e0a 2020 2020 2020 2020  ionary..        
-00029fa0: 6a73 6f6e 5f6d 6178 203d 2072 6573 702e  json_max = resp.
-00029fb0: 5f5f 6469 6374 5f5f 0a20 2020 2020 2020  __dict__.       
-00029fc0: 2023 206a 736f 6e5f 6d61 782e 7570 6461   # json_max.upda
-00029fd0: 7465 287b 226b 6579 223a 2076 616c 7565  te({"key": value
-00029fe0: 7d29 2020 2320 6164 6420 6469 6374 2069  })  # add dict i
-00029ff0: 7465 6d73 0a20 2020 2020 2020 206a 736f  tems.        jso
-0002a000: 6e5f 203d 206a 736f 6e5f 6d61 782e 636f  n_ = json_max.co
-0002a010: 7079 2829 0a20 2020 2020 2020 206a 736f  py().        jso
-0002a020: 6e5f 2e70 6f70 2822 7472 616e 7370 6f72  n_.pop("transpor
-0002a030: 745f 7265 7370 6f6e 7365 2229 0a20 2020  t_response").   
-0002a040: 2020 2020 206a 736f 6e5f 7370 6563 203d       json_spec =
-0002a050: 204e 6f6e 650a 2020 2020 2020 2020 7072   None.        pr
-0002a060: 696e 745f 6f75 7470 7574 280a 2020 2020  int_output(.    
-0002a070: 2020 2020 2020 2020 6773 2e70 612e 6f75          gs.pa.ou
-0002a080: 7470 7574 2c0a 2020 2020 2020 2020 2020  tput,.          
-0002a090: 2020 7465 7874 3d74 6578 742c 0a20 2020    text=text,.   
-0002a0a0: 2020 2020 2020 2020 206a 736f 6e5f 3d6a           json_=j
-0002a0b0: 736f 6e5f 2c0a 2020 2020 2020 2020 2020  son_,.          
-0002a0c0: 2020 6a73 6f6e 5f6d 6178 3d6a 736f 6e5f    json_max=json_
-0002a0d0: 6d61 782c 0a20 2020 2020 2020 2020 2020  max,.           
-0002a0e0: 206a 736f 6e5f 7370 6563 3d6a 736f 6e5f   json_spec=json_
-0002a0f0: 7370 6563 2c0a 2020 2020 2020 2020 290a  spec,.        ).
-0002a100: 0a0a 6173 796e 6320 6465 6620 6163 7469  ..async def acti
-0002a110: 6f6e 5f63 6f6e 7465 6e74 5f72 6570 6f73  on_content_repos
-0002a120: 6974 6f72 795f 636f 6e66 6967 280a 2020  itory_config(.  
-0002a130: 2020 636c 6965 6e74 3a20 4173 796e 6343    client: AsyncC
-0002a140: 6c69 656e 742c 2063 7265 6465 6e74 6961  lient, credentia
-0002a150: 6c73 3a20 6469 6374 0a29 202d 3e20 4e6f  ls: dict.) -> No
-0002a160: 6e65 3a0a 2020 2020 2222 224c 6973 7420  ne:.    """List 
-0002a170: 636f 6e66 6967 206f 6620 636f 6e74 656e  config of conten
-0002a180: 7420 7265 706f 206f 6620 686f 6d65 2073  t repo of home s
-0002a190: 6572 7665 7220 7768 696c 6520 616c 7265  erver while alre
-0002a1a0: 6164 7920 6c6f 6767 6564 2069 6e2e 2222  ady logged in.""
-0002a1b0: 220a 2020 2020 7265 7370 203d 2061 7761  ".    resp = awa
-0002a1c0: 6974 2063 6c69 656e 742e 636f 6e74 656e  it client.conten
-0002a1d0: 745f 7265 706f 7369 746f 7279 5f63 6f6e  t_repository_con
-0002a1e0: 6669 6728 290a 2020 2020 6966 2069 7369  fig().    if isi
-0002a1f0: 6e73 7461 6e63 6528 7265 7370 2c20 436f  nstance(resp, Co
-0002a200: 6e74 656e 7452 6570 6f73 6974 6f72 7943  ntentRepositoryC
-0002a210: 6f6e 6669 6745 7272 6f72 293a 0a20 2020  onfigError):.   
-0002a220: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
-0002a230: 7228 0a20 2020 2020 2020 2020 2020 2022  r(.            "
-0002a240: 4531 3833 3a20 220a 2020 2020 2020 2020  E183: ".        
-0002a250: 2020 2020 2263 6f6e 7465 6e74 5f72 6570      "content_rep
-0002a260: 6f73 6974 6f72 795f 636f 6e66 6967 2066  ository_config f
-0002a270: 6169 6c65 6420 7769 7468 2022 0a20 2020  ailed with ".   
-0002a280: 2020 2020 2020 2020 2066 227b 7072 6976           f"{priv
-0002a290: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
-0002a2a0: 6573 7029 297d 220a 2020 2020 2020 2020  esp))}".        
-0002a2b0: 290a 2020 2020 2020 2020 6773 2e65 7272  ).        gs.err
-0002a2c0: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
-0002a2d0: 656c 7365 3a0a 2020 2020 2020 2020 6773  else:.        gs
-0002a2e0: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
-0002a2f0: 2020 2020 2020 2020 2263 6f6e 7465 6e74          "content
-0002a300: 5f72 6570 6f73 6974 6f72 795f 636f 6e66  _repository_conf
-0002a310: 6967 2073 7563 6365 7373 6675 6c20 7769  ig successful wi
-0002a320: 7468 2022 0a20 2020 2020 2020 2020 2020  th ".           
-0002a330: 2066 227b 7072 6976 6163 795f 6669 6c74   f"{privacy_filt
-0002a340: 6572 2873 7472 2872 6573 7029 297d 220a  er(str(resp))}".
-0002a350: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0002a360: 2020 2320 6f75 7470 7574 2066 6f72 6d61    # output forma
-0002a370: 7420 636f 6e74 726f 6c6c 6564 2076 6961  t controlled via
-0002a380: 202d 2d6f 7574 7075 7420 666c 6167 0a20   --output flag. 
-0002a390: 2020 2020 2020 2074 6578 7420 3d20 7265         text = re
-0002a3a0: 7370 2e75 706c 6f61 645f 7369 7a65 2020  sp.upload_size  
-0002a3b0: 2320 7265 7475 726e 7320 6f6e 6c79 2031  # returns only 1
-0002a3c0: 2076 616c 7565 0a20 2020 2020 2020 2023   value.        #
-0002a3d0: 204f 626a 6563 7420 6f66 2074 7970 6520   Object of type 
-0002a3e0: 7878 7852 6573 706f 6e73 6520 6973 206e  xxxResponse is n
-0002a3f0: 6f74 204a 534f 4e0a 2020 2020 2020 2020  ot JSON.        
-0002a400: 2320 7365 7269 616c 697a 6162 6c65 2c20  # serializable, 
-0002a410: 6865 6e63 6520 7765 2075 7365 2074 6865  hence we use the
-0002a420: 2064 6963 7469 6f6e 6172 792e 0a20 2020   dictionary..   
-0002a430: 2020 2020 206a 736f 6e5f 6d61 7820 3d20       json_max = 
-0002a440: 7265 7370 2e5f 5f64 6963 745f 5f0a 2020  resp.__dict__.  
-0002a450: 2020 2020 2020 2320 6a73 6f6e 5f6d 6178        # json_max
-0002a460: 2e75 7064 6174 6528 7b22 6b65 7922 3a20  .update({"key": 
-0002a470: 7661 6c75 657d 2920 2023 2061 6464 2064  value})  # add d
-0002a480: 6963 7420 6974 656d 730a 2020 2020 2020  ict items.      
-0002a490: 2020 6a73 6f6e 5f20 3d20 6a73 6f6e 5f6d    json_ = json_m
-0002a4a0: 6178 2e63 6f70 7928 290a 2020 2020 2020  ax.copy().      
-0002a4b0: 2020 6a73 6f6e 5f2e 706f 7028 2274 7261    json_.pop("tra
-0002a4c0: 6e73 706f 7274 5f72 6573 706f 6e73 6522  nsport_response"
-0002a4d0: 290a 2020 2020 2020 2020 6a73 6f6e 5f73  ).        json_s
-0002a4e0: 7065 6320 3d20 4e6f 6e65 0a20 2020 2020  pec = None.     
-0002a4f0: 2020 2070 7269 6e74 5f6f 7574 7075 7428     print_output(
-0002a500: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
-0002a510: 7061 2e6f 7574 7075 742c 0a20 2020 2020  pa.output,.     
-0002a520: 2020 2020 2020 2074 6578 743d 7465 7874         text=text
-0002a530: 2c0a 2020 2020 2020 2020 2020 2020 6a73  ,.            js
-0002a540: 6f6e 5f3d 6a73 6f6e 5f2c 0a20 2020 2020  on_=json_,.     
-0002a550: 2020 2020 2020 206a 736f 6e5f 6d61 783d         json_max=
-0002a560: 6a73 6f6e 5f6d 6178 2c0a 2020 2020 2020  json_max,.      
-0002a570: 2020 2020 2020 6a73 6f6e 5f73 7065 633d        json_spec=
-0002a580: 6a73 6f6e 5f73 7065 632c 0a20 2020 2020  json_spec,.     
-0002a590: 2020 2029 0a0a 0a61 7379 6e63 2064 6566     )...async def
-0002a5a0: 2061 6374 696f 6e5f 7265 7374 2863 6c69   action_rest(cli
-0002a5b0: 656e 743a 2041 7379 6e63 436c 6965 6e74  ent: AsyncClient
-0002a5c0: 2c20 6372 6564 656e 7469 616c 733a 2064  , credentials: d
-0002a5d0: 6963 7429 202d 3e20 4e6f 6e65 3a0a 2020  ict) -> None:.  
-0002a5e0: 2020 2222 2249 6e76 6f6b 6520 5245 5354    """Invoke REST
-0002a5f0: 2041 5049 206f 6e20 4d61 7472 6978 2073   API on Matrix s
-0002a600: 6572 7665 722e 0a20 2020 2041 7373 756d  erver..    Assum
-0002a610: 6573 2074 6861 7420 7573 6572 2069 7320  es that user is 
-0002a620: 616c 7265 6164 7920 6c6f 6767 6564 2069  already logged i
-0002a630: 6e2e 0a20 2020 2022 2222 0a20 2020 2023  n..    """.    #
-0002a640: 2073 6565 3a20 6874 7470 733a 2f2f 646f   see: https://do
-0002a650: 6373 2e61 696f 6874 7470 2e6f 7267 2f65  cs.aiohttp.org/e
-0002a660: 6e2f 7374 6162 6c65 2f63 6c69 656e 745f  n/stable/client_
-0002a670: 7175 6963 6b73 7461 7274 2e68 746d 6c0a  quickstart.html.
-0002a680: 2020 2020 2320 7765 206d 7573 7420 656d      # we must em
-0002a690: 756c 6174 6520 6120 6375 726c 206c 696b  ulate a curl lik
-0002a6a0: 6520 7468 6973 3a0a 2020 2020 2320 6375  e this:.    # cu
-0002a6b0: 726c 202d 5844 454c 4554 4520 2022 6874  rl -XDELETE  "ht
-0002a6c0: 7470 733a 2f2f 5345 5256 4552 4845 5245  tps://SERVERHERE
-0002a6d0: 2f5f 7379 6e61 7073 652f 6164 6d69 6e2f  /_synapse/admin/
-0002a6e0: 7631 2f6d 6564 6961 2f53 4552 5645 5248  v1/media/SERVERH
-0002a6f0: 4552 452f 0a20 2020 2023 2020 2020 2020  ERE/.    #      
-0002a700: 4d58 4349 4448 4552 453f 6163 6365 7373  MXCIDHERE?access
-0002a710: 5f74 6f6b 656e 3d41 4343 4553 535f 544f  _token=ACCESS_TO
-0002a720: 4b45 4e5f 4845 5245 220a 2020 2020 2320  KEN_HERE".    # 
-0002a730: 6375 726c 202d 5850 4f53 5420 2d64 2027  curl -XPOST -d '
-0002a740: 7b22 6d73 6774 7970 6522 3a22 6d2e 7465  {"msgtype":"m.te
-0002a750: 7874 222c 2022 626f 6479 223a 2268 656c  xt", "body":"hel
-0002a760: 6c6f 227d 2720 5c0a 2020 2020 2320 2020  lo"}' \.    #   
-0002a770: 225f 5f68 6f6d 6573 6572 7665 725f 5f2f  "__homeserver__/
-0002a780: 5f6d 6174 7269 782f 636c 6965 6e74 2f72  _matrix/client/r
-0002a790: 302f 726f 6f6d 732f 5f5f 656e 636f 6465  0/rooms/__encode
-0002a7a0: 645f 6675 6c6c 5f72 6f6f 6d5f 6964 5f5f  d_full_room_id__
-0002a7b0: 2f5c 0a20 2020 2023 2020 2073 656e 642f  /\.    #   send/
-0002a7c0: 6d2e 726f 6f6d 2e6d 6573 7361 6765 3f61  m.room.message?a
-0002a7d0: 6363 6573 735f 746f 6b65 6e3d 594f 5552  ccess_token=YOUR
-0002a7e0: 544f 4b45 4e48 4552 4522 0a20 2020 2023  TOKENHERE".    #
-0002a7f0: 2063 7572 6c20 2d58 4745 5420 2d64 2022   curl -XGET -d "
-0002a800: 2220 275f 5f68 6f6d 6573 6572 7665 725f  " '__homeserver_
-0002a810: 5f2f 5f6d 6174 7269 782f 636c 6965 6e74  _/_matrix/client
-0002a820: 2f76 6572 7369 6f6e 7327 0a20 2020 2069  /versions'.    i
-0002a830: 6620 6e6f 7420 6c65 6e28 6773 2e70 612e  f not len(gs.pa.
-0002a840: 7265 7374 2920 2520 3320 3d3d 2030 3a0a  rest) % 3 == 0:.
-0002a850: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
-0002a860: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-0002a870: 2020 2245 3138 343a 2022 0a20 2020 2020    "E184: ".     
-0002a880: 2020 2020 2020 2022 496e 636f 7272 6563         "Incorrec
-0002a890: 7420 6e75 6d62 6572 206f 6620 6172 6775  t number of argu
-0002a8a0: 6d65 6e74 7320 666f 7220 2d2d 7265 7374  ments for --rest
-0002a8b0: 2e20 4172 6775 6d65 6e74 7320 6d75 7374  . Arguments must
-0002a8c0: 2062 6520 220a 2020 2020 2020 2020 2020   be ".          
-0002a8d0: 2020 6622 7472 6970 6c65 732c 2069 2e65    f"triples, i.e
-0002a8e0: 2e20 6d75 6c74 6970 6c65 7320 6f66 2033  . multiples of 3
-0002a8f0: 2c20 6275 7420 666f 756e 6420 7b6c 656e  , but found {len
-0002a900: 2867 732e 7061 2e72 6573 7429 7d20 220a  (gs.pa.rest)} ".
-0002a910: 2020 2020 2020 2020 2020 2020 2261 7267              "arg
-0002a920: 756d 656e 7473 2e22 0a20 2020 2020 2020  uments.".       
-0002a930: 2029 0a20 2020 2020 2020 2067 732e 6572   ).        gs.er
-0002a940: 725f 636f 756e 7420 2b3d 2031 0a20 2020  r_count += 1.   
-0002a950: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
-0002a960: 666f 7220 6969 2069 6e20 7261 6e67 6528  for ii in range(
-0002a970: 6c65 6e28 6773 2e70 612e 7265 7374 2920  len(gs.pa.rest) 
-0002a980: 2f2f 2033 293a 0a20 2020 2020 2020 206d  // 3):.        m
-0002a990: 6574 686f 6420 3d20 6773 2e70 612e 7265  ethod = gs.pa.re
-0002a9a0: 7374 5b69 6920 2a20 3320 2b20 305d 0a20  st[ii * 3 + 0]. 
-0002a9b0: 2020 2020 2020 2064 6174 6120 3d20 6773         data = gs
-0002a9c0: 2e70 612e 7265 7374 5b69 6920 2a20 3320  .pa.rest[ii * 3 
-0002a9d0: 2b20 315d 0a20 2020 2020 2020 2075 726c  + 1].        url
-0002a9e0: 203d 2067 732e 7061 2e72 6573 745b 6969   = gs.pa.rest[ii
-0002a9f0: 202a 2033 202b 2032 5d0a 2020 2020 2020   * 3 + 2].      
-0002aa00: 2020 6966 206e 6f74 206d 6574 686f 6420    if not method 
-0002aa10: 6f72 206d 6574 686f 642e 7570 7065 7228  or method.upper(
-0002aa20: 292e 7374 7269 7028 2920 6e6f 7420 696e  ).strip() not in
-0002aa30: 205b 0a20 2020 2020 2020 2020 2020 2022   [.            "
-0002aa40: 4745 5422 2c0a 2020 2020 2020 2020 2020  GET",.          
-0002aa50: 2020 2250 4f53 5422 2c0a 2020 2020 2020    "POST",.      
-0002aa60: 2020 2020 2020 2250 5554 222c 0a20 2020        "PUT",.   
-0002aa70: 2020 2020 2020 2020 2022 4445 4c45 5445           "DELETE
-0002aa80: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
-0002aa90: 4f50 5449 4f4e 5322 2c0a 2020 2020 2020  OPTIONS",.      
-0002aaa0: 2020 5d3a 0a20 2020 2020 2020 2020 2020    ]:.           
-0002aab0: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
-0002aac0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0002aad0: 4531 3835 3a20 220a 2020 2020 2020 2020  E185: ".        
-0002aae0: 2020 2020 2020 2020 6622 496e 636f 7272          f"Incorr
-0002aaf0: 6563 7420 5245 5354 206d 6574 686f 6420  ect REST method 
-0002ab00: 7b6d 6574 686f 647d 2e20 220a 2020 2020  {method}. ".    
-0002ab10: 2020 2020 2020 2020 2020 2020 274d 7573              'Mus
-0002ab20: 7420 6265 206f 6e65 206f 663a 2022 4745  t be one of: "GE
-0002ab30: 5422 2c20 2250 4f53 5422 2c20 2250 5554  T", "POST", "PUT
-0002ab40: 222c 2022 4445 4c45 5445 222c 2022 4f50  ", "DELETE", "OP
-0002ab50: 5449 4f4e 5322 2e27 0a20 2020 2020 2020  TIONS".'.       
-0002ab60: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0002ab70: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
-0002ab80: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
-0002ab90: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
-0002aba0: 2020 6d65 7468 6f64 203d 206d 6574 686f    method = metho
-0002abb0: 642e 7570 7065 7228 292e 7374 7269 7028  d.upper().strip(
-0002abc0: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-0002abd0: 2064 6174 613a 0a20 2020 2020 2020 2020   data:.         
-0002abe0: 2020 2064 6174 6120 3d20 2222 0a20 2020     data = "".   
-0002abf0: 2020 2020 2069 6620 6e6f 7420 7572 6c20       if not url 
-0002ac00: 6f72 2075 726c 2e73 7472 6970 2829 203d  or url.strip() =
-0002ac10: 3d20 2222 3a0a 2020 2020 2020 2020 2020  = "":.          
-0002ac20: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
-0002ac30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ac40: 2245 3138 363a 2022 2066 2249 6e63 6f72  "E186: " f"Incor
-0002ac50: 7265 6374 2052 4553 5420 5552 4c20 7b75  rect REST URL {u
-0002ac60: 726c 7d2e 204d 7573 7420 6e6f 7420 6265  rl}. Must not be
-0002ac70: 2065 6d70 7479 2e22 0a20 2020 2020 2020   empty.".       
-0002ac80: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0002ac90: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
-0002aca0: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
-0002acb0: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
-0002acc0: 2020 6966 2067 732e 7061 2e61 6363 6573    if gs.pa.acces
-0002acd0: 735f 746f 6b65 6e3a 0a20 2020 2020 2020  s_token:.       
-0002ace0: 2020 2020 2061 7420 3d20 6773 2e70 612e       at = gs.pa.
-0002acf0: 6163 6365 7373 5f74 6f6b 656e 0a20 2020  access_token.   
-0002ad00: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
-0002ad10: 6465 6275 6728 2255 7369 6e67 2061 6363  debug("Using acc
-0002ad20: 6573 7320 746f 6b65 6e20 6672 6f6d 202d  ess token from -
-0002ad30: 2d61 6363 6573 732d 746f 6b65 6e20 6172  -access-token ar
-0002ad40: 6775 6d65 6e74 2e22 290a 2020 2020 2020  gument.").      
-0002ad50: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0002ad60: 2020 2020 6174 203d 2063 7265 6465 6e74      at = credent
-0002ad70: 6961 6c73 5b22 6163 6365 7373 5f74 6f6b  ials["access_tok
-0002ad80: 656e 225d 0a20 2020 2020 2020 2020 2020  en"].           
-0002ad90: 2067 732e 6c6f 672e 6465 6275 6728 2255   gs.log.debug("U
-0002ada0: 7369 6e67 2061 6363 6573 7320 746f 6b65  sing access toke
-0002adb0: 6e20 6672 6f6d 2063 7265 6465 6e74 6961  n from credentia
-0002adc0: 6c73 2066 696c 652e 2229 0a20 2020 2020  ls file.").     
-0002add0: 2020 2066 6f72 2070 6820 696e 205b 0a20     for ph in [. 
-0002ade0: 2020 2020 2020 2020 2020 2048 4f4d 4553             HOMES
-0002adf0: 4552 5645 525f 504c 4143 4548 4f4c 4445  ERVER_PLACEHOLDE
-0002ae00: 522c 0a20 2020 2020 2020 2020 2020 2048  R,.            H
-0002ae10: 4f53 544e 414d 455f 504c 4143 4548 4f4c  OSTNAME_PLACEHOL
-0002ae20: 4445 522c 0a20 2020 2020 2020 2020 2020  DER,.           
-0002ae30: 2041 4343 4553 535f 544f 4b45 4e5f 504c   ACCESS_TOKEN_PL
-0002ae40: 4143 4548 4f4c 4445 522c 0a20 2020 2020  ACEHOLDER,.     
-0002ae50: 2020 2020 2020 2055 5345 525f 4944 5f50         USER_ID_P
-0002ae60: 4c41 4345 484f 4c44 4552 2c0a 2020 2020  LACEHOLDER,.    
-0002ae70: 2020 2020 2020 2020 4445 5649 4345 5f49          DEVICE_I
-0002ae80: 445f 504c 4143 4548 4f4c 4445 522c 0a20  D_PLACEHOLDER,. 
-0002ae90: 2020 2020 2020 2020 2020 2052 4f4f 4d5f             ROOM_
-0002aea0: 4944 5f50 4c41 4345 484f 4c44 4552 2c0a  ID_PLACEHOLDER,.
-0002aeb0: 2020 2020 2020 2020 5d3a 0a20 2020 2020          ]:.     
-0002aec0: 2020 2020 2020 2069 6620 7068 203d 3d20         if ph == 
-0002aed0: 484f 4d45 5345 5256 4552 5f50 4c41 4345  HOMESERVER_PLACE
-0002aee0: 484f 4c44 4552 3a0a 2020 2020 2020 2020  HOLDER:.        
-0002aef0: 2020 2020 2020 2020 6461 7461 203d 2064          data = d
-0002af00: 6174 612e 7265 706c 6163 6528 7068 2c20  ata.replace(ph, 
-0002af10: 6372 6564 656e 7469 616c 735b 2268 6f6d  credentials["hom
-0002af20: 6573 6572 7665 7222 5d29 0a20 2020 2020  eserver"]).     
-0002af30: 2020 2020 2020 2020 2020 2075 726c 203d             url =
-0002af40: 2075 726c 2e72 6570 6c61 6365 2870 682c   url.replace(ph,
-0002af50: 2063 7265 6465 6e74 6961 6c73 5b22 686f   credentials["ho
-0002af60: 6d65 7365 7276 6572 225d 290a 2020 2020  meserver"]).    
-0002af70: 2020 2020 2020 2020 656c 6966 2070 6820          elif ph 
-0002af80: 3d3d 2048 4f53 544e 414d 455f 504c 4143  == HOSTNAME_PLAC
-0002af90: 4548 4f4c 4445 523a 0a20 2020 2020 2020  EHOLDER:.       
-0002afa0: 2020 2020 2020 2020 2068 6f73 746e 616d           hostnam
-0002afb0: 6520 3d20 7572 6c70 6172 7365 2863 7265  e = urlparse(cre
-0002afc0: 6465 6e74 6961 6c73 5b22 686f 6d65 7365  dentials["homese
-0002afd0: 7276 6572 225d 292e 686f 7374 6e61 6d65  rver"]).hostname
-0002afe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002aff0: 2064 6174 6120 3d20 6461 7461 2e72 6570   data = data.rep
-0002b000: 6c61 6365 2870 682c 2068 6f73 746e 616d  lace(ph, hostnam
-0002b010: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-0002b020: 2020 2075 726c 203d 2075 726c 2e72 6570     url = url.rep
-0002b030: 6c61 6365 2870 682c 2068 6f73 746e 616d  lace(ph, hostnam
-0002b040: 6529 0a20 2020 2020 2020 2020 2020 2065  e).            e
-0002b050: 6c69 6620 7068 203d 3d20 4143 4345 5353  lif ph == ACCESS
-0002b060: 5f54 4f4b 454e 5f50 4c41 4345 484f 4c44  _TOKEN_PLACEHOLD
-0002b070: 4552 3a0a 2020 2020 2020 2020 2020 2020  ER:.            
-0002b080: 2020 2020 6461 7461 203d 2064 6174 612e      data = data.
-0002b090: 7265 706c 6163 6528 7068 2c20 6174 290a  replace(ph, at).
-0002b0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b0b0: 7572 6c20 3d20 7572 6c2e 7265 706c 6163  url = url.replac
-0002b0c0: 6528 7068 2c20 6174 290a 2020 2020 2020  e(ph, at).      
-0002b0d0: 2020 2020 2020 656c 6966 2070 6820 3d3d        elif ph ==
-0002b0e0: 2055 5345 525f 4944 5f50 4c41 4345 484f   USER_ID_PLACEHO
-0002b0f0: 4c44 4552 3a0a 2020 2020 2020 2020 2020  LDER:.          
-0002b100: 2020 2020 2020 6461 7461 203d 2064 6174        data = dat
-0002b110: 612e 7265 706c 6163 6528 7068 2c20 6372  a.replace(ph, cr
-0002b120: 6564 656e 7469 616c 735b 2275 7365 725f  edentials["user_
-0002b130: 6964 225d 290a 2020 2020 2020 2020 2020  id"]).          
-0002b140: 2020 2020 2020 7572 6c20 3d20 7572 6c2e        url = url.
-0002b150: 7265 706c 6163 6528 7068 2c20 6372 6564  replace(ph, cred
-0002b160: 656e 7469 616c 735b 2275 7365 725f 6964  entials["user_id
-0002b170: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
-0002b180: 656c 6966 2070 6820 3d3d 2044 4556 4943  elif ph == DEVIC
-0002b190: 455f 4944 5f50 4c41 4345 484f 4c44 4552  E_ID_PLACEHOLDER
-0002b1a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002b1b0: 2020 6461 7461 203d 2064 6174 612e 7265    data = data.re
-0002b1c0: 706c 6163 6528 7068 2c20 6372 6564 656e  place(ph, creden
-0002b1d0: 7469 616c 735b 2264 6576 6963 655f 6964  tials["device_id
-0002b1e0: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
-0002b1f0: 2020 2020 7572 6c20 3d20 7572 6c2e 7265      url = url.re
-0002b200: 706c 6163 6528 7068 2c20 6372 6564 656e  place(ph, creden
-0002b210: 7469 616c 735b 2264 6576 6963 655f 6964  tials["device_id
-0002b220: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
-0002b230: 656c 6966 2070 6820 3d3d 2052 4f4f 4d5f  elif ph == ROOM_
-0002b240: 4944 5f50 4c41 4345 484f 4c44 4552 3a0a  ID_PLACEHOLDER:.
-0002b250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b260: 726f 6f6d 5f69 6420 3d20 6372 6564 656e  room_id = creden
-0002b270: 7469 616c 735b 2272 6f6f 6d5f 6964 225d  tials["room_id"]
-0002b280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b290: 2072 6f6f 6d5f 6964 203d 2061 7761 6974   room_id = await
-0002b2a0: 206d 6170 5f72 6f6f 6d69 6e66 6f5f 746f   map_roominfo_to
-0002b2b0: 5f72 6f6f 6d69 6428 636c 6965 6e74 2c20  _roomid(client, 
-0002b2c0: 726f 6f6d 5f69 6429 0a20 2020 2020 2020  room_id).       
-0002b2d0: 2020 2020 2020 2020 2072 6f6f 6d5f 6964           room_id
-0002b2e0: 203d 2071 756f 7465 2872 6f6f 6d5f 6964   = quote(room_id
-0002b2f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002b300: 2020 6461 7461 203d 2064 6174 612e 7265    data = data.re
-0002b310: 706c 6163 6528 7068 2c20 726f 6f6d 5f69  place(ph, room_i
-0002b320: 6429 0a20 2020 2020 2020 2020 2020 2020  d).             
-0002b330: 2020 2075 726c 203d 2075 726c 2e72 6570     url = url.rep
-0002b340: 6c61 6365 2870 682c 2072 6f6f 6d5f 6964  lace(ph, room_id
-0002b350: 290a 2020 2020 2020 2020 7572 6c20 3d20  ).        url = 
-0002b360: 7572 6c2e 7374 7269 7028 290a 2020 2020  url.strip().    
-0002b370: 2020 2020 6966 2064 6174 6120 213d 2022      if data != "
-0002b380: 2220 616e 6420 286d 6574 686f 6420 696e  " and (method in
-0002b390: 2028 2247 4554 222c 2022 4445 4c45 5445   ("GET", "DELETE
-0002b3a0: 222c 2022 4f50 5449 4f4e 5322 2929 3a0a  ", "OPTIONS")):.
-0002b3b0: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
-0002b3c0: 6f67 2e77 6172 6e69 6e67 280a 2020 2020  og.warning(.    
-0002b3d0: 2020 2020 2020 2020 2020 2020 2257 3130              "W10
-0002b3e0: 383a 2022 0a20 2020 2020 2020 2020 2020  8: ".           
-0002b3f0: 2020 2020 2066 2746 6f75 6e64 2052 4553       f'Found RES
-0002b400: 5420 6461 7461 2022 7b64 6174 617d 2220  T data "{data}" 
-0002b410: 666f 7220 6d65 7468 6f64 207b 6d65 7468  for method {meth
-0002b420: 6f64 7d2e 2027 0a20 2020 2020 2020 2020  od}. '.         
-0002b430: 2020 2020 2020 2027 5468 6572 6520 6973         'There is
-0002b440: 2075 7375 616c 6c79 206e 6f20 6461 7461   usually no data
-0002b450: 2066 6f72 3a20 2247 4554 222c 2022 4445   for: "GET", "DE
-0002b460: 4c45 5445 222c 2022 4f50 5449 4f4e 5322  LETE", "OPTIONS"
-0002b470: 2e20 270a 2020 2020 2020 2020 2020 2020  . '.            
-0002b480: 2020 2020 224d 6f73 7420 6c69 6b65 6c79      "Most likely
-0002b490: 2074 6869 7320 6973 206e 6f74 2077 6861   this is not wha
-0002b4a0: 7420 796f 7520 7761 6e74 2e20 220a 2020  t you want. ".  
-0002b4b0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0002b4c0: 2020 2020 2020 2020 6773 2e77 6172 6e5f          gs.warn_
-0002b4d0: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
-0002b4e0: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-0002b4f0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-0002b500: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
-0002b510: 2020 6622 5072 6570 6172 696e 6720 746f    f"Preparing to
-0002b520: 2069 6e76 6f6b 6520 5245 5354 2041 5049   invoke REST API
-0002b530: 2063 616c 6c3a 206d 6574 686f 643d 7b6d   call: method={m
-0002b540: 6574 686f 647d 2022 0a20 2020 2020 2020  ethod} ".       
-0002b550: 2020 2020 2066 2264 6174 613d 7b64 6174       f"data={dat
-0002b560: 617d 2c20 7572 6c3d 7b70 7269 7661 6379  a}, url={privacy
-0002b570: 5f66 696c 7465 7228 7374 7228 7572 6c29  _filter(str(url)
-0002b580: 297d 2e22 0a20 2020 2020 2020 2029 0a20  )}.".        ). 
-0002b590: 2020 2020 2020 2063 6f6e 6e65 6374 6f72         connector
-0002b5a0: 203d 2054 4350 436f 6e6e 6563 746f 7228   = TCPConnector(
-0002b5b0: 7373 6c3d 6773 2e73 736c 2920 2023 2073  ssl=gs.ssl)  # s
-0002b5c0: 6574 7469 6e67 2073 736c 636f 6e74 6578  etting sslcontex
-0002b5d0: 740a 2020 2020 2020 2020 6173 796e 6320  t.        async 
-0002b5e0: 7769 7468 2043 6c69 656e 7453 6573 7369  with ClientSessi
-0002b5f0: 6f6e 2863 6f6e 6e65 6374 6f72 3d63 6f6e  on(connector=con
-0002b600: 6e65 6374 6f72 2920 6173 2073 6573 7369  nector) as sessi
-0002b610: 6f6e 3a20 2023 2061 696f 6874 7470 0a20  on:  # aiohttp. 
-0002b620: 2020 2020 2020 2020 2020 2069 6620 6d65             if me
-0002b630: 7468 6f64 203d 3d20 2247 4554 223a 0a20  thod == "GET":. 
-0002b640: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0002b650: 7379 6e63 2077 6974 6820 7365 7373 696f  sync with sessio
-0002b660: 6e2e 6765 7428 7572 6c2c 2064 6174 613d  n.get(url, data=
-0002b670: 6461 7461 2920 6173 2072 6573 703a 0a20  data) as resp:. 
-0002b680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b690: 2020 2073 7461 7475 7320 3d20 7265 7370     status = resp
-0002b6a0: 2e73 7461 7475 7320 2023 2069 6e74 2c20  .status  # int, 
-0002b6b0: 3230 3020 7375 6363 6573 730a 2020 2020  200 success.    
-0002b6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b6d0: 7478 7420 3d20 6177 6169 7420 7265 7370  txt = await resp
-0002b6e0: 2e74 6578 7428 2920 2023 2073 7472 2069  .text()  # str i
-0002b6f0: 6e20 6469 6374 2066 6f72 6d61 740a 2020  n dict format.  
-0002b700: 2020 2020 2020 2020 2020 656c 6966 206d            elif m
-0002b710: 6574 686f 6420 3d3d 2022 504f 5354 223a  ethod == "POST":
-0002b720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b730: 2061 7379 6e63 2077 6974 6820 7365 7373   async with sess
-0002b740: 696f 6e2e 706f 7374 2875 726c 2c20 6461  ion.post(url, da
-0002b750: 7461 3d64 6174 6129 2061 7320 7265 7370  ta=data) as resp
-0002b760: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002b770: 2020 2020 2020 7374 6174 7573 203d 2072        status = r
-0002b780: 6573 702e 7374 6174 7573 2020 2320 696e  esp.status  # in
-0002b790: 742c 2032 3030 2073 7563 6365 7373 0a20  t, 200 success. 
-0002b7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b7b0: 2020 2074 7874 203d 2061 7761 6974 2072     txt = await r
-0002b7c0: 6573 702e 7465 7874 2829 2020 2320 7374  esp.text()  # st
-0002b7d0: 7220 696e 2064 6963 7420 666f 726d 6174  r in dict format
-0002b7e0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-0002b7f0: 6620 6d65 7468 6f64 203d 3d20 2250 5554  f method == "PUT
-0002b800: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
-0002b810: 2020 2061 7379 6e63 2077 6974 6820 7365     async with se
-0002b820: 7373 696f 6e2e 7075 7428 7572 6c2c 2064  ssion.put(url, d
-0002b830: 6174 613d 6461 7461 2920 6173 2072 6573  ata=data) as res
-0002b840: 703a 0a20 2020 2020 2020 2020 2020 2020  p:.             
-0002b850: 2020 2020 2020 2073 7461 7475 7320 3d20         status = 
-0002b860: 7265 7370 2e73 7461 7475 7320 2023 2069  resp.status  # i
-0002b870: 6e74 2c20 3230 3020 7375 6363 6573 730a  nt, 200 success.
-0002b880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b890: 2020 2020 7478 7420 3d20 6177 6169 7420      txt = await 
-0002b8a0: 7265 7370 2e74 6578 7428 2920 2023 2073  resp.text()  # s
-0002b8b0: 7472 2069 6e20 6469 6374 2066 6f72 6d61  tr in dict forma
-0002b8c0: 740a 2020 2020 2020 2020 2020 2020 656c  t.            el
-0002b8d0: 6966 206d 6574 686f 6420 3d3d 2022 4445  if method == "DE
-0002b8e0: 4c45 5445 223a 0a20 2020 2020 2020 2020  LETE":.         
-0002b8f0: 2020 2020 2020 2061 7379 6e63 2077 6974         async wit
-0002b900: 6820 7365 7373 696f 6e2e 6465 6c65 7465  h session.delete
-0002b910: 2875 726c 2c20 6461 7461 3d64 6174 6129  (url, data=data)
-0002b920: 2061 7320 7265 7370 3a0a 2020 2020 2020   as resp:.      
-0002b930: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0002b940: 6174 7573 203d 2072 6573 702e 7374 6174  atus = resp.stat
-0002b950: 7573 2020 2320 696e 742c 2032 3030 2073  us  # int, 200 s
-0002b960: 7563 6365 7373 0a20 2020 2020 2020 2020  uccess.         
-0002b970: 2020 2020 2020 2020 2020 2074 7874 203d             txt =
-0002b980: 2061 7761 6974 2072 6573 702e 7465 7874   await resp.text
-0002b990: 2829 2020 2320 7374 7220 696e 2064 6963  ()  # str in dic
-0002b9a0: 7420 666f 726d 6174 0a20 2020 2020 2020  t format.       
-0002b9b0: 2020 2020 2065 6c69 6620 6d65 7468 6f64       elif method
-0002b9c0: 203d 3d20 224f 5054 494f 4e53 223a 0a20   == "OPTIONS":. 
-0002b9d0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0002b9e0: 7379 6e63 2077 6974 6820 7365 7373 696f  sync with sessio
-0002b9f0: 6e2e 6f70 7469 6f6e 7328 7572 6c2c 2064  n.options(url, d
-0002ba00: 6174 613d 6461 7461 2920 6173 2072 6573  ata=data) as res
-0002ba10: 703a 0a20 2020 2020 2020 2020 2020 2020  p:.             
-0002ba20: 2020 2020 2020 2073 7461 7475 7320 3d20         status = 
-0002ba30: 7265 7370 2e73 7461 7475 7320 2023 2069  resp.status  # i
-0002ba40: 6e74 2c20 3230 3020 7375 6363 6573 730a  nt, 200 success.
-0002ba50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ba60: 2020 2020 7478 7420 3d20 6177 6169 7420      txt = await 
-0002ba70: 7265 7370 2e74 6578 7428 2920 2023 2073  resp.text()  # s
-0002ba80: 7472 2069 6e20 6469 6374 2066 6f72 6d61  tr in dict forma
-0002ba90: 740a 2020 2020 2020 2020 6966 2073 7461  t.        if sta
-0002baa0: 7475 7320 213d 2032 3030 3a0a 2020 2020  tus != 200:.    
-0002bab0: 2020 2020 2020 2020 2320 7478 7420 6973          # txt is
-0002bac0: 2073 7472 206c 696b 6520 7468 6973 3a0a   str like this:.
-0002bad0: 2020 2020 2020 2020 2020 2020 2320 7b22              # {"
-0002bae0: 6572 7263 6f64 6522 3a22 4d5f 464f 5242  errcode":"M_FORB
-0002baf0: 4944 4445 4e22 2c22 6572 726f 7222 3a22  IDDEN","error":"
-0002bb00: 596f 7520 6172 6520 6e6f 7420 6120 7365  You are not a se
-0002bb10: 7276 6572 2061 646d 696e 227d 0a20 2020  rver admin"}.   
-0002bb20: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
-0002bb30: 6572 726f 7228 0a20 2020 2020 2020 2020  error(.         
-0002bb40: 2020 2020 2020 2022 4531 3837 3a20 220a         "E187: ".
-0002bb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bb60: 6622 5245 5354 2041 5049 2063 616c 6c20  f"REST API call 
-0002bb70: 6661 696c 6564 2e20 4661 696c 6564 2077  failed. Failed w
-0002bb80: 6974 6820 6572 726f 7220 636f 6465 207b  ith error code {
-0002bb90: 7374 6174 7573 7d20 616e 6420 220a 2020  status} and ".  
-0002bba0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0002bbb0: 6572 726f 7220 7465 7874 207b 7478 747d  error text {txt}
-0002bbc0: 2e20 496e 7075 7420 7761 733a 206d 6574  . Input was: met
-0002bbd0: 686f 643d 7b6d 6574 686f 647d 2022 0a20  hod={method} ". 
-0002bbe0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002bbf0: 2264 6174 613d 7b64 6174 617d 2c20 7572  "data={data}, ur
-0002bc00: 6c3d 7b70 7269 7661 6379 5f66 696c 7465  l={privacy_filte
-0002bc10: 7228 7374 7228 7572 6c29 297d 2e22 0a20  r(str(url))}.". 
-0002bc20: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0002bc30: 2020 2020 2020 2020 2067 732e 6572 725f           gs.err_
-0002bc40: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
-0002bc50: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002bc60: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-0002bc70: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-0002bc80: 2020 2066 2252 4553 5420 4150 4920 6361     f"REST API ca
-0002bc90: 6c6c 2077 6173 2073 7563 6365 7373 6675  ll was successfu
-0002bca0: 6c2e 2022 0a20 2020 2020 2020 2020 2020  l. ".           
-0002bcb0: 2020 2020 2066 2252 6573 706f 6e73 6520       f"Response 
-0002bcc0: 6973 3a20 7b74 7874 7d2e 2049 6e70 7574  is: {txt}. Input
-0002bcd0: 2077 6173 3a20 6d65 7468 6f64 3d7b 6d65   was: method={me
-0002bce0: 7468 6f64 7d20 220a 2020 2020 2020 2020  thod} ".        
-0002bcf0: 2020 2020 2020 2020 6622 6461 7461 3d7b          f"data={
-0002bd00: 6461 7461 7d2c 2075 726c 3d7b 7072 6976  data}, url={priv
-0002bd10: 6163 795f 6669 6c74 6572 2873 7472 2875  acy_filter(str(u
-0002bd20: 726c 2929 7d2e 220a 2020 2020 2020 2020  rl))}.".        
-0002bd30: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0002bd40: 2020 2320 6f75 7470 7574 2066 6f72 6d61    # output forma
-0002bd50: 7420 636f 6e74 726f 6c6c 6564 2076 6961  t controlled via
-0002bd60: 202d 2d6f 7574 7075 7420 666c 6167 0a20   --output flag. 
-0002bd70: 2020 2020 2020 2020 2020 2074 6578 7420             text 
-0002bd80: 3d20 6622 7b74 7874 7d22 2020 2320 7265  = f"{txt}"  # re
-0002bd90: 7475 726e 7320 6f6e 6c79 2031 2076 616c  turns only 1 val
-0002bda0: 7565 0a20 2020 2020 2020 2020 2020 206a  ue.            j
-0002bdb0: 736f 6e5f 6d61 7820 3d20 7265 7370 2e5f  son_max = resp._
-0002bdc0: 5f64 6963 745f 5f0a 2020 2020 2020 2020  _dict__.        
-0002bdd0: 2020 2020 6a73 6f6e 5f6d 6178 2e75 7064      json_max.upd
-0002bde0: 6174 6528 7b22 7265 7370 6f6e 7365 223a  ate({"response":
-0002bdf0: 2074 7874 7d29 2020 2320 6164 6420 6469   txt})  # add di
-0002be00: 6374 2069 7465 6d73 0a20 2020 2020 2020  ct items.       
-0002be10: 2020 2020 206a 736f 6e5f 203d 206a 736f       json_ = jso
-0002be20: 6e5f 6d61 782e 636f 7079 2829 0a20 2020  n_max.copy().   
-0002be30: 2020 2020 2020 2020 2023 206a 736f 6e5f           # json_
-0002be40: 2e70 6f70 2822 6b65 7922 290a 2020 2020  .pop("key").    
-0002be50: 2020 2020 2020 2020 6a73 6f6e 5f73 7065          json_spe
-0002be60: 6320 3d20 4e6f 6e65 0a20 2020 2020 2020  c = None.       
-0002be70: 2020 2020 2070 7269 6e74 5f6f 7574 7075       print_outpu
-0002be80: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-0002be90: 2020 2067 732e 7061 2e6f 7574 7075 742c     gs.pa.output,
-0002bea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002beb0: 2074 6578 743d 7465 7874 2c0a 2020 2020   text=text,.    
-0002bec0: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-0002bed0: 5f3d 6a73 6f6e 5f2c 0a20 2020 2020 2020  _=json_,.       
-0002bee0: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
-0002bef0: 783d 6a73 6f6e 5f6d 6178 2c0a 2020 2020  x=json_max,.    
-0002bf00: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-0002bf10: 5f73 7065 633d 6a73 6f6e 5f73 7065 632c  _spec=json_spec,
-0002bf20: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-0002bf30: 0a61 7379 6e63 2064 6566 2061 6374 696f  .async def actio
-0002bf40: 6e5f 6765 745f 6176 6174 6172 2863 6c69  n_get_avatar(cli
-0002bf50: 656e 743a 2041 7379 6e63 436c 6965 6e74  ent: AsyncClient
-0002bf60: 2c20 6372 6564 656e 7469 616c 733a 2064  , credentials: d
-0002bf70: 6963 7429 202d 3e20 4e6f 6e65 3a0a 2020  ict) -> None:.  
-0002bf80: 2020 2222 2247 6574 2061 7661 7461 7228    """Get avatar(
-0002bf90: 7329 206f 6620 6974 7365 6c66 206f 7220  s) of itself or 
-0002bfa0: 7573 6572 7320 7768 696c 6520 616c 7265  users while alre
-0002bfb0: 6164 7920 6c6f 6767 6564 2069 6e2e 2222  ady logged in.""
-0002bfc0: 220a 2020 2020 6966 2067 732e 7061 2e67  ".    if gs.pa.g
-0002bfd0: 6574 5f61 7661 7461 7220 3d3d 205b 5d3a  et_avatar == []:
-0002bfe0: 0a20 2020 2020 2020 2067 732e 7061 2e67  .        gs.pa.g
-0002bff0: 6574 5f61 7661 7461 722e 6170 7065 6e64  et_avatar.append
-0002c000: 2863 7265 6465 6e74 6961 6c73 5b22 7573  (credentials["us
-0002c010: 6572 5f69 6422 5d29 2020 2320 7768 6f61  er_id"])  # whoa
-0002c020: 6d69 0a20 2020 2067 732e 6c6f 672e 6465  mi.    gs.log.de
-0002c030: 6275 6728 6622 4765 7474 696e 6720 6176  bug(f"Getting av
-0002c040: 6174 6172 7320 666f 7220 7468 6573 6520  atars for these 
-0002c050: 7573 6572 733a 207b 6773 2e70 612e 6765  users: {gs.pa.ge
-0002c060: 745f 6176 6174 6172 7d22 290a 2020 2020  t_avatar}").    
-0002c070: 666f 7220 7573 6572 5f69 6420 696e 2067  for user_id in g
-0002c080: 732e 7061 2e67 6574 5f61 7661 7461 723a  s.pa.get_avatar:
-0002c090: 0a20 2020 2020 2020 2075 7365 725f 6964  .        user_id
-0002c0a0: 203d 2075 7365 725f 6964 2e73 7472 6970   = user_id.strip
-0002c0b0: 2829 0a20 2020 2020 2020 2072 6573 7020  ().        resp 
-0002c0c0: 3d20 6177 6169 7420 636c 6965 6e74 2e67  = await client.g
-0002c0d0: 6574 5f61 7661 7461 7228 7573 6572 5f69  et_avatar(user_i
-0002c0e0: 6429 0a20 2020 2020 2020 2069 6620 6973  d).        if is
-0002c0f0: 696e 7374 616e 6365 2872 6573 702c 2050  instance(resp, P
-0002c100: 726f 6669 6c65 4765 7441 7661 7461 7252  rofileGetAvatarR
-0002c110: 6573 706f 6e73 6529 3a0a 2020 2020 2020  esponse):.      
-0002c120: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-0002c130: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-0002c140: 2020 2020 2250 726f 6669 6c65 4765 7441      "ProfileGetA
-0002c150: 7661 7461 7252 6573 706f 6e73 652e 2052  vatarResponse. R
-0002c160: 6573 706f 6e73 6520 6973 3a20 220a 2020  esponse is: ".  
-0002c170: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0002c180: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
-0002c190: 7374 7228 7265 7370 2929 7d22 0a20 2020  str(resp))}".   
-0002c1a0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0002c1b0: 2020 2020 2020 2061 7661 7461 725f 6d78         avatar_mx
-0002c1c0: 6320 3d20 7265 7370 2e61 7661 7461 725f  c = resp.avatar_
-0002c1d0: 7572 6c0a 2020 2020 2020 2020 2020 2020  url.            
-0002c1e0: 6176 6174 6172 5f75 726c 203d 204e 6f6e  avatar_url = Non
-0002c1f0: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
-0002c200: 2061 7661 7461 725f 6d78 633a 2020 2320   avatar_mxc:  # 
-0002c210: 636f 756c 6420 6265 204e 6f6e 6520 6966  could be None if
-0002c220: 206e 6f20 6176 6174 6172 0a20 2020 2020   no avatar.     
-0002c230: 2020 2020 2020 2020 2020 2061 7661 7461             avata
-0002c240: 725f 7572 6c20 3d20 6177 6169 7420 636c  r_url = await cl
-0002c250: 6965 6e74 2e6d 7863 5f74 6f5f 6874 7470  ient.mxc_to_http
-0002c260: 2861 7661 7461 725f 6d78 6329 0a20 2020  (avatar_mxc).   
-0002c270: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
-0002c280: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
-0002c290: 2020 2020 2020 2066 2261 7661 7461 725f         f"avatar_
-0002c2a0: 6d78 6320 6973 207b 6176 6174 6172 5f6d  mxc is {avatar_m
-0002c2b0: 7863 7d2e 2061 7661 7461 725f 7572 6c20  xc}. avatar_url 
-0002c2c0: 6973 207b 6176 6174 6172 5f75 726c 7d22  is {avatar_url}"
-0002c2d0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0002c2e0: 2020 2020 2020 2020 2020 2023 206f 7574             # out
-0002c2f0: 7075 7420 666f 726d 6174 2063 6f6e 7472  put format contr
-0002c300: 6f6c 6c65 6420 7669 6120 2d2d 6f75 7470  olled via --outp
-0002c310: 7574 2066 6c61 670a 2020 2020 2020 2020  ut flag.        
-0002c320: 2020 2020 7465 7874 203d 2066 227b 6176      text = f"{av
-0002c330: 6174 6172 5f6d 7863 7d7b 5345 507d 7b61  atar_mxc}{SEP}{a
-0002c340: 7661 7461 725f 7572 6c7d 220a 2020 2020  vatar_url}".    
-0002c350: 2020 2020 2020 2020 2320 4f62 6a65 6374          # Object
-0002c360: 206f 6620 7479 7065 2078 7878 5265 7370   of type xxxResp
-0002c370: 6f6e 7365 2069 7320 6e6f 7420 4a53 4f4e  onse is not JSON
-0002c380: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
-0002c390: 6572 6961 6c69 7a61 626c 652c 2068 656e  erializable, hen
-0002c3a0: 6365 2077 6520 7573 6520 7468 6520 6469  ce we use the di
-0002c3b0: 6374 696f 6e61 7279 2e0a 2020 2020 2020  ctionary..      
-0002c3c0: 2020 2020 2020 6a73 6f6e 5f6d 6178 203d        json_max =
-0002c3d0: 2072 6573 702e 5f5f 6469 6374 5f5f 0a20   resp.__dict__. 
-0002c3e0: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-0002c3f0: 6d61 782e 7570 6461 7465 287b 2261 7661  max.update({"ava
-0002c400: 7461 725f 6874 7470 223a 2061 7661 7461  tar_http": avata
-0002c410: 725f 7572 6c7d 2920 2023 2061 6464 2064  r_url})  # add d
-0002c420: 6963 7420 6974 656d 730a 2020 2020 2020  ict items.      
-0002c430: 2020 2020 2020 6a73 6f6e 5f20 3d20 6a73        json_ = js
-0002c440: 6f6e 5f6d 6178 2e63 6f70 7928 290a 2020  on_max.copy().  
-0002c450: 2020 2020 2020 2020 2020 6a73 6f6e 5f2e            json_.
-0002c460: 706f 7028 2274 7261 6e73 706f 7274 5f72  pop("transport_r
-0002c470: 6573 706f 6e73 6522 290a 2020 2020 2020  esponse").      
-0002c480: 2020 2020 2020 6a73 6f6e 5f73 7065 6320        json_spec 
-0002c490: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
-0002c4a0: 2020 2070 7269 6e74 5f6f 7574 7075 7428     print_output(
-0002c4b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c4c0: 2067 732e 7061 2e6f 7574 7075 742c 0a20   gs.pa.output,. 
-0002c4d0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0002c4e0: 6578 743d 7465 7874 2c0a 2020 2020 2020  ext=text,.      
-0002c4f0: 2020 2020 2020 2020 2020 6a73 6f6e 5f3d            json_=
-0002c500: 6a73 6f6e 5f2c 0a20 2020 2020 2020 2020  json_,.         
-0002c510: 2020 2020 2020 206a 736f 6e5f 6d61 783d         json_max=
-0002c520: 6a73 6f6e 5f6d 6178 2c0a 2020 2020 2020  json_max,.      
-0002c530: 2020 2020 2020 2020 2020 6a73 6f6e 5f73            json_s
-0002c540: 7065 633d 6a73 6f6e 5f73 7065 632c 0a20  pec=json_spec,. 
-0002c550: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0002c560: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0002c570: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
-0002c580: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-0002c590: 2020 2020 2022 4531 3838 3a20 220a 2020       "E188: ".  
-0002c5a0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0002c5b0: 4661 696c 6564 2067 6574 7469 6e67 2061  Failed getting a
-0002c5c0: 7661 7461 7220 666f 7220 7573 6572 207b  vatar for user {
-0002c5d0: 7573 6572 5f69 647d 2022 0a20 2020 2020  user_id} ".     
-0002c5e0: 2020 2020 2020 2020 2020 2066 2266 726f             f"fro
-0002c5f0: 6d20 7365 7276 6572 2e20 7b70 7269 7661  m server. {priva
-0002c600: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
-0002c610: 7370 2929 7d22 0a20 2020 2020 2020 2020  sp))}".         
-0002c620: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0002c630: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
-0002c640: 2031 0a0a 0a61 7379 6e63 2064 6566 2061   1...async def a
-0002c650: 6374 696f 6e5f 6765 745f 7072 6f66 696c  ction_get_profil
-0002c660: 6528 636c 6965 6e74 3a20 4173 796e 6343  e(client: AsyncC
-0002c670: 6c69 656e 742c 2063 7265 6465 6e74 6961  lient, credentia
-0002c680: 6c73 3a20 6469 6374 2920 2d3e 204e 6f6e  ls: dict) -> Non
-0002c690: 653a 0a20 2020 2022 2222 4765 7420 7573  e:.    """Get us
-0002c6a0: 6572 2070 726f 6669 6c65 2873 2920 6f66  er profile(s) of
-0002c6b0: 2069 7473 656c 6620 6f72 2075 7365 7273   itself or users
-0002c6c0: 2077 6869 6c65 2061 6c72 6561 6479 206c   while already l
-0002c6d0: 6f67 6765 6420 696e 2e22 2222 0a20 2020  ogged in.""".   
-0002c6e0: 2069 6620 6773 2e70 612e 6765 745f 7072   if gs.pa.get_pr
-0002c6f0: 6f66 696c 6520 3d3d 205b 5d3a 0a20 2020  ofile == []:.   
-0002c700: 2020 2020 2067 732e 7061 2e67 6574 5f70       gs.pa.get_p
-0002c710: 726f 6669 6c65 2e61 7070 656e 6428 6372  rofile.append(cr
-0002c720: 6564 656e 7469 616c 735b 2275 7365 725f  edentials["user_
-0002c730: 6964 225d 2920 2023 2077 686f 616d 690a  id"])  # whoami.
-0002c740: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-0002c750: 2866 2247 6574 7469 6e67 2075 7365 7220  (f"Getting user 
-0002c760: 7072 6f66 696c 6573 2066 6f72 2074 6865  profiles for the
-0002c770: 7365 2075 7365 7273 3a20 7b67 732e 7061  se users: {gs.pa
-0002c780: 2e67 6574 5f70 726f 6669 6c65 7d22 290a  .get_profile}").
-0002c790: 2020 2020 666f 7220 7573 6572 5f69 6420      for user_id 
-0002c7a0: 696e 2067 732e 7061 2e67 6574 5f70 726f  in gs.pa.get_pro
-0002c7b0: 6669 6c65 3a0a 2020 2020 2020 2020 7573  file:.        us
-0002c7c0: 6572 5f69 6420 3d20 7573 6572 5f69 642e  er_id = user_id.
-0002c7d0: 7374 7269 7028 290a 2020 2020 2020 2020  strip().        
-0002c7e0: 7265 7370 203d 2061 7761 6974 2063 6c69  resp = await cli
-0002c7f0: 656e 742e 6765 745f 7072 6f66 696c 6528  ent.get_profile(
-0002c800: 7573 6572 5f69 6429 0a20 2020 2020 2020  user_id).       
-0002c810: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
-0002c820: 6573 702c 2050 726f 6669 6c65 4765 7445  esp, ProfileGetE
-0002c830: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-0002c840: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
-0002c850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c860: 2022 4531 3839 3a20 220a 2020 2020 2020   "E189: ".      
-0002c870: 2020 2020 2020 2020 2020 6622 4661 696c            f"Fail
-0002c880: 6564 2067 6574 7469 6e67 2070 726f 6669  ed getting profi
-0002c890: 6c65 2066 6f72 2075 7365 7220 7b75 7365  le for user {use
-0002c8a0: 725f 6964 7d20 220a 2020 2020 2020 2020  r_id} ".        
-0002c8b0: 2020 2020 2020 2020 6622 6672 6f6d 2073          f"from s
-0002c8c0: 6572 7665 722e 207b 7072 6976 6163 795f  erver. {privacy_
-0002c8d0: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
-0002c8e0: 297d 220a 2020 2020 2020 2020 2020 2020  )}".            
-0002c8f0: 290a 2020 2020 2020 2020 2020 2020 6773  ).            gs
-0002c900: 2e65 7272 5f63 6f75 6e74 202b 3d20 310a  .err_count += 1.
-0002c910: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0002c920: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-0002c930: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-0002c940: 2020 2020 2020 2020 6622 5072 6f66 696c          f"Profil
-0002c950: 6547 6574 5265 7370 6f6e 7365 2e20 5265  eGetResponse. Re
-0002c960: 7370 6f6e 7365 2069 733a 207b 7072 6976  sponse is: {priv
-0002c970: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
-0002c980: 6573 7029 297d 220a 2020 2020 2020 2020  esp))}".        
-0002c990: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0002c9a0: 2020 6469 7370 6c61 796e 616d 6520 3d20    displayname = 
-0002c9b0: 7265 7370 2e64 6973 706c 6179 6e61 6d65  resp.displayname
-0002c9c0: 0a20 2020 2020 2020 2020 2020 2061 7661  .            ava
-0002c9d0: 7461 725f 6d78 6320 3d20 7265 7370 2e61  tar_mxc = resp.a
-0002c9e0: 7661 7461 725f 7572 6c0a 2020 2020 2020  vatar_url.      
-0002c9f0: 2020 2020 2020 6176 6174 6172 5f75 726c        avatar_url
-0002ca00: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-0002ca10: 2020 2020 6966 2061 7661 7461 725f 6d78      if avatar_mx
-0002ca20: 633a 2020 2320 636f 756c 6420 6265 204e  c:  # could be N
-0002ca30: 6f6e 6520 6966 206e 6f20 6176 6174 6172  one if no avatar
-0002ca40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ca50: 2061 7661 7461 725f 7572 6c20 3d20 6177   avatar_url = aw
-0002ca60: 6169 7420 636c 6965 6e74 2e6d 7863 5f74  ait client.mxc_t
-0002ca70: 6f5f 6874 7470 2861 7661 7461 725f 6d78  o_http(avatar_mx
-0002ca80: 6329 0a20 2020 2020 2020 2020 2020 206f  c).            o
-0002ca90: 7468 6572 5f69 6e66 6f20 3d20 7265 7370  ther_info = resp
-0002caa0: 2e6f 7468 6572 5f69 6e66 6f0a 2020 2020  .other_info.    
-0002cab0: 2020 2020 2020 2020 6966 206e 6f74 206f          if not o
-0002cac0: 7468 6572 5f69 6e66 6f3a 2020 2320 656d  ther_info:  # em
-0002cad0: 7074 7920 6469 6374 0a20 2020 2020 2020  pty dict.       
-0002cae0: 2020 2020 2020 2020 206f 7468 6572 5f69           other_i
-0002caf0: 6e66 6f20 3d20 2222 0a20 2020 2020 2020  nfo = "".       
-0002cb00: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-0002cb10: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-0002cb20: 2020 2066 2264 6973 706c 6179 6e61 6d65     f"displayname
-0002cb30: 2069 7320 7b64 6973 706c 6179 6e61 6d65   is {displayname
-0002cb40: 7d2e 2061 7661 7461 725f 6d78 6320 6973  }. avatar_mxc is
-0002cb50: 207b 6176 6174 6172 5f6d 7863 7d2e 2022   {avatar_mxc}. "
-0002cb60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002cb70: 2066 2261 7661 7461 725f 7572 6c20 6973   f"avatar_url is
-0002cb80: 207b 6176 6174 6172 5f75 726c 7d2e 206f   {avatar_url}. o
-0002cb90: 7468 6572 5f69 6e66 6f20 6973 207b 7265  ther_info is {re
-0002cba0: 7370 2e6f 7468 6572 5f69 6e66 6f7d 2e22  sp.other_info}."
-0002cbb0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0002cbc0: 2020 2020 2020 2020 2020 2023 206f 7574             # out
-0002cbd0: 7075 7420 666f 726d 6174 2063 6f6e 7472  put format contr
-0002cbe0: 6f6c 6c65 6420 7669 6120 2d2d 6f75 7470  olled via --outp
-0002cbf0: 7574 2066 6c61 670a 2020 2020 2020 2020  ut flag.        
-0002cc00: 2020 2020 7465 7874 203d 2028 0a20 2020      text = (.   
-0002cc10: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
-0002cc20: 6469 7370 6c61 796e 616d 657d 7b53 4550  displayname}{SEP
-0002cc30: 7d7b 6176 6174 6172 5f6d 7863 7d7b 5345  }{avatar_mxc}{SE
-0002cc40: 507d 7b61 7661 7461 725f 7572 6c7d 220a  P}{avatar_url}".
-0002cc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cc60: 6622 7b53 4550 7d7b 6f74 6865 725f 696e  f"{SEP}{other_in
-0002cc70: 666f 7d22 0a20 2020 2020 2020 2020 2020  fo}".           
-0002cc80: 2029 0a20 2020 2020 2020 2020 2020 2023   ).            #
-0002cc90: 204f 626a 6563 7420 6f66 2074 7970 6520   Object of type 
-0002cca0: 7878 7852 6573 706f 6e73 6520 6973 206e  xxxResponse is n
-0002ccb0: 6f74 204a 534f 4e0a 2020 2020 2020 2020  ot JSON.        
-0002ccc0: 2020 2020 2320 7365 7269 616c 697a 6162      # serializab
-0002ccd0: 6c65 2c20 6865 6e63 6520 7765 2075 7365  le, hence we use
-0002cce0: 2074 6865 2064 6963 7469 6f6e 6172 792e   the dictionary.
-0002ccf0: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
-0002cd00: 6e5f 6d61 7820 3d20 7265 7370 2e5f 5f64  n_max = resp.__d
-0002cd10: 6963 745f 5f0a 2020 2020 2020 2020 2020  ict__.          
-0002cd20: 2020 6a73 6f6e 5f6d 6178 2e75 7064 6174    json_max.updat
-0002cd30: 6528 7b22 6176 6174 6172 5f68 7474 7022  e({"avatar_http"
-0002cd40: 3a20 6176 6174 6172 5f75 726c 7d29 2020  : avatar_url})  
-0002cd50: 2320 6164 6420 6469 6374 2069 7465 6d73  # add dict items
-0002cd60: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
-0002cd70: 6e5f 203d 206a 736f 6e5f 6d61 782e 636f  n_ = json_max.co
-0002cd80: 7079 2829 0a20 2020 2020 2020 2020 2020  py().           
-0002cd90: 206a 736f 6e5f 2e70 6f70 2822 7472 616e   json_.pop("tran
-0002cda0: 7370 6f72 745f 7265 7370 6f6e 7365 2229  sport_response")
-0002cdb0: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
-0002cdc0: 6e5f 7370 6563 203d 204e 6f6e 650a 2020  n_spec = None.  
-0002cdd0: 2020 2020 2020 2020 2020 7072 696e 745f            print_
-0002cde0: 6f75 7470 7574 280a 2020 2020 2020 2020  output(.        
-0002cdf0: 2020 2020 2020 2020 6773 2e70 612e 6f75          gs.pa.ou
-0002ce00: 7470 7574 2c0a 2020 2020 2020 2020 2020  tput,.          
-0002ce10: 2020 2020 2020 7465 7874 3d74 6578 742c        text=text,
-0002ce20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ce30: 206a 736f 6e5f 3d6a 736f 6e5f 2c0a 2020   json_=json_,.  
-0002ce40: 2020 2020 2020 2020 2020 2020 2020 6a73                js
-0002ce50: 6f6e 5f6d 6178 3d6a 736f 6e5f 6d61 782c  on_max=json_max,
-0002ce60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ce70: 206a 736f 6e5f 7370 6563 3d6a 736f 6e5f   json_spec=json_
-0002ce80: 7370 6563 2c0a 2020 2020 2020 2020 2020  spec,.          
-0002ce90: 2020 290a 0a0a 6173 796e 6320 6465 6620    )...async def 
-0002cea0: 6163 7469 6f6e 5f67 6574 5f63 6c69 656e  action_get_clien
-0002ceb0: 745f 696e 666f 280a 2020 2020 636c 6965  t_info(.    clie
-0002cec0: 6e74 3a20 4173 796e 6343 6c69 656e 742c  nt: AsyncClient,
-0002ced0: 2063 7265 6465 6e74 6961 6c73 3a20 6469   credentials: di
-0002cee0: 6374 0a29 202d 3e20 4e6f 6e65 3a0a 2020  ct.) -> None:.  
-0002cef0: 2020 2222 2247 6574 2063 6c69 656e 7420    """Get client 
-0002cf00: 696e 666f 2077 6869 6c65 2061 6c72 6561  info while alrea
-0002cf10: 6479 206c 6f67 6765 6420 696e 2e22 2222  dy logged in."""
-0002cf20: 0a20 2020 2067 732e 6c6f 672e 6465 6275  .    gs.log.debu
-0002cf30: 6728 2247 6574 7469 6e67 2063 6c69 656e  g("Getting clien
-0002cf40: 7420 696e 666f 2e22 290a 2020 2020 6177  t info.").    aw
-0002cf50: 6169 7420 7379 6e63 6872 6f6e 697a 6528  ait synchronize(
-0002cf60: 636c 6965 6e74 2920 2023 2073 796e 6328  client)  # sync(
-0002cf70: 2920 746f 2067 6574 2072 6f6f 6d73 0a20  ) to get rooms. 
-0002cf80: 2020 2070 7269 6e74 286a 736f 6e2e 6475     print(json.du
-0002cf90: 6d70 7328 636c 6965 6e74 2e5f 5f64 6963  mps(client.__dic
-0002cfa0: 745f 5f2c 2064 6566 6175 6c74 3d6f 626a  t__, default=obj
-0002cfb0: 5f74 6f5f 6469 6374 2929 0a0a 0a61 7379  _to_dict))...asy
-0002cfc0: 6e63 2064 6566 2061 6374 696f 6e5f 6765  nc def action_ge
-0002cfd0: 745f 726f 6f6d 5f69 6e66 6f28 636c 6965  t_room_info(clie
-0002cfe0: 6e74 3a20 4173 796e 6343 6c69 656e 742c  nt: AsyncClient,
-0002cff0: 2063 7265 6465 6e74 6961 6c73 3a20 6469   credentials: di
-0002d000: 6374 2920 2d3e 204e 6f6e 653a 0a20 2020  ct) -> None:.   
-0002d010: 2022 2222 4765 7420 726f 6f6d 2064 6973   """Get room dis
-0002d020: 706c 6179 206e 616d 6528 7329 206f 6620  play name(s) of 
-0002d030: 6974 7365 6c66 206f 7220 726f 6f6d 7320  itself or rooms 
-0002d040: 7768 696c 6520 616c 7265 6164 7920 6c6f  while already lo
-0002d050: 6767 6564 2069 6e2e 2222 220a 2020 2020  gged in.""".    
-0002d060: 6966 2067 732e 7061 2e67 6574 5f72 6f6f  if gs.pa.get_roo
-0002d070: 6d5f 696e 666f 203d 3d20 5b5d 3a0a 2020  m_info == []:.  
-0002d080: 2020 2020 2020 6773 2e70 612e 6765 745f        gs.pa.get_
-0002d090: 726f 6f6d 5f69 6e66 6f2e 6170 7065 6e64  room_info.append
-0002d0a0: 2863 7265 6465 6e74 6961 6c73 5b22 726f  (credentials["ro
-0002d0b0: 6f6d 5f69 6422 5d29 0a20 2020 2067 732e  om_id"]).    gs.
-0002d0c0: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
-0002d0d0: 2020 2022 4765 7474 696e 6720 726f 6f6d     "Getting room
-0002d0e0: 2064 6973 706c 6179 206e 616d 6573 2066   display names f
-0002d0f0: 6f72 2074 6865 7365 2072 6f6f 6d73 3a20  or these rooms: 
-0002d100: 2220 6622 7b67 732e 7061 2e67 6574 5f72  " f"{gs.pa.get_r
-0002d110: 6f6f 6d5f 696e 666f 7d22 0a20 2020 2029  oom_info}".    )
-0002d120: 0a20 2020 2061 7761 6974 2073 796e 6368  .    await synch
-0002d130: 726f 6e69 7a65 2863 6c69 656e 7429 2020  ronize(client)  
-0002d140: 2320 7379 6e63 2829 2074 6f20 6765 7420  # sync() to get 
-0002d150: 726f 6f6d 730a 2020 2020 2320 7573 6572  rooms.    # user
-0002d160: 5f69 6420 3d20 6372 6564 656e 7469 616c  _id = credential
-0002d170: 735b 2275 7365 725f 6964 225d 0a20 2020  s["user_id"].   
-0002d180: 2066 6f72 2072 6f6f 6d5f 6964 2069 6e20   for room_id in 
-0002d190: 6773 2e70 612e 6765 745f 726f 6f6d 5f69  gs.pa.get_room_i
-0002d1a0: 6e66 6f3a 0a20 2020 2020 2020 2072 6f6f  nfo:.        roo
-0002d1b0: 6d5f 6964 203d 2061 7761 6974 206d 6170  m_id = await map
-0002d1c0: 5f72 6f6f 6d69 6e66 6f5f 746f 5f72 6f6f  _roominfo_to_roo
-0002d1d0: 6d69 6428 636c 6965 6e74 2c20 726f 6f6d  mid(client, room
-0002d1e0: 5f69 6429 0a20 2020 2020 2020 2074 7279  _id).        try
-0002d1f0: 3a0a 2020 2020 2020 2020 2020 2020 726f  :.            ro
-0002d200: 6f6d 203d 2063 6c69 656e 742e 726f 6f6d  om = client.room
-0002d210: 735b 726f 6f6d 5f69 645d 0a20 2020 2020  s[room_id].     
-0002d220: 2020 2020 2020 2072 6f6f 6d5f 6469 7370         room_disp
-0002d230: 6c61 796e 616d 6520 3d20 726f 6f6d 2e64  layname = room.d
-0002d240: 6973 706c 6179 5f6e 616d 650a 2020 2020  isplay_name.    
-0002d250: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-0002d260: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-0002d270: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
-0002d280: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-0002d290: 2020 2020 2022 4531 3930 3a20 220a 2020       "E190: ".  
-0002d2a0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0002d2b0: 4661 696c 6564 2067 6574 7469 6e67 2072  Failed getting r
-0002d2c0: 6f6f 6d20 6469 7370 6c61 7920 6e61 6d65  oom display name
-0002d2d0: 2066 6f72 2072 6f6f 6d20 7b72 6f6f 6d5f   for room {room_
-0002d2e0: 6964 7d20 220a 2020 2020 2020 2020 2020  id} ".          
-0002d2f0: 2020 2020 2020 6622 6672 6f6d 2073 6572        f"from ser
-0002d300: 7665 722e 2022 0a20 2020 2020 2020 2020  ver. ".         
-0002d310: 2020 2020 2020 2066 2245 7863 6570 7469         f"Excepti
-0002d320: 6f6e 2069 7320 7b65 7d2e 2022 0a20 2020  on is {e}. ".   
-0002d330: 2020 2020 2020 2020 2020 2020 2066 2252               f"R
-0002d340: 6f6f 6d20 6973 207b 726f 6f6d 7d2e 2052  oom is {room}. R
-0002d350: 6f6f 6d20 6469 6374 2069 7320 7b72 6f6f  oom dict is {roo
-0002d360: 6d2e 5f5f 6469 6374 5f5f 7d2e 2022 0a20  m.__dict__}. ". 
-0002d370: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0002d380: 2020 2020 2020 2020 2067 732e 6572 725f           gs.err_
-0002d390: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
-0002d3a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002d3b0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-0002d3c0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-0002d3d0: 2020 2066 2272 6f6f 6d20 6964 2069 7320     f"room id is 
-0002d3e0: 7b72 6f6f 6d5f 6964 7d2c 2022 0a20 2020  {room_id}, ".   
-0002d3f0: 2020 2020 2020 2020 2020 2020 2066 2272               f"r
-0002d400: 6f6f 6d20 6469 7370 6c61 7920 6e61 6d65  oom display name
-0002d410: 2069 7320 7b72 6f6f 6d5f 6469 7370 6c61   is {room_displa
-0002d420: 796e 616d 657d 2c20 220a 2020 2020 2020  yname}, ".      
-0002d430: 2020 2020 2020 2020 2020 6622 726f 6f6d            f"room
-0002d440: 2069 7320 7b72 6f6f 6d7d 2e20 220a 2020   is {room}. ".  
-0002d450: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0002d460: 2020 2020 2020 2020 7265 7370 203d 2072          resp = r
-0002d470: 6f6f 6d0a 2020 2020 2020 2020 2020 2020  oom.            
-0002d480: 2320 6f75 7470 7574 2066 6f72 6d61 7420  # output format 
-0002d490: 636f 6e74 726f 6c6c 6564 2076 6961 202d  controlled via -
-0002d4a0: 2d6f 7574 7075 7420 666c 6167 0a20 2020  -output flag.   
-0002d4b0: 2020 2020 2020 2020 2074 6578 7420 3d20           text = 
-0002d4c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0002d4d0: 2020 6622 7b72 6f6f 6d5f 6964 7d7b 5345    f"{room_id}{SE
-0002d4e0: 507d 7b72 6f6f 6d5f 6469 7370 6c61 796e  P}{room_displayn
-0002d4f0: 616d 657d 7b53 4550 7d22 0a20 2020 2020  ame}{SEP}".     
-0002d500: 2020 2020 2020 2020 2020 2066 227b 726f             f"{ro
-0002d510: 6f6d 2e63 616e 6f6e 6963 616c 5f61 6c69  om.canonical_ali
-0002d520: 6173 7d7b 5345 507d 7b72 6f6f 6d2e 746f  as}{SEP}{room.to
-0002d530: 7069 637d 7b53 4550 7d22 0a20 2020 2020  pic}{SEP}".     
-0002d540: 2020 2020 2020 2020 2020 2066 227b 726f             f"{ro
-0002d550: 6f6d 2e63 7265 6174 6f72 7d7b 5345 507d  om.creator}{SEP}
-0002d560: 7b72 6f6f 6d2e 656e 6372 7970 7465 647d  {room.encrypted}
-0002d570: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0002d580: 2020 2320 6622 7b53 4550 7d7b 7573 6572    # f"{SEP}{user
-0002d590: 5f69 647d 220a 2020 2020 2020 2020 2020  _id}".          
-0002d5a0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0002d5b0: 2320 4f62 6a65 6374 206f 6620 7479 7065  # Object of type
-0002d5c0: 2078 7878 5265 7370 6f6e 7365 2069 7320   xxxResponse is 
-0002d5d0: 6e6f 7420 4a53 4f4e 0a20 2020 2020 2020  not JSON.       
-0002d5e0: 2020 2020 2023 2073 6572 6961 6c69 7a61       # serializa
-0002d5f0: 626c 652c 2068 656e 6365 2077 6520 7573  ble, hence we us
-0002d600: 6520 7468 6520 6469 6374 696f 6e61 7279  e the dictionary
-0002d610: 2e0a 2020 2020 2020 2020 2020 2020 6a73  ..            js
-0002d620: 6f6e 5f6d 6178 203d 2072 6573 702e 5f5f  on_max = resp.__
-0002d630: 6469 6374 5f5f 0a20 2020 2020 2020 2020  dict__.         
-0002d640: 2020 206a 736f 6e5f 6d61 782e 7570 6461     json_max.upda
-0002d650: 7465 280a 2020 2020 2020 2020 2020 2020  te(.            
-0002d660: 2020 2020 7b22 6469 7370 6c61 795f 6e61      {"display_na
-0002d670: 6d65 223a 2072 6f6f 6d5f 6469 7370 6c61  me": room_displa
-0002d680: 796e 616d 657d 0a20 2020 2020 2020 2020  yname}.         
-0002d690: 2020 2029 2020 2320 6164 6420 6469 6374     )  # add dict
-0002d6a0: 2069 7465 6d73 0a20 2020 2020 2020 2020   items.         
-0002d6b0: 2020 206a 736f 6e5f 203d 206a 736f 6e5f     json_ = json_
-0002d6c0: 6d61 782e 636f 7079 2829 0a20 2020 2020  max.copy().     
-0002d6d0: 2020 2020 2020 2023 206a 736f 6e5f 2e70         # json_.p
-0002d6e0: 6f70 2822 6b65 7922 290a 2020 2020 2020  op("key").      
-0002d6f0: 2020 2020 2020 6a73 6f6e 5f73 7065 6320        json_spec 
-0002d700: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
-0002d710: 2020 2070 7269 6e74 5f6f 7574 7075 7428     print_output(
-0002d720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d730: 2067 732e 7061 2e6f 7574 7075 742c 0a20   gs.pa.output,. 
-0002d740: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0002d750: 6578 743d 7465 7874 2c0a 2020 2020 2020  ext=text,.      
-0002d760: 2020 2020 2020 2020 2020 6a73 6f6e 5f3d            json_=
-0002d770: 6a73 6f6e 5f2c 0a20 2020 2020 2020 2020  json_,.         
-0002d780: 2020 2020 2020 206a 736f 6e5f 6d61 783d         json_max=
-0002d790: 6a73 6f6e 5f6d 6178 2c0a 2020 2020 2020  json_max,.      
-0002d7a0: 2020 2020 2020 2020 2020 6a73 6f6e 5f73            json_s
-0002d7b0: 7065 633d 6a73 6f6e 5f73 7065 632c 0a20  pec=json_spec,. 
-0002d7c0: 2020 2020 2020 2020 2020 2029 0a0a 0a61             )...a
-0002d7d0: 7379 6e63 2064 6566 2061 6374 696f 6e5f  sync def action_
-0002d7e0: 6861 735f 7065 726d 6973 7369 6f6e 280a  has_permission(.
-0002d7f0: 2020 2020 636c 6965 6e74 3a20 4173 796e      client: Asyn
-0002d800: 6343 6c69 656e 742c 2063 7265 6465 6e74  cClient, credent
-0002d810: 6961 6c73 3a20 6469 6374 0a29 202d 3e20  ials: dict.) -> 
-0002d820: 4e6f 6e65 3a0a 2020 2020 2222 2249 6e71  None:.    """Inq
-0002d830: 7569 7265 2061 626f 7574 2070 6572 6d69  uire about permi
-0002d840: 7373 696f 6e73 2069 6e20 726f 6f6d 7320  ssions in rooms 
-0002d850: 7768 696c 6520 616c 7265 6164 7920 6c6f  while already lo
-0002d860: 6767 6564 2069 6e2e 2222 220a 2020 2020  gged in.""".    
-0002d870: 6966 206e 6f74 206c 656e 2867 732e 7061  if not len(gs.pa
-0002d880: 2e68 6173 5f70 6572 6d69 7373 696f 6e29  .has_permission)
-0002d890: 2025 2032 203d 3d20 303a 0a20 2020 2020   % 2 == 0:.     
-0002d8a0: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
-0002d8b0: 0a20 2020 2020 2020 2020 2020 2022 4531  .            "E1
-0002d8c0: 3931 3a20 220a 2020 2020 2020 2020 2020  91: ".          
-0002d8d0: 2020 2249 6e63 6f72 7265 6374 206e 756d    "Incorrect num
-0002d8e0: 6265 7220 6f66 2061 7267 756d 656e 7473  ber of arguments
-0002d8f0: 2066 6f72 202d 2d68 6173 2d70 6572 6d69   for --has-permi
-0002d900: 7373 696f 6e2e 2041 7267 756d 656e 7473  ssion. Arguments
-0002d910: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-0002d920: 6d75 7374 2062 6520 7061 6972 732c 2069  must be pairs, i
-0002d930: 2e65 2e20 6d75 6c74 6970 6c65 7320 6f66  .e. multiples of
-0002d940: 2032 2c20 6275 7420 666f 756e 6420 220a   2, but found ".
-0002d950: 2020 2020 2020 2020 2020 2020 6622 7b6c              f"{l
-0002d960: 656e 2867 732e 7061 2e68 6173 5f70 6572  en(gs.pa.has_per
-0002d970: 6d69 7373 696f 6e29 7d20 6172 6775 6d65  mission)} argume
-0002d980: 6e74 732e 220a 2020 2020 2020 2020 290a  nts.".        ).
-0002d990: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
-0002d9a0: 6f75 6e74 202b 3d20 310a 2020 2020 2020  ount += 1.      
-0002d9b0: 2020 7265 7475 726e 0a20 2020 2075 7365    return.    use
-0002d9c0: 725f 6964 203d 2063 7265 6465 6e74 6961  r_id = credentia
-0002d9d0: 6c73 5b22 7573 6572 5f69 6422 5d20 2023  ls["user_id"]  #
-0002d9e0: 2077 686f 616d 690a 2020 2020 666f 7220   whoami.    for 
-0002d9f0: 6969 2069 6e20 7261 6e67 6528 6c65 6e28  ii in range(len(
-0002da00: 6773 2e70 612e 6861 735f 7065 726d 6973  gs.pa.has_permis
-0002da10: 7369 6f6e 2920 2f2f 2032 293a 0a20 2020  sion) // 2):.   
-0002da20: 2020 2020 2072 6f6f 6d5f 6964 203d 2067       room_id = g
-0002da30: 732e 7061 2e68 6173 5f70 6572 6d69 7373  s.pa.has_permiss
-0002da40: 696f 6e5b 6969 202a 2032 202b 2030 5d0a  ion[ii * 2 + 0].
-0002da50: 2020 2020 2020 2020 726f 6f6d 5f69 6420          room_id 
-0002da60: 3d20 726f 6f6d 5f69 642e 7265 706c 6163  = room_id.replac
-0002da70: 6528 7222 5c21 222c 2022 2122 2920 2023  e(r"\!", "!")  #
-0002da80: 2072 656d 6f76 6520 706f 7373 6962 6c65   remove possible
-0002da90: 2065 7363 6170 650a 2020 2020 2020 2020   escape.        
-0002daa0: 726f 6f6d 5f69 6420 3d20 6177 6169 7420  room_id = await 
-0002dab0: 6d61 705f 726f 6f6d 696e 666f 5f74 6f5f  map_roominfo_to_
-0002dac0: 726f 6f6d 6964 2863 6c69 656e 742c 2072  roomid(client, r
-0002dad0: 6f6f 6d5f 6964 290a 2020 2020 2020 2020  oom_id).        
-0002dae0: 7065 726d 6973 7369 6f6e 5f74 7970 6520  permission_type 
-0002daf0: 3d20 6773 2e70 612e 6861 735f 7065 726d  = gs.pa.has_perm
-0002db00: 6973 7369 6f6e 5b69 6920 2a20 3220 2b20  ission[ii * 2 + 
-0002db10: 315d 2e73 7472 6970 2829 0a20 2020 2020  1].strip().     
-0002db20: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-0002db30: 0a20 2020 2020 2020 2020 2020 2022 5072  .            "Pr
-0002db40: 6570 6172 696e 6720 746f 2061 736b 2061  eparing to ask a
-0002db50: 626f 7574 2070 6572 6d69 7373 696f 6e20  bout permission 
-0002db60: 666f 7220 7065 726d 6973 7369 6f6e 2074  for permission t
-0002db70: 7970 6520 220a 2020 2020 2020 2020 2020  ype ".          
-0002db80: 2020 6622 277b 7065 726d 6973 7369 6f6e    f"'{permission
-0002db90: 5f74 7970 657d 2720 696e 2072 6f6f 6d20  _type}' in room 
-0002dba0: 7b72 6f6f 6d5f 6964 7d2e 220a 2020 2020  {room_id}.".    
-0002dbb0: 2020 2020 290a 2020 2020 2020 2020 7472      ).        tr
-0002dbc0: 793a 0a20 2020 2020 2020 2020 2020 2072  y:.            r
-0002dbd0: 6573 7020 3d20 6177 6169 7420 636c 6965  esp = await clie
-0002dbe0: 6e74 2e68 6173 5f70 6572 6d69 7373 696f  nt.has_permissio
-0002dbf0: 6e28 726f 6f6d 5f69 642c 2070 6572 6d69  n(room_id, permi
-0002dc00: 7373 696f 6e5f 7479 7065 290a 2020 2020  ssion_type).    
-0002dc10: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-0002dc20: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-0002dc30: 2020 2020 2020 2072 6573 7020 3d20 4572         resp = Er
-0002dc40: 726f 7252 6573 706f 6e73 6528 0a20 2020  rorResponse(.   
-0002dc50: 2020 2020 2020 2020 2020 2020 2022 4531               "E1
-0002dc60: 3932 3a20 220a 2020 2020 2020 2020 2020  92: ".          
-0002dc70: 2020 2020 2020 6622 6861 735f 7065 726d        f"has_perm
-0002dc80: 6973 7369 6f6e 2829 2066 6169 6c65 6420  ission() failed 
-0002dc90: 7769 7468 2027 7b65 7d27 2e20 220a 2020  with '{e}'. ".  
-0002dca0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0002dcb0: 4973 2074 6865 2072 6f6f 6d20 6964 207b  Is the room id {
-0002dcc0: 726f 6f6d 5f69 647d 2063 6f72 7265 6374  room_id} correct
-0002dcd0: 3f22 0a20 2020 2020 2020 2020 2020 2029  ?".            )
-0002dce0: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-0002dcf0: 7374 616e 6365 2872 6573 702c 2045 7272  stance(resp, Err
-0002dd00: 6f72 5265 7370 6f6e 7365 293a 0a20 2020  orResponse):.   
-0002dd10: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
-0002dd20: 6572 726f 7228 0a20 2020 2020 2020 2020  error(.         
-0002dd30: 2020 2020 2020 2022 4531 3933 3a20 220a         "E193: ".
-0002dd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dd50: 2246 6169 6c65 6420 746f 2061 736b 2061  "Failed to ask a
-0002dd60: 626f 7574 2070 6572 6d69 7373 696f 6e20  bout permission 
-0002dd70: 666f 7220 7065 726d 6973 7369 6f6e 2074  for permission t
-0002dd80: 7970 6520 220a 2020 2020 2020 2020 2020  ype ".          
-0002dd90: 2020 2020 2020 6622 277b 7065 726d 6973        f"'{permis
-0002dda0: 7369 6f6e 5f74 7970 657d 2720 696e 2072  sion_type}' in r
-0002ddb0: 6f6f 6d20 7b72 6f6f 6d5f 6964 7d2e 2022  oom {room_id}. "
-0002ddc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ddd0: 2066 2252 6573 706f 6e73 6520 6973 207b   f"Response is {
-0002dde0: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
-0002ddf0: 7472 2872 6573 7029 297d 220a 2020 2020  tr(resp))}".    
-0002de00: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0002de10: 2020 2020 2020 6773 2e65 7272 5f63 6f75        gs.err_cou
-0002de20: 6e74 202b 3d20 310a 2020 2020 2020 2020  nt += 1.        
-0002de30: 2020 2020 2320 6f75 7470 7574 2066 6f72      # output for
-0002de40: 6d61 7420 636f 6e74 726f 6c6c 6564 2076  mat controlled v
-0002de50: 6961 202d 2d6f 7574 7075 7420 666c 6167  ia --output flag
-0002de60: 0a20 2020 2020 2020 2020 2020 2023 2066  .            # f
-0002de70: 6f72 204a 534f 4e20 7468 6520 7573 6572  or JSON the user
-0002de80: 2063 616e 2064 6574 6572 6d69 6e65 2077   can determine w
-0002de90: 6869 6368 206f 6e65 2066 726f 6d20 7468  hich one from th
-0002dea0: 6520 6c69 7374 0a20 2020 2020 2020 2020  e list.         
-0002deb0: 2020 2023 2077 6173 2073 7563 6365 7373     # was success
-0002dec0: 6675 6c20 616e 6420 7768 6963 6820 6f6e  ful and which on
-0002ded0: 6520 6661 696c 6564 2e20 466f 7220 3420  e failed. For 4 
-0002dee0: 696e 7075 7473 2074 6865 7265 0a20 2020  inputs there.   
-0002def0: 2020 2020 2020 2020 2023 206d 6967 6874           # might
-0002df00: 206f 6e6c 7920 6265 2033 206f 7574 7075   only be 3 outpu
-0002df10: 7420 4a53 4f4e 206f 626a 6563 7473 2069  t JSON objects i
-0002df20: 6620 7468 6572 6520 7761 7320 3120 6572  f there was 1 er
-0002df30: 726f 722e 0a20 2020 2020 2020 2020 2020  ror..           
-0002df40: 2023 2049 6e20 7465 7874 206d 6f64 6520   # In text mode 
-0002df50: 7765 2070 7269 6e74 2074 6869 7320 6572  we print this er
-0002df60: 726f 7220 6c69 6e65 2c20 736f 2074 6861  ror line, so tha
-0002df70: 7420 666f 7220 3420 696e 7075 7473 0a20  t for 4 inputs. 
-0002df80: 2020 2020 2020 2020 2020 2023 2074 6865             # the
-0002df90: 7265 2077 696c 6c20 6265 2034 206f 7574  re will be 4 out
-0002dfa0: 7075 7420 6c69 6e65 732e 0a20 2020 2020  put lines..     
-0002dfb0: 2020 2020 2020 2070 7269 6e74 5f6f 7574         print_out
-0002dfc0: 7075 7428 0a20 2020 2020 2020 2020 2020  put(.           
-0002dfd0: 2020 2020 2067 732e 7061 2e6f 7574 7075       gs.pa.outpu
-0002dfe0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-0002dff0: 2020 2074 6578 743d 280a 2020 2020 2020     text=(.      
-0002e000: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0002e010: 4572 726f 727b 5345 507d 7b75 7365 725f  Error{SEP}{user_
-0002e020: 6964 7d7b 5345 507d 7b72 6f6f 6d5f 6964  id}{SEP}{room_id
-0002e030: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
-0002e040: 2020 2020 2020 2066 227b 5345 507d 7b70         f"{SEP}{p
-0002e050: 6572 6d69 7373 696f 6e5f 7479 7065 7d22  ermission_type}"
-0002e060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e070: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
-0002e080: 2020 2020 6a73 6f6e 5f3d 4e6f 6e65 2c0a      json_=None,.
-0002e090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e0a0: 6a73 6f6e 5f6d 6178 3d4e 6f6e 652c 0a20  json_max=None,. 
-0002e0b0: 2020 2020 2020 2020 2020 2020 2020 206a                 j
-0002e0c0: 736f 6e5f 7370 6563 3d4e 6f6e 652c 0a20  son_spec=None,. 
-0002e0d0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0002e0e0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0002e0f0: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-0002e100: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
-0002e110: 2020 2020 2066 2268 6173 5f70 6572 6d69       f"has_permi
-0002e120: 7373 696f 6e20 7b75 7365 725f 6964 7d20  ssion {user_id} 
-0002e130: 666f 7220 7065 726d 6973 7369 6f6e 2074  for permission t
-0002e140: 7970 6520 220a 2020 2020 2020 2020 2020  ype ".          
-0002e150: 2020 2020 2020 6622 277b 7065 726d 6973        f"'{permis
-0002e160: 7369 6f6e 5f74 7970 657d 2720 696e 2072  sion_type}' in r
-0002e170: 6f6f 6d20 7b72 6f6f 6d5f 6964 7d3a 2022  oom {room_id}: "
-0002e180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e190: 2066 227b 7072 6976 6163 795f 6669 6c74   f"{privacy_filt
-0002e1a0: 6572 2873 7472 2872 6573 7029 297d 220a  er(str(resp))}".
-0002e1b0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0002e1c0: 2020 2020 2020 2020 2020 2320 6f75 7470            # outp
-0002e1d0: 7574 2066 6f72 6d61 7420 636f 6e74 726f  ut format contro
-0002e1e0: 6c6c 6564 2076 6961 202d 2d6f 7574 7075  lled via --outpu
-0002e1f0: 7420 666c 6167 0a20 2020 2020 2020 2020  t flag.         
-0002e200: 2020 2074 6578 7420 3d20 280a 2020 2020     text = (.    
-0002e210: 2020 2020 2020 2020 2020 2020 6622 7b70              f"{p
-0002e220: 7269 7661 6379 5f66 696c 7465 7228 7374  rivacy_filter(st
-0002e230: 7228 7265 7370 2929 7d7b 5345 507d 7b75  r(resp))}{SEP}{u
-0002e240: 7365 725f 6964 7d7b 5345 507d 7b72 6f6f  ser_id}{SEP}{roo
-0002e250: 6d5f 6964 7d7b 5345 507d 220a 2020 2020  m_id}{SEP}".    
-0002e260: 2020 2020 2020 2020 2020 2020 6622 7b70              f"{p
-0002e270: 6572 6d69 7373 696f 6e5f 7479 7065 7d22  ermission_type}"
-0002e280: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0002e290: 2020 2020 2020 2020 2020 2023 204f 626a             # Obj
-0002e2a0: 6563 7420 6f66 2074 7970 6520 7878 7852  ect of type xxxR
-0002e2b0: 6573 706f 6e73 6520 6973 206e 6f74 204a  esponse is not J
-0002e2c0: 534f 4e0a 2020 2020 2020 2020 2020 2020  SON.            
-0002e2d0: 2320 7365 7269 616c 697a 6162 6c65 2c20  # serializable, 
-0002e2e0: 6865 6e63 6520 7765 2075 7365 2074 6865  hence we use the
-0002e2f0: 2064 6963 7469 6f6e 6172 792e 0a20 2020   dictionary..   
-0002e300: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
-0002e310: 7820 3d20 7265 7370 2e5f 5f64 6963 745f  x = resp.__dict_
-0002e320: 5f0a 2020 2020 2020 2020 2020 2020 2320  _.            # 
-0002e330: 6a73 6f6e 5f6d 6178 2e75 7064 6174 6528  json_max.update(
-0002e340: 7b22 6b65 7922 3a20 7661 6c75 657d 2920  {"key": value}) 
-0002e350: 2023 2061 6464 2064 6963 7420 6974 656d   # add dict item
-0002e360: 730a 2020 2020 2020 2020 2020 2020 6a73  s.            js
-0002e370: 6f6e 5f20 3d20 6a73 6f6e 5f6d 6178 2e63  on_ = json_max.c
-0002e380: 6f70 7928 290a 2020 2020 2020 2020 2020  opy().          
-0002e390: 2020 6a73 6f6e 5f2e 706f 7028 2274 7261    json_.pop("tra
-0002e3a0: 6e73 706f 7274 5f72 6573 706f 6e73 6522  nsport_response"
-0002e3b0: 290a 2020 2020 2020 2020 2020 2020 6a73  ).            js
-0002e3c0: 6f6e 5f73 7065 6320 3d20 4e6f 6e65 0a20  on_spec = None. 
-0002e3d0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0002e3e0: 5f6f 7574 7075 7428 0a20 2020 2020 2020  _output(.       
-0002e3f0: 2020 2020 2020 2020 2067 732e 7061 2e6f           gs.pa.o
-0002e400: 7574 7075 742c 0a20 2020 2020 2020 2020  utput,.         
-0002e410: 2020 2020 2020 2074 6578 743d 7465 7874         text=text
-0002e420: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002e430: 2020 6a73 6f6e 5f3d 6a73 6f6e 5f2c 0a20    json_=json_,. 
-0002e440: 2020 2020 2020 2020 2020 2020 2020 206a                 j
-0002e450: 736f 6e5f 6d61 783d 6a73 6f6e 5f6d 6178  son_max=json_max
-0002e460: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002e470: 2020 6a73 6f6e 5f73 7065 633d 6a73 6f6e    json_spec=json
-0002e480: 5f73 7065 632c 0a20 2020 2020 2020 2020  _spec,.         
-0002e490: 2020 2029 0a0a 0a61 7379 6e63 2064 6566     )...async def
-0002e4a0: 2061 6374 696f 6e5f 7365 745f 6176 6174   action_set_avat
-0002e4b0: 6172 2863 6c69 656e 743a 2041 7379 6e63  ar(client: Async
-0002e4c0: 436c 6965 6e74 2c20 6372 6564 656e 7469  Client, credenti
-0002e4d0: 616c 733a 2064 6963 7429 202d 3e20 4e6f  als: dict) -> No
-0002e4e0: 6e65 3a0a 2020 2020 2222 2253 6574 2061  ne:.    """Set a
-0002e4f0: 7661 7461 7220 6f66 2069 7473 656c 6620  vatar of itself 
-0002e500: 7768 696c 6520 616c 7265 6164 7920 6c6f  while already lo
-0002e510: 6767 6564 2069 6e2e 2222 220a 2020 2020  gged in.""".    
-0002e520: 7573 6572 5f69 6420 3d20 6372 6564 656e  user_id = creden
-0002e530: 7469 616c 735b 2275 7365 725f 6964 225d  tials["user_id"]
-0002e540: 2020 2320 7768 6f61 6d69 0a20 2020 2061    # whoami.    a
-0002e550: 7661 7461 725f 6d78 6320 3d20 6773 2e70  vatar_mxc = gs.p
-0002e560: 612e 7365 745f 6176 6174 6172 0a20 2020  a.set_avatar.   
-0002e570: 2067 732e 6c6f 672e 6465 6275 6728 6622   gs.log.debug(f"
-0002e580: 5365 7474 696e 6720 6176 6174 6172 2066  Setting avatar f
-0002e590: 6f72 2075 7365 7220 7b75 7365 725f 6964  or user {user_id
-0002e5a0: 7d20 746f 2055 5249 207b 6176 6174 6172  } to URI {avatar
-0002e5b0: 5f6d 7863 7d2e 2229 0a20 2020 2072 6573  _mxc}.").    res
-0002e5c0: 7020 3d20 6177 6169 7420 636c 6965 6e74  p = await client
-0002e5d0: 2e73 6574 5f61 7661 7461 7228 6176 6174  .set_avatar(avat
-0002e5e0: 6172 5f6d 7863 290a 2020 2020 6966 2069  ar_mxc).    if i
-0002e5f0: 7369 6e73 7461 6e63 6528 7265 7370 2c20  sinstance(resp, 
-0002e600: 5072 6f66 696c 6553 6574 4176 6174 6172  ProfileSetAvatar
-0002e610: 5265 7370 6f6e 7365 293a 0a20 2020 2020  Response):.     
-0002e620: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-0002e630: 0a20 2020 2020 2020 2020 2020 2022 5072  .            "Pr
-0002e640: 6f66 696c 6553 6574 4176 6174 6172 5265  ofileSetAvatarRe
-0002e650: 7370 6f6e 7365 2e20 5265 7370 6f6e 7365  sponse. Response
-0002e660: 2069 733a 2022 0a20 2020 2020 2020 2020   is: ".         
-0002e670: 2020 2066 227b 7072 6976 6163 795f 6669     f"{privacy_fi
-0002e680: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
-0002e690: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
-0002e6a0: 2020 2020 6773 2e6c 6f67 2e69 6e66 6f28      gs.log.info(
-0002e6b0: 0a20 2020 2020 2020 2020 2020 2066 2253  .            f"S
-0002e6c0: 7563 6365 7373 6675 6c6c 7920 7365 7420  uccessfully set 
-0002e6d0: 6176 6174 6172 2066 6f72 2075 7365 7220  avatar for user 
-0002e6e0: 7b75 7365 725f 6964 7d20 220a 2020 2020  {user_id} ".    
-0002e6f0: 2020 2020 2020 2020 6622 746f 2055 5249          f"to URI
-0002e700: 207b 6176 6174 6172 5f6d 7863 7d2e 220a   {avatar_mxc}.".
-0002e710: 2020 2020 2020 2020 290a 2020 2020 656c          ).    el
-0002e720: 7365 3a0a 2020 2020 2020 2020 6773 2e6c  se:.        gs.l
-0002e730: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
-0002e740: 2020 2020 2020 2245 3139 353a 2022 0a20        "E195: ". 
-0002e750: 2020 2020 2020 2020 2020 2066 2246 6169             f"Fai
-0002e760: 6c65 6420 7365 7474 696e 6720 6176 6174  led setting avat
-0002e770: 6172 2066 6f72 2075 7365 7220 7b75 7365  ar for user {use
-0002e780: 725f 6964 7d20 6f6e 2073 6572 7665 722e  r_id} on server.
-0002e790: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
-0002e7a0: 227b 7072 6976 6163 795f 6669 6c74 6572  "{privacy_filter
-0002e7b0: 2873 7472 2872 6573 7029 297d 220a 2020  (str(resp))}".  
-0002e7c0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0002e7d0: 6773 2e65 7272 5f63 6f75 6e74 202b 3d20  gs.err_count += 
-0002e7e0: 310a 0a0a 6173 796e 6320 6465 6620 6163  1...async def ac
-0002e7f0: 7469 6f6e 5f69 6d70 6f72 745f 6b65 7973  tion_import_keys
-0002e800: 2863 6c69 656e 743a 2041 7379 6e63 436c  (client: AsyncCl
-0002e810: 6965 6e74 2c20 6372 6564 656e 7469 616c  ient, credential
-0002e820: 733a 2064 6963 7429 202d 3e20 4e6f 6e65  s: dict) -> None
-0002e830: 3a0a 2020 2020 2222 2249 6d70 6f72 7420  :.    """Import 
-0002e840: 4d65 676f 6c6d 206b 6579 7320 6672 6f6d  Megolm keys from
-0002e850: 2066 696c 6520 7768 696c 6520 616c 7265   file while alre
-0002e860: 6164 7920 6c6f 6767 6564 2069 6e2e 2222  ady logged in.""
-0002e870: 220a 2020 2020 6669 6c65 203d 2067 732e  ".    file = gs.
-0002e880: 7061 2e69 6d70 6f72 745f 6b65 7973 5b30  pa.import_keys[0
-0002e890: 5d0a 2020 2020 7061 7373 7068 7261 7365  ].    passphrase
-0002e8a0: 203d 2067 732e 7061 2e69 6d70 6f72 745f   = gs.pa.import_
-0002e8b0: 6b65 7973 5b31 5d0a 2020 2020 6773 2e6c  keys[1].    gs.l
-0002e8c0: 6f67 2e64 6562 7567 2866 2249 6d70 6f72  og.debug(f"Impor
-0002e8d0: 7469 6e67 206b 6579 7320 6672 6f6d 2066  ting keys from f
-0002e8e0: 696c 6520 7b66 696c 657d 2075 7369 6e67  ile {file} using
-0002e8f0: 2061 2070 6173 7370 6872 6173 652e 2229   a passphrase.")
-0002e900: 0a20 2020 2072 6573 7020 3d20 6177 6169  .    resp = awai
-0002e910: 7420 636c 6965 6e74 2e69 6d70 6f72 745f  t client.import_
-0002e920: 6b65 7973 2866 696c 652c 2070 6173 7370  keys(file, passp
-0002e930: 6872 6173 6529 0a20 2020 2069 6620 6973  hrase).    if is
-0002e940: 696e 7374 616e 6365 2872 6573 702c 2045  instance(resp, E
-0002e950: 6e63 7279 7074 696f 6e45 7272 6f72 293a  ncryptionError):
-0002e960: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
-0002e970: 6572 726f 7228 0a20 2020 2020 2020 2020  error(.         
-0002e980: 2020 2022 4531 3936 3a20 220a 2020 2020     "E196: ".    
-0002e990: 2020 2020 2020 2020 6622 4661 696c 6564          f"Failed
-0002e9a0: 2074 6f20 6465 6372 7970 7420 6b65 7973   to decrypt keys
-0002e9b0: 2066 696c 652e 2046 696c 6520 7b66 696c   file. File {fil
-0002e9c0: 657d 2069 7320 696e 7661 6c69 6420 6f72  e} is invalid or
-0002e9d0: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
-0002e9e0: 2263 6f75 6c64 6ee2 8099 7420 6265 2064  "couldn...t be d
-0002e9f0: 6563 7279 7074 6564 2e20 7b70 7269 7661  ecrypted. {priva
-0002ea00: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
-0002ea10: 7370 2929 7d22 0a20 2020 2020 2020 2029  sp))}".        )
-0002ea20: 0a20 2020 2020 2020 2067 732e 6572 725f  .        gs.err_
-0002ea30: 636f 756e 7420 2b3d 2031 0a20 2020 2065  count += 1.    e
-0002ea40: 6c73 653a 0a20 2020 2020 2020 2067 732e  lse:.        gs.
-0002ea50: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
-0002ea60: 2020 2020 2020 2066 2269 6d70 6f72 745f         f"import_
-0002ea70: 6b65 7973 2073 7563 6365 7373 6675 6c2e  keys successful.
-0002ea80: 2052 6573 706f 6e73 6520 6973 3a20 7b70   Response is: {p
-0002ea90: 7269 7661 6379 5f66 696c 7465 7228 7374  rivacy_filter(st
-0002eaa0: 7228 7265 7370 2929 7d22 0a20 2020 2020  r(resp))}".     
-0002eab0: 2020 2029 0a20 2020 2020 2020 2067 732e     ).        gs.
-0002eac0: 6c6f 672e 696e 666f 2866 2253 7563 6365  log.info(f"Succe
-0002ead0: 7373 6675 6c6c 7920 696d 706f 7274 6564  ssfully imported
-0002eae0: 206b 6579 7320 6672 6f6d 2066 696c 6520   keys from file 
-0002eaf0: 7b66 696c 657d 2e22 290a 0a0a 6173 796e  {file}.")...asyn
-0002eb00: 6320 6465 6620 6163 7469 6f6e 5f65 7870  c def action_exp
-0002eb10: 6f72 745f 6b65 7973 2863 6c69 656e 743a  ort_keys(client:
-0002eb20: 2041 7379 6e63 436c 6965 6e74 2c20 6372   AsyncClient, cr
-0002eb30: 6564 656e 7469 616c 733a 2064 6963 7429  edentials: dict)
-0002eb40: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2222   -> None:.    ""
-0002eb50: 2245 7870 6f72 7420 4d65 676f 6c6d 206b  "Export Megolm k
-0002eb60: 6579 7320 6672 6f6d 2066 696c 6520 7768  eys from file wh
-0002eb70: 696c 6520 616c 7265 6164 7920 6c6f 6767  ile already logg
-0002eb80: 6564 2069 6e2e 2222 220a 2020 2020 6669  ed in.""".    fi
-0002eb90: 6c65 203d 2067 732e 7061 2e65 7870 6f72  le = gs.pa.expor
-0002eba0: 745f 6b65 7973 5b30 5d0a 2020 2020 7061  t_keys[0].    pa
-0002ebb0: 7373 7068 7261 7365 203d 2067 732e 7061  ssphrase = gs.pa
-0002ebc0: 2e65 7870 6f72 745f 6b65 7973 5b31 5d0a  .export_keys[1].
-0002ebd0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-0002ebe0: 2866 2245 7870 6f72 7469 6e67 206b 6579  (f"Exporting key
-0002ebf0: 7320 746f 2066 696c 6520 7b66 696c 657d  s to file {file}
-0002ec00: 2075 7369 6e67 2061 2070 6173 7370 6872   using a passphr
-0002ec10: 6173 652e 2229 0a20 2020 2074 7279 3a0a  ase.").    try:.
-0002ec20: 2020 2020 2020 2020 7265 7370 203d 2061          resp = a
-0002ec30: 7761 6974 2063 6c69 656e 742e 6578 706f  wait client.expo
-0002ec40: 7274 5f6b 6579 7328 6669 6c65 2c20 7061  rt_keys(file, pa
-0002ec50: 7373 7068 7261 7365 290a 2020 2020 6578  ssphrase).    ex
-0002ec60: 6365 7074 2045 7863 6570 7469 6f6e 3a0a  cept Exception:.
-0002ec70: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
-0002ec80: 7272 6f72 2822 4531 3937 3a20 2220 6622  rror("E197: " f"
-0002ec90: 4661 696c 6564 2074 6f20 6578 706f 7274  Failed to export
-0002eca0: 206b 6579 7320 746f 2066 696c 6520 7b66   keys to file {f
-0002ecb0: 696c 657d 2e22 290a 2020 2020 2020 2020  ile}.").        
-0002ecc0: 7261 6973 650a 2020 2020 6773 2e6c 6f67  raise.    gs.log
-0002ecd0: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-0002ece0: 6622 6578 706f 7274 5f6b 6579 7320 7375  f"export_keys su
-0002ecf0: 6363 6573 7366 756c 2e20 5265 7370 6f6e  ccessful. Respon
-0002ed00: 7365 2069 733a 207b 7072 6976 6163 795f  se is: {privacy_
-0002ed10: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
-0002ed20: 297d 220a 2020 2020 290a 2020 2020 6773  )}".    ).    gs
-0002ed30: 2e6c 6f67 2e69 6e66 6f28 6622 5375 6363  .log.info(f"Succ
-0002ed40: 6573 7366 756c 6c79 2065 7870 6f72 7465  essfully exporte
-0002ed50: 6420 6b65 7973 2074 6f20 6669 6c65 207b  d keys to file {
-0002ed60: 6669 6c65 7d2e 2229 0a0a 0a61 7379 6e63  file}.")...async
-0002ed70: 2064 6566 2061 6374 696f 6e5f 726f 6f6d   def action_room
-0002ed80: 5f73 6574 5f61 6c69 6173 280a 2020 2020  _set_alias(.    
-0002ed90: 636c 6965 6e74 3a20 4173 796e 6343 6c69  client: AsyncCli
-0002eda0: 656e 742c 2063 7265 6465 6e74 6961 6c73  ent, credentials
-0002edb0: 3a20 6469 6374 0a29 202d 3e20 4e6f 6e65  : dict.) -> None
-0002edc0: 3a0a 2020 2020 2222 2241 6464 2061 6c69  :.    """Add ali
-0002edd0: 6173 2865 7329 2074 6f20 726f 6f6d 2873  as(es) to room(s
-0002ede0: 2920 7768 696c 6520 616c 7265 6164 7920  ) while already 
-0002edf0: 6c6f 6767 6564 2069 6e2e 2222 220a 2020  logged in.""".  
-0002ee00: 2020 6966 206c 656e 2867 732e 7061 2e72    if len(gs.pa.r
-0002ee10: 6f6f 6d5f 7365 745f 616c 6961 7329 203d  oom_set_alias) =
-0002ee20: 3d20 313a 2020 2320 7370 6563 6961 6c20  = 1:  # special 
-0002ee30: 6361 7365 0a20 2020 2020 2020 2067 732e  case.        gs.
-0002ee40: 7061 2e72 6f6f 6d5f 7365 745f 616c 6961  pa.room_set_alia
-0002ee50: 732e 6170 7065 6e64 2863 7265 6465 6e74  s.append(credent
-0002ee60: 6961 6c73 5b22 726f 6f6d 5f69 6422 5d29  ials["room_id"])
-0002ee70: 0a20 2020 2069 6620 6e6f 7420 6c65 6e28  .    if not len(
-0002ee80: 6773 2e70 612e 726f 6f6d 5f73 6574 5f61  gs.pa.room_set_a
-0002ee90: 6c69 6173 2920 2520 3220 3d3d 2030 3a0a  lias) % 2 == 0:.
-0002eea0: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
-0002eeb0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-0002eec0: 2020 2245 3139 383a 2022 0a20 2020 2020    "E198: ".     
-0002eed0: 2020 2020 2020 2022 496e 636f 7272 6563         "Incorrec
-0002eee0: 7420 6e75 6d62 6572 206f 6620 6172 6775  t number of argu
-0002eef0: 6d65 6e74 7320 666f 7220 2d2d 726f 6f6d  ments for --room
-0002ef00: 2d73 6574 2d61 6c69 6173 2e20 4172 6775  -set-alias. Argu
-0002ef10: 6d65 6e74 7320 220a 2020 2020 2020 2020  ments ".        
-0002ef20: 2020 2020 226d 7573 7420 6265 2070 6169      "must be pai
-0002ef30: 7273 2c20 692e 652e 206d 756c 7469 706c  rs, i.e. multipl
-0002ef40: 6573 206f 6620 322c 2062 7574 2066 6f75  es of 2, but fou
-0002ef50: 6e64 2022 0a20 2020 2020 2020 2020 2020  nd ".           
-0002ef60: 2066 227b 6c65 6e28 6773 2e70 612e 726f   f"{len(gs.pa.ro
-0002ef70: 6f6d 5f73 6574 5f61 6c69 6173 297d 2061  om_set_alias)} a
-0002ef80: 7267 756d 656e 7473 2e20 3120 6973 2061  rguments. 1 is a
-0002ef90: 6c6c 6f77 6564 2074 6f6f 2e22 0a20 2020  llowed too.".   
-0002efa0: 2020 2020 2029 0a20 2020 2020 2020 2067       ).        g
-0002efb0: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
-0002efc0: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
-0002efd0: 2020 2020 666f 7220 6969 2069 6e20 7261      for ii in ra
-0002efe0: 6e67 6528 6c65 6e28 6773 2e70 612e 726f  nge(len(gs.pa.ro
-0002eff0: 6f6d 5f73 6574 5f61 6c69 6173 2920 2f2f  om_set_alias) //
-0002f000: 2032 293a 0a20 2020 2020 2020 2061 6c69   2):.        ali
-0002f010: 6173 203d 2067 732e 7061 2e72 6f6f 6d5f  as = gs.pa.room_
-0002f020: 7365 745f 616c 6961 735b 6969 202a 2032  set_alias[ii * 2
-0002f030: 202b 2030 5d2e 7374 7269 7028 290a 2020   + 0].strip().  
-0002f040: 2020 2020 2020 726f 6f6d 5f69 6420 3d20        room_id = 
-0002f050: 6773 2e70 612e 726f 6f6d 5f73 6574 5f61  gs.pa.room_set_a
-0002f060: 6c69 6173 5b69 6920 2a20 3220 2b20 315d  lias[ii * 2 + 1]
-0002f070: 0a20 2020 2020 2020 2072 6f6f 6d5f 6964  .        room_id
-0002f080: 203d 2061 7761 6974 206d 6170 5f72 6f6f   = await map_roo
-0002f090: 6d69 6e66 6f5f 746f 5f72 6f6f 6d69 6428  minfo_to_roomid(
-0002f0a0: 636c 6965 6e74 2c20 726f 6f6d 5f69 6429  client, room_id)
-0002f0b0: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
-0002f0c0: 6465 6275 6728 6622 4164 6469 6e67 2061  debug(f"Adding a
-0002f0d0: 6c69 6173 2027 7b61 6c69 6173 7d27 2074  lias '{alias}' t
-0002f0e0: 6f20 726f 6f6d 2027 7b72 6f6f 6d5f 6964  o room '{room_id
-0002f0f0: 7d27 2e22 290a 2020 2020 2020 2020 6966  }'.").        if
-0002f100: 206e 6f74 2069 735f 726f 6f6d 5f61 6c69   not is_room_ali
-0002f110: 6173 2861 6c69 6173 2920 616e 6420 6e6f  as(alias) and no
-0002f120: 7420 6973 5f73 686f 7274 5f72 6f6f 6d5f  t is_short_room_
-0002f130: 616c 6961 7328 616c 6961 7329 3a0a 2020  alias(alias):.  
-0002f140: 2020 2020 2020 2020 2020 2320 6e6f 7420            # not 
-0002f150: 616e 2065 7868 6175 7374 6976 6520 6368  an exhaustive ch
-0002f160: 6563 6b0a 2020 2020 2020 2020 2020 2020  eck.            
-0002f170: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
-0002f180: 2020 2020 2020 2020 2020 2020 2020 2245                "E
-0002f190: 3139 393a 2022 0a20 2020 2020 2020 2020  199: ".         
-0002f1a0: 2020 2020 2020 2066 2249 6e76 616c 6964         f"Invalid
-0002f1b0: 2061 6c69 6173 2027 7b61 6c69 6173 7d27   alias '{alias}'
-0002f1c0: 2e20 5468 6973 2069 7320 6e65 6974 6865  . This is neithe
-0002f1d0: 7220 6120 6675 6c6c 2072 6f6f 6d20 616c  r a full room al
-0002f1e0: 6961 7320 220a 2020 2020 2020 2020 2020  ias ".          
-0002f1f0: 2020 2020 2020 226e 6f72 2061 2073 686f        "nor a sho
-0002f200: 7274 2072 6f6f 6d20 616c 6961 732e 2049  rt room alias. I
-0002f210: 7420 7368 6f75 6c64 2065 6974 6865 7220  t should either 
-0002f220: 6265 2022 0a20 2020 2020 2020 2020 2020  be ".           
-0002f230: 2020 2020 2022 2723 536f 6d65 526f 6f6d       "'#SomeRoom
-0002f240: 416c 6961 733a 6d61 7472 6978 2e65 7861  Alias:matrix.exa
-0002f250: 6d70 6c65 2e63 6f6d 2720 6f72 2022 0a20  mple.com' or ". 
-0002f260: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0002f270: 2723 536f 6d65 526f 6f6d 416c 6961 7327  '#SomeRoomAlias'
-0002f280: 206f 7220 2753 6f6d 6552 6f6f 6d41 6c69   or 'SomeRoomAli
-0002f290: 6173 272e 220a 2020 2020 2020 2020 2020  as'.".          
-0002f2a0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0002f2b0: 6773 2e65 7272 5f63 6f75 6e74 202b 3d20  gs.err_count += 
-0002f2c0: 310a 2020 2020 2020 2020 2020 2020 636f  1.            co
-0002f2d0: 6e74 696e 7565 0a20 2020 2020 2020 2069  ntinue.        i
-0002f2e0: 6620 223a 2220 6e6f 7420 696e 2061 6c69  f ":" not in ali
-0002f2f0: 6173 3a0a 2020 2020 2020 2020 2020 2020  as:.            
-0002f300: 2320 446f 204e 4f54 2075 7365 2073 686f  # Do NOT use sho
-0002f310: 7274 5f72 6f6f 6d5f 616c 6961 735f 746f  rt_room_alias_to
-0002f320: 5f72 6f6f 6d5f 616c 6961 7328 292e 0a20  _room_alias().. 
-0002f330: 2020 2020 2020 2020 2020 2023 2057 6520             # We 
-0002f340: 7761 6e74 2074 6869 7320 746f 2062 6520  want this to be 
-0002f350: 6261 7365 6420 6f6e 2070 726f 7669 6465  based on provide
-0002f360: 6420 726f 6f6d 5f69 6420 6e6f 7420 7468  d room_id not th
-0002f370: 6520 6465 6661 756c 740a 2020 2020 2020  e default.      
-0002f380: 2020 2020 2020 2320 686f 6d65 7365 7276        # homeserv
-0002f390: 6572 210a 2020 2020 2020 2020 2020 2020  er!.            
-0002f3a0: 6966 2061 6c69 6173 5b30 5d20 213d 2022  if alias[0] != "
-0002f3b0: 2322 3a0a 2020 2020 2020 2020 2020 2020  #":.            
-0002f3c0: 2020 2020 616c 6961 7320 3d20 2223 2220      alias = "#" 
-0002f3d0: 2b20 616c 6961 730a 2020 2020 2020 2020  + alias.        
-0002f3e0: 2020 2020 616c 6961 7320 3d20 616c 6961      alias = alia
-0002f3f0: 7320 2b20 223a 2220 2b20 726f 6f6d 5f69  s + ":" + room_i
-0002f400: 642e 7370 6c69 7428 223a 2229 5b31 5d0a  d.split(":")[1].
-0002f410: 2020 2020 2020 2020 7265 7370 203d 2061          resp = a
-0002f420: 7761 6974 2063 6c69 656e 742e 726f 6f6d  wait client.room
-0002f430: 5f70 7574 5f61 6c69 6173 2861 6c69 6173  _put_alias(alias
-0002f440: 2c20 726f 6f6d 5f69 6429 0a20 2020 2020  , room_id).     
-0002f450: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-0002f460: 2872 6573 702c 2052 6f6f 6d50 7574 416c  (resp, RoomPutAl
-0002f470: 6961 7352 6573 706f 6e73 6529 3a0a 2020  iasResponse):.  
-0002f480: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-0002f490: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-0002f4a0: 2020 2020 2020 2020 2272 6f6f 6d5f 7075          "room_pu
-0002f4b0: 745f 616c 6961 7320 7375 6363 6573 7366  t_alias successf
-0002f4c0: 756c 2e20 5265 7370 6f6e 7365 2069 733a  ul. Response is:
-0002f4d0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-0002f4e0: 2020 2066 227b 7072 6976 6163 795f 6669     f"{privacy_fi
-0002f4f0: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
-0002f500: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-0002f510: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
-0002f520: 6f67 2e69 6e66 6f28 0a20 2020 2020 2020  og.info(.       
-0002f530: 2020 2020 2020 2020 2066 2253 7563 6365           f"Succe
-0002f540: 7373 6675 6c6c 7920 6164 6465 6420 616c  ssfully added al
-0002f550: 6961 7320 277b 616c 6961 737d 2720 746f  ias '{alias}' to
-0002f560: 2072 6f6f 6d20 277b 726f 6f6d 5f69 647d   room '{room_id}
-0002f570: 272e 220a 2020 2020 2020 2020 2020 2020  '.".            
-0002f580: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-0002f590: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
-0002f5a0: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
-0002f5b0: 2020 2020 2020 2020 2020 2245 3230 303a            "E200:
-0002f5c0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-0002f5d0: 2020 2066 2246 6169 6c65 6420 746f 2061     f"Failed to a
-0002f5e0: 6464 2061 6c69 6173 2027 7b61 6c69 6173  dd alias '{alias
-0002f5f0: 7d27 2074 6f20 726f 6f6d 2027 7b72 6f6f  }' to room '{roo
-0002f600: 6d5f 6964 7d27 3a20 220a 2020 2020 2020  m_id}': ".      
+00028060: 2020 2020 6669 6c65 2e77 7269 7465 280a      file.write(.
+00028070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028080: 2020 2020 2020 2020 6372 7970 746f 2e61          crypto.a
+00028090: 7474 6163 686d 656e 7473 2e64 6563 7279  ttachments.decry
+000280a0: 7074 5f61 7474 6163 686d 656e 7428 0a20  pt_attachment(. 
+000280b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000280c0: 2020 2020 2020 2020 2020 2072 6573 702e             resp.
+000280d0: 626f 6479 2c0a 2020 2020 2020 2020 2020  body,.          
+000280e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000280f0: 2020 6465 6372 7970 7469 6f6e 5f64 6963    decryption_dic
+00028100: 745b 226b 6579 225d 5b22 6b22 5d2c 0a20  t["key"]["k"],. 
+00028110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028120: 2020 2020 2020 2020 2020 2064 6563 7279             decry
+00028130: 7074 696f 6e5f 6469 6374 5b22 6861 7368  ption_dict["hash
+00028140: 6573 225d 5b22 7368 6132 3536 225d 2c0a  es"]["sha256"],.
+00028150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028160: 2020 2020 2020 2020 2020 2020 6465 6372              decr
+00028170: 7970 7469 6f6e 5f64 6963 745b 2269 7622  yption_dict["iv"
+00028180: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00028190: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+000281a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000281b0: 2029 0a20 2020 2020 2020 2020 2020 2065   ).            e
+000281c0: 6c73 653a 2020 2320 706c 6169 6e2c 2075  lse:  # plain, u
+000281d0: 6e65 6e63 7279 7074 6564 0a20 2020 2020  nencrypted.     
+000281e0: 2020 2020 2020 2020 2020 2077 6974 6820             with 
+000281f0: 6f70 656e 2866 696c 656e 616d 652c 2022  open(filename, "
+00028200: 7762 2229 2061 7320 6669 6c65 3a0a 2020  wb") as file:.  
+00028210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028220: 2020 6669 6c65 2e77 7269 7465 2872 6573    file.write(res
+00028230: 702e 626f 6479 290a 2020 2020 2020 2020  p.body).        
+00028240: 6969 202b 3d20 310a 0a0a 6173 796e 6320  ii += 1...async 
+00028250: 6465 6620 6163 7469 6f6e 5f6a 6f69 6e65  def action_joine
+00028260: 645f 726f 6f6d 7328 636c 6965 6e74 3a20  d_rooms(client: 
+00028270: 4173 796e 6343 6c69 656e 742c 2063 7265  AsyncClient, cre
+00028280: 6465 6e74 6961 6c73 3a20 6469 6374 2920  dentials: dict) 
+00028290: 2d3e 204e 6f6e 653a 0a20 2020 2022 2222  -> None:.    """
+000282a0: 4765 7420 6a6f 696e 6564 2072 6f6f 6d73  Get joined rooms
+000282b0: 2077 6869 6c65 2061 6c72 6561 6479 206c   while already l
+000282c0: 6f67 6765 6420 696e 2e22 2222 0a20 2020  ogged in.""".   
+000282d0: 2072 6573 7020 3d20 6177 6169 7420 636c   resp = await cl
+000282e0: 6965 6e74 2e6a 6f69 6e65 645f 726f 6f6d  ient.joined_room
+000282f0: 7328 290a 2020 2020 6966 2069 7369 6e73  s().    if isins
+00028300: 7461 6e63 6528 7265 7370 2c20 4a6f 696e  tance(resp, Join
+00028310: 6564 526f 6f6d 7345 7272 6f72 293a 0a20  edRoomsError):. 
+00028320: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
+00028330: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+00028340: 2022 4531 3737 3a20 2220 6622 6a6f 696e   "E177: " f"join
+00028350: 6564 5f72 6f6f 6d73 2066 6169 6c65 6420  ed_rooms failed 
+00028360: 7769 7468 207b 7072 6976 6163 795f 6669  with {privacy_fi
+00028370: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
+00028380: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
+00028390: 2020 2020 6773 2e65 7272 5f63 6f75 6e74      gs.err_count
+000283a0: 202b 3d20 310a 2020 2020 656c 7365 3a0a   += 1.    else:.
+000283b0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+000283c0: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
+000283d0: 2020 6622 6a6f 696e 6564 5f72 6f6f 6d73    f"joined_rooms
+000283e0: 2073 7563 6365 7373 6675 6c20 7769 7468   successful with
+000283f0: 207b 7072 6976 6163 795f 6669 6c74 6572   {privacy_filter
+00028400: 2873 7472 2872 6573 7029 297d 220a 2020  (str(resp))}".  
+00028410: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00028420: 2320 6f75 7470 7574 2066 6f72 6d61 7420  # output format 
+00028430: 636f 6e74 726f 6c6c 6564 2076 6961 202d  controlled via -
+00028440: 2d6f 7574 7075 7420 666c 6167 0a20 2020  -output flag.   
+00028450: 2020 2020 2074 6578 7420 3d20 2222 0a20       text = "". 
+00028460: 2020 2020 2020 2066 6f72 2072 7220 696e         for rr in
+00028470: 2072 6573 702e 726f 6f6d 733a 0a20 2020   resp.rooms:.   
+00028480: 2020 2020 2020 2020 2074 6578 7420 2b3d           text +=
+00028490: 2072 7220 2b20 225c 6e22 0a20 2020 2020   rr + "\n".     
+000284a0: 2020 2074 6578 7420 3d20 7465 7874 2e73     text = text.s
+000284b0: 7472 6970 2829 0a20 2020 2020 2020 2023  trip().        #
+000284c0: 204f 626a 6563 7420 6f66 2074 7970 6520   Object of type 
+000284d0: 7878 7852 6573 706f 6e73 6520 6973 206e  xxxResponse is n
+000284e0: 6f74 204a 534f 4e0a 2020 2020 2020 2020  ot JSON.        
+000284f0: 2320 7365 7269 616c 697a 6162 6c65 2c20  # serializable, 
+00028500: 6865 6e63 6520 7765 2075 7365 2074 6865  hence we use the
+00028510: 2064 6963 7469 6f6e 6172 792e 0a20 2020   dictionary..   
+00028520: 2020 2020 206a 736f 6e5f 6d61 7820 3d20       json_max = 
+00028530: 7265 7370 2e5f 5f64 6963 745f 5f0a 2020  resp.__dict__.  
+00028540: 2020 2020 2020 2320 6a73 6f6e 5f6d 6178        # json_max
+00028550: 2e75 7064 6174 6528 7b22 6b65 7922 3a20  .update({"key": 
+00028560: 7661 6c75 657d 2920 2023 2061 6464 2064  value})  # add d
+00028570: 6963 7420 6974 656d 730a 2020 2020 2020  ict items.      
+00028580: 2020 6a73 6f6e 5f20 3d20 6a73 6f6e 5f6d    json_ = json_m
+00028590: 6178 2e63 6f70 7928 290a 2020 2020 2020  ax.copy().      
+000285a0: 2020 6a73 6f6e 5f2e 706f 7028 2274 7261    json_.pop("tra
+000285b0: 6e73 706f 7274 5f72 6573 706f 6e73 6522  nsport_response"
+000285c0: 290a 2020 2020 2020 2020 6a73 6f6e 5f73  ).        json_s
+000285d0: 7065 6320 3d20 4e6f 6e65 0a20 2020 2020  pec = None.     
+000285e0: 2020 2070 7269 6e74 5f6f 7574 7075 7428     print_output(
+000285f0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+00028600: 7061 2e6f 7574 7075 742c 0a20 2020 2020  pa.output,.     
+00028610: 2020 2020 2020 2074 6578 743d 7465 7874         text=text
+00028620: 2c0a 2020 2020 2020 2020 2020 2020 6a73  ,.            js
+00028630: 6f6e 5f3d 6a73 6f6e 5f2c 0a20 2020 2020  on_=json_,.     
+00028640: 2020 2020 2020 206a 736f 6e5f 6d61 783d         json_max=
+00028650: 6a73 6f6e 5f6d 6178 2c0a 2020 2020 2020  json_max,.      
+00028660: 2020 2020 2020 6a73 6f6e 5f73 7065 633d        json_spec=
+00028670: 6a73 6f6e 5f73 7065 632c 0a20 2020 2020  json_spec,.     
+00028680: 2020 2029 0a0a 0a61 7379 6e63 2064 6566     )...async def
+00028690: 2061 6374 696f 6e5f 6a6f 696e 6564 5f6d   action_joined_m
+000286a0: 656d 6265 7273 280a 2020 2020 636c 6965  embers(.    clie
+000286b0: 6e74 3a20 4173 796e 6343 6c69 656e 742c  nt: AsyncClient,
+000286c0: 2063 7265 6465 6e74 6961 6c73 3a20 6469   credentials: di
+000286d0: 6374 0a29 202d 3e20 4e6f 6e65 3a0a 2020  ct.) -> None:.  
+000286e0: 2020 2222 2247 6574 206d 656d 6265 7273    """Get members
+000286f0: 206f 6620 6769 7665 6e20 726f 6f6d 7320   of given rooms 
+00028700: 7768 696c 6520 616c 7265 6164 7920 6265  while already be
+00028710: 696e 6720 6c6f 6767 6564 2069 6e2e 2222  ing logged in.""
+00028720: 220a 2020 2020 726f 6f6d 7320 3d20 6773  ".    rooms = gs
+00028730: 2e70 612e 6a6f 696e 6564 5f6d 656d 6265  .pa.joined_membe
+00028740: 7273 0a20 2020 2069 6620 6e6f 7420 726f  rs.    if not ro
+00028750: 6f6d 733a 0a20 2020 2020 2020 2067 732e  oms:.        gs.
+00028760: 6c6f 672e 7761 726e 696e 6728 0a20 2020  log.warning(.   
+00028770: 2020 2020 2020 2020 2022 5731 3037 3a20           "W107: 
+00028780: 220a 2020 2020 2020 2020 2020 2020 224e  ".            "N
+00028790: 6f20 6d65 6d62 6572 7368 6970 2061 6374  o membership act
+000287a0: 696f 6e28 7329 2077 6572 6520 7065 7266  ion(s) were perf
+000287b0: 6f72 6d65 6420 6265 6361 7573 6520 6e6f  ormed because no
+000287c0: 2072 6f6f 6d73 2022 0a20 2020 2020 2020   rooms ".       
+000287d0: 2020 2020 2022 7765 7265 2073 7065 6369       "were speci
+000287e0: 6669 6564 2e20 5573 6520 2d2d 6a6f 696e  fied. Use --join
+000287f0: 6564 2d6d 656d 6265 7273 206f 7074 696f  ed-members optio
+00028800: 6e20 616e 6420 7370 6563 6966 7920 726f  n and specify ro
+00028810: 6f6d 732e 220a 2020 2020 2020 2020 290a  oms.".        ).
+00028820: 2020 2020 2020 2020 6773 2e77 6172 6e5f          gs.warn_
+00028830: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
+00028840: 2020 2072 6574 7572 6e0a 0a20 2020 2067     return..    g
+00028850: 732e 6c6f 672e 6465 6275 6728 6622 5472  s.log.debug(f"Tr
+00028860: 7969 6e67 2074 6f20 6765 7420 6d65 6d62  ying to get memb
+00028870: 6572 7320 666f 7220 7468 6573 6520 726f  ers for these ro
+00028880: 6f6d 733a 207b 726f 6f6d 737d 2229 0a20  oms: {rooms}"). 
+00028890: 2020 2069 6620 222a 2220 696e 2072 6f6f     if "*" in roo
+000288a0: 6d73 3a0a 2020 2020 2020 2020 7265 7370  ms:.        resp
+000288b0: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+000288c0: 6a6f 696e 6564 5f72 6f6f 6d73 2829 0a20  joined_rooms(). 
+000288d0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+000288e0: 616e 6365 2872 6573 702c 204a 6f69 6e65  ance(resp, Joine
+000288f0: 6452 6f6f 6d73 4572 726f 7229 3a0a 2020  dRoomsError):.  
+00028900: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
+00028910: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
+00028920: 2020 2020 2020 2020 2245 3137 383a 2022          "E178: "
+00028930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028940: 2022 6a6f 696e 6564 5f72 6f6f 6d73 2066   "joined_rooms f
+00028950: 6169 6c65 6420 7769 7468 2022 0a20 2020  ailed with ".   
+00028960: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
+00028970: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
+00028980: 7472 2872 6573 7029 297d 2e20 4e6f 7420  tr(resp))}. Not 
+00028990: 6162 6c65 2074 6f20 220a 2020 2020 2020  able to ".      
+000289a0: 2020 2020 2020 2020 2020 2267 6574 2061            "get a
+000289b0: 6c6c 2072 6f6f 6d73 2061 7320 7370 6563  ll rooms as spec
+000289c0: 6966 6965 6420 6279 2027 2a27 2e20 220a  ified by '*'. ".
+000289d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000289e0: 2254 6865 206d 656d 6265 7220 6c69 7374  "The member list
+000289f0: 696e 6720 7769 6c6c 2062 6520 696e 636f  ing will be inco
+00028a00: 6d70 6c65 7465 206f 7220 6d69 7373 696e  mplete or missin
+00028a10: 672e 220a 2020 2020 2020 2020 2020 2020  g.".            
+00028a20: 290a 2020 2020 2020 2020 2020 2020 6773  ).            gs
+00028a30: 2e65 7272 5f63 6f75 6e74 202b 3d20 310a  .err_count += 1.
+00028a40: 2020 2020 2020 2020 2020 2020 2320 7369              # si
+00028a50: 6e63 6520 7765 2063 616e 2774 2067 6574  nce we can't get
+00028a60: 2061 6c6c 2072 6f6f 6d73 206c 6561 7665   all rooms leave
+00028a70: 2072 6f6f 6d20 6c69 7374 2061 7320 6973   room list as is
+00028a80: 0a20 2020 2020 2020 2020 2020 2072 6f6f  .            roo
+00028a90: 6d73 203d 2066 696c 7465 7228 6c61 6d62  ms = filter(lamb
+00028aa0: 6461 2076 616c 3a20 7661 6c20 213d 2022  da val: val != "
+00028ab0: 2a22 2c20 726f 6f6d 7329 2020 2320 7265  *", rooms)  # re
+00028ac0: 6d6f 7665 2061 6c6c 202a 0a20 2020 2020  move all *.     
+00028ad0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00028ae0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
+00028af0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+00028b00: 2020 2066 226a 6f69 6e65 645f 726f 6f6d     f"joined_room
+00028b10: 7320 7375 6363 6573 7366 756c 2077 6974  s successful wit
+00028b20: 6820 7b70 7269 7661 6379 5f66 696c 7465  h {privacy_filte
+00028b30: 7228 7374 7228 7265 7370 2929 7d22 0a20  r(str(resp))}". 
+00028b40: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00028b50: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
+00028b60: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
+00028b70: 2020 2020 2020 2022 526f 6f6d 206c 6973         "Room lis
+00028b80: 7420 6861 7320 6265 656e 2073 7563 6365  t has been succe
+00028b90: 7373 6675 6c6c 7920 6f76 6572 7772 6974  ssfully overwrit
+00028ba0: 7465 6e20 7769 7468 2027 2a27 220a 2020  ten with '*'".  
+00028bb0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00028bc0: 2020 2020 2020 2020 726f 6f6d 7320 3d20          rooms = 
+00028bd0: 7265 7370 2e72 6f6f 6d73 2020 2320 6f76  resp.rooms  # ov
+00028be0: 6572 7772 6974 6520 6172 6773 2077 6974  erwrite args wit
+00028bf0: 6820 6675 6c6c 206c 6973 740a 2020 2020  h full list.    
+00028c00: 666f 7220 726f 6f6d 2069 6e20 726f 6f6d  for room in room
+00028c10: 733a 0a20 2020 2020 2020 2072 6f6f 6d20  s:.        room 
+00028c20: 3d20 726f 6f6d 2e72 6570 6c61 6365 2872  = room.replace(r
+00028c30: 225c 2122 2c20 2221 2229 2020 2320 7265  "\!", "!")  # re
+00028c40: 6d6f 7665 2070 6f73 7369 626c 6520 6573  move possible es
+00028c50: 6361 7065 0a20 2020 2020 2020 2072 6573  cape.        res
+00028c60: 7020 3d20 6177 6169 7420 636c 6965 6e74  p = await client
+00028c70: 2e6a 6f69 6e65 645f 6d65 6d62 6572 7328  .joined_members(
+00028c80: 726f 6f6d 290a 2020 2020 2020 2020 6966  room).        if
+00028c90: 2069 7369 6e73 7461 6e63 6528 7265 7370   isinstance(resp
+00028ca0: 2c20 4a6f 696e 6564 4d65 6d62 6572 7345  , JoinedMembersE
+00028cb0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+00028cc0: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
+00028cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028ce0: 2022 4531 3739 3a20 220a 2020 2020 2020   "E179: ".      
+00028cf0: 2020 2020 2020 2020 2020 6622 6a6f 696e            f"join
+00028d00: 6564 5f6d 656d 6265 7273 2066 6169 6c65  ed_members faile
+00028d10: 6420 7769 7468 207b 7072 6976 6163 795f  d with {privacy_
+00028d20: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
+00028d30: 297d 220a 2020 2020 2020 2020 2020 2020  )}".            
+00028d40: 290a 2020 2020 2020 2020 2020 2020 6773  ).            gs
+00028d50: 2e65 7272 5f63 6f75 6e74 202b 3d20 310a  .err_count += 1.
+00028d60: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00028d70: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
+00028d80: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+00028d90: 2020 2020 2020 2020 6622 6a6f 696e 6564          f"joined
+00028da0: 5f6d 656d 6265 7273 2073 7563 6365 7373  _members success
+00028db0: 6675 6c20 7769 7468 207b 7072 6976 6163  ful with {privac
+00028dc0: 795f 6669 6c74 6572 2873 7472 2872 6573  y_filter(str(res
+00028dd0: 7029 297d 220a 2020 2020 2020 2020 2020  p))}".          
+00028de0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00028df0: 2320 6d65 6d62 6572 7320 3d20 4c69 7374  # members = List
+00028e00: 5b52 6f6f 6d4d 656d 6265 725d 203b 2052  [RoomMember] ; R
+00028e10: 6f6f 6d4d 656d 6265 720a 2020 2020 2020  oomMember.      
+00028e20: 2020 2020 2020 2320 6f75 7470 7574 2066        # output f
+00028e30: 6f72 6d61 7420 636f 6e74 726f 6c6c 6564  ormat controlled
+00028e40: 2076 6961 202d 2d6f 7574 7075 7420 666c   via --output fl
+00028e50: 6167 0a20 2020 2020 2020 2020 2020 2074  ag.            t
+00028e60: 6578 7420 3d20 7265 7370 2e72 6f6f 6d5f  ext = resp.room_
+00028e70: 6964 202b 2022 5c6e 220a 2020 2020 2020  id + "\n".      
+00028e80: 2020 2020 2020 666f 7220 6d65 6d62 6572        for member
+00028e90: 2069 6e20 7265 7370 2e6d 656d 6265 7273   in resp.members
+00028ea0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00028eb0: 2020 2320 636f 6e76 6572 7420 4e6f 6e65    # convert None
+00028ec0: 2074 6f20 2727 0a20 2020 2020 2020 2020   to ''.         
+00028ed0: 2020 2020 2020 2074 6578 7420 2b3d 2028         text += (
+00028ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028ef0: 2020 2020 2053 4550 0a20 2020 2020 2020       SEP.       
+00028f00: 2020 2020 2020 2020 2020 2020 202b 206d               + m
+00028f10: 656d 6265 722e 7573 6572 5f69 640a 2020  ember.user_id.  
+00028f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028f30: 2020 2b20 5345 500a 2020 2020 2020 2020    + SEP.        
+00028f40: 2020 2020 2020 2020 2020 2020 2b20 7a6e              + zn
+00028f50: 286d 656d 6265 722e 6469 7370 6c61 795f  (member.display_
+00028f60: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
+00028f70: 2020 2020 2020 2020 2020 2b20 5345 500a            + SEP.
+00028f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028f90: 2020 2020 2b20 7a6e 286d 656d 6265 722e      + zn(member.
+00028fa0: 6176 6174 6172 5f75 726c 290a 2020 2020  avatar_url).    
+00028fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028fc0: 2b20 225c 6e22 0a20 2020 2020 2020 2020  + "\n".         
+00028fd0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00028fe0: 2020 2020 2074 6578 7420 3d20 7465 7874       text = text
+00028ff0: 2e73 7472 6970 2829 0a20 2020 2020 2020  .strip().       
+00029000: 2020 2020 2023 204f 626a 6563 7420 6f66       # Object of
+00029010: 2074 7970 6520 7878 7852 6573 706f 6e73   type xxxRespons
+00029020: 6520 6973 206e 6f74 204a 534f 4e0a 2020  e is not JSON.  
+00029030: 2020 2020 2020 2020 2020 2320 7365 7269            # seri
+00029040: 616c 697a 6162 6c65 2c20 6865 6e63 6520  alizable, hence 
+00029050: 7765 2075 7365 2074 6865 2064 6963 7469  we use the dicti
+00029060: 6f6e 6172 792e 0a20 2020 2020 2020 2020  onary..         
+00029070: 2020 206a 736f 6e5f 6d61 7820 3d20 7265     json_max = re
+00029080: 7370 2e5f 5f64 6963 745f 5f0a 2020 2020  sp.__dict__.    
+00029090: 2020 2020 2020 2020 2320 6a73 6f6e 5f6d          # json_m
+000290a0: 6178 2e75 7064 6174 6528 7b22 6b65 7922  ax.update({"key"
+000290b0: 3a20 7661 6c75 657d 2920 2023 2061 6464  : value})  # add
+000290c0: 2064 6963 7420 6974 656d 730a 2020 2020   dict items.    
+000290d0: 2020 2020 2020 2020 6a73 6f6e 5f20 3d20          json_ = 
+000290e0: 6a73 6f6e 5f6d 6178 2e63 6f70 7928 290a  json_max.copy().
+000290f0: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+00029100: 5f2e 706f 7028 2274 7261 6e73 706f 7274  _.pop("transport
+00029110: 5f72 6573 706f 6e73 6522 290a 2020 2020  _response").    
+00029120: 2020 2020 2020 2020 6a73 6f6e 5f73 7065          json_spe
+00029130: 6320 3d20 4e6f 6e65 0a20 2020 2020 2020  c = None.       
+00029140: 2020 2020 2070 7269 6e74 5f6f 7574 7075       print_outpu
+00029150: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+00029160: 2020 2067 732e 7061 2e6f 7574 7075 742c     gs.pa.output,
+00029170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029180: 2074 6578 743d 7465 7874 2c0a 2020 2020   text=text,.    
+00029190: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+000291a0: 5f3d 6a73 6f6e 5f2c 0a20 2020 2020 2020  _=json_,.       
+000291b0: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
+000291c0: 783d 6a73 6f6e 5f6d 6178 2c0a 2020 2020  x=json_max,.    
+000291d0: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+000291e0: 5f73 7065 633d 6a73 6f6e 5f73 7065 632c  _spec=json_spec,
+000291f0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+00029200: 0a61 7379 6e63 2064 6566 2061 6374 696f  .async def actio
+00029210: 6e5f 6d78 635f 746f 5f68 7474 7028 636c  n_mxc_to_http(cl
+00029220: 6965 6e74 3a20 4173 796e 6343 6c69 656e  ient: AsyncClien
+00029230: 742c 2063 7265 6465 6e74 6961 6c73 3a20  t, credentials: 
+00029240: 6469 6374 2920 2d3e 204e 6f6e 653a 0a20  dict) -> None:. 
+00029250: 2020 2022 2222 436f 6e76 6572 7420 4d58     """Convert MX
+00029260: 4320 5552 4920 746f 2048 5454 5020 5552  C URI to HTTP UR
+00029270: 4c20 7768 696c 6520 616c 7265 6164 7920  L while already 
+00029280: 6c6f 6767 6564 2069 6e2e 2222 220a 2020  logged in.""".  
+00029290: 2020 666f 7220 6d78 6320 696e 2067 732e    for mxc in gs.
+000292a0: 7061 2e6d 7863 5f74 6f5f 6874 7470 3a0a  pa.mxc_to_http:.
+000292b0: 2020 2020 2020 2020 6d78 6320 3d20 6d78          mxc = mx
+000292c0: 632e 7374 7269 7028 290a 2020 2020 2020  c.strip().      
+000292d0: 2020 6874 7470 203d 2061 7761 6974 2063    http = await c
+000292e0: 6c69 656e 742e 6d78 635f 746f 5f68 7474  lient.mxc_to_htt
+000292f0: 7028 6d78 6329 2020 2320 7265 7475 726e  p(mxc)  # return
+00029300: 7320 4e6f 6e65 206f 7220 7374 720a 2020  s None or str.  
+00029310: 2020 2020 2020 2320 6f75 7470 7574 2066        # output f
+00029320: 6f72 6d61 7420 636f 6e74 726f 6c6c 6564  ormat controlled
+00029330: 2076 6961 202d 2d6f 7574 7075 7420 666c   via --output fl
+00029340: 6167 0a20 2020 2020 2020 2074 6578 7420  ag.        text 
+00029350: 3d20 6622 7b6d 7863 7d7b 5345 507d 7b68  = f"{mxc}{SEP}{h
+00029360: 7474 707d 220a 2020 2020 2020 2020 6a73  ttp}".        js
+00029370: 6f6e 5f6d 6178 203d 207b 226d 7863 223a  on_max = {"mxc":
+00029380: 206d 7863 2c20 2268 7474 7022 3a20 6874   mxc, "http": ht
+00029390: 7470 7d0a 2020 2020 2020 2020 2320 6a73  tp}.        # js
+000293a0: 6f6e 5f6d 6178 2e75 7064 6174 6528 7b22  on_max.update({"
+000293b0: 6b65 7922 3a20 7661 6c75 657d 2920 2023  key": value})  #
+000293c0: 2061 6464 2064 6963 7420 6974 656d 730a   add dict items.
+000293d0: 2020 2020 2020 2020 6a73 6f6e 5f20 3d20          json_ = 
+000293e0: 6a73 6f6e 5f6d 6178 2e63 6f70 7928 290a  json_max.copy().
+000293f0: 2020 2020 2020 2020 2320 6a73 6f6e 5f2e          # json_.
+00029400: 706f 7028 226b 6579 2229 0a20 2020 2020  pop("key").     
+00029410: 2020 206a 736f 6e5f 7370 6563 203d 204e     json_spec = N
+00029420: 6f6e 650a 2020 2020 2020 2020 7072 696e  one.        prin
+00029430: 745f 6f75 7470 7574 280a 2020 2020 2020  t_output(.      
+00029440: 2020 2020 2020 6773 2e70 612e 6f75 7470        gs.pa.outp
+00029450: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
+00029460: 7465 7874 3d74 6578 742c 0a20 2020 2020  text=text,.     
+00029470: 2020 2020 2020 206a 736f 6e5f 3d6a 736f         json_=jso
+00029480: 6e5f 2c0a 2020 2020 2020 2020 2020 2020  n_,.            
+00029490: 6a73 6f6e 5f6d 6178 3d6a 736f 6e5f 6d61  json_max=json_ma
+000294a0: 782c 0a20 2020 2020 2020 2020 2020 206a  x,.            j
+000294b0: 736f 6e5f 7370 6563 3d6a 736f 6e5f 7370  son_spec=json_sp
+000294c0: 6563 2c0a 2020 2020 2020 2020 290a 0a0a  ec,.        )...
+000294d0: 6173 796e 6320 6465 6620 6163 7469 6f6e  async def action
+000294e0: 5f64 6576 6963 6573 2863 6c69 656e 743a  _devices(client:
+000294f0: 2041 7379 6e63 436c 6965 6e74 2c20 6372   AsyncClient, cr
+00029500: 6564 656e 7469 616c 733a 2064 6963 7429  edentials: dict)
+00029510: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2222   -> None:.    ""
+00029520: 224c 6973 7420 6465 7669 6365 7320 6f66  "List devices of
+00029530: 2061 6363 6f75 6e74 2077 6869 6c65 2061   account while a
+00029540: 6c72 6561 6479 206c 6f67 6765 6420 696e  lready logged in
+00029550: 2e22 2222 0a20 2020 2072 6573 7020 3d20  .""".    resp = 
+00029560: 6177 6169 7420 636c 6965 6e74 2e64 6576  await client.dev
+00029570: 6963 6573 2829 0a20 2020 2069 6620 6973  ices().    if is
+00029580: 696e 7374 616e 6365 2872 6573 702c 2044  instance(resp, D
+00029590: 6576 6963 6573 4572 726f 7229 3a0a 2020  evicesError):.  
+000295a0: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
+000295b0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+000295c0: 2245 3138 303a 2022 2066 2264 6576 6963  "E180: " f"devic
+000295d0: 6573 2066 6169 6c65 6420 7769 7468 207b  es failed with {
+000295e0: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
+000295f0: 7472 2872 6573 7029 297d 220a 2020 2020  tr(resp))}".    
+00029600: 2020 2020 290a 2020 2020 2020 2020 6773      ).        gs
+00029610: 2e65 7272 5f63 6f75 6e74 202b 3d20 310a  .err_count += 1.
+00029620: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00029630: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
+00029640: 2264 6576 6963 6573 2073 7563 6365 7373  "devices success
+00029650: 6675 6c20 7769 7468 207b 7072 6976 6163  ful with {privac
+00029660: 795f 6669 6c74 6572 2873 7472 2872 6573  y_filter(str(res
+00029670: 7029 297d 2229 0a20 2020 2020 2020 2023  p))}").        #
+00029680: 206f 7574 7075 7420 666f 726d 6174 2063   output format c
+00029690: 6f6e 7472 6f6c 6c65 6420 7669 6120 2d2d  ontrolled via --
+000296a0: 6f75 7470 7574 2066 6c61 670a 2020 2020  output flag.    
+000296b0: 2020 2020 7465 7874 203d 2022 220a 2020      text = "".  
+000296c0: 2020 2020 2020 666f 7220 7272 2069 6e20        for rr in 
+000296d0: 7265 7370 2e64 6576 6963 6573 3a0a 2020  resp.devices:.  
+000296e0: 2020 2020 2020 2020 2020 7465 7874 202b            text +
+000296f0: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+00029700: 2020 2020 7272 2e69 640a 2020 2020 2020      rr.id.      
+00029710: 2020 2020 2020 2020 2020 2b20 5345 500a            + SEP.
+00029720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029730: 2b20 7272 2e64 6973 706c 6179 5f6e 616d  + rr.display_nam
+00029740: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00029750: 2020 2b20 5345 500a 2020 2020 2020 2020    + SEP.        
+00029760: 2020 2020 2020 2020 2b20 7272 2e6c 6173          + rr.las
+00029770: 745f 7365 656e 5f69 700a 2020 2020 2020  t_seen_ip.      
+00029780: 2020 2020 2020 2020 2020 2b20 5345 500a            + SEP.
+00029790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000297a0: 2b20 7374 7228 7272 2e6c 6173 745f 7365  + str(rr.last_se
+000297b0: 656e 5f64 6174 6529 0a20 2020 2020 2020  en_date).       
+000297c0: 2020 2020 2020 2020 202b 2022 5c6e 220a           + "\n".
+000297d0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+000297e0: 2020 2020 2020 7465 7874 203d 2074 6578        text = tex
+000297f0: 742e 7374 7269 7028 290a 2020 2020 2020  t.strip().      
+00029800: 2020 2320 4f62 6a65 6374 206f 6620 7479    # Object of ty
+00029810: 7065 2078 7878 5265 7370 6f6e 7365 2069  pe xxxResponse i
+00029820: 7320 6e6f 7420 4a53 4f4e 0a20 2020 2020  s not JSON.     
+00029830: 2020 2023 2073 6572 6961 6c69 7a61 626c     # serializabl
+00029840: 652c 2068 656e 6365 2077 6520 7573 6520  e, hence we use 
+00029850: 7468 6520 6469 6374 696f 6e61 7279 2e0a  the dictionary..
+00029860: 2020 2020 2020 2020 6a73 6f6e 5f6d 6178          json_max
+00029870: 203d 2072 6573 702e 5f5f 6469 6374 5f5f   = resp.__dict__
+00029880: 0a20 2020 2020 2020 2023 206a 736f 6e5f  .        # json_
+00029890: 6d61 782e 7570 6461 7465 287b 226b 6579  max.update({"key
+000298a0: 223a 2076 616c 7565 7d29 2020 2320 6164  ": value})  # ad
+000298b0: 6420 6469 6374 2069 7465 6d73 0a20 2020  d dict items.   
+000298c0: 2020 2020 206a 736f 6e5f 203d 206a 736f       json_ = jso
+000298d0: 6e5f 6d61 782e 636f 7079 2829 0a20 2020  n_max.copy().   
+000298e0: 2020 2020 206a 736f 6e5f 2e70 6f70 2822       json_.pop("
+000298f0: 7472 616e 7370 6f72 745f 7265 7370 6f6e  transport_respon
+00029900: 7365 2229 0a20 2020 2020 2020 206a 736f  se").        jso
+00029910: 6e5f 7370 6563 203d 204e 6f6e 650a 2020  n_spec = None.  
+00029920: 2020 2020 2020 7072 696e 745f 6f75 7470        print_outp
+00029930: 7574 280a 2020 2020 2020 2020 2020 2020  ut(.            
+00029940: 6773 2e70 612e 6f75 7470 7574 2c0a 2020  gs.pa.output,.  
+00029950: 2020 2020 2020 2020 2020 7465 7874 3d74            text=t
+00029960: 6578 742c 0a20 2020 2020 2020 2020 2020  ext,.           
+00029970: 206a 736f 6e5f 3d6a 736f 6e5f 2c0a 2020   json_=json_,.  
+00029980: 2020 2020 2020 2020 2020 6a73 6f6e 5f6d            json_m
+00029990: 6178 3d6a 736f 6e5f 6d61 782c 0a20 2020  ax=json_max,.   
+000299a0: 2020 2020 2020 2020 206a 736f 6e5f 7370           json_sp
+000299b0: 6563 3d6a 736f 6e5f 7370 6563 2c0a 2020  ec=json_spec,.  
+000299c0: 2020 2020 2020 290a 0a0a 6173 796e 6320        )...async 
+000299d0: 6465 6620 6163 7469 6f6e 5f64 6973 636f  def action_disco
+000299e0: 7665 7279 5f69 6e66 6f28 0a20 2020 2063  very_info(.    c
+000299f0: 6c69 656e 743a 2041 7379 6e63 436c 6965  lient: AsyncClie
+00029a00: 6e74 2c20 6372 6564 656e 7469 616c 733a  nt, credentials:
+00029a10: 2064 6963 740a 2920 2d3e 204e 6f6e 653a   dict.) -> None:
+00029a20: 0a20 2020 2022 2222 4c69 7374 2064 6973  .    """List dis
+00029a30: 636f 7665 7279 5f69 6e66 6f20 6f66 2068  covery_info of h
+00029a40: 6f6d 6520 7365 7276 6572 2077 6869 6c65  ome server while
+00029a50: 2061 6c72 6561 6479 206c 6f67 6765 6420   already logged 
+00029a60: 696e 2e22 2222 0a20 2020 2072 6573 7020  in.""".    resp 
+00029a70: 3d20 6177 6169 7420 636c 6965 6e74 2e64  = await client.d
+00029a80: 6973 636f 7665 7279 5f69 6e66 6f28 290a  iscovery_info().
+00029a90: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00029aa0: 6528 7265 7370 2c20 4469 7363 6f76 6572  e(resp, Discover
+00029ab0: 7949 6e66 6f45 7272 6f72 293a 0a20 2020  yInfoError):.   
+00029ac0: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
+00029ad0: 7228 0a20 2020 2020 2020 2020 2020 2022  r(.            "
+00029ae0: 4531 3831 3a20 2220 6622 6469 7363 6f76  E181: " f"discov
+00029af0: 6572 795f 696e 666f 2066 6169 6c65 6420  ery_info failed 
+00029b00: 7769 7468 207b 7072 6976 6163 795f 6669  with {privacy_fi
+00029b10: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
+00029b20: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
+00029b30: 2020 2020 6773 2e65 7272 5f63 6f75 6e74      gs.err_count
+00029b40: 202b 3d20 310a 2020 2020 656c 7365 3a0a   += 1.    else:.
+00029b50: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+00029b60: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
+00029b70: 2020 6622 6469 7363 6f76 6572 795f 696e    f"discovery_in
+00029b80: 666f 2073 7563 6365 7373 6675 6c20 7769  fo successful wi
+00029b90: 7468 207b 7072 6976 6163 795f 6669 6c74  th {privacy_filt
+00029ba0: 6572 2873 7472 2872 6573 7029 297d 220a  er(str(resp))}".
+00029bb0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00029bc0: 2020 2320 6f75 7470 7574 2066 6f72 6d61    # output forma
+00029bd0: 7420 636f 6e74 726f 6c6c 6564 2076 6961  t controlled via
+00029be0: 202d 2d6f 7574 7075 7420 666c 6167 0a20   --output flag. 
+00029bf0: 2020 2020 2020 2074 6578 7420 3d20 6622         text = f"
+00029c00: 7b72 6573 702e 686f 6d65 7365 7276 6572  {resp.homeserver
+00029c10: 5f75 726c 7d7b 5345 507d 7b72 6573 702e  _url}{SEP}{resp.
+00029c20: 6964 656e 7469 7479 5f73 6572 7665 725f  identity_server_
+00029c30: 7572 6c7d 220a 2020 2020 2020 2020 2320  url}".        # 
+00029c40: 4f62 6a65 6374 206f 6620 7479 7065 2078  Object of type x
+00029c50: 7878 5265 7370 6f6e 7365 2069 7320 6e6f  xxResponse is no
+00029c60: 7420 4a53 4f4e 0a20 2020 2020 2020 2023  t JSON.        #
+00029c70: 2073 6572 6961 6c69 7a61 626c 652c 2068   serializable, h
+00029c80: 656e 6365 2077 6520 7573 6520 7468 6520  ence we use the 
+00029c90: 6469 6374 696f 6e61 7279 2e0a 2020 2020  dictionary..    
+00029ca0: 2020 2020 6a73 6f6e 5f6d 6178 203d 2072      json_max = r
+00029cb0: 6573 702e 5f5f 6469 6374 5f5f 0a20 2020  esp.__dict__.   
+00029cc0: 2020 2020 2023 206a 736f 6e5f 6d61 782e       # json_max.
+00029cd0: 7570 6461 7465 287b 226b 6579 223a 2076  update({"key": v
+00029ce0: 616c 7565 7d29 2020 2320 6164 6420 6469  alue})  # add di
+00029cf0: 6374 2069 7465 6d73 0a20 2020 2020 2020  ct items.       
+00029d00: 206a 736f 6e5f 203d 206a 736f 6e5f 6d61   json_ = json_ma
+00029d10: 782e 636f 7079 2829 0a20 2020 2020 2020  x.copy().       
+00029d20: 206a 736f 6e5f 2e70 6f70 2822 7472 616e   json_.pop("tran
+00029d30: 7370 6f72 745f 7265 7370 6f6e 7365 2229  sport_response")
+00029d40: 0a20 2020 2020 2020 206a 736f 6e5f 7370  .        json_sp
+00029d50: 6563 203d 204e 6f6e 650a 2020 2020 2020  ec = None.      
+00029d60: 2020 7072 696e 745f 6f75 7470 7574 280a    print_output(.
+00029d70: 2020 2020 2020 2020 2020 2020 6773 2e70              gs.p
+00029d80: 612e 6f75 7470 7574 2c0a 2020 2020 2020  a.output,.      
+00029d90: 2020 2020 2020 7465 7874 3d74 6578 742c        text=text,
+00029da0: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
+00029db0: 6e5f 3d6a 736f 6e5f 2c0a 2020 2020 2020  n_=json_,.      
+00029dc0: 2020 2020 2020 6a73 6f6e 5f6d 6178 3d6a        json_max=j
+00029dd0: 736f 6e5f 6d61 782c 0a20 2020 2020 2020  son_max,.       
+00029de0: 2020 2020 206a 736f 6e5f 7370 6563 3d6a       json_spec=j
+00029df0: 736f 6e5f 7370 6563 2c0a 2020 2020 2020  son_spec,.      
+00029e00: 2020 290a 0a0a 6173 796e 6320 6465 6620    )...async def 
+00029e10: 6163 7469 6f6e 5f6c 6f67 696e 5f69 6e66  action_login_inf
+00029e20: 6f28 636c 6965 6e74 3a20 4173 796e 6343  o(client: AsyncC
+00029e30: 6c69 656e 742c 2063 7265 6465 6e74 6961  lient, credentia
+00029e40: 6c73 3a20 6469 6374 2920 2d3e 204e 6f6e  ls: dict) -> Non
+00029e50: 653a 0a20 2020 2022 2222 4c69 7374 206c  e:.    """List l
+00029e60: 6f67 696e 206d 6574 686f 6473 206f 6620  ogin methods of 
+00029e70: 686f 6d65 2073 6572 7665 7220 7768 696c  home server whil
+00029e80: 6520 616c 7265 6164 7920 6c6f 6767 6564  e already logged
+00029e90: 2069 6e2e 2222 220a 2020 2020 7265 7370   in.""".    resp
+00029ea0: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+00029eb0: 6c6f 6769 6e5f 696e 666f 2829 0a20 2020  login_info().   
+00029ec0: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
+00029ed0: 6573 702c 204c 6f67 696e 496e 666f 4572  esp, LoginInfoEr
+00029ee0: 726f 7229 3a0a 2020 2020 2020 2020 6773  ror):.        gs
+00029ef0: 2e6c 6f67 2e65 7272 6f72 280a 2020 2020  .log.error(.    
+00029f00: 2020 2020 2020 2020 2245 3138 323a 2022          "E182: "
+00029f10: 2066 226c 6f67 696e 5f69 6e66 6f20 6661   f"login_info fa
+00029f20: 696c 6564 2077 6974 6820 7b70 7269 7661  iled with {priva
+00029f30: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
+00029f40: 7370 2929 7d22 0a20 2020 2020 2020 2029  sp))}".        )
+00029f50: 0a20 2020 2020 2020 2067 732e 6572 725f  .        gs.err_
+00029f60: 636f 756e 7420 2b3d 2031 0a20 2020 2065  count += 1.    e
+00029f70: 6c73 653a 0a20 2020 2020 2020 2067 732e  lse:.        gs.
+00029f80: 6c6f 672e 6465 6275 6728 6622 6c6f 6769  log.debug(f"logi
+00029f90: 6e5f 696e 666f 2073 7563 6365 7373 6675  n_info successfu
+00029fa0: 6c20 7769 7468 207b 7072 6976 6163 795f  l with {privacy_
+00029fb0: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
+00029fc0: 297d 2229 0a20 2020 2020 2020 2023 206f  )}").        # o
+00029fd0: 7574 7075 7420 666f 726d 6174 2063 6f6e  utput format con
+00029fe0: 7472 6f6c 6c65 6420 7669 6120 2d2d 6f75  trolled via --ou
+00029ff0: 7470 7574 2066 6c61 670a 2020 2020 2020  tput flag.      
+0002a000: 2020 7465 7874 203d 2022 220a 2020 2020    text = "".    
+0002a010: 2020 2020 666f 7220 7272 2069 6e20 7265      for rr in re
+0002a020: 7370 2e66 6c6f 7773 3a0a 2020 2020 2020  sp.flows:.      
+0002a030: 2020 2020 2020 7465 7874 202b 3d20 7374        text += st
+0002a040: 7228 7272 2920 2b20 225c 6e22 0a20 2020  r(rr) + "\n".   
+0002a050: 2020 2020 2074 6578 7420 3d20 7465 7874       text = text
+0002a060: 2e73 7472 6970 2829 0a20 2020 2020 2020  .strip().       
+0002a070: 2023 204f 626a 6563 7420 6f66 2074 7970   # Object of typ
+0002a080: 6520 7878 7852 6573 706f 6e73 6520 6973  e xxxResponse is
+0002a090: 206e 6f74 204a 534f 4e0a 2020 2020 2020   not JSON.      
+0002a0a0: 2020 2320 7365 7269 616c 697a 6162 6c65    # serializable
+0002a0b0: 2c20 6865 6e63 6520 7765 2075 7365 2074  , hence we use t
+0002a0c0: 6865 2064 6963 7469 6f6e 6172 792e 0a20  he dictionary.. 
+0002a0d0: 2020 2020 2020 206a 736f 6e5f 6d61 7820         json_max 
+0002a0e0: 3d20 7265 7370 2e5f 5f64 6963 745f 5f0a  = resp.__dict__.
+0002a0f0: 2020 2020 2020 2020 2320 6a73 6f6e 5f6d          # json_m
+0002a100: 6178 2e75 7064 6174 6528 7b22 6b65 7922  ax.update({"key"
+0002a110: 3a20 7661 6c75 657d 2920 2023 2061 6464  : value})  # add
+0002a120: 2064 6963 7420 6974 656d 730a 2020 2020   dict items.    
+0002a130: 2020 2020 6a73 6f6e 5f20 3d20 6a73 6f6e      json_ = json
+0002a140: 5f6d 6178 2e63 6f70 7928 290a 2020 2020  _max.copy().    
+0002a150: 2020 2020 6a73 6f6e 5f2e 706f 7028 2274      json_.pop("t
+0002a160: 7261 6e73 706f 7274 5f72 6573 706f 6e73  ransport_respons
+0002a170: 6522 290a 2020 2020 2020 2020 6a73 6f6e  e").        json
+0002a180: 5f73 7065 6320 3d20 4e6f 6e65 0a20 2020  _spec = None.   
+0002a190: 2020 2020 2070 7269 6e74 5f6f 7574 7075       print_outpu
+0002a1a0: 7428 0a20 2020 2020 2020 2020 2020 2067  t(.            g
+0002a1b0: 732e 7061 2e6f 7574 7075 742c 0a20 2020  s.pa.output,.   
+0002a1c0: 2020 2020 2020 2020 2074 6578 743d 7465           text=te
+0002a1d0: 7874 2c0a 2020 2020 2020 2020 2020 2020  xt,.            
+0002a1e0: 6a73 6f6e 5f3d 6a73 6f6e 5f2c 0a20 2020  json_=json_,.   
+0002a1f0: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
+0002a200: 783d 6a73 6f6e 5f6d 6178 2c0a 2020 2020  x=json_max,.    
+0002a210: 2020 2020 2020 2020 6a73 6f6e 5f73 7065          json_spe
+0002a220: 633d 6a73 6f6e 5f73 7065 632c 0a20 2020  c=json_spec,.   
+0002a230: 2020 2020 2029 0a0a 0a61 7379 6e63 2064       )...async d
+0002a240: 6566 2061 6374 696f 6e5f 636f 6e74 656e  ef action_conten
+0002a250: 745f 7265 706f 7369 746f 7279 5f63 6f6e  t_repository_con
+0002a260: 6669 6728 0a20 2020 2063 6c69 656e 743a  fig(.    client:
+0002a270: 2041 7379 6e63 436c 6965 6e74 2c20 6372   AsyncClient, cr
+0002a280: 6564 656e 7469 616c 733a 2064 6963 740a  edentials: dict.
+0002a290: 2920 2d3e 204e 6f6e 653a 0a20 2020 2022  ) -> None:.    "
+0002a2a0: 2222 4c69 7374 2063 6f6e 6669 6720 6f66  ""List config of
+0002a2b0: 2063 6f6e 7465 6e74 2072 6570 6f20 6f66   content repo of
+0002a2c0: 2068 6f6d 6520 7365 7276 6572 2077 6869   home server whi
+0002a2d0: 6c65 2061 6c72 6561 6479 206c 6f67 6765  le already logge
+0002a2e0: 6420 696e 2e22 2222 0a20 2020 2072 6573  d in.""".    res
+0002a2f0: 7020 3d20 6177 6169 7420 636c 6965 6e74  p = await client
+0002a300: 2e63 6f6e 7465 6e74 5f72 6570 6f73 6974  .content_reposit
+0002a310: 6f72 795f 636f 6e66 6967 2829 0a20 2020  ory_config().   
+0002a320: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
+0002a330: 6573 702c 2043 6f6e 7465 6e74 5265 706f  esp, ContentRepo
+0002a340: 7369 746f 7279 436f 6e66 6967 4572 726f  sitoryConfigErro
+0002a350: 7229 3a0a 2020 2020 2020 2020 6773 2e6c  r):.        gs.l
+0002a360: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
+0002a370: 2020 2020 2020 2245 3138 333a 2022 0a20        "E183: ". 
+0002a380: 2020 2020 2020 2020 2020 2022 636f 6e74             "cont
+0002a390: 656e 745f 7265 706f 7369 746f 7279 5f63  ent_repository_c
+0002a3a0: 6f6e 6669 6720 6661 696c 6564 2077 6974  onfig failed wit
+0002a3b0: 6820 220a 2020 2020 2020 2020 2020 2020  h ".            
+0002a3c0: 6622 7b70 7269 7661 6379 5f66 696c 7465  f"{privacy_filte
+0002a3d0: 7228 7374 7228 7265 7370 2929 7d22 0a20  r(str(resp))}". 
+0002a3e0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0002a3f0: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
+0002a400: 2031 0a20 2020 2065 6c73 653a 0a20 2020   1.    else:.   
+0002a410: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
+0002a420: 6728 0a20 2020 2020 2020 2020 2020 2022  g(.            "
+0002a430: 636f 6e74 656e 745f 7265 706f 7369 746f  content_reposito
+0002a440: 7279 5f63 6f6e 6669 6720 7375 6363 6573  ry_config succes
+0002a450: 7366 756c 2077 6974 6820 220a 2020 2020  sful with ".    
+0002a460: 2020 2020 2020 2020 6622 7b70 7269 7661          f"{priva
+0002a470: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
+0002a480: 7370 2929 7d22 0a20 2020 2020 2020 2029  sp))}".        )
+0002a490: 0a20 2020 2020 2020 2023 206f 7574 7075  .        # outpu
+0002a4a0: 7420 666f 726d 6174 2063 6f6e 7472 6f6c  t format control
+0002a4b0: 6c65 6420 7669 6120 2d2d 6f75 7470 7574  led via --output
+0002a4c0: 2066 6c61 670a 2020 2020 2020 2020 7465   flag.        te
+0002a4d0: 7874 203d 2072 6573 702e 7570 6c6f 6164  xt = resp.upload
+0002a4e0: 5f73 697a 6520 2023 2072 6574 7572 6e73  _size  # returns
+0002a4f0: 206f 6e6c 7920 3120 7661 6c75 650a 2020   only 1 value.  
+0002a500: 2020 2020 2020 2320 4f62 6a65 6374 206f        # Object o
+0002a510: 6620 7479 7065 2078 7878 5265 7370 6f6e  f type xxxRespon
+0002a520: 7365 2069 7320 6e6f 7420 4a53 4f4e 0a20  se is not JSON. 
+0002a530: 2020 2020 2020 2023 2073 6572 6961 6c69         # seriali
+0002a540: 7a61 626c 652c 2068 656e 6365 2077 6520  zable, hence we 
+0002a550: 7573 6520 7468 6520 6469 6374 696f 6e61  use the dictiona
+0002a560: 7279 2e0a 2020 2020 2020 2020 6a73 6f6e  ry..        json
+0002a570: 5f6d 6178 203d 2072 6573 702e 5f5f 6469  _max = resp.__di
+0002a580: 6374 5f5f 0a20 2020 2020 2020 2023 206a  ct__.        # j
+0002a590: 736f 6e5f 6d61 782e 7570 6461 7465 287b  son_max.update({
+0002a5a0: 226b 6579 223a 2076 616c 7565 7d29 2020  "key": value})  
+0002a5b0: 2320 6164 6420 6469 6374 2069 7465 6d73  # add dict items
+0002a5c0: 0a20 2020 2020 2020 206a 736f 6e5f 203d  .        json_ =
+0002a5d0: 206a 736f 6e5f 6d61 782e 636f 7079 2829   json_max.copy()
+0002a5e0: 0a20 2020 2020 2020 206a 736f 6e5f 2e70  .        json_.p
+0002a5f0: 6f70 2822 7472 616e 7370 6f72 745f 7265  op("transport_re
+0002a600: 7370 6f6e 7365 2229 0a20 2020 2020 2020  sponse").       
+0002a610: 206a 736f 6e5f 7370 6563 203d 204e 6f6e   json_spec = Non
+0002a620: 650a 2020 2020 2020 2020 7072 696e 745f  e.        print_
+0002a630: 6f75 7470 7574 280a 2020 2020 2020 2020  output(.        
+0002a640: 2020 2020 6773 2e70 612e 6f75 7470 7574      gs.pa.output
+0002a650: 2c0a 2020 2020 2020 2020 2020 2020 7465  ,.            te
+0002a660: 7874 3d74 6578 742c 0a20 2020 2020 2020  xt=text,.       
+0002a670: 2020 2020 206a 736f 6e5f 3d6a 736f 6e5f       json_=json_
+0002a680: 2c0a 2020 2020 2020 2020 2020 2020 6a73  ,.            js
+0002a690: 6f6e 5f6d 6178 3d6a 736f 6e5f 6d61 782c  on_max=json_max,
+0002a6a0: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
+0002a6b0: 6e5f 7370 6563 3d6a 736f 6e5f 7370 6563  n_spec=json_spec
+0002a6c0: 2c0a 2020 2020 2020 2020 290a 0a0a 6173  ,.        )...as
+0002a6d0: 796e 6320 6465 6620 6163 7469 6f6e 5f72  ync def action_r
+0002a6e0: 6573 7428 636c 6965 6e74 3a20 4173 796e  est(client: Asyn
+0002a6f0: 6343 6c69 656e 742c 2063 7265 6465 6e74  cClient, credent
+0002a700: 6961 6c73 3a20 6469 6374 2920 2d3e 204e  ials: dict) -> N
+0002a710: 6f6e 653a 0a20 2020 2022 2222 496e 766f  one:.    """Invo
+0002a720: 6b65 2052 4553 5420 4150 4920 6f6e 204d  ke REST API on M
+0002a730: 6174 7269 7820 7365 7276 6572 2e0a 2020  atrix server..  
+0002a740: 2020 4173 7375 6d65 7320 7468 6174 2075    Assumes that u
+0002a750: 7365 7220 6973 2061 6c72 6561 6479 206c  ser is already l
+0002a760: 6f67 6765 6420 696e 2e0a 2020 2020 2222  ogged in..    ""
+0002a770: 220a 2020 2020 2320 7365 653a 2068 7474  ".    # see: htt
+0002a780: 7073 3a2f 2f64 6f63 732e 6169 6f68 7474  ps://docs.aiohtt
+0002a790: 702e 6f72 672f 656e 2f73 7461 626c 652f  p.org/en/stable/
+0002a7a0: 636c 6965 6e74 5f71 7569 636b 7374 6172  client_quickstar
+0002a7b0: 742e 6874 6d6c 0a20 2020 2023 2077 6520  t.html.    # we 
+0002a7c0: 6d75 7374 2065 6d75 6c61 7465 2061 2063  must emulate a c
+0002a7d0: 7572 6c20 6c69 6b65 2074 6869 733a 0a20  url like this:. 
+0002a7e0: 2020 2023 2063 7572 6c20 2d58 4445 4c45     # curl -XDELE
+0002a7f0: 5445 2020 2268 7474 7073 3a2f 2f53 4552  TE  "https://SER
+0002a800: 5645 5248 4552 452f 5f73 796e 6170 7365  VERHERE/_synapse
+0002a810: 2f61 646d 696e 2f76 312f 6d65 6469 612f  /admin/v1/media/
+0002a820: 5345 5256 4552 4845 5245 2f0a 2020 2020  SERVERHERE/.    
+0002a830: 2320 2020 2020 204d 5843 4944 4845 5245  #      MXCIDHERE
+0002a840: 3f61 6363 6573 735f 746f 6b65 6e3d 4143  ?access_token=AC
+0002a850: 4345 5353 5f54 4f4b 454e 5f48 4552 4522  CESS_TOKEN_HERE"
+0002a860: 0a20 2020 2023 2063 7572 6c20 2d58 504f  .    # curl -XPO
+0002a870: 5354 202d 6420 277b 226d 7367 7479 7065  ST -d '{"msgtype
+0002a880: 223a 226d 2e74 6578 7422 2c20 2262 6f64  ":"m.text", "bod
+0002a890: 7922 3a22 6865 6c6c 6f22 7d27 205c 0a20  y":"hello"}' \. 
+0002a8a0: 2020 2023 2020 2022 5f5f 686f 6d65 7365     #   "__homese
+0002a8b0: 7276 6572 5f5f 2f5f 6d61 7472 6978 2f63  rver__/_matrix/c
+0002a8c0: 6c69 656e 742f 7230 2f72 6f6f 6d73 2f5f  lient/r0/rooms/_
+0002a8d0: 5f65 6e63 6f64 6564 5f66 756c 6c5f 726f  _encoded_full_ro
+0002a8e0: 6f6d 5f69 645f 5f2f 5c0a 2020 2020 2320  om_id__/\.    # 
+0002a8f0: 2020 7365 6e64 2f6d 2e72 6f6f 6d2e 6d65    send/m.room.me
+0002a900: 7373 6167 653f 6163 6365 7373 5f74 6f6b  ssage?access_tok
+0002a910: 656e 3d59 4f55 5254 4f4b 454e 4845 5245  en=YOURTOKENHERE
+0002a920: 220a 2020 2020 2320 6375 726c 202d 5847  ".    # curl -XG
+0002a930: 4554 202d 6420 2222 2027 5f5f 686f 6d65  ET -d "" '__home
+0002a940: 7365 7276 6572 5f5f 2f5f 6d61 7472 6978  server__/_matrix
+0002a950: 2f63 6c69 656e 742f 7665 7273 696f 6e73  /client/versions
+0002a960: 270a 2020 2020 6966 206e 6f74 206c 656e  '.    if not len
+0002a970: 2867 732e 7061 2e72 6573 7429 2025 2033  (gs.pa.rest) % 3
+0002a980: 203d 3d20 303a 0a20 2020 2020 2020 2067   == 0:.        g
+0002a990: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
+0002a9a0: 2020 2020 2020 2020 2022 4531 3834 3a20           "E184: 
+0002a9b0: 220a 2020 2020 2020 2020 2020 2020 2249  ".            "I
+0002a9c0: 6e63 6f72 7265 6374 206e 756d 6265 7220  ncorrect number 
+0002a9d0: 6f66 2061 7267 756d 656e 7473 2066 6f72  of arguments for
+0002a9e0: 202d 2d72 6573 742e 2041 7267 756d 656e   --rest. Argumen
+0002a9f0: 7473 206d 7573 7420 6265 2022 0a20 2020  ts must be ".   
+0002aa00: 2020 2020 2020 2020 2066 2274 7269 706c           f"tripl
+0002aa10: 6573 2c20 692e 652e 206d 756c 7469 706c  es, i.e. multipl
+0002aa20: 6573 206f 6620 332c 2062 7574 2066 6f75  es of 3, but fou
+0002aa30: 6e64 207b 6c65 6e28 6773 2e70 612e 7265  nd {len(gs.pa.re
+0002aa40: 7374 297d 2022 0a20 2020 2020 2020 2020  st)} ".         
+0002aa50: 2020 2022 6172 6775 6d65 6e74 732e 220a     "arguments.".
+0002aa60: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0002aa70: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
+0002aa80: 3d20 310a 2020 2020 2020 2020 7265 7475  = 1.        retu
+0002aa90: 726e 0a20 2020 2066 6f72 2069 6920 696e  rn.    for ii in
+0002aaa0: 2072 616e 6765 286c 656e 2867 732e 7061   range(len(gs.pa
+0002aab0: 2e72 6573 7429 202f 2f20 3329 3a0a 2020  .rest) // 3):.  
+0002aac0: 2020 2020 2020 6d65 7468 6f64 203d 2067        method = g
+0002aad0: 732e 7061 2e72 6573 745b 6969 202a 2033  s.pa.rest[ii * 3
+0002aae0: 202b 2030 5d0a 2020 2020 2020 2020 6461   + 0].        da
+0002aaf0: 7461 203d 2067 732e 7061 2e72 6573 745b  ta = gs.pa.rest[
+0002ab00: 6969 202a 2033 202b 2031 5d0a 2020 2020  ii * 3 + 1].    
+0002ab10: 2020 2020 7572 6c20 3d20 6773 2e70 612e      url = gs.pa.
+0002ab20: 7265 7374 5b69 6920 2a20 3320 2b20 325d  rest[ii * 3 + 2]
+0002ab30: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0002ab40: 6d65 7468 6f64 206f 7220 6d65 7468 6f64  method or method
+0002ab50: 2e75 7070 6572 2829 2e73 7472 6970 2829  .upper().strip()
+0002ab60: 206e 6f74 2069 6e20 5b0a 2020 2020 2020   not in [.      
+0002ab70: 2020 2020 2020 2247 4554 222c 0a20 2020        "GET",.   
+0002ab80: 2020 2020 2020 2020 2022 504f 5354 222c           "POST",
+0002ab90: 0a20 2020 2020 2020 2020 2020 2022 5055  .            "PU
+0002aba0: 5422 2c0a 2020 2020 2020 2020 2020 2020  T",.            
+0002abb0: 2244 454c 4554 4522 2c0a 2020 2020 2020  "DELETE",.      
+0002abc0: 2020 2020 2020 224f 5054 494f 4e53 222c        "OPTIONS",
+0002abd0: 0a20 2020 2020 2020 205d 3a0a 2020 2020  .        ]:.    
+0002abe0: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
+0002abf0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+0002ac00: 2020 2020 2020 2245 3138 353a 2022 0a20        "E185: ". 
+0002ac10: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0002ac20: 2249 6e63 6f72 7265 6374 2052 4553 5420  "Incorrect REST 
+0002ac30: 6d65 7468 6f64 207b 6d65 7468 6f64 7d2e  method {method}.
+0002ac40: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+0002ac50: 2020 2027 4d75 7374 2062 6520 6f6e 6520     'Must be one 
+0002ac60: 6f66 3a20 2247 4554 222c 2022 504f 5354  of: "GET", "POST
+0002ac70: 222c 2022 5055 5422 2c20 2244 454c 4554  ", "PUT", "DELET
+0002ac80: 4522 2c20 224f 5054 494f 4e53 222e 270a  E", "OPTIONS".'.
+0002ac90: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0002aca0: 2020 2020 2020 2020 2020 6773 2e65 7272            gs.err
+0002acb0: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
+0002acc0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+0002acd0: 0a20 2020 2020 2020 206d 6574 686f 6420  .        method 
+0002ace0: 3d20 6d65 7468 6f64 2e75 7070 6572 2829  = method.upper()
+0002acf0: 2e73 7472 6970 2829 0a20 2020 2020 2020  .strip().       
+0002ad00: 2069 6620 6e6f 7420 6461 7461 3a0a 2020   if not data:.  
+0002ad10: 2020 2020 2020 2020 2020 6461 7461 203d            data =
+0002ad20: 2022 220a 2020 2020 2020 2020 6966 206e   "".        if n
+0002ad30: 6f74 2075 726c 206f 7220 7572 6c2e 7374  ot url or url.st
+0002ad40: 7269 7028 2920 3d3d 2022 223a 0a20 2020  rip() == "":.   
+0002ad50: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
+0002ad60: 6572 726f 7228 0a20 2020 2020 2020 2020  error(.         
+0002ad70: 2020 2020 2020 2022 4531 3836 3a20 2220         "E186: " 
+0002ad80: 6622 496e 636f 7272 6563 7420 5245 5354  f"Incorrect REST
+0002ad90: 2055 524c 207b 7572 6c7d 2e20 4d75 7374   URL {url}. Must
+0002ada0: 206e 6f74 2062 6520 656d 7074 792e 220a   not be empty.".
+0002adb0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0002adc0: 2020 2020 2020 2020 2020 6773 2e65 7272            gs.err
+0002add0: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
+0002ade0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+0002adf0: 0a20 2020 2020 2020 2069 6620 6773 2e70  .        if gs.p
+0002ae00: 612e 6163 6365 7373 5f74 6f6b 656e 3a0a  a.access_token:.
+0002ae10: 2020 2020 2020 2020 2020 2020 6174 203d              at =
+0002ae20: 2067 732e 7061 2e61 6363 6573 735f 746f   gs.pa.access_to
+0002ae30: 6b65 6e0a 2020 2020 2020 2020 2020 2020  ken.            
+0002ae40: 6773 2e6c 6f67 2e64 6562 7567 2822 5573  gs.log.debug("Us
+0002ae50: 696e 6720 6163 6365 7373 2074 6f6b 656e  ing access token
+0002ae60: 2066 726f 6d20 2d2d 6163 6365 7373 2d74   from --access-t
+0002ae70: 6f6b 656e 2061 7267 756d 656e 742e 2229  oken argument.")
+0002ae80: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0002ae90: 2020 2020 2020 2020 2020 2061 7420 3d20             at = 
+0002aea0: 6372 6564 656e 7469 616c 735b 2261 6363  credentials["acc
+0002aeb0: 6573 735f 746f 6b65 6e22 5d0a 2020 2020  ess_token"].    
+0002aec0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+0002aed0: 6562 7567 2822 5573 696e 6720 6163 6365  ebug("Using acce
+0002aee0: 7373 2074 6f6b 656e 2066 726f 6d20 6372  ss token from cr
+0002aef0: 6564 656e 7469 616c 7320 6669 6c65 2e22  edentials file."
+0002af00: 290a 2020 2020 2020 2020 666f 7220 7068  ).        for ph
+0002af10: 2069 6e20 5b0a 2020 2020 2020 2020 2020   in [.          
+0002af20: 2020 484f 4d45 5345 5256 4552 5f50 4c41    HOMESERVER_PLA
+0002af30: 4345 484f 4c44 4552 2c0a 2020 2020 2020  CEHOLDER,.      
+0002af40: 2020 2020 2020 484f 5354 4e41 4d45 5f50        HOSTNAME_P
+0002af50: 4c41 4345 484f 4c44 4552 2c0a 2020 2020  LACEHOLDER,.    
+0002af60: 2020 2020 2020 2020 4143 4345 5353 5f54          ACCESS_T
+0002af70: 4f4b 454e 5f50 4c41 4345 484f 4c44 4552  OKEN_PLACEHOLDER
+0002af80: 2c0a 2020 2020 2020 2020 2020 2020 5553  ,.            US
+0002af90: 4552 5f49 445f 504c 4143 4548 4f4c 4445  ER_ID_PLACEHOLDE
+0002afa0: 522c 0a20 2020 2020 2020 2020 2020 2044  R,.            D
+0002afb0: 4556 4943 455f 4944 5f50 4c41 4345 484f  EVICE_ID_PLACEHO
+0002afc0: 4c44 4552 2c0a 2020 2020 2020 2020 2020  LDER,.          
+0002afd0: 2020 524f 4f4d 5f49 445f 504c 4143 4548    ROOM_ID_PLACEH
+0002afe0: 4f4c 4445 522c 0a20 2020 2020 2020 205d  OLDER,.        ]
+0002aff0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0002b000: 2070 6820 3d3d 2048 4f4d 4553 4552 5645   ph == HOMESERVE
+0002b010: 525f 504c 4143 4548 4f4c 4445 523a 0a20  R_PLACEHOLDER:. 
+0002b020: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0002b030: 6174 6120 3d20 6461 7461 2e72 6570 6c61  ata = data.repla
+0002b040: 6365 2870 682c 2063 7265 6465 6e74 6961  ce(ph, credentia
+0002b050: 6c73 5b22 686f 6d65 7365 7276 6572 225d  ls["homeserver"]
+0002b060: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002b070: 2020 7572 6c20 3d20 7572 6c2e 7265 706c    url = url.repl
+0002b080: 6163 6528 7068 2c20 6372 6564 656e 7469  ace(ph, credenti
+0002b090: 616c 735b 2268 6f6d 6573 6572 7665 7222  als["homeserver"
+0002b0a0: 5d29 0a20 2020 2020 2020 2020 2020 2065  ]).            e
+0002b0b0: 6c69 6620 7068 203d 3d20 484f 5354 4e41  lif ph == HOSTNA
+0002b0c0: 4d45 5f50 4c41 4345 484f 4c44 4552 3a0a  ME_PLACEHOLDER:.
+0002b0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b0e0: 686f 7374 6e61 6d65 203d 2075 726c 7061  hostname = urlpa
+0002b0f0: 7273 6528 6372 6564 656e 7469 616c 735b  rse(credentials[
+0002b100: 2268 6f6d 6573 6572 7665 7222 5d29 2e68  "homeserver"]).h
+0002b110: 6f73 746e 616d 650a 2020 2020 2020 2020  ostname.        
+0002b120: 2020 2020 2020 2020 6461 7461 203d 2064          data = d
+0002b130: 6174 612e 7265 706c 6163 6528 7068 2c20  ata.replace(ph, 
+0002b140: 686f 7374 6e61 6d65 290a 2020 2020 2020  hostname).      
+0002b150: 2020 2020 2020 2020 2020 7572 6c20 3d20            url = 
+0002b160: 7572 6c2e 7265 706c 6163 6528 7068 2c20  url.replace(ph, 
+0002b170: 686f 7374 6e61 6d65 290a 2020 2020 2020  hostname).      
+0002b180: 2020 2020 2020 656c 6966 2070 6820 3d3d        elif ph ==
+0002b190: 2041 4343 4553 535f 544f 4b45 4e5f 504c   ACCESS_TOKEN_PL
+0002b1a0: 4143 4548 4f4c 4445 523a 0a20 2020 2020  ACEHOLDER:.     
+0002b1b0: 2020 2020 2020 2020 2020 2064 6174 6120             data 
+0002b1c0: 3d20 6461 7461 2e72 6570 6c61 6365 2870  = data.replace(p
+0002b1d0: 682c 2061 7429 0a20 2020 2020 2020 2020  h, at).         
+0002b1e0: 2020 2020 2020 2075 726c 203d 2075 726c         url = url
+0002b1f0: 2e72 6570 6c61 6365 2870 682c 2061 7429  .replace(ph, at)
+0002b200: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+0002b210: 6620 7068 203d 3d20 5553 4552 5f49 445f  f ph == USER_ID_
+0002b220: 504c 4143 4548 4f4c 4445 523a 0a20 2020  PLACEHOLDER:.   
+0002b230: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+0002b240: 6120 3d20 6461 7461 2e72 6570 6c61 6365  a = data.replace
+0002b250: 2870 682c 2063 7265 6465 6e74 6961 6c73  (ph, credentials
+0002b260: 5b22 7573 6572 5f69 6422 5d29 0a20 2020  ["user_id"]).   
+0002b270: 2020 2020 2020 2020 2020 2020 2075 726c               url
+0002b280: 203d 2075 726c 2e72 6570 6c61 6365 2870   = url.replace(p
+0002b290: 682c 2063 7265 6465 6e74 6961 6c73 5b22  h, credentials["
+0002b2a0: 7573 6572 5f69 6422 5d29 0a20 2020 2020  user_id"]).     
+0002b2b0: 2020 2020 2020 2065 6c69 6620 7068 203d         elif ph =
+0002b2c0: 3d20 4445 5649 4345 5f49 445f 504c 4143  = DEVICE_ID_PLAC
+0002b2d0: 4548 4f4c 4445 523a 0a20 2020 2020 2020  EHOLDER:.       
+0002b2e0: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
+0002b2f0: 6461 7461 2e72 6570 6c61 6365 2870 682c  data.replace(ph,
+0002b300: 2063 7265 6465 6e74 6961 6c73 5b22 6465   credentials["de
+0002b310: 7669 6365 5f69 6422 5d29 0a20 2020 2020  vice_id"]).     
+0002b320: 2020 2020 2020 2020 2020 2075 726c 203d             url =
+0002b330: 2075 726c 2e72 6570 6c61 6365 2870 682c   url.replace(ph,
+0002b340: 2063 7265 6465 6e74 6961 6c73 5b22 6465   credentials["de
+0002b350: 7669 6365 5f69 6422 5d29 0a20 2020 2020  vice_id"]).     
+0002b360: 2020 2020 2020 2065 6c69 6620 7068 203d         elif ph =
+0002b370: 3d20 524f 4f4d 5f49 445f 504c 4143 4548  = ROOM_ID_PLACEH
+0002b380: 4f4c 4445 523a 0a20 2020 2020 2020 2020  OLDER:.         
+0002b390: 2020 2020 2020 2072 6f6f 6d5f 6964 203d         room_id =
+0002b3a0: 2063 7265 6465 6e74 6961 6c73 5b22 726f   credentials["ro
+0002b3b0: 6f6d 5f69 6422 5d0a 2020 2020 2020 2020  om_id"].        
+0002b3c0: 2020 2020 2020 2020 726f 6f6d 5f69 6420          room_id 
+0002b3d0: 3d20 6177 6169 7420 6d61 705f 726f 6f6d  = await map_room
+0002b3e0: 696e 666f 5f74 6f5f 726f 6f6d 6964 2863  info_to_roomid(c
+0002b3f0: 6c69 656e 742c 2072 6f6f 6d5f 6964 290a  lient, room_id).
+0002b400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b410: 726f 6f6d 5f69 6420 3d20 7175 6f74 6528  room_id = quote(
+0002b420: 726f 6f6d 5f69 6429 0a20 2020 2020 2020  room_id).       
+0002b430: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
+0002b440: 6461 7461 2e72 6570 6c61 6365 2870 682c  data.replace(ph,
+0002b450: 2072 6f6f 6d5f 6964 290a 2020 2020 2020   room_id).      
+0002b460: 2020 2020 2020 2020 2020 7572 6c20 3d20            url = 
+0002b470: 7572 6c2e 7265 706c 6163 6528 7068 2c20  url.replace(ph, 
+0002b480: 726f 6f6d 5f69 6429 0a20 2020 2020 2020  room_id).       
+0002b490: 2075 726c 203d 2075 726c 2e73 7472 6970   url = url.strip
+0002b4a0: 2829 0a20 2020 2020 2020 2069 6620 6461  ().        if da
+0002b4b0: 7461 2021 3d20 2222 2061 6e64 2028 6d65  ta != "" and (me
+0002b4c0: 7468 6f64 2069 6e20 2822 4745 5422 2c20  thod in ("GET", 
+0002b4d0: 2244 454c 4554 4522 2c20 224f 5054 494f  "DELETE", "OPTIO
+0002b4e0: 4e53 2229 293a 0a20 2020 2020 2020 2020  NS")):.         
+0002b4f0: 2020 2067 732e 6c6f 672e 7761 726e 696e     gs.log.warnin
+0002b500: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+0002b510: 2020 2022 5731 3038 3a20 220a 2020 2020     "W108: ".    
+0002b520: 2020 2020 2020 2020 2020 2020 6627 466f              f'Fo
+0002b530: 756e 6420 5245 5354 2064 6174 6120 227b  und REST data "{
+0002b540: 6461 7461 7d22 2066 6f72 206d 6574 686f  data}" for metho
+0002b550: 6420 7b6d 6574 686f 647d 2e20 270a 2020  d {method}. '.  
+0002b560: 2020 2020 2020 2020 2020 2020 2020 2754                'T
+0002b570: 6865 7265 2069 7320 7573 7561 6c6c 7920  here is usually 
+0002b580: 6e6f 2064 6174 6120 666f 723a 2022 4745  no data for: "GE
+0002b590: 5422 2c20 2244 454c 4554 4522 2c20 224f  T", "DELETE", "O
+0002b5a0: 5054 494f 4e53 222e 2027 0a20 2020 2020  PTIONS". '.     
+0002b5b0: 2020 2020 2020 2020 2020 2022 4d6f 7374             "Most
+0002b5c0: 206c 696b 656c 7920 7468 6973 2069 7320   likely this is 
+0002b5d0: 6e6f 7420 7768 6174 2079 6f75 2077 616e  not what you wan
+0002b5e0: 742e 2022 0a20 2020 2020 2020 2020 2020  t. ".           
+0002b5f0: 2029 0a20 2020 2020 2020 2020 2020 2067   ).            g
+0002b600: 732e 7761 726e 5f63 6f75 6e74 202b 3d20  s.warn_count += 
+0002b610: 310a 2020 2020 2020 2020 2020 2020 636f  1.            co
+0002b620: 6e74 696e 7565 0a20 2020 2020 2020 2067  ntinue.        g
+0002b630: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
+0002b640: 2020 2020 2020 2020 2066 2250 7265 7061           f"Prepa
+0002b650: 7269 6e67 2074 6f20 696e 766f 6b65 2052  ring to invoke R
+0002b660: 4553 5420 4150 4920 6361 6c6c 3a20 6d65  EST API call: me
+0002b670: 7468 6f64 3d7b 6d65 7468 6f64 7d20 220a  thod={method} ".
+0002b680: 2020 2020 2020 2020 2020 2020 6622 6461              f"da
+0002b690: 7461 3d7b 6461 7461 7d2c 2075 726c 3d7b  ta={data}, url={
+0002b6a0: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
+0002b6b0: 7472 2875 726c 2929 7d2e 220a 2020 2020  tr(url))}.".    
+0002b6c0: 2020 2020 290a 2020 2020 2020 2020 636f      ).        co
+0002b6d0: 6e6e 6563 746f 7220 3d20 5443 5043 6f6e  nnector = TCPCon
+0002b6e0: 6e65 6374 6f72 2873 736c 3d67 732e 7373  nector(ssl=gs.ss
+0002b6f0: 6c29 2020 2320 7365 7474 696e 6720 7373  l)  # setting ss
+0002b700: 6c63 6f6e 7465 7874 0a20 2020 2020 2020  lcontext.       
+0002b710: 2061 7379 6e63 2077 6974 6820 436c 6965   async with Clie
+0002b720: 6e74 5365 7373 696f 6e28 636f 6e6e 6563  ntSession(connec
+0002b730: 746f 723d 636f 6e6e 6563 746f 7229 2061  tor=connector) a
+0002b740: 7320 7365 7373 696f 6e3a 2020 2320 6169  s session:  # ai
+0002b750: 6f68 7474 700a 2020 2020 2020 2020 2020  ohttp.          
+0002b760: 2020 6966 206d 6574 686f 6420 3d3d 2022    if method == "
+0002b770: 4745 5422 3a0a 2020 2020 2020 2020 2020  GET":.          
+0002b780: 2020 2020 2020 6173 796e 6320 7769 7468        async with
+0002b790: 2073 6573 7369 6f6e 2e67 6574 2875 726c   session.get(url
+0002b7a0: 2c20 6461 7461 3d64 6174 6129 2061 7320  , data=data) as 
+0002b7b0: 7265 7370 3a0a 2020 2020 2020 2020 2020  resp:.          
+0002b7c0: 2020 2020 2020 2020 2020 7374 6174 7573            status
+0002b7d0: 203d 2072 6573 702e 7374 6174 7573 2020   = resp.status  
+0002b7e0: 2320 696e 742c 2032 3030 2073 7563 6365  # int, 200 succe
+0002b7f0: 7373 0a20 2020 2020 2020 2020 2020 2020  ss.             
+0002b800: 2020 2020 2020 2074 7874 203d 2061 7761         txt = awa
+0002b810: 6974 2072 6573 702e 7465 7874 2829 2020  it resp.text()  
+0002b820: 2320 7374 7220 696e 2064 6963 7420 666f  # str in dict fo
+0002b830: 726d 6174 0a20 2020 2020 2020 2020 2020  rmat.           
+0002b840: 2065 6c69 6620 6d65 7468 6f64 203d 3d20   elif method == 
+0002b850: 2250 4f53 5422 3a0a 2020 2020 2020 2020  "POST":.        
+0002b860: 2020 2020 2020 2020 6173 796e 6320 7769          async wi
+0002b870: 7468 2073 6573 7369 6f6e 2e70 6f73 7428  th session.post(
+0002b880: 7572 6c2c 2064 6174 613d 6461 7461 2920  url, data=data) 
+0002b890: 6173 2072 6573 703a 0a20 2020 2020 2020  as resp:.       
+0002b8a0: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+0002b8b0: 7475 7320 3d20 7265 7370 2e73 7461 7475  tus = resp.statu
+0002b8c0: 7320 2023 2069 6e74 2c20 3230 3020 7375  s  # int, 200 su
+0002b8d0: 6363 6573 730a 2020 2020 2020 2020 2020  ccess.          
+0002b8e0: 2020 2020 2020 2020 2020 7478 7420 3d20            txt = 
+0002b8f0: 6177 6169 7420 7265 7370 2e74 6578 7428  await resp.text(
+0002b900: 2920 2023 2073 7472 2069 6e20 6469 6374  )  # str in dict
+0002b910: 2066 6f72 6d61 740a 2020 2020 2020 2020   format.        
+0002b920: 2020 2020 656c 6966 206d 6574 686f 6420      elif method 
+0002b930: 3d3d 2022 5055 5422 3a0a 2020 2020 2020  == "PUT":.      
+0002b940: 2020 2020 2020 2020 2020 6173 796e 6320            async 
+0002b950: 7769 7468 2073 6573 7369 6f6e 2e70 7574  with session.put
+0002b960: 2875 726c 2c20 6461 7461 3d64 6174 6129  (url, data=data)
+0002b970: 2061 7320 7265 7370 3a0a 2020 2020 2020   as resp:.      
+0002b980: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0002b990: 6174 7573 203d 2072 6573 702e 7374 6174  atus = resp.stat
+0002b9a0: 7573 2020 2320 696e 742c 2032 3030 2073  us  # int, 200 s
+0002b9b0: 7563 6365 7373 0a20 2020 2020 2020 2020  uccess.         
+0002b9c0: 2020 2020 2020 2020 2020 2074 7874 203d             txt =
+0002b9d0: 2061 7761 6974 2072 6573 702e 7465 7874   await resp.text
+0002b9e0: 2829 2020 2320 7374 7220 696e 2064 6963  ()  # str in dic
+0002b9f0: 7420 666f 726d 6174 0a20 2020 2020 2020  t format.       
+0002ba00: 2020 2020 2065 6c69 6620 6d65 7468 6f64       elif method
+0002ba10: 203d 3d20 2244 454c 4554 4522 3a0a 2020   == "DELETE":.  
+0002ba20: 2020 2020 2020 2020 2020 2020 2020 6173                as
+0002ba30: 796e 6320 7769 7468 2073 6573 7369 6f6e  ync with session
+0002ba40: 2e64 656c 6574 6528 7572 6c2c 2064 6174  .delete(url, dat
+0002ba50: 613d 6461 7461 2920 6173 2072 6573 703a  a=data) as resp:
+0002ba60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002ba70: 2020 2020 2073 7461 7475 7320 3d20 7265       status = re
+0002ba80: 7370 2e73 7461 7475 7320 2023 2069 6e74  sp.status  # int
+0002ba90: 2c20 3230 3020 7375 6363 6573 730a 2020  , 200 success.  
+0002baa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bab0: 2020 7478 7420 3d20 6177 6169 7420 7265    txt = await re
+0002bac0: 7370 2e74 6578 7428 2920 2023 2073 7472  sp.text()  # str
+0002bad0: 2069 6e20 6469 6374 2066 6f72 6d61 740a   in dict format.
+0002bae0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+0002baf0: 206d 6574 686f 6420 3d3d 2022 4f50 5449   method == "OPTI
+0002bb00: 4f4e 5322 3a0a 2020 2020 2020 2020 2020  ONS":.          
+0002bb10: 2020 2020 2020 6173 796e 6320 7769 7468        async with
+0002bb20: 2073 6573 7369 6f6e 2e6f 7074 696f 6e73   session.options
+0002bb30: 2875 726c 2c20 6461 7461 3d64 6174 6129  (url, data=data)
+0002bb40: 2061 7320 7265 7370 3a0a 2020 2020 2020   as resp:.      
+0002bb50: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0002bb60: 6174 7573 203d 2072 6573 702e 7374 6174  atus = resp.stat
+0002bb70: 7573 2020 2320 696e 742c 2032 3030 2073  us  # int, 200 s
+0002bb80: 7563 6365 7373 0a20 2020 2020 2020 2020  uccess.         
+0002bb90: 2020 2020 2020 2020 2020 2074 7874 203d             txt =
+0002bba0: 2061 7761 6974 2072 6573 702e 7465 7874   await resp.text
+0002bbb0: 2829 2020 2320 7374 7220 696e 2064 6963  ()  # str in dic
+0002bbc0: 7420 666f 726d 6174 0a20 2020 2020 2020  t format.       
+0002bbd0: 2069 6620 7374 6174 7573 2021 3d20 3230   if status != 20
+0002bbe0: 303a 0a20 2020 2020 2020 2020 2020 2023  0:.            #
+0002bbf0: 2074 7874 2069 7320 7374 7220 6c69 6b65   txt is str like
+0002bc00: 2074 6869 733a 0a20 2020 2020 2020 2020   this:.         
+0002bc10: 2020 2023 207b 2265 7272 636f 6465 223a     # {"errcode":
+0002bc20: 224d 5f46 4f52 4249 4444 454e 222c 2265  "M_FORBIDDEN","e
+0002bc30: 7272 6f72 223a 2259 6f75 2061 7265 206e  rror":"You are n
+0002bc40: 6f74 2061 2073 6572 7665 7220 6164 6d69  ot a server admi
+0002bc50: 6e22 7d0a 2020 2020 2020 2020 2020 2020  n"}.            
+0002bc60: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
+0002bc70: 2020 2020 2020 2020 2020 2020 2020 2245                "E
+0002bc80: 3138 373a 2022 0a20 2020 2020 2020 2020  187: ".         
+0002bc90: 2020 2020 2020 2066 2252 4553 5420 4150         f"REST AP
+0002bca0: 4920 6361 6c6c 2066 6169 6c65 642e 2046  I call failed. F
+0002bcb0: 6169 6c65 6420 7769 7468 2065 7272 6f72  ailed with error
+0002bcc0: 2063 6f64 6520 7b73 7461 7475 737d 2061   code {status} a
+0002bcd0: 6e64 2022 0a20 2020 2020 2020 2020 2020  nd ".           
+0002bce0: 2020 2020 2066 2265 7272 6f72 2074 6578       f"error tex
+0002bcf0: 7420 7b74 7874 7d2e 2049 6e70 7574 2077  t {txt}. Input w
+0002bd00: 6173 3a20 6d65 7468 6f64 3d7b 6d65 7468  as: method={meth
+0002bd10: 6f64 7d20 220a 2020 2020 2020 2020 2020  od} ".          
+0002bd20: 2020 2020 2020 6622 6461 7461 3d7b 6461        f"data={da
+0002bd30: 7461 7d2c 2075 726c 3d7b 7072 6976 6163  ta}, url={privac
+0002bd40: 795f 6669 6c74 6572 2873 7472 2875 726c  y_filter(str(url
+0002bd50: 2929 7d2e 220a 2020 2020 2020 2020 2020  ))}.".          
+0002bd60: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0002bd70: 6773 2e65 7272 5f63 6f75 6e74 202b 3d20  gs.err_count += 
+0002bd80: 310a 2020 2020 2020 2020 656c 7365 3a0a  1.        else:.
+0002bd90: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+0002bda0: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
+0002bdb0: 2020 2020 2020 2020 2020 6622 5245 5354            f"REST
+0002bdc0: 2041 5049 2063 616c 6c20 7761 7320 7375   API call was su
+0002bdd0: 6363 6573 7366 756c 2e20 220a 2020 2020  ccessful. ".    
+0002bde0: 2020 2020 2020 2020 2020 2020 6622 5265              f"Re
+0002bdf0: 7370 6f6e 7365 2069 733a 207b 7478 747d  sponse is: {txt}
+0002be00: 2e20 496e 7075 7420 7761 733a 206d 6574  . Input was: met
+0002be10: 686f 643d 7b6d 6574 686f 647d 2022 0a20  hod={method} ". 
+0002be20: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0002be30: 2264 6174 613d 7b64 6174 617d 2c20 7572  "data={data}, ur
+0002be40: 6c3d 7b70 7269 7661 6379 5f66 696c 7465  l={privacy_filte
+0002be50: 7228 7374 7228 7572 6c29 297d 2e22 0a20  r(str(url))}.". 
+0002be60: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0002be70: 2020 2020 2020 2020 2023 206f 7574 7075           # outpu
+0002be80: 7420 666f 726d 6174 2063 6f6e 7472 6f6c  t format control
+0002be90: 6c65 6420 7669 6120 2d2d 6f75 7470 7574  led via --output
+0002bea0: 2066 6c61 670a 2020 2020 2020 2020 2020   flag.          
+0002beb0: 2020 7465 7874 203d 2066 227b 7478 747d    text = f"{txt}
+0002bec0: 2220 2023 2072 6574 7572 6e73 206f 6e6c  "  # returns onl
+0002bed0: 7920 3120 7661 6c75 650a 2020 2020 2020  y 1 value.      
+0002bee0: 2020 2020 2020 6a73 6f6e 5f6d 6178 203d        json_max =
+0002bef0: 2072 6573 702e 5f5f 6469 6374 5f5f 0a20   resp.__dict__. 
+0002bf00: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+0002bf10: 6d61 782e 7570 6461 7465 287b 2272 6573  max.update({"res
+0002bf20: 706f 6e73 6522 3a20 7478 747d 2920 2023  ponse": txt})  #
+0002bf30: 2061 6464 2064 6963 7420 6974 656d 730a   add dict items.
+0002bf40: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+0002bf50: 5f20 3d20 6a73 6f6e 5f6d 6178 2e63 6f70  _ = json_max.cop
+0002bf60: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
+0002bf70: 2320 6a73 6f6e 5f2e 706f 7028 226b 6579  # json_.pop("key
+0002bf80: 2229 0a20 2020 2020 2020 2020 2020 206a  ").            j
+0002bf90: 736f 6e5f 7370 6563 203d 204e 6f6e 650a  son_spec = None.
+0002bfa0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0002bfb0: 745f 6f75 7470 7574 280a 2020 2020 2020  t_output(.      
+0002bfc0: 2020 2020 2020 2020 2020 6773 2e70 612e            gs.pa.
+0002bfd0: 6f75 7470 7574 2c0a 2020 2020 2020 2020  output,.        
+0002bfe0: 2020 2020 2020 2020 7465 7874 3d74 6578          text=tex
+0002bff0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+0002c000: 2020 206a 736f 6e5f 3d6a 736f 6e5f 2c0a     json_=json_,.
+0002c010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c020: 6a73 6f6e 5f6d 6178 3d6a 736f 6e5f 6d61  json_max=json_ma
+0002c030: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+0002c040: 2020 206a 736f 6e5f 7370 6563 3d6a 736f     json_spec=jso
+0002c050: 6e5f 7370 6563 2c0a 2020 2020 2020 2020  n_spec,.        
+0002c060: 2020 2020 290a 0a0a 6173 796e 6320 6465      )...async de
+0002c070: 6620 6163 7469 6f6e 5f67 6574 5f61 7661  f action_get_ava
+0002c080: 7461 7228 636c 6965 6e74 3a20 4173 796e  tar(client: Asyn
+0002c090: 6343 6c69 656e 742c 2063 7265 6465 6e74  cClient, credent
+0002c0a0: 6961 6c73 3a20 6469 6374 2920 2d3e 204e  ials: dict) -> N
+0002c0b0: 6f6e 653a 0a20 2020 2022 2222 4765 7420  one:.    """Get 
+0002c0c0: 6176 6174 6172 2873 2920 6f66 2069 7473  avatar(s) of its
+0002c0d0: 656c 6620 6f72 2075 7365 7273 2077 6869  elf or users whi
+0002c0e0: 6c65 2061 6c72 6561 6479 206c 6f67 6765  le already logge
+0002c0f0: 6420 696e 2e22 2222 0a20 2020 2069 6620  d in.""".    if 
+0002c100: 6773 2e70 612e 6765 745f 6176 6174 6172  gs.pa.get_avatar
+0002c110: 203d 3d20 5b5d 3a0a 2020 2020 2020 2020   == []:.        
+0002c120: 6773 2e70 612e 6765 745f 6176 6174 6172  gs.pa.get_avatar
+0002c130: 2e61 7070 656e 6428 6372 6564 656e 7469  .append(credenti
+0002c140: 616c 735b 2275 7365 725f 6964 225d 2920  als["user_id"]) 
+0002c150: 2023 2077 686f 616d 690a 2020 2020 6773   # whoami.    gs
+0002c160: 2e6c 6f67 2e64 6562 7567 2866 2247 6574  .log.debug(f"Get
+0002c170: 7469 6e67 2061 7661 7461 7273 2066 6f72  ting avatars for
+0002c180: 2074 6865 7365 2075 7365 7273 3a20 7b67   these users: {g
+0002c190: 732e 7061 2e67 6574 5f61 7661 7461 727d  s.pa.get_avatar}
+0002c1a0: 2229 0a20 2020 2066 6f72 2075 7365 725f  ").    for user_
+0002c1b0: 6964 2069 6e20 6773 2e70 612e 6765 745f  id in gs.pa.get_
+0002c1c0: 6176 6174 6172 3a0a 2020 2020 2020 2020  avatar:.        
+0002c1d0: 7573 6572 5f69 6420 3d20 7573 6572 5f69  user_id = user_i
+0002c1e0: 642e 7374 7269 7028 290a 2020 2020 2020  d.strip().      
+0002c1f0: 2020 7265 7370 203d 2061 7761 6974 2063    resp = await c
+0002c200: 6c69 656e 742e 6765 745f 6176 6174 6172  lient.get_avatar
+0002c210: 2875 7365 725f 6964 290a 2020 2020 2020  (user_id).      
+0002c220: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0002c230: 7265 7370 2c20 5072 6f66 696c 6547 6574  resp, ProfileGet
+0002c240: 4176 6174 6172 5265 7370 6f6e 7365 293a  AvatarResponse):
+0002c250: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+0002c260: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
+0002c270: 2020 2020 2020 2020 2020 2022 5072 6f66             "Prof
+0002c280: 696c 6547 6574 4176 6174 6172 5265 7370  ileGetAvatarResp
+0002c290: 6f6e 7365 2e20 5265 7370 6f6e 7365 2069  onse. Response i
+0002c2a0: 733a 2022 0a20 2020 2020 2020 2020 2020  s: ".           
+0002c2b0: 2020 2020 2066 227b 7072 6976 6163 795f       f"{privacy_
+0002c2c0: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
+0002c2d0: 297d 220a 2020 2020 2020 2020 2020 2020  )}".            
+0002c2e0: 290a 2020 2020 2020 2020 2020 2020 6176  ).            av
+0002c2f0: 6174 6172 5f6d 7863 203d 2072 6573 702e  atar_mxc = resp.
+0002c300: 6176 6174 6172 5f75 726c 0a20 2020 2020  avatar_url.     
+0002c310: 2020 2020 2020 2061 7661 7461 725f 7572         avatar_ur
+0002c320: 6c20 3d20 4e6f 6e65 0a20 2020 2020 2020  l = None.       
+0002c330: 2020 2020 2069 6620 6176 6174 6172 5f6d       if avatar_m
+0002c340: 7863 3a20 2023 2063 6f75 6c64 2062 6520  xc:  # could be 
+0002c350: 4e6f 6e65 2069 6620 6e6f 2061 7661 7461  None if no avata
+0002c360: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
+0002c370: 2020 6176 6174 6172 5f75 726c 203d 2061    avatar_url = a
+0002c380: 7761 6974 2063 6c69 656e 742e 6d78 635f  wait client.mxc_
+0002c390: 746f 5f68 7474 7028 6176 6174 6172 5f6d  to_http(avatar_m
+0002c3a0: 7863 290a 2020 2020 2020 2020 2020 2020  xc).            
+0002c3b0: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
+0002c3c0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0002c3d0: 6176 6174 6172 5f6d 7863 2069 7320 7b61  avatar_mxc is {a
+0002c3e0: 7661 7461 725f 6d78 637d 2e20 6176 6174  vatar_mxc}. avat
+0002c3f0: 6172 5f75 726c 2069 7320 7b61 7661 7461  ar_url is {avata
+0002c400: 725f 7572 6c7d 220a 2020 2020 2020 2020  r_url}".        
+0002c410: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0002c420: 2020 2320 6f75 7470 7574 2066 6f72 6d61    # output forma
+0002c430: 7420 636f 6e74 726f 6c6c 6564 2076 6961  t controlled via
+0002c440: 202d 2d6f 7574 7075 7420 666c 6167 0a20   --output flag. 
+0002c450: 2020 2020 2020 2020 2020 2074 6578 7420             text 
+0002c460: 3d20 6622 7b61 7661 7461 725f 6d78 637d  = f"{avatar_mxc}
+0002c470: 7b53 4550 7d7b 6176 6174 6172 5f75 726c  {SEP}{avatar_url
+0002c480: 7d22 0a20 2020 2020 2020 2020 2020 2023  }".            #
+0002c490: 204f 626a 6563 7420 6f66 2074 7970 6520   Object of type 
+0002c4a0: 7878 7852 6573 706f 6e73 6520 6973 206e  xxxResponse is n
+0002c4b0: 6f74 204a 534f 4e0a 2020 2020 2020 2020  ot JSON.        
+0002c4c0: 2020 2020 2320 7365 7269 616c 697a 6162      # serializab
+0002c4d0: 6c65 2c20 6865 6e63 6520 7765 2075 7365  le, hence we use
+0002c4e0: 2074 6865 2064 6963 7469 6f6e 6172 792e   the dictionary.
+0002c4f0: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
+0002c500: 6e5f 6d61 7820 3d20 7265 7370 2e5f 5f64  n_max = resp.__d
+0002c510: 6963 745f 5f0a 2020 2020 2020 2020 2020  ict__.          
+0002c520: 2020 6a73 6f6e 5f6d 6178 2e75 7064 6174    json_max.updat
+0002c530: 6528 7b22 6176 6174 6172 5f68 7474 7022  e({"avatar_http"
+0002c540: 3a20 6176 6174 6172 5f75 726c 7d29 2020  : avatar_url})  
+0002c550: 2320 6164 6420 6469 6374 2069 7465 6d73  # add dict items
+0002c560: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
+0002c570: 6e5f 203d 206a 736f 6e5f 6d61 782e 636f  n_ = json_max.co
+0002c580: 7079 2829 0a20 2020 2020 2020 2020 2020  py().           
+0002c590: 206a 736f 6e5f 2e70 6f70 2822 7472 616e   json_.pop("tran
+0002c5a0: 7370 6f72 745f 7265 7370 6f6e 7365 2229  sport_response")
+0002c5b0: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
+0002c5c0: 6e5f 7370 6563 203d 204e 6f6e 650a 2020  n_spec = None.  
+0002c5d0: 2020 2020 2020 2020 2020 7072 696e 745f            print_
+0002c5e0: 6f75 7470 7574 280a 2020 2020 2020 2020  output(.        
+0002c5f0: 2020 2020 2020 2020 6773 2e70 612e 6f75          gs.pa.ou
+0002c600: 7470 7574 2c0a 2020 2020 2020 2020 2020  tput,.          
+0002c610: 2020 2020 2020 7465 7874 3d74 6578 742c        text=text,
+0002c620: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002c630: 206a 736f 6e5f 3d6a 736f 6e5f 2c0a 2020   json_=json_,.  
+0002c640: 2020 2020 2020 2020 2020 2020 2020 6a73                js
+0002c650: 6f6e 5f6d 6178 3d6a 736f 6e5f 6d61 782c  on_max=json_max,
+0002c660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002c670: 206a 736f 6e5f 7370 6563 3d6a 736f 6e5f   json_spec=json_
+0002c680: 7370 6563 2c0a 2020 2020 2020 2020 2020  spec,.          
+0002c690: 2020 290a 2020 2020 2020 2020 656c 7365    ).        else
+0002c6a0: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
+0002c6b0: 2e6c 6f67 2e65 7272 6f72 280a 2020 2020  .log.error(.    
+0002c6c0: 2020 2020 2020 2020 2020 2020 2245 3138              "E18
+0002c6d0: 383a 2022 0a20 2020 2020 2020 2020 2020  8: ".           
+0002c6e0: 2020 2020 2066 2246 6169 6c65 6420 6765       f"Failed ge
+0002c6f0: 7474 696e 6720 6176 6174 6172 2066 6f72  tting avatar for
+0002c700: 2075 7365 7220 7b75 7365 725f 6964 7d20   user {user_id} 
+0002c710: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0002c720: 2020 6622 6672 6f6d 2073 6572 7665 722e    f"from server.
+0002c730: 207b 7072 6976 6163 795f 6669 6c74 6572   {privacy_filter
+0002c740: 2873 7472 2872 6573 7029 297d 220a 2020  (str(resp))}".  
+0002c750: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0002c760: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
+0002c770: 6f75 6e74 202b 3d20 310a 0a0a 6173 796e  ount += 1...asyn
+0002c780: 6320 6465 6620 6163 7469 6f6e 5f67 6574  c def action_get
+0002c790: 5f70 726f 6669 6c65 2863 6c69 656e 743a  _profile(client:
+0002c7a0: 2041 7379 6e63 436c 6965 6e74 2c20 6372   AsyncClient, cr
+0002c7b0: 6564 656e 7469 616c 733a 2064 6963 7429  edentials: dict)
+0002c7c0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2222   -> None:.    ""
+0002c7d0: 2247 6574 2075 7365 7220 7072 6f66 696c  "Get user profil
+0002c7e0: 6528 7329 206f 6620 6974 7365 6c66 206f  e(s) of itself o
+0002c7f0: 7220 7573 6572 7320 7768 696c 6520 616c  r users while al
+0002c800: 7265 6164 7920 6c6f 6767 6564 2069 6e2e  ready logged in.
+0002c810: 2222 220a 2020 2020 6966 2067 732e 7061  """.    if gs.pa
+0002c820: 2e67 6574 5f70 726f 6669 6c65 203d 3d20  .get_profile == 
+0002c830: 5b5d 3a0a 2020 2020 2020 2020 6773 2e70  []:.        gs.p
+0002c840: 612e 6765 745f 7072 6f66 696c 652e 6170  a.get_profile.ap
+0002c850: 7065 6e64 2863 7265 6465 6e74 6961 6c73  pend(credentials
+0002c860: 5b22 7573 6572 5f69 6422 5d29 2020 2320  ["user_id"])  # 
+0002c870: 7768 6f61 6d69 0a20 2020 2067 732e 6c6f  whoami.    gs.lo
+0002c880: 672e 6465 6275 6728 6622 4765 7474 696e  g.debug(f"Gettin
+0002c890: 6720 7573 6572 2070 726f 6669 6c65 7320  g user profiles 
+0002c8a0: 666f 7220 7468 6573 6520 7573 6572 733a  for these users:
+0002c8b0: 207b 6773 2e70 612e 6765 745f 7072 6f66   {gs.pa.get_prof
+0002c8c0: 696c 657d 2229 0a20 2020 2066 6f72 2075  ile}").    for u
+0002c8d0: 7365 725f 6964 2069 6e20 6773 2e70 612e  ser_id in gs.pa.
+0002c8e0: 6765 745f 7072 6f66 696c 653a 0a20 2020  get_profile:.   
+0002c8f0: 2020 2020 2075 7365 725f 6964 203d 2075       user_id = u
+0002c900: 7365 725f 6964 2e73 7472 6970 2829 0a20  ser_id.strip(). 
+0002c910: 2020 2020 2020 2072 6573 7020 3d20 6177         resp = aw
+0002c920: 6169 7420 636c 6965 6e74 2e67 6574 5f70  ait client.get_p
+0002c930: 726f 6669 6c65 2875 7365 725f 6964 290a  rofile(user_id).
+0002c940: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+0002c950: 7461 6e63 6528 7265 7370 2c20 5072 6f66  tance(resp, Prof
+0002c960: 696c 6547 6574 4572 726f 7229 3a0a 2020  ileGetError):.  
+0002c970: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
+0002c980: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
+0002c990: 2020 2020 2020 2020 2245 3138 393a 2022          "E189: "
+0002c9a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002c9b0: 2066 2246 6169 6c65 6420 6765 7474 696e   f"Failed gettin
+0002c9c0: 6720 7072 6f66 696c 6520 666f 7220 7573  g profile for us
+0002c9d0: 6572 207b 7573 6572 5f69 647d 2022 0a20  er {user_id} ". 
+0002c9e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0002c9f0: 2266 726f 6d20 7365 7276 6572 2e20 7b70  "from server. {p
+0002ca00: 7269 7661 6379 5f66 696c 7465 7228 7374  rivacy_filter(st
+0002ca10: 7228 7265 7370 2929 7d22 0a20 2020 2020  r(resp))}".     
+0002ca20: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0002ca30: 2020 2020 2067 732e 6572 725f 636f 756e       gs.err_coun
+0002ca40: 7420 2b3d 2031 0a20 2020 2020 2020 2065  t += 1.        e
+0002ca50: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0002ca60: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
+0002ca70: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0002ca80: 2250 726f 6669 6c65 4765 7452 6573 706f  "ProfileGetRespo
+0002ca90: 6e73 652e 2052 6573 706f 6e73 6520 6973  nse. Response is
+0002caa0: 3a20 7b70 7269 7661 6379 5f66 696c 7465  : {privacy_filte
+0002cab0: 7228 7374 7228 7265 7370 2929 7d22 0a20  r(str(resp))}". 
+0002cac0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0002cad0: 2020 2020 2020 2020 2064 6973 706c 6179           display
+0002cae0: 6e61 6d65 203d 2072 6573 702e 6469 7370  name = resp.disp
+0002caf0: 6c61 796e 616d 650a 2020 2020 2020 2020  layname.        
+0002cb00: 2020 2020 6176 6174 6172 5f6d 7863 203d      avatar_mxc =
+0002cb10: 2072 6573 702e 6176 6174 6172 5f75 726c   resp.avatar_url
+0002cb20: 0a20 2020 2020 2020 2020 2020 2061 7661  .            ava
+0002cb30: 7461 725f 7572 6c20 3d20 4e6f 6e65 0a20  tar_url = None. 
+0002cb40: 2020 2020 2020 2020 2020 2069 6620 6176             if av
+0002cb50: 6174 6172 5f6d 7863 3a20 2023 2063 6f75  atar_mxc:  # cou
+0002cb60: 6c64 2062 6520 4e6f 6e65 2069 6620 6e6f  ld be None if no
+0002cb70: 2061 7661 7461 720a 2020 2020 2020 2020   avatar.        
+0002cb80: 2020 2020 2020 2020 6176 6174 6172 5f75          avatar_u
+0002cb90: 726c 203d 2061 7761 6974 2063 6c69 656e  rl = await clien
+0002cba0: 742e 6d78 635f 746f 5f68 7474 7028 6176  t.mxc_to_http(av
+0002cbb0: 6174 6172 5f6d 7863 290a 2020 2020 2020  atar_mxc).      
+0002cbc0: 2020 2020 2020 6f74 6865 725f 696e 666f        other_info
+0002cbd0: 203d 2072 6573 702e 6f74 6865 725f 696e   = resp.other_in
+0002cbe0: 666f 0a20 2020 2020 2020 2020 2020 2069  fo.            i
+0002cbf0: 6620 6e6f 7420 6f74 6865 725f 696e 666f  f not other_info
+0002cc00: 3a20 2023 2065 6d70 7479 2064 6963 740a  :  # empty dict.
+0002cc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cc20: 6f74 6865 725f 696e 666f 203d 2022 220a  other_info = "".
+0002cc30: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+0002cc40: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
+0002cc50: 2020 2020 2020 2020 2020 6622 6469 7370            f"disp
+0002cc60: 6c61 796e 616d 6520 6973 207b 6469 7370  layname is {disp
+0002cc70: 6c61 796e 616d 657d 2e20 6176 6174 6172  layname}. avatar
+0002cc80: 5f6d 7863 2069 7320 7b61 7661 7461 725f  _mxc is {avatar_
+0002cc90: 6d78 637d 2e20 220a 2020 2020 2020 2020  mxc}. ".        
+0002cca0: 2020 2020 2020 2020 6622 6176 6174 6172          f"avatar
+0002ccb0: 5f75 726c 2069 7320 7b61 7661 7461 725f  _url is {avatar_
+0002ccc0: 7572 6c7d 2e20 6f74 6865 725f 696e 666f  url}. other_info
+0002ccd0: 2069 7320 7b72 6573 702e 6f74 6865 725f   is {resp.other_
+0002cce0: 696e 666f 7d2e 220a 2020 2020 2020 2020  info}.".        
+0002ccf0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0002cd00: 2020 2320 6f75 7470 7574 2066 6f72 6d61    # output forma
+0002cd10: 7420 636f 6e74 726f 6c6c 6564 2076 6961  t controlled via
+0002cd20: 202d 2d6f 7574 7075 7420 666c 6167 0a20   --output flag. 
+0002cd30: 2020 2020 2020 2020 2020 2074 6578 7420             text 
+0002cd40: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+0002cd50: 2020 2020 6622 7b64 6973 706c 6179 6e61      f"{displayna
+0002cd60: 6d65 7d7b 5345 507d 7b61 7661 7461 725f  me}{SEP}{avatar_
+0002cd70: 6d78 637d 7b53 4550 7d7b 6176 6174 6172  mxc}{SEP}{avatar
+0002cd80: 5f75 726c 7d22 0a20 2020 2020 2020 2020  _url}".         
+0002cd90: 2020 2020 2020 2066 227b 5345 507d 7b6f         f"{SEP}{o
+0002cda0: 7468 6572 5f69 6e66 6f7d 220a 2020 2020  ther_info}".    
+0002cdb0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0002cdc0: 2020 2020 2020 2320 4f62 6a65 6374 206f        # Object o
+0002cdd0: 6620 7479 7065 2078 7878 5265 7370 6f6e  f type xxxRespon
+0002cde0: 7365 2069 7320 6e6f 7420 4a53 4f4e 0a20  se is not JSON. 
+0002cdf0: 2020 2020 2020 2020 2020 2023 2073 6572             # ser
+0002ce00: 6961 6c69 7a61 626c 652c 2068 656e 6365  ializable, hence
+0002ce10: 2077 6520 7573 6520 7468 6520 6469 6374   we use the dict
+0002ce20: 696f 6e61 7279 2e0a 2020 2020 2020 2020  ionary..        
+0002ce30: 2020 2020 6a73 6f6e 5f6d 6178 203d 2072      json_max = r
+0002ce40: 6573 702e 5f5f 6469 6374 5f5f 0a20 2020  esp.__dict__.   
+0002ce50: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
+0002ce60: 782e 7570 6461 7465 287b 2261 7661 7461  x.update({"avata
+0002ce70: 725f 6874 7470 223a 2061 7661 7461 725f  r_http": avatar_
+0002ce80: 7572 6c7d 2920 2023 2061 6464 2064 6963  url})  # add dic
+0002ce90: 7420 6974 656d 730a 2020 2020 2020 2020  t items.        
+0002cea0: 2020 2020 6a73 6f6e 5f20 3d20 6a73 6f6e      json_ = json
+0002ceb0: 5f6d 6178 2e63 6f70 7928 290a 2020 2020  _max.copy().    
+0002cec0: 2020 2020 2020 2020 6a73 6f6e 5f2e 706f          json_.po
+0002ced0: 7028 2274 7261 6e73 706f 7274 5f72 6573  p("transport_res
+0002cee0: 706f 6e73 6522 290a 2020 2020 2020 2020  ponse").        
+0002cef0: 2020 2020 6a73 6f6e 5f73 7065 6320 3d20      json_spec = 
+0002cf00: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+0002cf10: 2070 7269 6e74 5f6f 7574 7075 7428 0a20   print_output(. 
+0002cf20: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0002cf30: 732e 7061 2e6f 7574 7075 742c 0a20 2020  s.pa.output,.   
+0002cf40: 2020 2020 2020 2020 2020 2020 2074 6578               tex
+0002cf50: 743d 7465 7874 2c0a 2020 2020 2020 2020  t=text,.        
+0002cf60: 2020 2020 2020 2020 6a73 6f6e 5f3d 6a73          json_=js
+0002cf70: 6f6e 5f2c 0a20 2020 2020 2020 2020 2020  on_,.           
+0002cf80: 2020 2020 206a 736f 6e5f 6d61 783d 6a73       json_max=js
+0002cf90: 6f6e 5f6d 6178 2c0a 2020 2020 2020 2020  on_max,.        
+0002cfa0: 2020 2020 2020 2020 6a73 6f6e 5f73 7065          json_spe
+0002cfb0: 633d 6a73 6f6e 5f73 7065 632c 0a20 2020  c=json_spec,.   
+0002cfc0: 2020 2020 2020 2020 2029 0a0a 0a61 7379           )...asy
+0002cfd0: 6e63 2064 6566 2061 6374 696f 6e5f 6765  nc def action_ge
+0002cfe0: 745f 636c 6965 6e74 5f69 6e66 6f28 0a20  t_client_info(. 
+0002cff0: 2020 2063 6c69 656e 743a 2041 7379 6e63     client: Async
+0002d000: 436c 6965 6e74 2c20 6372 6564 656e 7469  Client, credenti
+0002d010: 616c 733a 2064 6963 740a 2920 2d3e 204e  als: dict.) -> N
+0002d020: 6f6e 653a 0a20 2020 2022 2222 4765 7420  one:.    """Get 
+0002d030: 636c 6965 6e74 2069 6e66 6f20 7768 696c  client info whil
+0002d040: 6520 616c 7265 6164 7920 6c6f 6767 6564  e already logged
+0002d050: 2069 6e2e 2222 220a 2020 2020 6773 2e6c   in.""".    gs.l
+0002d060: 6f67 2e64 6562 7567 2822 4765 7474 696e  og.debug("Gettin
+0002d070: 6720 636c 6965 6e74 2069 6e66 6f2e 2229  g client info.")
+0002d080: 0a20 2020 2061 7761 6974 2073 796e 6368  .    await synch
+0002d090: 726f 6e69 7a65 2863 6c69 656e 7429 2020  ronize(client)  
+0002d0a0: 2320 7379 6e63 2829 2074 6f20 6765 7420  # sync() to get 
+0002d0b0: 726f 6f6d 730a 2020 2020 7072 696e 7428  rooms.    print(
+0002d0c0: 6a73 6f6e 2e64 756d 7073 2863 6c69 656e  json.dumps(clien
+0002d0d0: 742e 5f5f 6469 6374 5f5f 2c20 6465 6661  t.__dict__, defa
+0002d0e0: 756c 743d 6f62 6a5f 746f 5f64 6963 7429  ult=obj_to_dict)
+0002d0f0: 290a 0a0a 6173 796e 6320 6465 6620 6163  )...async def ac
+0002d100: 7469 6f6e 5f67 6574 5f72 6f6f 6d5f 696e  tion_get_room_in
+0002d110: 666f 2863 6c69 656e 743a 2041 7379 6e63  fo(client: Async
+0002d120: 436c 6965 6e74 2c20 6372 6564 656e 7469  Client, credenti
+0002d130: 616c 733a 2064 6963 7429 202d 3e20 4e6f  als: dict) -> No
+0002d140: 6e65 3a0a 2020 2020 2222 2247 6574 2072  ne:.    """Get r
+0002d150: 6f6f 6d20 6469 7370 6c61 7920 6e61 6d65  oom display name
+0002d160: 2873 2920 6f66 2069 7473 656c 6620 6f72  (s) of itself or
+0002d170: 2072 6f6f 6d73 2077 6869 6c65 2061 6c72   rooms while alr
+0002d180: 6561 6479 206c 6f67 6765 6420 696e 2e22  eady logged in."
+0002d190: 2222 0a20 2020 2069 6620 6773 2e70 612e  "".    if gs.pa.
+0002d1a0: 6765 745f 726f 6f6d 5f69 6e66 6f20 3d3d  get_room_info ==
+0002d1b0: 205b 5d3a 0a20 2020 2020 2020 2067 732e   []:.        gs.
+0002d1c0: 7061 2e67 6574 5f72 6f6f 6d5f 696e 666f  pa.get_room_info
+0002d1d0: 2e61 7070 656e 6428 6372 6564 656e 7469  .append(credenti
+0002d1e0: 616c 735b 2272 6f6f 6d5f 6964 225d 290a  als["room_id"]).
+0002d1f0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+0002d200: 280a 2020 2020 2020 2020 2247 6574 7469  (.        "Getti
+0002d210: 6e67 2072 6f6f 6d20 6469 7370 6c61 7920  ng room display 
+0002d220: 6e61 6d65 7320 666f 7220 7468 6573 6520  names for these 
+0002d230: 726f 6f6d 733a 2022 2066 227b 6773 2e70  rooms: " f"{gs.p
+0002d240: 612e 6765 745f 726f 6f6d 5f69 6e66 6f7d  a.get_room_info}
+0002d250: 220a 2020 2020 290a 2020 2020 6177 6169  ".    ).    awai
+0002d260: 7420 7379 6e63 6872 6f6e 697a 6528 636c  t synchronize(cl
+0002d270: 6965 6e74 2920 2023 2073 796e 6328 2920  ient)  # sync() 
+0002d280: 746f 2067 6574 2072 6f6f 6d73 0a20 2020  to get rooms.   
+0002d290: 2023 2075 7365 725f 6964 203d 2063 7265   # user_id = cre
+0002d2a0: 6465 6e74 6961 6c73 5b22 7573 6572 5f69  dentials["user_i
+0002d2b0: 6422 5d0a 2020 2020 666f 7220 726f 6f6d  d"].    for room
+0002d2c0: 5f69 6420 696e 2067 732e 7061 2e67 6574  _id in gs.pa.get
+0002d2d0: 5f72 6f6f 6d5f 696e 666f 3a0a 2020 2020  _room_info:.    
+0002d2e0: 2020 2020 726f 6f6d 5f69 6420 3d20 6177      room_id = aw
+0002d2f0: 6169 7420 6d61 705f 726f 6f6d 696e 666f  ait map_roominfo
+0002d300: 5f74 6f5f 726f 6f6d 6964 2863 6c69 656e  _to_roomid(clien
+0002d310: 742c 2072 6f6f 6d5f 6964 290a 2020 2020  t, room_id).    
+0002d320: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0002d330: 2020 2020 2072 6f6f 6d20 3d20 636c 6965       room = clie
+0002d340: 6e74 2e72 6f6f 6d73 5b72 6f6f 6d5f 6964  nt.rooms[room_id
+0002d350: 5d0a 2020 2020 2020 2020 2020 2020 726f  ].            ro
+0002d360: 6f6d 5f64 6973 706c 6179 6e61 6d65 203d  om_displayname =
+0002d370: 2072 6f6f 6d2e 6469 7370 6c61 795f 6e61   room.display_na
+0002d380: 6d65 0a20 2020 2020 2020 2065 7863 6570  me.        excep
+0002d390: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+0002d3a0: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
+0002d3b0: 2e6c 6f67 2e65 7272 6f72 280a 2020 2020  .log.error(.    
+0002d3c0: 2020 2020 2020 2020 2020 2020 2245 3139              "E19
+0002d3d0: 303a 2022 0a20 2020 2020 2020 2020 2020  0: ".           
+0002d3e0: 2020 2020 2066 2246 6169 6c65 6420 6765       f"Failed ge
+0002d3f0: 7474 696e 6720 726f 6f6d 2064 6973 706c  tting room displ
+0002d400: 6179 206e 616d 6520 666f 7220 726f 6f6d  ay name for room
+0002d410: 207b 726f 6f6d 5f69 647d 2022 0a20 2020   {room_id} ".   
+0002d420: 2020 2020 2020 2020 2020 2020 2066 2266               f"f
+0002d430: 726f 6d20 7365 7276 6572 2e20 220a 2020  rom server. ".  
+0002d440: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0002d450: 4578 6365 7074 696f 6e20 6973 207b 657d  Exception is {e}
+0002d460: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
+0002d470: 2020 2020 6622 526f 6f6d 2069 7320 7b72      f"Room is {r
+0002d480: 6f6f 6d7d 2e20 526f 6f6d 2064 6963 7420  oom}. Room dict 
+0002d490: 6973 207b 726f 6f6d 2e5f 5f64 6963 745f  is {room.__dict_
+0002d4a0: 5f7d 2e20 220a 2020 2020 2020 2020 2020  _}. ".          
+0002d4b0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0002d4c0: 6773 2e65 7272 5f63 6f75 6e74 202b 3d20  gs.err_count += 
+0002d4d0: 310a 2020 2020 2020 2020 656c 7365 3a0a  1.        else:.
+0002d4e0: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+0002d4f0: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
+0002d500: 2020 2020 2020 2020 2020 6622 726f 6f6d            f"room
+0002d510: 2069 6420 6973 207b 726f 6f6d 5f69 647d   id is {room_id}
+0002d520: 2c20 220a 2020 2020 2020 2020 2020 2020  , ".            
+0002d530: 2020 2020 6622 726f 6f6d 2064 6973 706c      f"room displ
+0002d540: 6179 206e 616d 6520 6973 207b 726f 6f6d  ay name is {room
+0002d550: 5f64 6973 706c 6179 6e61 6d65 7d2c 2022  _displayname}, "
+0002d560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d570: 2066 2272 6f6f 6d20 6973 207b 726f 6f6d   f"room is {room
+0002d580: 7d2e 2022 0a20 2020 2020 2020 2020 2020  }. ".           
+0002d590: 2029 0a20 2020 2020 2020 2020 2020 2072   ).            r
+0002d5a0: 6573 7020 3d20 726f 6f6d 0a20 2020 2020  esp = room.     
+0002d5b0: 2020 2020 2020 2023 206f 7574 7075 7420         # output 
+0002d5c0: 666f 726d 6174 2063 6f6e 7472 6f6c 6c65  format controlle
+0002d5d0: 6420 7669 6120 2d2d 6f75 7470 7574 2066  d via --output f
+0002d5e0: 6c61 670a 2020 2020 2020 2020 2020 2020  lag.            
+0002d5f0: 7465 7874 203d 2028 0a20 2020 2020 2020  text = (.       
+0002d600: 2020 2020 2020 2020 2066 227b 726f 6f6d           f"{room
+0002d610: 5f69 647d 7b53 4550 7d7b 726f 6f6d 5f64  _id}{SEP}{room_d
+0002d620: 6973 706c 6179 6e61 6d65 7d7b 5345 507d  isplayname}{SEP}
+0002d630: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0002d640: 2020 6622 7b72 6f6f 6d2e 6361 6e6f 6e69    f"{room.canoni
+0002d650: 6361 6c5f 616c 6961 737d 7b53 4550 7d7b  cal_alias}{SEP}{
+0002d660: 726f 6f6d 2e74 6f70 6963 7d7b 5345 507d  room.topic}{SEP}
+0002d670: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0002d680: 2020 6622 7b72 6f6f 6d2e 6372 6561 746f    f"{room.creato
+0002d690: 727d 7b53 4550 7d7b 726f 6f6d 2e65 6e63  r}{SEP}{room.enc
+0002d6a0: 7279 7074 6564 7d22 0a20 2020 2020 2020  rypted}".       
+0002d6b0: 2020 2020 2020 2020 2023 2066 227b 5345           # f"{SE
+0002d6c0: 507d 7b75 7365 725f 6964 7d22 0a20 2020  P}{user_id}".   
+0002d6d0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0002d6e0: 2020 2020 2020 2023 204f 626a 6563 7420         # Object 
+0002d6f0: 6f66 2074 7970 6520 7878 7852 6573 706f  of type xxxRespo
+0002d700: 6e73 6520 6973 206e 6f74 204a 534f 4e0a  nse is not JSON.
+0002d710: 2020 2020 2020 2020 2020 2020 2320 7365              # se
+0002d720: 7269 616c 697a 6162 6c65 2c20 6865 6e63  rializable, henc
+0002d730: 6520 7765 2075 7365 2074 6865 2064 6963  e we use the dic
+0002d740: 7469 6f6e 6172 792e 0a20 2020 2020 2020  tionary..       
+0002d750: 2020 2020 206a 736f 6e5f 6d61 7820 3d20       json_max = 
+0002d760: 7265 7370 2e5f 5f64 6963 745f 5f0a 2020  resp.__dict__.  
+0002d770: 2020 2020 2020 2020 2020 6a73 6f6e 5f6d            json_m
+0002d780: 6178 2e75 7064 6174 6528 0a20 2020 2020  ax.update(.     
+0002d790: 2020 2020 2020 2020 2020 207b 2264 6973             {"dis
+0002d7a0: 706c 6179 5f6e 616d 6522 3a20 726f 6f6d  play_name": room
+0002d7b0: 5f64 6973 706c 6179 6e61 6d65 7d0a 2020  _displayname}.  
+0002d7c0: 2020 2020 2020 2020 2020 2920 2023 2061            )  # a
+0002d7d0: 6464 2064 6963 7420 6974 656d 730a 2020  dd dict items.  
+0002d7e0: 2020 2020 2020 2020 2020 6a73 6f6e 5f20            json_ 
+0002d7f0: 3d20 6a73 6f6e 5f6d 6178 2e63 6f70 7928  = json_max.copy(
+0002d800: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+0002d810: 6a73 6f6e 5f2e 706f 7028 226b 6579 2229  json_.pop("key")
+0002d820: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
+0002d830: 6e5f 7370 6563 203d 204e 6f6e 650a 2020  n_spec = None.  
+0002d840: 2020 2020 2020 2020 2020 7072 696e 745f            print_
+0002d850: 6f75 7470 7574 280a 2020 2020 2020 2020  output(.        
+0002d860: 2020 2020 2020 2020 6773 2e70 612e 6f75          gs.pa.ou
+0002d870: 7470 7574 2c0a 2020 2020 2020 2020 2020  tput,.          
+0002d880: 2020 2020 2020 7465 7874 3d74 6578 742c        text=text,
+0002d890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d8a0: 206a 736f 6e5f 3d6a 736f 6e5f 2c0a 2020   json_=json_,.  
+0002d8b0: 2020 2020 2020 2020 2020 2020 2020 6a73                js
+0002d8c0: 6f6e 5f6d 6178 3d6a 736f 6e5f 6d61 782c  on_max=json_max,
+0002d8d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d8e0: 206a 736f 6e5f 7370 6563 3d6a 736f 6e5f   json_spec=json_
+0002d8f0: 7370 6563 2c0a 2020 2020 2020 2020 2020  spec,.          
+0002d900: 2020 290a 0a0a 6173 796e 6320 6465 6620    )...async def 
+0002d910: 6163 7469 6f6e 5f68 6173 5f70 6572 6d69  action_has_permi
+0002d920: 7373 696f 6e28 0a20 2020 2063 6c69 656e  ssion(.    clien
+0002d930: 743a 2041 7379 6e63 436c 6965 6e74 2c20  t: AsyncClient, 
+0002d940: 6372 6564 656e 7469 616c 733a 2064 6963  credentials: dic
+0002d950: 740a 2920 2d3e 204e 6f6e 653a 0a20 2020  t.) -> None:.   
+0002d960: 2022 2222 496e 7175 6972 6520 6162 6f75   """Inquire abou
+0002d970: 7420 7065 726d 6973 7369 6f6e 7320 696e  t permissions in
+0002d980: 2072 6f6f 6d73 2077 6869 6c65 2061 6c72   rooms while alr
+0002d990: 6561 6479 206c 6f67 6765 6420 696e 2e22  eady logged in."
+0002d9a0: 2222 0a20 2020 2069 6620 6e6f 7420 6c65  "".    if not le
+0002d9b0: 6e28 6773 2e70 612e 6861 735f 7065 726d  n(gs.pa.has_perm
+0002d9c0: 6973 7369 6f6e 2920 2520 3220 3d3d 2030  ission) % 2 == 0
+0002d9d0: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
+0002d9e0: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
+0002d9f0: 2020 2020 2245 3139 313a 2022 0a20 2020      "E191: ".   
+0002da00: 2020 2020 2020 2020 2022 496e 636f 7272           "Incorr
+0002da10: 6563 7420 6e75 6d62 6572 206f 6620 6172  ect number of ar
+0002da20: 6775 6d65 6e74 7320 666f 7220 2d2d 6861  guments for --ha
+0002da30: 732d 7065 726d 6973 7369 6f6e 2e20 4172  s-permission. Ar
+0002da40: 6775 6d65 6e74 7320 220a 2020 2020 2020  guments ".      
+0002da50: 2020 2020 2020 226d 7573 7420 6265 2070        "must be p
+0002da60: 6169 7273 2c20 692e 652e 206d 756c 7469  airs, i.e. multi
+0002da70: 706c 6573 206f 6620 322c 2062 7574 2066  ples of 2, but f
+0002da80: 6f75 6e64 2022 0a20 2020 2020 2020 2020  ound ".         
+0002da90: 2020 2066 227b 6c65 6e28 6773 2e70 612e     f"{len(gs.pa.
+0002daa0: 6861 735f 7065 726d 6973 7369 6f6e 297d  has_permission)}
+0002dab0: 2061 7267 756d 656e 7473 2e22 0a20 2020   arguments.".   
+0002dac0: 2020 2020 2029 0a20 2020 2020 2020 2067       ).        g
+0002dad0: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
+0002dae0: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
+0002daf0: 2020 2020 7573 6572 5f69 6420 3d20 6372      user_id = cr
+0002db00: 6564 656e 7469 616c 735b 2275 7365 725f  edentials["user_
+0002db10: 6964 225d 2020 2320 7768 6f61 6d69 0a20  id"]  # whoami. 
+0002db20: 2020 2066 6f72 2069 6920 696e 2072 616e     for ii in ran
+0002db30: 6765 286c 656e 2867 732e 7061 2e68 6173  ge(len(gs.pa.has
+0002db40: 5f70 6572 6d69 7373 696f 6e29 202f 2f20  _permission) // 
+0002db50: 3229 3a0a 2020 2020 2020 2020 726f 6f6d  2):.        room
+0002db60: 5f69 6420 3d20 6773 2e70 612e 6861 735f  _id = gs.pa.has_
+0002db70: 7065 726d 6973 7369 6f6e 5b69 6920 2a20  permission[ii * 
+0002db80: 3220 2b20 305d 0a20 2020 2020 2020 2072  2 + 0].        r
+0002db90: 6f6f 6d5f 6964 203d 2072 6f6f 6d5f 6964  oom_id = room_id
+0002dba0: 2e72 6570 6c61 6365 2872 225c 2122 2c20  .replace(r"\!", 
+0002dbb0: 2221 2229 2020 2320 7265 6d6f 7665 2070  "!")  # remove p
+0002dbc0: 6f73 7369 626c 6520 6573 6361 7065 0a20  ossible escape. 
+0002dbd0: 2020 2020 2020 2072 6f6f 6d5f 6964 203d         room_id =
+0002dbe0: 2061 7761 6974 206d 6170 5f72 6f6f 6d69   await map_roomi
+0002dbf0: 6e66 6f5f 746f 5f72 6f6f 6d69 6428 636c  nfo_to_roomid(cl
+0002dc00: 6965 6e74 2c20 726f 6f6d 5f69 6429 0a20  ient, room_id). 
+0002dc10: 2020 2020 2020 2070 6572 6d69 7373 696f         permissio
+0002dc20: 6e5f 7479 7065 203d 2067 732e 7061 2e68  n_type = gs.pa.h
+0002dc30: 6173 5f70 6572 6d69 7373 696f 6e5b 6969  as_permission[ii
+0002dc40: 202a 2032 202b 2031 5d2e 7374 7269 7028   * 2 + 1].strip(
+0002dc50: 290a 2020 2020 2020 2020 6773 2e6c 6f67  ).        gs.log
+0002dc60: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+0002dc70: 2020 2020 2250 7265 7061 7269 6e67 2074      "Preparing t
+0002dc80: 6f20 6173 6b20 6162 6f75 7420 7065 726d  o ask about perm
+0002dc90: 6973 7369 6f6e 2066 6f72 2070 6572 6d69  ission for permi
+0002dca0: 7373 696f 6e20 7479 7065 2022 0a20 2020  ssion type ".   
+0002dcb0: 2020 2020 2020 2020 2066 2227 7b70 6572           f"'{per
+0002dcc0: 6d69 7373 696f 6e5f 7479 7065 7d27 2069  mission_type}' i
+0002dcd0: 6e20 726f 6f6d 207b 726f 6f6d 5f69 647d  n room {room_id}
+0002dce0: 2e22 0a20 2020 2020 2020 2029 0a20 2020  .".        ).   
+0002dcf0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0002dd00: 2020 2020 2020 7265 7370 203d 2061 7761        resp = awa
+0002dd10: 6974 2063 6c69 656e 742e 6861 735f 7065  it client.has_pe
+0002dd20: 726d 6973 7369 6f6e 2872 6f6f 6d5f 6964  rmission(room_id
+0002dd30: 2c20 7065 726d 6973 7369 6f6e 5f74 7970  , permission_typ
+0002dd40: 6529 0a20 2020 2020 2020 2065 7863 6570  e).        excep
+0002dd50: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+0002dd60: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0002dd70: 7370 203d 2045 7272 6f72 5265 7370 6f6e  sp = ErrorRespon
+0002dd80: 7365 280a 2020 2020 2020 2020 2020 2020  se(.            
+0002dd90: 2020 2020 2245 3139 323a 2022 0a20 2020      "E192: ".   
+0002dda0: 2020 2020 2020 2020 2020 2020 2066 2268               f"h
+0002ddb0: 6173 5f70 6572 6d69 7373 696f 6e28 2920  as_permission() 
+0002ddc0: 6661 696c 6564 2077 6974 6820 277b 657d  failed with '{e}
+0002ddd0: 272e 2022 0a20 2020 2020 2020 2020 2020  '. ".           
+0002dde0: 2020 2020 2066 2249 7320 7468 6520 726f       f"Is the ro
+0002ddf0: 6f6d 2069 6420 7b72 6f6f 6d5f 6964 7d20  om id {room_id} 
+0002de00: 636f 7272 6563 743f 220a 2020 2020 2020  correct?".      
+0002de10: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0002de20: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
+0002de30: 7370 2c20 4572 726f 7252 6573 706f 6e73  sp, ErrorRespons
+0002de40: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+0002de50: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
+0002de60: 2020 2020 2020 2020 2020 2020 2020 2245                "E
+0002de70: 3139 333a 2022 0a20 2020 2020 2020 2020  193: ".         
+0002de80: 2020 2020 2020 2022 4661 696c 6564 2074         "Failed t
+0002de90: 6f20 6173 6b20 6162 6f75 7420 7065 726d  o ask about perm
+0002dea0: 6973 7369 6f6e 2066 6f72 2070 6572 6d69  ission for permi
+0002deb0: 7373 696f 6e20 7479 7065 2022 0a20 2020  ssion type ".   
+0002dec0: 2020 2020 2020 2020 2020 2020 2066 2227               f"'
+0002ded0: 7b70 6572 6d69 7373 696f 6e5f 7479 7065  {permission_type
+0002dee0: 7d27 2069 6e20 726f 6f6d 207b 726f 6f6d  }' in room {room
+0002def0: 5f69 647d 2e20 220a 2020 2020 2020 2020  _id}. ".        
+0002df00: 2020 2020 2020 2020 6622 5265 7370 6f6e          f"Respon
+0002df10: 7365 2069 7320 7b70 7269 7661 6379 5f66  se is {privacy_f
+0002df20: 696c 7465 7228 7374 7228 7265 7370 2929  ilter(str(resp))
+0002df30: 7d22 0a20 2020 2020 2020 2020 2020 2029  }".            )
+0002df40: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+0002df50: 6572 725f 636f 756e 7420 2b3d 2031 0a20  err_count += 1. 
+0002df60: 2020 2020 2020 2020 2020 2023 206f 7574             # out
+0002df70: 7075 7420 666f 726d 6174 2063 6f6e 7472  put format contr
+0002df80: 6f6c 6c65 6420 7669 6120 2d2d 6f75 7470  olled via --outp
+0002df90: 7574 2066 6c61 670a 2020 2020 2020 2020  ut flag.        
+0002dfa0: 2020 2020 2320 666f 7220 4a53 4f4e 2074      # for JSON t
+0002dfb0: 6865 2075 7365 7220 6361 6e20 6465 7465  he user can dete
+0002dfc0: 726d 696e 6520 7768 6963 6820 6f6e 6520  rmine which one 
+0002dfd0: 6672 6f6d 2074 6865 206c 6973 740a 2020  from the list.  
+0002dfe0: 2020 2020 2020 2020 2020 2320 7761 7320            # was 
+0002dff0: 7375 6363 6573 7366 756c 2061 6e64 2077  successful and w
+0002e000: 6869 6368 206f 6e65 2066 6169 6c65 642e  hich one failed.
+0002e010: 2046 6f72 2034 2069 6e70 7574 7320 7468   For 4 inputs th
+0002e020: 6572 650a 2020 2020 2020 2020 2020 2020  ere.            
+0002e030: 2320 6d69 6768 7420 6f6e 6c79 2062 6520  # might only be 
+0002e040: 3320 6f75 7470 7574 204a 534f 4e20 6f62  3 output JSON ob
+0002e050: 6a65 6374 7320 6966 2074 6865 7265 2077  jects if there w
+0002e060: 6173 2031 2065 7272 6f72 2e0a 2020 2020  as 1 error..    
+0002e070: 2020 2020 2020 2020 2320 496e 2074 6578          # In tex
+0002e080: 7420 6d6f 6465 2077 6520 7072 696e 7420  t mode we print 
+0002e090: 7468 6973 2065 7272 6f72 206c 696e 652c  this error line,
+0002e0a0: 2073 6f20 7468 6174 2066 6f72 2034 2069   so that for 4 i
+0002e0b0: 6e70 7574 730a 2020 2020 2020 2020 2020  nputs.          
+0002e0c0: 2020 2320 7468 6572 6520 7769 6c6c 2062    # there will b
+0002e0d0: 6520 3420 6f75 7470 7574 206c 696e 6573  e 4 output lines
+0002e0e0: 2e0a 2020 2020 2020 2020 2020 2020 7072  ..            pr
+0002e0f0: 696e 745f 6f75 7470 7574 280a 2020 2020  int_output(.    
+0002e100: 2020 2020 2020 2020 2020 2020 6773 2e70              gs.p
+0002e110: 612e 6f75 7470 7574 2c0a 2020 2020 2020  a.output,.      
+0002e120: 2020 2020 2020 2020 2020 7465 7874 3d28            text=(
+0002e130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e140: 2020 2020 2066 2245 7272 6f72 7b53 4550       f"Error{SEP
+0002e150: 7d7b 7573 6572 5f69 647d 7b53 4550 7d7b  }{user_id}{SEP}{
+0002e160: 726f 6f6d 5f69 647d 220a 2020 2020 2020  room_id}".      
+0002e170: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0002e180: 7b53 4550 7d7b 7065 726d 6973 7369 6f6e  {SEP}{permission
+0002e190: 5f74 7970 657d 220a 2020 2020 2020 2020  _type}".        
+0002e1a0: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
+0002e1b0: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+0002e1c0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
+0002e1d0: 2020 2020 2020 206a 736f 6e5f 6d61 783d         json_max=
+0002e1e0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+0002e1f0: 2020 2020 2020 6a73 6f6e 5f73 7065 633d        json_spec=
+0002e200: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+0002e210: 2020 290a 2020 2020 2020 2020 656c 7365    ).        else
+0002e220: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
+0002e230: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
+0002e240: 2020 2020 2020 2020 2020 2020 6622 6861              f"ha
+0002e250: 735f 7065 726d 6973 7369 6f6e 207b 7573  s_permission {us
+0002e260: 6572 5f69 647d 2066 6f72 2070 6572 6d69  er_id} for permi
+0002e270: 7373 696f 6e20 7479 7065 2022 0a20 2020  ssion type ".   
+0002e280: 2020 2020 2020 2020 2020 2020 2066 2227               f"'
+0002e290: 7b70 6572 6d69 7373 696f 6e5f 7479 7065  {permission_type
+0002e2a0: 7d27 2069 6e20 726f 6f6d 207b 726f 6f6d  }' in room {room
+0002e2b0: 5f69 647d 3a20 220a 2020 2020 2020 2020  _id}: ".        
+0002e2c0: 2020 2020 2020 2020 6622 7b70 7269 7661          f"{priva
+0002e2d0: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
+0002e2e0: 7370 2929 7d22 0a20 2020 2020 2020 2020  sp))}".         
+0002e2f0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0002e300: 2023 206f 7574 7075 7420 666f 726d 6174   # output format
+0002e310: 2063 6f6e 7472 6f6c 6c65 6420 7669 6120   controlled via 
+0002e320: 2d2d 6f75 7470 7574 2066 6c61 670a 2020  --output flag.  
+0002e330: 2020 2020 2020 2020 2020 7465 7874 203d            text =
+0002e340: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+0002e350: 2020 2066 227b 7072 6976 6163 795f 6669     f"{privacy_fi
+0002e360: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
+0002e370: 7b53 4550 7d7b 7573 6572 5f69 647d 7b53  {SEP}{user_id}{S
+0002e380: 4550 7d7b 726f 6f6d 5f69 647d 7b53 4550  EP}{room_id}{SEP
+0002e390: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
+0002e3a0: 2020 2066 227b 7065 726d 6973 7369 6f6e     f"{permission
+0002e3b0: 5f74 7970 657d 220a 2020 2020 2020 2020  _type}".        
+0002e3c0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0002e3d0: 2020 2320 4f62 6a65 6374 206f 6620 7479    # Object of ty
+0002e3e0: 7065 2078 7878 5265 7370 6f6e 7365 2069  pe xxxResponse i
+0002e3f0: 7320 6e6f 7420 4a53 4f4e 0a20 2020 2020  s not JSON.     
+0002e400: 2020 2020 2020 2023 2073 6572 6961 6c69         # seriali
+0002e410: 7a61 626c 652c 2068 656e 6365 2077 6520  zable, hence we 
+0002e420: 7573 6520 7468 6520 6469 6374 696f 6e61  use the dictiona
+0002e430: 7279 2e0a 2020 2020 2020 2020 2020 2020  ry..            
+0002e440: 6a73 6f6e 5f6d 6178 203d 2072 6573 702e  json_max = resp.
+0002e450: 5f5f 6469 6374 5f5f 0a20 2020 2020 2020  __dict__.       
+0002e460: 2020 2020 2023 206a 736f 6e5f 6d61 782e       # json_max.
+0002e470: 7570 6461 7465 287b 226b 6579 223a 2076  update({"key": v
+0002e480: 616c 7565 7d29 2020 2320 6164 6420 6469  alue})  # add di
+0002e490: 6374 2069 7465 6d73 0a20 2020 2020 2020  ct items.       
+0002e4a0: 2020 2020 206a 736f 6e5f 203d 206a 736f       json_ = jso
+0002e4b0: 6e5f 6d61 782e 636f 7079 2829 0a20 2020  n_max.copy().   
+0002e4c0: 2020 2020 2020 2020 206a 736f 6e5f 2e70           json_.p
+0002e4d0: 6f70 2822 7472 616e 7370 6f72 745f 7265  op("transport_re
+0002e4e0: 7370 6f6e 7365 2229 0a20 2020 2020 2020  sponse").       
+0002e4f0: 2020 2020 206a 736f 6e5f 7370 6563 203d       json_spec =
+0002e500: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+0002e510: 2020 7072 696e 745f 6f75 7470 7574 280a    print_output(.
+0002e520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e530: 6773 2e70 612e 6f75 7470 7574 2c0a 2020  gs.pa.output,.  
+0002e540: 2020 2020 2020 2020 2020 2020 2020 7465                te
+0002e550: 7874 3d74 6578 742c 0a20 2020 2020 2020  xt=text,.       
+0002e560: 2020 2020 2020 2020 206a 736f 6e5f 3d6a           json_=j
+0002e570: 736f 6e5f 2c0a 2020 2020 2020 2020 2020  son_,.          
+0002e580: 2020 2020 2020 6a73 6f6e 5f6d 6178 3d6a        json_max=j
+0002e590: 736f 6e5f 6d61 782c 0a20 2020 2020 2020  son_max,.       
+0002e5a0: 2020 2020 2020 2020 206a 736f 6e5f 7370           json_sp
+0002e5b0: 6563 3d6a 736f 6e5f 7370 6563 2c0a 2020  ec=json_spec,.  
+0002e5c0: 2020 2020 2020 2020 2020 290a 0a0a 6173            )...as
+0002e5d0: 796e 6320 6465 6620 6163 7469 6f6e 5f73  ync def action_s
+0002e5e0: 6574 5f61 7661 7461 7228 636c 6965 6e74  et_avatar(client
+0002e5f0: 3a20 4173 796e 6343 6c69 656e 742c 2063  : AsyncClient, c
+0002e600: 7265 6465 6e74 6961 6c73 3a20 6469 6374  redentials: dict
+0002e610: 2920 2d3e 204e 6f6e 653a 0a20 2020 2022  ) -> None:.    "
+0002e620: 2222 5365 7420 6176 6174 6172 206f 6620  ""Set avatar of 
+0002e630: 6974 7365 6c66 2077 6869 6c65 2061 6c72  itself while alr
+0002e640: 6561 6479 206c 6f67 6765 6420 696e 2e22  eady logged in."
+0002e650: 2222 0a20 2020 2075 7365 725f 6964 203d  "".    user_id =
+0002e660: 2063 7265 6465 6e74 6961 6c73 5b22 7573   credentials["us
+0002e670: 6572 5f69 6422 5d20 2023 2077 686f 616d  er_id"]  # whoam
+0002e680: 690a 2020 2020 6176 6174 6172 5f6d 7863  i.    avatar_mxc
+0002e690: 203d 2067 732e 7061 2e73 6574 5f61 7661   = gs.pa.set_ava
+0002e6a0: 7461 720a 2020 2020 6773 2e6c 6f67 2e64  tar.    gs.log.d
+0002e6b0: 6562 7567 2866 2253 6574 7469 6e67 2061  ebug(f"Setting a
+0002e6c0: 7661 7461 7220 666f 7220 7573 6572 207b  vatar for user {
+0002e6d0: 7573 6572 5f69 647d 2074 6f20 5552 4920  user_id} to URI 
+0002e6e0: 7b61 7661 7461 725f 6d78 637d 2e22 290a  {avatar_mxc}.").
+0002e6f0: 2020 2020 7265 7370 203d 2061 7761 6974      resp = await
+0002e700: 2063 6c69 656e 742e 7365 745f 6176 6174   client.set_avat
+0002e710: 6172 2861 7661 7461 725f 6d78 6329 0a20  ar(avatar_mxc). 
+0002e720: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+0002e730: 2872 6573 702c 2050 726f 6669 6c65 5365  (resp, ProfileSe
+0002e740: 7441 7661 7461 7252 6573 706f 6e73 6529  tAvatarResponse)
+0002e750: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
+0002e760: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+0002e770: 2020 2020 2250 726f 6669 6c65 5365 7441      "ProfileSetA
+0002e780: 7661 7461 7252 6573 706f 6e73 652e 2052  vatarResponse. R
+0002e790: 6573 706f 6e73 6520 6973 3a20 220a 2020  esponse is: ".  
+0002e7a0: 2020 2020 2020 2020 2020 6622 7b70 7269            f"{pri
+0002e7b0: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
+0002e7c0: 7265 7370 2929 7d22 0a20 2020 2020 2020  resp))}".       
+0002e7d0: 2029 0a20 2020 2020 2020 2067 732e 6c6f   ).        gs.lo
+0002e7e0: 672e 696e 666f 280a 2020 2020 2020 2020  g.info(.        
+0002e7f0: 2020 2020 6622 5375 6363 6573 7366 756c      f"Successful
+0002e800: 6c79 2073 6574 2061 7661 7461 7220 666f  ly set avatar fo
+0002e810: 7220 7573 6572 207b 7573 6572 5f69 647d  r user {user_id}
+0002e820: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
+0002e830: 2274 6f20 5552 4920 7b61 7661 7461 725f  "to URI {avatar_
+0002e840: 6d78 637d 2e22 0a20 2020 2020 2020 2029  mxc}.".        )
+0002e850: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+0002e860: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
+0002e870: 0a20 2020 2020 2020 2020 2020 2022 4531  .            "E1
+0002e880: 3935 3a20 220a 2020 2020 2020 2020 2020  95: ".          
+0002e890: 2020 6622 4661 696c 6564 2073 6574 7469    f"Failed setti
+0002e8a0: 6e67 2061 7661 7461 7220 666f 7220 7573  ng avatar for us
+0002e8b0: 6572 207b 7573 6572 5f69 647d 206f 6e20  er {user_id} on 
+0002e8c0: 7365 7276 6572 2e20 220a 2020 2020 2020  server. ".      
+0002e8d0: 2020 2020 2020 6622 7b70 7269 7661 6379        f"{privacy
+0002e8e0: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
+0002e8f0: 2929 7d22 0a20 2020 2020 2020 2029 0a20  ))}".        ). 
+0002e900: 2020 2020 2020 2067 732e 6572 725f 636f         gs.err_co
+0002e910: 756e 7420 2b3d 2031 0a0a 0a61 7379 6e63  unt += 1...async
+0002e920: 2064 6566 2061 6374 696f 6e5f 696d 706f   def action_impo
+0002e930: 7274 5f6b 6579 7328 636c 6965 6e74 3a20  rt_keys(client: 
+0002e940: 4173 796e 6343 6c69 656e 742c 2063 7265  AsyncClient, cre
+0002e950: 6465 6e74 6961 6c73 3a20 6469 6374 2920  dentials: dict) 
+0002e960: 2d3e 204e 6f6e 653a 0a20 2020 2022 2222  -> None:.    """
+0002e970: 496d 706f 7274 204d 6567 6f6c 6d20 6b65  Import Megolm ke
+0002e980: 7973 2066 726f 6d20 6669 6c65 2077 6869  ys from file whi
+0002e990: 6c65 2061 6c72 6561 6479 206c 6f67 6765  le already logge
+0002e9a0: 6420 696e 2e22 2222 0a20 2020 2066 696c  d in.""".    fil
+0002e9b0: 6520 3d20 6773 2e70 612e 696d 706f 7274  e = gs.pa.import
+0002e9c0: 5f6b 6579 735b 305d 0a20 2020 2070 6173  _keys[0].    pas
+0002e9d0: 7370 6872 6173 6520 3d20 6773 2e70 612e  sphrase = gs.pa.
+0002e9e0: 696d 706f 7274 5f6b 6579 735b 315d 0a20  import_keys[1]. 
+0002e9f0: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+0002ea00: 6622 496d 706f 7274 696e 6720 6b65 7973  f"Importing keys
+0002ea10: 2066 726f 6d20 6669 6c65 207b 6669 6c65   from file {file
+0002ea20: 7d20 7573 696e 6720 6120 7061 7373 7068  } using a passph
+0002ea30: 7261 7365 2e22 290a 2020 2020 7265 7370  rase.").    resp
+0002ea40: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+0002ea50: 696d 706f 7274 5f6b 6579 7328 6669 6c65  import_keys(file
+0002ea60: 2c20 7061 7373 7068 7261 7365 290a 2020  , passphrase).  
+0002ea70: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0002ea80: 7265 7370 2c20 456e 6372 7970 7469 6f6e  resp, Encryption
+0002ea90: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+0002eaa0: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
+0002eab0: 2020 2020 2020 2020 2020 2245 3139 363a            "E196:
+0002eac0: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
+0002ead0: 2246 6169 6c65 6420 746f 2064 6563 7279  "Failed to decry
+0002eae0: 7074 206b 6579 7320 6669 6c65 2e20 4669  pt keys file. Fi
+0002eaf0: 6c65 207b 6669 6c65 7d20 6973 2069 6e76  le {file} is inv
+0002eb00: 616c 6964 206f 7220 220a 2020 2020 2020  alid or ".      
+0002eb10: 2020 2020 2020 6622 636f 756c 646e e280        f"couldn..
+0002eb20: 9974 2062 6520 6465 6372 7970 7465 642e  .t be decrypted.
+0002eb30: 207b 7072 6976 6163 795f 6669 6c74 6572   {privacy_filter
+0002eb40: 2873 7472 2872 6573 7029 297d 220a 2020  (str(resp))}".  
+0002eb50: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0002eb60: 6773 2e65 7272 5f63 6f75 6e74 202b 3d20  gs.err_count += 
+0002eb70: 310a 2020 2020 656c 7365 3a0a 2020 2020  1.    else:.    
+0002eb80: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+0002eb90: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
+0002eba0: 696d 706f 7274 5f6b 6579 7320 7375 6363  import_keys succ
+0002ebb0: 6573 7366 756c 2e20 5265 7370 6f6e 7365  essful. Response
+0002ebc0: 2069 733a 207b 7072 6976 6163 795f 6669   is: {privacy_fi
+0002ebd0: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
+0002ebe0: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
+0002ebf0: 2020 2020 6773 2e6c 6f67 2e69 6e66 6f28      gs.log.info(
+0002ec00: 6622 5375 6363 6573 7366 756c 6c79 2069  f"Successfully i
+0002ec10: 6d70 6f72 7465 6420 6b65 7973 2066 726f  mported keys fro
+0002ec20: 6d20 6669 6c65 207b 6669 6c65 7d2e 2229  m file {file}.")
+0002ec30: 0a0a 0a61 7379 6e63 2064 6566 2061 6374  ...async def act
+0002ec40: 696f 6e5f 6578 706f 7274 5f6b 6579 7328  ion_export_keys(
+0002ec50: 636c 6965 6e74 3a20 4173 796e 6343 6c69  client: AsyncCli
+0002ec60: 656e 742c 2063 7265 6465 6e74 6961 6c73  ent, credentials
+0002ec70: 3a20 6469 6374 2920 2d3e 204e 6f6e 653a  : dict) -> None:
+0002ec80: 0a20 2020 2022 2222 4578 706f 7274 204d  .    """Export M
+0002ec90: 6567 6f6c 6d20 6b65 7973 2066 726f 6d20  egolm keys from 
+0002eca0: 6669 6c65 2077 6869 6c65 2061 6c72 6561  file while alrea
+0002ecb0: 6479 206c 6f67 6765 6420 696e 2e22 2222  dy logged in."""
+0002ecc0: 0a20 2020 2066 696c 6520 3d20 6773 2e70  .    file = gs.p
+0002ecd0: 612e 6578 706f 7274 5f6b 6579 735b 305d  a.export_keys[0]
+0002ece0: 0a20 2020 2070 6173 7370 6872 6173 6520  .    passphrase 
+0002ecf0: 3d20 6773 2e70 612e 6578 706f 7274 5f6b  = gs.pa.export_k
+0002ed00: 6579 735b 315d 0a20 2020 2067 732e 6c6f  eys[1].    gs.lo
+0002ed10: 672e 6465 6275 6728 6622 4578 706f 7274  g.debug(f"Export
+0002ed20: 696e 6720 6b65 7973 2074 6f20 6669 6c65  ing keys to file
+0002ed30: 207b 6669 6c65 7d20 7573 696e 6720 6120   {file} using a 
+0002ed40: 7061 7373 7068 7261 7365 2e22 290a 2020  passphrase.").  
+0002ed50: 2020 7472 793a 0a20 2020 2020 2020 2072    try:.        r
+0002ed60: 6573 7020 3d20 6177 6169 7420 636c 6965  esp = await clie
+0002ed70: 6e74 2e65 7870 6f72 745f 6b65 7973 2866  nt.export_keys(f
+0002ed80: 696c 652c 2070 6173 7370 6872 6173 6529  ile, passphrase)
+0002ed90: 0a20 2020 2065 7863 6570 7420 4578 6365  .    except Exce
+0002eda0: 7074 696f 6e3a 0a20 2020 2020 2020 2067  ption:.        g
+0002edb0: 732e 6c6f 672e 6572 726f 7228 2245 3139  s.log.error("E19
+0002edc0: 373a 2022 2066 2246 6169 6c65 6420 746f  7: " f"Failed to
+0002edd0: 2065 7870 6f72 7420 6b65 7973 2074 6f20   export keys to 
+0002ede0: 6669 6c65 207b 6669 6c65 7d2e 2229 0a20  file {file}."). 
+0002edf0: 2020 2020 2020 2072 6169 7365 0a20 2020         raise.   
+0002ee00: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
+0002ee10: 2020 2020 2020 2066 2265 7870 6f72 745f         f"export_
+0002ee20: 6b65 7973 2073 7563 6365 7373 6675 6c2e  keys successful.
+0002ee30: 2052 6573 706f 6e73 6520 6973 3a20 7b70   Response is: {p
+0002ee40: 7269 7661 6379 5f66 696c 7465 7228 7374  rivacy_filter(st
+0002ee50: 7228 7265 7370 2929 7d22 0a20 2020 2029  r(resp))}".    )
+0002ee60: 0a20 2020 2067 732e 6c6f 672e 696e 666f  .    gs.log.info
+0002ee70: 2866 2253 7563 6365 7373 6675 6c6c 7920  (f"Successfully 
+0002ee80: 6578 706f 7274 6564 206b 6579 7320 746f  exported keys to
+0002ee90: 2066 696c 6520 7b66 696c 657d 2e22 290a   file {file}.").
+0002eea0: 0a0a 6173 796e 6320 6465 6620 6163 7469  ..async def acti
+0002eeb0: 6f6e 5f72 6f6f 6d5f 7365 745f 616c 6961  on_room_set_alia
+0002eec0: 7328 0a20 2020 2063 6c69 656e 743a 2041  s(.    client: A
+0002eed0: 7379 6e63 436c 6965 6e74 2c20 6372 6564  syncClient, cred
+0002eee0: 656e 7469 616c 733a 2064 6963 740a 2920  entials: dict.) 
+0002eef0: 2d3e 204e 6f6e 653a 0a20 2020 2022 2222  -> None:.    """
+0002ef00: 4164 6420 616c 6961 7328 6573 2920 746f  Add alias(es) to
+0002ef10: 2072 6f6f 6d28 7329 2077 6869 6c65 2061   room(s) while a
+0002ef20: 6c72 6561 6479 206c 6f67 6765 6420 696e  lready logged in
+0002ef30: 2e22 2222 0a20 2020 2069 6620 6c65 6e28  .""".    if len(
+0002ef40: 6773 2e70 612e 726f 6f6d 5f73 6574 5f61  gs.pa.room_set_a
+0002ef50: 6c69 6173 2920 3d3d 2031 3a20 2023 2073  lias) == 1:  # s
+0002ef60: 7065 6369 616c 2063 6173 650a 2020 2020  pecial case.    
+0002ef70: 2020 2020 6773 2e70 612e 726f 6f6d 5f73      gs.pa.room_s
+0002ef80: 6574 5f61 6c69 6173 2e61 7070 656e 6428  et_alias.append(
+0002ef90: 6372 6564 656e 7469 616c 735b 2272 6f6f  credentials["roo
+0002efa0: 6d5f 6964 225d 290a 2020 2020 6966 206e  m_id"]).    if n
+0002efb0: 6f74 206c 656e 2867 732e 7061 2e72 6f6f  ot len(gs.pa.roo
+0002efc0: 6d5f 7365 745f 616c 6961 7329 2025 2032  m_set_alias) % 2
+0002efd0: 203d 3d20 303a 0a20 2020 2020 2020 2067   == 0:.        g
+0002efe0: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
+0002eff0: 2020 2020 2020 2020 2022 4531 3938 3a20           "E198: 
+0002f000: 220a 2020 2020 2020 2020 2020 2020 2249  ".            "I
+0002f010: 6e63 6f72 7265 6374 206e 756d 6265 7220  ncorrect number 
+0002f020: 6f66 2061 7267 756d 656e 7473 2066 6f72  of arguments for
+0002f030: 202d 2d72 6f6f 6d2d 7365 742d 616c 6961   --room-set-alia
+0002f040: 732e 2041 7267 756d 656e 7473 2022 0a20  s. Arguments ". 
+0002f050: 2020 2020 2020 2020 2020 2022 6d75 7374             "must
+0002f060: 2062 6520 7061 6972 732c 2069 2e65 2e20   be pairs, i.e. 
+0002f070: 6d75 6c74 6970 6c65 7320 6f66 2032 2c20  multiples of 2, 
+0002f080: 6275 7420 666f 756e 6420 220a 2020 2020  but found ".    
+0002f090: 2020 2020 2020 2020 6622 7b6c 656e 2867          f"{len(g
+0002f0a0: 732e 7061 2e72 6f6f 6d5f 7365 745f 616c  s.pa.room_set_al
+0002f0b0: 6961 7329 7d20 6172 6775 6d65 6e74 732e  ias)} arguments.
+0002f0c0: 2031 2069 7320 616c 6c6f 7765 6420 746f   1 is allowed to
+0002f0d0: 6f2e 220a 2020 2020 2020 2020 290a 2020  o.".        ).  
+0002f0e0: 2020 2020 2020 6773 2e65 7272 5f63 6f75        gs.err_cou
+0002f0f0: 6e74 202b 3d20 310a 2020 2020 2020 2020  nt += 1.        
+0002f100: 7265 7475 726e 0a20 2020 2066 6f72 2069  return.    for i
+0002f110: 6920 696e 2072 616e 6765 286c 656e 2867  i in range(len(g
+0002f120: 732e 7061 2e72 6f6f 6d5f 7365 745f 616c  s.pa.room_set_al
+0002f130: 6961 7329 202f 2f20 3229 3a0a 2020 2020  ias) // 2):.    
+0002f140: 2020 2020 616c 6961 7320 3d20 6773 2e70      alias = gs.p
+0002f150: 612e 726f 6f6d 5f73 6574 5f61 6c69 6173  a.room_set_alias
+0002f160: 5b69 6920 2a20 3220 2b20 305d 2e73 7472  [ii * 2 + 0].str
+0002f170: 6970 2829 0a20 2020 2020 2020 2072 6f6f  ip().        roo
+0002f180: 6d5f 6964 203d 2067 732e 7061 2e72 6f6f  m_id = gs.pa.roo
+0002f190: 6d5f 7365 745f 616c 6961 735b 6969 202a  m_set_alias[ii *
+0002f1a0: 2032 202b 2031 5d0a 2020 2020 2020 2020   2 + 1].        
+0002f1b0: 726f 6f6d 5f69 6420 3d20 6177 6169 7420  room_id = await 
+0002f1c0: 6d61 705f 726f 6f6d 696e 666f 5f74 6f5f  map_roominfo_to_
+0002f1d0: 726f 6f6d 6964 2863 6c69 656e 742c 2072  roomid(client, r
+0002f1e0: 6f6f 6d5f 6964 290a 2020 2020 2020 2020  oom_id).        
+0002f1f0: 6773 2e6c 6f67 2e64 6562 7567 2866 2241  gs.log.debug(f"A
+0002f200: 6464 696e 6720 616c 6961 7320 277b 616c  dding alias '{al
+0002f210: 6961 737d 2720 746f 2072 6f6f 6d20 277b  ias}' to room '{
+0002f220: 726f 6f6d 5f69 647d 272e 2229 0a20 2020  room_id}'.").   
+0002f230: 2020 2020 2069 6620 6e6f 7420 6973 5f72       if not is_r
+0002f240: 6f6f 6d5f 616c 6961 7328 616c 6961 7329  oom_alias(alias)
+0002f250: 2061 6e64 206e 6f74 2069 735f 7368 6f72   and not is_shor
+0002f260: 745f 726f 6f6d 5f61 6c69 6173 2861 6c69  t_room_alias(ali
+0002f270: 6173 293a 0a20 2020 2020 2020 2020 2020  as):.           
+0002f280: 2023 206e 6f74 2061 6e20 6578 6861 7573   # not an exhaus
+0002f290: 7469 7665 2063 6865 636b 0a20 2020 2020  tive check.     
+0002f2a0: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
+0002f2b0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+0002f2c0: 2020 2020 2022 4531 3939 3a20 220a 2020       "E199: ".  
+0002f2d0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0002f2e0: 496e 7661 6c69 6420 616c 6961 7320 277b  Invalid alias '{
+0002f2f0: 616c 6961 737d 272e 2054 6869 7320 6973  alias}'. This is
+0002f300: 206e 6569 7468 6572 2061 2066 756c 6c20   neither a full 
+0002f310: 726f 6f6d 2061 6c69 6173 2022 0a20 2020  room alias ".   
+0002f320: 2020 2020 2020 2020 2020 2020 2022 6e6f               "no
+0002f330: 7220 6120 7368 6f72 7420 726f 6f6d 2061  r a short room a
+0002f340: 6c69 6173 2e20 4974 2073 686f 756c 6420  lias. It should 
+0002f350: 6569 7468 6572 2062 6520 220a 2020 2020  either be ".    
+0002f360: 2020 2020 2020 2020 2020 2020 2227 2353              "'#S
+0002f370: 6f6d 6552 6f6f 6d41 6c69 6173 3a6d 6174  omeRoomAlias:mat
+0002f380: 7269 782e 6578 616d 706c 652e 636f 6d27  rix.example.com'
+0002f390: 206f 7220 220a 2020 2020 2020 2020 2020   or ".          
+0002f3a0: 2020 2020 2020 2227 2353 6f6d 6552 6f6f        "'#SomeRoo
+0002f3b0: 6d41 6c69 6173 2720 6f72 2027 536f 6d65  mAlias' or 'Some
+0002f3c0: 526f 6f6d 416c 6961 7327 2e22 0a20 2020  RoomAlias'.".   
+0002f3d0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0002f3e0: 2020 2020 2020 2067 732e 6572 725f 636f         gs.err_co
+0002f3f0: 756e 7420 2b3d 2031 0a20 2020 2020 2020  unt += 1.       
+0002f400: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
+0002f410: 2020 2020 2020 6966 2022 3a22 206e 6f74        if ":" not
+0002f420: 2069 6e20 616c 6961 733a 0a20 2020 2020   in alias:.     
+0002f430: 2020 2020 2020 2023 2044 6f20 4e4f 5420         # Do NOT 
+0002f440: 7573 6520 7368 6f72 745f 726f 6f6d 5f61  use short_room_a
+0002f450: 6c69 6173 5f74 6f5f 726f 6f6d 5f61 6c69  lias_to_room_ali
+0002f460: 6173 2829 2e0a 2020 2020 2020 2020 2020  as()..          
+0002f470: 2020 2320 5765 2077 616e 7420 7468 6973    # We want this
+0002f480: 2074 6f20 6265 2062 6173 6564 206f 6e20   to be based on 
+0002f490: 7072 6f76 6964 6564 2072 6f6f 6d5f 6964  provided room_id
+0002f4a0: 206e 6f74 2074 6865 2064 6566 6175 6c74   not the default
+0002f4b0: 0a20 2020 2020 2020 2020 2020 2023 2068  .            # h
+0002f4c0: 6f6d 6573 6572 7665 7221 0a20 2020 2020  omeserver!.     
+0002f4d0: 2020 2020 2020 2069 6620 616c 6961 735b         if alias[
+0002f4e0: 305d 2021 3d20 2223 223a 0a20 2020 2020  0] != "#":.     
+0002f4f0: 2020 2020 2020 2020 2020 2061 6c69 6173             alias
+0002f500: 203d 2022 2322 202b 2061 6c69 6173 0a20   = "#" + alias. 
+0002f510: 2020 2020 2020 2020 2020 2061 6c69 6173             alias
+0002f520: 203d 2061 6c69 6173 202b 2022 3a22 202b   = alias + ":" +
+0002f530: 2072 6f6f 6d5f 6964 2e73 706c 6974 2822   room_id.split("
+0002f540: 3a22 295b 315d 0a20 2020 2020 2020 2072  :")[1].        r
+0002f550: 6573 7020 3d20 6177 6169 7420 636c 6965  esp = await clie
+0002f560: 6e74 2e72 6f6f 6d5f 7075 745f 616c 6961  nt.room_put_alia
+0002f570: 7328 616c 6961 732c 2072 6f6f 6d5f 6964  s(alias, room_id
+0002f580: 290a 2020 2020 2020 2020 6966 2069 7369  ).        if isi
+0002f590: 6e73 7461 6e63 6528 7265 7370 2c20 526f  nstance(resp, Ro
+0002f5a0: 6f6d 5075 7441 6c69 6173 5265 7370 6f6e  omPutAliasRespon
+0002f5b0: 7365 293a 0a20 2020 2020 2020 2020 2020  se):.           
+0002f5c0: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
+0002f5d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0002f5e0: 726f 6f6d 5f70 7574 5f61 6c69 6173 2073  room_put_alias s
+0002f5f0: 7563 6365 7373 6675 6c2e 2052 6573 706f  uccessful. Respo
+0002f600: 6e73 6520 6973 3a20 220a 2020 2020 2020  nse is: ".      
 0002f610: 2020 2020 2020 2020 2020 6622 7b70 7269            f"{pri
 0002f620: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
 0002f630: 7265 7370 2929 7d22 0a20 2020 2020 2020  resp))}".       
 0002f640: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0002f650: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
-0002f660: 2b3d 2031 0a0a 0a61 7379 6e63 2064 6566  += 1...async def
-0002f670: 2061 6374 696f 6e5f 726f 6f6d 5f72 6573   action_room_res
-0002f680: 6f6c 7665 5f61 6c69 6173 280a 2020 2020  olve_alias(.    
-0002f690: 636c 6965 6e74 3a20 4173 796e 6343 6c69  client: AsyncCli
-0002f6a0: 656e 742c 2063 7265 6465 6e74 6961 6c73  ent, credentials
-0002f6b0: 3a20 6469 6374 0a29 202d 3e20 4e6f 6e65  : dict.) -> None
-0002f6c0: 3a0a 2020 2020 2222 2252 6573 6f6c 7665  :.    """Resolve
-0002f6d0: 2072 6f6f 6d20 616c 6961 7328 6573 2920   room alias(es) 
-0002f6e0: 7768 696c 6520 616c 7265 6164 7920 6c6f  while already lo
-0002f6f0: 6767 6564 2069 6e2e 2222 220a 2020 2020  gged in.""".    
-0002f700: 666f 7220 616c 6961 7320 696e 2067 732e  for alias in gs.
-0002f710: 7061 2e72 6f6f 6d5f 7265 736f 6c76 655f  pa.room_resolve_
-0002f720: 616c 6961 733a 0a20 2020 2020 2020 2061  alias:.        a
-0002f730: 6c69 6173 203d 2061 6c69 6173 2e73 7472  lias = alias.str
-0002f740: 6970 2829 0a20 2020 2020 2020 2067 732e  ip().        gs.
-0002f750: 6c6f 672e 6465 6275 6728 6622 5265 736f  log.debug(f"Reso
-0002f760: 6c76 696e 6720 726f 6f6d 2061 6c69 6173  lving room alias
-0002f770: 2027 7b61 6c69 6173 7d27 2e22 290a 2020   '{alias}'.").  
-0002f780: 2020 2020 2020 6966 206e 6f74 2069 735f        if not is_
-0002f790: 726f 6f6d 5f61 6c69 6173 2861 6c69 6173  room_alias(alias
-0002f7a0: 2920 616e 6420 6e6f 7420 6973 5f73 686f  ) and not is_sho
-0002f7b0: 7274 5f72 6f6f 6d5f 616c 6961 7328 616c  rt_room_alias(al
-0002f7c0: 6961 7329 3a0a 2020 2020 2020 2020 2020  ias):.          
-0002f7d0: 2020 2320 6e6f 7420 616e 2065 7868 6175    # not an exhau
-0002f7e0: 7374 6976 6520 6368 6563 6b0a 2020 2020  stive check.    
-0002f7f0: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
-0002f800: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-0002f810: 2020 2020 2020 2245 3230 313a 2022 0a20        "E201: ". 
-0002f820: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002f830: 2249 6e76 616c 6964 2061 6c69 6173 2027  "Invalid alias '
-0002f840: 7b61 6c69 6173 7d27 2e20 5468 6973 2069  {alias}'. This i
-0002f850: 7320 6e65 6974 6865 7220 6120 6675 6c6c  s neither a full
-0002f860: 2072 6f6f 6d20 616c 6961 7320 220a 2020   room alias ".  
-0002f870: 2020 2020 2020 2020 2020 2020 2020 226e                "n
-0002f880: 6f72 2061 2073 686f 7274 2072 6f6f 6d20  or a short room 
-0002f890: 616c 6961 732e 2049 7420 7368 6f75 6c64  alias. It should
-0002f8a0: 2065 6974 6865 7220 6265 2022 0a20 2020   either be ".   
-0002f8b0: 2020 2020 2020 2020 2020 2020 2022 2723               "'#
-0002f8c0: 536f 6d65 526f 6f6d 416c 6961 733a 6d61  SomeRoomAlias:ma
-0002f8d0: 7472 6978 2e65 7861 6d70 6c65 2e63 6f6d  trix.example.com
-0002f8e0: 2720 6f72 2022 0a20 2020 2020 2020 2020  ' or ".         
-0002f8f0: 2020 2020 2020 2022 2723 536f 6d65 526f         "'#SomeRo
-0002f900: 6f6d 416c 6961 7327 206f 7220 2753 6f6d  omAlias' or 'Som
-0002f910: 6552 6f6f 6d41 6c69 6173 272e 220a 2020  eRoomAlias'.".  
-0002f920: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0002f930: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
-0002f940: 6f75 6e74 202b 3d20 310a 2020 2020 2020  ount += 1.      
-0002f950: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
-0002f960: 2020 2020 2020 2069 6620 223a 2220 6e6f         if ":" no
-0002f970: 7420 696e 2061 6c69 6173 3a20 2023 2073  t in alias:  # s
-0002f980: 686f 7274 2061 6c69 6173 2c20 7769 7468  hort alias, with
-0002f990: 6f75 7420 686f 6d65 7365 7276 6572 0a20  out homeserver. 
-0002f9a0: 2020 2020 2020 2020 2020 2061 6c69 6173             alias
-0002f9b0: 203d 2073 686f 7274 5f72 6f6f 6d5f 616c   = short_room_al
-0002f9c0: 6961 735f 746f 5f72 6f6f 6d5f 616c 6961  ias_to_room_alia
-0002f9d0: 7328 616c 6961 732c 2063 7265 6465 6e74  s(alias, credent
-0002f9e0: 6961 6c73 290a 2020 2020 2020 2020 7265  ials).        re
-0002f9f0: 7370 203d 2061 7761 6974 2063 6c69 656e  sp = await clien
-0002fa00: 742e 726f 6f6d 5f72 6573 6f6c 7665 5f61  t.room_resolve_a
-0002fa10: 6c69 6173 2861 6c69 6173 290a 2020 2020  lias(alias).    
-0002fa20: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-0002fa30: 6528 7265 7370 2c20 526f 6f6d 5265 736f  e(resp, RoomReso
-0002fa40: 6c76 6541 6c69 6173 5265 7370 6f6e 7365  lveAliasResponse
-0002fa50: 293a 0a20 2020 2020 2020 2020 2020 2067  ):.            g
-0002fa60: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
-0002fa70: 2020 2020 2020 2020 2020 2020 2022 726f               "ro
-0002fa80: 6f6d 5f72 6573 6f6c 7665 5f61 6c69 6173  om_resolve_alias
-0002fa90: 2073 7563 6365 7373 6675 6c2e 2052 6573   successful. Res
-0002faa0: 706f 6e73 6520 6973 3a20 220a 2020 2020  ponse is: ".    
-0002fab0: 2020 2020 2020 2020 2020 2020 6622 7b70              f"{p
-0002fac0: 7269 7661 6379 5f66 696c 7465 7228 7374  rivacy_filter(st
-0002fad0: 7228 7265 7370 2929 7d22 0a20 2020 2020  r(resp))}".     
-0002fae0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0002faf0: 2020 2020 2067 732e 6c6f 672e 696e 666f       gs.log.info
-0002fb00: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0002fb10: 2020 6622 5375 6363 6573 7366 756c 6c79    f"Successfully
-0002fb20: 2072 6573 6f6c 7665 6420 726f 6f6d 2061   resolved room a
-0002fb30: 6c69 6173 2027 7b61 6c69 6173 7d27 2074  lias '{alias}' t
-0002fb40: 6f20 220a 2020 2020 2020 2020 2020 2020  o ".            
-0002fb50: 2020 2020 6622 7b72 6573 702e 726f 6f6d      f"{resp.room
-0002fb60: 5f69 647d 2e22 0a20 2020 2020 2020 2020  _id}.".         
-0002fb70: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0002fb80: 2023 206f 7574 7075 7420 666f 726d 6174   # output format
-0002fb90: 2063 6f6e 7472 6f6c 6c65 6420 7669 6120   controlled via 
-0002fba0: 2d2d 6f75 7470 7574 2066 6c61 670a 2020  --output flag.  
-0002fbb0: 2020 2020 2020 2020 2020 7465 7874 203d            text =
-0002fbc0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-0002fbd0: 2020 2066 227b 7265 7370 2e72 6f6f 6d5f     f"{resp.room_
-0002fbe0: 616c 6961 737d 7b53 4550 7d7b 7265 7370  alias}{SEP}{resp
-0002fbf0: 2e72 6f6f 6d5f 6964 7d7b 5345 507d 2220  .room_id}{SEP}" 
-0002fc00: 6622 7b72 6573 702e 7365 7276 6572 737d  f"{resp.servers}
+0002f650: 2020 2067 732e 6c6f 672e 696e 666f 280a     gs.log.info(.
+0002f660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f670: 6622 5375 6363 6573 7366 756c 6c79 2061  f"Successfully a
+0002f680: 6464 6564 2061 6c69 6173 2027 7b61 6c69  dded alias '{ali
+0002f690: 6173 7d27 2074 6f20 726f 6f6d 2027 7b72  as}' to room '{r
+0002f6a0: 6f6f 6d5f 6964 7d27 2e22 0a20 2020 2020  oom_id}'.".     
+0002f6b0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0002f6c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0002f6d0: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
+0002f6e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f6f0: 2022 4532 3030 3a20 220a 2020 2020 2020   "E200: ".      
+0002f700: 2020 2020 2020 2020 2020 6622 4661 696c            f"Fail
+0002f710: 6564 2074 6f20 6164 6420 616c 6961 7320  ed to add alias 
+0002f720: 277b 616c 6961 737d 2720 746f 2072 6f6f  '{alias}' to roo
+0002f730: 6d20 277b 726f 6f6d 5f69 647d 273a 2022  m '{room_id}': "
+0002f740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f750: 2066 227b 7072 6976 6163 795f 6669 6c74   f"{privacy_filt
+0002f760: 6572 2873 7472 2872 6573 7029 297d 220a  er(str(resp))}".
+0002f770: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0002f780: 2020 2020 2020 2020 2020 6773 2e65 7272            gs.err
+0002f790: 5f63 6f75 6e74 202b 3d20 310a 0a0a 6173  _count += 1...as
+0002f7a0: 796e 6320 6465 6620 6163 7469 6f6e 5f72  ync def action_r
+0002f7b0: 6f6f 6d5f 7265 736f 6c76 655f 616c 6961  oom_resolve_alia
+0002f7c0: 7328 0a20 2020 2063 6c69 656e 743a 2041  s(.    client: A
+0002f7d0: 7379 6e63 436c 6965 6e74 2c20 6372 6564  syncClient, cred
+0002f7e0: 656e 7469 616c 733a 2064 6963 740a 2920  entials: dict.) 
+0002f7f0: 2d3e 204e 6f6e 653a 0a20 2020 2022 2222  -> None:.    """
+0002f800: 5265 736f 6c76 6520 726f 6f6d 2061 6c69  Resolve room ali
+0002f810: 6173 2865 7329 2077 6869 6c65 2061 6c72  as(es) while alr
+0002f820: 6561 6479 206c 6f67 6765 6420 696e 2e22  eady logged in."
+0002f830: 2222 0a20 2020 2066 6f72 2061 6c69 6173  "".    for alias
+0002f840: 2069 6e20 6773 2e70 612e 726f 6f6d 5f72   in gs.pa.room_r
+0002f850: 6573 6f6c 7665 5f61 6c69 6173 3a0a 2020  esolve_alias:.  
+0002f860: 2020 2020 2020 616c 6961 7320 3d20 616c        alias = al
+0002f870: 6961 732e 7374 7269 7028 290a 2020 2020  ias.strip().    
+0002f880: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+0002f890: 2866 2252 6573 6f6c 7669 6e67 2072 6f6f  (f"Resolving roo
+0002f8a0: 6d20 616c 6961 7320 277b 616c 6961 737d  m alias '{alias}
+0002f8b0: 272e 2229 0a20 2020 2020 2020 2069 6620  '.").        if 
+0002f8c0: 6e6f 7420 6973 5f72 6f6f 6d5f 616c 6961  not is_room_alia
+0002f8d0: 7328 616c 6961 7329 2061 6e64 206e 6f74  s(alias) and not
+0002f8e0: 2069 735f 7368 6f72 745f 726f 6f6d 5f61   is_short_room_a
+0002f8f0: 6c69 6173 2861 6c69 6173 293a 0a20 2020  lias(alias):.   
+0002f900: 2020 2020 2020 2020 2023 206e 6f74 2061           # not a
+0002f910: 6e20 6578 6861 7573 7469 7665 2063 6865  n exhaustive che
+0002f920: 636b 0a20 2020 2020 2020 2020 2020 2067  ck.            g
+0002f930: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
+0002f940: 2020 2020 2020 2020 2020 2020 2022 4532               "E2
+0002f950: 3031 3a20 220a 2020 2020 2020 2020 2020  01: ".          
+0002f960: 2020 2020 2020 6622 496e 7661 6c69 6420        f"Invalid 
+0002f970: 616c 6961 7320 277b 616c 6961 737d 272e  alias '{alias}'.
+0002f980: 2054 6869 7320 6973 206e 6569 7468 6572   This is neither
+0002f990: 2061 2066 756c 6c20 726f 6f6d 2061 6c69   a full room ali
+0002f9a0: 6173 2022 0a20 2020 2020 2020 2020 2020  as ".           
+0002f9b0: 2020 2020 2022 6e6f 7220 6120 7368 6f72       "nor a shor
+0002f9c0: 7420 726f 6f6d 2061 6c69 6173 2e20 4974  t room alias. It
+0002f9d0: 2073 686f 756c 6420 6569 7468 6572 2062   should either b
+0002f9e0: 6520 220a 2020 2020 2020 2020 2020 2020  e ".            
+0002f9f0: 2020 2020 2227 2353 6f6d 6552 6f6f 6d41      "'#SomeRoomA
+0002fa00: 6c69 6173 3a6d 6174 7269 782e 6578 616d  lias:matrix.exam
+0002fa10: 706c 652e 636f 6d27 206f 7220 220a 2020  ple.com' or ".  
+0002fa20: 2020 2020 2020 2020 2020 2020 2020 2227                "'
+0002fa30: 2353 6f6d 6552 6f6f 6d41 6c69 6173 2720  #SomeRoomAlias' 
+0002fa40: 6f72 2027 536f 6d65 526f 6f6d 416c 6961  or 'SomeRoomAlia
+0002fa50: 7327 2e22 0a20 2020 2020 2020 2020 2020  s'.".           
+0002fa60: 2029 0a20 2020 2020 2020 2020 2020 2067   ).            g
+0002fa70: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
+0002fa80: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0002fa90: 7469 6e75 650a 2020 2020 2020 2020 6966  tinue.        if
+0002faa0: 2022 3a22 206e 6f74 2069 6e20 616c 6961   ":" not in alia
+0002fab0: 733a 2020 2320 7368 6f72 7420 616c 6961  s:  # short alia
+0002fac0: 732c 2077 6974 686f 7574 2068 6f6d 6573  s, without homes
+0002fad0: 6572 7665 720a 2020 2020 2020 2020 2020  erver.          
+0002fae0: 2020 616c 6961 7320 3d20 7368 6f72 745f    alias = short_
+0002faf0: 726f 6f6d 5f61 6c69 6173 5f74 6f5f 726f  room_alias_to_ro
+0002fb00: 6f6d 5f61 6c69 6173 2861 6c69 6173 2c20  om_alias(alias, 
+0002fb10: 6372 6564 656e 7469 616c 7329 0a20 2020  credentials).   
+0002fb20: 2020 2020 2072 6573 7020 3d20 6177 6169       resp = awai
+0002fb30: 7420 636c 6965 6e74 2e72 6f6f 6d5f 7265  t client.room_re
+0002fb40: 736f 6c76 655f 616c 6961 7328 616c 6961  solve_alias(alia
+0002fb50: 7329 0a20 2020 2020 2020 2069 6620 6973  s).        if is
+0002fb60: 696e 7374 616e 6365 2872 6573 702c 2052  instance(resp, R
+0002fb70: 6f6f 6d52 6573 6f6c 7665 416c 6961 7352  oomResolveAliasR
+0002fb80: 6573 706f 6e73 6529 3a0a 2020 2020 2020  esponse):.      
+0002fb90: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+0002fba0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+0002fbb0: 2020 2020 2272 6f6f 6d5f 7265 736f 6c76      "room_resolv
+0002fbc0: 655f 616c 6961 7320 7375 6363 6573 7366  e_alias successf
+0002fbd0: 756c 2e20 5265 7370 6f6e 7365 2069 733a  ul. Response is:
+0002fbe0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+0002fbf0: 2020 2066 227b 7072 6976 6163 795f 6669     f"{privacy_fi
+0002fc00: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
 0002fc10: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-0002fc20: 2020 2020 2020 2020 2020 2020 2320 4f62              # Ob
-0002fc30: 6a65 6374 206f 6620 7479 7065 2078 7878  ject of type xxx
-0002fc40: 5265 7370 6f6e 7365 2069 7320 6e6f 7420  Response is not 
-0002fc50: 4a53 4f4e 0a20 2020 2020 2020 2020 2020  JSON.           
-0002fc60: 2023 2073 6572 6961 6c69 7a61 626c 652c   # serializable,
-0002fc70: 2068 656e 6365 2077 6520 7573 6520 7468   hence we use th
-0002fc80: 6520 6469 6374 696f 6e61 7279 2e0a 2020  e dictionary..  
-0002fc90: 2020 2020 2020 2020 2020 6a73 6f6e 5f6d            json_m
-0002fca0: 6178 203d 2072 6573 702e 5f5f 6469 6374  ax = resp.__dict
-0002fcb0: 5f5f 0a20 2020 2020 2020 2020 2020 2023  __.            #
-0002fcc0: 206a 736f 6e5f 6d61 782e 7570 6461 7465   json_max.update
-0002fcd0: 287b 226b 6579 223a 2076 616c 7565 7d29  ({"key": value})
-0002fce0: 2020 2320 6164 6420 6469 6374 2069 7465    # add dict ite
-0002fcf0: 6d73 0a20 2020 2020 2020 2020 2020 206a  ms.            j
-0002fd00: 736f 6e5f 203d 206a 736f 6e5f 6d61 782e  son_ = json_max.
-0002fd10: 636f 7079 2829 0a20 2020 2020 2020 2020  copy().         
-0002fd20: 2020 206a 736f 6e5f 2e70 6f70 2822 7472     json_.pop("tr
-0002fd30: 616e 7370 6f72 745f 7265 7370 6f6e 7365  ansport_response
-0002fd40: 2229 0a20 2020 2020 2020 2020 2020 206a  ").            j
-0002fd50: 736f 6e5f 7370 6563 203d 204e 6f6e 650a  son_spec = None.
-0002fd60: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0002fd70: 745f 6f75 7470 7574 280a 2020 2020 2020  t_output(.      
-0002fd80: 2020 2020 2020 2020 2020 6773 2e70 612e            gs.pa.
-0002fd90: 6f75 7470 7574 2c0a 2020 2020 2020 2020  output,.        
-0002fda0: 2020 2020 2020 2020 7465 7874 3d74 6578          text=tex
-0002fdb0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-0002fdc0: 2020 206a 736f 6e5f 3d6a 736f 6e5f 2c0a     json_=json_,.
-0002fdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fde0: 6a73 6f6e 5f6d 6178 3d6a 736f 6e5f 6d61  json_max=json_ma
-0002fdf0: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-0002fe00: 2020 206a 736f 6e5f 7370 6563 3d6a 736f     json_spec=jso
-0002fe10: 6e5f 7370 6563 2c0a 2020 2020 2020 2020  n_spec,.        
-0002fe20: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
-0002fe30: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0002fe40: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
-0002fe50: 2020 2020 2020 2020 2020 2020 2020 2245                "E
-0002fe60: 3230 323a 2022 0a20 2020 2020 2020 2020  202: ".         
-0002fe70: 2020 2020 2020 2066 2246 6169 6c65 6420         f"Failed 
-0002fe80: 746f 2072 6573 6f6c 7665 2072 6f6f 6d20  to resolve room 
-0002fe90: 616c 6961 7320 277b 616c 6961 737d 273a  alias '{alias}':
-0002fea0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-0002feb0: 2020 2066 227b 7072 6976 6163 795f 6669     f"{privacy_fi
-0002fec0: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
-0002fed0: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-0002fee0: 2020 2020 2020 2020 2020 2020 6773 2e65              gs.e
-0002fef0: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
-0002ff00: 2020 2020 2020 2020 2020 2320 6f75 7470            # outp
-0002ff10: 7574 2066 6f72 6d61 7420 636f 6e74 726f  ut format contro
-0002ff20: 6c6c 6564 2076 6961 202d 2d6f 7574 7075  lled via --outpu
-0002ff30: 7420 666c 6167 0a20 2020 2020 2020 2020  t flag.         
-0002ff40: 2020 2023 2066 6f72 204a 534f 4e20 7468     # for JSON th
-0002ff50: 6520 7573 6572 2063 616e 2064 6574 6572  e user can deter
-0002ff60: 6d69 6e65 2077 6869 6368 206f 6e65 2066  mine which one f
-0002ff70: 726f 6d20 7468 6520 6c69 7374 0a20 2020  rom the list.   
-0002ff80: 2020 2020 2020 2020 2023 2077 6173 2073           # was s
-0002ff90: 7563 6365 7373 6675 6c20 616e 6420 7768  uccessful and wh
-0002ffa0: 6963 6820 6f6e 6520 6661 696c 6564 2e20  ich one failed. 
-0002ffb0: 466f 7220 3420 696e 7075 7473 2074 6865  For 4 inputs the
-0002ffc0: 7265 0a20 2020 2020 2020 2020 2020 2023  re.            #
-0002ffd0: 206d 6967 6874 206f 6e6c 7920 6265 2033   might only be 3
-0002ffe0: 206f 7574 7075 7420 4a53 4f4e 206f 626a   output JSON obj
-0002fff0: 6563 7473 2069 6620 7468 6572 6520 7761  ects if there wa
-00030000: 7320 3120 6572 726f 722e 0a20 2020 2020  s 1 error..     
-00030010: 2020 2020 2020 2023 2049 6e20 7465 7874         # In text
-00030020: 206d 6f64 6520 7765 2070 7269 6e74 2074   mode we print t
-00030030: 6869 7320 6572 726f 7220 6c69 6e65 2c20  his error line, 
-00030040: 736f 2074 6861 7420 666f 7220 3420 696e  so that for 4 in
-00030050: 7075 7473 0a20 2020 2020 2020 2020 2020  puts.           
-00030060: 2023 2074 6865 7265 2077 696c 6c20 6265   # there will be
-00030070: 2034 206f 7574 7075 7420 6c69 6e65 732e   4 output lines.
-00030080: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00030090: 6e74 5f6f 7574 7075 7428 0a20 2020 2020  nt_output(.     
-000300a0: 2020 2020 2020 2020 2020 2067 732e 7061             gs.pa
-000300b0: 2e6f 7574 7075 742c 0a20 2020 2020 2020  .output,.       
-000300c0: 2020 2020 2020 2020 2074 6578 743d 2866           text=(f
-000300d0: 227b 616c 6961 737d 7b53 4550 7d45 7272  "{alias}{SEP}Err
-000300e0: 6f72 7b53 4550 7d5b 5d22 292c 0a20 2020  or{SEP}[]"),.   
-000300f0: 2020 2020 2020 2020 2020 2020 206a 736f               jso
-00030100: 6e5f 3d4e 6f6e 652c 0a20 2020 2020 2020  n_=None,.       
-00030110: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
-00030120: 783d 4e6f 6e65 2c0a 2020 2020 2020 2020  x=None,.        
-00030130: 2020 2020 2020 2020 6a73 6f6e 5f73 7065          json_spe
-00030140: 633d 4e6f 6e65 2c0a 2020 2020 2020 2020  c=None,.        
-00030150: 2020 2020 290a 0a0a 6173 796e 6320 6465      )...async de
-00030160: 6620 6163 7469 6f6e 5f72 6f6f 6d5f 6465  f action_room_de
-00030170: 6c65 7465 5f61 6c69 6173 280a 2020 2020  lete_alias(.    
-00030180: 636c 6965 6e74 3a20 4173 796e 6343 6c69  client: AsyncCli
-00030190: 656e 742c 2063 7265 6465 6e74 6961 6c73  ent, credentials
-000301a0: 3a20 6469 6374 0a29 202d 3e20 4e6f 6e65  : dict.) -> None
-000301b0: 3a0a 2020 2020 2222 2244 656c 6574 6520  :.    """Delete 
-000301c0: 726f 6f6d 2061 6c69 6173 2865 7329 2077  room alias(es) w
-000301d0: 6869 6c65 2061 6c72 6561 6479 206c 6f67  hile already log
-000301e0: 6765 6420 696e 2e22 2222 0a20 2020 2066  ged in.""".    f
-000301f0: 6f72 2061 6c69 6173 2069 6e20 6773 2e70  or alias in gs.p
-00030200: 612e 726f 6f6d 5f64 656c 6574 655f 616c  a.room_delete_al
-00030210: 6961 733a 0a20 2020 2020 2020 2061 6c69  ias:.        ali
-00030220: 6173 203d 2061 6c69 6173 2e73 7472 6970  as = alias.strip
-00030230: 2829 0a20 2020 2020 2020 2067 732e 6c6f  ().        gs.lo
-00030240: 672e 6465 6275 6728 6622 4465 6c65 7469  g.debug(f"Deleti
-00030250: 6e67 2072 6f6f 6d20 616c 6961 7320 277b  ng room alias '{
-00030260: 616c 6961 737d 272e 2229 0a20 2020 2020  alias}'.").     
-00030270: 2020 2069 6620 6e6f 7420 6973 5f72 6f6f     if not is_roo
-00030280: 6d5f 616c 6961 7328 616c 6961 7329 2061  m_alias(alias) a
-00030290: 6e64 206e 6f74 2069 735f 7368 6f72 745f  nd not is_short_
-000302a0: 726f 6f6d 5f61 6c69 6173 2861 6c69 6173  room_alias(alias
-000302b0: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
-000302c0: 206e 6f74 2061 6e20 6578 6861 7573 7469   not an exhausti
-000302d0: 7665 2063 6865 636b 0a20 2020 2020 2020  ve check.       
-000302e0: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
-000302f0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-00030300: 2020 2022 4532 3033 3a20 220a 2020 2020     "E203: ".    
-00030310: 2020 2020 2020 2020 2020 2020 6622 496e              f"In
-00030320: 7661 6c69 6420 616c 6961 7320 277b 616c  valid alias '{al
-00030330: 6961 737d 272e 2054 6869 7320 6973 206e  ias}'. This is n
-00030340: 6569 7468 6572 2061 2066 756c 6c20 726f  either a full ro
-00030350: 6f6d 2061 6c69 6173 2022 0a20 2020 2020  om alias ".     
-00030360: 2020 2020 2020 2020 2020 2022 6e6f 7220             "nor 
-00030370: 6120 7368 6f72 7420 726f 6f6d 2061 6c69  a short room ali
-00030380: 6173 2e20 4974 2073 686f 756c 6420 6569  as. It should ei
-00030390: 7468 6572 2062 6520 220a 2020 2020 2020  ther be ".      
-000303a0: 2020 2020 2020 2020 2020 2227 2353 6f6d            "'#Som
-000303b0: 6552 6f6f 6d41 6c69 6173 3a6d 6174 7269  eRoomAlias:matri
-000303c0: 782e 6578 616d 706c 652e 636f 6d27 206f  x.example.com' o
-000303d0: 7220 2753 6f6d 6552 6f6f 6d41 6c69 6173  r 'SomeRoomAlias
-000303e0: 272e 220a 2020 2020 2020 2020 2020 2020  '.".            
-000303f0: 290a 2020 2020 2020 2020 2020 2020 6773  ).            gs
-00030400: 2e65 7272 5f63 6f75 6e74 202b 3d20 310a  .err_count += 1.
-00030410: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00030420: 696e 7565 0a20 2020 2020 2020 2069 6620  inue.        if 
-00030430: 223a 2220 6e6f 7420 696e 2061 6c69 6173  ":" not in alias
-00030440: 3a20 2023 2073 686f 7274 2061 6c69 6173  :  # short alias
-00030450: 2c20 7769 7468 6f75 7420 686f 6d65 7365  , without homese
-00030460: 7276 6572 0a20 2020 2020 2020 2020 2020  rver.           
-00030470: 2061 6c69 6173 203d 2073 686f 7274 5f72   alias = short_r
-00030480: 6f6f 6d5f 616c 6961 735f 746f 5f72 6f6f  oom_alias_to_roo
-00030490: 6d5f 616c 6961 7328 616c 6961 732c 2063  m_alias(alias, c
-000304a0: 7265 6465 6e74 6961 6c73 290a 2020 2020  redentials).    
-000304b0: 2020 2020 7265 7370 203d 2061 7761 6974      resp = await
-000304c0: 2063 6c69 656e 742e 726f 6f6d 5f64 656c   client.room_del
-000304d0: 6574 655f 616c 6961 7328 616c 6961 7329  ete_alias(alias)
-000304e0: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-000304f0: 7374 616e 6365 2872 6573 702c 2052 6f6f  stance(resp, Roo
-00030500: 6d44 656c 6574 6541 6c69 6173 5265 7370  mDeleteAliasResp
-00030510: 6f6e 7365 293a 0a20 2020 2020 2020 2020  onse):.         
-00030520: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-00030530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030540: 2022 726f 6f6d 5f64 656c 6574 655f 616c   "room_delete_al
-00030550: 6961 7320 7375 6363 6573 7366 756c 2e20  ias successful. 
-00030560: 5265 7370 6f6e 7365 2069 733a 2022 0a20  Response is: ". 
-00030570: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00030580: 227b 7072 6976 6163 795f 6669 6c74 6572  "{privacy_filter
-00030590: 2873 7472 2872 6573 7029 297d 220a 2020  (str(resp))}".  
-000305a0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000305b0: 2020 2020 2020 2020 6773 2e6c 6f67 2e69          gs.log.i
-000305c0: 6e66 6f28 6622 5375 6363 6573 7366 756c  nfo(f"Successful
-000305d0: 6c79 2064 656c 6574 6564 2072 6f6f 6d20  ly deleted room 
-000305e0: 616c 6961 7320 277b 616c 6961 737d 272e  alias '{alias}'.
-000305f0: 2229 0a20 2020 2020 2020 2065 6c73 653a  ").        else:
-00030600: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
-00030610: 6c6f 672e 6572 726f 7228 0a20 2020 2020  log.error(.     
-00030620: 2020 2020 2020 2020 2020 2022 4532 3034             "E204
-00030630: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
-00030640: 2020 2020 6622 4661 696c 6564 2074 6f20      f"Failed to 
-00030650: 6465 6c65 7465 2072 6f6f 6d20 616c 6961  delete room alia
-00030660: 7320 277b 616c 6961 737d 273a 2022 0a20  s '{alias}': ". 
-00030670: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00030680: 227b 7072 6976 6163 795f 6669 6c74 6572  "{privacy_filter
-00030690: 2873 7472 2872 6573 7029 297d 220a 2020  (str(resp))}".  
-000306a0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000306b0: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
-000306c0: 6f75 6e74 202b 3d20 310a 0a0a 6173 796e  ount += 1...asyn
-000306d0: 6320 6465 6620 6163 7469 6f6e 5f67 6574  c def action_get
-000306e0: 5f6f 7065 6e69 645f 746f 6b65 6e28 0a20  _openid_token(. 
-000306f0: 2020 2063 6c69 656e 743a 2041 7379 6e63     client: Async
-00030700: 436c 6965 6e74 2c20 6372 6564 656e 7469  Client, credenti
-00030710: 616c 733a 2064 6963 740a 2920 2d3e 204e  als: dict.) -> N
-00030720: 6f6e 653a 0a20 2020 2022 2222 4765 7420  one:.    """Get 
-00030730: 4f70 656e 4964 2074 6f6b 656e 2873 2920  OpenId token(s) 
-00030740: 666f 7220 6974 7365 6c66 206f 7220 7573  for itself or us
-00030750: 6572 7320 7768 696c 6520 616c 7265 6164  ers while alread
-00030760: 7920 6c6f 6767 6564 2069 6e2e 2222 220a  y logged in.""".
-00030770: 2020 2020 6966 206e 6f74 2048 4156 455f      if not HAVE_
-00030780: 4f50 454e 4944 3a0a 2020 2020 2020 2020  OPENID:.        
-00030790: 6e69 6f5f 7665 7273 696f 6e20 3d20 706b  nio_version = pk
-000307a0: 675f 7265 736f 7572 6365 732e 6765 745f  g_resources.get_
-000307b0: 6469 7374 7269 6275 7469 6f6e 2822 6d61  distribution("ma
-000307c0: 7472 6978 2d6e 696f 2229 2e76 6572 7369  trix-nio").versi
-000307d0: 6f6e 0a20 2020 2020 2020 2067 732e 6c6f  on.        gs.lo
-000307e0: 672e 6572 726f 7228 0a20 2020 2020 2020  g.error(.       
-000307f0: 2020 2020 2022 4532 3035 3a20 220a 2020       "E205: ".  
-00030800: 2020 2020 2020 2020 2020 6622 596f 7520            f"You 
-00030810: 6172 6520 7275 6e6e 696e 6720 6d61 7472  are running matr
-00030820: 6978 2d6e 696f 2076 6572 7369 6f6e 207b  ix-nio version {
-00030830: 6e69 6f5f 7665 7273 696f 6e7d 2e20 220a  nio_version}. ".
-00030840: 2020 2020 2020 2020 2020 2020 6622 5468              f"Th
-00030850: 6973 2066 6561 7475 7265 2069 7320 6f6e  is feature is on
-00030860: 6c79 2061 7661 696c 6162 6c65 206f 6e20  ly available on 
-00030870: 7665 7273 696f 6e73 206c 6172 6765 7220  versions larger 
-00030880: 7468 616e 2030 2e31 392e 302e 2022 0a20  than 0.19.0. ". 
-00030890: 2020 2020 2020 2020 2020 2022 5570 6461             "Upda
-000308a0: 7465 2069 6620 6e65 6365 7373 6172 792e  te if necessary.
-000308b0: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-000308c0: 5761 6974 2066 6f72 2076 6572 7369 6f6e  Wait for version
-000308d0: 2030 2e31 392e 3120 6f72 2030 2e32 3020   0.19.1 or 0.20 
-000308e0: 746f 2062 6520 7265 6c65 6173 6564 2e20  to be released. 
-000308f0: 220a 2020 2020 2020 2020 2020 2020 224f  ".            "O
-00030900: 7220 7573 6520 756e 7265 6c65 6173 6564  r use unreleased
-00030910: 2063 6f64 6520 6672 6f6d 206d 6173 7465   code from maste
-00030920: 7220 6272 616e 6368 206f 6e20 4769 7468  r branch on Gith
-00030930: 7562 2e22 0a20 2020 2020 2020 2029 0a20  ub.".        ). 
-00030940: 2020 2020 2020 2067 732e 6572 725f 636f         gs.err_co
-00030950: 756e 7420 2b3d 2031 0a20 2020 2020 2020  unt += 1.       
-00030960: 2072 6574 7572 6e0a 2020 2020 6966 2067   return.    if g
-00030970: 732e 7061 2e67 6574 5f6f 7065 6e69 645f  s.pa.get_openid_
-00030980: 746f 6b65 6e20 3d3d 205b 5d3a 0a20 2020  token == []:.   
-00030990: 2020 2020 2067 732e 7061 2e67 6574 5f6f       gs.pa.get_o
-000309a0: 7065 6e69 645f 746f 6b65 6e2e 6170 7065  penid_token.appe
-000309b0: 6e64 2863 7265 6465 6e74 6961 6c73 5b22  nd(credentials["
-000309c0: 7573 6572 5f69 6422 5d29 2020 2320 7768  user_id"])  # wh
-000309d0: 6f61 6d69 0a20 2020 2067 732e 6c6f 672e  oami.    gs.log.
-000309e0: 6465 6275 6728 6622 4765 7474 696e 6720  debug(f"Getting 
-000309f0: 4f70 656e 4944 7320 666f 7220 7468 6573  OpenIDs for thes
-00030a00: 6520 7573 6572 733a 207b 6773 2e70 612e  e users: {gs.pa.
-00030a10: 6765 745f 6f70 656e 6964 5f74 6f6b 656e  get_openid_token
-00030a20: 7d22 290a 2020 2020 666f 7220 7573 6572  }").    for user
-00030a30: 5f69 6420 696e 2067 732e 7061 2e67 6574  _id in gs.pa.get
-00030a40: 5f6f 7065 6e69 645f 746f 6b65 6e3a 0a20  _openid_token:. 
-00030a50: 2020 2020 2020 2075 7365 725f 6964 203d         user_id =
-00030a60: 2075 7365 725f 6964 2e73 7472 6970 2829   user_id.strip()
-00030a70: 0a20 2020 2020 2020 2072 6573 7020 3d20  .        resp = 
-00030a80: 6177 6169 7420 636c 6965 6e74 2e67 6574  await client.get
-00030a90: 5f6f 7065 6e69 645f 746f 6b65 6e28 7573  _openid_token(us
-00030aa0: 6572 5f69 6429 0a20 2020 2020 2020 2069  er_id).        i
-00030ab0: 6620 6973 696e 7374 616e 6365 2872 6573  f isinstance(res
-00030ac0: 702c 2047 6574 4f70 656e 4944 546f 6b65  p, GetOpenIDToke
-00030ad0: 6e45 7272 6f72 293a 0a20 2020 2020 2020  nError):.       
-00030ae0: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
-00030af0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-00030b00: 2020 2022 4532 3036 3a20 220a 2020 2020     "E206: ".    
-00030b10: 2020 2020 2020 2020 2020 2020 6622 4661              f"Fa
-00030b20: 696c 6564 2074 6f20 6765 7420 4f70 656e  iled to get Open
-00030b30: 4964 2066 6f72 2075 7365 7220 7b75 7365  Id for user {use
-00030b40: 725f 6964 7d2e 2052 6573 706f 6e73 653a  r_id}. Response:
-00030b50: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00030b60: 2020 2066 227b 7072 6976 6163 795f 6669     f"{privacy_fi
-00030b70: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
-00030b80: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-00030b90: 2020 2020 2020 2020 2020 2020 6773 2e65              gs.e
-00030ba0: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
-00030bb0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00030bc0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-00030bd0: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
-00030be0: 2020 2020 2020 2267 6574 5f6f 7065 6e69        "get_openi
-00030bf0: 645f 746f 6b65 6e20 7375 6363 6573 7366  d_token successf
-00030c00: 756c 2e20 5265 7370 6f6e 7365 2069 733a  ul. Response is:
-00030c10: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00030c20: 2020 2066 227b 7072 6976 6163 795f 6669     f"{privacy_fi
-00030c30: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
-00030c40: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-00030c50: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
-00030c60: 6f67 2e69 6e66 6f28 0a20 2020 2020 2020  og.info(.       
-00030c70: 2020 2020 2020 2020 2066 2253 7563 6365           f"Succe
-00030c80: 7373 6675 6c6c 7920 6f62 7461 696e 6564  ssfully obtained
-00030c90: 204f 7065 6e49 6420 746f 6b65 6e20 220a   OpenId token ".
-00030ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030cb0: 6622 7b72 6573 702e 6163 6365 7373 5f74  f"{resp.access_t
-00030cc0: 6f6b 656e 7d20 666f 7220 7573 6572 207b  oken} for user {
-00030cd0: 7573 6572 5f69 647d 2e22 0a20 2020 2020  user_id}.".     
-00030ce0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00030cf0: 2020 2020 2023 206f 7574 7075 7420 666f       # output fo
-00030d00: 726d 6174 2063 6f6e 7472 6f6c 6c65 6420  rmat controlled 
-00030d10: 7669 6120 2d2d 6f75 7470 7574 2066 6c61  via --output fla
-00030d20: 670a 2020 2020 2020 2020 2020 2020 7465  g.            te
-00030d30: 7874 203d 2028 0a20 2020 2020 2020 2020  xt = (.         
-00030d40: 2020 2020 2020 2066 227b 7573 6572 5f69         f"{user_i
-00030d50: 647d 7b53 4550 7d7b 7265 7370 2e61 6363  d}{SEP}{resp.acc
-00030d60: 6573 735f 746f 6b65 6e7d 7b53 4550 7d7b  ess_token}{SEP}{
-00030d70: 7265 7370 2e65 7870 6972 6573 5f69 6e7d  resp.expires_in}
-00030d80: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00030d90: 2020 6622 7b53 4550 7d7b 7265 7370 2e6d    f"{SEP}{resp.m
-00030da0: 6174 7269 785f 7365 7276 6572 5f6e 616d  atrix_server_nam
-00030db0: 657d 7b53 4550 7d7b 7265 7370 2e74 6f6b  e}{SEP}{resp.tok
-00030dc0: 656e 5f74 7970 657d 220a 2020 2020 2020  en_type}".      
-00030dd0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00030de0: 2020 2020 2320 4f62 6a65 6374 206f 6620      # Object of 
-00030df0: 7479 7065 2078 7878 5265 7370 6f6e 7365  type xxxResponse
-00030e00: 2069 7320 6e6f 7420 4a53 4f4e 0a20 2020   is not JSON.   
-00030e10: 2020 2020 2020 2020 2023 2073 6572 6961           # seria
-00030e20: 6c69 7a61 626c 652c 2068 656e 6365 2077  lizable, hence w
-00030e30: 6520 7573 6520 7468 6520 6469 6374 696f  e use the dictio
-00030e40: 6e61 7279 2e0a 2020 2020 2020 2020 2020  nary..          
-00030e50: 2020 6a73 6f6e 5f6d 6178 203d 2072 6573    json_max = res
-00030e60: 702e 5f5f 6469 6374 5f5f 0a20 2020 2020  p.__dict__.     
-00030e70: 2020 2020 2020 206a 736f 6e5f 6d61 782e         json_max.
-00030e80: 7570 6461 7465 287b 2275 7365 725f 6964  update({"user_id
-00030e90: 223a 2075 7365 725f 6964 7d29 2020 2320  ": user_id})  # 
-00030ea0: 6164 6420 6469 6374 2069 7465 6d73 0a20  add dict items. 
-00030eb0: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-00030ec0: 203d 206a 736f 6e5f 6d61 782e 636f 7079   = json_max.copy
-00030ed0: 2829 0a20 2020 2020 2020 2020 2020 206a  ().            j
-00030ee0: 736f 6e5f 2e70 6f70 2822 7472 616e 7370  son_.pop("transp
-00030ef0: 6f72 745f 7265 7370 6f6e 7365 2229 0a20  ort_response"). 
-00030f00: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-00030f10: 7370 6563 203d 204e 6f6e 650a 2020 2020  spec = None.    
-00030f20: 2020 2020 2020 2020 7072 696e 745f 6f75          print_ou
-00030f30: 7470 7574 280a 2020 2020 2020 2020 2020  tput(.          
-00030f40: 2020 2020 2020 6773 2e70 612e 6f75 7470        gs.pa.outp
-00030f50: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
-00030f60: 2020 2020 7465 7874 3d74 6578 742c 0a20      text=text,. 
-00030f70: 2020 2020 2020 2020 2020 2020 2020 206a                 j
-00030f80: 736f 6e5f 3d6a 736f 6e5f 2c0a 2020 2020  son_=json_,.    
-00030f90: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-00030fa0: 5f6d 6178 3d6a 736f 6e5f 6d61 782c 0a20  _max=json_max,. 
-00030fb0: 2020 2020 2020 2020 2020 2020 2020 206a                 j
-00030fc0: 736f 6e5f 7370 6563 3d6a 736f 6e5f 7370  son_spec=json_sp
-00030fd0: 6563 2c0a 2020 2020 2020 2020 2020 2020  ec,.            
-00030fe0: 290a 0a0a 6173 796e 6320 6465 6620 6163  )...async def ac
-00030ff0: 7469 6f6e 5f72 6f6f 6d5f 6765 745f 7669  tion_room_get_vi
-00031000: 7369 6269 6c69 7479 280a 2020 2020 636c  sibility(.    cl
-00031010: 6965 6e74 3a20 4173 796e 6343 6c69 656e  ient: AsyncClien
-00031020: 742c 2063 7265 6465 6e74 6961 6c73 3a20  t, credentials: 
-00031030: 6469 6374 0a29 202d 3e20 4e6f 6e65 3a0a  dict.) -> None:.
-00031040: 2020 2020 2222 2247 6574 2076 6973 6962      """Get visib
-00031050: 696c 6974 7920 6f66 2072 6f6f 6d28 7329  ility of room(s)
-00031060: 2077 6869 6c65 2061 6c72 6561 6479 206c   while already l
-00031070: 6f67 6765 6420 696e 2e22 2222 0a20 2020  ogged in.""".   
-00031080: 2069 6620 6773 2e70 612e 726f 6f6d 5f67   if gs.pa.room_g
-00031090: 6574 5f76 6973 6962 696c 6974 7920 3d3d  et_visibility ==
-000310a0: 205b 5d3a 0a20 2020 2020 2020 2067 732e   []:.        gs.
-000310b0: 7061 2e72 6f6f 6d5f 6765 745f 7669 7369  pa.room_get_visi
-000310c0: 6269 6c69 7479 2e61 7070 656e 6428 6372  bility.append(cr
-000310d0: 6564 656e 7469 616c 735b 2272 6f6f 6d5f  edentials["room_
-000310e0: 6964 225d 2920 2023 2064 6566 2e20 726f  id"])  # def. ro
-000310f0: 6f6d 0a20 2020 2066 6f72 2072 6f6f 6d5f  om.    for room_
-00031100: 6964 2069 6e20 6773 2e70 612e 726f 6f6d  id in gs.pa.room
-00031110: 5f67 6574 5f76 6973 6962 696c 6974 793a  _get_visibility:
-00031120: 0a20 2020 2020 2020 2072 6f6f 6d5f 6964  .        room_id
-00031130: 203d 2061 7761 6974 206d 6170 5f72 6f6f   = await map_roo
-00031140: 6d69 6e66 6f5f 746f 5f72 6f6f 6d69 6428  minfo_to_roomid(
-00031150: 636c 6965 6e74 2c20 726f 6f6d 5f69 6429  client, room_id)
-00031160: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
-00031170: 6465 6275 6728 6622 4765 7474 696e 6720  debug(f"Getting 
-00031180: 7669 7369 6269 6c69 7479 2066 6f72 2072  visibility for r
-00031190: 6f6f 6d20 7b72 6f6f 6d5f 6964 7d2e 2229  oom {room_id}.")
-000311a0: 0a20 2020 2020 2020 2072 6573 7020 3d20  .        resp = 
-000311b0: 6177 6169 7420 636c 6965 6e74 2e72 6f6f  await client.roo
-000311c0: 6d5f 6765 745f 7669 7369 6269 6c69 7479  m_get_visibility
-000311d0: 2872 6f6f 6d5f 6964 290a 2020 2020 2020  (room_id).      
-000311e0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-000311f0: 7265 7370 2c20 526f 6f6d 4765 7456 6973  resp, RoomGetVis
-00031200: 6962 696c 6974 7952 6573 706f 6e73 6529  ibilityResponse)
-00031210: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
-00031220: 2e6c 6f67 2e69 6e66 6f28 0a20 2020 2020  .log.info(.     
-00031230: 2020 2020 2020 2020 2020 2066 2253 7563             f"Suc
-00031240: 6365 7373 6675 6c6c 7920 676f 7420 7669  cessfully got vi
-00031250: 7369 6269 6c69 7479 2066 6f72 2072 6f6f  sibility for roo
-00031260: 6d20 7b72 6573 702e 726f 6f6d 5f69 647d  m {resp.room_id}
-00031270: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
-00031280: 2020 2020 6622 7b72 6573 702e 7669 7369      f"{resp.visi
-00031290: 6269 6c69 7479 7d2e 220a 2020 2020 2020  bility}.".      
-000312a0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000312b0: 2020 2020 2320 6f75 7470 7574 2066 6f72      # output for
-000312c0: 6d61 7420 636f 6e74 726f 6c6c 6564 2076  mat controlled v
-000312d0: 6961 202d 2d6f 7574 7075 7420 666c 6167  ia --output flag
-000312e0: 0a20 2020 2020 2020 2020 2020 2074 6578  .            tex
-000312f0: 7420 3d20 6622 7b72 6573 702e 7669 7369  t = f"{resp.visi
-00031300: 6269 6c69 7479 7d7b 5345 507d 7b72 6f6f  bility}{SEP}{roo
-00031310: 6d5f 6964 7d22 0a20 2020 2020 2020 2020  m_id}".         
-00031320: 2020 2023 204f 626a 6563 7420 6f66 2074     # Object of t
-00031330: 7970 6520 7878 7852 6573 706f 6e73 6520  ype xxxResponse 
-00031340: 6973 206e 6f74 204a 534f 4e0a 2020 2020  is not JSON.    
-00031350: 2020 2020 2020 2020 2320 7365 7269 616c          # serial
-00031360: 697a 6162 6c65 2c20 6865 6e63 6520 7765  izable, hence we
-00031370: 2075 7365 2074 6865 2064 6963 7469 6f6e   use the diction
-00031380: 6172 792e 0a20 2020 2020 2020 2020 2020  ary..           
-00031390: 206a 736f 6e5f 6d61 7820 3d20 7265 7370   json_max = resp
-000313a0: 2e5f 5f64 6963 745f 5f0a 2020 2020 2020  .__dict__.      
-000313b0: 2020 2020 2020 2320 6a73 6f6e 5f6d 6178        # json_max
-000313c0: 2e75 7064 6174 6528 7b22 6b65 7922 3a20  .update({"key": 
-000313d0: 7661 6c75 657d 2920 2023 2061 6464 2064  value})  # add d
-000313e0: 6963 7420 6974 656d 730a 2020 2020 2020  ict items.      
-000313f0: 2020 2020 2020 6a73 6f6e 5f20 3d20 6a73        json_ = js
-00031400: 6f6e 5f6d 6178 2e63 6f70 7928 290a 2020  on_max.copy().  
-00031410: 2020 2020 2020 2020 2020 6a73 6f6e 5f2e            json_.
-00031420: 706f 7028 2274 7261 6e73 706f 7274 5f72  pop("transport_r
-00031430: 6573 706f 6e73 6522 290a 2020 2020 2020  esponse").      
-00031440: 2020 2020 2020 6a73 6f6e 5f73 7065 6320        json_spec 
-00031450: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
-00031460: 2020 2070 7269 6e74 5f6f 7574 7075 7428     print_output(
-00031470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031480: 2067 732e 7061 2e6f 7574 7075 742c 0a20   gs.pa.output,. 
-00031490: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000314a0: 6578 743d 7465 7874 2c0a 2020 2020 2020  ext=text,.      
-000314b0: 2020 2020 2020 2020 2020 6a73 6f6e 5f3d            json_=
-000314c0: 6a73 6f6e 5f2c 0a20 2020 2020 2020 2020  json_,.         
-000314d0: 2020 2020 2020 206a 736f 6e5f 6d61 783d         json_max=
-000314e0: 6a73 6f6e 5f6d 6178 2c0a 2020 2020 2020  json_max,.      
-000314f0: 2020 2020 2020 2020 2020 6a73 6f6e 5f73            json_s
-00031500: 7065 633d 6a73 6f6e 5f73 7065 632c 0a20  pec=json_spec,. 
-00031510: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00031520: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00031530: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
-00031540: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-00031550: 2020 2020 2022 4532 3037 3a20 220a 2020       "E207: ".  
-00031560: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00031570: 4661 696c 6564 2067 6574 7469 6e67 2076  Failed getting v
-00031580: 6973 6962 696c 6974 7920 666f 7220 726f  isibility for ro
-00031590: 6f6d 207b 726f 6f6d 5f69 647d 2e20 220a  om {room_id}. ".
-000315a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000315b0: 6622 7b70 7269 7661 6379 5f66 696c 7465  f"{privacy_filte
-000315c0: 7228 7374 7228 7265 7370 2929 7d22 0a20  r(str(resp))}". 
-000315d0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000315e0: 2020 2020 2020 2020 2067 732e 6572 725f           gs.err_
-000315f0: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
-00031600: 2020 2020 2020 2065 7272 6d73 6720 3d20         errmsg = 
-00031610: 2245 7272 6f72 3a20 2220 2b20 7374 7228  "Error: " + str(
-00031620: 7265 7370 2e73 7461 7475 735f 636f 6465  resp.status_code
-00031630: 2920 2b20 2220 2220 2b20 7265 7370 2e6d  ) + " " + resp.m
-00031640: 6573 7361 6765 0a20 2020 2020 2020 2020  essage.         
-00031650: 2020 2023 206f 7574 7075 7420 666f 726d     # output form
-00031660: 6174 2063 6f6e 7472 6f6c 6c65 6420 7669  at controlled vi
-00031670: 6120 2d2d 6f75 7470 7574 2066 6c61 670a  a --output flag.
-00031680: 2020 2020 2020 2020 2020 2020 2320 666f              # fo
-00031690: 7220 4a53 4f4e 2074 6865 2075 7365 7220  r JSON the user 
-000316a0: 6361 6e20 6465 7465 726d 696e 6520 7768  can determine wh
-000316b0: 6963 6820 6f6e 6520 6672 6f6d 2074 6865  ich one from the
-000316c0: 206c 6973 740a 2020 2020 2020 2020 2020   list.          
-000316d0: 2020 2320 7761 7320 7375 6363 6573 7366    # was successf
-000316e0: 756c 2061 6e64 2077 6869 6368 206f 6e65  ul and which one
-000316f0: 2066 6169 6c65 642e 2046 6f72 2034 2069   failed. For 4 i
-00031700: 6e70 7574 7320 7468 6572 650a 2020 2020  nputs there.    
-00031710: 2020 2020 2020 2020 2320 6d69 6768 7420          # might 
-00031720: 6f6e 6c79 2062 6520 3320 6f75 7470 7574  only be 3 output
-00031730: 204a 534f 4e20 6f62 6a65 6374 7320 6966   JSON objects if
-00031740: 2074 6865 7265 2077 6173 2031 2065 7272   there was 1 err
-00031750: 6f72 2e0a 2020 2020 2020 2020 2020 2020  or..            
-00031760: 2320 496e 2074 6578 7420 6d6f 6465 2077  # In text mode w
-00031770: 6520 7072 696e 7420 7468 6973 2065 7272  e print this err
-00031780: 6f72 206c 696e 652c 2073 6f20 7468 6174  or line, so that
-00031790: 2066 6f72 2034 2069 6e70 7574 730a 2020   for 4 inputs.  
-000317a0: 2020 2020 2020 2020 2020 2320 7468 6572            # ther
-000317b0: 6520 7769 6c6c 2062 6520 3420 6f75 7470  e will be 4 outp
-000317c0: 7574 206c 696e 6573 2e0a 2020 2020 2020  ut lines..      
-000317d0: 2020 2020 2020 7072 696e 745f 6f75 7470        print_outp
-000317e0: 7574 280a 2020 2020 2020 2020 2020 2020  ut(.            
-000317f0: 2020 2020 6773 2e70 612e 6f75 7470 7574      gs.pa.output
-00031800: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00031810: 2020 7465 7874 3d28 6622 7b65 7272 6d73    text=(f"{errms
-00031820: 677d 7b53 4550 7d7b 726f 6f6d 5f69 647d  g}{SEP}{room_id}
-00031830: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-00031840: 2020 2020 6a73 6f6e 5f3d 4e6f 6e65 2c0a      json_=None,.
-00031850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031860: 6a73 6f6e 5f6d 6178 3d4e 6f6e 652c 0a20  json_max=None,. 
-00031870: 2020 2020 2020 2020 2020 2020 2020 206a                 j
-00031880: 736f 6e5f 7370 6563 3d4e 6f6e 652c 0a20  son_spec=None,. 
-00031890: 2020 2020 2020 2020 2020 2029 0a0a 0a61             )...a
-000318a0: 7379 6e63 2064 6566 2061 6374 696f 6e5f  sync def action_
-000318b0: 726f 6f6d 5f67 6574 5f73 7461 7465 280a  room_get_state(.
-000318c0: 2020 2020 636c 6965 6e74 3a20 4173 796e      client: Asyn
-000318d0: 6343 6c69 656e 742c 2063 7265 6465 6e74  cClient, credent
-000318e0: 6961 6c73 3a20 6469 6374 0a29 202d 3e20  ials: dict.) -> 
-000318f0: 4e6f 6e65 3a0a 2020 2020 2222 2247 6574  None:.    """Get
-00031900: 2073 7461 7465 206f 6620 726f 6f6d 2873   state of room(s
-00031910: 2920 7768 696c 6520 616c 7265 6164 7920  ) while already 
-00031920: 6c6f 6767 6564 2069 6e2e 2222 220a 2020  logged in.""".  
-00031930: 2020 6966 2067 732e 7061 2e72 6f6f 6d5f    if gs.pa.room_
-00031940: 6765 745f 7374 6174 6520 3d3d 205b 5d3a  get_state == []:
-00031950: 0a20 2020 2020 2020 2067 732e 7061 2e72  .        gs.pa.r
-00031960: 6f6f 6d5f 6765 745f 7374 6174 652e 6170  oom_get_state.ap
-00031970: 7065 6e64 2863 7265 6465 6e74 6961 6c73  pend(credentials
-00031980: 5b22 726f 6f6d 5f69 6422 5d29 2020 2320  ["room_id"])  # 
-00031990: 6465 6661 756c 7420 726f 6f6d 0a20 2020  default room.   
-000319a0: 2066 6f72 2072 6f6f 6d5f 6964 2069 6e20   for room_id in 
-000319b0: 6773 2e70 612e 726f 6f6d 5f67 6574 5f73  gs.pa.room_get_s
-000319c0: 7461 7465 3a0a 2020 2020 2020 2020 726f  tate:.        ro
-000319d0: 6f6d 5f69 6420 3d20 6177 6169 7420 6d61  om_id = await ma
-000319e0: 705f 726f 6f6d 696e 666f 5f74 6f5f 726f  p_roominfo_to_ro
-000319f0: 6f6d 6964 2863 6c69 656e 742c 2072 6f6f  omid(client, roo
-00031a00: 6d5f 6964 290a 2020 2020 2020 2020 6773  m_id).        gs
-00031a10: 2e6c 6f67 2e64 6562 7567 2866 2247 6574  .log.debug(f"Get
-00031a20: 7469 6e67 2076 6973 6962 696c 6974 7920  ting visibility 
-00031a30: 666f 7220 726f 6f6d 207b 726f 6f6d 5f69  for room {room_i
-00031a40: 647d 2e22 290a 2020 2020 2020 2020 7265  d}.").        re
-00031a50: 7370 203d 2061 7761 6974 2063 6c69 656e  sp = await clien
-00031a60: 742e 726f 6f6d 5f67 6574 5f73 7461 7465  t.room_get_state
-00031a70: 2872 6f6f 6d5f 6964 290a 2020 2020 2020  (room_id).      
-00031a80: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00031a90: 7265 7370 2c20 526f 6f6d 4765 7453 7461  resp, RoomGetSta
-00031aa0: 7465 5265 7370 6f6e 7365 293a 0a20 2020  teResponse):.   
-00031ab0: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
-00031ac0: 696e 666f 280a 2020 2020 2020 2020 2020  info(.          
-00031ad0: 2020 2020 2020 6622 5375 6363 6573 7366        f"Successf
-00031ae0: 756c 6c79 2067 6f74 2073 7461 7465 2066  ully got state f
-00031af0: 6f72 2072 6f6f 6d20 7b72 6573 702e 726f  or room {resp.ro
-00031b00: 6f6d 5f69 647d 3a20 220a 2020 2020 2020  om_id}: ".      
-00031b10: 2020 2020 2020 2020 2020 6622 7b72 6573            f"{res
-00031b20: 702e 6576 656e 7473 7d2e 220a 2020 2020  p.events}.".    
-00031b30: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00031b40: 2020 2020 2020 2320 6f75 7470 7574 2066        # output f
-00031b50: 6f72 6d61 7420 636f 6e74 726f 6c6c 6564  ormat controlled
-00031b60: 2076 6961 202d 2d6f 7574 7075 7420 666c   via --output fl
-00031b70: 6167 0a20 2020 2020 2020 2020 2020 2074  ag.            t
-00031b80: 6578 7420 3d20 6622 7b72 6573 702e 6576  ext = f"{resp.ev
-00031b90: 656e 7473 7d7b 5345 507d 7b72 6f6f 6d5f  ents}{SEP}{room_
-00031ba0: 6964 7d22 0a20 2020 2020 2020 2020 2020  id}".           
-00031bb0: 2023 204f 626a 6563 7420 6f66 2074 7970   # Object of typ
-00031bc0: 6520 7878 7852 6573 706f 6e73 6520 6973  e xxxResponse is
-00031bd0: 206e 6f74 204a 534f 4e0a 2020 2020 2020   not JSON.      
-00031be0: 2020 2020 2020 2320 7365 7269 616c 697a        # serializ
-00031bf0: 6162 6c65 2c20 6865 6e63 6520 7765 2075  able, hence we u
-00031c00: 7365 2074 6865 2064 6963 7469 6f6e 6172  se the dictionar
-00031c10: 792e 0a20 2020 2020 2020 2020 2020 206a  y..            j
-00031c20: 736f 6e5f 6d61 7820 3d20 7265 7370 2e5f  son_max = resp._
-00031c30: 5f64 6963 745f 5f0a 2020 2020 2020 2020  _dict__.        
-00031c40: 2020 2020 2320 6a73 6f6e 5f6d 6178 2e75      # json_max.u
-00031c50: 7064 6174 6528 7b22 6b65 7922 3a20 7661  pdate({"key": va
-00031c60: 6c75 657d 2920 2023 2061 6464 2064 6963  lue})  # add dic
-00031c70: 7420 6974 656d 730a 2020 2020 2020 2020  t items.        
-00031c80: 2020 2020 6a73 6f6e 5f20 3d20 6a73 6f6e      json_ = json
-00031c90: 5f6d 6178 2e63 6f70 7928 290a 2020 2020  _max.copy().    
-00031ca0: 2020 2020 2020 2020 6a73 6f6e 5f2e 706f          json_.po
-00031cb0: 7028 2274 7261 6e73 706f 7274 5f72 6573  p("transport_res
-00031cc0: 706f 6e73 6522 290a 2020 2020 2020 2020  ponse").        
-00031cd0: 2020 2020 6a73 6f6e 5f73 7065 6320 3d20      json_spec = 
-00031ce0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-00031cf0: 2070 7269 6e74 5f6f 7574 7075 7428 0a20   print_output(. 
-00031d00: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00031d10: 732e 7061 2e6f 7574 7075 742c 0a20 2020  s.pa.output,.   
-00031d20: 2020 2020 2020 2020 2020 2020 2074 6578               tex
-00031d30: 743d 7465 7874 2c0a 2020 2020 2020 2020  t=text,.        
-00031d40: 2020 2020 2020 2020 6a73 6f6e 5f3d 6a73          json_=js
-00031d50: 6f6e 5f2c 0a20 2020 2020 2020 2020 2020  on_,.           
-00031d60: 2020 2020 206a 736f 6e5f 6d61 783d 6a73       json_max=js
-00031d70: 6f6e 5f6d 6178 2c0a 2020 2020 2020 2020  on_max,.        
-00031d80: 2020 2020 2020 2020 6a73 6f6e 5f73 7065          json_spe
-00031d90: 633d 6a73 6f6e 5f73 7065 632c 0a20 2020  c=json_spec,.   
-00031da0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00031db0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00031dc0: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
-00031dd0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-00031de0: 2020 2022 4532 3038 3a20 220a 2020 2020     "E208: ".    
-00031df0: 2020 2020 2020 2020 2020 2020 6622 4661              f"Fa
-00031e00: 696c 6564 2067 6574 7469 6e67 2073 7461  iled getting sta
-00031e10: 7465 2066 6f72 2072 6f6f 6d20 7b72 6f6f  te for room {roo
-00031e20: 6d5f 6964 7d2e 2022 0a20 2020 2020 2020  m_id}. ".       
-00031e30: 2020 2020 2020 2020 2066 227b 7072 6976           f"{priv
-00031e40: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
-00031e50: 6573 7029 297d 220a 2020 2020 2020 2020  esp))}".        
-00031e60: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00031e70: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
-00031e80: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-00031e90: 6572 726d 7367 203d 2022 4572 726f 723a  errmsg = "Error:
-00031ea0: 2022 202b 2073 7472 2872 6573 702e 7374   " + str(resp.st
-00031eb0: 6174 7573 5f63 6f64 6529 202b 2022 2022  atus_code) + " "
-00031ec0: 202b 2072 6573 702e 6d65 7373 6167 650a   + resp.message.
-00031ed0: 2020 2020 2020 2020 2020 2020 2320 6f75              # ou
-00031ee0: 7470 7574 2066 6f72 6d61 7420 636f 6e74  tput format cont
-00031ef0: 726f 6c6c 6564 2076 6961 202d 2d6f 7574  rolled via --out
-00031f00: 7075 7420 666c 6167 0a20 2020 2020 2020  put flag.       
-00031f10: 2020 2020 2023 2066 6f72 204a 534f 4e20       # for JSON 
-00031f20: 7468 6520 7573 6572 2063 616e 2064 6574  the user can det
-00031f30: 6572 6d69 6e65 2077 6869 6368 206f 6e65  ermine which one
-00031f40: 2066 726f 6d20 7468 6520 6c69 7374 0a20   from the list. 
-00031f50: 2020 2020 2020 2020 2020 2023 2077 6173             # was
-00031f60: 2073 7563 6365 7373 6675 6c20 616e 6420   successful and 
-00031f70: 7768 6963 6820 6f6e 6520 6661 696c 6564  which one failed
-00031f80: 2e20 466f 7220 3420 696e 7075 7473 2074  . For 4 inputs t
-00031f90: 6865 7265 0a20 2020 2020 2020 2020 2020  here.           
-00031fa0: 2023 206d 6967 6874 206f 6e6c 7920 6265   # might only be
-00031fb0: 2033 206f 7574 7075 7420 4a53 4f4e 206f   3 output JSON o
-00031fc0: 626a 6563 7473 2069 6620 7468 6572 6520  bjects if there 
-00031fd0: 7761 7320 3120 6572 726f 722e 0a20 2020  was 1 error..   
-00031fe0: 2020 2020 2020 2020 2023 2049 6e20 7465           # In te
-00031ff0: 7874 206d 6f64 6520 7765 2070 7269 6e74  xt mode we print
-00032000: 2074 6869 7320 6572 726f 7220 6c69 6e65   this error line
-00032010: 2c20 736f 2074 6861 7420 666f 7220 3420  , so that for 4 
-00032020: 696e 7075 7473 0a20 2020 2020 2020 2020  inputs.         
-00032030: 2020 2023 2074 6865 7265 2077 696c 6c20     # there will 
-00032040: 6265 2034 206f 7574 7075 7420 6c69 6e65  be 4 output line
-00032050: 732e 0a20 2020 2020 2020 2020 2020 2070  s..            p
-00032060: 7269 6e74 5f6f 7574 7075 7428 0a20 2020  rint_output(.   
-00032070: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
-00032080: 7061 2e6f 7574 7075 742c 0a20 2020 2020  pa.output,.     
-00032090: 2020 2020 2020 2020 2020 2074 6578 743d             text=
-000320a0: 2866 227b 6572 726d 7367 7d7b 5345 507d  (f"{errmsg}{SEP}
-000320b0: 7b72 6f6f 6d5f 6964 7d22 292c 0a20 2020  {room_id}"),.   
-000320c0: 2020 2020 2020 2020 2020 2020 206a 736f               jso
-000320d0: 6e5f 3d4e 6f6e 652c 0a20 2020 2020 2020  n_=None,.       
-000320e0: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
-000320f0: 783d 4e6f 6e65 2c0a 2020 2020 2020 2020  x=None,.        
-00032100: 2020 2020 2020 2020 6a73 6f6e 5f73 7065          json_spe
-00032110: 633d 4e6f 6e65 2c0a 2020 2020 2020 2020  c=None,.        
-00032120: 2020 2020 290a 0a0a 6173 796e 6320 6465      )...async de
-00032130: 6620 6163 7469 6f6e 5f64 656c 6574 655f  f action_delete_
-00032140: 6465 7669 6365 2863 6c69 656e 743a 2041  device(client: A
-00032150: 7379 6e63 436c 6965 6e74 2c20 6372 6564  syncClient, cred
-00032160: 656e 7469 616c 733a 2064 6963 7429 202d  entials: dict) -
-00032170: 3e20 4e6f 6e65 3a0a 2020 2020 2222 2244  > None:.    """D
-00032180: 656c 6574 6520 6465 7669 6365 2873 2920  elete device(s) 
-00032190: 666f 7220 6974 7365 6c66 206f 7220 6f74  for itself or ot
-000321a0: 6865 7220 7573 6572 2077 6869 6c65 2061  her user while a
-000321b0: 6c72 6561 6479 206c 6f67 6765 6420 696e  lready logged in
-000321c0: 2e0a 0a20 2020 2046 6f72 2064 6f63 756d  ...    For docum
-000321d0: 656e 7461 7469 6f6e 2072 6561 643a 0a20  entation read:. 
-000321e0: 2020 2068 7474 7073 3a2f 2f6d 6174 7269     https://matri
-000321f0: 782d 6e69 6f2e 7265 6164 7468 6564 6f63  x-nio.readthedoc
-00032200: 732e 696f 2f65 6e2f 6c61 7465 7374 2f6e  s.io/en/latest/n
-00032210: 696f 2e68 746d 6c23 6173 796e 6363 6c69  io.html#asynccli
-00032220: 656e 740a 2020 2020 6874 7470 733a 2f2f  ent.    https://
-00032230: 6d61 7472 6978 2e6f 7267 2f64 6f63 732f  matrix.org/docs/
-00032240: 7370 6563 2f63 6c69 656e 745f 7365 7276  spec/client_serv
-00032250: 6572 2f72 302e 362e 3023 6175 7468 656e  er/r0.6.0#authen
-00032260: 7469 6361 7469 6f6e 2d74 7970 6573 0a0a  tication-types..
-00032270: 2020 2020 5468 6572 6520 6172 6520 7365      There are se
-00032280: 7665 7261 6c20 7761 7973 2074 6f20 6175  veral ways to au
-00032290: 7468 656e 7469 6361 7465 2c20 736f 6d65  thenticate, some
-000322a0: 206f 6620 7468 6573 6520 7761 7973 206d   of these ways m
-000322b0: 6179 206f 7220 6d61 7920 6e6f 740a 2020  ay or may not.  
-000322c0: 2020 6265 2073 7570 706f 7274 6564 2062    be supported b
-000322d0: 7920 7468 6520 7365 7276 6572 2e20 536f  y the server. So
-000322e0: 2c20 7468 6973 2069 7320 7365 7276 6572  , this is server
-000322f0: 2073 7065 6369 6669 632e 0a20 2020 2054   specific..    T
-00032300: 6865 2022 6d2e 6c6f 6769 6e2e 746f 6b65  he "m.login.toke
-00032310: 6e22 206f 7074 696f 6e20 7365 656d 7320  n" option seems 
-00032320: 7573 6566 756c 2061 7420 6669 7273 7420  useful at first 
-00032330: 676c 616e 6365 2c20 6275 7420 6e6f 7465  glance, but note
-00032340: 2074 6861 740a 2020 2020 7468 6973 2069   that.    this i
-00032350: 7320 4e4f 5420 616e 2061 6363 6573 7320  s NOT an access 
-00032360: 746f 6b65 6e2c 2062 7574 2061 206c 6f67  token, but a log
-00032370: 696e 2074 6f6b 656e 2072 6563 6569 7665  in token receive
-00032380: 6420 6672 6f6d 2073 6f6d 6577 6865 7265  d from somewhere
-00032390: 0a20 2020 2065 6c73 652e 2053 6f2c 2069  .    else. So, i
-000323a0: 6e20 7265 616c 6974 7920 7468 6520 226d  n reality the "m
-000323b0: 2e6c 6f67 696e 2e74 6f6b 656e 2220 6f70  .login.token" op
-000323c0: 7469 6f6e 2069 7320 6e6f 7420 7573 6566  tion is not usef
-000323d0: 756c 2e0a 2020 2020 7b0a 2020 2020 2020  ul..    {.      
-000323e0: 2274 7970 6522 3a20 226d 2e6c 6f67 696e  "type": "m.login
-000323f0: 2e74 6f6b 656e 222c 0a20 2020 2020 2022  .token",.      "
-00032400: 746f 6b65 6e22 3a20 223c 746f 6b65 6e3e  token": "<token>
-00032410: 222c 2020 3c3d 3d20 7468 6973 2069 7320  ",  <== this is 
-00032420: 6120 6c6f 6769 6e20 746f 6b65 6e2c 204e  a login token, N
-00032430: 4f54 2061 6e20 6163 6365 7373 2074 6f6b  OT an access tok
-00032440: 656e 210a 2020 2020 2020 2274 786e 5f69  en!.      "txn_i
-00032450: 6422 3a20 223c 636c 6965 6e74 2067 656e  d": "<client gen
-00032460: 6572 6174 6564 206e 6f6e 6365 3e22 2c0a  erated nonce>",.
-00032470: 2020 2020 2020 2273 6573 7369 6f6e 223a        "session":
-00032480: 2022 3c73 6573 7369 6f6e 2049 443e 220a   "<session ID>".
-00032490: 2020 2020 7d0a 0a20 2020 2054 6865 2022      }..    The "
-000324a0: 6d2e 6c6f 6769 6e2e 7373 6f22 206f 7074  m.login.sso" opt
-000324b0: 696f 6e20 776f 756c 6420 6265 2075 7365  ion would be use
-000324c0: 6675 6c2c 2062 7574 2049 2068 6176 656e  ful, but I haven
-000324d0: 2774 2069 6d70 6c65 6d65 6e74 6564 2069  't implemented i
-000324e0: 740a 2020 2020 7965 742e 2049 7420 776f  t.    yet. It wo
-000324f0: 756c 6420 6265 2061 2062 6974 2073 696d  uld be a bit sim
-00032500: 696c 6172 2061 7320 746f 2074 6865 2063  ilar as to the c
-00032510: 6f64 6520 696e 2061 6374 696f 6e5f 6c6f  ode in action_lo
-00032520: 6769 6e28 292e 0a0a 2020 2020 5468 6520  gin()...    The 
-00032530: 6d6f 7374 2063 6f6d 6d6f 6e20 6f70 7469  most common opti
-00032540: 6f6e 2069 7320 226d 2e6c 6f67 696e 2e70  on is "m.login.p
-00032550: 6173 7377 6f72 6422 2e20 5468 6973 206f  assword". This o
-00032560: 7074 696f 6e20 6973 2069 6d70 6c65 6d65  ption is impleme
-00032570: 6e74 6564 2e0a 2020 2020 2222 220a 2020  nted..    """.  
-00032580: 2020 6966 206e 6f74 2067 732e 7061 2e70    if not gs.pa.p
-00032590: 6173 7377 6f72 643a 0a20 2020 2020 2020  assword:.       
-000325a0: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
-000325b0: 2020 2020 2020 2020 2020 2022 4532 3039             "E209
-000325c0: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
-000325d0: 6622 4661 696c 6564 2074 6f20 6465 6c65  f"Failed to dele
-000325e0: 7465 2064 6576 6963 6573 2062 6563 6175  te devices becau
-000325f0: 7365 202d 2d70 6173 7377 6f72 6420 7761  se --password wa
-00032600: 7320 6e6f 7420 7365 742e 2022 0a20 2020  s not set. ".   
-00032610: 2020 2020 2020 2020 2066 2228 7b67 732e           f"({gs.
-00032620: 7061 2e70 6173 7377 6f72 647d 2922 0a20  pa.password})". 
-00032630: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00032640: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
-00032650: 2031 0a20 2020 2020 2020 2072 6574 7572   1.        retur
-00032660: 6e0a 2020 2020 656c 7365 3a0a 2020 2020  n.    else:.    
-00032670: 2020 2020 7061 7373 776f 7264 203d 2067      password = g
-00032680: 732e 7061 2e70 6173 7377 6f72 640a 2020  s.pa.password.  
-00032690: 2020 6966 206e 6f74 2067 732e 7061 2e75    if not gs.pa.u
-000326a0: 7365 723a 0a20 2020 2020 2020 2023 2067  ser:.        # g
-000326b0: 6574 2070 7265 7365 6e63 6520 6e61 6d65  et presence name
-000326c0: 206f 6620 6d79 7365 6c66 0a20 2020 2020   of myself.     
-000326d0: 2020 2075 7365 725f 6964 203d 2063 7265     user_id = cre
-000326e0: 6465 6e74 6961 6c73 5b22 7573 6572 5f69  dentials["user_i
-000326f0: 6422 5d0a 2020 2020 656c 7365 3a0a 2020  d"].    else:.  
-00032700: 2020 2020 2020 7573 6572 5f69 6420 3d20        user_id = 
-00032710: 6773 2e70 612e 7573 6572 5b30 5d0a 2020  gs.pa.user[0].  
-00032720: 2020 2020 2020 6966 206c 656e 2867 732e        if len(gs.
-00032730: 7061 2e75 7365 7229 203e 2031 3a0a 2020  pa.user) > 1:.  
-00032740: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-00032750: 2e77 6172 6e69 6e67 280a 2020 2020 2020  .warning(.      
-00032760: 2020 2020 2020 2020 2020 2257 3130 393a            "W109:
-00032770: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00032780: 2020 2022 5761 726e 696e 672e 2022 0a20     "Warning. ". 
-00032790: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000327a0: 2d2d 7573 6572 2073 7065 6369 6669 6573  --user specifies
-000327b0: 206d 6f72 6520 7468 656e 206f 6e65 2075   more then one u
-000327c0: 7365 722e 2049 6620 2d2d 7573 6572 2069  ser. If --user i
-000327d0: 7320 7573 6564 2061 7420 220a 2020 2020  s used at ".    
-000327e0: 2020 2020 2020 2020 2020 2020 2261 6c6c              "all
-000327f0: 2c20 7468 656e 2065 7861 6374 6c79 206f  , then exactly o
-00032800: 6e65 2075 7365 7220 7368 6f75 6c64 2062  ne user should b
-00032810: 6520 6769 7665 6e2e 220a 2020 2020 2020  e given.".      
-00032820: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00032830: 2020 2020 6773 2e77 6172 6e5f 636f 756e      gs.warn_coun
-00032840: 7420 2b3d 2031 0a20 2020 2064 6576 6963  t += 1.    devic
-00032850: 6573 203d 2067 732e 7061 2e64 656c 6574  es = gs.pa.delet
-00032860: 655f 6465 7669 6365 0a20 2020 2023 2074  e_device.    # t
-00032870: 6869 7320 6175 746f 6d61 7469 6361 6c6c  his automaticall
-00032880: 7920 6573 6361 7065 7320 7468 6520 2220  y escapes the " 
-00032890: 6c65 7474 6572 7320 696e 2074 6865 2070  letters in the p
-000328a0: 6173 7377 6f72 642c 0a20 2020 2023 2061  assword,.    # a
-000328b0: 6e64 2074 616b 6573 2063 6172 6520 6f66  nd takes care of
-000328c0: 2073 7061 6365 732c 2065 7463 2e0a 2020   spaces, etc..  
-000328d0: 2020 6175 7468 203d 207b 0a20 2020 2020    auth = {.     
-000328e0: 2020 2022 7479 7065 223a 2022 6d2e 6c6f     "type": "m.lo
-000328f0: 6769 6e2e 7061 7373 776f 7264 222c 0a20  gin.password",. 
-00032900: 2020 2020 2020 2022 6964 656e 7469 6669         "identifi
-00032910: 6572 223a 207b 2274 7970 6522 3a20 226d  er": {"type": "m
-00032920: 2e69 642e 7573 6572 222c 2022 7573 6572  .id.user", "user
-00032930: 223a 2075 7365 725f 6964 7d2c 0a20 2020  ": user_id},.   
-00032940: 2020 2020 2022 7061 7373 776f 7264 223a       "password":
-00032950: 2070 6173 7377 6f72 642c 0a20 2020 207d   password,.    }
-00032960: 0a20 2020 2070 6173 7377 6f72 6466 616b  .    passwordfak
-00032970: 6520 3d20 222a 2a2a 220a 2020 2020 6175  e = "***".    au
-00032980: 7468 6661 6b65 203d 207b 0a20 2020 2020  thfake = {.     
-00032990: 2020 2022 7479 7065 223a 2022 6d2e 6c6f     "type": "m.lo
-000329a0: 6769 6e2e 7061 7373 776f 7264 222c 0a20  gin.password",. 
-000329b0: 2020 2020 2020 2022 6964 656e 7469 6669         "identifi
-000329c0: 6572 223a 207b 2274 7970 6522 3a20 226d  er": {"type": "m
-000329d0: 2e69 642e 7573 6572 222c 2022 7573 6572  .id.user", "user
-000329e0: 223a 2075 7365 725f 6964 7d2c 0a20 2020  ": user_id},.   
-000329f0: 2020 2020 2022 7061 7373 776f 7264 223a       "password":
-00032a00: 2070 6173 7377 6f72 6466 616b 652c 0a20   passwordfake,. 
-00032a10: 2020 207d 0a20 2020 2067 732e 6c6f 672e     }.    gs.log.
-00032a20: 6465 6275 6728 0a20 2020 2020 2020 2066  debug(.        f
-00032a30: 2241 626f 7574 2074 6f20 6465 6c65 7465  "About to delete
-00032a40: 2064 6576 6963 6573 207b 6465 7669 6365   devices {device
-00032a50: 737d 2066 6f72 2075 7365 7220 7b75 7365  s} for user {use
-00032a60: 725f 6964 7d20 220a 2020 2020 2020 2020  r_id} ".        
-00032a70: 6622 7769 7468 2070 6173 7377 6f72 6420  f"with password 
-00032a80: 7b70 6173 7377 6f72 6466 616b 657d 2061  {passwordfake} a
-00032a90: 6e64 2061 7574 6820 7b61 7574 6866 616b  nd auth {authfak
-00032aa0: 657d 2e22 0a20 2020 2029 0a20 2020 2072  e}.".    ).    r
-00032ab0: 6573 7020 3d20 6177 6169 7420 636c 6965  esp = await clie
-00032ac0: 6e74 2e64 656c 6574 655f 6465 7669 6365  nt.delete_device
-00032ad0: 7328 6465 7669 6365 732c 2061 7574 6829  s(devices, auth)
-00032ae0: 0a20 2020 2069 6620 6973 696e 7374 616e  .    if isinstan
-00032af0: 6365 2872 6573 702c 2044 656c 6574 6544  ce(resp, DeleteD
-00032b00: 6576 6963 6573 4572 726f 7229 3a0a 2020  evicesError):.  
-00032b10: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
-00032b20: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00032b30: 2245 3231 303a 2022 0a20 2020 2020 2020  "E210: ".       
-00032b40: 2020 2020 2066 2246 6169 6c65 6420 746f       f"Failed to
-00032b50: 2064 656c 6574 6520 6465 7669 6365 7320   delete devices 
-00032b60: 7b64 6576 6963 6573 7d20 666f 7220 7573  {devices} for us
-00032b70: 6572 207b 7573 6572 5f69 647d 2022 0a20  er {user_id} ". 
-00032b80: 2020 2020 2020 2020 2020 2066 2277 6974             f"wit
-00032b90: 6820 7061 7373 776f 7264 207b 7061 7373  h password {pass
-00032ba0: 776f 7264 6661 6b65 7d20 616e 6420 6175  wordfake} and au
-00032bb0: 7468 207b 6175 7468 6661 6b65 7d2e 2022  th {authfake}. "
-00032bc0: 0a20 2020 2020 2020 2020 2020 2066 2252  .            f"R
-00032bd0: 6573 706f 6e73 653a 207b 7072 6976 6163  esponse: {privac
-00032be0: 795f 6669 6c74 6572 2873 7472 2872 6573  y_filter(str(res
-00032bf0: 7029 297d 220a 2020 2020 2020 2020 290a  p))}".        ).
-00032c00: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
-00032c10: 6f75 6e74 202b 3d20 310a 2020 2020 656c  ount += 1.    el
-00032c20: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
-00032c30: 7370 2c20 4465 6c65 7465 4465 7669 6365  sp, DeleteDevice
-00032c40: 7341 7574 6852 6573 706f 6e73 6529 3a0a  sAuthResponse):.
-00032c50: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
-00032c60: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00032c70: 2020 2245 3231 313a 2022 0a20 2020 2020    "E211: ".     
-00032c80: 2020 2020 2020 2066 2246 6169 6c65 6420         f"Failed 
-00032c90: 746f 2064 656c 6574 6520 6465 7669 6365  to delete device
-00032ca0: 7320 7b64 6576 6963 6573 7d20 666f 7220  s {devices} for 
-00032cb0: 7573 6572 207b 7573 6572 5f69 647d 2064  user {user_id} d
-00032cc0: 7565 2074 6f20 220a 2020 2020 2020 2020  ue to ".        
-00032cd0: 2020 2020 2261 7574 6865 6e74 6963 6174      "authenticat
-00032ce0: 696f 6e20 6661 696c 7572 652e 2041 7265  ion failure. Are
-00032cf0: 2079 6f75 2061 7574 686f 7269 7a65 643f   you authorized?
-00032d00: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
-00032d10: 2241 7574 6865 6e74 6963 6174 696f 6e3a  "Authentication:
-00032d20: 207b 6175 7468 6661 6b65 7d2c 2052 6573   {authfake}, Res
-00032d30: 706f 6e73 653a 2022 0a20 2020 2020 2020  ponse: ".       
-00032d40: 2020 2020 2066 227b 7072 6976 6163 795f       f"{privacy_
-00032d50: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
-00032d60: 297d 220a 2020 2020 2020 2020 290a 2020  )}".        ).  
-00032d70: 2020 2020 2020 6773 2e65 7272 5f63 6f75        gs.err_cou
-00032d80: 6e74 202b 3d20 310a 2020 2020 656c 7365  nt += 1.    else
-00032d90: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
-00032da0: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-00032db0: 2020 2020 2264 656c 6574 655f 6465 7669      "delete_devi
-00032dc0: 6365 7320 7375 6363 6573 7366 756c 2e20  ces successful. 
-00032dd0: 5265 7370 6f6e 7365 2069 733a 2022 0a20  Response is: ". 
-00032de0: 2020 2020 2020 2020 2020 2066 227b 7072             f"{pr
-00032df0: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
-00032e00: 2872 6573 7029 297d 220a 2020 2020 2020  (resp))}".      
-00032e10: 2020 290a 2020 2020 2020 2020 6773 2e6c    ).        gs.l
-00032e20: 6f67 2e69 6e66 6f28 0a20 2020 2020 2020  og.info(.       
-00032e30: 2020 2020 2066 2253 7563 6365 7373 6675       f"Successfu
-00032e40: 6c6c 7920 6465 6c65 7465 6420 6465 7669  lly deleted devi
-00032e50: 6365 7320 7b64 6576 6963 6573 7d20 666f  ces {devices} fo
-00032e60: 7220 7573 6572 207b 7573 6572 5f69 647d  r user {user_id}
-00032e70: 2e22 0a20 2020 2020 2020 2029 0a0a 0a61  .".        )...a
-00032e80: 7379 6e63 2064 6566 2061 6374 696f 6e5f  sync def action_
-00032e90: 726f 6f6d 5f72 6564 6163 7428 636c 6965  room_redact(clie
-00032ea0: 6e74 3a20 4173 796e 6343 6c69 656e 742c  nt: AsyncClient,
-00032eb0: 2063 7265 6465 6e74 6961 6c73 3a20 6469   credentials: di
-00032ec0: 6374 2920 2d3e 204e 6f6e 653a 0a20 2020  ct) -> None:.   
-00032ed0: 2022 2222 5265 6461 6374 2065 7665 6e74   """Redact event
-00032ee0: 2873 2920 6f66 2072 6f6f 6d28 7329 2077  (s) of room(s) w
-00032ef0: 6869 6c65 2061 6c72 6561 6479 206c 6f67  hile already log
-00032f00: 6765 6420 696e 2e22 2222 0a20 2020 2069  ged in.""".    i
-00032f10: 6620 6c65 6e28 6773 2e70 612e 726f 6f6d  f len(gs.pa.room
-00032f20: 5f72 6564 6163 7429 203d 3d20 323a 0a20  _redact) == 2:. 
-00032f30: 2020 2020 2020 2067 732e 7061 2e72 6f6f         gs.pa.roo
-00032f40: 6d5f 7265 6461 6374 2e61 7070 656e 6428  m_redact.append(
-00032f50: 2222 290a 2020 2020 6966 206e 6f74 206c  "").    if not l
-00032f60: 656e 2867 732e 7061 2e72 6f6f 6d5f 7265  en(gs.pa.room_re
-00032f70: 6461 6374 2920 2520 3320 3d3d 2030 3a0a  dact) % 3 == 0:.
-00032f80: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
-00032f90: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00032fa0: 2020 2245 3231 323a 2022 0a20 2020 2020    "E212: ".     
-00032fb0: 2020 2020 2020 2022 496e 636f 7272 6563         "Incorrec
-00032fc0: 7420 6e75 6d62 6572 206f 6620 6172 6775  t number of argu
-00032fd0: 6d65 6e74 7320 666f 7220 2d2d 726f 6f6d  ments for --room
-00032fe0: 2d72 6564 6163 742e 2041 7267 756d 656e  -redact. Argumen
-00032ff0: 7473 206d 7573 7420 220a 2020 2020 2020  ts must ".      
-00033000: 2020 2020 2020 6622 6265 2074 7269 706c        f"be tripl
-00033010: 6573 2c20 692e 652e 206d 756c 7469 706c  es, i.e. multipl
-00033020: 6573 206f 6620 332c 2062 7574 2066 6f75  es of 3, but fou
-00033030: 6e64 2022 0a20 2020 2020 2020 2020 2020  nd ".           
-00033040: 2066 227b 6c65 6e28 6773 2e70 612e 726f   f"{len(gs.pa.ro
-00033050: 6f6d 5f72 6564 6163 7429 7d20 6172 6775  om_redact)} argu
-00033060: 6d65 6e74 732e 2032 2069 7320 616c 736f  ments. 2 is also
-00033070: 2061 6c6c 6f77 6564 2e22 0a20 2020 2020   allowed.".     
-00033080: 2020 2029 0a20 2020 2020 2020 2067 732e     ).        gs.
-00033090: 6572 725f 636f 756e 7420 2b3d 2031 0a20  err_count += 1. 
-000330a0: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
-000330b0: 2020 666f 7220 6969 2069 6e20 7261 6e67    for ii in rang
-000330c0: 6528 6c65 6e28 6773 2e70 612e 726f 6f6d  e(len(gs.pa.room
-000330d0: 5f72 6564 6163 7429 202f 2f20 3329 3a0a  _redact) // 3):.
-000330e0: 2020 2020 2020 2020 726f 6f6d 5f69 6420          room_id 
-000330f0: 3d20 6773 2e70 612e 726f 6f6d 5f72 6564  = gs.pa.room_red
-00033100: 6163 745b 6969 202a 2033 202b 2030 5d0a  act[ii * 3 + 0].
-00033110: 2020 2020 2020 2020 726f 6f6d 5f69 6420          room_id 
-00033120: 3d20 6177 6169 7420 6d61 705f 726f 6f6d  = await map_room
-00033130: 696e 666f 5f74 6f5f 726f 6f6d 6964 2863  info_to_roomid(c
-00033140: 6c69 656e 742c 2072 6f6f 6d5f 6964 290a  lient, room_id).
-00033150: 2020 2020 2020 2020 6576 656e 745f 6964          event_id
-00033160: 203d 2067 732e 7061 2e72 6f6f 6d5f 7265   = gs.pa.room_re
-00033170: 6461 6374 5b69 6920 2a20 3320 2b20 315d  dact[ii * 3 + 1]
-00033180: 0a20 2020 2020 2020 2072 6561 736f 6e20  .        reason 
-00033190: 3d20 6773 2e70 612e 726f 6f6d 5f72 6564  = gs.pa.room_red
-000331a0: 6163 745b 6969 202a 2033 202b 2032 5d2e  act[ii * 3 + 2].
-000331b0: 7374 7269 7028 290a 2020 2020 2020 2020  strip().        
-000331c0: 6966 2072 6561 736f 6e20 3d3d 2022 223a  if reason == "":
-000331d0: 0a20 2020 2020 2020 2020 2020 2072 6561  .            rea
-000331e0: 736f 6e20 3d20 4e6f 6e65 0a20 2020 2020  son = None.     
-000331f0: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-00033200: 0a20 2020 2020 2020 2020 2020 2066 2250  .            f"P
-00033210: 7265 7061 7269 6e67 2074 6f20 7265 6461  reparing to reda
-00033220: 6374 2065 7665 6e74 207b 6576 656e 745f  ct event {event_
-00033230: 6964 7d20 696e 2072 6f6f 6d20 7b72 6f6f  id} in room {roo
-00033240: 6d5f 6964 7d20 220a 2020 2020 2020 2020  m_id} ".        
-00033250: 2020 2020 6622 7072 6f76 6964 696e 6720      f"providing 
-00033260: 7265 6173 6f6e 2027 7b72 6561 736f 6e7d  reason '{reason}
-00033270: 272e 220a 2020 2020 2020 2020 290a 2020  '.".        ).  
-00033280: 2020 2020 2020 7265 7370 203d 2061 7761        resp = awa
-00033290: 6974 2063 6c69 656e 742e 726f 6f6d 5f72  it client.room_r
-000332a0: 6564 6163 7428 726f 6f6d 5f69 642c 2065  edact(room_id, e
-000332b0: 7665 6e74 5f69 642c 2072 6561 736f 6e3d  vent_id, reason=
-000332c0: 7265 6173 6f6e 290a 2020 2020 2020 2020  reason).        
-000332d0: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
-000332e0: 7370 2c20 526f 6f6d 5265 6461 6374 4572  sp, RoomRedactEr
-000332f0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-00033300: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
-00033310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033320: 2245 3231 333a 2022 0a20 2020 2020 2020  "E213: ".       
-00033330: 2020 2020 2020 2020 2066 2246 6169 6c65           f"Faile
-00033340: 6420 746f 2072 6564 6163 7420 6576 656e  d to redact even
-00033350: 7420 7b65 7665 6e74 5f69 647d 2069 6e20  t {event_id} in 
-00033360: 726f 6f6d 207b 726f 6f6d 5f69 647d 2022  room {room_id} "
-00033370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00033380: 2066 2277 6974 6820 7265 6173 6f6e 2027   f"with reason '
-00033390: 7b72 6561 736f 6e7d 272e 2022 0a20 2020  {reason}'. ".   
-000333a0: 2020 2020 2020 2020 2020 2020 2066 2252               f"R
-000333b0: 6573 706f 6e73 653a 207b 7072 6976 6163  esponse: {privac
-000333c0: 795f 6669 6c74 6572 2873 7472 2872 6573  y_filter(str(res
-000333d0: 7029 297d 220a 2020 2020 2020 2020 2020  p))}".          
-000333e0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-000333f0: 6773 2e65 7272 5f63 6f75 6e74 202b 3d20  gs.err_count += 
-00033400: 310a 2020 2020 2020 2020 656c 7365 3a0a  1.        else:.
-00033410: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
-00033420: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
-00033430: 2020 2020 2020 2020 2020 2272 6f6f 6d5f            "room_
-00033440: 7265 6461 6374 2073 7563 6365 7373 6675  redact successfu
-00033450: 6c2e 2052 6573 706f 6e73 6520 6973 3a20  l. Response is: 
-00033460: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00033470: 2020 6622 7b70 7269 7661 6379 5f66 696c    f"{privacy_fil
-00033480: 7465 7228 7374 7228 7265 7370 2929 7d22  ter(str(resp))}"
-00033490: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-000334a0: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-000334b0: 672e 696e 666f 280a 2020 2020 2020 2020  g.info(.        
-000334c0: 2020 2020 2020 2020 6622 5375 6363 6573          f"Succes
-000334d0: 7366 756c 6c79 2072 6564 6163 7465 6420  sfully redacted 
-000334e0: 6576 656e 7420 7b65 7665 6e74 5f69 647d  event {event_id}
-000334f0: 2069 6e20 726f 6f6d 207b 726f 6f6d 5f69   in room {room_i
-00033500: 647d 2022 0a20 2020 2020 2020 2020 2020  d} ".           
-00033510: 2020 2020 2066 2270 726f 7669 6469 6e67       f"providing
-00033520: 2072 6561 736f 6e20 277b 2727 2069 6620   reason '{'' if 
-00033530: 7265 6173 6f6e 2069 7320 4e6f 6e65 2065  reason is None e
-00033540: 6c73 6520 7265 6173 6f6e 7d27 2e22 0a20  lse reason}'.". 
-00033550: 2020 2020 2020 2020 2020 2029 0a0a 0a61             )...a
-00033560: 7379 6e63 2064 6566 2061 6374 696f 6e5f  sync def action_
-00033570: 7768 6f61 6d69 2863 6c69 656e 743a 2041  whoami(client: A
-00033580: 7379 6e63 436c 6965 6e74 2c20 6372 6564  syncClient, cred
-00033590: 656e 7469 616c 733a 2064 6963 7429 202d  entials: dict) -
-000335a0: 3e20 4e6f 6e65 3a0a 2020 2020 2222 2247  > None:.    """G
-000335b0: 6574 2075 7365 7220 6964 2077 6869 6c65  et user id while
-000335c0: 2061 6c72 6561 6479 206c 6f67 6765 6420   already logged 
-000335d0: 696e 2e22 2222 0a20 2020 2077 686f 616d  in.""".    whoam
-000335e0: 6920 3d20 6372 6564 656e 7469 616c 735b  i = credentials[
-000335f0: 2275 7365 725f 6964 225d 0a20 2020 2067  "user_id"].    g
-00033600: 732e 6c6f 672e 6465 6275 6728 6622 7768  s.log.debug(f"wh
-00033610: 6f61 6d69 3a20 7573 6572 2069 643a 207b  oami: user id: {
-00033620: 7768 6f61 6d69 7d22 290a 2020 2020 2320  whoami}").    # 
-00033630: 6f75 7470 7574 2066 6f72 6d61 7420 636f  output format co
-00033640: 6e74 726f 6c6c 6564 2076 6961 202d 2d6f  ntrolled via --o
-00033650: 7574 7075 7420 666c 6167 0a20 2020 2074  utput flag.    t
-00033660: 6578 7420 3d20 7768 6f61 6d69 0a20 2020  ext = whoami.   
-00033670: 206a 736f 6e5f 6d61 7820 3d20 7b22 7573   json_max = {"us
-00033680: 6572 5f69 6422 3a20 7768 6f61 6d69 7d0a  er_id": whoami}.
-00033690: 2020 2020 2320 6a73 6f6e 5f6d 6178 2e75      # json_max.u
-000336a0: 7064 6174 6528 7b22 6b65 7922 3a20 7661  pdate({"key": va
-000336b0: 6c75 657d 2920 2023 2061 6464 2064 6963  lue})  # add dic
-000336c0: 7420 6974 656d 730a 2020 2020 6a73 6f6e  t items.    json
-000336d0: 5f20 3d20 6a73 6f6e 5f6d 6178 2e63 6f70  _ = json_max.cop
-000336e0: 7928 290a 2020 2020 2320 6a73 6f6e 5f2e  y().    # json_.
-000336f0: 706f 7028 226b 6579 2229 0a20 2020 206a  pop("key").    j
-00033700: 736f 6e5f 7370 6563 203d 204e 6f6e 650a  son_spec = None.
-00033710: 2020 2020 7072 696e 745f 6f75 7470 7574      print_output
-00033720: 280a 2020 2020 2020 2020 6773 2e70 612e  (.        gs.pa.
-00033730: 6f75 7470 7574 2c0a 2020 2020 2020 2020  output,.        
-00033740: 7465 7874 3d74 6578 742c 0a20 2020 2020  text=text,.     
-00033750: 2020 206a 736f 6e5f 3d6a 736f 6e5f 2c0a     json_=json_,.
-00033760: 2020 2020 2020 2020 6a73 6f6e 5f6d 6178          json_max
-00033770: 3d6a 736f 6e5f 6d61 782c 0a20 2020 2020  =json_max,.     
-00033780: 2020 206a 736f 6e5f 7370 6563 3d6a 736f     json_spec=jso
-00033790: 6e5f 7370 6563 2c0a 2020 2020 290a 0a0a  n_spec,.    )...
-000337a0: 6173 796e 6320 6465 6620 6163 7469 6f6e  async def action
-000337b0: 5f72 6f6f 6d73 6574 6765 7428 2920 2d3e  _roomsetget() ->
-000337c0: 204e 6f6e 653a 0a20 2020 2022 2222 5065   None:.    """Pe
-000337d0: 7266 6f72 6d20 726f 6f6d 2c20 6765 742c  rform room, get,
-000337e0: 2073 6574 2061 6374 696f 6e73 2077 6869   set actions whi
-000337f0: 6c65 2062 6569 6e67 206c 6f67 6765 6420  le being logged 
-00033800: 696e 2e22 2222 0a20 2020 2069 6620 6e6f  in.""".    if no
-00033810: 7420 6773 2e63 6c69 656e 7420 616e 6420  t gs.client and 
-00033820: 6e6f 7420 6773 2e63 7265 6465 6e74 6961  not gs.credentia
-00033830: 6c73 3a0a 2020 2020 2020 2020 6773 2e6c  ls:.        gs.l
-00033840: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
-00033850: 2020 2020 2020 2245 3231 343a 2022 2022        "E214: " "
-00033860: 436c 6965 6e74 206f 7220 6372 6564 656e  Client or creden
-00033870: 7469 616c 7320 6e6f 7420 7365 742e 2053  tials not set. S
-00033880: 6b69 7070 696e 6720 6163 7469 6f6e 2e22  kipping action."
-00033890: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-000338a0: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
-000338b0: 2b3d 2031 0a20 2020 2020 2020 2072 6574  += 1.        ret
-000338c0: 7572 6e0a 2020 2020 7472 793a 0a20 2020  urn.    try:.   
-000338d0: 2020 2020 2023 2072 6f6f 6d5f 6163 7469       # room_acti
-000338e0: 6f6e 0a20 2020 2020 2020 2023 2077 6520  on.        # we 
-000338f0: 616c 7265 6164 7920 6368 6563 6b65 6420  already checked 
-00033900: 6172 6773 2061 7420 7468 6520 6265 6769  args at the begi
-00033910: 6e6e 696e 672c 206e 6f20 6e65 6564 2074  nning, no need t
-00033920: 6f20 6368 6563 6b0a 2020 2020 2020 2020  o check.        
-00033930: 2320 726f 6f6d 2061 6e64 2075 7365 7220  # room and user 
-00033940: 6172 6775 6d65 6e74 2063 6f6d 6269 6e61  argument combina
-00033950: 7469 6f6e 7320 6167 6169 6e2e 0a20 2020  tions again..   
-00033960: 2020 2020 2023 2072 6f6f 6d20 7365 7420       # room set 
-00033970: 6163 7469 6f6e 730a 2020 2020 2020 2020  actions.        
-00033980: 6966 2067 732e 7061 2e72 6f6f 6d5f 6372  if gs.pa.room_cr
-00033990: 6561 7465 3a0a 2020 2020 2020 2020 2020  eate:.          
-000339a0: 2020 6177 6169 7420 6163 7469 6f6e 5f72    await action_r
-000339b0: 6f6f 6d5f 6372 6561 7465 2867 732e 636c  oom_create(gs.cl
-000339c0: 6965 6e74 2c20 6773 2e63 7265 6465 6e74  ient, gs.credent
-000339d0: 6961 6c73 290a 2020 2020 2020 2020 6966  ials).        if
-000339e0: 2067 732e 7061 2e72 6f6f 6d5f 646d 5f63   gs.pa.room_dm_c
-000339f0: 7265 6174 653a 0a20 2020 2020 2020 2020  reate:.         
-00033a00: 2020 2061 7761 6974 2061 6374 696f 6e5f     await action_
-00033a10: 726f 6f6d 5f64 6d5f 6372 6561 7465 2867  room_dm_create(g
-00033a20: 732e 636c 6965 6e74 2c20 6773 2e63 7265  s.client, gs.cre
-00033a30: 6465 6e74 6961 6c73 290a 2020 2020 2020  dentials).      
-00033a40: 2020 6966 2067 732e 7061 2e72 6f6f 6d5f    if gs.pa.room_
-00033a50: 6a6f 696e 3a0a 2020 2020 2020 2020 2020  join:.          
-00033a60: 2020 6177 6169 7420 6163 7469 6f6e 5f72    await action_r
-00033a70: 6f6f 6d5f 6a6f 696e 2867 732e 636c 6965  oom_join(gs.clie
-00033a80: 6e74 2c20 6773 2e63 7265 6465 6e74 6961  nt, gs.credentia
-00033a90: 6c73 290a 2020 2020 2020 2020 6966 2067  ls).        if g
-00033aa0: 732e 7061 2e72 6f6f 6d5f 6c65 6176 653a  s.pa.room_leave:
-00033ab0: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-00033ac0: 6974 2061 6374 696f 6e5f 726f 6f6d 5f6c  it action_room_l
-00033ad0: 6561 7665 2867 732e 636c 6965 6e74 2c20  eave(gs.client, 
-00033ae0: 6773 2e63 7265 6465 6e74 6961 6c73 290a  gs.credentials).
-00033af0: 2020 2020 2020 2020 6966 2067 732e 7061          if gs.pa
-00033b00: 2e72 6f6f 6d5f 666f 7267 6574 3a0a 2020  .room_forget:.  
-00033b10: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-00033b20: 6163 7469 6f6e 5f72 6f6f 6d5f 666f 7267  action_room_forg
-00033b30: 6574 2867 732e 636c 6965 6e74 2c20 6773  et(gs.client, gs
-00033b40: 2e63 7265 6465 6e74 6961 6c73 290a 2020  .credentials).  
-00033b50: 2020 2020 2020 6966 2067 732e 7061 2e72        if gs.pa.r
-00033b60: 6f6f 6d5f 696e 7669 7465 2061 6e64 2067  oom_invite and g
-00033b70: 732e 7061 2e75 7365 723a 0a20 2020 2020  s.pa.user:.     
-00033b80: 2020 2020 2020 2061 7761 6974 2061 6374         await act
-00033b90: 696f 6e5f 726f 6f6d 5f69 6e76 6974 6528  ion_room_invite(
-00033ba0: 6773 2e63 6c69 656e 742c 2067 732e 6372  gs.client, gs.cr
-00033bb0: 6564 656e 7469 616c 7329 0a20 2020 2020  edentials).     
-00033bc0: 2020 2069 6620 6773 2e70 612e 726f 6f6d     if gs.pa.room
-00033bd0: 5f62 616e 2061 6e64 2067 732e 7061 2e75  _ban and gs.pa.u
-00033be0: 7365 723a 0a20 2020 2020 2020 2020 2020  ser:.           
-00033bf0: 2061 7761 6974 2061 6374 696f 6e5f 726f   await action_ro
-00033c00: 6f6d 5f62 616e 2867 732e 636c 6965 6e74  om_ban(gs.client
-00033c10: 2c20 6773 2e63 7265 6465 6e74 6961 6c73  , gs.credentials
-00033c20: 290a 2020 2020 2020 2020 6966 2067 732e  ).        if gs.
-00033c30: 7061 2e72 6f6f 6d5f 756e 6261 6e20 616e  pa.room_unban an
-00033c40: 6420 6773 2e70 612e 7573 6572 3a0a 2020  d gs.pa.user:.  
-00033c50: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-00033c60: 6163 7469 6f6e 5f72 6f6f 6d5f 756e 6261  action_room_unba
-00033c70: 6e28 6773 2e63 6c69 656e 742c 2067 732e  n(gs.client, gs.
-00033c80: 6372 6564 656e 7469 616c 7329 0a20 2020  credentials).   
-00033c90: 2020 2020 2069 6620 6773 2e70 612e 726f       if gs.pa.ro
-00033ca0: 6f6d 5f6b 6963 6b20 616e 6420 6773 2e70  om_kick and gs.p
-00033cb0: 612e 7573 6572 3a0a 2020 2020 2020 2020  a.user:.        
-00033cc0: 2020 2020 6177 6169 7420 6163 7469 6f6e      await action
-00033cd0: 5f72 6f6f 6d5f 6b69 636b 2867 732e 636c  _room_kick(gs.cl
-00033ce0: 6965 6e74 2c20 6773 2e63 7265 6465 6e74  ient, gs.credent
-00033cf0: 6961 6c73 290a 2020 2020 2020 2020 6966  ials).        if
-00033d00: 2067 732e 7061 2e72 6f6f 6d5f 7265 6461   gs.pa.room_reda
-00033d10: 6374 3a0a 2020 2020 2020 2020 2020 2020  ct:.            
-00033d20: 6177 6169 7420 6163 7469 6f6e 5f72 6f6f  await action_roo
-00033d30: 6d5f 7265 6461 6374 2867 732e 636c 6965  m_redact(gs.clie
-00033d40: 6e74 2c20 6773 2e63 7265 6465 6e74 6961  nt, gs.credentia
-00033d50: 6c73 290a 2020 2020 2020 2020 6966 2067  ls).        if g
-00033d60: 732e 7061 2e72 6f6f 6d5f 7365 745f 616c  s.pa.room_set_al
-00033d70: 6961 733a 0a20 2020 2020 2020 2020 2020  ias:.           
-00033d80: 2061 7761 6974 2061 6374 696f 6e5f 726f   await action_ro
-00033d90: 6f6d 5f73 6574 5f61 6c69 6173 2867 732e  om_set_alias(gs.
-00033da0: 636c 6965 6e74 2c20 6773 2e63 7265 6465  client, gs.crede
-00033db0: 6e74 6961 6c73 290a 2020 2020 2020 2020  ntials).        
-00033dc0: 6966 2067 732e 7061 2e72 6f6f 6d5f 6465  if gs.pa.room_de
-00033dd0: 6c65 7465 5f61 6c69 6173 3a0a 2020 2020  lete_alias:.    
-00033de0: 2020 2020 2020 2020 6177 6169 7420 6163          await ac
-00033df0: 7469 6f6e 5f72 6f6f 6d5f 6465 6c65 7465  tion_room_delete
-00033e00: 5f61 6c69 6173 2867 732e 636c 6965 6e74  _alias(gs.client
-00033e10: 2c20 6773 2e63 7265 6465 6e74 6961 6c73  , gs.credentials
-00033e20: 290a 2020 2020 2020 2020 2320 726f 6f6d  ).        # room
-00033e30: 2067 6574 2061 6374 696f 6e73 0a20 2020   get actions.   
-00033e40: 2020 2020 2069 6620 6773 2e70 612e 726f       if gs.pa.ro
-00033e50: 6f6d 5f67 6574 5f76 6973 6962 696c 6974  om_get_visibilit
-00033e60: 7920 6973 206e 6f74 204e 6f6e 653a 2020  y is not None:  
-00033e70: 2320 656d 7074 7920 5b5d 206d 7573 7420  # empty [] must 
-00033e80: 696e 766f 6b65 2066 756e 630a 2020 2020  invoke func.    
-00033e90: 2020 2020 2020 2020 6177 6169 7420 6163          await ac
-00033ea0: 7469 6f6e 5f72 6f6f 6d5f 6765 745f 7669  tion_room_get_vi
-00033eb0: 7369 6269 6c69 7479 2867 732e 636c 6965  sibility(gs.clie
-00033ec0: 6e74 2c20 6773 2e63 7265 6465 6e74 6961  nt, gs.credentia
-00033ed0: 6c73 290a 2020 2020 2020 2020 6966 2067  ls).        if g
-00033ee0: 732e 7061 2e72 6f6f 6d5f 6765 745f 7374  s.pa.room_get_st
-00033ef0: 6174 6520 6973 206e 6f74 204e 6f6e 653a  ate is not None:
-00033f00: 2020 2320 656d 7074 7920 6c69 7374 206d    # empty list m
-00033f10: 7573 7420 696e 766f 6b65 2066 756e 630a  ust invoke func.
-00033f20: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00033f30: 7420 6163 7469 6f6e 5f72 6f6f 6d5f 6765  t action_room_ge
-00033f40: 745f 7374 6174 6528 6773 2e63 6c69 656e  t_state(gs.clien
-00033f50: 742c 2067 732e 6372 6564 656e 7469 616c  t, gs.credential
-00033f60: 7329 0a20 2020 2020 2020 2069 6620 6773  s).        if gs
-00033f70: 2e70 612e 726f 6f6d 5f72 6573 6f6c 7665  .pa.room_resolve
-00033f80: 5f61 6c69 6173 3a0a 2020 2020 2020 2020  _alias:.        
-00033f90: 2020 2020 6177 6169 7420 6163 7469 6f6e      await action
-00033fa0: 5f72 6f6f 6d5f 7265 736f 6c76 655f 616c  _room_resolve_al
-00033fb0: 6961 7328 6773 2e63 6c69 656e 742c 2067  ias(gs.client, g
-00033fc0: 732e 6372 6564 656e 7469 616c 7329 0a20  s.credentials). 
-00033fd0: 2020 2020 2020 2069 6620 6773 2e72 6f6f         if gs.roo
-00033fe0: 6d5f 6163 7469 6f6e 3a0a 2020 2020 2020  m_action:.      
-00033ff0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-00034000: 7567 2822 526f 6f6d 2061 6374 696f 6e28  ug("Room action(
-00034010: 7329 2077 6572 6520 7065 7266 6f72 6d65  s) were performe
-00034020: 6420 6f72 2061 7474 656d 7074 6564 2e22  d or attempted."
-00034030: 290a 0a20 2020 2020 2020 2023 2073 6574  )..        # set
-00034040: 5f61 6374 696f 6e0a 2020 2020 2020 2020  _action.        
-00034050: 6966 2067 732e 7061 2e73 6574 5f64 6973  if gs.pa.set_dis
-00034060: 706c 6179 5f6e 616d 653a 0a20 2020 2020  play_name:.     
-00034070: 2020 2020 2020 2061 7761 6974 2061 6374         await act
-00034080: 696f 6e5f 7365 745f 6469 7370 6c61 795f  ion_set_display_
-00034090: 6e61 6d65 2867 732e 636c 6965 6e74 2c20  name(gs.client, 
-000340a0: 6773 2e63 7265 6465 6e74 6961 6c73 290a  gs.credentials).
-000340b0: 2020 2020 2020 2020 6966 2067 732e 7061          if gs.pa
-000340c0: 2e73 6574 5f64 6576 6963 655f 6e61 6d65  .set_device_name
-000340d0: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
-000340e0: 6169 7420 6163 7469 6f6e 5f73 6574 5f64  ait action_set_d
-000340f0: 6576 6963 655f 6e61 6d65 2867 732e 636c  evice_name(gs.cl
-00034100: 6965 6e74 2c20 6773 2e63 7265 6465 6e74  ient, gs.credent
-00034110: 6961 6c73 290a 2020 2020 2020 2020 6966  ials).        if
-00034120: 2067 732e 7061 2e73 6574 5f70 7265 7365   gs.pa.set_prese
-00034130: 6e63 653a 0a20 2020 2020 2020 2020 2020  nce:.           
-00034140: 2061 7761 6974 2061 6374 696f 6e5f 7365   await action_se
-00034150: 745f 7072 6573 656e 6365 2867 732e 636c  t_presence(gs.cl
-00034160: 6965 6e74 2c20 6773 2e63 7265 6465 6e74  ient, gs.credent
-00034170: 6961 6c73 290a 2020 2020 2020 2020 6966  ials).        if
-00034180: 2067 732e 7061 2e75 706c 6f61 643a 0a20   gs.pa.upload:. 
-00034190: 2020 2020 2020 2020 2020 2061 7761 6974             await
-000341a0: 2061 6374 696f 6e5f 7570 6c6f 6164 2867   action_upload(g
-000341b0: 732e 636c 6965 6e74 2c20 6773 2e63 7265  s.client, gs.cre
-000341c0: 6465 6e74 6961 6c73 290a 2020 2020 2020  dentials).      
-000341d0: 2020 6966 2067 732e 7061 2e64 656c 6574    if gs.pa.delet
-000341e0: 655f 6d78 633a 0a20 2020 2020 2020 2020  e_mxc:.         
-000341f0: 2020 2061 7761 6974 2061 6374 696f 6e5f     await action_
-00034200: 6465 6c65 7465 5f6d 7863 2867 732e 636c  delete_mxc(gs.cl
-00034210: 6965 6e74 2c20 6773 2e63 7265 6465 6e74  ient, gs.credent
-00034220: 6961 6c73 290a 2020 2020 2020 2020 6966  ials).        if
-00034230: 2067 732e 7061 2e64 656c 6574 655f 6d78   gs.pa.delete_mx
-00034240: 635f 6265 666f 7265 3a0a 2020 2020 2020  c_before:.      
-00034250: 2020 2020 2020 6177 6169 7420 6163 7469        await acti
-00034260: 6f6e 5f64 656c 6574 655f 6d78 635f 6265  on_delete_mxc_be
-00034270: 666f 7265 2867 732e 636c 6965 6e74 2c20  fore(gs.client, 
-00034280: 6773 2e63 7265 6465 6e74 6961 6c73 290a  gs.credentials).
-00034290: 2020 2020 2020 2020 6966 2067 732e 7061          if gs.pa
-000342a0: 2e72 6573 743a 0a20 2020 2020 2020 2020  .rest:.         
-000342b0: 2020 2061 7761 6974 2061 6374 696f 6e5f     await action_
-000342c0: 7265 7374 2867 732e 636c 6965 6e74 2c20  rest(gs.client, 
-000342d0: 6773 2e63 7265 6465 6e74 6961 6c73 290a  gs.credentials).
-000342e0: 2020 2020 2020 2020 6966 2067 732e 7061          if gs.pa
-000342f0: 2e73 6574 5f61 7661 7461 723a 0a20 2020  .set_avatar:.   
-00034300: 2020 2020 2020 2020 2061 7761 6974 2061           await a
-00034310: 6374 696f 6e5f 7365 745f 6176 6174 6172  ction_set_avatar
-00034320: 2867 732e 636c 6965 6e74 2c20 6773 2e63  (gs.client, gs.c
-00034330: 7265 6465 6e74 6961 6c73 290a 2020 2020  redentials).    
-00034340: 2020 2020 6966 2067 732e 7061 2e69 6d70      if gs.pa.imp
-00034350: 6f72 745f 6b65 7973 3a0a 2020 2020 2020  ort_keys:.      
-00034360: 2020 2020 2020 6177 6169 7420 6163 7469        await acti
-00034370: 6f6e 5f69 6d70 6f72 745f 6b65 7973 2867  on_import_keys(g
-00034380: 732e 636c 6965 6e74 2c20 6773 2e63 7265  s.client, gs.cre
-00034390: 6465 6e74 6961 6c73 290a 2020 2020 2020  dentials).      
-000343a0: 2020 6966 2067 732e 7061 2e64 656c 6574    if gs.pa.delet
-000343b0: 655f 6465 7669 6365 3a0a 2020 2020 2020  e_device:.      
-000343c0: 2020 2020 2020 6177 6169 7420 6163 7469        await acti
-000343d0: 6f6e 5f64 656c 6574 655f 6465 7669 6365  on_delete_device
-000343e0: 2867 732e 636c 6965 6e74 2c20 6773 2e63  (gs.client, gs.c
-000343f0: 7265 6465 6e74 6961 6c73 290a 0a20 2020  redentials)..   
-00034400: 2020 2020 2023 2067 6574 5f61 6374 696f       # get_actio
-00034410: 6e0a 2020 2020 2020 2020 6966 2067 732e  n.        if gs.
-00034420: 7061 2e67 6574 5f64 6973 706c 6179 5f6e  pa.get_display_n
-00034430: 616d 653a 0a20 2020 2020 2020 2020 2020  ame:.           
-00034440: 2061 7761 6974 2061 6374 696f 6e5f 6765   await action_ge
-00034450: 745f 6469 7370 6c61 795f 6e61 6d65 2867  t_display_name(g
-00034460: 732e 636c 6965 6e74 2c20 6773 2e63 7265  s.client, gs.cre
-00034470: 6465 6e74 6961 6c73 290a 2020 2020 2020  dentials).      
-00034480: 2020 6966 2067 732e 7061 2e67 6574 5f70    if gs.pa.get_p
-00034490: 7265 7365 6e63 653a 0a20 2020 2020 2020  resence:.       
-000344a0: 2020 2020 2061 7761 6974 2061 6374 696f       await actio
-000344b0: 6e5f 6765 745f 7072 6573 656e 6365 2867  n_get_presence(g
-000344c0: 732e 636c 6965 6e74 2c20 6773 2e63 7265  s.client, gs.cre
-000344d0: 6465 6e74 6961 6c73 290a 2020 2020 2020  dentials).      
-000344e0: 2020 6966 2067 732e 7061 2e64 6f77 6e6c    if gs.pa.downl
-000344f0: 6f61 643a 0a20 2020 2020 2020 2020 2020  oad:.           
-00034500: 2061 7761 6974 2061 6374 696f 6e5f 646f   await action_do
-00034510: 776e 6c6f 6164 2867 732e 636c 6965 6e74  wnload(gs.client
-00034520: 2c20 6773 2e63 7265 6465 6e74 6961 6c73  , gs.credentials
-00034530: 290a 2020 2020 2020 2020 6966 2067 732e  ).        if gs.
-00034540: 7061 2e6a 6f69 6e65 645f 726f 6f6d 733a  pa.joined_rooms:
-00034550: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-00034560: 6974 2061 6374 696f 6e5f 6a6f 696e 6564  it action_joined
-00034570: 5f72 6f6f 6d73 2867 732e 636c 6965 6e74  _rooms(gs.client
-00034580: 2c20 6773 2e63 7265 6465 6e74 6961 6c73  , gs.credentials
-00034590: 290a 2020 2020 2020 2020 6966 2067 732e  ).        if gs.
-000345a0: 7061 2e6a 6f69 6e65 645f 6d65 6d62 6572  pa.joined_member
-000345b0: 733a 0a20 2020 2020 2020 2020 2020 2061  s:.            a
-000345c0: 7761 6974 2061 6374 696f 6e5f 6a6f 696e  wait action_join
-000345d0: 6564 5f6d 656d 6265 7273 2867 732e 636c  ed_members(gs.cl
-000345e0: 6965 6e74 2c20 6773 2e63 7265 6465 6e74  ient, gs.credent
-000345f0: 6961 6c73 290a 2020 2020 2020 2020 6966  ials).        if
-00034600: 2067 732e 7061 2e6d 7863 5f74 6f5f 6874   gs.pa.mxc_to_ht
-00034610: 7470 3a0a 2020 2020 2020 2020 2020 2020  tp:.            
-00034620: 6177 6169 7420 6163 7469 6f6e 5f6d 7863  await action_mxc
-00034630: 5f74 6f5f 6874 7470 2867 732e 636c 6965  _to_http(gs.clie
-00034640: 6e74 2c20 6773 2e63 7265 6465 6e74 6961  nt, gs.credentia
-00034650: 6c73 290a 2020 2020 2020 2020 6966 2067  ls).        if g
-00034660: 732e 7061 2e64 6576 6963 6573 3a0a 2020  s.pa.devices:.  
-00034670: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-00034680: 6163 7469 6f6e 5f64 6576 6963 6573 2867  action_devices(g
-00034690: 732e 636c 6965 6e74 2c20 6773 2e63 7265  s.client, gs.cre
-000346a0: 6465 6e74 6961 6c73 290a 2020 2020 2020  dentials).      
-000346b0: 2020 6966 2067 732e 7061 2e64 6973 636f    if gs.pa.disco
-000346c0: 7665 7279 5f69 6e66 6f3a 0a20 2020 2020  very_info:.     
-000346d0: 2020 2020 2020 2061 7761 6974 2061 6374         await act
-000346e0: 696f 6e5f 6469 7363 6f76 6572 795f 696e  ion_discovery_in
-000346f0: 666f 2867 732e 636c 6965 6e74 2c20 6773  fo(gs.client, gs
-00034700: 2e63 7265 6465 6e74 6961 6c73 290a 2020  .credentials).  
-00034710: 2020 2020 2020 6966 2067 732e 7061 2e6c        if gs.pa.l
-00034720: 6f67 696e 5f69 6e66 6f3a 0a20 2020 2020  ogin_info:.     
-00034730: 2020 2020 2020 2061 7761 6974 2061 6374         await act
-00034740: 696f 6e5f 6c6f 6769 6e5f 696e 666f 2867  ion_login_info(g
-00034750: 732e 636c 6965 6e74 2c20 6773 2e63 7265  s.client, gs.cre
-00034760: 6465 6e74 6961 6c73 290a 2020 2020 2020  dentials).      
-00034770: 2020 6966 2067 732e 7061 2e63 6f6e 7465    if gs.pa.conte
-00034780: 6e74 5f72 6570 6f73 6974 6f72 795f 636f  nt_repository_co
-00034790: 6e66 6967 3a0a 2020 2020 2020 2020 2020  nfig:.          
-000347a0: 2020 6177 6169 7420 6163 7469 6f6e 5f63    await action_c
-000347b0: 6f6e 7465 6e74 5f72 6570 6f73 6974 6f72  ontent_repositor
-000347c0: 795f 636f 6e66 6967 2867 732e 636c 6965  y_config(gs.clie
-000347d0: 6e74 2c20 6773 2e63 7265 6465 6e74 6961  nt, gs.credentia
-000347e0: 6c73 290a 2020 2020 2020 2020 6966 2067  ls).        if g
-000347f0: 732e 7061 2e67 6574 5f61 7661 7461 7220  s.pa.get_avatar 
-00034800: 6973 206e 6f74 204e 6f6e 653a 2020 2320  is not None:  # 
-00034810: 656d 7074 7920 6c69 7374 206d 7573 7420  empty list must 
-00034820: 696e 766f 6b65 2066 756e 6374 696f 6e0a  invoke function.
-00034830: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00034840: 7420 6163 7469 6f6e 5f67 6574 5f61 7661  t action_get_ava
-00034850: 7461 7228 6773 2e63 6c69 656e 742c 2067  tar(gs.client, g
-00034860: 732e 6372 6564 656e 7469 616c 7329 0a20  s.credentials). 
-00034870: 2020 2020 2020 2069 6620 6773 2e70 612e         if gs.pa.
-00034880: 6765 745f 7072 6f66 696c 6520 6973 206e  get_profile is n
-00034890: 6f74 204e 6f6e 653a 2020 2320 656d 7074  ot None:  # empt
-000348a0: 7920 6c69 7374 206d 7573 7420 696e 766f  y list must invo
-000348b0: 6b65 2066 756e 6374 696f 6e0a 2020 2020  ke function.    
-000348c0: 2020 2020 2020 2020 6177 6169 7420 6163          await ac
-000348d0: 7469 6f6e 5f67 6574 5f70 726f 6669 6c65  tion_get_profile
-000348e0: 2867 732e 636c 6965 6e74 2c20 6773 2e63  (gs.client, gs.c
-000348f0: 7265 6465 6e74 6961 6c73 290a 2020 2020  redentials).    
-00034900: 2020 2020 6966 2067 732e 7061 2e67 6574      if gs.pa.get
-00034910: 5f72 6f6f 6d5f 696e 666f 2069 7320 6e6f  _room_info is no
-00034920: 7420 4e6f 6e65 3a20 2023 2065 6d70 7479  t None:  # empty
-00034930: 206c 6973 7420 6d75 7374 2069 6e76 6f6b   list must invok
-00034940: 6520 6675 6e63 7469 6f6e 0a20 2020 2020  e function.     
-00034950: 2020 2020 2020 2061 7761 6974 2061 6374         await act
-00034960: 696f 6e5f 6765 745f 726f 6f6d 5f69 6e66  ion_get_room_inf
-00034970: 6f28 6773 2e63 6c69 656e 742c 2067 732e  o(gs.client, gs.
-00034980: 6372 6564 656e 7469 616c 7329 0a20 2020  credentials).   
-00034990: 2020 2020 2069 6620 6773 2e70 612e 6765       if gs.pa.ge
-000349a0: 745f 636c 6965 6e74 5f69 6e66 6f3a 0a20  t_client_info:. 
-000349b0: 2020 2020 2020 2020 2020 2061 7761 6974             await
-000349c0: 2061 6374 696f 6e5f 6765 745f 636c 6965   action_get_clie
-000349d0: 6e74 5f69 6e66 6f28 6773 2e63 6c69 656e  nt_info(gs.clien
-000349e0: 742c 2067 732e 6372 6564 656e 7469 616c  t, gs.credential
-000349f0: 7329 0a20 2020 2020 2020 2069 6620 6773  s).        if gs
-00034a00: 2e70 612e 6861 735f 7065 726d 6973 7369  .pa.has_permissi
-00034a10: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
-00034a20: 6177 6169 7420 6163 7469 6f6e 5f68 6173  await action_has
-00034a30: 5f70 6572 6d69 7373 696f 6e28 6773 2e63  _permission(gs.c
-00034a40: 6c69 656e 742c 2067 732e 6372 6564 656e  lient, gs.creden
-00034a50: 7469 616c 7329 0a20 2020 2020 2020 2069  tials).        i
-00034a60: 6620 6773 2e70 612e 6578 706f 7274 5f6b  f gs.pa.export_k
-00034a70: 6579 733a 0a20 2020 2020 2020 2020 2020  eys:.           
-00034a80: 2061 7761 6974 2061 6374 696f 6e5f 6578   await action_ex
-00034a90: 706f 7274 5f6b 6579 7328 6773 2e63 6c69  port_keys(gs.cli
-00034aa0: 656e 742c 2067 732e 6372 6564 656e 7469  ent, gs.credenti
-00034ab0: 616c 7329 0a20 2020 2020 2020 2069 6620  als).        if 
-00034ac0: 6773 2e70 612e 6765 745f 6f70 656e 6964  gs.pa.get_openid
-00034ad0: 5f74 6f6b 656e 2069 7320 6e6f 7420 4e6f  _token is not No
-00034ae0: 6e65 3a20 2023 2065 6d70 7479 206c 6973  ne:  # empty lis
-00034af0: 7420 6d75 7374 2069 6e76 6f6b 6520 6675  t must invoke fu
-00034b00: 6e63 0a20 2020 2020 2020 2020 2020 2061  nc.            a
-00034b10: 7761 6974 2061 6374 696f 6e5f 6765 745f  wait action_get_
-00034b20: 6f70 656e 6964 5f74 6f6b 656e 2867 732e  openid_token(gs.
-00034b30: 636c 6965 6e74 2c20 6773 2e63 7265 6465  client, gs.crede
-00034b40: 6e74 6961 6c73 290a 2020 2020 2020 2020  ntials).        
-00034b50: 6966 2067 732e 7061 2e77 686f 616d 693a  if gs.pa.whoami:
-00034b60: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-00034b70: 6974 2061 6374 696f 6e5f 7768 6f61 6d69  it action_whoami
-00034b80: 2867 732e 636c 6965 6e74 2c20 6773 2e63  (gs.client, gs.c
-00034b90: 7265 6465 6e74 6961 6c73 290a 2020 2020  redentials).    
-00034ba0: 2020 2020 6966 2067 732e 7365 7467 6574      if gs.setget
-00034bb0: 5f61 6374 696f 6e3a 0a20 2020 2020 2020  _action:.       
-00034bc0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-00034bd0: 6728 2253 6574 206f 7220 6765 7420 6163  g("Set or get ac
-00034be0: 7469 6f6e 2873 2920 7765 7265 2070 6572  tion(s) were per
-00034bf0: 666f 726d 6564 206f 7220 6174 7465 6d70  formed or attemp
-00034c00: 7465 642e 2229 0a20 2020 2065 7863 6570  ted.").    excep
-00034c10: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
-00034c20: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
-00034c30: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
-00034c40: 2020 2020 2245 3231 353a 2022 0a20 2020      "E215: ".   
-00034c50: 2020 2020 2020 2020 2022 4572 726f 7220           "Error 
-00034c60: 6475 7269 6e67 2072 6f6f 6d2c 2073 6574  during room, set
-00034c70: 2c20 6765 7420 6163 7469 6f6e 732e 2043  , get actions. C
-00034c80: 6f6e 7469 6e75 696e 6720 6465 7370 6974  ontinuing despit
-00034c90: 6520 6572 726f 722e 2022 0a20 2020 2020  e error. ".     
-00034ca0: 2020 2020 2020 2066 2245 7863 6570 7469         f"Excepti
-00034cb0: 6f6e 3a20 7b65 7d22 0a20 2020 2020 2020  on: {e}".       
-00034cc0: 2029 0a20 2020 2020 2020 2067 732e 6c6f   ).        gs.lo
-00034cd0: 672e 6465 6275 6728 2248 6572 6520 6973  g.debug("Here is
-00034ce0: 2074 6865 2074 7261 6365 6261 636b 2e5c   the traceback.\
-00034cf0: 6e22 202b 2074 7261 6365 6261 636b 2e66  n" + traceback.f
-00034d00: 6f72 6d61 745f 6578 6328 2929 0a20 2020  ormat_exc()).   
-00034d10: 2020 2020 2067 732e 6572 725f 636f 756e       gs.err_coun
-00034d20: 7420 2b3d 2031 0a0a 0a61 7379 6e63 2064  t += 1...async d
-00034d30: 6566 2061 6374 696f 6e5f 7665 7269 6679  ef action_verify
-00034d40: 2829 202d 3e20 4e6f 6e65 3a0a 2020 2020  () -> None:.    
-00034d50: 2222 2256 6572 6966 7920 7768 696c 6520  """Verify while 
-00034d60: 616c 7265 6164 7920 6c6f 6767 6564 2069  already logged i
-00034d70: 6e2e 2222 220a 2020 2020 6966 206e 6f74  n.""".    if not
-00034d80: 2067 732e 636c 6965 6e74 2061 6e64 206e   gs.client and n
-00034d90: 6f74 2067 732e 6372 6564 656e 7469 616c  ot gs.credential
-00034da0: 733a 0a20 2020 2020 2020 2067 732e 6c6f  s:.        gs.lo
-00034db0: 672e 6572 726f 7228 0a20 2020 2020 2020  g.error(.       
-00034dc0: 2020 2020 2022 4532 3136 3a20 2220 2243       "E216: " "C
-00034dd0: 6c69 656e 7420 6f72 2063 7265 6465 6e74  lient or credent
-00034de0: 6961 6c73 206e 6f74 2073 6574 2e20 536b  ials not set. Sk
-00034df0: 6970 7069 6e67 2061 6374 696f 6e2e 220a  ipping action.".
-00034e00: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00034e10: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
-00034e20: 3d20 310a 2020 2020 2020 2020 7265 7475  = 1.        retu
-00034e30: 726e 0a20 2020 2074 7279 3a0a 2020 2020  rn.    try:.    
-00034e40: 2020 2020 2320 5365 7420 7570 2065 7665      # Set up eve
-00034e50: 6e74 2063 616c 6c62 6163 6b73 0a20 2020  nt callbacks.   
-00034e60: 2020 2020 2063 616c 6c62 6163 6b73 203d       callbacks =
-00034e70: 2043 616c 6c62 6163 6b73 2867 732e 636c   Callbacks(gs.cl
-00034e80: 6965 6e74 290a 2020 2020 2020 2020 6773  ient).        gs
-00034e90: 2e63 6c69 656e 742e 6164 645f 746f 5f64  .client.add_to_d
-00034ea0: 6576 6963 655f 6361 6c6c 6261 636b 280a  evice_callback(.
-00034eb0: 2020 2020 2020 2020 2020 2020 6361 6c6c              call
-00034ec0: 6261 636b 732e 746f 5f64 6576 6963 655f  backs.to_device_
-00034ed0: 6361 6c6c 6261 636b 2c20 284b 6579 5665  callback, (KeyVe
-00034ee0: 7269 6669 6361 7469 6f6e 4576 656e 742c  rificationEvent,
-00034ef0: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
-00034f00: 2020 2020 2320 5379 6e63 2065 6e63 7279      # Sync encry
-00034f10: 7074 696f 6e20 6b65 7973 2077 6974 6820  ption keys with 
-00034f20: 7468 6520 7365 7276 6572 0a20 2020 2020  the server.     
-00034f30: 2020 2023 2052 6571 7569 7265 6420 666f     # Required fo
-00034f40: 7220 7061 7274 6963 6970 6174 696e 6720  r participating 
-00034f50: 696e 2065 6e63 7279 7074 6564 2072 6f6f  in encrypted roo
-00034f60: 6d73 0a20 2020 2020 2020 2069 6620 6773  ms.        if gs
-00034f70: 2e63 6c69 656e 742e 7368 6f75 6c64 5f75  .client.should_u
-00034f80: 706c 6f61 645f 6b65 7973 3a0a 2020 2020  pload_keys:.    
-00034f90: 2020 2020 2020 2020 6177 6169 7420 6773          await gs
-00034fa0: 2e63 6c69 656e 742e 6b65 7973 5f75 706c  .client.keys_upl
-00034fb0: 6f61 6428 290a 2020 2020 2020 2020 7072  oad().        pr
-00034fc0: 696e 7428 0a20 2020 2020 2020 2020 2020  int(.           
-00034fd0: 2066 227b 5052 4f47 5f57 4954 484f 5554   f"{PROG_WITHOUT
-00034fe0: 5f45 5854 7d20 6973 2072 6561 6479 2061  _EXT} is ready a
-00034ff0: 6e64 2077 6169 7469 6e67 2066 6f72 2074  nd waiting for t
-00035000: 6865 206f 7468 6572 2070 6172 7479 2074  he other party t
-00035010: 6f20 220a 2020 2020 2020 2020 2020 2020  o ".            
-00035020: 2269 6e69 7469 6174 6520 616e 2065 6d6f  "initiate an emo
-00035030: 6a69 2076 6572 6966 6963 6174 696f 6e20  ji verification 
-00035040: 7769 7468 2075 7320 6279 2073 656c 6563  with us by selec
-00035050: 7469 6e67 2022 0a20 2020 2020 2020 2020  ting ".         
-00035060: 2020 2022 2756 6572 6966 7920 6279 2045     "'Verify by E
-00035070: 6d6f 6a69 2720 220a 2020 2020 2020 2020  moji' ".        
-00035080: 2020 2020 2269 6e20 7468 6569 7220 4d61      "in their Ma
-00035090: 7472 6978 2063 6c69 656e 742e 2052 6561  trix client. Rea
-000350a0: 6420 2d2d 7665 7269 6679 2069 6e73 7472  d --verify instr
-000350b0: 7563 7469 6f6e 7320 696e 202d 2d6d 616e  uctions in --man
-000350c0: 7561 6c20 220a 2020 2020 2020 2020 2020  ual ".          
-000350d0: 2020 2263 6172 6566 756c 6c79 2074 6f20    "carefully to 
-000350e0: 6173 7369 7374 2079 6f75 2069 6e20 686f  assist you in ho
-000350f0: 7720 746f 2064 6f20 7468 6973 2071 7569  w to do this qui
-00035100: 636b 6c79 2e22 2c0a 2020 2020 2020 2020  ckly.",.        
-00035110: 2020 2020 6669 6c65 3d73 7973 2e73 7464      file=sys.std
-00035120: 6f75 742c 0a20 2020 2020 2020 2020 2020  out,.           
-00035130: 2066 6c75 7368 3d54 7275 652c 0a20 2020   flush=True,.   
-00035140: 2020 2020 2029 0a20 2020 2020 2020 2023       ).        #
-00035150: 2074 6865 2073 796e 635f 6c6f 6f70 2077   the sync_loop w
-00035160: 696c 6c20 6265 2074 6572 6d69 6e61 7465  ill be terminate
-00035170: 6420 6279 2075 7365 7220 6869 7474 696e  d by user hittin
-00035180: 6720 436f 6e74 726f 6c2d 430a 2020 2020  g Control-C.    
-00035190: 2020 2020 6177 6169 7420 6773 2e63 6c69      await gs.cli
-000351a0: 656e 742e 7379 6e63 5f66 6f72 6576 6572  ent.sync_forever
-000351b0: 2874 696d 656f 7574 3d33 3030 3030 2c20  (timeout=30000, 
-000351c0: 6675 6c6c 5f73 7461 7465 3d54 7275 6529  full_state=True)
-000351d0: 0a20 2020 2065 7863 6570 7420 4b65 7962  .    except Keyb
-000351e0: 6f61 7264 496e 7465 7272 7570 743a 0a20  oardInterrupt:. 
-000351f0: 2020 2020 2020 2023 2054 6869 7320 7769         # This wi
-00035200: 6c6c 206e 6576 6572 2062 6520 6361 7567  ll never be caug
-00035210: 6874 2e20 4920 646f 206e 6f74 206b 6e6f  ht. I do not kno
-00035220: 7720 7768 792e 0a20 2020 2020 2020 2067  w why..        g
-00035230: 732e 6c6f 672e 6465 6275 6728 224b 6579  s.log.debug("Key
-00035240: 626f 6172 6420 696e 7465 7272 7570 7420  board interrupt 
-00035250: 6166 7465 7220 456d 6f6a 6920 7665 7269  after Emoji veri
-00035260: 6669 6361 7469 6f6e 2e22 290a 2020 2020  fication.").    
-00035270: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-00035280: 2061 7320 653a 0a20 2020 2020 2020 2067   as e:.        g
-00035290: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
-000352a0: 2020 2020 2020 2020 2022 4532 3137 3a20           "E217: 
-000352b0: 220a 2020 2020 2020 2020 2020 2020 2245  ".            "E
-000352c0: 7272 6f72 2064 7572 696e 6720 7665 7269  rror during veri
-000352d0: 6679 2e20 436f 6e74 696e 7569 6e67 2064  fy. Continuing d
-000352e0: 6573 7069 7465 2065 7272 6f72 2e20 220a  espite error. ".
-000352f0: 2020 2020 2020 2020 2020 2020 6622 4578              f"Ex
-00035300: 6365 7074 696f 6e3a 207b 657d 220a 2020  ception: {e}".  
-00035310: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00035320: 6773 2e65 7272 5f63 6f75 6e74 202b 3d20  gs.err_count += 
-00035330: 310a 0a0a 6173 796e 6320 6465 6620 6163  1...async def ac
-00035340: 7469 6f6e 5f73 656e 6428 2920 2d3e 204e  tion_send() -> N
-00035350: 6f6e 653a 0a20 2020 2022 2222 5365 6e64  one:.    """Send
-00035360: 206d 6573 7361 6765 7320 7768 696c 6520   messages while 
-00035370: 616c 7265 6164 7920 6c6f 6767 6564 2069  already logged i
-00035380: 6e2e 2222 220a 2020 2020 6966 206e 6f74  n.""".    if not
-00035390: 2067 732e 636c 6965 6e74 2061 6e64 206e   gs.client and n
-000353a0: 6f74 2067 732e 6372 6564 656e 7469 616c  ot gs.credential
-000353b0: 733a 0a20 2020 2020 2020 2067 732e 6c6f  s:.        gs.lo
-000353c0: 672e 6572 726f 7228 0a20 2020 2020 2020  g.error(.       
-000353d0: 2020 2020 2022 4532 3138 3a20 2220 2243       "E218: " "C
-000353e0: 6c69 656e 7420 6f72 2063 7265 6465 6e74  lient or credent
-000353f0: 6961 6c73 206e 6f74 2073 6574 2e20 536b  ials not set. Sk
-00035400: 6970 7069 6e67 2061 6374 696f 6e2e 220a  ipping action.".
-00035410: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00035420: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
-00035430: 3d20 310a 2020 2020 2020 2020 7265 7475  = 1.        retu
-00035440: 726e 0a20 2020 2074 7279 3a0a 2020 2020  rn.    try:.    
-00035450: 2020 2020 2320 6120 6665 7720 6d6f 7265      # a few more
-00035460: 2073 7465 7073 2074 6f20 7072 6570 6172   steps to prepar
-00035470: 6520 666f 7220 7365 6e64 696e 6720 6d65  e for sending me
-00035480: 7373 6167 6573 0a20 2020 2020 2020 2072  ssages.        r
-00035490: 6f6f 6d73 203d 2061 7761 6974 2064 6574  ooms = await det
-000354a0: 6572 6d69 6e65 5f72 6f6f 6d73 280a 2020  ermine_rooms(.  
-000354b0: 2020 2020 2020 2020 2020 6773 2e63 7265            gs.cre
-000354c0: 6465 6e74 6961 6c73 5b22 726f 6f6d 5f69  dentials["room_i
-000354d0: 6422 5d2c 2067 732e 636c 6965 6e74 2c20  d"], gs.client, 
-000354e0: 6773 2e63 7265 6465 6e74 6961 6c73 0a20  gs.credentials. 
-000354f0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00035500: 2067 732e 6c6f 672e 6465 6275 6728 6622   gs.log.debug(f"
-00035510: 526f 6f6d 7320 6172 653a 207b 726f 6f6d  Rooms are: {room
-00035520: 737d 2229 0a20 2020 2020 2020 2067 732e  s}").        gs.
-00035530: 6c6f 672e 6465 6275 6728 6622 6773 2e63  log.debug(f"gs.c
-00035540: 6c69 656e 742e 726f 6f6d 7320 6172 653a  lient.rooms are:
-00035550: 207b 6773 2e63 6c69 656e 742e 726f 6f6d   {gs.client.room
-00035560: 737d 2229 0a20 2020 2020 2020 2023 2053  s}").        # S
-00035570: 796e 6320 656e 6372 7970 7469 6f6e 206b  ync encryption k
-00035580: 6579 7320 7769 7468 2074 6865 2073 6572  eys with the ser
-00035590: 7665 720a 2020 2020 2020 2020 2320 5265  ver.        # Re
-000355a0: 7175 6972 6564 2066 6f72 2070 6172 7469  quired for parti
-000355b0: 6369 7061 7469 6e67 2069 6e20 656e 6372  cipating in encr
-000355c0: 7970 7465 6420 726f 6f6d 730a 2020 2020  ypted rooms.    
-000355d0: 2020 2020 6966 2067 732e 636c 6965 6e74      if gs.client
-000355e0: 2e73 686f 756c 645f 7570 6c6f 6164 5f6b  .should_upload_k
-000355f0: 6579 733a 0a20 2020 2020 2020 2020 2020  eys:.           
-00035600: 2067 732e 6c6f 672e 6465 6275 6728 2253   gs.log.debug("S
-00035610: 7461 7274 696e 6720 6b65 7973 5f75 706c  tarting keys_upl
-00035620: 6f61 6422 290a 2020 2020 2020 2020 2020  oad").          
-00035630: 2020 6177 6169 7420 6773 2e63 6c69 656e    await gs.clien
-00035640: 742e 6b65 7973 5f75 706c 6f61 6428 290a  t.keys_upload().
-00035650: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
-00035660: 6f67 2e64 6562 7567 2822 4669 6e69 7368  og.debug("Finish
-00035670: 6564 206b 6579 735f 7570 6c6f 6164 2229  ed keys_upload")
-00035680: 0a20 2020 2020 2020 2069 6620 6773 2e70  .        if gs.p
-00035690: 612e 7379 6e63 203d 3d20 5359 4e43 5f4f  a.sync == SYNC_O
-000356a0: 4646 3a0a 2020 2020 2020 2020 2020 2020  FF:.            
-000356b0: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
-000356c0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-000356d0: 4475 6520 746f 2027 2d2d 7379 6e63 207b  Due to '--sync {
-000356e0: 5359 4e43 5f4f 4646 7d27 206f 7074 696f  SYNC_OFF}' optio
-000356f0: 6e2c 2073 796e 6328 2920 7769 6c6c 2062  n, sync() will b
-00035700: 6520 736b 6970 7065 642e 220a 2020 2020  e skipped.".    
-00035710: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00035720: 2020 2020 2020 2320 5072 6566 696c 6c20        # Prefill 
-00035730: 726f 6f6d 7320 6173 206f 7574 6c69 6e65  rooms as outline
-00035740: 6420 696e 2049 7373 7565 2023 3931 0a20  d in Issue #91. 
-00035750: 2020 2020 2020 2020 2020 2023 2053 696e             # Sin
-00035760: 6365 2073 796e 6328 2920 6973 206e 6f74  ce sync() is not
-00035770: 2063 616c 6c65 6420 7765 204d 5553 5420   called we MUST 
-00035780: 6669 6c6c 2069 6e20 7468 6520 726f 6f6d  fill in the room
-00035790: 7320 6d61 6e75 616c 6c79 2e0a 2020 2020  s manually..    
-000357a0: 2020 2020 2020 2020 2320 5468 6973 206c          # This l
-000357b0: 696e 6520 7761 7320 7375 6767 6573 7465  ine was suggeste
-000357c0: 6420 6173 2077 6f72 6b61 726f 756e 643a  d as workaround:
-000357d0: 0a20 2020 2020 2020 2020 2020 2023 2061  .            # a
-000357e0: 7379 6e63 5f63 6c69 656e 742e 726f 6f6d  sync_client.room
-000357f0: 735b 726f 6f6d 5f69 645d 203d 206e 696f  s[room_id] = nio
-00035800: 2e72 6f6f 6d73 2e4d 6174 7269 7852 6f6f  .rooms.MatrixRoo
-00035810: 6d28 0a20 2020 2020 2020 2020 2020 2023  m(.            #
-00035820: 2020 2020 2020 2020 2020 726f 6f6d 5f69            room_i
-00035830: 643d 726f 6f6d 5f69 642c 206f 776e 5f75  d=room_id, own_u
-00035840: 7365 725f 6964 3d75 7365 725f 6964 2c20  ser_id=user_id, 
-00035850: 656e 6372 7970 7465 643d 5472 7565 290a  encrypted=True).
-00035860: 2020 2020 2020 2020 2020 2020 2320 5765              # We
-00035870: 206d 7573 7420 616c 736f 206d 6170 2072   must also map r
-00035880: 6f6f 6d20 616c 6961 7365 7320 746f 2072  oom aliases to r
-00035890: 6f6f 6d20 6964 732e 0a20 2020 2020 2020  oom ids..       
-000358a0: 2020 2020 2066 6f72 2072 6f6f 6d5f 6964       for room_id
-000358b0: 2069 6e20 726f 6f6d 733a 0a20 2020 2020   in rooms:.     
-000358c0: 2020 2020 2020 2020 2020 2072 6f6f 6d5f             room_
-000358d0: 6964 203d 2061 7761 6974 206d 6170 5f72  id = await map_r
-000358e0: 6f6f 6d69 6e66 6f5f 746f 5f72 6f6f 6d69  oominfo_to_roomi
-000358f0: 6428 6773 2e63 6c69 656e 742c 2072 6f6f  d(gs.client, roo
-00035900: 6d5f 6964 290a 2020 2020 2020 2020 2020  m_id).          
-00035910: 2020 2020 2020 6773 2e63 6c69 656e 742e        gs.client.
-00035920: 726f 6f6d 735b 726f 6f6d 5f69 645d 203d  rooms[room_id] =
-00035930: 204d 6174 7269 7852 6f6f 6d28 0a20 2020   MatrixRoom(.   
-00035940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035950: 2072 6f6f 6d5f 6964 3d72 6f6f 6d5f 6964   room_id=room_id
-00035960: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00035970: 2020 2020 2020 6f77 6e5f 7573 6572 5f69        own_user_i
-00035980: 643d 6773 2e63 7265 6465 6e74 6961 6c73  d=gs.credentials
-00035990: 5b22 7573 6572 5f69 6422 5d2c 0a20 2020  ["user_id"],.   
-000359a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000359b0: 2065 6e63 7279 7074 6564 3d54 7275 652c   encrypted=True,
-000359c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000359d0: 2029 0a20 2020 2020 2020 2065 6c73 653a   ).        else:
-000359e0: 2020 2320 5359 4e43 5f46 554c 4c0a 2020    # SYNC_FULL.  
-000359f0: 2020 2020 2020 2020 2020 2320 4465 6661            # Defa
-00035a00: 756c 7420 6361 7365 2c20 7374 616e 6461  ult case, standa
-00035a10: 7264 3a0a 2020 2020 2020 2020 2020 2020  rd:.            
-00035a20: 2320 4f6e 6520 6d75 7374 2073 796e 6320  # One must sync 
-00035a30: 6669 7273 7420 746f 2067 6574 2072 6f6f  first to get roo
-00035a40: 6d20 6964 7320 666f 7220 656e 6372 7970  m ids for encryp
-00035a50: 7465 6420 726f 6f6d 730a 2020 2020 2020  ted rooms.      
-00035a60: 2020 2020 2020 2320 7369 6e63 6520 7765        # since we
-00035a70: 206f 6e6c 7920 7365 6e64 2061 206d 7367   only send a msg
-00035a80: 2061 6e64 2074 6865 6e20 7374 6f70 2c0a   and then stop,.
-00035a90: 2020 2020 2020 2020 2020 2020 2320 7765              # we
-00035aa0: 2063 616e 2075 7365 2073 796e 6328 2920   can use sync() 
-00035ab0: 696e 7374 6561 6420 6f66 2073 796e 635f  instead of sync_
-00035ac0: 666f 7265 7665 7228 292e 0a20 2020 2020  forever()..     
-00035ad0: 2020 2020 2020 2066 756c 6c5f 7374 6174         full_stat
-00035ae0: 6520 3d20 5472 7565 0a20 2020 2020 2020  e = True.       
-00035af0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-00035b00: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-00035b10: 2020 2066 2253 7461 7274 696e 6720 7379     f"Starting sy
-00035b20: 6e63 2866 756c 6c5f 7374 6174 653d 7b66  nc(full_state={f
-00035b30: 756c 6c5f 7374 6174 657d 2920 220a 2020  ull_state}) ".  
-00035b40: 2020 2020 2020 2020 2020 2020 2020 2274                "t
-00035b50: 6f20 7379 6e63 6872 6f6e 697a 6520 6576  o synchronize ev
-00035b60: 656e 7473 2077 6974 6820 7365 7276 6572  ents with server
-00035b70: 2e22 0a20 2020 2020 2020 2020 2020 2029  .".            )
-00035b80: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-00035b90: 6974 2067 732e 636c 6965 6e74 2e73 796e  it gs.client.syn
-00035ba0: 6328 7469 6d65 6f75 743d 3330 3030 302c  c(timeout=30000,
-00035bb0: 2066 756c 6c5f 7374 6174 653d 6675 6c6c   full_state=full
-00035bc0: 5f73 7461 7465 290a 2020 2020 2020 2020  _state).        
-00035bd0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-00035be0: 2822 4669 6e69 7368 6564 2073 796e 6328  ("Finished sync(
-00035bf0: 2920 7769 7468 2073 6572 7665 722e 2229  ) with server.")
-00035c00: 0a20 2020 2020 2020 2023 204e 6f77 2077  .        # Now w
-00035c10: 6520 6361 6e20 7365 6e64 206d 6573 7361  e can send messa
-00035c20: 6765 7320 6173 2074 6865 2075 7365 720a  ges as the user.
-00035c30: 2020 2020 2020 2020 6177 6169 7420 7072          await pr
-00035c40: 6f63 6573 735f 6172 6775 6d65 6e74 735f  ocess_arguments_
-00035c50: 616e 645f 696e 7075 7428 6773 2e63 6c69  and_input(gs.cli
-00035c60: 656e 742c 2072 6f6f 6d73 290a 2020 2020  ent, rooms).    
-00035c70: 2020 2020 2320 6773 2e6c 6f67 2e64 6562      # gs.log.deb
-00035c80: 7567 2866 2267 732e 636c 6965 6e74 2e72  ug(f"gs.client.r
-00035c90: 6f6f 6d73 2061 7265 3a20 7b67 732e 636c  ooms are: {gs.cl
-00035ca0: 6965 6e74 2e72 6f6f 6d73 7d22 290a 2020  ient.rooms}").  
-00035cb0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-00035cc0: 7567 2822 4d65 7373 6167 6520 7365 6e64  ug("Message send
-00035cd0: 2061 6374 696f 6e20 6669 6e69 7368 6564   action finished
-00035ce0: 2e22 290a 2020 2020 6578 6365 7074 2045  .").    except E
-00035cf0: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
-00035d00: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
-00035d10: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-00035d20: 2022 4532 3139 3a20 220a 2020 2020 2020   "E219: ".      
-00035d30: 2020 2020 2020 2245 7272 6f72 2064 7572        "Error dur
-00035d40: 696e 6720 7365 6e64 696e 672e 2043 6f6e  ing sending. Con
-00035d50: 7469 6e75 696e 6720 6465 7370 6974 6520  tinuing despite 
-00035d60: 6572 726f 722e 2022 0a20 2020 2020 2020  error. ".       
-00035d70: 2020 2020 2066 2245 7863 6570 7469 6f6e       f"Exception
-00035d80: 3a20 7b65 7d22 0a20 2020 2020 2020 2029  : {e}".        )
-00035d90: 0a20 2020 2020 2020 2067 732e 6572 725f  .        gs.err_
-00035da0: 636f 756e 7420 2b3d 2031 0a0a 0a61 7379  count += 1...asy
-00035db0: 6e63 2064 6566 2061 6374 696f 6e5f 6c6f  nc def action_lo
-00035dc0: 676f 7574 2829 202d 3e20 4e6f 6e65 3a0a  gout() -> None:.
-00035dd0: 2020 2020 2222 224c 6f67 206f 7574 206f      """Log out o
-00035de0: 6e65 206f 7220 616c 6c20 6465 7669 6365  ne or all device
-00035df0: 7320 6672 6f6d 204d 6174 7269 7820 7365  s from Matrix se
-00035e00: 7276 6572 2e22 2222 0a20 2020 2069 6620  rver.""".    if 
-00035e10: 6e6f 7420 6773 2e63 6c69 656e 7420 616e  not gs.client an
-00035e20: 6420 6e6f 7420 6773 2e63 7265 6465 6e74  d not gs.credent
-00035e30: 6961 6c73 3a0a 2020 2020 2020 2020 6773  ials:.        gs
+0002fc20: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+0002fc30: 6f67 2e69 6e66 6f28 0a20 2020 2020 2020  og.info(.       
+0002fc40: 2020 2020 2020 2020 2066 2253 7563 6365           f"Succe
+0002fc50: 7373 6675 6c6c 7920 7265 736f 6c76 6564  ssfully resolved
+0002fc60: 2072 6f6f 6d20 616c 6961 7320 277b 616c   room alias '{al
+0002fc70: 6961 737d 2720 746f 2022 0a20 2020 2020  ias}' to ".     
+0002fc80: 2020 2020 2020 2020 2020 2066 227b 7265             f"{re
+0002fc90: 7370 2e72 6f6f 6d5f 6964 7d2e 220a 2020  sp.room_id}.".  
+0002fca0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0002fcb0: 2020 2020 2020 2020 2320 6f75 7470 7574          # output
+0002fcc0: 2066 6f72 6d61 7420 636f 6e74 726f 6c6c   format controll
+0002fcd0: 6564 2076 6961 202d 2d6f 7574 7075 7420  ed via --output 
+0002fce0: 666c 6167 0a20 2020 2020 2020 2020 2020  flag.           
+0002fcf0: 2074 6578 7420 3d20 280a 2020 2020 2020   text = (.      
+0002fd00: 2020 2020 2020 2020 2020 6622 7b72 6573            f"{res
+0002fd10: 702e 726f 6f6d 5f61 6c69 6173 7d7b 5345  p.room_alias}{SE
+0002fd20: 507d 7b72 6573 702e 726f 6f6d 5f69 647d  P}{resp.room_id}
+0002fd30: 7b53 4550 7d22 2066 227b 7265 7370 2e73  {SEP}" f"{resp.s
+0002fd40: 6572 7665 7273 7d22 0a20 2020 2020 2020  ervers}".       
+0002fd50: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0002fd60: 2020 2023 204f 626a 6563 7420 6f66 2074     # Object of t
+0002fd70: 7970 6520 7878 7852 6573 706f 6e73 6520  ype xxxResponse 
+0002fd80: 6973 206e 6f74 204a 534f 4e0a 2020 2020  is not JSON.    
+0002fd90: 2020 2020 2020 2020 2320 7365 7269 616c          # serial
+0002fda0: 697a 6162 6c65 2c20 6865 6e63 6520 7765  izable, hence we
+0002fdb0: 2075 7365 2074 6865 2064 6963 7469 6f6e   use the diction
+0002fdc0: 6172 792e 0a20 2020 2020 2020 2020 2020  ary..           
+0002fdd0: 206a 736f 6e5f 6d61 7820 3d20 7265 7370   json_max = resp
+0002fde0: 2e5f 5f64 6963 745f 5f0a 2020 2020 2020  .__dict__.      
+0002fdf0: 2020 2020 2020 2320 6a73 6f6e 5f6d 6178        # json_max
+0002fe00: 2e75 7064 6174 6528 7b22 6b65 7922 3a20  .update({"key": 
+0002fe10: 7661 6c75 657d 2920 2023 2061 6464 2064  value})  # add d
+0002fe20: 6963 7420 6974 656d 730a 2020 2020 2020  ict items.      
+0002fe30: 2020 2020 2020 6a73 6f6e 5f20 3d20 6a73        json_ = js
+0002fe40: 6f6e 5f6d 6178 2e63 6f70 7928 290a 2020  on_max.copy().  
+0002fe50: 2020 2020 2020 2020 2020 6a73 6f6e 5f2e            json_.
+0002fe60: 706f 7028 2274 7261 6e73 706f 7274 5f72  pop("transport_r
+0002fe70: 6573 706f 6e73 6522 290a 2020 2020 2020  esponse").      
+0002fe80: 2020 2020 2020 6a73 6f6e 5f73 7065 6320        json_spec 
+0002fe90: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
+0002fea0: 2020 2070 7269 6e74 5f6f 7574 7075 7428     print_output(
+0002feb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002fec0: 2067 732e 7061 2e6f 7574 7075 742c 0a20   gs.pa.output,. 
+0002fed0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0002fee0: 6578 743d 7465 7874 2c0a 2020 2020 2020  ext=text,.      
+0002fef0: 2020 2020 2020 2020 2020 6a73 6f6e 5f3d            json_=
+0002ff00: 6a73 6f6e 5f2c 0a20 2020 2020 2020 2020  json_,.         
+0002ff10: 2020 2020 2020 206a 736f 6e5f 6d61 783d         json_max=
+0002ff20: 6a73 6f6e 5f6d 6178 2c0a 2020 2020 2020  json_max,.      
+0002ff30: 2020 2020 2020 2020 2020 6a73 6f6e 5f73            json_s
+0002ff40: 7065 633d 6a73 6f6e 5f73 7065 632c 0a20  pec=json_spec,. 
+0002ff50: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0002ff60: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0002ff70: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
+0002ff80: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+0002ff90: 2020 2020 2022 4532 3032 3a20 220a 2020       "E202: ".  
+0002ffa0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0002ffb0: 4661 696c 6564 2074 6f20 7265 736f 6c76  Failed to resolv
+0002ffc0: 6520 726f 6f6d 2061 6c69 6173 2027 7b61  e room alias '{a
+0002ffd0: 6c69 6173 7d27 3a20 220a 2020 2020 2020  lias}': ".      
+0002ffe0: 2020 2020 2020 2020 2020 6622 7b70 7269            f"{pri
+0002fff0: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
+00030000: 7265 7370 2929 7d22 0a20 2020 2020 2020  resp))}".       
+00030010: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00030020: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
+00030030: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
+00030040: 2023 206f 7574 7075 7420 666f 726d 6174   # output format
+00030050: 2063 6f6e 7472 6f6c 6c65 6420 7669 6120   controlled via 
+00030060: 2d2d 6f75 7470 7574 2066 6c61 670a 2020  --output flag.  
+00030070: 2020 2020 2020 2020 2020 2320 666f 7220            # for 
+00030080: 4a53 4f4e 2074 6865 2075 7365 7220 6361  JSON the user ca
+00030090: 6e20 6465 7465 726d 696e 6520 7768 6963  n determine whic
+000300a0: 6820 6f6e 6520 6672 6f6d 2074 6865 206c  h one from the l
+000300b0: 6973 740a 2020 2020 2020 2020 2020 2020  ist.            
+000300c0: 2320 7761 7320 7375 6363 6573 7366 756c  # was successful
+000300d0: 2061 6e64 2077 6869 6368 206f 6e65 2066   and which one f
+000300e0: 6169 6c65 642e 2046 6f72 2034 2069 6e70  ailed. For 4 inp
+000300f0: 7574 7320 7468 6572 650a 2020 2020 2020  uts there.      
+00030100: 2020 2020 2020 2320 6d69 6768 7420 6f6e        # might on
+00030110: 6c79 2062 6520 3320 6f75 7470 7574 204a  ly be 3 output J
+00030120: 534f 4e20 6f62 6a65 6374 7320 6966 2074  SON objects if t
+00030130: 6865 7265 2077 6173 2031 2065 7272 6f72  here was 1 error
+00030140: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00030150: 496e 2074 6578 7420 6d6f 6465 2077 6520  In text mode we 
+00030160: 7072 696e 7420 7468 6973 2065 7272 6f72  print this error
+00030170: 206c 696e 652c 2073 6f20 7468 6174 2066   line, so that f
+00030180: 6f72 2034 2069 6e70 7574 730a 2020 2020  or 4 inputs.    
+00030190: 2020 2020 2020 2020 2320 7468 6572 6520          # there 
+000301a0: 7769 6c6c 2062 6520 3420 6f75 7470 7574  will be 4 output
+000301b0: 206c 696e 6573 2e0a 2020 2020 2020 2020   lines..        
+000301c0: 2020 2020 7072 696e 745f 6f75 7470 7574      print_output
+000301d0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000301e0: 2020 6773 2e70 612e 6f75 7470 7574 2c0a    gs.pa.output,.
+000301f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030200: 7465 7874 3d28 6622 7b61 6c69 6173 7d7b  text=(f"{alias}{
+00030210: 5345 507d 4572 726f 727b 5345 507d 5b5d  SEP}Error{SEP}[]
+00030220: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+00030230: 2020 2020 6a73 6f6e 5f3d 4e6f 6e65 2c0a      json_=None,.
+00030240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030250: 6a73 6f6e 5f6d 6178 3d4e 6f6e 652c 0a20  json_max=None,. 
+00030260: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+00030270: 736f 6e5f 7370 6563 3d4e 6f6e 652c 0a20  son_spec=None,. 
+00030280: 2020 2020 2020 2020 2020 2029 0a0a 0a61             )...a
+00030290: 7379 6e63 2064 6566 2061 6374 696f 6e5f  sync def action_
+000302a0: 726f 6f6d 5f64 656c 6574 655f 616c 6961  room_delete_alia
+000302b0: 7328 0a20 2020 2063 6c69 656e 743a 2041  s(.    client: A
+000302c0: 7379 6e63 436c 6965 6e74 2c20 6372 6564  syncClient, cred
+000302d0: 656e 7469 616c 733a 2064 6963 740a 2920  entials: dict.) 
+000302e0: 2d3e 204e 6f6e 653a 0a20 2020 2022 2222  -> None:.    """
+000302f0: 4465 6c65 7465 2072 6f6f 6d20 616c 6961  Delete room alia
+00030300: 7328 6573 2920 7768 696c 6520 616c 7265  s(es) while alre
+00030310: 6164 7920 6c6f 6767 6564 2069 6e2e 2222  ady logged in.""
+00030320: 220a 2020 2020 666f 7220 616c 6961 7320  ".    for alias 
+00030330: 696e 2067 732e 7061 2e72 6f6f 6d5f 6465  in gs.pa.room_de
+00030340: 6c65 7465 5f61 6c69 6173 3a0a 2020 2020  lete_alias:.    
+00030350: 2020 2020 616c 6961 7320 3d20 616c 6961      alias = alia
+00030360: 732e 7374 7269 7028 290a 2020 2020 2020  s.strip().      
+00030370: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
+00030380: 2244 656c 6574 696e 6720 726f 6f6d 2061  "Deleting room a
+00030390: 6c69 6173 2027 7b61 6c69 6173 7d27 2e22  lias '{alias}'."
+000303a0: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+000303b0: 2069 735f 726f 6f6d 5f61 6c69 6173 2861   is_room_alias(a
+000303c0: 6c69 6173 2920 616e 6420 6e6f 7420 6973  lias) and not is
+000303d0: 5f73 686f 7274 5f72 6f6f 6d5f 616c 6961  _short_room_alia
+000303e0: 7328 616c 6961 7329 3a0a 2020 2020 2020  s(alias):.      
+000303f0: 2020 2020 2020 2320 6e6f 7420 616e 2065        # not an e
+00030400: 7868 6175 7374 6976 6520 6368 6563 6b0a  xhaustive check.
+00030410: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+00030420: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
+00030430: 2020 2020 2020 2020 2020 2245 3230 333a            "E203:
+00030440: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00030450: 2020 2066 2249 6e76 616c 6964 2061 6c69     f"Invalid ali
+00030460: 6173 2027 7b61 6c69 6173 7d27 2e20 5468  as '{alias}'. Th
+00030470: 6973 2069 7320 6e65 6974 6865 7220 6120  is is neither a 
+00030480: 6675 6c6c 2072 6f6f 6d20 616c 6961 7320  full room alias 
+00030490: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+000304a0: 2020 226e 6f72 2061 2073 686f 7274 2072    "nor a short r
+000304b0: 6f6f 6d20 616c 6961 732e 2049 7420 7368  oom alias. It sh
+000304c0: 6f75 6c64 2065 6974 6865 7220 6265 2022  ould either be "
+000304d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000304e0: 2022 2723 536f 6d65 526f 6f6d 416c 6961   "'#SomeRoomAlia
+000304f0: 733a 6d61 7472 6978 2e65 7861 6d70 6c65  s:matrix.example
+00030500: 2e63 6f6d 2720 6f72 2027 536f 6d65 526f  .com' or 'SomeRo
+00030510: 6f6d 416c 6961 7327 2e22 0a20 2020 2020  omAlias'.".     
+00030520: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00030530: 2020 2020 2067 732e 6572 725f 636f 756e       gs.err_coun
+00030540: 7420 2b3d 2031 0a20 2020 2020 2020 2020  t += 1.         
+00030550: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
+00030560: 2020 2020 6966 2022 3a22 206e 6f74 2069      if ":" not i
+00030570: 6e20 616c 6961 733a 2020 2320 7368 6f72  n alias:  # shor
+00030580: 7420 616c 6961 732c 2077 6974 686f 7574  t alias, without
+00030590: 2068 6f6d 6573 6572 7665 720a 2020 2020   homeserver.    
+000305a0: 2020 2020 2020 2020 616c 6961 7320 3d20          alias = 
+000305b0: 7368 6f72 745f 726f 6f6d 5f61 6c69 6173  short_room_alias
+000305c0: 5f74 6f5f 726f 6f6d 5f61 6c69 6173 2861  _to_room_alias(a
+000305d0: 6c69 6173 2c20 6372 6564 656e 7469 616c  lias, credential
+000305e0: 7329 0a20 2020 2020 2020 2072 6573 7020  s).        resp 
+000305f0: 3d20 6177 6169 7420 636c 6965 6e74 2e72  = await client.r
+00030600: 6f6f 6d5f 6465 6c65 7465 5f61 6c69 6173  oom_delete_alias
+00030610: 2861 6c69 6173 290a 2020 2020 2020 2020  (alias).        
+00030620: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
+00030630: 7370 2c20 526f 6f6d 4465 6c65 7465 416c  sp, RoomDeleteAl
+00030640: 6961 7352 6573 706f 6e73 6529 3a0a 2020  iasResponse):.  
+00030650: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
+00030660: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+00030670: 2020 2020 2020 2020 2272 6f6f 6d5f 6465          "room_de
+00030680: 6c65 7465 5f61 6c69 6173 2073 7563 6365  lete_alias succe
+00030690: 7373 6675 6c2e 2052 6573 706f 6e73 6520  ssful. Response 
+000306a0: 6973 3a20 220a 2020 2020 2020 2020 2020  is: ".          
+000306b0: 2020 2020 2020 6622 7b70 7269 7661 6379        f"{privacy
+000306c0: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
+000306d0: 2929 7d22 0a20 2020 2020 2020 2020 2020  ))}".           
+000306e0: 2029 0a20 2020 2020 2020 2020 2020 2067   ).            g
+000306f0: 732e 6c6f 672e 696e 666f 2866 2253 7563  s.log.info(f"Suc
+00030700: 6365 7373 6675 6c6c 7920 6465 6c65 7465  cessfully delete
+00030710: 6420 726f 6f6d 2061 6c69 6173 2027 7b61  d room alias '{a
+00030720: 6c69 6173 7d27 2e22 290a 2020 2020 2020  lias}'.").      
+00030730: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00030740: 2020 2020 6773 2e6c 6f67 2e65 7272 6f72      gs.log.error
+00030750: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00030760: 2020 2245 3230 343a 2022 0a20 2020 2020    "E204: ".     
+00030770: 2020 2020 2020 2020 2020 2066 2246 6169             f"Fai
+00030780: 6c65 6420 746f 2064 656c 6574 6520 726f  led to delete ro
+00030790: 6f6d 2061 6c69 6173 2027 7b61 6c69 6173  om alias '{alias
+000307a0: 7d27 3a20 220a 2020 2020 2020 2020 2020  }': ".          
+000307b0: 2020 2020 2020 6622 7b70 7269 7661 6379        f"{privacy
+000307c0: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
+000307d0: 2929 7d22 0a20 2020 2020 2020 2020 2020  ))}".           
+000307e0: 2029 0a20 2020 2020 2020 2020 2020 2067   ).            g
+000307f0: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
+00030800: 0a0a 0a61 7379 6e63 2064 6566 2061 6374  ...async def act
+00030810: 696f 6e5f 6765 745f 6f70 656e 6964 5f74  ion_get_openid_t
+00030820: 6f6b 656e 280a 2020 2020 636c 6965 6e74  oken(.    client
+00030830: 3a20 4173 796e 6343 6c69 656e 742c 2063  : AsyncClient, c
+00030840: 7265 6465 6e74 6961 6c73 3a20 6469 6374  redentials: dict
+00030850: 0a29 202d 3e20 4e6f 6e65 3a0a 2020 2020  .) -> None:.    
+00030860: 2222 2247 6574 204f 7065 6e49 6420 746f  """Get OpenId to
+00030870: 6b65 6e28 7329 2066 6f72 2069 7473 656c  ken(s) for itsel
+00030880: 6620 6f72 2075 7365 7273 2077 6869 6c65  f or users while
+00030890: 2061 6c72 6561 6479 206c 6f67 6765 6420   already logged 
+000308a0: 696e 2e22 2222 0a20 2020 2069 6620 6e6f  in.""".    if no
+000308b0: 7420 4841 5645 5f4f 5045 4e49 443a 0a20  t HAVE_OPENID:. 
+000308c0: 2020 2020 2020 206e 696f 5f76 6572 7369         nio_versi
+000308d0: 6f6e 203d 2070 6b67 5f72 6573 6f75 7263  on = pkg_resourc
+000308e0: 6573 2e67 6574 5f64 6973 7472 6962 7574  es.get_distribut
+000308f0: 696f 6e28 226d 6174 7269 782d 6e69 6f22  ion("matrix-nio"
+00030900: 292e 7665 7273 696f 6e0a 2020 2020 2020  ).version.      
+00030910: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
+00030920: 2020 2020 2020 2020 2020 2020 2245 3230              "E20
+00030930: 353a 2022 0a20 2020 2020 2020 2020 2020  5: ".           
+00030940: 2066 2259 6f75 2061 7265 2072 756e 6e69   f"You are runni
+00030950: 6e67 206d 6174 7269 782d 6e69 6f20 7665  ng matrix-nio ve
+00030960: 7273 696f 6e20 7b6e 696f 5f76 6572 7369  rsion {nio_versi
+00030970: 6f6e 7d2e 2022 0a20 2020 2020 2020 2020  on}. ".         
+00030980: 2020 2066 2254 6869 7320 6665 6174 7572     f"This featur
+00030990: 6520 6973 206f 6e6c 7920 6176 6169 6c61  e is only availa
+000309a0: 626c 6520 6f6e 2076 6572 7369 6f6e 7320  ble on versions 
+000309b0: 6c61 7267 6572 2074 6861 6e20 302e 3139  larger than 0.19
+000309c0: 2e30 2e20 220a 2020 2020 2020 2020 2020  .0. ".          
+000309d0: 2020 2255 7064 6174 6520 6966 206e 6563    "Update if nec
+000309e0: 6573 7361 7279 2e20 220a 2020 2020 2020  essary. ".      
+000309f0: 2020 2020 2020 2257 6169 7420 666f 7220        "Wait for 
+00030a00: 7665 7273 696f 6e20 302e 3139 2e31 206f  version 0.19.1 o
+00030a10: 7220 302e 3230 2074 6f20 6265 2072 656c  r 0.20 to be rel
+00030a20: 6561 7365 642e 2022 0a20 2020 2020 2020  eased. ".       
+00030a30: 2020 2020 2022 4f72 2075 7365 2075 6e72       "Or use unr
+00030a40: 656c 6561 7365 6420 636f 6465 2066 726f  eleased code fro
+00030a50: 6d20 6d61 7374 6572 2062 7261 6e63 6820  m master branch 
+00030a60: 6f6e 2047 6974 6875 622e 220a 2020 2020  on Github.".    
+00030a70: 2020 2020 290a 2020 2020 2020 2020 6773      ).        gs
+00030a80: 2e65 7272 5f63 6f75 6e74 202b 3d20 310a  .err_count += 1.
+00030a90: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
+00030aa0: 2020 2069 6620 6773 2e70 612e 6765 745f     if gs.pa.get_
+00030ab0: 6f70 656e 6964 5f74 6f6b 656e 203d 3d20  openid_token == 
+00030ac0: 5b5d 3a0a 2020 2020 2020 2020 6773 2e70  []:.        gs.p
+00030ad0: 612e 6765 745f 6f70 656e 6964 5f74 6f6b  a.get_openid_tok
+00030ae0: 656e 2e61 7070 656e 6428 6372 6564 656e  en.append(creden
+00030af0: 7469 616c 735b 2275 7365 725f 6964 225d  tials["user_id"]
+00030b00: 2920 2023 2077 686f 616d 690a 2020 2020  )  # whoami.    
+00030b10: 6773 2e6c 6f67 2e64 6562 7567 2866 2247  gs.log.debug(f"G
+00030b20: 6574 7469 6e67 204f 7065 6e49 4473 2066  etting OpenIDs f
+00030b30: 6f72 2074 6865 7365 2075 7365 7273 3a20  or these users: 
+00030b40: 7b67 732e 7061 2e67 6574 5f6f 7065 6e69  {gs.pa.get_openi
+00030b50: 645f 746f 6b65 6e7d 2229 0a20 2020 2066  d_token}").    f
+00030b60: 6f72 2075 7365 725f 6964 2069 6e20 6773  or user_id in gs
+00030b70: 2e70 612e 6765 745f 6f70 656e 6964 5f74  .pa.get_openid_t
+00030b80: 6f6b 656e 3a0a 2020 2020 2020 2020 7573  oken:.        us
+00030b90: 6572 5f69 6420 3d20 7573 6572 5f69 642e  er_id = user_id.
+00030ba0: 7374 7269 7028 290a 2020 2020 2020 2020  strip().        
+00030bb0: 7265 7370 203d 2061 7761 6974 2063 6c69  resp = await cli
+00030bc0: 656e 742e 6765 745f 6f70 656e 6964 5f74  ent.get_openid_t
+00030bd0: 6f6b 656e 2875 7365 725f 6964 290a 2020  oken(user_id).  
+00030be0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00030bf0: 6e63 6528 7265 7370 2c20 4765 744f 7065  nce(resp, GetOpe
+00030c00: 6e49 4454 6f6b 656e 4572 726f 7229 3a0a  nIDTokenError):.
+00030c10: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+00030c20: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
+00030c30: 2020 2020 2020 2020 2020 2245 3230 363a            "E206:
+00030c40: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00030c50: 2020 2066 2246 6169 6c65 6420 746f 2067     f"Failed to g
+00030c60: 6574 204f 7065 6e49 6420 666f 7220 7573  et OpenId for us
+00030c70: 6572 207b 7573 6572 5f69 647d 2e20 5265  er {user_id}. Re
+00030c80: 7370 6f6e 7365 3a20 220a 2020 2020 2020  sponse: ".      
+00030c90: 2020 2020 2020 2020 2020 6622 7b70 7269            f"{pri
+00030ca0: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
+00030cb0: 7265 7370 2929 7d22 0a20 2020 2020 2020  resp))}".       
+00030cc0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00030cd0: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
+00030ce0: 2b3d 2031 0a20 2020 2020 2020 2065 6c73  += 1.        els
+00030cf0: 653a 0a20 2020 2020 2020 2020 2020 2067  e:.            g
+00030d00: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
+00030d10: 2020 2020 2020 2020 2020 2020 2022 6765               "ge
+00030d20: 745f 6f70 656e 6964 5f74 6f6b 656e 2073  t_openid_token s
+00030d30: 7563 6365 7373 6675 6c2e 2052 6573 706f  uccessful. Respo
+00030d40: 6e73 6520 6973 3a20 220a 2020 2020 2020  nse is: ".      
+00030d50: 2020 2020 2020 2020 2020 6622 7b70 7269            f"{pri
+00030d60: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
+00030d70: 7265 7370 2929 7d22 0a20 2020 2020 2020  resp))}".       
+00030d80: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00030d90: 2020 2067 732e 6c6f 672e 696e 666f 280a     gs.log.info(.
+00030da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030db0: 6622 5375 6363 6573 7366 756c 6c79 206f  f"Successfully o
+00030dc0: 6274 6169 6e65 6420 4f70 656e 4964 2074  btained OpenId t
+00030dd0: 6f6b 656e 2022 0a20 2020 2020 2020 2020  oken ".         
+00030de0: 2020 2020 2020 2066 227b 7265 7370 2e61         f"{resp.a
+00030df0: 6363 6573 735f 746f 6b65 6e7d 2066 6f72  ccess_token} for
+00030e00: 2075 7365 7220 7b75 7365 725f 6964 7d2e   user {user_id}.
+00030e10: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+00030e20: 2020 2020 2020 2020 2020 2020 2320 6f75              # ou
+00030e30: 7470 7574 2066 6f72 6d61 7420 636f 6e74  tput format cont
+00030e40: 726f 6c6c 6564 2076 6961 202d 2d6f 7574  rolled via --out
+00030e50: 7075 7420 666c 6167 0a20 2020 2020 2020  put flag.       
+00030e60: 2020 2020 2074 6578 7420 3d20 280a 2020       text = (.  
+00030e70: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00030e80: 7b75 7365 725f 6964 7d7b 5345 507d 7b72  {user_id}{SEP}{r
+00030e90: 6573 702e 6163 6365 7373 5f74 6f6b 656e  esp.access_token
+00030ea0: 7d7b 5345 507d 7b72 6573 702e 6578 7069  }{SEP}{resp.expi
+00030eb0: 7265 735f 696e 7d22 0a20 2020 2020 2020  res_in}".       
+00030ec0: 2020 2020 2020 2020 2066 227b 5345 507d           f"{SEP}
+00030ed0: 7b72 6573 702e 6d61 7472 6978 5f73 6572  {resp.matrix_ser
+00030ee0: 7665 725f 6e61 6d65 7d7b 5345 507d 7b72  ver_name}{SEP}{r
+00030ef0: 6573 702e 746f 6b65 6e5f 7479 7065 7d22  esp.token_type}"
+00030f00: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00030f10: 2020 2020 2020 2020 2020 2023 204f 626a             # Obj
+00030f20: 6563 7420 6f66 2074 7970 6520 7878 7852  ect of type xxxR
+00030f30: 6573 706f 6e73 6520 6973 206e 6f74 204a  esponse is not J
+00030f40: 534f 4e0a 2020 2020 2020 2020 2020 2020  SON.            
+00030f50: 2320 7365 7269 616c 697a 6162 6c65 2c20  # serializable, 
+00030f60: 6865 6e63 6520 7765 2075 7365 2074 6865  hence we use the
+00030f70: 2064 6963 7469 6f6e 6172 792e 0a20 2020   dictionary..   
+00030f80: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
+00030f90: 7820 3d20 7265 7370 2e5f 5f64 6963 745f  x = resp.__dict_
+00030fa0: 5f0a 2020 2020 2020 2020 2020 2020 6a73  _.            js
+00030fb0: 6f6e 5f6d 6178 2e75 7064 6174 6528 7b22  on_max.update({"
+00030fc0: 7573 6572 5f69 6422 3a20 7573 6572 5f69  user_id": user_i
+00030fd0: 647d 2920 2023 2061 6464 2064 6963 7420  d})  # add dict 
+00030fe0: 6974 656d 730a 2020 2020 2020 2020 2020  items.          
+00030ff0: 2020 6a73 6f6e 5f20 3d20 6a73 6f6e 5f6d    json_ = json_m
+00031000: 6178 2e63 6f70 7928 290a 2020 2020 2020  ax.copy().      
+00031010: 2020 2020 2020 6a73 6f6e 5f2e 706f 7028        json_.pop(
+00031020: 2274 7261 6e73 706f 7274 5f72 6573 706f  "transport_respo
+00031030: 6e73 6522 290a 2020 2020 2020 2020 2020  nse").          
+00031040: 2020 6a73 6f6e 5f73 7065 6320 3d20 4e6f    json_spec = No
+00031050: 6e65 0a20 2020 2020 2020 2020 2020 2070  ne.            p
+00031060: 7269 6e74 5f6f 7574 7075 7428 0a20 2020  rint_output(.   
+00031070: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
+00031080: 7061 2e6f 7574 7075 742c 0a20 2020 2020  pa.output,.     
+00031090: 2020 2020 2020 2020 2020 2074 6578 743d             text=
+000310a0: 7465 7874 2c0a 2020 2020 2020 2020 2020  text,.          
+000310b0: 2020 2020 2020 6a73 6f6e 5f3d 6a73 6f6e        json_=json
+000310c0: 5f2c 0a20 2020 2020 2020 2020 2020 2020  _,.             
+000310d0: 2020 206a 736f 6e5f 6d61 783d 6a73 6f6e     json_max=json
+000310e0: 5f6d 6178 2c0a 2020 2020 2020 2020 2020  _max,.          
+000310f0: 2020 2020 2020 6a73 6f6e 5f73 7065 633d        json_spec=
+00031100: 6a73 6f6e 5f73 7065 632c 0a20 2020 2020  json_spec,.     
+00031110: 2020 2020 2020 2029 0a0a 0a61 7379 6e63         )...async
+00031120: 2064 6566 2061 6374 696f 6e5f 726f 6f6d   def action_room
+00031130: 5f67 6574 5f76 6973 6962 696c 6974 7928  _get_visibility(
+00031140: 0a20 2020 2063 6c69 656e 743a 2041 7379  .    client: Asy
+00031150: 6e63 436c 6965 6e74 2c20 6372 6564 656e  ncClient, creden
+00031160: 7469 616c 733a 2064 6963 740a 2920 2d3e  tials: dict.) ->
+00031170: 204e 6f6e 653a 0a20 2020 2022 2222 4765   None:.    """Ge
+00031180: 7420 7669 7369 6269 6c69 7479 206f 6620  t visibility of 
+00031190: 726f 6f6d 2873 2920 7768 696c 6520 616c  room(s) while al
+000311a0: 7265 6164 7920 6c6f 6767 6564 2069 6e2e  ready logged in.
+000311b0: 2222 220a 2020 2020 6966 2067 732e 7061  """.    if gs.pa
+000311c0: 2e72 6f6f 6d5f 6765 745f 7669 7369 6269  .room_get_visibi
+000311d0: 6c69 7479 203d 3d20 5b5d 3a0a 2020 2020  lity == []:.    
+000311e0: 2020 2020 6773 2e70 612e 726f 6f6d 5f67      gs.pa.room_g
+000311f0: 6574 5f76 6973 6962 696c 6974 792e 6170  et_visibility.ap
+00031200: 7065 6e64 2863 7265 6465 6e74 6961 6c73  pend(credentials
+00031210: 5b22 726f 6f6d 5f69 6422 5d29 2020 2320  ["room_id"])  # 
+00031220: 6465 662e 2072 6f6f 6d0a 2020 2020 666f  def. room.    fo
+00031230: 7220 726f 6f6d 5f69 6420 696e 2067 732e  r room_id in gs.
+00031240: 7061 2e72 6f6f 6d5f 6765 745f 7669 7369  pa.room_get_visi
+00031250: 6269 6c69 7479 3a0a 2020 2020 2020 2020  bility:.        
+00031260: 726f 6f6d 5f69 6420 3d20 6177 6169 7420  room_id = await 
+00031270: 6d61 705f 726f 6f6d 696e 666f 5f74 6f5f  map_roominfo_to_
+00031280: 726f 6f6d 6964 2863 6c69 656e 742c 2072  roomid(client, r
+00031290: 6f6f 6d5f 6964 290a 2020 2020 2020 2020  oom_id).        
+000312a0: 6773 2e6c 6f67 2e64 6562 7567 2866 2247  gs.log.debug(f"G
+000312b0: 6574 7469 6e67 2076 6973 6962 696c 6974  etting visibilit
+000312c0: 7920 666f 7220 726f 6f6d 207b 726f 6f6d  y for room {room
+000312d0: 5f69 647d 2e22 290a 2020 2020 2020 2020  _id}.").        
+000312e0: 7265 7370 203d 2061 7761 6974 2063 6c69  resp = await cli
+000312f0: 656e 742e 726f 6f6d 5f67 6574 5f76 6973  ent.room_get_vis
+00031300: 6962 696c 6974 7928 726f 6f6d 5f69 6429  ibility(room_id)
+00031310: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+00031320: 7374 616e 6365 2872 6573 702c 2052 6f6f  stance(resp, Roo
+00031330: 6d47 6574 5669 7369 6269 6c69 7479 5265  mGetVisibilityRe
+00031340: 7370 6f6e 7365 293a 0a20 2020 2020 2020  sponse):.       
+00031350: 2020 2020 2067 732e 6c6f 672e 696e 666f       gs.log.info
+00031360: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00031370: 2020 6622 5375 6363 6573 7366 756c 6c79    f"Successfully
+00031380: 2067 6f74 2076 6973 6962 696c 6974 7920   got visibility 
+00031390: 666f 7220 726f 6f6d 207b 7265 7370 2e72  for room {resp.r
+000313a0: 6f6f 6d5f 6964 7d3a 2022 0a20 2020 2020  oom_id}: ".     
+000313b0: 2020 2020 2020 2020 2020 2066 227b 7265             f"{re
+000313c0: 7370 2e76 6973 6962 696c 6974 797d 2e22  sp.visibility}."
+000313d0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+000313e0: 2020 2020 2020 2020 2020 2023 206f 7574             # out
+000313f0: 7075 7420 666f 726d 6174 2063 6f6e 7472  put format contr
+00031400: 6f6c 6c65 6420 7669 6120 2d2d 6f75 7470  olled via --outp
+00031410: 7574 2066 6c61 670a 2020 2020 2020 2020  ut flag.        
+00031420: 2020 2020 7465 7874 203d 2066 227b 7265      text = f"{re
+00031430: 7370 2e76 6973 6962 696c 6974 797d 7b53  sp.visibility}{S
+00031440: 4550 7d7b 726f 6f6d 5f69 647d 220a 2020  EP}{room_id}".  
+00031450: 2020 2020 2020 2020 2020 2320 4f62 6a65            # Obje
+00031460: 6374 206f 6620 7479 7065 2078 7878 5265  ct of type xxxRe
+00031470: 7370 6f6e 7365 2069 7320 6e6f 7420 4a53  sponse is not JS
+00031480: 4f4e 0a20 2020 2020 2020 2020 2020 2023  ON.            #
+00031490: 2073 6572 6961 6c69 7a61 626c 652c 2068   serializable, h
+000314a0: 656e 6365 2077 6520 7573 6520 7468 6520  ence we use the 
+000314b0: 6469 6374 696f 6e61 7279 2e0a 2020 2020  dictionary..    
+000314c0: 2020 2020 2020 2020 6a73 6f6e 5f6d 6178          json_max
+000314d0: 203d 2072 6573 702e 5f5f 6469 6374 5f5f   = resp.__dict__
+000314e0: 0a20 2020 2020 2020 2020 2020 2023 206a  .            # j
+000314f0: 736f 6e5f 6d61 782e 7570 6461 7465 287b  son_max.update({
+00031500: 226b 6579 223a 2076 616c 7565 7d29 2020  "key": value})  
+00031510: 2320 6164 6420 6469 6374 2069 7465 6d73  # add dict items
+00031520: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
+00031530: 6e5f 203d 206a 736f 6e5f 6d61 782e 636f  n_ = json_max.co
+00031540: 7079 2829 0a20 2020 2020 2020 2020 2020  py().           
+00031550: 206a 736f 6e5f 2e70 6f70 2822 7472 616e   json_.pop("tran
+00031560: 7370 6f72 745f 7265 7370 6f6e 7365 2229  sport_response")
+00031570: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
+00031580: 6e5f 7370 6563 203d 204e 6f6e 650a 2020  n_spec = None.  
+00031590: 2020 2020 2020 2020 2020 7072 696e 745f            print_
+000315a0: 6f75 7470 7574 280a 2020 2020 2020 2020  output(.        
+000315b0: 2020 2020 2020 2020 6773 2e70 612e 6f75          gs.pa.ou
+000315c0: 7470 7574 2c0a 2020 2020 2020 2020 2020  tput,.          
+000315d0: 2020 2020 2020 7465 7874 3d74 6578 742c        text=text,
+000315e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000315f0: 206a 736f 6e5f 3d6a 736f 6e5f 2c0a 2020   json_=json_,.  
+00031600: 2020 2020 2020 2020 2020 2020 2020 6a73                js
+00031610: 6f6e 5f6d 6178 3d6a 736f 6e5f 6d61 782c  on_max=json_max,
+00031620: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00031630: 206a 736f 6e5f 7370 6563 3d6a 736f 6e5f   json_spec=json_
+00031640: 7370 6563 2c0a 2020 2020 2020 2020 2020  spec,.          
+00031650: 2020 290a 2020 2020 2020 2020 656c 7365    ).        else
+00031660: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
+00031670: 2e6c 6f67 2e65 7272 6f72 280a 2020 2020  .log.error(.    
+00031680: 2020 2020 2020 2020 2020 2020 2245 3230              "E20
+00031690: 373a 2022 0a20 2020 2020 2020 2020 2020  7: ".           
+000316a0: 2020 2020 2066 2246 6169 6c65 6420 6765       f"Failed ge
+000316b0: 7474 696e 6720 7669 7369 6269 6c69 7479  tting visibility
+000316c0: 2066 6f72 2072 6f6f 6d20 7b72 6f6f 6d5f   for room {room_
+000316d0: 6964 7d2e 2022 0a20 2020 2020 2020 2020  id}. ".         
+000316e0: 2020 2020 2020 2066 227b 7072 6976 6163         f"{privac
+000316f0: 795f 6669 6c74 6572 2873 7472 2872 6573  y_filter(str(res
+00031700: 7029 297d 220a 2020 2020 2020 2020 2020  p))}".          
+00031710: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00031720: 6773 2e65 7272 5f63 6f75 6e74 202b 3d20  gs.err_count += 
+00031730: 310a 2020 2020 2020 2020 2020 2020 6572  1.            er
+00031740: 726d 7367 203d 2022 4572 726f 723a 2022  rmsg = "Error: "
+00031750: 202b 2073 7472 2872 6573 702e 7374 6174   + str(resp.stat
+00031760: 7573 5f63 6f64 6529 202b 2022 2022 202b  us_code) + " " +
+00031770: 2072 6573 702e 6d65 7373 6167 650a 2020   resp.message.  
+00031780: 2020 2020 2020 2020 2020 2320 6f75 7470            # outp
+00031790: 7574 2066 6f72 6d61 7420 636f 6e74 726f  ut format contro
+000317a0: 6c6c 6564 2076 6961 202d 2d6f 7574 7075  lled via --outpu
+000317b0: 7420 666c 6167 0a20 2020 2020 2020 2020  t flag.         
+000317c0: 2020 2023 2066 6f72 204a 534f 4e20 7468     # for JSON th
+000317d0: 6520 7573 6572 2063 616e 2064 6574 6572  e user can deter
+000317e0: 6d69 6e65 2077 6869 6368 206f 6e65 2066  mine which one f
+000317f0: 726f 6d20 7468 6520 6c69 7374 0a20 2020  rom the list.   
+00031800: 2020 2020 2020 2020 2023 2077 6173 2073           # was s
+00031810: 7563 6365 7373 6675 6c20 616e 6420 7768  uccessful and wh
+00031820: 6963 6820 6f6e 6520 6661 696c 6564 2e20  ich one failed. 
+00031830: 466f 7220 3420 696e 7075 7473 2074 6865  For 4 inputs the
+00031840: 7265 0a20 2020 2020 2020 2020 2020 2023  re.            #
+00031850: 206d 6967 6874 206f 6e6c 7920 6265 2033   might only be 3
+00031860: 206f 7574 7075 7420 4a53 4f4e 206f 626a   output JSON obj
+00031870: 6563 7473 2069 6620 7468 6572 6520 7761  ects if there wa
+00031880: 7320 3120 6572 726f 722e 0a20 2020 2020  s 1 error..     
+00031890: 2020 2020 2020 2023 2049 6e20 7465 7874         # In text
+000318a0: 206d 6f64 6520 7765 2070 7269 6e74 2074   mode we print t
+000318b0: 6869 7320 6572 726f 7220 6c69 6e65 2c20  his error line, 
+000318c0: 736f 2074 6861 7420 666f 7220 3420 696e  so that for 4 in
+000318d0: 7075 7473 0a20 2020 2020 2020 2020 2020  puts.           
+000318e0: 2023 2074 6865 7265 2077 696c 6c20 6265   # there will be
+000318f0: 2034 206f 7574 7075 7420 6c69 6e65 732e   4 output lines.
+00031900: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+00031910: 6e74 5f6f 7574 7075 7428 0a20 2020 2020  nt_output(.     
+00031920: 2020 2020 2020 2020 2020 2067 732e 7061             gs.pa
+00031930: 2e6f 7574 7075 742c 0a20 2020 2020 2020  .output,.       
+00031940: 2020 2020 2020 2020 2074 6578 743d 2866           text=(f
+00031950: 227b 6572 726d 7367 7d7b 5345 507d 7b72  "{errmsg}{SEP}{r
+00031960: 6f6f 6d5f 6964 7d22 292c 0a20 2020 2020  oom_id}"),.     
+00031970: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+00031980: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
+00031990: 2020 2020 2020 206a 736f 6e5f 6d61 783d         json_max=
+000319a0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+000319b0: 2020 2020 2020 6a73 6f6e 5f73 7065 633d        json_spec=
+000319c0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+000319d0: 2020 290a 0a0a 6173 796e 6320 6465 6620    )...async def 
+000319e0: 6163 7469 6f6e 5f72 6f6f 6d5f 6765 745f  action_room_get_
+000319f0: 7374 6174 6528 0a20 2020 2063 6c69 656e  state(.    clien
+00031a00: 743a 2041 7379 6e63 436c 6965 6e74 2c20  t: AsyncClient, 
+00031a10: 6372 6564 656e 7469 616c 733a 2064 6963  credentials: dic
+00031a20: 740a 2920 2d3e 204e 6f6e 653a 0a20 2020  t.) -> None:.   
+00031a30: 2022 2222 4765 7420 7374 6174 6520 6f66   """Get state of
+00031a40: 2072 6f6f 6d28 7329 2077 6869 6c65 2061   room(s) while a
+00031a50: 6c72 6561 6479 206c 6f67 6765 6420 696e  lready logged in
+00031a60: 2e22 2222 0a20 2020 2069 6620 6773 2e70  .""".    if gs.p
+00031a70: 612e 726f 6f6d 5f67 6574 5f73 7461 7465  a.room_get_state
+00031a80: 203d 3d20 5b5d 3a0a 2020 2020 2020 2020   == []:.        
+00031a90: 6773 2e70 612e 726f 6f6d 5f67 6574 5f73  gs.pa.room_get_s
+00031aa0: 7461 7465 2e61 7070 656e 6428 6372 6564  tate.append(cred
+00031ab0: 656e 7469 616c 735b 2272 6f6f 6d5f 6964  entials["room_id
+00031ac0: 225d 2920 2023 2064 6566 6175 6c74 2072  "])  # default r
+00031ad0: 6f6f 6d0a 2020 2020 666f 7220 726f 6f6d  oom.    for room
+00031ae0: 5f69 6420 696e 2067 732e 7061 2e72 6f6f  _id in gs.pa.roo
+00031af0: 6d5f 6765 745f 7374 6174 653a 0a20 2020  m_get_state:.   
+00031b00: 2020 2020 2072 6f6f 6d5f 6964 203d 2061       room_id = a
+00031b10: 7761 6974 206d 6170 5f72 6f6f 6d69 6e66  wait map_roominf
+00031b20: 6f5f 746f 5f72 6f6f 6d69 6428 636c 6965  o_to_roomid(clie
+00031b30: 6e74 2c20 726f 6f6d 5f69 6429 0a20 2020  nt, room_id).   
+00031b40: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
+00031b50: 6728 6622 4765 7474 696e 6720 7669 7369  g(f"Getting visi
+00031b60: 6269 6c69 7479 2066 6f72 2072 6f6f 6d20  bility for room 
+00031b70: 7b72 6f6f 6d5f 6964 7d2e 2229 0a20 2020  {room_id}.").   
+00031b80: 2020 2020 2072 6573 7020 3d20 6177 6169       resp = awai
+00031b90: 7420 636c 6965 6e74 2e72 6f6f 6d5f 6765  t client.room_ge
+00031ba0: 745f 7374 6174 6528 726f 6f6d 5f69 6429  t_state(room_id)
+00031bb0: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+00031bc0: 7374 616e 6365 2872 6573 702c 2052 6f6f  stance(resp, Roo
+00031bd0: 6d47 6574 5374 6174 6552 6573 706f 6e73  mGetStateRespons
+00031be0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+00031bf0: 6773 2e6c 6f67 2e69 6e66 6f28 0a20 2020  gs.log.info(.   
+00031c00: 2020 2020 2020 2020 2020 2020 2066 2253               f"S
+00031c10: 7563 6365 7373 6675 6c6c 7920 676f 7420  uccessfully got 
+00031c20: 7374 6174 6520 666f 7220 726f 6f6d 207b  state for room {
+00031c30: 7265 7370 2e72 6f6f 6d5f 6964 7d3a 2022  resp.room_id}: "
+00031c40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00031c50: 2066 227b 7265 7370 2e65 7665 6e74 737d   f"{resp.events}
+00031c60: 2e22 0a20 2020 2020 2020 2020 2020 2029  .".            )
+00031c70: 0a20 2020 2020 2020 2020 2020 2023 206f  .            # o
+00031c80: 7574 7075 7420 666f 726d 6174 2063 6f6e  utput format con
+00031c90: 7472 6f6c 6c65 6420 7669 6120 2d2d 6f75  trolled via --ou
+00031ca0: 7470 7574 2066 6c61 670a 2020 2020 2020  tput flag.      
+00031cb0: 2020 2020 2020 7465 7874 203d 2066 227b        text = f"{
+00031cc0: 7265 7370 2e65 7665 6e74 737d 7b53 4550  resp.events}{SEP
+00031cd0: 7d7b 726f 6f6d 5f69 647d 220a 2020 2020  }{room_id}".    
+00031ce0: 2020 2020 2020 2020 2320 4f62 6a65 6374          # Object
+00031cf0: 206f 6620 7479 7065 2078 7878 5265 7370   of type xxxResp
+00031d00: 6f6e 7365 2069 7320 6e6f 7420 4a53 4f4e  onse is not JSON
+00031d10: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
+00031d20: 6572 6961 6c69 7a61 626c 652c 2068 656e  erializable, hen
+00031d30: 6365 2077 6520 7573 6520 7468 6520 6469  ce we use the di
+00031d40: 6374 696f 6e61 7279 2e0a 2020 2020 2020  ctionary..      
+00031d50: 2020 2020 2020 6a73 6f6e 5f6d 6178 203d        json_max =
+00031d60: 2072 6573 702e 5f5f 6469 6374 5f5f 0a20   resp.__dict__. 
+00031d70: 2020 2020 2020 2020 2020 2023 206a 736f             # jso
+00031d80: 6e5f 6d61 782e 7570 6461 7465 287b 226b  n_max.update({"k
+00031d90: 6579 223a 2076 616c 7565 7d29 2020 2320  ey": value})  # 
+00031da0: 6164 6420 6469 6374 2069 7465 6d73 0a20  add dict items. 
+00031db0: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+00031dc0: 203d 206a 736f 6e5f 6d61 782e 636f 7079   = json_max.copy
+00031dd0: 2829 0a20 2020 2020 2020 2020 2020 206a  ().            j
+00031de0: 736f 6e5f 2e70 6f70 2822 7472 616e 7370  son_.pop("transp
+00031df0: 6f72 745f 7265 7370 6f6e 7365 2229 0a20  ort_response"). 
+00031e00: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+00031e10: 7370 6563 203d 204e 6f6e 650a 2020 2020  spec = None.    
+00031e20: 2020 2020 2020 2020 7072 696e 745f 6f75          print_ou
+00031e30: 7470 7574 280a 2020 2020 2020 2020 2020  tput(.          
+00031e40: 2020 2020 2020 6773 2e70 612e 6f75 7470        gs.pa.outp
+00031e50: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
+00031e60: 2020 2020 7465 7874 3d74 6578 742c 0a20      text=text,. 
+00031e70: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+00031e80: 736f 6e5f 3d6a 736f 6e5f 2c0a 2020 2020  son_=json_,.    
+00031e90: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+00031ea0: 5f6d 6178 3d6a 736f 6e5f 6d61 782c 0a20  _max=json_max,. 
+00031eb0: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+00031ec0: 736f 6e5f 7370 6563 3d6a 736f 6e5f 7370  son_spec=json_sp
+00031ed0: 6563 2c0a 2020 2020 2020 2020 2020 2020  ec,.            
+00031ee0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00031ef0: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+00031f00: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
+00031f10: 2020 2020 2020 2020 2020 2245 3230 383a            "E208:
+00031f20: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00031f30: 2020 2066 2246 6169 6c65 6420 6765 7474     f"Failed gett
+00031f40: 696e 6720 7374 6174 6520 666f 7220 726f  ing state for ro
+00031f50: 6f6d 207b 726f 6f6d 5f69 647d 2e20 220a  om {room_id}. ".
+00031f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031f70: 6622 7b70 7269 7661 6379 5f66 696c 7465  f"{privacy_filte
+00031f80: 7228 7374 7228 7265 7370 2929 7d22 0a20  r(str(resp))}". 
+00031f90: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00031fa0: 2020 2020 2020 2020 2067 732e 6572 725f           gs.err_
+00031fb0: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
+00031fc0: 2020 2020 2020 2065 7272 6d73 6720 3d20         errmsg = 
+00031fd0: 2245 7272 6f72 3a20 2220 2b20 7374 7228  "Error: " + str(
+00031fe0: 7265 7370 2e73 7461 7475 735f 636f 6465  resp.status_code
+00031ff0: 2920 2b20 2220 2220 2b20 7265 7370 2e6d  ) + " " + resp.m
+00032000: 6573 7361 6765 0a20 2020 2020 2020 2020  essage.         
+00032010: 2020 2023 206f 7574 7075 7420 666f 726d     # output form
+00032020: 6174 2063 6f6e 7472 6f6c 6c65 6420 7669  at controlled vi
+00032030: 6120 2d2d 6f75 7470 7574 2066 6c61 670a  a --output flag.
+00032040: 2020 2020 2020 2020 2020 2020 2320 666f              # fo
+00032050: 7220 4a53 4f4e 2074 6865 2075 7365 7220  r JSON the user 
+00032060: 6361 6e20 6465 7465 726d 696e 6520 7768  can determine wh
+00032070: 6963 6820 6f6e 6520 6672 6f6d 2074 6865  ich one from the
+00032080: 206c 6973 740a 2020 2020 2020 2020 2020   list.          
+00032090: 2020 2320 7761 7320 7375 6363 6573 7366    # was successf
+000320a0: 756c 2061 6e64 2077 6869 6368 206f 6e65  ul and which one
+000320b0: 2066 6169 6c65 642e 2046 6f72 2034 2069   failed. For 4 i
+000320c0: 6e70 7574 7320 7468 6572 650a 2020 2020  nputs there.    
+000320d0: 2020 2020 2020 2020 2320 6d69 6768 7420          # might 
+000320e0: 6f6e 6c79 2062 6520 3320 6f75 7470 7574  only be 3 output
+000320f0: 204a 534f 4e20 6f62 6a65 6374 7320 6966   JSON objects if
+00032100: 2074 6865 7265 2077 6173 2031 2065 7272   there was 1 err
+00032110: 6f72 2e0a 2020 2020 2020 2020 2020 2020  or..            
+00032120: 2320 496e 2074 6578 7420 6d6f 6465 2077  # In text mode w
+00032130: 6520 7072 696e 7420 7468 6973 2065 7272  e print this err
+00032140: 6f72 206c 696e 652c 2073 6f20 7468 6174  or line, so that
+00032150: 2066 6f72 2034 2069 6e70 7574 730a 2020   for 4 inputs.  
+00032160: 2020 2020 2020 2020 2020 2320 7468 6572            # ther
+00032170: 6520 7769 6c6c 2062 6520 3420 6f75 7470  e will be 4 outp
+00032180: 7574 206c 696e 6573 2e0a 2020 2020 2020  ut lines..      
+00032190: 2020 2020 2020 7072 696e 745f 6f75 7470        print_outp
+000321a0: 7574 280a 2020 2020 2020 2020 2020 2020  ut(.            
+000321b0: 2020 2020 6773 2e70 612e 6f75 7470 7574      gs.pa.output
+000321c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000321d0: 2020 7465 7874 3d28 6622 7b65 7272 6d73    text=(f"{errms
+000321e0: 677d 7b53 4550 7d7b 726f 6f6d 5f69 647d  g}{SEP}{room_id}
+000321f0: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+00032200: 2020 2020 6a73 6f6e 5f3d 4e6f 6e65 2c0a      json_=None,.
+00032210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032220: 6a73 6f6e 5f6d 6178 3d4e 6f6e 652c 0a20  json_max=None,. 
+00032230: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+00032240: 736f 6e5f 7370 6563 3d4e 6f6e 652c 0a20  son_spec=None,. 
+00032250: 2020 2020 2020 2020 2020 2029 0a0a 0a61             )...a
+00032260: 7379 6e63 2064 6566 2061 6374 696f 6e5f  sync def action_
+00032270: 6465 6c65 7465 5f64 6576 6963 6528 636c  delete_device(cl
+00032280: 6965 6e74 3a20 4173 796e 6343 6c69 656e  ient: AsyncClien
+00032290: 742c 2063 7265 6465 6e74 6961 6c73 3a20  t, credentials: 
+000322a0: 6469 6374 2920 2d3e 204e 6f6e 653a 0a20  dict) -> None:. 
+000322b0: 2020 2022 2222 4465 6c65 7465 2064 6576     """Delete dev
+000322c0: 6963 6528 7329 2066 6f72 2069 7473 656c  ice(s) for itsel
+000322d0: 6620 6f72 206f 7468 6572 2075 7365 7220  f or other user 
+000322e0: 7768 696c 6520 616c 7265 6164 7920 6c6f  while already lo
+000322f0: 6767 6564 2069 6e2e 0a0a 2020 2020 466f  gged in...    Fo
+00032300: 7220 646f 6375 6d65 6e74 6174 696f 6e20  r documentation 
+00032310: 7265 6164 3a0a 2020 2020 6874 7470 733a  read:.    https:
+00032320: 2f2f 6d61 7472 6978 2d6e 696f 2e72 6561  //matrix-nio.rea
+00032330: 6474 6865 646f 6373 2e69 6f2f 656e 2f6c  dthedocs.io/en/l
+00032340: 6174 6573 742f 6e69 6f2e 6874 6d6c 2361  atest/nio.html#a
+00032350: 7379 6e63 636c 6965 6e74 0a20 2020 2068  syncclient.    h
+00032360: 7474 7073 3a2f 2f6d 6174 7269 782e 6f72  ttps://matrix.or
+00032370: 672f 646f 6373 2f73 7065 632f 636c 6965  g/docs/spec/clie
+00032380: 6e74 5f73 6572 7665 722f 7230 2e36 2e30  nt_server/r0.6.0
+00032390: 2361 7574 6865 6e74 6963 6174 696f 6e2d  #authentication-
+000323a0: 7479 7065 730a 0a20 2020 2054 6865 7265  types..    There
+000323b0: 2061 7265 2073 6576 6572 616c 2077 6179   are several way
+000323c0: 7320 746f 2061 7574 6865 6e74 6963 6174  s to authenticat
+000323d0: 652c 2073 6f6d 6520 6f66 2074 6865 7365  e, some of these
+000323e0: 2077 6179 7320 6d61 7920 6f72 206d 6179   ways may or may
+000323f0: 206e 6f74 0a20 2020 2062 6520 7375 7070   not.    be supp
+00032400: 6f72 7465 6420 6279 2074 6865 2073 6572  orted by the ser
+00032410: 7665 722e 2053 6f2c 2074 6869 7320 6973  ver. So, this is
+00032420: 2073 6572 7665 7220 7370 6563 6966 6963   server specific
+00032430: 2e0a 2020 2020 5468 6520 226d 2e6c 6f67  ..    The "m.log
+00032440: 696e 2e74 6f6b 656e 2220 6f70 7469 6f6e  in.token" option
+00032450: 2073 6565 6d73 2075 7365 6675 6c20 6174   seems useful at
+00032460: 2066 6972 7374 2067 6c61 6e63 652c 2062   first glance, b
+00032470: 7574 206e 6f74 6520 7468 6174 0a20 2020  ut note that.   
+00032480: 2074 6869 7320 6973 204e 4f54 2061 6e20   this is NOT an 
+00032490: 6163 6365 7373 2074 6f6b 656e 2c20 6275  access token, bu
+000324a0: 7420 6120 6c6f 6769 6e20 746f 6b65 6e20  t a login token 
+000324b0: 7265 6365 6976 6564 2066 726f 6d20 736f  received from so
+000324c0: 6d65 7768 6572 650a 2020 2020 656c 7365  mewhere.    else
+000324d0: 2e20 536f 2c20 696e 2072 6561 6c69 7479  . So, in reality
+000324e0: 2074 6865 2022 6d2e 6c6f 6769 6e2e 746f   the "m.login.to
+000324f0: 6b65 6e22 206f 7074 696f 6e20 6973 206e  ken" option is n
+00032500: 6f74 2075 7365 6675 6c2e 0a20 2020 207b  ot useful..    {
+00032510: 0a20 2020 2020 2022 7479 7065 223a 2022  .      "type": "
+00032520: 6d2e 6c6f 6769 6e2e 746f 6b65 6e22 2c0a  m.login.token",.
+00032530: 2020 2020 2020 2274 6f6b 656e 223a 2022        "token": "
+00032540: 3c74 6f6b 656e 3e22 2c20 203c 3d3d 2074  <token>",  <== t
+00032550: 6869 7320 6973 2061 206c 6f67 696e 2074  his is a login t
+00032560: 6f6b 656e 2c20 4e4f 5420 616e 2061 6363  oken, NOT an acc
+00032570: 6573 7320 746f 6b65 6e21 0a20 2020 2020  ess token!.     
+00032580: 2022 7478 6e5f 6964 223a 2022 3c63 6c69   "txn_id": "<cli
+00032590: 656e 7420 6765 6e65 7261 7465 6420 6e6f  ent generated no
+000325a0: 6e63 653e 222c 0a20 2020 2020 2022 7365  nce>",.      "se
+000325b0: 7373 696f 6e22 3a20 223c 7365 7373 696f  ssion": "<sessio
+000325c0: 6e20 4944 3e22 0a20 2020 207d 0a0a 2020  n ID>".    }..  
+000325d0: 2020 5468 6520 226d 2e6c 6f67 696e 2e73    The "m.login.s
+000325e0: 736f 2220 6f70 7469 6f6e 2077 6f75 6c64  so" option would
+000325f0: 2062 6520 7573 6566 756c 2c20 6275 7420   be useful, but 
+00032600: 4920 6861 7665 6e27 7420 696d 706c 656d  I haven't implem
+00032610: 656e 7465 6420 6974 0a20 2020 2079 6574  ented it.    yet
+00032620: 2e20 4974 2077 6f75 6c64 2062 6520 6120  . It would be a 
+00032630: 6269 7420 7369 6d69 6c61 7220 6173 2074  bit similar as t
+00032640: 6f20 7468 6520 636f 6465 2069 6e20 6163  o the code in ac
+00032650: 7469 6f6e 5f6c 6f67 696e 2829 2e0a 0a20  tion_login()... 
+00032660: 2020 2054 6865 206d 6f73 7420 636f 6d6d     The most comm
+00032670: 6f6e 206f 7074 696f 6e20 6973 2022 6d2e  on option is "m.
+00032680: 6c6f 6769 6e2e 7061 7373 776f 7264 222e  login.password".
+00032690: 2054 6869 7320 6f70 7469 6f6e 2069 7320   This option is 
+000326a0: 696d 706c 656d 656e 7465 642e 0a20 2020  implemented..   
+000326b0: 2022 2222 0a20 2020 2069 6620 6e6f 7420   """.    if not 
+000326c0: 6773 2e70 612e 7061 7373 776f 7264 3a0a  gs.pa.password:.
+000326d0: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
+000326e0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+000326f0: 2020 2245 3230 393a 2022 0a20 2020 2020    "E209: ".     
+00032700: 2020 2020 2020 2066 2246 6169 6c65 6420         f"Failed 
+00032710: 746f 2064 656c 6574 6520 6465 7669 6365  to delete device
+00032720: 7320 6265 6361 7573 6520 2d2d 7061 7373  s because --pass
+00032730: 776f 7264 2077 6173 206e 6f74 2073 6574  word was not set
+00032740: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
+00032750: 6622 287b 6773 2e70 612e 7061 7373 776f  f"({gs.pa.passwo
+00032760: 7264 7d29 220a 2020 2020 2020 2020 290a  rd})".        ).
+00032770: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
+00032780: 6f75 6e74 202b 3d20 310a 2020 2020 2020  ount += 1.      
+00032790: 2020 7265 7475 726e 0a20 2020 2065 6c73    return.    els
+000327a0: 653a 0a20 2020 2020 2020 2070 6173 7377  e:.        passw
+000327b0: 6f72 6420 3d20 6773 2e70 612e 7061 7373  ord = gs.pa.pass
+000327c0: 776f 7264 0a20 2020 2069 6620 6e6f 7420  word.    if not 
+000327d0: 6773 2e70 612e 7573 6572 3a0a 2020 2020  gs.pa.user:.    
+000327e0: 2020 2020 2320 6765 7420 7072 6573 656e      # get presen
+000327f0: 6365 206e 616d 6520 6f66 206d 7973 656c  ce name of mysel
+00032800: 660a 2020 2020 2020 2020 7573 6572 5f69  f.        user_i
+00032810: 6420 3d20 6372 6564 656e 7469 616c 735b  d = credentials[
+00032820: 2275 7365 725f 6964 225d 0a20 2020 2065  "user_id"].    e
+00032830: 6c73 653a 0a20 2020 2020 2020 2075 7365  lse:.        use
+00032840: 725f 6964 203d 2067 732e 7061 2e75 7365  r_id = gs.pa.use
+00032850: 725b 305d 0a20 2020 2020 2020 2069 6620  r[0].        if 
+00032860: 6c65 6e28 6773 2e70 612e 7573 6572 2920  len(gs.pa.user) 
+00032870: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
+00032880: 2067 732e 6c6f 672e 7761 726e 696e 6728   gs.log.warning(
+00032890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000328a0: 2022 5731 3039 3a20 220a 2020 2020 2020   "W109: ".      
+000328b0: 2020 2020 2020 2020 2020 2257 6172 6e69            "Warni
+000328c0: 6e67 2e20 220a 2020 2020 2020 2020 2020  ng. ".          
+000328d0: 2020 2020 2020 222d 2d75 7365 7220 7370        "--user sp
+000328e0: 6563 6966 6965 7320 6d6f 7265 2074 6865  ecifies more the
+000328f0: 6e20 6f6e 6520 7573 6572 2e20 4966 202d  n one user. If -
+00032900: 2d75 7365 7220 6973 2075 7365 6420 6174  -user is used at
+00032910: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00032920: 2020 2022 616c 6c2c 2074 6865 6e20 6578     "all, then ex
+00032930: 6163 746c 7920 6f6e 6520 7573 6572 2073  actly one user s
+00032940: 686f 756c 6420 6265 2067 6976 656e 2e22  hould be given."
+00032950: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00032960: 2020 2020 2020 2020 2020 2067 732e 7761             gs.wa
+00032970: 726e 5f63 6f75 6e74 202b 3d20 310a 2020  rn_count += 1.  
+00032980: 2020 6465 7669 6365 7320 3d20 6773 2e70    devices = gs.p
+00032990: 612e 6465 6c65 7465 5f64 6576 6963 650a  a.delete_device.
+000329a0: 2020 2020 2320 7468 6973 2061 7574 6f6d      # this autom
+000329b0: 6174 6963 616c 6c79 2065 7363 6170 6573  atically escapes
+000329c0: 2074 6865 2022 206c 6574 7465 7273 2069   the " letters i
+000329d0: 6e20 7468 6520 7061 7373 776f 7264 2c0a  n the password,.
+000329e0: 2020 2020 2320 616e 6420 7461 6b65 7320      # and takes 
+000329f0: 6361 7265 206f 6620 7370 6163 6573 2c20  care of spaces, 
+00032a00: 6574 632e 0a20 2020 2061 7574 6820 3d20  etc..    auth = 
+00032a10: 7b0a 2020 2020 2020 2020 2274 7970 6522  {.        "type"
+00032a20: 3a20 226d 2e6c 6f67 696e 2e70 6173 7377  : "m.login.passw
+00032a30: 6f72 6422 2c0a 2020 2020 2020 2020 2269  ord",.        "i
+00032a40: 6465 6e74 6966 6965 7222 3a20 7b22 7479  dentifier": {"ty
+00032a50: 7065 223a 2022 6d2e 6964 2e75 7365 7222  pe": "m.id.user"
+00032a60: 2c20 2275 7365 7222 3a20 7573 6572 5f69  , "user": user_i
+00032a70: 647d 2c0a 2020 2020 2020 2020 2270 6173  d},.        "pas
+00032a80: 7377 6f72 6422 3a20 7061 7373 776f 7264  sword": password
+00032a90: 2c0a 2020 2020 7d0a 2020 2020 7061 7373  ,.    }.    pass
+00032aa0: 776f 7264 6661 6b65 203d 2022 2a2a 2a22  wordfake = "***"
+00032ab0: 0a20 2020 2061 7574 6866 616b 6520 3d20  .    authfake = 
+00032ac0: 7b0a 2020 2020 2020 2020 2274 7970 6522  {.        "type"
+00032ad0: 3a20 226d 2e6c 6f67 696e 2e70 6173 7377  : "m.login.passw
+00032ae0: 6f72 6422 2c0a 2020 2020 2020 2020 2269  ord",.        "i
+00032af0: 6465 6e74 6966 6965 7222 3a20 7b22 7479  dentifier": {"ty
+00032b00: 7065 223a 2022 6d2e 6964 2e75 7365 7222  pe": "m.id.user"
+00032b10: 2c20 2275 7365 7222 3a20 7573 6572 5f69  , "user": user_i
+00032b20: 647d 2c0a 2020 2020 2020 2020 2270 6173  d},.        "pas
+00032b30: 7377 6f72 6422 3a20 7061 7373 776f 7264  sword": password
+00032b40: 6661 6b65 2c0a 2020 2020 7d0a 2020 2020  fake,.    }.    
+00032b50: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
+00032b60: 2020 2020 2020 6622 4162 6f75 7420 746f        f"About to
+00032b70: 2064 656c 6574 6520 6465 7669 6365 7320   delete devices 
+00032b80: 7b64 6576 6963 6573 7d20 666f 7220 7573  {devices} for us
+00032b90: 6572 207b 7573 6572 5f69 647d 2022 0a20  er {user_id} ". 
+00032ba0: 2020 2020 2020 2066 2277 6974 6820 7061         f"with pa
+00032bb0: 7373 776f 7264 207b 7061 7373 776f 7264  ssword {password
+00032bc0: 6661 6b65 7d20 616e 6420 6175 7468 207b  fake} and auth {
+00032bd0: 6175 7468 6661 6b65 7d2e 220a 2020 2020  authfake}.".    
+00032be0: 290a 2020 2020 7265 7370 203d 2061 7761  ).    resp = awa
+00032bf0: 6974 2063 6c69 656e 742e 6465 6c65 7465  it client.delete
+00032c00: 5f64 6576 6963 6573 2864 6576 6963 6573  _devices(devices
+00032c10: 2c20 6175 7468 290a 2020 2020 6966 2069  , auth).    if i
+00032c20: 7369 6e73 7461 6e63 6528 7265 7370 2c20  sinstance(resp, 
+00032c30: 4465 6c65 7465 4465 7669 6365 7345 7272  DeleteDevicesErr
+00032c40: 6f72 293a 0a20 2020 2020 2020 2067 732e  or):.        gs.
+00032c50: 6c6f 672e 6572 726f 7228 0a20 2020 2020  log.error(.     
+00032c60: 2020 2020 2020 2022 4532 3130 3a20 220a         "E210: ".
+00032c70: 2020 2020 2020 2020 2020 2020 6622 4661              f"Fa
+00032c80: 696c 6564 2074 6f20 6465 6c65 7465 2064  iled to delete d
+00032c90: 6576 6963 6573 207b 6465 7669 6365 737d  evices {devices}
+00032ca0: 2066 6f72 2075 7365 7220 7b75 7365 725f   for user {user_
+00032cb0: 6964 7d20 220a 2020 2020 2020 2020 2020  id} ".          
+00032cc0: 2020 6622 7769 7468 2070 6173 7377 6f72    f"with passwor
+00032cd0: 6420 7b70 6173 7377 6f72 6466 616b 657d  d {passwordfake}
+00032ce0: 2061 6e64 2061 7574 6820 7b61 7574 6866   and auth {authf
+00032cf0: 616b 657d 2e20 220a 2020 2020 2020 2020  ake}. ".        
+00032d00: 2020 2020 6622 5265 7370 6f6e 7365 3a20      f"Response: 
+00032d10: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
+00032d20: 7374 7228 7265 7370 2929 7d22 0a20 2020  str(resp))}".   
+00032d30: 2020 2020 2029 0a20 2020 2020 2020 2067       ).        g
+00032d40: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
+00032d50: 0a20 2020 2065 6c69 6620 6973 696e 7374  .    elif isinst
+00032d60: 616e 6365 2872 6573 702c 2044 656c 6574  ance(resp, Delet
+00032d70: 6544 6576 6963 6573 4175 7468 5265 7370  eDevicesAuthResp
+00032d80: 6f6e 7365 293a 0a20 2020 2020 2020 2067  onse):.        g
+00032d90: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
+00032da0: 2020 2020 2020 2020 2022 4532 3131 3a20           "E211: 
+00032db0: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
+00032dc0: 4661 696c 6564 2074 6f20 6465 6c65 7465  Failed to delete
+00032dd0: 2064 6576 6963 6573 207b 6465 7669 6365   devices {device
+00032de0: 737d 2066 6f72 2075 7365 7220 7b75 7365  s} for user {use
+00032df0: 725f 6964 7d20 6475 6520 746f 2022 0a20  r_id} due to ". 
+00032e00: 2020 2020 2020 2020 2020 2022 6175 7468             "auth
+00032e10: 656e 7469 6361 7469 6f6e 2066 6169 6c75  entication failu
+00032e20: 7265 2e20 4172 6520 796f 7520 6175 7468  re. Are you auth
+00032e30: 6f72 697a 6564 3f20 220a 2020 2020 2020  orized? ".      
+00032e40: 2020 2020 2020 6622 4175 7468 656e 7469        f"Authenti
+00032e50: 6361 7469 6f6e 3a20 7b61 7574 6866 616b  cation: {authfak
+00032e60: 657d 2c20 5265 7370 6f6e 7365 3a20 220a  e}, Response: ".
+00032e70: 2020 2020 2020 2020 2020 2020 6622 7b70              f"{p
+00032e80: 7269 7661 6379 5f66 696c 7465 7228 7374  rivacy_filter(st
+00032e90: 7228 7265 7370 2929 7d22 0a20 2020 2020  r(resp))}".     
+00032ea0: 2020 2029 0a20 2020 2020 2020 2067 732e     ).        gs.
+00032eb0: 6572 725f 636f 756e 7420 2b3d 2031 0a20  err_count += 1. 
+00032ec0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00032ed0: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
+00032ee0: 2020 2020 2020 2020 2020 2022 6465 6c65             "dele
+00032ef0: 7465 5f64 6576 6963 6573 2073 7563 6365  te_devices succe
+00032f00: 7373 6675 6c2e 2052 6573 706f 6e73 6520  ssful. Response 
+00032f10: 6973 3a20 220a 2020 2020 2020 2020 2020  is: ".          
+00032f20: 2020 6622 7b70 7269 7661 6379 5f66 696c    f"{privacy_fil
+00032f30: 7465 7228 7374 7228 7265 7370 2929 7d22  ter(str(resp))}"
+00032f40: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00032f50: 2020 2067 732e 6c6f 672e 696e 666f 280a     gs.log.info(.
+00032f60: 2020 2020 2020 2020 2020 2020 6622 5375              f"Su
+00032f70: 6363 6573 7366 756c 6c79 2064 656c 6574  ccessfully delet
+00032f80: 6564 2064 6576 6963 6573 207b 6465 7669  ed devices {devi
+00032f90: 6365 737d 2066 6f72 2075 7365 7220 7b75  ces} for user {u
+00032fa0: 7365 725f 6964 7d2e 220a 2020 2020 2020  ser_id}.".      
+00032fb0: 2020 290a 0a0a 6173 796e 6320 6465 6620    )...async def 
+00032fc0: 6163 7469 6f6e 5f72 6f6f 6d5f 7265 6461  action_room_reda
+00032fd0: 6374 2863 6c69 656e 743a 2041 7379 6e63  ct(client: Async
+00032fe0: 436c 6965 6e74 2c20 6372 6564 656e 7469  Client, credenti
+00032ff0: 616c 733a 2064 6963 7429 202d 3e20 4e6f  als: dict) -> No
+00033000: 6e65 3a0a 2020 2020 2222 2252 6564 6163  ne:.    """Redac
+00033010: 7420 6576 656e 7428 7329 206f 6620 726f  t event(s) of ro
+00033020: 6f6d 2873 2920 7768 696c 6520 616c 7265  om(s) while alre
+00033030: 6164 7920 6c6f 6767 6564 2069 6e2e 2222  ady logged in.""
+00033040: 220a 2020 2020 6966 206c 656e 2867 732e  ".    if len(gs.
+00033050: 7061 2e72 6f6f 6d5f 7265 6461 6374 2920  pa.room_redact) 
+00033060: 3d3d 2032 3a0a 2020 2020 2020 2020 6773  == 2:.        gs
+00033070: 2e70 612e 726f 6f6d 5f72 6564 6163 742e  .pa.room_redact.
+00033080: 6170 7065 6e64 2822 2229 0a20 2020 2069  append("").    i
+00033090: 6620 6e6f 7420 6c65 6e28 6773 2e70 612e  f not len(gs.pa.
+000330a0: 726f 6f6d 5f72 6564 6163 7429 2025 2033  room_redact) % 3
+000330b0: 203d 3d20 303a 0a20 2020 2020 2020 2067   == 0:.        g
+000330c0: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
+000330d0: 2020 2020 2020 2020 2022 4532 3132 3a20           "E212: 
+000330e0: 220a 2020 2020 2020 2020 2020 2020 2249  ".            "I
+000330f0: 6e63 6f72 7265 6374 206e 756d 6265 7220  ncorrect number 
+00033100: 6f66 2061 7267 756d 656e 7473 2066 6f72  of arguments for
+00033110: 202d 2d72 6f6f 6d2d 7265 6461 6374 2e20   --room-redact. 
+00033120: 4172 6775 6d65 6e74 7320 6d75 7374 2022  Arguments must "
+00033130: 0a20 2020 2020 2020 2020 2020 2066 2262  .            f"b
+00033140: 6520 7472 6970 6c65 732c 2069 2e65 2e20  e triples, i.e. 
+00033150: 6d75 6c74 6970 6c65 7320 6f66 2033 2c20  multiples of 3, 
+00033160: 6275 7420 666f 756e 6420 220a 2020 2020  but found ".    
+00033170: 2020 2020 2020 2020 6622 7b6c 656e 2867          f"{len(g
+00033180: 732e 7061 2e72 6f6f 6d5f 7265 6461 6374  s.pa.room_redact
+00033190: 297d 2061 7267 756d 656e 7473 2e20 3220  )} arguments. 2 
+000331a0: 6973 2061 6c73 6f20 616c 6c6f 7765 642e  is also allowed.
+000331b0: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
+000331c0: 2020 2020 6773 2e65 7272 5f63 6f75 6e74      gs.err_count
+000331d0: 202b 3d20 310a 2020 2020 2020 2020 7265   += 1.        re
+000331e0: 7475 726e 0a20 2020 2066 6f72 2069 6920  turn.    for ii 
+000331f0: 696e 2072 616e 6765 286c 656e 2867 732e  in range(len(gs.
+00033200: 7061 2e72 6f6f 6d5f 7265 6461 6374 2920  pa.room_redact) 
+00033210: 2f2f 2033 293a 0a20 2020 2020 2020 2072  // 3):.        r
+00033220: 6f6f 6d5f 6964 203d 2067 732e 7061 2e72  oom_id = gs.pa.r
+00033230: 6f6f 6d5f 7265 6461 6374 5b69 6920 2a20  oom_redact[ii * 
+00033240: 3320 2b20 305d 0a20 2020 2020 2020 2072  3 + 0].        r
+00033250: 6f6f 6d5f 6964 203d 2061 7761 6974 206d  oom_id = await m
+00033260: 6170 5f72 6f6f 6d69 6e66 6f5f 746f 5f72  ap_roominfo_to_r
+00033270: 6f6f 6d69 6428 636c 6965 6e74 2c20 726f  oomid(client, ro
+00033280: 6f6d 5f69 6429 0a20 2020 2020 2020 2065  om_id).        e
+00033290: 7665 6e74 5f69 6420 3d20 6773 2e70 612e  vent_id = gs.pa.
+000332a0: 726f 6f6d 5f72 6564 6163 745b 6969 202a  room_redact[ii *
+000332b0: 2033 202b 2031 5d0a 2020 2020 2020 2020   3 + 1].        
+000332c0: 7265 6173 6f6e 203d 2067 732e 7061 2e72  reason = gs.pa.r
+000332d0: 6f6f 6d5f 7265 6461 6374 5b69 6920 2a20  oom_redact[ii * 
+000332e0: 3320 2b20 325d 2e73 7472 6970 2829 0a20  3 + 2].strip(). 
+000332f0: 2020 2020 2020 2069 6620 7265 6173 6f6e         if reason
+00033300: 203d 3d20 2222 3a0a 2020 2020 2020 2020   == "":.        
+00033310: 2020 2020 7265 6173 6f6e 203d 204e 6f6e      reason = Non
+00033320: 650a 2020 2020 2020 2020 6773 2e6c 6f67  e.        gs.log
+00033330: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+00033340: 2020 2020 6622 5072 6570 6172 696e 6720      f"Preparing 
+00033350: 746f 2072 6564 6163 7420 6576 656e 7420  to redact event 
+00033360: 7b65 7665 6e74 5f69 647d 2069 6e20 726f  {event_id} in ro
+00033370: 6f6d 207b 726f 6f6d 5f69 647d 2022 0a20  om {room_id} ". 
+00033380: 2020 2020 2020 2020 2020 2066 2270 726f             f"pro
+00033390: 7669 6469 6e67 2072 6561 736f 6e20 277b  viding reason '{
+000333a0: 7265 6173 6f6e 7d27 2e22 0a20 2020 2020  reason}'.".     
+000333b0: 2020 2029 0a20 2020 2020 2020 2072 6573     ).        res
+000333c0: 7020 3d20 6177 6169 7420 636c 6965 6e74  p = await client
+000333d0: 2e72 6f6f 6d5f 7265 6461 6374 2872 6f6f  .room_redact(roo
+000333e0: 6d5f 6964 2c20 6576 656e 745f 6964 2c20  m_id, event_id, 
+000333f0: 7265 6173 6f6e 3d72 6561 736f 6e29 0a20  reason=reason). 
+00033400: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+00033410: 616e 6365 2872 6573 702c 2052 6f6f 6d52  ance(resp, RoomR
+00033420: 6564 6163 7445 7272 6f72 293a 0a20 2020  edactError):.   
+00033430: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
+00033440: 6572 726f 7228 0a20 2020 2020 2020 2020  error(.         
+00033450: 2020 2020 2020 2022 4532 3133 3a20 220a         "E213: ".
+00033460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033470: 6622 4661 696c 6564 2074 6f20 7265 6461  f"Failed to reda
+00033480: 6374 2065 7665 6e74 207b 6576 656e 745f  ct event {event_
+00033490: 6964 7d20 696e 2072 6f6f 6d20 7b72 6f6f  id} in room {roo
+000334a0: 6d5f 6964 7d20 220a 2020 2020 2020 2020  m_id} ".        
+000334b0: 2020 2020 2020 2020 6622 7769 7468 2072          f"with r
+000334c0: 6561 736f 6e20 277b 7265 6173 6f6e 7d27  eason '{reason}'
+000334d0: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
+000334e0: 2020 2020 6622 5265 7370 6f6e 7365 3a20      f"Response: 
+000334f0: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
+00033500: 7374 7228 7265 7370 2929 7d22 0a20 2020  str(resp))}".   
+00033510: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00033520: 2020 2020 2020 2067 732e 6572 725f 636f         gs.err_co
+00033530: 756e 7420 2b3d 2031 0a20 2020 2020 2020  unt += 1.       
+00033540: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00033550: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+00033560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00033570: 2022 726f 6f6d 5f72 6564 6163 7420 7375   "room_redact su
+00033580: 6363 6573 7366 756c 2e20 5265 7370 6f6e  ccessful. Respon
+00033590: 7365 2069 733a 2022 0a20 2020 2020 2020  se is: ".       
+000335a0: 2020 2020 2020 2020 2066 227b 7072 6976           f"{priv
+000335b0: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
+000335c0: 6573 7029 297d 220a 2020 2020 2020 2020  esp))}".        
+000335d0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+000335e0: 2020 6773 2e6c 6f67 2e69 6e66 6f28 0a20    gs.log.info(. 
+000335f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00033600: 2253 7563 6365 7373 6675 6c6c 7920 7265  "Successfully re
+00033610: 6461 6374 6564 2065 7665 6e74 207b 6576  dacted event {ev
+00033620: 656e 745f 6964 7d20 696e 2072 6f6f 6d20  ent_id} in room 
+00033630: 7b72 6f6f 6d5f 6964 7d20 220a 2020 2020  {room_id} ".    
+00033640: 2020 2020 2020 2020 2020 2020 6622 7072              f"pr
+00033650: 6f76 6964 696e 6720 7265 6173 6f6e 2027  oviding reason '
+00033660: 7b27 2720 6966 2072 6561 736f 6e20 6973  {'' if reason is
+00033670: 204e 6f6e 6520 656c 7365 2072 6561 736f   None else reaso
+00033680: 6e7d 272e 220a 2020 2020 2020 2020 2020  n}'.".          
+00033690: 2020 290a 0a0a 6173 796e 6320 6465 6620    )...async def 
+000336a0: 6163 7469 6f6e 5f77 686f 616d 6928 636c  action_whoami(cl
+000336b0: 6965 6e74 3a20 4173 796e 6343 6c69 656e  ient: AsyncClien
+000336c0: 742c 2063 7265 6465 6e74 6961 6c73 3a20  t, credentials: 
+000336d0: 6469 6374 2920 2d3e 204e 6f6e 653a 0a20  dict) -> None:. 
+000336e0: 2020 2022 2222 4765 7420 7573 6572 2069     """Get user i
+000336f0: 6420 7768 696c 6520 616c 7265 6164 7920  d while already 
+00033700: 6c6f 6767 6564 2069 6e2e 2222 220a 2020  logged in.""".  
+00033710: 2020 7768 6f61 6d69 203d 2063 7265 6465    whoami = crede
+00033720: 6e74 6961 6c73 5b22 7573 6572 5f69 6422  ntials["user_id"
+00033730: 5d0a 2020 2020 6773 2e6c 6f67 2e64 6562  ].    gs.log.deb
+00033740: 7567 2866 2277 686f 616d 693a 2075 7365  ug(f"whoami: use
+00033750: 7220 6964 3a20 7b77 686f 616d 697d 2229  r id: {whoami}")
+00033760: 0a20 2020 2023 206f 7574 7075 7420 666f  .    # output fo
+00033770: 726d 6174 2063 6f6e 7472 6f6c 6c65 6420  rmat controlled 
+00033780: 7669 6120 2d2d 6f75 7470 7574 2066 6c61  via --output fla
+00033790: 670a 2020 2020 7465 7874 203d 2077 686f  g.    text = who
+000337a0: 616d 690a 2020 2020 6a73 6f6e 5f6d 6178  ami.    json_max
+000337b0: 203d 207b 2275 7365 725f 6964 223a 2077   = {"user_id": w
+000337c0: 686f 616d 697d 0a20 2020 2023 206a 736f  hoami}.    # jso
+000337d0: 6e5f 6d61 782e 7570 6461 7465 287b 226b  n_max.update({"k
+000337e0: 6579 223a 2076 616c 7565 7d29 2020 2320  ey": value})  # 
+000337f0: 6164 6420 6469 6374 2069 7465 6d73 0a20  add dict items. 
+00033800: 2020 206a 736f 6e5f 203d 206a 736f 6e5f     json_ = json_
+00033810: 6d61 782e 636f 7079 2829 0a20 2020 2023  max.copy().    #
+00033820: 206a 736f 6e5f 2e70 6f70 2822 6b65 7922   json_.pop("key"
+00033830: 290a 2020 2020 6a73 6f6e 5f73 7065 6320  ).    json_spec 
+00033840: 3d20 4e6f 6e65 0a20 2020 2070 7269 6e74  = None.    print
+00033850: 5f6f 7574 7075 7428 0a20 2020 2020 2020  _output(.       
+00033860: 2067 732e 7061 2e6f 7574 7075 742c 0a20   gs.pa.output,. 
+00033870: 2020 2020 2020 2074 6578 743d 7465 7874         text=text
+00033880: 2c0a 2020 2020 2020 2020 6a73 6f6e 5f3d  ,.        json_=
+00033890: 6a73 6f6e 5f2c 0a20 2020 2020 2020 206a  json_,.        j
+000338a0: 736f 6e5f 6d61 783d 6a73 6f6e 5f6d 6178  son_max=json_max
+000338b0: 2c0a 2020 2020 2020 2020 6a73 6f6e 5f73  ,.        json_s
+000338c0: 7065 633d 6a73 6f6e 5f73 7065 632c 0a20  pec=json_spec,. 
+000338d0: 2020 2029 0a0a 0a61 7379 6e63 2064 6566     )...async def
+000338e0: 2061 6374 696f 6e5f 726f 6f6d 7365 7467   action_roomsetg
+000338f0: 6574 2829 202d 3e20 4e6f 6e65 3a0a 2020  et() -> None:.  
+00033900: 2020 2222 2250 6572 666f 726d 2072 6f6f    """Perform roo
+00033910: 6d2c 2067 6574 2c20 7365 7420 6163 7469  m, get, set acti
+00033920: 6f6e 7320 7768 696c 6520 6265 696e 6720  ons while being 
+00033930: 6c6f 6767 6564 2069 6e2e 2222 220a 2020  logged in.""".  
+00033940: 2020 6966 206e 6f74 2067 732e 636c 6965    if not gs.clie
+00033950: 6e74 2061 6e64 206e 6f74 2067 732e 6372  nt and not gs.cr
+00033960: 6564 656e 7469 616c 733a 0a20 2020 2020  edentials:.     
+00033970: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
+00033980: 0a20 2020 2020 2020 2020 2020 2022 4532  .            "E2
+00033990: 3134 3a20 2220 2243 6c69 656e 7420 6f72  14: " "Client or
+000339a0: 2063 7265 6465 6e74 6961 6c73 206e 6f74   credentials not
+000339b0: 2073 6574 2e20 536b 6970 7069 6e67 2061   set. Skipping a
+000339c0: 6374 696f 6e2e 220a 2020 2020 2020 2020  ction.".        
+000339d0: 290a 2020 2020 2020 2020 6773 2e65 7272  ).        gs.err
+000339e0: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
+000339f0: 2020 2020 7265 7475 726e 0a20 2020 2074      return.    t
+00033a00: 7279 3a0a 2020 2020 2020 2020 2320 726f  ry:.        # ro
+00033a10: 6f6d 5f61 6374 696f 6e0a 2020 2020 2020  om_action.      
+00033a20: 2020 2320 7765 2061 6c72 6561 6479 2063    # we already c
+00033a30: 6865 636b 6564 2061 7267 7320 6174 2074  hecked args at t
+00033a40: 6865 2062 6567 696e 6e69 6e67 2c20 6e6f  he beginning, no
+00033a50: 206e 6565 6420 746f 2063 6865 636b 0a20   need to check. 
+00033a60: 2020 2020 2020 2023 2072 6f6f 6d20 616e         # room an
+00033a70: 6420 7573 6572 2061 7267 756d 656e 7420  d user argument 
+00033a80: 636f 6d62 696e 6174 696f 6e73 2061 6761  combinations aga
+00033a90: 696e 2e0a 2020 2020 2020 2020 2320 726f  in..        # ro
+00033aa0: 6f6d 2073 6574 2061 6374 696f 6e73 0a20  om set actions. 
+00033ab0: 2020 2020 2020 2069 6620 6773 2e70 612e         if gs.pa.
+00033ac0: 726f 6f6d 5f63 7265 6174 653a 0a20 2020  room_create:.   
+00033ad0: 2020 2020 2020 2020 2061 7761 6974 2061           await a
+00033ae0: 6374 696f 6e5f 726f 6f6d 5f63 7265 6174  ction_room_creat
+00033af0: 6528 6773 2e63 6c69 656e 742c 2067 732e  e(gs.client, gs.
+00033b00: 6372 6564 656e 7469 616c 7329 0a20 2020  credentials).   
+00033b10: 2020 2020 2069 6620 6773 2e70 612e 726f       if gs.pa.ro
+00033b20: 6f6d 5f64 6d5f 6372 6561 7465 3a0a 2020  om_dm_create:.  
+00033b30: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+00033b40: 6163 7469 6f6e 5f72 6f6f 6d5f 646d 5f63  action_room_dm_c
+00033b50: 7265 6174 6528 6773 2e63 6c69 656e 742c  reate(gs.client,
+00033b60: 2067 732e 6372 6564 656e 7469 616c 7329   gs.credentials)
+00033b70: 0a20 2020 2020 2020 2069 6620 6773 2e70  .        if gs.p
+00033b80: 612e 726f 6f6d 5f6a 6f69 6e3a 0a20 2020  a.room_join:.   
+00033b90: 2020 2020 2020 2020 2061 7761 6974 2061           await a
+00033ba0: 6374 696f 6e5f 726f 6f6d 5f6a 6f69 6e28  ction_room_join(
+00033bb0: 6773 2e63 6c69 656e 742c 2067 732e 6372  gs.client, gs.cr
+00033bc0: 6564 656e 7469 616c 7329 0a20 2020 2020  edentials).     
+00033bd0: 2020 2069 6620 6773 2e70 612e 726f 6f6d     if gs.pa.room
+00033be0: 5f6c 6561 7665 3a0a 2020 2020 2020 2020  _leave:.        
+00033bf0: 2020 2020 6177 6169 7420 6163 7469 6f6e      await action
+00033c00: 5f72 6f6f 6d5f 6c65 6176 6528 6773 2e63  _room_leave(gs.c
+00033c10: 6c69 656e 742c 2067 732e 6372 6564 656e  lient, gs.creden
+00033c20: 7469 616c 7329 0a20 2020 2020 2020 2069  tials).        i
+00033c30: 6620 6773 2e70 612e 726f 6f6d 5f66 6f72  f gs.pa.room_for
+00033c40: 6765 743a 0a20 2020 2020 2020 2020 2020  get:.           
+00033c50: 2061 7761 6974 2061 6374 696f 6e5f 726f   await action_ro
+00033c60: 6f6d 5f66 6f72 6765 7428 6773 2e63 6c69  om_forget(gs.cli
+00033c70: 656e 742c 2067 732e 6372 6564 656e 7469  ent, gs.credenti
+00033c80: 616c 7329 0a20 2020 2020 2020 2069 6620  als).        if 
+00033c90: 6773 2e70 612e 726f 6f6d 5f69 6e76 6974  gs.pa.room_invit
+00033ca0: 6520 616e 6420 6773 2e70 612e 7573 6572  e and gs.pa.user
+00033cb0: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
+00033cc0: 6169 7420 6163 7469 6f6e 5f72 6f6f 6d5f  ait action_room_
+00033cd0: 696e 7669 7465 2867 732e 636c 6965 6e74  invite(gs.client
+00033ce0: 2c20 6773 2e63 7265 6465 6e74 6961 6c73  , gs.credentials
+00033cf0: 290a 2020 2020 2020 2020 6966 2067 732e  ).        if gs.
+00033d00: 7061 2e72 6f6f 6d5f 6261 6e20 616e 6420  pa.room_ban and 
+00033d10: 6773 2e70 612e 7573 6572 3a0a 2020 2020  gs.pa.user:.    
+00033d20: 2020 2020 2020 2020 6177 6169 7420 6163          await ac
+00033d30: 7469 6f6e 5f72 6f6f 6d5f 6261 6e28 6773  tion_room_ban(gs
+00033d40: 2e63 6c69 656e 742c 2067 732e 6372 6564  .client, gs.cred
+00033d50: 656e 7469 616c 7329 0a20 2020 2020 2020  entials).       
+00033d60: 2069 6620 6773 2e70 612e 726f 6f6d 5f75   if gs.pa.room_u
+00033d70: 6e62 616e 2061 6e64 2067 732e 7061 2e75  nban and gs.pa.u
+00033d80: 7365 723a 0a20 2020 2020 2020 2020 2020  ser:.           
+00033d90: 2061 7761 6974 2061 6374 696f 6e5f 726f   await action_ro
+00033da0: 6f6d 5f75 6e62 616e 2867 732e 636c 6965  om_unban(gs.clie
+00033db0: 6e74 2c20 6773 2e63 7265 6465 6e74 6961  nt, gs.credentia
+00033dc0: 6c73 290a 2020 2020 2020 2020 6966 2067  ls).        if g
+00033dd0: 732e 7061 2e72 6f6f 6d5f 6b69 636b 2061  s.pa.room_kick a
+00033de0: 6e64 2067 732e 7061 2e75 7365 723a 0a20  nd gs.pa.user:. 
+00033df0: 2020 2020 2020 2020 2020 2061 7761 6974             await
+00033e00: 2061 6374 696f 6e5f 726f 6f6d 5f6b 6963   action_room_kic
+00033e10: 6b28 6773 2e63 6c69 656e 742c 2067 732e  k(gs.client, gs.
+00033e20: 6372 6564 656e 7469 616c 7329 0a20 2020  credentials).   
+00033e30: 2020 2020 2069 6620 6773 2e70 612e 726f       if gs.pa.ro
+00033e40: 6f6d 5f72 6564 6163 743a 0a20 2020 2020  om_redact:.     
+00033e50: 2020 2020 2020 2061 7761 6974 2061 6374         await act
+00033e60: 696f 6e5f 726f 6f6d 5f72 6564 6163 7428  ion_room_redact(
+00033e70: 6773 2e63 6c69 656e 742c 2067 732e 6372  gs.client, gs.cr
+00033e80: 6564 656e 7469 616c 7329 0a20 2020 2020  edentials).     
+00033e90: 2020 2069 6620 6773 2e70 612e 726f 6f6d     if gs.pa.room
+00033ea0: 5f73 6574 5f61 6c69 6173 3a0a 2020 2020  _set_alias:.    
+00033eb0: 2020 2020 2020 2020 6177 6169 7420 6163          await ac
+00033ec0: 7469 6f6e 5f72 6f6f 6d5f 7365 745f 616c  tion_room_set_al
+00033ed0: 6961 7328 6773 2e63 6c69 656e 742c 2067  ias(gs.client, g
+00033ee0: 732e 6372 6564 656e 7469 616c 7329 0a20  s.credentials). 
+00033ef0: 2020 2020 2020 2069 6620 6773 2e70 612e         if gs.pa.
+00033f00: 726f 6f6d 5f64 656c 6574 655f 616c 6961  room_delete_alia
+00033f10: 733a 0a20 2020 2020 2020 2020 2020 2061  s:.            a
+00033f20: 7761 6974 2061 6374 696f 6e5f 726f 6f6d  wait action_room
+00033f30: 5f64 656c 6574 655f 616c 6961 7328 6773  _delete_alias(gs
+00033f40: 2e63 6c69 656e 742c 2067 732e 6372 6564  .client, gs.cred
+00033f50: 656e 7469 616c 7329 0a20 2020 2020 2020  entials).       
+00033f60: 2023 2072 6f6f 6d20 6765 7420 6163 7469   # room get acti
+00033f70: 6f6e 730a 2020 2020 2020 2020 6966 2067  ons.        if g
+00033f80: 732e 7061 2e72 6f6f 6d5f 6765 745f 7669  s.pa.room_get_vi
+00033f90: 7369 6269 6c69 7479 2069 7320 6e6f 7420  sibility is not 
+00033fa0: 4e6f 6e65 3a20 2023 2065 6d70 7479 205b  None:  # empty [
+00033fb0: 5d20 6d75 7374 2069 6e76 6f6b 6520 6675  ] must invoke fu
+00033fc0: 6e63 0a20 2020 2020 2020 2020 2020 2061  nc.            a
+00033fd0: 7761 6974 2061 6374 696f 6e5f 726f 6f6d  wait action_room
+00033fe0: 5f67 6574 5f76 6973 6962 696c 6974 7928  _get_visibility(
+00033ff0: 6773 2e63 6c69 656e 742c 2067 732e 6372  gs.client, gs.cr
+00034000: 6564 656e 7469 616c 7329 0a20 2020 2020  edentials).     
+00034010: 2020 2069 6620 6773 2e70 612e 726f 6f6d     if gs.pa.room
+00034020: 5f67 6574 5f73 7461 7465 2069 7320 6e6f  _get_state is no
+00034030: 7420 4e6f 6e65 3a20 2023 2065 6d70 7479  t None:  # empty
+00034040: 206c 6973 7420 6d75 7374 2069 6e76 6f6b   list must invok
+00034050: 6520 6675 6e63 0a20 2020 2020 2020 2020  e func.         
+00034060: 2020 2061 7761 6974 2061 6374 696f 6e5f     await action_
+00034070: 726f 6f6d 5f67 6574 5f73 7461 7465 2867  room_get_state(g
+00034080: 732e 636c 6965 6e74 2c20 6773 2e63 7265  s.client, gs.cre
+00034090: 6465 6e74 6961 6c73 290a 2020 2020 2020  dentials).      
+000340a0: 2020 6966 2067 732e 7061 2e72 6f6f 6d5f    if gs.pa.room_
+000340b0: 7265 736f 6c76 655f 616c 6961 733a 0a20  resolve_alias:. 
+000340c0: 2020 2020 2020 2020 2020 2061 7761 6974             await
+000340d0: 2061 6374 696f 6e5f 726f 6f6d 5f72 6573   action_room_res
+000340e0: 6f6c 7665 5f61 6c69 6173 2867 732e 636c  olve_alias(gs.cl
+000340f0: 6965 6e74 2c20 6773 2e63 7265 6465 6e74  ient, gs.credent
+00034100: 6961 6c73 290a 2020 2020 2020 2020 6966  ials).        if
+00034110: 2067 732e 726f 6f6d 5f61 6374 696f 6e3a   gs.room_action:
+00034120: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+00034130: 6c6f 672e 6465 6275 6728 2252 6f6f 6d20  log.debug("Room 
+00034140: 6163 7469 6f6e 2873 2920 7765 7265 2070  action(s) were p
+00034150: 6572 666f 726d 6564 206f 7220 6174 7465  erformed or atte
+00034160: 6d70 7465 642e 2229 0a0a 2020 2020 2020  mpted.")..      
+00034170: 2020 2320 7365 745f 6163 7469 6f6e 0a20    # set_action. 
+00034180: 2020 2020 2020 2069 6620 6773 2e70 612e         if gs.pa.
+00034190: 7365 745f 6469 7370 6c61 795f 6e61 6d65  set_display_name
+000341a0: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
+000341b0: 6169 7420 6163 7469 6f6e 5f73 6574 5f64  ait action_set_d
+000341c0: 6973 706c 6179 5f6e 616d 6528 6773 2e63  isplay_name(gs.c
+000341d0: 6c69 656e 742c 2067 732e 6372 6564 656e  lient, gs.creden
+000341e0: 7469 616c 7329 0a20 2020 2020 2020 2069  tials).        i
+000341f0: 6620 6773 2e70 612e 7365 745f 6465 7669  f gs.pa.set_devi
+00034200: 6365 5f6e 616d 653a 0a20 2020 2020 2020  ce_name:.       
+00034210: 2020 2020 2061 7761 6974 2061 6374 696f       await actio
+00034220: 6e5f 7365 745f 6465 7669 6365 5f6e 616d  n_set_device_nam
+00034230: 6528 6773 2e63 6c69 656e 742c 2067 732e  e(gs.client, gs.
+00034240: 6372 6564 656e 7469 616c 7329 0a20 2020  credentials).   
+00034250: 2020 2020 2069 6620 6773 2e70 612e 7365       if gs.pa.se
+00034260: 745f 7072 6573 656e 6365 3a0a 2020 2020  t_presence:.    
+00034270: 2020 2020 2020 2020 6177 6169 7420 6163          await ac
+00034280: 7469 6f6e 5f73 6574 5f70 7265 7365 6e63  tion_set_presenc
+00034290: 6528 6773 2e63 6c69 656e 742c 2067 732e  e(gs.client, gs.
+000342a0: 6372 6564 656e 7469 616c 7329 0a20 2020  credentials).   
+000342b0: 2020 2020 2069 6620 6773 2e70 612e 7570       if gs.pa.up
+000342c0: 6c6f 6164 3a0a 2020 2020 2020 2020 2020  load:.          
+000342d0: 2020 6177 6169 7420 6163 7469 6f6e 5f75    await action_u
+000342e0: 706c 6f61 6428 6773 2e63 6c69 656e 742c  pload(gs.client,
+000342f0: 2067 732e 6372 6564 656e 7469 616c 7329   gs.credentials)
+00034300: 0a20 2020 2020 2020 2069 6620 6773 2e70  .        if gs.p
+00034310: 612e 6465 6c65 7465 5f6d 7863 3a0a 2020  a.delete_mxc:.  
+00034320: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+00034330: 6163 7469 6f6e 5f64 656c 6574 655f 6d78  action_delete_mx
+00034340: 6328 6773 2e63 6c69 656e 742c 2067 732e  c(gs.client, gs.
+00034350: 6372 6564 656e 7469 616c 7329 0a20 2020  credentials).   
+00034360: 2020 2020 2069 6620 6773 2e70 612e 6465       if gs.pa.de
+00034370: 6c65 7465 5f6d 7863 5f62 6566 6f72 653a  lete_mxc_before:
+00034380: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+00034390: 6974 2061 6374 696f 6e5f 6465 6c65 7465  it action_delete
+000343a0: 5f6d 7863 5f62 6566 6f72 6528 6773 2e63  _mxc_before(gs.c
+000343b0: 6c69 656e 742c 2067 732e 6372 6564 656e  lient, gs.creden
+000343c0: 7469 616c 7329 0a20 2020 2020 2020 2069  tials).        i
+000343d0: 6620 6773 2e70 612e 7265 7374 3a0a 2020  f gs.pa.rest:.  
+000343e0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+000343f0: 6163 7469 6f6e 5f72 6573 7428 6773 2e63  action_rest(gs.c
+00034400: 6c69 656e 742c 2067 732e 6372 6564 656e  lient, gs.creden
+00034410: 7469 616c 7329 0a20 2020 2020 2020 2069  tials).        i
+00034420: 6620 6773 2e70 612e 7365 745f 6176 6174  f gs.pa.set_avat
+00034430: 6172 3a0a 2020 2020 2020 2020 2020 2020  ar:.            
+00034440: 6177 6169 7420 6163 7469 6f6e 5f73 6574  await action_set
+00034450: 5f61 7661 7461 7228 6773 2e63 6c69 656e  _avatar(gs.clien
+00034460: 742c 2067 732e 6372 6564 656e 7469 616c  t, gs.credential
+00034470: 7329 0a20 2020 2020 2020 2069 6620 6773  s).        if gs
+00034480: 2e70 612e 696d 706f 7274 5f6b 6579 733a  .pa.import_keys:
+00034490: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+000344a0: 6974 2061 6374 696f 6e5f 696d 706f 7274  it action_import
+000344b0: 5f6b 6579 7328 6773 2e63 6c69 656e 742c  _keys(gs.client,
+000344c0: 2067 732e 6372 6564 656e 7469 616c 7329   gs.credentials)
+000344d0: 0a20 2020 2020 2020 2069 6620 6773 2e70  .        if gs.p
+000344e0: 612e 6465 6c65 7465 5f64 6576 6963 653a  a.delete_device:
+000344f0: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+00034500: 6974 2061 6374 696f 6e5f 6465 6c65 7465  it action_delete
+00034510: 5f64 6576 6963 6528 6773 2e63 6c69 656e  _device(gs.clien
+00034520: 742c 2067 732e 6372 6564 656e 7469 616c  t, gs.credential
+00034530: 7329 0a0a 2020 2020 2020 2020 2320 6765  s)..        # ge
+00034540: 745f 6163 7469 6f6e 0a20 2020 2020 2020  t_action.       
+00034550: 2069 6620 6773 2e70 612e 6765 745f 6469   if gs.pa.get_di
+00034560: 7370 6c61 795f 6e61 6d65 3a0a 2020 2020  splay_name:.    
+00034570: 2020 2020 2020 2020 6177 6169 7420 6163          await ac
+00034580: 7469 6f6e 5f67 6574 5f64 6973 706c 6179  tion_get_display
+00034590: 5f6e 616d 6528 6773 2e63 6c69 656e 742c  _name(gs.client,
+000345a0: 2067 732e 6372 6564 656e 7469 616c 7329   gs.credentials)
+000345b0: 0a20 2020 2020 2020 2069 6620 6773 2e70  .        if gs.p
+000345c0: 612e 6765 745f 7072 6573 656e 6365 3a0a  a.get_presence:.
+000345d0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+000345e0: 7420 6163 7469 6f6e 5f67 6574 5f70 7265  t action_get_pre
+000345f0: 7365 6e63 6528 6773 2e63 6c69 656e 742c  sence(gs.client,
+00034600: 2067 732e 6372 6564 656e 7469 616c 7329   gs.credentials)
+00034610: 0a20 2020 2020 2020 2069 6620 6773 2e70  .        if gs.p
+00034620: 612e 646f 776e 6c6f 6164 3a0a 2020 2020  a.download:.    
+00034630: 2020 2020 2020 2020 6177 6169 7420 6163          await ac
+00034640: 7469 6f6e 5f64 6f77 6e6c 6f61 6428 6773  tion_download(gs
+00034650: 2e63 6c69 656e 742c 2067 732e 6372 6564  .client, gs.cred
+00034660: 656e 7469 616c 7329 0a20 2020 2020 2020  entials).       
+00034670: 2069 6620 6773 2e70 612e 6a6f 696e 6564   if gs.pa.joined
+00034680: 5f72 6f6f 6d73 3a0a 2020 2020 2020 2020  _rooms:.        
+00034690: 2020 2020 6177 6169 7420 6163 7469 6f6e      await action
+000346a0: 5f6a 6f69 6e65 645f 726f 6f6d 7328 6773  _joined_rooms(gs
+000346b0: 2e63 6c69 656e 742c 2067 732e 6372 6564  .client, gs.cred
+000346c0: 656e 7469 616c 7329 0a20 2020 2020 2020  entials).       
+000346d0: 2069 6620 6773 2e70 612e 6a6f 696e 6564   if gs.pa.joined
+000346e0: 5f6d 656d 6265 7273 3a0a 2020 2020 2020  _members:.      
+000346f0: 2020 2020 2020 6177 6169 7420 6163 7469        await acti
+00034700: 6f6e 5f6a 6f69 6e65 645f 6d65 6d62 6572  on_joined_member
+00034710: 7328 6773 2e63 6c69 656e 742c 2067 732e  s(gs.client, gs.
+00034720: 6372 6564 656e 7469 616c 7329 0a20 2020  credentials).   
+00034730: 2020 2020 2069 6620 6773 2e70 612e 6d78       if gs.pa.mx
+00034740: 635f 746f 5f68 7474 703a 0a20 2020 2020  c_to_http:.     
+00034750: 2020 2020 2020 2061 7761 6974 2061 6374         await act
+00034760: 696f 6e5f 6d78 635f 746f 5f68 7474 7028  ion_mxc_to_http(
+00034770: 6773 2e63 6c69 656e 742c 2067 732e 6372  gs.client, gs.cr
+00034780: 6564 656e 7469 616c 7329 0a20 2020 2020  edentials).     
+00034790: 2020 2069 6620 6773 2e70 612e 6465 7669     if gs.pa.devi
+000347a0: 6365 733a 0a20 2020 2020 2020 2020 2020  ces:.           
+000347b0: 2061 7761 6974 2061 6374 696f 6e5f 6465   await action_de
+000347c0: 7669 6365 7328 6773 2e63 6c69 656e 742c  vices(gs.client,
+000347d0: 2067 732e 6372 6564 656e 7469 616c 7329   gs.credentials)
+000347e0: 0a20 2020 2020 2020 2069 6620 6773 2e70  .        if gs.p
+000347f0: 612e 6469 7363 6f76 6572 795f 696e 666f  a.discovery_info
+00034800: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
+00034810: 6169 7420 6163 7469 6f6e 5f64 6973 636f  ait action_disco
+00034820: 7665 7279 5f69 6e66 6f28 6773 2e63 6c69  very_info(gs.cli
+00034830: 656e 742c 2067 732e 6372 6564 656e 7469  ent, gs.credenti
+00034840: 616c 7329 0a20 2020 2020 2020 2069 6620  als).        if 
+00034850: 6773 2e70 612e 6c6f 6769 6e5f 696e 666f  gs.pa.login_info
+00034860: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
+00034870: 6169 7420 6163 7469 6f6e 5f6c 6f67 696e  ait action_login
+00034880: 5f69 6e66 6f28 6773 2e63 6c69 656e 742c  _info(gs.client,
+00034890: 2067 732e 6372 6564 656e 7469 616c 7329   gs.credentials)
+000348a0: 0a20 2020 2020 2020 2069 6620 6773 2e70  .        if gs.p
+000348b0: 612e 636f 6e74 656e 745f 7265 706f 7369  a.content_reposi
+000348c0: 746f 7279 5f63 6f6e 6669 673a 0a20 2020  tory_config:.   
+000348d0: 2020 2020 2020 2020 2061 7761 6974 2061           await a
+000348e0: 6374 696f 6e5f 636f 6e74 656e 745f 7265  ction_content_re
+000348f0: 706f 7369 746f 7279 5f63 6f6e 6669 6728  pository_config(
+00034900: 6773 2e63 6c69 656e 742c 2067 732e 6372  gs.client, gs.cr
+00034910: 6564 656e 7469 616c 7329 0a20 2020 2020  edentials).     
+00034920: 2020 2069 6620 6773 2e70 612e 6765 745f     if gs.pa.get_
+00034930: 6176 6174 6172 2069 7320 6e6f 7420 4e6f  avatar is not No
+00034940: 6e65 3a20 2023 2065 6d70 7479 206c 6973  ne:  # empty lis
+00034950: 7420 6d75 7374 2069 6e76 6f6b 6520 6675  t must invoke fu
+00034960: 6e63 7469 6f6e 0a20 2020 2020 2020 2020  nction.         
+00034970: 2020 2061 7761 6974 2061 6374 696f 6e5f     await action_
+00034980: 6765 745f 6176 6174 6172 2867 732e 636c  get_avatar(gs.cl
+00034990: 6965 6e74 2c20 6773 2e63 7265 6465 6e74  ient, gs.credent
+000349a0: 6961 6c73 290a 2020 2020 2020 2020 6966  ials).        if
+000349b0: 2067 732e 7061 2e67 6574 5f70 726f 6669   gs.pa.get_profi
+000349c0: 6c65 2069 7320 6e6f 7420 4e6f 6e65 3a20  le is not None: 
+000349d0: 2023 2065 6d70 7479 206c 6973 7420 6d75   # empty list mu
+000349e0: 7374 2069 6e76 6f6b 6520 6675 6e63 7469  st invoke functi
+000349f0: 6f6e 0a20 2020 2020 2020 2020 2020 2061  on.            a
+00034a00: 7761 6974 2061 6374 696f 6e5f 6765 745f  wait action_get_
+00034a10: 7072 6f66 696c 6528 6773 2e63 6c69 656e  profile(gs.clien
+00034a20: 742c 2067 732e 6372 6564 656e 7469 616c  t, gs.credential
+00034a30: 7329 0a20 2020 2020 2020 2069 6620 6773  s).        if gs
+00034a40: 2e70 612e 6765 745f 726f 6f6d 5f69 6e66  .pa.get_room_inf
+00034a50: 6f20 6973 206e 6f74 204e 6f6e 653a 2020  o is not None:  
+00034a60: 2320 656d 7074 7920 6c69 7374 206d 7573  # empty list mus
+00034a70: 7420 696e 766f 6b65 2066 756e 6374 696f  t invoke functio
+00034a80: 6e0a 2020 2020 2020 2020 2020 2020 6177  n.            aw
+00034a90: 6169 7420 6163 7469 6f6e 5f67 6574 5f72  ait action_get_r
+00034aa0: 6f6f 6d5f 696e 666f 2867 732e 636c 6965  oom_info(gs.clie
+00034ab0: 6e74 2c20 6773 2e63 7265 6465 6e74 6961  nt, gs.credentia
+00034ac0: 6c73 290a 2020 2020 2020 2020 6966 2067  ls).        if g
+00034ad0: 732e 7061 2e67 6574 5f63 6c69 656e 745f  s.pa.get_client_
+00034ae0: 696e 666f 3a0a 2020 2020 2020 2020 2020  info:.          
+00034af0: 2020 6177 6169 7420 6163 7469 6f6e 5f67    await action_g
+00034b00: 6574 5f63 6c69 656e 745f 696e 666f 2867  et_client_info(g
+00034b10: 732e 636c 6965 6e74 2c20 6773 2e63 7265  s.client, gs.cre
+00034b20: 6465 6e74 6961 6c73 290a 2020 2020 2020  dentials).      
+00034b30: 2020 6966 2067 732e 7061 2e68 6173 5f70    if gs.pa.has_p
+00034b40: 6572 6d69 7373 696f 6e3a 0a20 2020 2020  ermission:.     
+00034b50: 2020 2020 2020 2061 7761 6974 2061 6374         await act
+00034b60: 696f 6e5f 6861 735f 7065 726d 6973 7369  ion_has_permissi
+00034b70: 6f6e 2867 732e 636c 6965 6e74 2c20 6773  on(gs.client, gs
+00034b80: 2e63 7265 6465 6e74 6961 6c73 290a 2020  .credentials).  
+00034b90: 2020 2020 2020 6966 2067 732e 7061 2e65        if gs.pa.e
+00034ba0: 7870 6f72 745f 6b65 7973 3a0a 2020 2020  xport_keys:.    
+00034bb0: 2020 2020 2020 2020 6177 6169 7420 6163          await ac
+00034bc0: 7469 6f6e 5f65 7870 6f72 745f 6b65 7973  tion_export_keys
+00034bd0: 2867 732e 636c 6965 6e74 2c20 6773 2e63  (gs.client, gs.c
+00034be0: 7265 6465 6e74 6961 6c73 290a 2020 2020  redentials).    
+00034bf0: 2020 2020 6966 2067 732e 7061 2e67 6574      if gs.pa.get
+00034c00: 5f6f 7065 6e69 645f 746f 6b65 6e20 6973  _openid_token is
+00034c10: 206e 6f74 204e 6f6e 653a 2020 2320 656d   not None:  # em
+00034c20: 7074 7920 6c69 7374 206d 7573 7420 696e  pty list must in
+00034c30: 766f 6b65 2066 756e 630a 2020 2020 2020  voke func.      
+00034c40: 2020 2020 2020 6177 6169 7420 6163 7469        await acti
+00034c50: 6f6e 5f67 6574 5f6f 7065 6e69 645f 746f  on_get_openid_to
+00034c60: 6b65 6e28 6773 2e63 6c69 656e 742c 2067  ken(gs.client, g
+00034c70: 732e 6372 6564 656e 7469 616c 7329 0a20  s.credentials). 
+00034c80: 2020 2020 2020 2069 6620 6773 2e70 612e         if gs.pa.
+00034c90: 7768 6f61 6d69 3a0a 2020 2020 2020 2020  whoami:.        
+00034ca0: 2020 2020 6177 6169 7420 6163 7469 6f6e      await action
+00034cb0: 5f77 686f 616d 6928 6773 2e63 6c69 656e  _whoami(gs.clien
+00034cc0: 742c 2067 732e 6372 6564 656e 7469 616c  t, gs.credential
+00034cd0: 7329 0a20 2020 2020 2020 2069 6620 6773  s).        if gs
+00034ce0: 2e73 6574 6765 745f 6163 7469 6f6e 3a0a  .setget_action:.
+00034cf0: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+00034d00: 6f67 2e64 6562 7567 2822 5365 7420 6f72  og.debug("Set or
+00034d10: 2067 6574 2061 6374 696f 6e28 7329 2077   get action(s) w
+00034d20: 6572 6520 7065 7266 6f72 6d65 6420 6f72  ere performed or
+00034d30: 2061 7474 656d 7074 6564 2e22 290a 2020   attempted.").  
+00034d40: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+00034d50: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
+00034d60: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
+00034d70: 2020 2020 2020 2020 2020 2022 4532 3135             "E215
+00034d80: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
+00034d90: 2245 7272 6f72 2064 7572 696e 6720 726f  "Error during ro
+00034da0: 6f6d 2c20 7365 742c 2067 6574 2061 6374  om, set, get act
+00034db0: 696f 6e73 2e20 436f 6e74 696e 7569 6e67  ions. Continuing
+00034dc0: 2064 6573 7069 7465 2065 7272 6f72 2e20   despite error. 
+00034dd0: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
+00034de0: 4578 6365 7074 696f 6e3a 207b 657d 220a  Exception: {e}".
+00034df0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00034e00: 2020 6773 2e6c 6f67 2e64 6562 7567 2822    gs.log.debug("
+00034e10: 4865 7265 2069 7320 7468 6520 7472 6163  Here is the trac
+00034e20: 6562 6163 6b2e 5c6e 2220 2b20 7472 6163  eback.\n" + trac
+00034e30: 6562 6163 6b2e 666f 726d 6174 5f65 7863  eback.format_exc
+00034e40: 2829 290a 2020 2020 2020 2020 6773 2e65  ()).        gs.e
+00034e50: 7272 5f63 6f75 6e74 202b 3d20 310a 0a0a  rr_count += 1...
+00034e60: 6173 796e 6320 6465 6620 6163 7469 6f6e  async def action
+00034e70: 5f76 6572 6966 7928 2920 2d3e 204e 6f6e  _verify() -> Non
+00034e80: 653a 0a20 2020 2022 2222 5665 7269 6679  e:.    """Verify
+00034e90: 2077 6869 6c65 2061 6c72 6561 6479 206c   while already l
+00034ea0: 6f67 6765 6420 696e 2e22 2222 0a20 2020  ogged in.""".   
+00034eb0: 2069 6620 6e6f 7420 6773 2e63 6c69 656e   if not gs.clien
+00034ec0: 7420 616e 6420 6e6f 7420 6773 2e63 7265  t and not gs.cre
+00034ed0: 6465 6e74 6961 6c73 3a0a 2020 2020 2020  dentials:.      
+00034ee0: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
+00034ef0: 2020 2020 2020 2020 2020 2020 2245 3231              "E21
+00034f00: 363a 2022 2022 436c 6965 6e74 206f 7220  6: " "Client or 
+00034f10: 6372 6564 656e 7469 616c 7320 6e6f 7420  credentials not 
+00034f20: 7365 742e 2053 6b69 7070 696e 6720 6163  set. Skipping ac
+00034f30: 7469 6f6e 2e22 0a20 2020 2020 2020 2029  tion.".        )
+00034f40: 0a20 2020 2020 2020 2067 732e 6572 725f  .        gs.err_
+00034f50: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
+00034f60: 2020 2072 6574 7572 6e0a 2020 2020 7472     return.    tr
+00034f70: 793a 0a20 2020 2020 2020 2023 2053 6574  y:.        # Set
+00034f80: 2075 7020 6576 656e 7420 6361 6c6c 6261   up event callba
+00034f90: 636b 730a 2020 2020 2020 2020 6361 6c6c  cks.        call
+00034fa0: 6261 636b 7320 3d20 4361 6c6c 6261 636b  backs = Callback
+00034fb0: 7328 6773 2e63 6c69 656e 7429 0a20 2020  s(gs.client).   
+00034fc0: 2020 2020 2067 732e 636c 6965 6e74 2e61       gs.client.a
+00034fd0: 6464 5f74 6f5f 6465 7669 6365 5f63 616c  dd_to_device_cal
+00034fe0: 6c62 6163 6b28 0a20 2020 2020 2020 2020  lback(.         
+00034ff0: 2020 2063 616c 6c62 6163 6b73 2e74 6f5f     callbacks.to_
+00035000: 6465 7669 6365 5f63 616c 6c62 6163 6b2c  device_callback,
+00035010: 2028 4b65 7956 6572 6966 6963 6174 696f   (KeyVerificatio
+00035020: 6e45 7665 6e74 2c29 0a20 2020 2020 2020  nEvent,).       
+00035030: 2029 0a20 2020 2020 2020 2023 2053 796e   ).        # Syn
+00035040: 6320 656e 6372 7970 7469 6f6e 206b 6579  c encryption key
+00035050: 7320 7769 7468 2074 6865 2073 6572 7665  s with the serve
+00035060: 720a 2020 2020 2020 2020 2320 5265 7175  r.        # Requ
+00035070: 6972 6564 2066 6f72 2070 6172 7469 6369  ired for partici
+00035080: 7061 7469 6e67 2069 6e20 656e 6372 7970  pating in encryp
+00035090: 7465 6420 726f 6f6d 730a 2020 2020 2020  ted rooms.      
+000350a0: 2020 6966 2067 732e 636c 6965 6e74 2e73    if gs.client.s
+000350b0: 686f 756c 645f 7570 6c6f 6164 5f6b 6579  hould_upload_key
+000350c0: 733a 0a20 2020 2020 2020 2020 2020 2061  s:.            a
+000350d0: 7761 6974 2067 732e 636c 6965 6e74 2e6b  wait gs.client.k
+000350e0: 6579 735f 7570 6c6f 6164 2829 0a20 2020  eys_upload().   
+000350f0: 2020 2020 2070 7269 6e74 280a 2020 2020       print(.    
+00035100: 2020 2020 2020 2020 6622 7b50 524f 475f          f"{PROG_
+00035110: 5749 5448 4f55 545f 4558 547d 2069 7320  WITHOUT_EXT} is 
+00035120: 7265 6164 7920 616e 6420 7761 6974 696e  ready and waitin
+00035130: 6720 666f 7220 7468 6520 6f74 6865 7220  g for the other 
+00035140: 7061 7274 7920 746f 2022 0a20 2020 2020  party to ".     
+00035150: 2020 2020 2020 2022 696e 6974 6961 7465         "initiate
+00035160: 2061 6e20 656d 6f6a 6920 7665 7269 6669   an emoji verifi
+00035170: 6361 7469 6f6e 2077 6974 6820 7573 2062  cation with us b
+00035180: 7920 7365 6c65 6374 696e 6720 220a 2020  y selecting ".  
+00035190: 2020 2020 2020 2020 2020 2227 5665 7269            "'Veri
+000351a0: 6679 2062 7920 456d 6f6a 6927 2022 0a20  fy by Emoji' ". 
+000351b0: 2020 2020 2020 2020 2020 2022 696e 2074             "in t
+000351c0: 6865 6972 204d 6174 7269 7820 636c 6965  heir Matrix clie
+000351d0: 6e74 2e20 5265 6164 202d 2d76 6572 6966  nt. Read --verif
+000351e0: 7920 696e 7374 7275 6374 696f 6e73 2069  y instructions i
+000351f0: 6e20 2d2d 6d61 6e75 616c 2022 0a20 2020  n --manual ".   
+00035200: 2020 2020 2020 2020 2022 6361 7265 6675           "carefu
+00035210: 6c6c 7920 746f 2061 7373 6973 7420 796f  lly to assist yo
+00035220: 7520 696e 2068 6f77 2074 6f20 646f 2074  u in how to do t
+00035230: 6869 7320 7175 6963 6b6c 792e 222c 0a20  his quickly.",. 
+00035240: 2020 2020 2020 2020 2020 2066 696c 653d             file=
+00035250: 7379 732e 7374 646f 7574 2c0a 2020 2020  sys.stdout,.    
+00035260: 2020 2020 2020 2020 666c 7573 683d 5472          flush=Tr
+00035270: 7565 2c0a 2020 2020 2020 2020 290a 2020  ue,.        ).  
+00035280: 2020 2020 2020 2320 7468 6520 7379 6e63        # the sync
+00035290: 5f6c 6f6f 7020 7769 6c6c 2062 6520 7465  _loop will be te
+000352a0: 726d 696e 6174 6564 2062 7920 7573 6572  rminated by user
+000352b0: 2068 6974 7469 6e67 2043 6f6e 7472 6f6c   hitting Control
+000352c0: 2d43 0a20 2020 2020 2020 2061 7761 6974  -C.        await
+000352d0: 2067 732e 636c 6965 6e74 2e73 796e 635f   gs.client.sync_
+000352e0: 666f 7265 7665 7228 7469 6d65 6f75 743d  forever(timeout=
+000352f0: 3330 3030 302c 2066 756c 6c5f 7374 6174  30000, full_stat
+00035300: 653d 5472 7565 290a 2020 2020 6578 6365  e=True).    exce
+00035310: 7074 204b 6579 626f 6172 6449 6e74 6572  pt KeyboardInter
+00035320: 7275 7074 3a0a 2020 2020 2020 2020 2320  rupt:.        # 
+00035330: 5468 6973 2077 696c 6c20 6e65 7665 7220  This will never 
+00035340: 6265 2063 6175 6768 742e 2049 2064 6f20  be caught. I do 
+00035350: 6e6f 7420 6b6e 6f77 2077 6879 2e0a 2020  not know why..  
+00035360: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+00035370: 7567 2822 4b65 7962 6f61 7264 2069 6e74  ug("Keyboard int
+00035380: 6572 7275 7074 2061 6674 6572 2045 6d6f  errupt after Emo
+00035390: 6a69 2076 6572 6966 6963 6174 696f 6e2e  ji verification.
+000353a0: 2229 0a20 2020 2065 7863 6570 7420 4578  ").    except Ex
+000353b0: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
+000353c0: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
+000353d0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+000353e0: 2245 3231 373a 2022 0a20 2020 2020 2020  "E217: ".       
+000353f0: 2020 2020 2022 4572 726f 7220 6475 7269       "Error duri
+00035400: 6e67 2076 6572 6966 792e 2043 6f6e 7469  ng verify. Conti
+00035410: 6e75 696e 6720 6465 7370 6974 6520 6572  nuing despite er
+00035420: 726f 722e 2022 0a20 2020 2020 2020 2020  ror. ".         
+00035430: 2020 2066 2245 7863 6570 7469 6f6e 3a20     f"Exception: 
+00035440: 7b65 7d22 0a20 2020 2020 2020 2029 0a20  {e}".        ). 
+00035450: 2020 2020 2020 2067 732e 6572 725f 636f         gs.err_co
+00035460: 756e 7420 2b3d 2031 0a0a 0a61 7379 6e63  unt += 1...async
+00035470: 2064 6566 2061 6374 696f 6e5f 7365 6e64   def action_send
+00035480: 2829 202d 3e20 4e6f 6e65 3a0a 2020 2020  () -> None:.    
+00035490: 2222 2253 656e 6420 6d65 7373 6167 6573  """Send messages
+000354a0: 2077 6869 6c65 2061 6c72 6561 6479 206c   while already l
+000354b0: 6f67 6765 6420 696e 2e22 2222 0a20 2020  ogged in.""".   
+000354c0: 2069 6620 6e6f 7420 6773 2e63 6c69 656e   if not gs.clien
+000354d0: 7420 616e 6420 6e6f 7420 6773 2e63 7265  t and not gs.cre
+000354e0: 6465 6e74 6961 6c73 3a0a 2020 2020 2020  dentials:.      
+000354f0: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
+00035500: 2020 2020 2020 2020 2020 2020 2245 3231              "E21
+00035510: 383a 2022 2022 436c 6965 6e74 206f 7220  8: " "Client or 
+00035520: 6372 6564 656e 7469 616c 7320 6e6f 7420  credentials not 
+00035530: 7365 742e 2053 6b69 7070 696e 6720 6163  set. Skipping ac
+00035540: 7469 6f6e 2e22 0a20 2020 2020 2020 2029  tion.".        )
+00035550: 0a20 2020 2020 2020 2067 732e 6572 725f  .        gs.err_
+00035560: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
+00035570: 2020 2072 6574 7572 6e0a 2020 2020 7472     return.    tr
+00035580: 793a 0a20 2020 2020 2020 2023 2061 2066  y:.        # a f
+00035590: 6577 206d 6f72 6520 7374 6570 7320 746f  ew more steps to
+000355a0: 2070 7265 7061 7265 2066 6f72 2073 656e   prepare for sen
+000355b0: 6469 6e67 206d 6573 7361 6765 730a 2020  ding messages.  
+000355c0: 2020 2020 2020 726f 6f6d 7320 3d20 6177        rooms = aw
+000355d0: 6169 7420 6465 7465 726d 696e 655f 726f  ait determine_ro
+000355e0: 6f6d 7328 0a20 2020 2020 2020 2020 2020  oms(.           
+000355f0: 2067 732e 6372 6564 656e 7469 616c 735b   gs.credentials[
+00035600: 2272 6f6f 6d5f 6964 225d 2c20 6773 2e63  "room_id"], gs.c
+00035610: 6c69 656e 742c 2067 732e 6372 6564 656e  lient, gs.creden
+00035620: 7469 616c 730a 2020 2020 2020 2020 290a  tials.        ).
+00035630: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+00035640: 6562 7567 2866 2252 6f6f 6d73 2061 7265  ebug(f"Rooms are
+00035650: 3a20 7b72 6f6f 6d73 7d22 290a 2020 2020  : {rooms}").    
+00035660: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+00035670: 2866 2267 732e 636c 6965 6e74 2e72 6f6f  (f"gs.client.roo
+00035680: 6d73 2061 7265 3a20 7b67 732e 636c 6965  ms are: {gs.clie
+00035690: 6e74 2e72 6f6f 6d73 7d22 290a 2020 2020  nt.rooms}").    
+000356a0: 2020 2020 2320 5379 6e63 2065 6e63 7279      # Sync encry
+000356b0: 7074 696f 6e20 6b65 7973 2077 6974 6820  ption keys with 
+000356c0: 7468 6520 7365 7276 6572 0a20 2020 2020  the server.     
+000356d0: 2020 2023 2052 6571 7569 7265 6420 666f     # Required fo
+000356e0: 7220 7061 7274 6963 6970 6174 696e 6720  r participating 
+000356f0: 696e 2065 6e63 7279 7074 6564 2072 6f6f  in encrypted roo
+00035700: 6d73 0a20 2020 2020 2020 2069 6620 6773  ms.        if gs
+00035710: 2e63 6c69 656e 742e 7368 6f75 6c64 5f75  .client.should_u
+00035720: 706c 6f61 645f 6b65 7973 3a0a 2020 2020  pload_keys:.    
+00035730: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+00035740: 6562 7567 2822 5374 6172 7469 6e67 206b  ebug("Starting k
+00035750: 6579 735f 7570 6c6f 6164 2229 0a20 2020  eys_upload").   
+00035760: 2020 2020 2020 2020 2061 7761 6974 2067           await g
+00035770: 732e 636c 6965 6e74 2e6b 6579 735f 7570  s.client.keys_up
+00035780: 6c6f 6164 2829 0a20 2020 2020 2020 2020  load().         
+00035790: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+000357a0: 2246 696e 6973 6865 6420 6b65 7973 5f75  "Finished keys_u
+000357b0: 706c 6f61 6422 290a 2020 2020 2020 2020  pload").        
+000357c0: 6966 2067 732e 7061 2e73 796e 6320 3d3d  if gs.pa.sync ==
+000357d0: 2053 594e 435f 4f46 463a 0a20 2020 2020   SYNC_OFF:.     
+000357e0: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+000357f0: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
+00035800: 2020 2020 2066 2244 7565 2074 6f20 272d       f"Due to '-
+00035810: 2d73 796e 6320 7b53 594e 435f 4f46 467d  -sync {SYNC_OFF}
+00035820: 2720 6f70 7469 6f6e 2c20 7379 6e63 2829  ' option, sync()
+00035830: 2077 696c 6c20 6265 2073 6b69 7070 6564   will be skipped
+00035840: 2e22 0a20 2020 2020 2020 2020 2020 2029  .".            )
+00035850: 0a20 2020 2020 2020 2020 2020 2023 2050  .            # P
+00035860: 7265 6669 6c6c 2072 6f6f 6d73 2061 7320  refill rooms as 
+00035870: 6f75 746c 696e 6564 2069 6e20 4973 7375  outlined in Issu
+00035880: 6520 2339 310a 2020 2020 2020 2020 2020  e #91.          
+00035890: 2020 2320 5369 6e63 6520 7379 6e63 2829    # Since sync()
+000358a0: 2069 7320 6e6f 7420 6361 6c6c 6564 2077   is not called w
+000358b0: 6520 4d55 5354 2066 696c 6c20 696e 2074  e MUST fill in t
+000358c0: 6865 2072 6f6f 6d73 206d 616e 7561 6c6c  he rooms manuall
+000358d0: 792e 0a20 2020 2020 2020 2020 2020 2023  y..            #
+000358e0: 2054 6869 7320 6c69 6e65 2077 6173 2073   This line was s
+000358f0: 7567 6765 7374 6564 2061 7320 776f 726b  uggested as work
+00035900: 6172 6f75 6e64 3a0a 2020 2020 2020 2020  around:.        
+00035910: 2020 2020 2320 6173 796e 635f 636c 6965      # async_clie
+00035920: 6e74 2e72 6f6f 6d73 5b72 6f6f 6d5f 6964  nt.rooms[room_id
+00035930: 5d20 3d20 6e69 6f2e 726f 6f6d 732e 4d61  ] = nio.rooms.Ma
+00035940: 7472 6978 526f 6f6d 280a 2020 2020 2020  trixRoom(.      
+00035950: 2020 2020 2020 2320 2020 2020 2020 2020        #         
+00035960: 2072 6f6f 6d5f 6964 3d72 6f6f 6d5f 6964   room_id=room_id
+00035970: 2c20 6f77 6e5f 7573 6572 5f69 643d 7573  , own_user_id=us
+00035980: 6572 5f69 642c 2065 6e63 7279 7074 6564  er_id, encrypted
+00035990: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
+000359a0: 2020 2023 2057 6520 6d75 7374 2061 6c73     # We must als
+000359b0: 6f20 6d61 7020 726f 6f6d 2061 6c69 6173  o map room alias
+000359c0: 6573 2074 6f20 726f 6f6d 2069 6473 2e0a  es to room ids..
+000359d0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000359e0: 726f 6f6d 5f69 6420 696e 2072 6f6f 6d73  room_id in rooms
+000359f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00035a00: 2020 726f 6f6d 5f69 6420 3d20 6177 6169    room_id = awai
+00035a10: 7420 6d61 705f 726f 6f6d 696e 666f 5f74  t map_roominfo_t
+00035a20: 6f5f 726f 6f6d 6964 2867 732e 636c 6965  o_roomid(gs.clie
+00035a30: 6e74 2c20 726f 6f6d 5f69 6429 0a20 2020  nt, room_id).   
+00035a40: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
+00035a50: 636c 6965 6e74 2e72 6f6f 6d73 5b72 6f6f  client.rooms[roo
+00035a60: 6d5f 6964 5d20 3d20 4d61 7472 6978 526f  m_id] = MatrixRo
+00035a70: 6f6d 280a 2020 2020 2020 2020 2020 2020  om(.            
+00035a80: 2020 2020 2020 2020 726f 6f6d 5f69 643d          room_id=
+00035a90: 726f 6f6d 5f69 642c 0a20 2020 2020 2020  room_id,.       
+00035aa0: 2020 2020 2020 2020 2020 2020 206f 776e               own
+00035ab0: 5f75 7365 725f 6964 3d67 732e 6372 6564  _user_id=gs.cred
+00035ac0: 656e 7469 616c 735b 2275 7365 725f 6964  entials["user_id
+00035ad0: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
+00035ae0: 2020 2020 2020 2020 656e 6372 7970 7465          encrypte
+00035af0: 643d 5472 7565 2c0a 2020 2020 2020 2020  d=True,.        
+00035b00: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00035b10: 2020 656c 7365 3a20 2023 2053 594e 435f    else:  # SYNC_
+00035b20: 4655 4c4c 0a20 2020 2020 2020 2020 2020  FULL.           
+00035b30: 2023 2044 6566 6175 6c74 2063 6173 652c   # Default case,
+00035b40: 2073 7461 6e64 6172 643a 0a20 2020 2020   standard:.     
+00035b50: 2020 2020 2020 2023 204f 6e65 206d 7573         # One mus
+00035b60: 7420 7379 6e63 2066 6972 7374 2074 6f20  t sync first to 
+00035b70: 6765 7420 726f 6f6d 2069 6473 2066 6f72  get room ids for
+00035b80: 2065 6e63 7279 7074 6564 2072 6f6f 6d73   encrypted rooms
+00035b90: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
+00035ba0: 696e 6365 2077 6520 6f6e 6c79 2073 656e  ince we only sen
+00035bb0: 6420 6120 6d73 6720 616e 6420 7468 656e  d a msg and then
+00035bc0: 2073 746f 702c 0a20 2020 2020 2020 2020   stop,.         
+00035bd0: 2020 2023 2077 6520 6361 6e20 7573 6520     # we can use 
+00035be0: 7379 6e63 2829 2069 6e73 7465 6164 206f  sync() instead o
+00035bf0: 6620 7379 6e63 5f66 6f72 6576 6572 2829  f sync_forever()
+00035c00: 2e0a 2020 2020 2020 2020 2020 2020 6675  ..            fu
+00035c10: 6c6c 5f73 7461 7465 203d 2054 7275 650a  ll_state = True.
+00035c20: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+00035c30: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
+00035c40: 2020 2020 2020 2020 2020 6622 5374 6172            f"Star
+00035c50: 7469 6e67 2073 796e 6328 6675 6c6c 5f73  ting sync(full_s
+00035c60: 7461 7465 3d7b 6675 6c6c 5f73 7461 7465  tate={full_state
+00035c70: 7d29 2022 0a20 2020 2020 2020 2020 2020  }) ".           
+00035c80: 2020 2020 2022 746f 2073 796e 6368 726f       "to synchro
+00035c90: 6e69 7a65 2065 7665 6e74 7320 7769 7468  nize events with
+00035ca0: 2073 6572 7665 722e 220a 2020 2020 2020   server.".      
+00035cb0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00035cc0: 2020 2020 6177 6169 7420 6773 2e63 6c69      await gs.cli
+00035cd0: 656e 742e 7379 6e63 2874 696d 656f 7574  ent.sync(timeout
+00035ce0: 3d33 3030 3030 2c20 6675 6c6c 5f73 7461  =30000, full_sta
+00035cf0: 7465 3d66 756c 6c5f 7374 6174 6529 0a20  te=full_state). 
+00035d00: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
+00035d10: 672e 6465 6275 6728 2246 696e 6973 6865  g.debug("Finishe
+00035d20: 6420 7379 6e63 2829 2077 6974 6820 7365  d sync() with se
+00035d30: 7276 6572 2e22 290a 2020 2020 2020 2020  rver.").        
+00035d40: 2320 4e6f 7720 7765 2063 616e 2073 656e  # Now we can sen
+00035d50: 6420 6d65 7373 6167 6573 2061 7320 7468  d messages as th
+00035d60: 6520 7573 6572 0a20 2020 2020 2020 2061  e user.        a
+00035d70: 7761 6974 2070 726f 6365 7373 5f61 7267  wait process_arg
+00035d80: 756d 656e 7473 5f61 6e64 5f69 6e70 7574  uments_and_input
+00035d90: 2867 732e 636c 6965 6e74 2c20 726f 6f6d  (gs.client, room
+00035da0: 7329 0a20 2020 2020 2020 2023 2067 732e  s).        # gs.
+00035db0: 6c6f 672e 6465 6275 6728 6622 6773 2e63  log.debug(f"gs.c
+00035dc0: 6c69 656e 742e 726f 6f6d 7320 6172 653a  lient.rooms are:
+00035dd0: 207b 6773 2e63 6c69 656e 742e 726f 6f6d   {gs.client.room
+00035de0: 737d 2229 0a20 2020 2020 2020 2067 732e  s}").        gs.
+00035df0: 6c6f 672e 6465 6275 6728 224d 6573 7361  log.debug("Messa
+00035e00: 6765 2073 656e 6420 6163 7469 6f6e 2066  ge send action f
+00035e10: 696e 6973 6865 642e 2229 0a20 2020 2065  inished.").    e
+00035e20: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+00035e30: 6173 2065 3a0a 2020 2020 2020 2020 6773  as e:.        gs
 00035e40: 2e6c 6f67 2e65 7272 6f72 280a 2020 2020  .log.error(.    
-00035e50: 2020 2020 2020 2020 2245 3232 303a 2022          "E220: "
-00035e60: 2022 436c 6965 6e74 206f 7220 6372 6564   "Client or cred
-00035e70: 656e 7469 616c 7320 6e6f 7420 7365 742e  entials not set.
-00035e80: 2053 6b69 7070 696e 6720 6163 7469 6f6e   Skipping action
-00035e90: 2e22 0a20 2020 2020 2020 2029 0a20 2020  .".        ).   
-00035ea0: 2020 2020 2067 732e 6572 725f 636f 756e       gs.err_coun
-00035eb0: 7420 2b3d 2031 0a20 2020 2020 2020 2072  t += 1.        r
-00035ec0: 6574 7572 6e0a 2020 2020 7472 793a 0a20  eturn.    try:. 
-00035ed0: 2020 2020 2020 2064 6576 6963 6520 3d20         device = 
-00035ee0: 6773 2e70 612e 6c6f 676f 7574 2e6c 6f77  gs.pa.logout.low
-00035ef0: 6572 2829 0a20 2020 2020 2020 2069 6620  er().        if 
-00035f00: 6465 7669 6365 203d 3d20 226d 6522 3a0a  device == "me":.
-00035f10: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
-00035f20: 6f67 2e64 6562 7567 2866 222d 2d6c 6f67  og.debug(f"--log
-00035f30: 6f75 7420 6861 7320 6368 6f73 656e 2074  out has chosen t
-00035f40: 6f20 6c6f 6720 6f75 7420 6465 7669 6365  o log out device
-00035f50: 207b 6465 7669 6365 7d22 290a 2020 2020   {device}").    
-00035f60: 2020 2020 2020 2020 616c 6c5f 6465 7669          all_devi
-00035f70: 6365 7320 3d20 4661 6c73 650a 2020 2020  ces = False.    
-00035f80: 2020 2020 656c 6966 2064 6576 6963 6520      elif device 
-00035f90: 3d3d 2022 616c 6c22 3a0a 2020 2020 2020  == "all":.      
-00035fa0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-00035fb0: 7567 2866 222d 2d6c 6f67 6f75 7420 6861  ug(f"--logout ha
-00035fc0: 7320 6368 6f73 656e 2074 6f20 6c6f 6720  s chosen to log 
-00035fd0: 6f75 7420 6465 7669 6365 7320 7b64 6576  out devices {dev
-00035fe0: 6963 657d 2229 0a20 2020 2020 2020 2020  ice}").         
-00035ff0: 2020 2061 6c6c 5f64 6576 6963 6573 203d     all_devices =
-00036000: 2054 7275 650a 2020 2020 2020 2020 656c   True.        el
-00036010: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00036020: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
-00036030: 2020 2020 2020 2020 2020 2020 2020 2245                "E
-00036040: 3232 313a 2022 0a20 2020 2020 2020 2020  221: ".         
-00036050: 2020 2020 2020 2022 4572 726f 7220 6475         "Error du
-00036060: 7269 6e67 206c 6f67 6f75 742e 204f 6e6c  ring logout. Onl
-00036070: 7920 276d 6527 2061 6e64 2027 616c 6c27  y 'me' and 'all'
-00036080: 2061 7265 2073 7570 706f 7274 6564 2e20   are supported. 
-00036090: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-000360a0: 2020 6622 4275 7420 666f 756e 6420 2d2d    f"But found --
-000360b0: 6c6f 676f 7574 2027 7b64 6576 6963 657d  logout '{device}
-000360c0: 272e 2043 6f6e 7469 6e75 696e 6720 6465  '. Continuing de
-000360d0: 7370 6974 6520 6572 726f 722e 2022 0a20  spite error. ". 
-000360e0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000360f0: 2020 2020 2020 2020 2067 732e 6572 725f           gs.err_
-00036100: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
-00036110: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
-00036120: 2020 2020 2020 7265 7370 203d 2061 7761        resp = awa
-00036130: 6974 2067 732e 636c 6965 6e74 2e6c 6f67  it gs.client.log
-00036140: 6f75 7428 616c 6c5f 6465 7669 6365 7329  out(all_devices)
-00036150: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-00036160: 7374 616e 6365 2872 6573 702c 204c 6f67  stance(resp, Log
-00036170: 6f75 7445 7272 6f72 293a 0a20 2020 2020  outError):.     
-00036180: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
-00036190: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-000361a0: 2020 2020 2022 4532 3232 3a20 220a 2020       "E222: ".  
-000361b0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-000361c0: 4661 696c 6564 2074 6f20 6c6f 676f 7574  Failed to logout
-000361d0: 207b 6465 7669 6365 7d2e 2052 6573 706f   {device}. Respo
-000361e0: 6e73 653a 2022 0a20 2020 2020 2020 2020  nse: ".         
-000361f0: 2020 2020 2020 2066 227b 7072 6976 6163         f"{privac
-00036200: 795f 6669 6c74 6572 2873 7472 2872 6573  y_filter(str(res
-00036210: 7029 297d 220a 2020 2020 2020 2020 2020  p))}".          
+00035e50: 2020 2020 2020 2020 2245 3231 393a 2022          "E219: "
+00035e60: 0a20 2020 2020 2020 2020 2020 2022 4572  .            "Er
+00035e70: 726f 7220 6475 7269 6e67 2073 656e 6469  ror during sendi
+00035e80: 6e67 2e20 436f 6e74 696e 7569 6e67 2064  ng. Continuing d
+00035e90: 6573 7069 7465 2065 7272 6f72 2e20 220a  espite error. ".
+00035ea0: 2020 2020 2020 2020 2020 2020 6622 4578              f"Ex
+00035eb0: 6365 7074 696f 6e3a 207b 657d 220a 2020  ception: {e}".  
+00035ec0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00035ed0: 6773 2e65 7272 5f63 6f75 6e74 202b 3d20  gs.err_count += 
+00035ee0: 310a 0a0a 6173 796e 6320 6465 6620 6163  1...async def ac
+00035ef0: 7469 6f6e 5f6c 6f67 6f75 7428 2920 2d3e  tion_logout() ->
+00035f00: 204e 6f6e 653a 0a20 2020 2022 2222 4c6f   None:.    """Lo
+00035f10: 6720 6f75 7420 6f6e 6520 6f72 2061 6c6c  g out one or all
+00035f20: 2064 6576 6963 6573 2066 726f 6d20 4d61   devices from Ma
+00035f30: 7472 6978 2073 6572 7665 722e 2222 220a  trix server.""".
+00035f40: 2020 2020 6966 206e 6f74 2067 732e 636c      if not gs.cl
+00035f50: 6965 6e74 2061 6e64 206e 6f74 2067 732e  ient and not gs.
+00035f60: 6372 6564 656e 7469 616c 733a 0a20 2020  credentials:.   
+00035f70: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
+00035f80: 7228 0a20 2020 2020 2020 2020 2020 2022  r(.            "
+00035f90: 4532 3230 3a20 2220 2243 6c69 656e 7420  E220: " "Client 
+00035fa0: 6f72 2063 7265 6465 6e74 6961 6c73 206e  or credentials n
+00035fb0: 6f74 2073 6574 2e20 536b 6970 7069 6e67  ot set. Skipping
+00035fc0: 2061 6374 696f 6e2e 220a 2020 2020 2020   action.".      
+00035fd0: 2020 290a 2020 2020 2020 2020 6773 2e65    ).        gs.e
+00035fe0: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
+00035ff0: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+00036000: 2074 7279 3a0a 2020 2020 2020 2020 6465   try:.        de
+00036010: 7669 6365 203d 2067 732e 7061 2e6c 6f67  vice = gs.pa.log
+00036020: 6f75 742e 6c6f 7765 7228 290a 2020 2020  out.lower().    
+00036030: 2020 2020 6966 2064 6576 6963 6520 3d3d      if device ==
+00036040: 2022 6d65 223a 0a20 2020 2020 2020 2020   "me":.         
+00036050: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+00036060: 6622 2d2d 6c6f 676f 7574 2068 6173 2063  f"--logout has c
+00036070: 686f 7365 6e20 746f 206c 6f67 206f 7574  hosen to log out
+00036080: 2064 6576 6963 6520 7b64 6576 6963 657d   device {device}
+00036090: 2229 0a20 2020 2020 2020 2020 2020 2061  ").            a
+000360a0: 6c6c 5f64 6576 6963 6573 203d 2046 616c  ll_devices = Fal
+000360b0: 7365 0a20 2020 2020 2020 2065 6c69 6620  se.        elif 
+000360c0: 6465 7669 6365 203d 3d20 2261 6c6c 223a  device == "all":
+000360d0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+000360e0: 6c6f 672e 6465 6275 6728 6622 2d2d 6c6f  log.debug(f"--lo
+000360f0: 676f 7574 2068 6173 2063 686f 7365 6e20  gout has chosen 
+00036100: 746f 206c 6f67 206f 7574 2064 6576 6963  to log out devic
+00036110: 6573 207b 6465 7669 6365 7d22 290a 2020  es {device}").  
+00036120: 2020 2020 2020 2020 2020 616c 6c5f 6465            all_de
+00036130: 7669 6365 7320 3d20 5472 7565 0a20 2020  vices = True.   
+00036140: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00036150: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
+00036160: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+00036170: 2020 2020 2022 4532 3231 3a20 220a 2020       "E221: ".  
+00036180: 2020 2020 2020 2020 2020 2020 2020 2245                "E
+00036190: 7272 6f72 2064 7572 696e 6720 6c6f 676f  rror during logo
+000361a0: 7574 2e20 4f6e 6c79 2027 6d65 2720 616e  ut. Only 'me' an
+000361b0: 6420 2761 6c6c 2720 6172 6520 7375 7070  d 'all' are supp
+000361c0: 6f72 7465 642e 2022 0a20 2020 2020 2020  orted. ".       
+000361d0: 2020 2020 2020 2020 2066 2242 7574 2066           f"But f
+000361e0: 6f75 6e64 202d 2d6c 6f67 6f75 7420 277b  ound --logout '{
+000361f0: 6465 7669 6365 7d27 2e20 436f 6e74 696e  device}'. Contin
+00036200: 7569 6e67 2064 6573 7069 7465 2065 7272  uing despite err
+00036210: 6f72 2e20 220a 2020 2020 2020 2020 2020  or. ".          
 00036220: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
 00036230: 6773 2e65 7272 5f63 6f75 6e74 202b 3d20  gs.err_count += 
-00036240: 310a 2020 2020 2020 2020 656c 7365 3a0a  1.        else:.
-00036250: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
-00036260: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
-00036270: 2020 2020 2020 2020 2020 6622 6c6f 676f            f"logo
-00036280: 7574 2073 7563 6365 7373 6675 6c2e 2052  ut successful. R
-00036290: 6573 706f 6e73 6520 6973 3a20 7b70 7269  esponse is: {pri
-000362a0: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
-000362b0: 7265 7370 2929 7d22 0a20 2020 2020 2020  resp))}".       
-000362c0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-000362d0: 2020 2067 732e 6c6f 672e 696e 666f 2866     gs.log.info(f
-000362e0: 2253 7563 6365 7373 6675 6c6c 7920 6c6f  "Successfully lo
-000362f0: 6767 6564 206f 7574 207b 6465 7669 6365  gged out {device
-00036300: 7d2e 2229 0a0a 2020 2020 6578 6365 7074  }.")..    except
-00036310: 2045 7863 6570 7469 6f6e 2061 7320 653a   Exception as e:
-00036320: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
-00036330: 6572 726f 7228 0a20 2020 2020 2020 2020  error(.         
-00036340: 2020 2022 4532 3233 3a20 220a 2020 2020     "E223: ".    
-00036350: 2020 2020 2020 2020 2245 7272 6f72 2064          "Error d
-00036360: 7572 696e 6720 6c6f 676f 7574 2e20 436f  uring logout. Co
-00036370: 6e74 696e 7569 6e67 2064 6573 7069 7465  ntinuing despite
-00036380: 2065 7272 6f72 2e20 220a 2020 2020 2020   error. ".      
-00036390: 2020 2020 2020 6622 4578 6365 7074 696f        f"Exceptio
-000363a0: 6e3a 207b 657d 220a 2020 2020 2020 2020  n: {e}".        
-000363b0: 290a 2020 2020 2020 2020 6773 2e65 7272  ).        gs.err
-000363c0: 5f63 6f75 6e74 202b 3d20 310a 0a0a 6173  _count += 1...as
-000363d0: 796e 6320 6465 6620 6163 7469 6f6e 5f6c  ync def action_l
-000363e0: 6f67 696e 2829 202d 3e20 4e6f 6e65 3a0a  ogin() -> None:.
-000363f0: 2020 2020 2222 224c 6f67 2069 6e20 7573      """Log in us
-00036400: 696e 6720 5353 4f20 6f72 2070 6173 7377  ing SSO or passw
-00036410: 6f72 642c 2063 7265 6174 6520 6372 6564  ord, create cred
-00036420: 656e 7469 616c 7320 6669 6c65 2c20 6372  entials file, cr
-00036430: 6561 7465 2073 746f 7265 2c0a 2020 2020  eate store,.    
-00036440: 616e 6420 7265 6d61 696e 206c 6f67 6765  and remain logge
-00036450: 6420 696e 2e0a 2020 2020 2222 220a 2020  d in..    """.  
-00036460: 2020 6372 6564 656e 7469 616c 735f 6669    credentials_fi
-00036470: 6c65 203d 2064 6574 6572 6d69 6e65 5f63  le = determine_c
-00036480: 7265 6465 6e74 6961 6c73 5f66 696c 6528  redentials_file(
-00036490: 290a 2020 2020 6966 2063 7265 6465 6e74  ).    if credent
-000364a0: 6961 6c73 5f65 7869 7374 2863 7265 6465  ials_exist(crede
-000364b0: 6e74 6961 6c73 5f66 696c 6529 3a0a 2020  ntials_file):.  
-000364c0: 2020 2020 2020 7261 6973 6520 4d61 7472        raise Matr
-000364d0: 6978 436f 6d6d 616e 6465 7245 7272 6f72  ixCommanderError
-000364e0: 280a 2020 2020 2020 2020 2020 2020 2245  (.            "E
-000364f0: 3232 343a 2022 0a20 2020 2020 2020 2020  224: ".         
-00036500: 2020 2022 2d2d 6c6f 6769 6e20 7761 7320     "--login was 
-00036510: 7573 6564 2062 7574 2063 7265 6465 6e74  used but credent
-00036520: 6961 6c73 2061 6c72 6561 6479 2065 7869  ials already exi
-00036530: 7374 2022 0a20 2020 2020 2020 2020 2020  st ".           
-00036540: 2066 2269 6e20 277b 6372 6564 656e 7469   f"in '{credenti
-00036550: 616c 735f 6669 6c65 7d27 2e22 0a20 2020  als_file}'.".   
-00036560: 2020 2020 2029 2066 726f 6d20 4e6f 6e65       ) from None
-00036570: 0a20 2020 2073 746f 7265 5f64 6972 203d  .    store_dir =
-00036580: 2064 6574 6572 6d69 6e65 5f73 746f 7265   determine_store
-00036590: 5f64 6972 2829 0a20 2020 2069 6620 7374  _dir().    if st
-000365a0: 6f72 655f 6578 6973 7473 2873 746f 7265  ore_exists(store
-000365b0: 5f64 6972 293a 0a20 2020 2020 2020 2072  _dir):.        r
-000365c0: 6169 7365 204d 6174 7269 7843 6f6d 6d61  aise MatrixComma
-000365d0: 6e64 6572 4572 726f 7228 0a20 2020 2020  nderError(.     
-000365e0: 2020 2020 2020 2022 4532 3235 3a20 220a         "E225: ".
-000365f0: 2020 2020 2020 2020 2020 2020 6622 2d2d              f"--
-00036600: 6c6f 6769 6e20 7761 7320 7573 6564 2062  login was used b
-00036610: 7574 2073 746f 7265 2061 6c72 6561 6479  ut store already
-00036620: 2065 7869 7374 7320 696e 2027 7b73 746f   exists in '{sto
-00036630: 7265 5f64 6972 7d27 2e22 0a20 2020 2020  re_dir}'.".     
-00036640: 2020 2029 2066 726f 6d20 4e6f 6e65 0a20     ) from None. 
-00036650: 2020 206d 6574 686f 6420 3d20 6773 2e70     method = gs.p
-00036660: 612e 6c6f 6769 6e2e 6c6f 7765 7228 290a  a.login.lower().
-00036670: 2020 2020 696e 7465 7261 6374 6976 6520      interactive 
-00036680: 3d20 4661 6c73 650a 2020 2020 6966 206d  = False.    if m
-00036690: 6574 686f 6420 3d3d 2022 7061 7373 776f  ethod == "passwo
-000366a0: 7264 223a 0a20 2020 2020 2020 2067 732e  rd":.        gs.
-000366b0: 6c6f 672e 6465 6275 6728 222d 2d6c 6f67  log.debug("--log
-000366c0: 696e 2068 6173 2063 686f 7365 6e20 7061  in has chosen pa
-000366d0: 7373 776f 7264 206d 6574 686f 6420 666f  ssword method fo
-000366e0: 7220 6175 7468 656e 7469 6361 7469 6f6e  r authentication
-000366f0: 2229 0a20 2020 2065 6c69 6620 6d65 7468  ").    elif meth
-00036700: 6f64 203d 3d20 2273 736f 223a 0a20 2020  od == "sso":.   
-00036710: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-00036720: 6728 222d 2d6c 6f67 696e 2068 6173 2063  g("--login has c
-00036730: 686f 7365 6e20 5353 4f20 6d65 7468 6f64  hosen SSO method
-00036740: 2066 6f72 2061 7574 6865 6e74 6963 6174   for authenticat
-00036750: 696f 6e22 290a 2020 2020 656c 7365 3a0a  ion").    else:.
-00036760: 2020 2020 2020 2020 7261 6973 6520 4d61          raise Ma
-00036770: 7472 6978 436f 6d6d 616e 6465 7245 7272  trixCommanderErr
-00036780: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00036790: 2245 3232 363a 2022 0a20 2020 2020 2020  "E226: ".       
-000367a0: 2020 2020 2022 2d2d 6c6f 6769 6e20 7370       "--login sp
-000367b0: 6563 6966 6965 7320 696e 7661 6c69 6420  ecifies invalid 
-000367c0: 6175 7468 656e 7469 6361 7469 6e20 6d65  authenticatin me
-000367d0: 7468 6f64 2022 0a20 2020 2020 2020 2020  thod ".         
-000367e0: 2020 2066 2227 7b6d 6574 686f 647d 272e     f"'{method}'.
-000367f0: 204f 6e6c 7920 2770 6173 7377 6f72 6427   Only 'password'
-00036800: 2061 6e64 2027 7373 6f27 2061 6c6c 6f77   and 'sso' allow
-00036810: 6564 2e22 0a20 2020 2020 2020 2029 2066  ed.".        ) f
-00036820: 726f 6d20 4e6f 6e65 0a20 2020 2069 6620  rom None.    if 
-00036830: 6773 2e70 612e 686f 6d65 7365 7276 6572  gs.pa.homeserver
-00036840: 3a0a 2020 2020 2020 2020 686f 6d65 7365  :.        homese
-00036850: 7276 6572 203d 2067 732e 7061 2e68 6f6d  rver = gs.pa.hom
-00036860: 6573 6572 7665 720a 2020 2020 656c 7365  eserver.    else
-00036870: 3a0a 2020 2020 2020 2020 696e 7465 7261  :.        intera
-00036880: 6374 6976 6520 3d20 5472 7565 0a20 2020  ctive = True.   
-00036890: 2020 2020 2068 6f6d 6573 6572 7665 7220       homeserver 
-000368a0: 3d20 2268 7474 7073 3a2f 2f6d 6174 7269  = "https://matri
-000368b0: 782e 6578 616d 706c 652e 6f72 6722 0a20  x.example.org". 
-000368c0: 2020 2020 2020 2068 6f6d 6573 6572 7665         homeserve
-000368d0: 7220 3d20 696e 7075 7428 6622 456e 7465  r = input(f"Ente
-000368e0: 7220 5552 4c20 6f66 2079 6f75 7220 686f  r URL of your ho
-000368f0: 6d65 7365 7276 6572 3a20 5b7b 686f 6d65  meserver: [{home
-00036900: 7365 7276 6572 7d5d 2022 290a 2020 2020  server}] ").    
-00036910: 2020 2020 6966 206e 6f74 2068 6f6d 6573      if not homes
-00036920: 6572 7665 723a 0a20 2020 2020 2020 2020  erver:.         
-00036930: 2020 2068 6f6d 6573 6572 7665 7220 3d20     homeserver = 
-00036940: 2268 7474 7073 3a2f 2f6d 6174 7269 782e  "https://matrix.
-00036950: 6f72 6722 2020 2320 6265 7474 6572 2065  org"  # better e
-00036960: 7272 6f72 206d 7367 206c 6174 6572 0a20  rror msg later. 
-00036970: 2020 2069 6620 6e6f 7420 280a 2020 2020     if not (.    
-00036980: 2020 2020 686f 6d65 7365 7276 6572 2e73      homeserver.s
-00036990: 7461 7274 7377 6974 6828 2268 7474 7073  tartswith("https
-000369a0: 3a2f 2f22 2920 6f72 2068 6f6d 6573 6572  ://") or homeser
-000369b0: 7665 722e 7374 6172 7473 7769 7468 2822  ver.startswith("
-000369c0: 6874 7470 3a2f 2f22 290a 2020 2020 293a  http://").    ):
-000369d0: 0a20 2020 2020 2020 2068 6f6d 6573 6572  .        homeser
-000369e0: 7665 7220 3d20 2268 7474 7073 3a2f 2f22  ver = "https://"
-000369f0: 202b 2068 6f6d 6573 6572 7665 720a 2020   + homeserver.  
-00036a00: 2020 686f 6d65 7365 7276 6572 5f73 686f    homeserver_sho
-00036a10: 7274 203d 2075 726c 7061 7273 6528 686f  rt = urlparse(ho
-00036a20: 6d65 7365 7276 6572 292e 686f 7374 6e61  meserver).hostna
-00036a30: 6d65 2020 2320 6d61 7472 6978 2e65 7861  me  # matrix.exa
-00036a40: 6d70 6c65 2e6f 7267 0a0a 2020 2020 2320  mple.org..    # 
-00036a50: 466f 7220 5353 4f20 6c6f 6769 6e2c 2075  For SSO login, u
-00036a60: 7365 725f 6964 2069 7320 6e6f 7420 6e65  ser_id is not ne
-00036a70: 6564 6564 2e20 4275 7420 6d61 7472 6978  eded. But matrix
-00036a80: 2d63 6f6d 6d61 6e64 6572 206e 6565 6473  -commander needs
-00036a90: 0a20 2020 2023 2075 7365 725f 6964 2066  .    # user_id f
-00036aa0: 6f72 2063 7265 6465 6e74 6961 6c73 2066  or credentials f
-00036ab0: 6f72 2061 7267 756d 656e 7473 206c 696b  or arguments lik
-00036ac0: 6520 2d2d 7768 6f61 6d69 2e0a 2020 2020  e --whoami..    
-00036ad0: 2320 466f 7220 5353 4f2c 2077 6520 6765  # For SSO, we ge
-00036ae0: 7420 7468 6520 7573 6572 5f69 6420 6672  t the user_id fr
-00036af0: 6f6d 206c 6f67 696e 2829 2041 5049 2063  om login() API c
-00036b00: 616c 6c2c 2069 2e65 2e20 6672 6f6d 2073  all, i.e. from s
-00036b10: 6572 7665 722e 0a20 2020 2069 6620 6773  erver..    if gs
-00036b20: 2e70 612e 7573 6572 5f6c 6f67 696e 3a0a  .pa.user_login:.
-00036b30: 2020 2020 2020 2020 7573 6572 5f69 6420          user_id 
-00036b40: 3d20 6773 2e70 612e 7573 6572 5f6c 6f67  = gs.pa.user_log
-00036b50: 696e 0a20 2020 2065 6c73 653a 0a20 2020  in.    else:.   
-00036b60: 2020 2020 2075 7365 725f 6964 203d 204e       user_id = N
-00036b70: 6f6e 650a 2020 2020 6966 206d 6574 686f  one.    if metho
-00036b80: 6420 3d3d 2022 7061 7373 776f 7264 2220  d == "password" 
-00036b90: 616e 6420 6e6f 7420 7573 6572 5f69 643a  and not user_id:
-00036ba0: 0a20 2020 2020 2020 2069 6e74 6572 6163  .        interac
-00036bb0: 7469 7665 203d 2054 7275 650a 2020 2020  tive = True.    
-00036bc0: 2020 2020 7573 6572 5f69 6420 3d20 2240      user_id = "@
-00036bd0: 6a6f 686e 3a65 7861 6d70 6c65 2e6f 7267  john:example.org
-00036be0: 220a 2020 2020 2020 2020 7573 6572 5f69  ".        user_i
-00036bf0: 6432 203d 2022 406a 6f68 6e3a 2220 2b20  d2 = "@john:" + 
-00036c00: 686f 6d65 7365 7276 6572 5f73 686f 7274  homeserver_short
-00036c10: 0a20 2020 2020 2020 2075 7365 725f 6964  .        user_id
-00036c20: 203d 2069 6e70 7574 280a 2020 2020 2020   = input(.      
-00036c30: 2020 2020 2020 6622 456e 7465 7220 796f        f"Enter yo
-00036c40: 7572 2075 7365 7220 4944 3a20 205b 7b75  ur user ID:  [{u
-00036c50: 7365 725f 6964 7d5d 2020 6f72 2020 5b6a  ser_id}]  or  [j
-00036c60: 6f68 6e5d 2066 6f72 207b 7573 6572 5f69  ohn] for {user_i
-00036c70: 6432 7d20 3a20 220a 2020 2020 2020 2020  d2} : ".        
-00036c80: 292e 7374 7269 7028 290a 2020 2020 6966  ).strip().    if
-00036c90: 206d 6574 686f 6420 3d3d 2022 7061 7373   method == "pass
-00036ca0: 776f 7264 223a 0a20 2020 2020 2020 2069  word":.        i
-00036cb0: 6620 6773 2e70 612e 7061 7373 776f 7264  f gs.pa.password
-00036cc0: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
-00036cd0: 7373 776f 7264 203d 2067 732e 7061 2e70  ssword = gs.pa.p
-00036ce0: 6173 7377 6f72 640a 2020 2020 2020 2020  assword.        
-00036cf0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00036d00: 2020 696e 7465 7261 6374 6976 6520 3d20    interactive = 
-00036d10: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-00036d20: 2070 7269 6e74 2822 506c 6561 7365 2070   print("Please p
-00036d30: 726f 7669 6465 2079 6f75 7220 4d61 7472  rovide your Matr
-00036d40: 6978 2061 6363 6f75 6e74 2070 6173 7377  ix account passw
-00036d50: 6f72 642e 2229 0a20 2020 2020 2020 2020  ord.").         
-00036d60: 2020 2070 6173 7377 6f72 6420 3d20 6765     password = ge
-00036d70: 7470 6173 732e 6765 7470 6173 7328 290a  tpass.getpass().
-00036d80: 2020 2020 656c 6966 206d 6574 686f 6420      elif method 
-00036d90: 3d3d 2022 7373 6f22 3a0a 2020 2020 2020  == "sso":.      
-00036da0: 2020 7061 7373 776f 7264 203d 204e 6f6e    password = Non
-00036db0: 650a 2020 2020 6966 2067 732e 7061 2e64  e.    if gs.pa.d
-00036dc0: 6576 6963 6520 6973 206e 6f74 204e 6f6e  evice is not Non
-00036dd0: 653a 2020 2320 736f 6d65 7468 696e 6720  e:  # something 
-00036de0: 7761 7320 7370 6563 6966 6965 640a 2020  was specified.  
-00036df0: 2020 2020 2020 6465 7669 6365 5f6e 616d        device_nam
-00036e00: 6520 3d20 6773 2e70 612e 6465 7669 6365  e = gs.pa.device
-00036e10: 2e73 7472 6970 2829 0a20 2020 2020 2020  .strip().       
-00036e20: 2069 6620 6465 7669 6365 5f6e 616d 6520   if device_name 
-00036e30: 3d3d 2022 223a 0a20 2020 2020 2020 2020  == "":.         
-00036e40: 2020 2064 6576 6963 655f 6e61 6d65 203d     device_name =
-00036e50: 2050 524f 475f 5749 5448 4f55 545f 4558   PROG_WITHOUT_EX
-00036e60: 5420 2023 2064 6566 6175 6c74 0a20 2020  T  # default.   
-00036e70: 2065 6c73 653a 0a20 2020 2020 2020 2069   else:.        i
-00036e80: 6e74 6572 6163 7469 7665 203d 2054 7275  nteractive = Tru
-00036e90: 650a 2020 2020 2020 2020 6465 7669 6365  e.        device
-00036ea0: 5f6e 616d 6520 3d20 5052 4f47 5f57 4954  _name = PROG_WIT
-00036eb0: 484f 5554 5f45 5854 0a20 2020 2020 2020  HOUT_EXT.       
-00036ec0: 2064 6576 6963 655f 6e61 6d65 203d 2069   device_name = i
-00036ed0: 6e70 7574 280a 2020 2020 2020 2020 2020  nput(.          
-00036ee0: 2020 6622 4368 6f6f 7365 2061 206e 616d    f"Choose a nam
-00036ef0: 6520 666f 7220 7468 6973 2064 6576 6963  e for this devic
-00036f00: 653a 205b 7b64 6576 6963 655f 6e61 6d65  e: [{device_name
-00036f10: 7d5d 2022 0a20 2020 2020 2020 2029 2e73  }] ".        ).s
-00036f20: 7472 6970 2829 0a20 2020 2020 2020 2069  trip().        i
-00036f30: 6620 6465 7669 6365 5f6e 616d 6520 3d3d  f device_name ==
-00036f40: 2022 223a 0a20 2020 2020 2020 2020 2020   "":.           
-00036f50: 2064 6576 6963 655f 6e61 6d65 203d 2050   device_name = P
-00036f60: 524f 475f 5749 5448 4f55 545f 4558 5420  ROG_WITHOUT_EXT 
-00036f70: 2023 2064 6566 6175 6c74 0a20 2020 2069   # default.    i
-00036f80: 6620 6773 2e70 612e 726f 6f6d 5f64 6566  f gs.pa.room_def
-00036f90: 6175 6c74 2069 7320 6e6f 7420 4e6f 6e65  ault is not None
-00036fa0: 3a20 2023 2073 6f6d 6574 6869 6e67 2077  :  # something w
-00036fb0: 6173 2073 7065 6369 6669 6564 0a20 2020  as specified.   
-00036fc0: 2020 2020 2072 6f6f 6d5f 6964 203d 2067       room_id = g
-00036fd0: 732e 7061 2e72 6f6f 6d5f 6465 6661 756c  s.pa.room_defaul
-00036fe0: 742e 7374 7269 7028 290a 2020 2020 2020  t.strip().      
-00036ff0: 2020 726f 6f6d 5f69 6420 3d20 726f 6f6d    room_id = room
-00037000: 5f69 642e 7265 706c 6163 6528 7222 5c21  _id.replace(r"\!
-00037010: 222c 2022 2122 2920 2023 2072 656d 6f76  ", "!")  # remov
-00037020: 6520 706f 7373 6962 6c65 2065 7363 6170  e possible escap
-00037030: 650a 2020 2020 656c 7365 3a0a 2020 2020  e.    else:.    
-00037040: 2020 2020 696e 7465 7261 6374 6976 6520      interactive 
-00037050: 3d20 5472 7565 0a20 2020 2020 2020 2072  = True.        r
-00037060: 6f6f 6d5f 6964 203d 2022 2153 6f6d 6552  oom_id = "!SomeR
-00037070: 6f6f 6d49 6453 7472 696e 673a 6578 616d  oomIdString:exam
-00037080: 706c 652e 6f72 6722 0a20 2020 2020 2020  ple.org".       
-00037090: 2072 6f6f 6d5f 6964 3220 3d20 2223 616c   room_id2 = "#al
-000370a0: 6961 733a 2220 2b20 686f 6d65 7365 7276  ias:" + homeserv
-000370b0: 6572 5f73 686f 7274 0a20 2020 2020 2020  er_short.       
-000370c0: 2072 6f6f 6d5f 6964 203d 2069 6e70 7574   room_id = input
-000370d0: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
-000370e0: 456e 7465 7220 726f 6f6d 2049 4420 666f  Enter room ID fo
-000370f0: 7220 6465 6661 756c 7420 726f 6f6d 3a20  r default room: 
-00037100: 205b 7b72 6f6f 6d5f 6964 7d5d 2020 220a   [{room_id}]  ".
-00037110: 2020 2020 2020 2020 2020 2020 6622 6f72              f"or
-00037120: 2020 5b61 6c69 6173 5d20 666f 7220 7b72    [alias] for {r
-00037130: 6f6f 6d5f 6964 327d 203a 2022 0a20 2020  oom_id2} : ".   
-00037140: 2020 2020 2029 2e73 7472 6970 2829 0a20       ).strip(). 
-00037150: 2020 2069 6620 7573 6572 5f69 6420 6973     if user_id is
-00037160: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00037170: 2020 2069 6620 6973 5f70 6172 7469 616c     if is_partial
-00037180: 5f75 7365 725f 6964 2875 7365 725f 6964  _user_id(user_id
-00037190: 293a 0a20 2020 2020 2020 2020 2020 2075  ):.            u
-000371a0: 7365 725f 6964 203d 2075 7365 725f 6964  ser_id = user_id
-000371b0: 202b 2022 3a22 202b 2068 6f6d 6573 6572   + ":" + homeser
-000371c0: 7665 725f 7368 6f72 7420 2023 2064 6f6e  ver_short  # don
-000371d0: 7420 7573 6520 666e 0a20 2020 2020 2020  t use fn.       
-000371e0: 2069 6620 6973 5f73 686f 7274 5f75 7365   if is_short_use
-000371f0: 725f 6964 2875 7365 725f 6964 293a 0a20  r_id(user_id):. 
-00037200: 2020 2020 2020 2020 2020 2075 7365 725f             user_
-00037210: 6964 203d 2022 4022 202b 2075 7365 725f  id = "@" + user_
-00037220: 6964 202b 2022 3a22 202b 2068 6f6d 6573  id + ":" + homes
-00037230: 6572 7665 725f 7368 6f72 7420 2023 2064  erver_short  # d
-00037240: 6f6e 7420 7573 6520 666e 0a20 2020 2020  ont use fn.     
-00037250: 2020 2069 6620 6e6f 7420 6973 5f75 7365     if not is_use
-00037260: 725f 6964 2875 7365 725f 6964 293a 0a20  r_id(user_id):. 
-00037270: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00037280: 204d 6174 7269 7843 6f6d 6d61 6e64 6572   MatrixCommander
-00037290: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-000372a0: 2020 2020 2020 2022 4532 3237 3a20 220a         "E227: ".
-000372b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000372c0: 6622 5573 6572 2069 6420 277b 7573 6572  f"User id '{user
-000372d0: 5f69 647d 2720 666f 7220 2d2d 6c6f 6769  _id}' for --logi
-000372e0: 6e20 6973 2069 6e76 616c 6964 2e20 220a  n is invalid. ".
-000372f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037300: 2253 7065 6369 6679 2063 6f72 7265 6374  "Specify correct
-00037310: 2075 7365 7220 6964 2e22 0a20 2020 2020   user id.".     
-00037320: 2020 2020 2020 2029 2066 726f 6d20 4e6f         ) from No
-00037330: 6e65 0a20 2020 2069 6620 6973 5f73 686f  ne.    if is_sho
-00037340: 7274 5f72 6f6f 6d5f 616c 6961 7328 726f  rt_room_alias(ro
-00037350: 6f6d 5f69 6429 3a0a 2020 2020 2020 2020  om_id):.        
-00037360: 6966 2072 6f6f 6d5f 6964 5b30 5d20 213d  if room_id[0] !=
-00037370: 2022 2322 3a0a 2020 2020 2020 2020 2020   "#":.          
-00037380: 2020 726f 6f6d 5f69 6420 3d20 2223 2220    room_id = "#" 
-00037390: 2b20 726f 6f6d 5f69 640a 2020 2020 2020  + room_id.      
-000373a0: 2020 726f 6f6d 5f69 6420 3d20 726f 6f6d    room_id = room
-000373b0: 5f69 6420 2b20 223a 2220 2b20 686f 6d65  _id + ":" + home
-000373c0: 7365 7276 6572 5f73 686f 7274 2020 2320  server_short  # 
-000373d0: 646f 6e74 2075 7365 2066 6e0a 2020 2020  dont use fn.    
-000373e0: 6966 206e 6f74 2069 735f 726f 6f6d 2872  if not is_room(r
-000373f0: 6f6f 6d5f 6964 293a 0a20 2020 2020 2020  oom_id):.       
-00037400: 2072 6169 7365 204d 6174 7269 7843 6f6d   raise MatrixCom
-00037410: 6d61 6e64 6572 4572 726f 7228 0a20 2020  manderError(.   
-00037420: 2020 2020 2020 2020 2022 4532 3238 3a20           "E228: 
-00037430: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
-00037440: 526f 6f6d 2069 6420 277b 726f 6f6d 5f69  Room id '{room_i
-00037450: 647d 2720 666f 7220 2d2d 6c6f 6769 6e20  d}' for --login 
-00037460: 6973 2069 6e76 616c 6964 2e20 220a 2020  is invalid. ".  
-00037470: 2020 2020 2020 2020 2020 2253 7065 6369            "Speci
-00037480: 6679 2063 6f72 7265 6374 2072 6f6f 6d20  fy correct room 
-00037490: 6964 2e22 0a20 2020 2020 2020 2029 2066  id.".        ) f
-000374a0: 726f 6d20 4e6f 6e65 0a0a 2020 2020 6773  rom None..    gs
-000374b0: 2e6c 6f67 2e69 6e66 6f28 6622 5468 6520  .log.info(f"The 
-000374c0: 7072 6f76 6964 6564 206c 6f67 696e 2064  provided login d
-000374d0: 6174 6120 6973 3a20 686f 6d65 7365 7276  ata is: homeserv
-000374e0: 6572 3d27 7b68 6f6d 6573 6572 7665 727d  er='{homeserver}
-000374f0: 2722 290a 2020 2020 6773 2e6c 6f67 2e69  '").    gs.log.i
-00037500: 6e66 6f28 6622 2020 2020 2020 2020 2020  nfo(f"          
-00037510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037520: 2020 7573 6572 2069 643d 277b 7573 6572    user id='{user
-00037530: 5f69 647d 2722 290a 2020 2020 2320 6773  _id}'").    # gs
-00037540: 2e6c 6f67 2e69 6e66 6f28 6622 2020 2020  .log.info(f"    
-00037550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037560: 2020 2020 2020 2020 7061 7373 776f 7264          password
-00037570: 3d27 7b70 6173 7377 6f72 647d 2722 290a  ='{password}'").
-00037580: 2020 2020 6773 2e6c 6f67 2e69 6e66 6f28      gs.log.info(
-00037590: 6622 2020 2020 2020 2020 2020 2020 2020  f"              
-000375a0: 2020 2020 2020 2020 2020 2020 2020 6465                de
-000375b0: 7669 6365 206e 616d 653d 277b 6465 7669  vice name='{devi
-000375c0: 6365 5f6e 616d 657d 2722 290a 2020 2020  ce_name}'").    
-000375d0: 6773 2e6c 6f67 2e69 6e66 6f28 6622 2020  gs.log.info(f"  
-000375e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000375f0: 2020 2020 2020 2020 2020 726f 6f6d 2069            room i
-00037600: 643d 277b 726f 6f6d 5f69 647d 2722 290a  d='{room_id}'").
-00037610: 2020 2020 6966 2069 6e74 6572 6163 7469      if interacti
-00037620: 7665 3a0a 2020 2020 2020 2020 7072 696e  ve:.        prin
-00037630: 7428 6622 5468 6520 7072 6f76 6964 6564  t(f"The provided
-00037640: 206c 6f67 696e 2064 6174 6120 6973 3a20   login data is: 
-00037650: 686f 6d65 7365 7276 6572 3d27 7b68 6f6d  homeserver='{hom
-00037660: 6573 6572 7665 727d 2722 290a 2020 2020  eserver}'").    
-00037670: 2020 2020 7072 696e 7428 6622 2020 2020      print(f"    
-00037680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037690: 2020 2020 2020 2020 7573 6572 2069 643d          user id=
-000376a0: 277b 7573 6572 5f69 647d 2722 290a 2020  '{user_id}'").  
-000376b0: 2020 2020 2020 2320 7072 696e 7428 6622        # print(f"
-000376c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000376d0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-000376e0: 776f 7264 3d27 7b70 6173 7377 6f72 647d  word='{password}
-000376f0: 2722 290a 2020 2020 2020 2020 7072 696e  '").        prin
-00037700: 7428 2220 2020 2020 2020 2020 2020 2020  t("             
-00037710: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00037720: 6173 7377 6f72 643d 272a 2a2a 2722 290a  assword='***'").
-00037730: 2020 2020 2020 2020 7072 696e 7428 6622          print(f"
-00037740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037750: 2020 2020 2020 2020 2020 2020 6465 7669              devi
-00037760: 6365 206e 616d 653d 277b 6465 7669 6365  ce name='{device
-00037770: 5f6e 616d 657d 2722 290a 2020 2020 2020  _name}'").      
-00037780: 2020 7072 696e 7428 0a20 2020 2020 2020    print(.       
-00037790: 2020 2020 2066 2220 2020 2020 2020 2020       f"         
-000377a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000377b0: 2020 2072 6f6f 6d20 6964 3d27 7b72 6f6f     room id='{roo
-000377c0: 6d5f 6964 7d27 222c 0a20 2020 2020 2020  m_id}'",.       
-000377d0: 2020 2020 2066 6c75 7368 3d54 7275 652c       flush=True,
-000377e0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-000377f0: 2020 2063 6f6e 6669 726d 203d 2069 6e70     confirm = inp
-00037800: 7574 2822 436f 7272 6563 743f 2028 5965  ut("Correct? (Ye
-00037810: 7320 6f72 2043 7472 6c2d 4320 746f 2061  s or Ctrl-C to a
-00037820: 626f 7274 2920 2229 0a20 2020 2020 2020  bort) ").       
-00037830: 2069 6620 636f 6e66 6972 6d2e 6c6f 7765   if confirm.lowe
-00037840: 7228 2920 213d 2022 7965 7322 2061 6e64  r() != "yes" and
-00037850: 2063 6f6e 6669 726d 2e6c 6f77 6572 2829   confirm.lower()
-00037860: 2021 3d20 2279 223a 0a20 2020 2020 2020   != "y":.       
-00037870: 2020 2020 2070 7269 6e74 280a 2020 2020       print(.    
-00037880: 2020 2020 2020 2020 2020 2020 2222 2c0a              "",.
-00037890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000378a0: 666c 7573 683d 5472 7565 2c0a 2020 2020  flush=True,.    
-000378b0: 2020 2020 2020 2020 2920 2023 2061 6464          )  # add
-000378c0: 206e 6577 6c69 6e65 2074 6f20 7374 646f   newline to stdo
-000378d0: 7574 2074 6f20 7365 7061 7261 7465 2061  ut to separate a
-000378e0: 6e79 206c 6f67 2069 6e66 6f0a 2020 2020  ny log info.    
-000378f0: 2020 2020 2020 2020 6773 2e6c 6f67 2e69          gs.log.i
-00037900: 6e66 6f28 2241 626f 7274 696e 6720 6475  nfo("Aborting du
-00037910: 6520 746f 2075 7365 7220 7265 7175 6573  e to user reques
-00037920: 742e 2229 0a20 2020 2020 2020 2020 2020  t.").           
-00037930: 2072 6574 7572 6e0a 0a20 2020 2023 2061   return..    # a
-00037940: 6c6c 2074 6865 2069 6e70 7574 2072 6571  ll the input req
-00037950: 7569 7265 6420 666f 7220 6c6f 6769 6e20  uired for login 
-00037960: 6973 2063 6f6c 6c65 6374 6564 2c0a 2020  is collected,.  
-00037970: 2020 2320 6c61 7465 7220 7765 2067 6574    # later we get
-00037980: 2075 7365 725f 6964 2066 6f72 2053 534f   user_id for SSO
-00037990: 2028 7265 7475 726e 6564 2061 7420 6c6f   (returned at lo
-000379a0: 6769 6e20 4150 4920 6361 6c6c 290a 0a20  gin API call).. 
-000379b0: 2020 2069 6620 6773 2e70 612e 7072 6f78     if gs.pa.prox
-000379c0: 793a 0a20 2020 2020 2020 2067 732e 6c6f  y:.        gs.lo
-000379d0: 672e 696e 666f 2866 2250 726f 7879 207b  g.info(f"Proxy {
-000379e0: 6773 2e70 612e 7072 6f78 797d 2077 696c  gs.pa.proxy} wil
-000379f0: 6c20 6265 2075 7365 642e 2229 0a0a 2020  l be used.")..  
-00037a00: 2020 2320 6368 6563 6b20 666f 7220 7061    # check for pa
-00037a10: 7373 776f 7264 2f53 534f 0a20 2020 2063  ssword/SSO.    c
-00037a20: 6f6e 6e65 6374 6f72 203d 2054 4350 436f  onnector = TCPCo
-00037a30: 6e6e 6563 746f 7228 7373 6c3d 6773 2e73  nnector(ssl=gs.s
-00037a40: 736c 2920 2023 2073 6574 7469 6e67 2073  sl)  # setting s
-00037a50: 736c 636f 6e74 6578 740a 2020 2020 6173  slcontext.    as
-00037a60: 796e 6320 7769 7468 2043 6c69 656e 7453  ync with ClientS
-00037a70: 6573 7369 6f6e 2863 6f6e 6e65 6374 6f72  ession(connector
-00037a80: 3d63 6f6e 6e65 6374 6f72 2920 6173 2073  =connector) as s
-00037a90: 6573 7369 6f6e 3a20 2023 2061 696f 6874  ession:  # aioht
-00037aa0: 7470 0a20 2020 2020 2020 2061 7379 6e63  tp.        async
-00037ab0: 2077 6974 6820 7365 7373 696f 6e2e 6765   with session.ge
-00037ac0: 7428 0a20 2020 2020 2020 2020 2020 2066  t(.            f
-00037ad0: 227b 686f 6d65 7365 7276 6572 7d2f 5f6d  "{homeserver}/_m
-00037ae0: 6174 7269 782f 636c 6965 6e74 2f72 302f  atrix/client/r0/
-00037af0: 6c6f 6769 6e22 2c0a 2020 2020 2020 2020  login",.        
-00037b00: 2020 2020 7261 6973 655f 666f 725f 7374      raise_for_st
-00037b10: 6174 7573 3d54 7275 652c 0a20 2020 2020  atus=True,.     
-00037b20: 2020 2020 2020 2070 726f 7879 3d67 732e         proxy=gs.
-00037b30: 7061 2e70 726f 7879 2c0a 2020 2020 2020  pa.proxy,.      
-00037b40: 2020 2920 6173 2072 6573 706f 6e73 653a    ) as response:
-00037b50: 0a20 2020 2020 2020 2020 2020 2066 6c6f  .            flo
-00037b60: 775f 7479 7065 7320 3d20 7b0a 2020 2020  w_types = {.    
-00037b70: 2020 2020 2020 2020 2020 2020 785b 2274              x["t
-00037b80: 7970 6522 5d20 666f 7220 7820 696e 2028  ype"] for x in (
-00037b90: 6177 6169 7420 7265 7370 6f6e 7365 2e6a  await response.j
-00037ba0: 736f 6e28 2929 2e67 6574 2822 666c 6f77  son()).get("flow
-00037bb0: 7322 2c20 5b5d 290a 2020 2020 2020 2020  s", []).        
-00037bc0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00037bd0: 2020 6773 2e6c 6f67 2e64 6562 7567 2822    gs.log.debug("
-00037be0: 5375 7070 6f72 7465 6420 6c6f 6769 6e20  Supported login 
-00037bf0: 666c 6f77 733a 2025 7222 2c20 666c 6f77  flows: %r", flow
-00037c00: 5f74 7970 6573 290a 0a20 2020 2020 2020  _types)..       
-00037c10: 2020 2020 2023 2074 6f6b 656e 5f61 7661       # token_ava
-00037c20: 696c 6162 6c65 203d 2022 6d2e 6c6f 6769  ilable = "m.logi
-00037c30: 6e2e 746f 6b65 6e22 2069 6e20 666c 6f77  n.token" in flow
-00037c40: 5f74 7970 6573 0a20 2020 2020 2020 2020  _types.         
-00037c50: 2020 2023 206d 2e6c 6f67 696e 2e74 6f6b     # m.login.tok
-00037c60: 656e 2064 6f65 7320 6e6f 7420 7265 6665  en does not refe
-00037c70: 7220 746f 2073 7464 2061 6363 6573 732d  r to std access-
-00037c80: 746f 6b65 6e20 6c6f 6769 6e0a 2020 2020  token login.    
-00037c90: 2020 2020 2020 2020 7061 7373 776f 7264          password
-00037ca0: 5f61 7661 696c 6162 6c65 203d 2022 6d2e  _available = "m.
-00037cb0: 6c6f 6769 6e2e 7061 7373 776f 7264 2220  login.password" 
-00037cc0: 696e 2066 6c6f 775f 7479 7065 730a 2020  in flow_types.  
-00037cd0: 2020 2020 2020 2020 2020 7373 6f5f 6176            sso_av
-00037ce0: 6169 6c61 626c 6520 3d20 280a 2020 2020  ailable = (.    
-00037cf0: 2020 2020 2020 2020 2020 2020 226d 2e6c              "m.l
-00037d00: 6f67 696e 2e73 736f 2220 696e 2066 6c6f  ogin.sso" in flo
-00037d10: 775f 7479 7065 7320 616e 6420 226d 2e6c  w_types and "m.l
-00037d20: 6f67 696e 2e74 6f6b 656e 2220 696e 2066  ogin.token" in f
-00037d30: 6c6f 775f 7479 7065 730a 2020 2020 2020  low_types.      
-00037d40: 2020 2020 2020 290a 0a20 2020 2069 6620        )..    if 
-00037d50: 6d65 7468 6f64 203d 3d20 2273 736f 2220  method == "sso" 
-00037d60: 616e 6420 6e6f 7420 7373 6f5f 6176 6169  and not sso_avai
-00037d70: 6c61 626c 653a 0a20 2020 2020 2020 2072  lable:.        r
-00037d80: 6169 7365 204d 6174 7269 7843 6f6d 6d61  aise MatrixComma
-00037d90: 6e64 6572 4572 726f 7228 0a20 2020 2020  nderError(.     
-00037da0: 2020 2020 2020 2022 4532 3239 3a20 220a         "E229: ".
-00037db0: 2020 2020 2020 2020 2020 2020 224d 6574              "Met
-00037dc0: 686f 6420 2773 736f 2720 7761 7320 7365  hod 'sso' was se
-00037dd0: 6c65 6374 6564 2066 6f72 202d 2d6c 6f67  lected for --log
-00037de0: 696e 2062 7574 204d 6174 7269 7820 7365  in but Matrix se
-00037df0: 7276 6572 2064 6f65 7320 220a 2020 2020  rver does ".    
-00037e00: 2020 2020 2020 2020 226e 6f74 2073 7570          "not sup
-00037e10: 706f 7274 2053 696e 676c 6520 5369 676e  port Single Sign
-00037e20: 2d4f 6e2e 2054 7279 202d 2d6c 6f67 696e  -On. Try --login
-00037e30: 2077 6974 6820 6d65 7468 6f64 2027 7061   with method 'pa
-00037e40: 7373 776f 7264 272e 220a 2020 2020 2020  ssword'.".      
-00037e50: 2020 2920 6672 6f6d 204e 6f6e 650a 2020    ) from None.  
-00037e60: 2020 6966 206d 6574 686f 6420 3d3d 2022    if method == "
-00037e70: 7061 7373 776f 7264 2220 616e 6420 6e6f  password" and no
-00037e80: 7420 7061 7373 776f 7264 5f61 7661 696c  t password_avail
-00037e90: 6162 6c65 3a0a 2020 2020 2020 2020 7261  able:.        ra
-00037ea0: 6973 6520 4d61 7472 6978 436f 6d6d 616e  ise MatrixComman
-00037eb0: 6465 7245 7272 6f72 280a 2020 2020 2020  derError(.      
-00037ec0: 2020 2020 2020 2245 3233 303a 2022 0a20        "E230: ". 
-00037ed0: 2020 2020 2020 2020 2020 2022 4d65 7468             "Meth
-00037ee0: 6f64 2027 7061 7373 776f 7264 2720 7761  od 'password' wa
-00037ef0: 7320 7365 6c65 6374 6564 2066 6f72 202d  s selected for -
-00037f00: 2d6c 6f67 696e 2062 7574 204d 6174 7269  -login but Matri
-00037f10: 7820 7365 7276 6572 2022 0a20 2020 2020  x server ".     
-00037f20: 2020 2020 2020 2022 646f 6573 206e 6f74         "does not
-00037f30: 2073 7570 706f 7274 2070 6173 7377 6f72   support passwor
-00037f40: 6420 6c6f 6769 6e2e 2054 7279 202d 2d6c  d login. Try --l
-00037f50: 6f67 696e 2077 6974 6820 6d65 7468 6f64  ogin with method
-00037f60: 2027 7373 6f27 2e22 0a20 2020 2020 2020   'sso'.".       
-00037f70: 2029 2066 726f 6d20 4e6f 6e65 0a0a 2020   ) from None..  
-00037f80: 2020 2320 5353 4f3a 2053 696e 676c 6520    # SSO: Single 
-00037f90: 5369 676e 2d4f 6e3a 0a20 2020 2023 2073  Sign-On:.    # s
-00037fa0: 6565 2068 7474 7073 3a2f 2f6d 6174 7269  ee https://matri
-00037fb0: 782e 6f72 672f 646f 6373 2f67 7569 6465  x.org/docs/guide
-00037fc0: 732f 7373 6f2d 666f 722d 636c 6965 6e74  s/sso-for-client
-00037fd0: 2d64 6576 656c 6f70 6572 730a 2020 2020  -developers.    
-00037fe0: 6966 2073 736f 5f61 7661 696c 6162 6c65  if sso_available
-00037ff0: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
-00038000: 2e64 6562 7567 2822 5365 7276 6572 2073  .debug("Server s
-00038010: 7570 706f 7274 7320 5353 4f20 666f 7220  upports SSO for 
-00038020: 6c6f 6769 6e2e 2229 0a20 2020 2065 6c73  login.").    els
-00038030: 653a 0a20 2020 2020 2020 2067 732e 6c6f  e:.        gs.lo
-00038040: 672e 6465 6275 6728 2253 6572 7665 7220  g.debug("Server 
-00038050: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-00038060: 2053 534f 2066 6f72 206c 6f67 696e 2e22   SSO for login."
-00038070: 290a 0a20 2020 2069 6620 6d65 7468 6f64  )..    if method
-00038080: 203d 3d20 2273 736f 223a 0a20 2020 2020   == "sso":.     
-00038090: 2020 2023 2073 7461 7274 7570 2073 6572     # startup ser
-000380a0: 7665 7220 746f 2068 616e 646c 6520 7265  ver to handle re
-000380b0: 7370 6f6e 7365 0a20 2020 2020 2020 2073  sponse.        s
-000380c0: 746f 705f 7365 7276 6572 5f65 7674 203d  top_server_evt =
-000380d0: 2061 7379 6e63 696f 2e45 7665 6e74 2829   asyncio.Event()
-000380e0: 0a20 2020 2020 2020 206c 6f67 696e 5f74  .        login_t
-000380f0: 6f6b 656e 203d 204e 6f6e 650a 0a20 2020  oken = None..   
-00038100: 2020 2020 2061 7379 6e63 2064 6566 2068       async def h
-00038110: 616e 646c 6528 7265 7175 6573 7429 3a0a  andle(request):.
-00038120: 2020 2020 2020 2020 2020 2020 6e6f 6e6c              nonl
-00038130: 6f63 616c 206c 6f67 696e 5f74 6f6b 656e  ocal login_token
-00038140: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-00038150: 696e 5f74 6f6b 656e 203d 2072 6571 7565  in_token = reque
-00038160: 7374 2e71 7565 7279 2e67 6574 2822 6c6f  st.query.get("lo
-00038170: 6769 6e54 6f6b 656e 2229 0a20 2020 2020  ginToken").     
-00038180: 2020 2020 2020 2073 746f 705f 7365 7276         stop_serv
-00038190: 6572 5f65 7674 2e73 6574 2829 0a20 2020  er_evt.set().   
-000381a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000381b0: 7765 622e 5265 7370 6f6e 7365 280a 2020  web.Response(.  
-000381c0: 2020 2020 2020 2020 2020 2020 2020 626f                bo
-000381d0: 6479 3d22 4c6f 6769 6e20 636f 6d70 6c65  dy="Login comple
-000381e0: 7465 2e20 596f 7520 6361 6e20 6e6f 7720  te. You can now 
-000381f0: 636c 6f73 6520 7468 6973 2070 6167 652e  close this page.
-00038200: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-00038210: 0a20 2020 2020 2020 2061 7070 203d 2077  .        app = w
-00038220: 6562 2e41 7070 6c69 6361 7469 6f6e 2829  eb.Application()
-00038230: 0a20 2020 2020 2020 2061 7070 2e61 6464  .        app.add
-00038240: 5f72 6f75 7465 7328 5b77 6562 2e67 6574  _routes([web.get
-00038250: 2822 2f22 2c20 6861 6e64 6c65 295d 290a  ("/", handle)]).
-00038260: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
-00038270: 2e67 6574 4c6f 6767 6572 2822 6169 6f68  .getLogger("aioh
-00038280: 7474 702e 6163 6365 7373 2229 2e73 6574  ttp.access").set
-00038290: 4c65 7665 6c28 6c6f 6767 696e 672e 5741  Level(logging.WA
-000382a0: 524e 494e 4729 0a20 2020 2020 2020 2072  RNING).        r
-000382b0: 756e 6e65 7220 3d20 7765 622e 4170 7052  unner = web.AppR
-000382c0: 756e 6e65 7228 6170 7029 0a20 2020 2020  unner(app).     
-000382d0: 2020 2061 7761 6974 2072 756e 6e65 722e     await runner.
-000382e0: 7365 7475 7028 290a 2020 2020 2020 2020  setup().        
-000382f0: 7369 7465 203d 2077 6562 2e54 4350 5369  site = web.TCPSi
-00038300: 7465 2872 756e 6e65 722c 2022 6c6f 6361  te(runner, "loca
-00038310: 6c68 6f73 7422 2c20 3338 3038 3029 0a20  lhost", 38080). 
-00038320: 2020 2020 2020 2061 7761 6974 2073 6974         await sit
-00038330: 652e 7374 6172 7428 290a 0a20 2020 2020  e.start()..     
-00038340: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00038350: 2020 2020 6773 2e6c 6f67 2e69 6e66 6f28      gs.log.info(
-00038360: 224c 6175 6e63 6869 6e67 2062 726f 7773  "Launching brows
-00038370: 6572 2074 6f20 636f 6d70 6c65 7465 2053  er to complete S
-00038380: 534f 206c 6f67 696e 2e22 290a 2020 2020  SO login.").    
-00038390: 2020 2020 2020 2020 6966 2067 732e 7061          if gs.pa
-000383a0: 2e70 726f 7879 3a0a 2020 2020 2020 2020  .proxy:.        
-000383b0: 2020 2020 2020 2020 6773 2e6c 6f67 2e77          gs.log.w
-000383c0: 6172 6e69 6e67 280a 2020 2020 2020 2020  arning(.        
-000383d0: 2020 2020 2020 2020 2020 2020 2257 3131              "W11
-000383e0: 303a 2022 0a20 2020 2020 2020 2020 2020  0: ".           
-000383f0: 2020 2020 2020 2020 2066 2253 7065 6369           f"Speci
-00038400: 6669 6564 2070 726f 7879 207b 6773 2e70  fied proxy {gs.p
-00038410: 612e 7072 6f78 797d 2063 616e 6e6f 7420  a.proxy} cannot 
-00038420: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00038430: 2020 2020 2020 2262 6520 636f 6e66 6967        "be config
-00038440: 7572 6564 2066 6f72 2062 726f 7773 6572  ured for browser
-00038450: 2e22 0a20 2020 2020 2020 2020 2020 2020  .".             
-00038460: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00038470: 2020 2020 2067 732e 7761 726e 5f63 6f75       gs.warn_cou
-00038480: 6e74 202b 3d20 310a 0a20 2020 2020 2020  nt += 1..       
-00038490: 2020 2020 2023 206c 6175 6e63 6820 7765       # launch we
-000384a0: 622d 6272 6f77 7365 720a 2020 2020 2020  b-browser.      
-000384b0: 2020 2020 2020 6966 2073 7973 2e70 6c61        if sys.pla
-000384c0: 7466 6f72 6d2e 7374 6172 7473 7769 7468  tform.startswith
-000384d0: 2822 6461 7277 696e 2229 3a0a 2020 2020  ("darwin"):.    
-000384e0: 2020 2020 2020 2020 2020 2020 636d 6420              cmd 
-000384f0: 3d20 5b73 6875 7469 6c2e 7768 6963 6828  = [shutil.which(
-00038500: 226f 7065 6e22 295d 0a20 2020 2020 2020  "open")].       
-00038510: 2020 2020 2065 6c69 6620 7379 732e 706c       elif sys.pl
-00038520: 6174 666f 726d 2e73 7461 7274 7377 6974  atform.startswit
-00038530: 6828 2277 696e 2229 3a0a 2020 2020 2020  h("win"):.      
-00038540: 2020 2020 2020 2020 2020 636d 6420 3d20            cmd = 
-00038550: 5b22 7374 6172 7422 5d0a 2020 2020 2020  ["start"].      
-00038560: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00038570: 2020 2020 2020 2020 2020 2020 636d 6420              cmd 
-00038580: 3d20 5b73 6875 7469 6c2e 7768 6963 6828  = [shutil.which(
-00038590: 2278 6467 2d6f 7065 6e22 295d 0a20 2020  "xdg-open")].   
-000385a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000385b0: 636d 6420 3d3d 205b 4e6f 6e65 5d3a 0a20  cmd == [None]:. 
-000385c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000385d0: 2020 2063 6d64 203d 205b 7368 7574 696c     cmd = [shutil
-000385e0: 2e77 6869 6368 2822 782d 7777 772d 6272  .which("x-www-br
-000385f0: 6f77 7365 7222 295d 0a20 2020 2020 2020  owser")].       
-00038600: 2020 2020 2063 6d64 2e61 7070 656e 6428       cmd.append(
-00038610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00038620: 2066 227b 686f 6d65 7365 7276 6572 7d2f   f"{homeserver}/
-00038630: 5f6d 6174 7269 782f 636c 6965 6e74 2f72  _matrix/client/r
-00038640: 302f 6c6f 6769 6e2f 7373 6f2f 7265 6469  0/login/sso/redi
-00038650: 7265 6374 220a 2020 2020 2020 2020 2020  rect".          
-00038660: 2020 2020 2020 223f 7265 6469 7265 6374        "?redirect
-00038670: 5572 6c3d 6874 7470 3a2f 2f6c 6f63 616c  Url=http://local
-00038680: 686f 7374 3a33 3830 3830 2f22 0a20 2020  host:38080/".   
-00038690: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000386a0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-000386b0: 2020 2020 2020 2020 2020 2020 7375 6270              subp
-000386c0: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
-000386d0: 7075 7428 636d 6429 0a20 2020 2020 2020  put(cmd).       
-000386e0: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
-000386f0: 7074 696f 6e3a 0a20 2020 2020 2020 2020  ption:.         
-00038700: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
-00038710: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-00038720: 2020 2020 2020 2020 2022 4532 3331 3a20           "E231: 
-00038730: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00038740: 2020 2020 2020 2242 726f 7773 6572 2063        "Browser c
-00038750: 6f75 6c64 206e 6f74 2062 6520 6c61 756e  ould not be laun
-00038760: 6368 6564 2e20 220a 2020 2020 2020 2020  ched. ".        
-00038770: 2020 2020 2020 2020 2020 2020 2248 656e              "Hen
-00038780: 6365 2053 534f 2028 5369 6e67 6c65 2053  ce SSO (Single S
-00038790: 6967 6e2d 4f6e 2920 6c6f 6769 6e20 636f  ign-On) login co
-000387a0: 756c 6420 6e6f 7420 6265 2022 0a20 2020  uld not be ".   
-000387b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000387c0: 2022 636f 6d70 6c65 7465 642e 2053 6f72   "completed. Sor
-000387d0: 7279 2e20 4966 2079 6f75 2074 6869 6e6b  ry. If you think
-000387e0: 2074 6865 2062 726f 7773 6572 2061 6e64   the browser and
-000387f0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00038800: 2020 2020 2020 2022 5353 4f20 7368 6f75         "SSO shou
-00038810: 6c64 2077 6f72 6b20 7468 656e 2074 7279  ld work then try
-00038820: 2061 6761 696e 2e20 4966 2079 6f75 2064   again. If you d
-00038830: 6f20 6e6f 7420 6861 7665 2022 0a20 2020  o not have ".   
-00038840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038850: 2022 6120 6272 6f77 7365 7220 6f72 2064   "a browser or d
-00038860: 6f6e 2774 2077 616e 7420 5353 4f20 6f72  on't want SSO or
-00038870: 2077 616e 7420 746f 206c 6f67 696e 2077   want to login w
-00038880: 6974 6820 6120 220a 2020 2020 2020 2020  ith a ".        
-00038890: 2020 2020 2020 2020 2020 2020 2270 6173              "pas
-000388a0: 7377 6f72 6420 696e 7374 6561 642c 2074  sword instead, t
-000388b0: 6865 6e20 7573 6520 272d 2d6c 6f67 696e  hen use '--login
-000388c0: 2070 6173 7377 6f72 6427 2069 6e20 220a   password' in ".
-000388d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000388e0: 2020 2020 2274 6865 2063 6f6d 6d61 6e64      "the command
-000388f0: 206c 696e 652e 220a 2020 2020 2020 2020   line.".        
-00038900: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00038910: 2020 2020 2020 2020 2020 7261 6973 650a            raise.
-00038920: 0a20 2020 2020 2020 2020 2020 2023 2077  .            # w
-00038930: 6169 7420 616e 6420 7368 7574 646f 776e  ait and shutdown
-00038940: 2073 6572 7665 720a 2020 2020 2020 2020   server.        
-00038950: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00038960: 2020 2020 2020 2020 2061 7761 6974 2061           await a
-00038970: 7379 6e63 696f 2e77 6169 745f 666f 7228  syncio.wait_for(
-00038980: 7374 6f70 5f73 6572 7665 725f 6576 742e  stop_server_evt.
-00038990: 7761 6974 2829 2c20 3520 2a20 3630 290a  wait(), 5 * 60).
-000389a0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-000389b0: 7074 2061 7379 6e63 696f 2e54 696d 656f  pt asyncio.Timeo
-000389c0: 7574 4572 726f 723a 0a20 2020 2020 2020  utError:.       
-000389d0: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
-000389e0: 6572 726f 7228 0a20 2020 2020 2020 2020  error(.         
-000389f0: 2020 2020 2020 2020 2020 2022 4532 3332             "E232
-00038a00: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
-00038a10: 2020 2020 2020 2020 6622 5468 6520 7072          f"The pr
-00038a20: 6f67 7261 6d20 7b50 524f 475f 5749 5448  ogram {PROG_WITH
-00038a30: 5f45 5854 7d20 6661 696c 6564 2e20 220a  _EXT} failed. ".
-00038a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038a50: 2020 2020 224e 6f20 7265 7370 6f6e 7365      "No response
-00038a60: 2077 6173 2072 6563 6569 7665 6420 6672   was received fr
-00038a70: 6f6d 2053 534f 2070 726f 7669 6465 722e  om SSO provider.
-00038a80: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00038a90: 2020 2020 2020 2022 5468 6572 6520 7761         "There wa
-00038aa0: 7320 6120 7469 6d65 6f75 742e 2053 6f72  s a timeout. Sor
-00038ab0: 7279 2e22 0a20 2020 2020 2020 2020 2020  ry.".           
-00038ac0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00038ad0: 2020 2020 2020 2072 6169 7365 0a20 2020         raise.   
-00038ae0: 2020 2020 2066 696e 616c 6c79 3a0a 2020       finally:.  
-00038af0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-00038b00: 7275 6e6e 6572 2e63 6c65 616e 7570 2829  runner.cleanup()
-00038b10: 0a0a 2020 2020 2320 436f 6e66 6967 7572  ..    # Configur
-00038b20: 6174 696f 6e20 6f70 7469 6f6e 7320 666f  ation options fo
-00038b30: 7220 7468 6520 4173 796e 6343 6c69 656e  r the AsyncClien
-00038b40: 740a 2020 2020 636c 6965 6e74 5f63 6f6e  t.    client_con
-00038b50: 6669 6720 3d20 4173 796e 6343 6c69 656e  fig = AsyncClien
-00038b60: 7443 6f6e 6669 6728 0a20 2020 2020 2020  tConfig(.       
-00038b70: 206d 6178 5f6c 696d 6974 5f65 7863 6565   max_limit_excee
-00038b80: 6465 643d 302c 0a20 2020 2020 2020 206d  ded=0,.        m
-00038b90: 6178 5f74 696d 656f 7574 733d 302c 0a20  ax_timeouts=0,. 
-00038ba0: 2020 2020 2020 2073 746f 7265 5f73 796e         store_syn
-00038bb0: 635f 746f 6b65 6e73 3d54 7275 652c 0a20  c_tokens=True,. 
-00038bc0: 2020 2020 2020 2065 6e63 7279 7074 696f         encryptio
-00038bd0: 6e5f 656e 6162 6c65 643d 5472 7565 2c0a  n_enabled=True,.
-00038be0: 2020 2020 290a 0a20 2020 2073 746f 7265      )..    store
-00038bf0: 5f63 7265 6174 6528 7374 6f72 655f 6469  _create(store_di
-00038c00: 7229 0a0a 2020 2020 2320 496e 6974 6961  r)..    # Initia
-00038c10: 6c69 7a65 2074 6865 206d 6174 7269 7820  lize the matrix 
-00038c20: 636c 6965 6e74 0a20 2020 2063 6c69 656e  client.    clien
-00038c30: 7420 3d20 4173 796e 6343 6c69 656e 7428  t = AsyncClient(
-00038c40: 0a20 2020 2020 2020 2068 6f6d 6573 6572  .        homeser
-00038c50: 7665 722c 0a20 2020 2020 2020 2022 2220  ver,.        "" 
-00038c60: 6966 206e 6f74 2075 7365 725f 6964 2065  if not user_id e
-00038c70: 6c73 6520 7573 6572 5f69 642c 0a20 2020  lse user_id,.   
-00038c80: 2020 2020 2073 746f 7265 5f70 6174 683d       store_path=
-00038c90: 7374 6f72 655f 6469 722c 0a20 2020 2020  store_dir,.     
-00038ca0: 2020 2063 6f6e 6669 673d 636c 6965 6e74     config=client
-00038cb0: 5f63 6f6e 6669 672c 0a20 2020 2020 2020  _config,.       
-00038cc0: 2073 736c 3d67 732e 7373 6c2c 0a20 2020   ssl=gs.ssl,.   
-00038cd0: 2020 2020 2070 726f 7879 3d67 732e 7061       proxy=gs.pa
-00038ce0: 2e70 726f 7879 2c0a 2020 2020 290a 2020  .proxy,.    ).  
-00038cf0: 2020 7472 793a 0a20 2020 2020 2020 2069    try:.        i
-00038d00: 6620 6d65 7468 6f64 203d 3d20 2273 736f  f method == "sso
-00038d10: 223a 0a20 2020 2020 2020 2020 2020 2072  ":.            r
-00038d20: 6573 7020 3d20 6177 6169 7420 636c 6965  esp = await clie
-00038d30: 6e74 2e6c 6f67 696e 280a 2020 2020 2020  nt.login(.      
-00038d40: 2020 2020 2020 2020 2020 746f 6b65 6e3d            token=
-00038d50: 6c6f 6769 6e5f 746f 6b65 6e2c 2064 6576  login_token, dev
-00038d60: 6963 655f 6e61 6d65 3d64 6576 6963 655f  ice_name=device_
-00038d70: 6e61 6d65 0a20 2020 2020 2020 2020 2020  name.           
-00038d80: 2029 0a20 2020 2020 2020 2065 6c69 6620   ).        elif 
-00038d90: 6d65 7468 6f64 203d 3d20 2270 6173 7377  method == "passw
-00038da0: 6f72 6422 3a0a 2020 2020 2020 2020 2020  ord":.          
-00038db0: 2020 7265 7370 203d 2061 7761 6974 2063    resp = await c
-00038dc0: 6c69 656e 742e 6c6f 6769 6e28 7061 7373  lient.login(pass
-00038dd0: 776f 7264 2c20 6465 7669 6365 5f6e 616d  word, device_nam
-00038de0: 653d 6465 7669 6365 5f6e 616d 6529 0a0a  e=device_name)..
-00038df0: 2020 2020 2020 2020 2320 6368 6563 6b20          # check 
-00038e00: 7468 6174 2077 6520 6c6f 6767 6564 2069  that we logged i
-00038e10: 6e20 7375 6363 6573 6675 6c6c 790a 2020  n succesfully.  
-00038e20: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00038e30: 6e63 6528 7265 7370 2c20 4c6f 6769 6e52  nce(resp, LoginR
-00038e40: 6573 706f 6e73 6529 3a0a 2020 2020 2020  esponse):.      
-00038e50: 2020 2020 2020 2320 7768 656e 2077 7269        # when wri
-00038e60: 7469 6e67 2c20 616c 7761 7973 2077 7269  ting, always wri
-00038e70: 7465 2074 6f20 7072 696d 6172 7920 6c6f  te to primary lo
-00038e80: 6361 7469 6f6e 2028 652e 672e 202e 290a  cation (e.g. .).
-00038e90: 2020 2020 2020 2020 2020 2020 7772 6974              writ
-00038ea0: 655f 6372 6564 656e 7469 616c 735f 746f  e_credentials_to
-00038eb0: 5f64 6973 6b28 0a20 2020 2020 2020 2020  _disk(.         
-00038ec0: 2020 2020 2020 2068 6f6d 6573 6572 7665         homeserve
-00038ed0: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-00038ee0: 2020 2072 6573 702e 7573 6572 5f69 642c     resp.user_id,
-00038ef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00038f00: 2072 6573 702e 6465 7669 6365 5f69 642c   resp.device_id,
-00038f10: 2020 2320 6e6f 7465 2074 6869 7320 6973    # note this is
-00038f20: 2061 6e20 6964 2c20 6e6f 7420 6120 6e61   an id, not a na
-00038f30: 6d65 210a 2020 2020 2020 2020 2020 2020  me!.            
-00038f40: 2020 2020 7265 7370 2e61 6363 6573 735f      resp.access_
-00038f50: 746f 6b65 6e2c 0a20 2020 2020 2020 2020  token,.         
-00038f60: 2020 2020 2020 2072 6f6f 6d5f 6964 2c0a         room_id,.
-00038f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038f80: 6773 2e70 612e 6372 6564 656e 7469 616c  gs.pa.credential
-00038f90: 732c 0a20 2020 2020 2020 2020 2020 2029  s,.            )
-00038fa0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
-00038fb0: 636c 6965 6e74 203d 2063 6c69 656e 740a  client = client.
-00038fc0: 2020 2020 2020 2020 2020 2020 6773 2e63              gs.c
-00038fd0: 7265 6465 6e74 6961 6c73 203d 2072 6561  redentials = rea
-00038fe0: 645f 6372 6564 656e 7469 616c 735f 6672  d_credentials_fr
-00038ff0: 6f6d 5f64 6973 6b28 6372 6564 656e 7469  om_disk(credenti
-00039000: 616c 735f 6669 6c65 290a 2020 2020 2020  als_file).      
-00039010: 2020 2020 2020 7478 7420 3d20 280a 2020        txt = (.  
-00039020: 2020 2020 2020 2020 2020 2020 2020 2245                "E
-00039030: 3233 333a 2022 0a20 2020 2020 2020 2020  233: ".         
-00039040: 2020 2020 2020 2066 224c 6f67 2069 6e20         f"Log in 
-00039050: 7573 696e 6720 6d65 7468 6f64 2027 7b6d  using method '{m
-00039060: 6574 686f 647d 2720 7761 7320 7375 6363  ethod}' was succ
-00039070: 6573 7366 756c 2e20 220a 2020 2020 2020  essful. ".      
-00039080: 2020 2020 2020 2020 2020 6622 4372 6564            f"Cred
-00039090: 656e 7469 616c 7320 7765 7265 2073 746f  entials were sto
-000390a0: 7265 6420 696e 2066 696c 6520 277b 6773  red in file '{gs
-000390b0: 2e70 612e 6372 6564 656e 7469 616c 737d  .pa.credentials}
-000390c0: 272e 2022 0a20 2020 2020 2020 2020 2020  '. ".           
-000390d0: 2020 2020 2066 2246 726f 6d20 6e6f 7720       f"From now 
-000390e0: 6f6e 2079 6f75 2063 616e 2072 756e 2070  on you can run p
-000390f0: 726f 6772 616d 2027 7b50 524f 475f 5749  rogram '{PROG_WI
-00039100: 5448 5f45 5854 7d27 2022 0a20 2020 2020  TH_EXT}' ".     
-00039110: 2020 2020 2020 2020 2020 2022 7769 7468             "with
-00039120: 6f75 7420 6c6f 6720 696e 2c20 6173 2061  out log in, as a
-00039130: 6e20 6163 6365 7373 2074 6f6b 656e 2069  n access token i
-00039140: 7320 7374 6f72 6564 2069 6e20 796f 7572  s stored in your
-00039150: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00039160: 2020 2022 6372 6564 656e 7469 616c 7320     "credentials 
-00039170: 6669 6c65 2e20 220a 2020 2020 2020 2020  file. ".        
-00039180: 2020 2020 2020 2020 2249 6620 796f 7520          "If you 
-00039190: 706c 616e 206f 6e20 6861 7669 6e67 206d  plan on having m
-000391a0: 616e 7920 6372 6564 656e 7469 616c 2066  any credential f
-000391b0: 696c 6573 2c20 636f 6e73 6964 6572 2022  iles, consider "
-000391c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000391d0: 2066 226d 6f76 696e 6720 7468 656d 2074   f"moving them t
-000391e0: 6f20 6469 7265 6374 6f72 7920 277b 4352  o directory '{CR
-000391f0: 4544 454e 5449 414c 535f 4449 525f 4c41  EDENTIALS_DIR_LA
-00039200: 5354 5245 534f 5254 7d27 2e22 0a20 2020  STRESORT}'.".   
-00039210: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00039220: 2020 2020 2020 2067 732e 6c6f 672e 696e         gs.log.in
-00039230: 666f 2874 7874 290a 2020 2020 2020 2020  fo(txt).        
-00039240: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00039250: 2020 2320 6973 696e 7374 616e 6365 2872    # isinstance(r
-00039260: 6573 702c 204c 6f67 696e 4572 726f 7229  esp, LoginError)
-00039270: 203d 3d20 7472 7565 0a20 2020 2020 2020   == true.       
-00039280: 2020 2020 2023 2063 6c65 616e 7570 0a20       # cleanup. 
-00039290: 2020 2020 2020 2020 2020 2061 7761 6974             await
-000392a0: 2063 6c69 656e 742e 636c 6f73 6528 2920   client.close() 
-000392b0: 2023 206e 6f74 2079 6574 2069 6e20 6773   # not yet in gs
-000392c0: 2e0a 2020 2020 2020 2020 2020 2020 7374  ..            st
-000392d0: 6f72 655f 6465 6c65 7465 2873 746f 7265  ore_delete(store
-000392e0: 5f64 6972 2920 2023 2065 6d70 7479 2c20  _dir)  # empty, 
-000392f0: 6a75 7374 2063 7265 6174 6564 0a20 2020  just created.   
-00039300: 2020 2020 2020 2020 2023 2072 6573 7020           # resp 
-00039310: 646f 6573 206e 6f74 2063 6f6e 7461 696e  does not contain
-00039320: 2073 6563 7265 7473 0a20 2020 2020 2020   secrets.       
-00039330: 2020 2020 2023 2072 6573 7020 6973 3a20       # resp is: 
-00039340: 6d65 7373 6167 653d 2249 6e76 616c 6964  message="Invalid
-00039350: 2075 7365 726e 616d 6520 6f72 2070 6173   username or pas
-00039360: 7377 6f72 6422 2c20 636f 6465 3d4d 5f46  sword", code=M_F
-00039370: 4f52 4249 4444 454e 0a20 2020 2020 2020  ORBIDDEN.       
-00039380: 2020 2020 2074 7874 203d 2028 0a20 2020       txt = (.   
-00039390: 2020 2020 2020 2020 2020 2020 2022 4532               "E2
-000393a0: 3334 3a20 220a 2020 2020 2020 2020 2020  34: ".          
-000393b0: 2020 2020 2020 224c 6f67 2069 6e20 6661        "Log in fa
-000393c0: 696c 6564 2e20 220a 2020 2020 2020 2020  iled. ".        
-000393d0: 2020 2020 2020 2020 224d 6f73 7420 6c69          "Most li
-000393e0: 6b65 6c79 2077 726f 6e67 2063 7265 6465  kely wrong crede
-000393f0: 6e74 6961 6c73 2077 6572 6520 656e 7465  ntials were ente
-00039400: 7265 642e 2022 0a20 2020 2020 2020 2020  red. ".         
-00039410: 2020 2020 2020 2066 2268 6f6d 6573 6572         f"homeser
-00039420: 7665 723d 277b 686f 6d65 7365 7276 6572  ver='{homeserver
-00039430: 7d27 3b20 6465 7669 6365 206e 616d 653d  }'; device name=
-00039440: 277b 6465 7669 6365 5f6e 616d 657d 273b  '{device_name}';
-00039450: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00039460: 2020 2066 2275 7365 723d 277b 7573 6572     f"user='{user
-00039470: 5f69 647d 273b 2072 6f6f 6d5f 6964 3d27  _id}'; room_id='
-00039480: 7b72 6f6f 6d5f 6964 7d27 2e20 220a 2020  {room_id}'. ".  
-00039490: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-000394a0: 4661 696c 6564 2074 6f20 6c6f 6720 696e  Failed to log in
-000394b0: 3a20 7b72 6573 702e 6d65 7373 6167 657d  : {resp.message}
-000394c0: 2c20 7b73 7472 2872 6573 702e 7374 6174  , {str(resp.stat
-000394d0: 7573 5f63 6f64 6529 7d22 0a20 2020 2020  us_code)}".     
-000394e0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000394f0: 2020 2020 2067 732e 6572 725f 636f 756e       gs.err_coun
-00039500: 7420 2b3d 2031 0a20 2020 2020 2020 2020  t += 1.         
-00039510: 2020 2072 6169 7365 204d 6174 7269 7843     raise MatrixC
-00039520: 6f6d 6d61 6e64 6572 4572 726f 7228 7478  ommanderError(tx
-00039530: 7429 0a20 2020 2065 7863 6570 7420 4578  t).    except Ex
-00039540: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
-00039550: 2020 2020 2020 7478 7420 3d20 280a 2020        txt = (.  
-00039560: 2020 2020 2020 2020 2020 2245 3233 353a            "E235:
-00039570: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-00039580: 4c6f 6720 696e 2066 6169 6c65 642e 2053  Log in failed. S
-00039590: 6f72 7279 2e22 0a20 2020 2020 2020 2020  orry.".         
-000395a0: 2020 2066 2268 6f6d 6573 6572 7665 723d     f"homeserver=
-000395b0: 277b 686f 6d65 7365 7276 6572 7d27 3b20  '{homeserver}'; 
-000395c0: 6465 7669 6365 206e 616d 653d 277b 6465  device name='{de
-000395d0: 7669 6365 5f6e 616d 657d 273b 2022 0a20  vice_name}'; ". 
-000395e0: 2020 2020 2020 2020 2020 2066 2275 7365             f"use
-000395f0: 723d 277b 7573 6572 5f69 647d 273b 2072  r='{user_id}'; r
-00039600: 6f6f 6d5f 6964 3d27 7b72 6f6f 6d5f 6964  oom_id='{room_id
-00039610: 7d27 2e20 220a 2020 2020 2020 2020 2020  }'. ".          
-00039620: 2020 6622 4661 696c 6564 2074 6f20 6c6f    f"Failed to lo
-00039630: 6720 696e 3a20 7b65 7d22 0a20 2020 2020  g in: {e}".     
-00039640: 2020 2029 0a20 2020 2020 2020 2023 2067     ).        # g
-00039650: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
-00039660: 2020 2320 646f 6e27 7420 696e 6372 656d    # don't increm
-00039670: 656e 7420 7369 6e63 6520 6e6f 7420 4d61  ent since not Ma
-00039680: 7472 6978 436f 6d6d 616e 6465 7245 7272  trixCommanderErr
-00039690: 6f72 0a20 2020 2020 2020 2072 6169 7365  or.        raise
-000396a0: 0a20 2020 2023 2077 6520 6172 6520 6e6f  .    # we are no
-000396b0: 7720 6175 7468 656e 7469 6361 7465 642c  w authenticated,
-000396c0: 2077 6520 6172 6520 6e6f 7720 6c6f 6767   we are now logg
-000396d0: 6564 2069 6e0a 2020 2020 2320 6773 206e  ed in.    # gs n
-000396e0: 6f77 2068 6173 2063 6c69 656e 7420 616e  ow has client an
-000396f0: 6420 6372 6564 656e 7469 616c 732c 206e  d credentials, n
-00039700: 6565 6465 6420 6279 2066 7572 7468 6572  eeded by further
-00039710: 2061 6374 696f 6e73 0a0a 0a61 7379 6e63   actions...async
-00039720: 2064 6566 2069 6d70 6c69 6369 745f 6c6f   def implicit_lo
-00039730: 6769 6e28 2920 2d3e 204e 6f6e 653a 0a20  gin() -> None:. 
-00039740: 2020 2022 2222 4c6f 6720 696e 2075 7369     """Log in usi
-00039750: 6e67 2063 7265 6465 6e74 6961 6c73 2066  ng credentials f
-00039760: 696c 6520 616e 6420 7265 6d61 696e 206c  ile and remain l
-00039770: 6f67 6765 6420 696e 2e22 2222 0a20 2020  ogged in.""".   
-00039780: 2063 6c69 656e 742c 2063 7265 6465 6e74   client, credent
-00039790: 6961 6c73 203d 2061 7761 6974 206c 6f67  ials = await log
-000397a0: 696e 5f75 7369 6e67 5f63 7265 6465 6e74  in_using_credent
-000397b0: 6961 6c73 5f66 696c 6528 290a 2020 2020  ials_file().    
-000397c0: 6773 2e63 6c69 656e 7420 3d20 636c 6965  gs.client = clie
-000397d0: 6e74 0a20 2020 2067 732e 6372 6564 656e  nt.    gs.creden
-000397e0: 7469 616c 7320 3d20 6372 6564 656e 7469  tials = credenti
-000397f0: 616c 730a 0a0a 6465 6620 726f 6f6d 735f  als...def rooms_
-00039800: 746f 5f6c 6f6e 675f 726f 6f6d 5f6e 616d  to_long_room_nam
-00039810: 6573 2829 202d 3e20 4e6f 6e65 3a0a 2020  es() -> None:.  
-00039820: 2020 2222 2243 6f6e 7665 7274 2066 6f6f    """Convert foo
-00039830: 2074 6f20 2366 6f6f 3a65 7861 6d70 6c65   to #foo:example
-00039840: 2e63 6f6d 2069 6e20 6773 2e70 612e 726f  .com in gs.pa.ro
-00039850: 6f6d 2077 6865 7265 206e 6563 6573 7361  om where necessa
-00039860: 7279 2e22 2222 0a20 2020 2069 6620 6773  ry.""".    if gs
-00039870: 2e70 612e 726f 6f6d 3a0a 2020 2020 2020  .pa.room:.      
-00039880: 2020 6c6f 6e67 5f72 6f6f 6d73 203d 205b    long_rooms = [
-00039890: 5d0a 2020 2020 2020 2020 666f 7220 726f  ].        for ro
-000398a0: 6f6d 2069 6e20 6773 2e70 612e 726f 6f6d  om in gs.pa.room
-000398b0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-000398c0: 2069 735f 7368 6f72 745f 726f 6f6d 5f61   is_short_room_a
-000398d0: 6c69 6173 2872 6f6f 6d29 3a0a 2020 2020  lias(room):.    
-000398e0: 2020 2020 2020 2020 2020 2020 6c6f 6e67              long
-000398f0: 5f72 6f6f 6d73 2e61 7070 656e 6428 0a20  _rooms.append(. 
-00039900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039910: 2020 2073 686f 7274 5f72 6f6f 6d5f 616c     short_room_al
-00039920: 6961 735f 746f 5f72 6f6f 6d5f 616c 6961  ias_to_room_alia
-00039930: 7328 726f 6f6d 2c20 6773 2e63 7265 6465  s(room, gs.crede
-00039940: 6e74 6961 6c73 290a 2020 2020 2020 2020  ntials).        
-00039950: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00039960: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00039970: 2020 2020 2020 2020 2020 2020 6c6f 6e67              long
-00039980: 5f72 6f6f 6d73 2e61 7070 656e 6428 726f  _rooms.append(ro
-00039990: 6f6d 290a 2020 2020 2020 2020 6773 2e70  om).        gs.p
-000399a0: 612e 726f 6f6d 203d 206c 6f6e 675f 726f  a.room = long_ro
-000399b0: 6f6d 730a 0a0a 6173 796e 6320 6465 6620  oms...async def 
-000399c0: 6173 796e 635f 6d61 696e 2829 202d 3e20  async_main() -> 
-000399d0: 4e6f 6e65 3a0a 2020 2020 2222 2252 756e  None:.    """Run
-000399e0: 206d 6169 6e20 6675 6e63 7469 6f6e 7320   main functions 
-000399f0: 6265 696e 6720 696e 7369 6465 2074 6865  being inside the
-00039a00: 2065 7665 6e74 206c 6f6f 702e 2222 220a   event loop.""".
-00039a10: 2020 2020 2320 6c6f 6769 6e20 6578 706c      # login expl
-00039a20: 6963 6974 6c79 0a20 2020 2023 206c 6f67  icitly.    # log
-00039a30: 696e 2069 6d70 6c69 6369 746c 790a 2020  in implicitly.  
-00039a40: 2020 2320 7665 7269 6679 0a20 2020 2023    # verify.    #
-00039a50: 2073 6574 2c20 6765 742c 2072 6f6f 6d2c   set, get, room,
-00039a60: 0a20 2020 2023 2073 656e 640a 2020 2020  .    # send.    
-00039a70: 2320 6c69 7374 656e 0a20 2020 2023 206c  # listen.    # l
-00039a80: 6f67 6f75 740a 2020 2020 2320 636c 6f73  ogout.    # clos
-00039a90: 6520 636c 6965 6e74 0a20 2020 2023 2073  e client.    # s
-00039aa0: 7973 2e61 7267 7620 6f72 6465 7269 6e67  ys.argv ordering
-00039ab0: 3f20 2320 746f 646f 0a20 2020 2074 7279  ? # todo.    try
-00039ac0: 3a0a 2020 2020 2020 2020 6966 2067 732e  :.        if gs.
-00039ad0: 7061 2e6c 6f67 696e 3a0a 2020 2020 2020  pa.login:.      
-00039ae0: 2020 2020 2020 6177 6169 7420 6163 7469        await acti
-00039af0: 6f6e 5f6c 6f67 696e 2829 2020 2320 6578  on_login()  # ex
-00039b00: 706c 6963 6974 206c 6f67 696e 0a20 2020  plicit login.   
-00039b10: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00039b20: 2020 2020 2020 2061 7761 6974 2069 6d70         await imp
-00039b30: 6c69 6369 745f 6c6f 6769 6e28 290a 2020  licit_login().  
-00039b40: 2020 2020 2020 6966 2067 732e 7061 2e76        if gs.pa.v
-00039b50: 6572 6966 793a 0a20 2020 2020 2020 2020  erify:.         
-00039b60: 2020 2061 7761 6974 2061 6374 696f 6e5f     await action_
-00039b70: 7665 7269 6679 2829 0a20 2020 2020 2020  verify().       
-00039b80: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-00039b90: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-00039ba0: 2020 2022 4b65 7962 6f61 7264 2069 6e74     "Keyboard int
-00039bb0: 6572 7275 7074 2072 6563 6569 7665 6420  errupt received 
-00039bc0: 6166 7465 7220 456d 6f6a 6920 7665 7269  after Emoji veri
-00039bd0: 6669 6361 7469 6f6e 2e22 0a20 2020 2020  fication.".     
-00039be0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00039bf0: 2072 6f6f 6d73 5f74 6f5f 6c6f 6e67 5f72   rooms_to_long_r
-00039c00: 6f6f 6d5f 6e61 6d65 7328 2920 2023 2063  oom_names()  # c
-00039c10: 6f6d 706c 6574 6520 726f 6f6d 206e 616d  omplete room nam
-00039c20: 6573 0a20 2020 2020 2020 2069 6620 6773  es.        if gs
-00039c30: 2e72 6f6f 6d5f 6163 7469 6f6e 206f 7220  .room_action or 
-00039c40: 6773 2e73 6574 6765 745f 6163 7469 6f6e  gs.setget_action
+00036240: 310a 2020 2020 2020 2020 2020 2020 7265  1.            re
+00036250: 7475 726e 0a20 2020 2020 2020 2072 6573  turn.        res
+00036260: 7020 3d20 6177 6169 7420 6773 2e63 6c69  p = await gs.cli
+00036270: 656e 742e 6c6f 676f 7574 2861 6c6c 5f64  ent.logout(all_d
+00036280: 6576 6963 6573 290a 2020 2020 2020 2020  evices).        
+00036290: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
+000362a0: 7370 2c20 4c6f 676f 7574 4572 726f 7229  sp, LogoutError)
+000362b0: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
+000362c0: 2e6c 6f67 2e65 7272 6f72 280a 2020 2020  .log.error(.    
+000362d0: 2020 2020 2020 2020 2020 2020 2245 3232              "E22
+000362e0: 323a 2022 0a20 2020 2020 2020 2020 2020  2: ".           
+000362f0: 2020 2020 2066 2246 6169 6c65 6420 746f       f"Failed to
+00036300: 206c 6f67 6f75 7420 7b64 6576 6963 657d   logout {device}
+00036310: 2e20 5265 7370 6f6e 7365 3a20 220a 2020  . Response: ".  
+00036320: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00036330: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
+00036340: 7374 7228 7265 7370 2929 7d22 0a20 2020  str(resp))}".   
+00036350: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00036360: 2020 2020 2020 2067 732e 6572 725f 636f         gs.err_co
+00036370: 756e 7420 2b3d 2031 0a20 2020 2020 2020  unt += 1.       
+00036380: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00036390: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+000363a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000363b0: 2066 226c 6f67 6f75 7420 7375 6363 6573   f"logout succes
+000363c0: 7366 756c 2e20 5265 7370 6f6e 7365 2069  sful. Response i
+000363d0: 733a 207b 7072 6976 6163 795f 6669 6c74  s: {privacy_filt
+000363e0: 6572 2873 7472 2872 6573 7029 297d 220a  er(str(resp))}".
+000363f0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00036400: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
+00036410: 2e69 6e66 6f28 6622 5375 6363 6573 7366  .info(f"Successf
+00036420: 756c 6c79 206c 6f67 6765 6420 6f75 7420  ully logged out 
+00036430: 7b64 6576 6963 657d 2e22 290a 0a20 2020  {device}.")..   
+00036440: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+00036450: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
+00036460: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
+00036470: 2020 2020 2020 2020 2020 2245 3232 333a            "E223:
+00036480: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
+00036490: 4572 726f 7220 6475 7269 6e67 206c 6f67  Error during log
+000364a0: 6f75 742e 2043 6f6e 7469 6e75 696e 6720  out. Continuing 
+000364b0: 6465 7370 6974 6520 6572 726f 722e 2022  despite error. "
+000364c0: 0a20 2020 2020 2020 2020 2020 2066 2245  .            f"E
+000364d0: 7863 6570 7469 6f6e 3a20 7b65 7d22 0a20  xception: {e}". 
+000364e0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000364f0: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
+00036500: 2031 0a0a 0a61 7379 6e63 2064 6566 2061   1...async def a
+00036510: 6374 696f 6e5f 6c6f 6769 6e28 2920 2d3e  ction_login() ->
+00036520: 204e 6f6e 653a 0a20 2020 2022 2222 4c6f   None:.    """Lo
+00036530: 6720 696e 2075 7369 6e67 2053 534f 206f  g in using SSO o
+00036540: 7220 7061 7373 776f 7264 2c20 6372 6561  r password, crea
+00036550: 7465 2063 7265 6465 6e74 6961 6c73 2066  te credentials f
+00036560: 696c 652c 2063 7265 6174 6520 7374 6f72  ile, create stor
+00036570: 652c 0a20 2020 2061 6e64 2072 656d 6169  e,.    and remai
+00036580: 6e20 6c6f 6767 6564 2069 6e2e 0a20 2020  n logged in..   
+00036590: 2022 2222 0a20 2020 2063 7265 6465 6e74   """.    credent
+000365a0: 6961 6c73 5f66 696c 6520 3d20 6465 7465  ials_file = dete
+000365b0: 726d 696e 655f 6372 6564 656e 7469 616c  rmine_credential
+000365c0: 735f 6669 6c65 2829 0a20 2020 2069 6620  s_file().    if 
+000365d0: 6372 6564 656e 7469 616c 735f 6578 6973  credentials_exis
+000365e0: 7428 6372 6564 656e 7469 616c 735f 6669  t(credentials_fi
+000365f0: 6c65 293a 0a20 2020 2020 2020 2072 6169  le):.        rai
+00036600: 7365 204d 6174 7269 7843 6f6d 6d61 6e64  se MatrixCommand
+00036610: 6572 4572 726f 7228 0a20 2020 2020 2020  erError(.       
+00036620: 2020 2020 2022 4532 3234 3a20 220a 2020       "E224: ".  
+00036630: 2020 2020 2020 2020 2020 222d 2d6c 6f67            "--log
+00036640: 696e 2077 6173 2075 7365 6420 6275 7420  in was used but 
+00036650: 6372 6564 656e 7469 616c 7320 616c 7265  credentials alre
+00036660: 6164 7920 6578 6973 7420 220a 2020 2020  ady exist ".    
+00036670: 2020 2020 2020 2020 6622 696e 2027 7b63          f"in '{c
+00036680: 7265 6465 6e74 6961 6c73 5f66 696c 657d  redentials_file}
+00036690: 272e 220a 2020 2020 2020 2020 2920 6672  '.".        ) fr
+000366a0: 6f6d 204e 6f6e 650a 2020 2020 7374 6f72  om None.    stor
+000366b0: 655f 6469 7220 3d20 6465 7465 726d 696e  e_dir = determin
+000366c0: 655f 7374 6f72 655f 6469 7228 290a 2020  e_store_dir().  
+000366d0: 2020 6966 2073 746f 7265 5f65 7869 7374    if store_exist
+000366e0: 7328 7374 6f72 655f 6469 7229 3a0a 2020  s(store_dir):.  
+000366f0: 2020 2020 2020 7261 6973 6520 4d61 7472        raise Matr
+00036700: 6978 436f 6d6d 616e 6465 7245 7272 6f72  ixCommanderError
+00036710: 280a 2020 2020 2020 2020 2020 2020 2245  (.            "E
+00036720: 3232 353a 2022 0a20 2020 2020 2020 2020  225: ".         
+00036730: 2020 2066 222d 2d6c 6f67 696e 2077 6173     f"--login was
+00036740: 2075 7365 6420 6275 7420 7374 6f72 6520   used but store 
+00036750: 616c 7265 6164 7920 6578 6973 7473 2069  already exists i
+00036760: 6e20 277b 7374 6f72 655f 6469 727d 272e  n '{store_dir}'.
+00036770: 220a 2020 2020 2020 2020 2920 6672 6f6d  ".        ) from
+00036780: 204e 6f6e 650a 2020 2020 6d65 7468 6f64   None.    method
+00036790: 203d 2067 732e 7061 2e6c 6f67 696e 2e6c   = gs.pa.login.l
+000367a0: 6f77 6572 2829 0a20 2020 2069 6e74 6572  ower().    inter
+000367b0: 6163 7469 7665 203d 2046 616c 7365 0a20  active = False. 
+000367c0: 2020 2069 6620 6d65 7468 6f64 203d 3d20     if method == 
+000367d0: 2270 6173 7377 6f72 6422 3a0a 2020 2020  "password":.    
+000367e0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+000367f0: 2822 2d2d 6c6f 6769 6e20 6861 7320 6368  ("--login has ch
+00036800: 6f73 656e 2070 6173 7377 6f72 6420 6d65  osen password me
+00036810: 7468 6f64 2066 6f72 2061 7574 6865 6e74  thod for authent
+00036820: 6963 6174 696f 6e22 290a 2020 2020 656c  ication").    el
+00036830: 6966 206d 6574 686f 6420 3d3d 2022 7373  if method == "ss
+00036840: 6f22 3a0a 2020 2020 2020 2020 6773 2e6c  o":.        gs.l
+00036850: 6f67 2e64 6562 7567 2822 2d2d 6c6f 6769  og.debug("--logi
+00036860: 6e20 6861 7320 6368 6f73 656e 2053 534f  n has chosen SSO
+00036870: 206d 6574 686f 6420 666f 7220 6175 7468   method for auth
+00036880: 656e 7469 6361 7469 6f6e 2229 0a20 2020  entication").   
+00036890: 2065 6c73 653a 0a20 2020 2020 2020 2072   else:.        r
+000368a0: 6169 7365 204d 6174 7269 7843 6f6d 6d61  aise MatrixComma
+000368b0: 6e64 6572 4572 726f 7228 0a20 2020 2020  nderError(.     
+000368c0: 2020 2020 2020 2022 4532 3236 3a20 220a         "E226: ".
+000368d0: 2020 2020 2020 2020 2020 2020 222d 2d6c              "--l
+000368e0: 6f67 696e 2073 7065 6369 6669 6573 2069  ogin specifies i
+000368f0: 6e76 616c 6964 2061 7574 6865 6e74 6963  nvalid authentic
+00036900: 6174 696e 206d 6574 686f 6420 220a 2020  atin method ".  
+00036910: 2020 2020 2020 2020 2020 6622 277b 6d65            f"'{me
+00036920: 7468 6f64 7d27 2e20 4f6e 6c79 2027 7061  thod}'. Only 'pa
+00036930: 7373 776f 7264 2720 616e 6420 2773 736f  ssword' and 'sso
+00036940: 2720 616c 6c6f 7765 642e 220a 2020 2020  ' allowed.".    
+00036950: 2020 2020 2920 6672 6f6d 204e 6f6e 650a      ) from None.
+00036960: 2020 2020 6966 2067 732e 7061 2e68 6f6d      if gs.pa.hom
+00036970: 6573 6572 7665 723a 0a20 2020 2020 2020  eserver:.       
+00036980: 2068 6f6d 6573 6572 7665 7220 3d20 6773   homeserver = gs
+00036990: 2e70 612e 686f 6d65 7365 7276 6572 0a20  .pa.homeserver. 
+000369a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000369b0: 2069 6e74 6572 6163 7469 7665 203d 2054   interactive = T
+000369c0: 7275 650a 2020 2020 2020 2020 686f 6d65  rue.        home
+000369d0: 7365 7276 6572 203d 2022 6874 7470 733a  server = "https:
+000369e0: 2f2f 6d61 7472 6978 2e65 7861 6d70 6c65  //matrix.example
+000369f0: 2e6f 7267 220a 2020 2020 2020 2020 686f  .org".        ho
+00036a00: 6d65 7365 7276 6572 203d 2069 6e70 7574  meserver = input
+00036a10: 2866 2245 6e74 6572 2055 524c 206f 6620  (f"Enter URL of 
+00036a20: 796f 7572 2068 6f6d 6573 6572 7665 723a  your homeserver:
+00036a30: 205b 7b68 6f6d 6573 6572 7665 727d 5d20   [{homeserver}] 
+00036a40: 2229 0a20 2020 2020 2020 2069 6620 6e6f  ").        if no
+00036a50: 7420 686f 6d65 7365 7276 6572 3a0a 2020  t homeserver:.  
+00036a60: 2020 2020 2020 2020 2020 686f 6d65 7365            homese
+00036a70: 7276 6572 203d 2022 6874 7470 733a 2f2f  rver = "https://
+00036a80: 6d61 7472 6978 2e6f 7267 2220 2023 2062  matrix.org"  # b
+00036a90: 6574 7465 7220 6572 726f 7220 6d73 6720  etter error msg 
+00036aa0: 6c61 7465 720a 2020 2020 6966 206e 6f74  later.    if not
+00036ab0: 2028 0a20 2020 2020 2020 2068 6f6d 6573   (.        homes
+00036ac0: 6572 7665 722e 7374 6172 7473 7769 7468  erver.startswith
+00036ad0: 2822 6874 7470 733a 2f2f 2229 206f 7220  ("https://") or 
+00036ae0: 686f 6d65 7365 7276 6572 2e73 7461 7274  homeserver.start
+00036af0: 7377 6974 6828 2268 7474 703a 2f2f 2229  swith("http://")
+00036b00: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+00036b10: 686f 6d65 7365 7276 6572 203d 2022 6874  homeserver = "ht
+00036b20: 7470 733a 2f2f 2220 2b20 686f 6d65 7365  tps://" + homese
+00036b30: 7276 6572 0a20 2020 2068 6f6d 6573 6572  rver.    homeser
+00036b40: 7665 725f 7368 6f72 7420 3d20 7572 6c70  ver_short = urlp
+00036b50: 6172 7365 2868 6f6d 6573 6572 7665 7229  arse(homeserver)
+00036b60: 2e68 6f73 746e 616d 6520 2023 206d 6174  .hostname  # mat
+00036b70: 7269 782e 6578 616d 706c 652e 6f72 670a  rix.example.org.
+00036b80: 0a20 2020 2023 2046 6f72 2053 534f 206c  .    # For SSO l
+00036b90: 6f67 696e 2c20 7573 6572 5f69 6420 6973  ogin, user_id is
+00036ba0: 206e 6f74 206e 6565 6465 642e 2042 7574   not needed. But
+00036bb0: 206d 6174 7269 782d 636f 6d6d 616e 6465   matrix-commande
+00036bc0: 7220 6e65 6564 730a 2020 2020 2320 7573  r needs.    # us
+00036bd0: 6572 5f69 6420 666f 7220 6372 6564 656e  er_id for creden
+00036be0: 7469 616c 7320 666f 7220 6172 6775 6d65  tials for argume
+00036bf0: 6e74 7320 6c69 6b65 202d 2d77 686f 616d  nts like --whoam
+00036c00: 692e 0a20 2020 2023 2046 6f72 2053 534f  i..    # For SSO
+00036c10: 2c20 7765 2067 6574 2074 6865 2075 7365  , we get the use
+00036c20: 725f 6964 2066 726f 6d20 6c6f 6769 6e28  r_id from login(
+00036c30: 2920 4150 4920 6361 6c6c 2c20 692e 652e  ) API call, i.e.
+00036c40: 2066 726f 6d20 7365 7276 6572 2e0a 2020   from server..  
+00036c50: 2020 6966 2067 732e 7061 2e75 7365 725f    if gs.pa.user_
+00036c60: 6c6f 6769 6e3a 0a20 2020 2020 2020 2075  login:.        u
+00036c70: 7365 725f 6964 203d 2067 732e 7061 2e75  ser_id = gs.pa.u
+00036c80: 7365 725f 6c6f 6769 6e0a 2020 2020 656c  ser_login.    el
+00036c90: 7365 3a0a 2020 2020 2020 2020 7573 6572  se:.        user
+00036ca0: 5f69 6420 3d20 4e6f 6e65 0a20 2020 2069  _id = None.    i
+00036cb0: 6620 6d65 7468 6f64 203d 3d20 2270 6173  f method == "pas
+00036cc0: 7377 6f72 6422 2061 6e64 206e 6f74 2075  sword" and not u
+00036cd0: 7365 725f 6964 3a0a 2020 2020 2020 2020  ser_id:.        
+00036ce0: 696e 7465 7261 6374 6976 6520 3d20 5472  interactive = Tr
+00036cf0: 7565 0a20 2020 2020 2020 2075 7365 725f  ue.        user_
+00036d00: 6964 203d 2022 406a 6f68 6e3a 6578 616d  id = "@john:exam
+00036d10: 706c 652e 6f72 6722 0a20 2020 2020 2020  ple.org".       
+00036d20: 2075 7365 725f 6964 3220 3d20 2240 6a6f   user_id2 = "@jo
+00036d30: 686e 3a22 202b 2068 6f6d 6573 6572 7665  hn:" + homeserve
+00036d40: 725f 7368 6f72 740a 2020 2020 2020 2020  r_short.        
+00036d50: 7573 6572 5f69 6420 3d20 696e 7075 7428  user_id = input(
+00036d60: 0a20 2020 2020 2020 2020 2020 2066 2245  .            f"E
+00036d70: 6e74 6572 2079 6f75 7220 7573 6572 2049  nter your user I
+00036d80: 443a 2020 5b7b 7573 6572 5f69 647d 5d20  D:  [{user_id}] 
+00036d90: 206f 7220 205b 6a6f 686e 5d20 666f 7220   or  [john] for 
+00036da0: 7b75 7365 725f 6964 327d 203a 2022 0a20  {user_id2} : ". 
+00036db0: 2020 2020 2020 2029 2e73 7472 6970 2829         ).strip()
+00036dc0: 0a20 2020 2069 6620 6d65 7468 6f64 203d  .    if method =
+00036dd0: 3d20 2270 6173 7377 6f72 6422 3a0a 2020  = "password":.  
+00036de0: 2020 2020 2020 6966 2067 732e 7061 2e70        if gs.pa.p
+00036df0: 6173 7377 6f72 643a 0a20 2020 2020 2020  assword:.       
+00036e00: 2020 2020 2070 6173 7377 6f72 6420 3d20       password = 
+00036e10: 6773 2e70 612e 7061 7373 776f 7264 0a20  gs.pa.password. 
+00036e20: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00036e30: 2020 2020 2020 2020 2069 6e74 6572 6163           interac
+00036e40: 7469 7665 203d 2054 7275 650a 2020 2020  tive = True.    
+00036e50: 2020 2020 2020 2020 7072 696e 7428 2250          print("P
+00036e60: 6c65 6173 6520 7072 6f76 6964 6520 796f  lease provide yo
+00036e70: 7572 204d 6174 7269 7820 6163 636f 756e  ur Matrix accoun
+00036e80: 7420 7061 7373 776f 7264 2e22 290a 2020  t password.").  
+00036e90: 2020 2020 2020 2020 2020 7061 7373 776f            passwo
+00036ea0: 7264 203d 2067 6574 7061 7373 2e67 6574  rd = getpass.get
+00036eb0: 7061 7373 2829 0a20 2020 2065 6c69 6620  pass().    elif 
+00036ec0: 6d65 7468 6f64 203d 3d20 2273 736f 223a  method == "sso":
+00036ed0: 0a20 2020 2020 2020 2070 6173 7377 6f72  .        passwor
+00036ee0: 6420 3d20 4e6f 6e65 0a20 2020 2069 6620  d = None.    if 
+00036ef0: 6773 2e70 612e 6465 7669 6365 2069 7320  gs.pa.device is 
+00036f00: 6e6f 7420 4e6f 6e65 3a20 2023 2073 6f6d  not None:  # som
+00036f10: 6574 6869 6e67 2077 6173 2073 7065 6369  ething was speci
+00036f20: 6669 6564 0a20 2020 2020 2020 2064 6576  fied.        dev
+00036f30: 6963 655f 6e61 6d65 203d 2067 732e 7061  ice_name = gs.pa
+00036f40: 2e64 6576 6963 652e 7374 7269 7028 290a  .device.strip().
+00036f50: 2020 2020 2020 2020 6966 2064 6576 6963          if devic
+00036f60: 655f 6e61 6d65 203d 3d20 2222 3a0a 2020  e_name == "":.  
+00036f70: 2020 2020 2020 2020 2020 6465 7669 6365            device
+00036f80: 5f6e 616d 6520 3d20 5052 4f47 5f57 4954  _name = PROG_WIT
+00036f90: 484f 5554 5f45 5854 2020 2320 6465 6661  HOUT_EXT  # defa
+00036fa0: 756c 740a 2020 2020 656c 7365 3a0a 2020  ult.    else:.  
+00036fb0: 2020 2020 2020 696e 7465 7261 6374 6976        interactiv
+00036fc0: 6520 3d20 5472 7565 0a20 2020 2020 2020  e = True.       
+00036fd0: 2064 6576 6963 655f 6e61 6d65 203d 2050   device_name = P
+00036fe0: 524f 475f 5749 5448 4f55 545f 4558 540a  ROG_WITHOUT_EXT.
+00036ff0: 2020 2020 2020 2020 6465 7669 6365 5f6e          device_n
+00037000: 616d 6520 3d20 696e 7075 7428 0a20 2020  ame = input(.   
+00037010: 2020 2020 2020 2020 2066 2243 686f 6f73           f"Choos
+00037020: 6520 6120 6e61 6d65 2066 6f72 2074 6869  e a name for thi
+00037030: 7320 6465 7669 6365 3a20 5b7b 6465 7669  s device: [{devi
+00037040: 6365 5f6e 616d 657d 5d20 220a 2020 2020  ce_name}] ".    
+00037050: 2020 2020 292e 7374 7269 7028 290a 2020      ).strip().  
+00037060: 2020 2020 2020 6966 2064 6576 6963 655f        if device_
+00037070: 6e61 6d65 203d 3d20 2222 3a0a 2020 2020  name == "":.    
+00037080: 2020 2020 2020 2020 6465 7669 6365 5f6e          device_n
+00037090: 616d 6520 3d20 5052 4f47 5f57 4954 484f  ame = PROG_WITHO
+000370a0: 5554 5f45 5854 2020 2320 6465 6661 756c  UT_EXT  # defaul
+000370b0: 740a 2020 2020 6966 2067 732e 7061 2e72  t.    if gs.pa.r
+000370c0: 6f6f 6d5f 6465 6661 756c 7420 6973 206e  oom_default is n
+000370d0: 6f74 204e 6f6e 653a 2020 2320 736f 6d65  ot None:  # some
+000370e0: 7468 696e 6720 7761 7320 7370 6563 6966  thing was specif
+000370f0: 6965 640a 2020 2020 2020 2020 726f 6f6d  ied.        room
+00037100: 5f69 6420 3d20 6773 2e70 612e 726f 6f6d  _id = gs.pa.room
+00037110: 5f64 6566 6175 6c74 2e73 7472 6970 2829  _default.strip()
+00037120: 0a20 2020 2020 2020 2072 6f6f 6d5f 6964  .        room_id
+00037130: 203d 2072 6f6f 6d5f 6964 2e72 6570 6c61   = room_id.repla
+00037140: 6365 2872 225c 2122 2c20 2221 2229 2020  ce(r"\!", "!")  
+00037150: 2320 7265 6d6f 7665 2070 6f73 7369 626c  # remove possibl
+00037160: 6520 6573 6361 7065 0a20 2020 2065 6c73  e escape.    els
+00037170: 653a 0a20 2020 2020 2020 2069 6e74 6572  e:.        inter
+00037180: 6163 7469 7665 203d 2054 7275 650a 2020  active = True.  
+00037190: 2020 2020 2020 726f 6f6d 5f69 6420 3d20        room_id = 
+000371a0: 2221 536f 6d65 526f 6f6d 4964 5374 7269  "!SomeRoomIdStri
+000371b0: 6e67 3a65 7861 6d70 6c65 2e6f 7267 220a  ng:example.org".
+000371c0: 2020 2020 2020 2020 726f 6f6d 5f69 6432          room_id2
+000371d0: 203d 2022 2361 6c69 6173 3a22 202b 2068   = "#alias:" + h
+000371e0: 6f6d 6573 6572 7665 725f 7368 6f72 740a  omeserver_short.
+000371f0: 2020 2020 2020 2020 726f 6f6d 5f69 6420          room_id 
+00037200: 3d20 696e 7075 7428 0a20 2020 2020 2020  = input(.       
+00037210: 2020 2020 2066 2245 6e74 6572 2072 6f6f       f"Enter roo
+00037220: 6d20 4944 2066 6f72 2064 6566 6175 6c74  m ID for default
+00037230: 2072 6f6f 6d3a 2020 5b7b 726f 6f6d 5f69   room:  [{room_i
+00037240: 647d 5d20 2022 0a20 2020 2020 2020 2020  d}]  ".         
+00037250: 2020 2066 226f 7220 205b 616c 6961 735d     f"or  [alias]
+00037260: 2066 6f72 207b 726f 6f6d 5f69 6432 7d20   for {room_id2} 
+00037270: 3a20 220a 2020 2020 2020 2020 292e 7374  : ".        ).st
+00037280: 7269 7028 290a 2020 2020 6966 2075 7365  rip().    if use
+00037290: 725f 6964 2069 7320 6e6f 7420 4e6f 6e65  r_id is not None
+000372a0: 3a0a 2020 2020 2020 2020 6966 2069 735f  :.        if is_
+000372b0: 7061 7274 6961 6c5f 7573 6572 5f69 6428  partial_user_id(
+000372c0: 7573 6572 5f69 6429 3a0a 2020 2020 2020  user_id):.      
+000372d0: 2020 2020 2020 7573 6572 5f69 6420 3d20        user_id = 
+000372e0: 7573 6572 5f69 6420 2b20 223a 2220 2b20  user_id + ":" + 
+000372f0: 686f 6d65 7365 7276 6572 5f73 686f 7274  homeserver_short
+00037300: 2020 2320 646f 6e74 2075 7365 2066 6e0a    # dont use fn.
+00037310: 2020 2020 2020 2020 6966 2069 735f 7368          if is_sh
+00037320: 6f72 745f 7573 6572 5f69 6428 7573 6572  ort_user_id(user
+00037330: 5f69 6429 3a0a 2020 2020 2020 2020 2020  _id):.          
+00037340: 2020 7573 6572 5f69 6420 3d20 2240 2220    user_id = "@" 
+00037350: 2b20 7573 6572 5f69 6420 2b20 223a 2220  + user_id + ":" 
+00037360: 2b20 686f 6d65 7365 7276 6572 5f73 686f  + homeserver_sho
+00037370: 7274 2020 2320 646f 6e74 2075 7365 2066  rt  # dont use f
+00037380: 6e0a 2020 2020 2020 2020 6966 206e 6f74  n.        if not
+00037390: 2069 735f 7573 6572 5f69 6428 7573 6572   is_user_id(user
+000373a0: 5f69 6429 3a0a 2020 2020 2020 2020 2020  _id):.          
+000373b0: 2020 7261 6973 6520 4d61 7472 6978 436f    raise MatrixCo
+000373c0: 6d6d 616e 6465 7245 7272 6f72 280a 2020  mmanderError(.  
+000373d0: 2020 2020 2020 2020 2020 2020 2020 2245                "E
+000373e0: 3232 373a 2022 0a20 2020 2020 2020 2020  227: ".         
+000373f0: 2020 2020 2020 2066 2255 7365 7220 6964         f"User id
+00037400: 2027 7b75 7365 725f 6964 7d27 2066 6f72   '{user_id}' for
+00037410: 202d 2d6c 6f67 696e 2069 7320 696e 7661   --login is inva
+00037420: 6c69 642e 2022 0a20 2020 2020 2020 2020  lid. ".         
+00037430: 2020 2020 2020 2022 5370 6563 6966 7920         "Specify 
+00037440: 636f 7272 6563 7420 7573 6572 2069 642e  correct user id.
+00037450: 220a 2020 2020 2020 2020 2020 2020 2920  ".            ) 
+00037460: 6672 6f6d 204e 6f6e 650a 2020 2020 6966  from None.    if
+00037470: 2069 735f 7368 6f72 745f 726f 6f6d 5f61   is_short_room_a
+00037480: 6c69 6173 2872 6f6f 6d5f 6964 293a 0a20  lias(room_id):. 
+00037490: 2020 2020 2020 2069 6620 726f 6f6d 5f69         if room_i
+000374a0: 645b 305d 2021 3d20 2223 223a 0a20 2020  d[0] != "#":.   
+000374b0: 2020 2020 2020 2020 2072 6f6f 6d5f 6964           room_id
+000374c0: 203d 2022 2322 202b 2072 6f6f 6d5f 6964   = "#" + room_id
+000374d0: 0a20 2020 2020 2020 2072 6f6f 6d5f 6964  .        room_id
+000374e0: 203d 2072 6f6f 6d5f 6964 202b 2022 3a22   = room_id + ":"
+000374f0: 202b 2068 6f6d 6573 6572 7665 725f 7368   + homeserver_sh
+00037500: 6f72 7420 2023 2064 6f6e 7420 7573 6520  ort  # dont use 
+00037510: 666e 0a20 2020 2069 6620 6e6f 7420 6973  fn.    if not is
+00037520: 5f72 6f6f 6d28 726f 6f6d 5f69 6429 3a0a  _room(room_id):.
+00037530: 2020 2020 2020 2020 7261 6973 6520 4d61          raise Ma
+00037540: 7472 6978 436f 6d6d 616e 6465 7245 7272  trixCommanderErr
+00037550: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00037560: 2245 3232 383a 2022 0a20 2020 2020 2020  "E228: ".       
+00037570: 2020 2020 2066 2252 6f6f 6d20 6964 2027       f"Room id '
+00037580: 7b72 6f6f 6d5f 6964 7d27 2066 6f72 202d  {room_id}' for -
+00037590: 2d6c 6f67 696e 2069 7320 696e 7661 6c69  -login is invali
+000375a0: 642e 2022 0a20 2020 2020 2020 2020 2020  d. ".           
+000375b0: 2022 5370 6563 6966 7920 636f 7272 6563   "Specify correc
+000375c0: 7420 726f 6f6d 2069 642e 220a 2020 2020  t room id.".    
+000375d0: 2020 2020 2920 6672 6f6d 204e 6f6e 650a      ) from None.
+000375e0: 0a20 2020 2067 732e 6c6f 672e 696e 666f  .    gs.log.info
+000375f0: 2866 2254 6865 2070 726f 7669 6465 6420  (f"The provided 
+00037600: 6c6f 6769 6e20 6461 7461 2069 733a 2068  login data is: h
+00037610: 6f6d 6573 6572 7665 723d 277b 686f 6d65  omeserver='{home
+00037620: 7365 7276 6572 7d27 2229 0a20 2020 2067  server}'").    g
+00037630: 732e 6c6f 672e 696e 666f 2866 2220 2020  s.log.info(f"   
+00037640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037650: 2020 2020 2020 2020 2075 7365 7220 6964           user id
+00037660: 3d27 7b75 7365 725f 6964 7d27 2229 0a20  ='{user_id}'"). 
+00037670: 2020 2023 2067 732e 6c6f 672e 696e 666f     # gs.log.info
+00037680: 2866 2220 2020 2020 2020 2020 2020 2020  (f"             
+00037690: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+000376a0: 6173 7377 6f72 643d 277b 7061 7373 776f  assword='{passwo
+000376b0: 7264 7d27 2229 0a20 2020 2067 732e 6c6f  rd}'").    gs.lo
+000376c0: 672e 696e 666f 2866 2220 2020 2020 2020  g.info(f"       
+000376d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000376e0: 2020 2020 2064 6576 6963 6520 6e61 6d65       device name
+000376f0: 3d27 7b64 6576 6963 655f 6e61 6d65 7d27  ='{device_name}'
+00037700: 2229 0a20 2020 2067 732e 6c6f 672e 696e  ").    gs.log.in
+00037710: 666f 2866 2220 2020 2020 2020 2020 2020  fo(f"           
+00037720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037730: 2072 6f6f 6d20 6964 3d27 7b72 6f6f 6d5f   room id='{room_
+00037740: 6964 7d27 2229 0a20 2020 2069 6620 696e  id}'").    if in
+00037750: 7465 7261 6374 6976 653a 0a20 2020 2020  teractive:.     
+00037760: 2020 2070 7269 6e74 2866 2254 6865 2070     print(f"The p
+00037770: 726f 7669 6465 6420 6c6f 6769 6e20 6461  rovided login da
+00037780: 7461 2069 733a 2068 6f6d 6573 6572 7665  ta is: homeserve
+00037790: 723d 277b 686f 6d65 7365 7276 6572 7d27  r='{homeserver}'
+000377a0: 2229 0a20 2020 2020 2020 2070 7269 6e74  ").        print
+000377b0: 2866 2220 2020 2020 2020 2020 2020 2020  (f"             
+000377c0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+000377d0: 7365 7220 6964 3d27 7b75 7365 725f 6964  ser id='{user_id
+000377e0: 7d27 2229 0a20 2020 2020 2020 2023 2070  }'").        # p
+000377f0: 7269 6e74 2866 2220 2020 2020 2020 2020  rint(f"         
+00037800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037810: 2020 2070 6173 7377 6f72 643d 277b 7061     password='{pa
+00037820: 7373 776f 7264 7d27 2229 0a20 2020 2020  ssword}'").     
+00037830: 2020 2070 7269 6e74 2822 2020 2020 2020     print("      
+00037840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037850: 2020 2020 2020 7061 7373 776f 7264 3d27        password='
+00037860: 2a2a 2a27 2229 0a20 2020 2020 2020 2070  ***'").        p
+00037870: 7269 6e74 2866 2220 2020 2020 2020 2020  rint(f"         
+00037880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037890: 2020 2064 6576 6963 6520 6e61 6d65 3d27     device name='
+000378a0: 7b64 6576 6963 655f 6e61 6d65 7d27 2229  {device_name}'")
+000378b0: 0a20 2020 2020 2020 2070 7269 6e74 280a  .        print(.
+000378c0: 2020 2020 2020 2020 2020 2020 6622 2020              f"  
+000378d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000378e0: 2020 2020 2020 2020 2020 726f 6f6d 2069            room i
+000378f0: 643d 277b 726f 6f6d 5f69 647d 2722 2c0a  d='{room_id}'",.
+00037900: 2020 2020 2020 2020 2020 2020 666c 7573              flus
+00037910: 683d 5472 7565 2c0a 2020 2020 2020 2020  h=True,.        
+00037920: 290a 2020 2020 2020 2020 636f 6e66 6972  ).        confir
+00037930: 6d20 3d20 696e 7075 7428 2243 6f72 7265  m = input("Corre
+00037940: 6374 3f20 2859 6573 206f 7220 4374 726c  ct? (Yes or Ctrl
+00037950: 2d43 2074 6f20 6162 6f72 7429 2022 290a  -C to abort) ").
+00037960: 2020 2020 2020 2020 6966 2063 6f6e 6669          if confi
+00037970: 726d 2e6c 6f77 6572 2829 2021 3d20 2279  rm.lower() != "y
+00037980: 6573 2220 616e 6420 636f 6e66 6972 6d2e  es" and confirm.
+00037990: 6c6f 7765 7228 2920 213d 2022 7922 3a0a  lower() != "y":.
+000379a0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+000379b0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+000379c0: 2020 2022 222c 0a20 2020 2020 2020 2020     "",.         
+000379d0: 2020 2020 2020 2066 6c75 7368 3d54 7275         flush=Tru
+000379e0: 652c 0a20 2020 2020 2020 2020 2020 2029  e,.            )
+000379f0: 2020 2320 6164 6420 6e65 776c 696e 6520    # add newline 
+00037a00: 746f 2073 7464 6f75 7420 746f 2073 6570  to stdout to sep
+00037a10: 6172 6174 6520 616e 7920 6c6f 6720 696e  arate any log in
+00037a20: 666f 0a20 2020 2020 2020 2020 2020 2067  fo.            g
+00037a30: 732e 6c6f 672e 696e 666f 2822 4162 6f72  s.log.info("Abor
+00037a40: 7469 6e67 2064 7565 2074 6f20 7573 6572  ting due to user
+00037a50: 2072 6571 7565 7374 2e22 290a 2020 2020   request.").    
+00037a60: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
+00037a70: 2020 2020 2320 616c 6c20 7468 6520 696e      # all the in
+00037a80: 7075 7420 7265 7175 6972 6564 2066 6f72  put required for
+00037a90: 206c 6f67 696e 2069 7320 636f 6c6c 6563   login is collec
+00037aa0: 7465 642c 0a20 2020 2023 206c 6174 6572  ted,.    # later
+00037ab0: 2077 6520 6765 7420 7573 6572 5f69 6420   we get user_id 
+00037ac0: 666f 7220 5353 4f20 2872 6574 7572 6e65  for SSO (returne
+00037ad0: 6420 6174 206c 6f67 696e 2041 5049 2063  d at login API c
+00037ae0: 616c 6c29 0a0a 2020 2020 6966 2067 732e  all)..    if gs.
+00037af0: 7061 2e70 726f 7879 3a0a 2020 2020 2020  pa.proxy:.      
+00037b00: 2020 6773 2e6c 6f67 2e69 6e66 6f28 6622    gs.log.info(f"
+00037b10: 5072 6f78 7920 7b67 732e 7061 2e70 726f  Proxy {gs.pa.pro
+00037b20: 7879 7d20 7769 6c6c 2062 6520 7573 6564  xy} will be used
+00037b30: 2e22 290a 0a20 2020 2023 2063 6865 636b  .")..    # check
+00037b40: 2066 6f72 2070 6173 7377 6f72 642f 5353   for password/SS
+00037b50: 4f0a 2020 2020 636f 6e6e 6563 746f 7220  O.    connector 
+00037b60: 3d20 5443 5043 6f6e 6e65 6374 6f72 2873  = TCPConnector(s
+00037b70: 736c 3d67 732e 7373 6c29 2020 2320 7365  sl=gs.ssl)  # se
+00037b80: 7474 696e 6720 7373 6c63 6f6e 7465 7874  tting sslcontext
+00037b90: 0a20 2020 2061 7379 6e63 2077 6974 6820  .    async with 
+00037ba0: 436c 6965 6e74 5365 7373 696f 6e28 636f  ClientSession(co
+00037bb0: 6e6e 6563 746f 723d 636f 6e6e 6563 746f  nnector=connecto
+00037bc0: 7229 2061 7320 7365 7373 696f 6e3a 2020  r) as session:  
+00037bd0: 2320 6169 6f68 7474 700a 2020 2020 2020  # aiohttp.      
+00037be0: 2020 6173 796e 6320 7769 7468 2073 6573    async with ses
+00037bf0: 7369 6f6e 2e67 6574 280a 2020 2020 2020  sion.get(.      
+00037c00: 2020 2020 2020 6622 7b68 6f6d 6573 6572        f"{homeser
+00037c10: 7665 727d 2f5f 6d61 7472 6978 2f63 6c69  ver}/_matrix/cli
+00037c20: 656e 742f 7230 2f6c 6f67 696e 222c 0a20  ent/r0/login",. 
+00037c30: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00037c40: 5f66 6f72 5f73 7461 7475 733d 5472 7565  _for_status=True
+00037c50: 2c0a 2020 2020 2020 2020 2020 2020 7072  ,.            pr
+00037c60: 6f78 793d 6773 2e70 612e 7072 6f78 792c  oxy=gs.pa.proxy,
+00037c70: 0a20 2020 2020 2020 2029 2061 7320 7265  .        ) as re
+00037c80: 7370 6f6e 7365 3a0a 2020 2020 2020 2020  sponse:.        
+00037c90: 2020 2020 666c 6f77 5f74 7970 6573 203d      flow_types =
+00037ca0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00037cb0: 2020 2078 5b22 7479 7065 225d 2066 6f72     x["type"] for
+00037cc0: 2078 2069 6e20 2861 7761 6974 2072 6573   x in (await res
+00037cd0: 706f 6e73 652e 6a73 6f6e 2829 292e 6765  ponse.json()).ge
+00037ce0: 7428 2266 6c6f 7773 222c 205b 5d29 0a20  t("flows", []). 
+00037cf0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00037d00: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
+00037d10: 6465 6275 6728 2253 7570 706f 7274 6564  debug("Supported
+00037d20: 206c 6f67 696e 2066 6c6f 7773 3a20 2572   login flows: %r
+00037d30: 222c 2066 6c6f 775f 7479 7065 7329 0a0a  ", flow_types)..
+00037d40: 2020 2020 2020 2020 2020 2020 2320 746f              # to
+00037d50: 6b65 6e5f 6176 6169 6c61 626c 6520 3d20  ken_available = 
+00037d60: 226d 2e6c 6f67 696e 2e74 6f6b 656e 2220  "m.login.token" 
+00037d70: 696e 2066 6c6f 775f 7479 7065 730a 2020  in flow_types.  
+00037d80: 2020 2020 2020 2020 2020 2320 6d2e 6c6f            # m.lo
+00037d90: 6769 6e2e 746f 6b65 6e20 646f 6573 206e  gin.token does n
+00037da0: 6f74 2072 6566 6572 2074 6f20 7374 6420  ot refer to std 
+00037db0: 6163 6365 7373 2d74 6f6b 656e 206c 6f67  access-token log
+00037dc0: 696e 0a20 2020 2020 2020 2020 2020 2070  in.            p
+00037dd0: 6173 7377 6f72 645f 6176 6169 6c61 626c  assword_availabl
+00037de0: 6520 3d20 226d 2e6c 6f67 696e 2e70 6173  e = "m.login.pas
+00037df0: 7377 6f72 6422 2069 6e20 666c 6f77 5f74  sword" in flow_t
+00037e00: 7970 6573 0a20 2020 2020 2020 2020 2020  ypes.           
+00037e10: 2073 736f 5f61 7661 696c 6162 6c65 203d   sso_available =
+00037e20: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00037e30: 2020 2022 6d2e 6c6f 6769 6e2e 7373 6f22     "m.login.sso"
+00037e40: 2069 6e20 666c 6f77 5f74 7970 6573 2061   in flow_types a
+00037e50: 6e64 2022 6d2e 6c6f 6769 6e2e 746f 6b65  nd "m.login.toke
+00037e60: 6e22 2069 6e20 666c 6f77 5f74 7970 6573  n" in flow_types
+00037e70: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+00037e80: 2020 2020 6966 206d 6574 686f 6420 3d3d      if method ==
+00037e90: 2022 7373 6f22 2061 6e64 206e 6f74 2073   "sso" and not s
+00037ea0: 736f 5f61 7661 696c 6162 6c65 3a0a 2020  so_available:.  
+00037eb0: 2020 2020 2020 7261 6973 6520 4d61 7472        raise Matr
+00037ec0: 6978 436f 6d6d 616e 6465 7245 7272 6f72  ixCommanderError
+00037ed0: 280a 2020 2020 2020 2020 2020 2020 2245  (.            "E
+00037ee0: 3232 393a 2022 0a20 2020 2020 2020 2020  229: ".         
+00037ef0: 2020 2022 4d65 7468 6f64 2027 7373 6f27     "Method 'sso'
+00037f00: 2077 6173 2073 656c 6563 7465 6420 666f   was selected fo
+00037f10: 7220 2d2d 6c6f 6769 6e20 6275 7420 4d61  r --login but Ma
+00037f20: 7472 6978 2073 6572 7665 7220 646f 6573  trix server does
+00037f30: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
+00037f40: 6e6f 7420 7375 7070 6f72 7420 5369 6e67  not support Sing
+00037f50: 6c65 2053 6967 6e2d 4f6e 2e20 5472 7920  le Sign-On. Try 
+00037f60: 2d2d 6c6f 6769 6e20 7769 7468 206d 6574  --login with met
+00037f70: 686f 6420 2770 6173 7377 6f72 6427 2e22  hod 'password'."
+00037f80: 0a20 2020 2020 2020 2029 2066 726f 6d20  .        ) from 
+00037f90: 4e6f 6e65 0a20 2020 2069 6620 6d65 7468  None.    if meth
+00037fa0: 6f64 203d 3d20 2270 6173 7377 6f72 6422  od == "password"
+00037fb0: 2061 6e64 206e 6f74 2070 6173 7377 6f72   and not passwor
+00037fc0: 645f 6176 6169 6c61 626c 653a 0a20 2020  d_available:.   
+00037fd0: 2020 2020 2072 6169 7365 204d 6174 7269       raise Matri
+00037fe0: 7843 6f6d 6d61 6e64 6572 4572 726f 7228  xCommanderError(
+00037ff0: 0a20 2020 2020 2020 2020 2020 2022 4532  .            "E2
+00038000: 3330 3a20 220a 2020 2020 2020 2020 2020  30: ".          
+00038010: 2020 224d 6574 686f 6420 2770 6173 7377    "Method 'passw
+00038020: 6f72 6427 2077 6173 2073 656c 6563 7465  ord' was selecte
+00038030: 6420 666f 7220 2d2d 6c6f 6769 6e20 6275  d for --login bu
+00038040: 7420 4d61 7472 6978 2073 6572 7665 7220  t Matrix server 
+00038050: 220a 2020 2020 2020 2020 2020 2020 2264  ".            "d
+00038060: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+00038070: 7061 7373 776f 7264 206c 6f67 696e 2e20  password login. 
+00038080: 5472 7920 2d2d 6c6f 6769 6e20 7769 7468  Try --login with
+00038090: 206d 6574 686f 6420 2773 736f 272e 220a   method 'sso'.".
+000380a0: 2020 2020 2020 2020 2920 6672 6f6d 204e          ) from N
+000380b0: 6f6e 650a 0a20 2020 2023 2053 534f 3a20  one..    # SSO: 
+000380c0: 5369 6e67 6c65 2053 6967 6e2d 4f6e 3a0a  Single Sign-On:.
+000380d0: 2020 2020 2320 7365 6520 6874 7470 733a      # see https:
+000380e0: 2f2f 6d61 7472 6978 2e6f 7267 2f64 6f63  //matrix.org/doc
+000380f0: 732f 6775 6964 6573 2f73 736f 2d66 6f72  s/guides/sso-for
+00038100: 2d63 6c69 656e 742d 6465 7665 6c6f 7065  -client-develope
+00038110: 7273 0a20 2020 2069 6620 7373 6f5f 6176  rs.    if sso_av
+00038120: 6169 6c61 626c 653a 0a20 2020 2020 2020  ailable:.       
+00038130: 2067 732e 6c6f 672e 6465 6275 6728 2253   gs.log.debug("S
+00038140: 6572 7665 7220 7375 7070 6f72 7473 2053  erver supports S
+00038150: 534f 2066 6f72 206c 6f67 696e 2e22 290a  SO for login.").
+00038160: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00038170: 2020 6773 2e6c 6f67 2e64 6562 7567 2822    gs.log.debug("
+00038180: 5365 7276 6572 2064 6f65 7320 6e6f 7420  Server does not 
+00038190: 7375 7070 6f72 7420 5353 4f20 666f 7220  support SSO for 
+000381a0: 6c6f 6769 6e2e 2229 0a0a 2020 2020 6966  login.")..    if
+000381b0: 206d 6574 686f 6420 3d3d 2022 7373 6f22   method == "sso"
+000381c0: 3a0a 2020 2020 2020 2020 2320 7374 6172  :.        # star
+000381d0: 7475 7020 7365 7276 6572 2074 6f20 6861  tup server to ha
+000381e0: 6e64 6c65 2072 6573 706f 6e73 650a 2020  ndle response.  
+000381f0: 2020 2020 2020 7374 6f70 5f73 6572 7665        stop_serve
+00038200: 725f 6576 7420 3d20 6173 796e 6369 6f2e  r_evt = asyncio.
+00038210: 4576 656e 7428 290a 2020 2020 2020 2020  Event().        
+00038220: 6c6f 6769 6e5f 746f 6b65 6e20 3d20 4e6f  login_token = No
+00038230: 6e65 0a0a 2020 2020 2020 2020 6173 796e  ne..        asyn
+00038240: 6320 6465 6620 6861 6e64 6c65 2872 6571  c def handle(req
+00038250: 7565 7374 293a 0a20 2020 2020 2020 2020  uest):.         
+00038260: 2020 206e 6f6e 6c6f 6361 6c20 6c6f 6769     nonlocal logi
+00038270: 6e5f 746f 6b65 6e0a 2020 2020 2020 2020  n_token.        
+00038280: 2020 2020 6c6f 6769 6e5f 746f 6b65 6e20      login_token 
+00038290: 3d20 7265 7175 6573 742e 7175 6572 792e  = request.query.
+000382a0: 6765 7428 226c 6f67 696e 546f 6b65 6e22  get("loginToken"
+000382b0: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
+000382c0: 6f70 5f73 6572 7665 725f 6576 742e 7365  op_server_evt.se
+000382d0: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+000382e0: 7265 7475 726e 2077 6562 2e52 6573 706f  return web.Respo
+000382f0: 6e73 6528 0a20 2020 2020 2020 2020 2020  nse(.           
+00038300: 2020 2020 2062 6f64 793d 224c 6f67 696e       body="Login
+00038310: 2063 6f6d 706c 6574 652e 2059 6f75 2063   complete. You c
+00038320: 616e 206e 6f77 2063 6c6f 7365 2074 6869  an now close thi
+00038330: 7320 7061 6765 2e22 0a20 2020 2020 2020  s page.".       
+00038340: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00038350: 6170 7020 3d20 7765 622e 4170 706c 6963  app = web.Applic
+00038360: 6174 696f 6e28 290a 2020 2020 2020 2020  ation().        
+00038370: 6170 702e 6164 645f 726f 7574 6573 285b  app.add_routes([
+00038380: 7765 622e 6765 7428 222f 222c 2068 616e  web.get("/", han
+00038390: 646c 6529 5d29 0a0a 2020 2020 2020 2020  dle)])..        
+000383a0: 6c6f 6767 696e 672e 6765 744c 6f67 6765  logging.getLogge
+000383b0: 7228 2261 696f 6874 7470 2e61 6363 6573  r("aiohttp.acces
+000383c0: 7322 292e 7365 744c 6576 656c 286c 6f67  s").setLevel(log
+000383d0: 6769 6e67 2e57 4152 4e49 4e47 290a 2020  ging.WARNING).  
+000383e0: 2020 2020 2020 7275 6e6e 6572 203d 2077        runner = w
+000383f0: 6562 2e41 7070 5275 6e6e 6572 2861 7070  eb.AppRunner(app
+00038400: 290a 2020 2020 2020 2020 6177 6169 7420  ).        await 
+00038410: 7275 6e6e 6572 2e73 6574 7570 2829 0a20  runner.setup(). 
+00038420: 2020 2020 2020 2073 6974 6520 3d20 7765         site = we
+00038430: 622e 5443 5053 6974 6528 7275 6e6e 6572  b.TCPSite(runner
+00038440: 2c20 226c 6f63 616c 686f 7374 222c 2033  , "localhost", 3
+00038450: 3830 3830 290a 2020 2020 2020 2020 6177  8080).        aw
+00038460: 6169 7420 7369 7465 2e73 7461 7274 2829  ait site.start()
+00038470: 0a0a 2020 2020 2020 2020 7472 793a 0a20  ..        try:. 
+00038480: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
+00038490: 672e 696e 666f 2822 4c61 756e 6368 696e  g.info("Launchin
+000384a0: 6720 6272 6f77 7365 7220 746f 2063 6f6d  g browser to com
+000384b0: 706c 6574 6520 5353 4f20 6c6f 6769 6e2e  plete SSO login.
+000384c0: 2229 0a20 2020 2020 2020 2020 2020 2069  ").            i
+000384d0: 6620 6773 2e70 612e 7072 6f78 793a 0a20  f gs.pa.proxy:. 
+000384e0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+000384f0: 732e 6c6f 672e 7761 726e 696e 6728 0a20  s.log.warning(. 
+00038500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038510: 2020 2022 5731 3130 3a20 220a 2020 2020     "W110: ".    
+00038520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038530: 6622 5370 6563 6966 6965 6420 7072 6f78  f"Specified prox
+00038540: 7920 7b67 732e 7061 2e70 726f 7879 7d20  y {gs.pa.proxy} 
+00038550: 6361 6e6e 6f74 2022 0a20 2020 2020 2020  cannot ".       
+00038560: 2020 2020 2020 2020 2020 2020 2022 6265               "be
+00038570: 2063 6f6e 6669 6775 7265 6420 666f 7220   configured for 
+00038580: 6272 6f77 7365 722e 220a 2020 2020 2020  browser.".      
+00038590: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000385a0: 2020 2020 2020 2020 2020 2020 6773 2e77              gs.w
+000385b0: 6172 6e5f 636f 756e 7420 2b3d 2031 0a0a  arn_count += 1..
+000385c0: 2020 2020 2020 2020 2020 2020 2320 6c61              # la
+000385d0: 756e 6368 2077 6562 2d62 726f 7773 6572  unch web-browser
+000385e0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000385f0: 7379 732e 706c 6174 666f 726d 2e73 7461  sys.platform.sta
+00038600: 7274 7377 6974 6828 2264 6172 7769 6e22  rtswith("darwin"
+00038610: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00038620: 2020 2063 6d64 203d 205b 7368 7574 696c     cmd = [shutil
+00038630: 2e77 6869 6368 2822 6f70 656e 2229 5d0a  .which("open")].
+00038640: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00038650: 2073 7973 2e70 6c61 7466 6f72 6d2e 7374   sys.platform.st
+00038660: 6172 7473 7769 7468 2822 7769 6e22 293a  artswith("win"):
+00038670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038680: 2063 6d64 203d 205b 2273 7461 7274 225d   cmd = ["start"]
+00038690: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+000386a0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000386b0: 2020 2063 6d64 203d 205b 7368 7574 696c     cmd = [shutil
+000386c0: 2e77 6869 6368 2822 7864 672d 6f70 656e  .which("xdg-open
+000386d0: 2229 5d0a 2020 2020 2020 2020 2020 2020  ")].            
+000386e0: 2020 2020 6966 2063 6d64 203d 3d20 5b4e      if cmd == [N
+000386f0: 6f6e 655d 3a0a 2020 2020 2020 2020 2020  one]:.          
+00038700: 2020 2020 2020 2020 2020 636d 6420 3d20            cmd = 
+00038710: 5b73 6875 7469 6c2e 7768 6963 6828 2278  [shutil.which("x
+00038720: 2d77 7777 2d62 726f 7773 6572 2229 5d0a  -www-browser")].
+00038730: 2020 2020 2020 2020 2020 2020 636d 642e              cmd.
+00038740: 6170 7065 6e64 280a 2020 2020 2020 2020  append(.        
+00038750: 2020 2020 2020 2020 6622 7b68 6f6d 6573          f"{homes
+00038760: 6572 7665 727d 2f5f 6d61 7472 6978 2f63  erver}/_matrix/c
+00038770: 6c69 656e 742f 7230 2f6c 6f67 696e 2f73  lient/r0/login/s
+00038780: 736f 2f72 6564 6972 6563 7422 0a20 2020  so/redirect".   
+00038790: 2020 2020 2020 2020 2020 2020 2022 3f72               "?r
+000387a0: 6564 6972 6563 7455 726c 3d68 7474 703a  edirectUrl=http:
+000387b0: 2f2f 6c6f 6361 6c68 6f73 743a 3338 3038  //localhost:3808
+000387c0: 302f 220a 2020 2020 2020 2020 2020 2020  0/".            
+000387d0: 290a 2020 2020 2020 2020 2020 2020 7472  ).            tr
+000387e0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+000387f0: 2020 2073 7562 7072 6f63 6573 732e 6368     subprocess.ch
+00038800: 6563 6b5f 6f75 7470 7574 2863 6d64 290a  eck_output(cmd).
+00038810: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+00038820: 7074 2045 7863 6570 7469 6f6e 3a0a 2020  pt Exception:.  
+00038830: 2020 2020 2020 2020 2020 2020 2020 6773                gs
+00038840: 2e6c 6f67 2e65 7272 6f72 280a 2020 2020  .log.error(.    
+00038850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038860: 2245 3233 313a 2022 0a20 2020 2020 2020  "E231: ".       
+00038870: 2020 2020 2020 2020 2020 2020 2022 4272               "Br
+00038880: 6f77 7365 7220 636f 756c 6420 6e6f 7420  owser could not 
+00038890: 6265 206c 6175 6e63 6865 642e 2022 0a20  be launched. ". 
+000388a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000388b0: 2020 2022 4865 6e63 6520 5353 4f20 2853     "Hence SSO (S
+000388c0: 696e 676c 6520 5369 676e 2d4f 6e29 206c  ingle Sign-On) l
+000388d0: 6f67 696e 2063 6f75 6c64 206e 6f74 2062  ogin could not b
+000388e0: 6520 220a 2020 2020 2020 2020 2020 2020  e ".            
+000388f0: 2020 2020 2020 2020 2263 6f6d 706c 6574          "complet
+00038900: 6564 2e20 536f 7272 792e 2049 6620 796f  ed. Sorry. If yo
+00038910: 7520 7468 696e 6b20 7468 6520 6272 6f77  u think the brow
+00038920: 7365 7220 616e 6420 220a 2020 2020 2020  ser and ".      
+00038930: 2020 2020 2020 2020 2020 2020 2020 2253                "S
+00038940: 534f 2073 686f 756c 6420 776f 726b 2074  SO should work t
+00038950: 6865 6e20 7472 7920 6167 6169 6e2e 2049  hen try again. I
+00038960: 6620 796f 7520 646f 206e 6f74 2068 6176  f you do not hav
+00038970: 6520 220a 2020 2020 2020 2020 2020 2020  e ".            
+00038980: 2020 2020 2020 2020 2261 2062 726f 7773          "a brows
+00038990: 6572 206f 7220 646f 6e27 7420 7761 6e74  er or don't want
+000389a0: 2053 534f 206f 7220 7761 6e74 2074 6f20   SSO or want to 
+000389b0: 6c6f 6769 6e20 7769 7468 2061 2022 0a20  login with a ". 
+000389c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000389d0: 2020 2022 7061 7373 776f 7264 2069 6e73     "password ins
+000389e0: 7465 6164 2c20 7468 656e 2075 7365 2027  tead, then use '
+000389f0: 2d2d 6c6f 6769 6e20 7061 7373 776f 7264  --login password
+00038a00: 2720 696e 2022 0a20 2020 2020 2020 2020  ' in ".         
+00038a10: 2020 2020 2020 2020 2020 2022 7468 6520             "the 
+00038a20: 636f 6d6d 616e 6420 6c69 6e65 2e22 0a20  command line.". 
+00038a30: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00038a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038a50: 2072 6169 7365 0a0a 2020 2020 2020 2020   raise..        
+00038a60: 2020 2020 2320 7761 6974 2061 6e64 2073      # wait and s
+00038a70: 6875 7464 6f77 6e20 7365 7276 6572 0a20  hutdown server. 
+00038a80: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00038a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038aa0: 6177 6169 7420 6173 796e 6369 6f2e 7761  await asyncio.wa
+00038ab0: 6974 5f66 6f72 2873 746f 705f 7365 7276  it_for(stop_serv
+00038ac0: 6572 5f65 7674 2e77 6169 7428 292c 2035  er_evt.wait(), 5
+00038ad0: 202a 2036 3029 0a20 2020 2020 2020 2020   * 60).         
+00038ae0: 2020 2065 7863 6570 7420 6173 796e 6369     except asynci
+00038af0: 6f2e 5469 6d65 6f75 7445 7272 6f72 3a0a  o.TimeoutError:.
+00038b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038b10: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
+00038b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038b30: 2020 2245 3233 323a 2022 0a20 2020 2020    "E232: ".     
+00038b40: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00038b50: 2254 6865 2070 726f 6772 616d 207b 5052  "The program {PR
+00038b60: 4f47 5f57 4954 485f 4558 547d 2066 6169  OG_WITH_EXT} fai
+00038b70: 6c65 642e 2022 0a20 2020 2020 2020 2020  led. ".         
+00038b80: 2020 2020 2020 2020 2020 2022 4e6f 2072             "No r
+00038b90: 6573 706f 6e73 6520 7761 7320 7265 6365  esponse was rece
+00038ba0: 6976 6564 2066 726f 6d20 5353 4f20 7072  ived from SSO pr
+00038bb0: 6f76 6964 6572 2e20 220a 2020 2020 2020  ovider. ".      
+00038bc0: 2020 2020 2020 2020 2020 2020 2020 2254                "T
+00038bd0: 6865 7265 2077 6173 2061 2074 696d 656f  here was a timeo
+00038be0: 7574 2e20 536f 7272 792e 220a 2020 2020  ut. Sorry.".    
+00038bf0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00038c00: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00038c10: 6973 650a 2020 2020 2020 2020 6669 6e61  ise.        fina
+00038c20: 6c6c 793a 0a20 2020 2020 2020 2020 2020  lly:.           
+00038c30: 2061 7761 6974 2072 756e 6e65 722e 636c   await runner.cl
+00038c40: 6561 6e75 7028 290a 0a20 2020 2023 2043  eanup()..    # C
+00038c50: 6f6e 6669 6775 7261 7469 6f6e 206f 7074  onfiguration opt
+00038c60: 696f 6e73 2066 6f72 2074 6865 2041 7379  ions for the Asy
+00038c70: 6e63 436c 6965 6e74 0a20 2020 2063 6c69  ncClient.    cli
+00038c80: 656e 745f 636f 6e66 6967 203d 2041 7379  ent_config = Asy
+00038c90: 6e63 436c 6965 6e74 436f 6e66 6967 280a  ncClientConfig(.
+00038ca0: 2020 2020 2020 2020 6d61 785f 6c69 6d69          max_limi
+00038cb0: 745f 6578 6365 6564 6564 3d30 2c0a 2020  t_exceeded=0,.  
+00038cc0: 2020 2020 2020 6d61 785f 7469 6d65 6f75        max_timeou
+00038cd0: 7473 3d30 2c0a 2020 2020 2020 2020 7374  ts=0,.        st
+00038ce0: 6f72 655f 7379 6e63 5f74 6f6b 656e 733d  ore_sync_tokens=
+00038cf0: 5472 7565 2c0a 2020 2020 2020 2020 656e  True,.        en
+00038d00: 6372 7970 7469 6f6e 5f65 6e61 626c 6564  cryption_enabled
+00038d10: 3d54 7275 652c 0a20 2020 2029 0a0a 2020  =True,.    )..  
+00038d20: 2020 7374 6f72 655f 6372 6561 7465 2873    store_create(s
+00038d30: 746f 7265 5f64 6972 290a 0a20 2020 2023  tore_dir)..    #
+00038d40: 2049 6e69 7469 616c 697a 6520 7468 6520   Initialize the 
+00038d50: 6d61 7472 6978 2063 6c69 656e 740a 2020  matrix client.  
+00038d60: 2020 636c 6965 6e74 203d 2041 7379 6e63    client = Async
+00038d70: 436c 6965 6e74 280a 2020 2020 2020 2020  Client(.        
+00038d80: 686f 6d65 7365 7276 6572 2c0a 2020 2020  homeserver,.    
+00038d90: 2020 2020 2222 2069 6620 6e6f 7420 7573      "" if not us
+00038da0: 6572 5f69 6420 656c 7365 2075 7365 725f  er_id else user_
+00038db0: 6964 2c0a 2020 2020 2020 2020 7374 6f72  id,.        stor
+00038dc0: 655f 7061 7468 3d73 746f 7265 5f64 6972  e_path=store_dir
+00038dd0: 2c0a 2020 2020 2020 2020 636f 6e66 6967  ,.        config
+00038de0: 3d63 6c69 656e 745f 636f 6e66 6967 2c0a  =client_config,.
+00038df0: 2020 2020 2020 2020 7373 6c3d 6773 2e73          ssl=gs.s
+00038e00: 736c 2c0a 2020 2020 2020 2020 7072 6f78  sl,.        prox
+00038e10: 793d 6773 2e70 612e 7072 6f78 792c 0a20  y=gs.pa.proxy,. 
+00038e20: 2020 2029 0a20 2020 2074 7279 3a0a 2020     ).    try:.  
+00038e30: 2020 2020 2020 6966 206d 6574 686f 6420        if method 
+00038e40: 3d3d 2022 7373 6f22 3a0a 2020 2020 2020  == "sso":.      
+00038e50: 2020 2020 2020 7265 7370 203d 2061 7761        resp = awa
+00038e60: 6974 2063 6c69 656e 742e 6c6f 6769 6e28  it client.login(
+00038e70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038e80: 2074 6f6b 656e 3d6c 6f67 696e 5f74 6f6b   token=login_tok
+00038e90: 656e 2c20 6465 7669 6365 5f6e 616d 653d  en, device_name=
+00038ea0: 6465 7669 6365 5f6e 616d 650a 2020 2020  device_name.    
+00038eb0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00038ec0: 2020 656c 6966 206d 6574 686f 6420 3d3d    elif method ==
+00038ed0: 2022 7061 7373 776f 7264 223a 0a20 2020   "password":.   
+00038ee0: 2020 2020 2020 2020 2072 6573 7020 3d20           resp = 
+00038ef0: 6177 6169 7420 636c 6965 6e74 2e6c 6f67  await client.log
+00038f00: 696e 2870 6173 7377 6f72 642c 2064 6576  in(password, dev
+00038f10: 6963 655f 6e61 6d65 3d64 6576 6963 655f  ice_name=device_
+00038f20: 6e61 6d65 290a 0a20 2020 2020 2020 2023  name)..        #
+00038f30: 2063 6865 636b 2074 6861 7420 7765 206c   check that we l
+00038f40: 6f67 6765 6420 696e 2073 7563 6365 7366  ogged in succesf
+00038f50: 756c 6c79 0a20 2020 2020 2020 2069 6620  ully.        if 
+00038f60: 6973 696e 7374 616e 6365 2872 6573 702c  isinstance(resp,
+00038f70: 204c 6f67 696e 5265 7370 6f6e 7365 293a   LoginResponse):
+00038f80: 0a20 2020 2020 2020 2020 2020 2023 2077  .            # w
+00038f90: 6865 6e20 7772 6974 696e 672c 2061 6c77  hen writing, alw
+00038fa0: 6179 7320 7772 6974 6520 746f 2070 7269  ays write to pri
+00038fb0: 6d61 7279 206c 6f63 6174 696f 6e20 2865  mary location (e
+00038fc0: 2e67 2e20 2e29 0a20 2020 2020 2020 2020  .g. .).         
+00038fd0: 2020 2077 7269 7465 5f63 7265 6465 6e74     write_credent
+00038fe0: 6961 6c73 5f74 6f5f 6469 736b 280a 2020  ials_to_disk(.  
+00038ff0: 2020 2020 2020 2020 2020 2020 2020 686f                ho
+00039000: 6d65 7365 7276 6572 2c0a 2020 2020 2020  meserver,.      
+00039010: 2020 2020 2020 2020 2020 7265 7370 2e75            resp.u
+00039020: 7365 725f 6964 2c0a 2020 2020 2020 2020  ser_id,.        
+00039030: 2020 2020 2020 2020 7265 7370 2e64 6576          resp.dev
+00039040: 6963 655f 6964 2c20 2023 206e 6f74 6520  ice_id,  # note 
+00039050: 7468 6973 2069 7320 616e 2069 642c 206e  this is an id, n
+00039060: 6f74 2061 206e 616d 6521 0a20 2020 2020  ot a name!.     
+00039070: 2020 2020 2020 2020 2020 2072 6573 702e             resp.
+00039080: 6163 6365 7373 5f74 6f6b 656e 2c0a 2020  access_token,.  
+00039090: 2020 2020 2020 2020 2020 2020 2020 726f                ro
+000390a0: 6f6d 5f69 642c 0a20 2020 2020 2020 2020  om_id,.         
+000390b0: 2020 2020 2020 2067 732e 7061 2e63 7265         gs.pa.cre
+000390c0: 6465 6e74 6961 6c73 2c0a 2020 2020 2020  dentials,.      
+000390d0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000390e0: 2020 2020 6773 2e63 6c69 656e 7420 3d20      gs.client = 
+000390f0: 636c 6965 6e74 0a20 2020 2020 2020 2020  client.         
+00039100: 2020 2067 732e 6372 6564 656e 7469 616c     gs.credential
+00039110: 7320 3d20 7265 6164 5f63 7265 6465 6e74  s = read_credent
+00039120: 6961 6c73 5f66 726f 6d5f 6469 736b 2863  ials_from_disk(c
+00039130: 7265 6465 6e74 6961 6c73 5f66 696c 6529  redentials_file)
+00039140: 0a20 2020 2020 2020 2020 2020 2074 7874  .            txt
+00039150: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+00039160: 2020 2020 2022 4532 3333 3a20 220a 2020       "E233: ".  
+00039170: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00039180: 4c6f 6720 696e 2075 7369 6e67 206d 6574  Log in using met
+00039190: 686f 6420 277b 6d65 7468 6f64 7d27 2077  hod '{method}' w
+000391a0: 6173 2073 7563 6365 7373 6675 6c2e 2022  as successful. "
+000391b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000391c0: 2066 2243 7265 6465 6e74 6961 6c73 2077   f"Credentials w
+000391d0: 6572 6520 7374 6f72 6564 2069 6e20 6669  ere stored in fi
+000391e0: 6c65 2027 7b67 732e 7061 2e63 7265 6465  le '{gs.pa.crede
+000391f0: 6e74 6961 6c73 7d27 2e20 220a 2020 2020  ntials}'. ".    
+00039200: 2020 2020 2020 2020 2020 2020 6622 4672              f"Fr
+00039210: 6f6d 206e 6f77 206f 6e20 796f 7520 6361  om now on you ca
+00039220: 6e20 7275 6e20 7072 6f67 7261 6d20 277b  n run program '{
+00039230: 5052 4f47 5f57 4954 485f 4558 547d 2720  PROG_WITH_EXT}' 
+00039240: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00039250: 2020 2277 6974 686f 7574 206c 6f67 2069    "without log i
+00039260: 6e2c 2061 7320 616e 2061 6363 6573 7320  n, as an access 
+00039270: 746f 6b65 6e20 6973 2073 746f 7265 6420  token is stored 
+00039280: 696e 2079 6f75 7220 220a 2020 2020 2020  in your ".      
+00039290: 2020 2020 2020 2020 2020 2263 7265 6465            "crede
+000392a0: 6e74 6961 6c73 2066 696c 652e 2022 0a20  ntials file. ". 
+000392b0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000392c0: 4966 2079 6f75 2070 6c61 6e20 6f6e 2068  If you plan on h
+000392d0: 6176 696e 6720 6d61 6e79 2063 7265 6465  aving many crede
+000392e0: 6e74 6961 6c20 6669 6c65 732c 2063 6f6e  ntial files, con
+000392f0: 7369 6465 7220 220a 2020 2020 2020 2020  sider ".        
+00039300: 2020 2020 2020 2020 6622 6d6f 7669 6e67          f"moving
+00039310: 2074 6865 6d20 746f 2064 6972 6563 746f   them to directo
+00039320: 7279 2027 7b43 5245 4445 4e54 4941 4c53  ry '{CREDENTIALS
+00039330: 5f44 4952 5f4c 4153 5452 4553 4f52 547d  _DIR_LASTRESORT}
+00039340: 272e 220a 2020 2020 2020 2020 2020 2020  '.".            
+00039350: 290a 2020 2020 2020 2020 2020 2020 6773  ).            gs
+00039360: 2e6c 6f67 2e69 6e66 6f28 7478 7429 0a20  .log.info(txt). 
+00039370: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00039380: 2020 2020 2020 2020 2023 2069 7369 6e73           # isins
+00039390: 7461 6e63 6528 7265 7370 2c20 4c6f 6769  tance(resp, Logi
+000393a0: 6e45 7272 6f72 2920 3d3d 2074 7275 650a  nError) == true.
+000393b0: 2020 2020 2020 2020 2020 2020 2320 636c              # cl
+000393c0: 6561 6e75 700a 2020 2020 2020 2020 2020  eanup.          
+000393d0: 2020 6177 6169 7420 636c 6965 6e74 2e63    await client.c
+000393e0: 6c6f 7365 2829 2020 2320 6e6f 7420 7965  lose()  # not ye
+000393f0: 7420 696e 2067 732e 0a20 2020 2020 2020  t in gs..       
+00039400: 2020 2020 2073 746f 7265 5f64 656c 6574       store_delet
+00039410: 6528 7374 6f72 655f 6469 7229 2020 2320  e(store_dir)  # 
+00039420: 656d 7074 792c 206a 7573 7420 6372 6561  empty, just crea
+00039430: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
+00039440: 2320 7265 7370 2064 6f65 7320 6e6f 7420  # resp does not 
+00039450: 636f 6e74 6169 6e20 7365 6372 6574 730a  contain secrets.
+00039460: 2020 2020 2020 2020 2020 2020 2320 7265              # re
+00039470: 7370 2069 733a 206d 6573 7361 6765 3d22  sp is: message="
+00039480: 496e 7661 6c69 6420 7573 6572 6e61 6d65  Invalid username
+00039490: 206f 7220 7061 7373 776f 7264 222c 2063   or password", c
+000394a0: 6f64 653d 4d5f 464f 5242 4944 4445 4e0a  ode=M_FORBIDDEN.
+000394b0: 2020 2020 2020 2020 2020 2020 7478 7420              txt 
+000394c0: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+000394d0: 2020 2020 2245 3233 343a 2022 0a20 2020      "E234: ".   
+000394e0: 2020 2020 2020 2020 2020 2020 2022 4c6f               "Lo
+000394f0: 6720 696e 2066 6169 6c65 642e 2022 0a20  g in failed. ". 
+00039500: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00039510: 4d6f 7374 206c 696b 656c 7920 7772 6f6e  Most likely wron
+00039520: 6720 6372 6564 656e 7469 616c 7320 7765  g credentials we
+00039530: 7265 2065 6e74 6572 6564 2e20 220a 2020  re entered. ".  
+00039540: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00039550: 686f 6d65 7365 7276 6572 3d27 7b68 6f6d  homeserver='{hom
+00039560: 6573 6572 7665 727d 273b 2064 6576 6963  eserver}'; devic
+00039570: 6520 6e61 6d65 3d27 7b64 6576 6963 655f  e name='{device_
+00039580: 6e61 6d65 7d27 3b20 220a 2020 2020 2020  name}'; ".      
+00039590: 2020 2020 2020 2020 2020 6622 7573 6572            f"user
+000395a0: 3d27 7b75 7365 725f 6964 7d27 3b20 726f  ='{user_id}'; ro
+000395b0: 6f6d 5f69 643d 277b 726f 6f6d 5f69 647d  om_id='{room_id}
+000395c0: 272e 2022 0a20 2020 2020 2020 2020 2020  '. ".           
+000395d0: 2020 2020 2066 2246 6169 6c65 6420 746f       f"Failed to
+000395e0: 206c 6f67 2069 6e3a 207b 7265 7370 2e6d   log in: {resp.m
+000395f0: 6573 7361 6765 7d2c 207b 7374 7228 7265  essage}, {str(re
+00039600: 7370 2e73 7461 7475 735f 636f 6465 297d  sp.status_code)}
+00039610: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+00039620: 2020 2020 2020 2020 2020 2020 6773 2e65              gs.e
+00039630: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
+00039640: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00039650: 4d61 7472 6978 436f 6d6d 616e 6465 7245  MatrixCommanderE
+00039660: 7272 6f72 2874 7874 290a 2020 2020 6578  rror(txt).    ex
+00039670: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
+00039680: 7320 653a 0a20 2020 2020 2020 2074 7874  s e:.        txt
+00039690: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+000396a0: 2022 4532 3335 3a20 220a 2020 2020 2020   "E235: ".      
+000396b0: 2020 2020 2020 224c 6f67 2069 6e20 6661        "Log in fa
+000396c0: 696c 6564 2e20 536f 7272 792e 220a 2020  iled. Sorry.".  
+000396d0: 2020 2020 2020 2020 2020 6622 686f 6d65            f"home
+000396e0: 7365 7276 6572 3d27 7b68 6f6d 6573 6572  server='{homeser
+000396f0: 7665 727d 273b 2064 6576 6963 6520 6e61  ver}'; device na
+00039700: 6d65 3d27 7b64 6576 6963 655f 6e61 6d65  me='{device_name
+00039710: 7d27 3b20 220a 2020 2020 2020 2020 2020  }'; ".          
+00039720: 2020 6622 7573 6572 3d27 7b75 7365 725f    f"user='{user_
+00039730: 6964 7d27 3b20 726f 6f6d 5f69 643d 277b  id}'; room_id='{
+00039740: 726f 6f6d 5f69 647d 272e 2022 0a20 2020  room_id}'. ".   
+00039750: 2020 2020 2020 2020 2066 2246 6169 6c65           f"Faile
+00039760: 6420 746f 206c 6f67 2069 6e3a 207b 657d  d to log in: {e}
+00039770: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
+00039780: 2020 2020 2320 6773 2e65 7272 5f63 6f75      # gs.err_cou
+00039790: 6e74 202b 3d20 3120 2023 2064 6f6e 2774  nt += 1  # don't
+000397a0: 2069 6e63 7265 6d65 6e74 2073 696e 6365   increment since
+000397b0: 206e 6f74 204d 6174 7269 7843 6f6d 6d61   not MatrixComma
+000397c0: 6e64 6572 4572 726f 720a 2020 2020 2020  nderError.      
+000397d0: 2020 7261 6973 650a 2020 2020 2320 7765    raise.    # we
+000397e0: 2061 7265 206e 6f77 2061 7574 6865 6e74   are now authent
+000397f0: 6963 6174 6564 2c20 7765 2061 7265 206e  icated, we are n
+00039800: 6f77 206c 6f67 6765 6420 696e 0a20 2020  ow logged in.   
+00039810: 2023 2067 7320 6e6f 7720 6861 7320 636c   # gs now has cl
+00039820: 6965 6e74 2061 6e64 2063 7265 6465 6e74  ient and credent
+00039830: 6961 6c73 2c20 6e65 6564 6564 2062 7920  ials, needed by 
+00039840: 6675 7274 6865 7220 6163 7469 6f6e 730a  further actions.
+00039850: 0a0a 6173 796e 6320 6465 6620 696d 706c  ..async def impl
+00039860: 6963 6974 5f6c 6f67 696e 2829 202d 3e20  icit_login() -> 
+00039870: 4e6f 6e65 3a0a 2020 2020 2222 224c 6f67  None:.    """Log
+00039880: 2069 6e20 7573 696e 6720 6372 6564 656e   in using creden
+00039890: 7469 616c 7320 6669 6c65 2061 6e64 2072  tials file and r
+000398a0: 656d 6169 6e20 6c6f 6767 6564 2069 6e2e  emain logged in.
+000398b0: 2222 220a 2020 2020 636c 6965 6e74 2c20  """.    client, 
+000398c0: 6372 6564 656e 7469 616c 7320 3d20 6177  credentials = aw
+000398d0: 6169 7420 6c6f 6769 6e5f 7573 696e 675f  ait login_using_
+000398e0: 6372 6564 656e 7469 616c 735f 6669 6c65  credentials_file
+000398f0: 2829 0a20 2020 2067 732e 636c 6965 6e74  ().    gs.client
+00039900: 203d 2063 6c69 656e 740a 2020 2020 6773   = client.    gs
+00039910: 2e63 7265 6465 6e74 6961 6c73 203d 2063  .credentials = c
+00039920: 7265 6465 6e74 6961 6c73 0a0a 0a64 6566  redentials...def
+00039930: 2072 6f6f 6d73 5f74 6f5f 6c6f 6e67 5f72   rooms_to_long_r
+00039940: 6f6f 6d5f 6e61 6d65 7328 2920 2d3e 204e  oom_names() -> N
+00039950: 6f6e 653a 0a20 2020 2022 2222 436f 6e76  one:.    """Conv
+00039960: 6572 7420 666f 6f20 746f 2023 666f 6f3a  ert foo to #foo:
+00039970: 6578 616d 706c 652e 636f 6d20 696e 2067  example.com in g
+00039980: 732e 7061 2e72 6f6f 6d20 7768 6572 6520  s.pa.room where 
+00039990: 6e65 6365 7373 6172 792e 2222 220a 2020  necessary.""".  
+000399a0: 2020 6966 2067 732e 7061 2e72 6f6f 6d3a    if gs.pa.room:
+000399b0: 0a20 2020 2020 2020 206c 6f6e 675f 726f  .        long_ro
+000399c0: 6f6d 7320 3d20 5b5d 0a20 2020 2020 2020  oms = [].       
+000399d0: 2066 6f72 2072 6f6f 6d20 696e 2067 732e   for room in gs.
+000399e0: 7061 2e72 6f6f 6d3a 0a20 2020 2020 2020  pa.room:.       
+000399f0: 2020 2020 2069 6620 6973 5f73 686f 7274       if is_short
+00039a00: 5f72 6f6f 6d5f 616c 6961 7328 726f 6f6d  _room_alias(room
+00039a10: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00039a20: 2020 206c 6f6e 675f 726f 6f6d 732e 6170     long_rooms.ap
+00039a30: 7065 6e64 280a 2020 2020 2020 2020 2020  pend(.          
+00039a40: 2020 2020 2020 2020 2020 7368 6f72 745f            short_
+00039a50: 726f 6f6d 5f61 6c69 6173 5f74 6f5f 726f  room_alias_to_ro
+00039a60: 6f6d 5f61 6c69 6173 2872 6f6f 6d2c 2067  om_alias(room, g
+00039a70: 732e 6372 6564 656e 7469 616c 7329 0a20  s.credentials). 
+00039a80: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00039a90: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00039aa0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00039ab0: 2020 206c 6f6e 675f 726f 6f6d 732e 6170     long_rooms.ap
+00039ac0: 7065 6e64 2872 6f6f 6d29 0a20 2020 2020  pend(room).     
+00039ad0: 2020 2067 732e 7061 2e72 6f6f 6d20 3d20     gs.pa.room = 
+00039ae0: 6c6f 6e67 5f72 6f6f 6d73 0a0a 0a61 7379  long_rooms...asy
+00039af0: 6e63 2064 6566 2061 7379 6e63 5f6d 6169  nc def async_mai
+00039b00: 6e28 2920 2d3e 204e 6f6e 653a 0a20 2020  n() -> None:.   
+00039b10: 2022 2222 5275 6e20 6d61 696e 2066 756e   """Run main fun
+00039b20: 6374 696f 6e73 2062 6569 6e67 2069 6e73  ctions being ins
+00039b30: 6964 6520 7468 6520 6576 656e 7420 6c6f  ide the event lo
+00039b40: 6f70 2e22 2222 0a20 2020 2023 206c 6f67  op.""".    # log
+00039b50: 696e 2065 7870 6c69 6369 746c 790a 2020  in explicitly.  
+00039b60: 2020 2320 6c6f 6769 6e20 696d 706c 6963    # login implic
+00039b70: 6974 6c79 0a20 2020 2023 2076 6572 6966  itly.    # verif
+00039b80: 790a 2020 2020 2320 7365 742c 2067 6574  y.    # set, get
+00039b90: 2c20 726f 6f6d 2c0a 2020 2020 2320 7365  , room,.    # se
+00039ba0: 6e64 0a20 2020 2023 206c 6973 7465 6e0a  nd.    # listen.
+00039bb0: 2020 2020 2320 6c6f 676f 7574 0a20 2020      # logout.   
+00039bc0: 2023 2063 6c6f 7365 2063 6c69 656e 740a   # close client.
+00039bd0: 2020 2020 2320 7379 732e 6172 6776 206f      # sys.argv o
+00039be0: 7264 6572 696e 673f 2023 2074 6f64 6f0a  rdering? # todo.
+00039bf0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00039c00: 2069 6620 6773 2e70 612e 6c6f 6769 6e3a   if gs.pa.login:
+00039c10: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+00039c20: 6974 2061 6374 696f 6e5f 6c6f 6769 6e28  it action_login(
+00039c30: 2920 2023 2065 7870 6c69 6369 7420 6c6f  )  # explicit lo
+00039c40: 6769 6e0a 2020 2020 2020 2020 656c 7365  gin.        else
 00039c50: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
-00039c60: 6169 7420 6163 7469 6f6e 5f72 6f6f 6d73  ait action_rooms
-00039c70: 6574 6765 7428 290a 2020 2020 2020 2020  etget().        
-00039c80: 6966 2067 732e 7365 6e64 5f61 6374 696f  if gs.send_actio
-00039c90: 6e3a 0a20 2020 2020 2020 2020 2020 2061  n:.            a
-00039ca0: 7761 6974 2061 6374 696f 6e5f 7365 6e64  wait action_send
-00039cb0: 2829 0a20 2020 2020 2020 2069 6620 6773  ().        if gs
-00039cc0: 2e6c 6973 7465 6e5f 6163 7469 6f6e 3a0a  .listen_action:.
-00039cd0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00039ce0: 7420 6163 7469 6f6e 5f6c 6973 7465 6e28  t action_listen(
-00039cf0: 290a 2020 2020 2020 2020 6966 2067 732e  ).        if gs.
-00039d00: 7061 2e6c 6f67 6f75 743a 0a20 2020 2020  pa.logout:.     
-00039d10: 2020 2020 2020 2061 7761 6974 2061 6374         await act
-00039d20: 696f 6e5f 6c6f 676f 7574 2829 0a20 2020  ion_logout().   
-00039d30: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-00039d40: 6e3a 0a20 2020 2020 2020 2072 6169 7365  n:.        raise
-00039d50: 0a20 2020 2066 696e 616c 6c79 3a0a 2020  .    finally:.  
-00039d60: 2020 2020 2020 6966 2067 732e 636c 6965        if gs.clie
-00039d70: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
-00039d80: 6177 6169 7420 6773 2e63 6c69 656e 742e  await gs.client.
-00039d90: 636c 6f73 6528 290a 0a0a 6465 6620 6368  close()...def ch
-00039da0: 6563 6b5f 6172 675f 6669 6c65 735f 7265  eck_arg_files_re
-00039db0: 6164 6162 6c65 2829 202d 3e20 4e6f 6e65  adable() -> None
-00039dc0: 3a0a 2020 2020 2222 2243 6865 636b 2069  :.    """Check i
-00039dd0: 6620 6669 6c65 7320 6672 6f6d 2063 6f6d  f files from com
-00039de0: 6d61 6e64 206c 696e 6520 6172 6520 7265  mand line are re
-00039df0: 6164 6162 6c65 2e22 2222 0a20 2020 2061  adable.""".    a
-00039e00: 7267 5f66 696c 6573 203d 2067 732e 7061  rg_files = gs.pa
-00039e10: 2e69 6d61 6765 2069 6620 6773 2e70 612e  .image if gs.pa.
-00039e20: 696d 6167 6520 656c 7365 205b 5d0a 2020  image else [].  
-00039e30: 2020 6172 675f 6669 6c65 7320 2b3d 2067    arg_files += g
-00039e40: 732e 7061 2e61 7564 696f 2069 6620 6773  s.pa.audio if gs
-00039e50: 2e70 612e 6175 6469 6f20 656c 7365 205b  .pa.audio else [
-00039e60: 5d0a 2020 2020 6172 675f 6669 6c65 7320  ].    arg_files 
-00039e70: 2b3d 2067 732e 7061 2e66 696c 6520 6966  += gs.pa.file if
-00039e80: 2067 732e 7061 2e66 696c 6520 656c 7365   gs.pa.file else
-00039e90: 205b 5d0a 2020 2020 6172 675f 6669 6c65   [].    arg_file
-00039ea0: 7320 2b3d 2067 732e 7061 2e65 7665 6e74  s += gs.pa.event
-00039eb0: 2069 6620 6773 2e70 612e 6576 656e 7420   if gs.pa.event 
-00039ec0: 656c 7365 205b 5d0a 2020 2020 7220 3d20  else [].    r = 
-00039ed0: 5472 7565 0a20 2020 2065 7272 7478 7420  True.    errtxt 
-00039ee0: 3d20 280a 2020 2020 2020 2020 2245 3233  = (.        "E23
-00039ef0: 363a 2022 0a20 2020 2020 2020 2022 5468  6: ".        "Th
-00039f00: 6573 6520 6669 6c65 7320 7370 6563 6966  ese files specif
-00039f10: 6965 6420 696e 2074 6865 2063 6f6d 6d61  ied in the comma
-00039f20: 6e64 206c 696e 6520 7765 7265 206e 6f74  nd line were not
-00039f30: 2066 6f75 6e64 2022 0a20 2020 2020 2020   found ".       
-00039f40: 2022 6f72 2061 7265 206e 6f74 2072 6561   "or are not rea
-00039f50: 6461 626c 653a 2022 0a20 2020 2029 0a20  dable: ".    ). 
-00039f60: 2020 2066 6f72 2066 6e20 696e 2061 7267     for fn in arg
-00039f70: 5f66 696c 6573 3a0a 2020 2020 2020 2020  _files:.        
-00039f80: 6966 2028 666e 2021 3d20 222d 2229 2061  if (fn != "-") a
-00039f90: 6e64 206e 6f74 2028 6973 6669 6c65 2866  nd not (isfile(f
-00039fa0: 6e29 2061 6e64 2061 6363 6573 7328 666e  n) and access(fn
-00039fb0: 2c20 525f 4f4b 2929 3a0a 2020 2020 2020  , R_OK)):.      
-00039fc0: 2020 2020 2020 6966 206e 6f74 2072 3a0a        if not r:.
-00039fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039fe0: 6572 7274 7874 202b 3d20 222c 2022 0a20  errtxt += ", ". 
-00039ff0: 2020 2020 2020 2020 2020 2065 7272 7478             errtx
-0003a000: 7420 2b3d 2066 2722 7b66 6e7d 2227 0a20  t += f'"{fn}"'. 
-0003a010: 2020 2020 2020 2020 2020 2072 203d 2046             r = F
-0003a020: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
-0003a030: 2065 7272 6669 6c65 203d 2066 6e0a 2020   errfile = fn.  
-0003a040: 2020 6966 206e 6f74 2072 3a0a 2020 2020    if not r:.    
-0003a050: 2020 2020 7261 6973 6520 4669 6c65 4e6f      raise FileNo
-0003a060: 7446 6f75 6e64 4572 726f 7228 6572 726e  tFoundError(errn
-0003a070: 6f2e 454e 4f45 4e54 2c20 6572 7274 7874  o.ENOENT, errtxt
-0003a080: 2c20 6572 7266 696c 6529 0a0a 0a64 6566  , errfile)...def
-0003a090: 2063 6865 636b 5f64 6f77 6e6c 6f61 645f   check_download_
-0003a0a0: 6d65 6469 615f 6469 7228 2920 2d3e 204e  media_dir() -> N
-0003a0b0: 6f6e 653a 0a20 2020 2022 2222 4368 6563  one:.    """Chec
-0003a0c0: 6b20 6966 206d 6564 6961 2064 6f77 6e6c  k if media downl
-0003a0d0: 6f61 6420 6469 7265 6374 6f72 7920 6973  oad directory is
-0003a0e0: 2063 6f72 7265 6374 2e22 2222 0a20 2020   correct.""".   
-0003a0f0: 2069 6620 6e6f 7420 6773 2e70 612e 646f   if not gs.pa.do
-0003a100: 776e 6c6f 6164 5f6d 6564 6961 3a0a 2020  wnload_media:.  
-0003a110: 2020 2020 2020 7265 7475 726e 2020 2320        return  # 
-0003a120: 2222 3a20 7468 6174 206d 6561 6e73 206e  "": that means n
-0003a130: 6f20 646f 776e 6c6f 6164 206f 6620 6d65  o download of me
-0003a140: 6469 612c 2076 616c 6964 2076 616c 7565  dia, valid value
-0003a150: 0a20 2020 2023 206e 6f72 6d61 696c 7a65  .    # normailze
-0003a160: 6420 666f 7220 6875 6d61 6e73 0a20 2020  d for humans.   
-0003a170: 2064 6c20 3d20 6f73 2e70 6174 682e 6e6f   dl = os.path.no
-0003a180: 726d 7061 7468 2867 732e 7061 2e64 6f77  rmpath(gs.pa.dow
-0003a190: 6e6c 6f61 645f 6d65 6469 6129 0a20 2020  nload_media).   
-0003a1a0: 2067 732e 7061 2e64 6f77 6e6c 6f61 645f   gs.pa.download_
-0003a1b0: 6d65 6469 6120 3d20 646c 0a20 2020 2069  media = dl.    i
-0003a1c0: 6620 6f73 2e70 6174 682e 6973 6669 6c65  f os.path.isfile
-0003a1d0: 2864 6c29 3a0a 2020 2020 2020 2020 7261  (dl):.        ra
-0003a1e0: 6973 6520 4e6f 7441 4469 7265 6374 6f72  ise NotADirector
-0003a1f0: 7945 7272 6f72 280a 2020 2020 2020 2020  yError(.        
-0003a200: 2020 2020 6572 726e 6f2e 454e 4f54 4449      errno.ENOTDI
-0003a210: 522c 0a20 2020 2020 2020 2020 2020 2022  R,.            "
-0003a220: 4532 3337 3a20 220a 2020 2020 2020 2020  E237: ".        
-0003a230: 2020 2020 6627 227b 646c 7d22 2063 616e      f'"{dl}" can
-0003a240: 6e6f 7420 6265 2075 7365 6420 6173 206d  not be used as m
-0003a250: 6564 6961 2064 6972 6563 746f 7279 2c20  edia directory, 
-0003a260: 6265 6361 7573 6520 270a 2020 2020 2020  because '.      
-0003a270: 2020 2020 2020 6627 227b 646c 7d22 2069        f'"{dl}" i
-0003a280: 7320 6120 6669 6c65 2e20 5370 6563 6966  s a file. Specif
-0003a290: 7920 6120 6469 6666 6572 656e 7420 6469  y a different di
-0003a2a0: 7265 6374 6f72 7920 666f 7220 646f 776e  rectory for down
-0003a2b0: 6c6f 6164 696e 6720 270a 2020 2020 2020  loading '.      
-0003a2c0: 2020 2020 2020 226d 6564 6961 2e22 2c0a        "media.",.
-0003a2d0: 2020 2020 2020 2020 2020 2020 646c 2c0a              dl,.
-0003a2e0: 2020 2020 2020 2020 290a 2020 2020 6966          ).    if
-0003a2f0: 206f 732e 7061 7468 2e69 7364 6972 2864   os.path.isdir(d
-0003a300: 6c29 3a0a 2020 2020 2020 2020 6966 206f  l):.        if o
-0003a310: 732e 6163 6365 7373 2864 6c2c 206f 732e  s.access(dl, os.
-0003a320: 575f 4f4b 293a 2020 2320 4368 6563 6b20  W_OK):  # Check 
-0003a330: 666f 7220 7772 6974 6520 6163 6365 7373  for write access
-0003a340: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0003a350: 7572 6e20 2023 2061 6c6c 204f 4b0a 2020  urn  # all OK.  
-0003a360: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0003a370: 2020 2020 2020 2020 7261 6973 6520 5065          raise Pe
-0003a380: 726d 6973 7369 6f6e 4572 726f 7228 0a20  rmissionError(. 
-0003a390: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0003a3a0: 7272 6e6f 2e45 5045 524d 2c0a 2020 2020  rrno.EPERM,.    
-0003a3b0: 2020 2020 2020 2020 2020 2020 2245 3233              "E23
-0003a3c0: 383a 2022 0a20 2020 2020 2020 2020 2020  8: ".           
-0003a3d0: 2020 2020 2022 466f 756e 6420 616e 2065       "Found an e
-0003a3e0: 7869 7374 696e 6720 6d65 6469 6120 646f  xisting media do
-0003a3f0: 776e 6c6f 6164 2064 6972 6563 746f 7279  wnload directory
-0003a400: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-0003a410: 2020 2066 2722 7b64 6c7d 222e 2042 7574     f'"{dl}". But
-0003a420: 2074 6869 7320 6469 7265 6374 6f72 7920   this directory 
-0003a430: 6973 206c 6163 6b69 6e67 2077 7269 7465  is lacking write
-0003a440: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0003a450: 2020 2022 7065 726d 6973 7369 6f6e 732e     "permissions.
-0003a460: 2041 6464 2077 7269 7465 2070 6572 6d69   Add write permi
-0003a470: 7373 696f 6e73 2074 6f20 6974 2e22 2c0a  ssions to it.",.
-0003a480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a490: 646c 2c0a 2020 2020 2020 2020 2020 2020  dl,.            
-0003a4a0: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
-0003a4b0: 2020 2020 2320 6e6f 7420 6120 6669 6c65      # not a file
-0003a4c0: 2c20 6e6f 7420 6120 6469 7265 6374 6f72  , not a director
-0003a4d0: 792c 2063 7265 6174 6520 6469 7265 6374  y, create direct
-0003a4e0: 6f72 790a 2020 2020 2020 2020 6d6f 6465  ory.        mode
-0003a4f0: 203d 2030 6f37 3737 0a20 2020 2020 2020   = 0o777.       
-0003a500: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0003a510: 2020 6f73 2e6d 6b64 6972 2864 6c2c 206d    os.mkdir(dl, m
-0003a520: 6f64 6529 0a20 2020 2020 2020 2065 7863  ode).        exc
-0003a530: 6570 7420 4f53 4572 726f 7220 6173 2065  ept OSError as e
-0003a540: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0003a550: 6973 6520 4f53 4572 726f 7228 0a20 2020  ise OSError(.   
-0003a560: 2020 2020 2020 2020 2020 2020 2065 2e65               e.e
-0003a570: 7272 6e6f 2c0a 2020 2020 2020 2020 2020  rrno,.          
-0003a580: 2020 2020 2020 2245 3233 393a 2022 0a20        "E239: ". 
-0003a590: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0003a5a0: 436f 756c 6420 6e6f 7420 6372 6561 7465  Could not create
-0003a5b0: 206d 6564 6961 2064 6f77 6e6c 6f61 6420   media download 
-0003a5c0: 6469 7265 6374 6f72 7920 220a 2020 2020  directory ".    
-0003a5d0: 2020 2020 2020 2020 2020 2020 6622 7b64              f"{d
-0003a5e0: 6c7d 2066 6f72 2079 6f75 2e20 287b 657d  l} for you. ({e}
-0003a5f0: 2922 2c0a 2020 2020 2020 2020 2020 2020  )",.            
-0003a600: 2020 2020 646c 2c0a 2020 2020 2020 2020      dl,.        
-0003a610: 2020 2020 290a 2020 2020 2020 2020 6773      ).        gs
-0003a620: 2e6c 6f67 2e64 6562 7567 2866 2743 7265  .log.debug(f'Cre
-0003a630: 6174 6564 206d 6564 6961 2064 6f77 6e6c  ated media downl
-0003a640: 6f61 6420 6469 7265 6374 6f72 7920 227b  oad directory "{
-0003a650: 646c 7d22 2066 6f72 2079 6f75 2e27 290a  dl}" for you.').
-0003a660: 0a0a 6465 6620 6368 6563 6b5f 7665 7273  ..def check_vers
-0003a670: 696f 6e28 2920 2d3e 204e 6f6e 653a 0a20  ion() -> None:. 
-0003a680: 2020 2022 2222 4368 6563 6b20 6966 206c     """Check if l
-0003a690: 6174 6573 7420 7665 7273 696f 6e2e 2222  atest version.""
-0003a6a0: 220a 2020 2020 706b 6720 3d20 5052 4f47  ".    pkg = PROG
-0003a6b0: 5f57 4954 484f 5554 5f45 5854 0a20 2020  _WITHOUT_EXT.   
-0003a6c0: 2076 6572 203d 2056 4552 5349 4f4e 4e52   ver = VERSIONNR
-0003a6d0: 2020 2320 6465 6661 756c 742c 2066 616c    # default, fal
-0003a6e0: 6c62 6163 6b0a 2020 2020 7472 793a 0a20  lback.    try:. 
-0003a6f0: 2020 2020 2020 2076 6572 203d 2070 6b67         ver = pkg
-0003a700: 5f72 6573 6f75 7263 6573 2e67 6574 5f64  _resources.get_d
-0003a710: 6973 7472 6962 7574 696f 6e28 706b 6729  istribution(pkg)
-0003a720: 2e76 6572 7369 6f6e 0a20 2020 2065 7863  .version.    exc
-0003a730: 6570 7420 4578 6365 7074 696f 6e3a 0a20  ept Exception:. 
-0003a740: 2020 2020 2020 2070 6173 7320 2023 2069         pass  # i
-0003a750: 6620 696e 7374 616c 6c65 6420 7669 6120  f installed via 
-0003a760: 6769 7420 636c 6f6e 652c 2070 6163 6b61  git clone, packa
-0003a770: 6765 2077 696c 6c20 6e6f 7420 6578 6973  ge will not exis
-0003a780: 7473 0a0a 2020 2020 696e 7374 616c 6c65  ts..    installe
-0003a790: 645f 7665 7273 696f 6e20 3d20 4c6f 6f73  d_version = Loos
-0003a7a0: 6556 6572 7369 6f6e 2876 6572 290a 2020  eVersion(ver).  
-0003a7b0: 2020 2320 6665 7463 6820 7061 636b 6167    # fetch packag
-0003a7c0: 6520 6d65 7461 6461 7461 2066 726f 6d20  e metadata from 
-0003a7d0: 5079 5049 0a20 2020 2070 7970 695f 7572  PyPI.    pypi_ur
-0003a7e0: 6c20 3d20 6622 6874 7470 733a 2f2f 7079  l = f"https://py
-0003a7f0: 7069 2e6f 7267 2f70 7970 692f 7b70 6b67  pi.org/pypi/{pkg
-0003a800: 7d2f 6a73 6f6e 220a 2020 2020 7265 7370  }/json".    resp
-0003a810: 6f6e 7365 203d 2075 726c 6c69 622e 7265  onse = urllib.re
-0003a820: 7175 6573 742e 7572 6c6f 7065 6e28 7079  quest.urlopen(py
-0003a830: 7069 5f75 726c 292e 7265 6164 2829 2e64  pi_url).read().d
-0003a840: 6563 6f64 6528 290a 2020 2020 6c61 7465  ecode().    late
-0003a850: 7374 5f76 6572 7369 6f6e 203d 206d 6178  st_version = max
-0003a860: 280a 2020 2020 2020 2020 4c6f 6f73 6556  (.        LooseV
-0003a870: 6572 7369 6f6e 2873 2920 666f 7220 7320  ersion(s) for s 
-0003a880: 696e 206a 736f 6e2e 6c6f 6164 7328 7265  in json.loads(re
-0003a890: 7370 6f6e 7365 295b 2272 656c 6561 7365  sponse)["release
-0003a8a0: 7322 5d2e 6b65 7973 2829 0a20 2020 2029  s"].keys().    )
-0003a8b0: 0a20 2020 2069 6620 696e 7374 616c 6c65  .    if installe
-0003a8c0: 645f 7665 7273 696f 6e20 3e3d 206c 6174  d_version >= lat
-0003a8d0: 6573 745f 7665 7273 696f 6e3a 0a20 2020  est_version:.   
-0003a8e0: 2020 2020 2075 7464 203d 2022 596f 7520       utd = "You 
-0003a8f0: 6172 6520 7570 2d74 6f2d 6461 7465 2122  are up-to-date!"
-0003a900: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-0003a910: 2020 2075 7464 203d 2022 436f 6e73 6964     utd = "Consid
-0003a920: 6572 2075 7064 6174 696e 6721 220a 2020  er updating!".  
-0003a930: 2020 7665 7273 696f 6e5f 696e 666f 203d    version_info =
-0003a940: 2028 0a20 2020 2020 2020 2066 2270 6163   (.        f"pac
-0003a950: 6b61 6765 3a20 7b70 6b67 7d2c 2069 6e73  kage: {pkg}, ins
-0003a960: 7461 6c6c 6564 3a20 7b69 6e73 7461 6c6c  talled: {install
-0003a970: 6564 5f76 6572 7369 6f6e 7d2c 2022 0a20  ed_version}, ". 
-0003a980: 2020 2020 2020 2066 226c 6174 6573 743a         f"latest:
-0003a990: 207b 6c61 7465 7374 5f76 6572 7369 6f6e   {latest_version
-0003a9a0: 7d20 3d3d 3e20 7b75 7464 7d22 0a20 2020  } ==> {utd}".   
-0003a9b0: 2029 0a20 2020 2067 732e 6c6f 672e 6465   ).    gs.log.de
-0003a9c0: 6275 6728 7665 7273 696f 6e5f 696e 666f  bug(version_info
-0003a9d0: 290a 2020 2020 2320 6f75 7470 7574 2066  ).    # output f
-0003a9e0: 6f72 6d61 7420 636f 6e74 726f 6c6c 6564  ormat controlled
-0003a9f0: 2076 6961 202d 2d6f 7574 7075 7420 666c   via --output fl
-0003aa00: 6167 0a20 2020 2074 6578 7420 3d20 7665  ag.    text = ve
-0003aa10: 7273 696f 6e5f 696e 666f 0a20 2020 206a  rsion_info.    j
-0003aa20: 736f 6e5f 6d61 7820 3d20 7b0a 2020 2020  son_max = {.    
-0003aa30: 2020 2020 2270 6163 6b61 6765 223a 2066      "package": f
-0003aa40: 227b 706b 677d 222c 0a20 2020 2020 2020  "{pkg}",.       
-0003aa50: 2022 7665 7273 696f 6e5f 696e 7374 616c   "version_instal
-0003aa60: 6c65 6422 3a20 6622 7b69 6e73 7461 6c6c  led": f"{install
-0003aa70: 6564 5f76 6572 7369 6f6e 7d22 2c0a 2020  ed_version}",.  
-0003aa80: 2020 2020 2020 2276 6572 7369 6f6e 5f6c        "version_l
-0003aa90: 6174 6573 7422 3a20 6622 7b6c 6174 6573  atest": f"{lates
-0003aaa0: 745f 7665 7273 696f 6e7d 222c 0a20 2020  t_version}",.   
-0003aab0: 2020 2020 2022 636f 6d6d 656e 7422 3a20       "comment": 
-0003aac0: 6622 7b75 7464 7d22 2c0a 2020 2020 7d0a  f"{utd}",.    }.
-0003aad0: 2020 2020 2320 6a73 6f6e 5f6d 6178 2e75      # json_max.u
-0003aae0: 7064 6174 6528 7b22 6b65 7922 3a20 7661  pdate({"key": va
-0003aaf0: 6c75 657d 2920 2023 2061 6464 2064 6963  lue})  # add dic
-0003ab00: 7420 6974 656d 730a 2020 2020 6a73 6f6e  t items.    json
-0003ab10: 5f20 3d20 6a73 6f6e 5f6d 6178 2e63 6f70  _ = json_max.cop
-0003ab20: 7928 290a 2020 2020 2320 6a73 6f6e 5f2e  y().    # json_.
-0003ab30: 706f 7028 226b 6579 2229 0a20 2020 206a  pop("key").    j
-0003ab40: 736f 6e5f 7370 6563 203d 204e 6f6e 650a  son_spec = None.
-0003ab50: 2020 2020 7072 696e 745f 6f75 7470 7574      print_output
-0003ab60: 280a 2020 2020 2020 2020 6773 2e70 612e  (.        gs.pa.
-0003ab70: 6f75 7470 7574 2c0a 2020 2020 2020 2020  output,.        
-0003ab80: 7465 7874 3d74 6578 742c 0a20 2020 2020  text=text,.     
-0003ab90: 2020 206a 736f 6e5f 3d6a 736f 6e5f 2c0a     json_=json_,.
-0003aba0: 2020 2020 2020 2020 6a73 6f6e 5f6d 6178          json_max
-0003abb0: 3d6a 736f 6e5f 6d61 782c 0a20 2020 2020  =json_max,.     
-0003abc0: 2020 206a 736f 6e5f 7370 6563 3d6a 736f     json_spec=jso
-0003abd0: 6e5f 7370 6563 2c0a 2020 2020 290a 0a0a  n_spec,.    )...
-0003abe0: 6465 6620 7665 7273 696f 6e28 2920 2d3e  def version() ->
-0003abf0: 204e 6f6e 653a 0a20 2020 2022 2222 5072   None:.    """Pr
-0003ac00: 696e 7420 7665 7273 696f 6e20 696e 666f  int version info
-0003ac10: 2e22 2222 0a20 2020 206e 696f 5f76 6572  .""".    nio_ver
-0003ac20: 7369 6f6e 203d 2070 6b67 5f72 6573 6f75  sion = pkg_resou
-0003ac30: 7263 6573 2e67 6574 5f64 6973 7472 6962  rces.get_distrib
-0003ac40: 7574 696f 6e28 226d 6174 7269 782d 6e69  ution("matrix-ni
-0003ac50: 6f22 292e 7665 7273 696f 6e0a 2020 2020  o").version.    
-0003ac60: 7079 7468 6f6e 5f76 6572 7369 6f6e 203d  python_version =
-0003ac70: 2073 7973 2e76 6572 7369 6f6e 0a20 2020   sys.version.   
-0003ac80: 2070 7974 686f 6e5f 7665 7273 696f 6e5f   python_version_
-0003ac90: 6e72 203d 2028 0a20 2020 2020 2020 2073  nr = (.        s
-0003aca0: 7472 2873 7973 2e76 6572 7369 6f6e 5f69  tr(sys.version_i
-0003acb0: 6e66 6f2e 6d61 6a6f 7229 0a20 2020 2020  nfo.major).     
-0003acc0: 2020 202b 2022 2e22 0a20 2020 2020 2020     + ".".       
-0003acd0: 202b 2073 7472 2873 7973 2e76 6572 7369   + str(sys.versi
-0003ace0: 6f6e 5f69 6e66 6f2e 6d69 6e6f 7229 0a20  on_info.minor). 
-0003acf0: 2020 2020 2020 202b 2022 2e22 0a20 2020         + ".".   
-0003ad00: 2020 2020 202b 2073 7472 2873 7973 2e76       + str(sys.v
-0003ad10: 6572 7369 6f6e 5f69 6e66 6f2e 6d69 6372  ersion_info.micr
-0003ad20: 6f29 0a20 2020 2029 0a20 2020 2076 6572  o).    ).    ver
-0003ad30: 7369 6f6e 5f69 6e66 6f20 3d20 280a 2020  sion_info = (.  
-0003ad40: 2020 2020 2020 225c 6e22 0a20 2020 2020        "\n".     
-0003ad50: 2020 2066 2220 205f 7c20 2020 2020 205f     f"  _|      _
-0003ad60: 7c20 2020 2020 205f 7c5f 7c5f 7c20 2020  |      _|_|_|   
-0003ad70: 205f 7c20 2020 2020 2020 7b50 524f 475f   _|       {PROG_
-0003ad80: 5749 5448 4f55 545f 4558 547d 3a20 220a  WITHOUT_EXT}: ".
-0003ad90: 2020 2020 2020 2020 6622 7b56 4552 5349          f"{VERSI
-0003ada0: 4f4e 4e52 7d20 7b56 4552 5349 4f4e 7d5c  ONNR} {VERSION}\
-0003adb0: 6e22 0a20 2020 2020 2020 2022 2020 5f7c  n".        "  _|
-0003adc0: 5f7c 2020 5f7c 5f7c 2020 2020 5f7c 2020  _|  _|_|    _|  
-0003add0: 2020 2020 2020 2020 2020 5f7c 2020 2020            _|    
-0003ade0: 2061 204d 6174 7269 7820 434c 4920 636c   a Matrix CLI cl
-0003adf0: 6965 6e74 5c6e 220a 2020 2020 2020 2020  ient\n".        
-0003ae00: 2220 205f 7c20 205f 7c20 205f 7c20 2020  "  _|  _|  _|   
-0003ae10: 205f 7c20 2020 2020 2020 2020 2020 2020   _|             
-0003ae20: 205f 7c20 2020 656e 6a6f 7920 616e 6420   _|   enjoy and 
-0003ae30: 7375 626d 6974 2050 5273 5c6e 220a 2020  submit PRs\n".  
-0003ae40: 2020 2020 2020 6622 2020 5f7c 2020 2020        f"  _|    
-0003ae50: 2020 5f7c 2020 2020 5f7c 2020 2020 2020    _|    _|      
-0003ae60: 2020 2020 2020 5f7c 2020 2020 206d 6174        _|     mat
-0003ae70: 7269 782d 6e69 6f3a 207b 6e69 6f5f 7665  rix-nio: {nio_ve
-0003ae80: 7273 696f 6e7d 5c6e 220a 2020 2020 2020  rsion}\n".      
-0003ae90: 2020 6622 2020 5f7c 2020 2020 2020 5f7c    f"  _|      _|
-0003aea0: 2020 2020 2020 5f7c 5f7c 5f7c 2020 2020        _|_|_|    
-0003aeb0: 5f7c 2020 2020 2020 2050 7974 686f 6e3a  _|       Python:
-0003aec0: 207b 7079 7468 6f6e 5f76 6572 7369 6f6e   {python_version
-0003aed0: 5f6e 727d 5c6e 220a 2020 2020 2020 2020  _nr}\n".        
-0003aee0: 225c 6e22 0a20 2020 2029 0a20 2020 2067  "\n".    ).    g
-0003aef0: 732e 6c6f 672e 6465 6275 6728 7665 7273  s.log.debug(vers
-0003af00: 696f 6e5f 696e 666f 290a 2020 2020 2320  ion_info).    # 
-0003af10: 6f75 7470 7574 2066 6f72 6d61 7420 636f  output format co
-0003af20: 6e74 726f 6c6c 6564 2076 6961 202d 2d6f  ntrolled via --o
-0003af30: 7574 7075 7420 666c 6167 0a20 2020 2074  utput flag.    t
-0003af40: 6578 7420 3d20 7665 7273 696f 6e5f 696e  ext = version_in
-0003af50: 666f 0a20 2020 206a 736f 6e5f 6d61 7820  fo.    json_max 
-0003af60: 3d20 7b0a 2020 2020 2020 2020 6622 7b50  = {.        f"{P
-0003af70: 524f 475f 5749 5448 4f55 545f 4558 547d  ROG_WITHOUT_EXT}
-0003af80: 223a 207b 0a20 2020 2020 2020 2020 2020  ": {.           
-0003af90: 2022 7665 7273 696f 6e22 3a20 6622 7b56   "version": f"{V
-0003afa0: 4552 5349 4f4e 4e52 7d22 2c0a 2020 2020  ERSIONNR}",.    
-0003afb0: 2020 2020 2020 2020 2264 6174 6522 3a20          "date": 
-0003afc0: 6622 7b56 4552 5349 4f4e 7d22 2c0a 2020  f"{VERSION}",.  
-0003afd0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-0003afe0: 2022 6d61 7472 6978 2d6e 696f 223a 207b   "matrix-nio": {
-0003aff0: 0a20 2020 2020 2020 2020 2020 2022 7665  .            "ve
-0003b000: 7273 696f 6e22 3a20 6622 7b6e 696f 5f76  rsion": f"{nio_v
-0003b010: 6572 7369 6f6e 7d22 2c0a 2020 2020 2020  ersion}",.      
-0003b020: 2020 7d2c 0a20 2020 2020 2020 2022 7079    },.        "py
-0003b030: 7468 6f6e 223a 207b 0a20 2020 2020 2020  thon": {.       
-0003b040: 2020 2020 2022 7665 7273 696f 6e22 3a20       "version": 
-0003b050: 6622 7b70 7974 686f 6e5f 7665 7273 696f  f"{python_versio
-0003b060: 6e5f 6e72 7d22 2c0a 2020 2020 2020 2020  n_nr}",.        
-0003b070: 2020 2020 2269 6e66 6f22 3a20 6622 7b70      "info": f"{p
-0003b080: 7974 686f 6e5f 7665 7273 696f 6e7d 222c  ython_version}",
-0003b090: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
-0003b0a0: 7d0a 2020 2020 2320 6a73 6f6e 5f6d 6178  }.    # json_max
-0003b0b0: 2e75 7064 6174 6528 7b22 6b65 7922 3a20  .update({"key": 
-0003b0c0: 7661 6c75 657d 2920 2023 2061 6464 2064  value})  # add d
-0003b0d0: 6963 7420 6974 656d 730a 2020 2020 6a73  ict items.    js
-0003b0e0: 6f6e 5f20 3d20 6a73 6f6e 5f6d 6178 2e63  on_ = json_max.c
-0003b0f0: 6f70 7928 290a 2020 2020 2320 6a73 6f6e  opy().    # json
-0003b100: 5f2e 706f 7028 226b 6579 2229 0a20 2020  _.pop("key").   
-0003b110: 206a 736f 6e5f 7370 6563 203d 204e 6f6e   json_spec = Non
-0003b120: 650a 2020 2020 7072 696e 745f 6f75 7470  e.    print_outp
-0003b130: 7574 280a 2020 2020 2020 2020 6773 2e70  ut(.        gs.p
-0003b140: 612e 6f75 7470 7574 2c0a 2020 2020 2020  a.output,.      
-0003b150: 2020 7465 7874 3d74 6578 742c 0a20 2020    text=text,.   
-0003b160: 2020 2020 206a 736f 6e5f 3d6a 736f 6e5f       json_=json_
-0003b170: 2c0a 2020 2020 2020 2020 6a73 6f6e 5f6d  ,.        json_m
-0003b180: 6178 3d6a 736f 6e5f 6d61 782c 0a20 2020  ax=json_max,.   
-0003b190: 2020 2020 206a 736f 6e5f 7370 6563 3d6a       json_spec=j
-0003b1a0: 736f 6e5f 7370 6563 2c0a 2020 2020 290a  son_spec,.    ).
-0003b1b0: 0a0a 6465 6620 696e 6974 6961 6c5f 6368  ..def initial_ch
-0003b1c0: 6563 6b5f 6f66 5f6c 6f67 5f61 7267 7328  eck_of_log_args(
-0003b1d0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2022  ) -> None:.    "
-0003b1e0: 2222 4368 6563 6b20 6c6f 6767 696e 6720  ""Check logging 
-0003b1f0: 7265 6c61 7465 6420 6172 6775 6d65 6e74  related argument
-0003b200: 732e 0a0a 2020 2020 4172 6775 6d65 6e74  s...    Argument
-0003b210: 733a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  s:.    ---------
-0003b220: 0a20 2020 204e 6f6e 650a 0a20 2020 2052  .    None..    R
-0003b230: 6574 7572 6e73 3a20 4e6f 6e65 0a0a 2020  eturns: None..  
-0003b240: 2020 5261 6973 6573 2065 7863 6570 7469    Raises excepti
-0003b250: 6f6e 206f 6e20 6572 726f 722e 0a20 2020  on on error..   
-0003b260: 2022 2222 0a20 2020 2069 6620 6e6f 7420   """.    if not 
-0003b270: 6773 2e70 612e 6c6f 675f 6c65 7665 6c3a  gs.pa.log_level:
-0003b280: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0003b290: 2023 2061 6c6c 204f 4b0a 2020 2020 666f   # all OK.    fo
-0003b2a0: 7220 6920 696e 2072 616e 6765 286c 656e  r i in range(len
-0003b2b0: 2867 732e 7061 2e6c 6f67 5f6c 6576 656c  (gs.pa.log_level
-0003b2c0: 2929 3a0a 2020 2020 2020 2020 7570 203d  )):.        up =
-0003b2d0: 2067 732e 7061 2e6c 6f67 5f6c 6576 656c   gs.pa.log_level
-0003b2e0: 5b69 5d2e 7570 7065 7228 290a 2020 2020  [i].upper().    
-0003b2f0: 2020 2020 6773 2e70 612e 6c6f 675f 6c65      gs.pa.log_le
-0003b300: 7665 6c5b 695d 203d 2075 700a 2020 2020  vel[i] = up.    
-0003b310: 2020 2020 6966 2075 7020 6e6f 7420 696e      if up not in
-0003b320: 205b 2244 4542 5547 222c 2022 494e 464f   ["DEBUG", "INFO
-0003b330: 222c 2022 5741 524e 494e 4722 2c20 2245  ", "WARNING", "E
-0003b340: 5252 4f52 222c 2022 4352 4954 4943 414c  RROR", "CRITICAL
-0003b350: 225d 3a0a 2020 2020 2020 2020 2020 2020  "]:.            
-0003b360: 2320 6773 2e65 7272 5f63 6f75 6e74 202b  # gs.err_count +
-0003b370: 3d20 3120 2023 2077 726f 6e67 0a20 2020  = 1  # wrong.   
-0003b380: 2020 2020 2020 2020 2072 6169 7365 204d           raise M
-0003b390: 6174 7269 7843 6f6d 6d61 6e64 6572 4572  atrixCommanderEr
-0003b3a0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-0003b3b0: 2020 2020 2022 4532 3431 3a20 220a 2020       "E241: ".  
-0003b3c0: 2020 2020 2020 2020 2020 2020 2020 272d                '-
-0003b3d0: 2d6c 6f67 2d6c 6576 656c 206f 6e6c 7920  -log-level only 
-0003b3e0: 616c 6c6f 7773 2076 616c 7565 7320 2244  allows values "D
-0003b3f0: 4542 5547 222c 2022 494e 464f 222c 2022  EBUG", "INFO", "
-0003b400: 5741 524e 494e 4722 2c20 270a 2020 2020  WARNING", '.    
-0003b410: 2020 2020 2020 2020 2020 2020 2722 4552              '"ER
-0003b420: 524f 5222 2c20 6f72 2022 4352 4954 4943  ROR", or "CRITIC
-0003b430: 414c 222e 202d 2d6c 6f67 2d6c 6576 656c  AL". --log-level
-0003b440: 2061 7267 756d 656e 7420 696e 636f 7272   argument incorr
-0003b450: 6563 742e 2027 0a20 2020 2020 2020 2020  ect. '.         
-0003b460: 2020 2020 2020 2066 2228 7b75 707d 2922         f"({up})"
-0003b470: 0a20 2020 2020 2020 2020 2020 2029 2066  .            ) f
-0003b480: 726f 6d20 4e6f 6e65 0a0a 0a23 2061 6363  rom None...# acc
-0003b490: 6f72 6469 6e67 2074 6f20 7079 6c61 6d61  ording to pylama
-0003b4a0: 3a20 6675 6e63 7469 6f6e 2074 6f6f 2063  : function too c
-0003b4b0: 6f6d 706c 6578 3a20 4339 3031 2023 206e  omplex: C901 # n
-0003b4c0: 6f71 613a 2043 3930 310a 6465 6620 696e  oqa: C901.def in
-0003b4d0: 6974 6961 6c5f 6368 6563 6b5f 6f66 5f61  itial_check_of_a
-0003b4e0: 7267 7328 2920 2d3e 204e 6f6e 653a 2020  rgs() -> None:  
-0003b4f0: 2320 6e6f 7161 3a20 4339 3031 0a20 2020  # noqa: C901.   
-0003b500: 2022 2222 4368 6563 6b20 6172 6775 6d65   """Check argume
-0003b510: 6e74 732e 2222 220a 2020 2020 2320 4669  nts.""".    # Fi
-0003b520: 7273 742c 2074 6865 2061 646a 7573 746d  rst, the adjustm
-0003b530: 656e 7473 0a20 2020 2069 6620 6e6f 7420  ents.    if not 
-0003b540: 6773 2e70 612e 656e 6372 7970 7465 643a  gs.pa.encrypted:
-0003b550: 0a20 2020 2020 2020 2067 732e 7061 2e65  .        gs.pa.e
-0003b560: 6e63 7279 7074 6564 203d 2054 7275 6520  ncrypted = True 
-0003b570: 2023 2066 6f72 6365 2069 7420 6f6e 0a20   # force it on. 
-0003b580: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-0003b590: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
-0003b5a0: 2022 456e 6372 7970 7469 6f6e 2069 7320   "Encryption is 
-0003b5b0: 616c 7761 7973 2065 6e61 626c 6564 2e20  always enabled. 
-0003b5c0: 4974 2063 616e 6e6f 7420 6265 2074 7572  It cannot be tur
-0003b5d0: 6e65 6420 6f66 662e 2022 0a20 2020 2020  ned off. ".     
-0003b5e0: 2020 2020 2020 2022 5573 6520 2d2d 7461         "Use --ta
-0003b5f0: 696c 2074 6f20 6469 7361 626c 6520 6974  il to disable it
-0003b600: 2066 6f72 2073 7065 6369 6669 6320 7573   for specific us
-0003b610: 6520 6361 7365 732e 220a 2020 2020 2020  e cases.".      
-0003b620: 2020 290a 2020 2020 6966 206e 6f74 2067    ).    if not g
-0003b630: 732e 7061 2e65 6e63 7279 7074 6564 3a20  s.pa.encrypted: 
-0003b640: 2023 206a 7573 7420 696e 2063 6173 6520   # just in case 
-0003b650: 7765 2065 7665 7220 676f 2062 6163 6b20  we ever go back 
-0003b660: 6469 7361 626c 696e 6720 6532 650a 2020  disabling e2e.  
-0003b670: 2020 2020 2020 6773 2e70 612e 7374 6f72        gs.pa.stor
-0003b680: 6520 3d20 4e6f 6e65 0a20 2020 2069 6620  e = None.    if 
-0003b690: 6773 2e70 612e 6c69 7374 656e 3a0a 2020  gs.pa.listen:.  
-0003b6a0: 2020 2020 2020 6773 2e70 612e 6c69 7374        gs.pa.list
-0003b6b0: 656e 203d 2067 732e 7061 2e6c 6973 7465  en = gs.pa.liste
-0003b6c0: 6e2e 6c6f 7765 7228 290a 2020 2020 6966  n.lower().    if
-0003b6d0: 2067 732e 7061 2e6c 6973 7465 6e20 3d3d   gs.pa.listen ==
-0003b6e0: 204e 4556 4552 2061 6e64 2067 732e 7061   NEVER and gs.pa
-0003b6f0: 2e74 6169 6c20 213d 2030 3a0a 2020 2020  .tail != 0:.    
-0003b700: 2020 2020 6773 2e70 612e 6c69 7374 656e      gs.pa.listen
-0003b710: 203d 2054 4149 4c20 2023 202d 2d74 6169   = TAIL  # --tai
-0003b720: 6c20 7475 726e 7320 6f6e 202d 2d6c 6973  l turns on --lis
-0003b730: 7465 6e20 5441 494c 0a20 2020 2020 2020  ten TAIL.       
-0003b740: 2067 732e 6c6f 672e 6465 6275 6728 272d   gs.log.debug('-
-0003b750: 2d6c 6973 7465 6e20 7365 7420 746f 2022  -listen set to "
-0003b760: 7461 696c 2220 6265 6361 7573 6520 222d  tail" because "-
-0003b770: 2d74 6169 6c22 2069 7320 7573 6564 2e27  -tail" is used.'
-0003b780: 290a 2020 2020 6966 2067 732e 7061 2e73  ).    if gs.pa.s
-0003b790: 796e 6320 6973 206e 6f74 204e 6f6e 653a  ync is not None:
-0003b7a0: 0a20 2020 2020 2020 2067 732e 7061 2e73  .        gs.pa.s
-0003b7b0: 796e 6320 3d20 6773 2e70 612e 7379 6e63  ync = gs.pa.sync
-0003b7c0: 2e6c 6f77 6572 2829 0a20 2020 2069 6620  .lower().    if 
-0003b7d0: 6773 2e70 612e 6f75 7470 7574 2069 7320  gs.pa.output is 
-0003b7e0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0003b7f0: 2020 6773 2e70 612e 6f75 7470 7574 203d    gs.pa.output =
-0003b800: 2067 732e 7061 2e6f 7574 7075 742e 6c6f   gs.pa.output.lo
-0003b810: 7765 7228 290a 0a20 2020 2069 6620 280a  wer()..    if (.
-0003b820: 2020 2020 2020 2020 6773 2e70 612e 6d65          gs.pa.me
-0003b830: 7373 6167 650a 2020 2020 2020 2020 6f72  ssage.        or
-0003b840: 2067 732e 7061 2e69 6d61 6765 0a20 2020   gs.pa.image.   
-0003b850: 2020 2020 206f 7220 6773 2e70 612e 6175       or gs.pa.au
-0003b860: 6469 6f0a 2020 2020 2020 2020 6f72 2067  dio.        or g
-0003b870: 732e 7061 2e66 696c 650a 2020 2020 2020  s.pa.file.      
-0003b880: 2020 6f72 2067 732e 7061 2e65 7665 6e74    or gs.pa.event
-0003b890: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
-0003b8a0: 6773 2e73 656e 645f 6163 7469 6f6e 203d  gs.send_action =
-0003b8b0: 2054 7275 650a 2020 2020 656c 7365 3a0a   True.    else:.
-0003b8c0: 2020 2020 2020 2020 6773 2e73 656e 645f          gs.send_
-0003b8d0: 6163 7469 6f6e 203d 2046 616c 7365 0a0a  action = False..
-0003b8e0: 2020 2020 6966 2067 732e 7061 2e6c 6973      if gs.pa.lis
-0003b8f0: 7465 6e20 696e 2028 464f 5245 5645 522c  ten in (FOREVER,
-0003b900: 204f 4e43 452c 2054 4149 4c2c 2041 4c4c   ONCE, TAIL, ALL
-0003b910: 293a 0a20 2020 2020 2020 2067 732e 6c69  ):.        gs.li
-0003b920: 7374 656e 5f61 6374 696f 6e20 3d20 5472  sten_action = Tr
-0003b930: 7565 0a20 2020 2065 6c73 653a 0a20 2020  ue.    else:.   
-0003b940: 2020 2020 2067 732e 6c69 7374 656e 5f61       gs.listen_a
-0003b950: 6374 696f 6e20 3d20 4661 6c73 650a 0a20  ction = False.. 
-0003b960: 2020 2069 6620 280a 2020 2020 2020 2020     if (.        
-0003b970: 2320 726f 6f6d 2073 6574 0a20 2020 2020  # room set.     
-0003b980: 2020 2067 732e 7061 2e72 6f6f 6d5f 6372     gs.pa.room_cr
-0003b990: 6561 7465 0a20 2020 2020 2020 206f 7220  eate.        or 
-0003b9a0: 6773 2e70 612e 726f 6f6d 5f64 6d5f 6372  gs.pa.room_dm_cr
-0003b9b0: 6561 7465 0a20 2020 2020 2020 206f 7220  eate.        or 
-0003b9c0: 6773 2e70 612e 726f 6f6d 5f6a 6f69 6e0a  gs.pa.room_join.
-0003b9d0: 2020 2020 2020 2020 6f72 2067 732e 7061          or gs.pa
-0003b9e0: 2e72 6f6f 6d5f 6c65 6176 650a 2020 2020  .room_leave.    
-0003b9f0: 2020 2020 6f72 2067 732e 7061 2e72 6f6f      or gs.pa.roo
-0003ba00: 6d5f 666f 7267 6574 0a20 2020 2020 2020  m_forget.       
-0003ba10: 206f 7220 6773 2e70 612e 726f 6f6d 5f69   or gs.pa.room_i
-0003ba20: 6e76 6974 650a 2020 2020 2020 2020 6f72  nvite.        or
-0003ba30: 2067 732e 7061 2e72 6f6f 6d5f 6261 6e0a   gs.pa.room_ban.
-0003ba40: 2020 2020 2020 2020 6f72 2067 732e 7061          or gs.pa
-0003ba50: 2e72 6f6f 6d5f 756e 6261 6e0a 2020 2020  .room_unban.    
-0003ba60: 2020 2020 6f72 2067 732e 7061 2e72 6f6f      or gs.pa.roo
-0003ba70: 6d5f 6b69 636b 0a20 2020 2020 2020 206f  m_kick.        o
-0003ba80: 7220 6773 2e70 612e 726f 6f6d 5f72 6564  r gs.pa.room_red
-0003ba90: 6163 740a 2020 2020 2020 2020 6f72 2067  act.        or g
-0003baa0: 732e 7061 2e72 6f6f 6d5f 7365 745f 616c  s.pa.room_set_al
-0003bab0: 6961 730a 2020 2020 2020 2020 6f72 2067  ias.        or g
-0003bac0: 732e 7061 2e72 6f6f 6d5f 6465 6c65 7465  s.pa.room_delete
-0003bad0: 5f61 6c69 6173 0a20 2020 2020 2020 2023  _alias.        #
-0003bae0: 2072 6f6f 6d20 6765 740a 2020 2020 2020   room get.      
-0003baf0: 2020 6f72 2067 732e 7061 2e72 6f6f 6d5f    or gs.pa.room_
-0003bb00: 6765 745f 7669 7369 6269 6c69 7479 2069  get_visibility i
-0003bb10: 7320 6e6f 7420 4e6f 6e65 2020 2320 656d  s not None  # em
-0003bb20: 7074 7920 6c69 7374 206d 7573 7420 696e  pty list must in
-0003bb30: 766f 6b65 2066 756e 630a 2020 2020 2020  voke func.      
-0003bb40: 2020 6f72 2067 732e 7061 2e72 6f6f 6d5f    or gs.pa.room_
-0003bb50: 6765 745f 7374 6174 6520 6973 206e 6f74  get_state is not
-0003bb60: 204e 6f6e 6520 2023 2065 6d70 7479 206c   None  # empty l
-0003bb70: 6973 7420 6d75 7374 2069 6e76 6f6b 6520  ist must invoke 
-0003bb80: 6675 6e63 0a20 2020 2020 2020 206f 7220  func.        or 
-0003bb90: 6773 2e70 612e 726f 6f6d 5f72 6573 6f6c  gs.pa.room_resol
-0003bba0: 7665 5f61 6c69 6173 0a20 2020 2029 3a0a  ve_alias.    ):.
-0003bbb0: 2020 2020 2020 2020 6773 2e72 6f6f 6d5f          gs.room_
-0003bbc0: 6163 7469 6f6e 203d 2054 7275 650a 2020  action = True.  
-0003bbd0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0003bbe0: 6773 2e72 6f6f 6d5f 6163 7469 6f6e 203d  gs.room_action =
-0003bbf0: 2046 616c 7365 0a0a 2020 2020 6966 2028   False..    if (
-0003bc00: 0a20 2020 2020 2020 2067 732e 7061 2e73  .        gs.pa.s
-0003bc10: 6574 5f64 6576 6963 655f 6e61 6d65 2020  et_device_name  
-0003bc20: 2320 7365 740a 2020 2020 2020 2020 6f72  # set.        or
-0003bc30: 2067 732e 7061 2e73 6574 5f64 6973 706c   gs.pa.set_displ
-0003bc40: 6179 5f6e 616d 650a 2020 2020 2020 2020  ay_name.        
-0003bc50: 6f72 2067 732e 7061 2e73 6574 5f70 7265  or gs.pa.set_pre
-0003bc60: 7365 6e63 650a 2020 2020 2020 2020 6f72  sence.        or
-0003bc70: 2067 732e 7061 2e75 706c 6f61 640a 2020   gs.pa.upload.  
-0003bc80: 2020 2020 2020 6f72 2067 732e 7061 2e64        or gs.pa.d
-0003bc90: 656c 6574 655f 6d78 630a 2020 2020 2020  elete_mxc.      
-0003bca0: 2020 6f72 2067 732e 7061 2e64 656c 6574    or gs.pa.delet
-0003bcb0: 655f 6d78 635f 6265 666f 7265 0a20 2020  e_mxc_before.   
-0003bcc0: 2020 2020 206f 7220 6773 2e70 612e 7265       or gs.pa.re
-0003bcd0: 7374 0a20 2020 2020 2020 206f 7220 6773  st.        or gs
-0003bce0: 2e70 612e 7365 745f 6176 6174 6172 0a20  .pa.set_avatar. 
-0003bcf0: 2020 2020 2020 206f 7220 6773 2e70 612e         or gs.pa.
-0003bd00: 696d 706f 7274 5f6b 6579 730a 2020 2020  import_keys.    
-0003bd10: 2020 2020 6f72 2067 732e 7061 2e64 656c      or gs.pa.del
-0003bd20: 6574 655f 6465 7669 6365 0a20 2020 2029  ete_device.    )
-0003bd30: 3a0a 2020 2020 2020 2020 6773 2e73 6574  :.        gs.set
-0003bd40: 5f61 6374 696f 6e20 3d20 5472 7565 0a20  _action = True. 
-0003bd50: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0003bd60: 2067 732e 7365 745f 6163 7469 6f6e 203d   gs.set_action =
-0003bd70: 2046 616c 7365 0a0a 2020 2020 6966 2028   False..    if (
-0003bd80: 0a20 2020 2020 2020 2067 732e 7061 2e67  .        gs.pa.g
-0003bd90: 6574 5f64 6973 706c 6179 5f6e 616d 6520  et_display_name 
-0003bda0: 2023 2067 6574 0a20 2020 2020 2020 206f   # get.        o
-0003bdb0: 7220 6773 2e70 612e 6765 745f 7072 6573  r gs.pa.get_pres
-0003bdc0: 656e 6365 0a20 2020 2020 2020 206f 7220  ence.        or 
-0003bdd0: 6773 2e70 612e 646f 776e 6c6f 6164 0a20  gs.pa.download. 
-0003bde0: 2020 2020 2020 206f 7220 6773 2e70 612e         or gs.pa.
-0003bdf0: 6a6f 696e 6564 5f72 6f6f 6d73 0a20 2020  joined_rooms.   
-0003be00: 2020 2020 206f 7220 6773 2e70 612e 6a6f       or gs.pa.jo
-0003be10: 696e 6564 5f6d 656d 6265 7273 0a20 2020  ined_members.   
-0003be20: 2020 2020 206f 7220 6773 2e70 612e 6d78       or gs.pa.mx
-0003be30: 635f 746f 5f68 7474 700a 2020 2020 2020  c_to_http.      
-0003be40: 2020 6f72 2067 732e 7061 2e64 6576 6963    or gs.pa.devic
-0003be50: 6573 0a20 2020 2020 2020 206f 7220 6773  es.        or gs
-0003be60: 2e70 612e 6469 7363 6f76 6572 795f 696e  .pa.discovery_in
-0003be70: 666f 0a20 2020 2020 2020 206f 7220 6773  fo.        or gs
-0003be80: 2e70 612e 6c6f 6769 6e5f 696e 666f 0a20  .pa.login_info. 
-0003be90: 2020 2020 2020 206f 7220 6773 2e70 612e         or gs.pa.
-0003bea0: 636f 6e74 656e 745f 7265 706f 7369 746f  content_reposito
-0003beb0: 7279 5f63 6f6e 6669 670a 2020 2020 2020  ry_config.      
-0003bec0: 2020 6f72 2067 732e 7061 2e67 6574 5f61    or gs.pa.get_a
-0003bed0: 7661 7461 7220 6973 206e 6f74 204e 6f6e  vatar is not Non
-0003bee0: 6520 2023 2065 6d70 7479 206c 6973 7420  e  # empty list 
-0003bef0: 6d75 7374 2069 6e76 6f6b 6520 6675 6e63  must invoke func
-0003bf00: 7469 6f6e 0a20 2020 2020 2020 206f 7220  tion.        or 
-0003bf10: 6773 2e70 612e 6765 745f 7072 6f66 696c  gs.pa.get_profil
-0003bf20: 6520 6973 206e 6f74 204e 6f6e 6520 2023  e is not None  #
-0003bf30: 2065 6d70 7479 206c 6973 7420 6d75 7374   empty list must
-0003bf40: 2069 6e76 6f6b 6520 6675 6e63 7469 6f6e   invoke function
-0003bf50: 0a20 2020 2020 2020 206f 7220 6773 2e70  .        or gs.p
-0003bf60: 612e 6765 745f 726f 6f6d 5f69 6e66 6f20  a.get_room_info 
-0003bf70: 6973 206e 6f74 204e 6f6e 6520 2023 2065  is not None  # e
-0003bf80: 6d70 7479 206c 6973 7420 6d75 7374 2069  mpty list must i
-0003bf90: 6e76 6f6b 6520 6675 6e63 7469 6f6e 0a20  nvoke function. 
-0003bfa0: 2020 2020 2020 206f 7220 6773 2e70 612e         or gs.pa.
-0003bfb0: 6765 745f 636c 6965 6e74 5f69 6e66 6f0a  get_client_info.
-0003bfc0: 2020 2020 2020 2020 6f72 2067 732e 7061          or gs.pa
-0003bfd0: 2e68 6173 5f70 6572 6d69 7373 696f 6e0a  .has_permission.
-0003bfe0: 2020 2020 2020 2020 6f72 2067 732e 7061          or gs.pa
-0003bff0: 2e65 7870 6f72 745f 6b65 7973 0a20 2020  .export_keys.   
-0003c000: 2020 2020 206f 7220 6773 2e70 612e 6765       or gs.pa.ge
-0003c010: 745f 6f70 656e 6964 5f74 6f6b 656e 2069  t_openid_token i
-0003c020: 7320 6e6f 7420 4e6f 6e65 2020 2320 656d  s not None  # em
-0003c030: 7074 7920 6c69 7374 206d 7573 7420 696e  pty list must in
-0003c040: 766f 6b65 2066 756e 630a 2020 2020 2020  voke func.      
-0003c050: 2020 6f72 2067 732e 7061 2e77 686f 616d    or gs.pa.whoam
-0003c060: 690a 2020 2020 293a 0a20 2020 2020 2020  i.    ):.       
-0003c070: 2067 732e 6765 745f 6163 7469 6f6e 203d   gs.get_action =
-0003c080: 2054 7275 650a 2020 2020 656c 7365 3a0a   True.    else:.
-0003c090: 2020 2020 2020 2020 6773 2e67 6574 5f61          gs.get_a
-0003c0a0: 6374 696f 6e20 3d20 4661 6c73 650a 0a20  ction = False.. 
-0003c0b0: 2020 2069 6620 6773 2e73 6574 5f61 6374     if gs.set_act
-0003c0c0: 696f 6e20 6f72 2067 732e 6765 745f 6163  ion or gs.get_ac
-0003c0d0: 7469 6f6e 3a0a 2020 2020 2020 2020 6773  tion:.        gs
-0003c0e0: 2e73 6574 6765 745f 6163 7469 6f6e 203d  .setget_action =
-0003c0f0: 2054 7275 650a 2020 2020 656c 7365 3a0a   True.    else:.
-0003c100: 2020 2020 2020 2020 6773 2e73 6574 6765          gs.setge
-0003c110: 745f 6163 7469 6f6e 203d 2046 616c 7365  t_action = False
-0003c120: 0a0a 2020 2020 2320 6f6e 6c79 2032 2053  ..    # only 2 S
-0003c130: 534c 2073 7461 7465 7320 616c 6c6f 7765  SL states allowe
-0003c140: 643a 204e 6f6e 6520 2853 534c 2064 6566  d: None (SSL def
-0003c150: 6175 6c74 206f 6e29 2c20 4661 6c73 6520  ault on), False 
-0003c160: 2853 534c 206f 6666 290a 2020 2020 6966  (SSL off).    if
-0003c170: 2067 732e 7061 2e6e 6f5f 7373 6c20 6973   gs.pa.no_ssl is
-0003c180: 206e 6f74 2054 7275 653a 0a20 2020 2020   not True:.     
-0003c190: 2020 2067 732e 7061 2e6e 6f5f 7373 6c20     gs.pa.no_ssl 
-0003c1a0: 3d20 4e6f 6e65 0a20 2020 2069 6620 6773  = None.    if gs
-0003c1b0: 2e70 612e 7072 6f78 7920 3d3d 2022 223a  .pa.proxy == "":
-0003c1c0: 0a20 2020 2020 2020 2067 732e 7061 2e70  .        gs.pa.p
-0003c1d0: 726f 7879 203d 204e 6f6e 650a 0a20 2020  roxy = None..   
-0003c1e0: 2023 2068 6f77 206f 6674 656e 2069 7320   # how often is 
-0003c1f0: 222d 2220 7573 6564 2074 6f20 7265 7072  "-" used to repr
-0003c200: 6573 656e 7420 7374 6469 6e0a 2020 2020  esent stdin.    
-0003c210: 2320 6d75 7374 2062 6520 3020 6f72 2031  # must be 0 or 1
-0003c220: 3b20 6361 6e6e 6f74 2062 6520 7573 6564  ; cannot be used
-0003c230: 2074 7769 6365 206f 7220 6d6f 7265 0a20   twice or more. 
-0003c240: 2020 2053 5444 494e 5f4d 4553 5341 4745     STDIN_MESSAGE
-0003c250: 203d 2030 0a20 2020 2053 5444 494e 5f49   = 0.    STDIN_I
-0003c260: 4d41 4745 203d 2030 0a20 2020 2053 5444  MAGE = 0.    STD
-0003c270: 494e 5f41 5544 494f 203d 2030 0a20 2020  IN_AUDIO = 0.   
-0003c280: 2053 5444 494e 5f46 494c 4520 3d20 300a   STDIN_FILE = 0.
-0003c290: 2020 2020 5354 4449 4e5f 4556 454e 5420      STDIN_EVENT 
-0003c2a0: 3d20 300a 2020 2020 5354 4449 4e5f 544f  = 0.    STDIN_TO
-0003c2b0: 5441 4c20 3d20 300a 2020 2020 6966 2067  TAL = 0.    if g
-0003c2c0: 732e 7061 2e69 6d61 6765 3a0a 2020 2020  s.pa.image:.    
-0003c2d0: 2020 2020 666f 7220 696d 6167 6520 696e      for image in
-0003c2e0: 2067 732e 7061 2e69 6d61 6765 3a0a 2020   gs.pa.image:.  
-0003c2f0: 2020 2020 2020 2020 2020 6966 2069 6d61            if ima
-0003c300: 6765 203d 3d20 222d 223a 0a20 2020 2020  ge == "-":.     
-0003c310: 2020 2020 2020 2020 2020 2053 5444 494e             STDIN
-0003c320: 5f49 4d41 4745 202b 3d20 310a 2020 2020  _IMAGE += 1.    
-0003c330: 2020 2020 2020 2020 2020 2020 6773 2e73              gs.s
-0003c340: 7464 696e 5f75 7365 203d 2022 696d 6167  tdin_use = "imag
-0003c350: 6522 0a20 2020 2069 6620 6773 2e70 612e  e".    if gs.pa.
-0003c360: 6175 6469 6f3a 0a20 2020 2020 2020 2066  audio:.        f
-0003c370: 6f72 2061 7564 696f 2069 6e20 6773 2e70  or audio in gs.p
-0003c380: 612e 6175 6469 6f3a 0a20 2020 2020 2020  a.audio:.       
-0003c390: 2020 2020 2069 6620 6175 6469 6f20 3d3d       if audio ==
-0003c3a0: 2022 2d22 3a0a 2020 2020 2020 2020 2020   "-":.          
-0003c3b0: 2020 2020 2020 5354 4449 4e5f 4155 4449        STDIN_AUDI
-0003c3c0: 4f20 2b3d 2031 0a20 2020 2020 2020 2020  O += 1.         
-0003c3d0: 2020 2020 2020 2067 732e 7374 6469 6e5f         gs.stdin_
-0003c3e0: 7573 6520 3d20 2261 7564 696f 220a 2020  use = "audio".  
-0003c3f0: 2020 6966 2067 732e 7061 2e66 696c 653a    if gs.pa.file:
-0003c400: 0a20 2020 2020 2020 2066 6f72 2066 696c  .        for fil
-0003c410: 6520 696e 2067 732e 7061 2e66 696c 653a  e in gs.pa.file:
-0003c420: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0003c430: 6669 6c65 203d 3d20 222d 223a 0a20 2020  file == "-":.   
-0003c440: 2020 2020 2020 2020 2020 2020 2053 5444               STD
-0003c450: 494e 5f46 494c 4520 2b3d 2031 0a20 2020  IN_FILE += 1.   
-0003c460: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
-0003c470: 7374 6469 6e5f 7573 6520 3d20 2266 696c  stdin_use = "fil
-0003c480: 6522 0a20 2020 2069 6620 6773 2e70 612e  e".    if gs.pa.
-0003c490: 6576 656e 743a 0a20 2020 2020 2020 2066  event:.        f
-0003c4a0: 6f72 2065 7665 6e74 2069 6e20 6773 2e70  or event in gs.p
-0003c4b0: 612e 6576 656e 743a 0a20 2020 2020 2020  a.event:.       
-0003c4c0: 2020 2020 2069 6620 6576 656e 7420 3d3d       if event ==
-0003c4d0: 2022 2d22 3a0a 2020 2020 2020 2020 2020   "-":.          
-0003c4e0: 2020 2020 2020 5354 4449 4e5f 4556 454e        STDIN_EVEN
-0003c4f0: 5420 2b3d 2031 0a20 2020 2020 2020 2020  T += 1.         
-0003c500: 2020 2020 2020 2067 732e 7374 6469 6e5f         gs.stdin_
-0003c510: 7573 6520 3d20 2265 7665 6e74 220a 2020  use = "event".  
-0003c520: 2020 6966 2067 732e 7061 2e6d 6573 7361    if gs.pa.messa
-0003c530: 6765 3a0a 2020 2020 2020 2020 666f 7220  ge:.        for 
-0003c540: 6d65 7373 6167 6520 696e 2067 732e 7061  message in gs.pa
-0003c550: 2e6d 6573 7361 6765 3a0a 2020 2020 2020  .message:.      
-0003c560: 2020 2020 2020 6966 206d 6573 7361 6765        if message
-0003c570: 203d 3d20 222d 2220 6f72 206d 6573 7361   == "-" or messa
-0003c580: 6765 203d 3d20 225f 223a 0a20 2020 2020  ge == "_":.     
-0003c590: 2020 2020 2020 2020 2020 2053 5444 494e             STDIN
-0003c5a0: 5f4d 4553 5341 4745 202b 3d20 310a 2020  _MESSAGE += 1.  
-0003c5b0: 2020 2020 2020 2020 2020 2020 2020 6773                gs
-0003c5c0: 2e73 7464 696e 5f75 7365 203d 2022 6d65  .stdin_use = "me
-0003c5d0: 7373 6167 6522 0a20 2020 2053 5444 494e  ssage".    STDIN
-0003c5e0: 5f54 4f54 414c 203d 2028 0a20 2020 2020  _TOTAL = (.     
-0003c5f0: 2020 2053 5444 494e 5f4d 4553 5341 4745     STDIN_MESSAGE
-0003c600: 202b 2053 5444 494e 5f49 4d41 4745 202b   + STDIN_IMAGE +
-0003c610: 2053 5444 494e 5f41 5544 494f 202b 2053   STDIN_AUDIO + S
-0003c620: 5444 494e 5f46 494c 4520 2b20 5354 4449  TDIN_FILE + STDI
-0003c630: 4e5f 4556 454e 540a 2020 2020 290a 0a20  N_EVENT.    ).. 
-0003c640: 2020 2023 2053 6563 6f6e 646c 792c 2074     # Secondly, t
-0003c650: 6865 2063 6865 636b 730a 2020 2020 6966  he checks.    if
-0003c660: 2067 732e 7061 2e63 6f6e 6669 673a 0a20   gs.pa.config:. 
-0003c670: 2020 2020 2020 2074 203d 2028 0a20 2020         t = (.   
-0003c680: 2020 2020 2020 2020 2022 5468 6973 2066           "This f
-0003c690: 6561 7475 7265 2069 7320 6e6f 7420 696d  eature is not im
-0003c6a0: 706c 656d 656e 7465 6420 7965 7420 616e  plemented yet an
-0003c6b0: 6420 7769 6c6c 206d 6f73 7420 6c69 6b65  d will most like
-0003c6c0: 6c79 2022 0a20 2020 2020 2020 2020 2020  ly ".           
-0003c6d0: 2022 6e6f 7420 6265 2069 6d70 6c65 6d65   "not be impleme
-0003c6e0: 6e74 6564 2e20 5365 6520 4973 7375 6520  nted. See Issue 
-0003c6f0: 2333 3420 6f6e 2047 6974 6875 622e 220a  #34 on Github.".
-0003c700: 2020 2020 2020 2020 290a 2020 2020 656c          ).    el
-0003c710: 6966 2067 732e 7061 2e6c 6973 7465 6e20  if gs.pa.listen 
-0003c720: 696e 2028 464f 5245 5645 522c 204f 4e43  in (FOREVER, ONC
-0003c730: 452c 2041 4c4c 2920 616e 6420 6773 2e70  E, ALL) and gs.p
-0003c740: 612e 7461 696c 2021 3d20 303a 0a20 2020  a.tail != 0:.   
-0003c750: 2020 2020 2074 203d 2028 0a20 2020 2020       t = (.     
-0003c760: 2020 2020 2020 2022 446f 6e27 7420 7573         "Don't us
-0003c770: 6520 2d2d 6c69 7374 656e 2066 6f72 6576  e --listen forev
-0003c780: 6572 2c20 2d2d 6c69 7374 656e 206f 6e63  er, --listen onc
-0003c790: 6520 6f72 202d 2d6c 6973 7465 6e20 616c  e or --listen al
-0003c7a0: 6c20 220a 2020 2020 2020 2020 2020 2020  l ".            
-0003c7b0: 2274 6f67 6574 6865 7220 7769 7468 202d  "together with -
-0003c7c0: 2d74 6169 6c2e 2049 7427 7320 6f6e 6520  -tail. It's one 
-0003c7d0: 6f72 2074 6865 206f 7468 6572 2e22 0a20  or the other.". 
-0003c7e0: 2020 2020 2020 2029 0a20 2020 2023 2074         ).    # t
-0003c7f0: 6869 7320 6973 2073 6574 2062 7920 6465  his is set by de
-0003c800: 6661 756c 7420 616e 7977 6179 2c20 6a75  fault anyway, ju
-0003c810: 7374 2064 6566 656e 7369 7665 2070 726f  st defensive pro
-0003c820: 6772 616d 6d69 6e67 0a20 2020 2065 6c69  gramming.    eli
-0003c830: 6620 6773 2e70 612e 656e 6372 7970 7465  f gs.pa.encrypte
-0003c840: 6420 616e 6420 6773 2e70 612e 7374 6f72  d and gs.pa.stor
-0003c850: 6520 696e 2028 4e6f 6e65 2c20 2222 293a  e in (None, ""):
-0003c860: 0a20 2020 2020 2020 2074 203d 2028 0a20  .        t = (. 
-0003c870: 2020 2020 2020 2020 2020 2022 4966 202d             "If -
-0003c880: 2d65 6e63 7279 7074 6564 2069 7320 7573  -encrypted is us
-0003c890: 6564 202d 2d73 746f 7265 206d 7573 7420  ed --store must 
-0003c8a0: 6265 2073 6574 2074 6f6f 2e20 220a 2020  be set too. ".  
-0003c8b0: 2020 2020 2020 2020 2020 2253 7065 6369            "Speci
-0003c8c0: 6679 202d 2d73 746f 7265 2061 6e64 2072  fy --store and r
-0003c8d0: 756e 2070 726f 6772 616d 2061 6761 696e  un program again
-0003c8e0: 2e22 0a20 2020 2020 2020 2029 0a20 2020  .".        ).   
-0003c8f0: 2065 6c69 6620 6773 2e70 612e 7665 7269   elif gs.pa.veri
-0003c900: 6679 2061 6e64 2028 6773 2e70 612e 7665  fy and (gs.pa.ve
-0003c910: 7269 6679 2e6c 6f77 6572 2829 2021 3d20  rify.lower() != 
-0003c920: 454d 4f4a 4929 3a0a 2020 2020 2020 2020  EMOJI):.        
-0003c930: 7420 3d20 6627 466f 7220 2d2d 7665 7269  t = f'For --veri
-0003c940: 6679 2063 7572 7265 6e74 6c79 206f 6e6c  fy currently onl
-0003c950: 7920 227b 454d 4f4a 497d 2220 6973 2061  y "{EMOJI}" is a
-0003c960: 6c6c 6f77 6564 2061 7320 6b65 7977 6f72  llowed as keywor
-0003c970: 642e 270a 2020 2020 656c 6966 2067 732e  d.'.    elif gs.
-0003c980: 7061 2e76 6572 7369 6f6e 2061 6e64 2028  pa.version and (
-0003c990: 0a20 2020 2020 2020 2067 732e 7061 2e76  .        gs.pa.v
-0003c9a0: 6572 7369 6f6e 2e6c 6f77 6572 2829 2021  ersion.lower() !
-0003c9b0: 3d20 5052 494e 5420 616e 6420 6773 2e70  = PRINT and gs.p
-0003c9c0: 612e 7665 7273 696f 6e2e 6c6f 7765 7228  a.version.lower(
-0003c9d0: 2920 213d 2043 4845 434b 0a20 2020 2029  ) != CHECK.    )
-0003c9e0: 3a0a 2020 2020 2020 2020 7420 3d20 280a  :.        t = (.
-0003c9f0: 2020 2020 2020 2020 2020 2020 6627 466f              f'Fo
-0003ca00: 7220 2d2d 7665 7273 696f 6e20 6375 7272  r --version curr
-0003ca10: 656e 746c 7920 6f6e 6c79 2022 7b50 5249  ently only "{PRI
-0003ca20: 4e54 7d22 2027 0a20 2020 2020 2020 2020  NT}" '.         
-0003ca30: 2020 2066 276f 7220 227b 4348 4543 4b7d     f'or "{CHECK}
-0003ca40: 2220 6973 2061 6c6c 6f77 6564 2061 7320  " is allowed as 
-0003ca50: 6b65 7977 6f72 642e 270a 2020 2020 2020  keyword.'.      
-0003ca60: 2020 290a 2020 2020 2320 616c 6c6f 7720    ).    # allow 
-0003ca70: 7665 7269 6679 2077 6974 6820 6576 6572  verify with ever
-0003ca80: 7974 6869 6e67 0a20 2020 2023 2061 6c6c  ything.    # all
-0003ca90: 6f77 2073 656e 6420 7769 7468 2065 7665  ow send with eve
-0003caa0: 7279 7468 696e 670a 2020 2020 2320 616c  rything.    # al
-0003cab0: 6c6f 7720 6c69 7374 656e 2077 6974 6820  low listen with 
-0003cac0: 6576 6572 7974 6869 6e67 0a20 2020 2065  everything.    e
-0003cad0: 6c69 6620 6773 2e70 612e 7365 745f 6465  lif gs.pa.set_de
-0003cae0: 7669 6365 5f6e 616d 6520 616e 6420 2867  vice_name and (g
-0003caf0: 732e 7061 2e73 6574 5f64 6576 6963 655f  s.pa.set_device_
-0003cb00: 6e61 6d65 2e73 7472 6970 2829 203d 3d20  name.strip() == 
-0003cb10: 2222 293a 0a20 2020 2020 2020 2074 203d  ""):.        t =
-0003cb20: 2022 446f 6e27 7420 7573 6520 616e 2065   "Don't use an e
-0003cb30: 6d70 7479 206e 616d 6520 666f 7220 2d2d  mpty name for --
-0003cb40: 7365 742d 6465 7669 6365 2d6e 616d 652e  set-device-name.
-0003cb50: 220a 2020 2020 656c 6966 2067 732e 7061  ".    elif gs.pa
-0003cb60: 2e73 6574 5f64 6973 706c 6179 5f6e 616d  .set_display_nam
-0003cb70: 6520 616e 6420 2867 732e 7061 2e73 6574  e and (gs.pa.set
-0003cb80: 5f64 6973 706c 6179 5f6e 616d 652e 7374  _display_name.st
-0003cb90: 7269 7028 2920 3d3d 2022 2229 3a0a 2020  rip() == ""):.  
-0003cba0: 2020 2020 2020 7420 3d20 2244 6f6e 2774        t = "Don't
-0003cbb0: 2075 7365 2061 6e20 656d 7074 7920 6e61   use an empty na
-0003cbc0: 6d65 2066 6f72 202d 2d73 6574 2d64 6973  me for --set-dis
-0003cbd0: 706c 6179 2d6e 616d 652e 220a 2020 2020  play-name.".    
-0003cbe0: 656c 6966 2028 6773 2e70 612e 7573 6572  elif (gs.pa.user
-0003cbf0: 2920 616e 6420 6e6f 7420 280a 2020 2020  ) and not (.    
-0003cc00: 2020 2020 6773 2e73 656e 645f 6163 7469      gs.send_acti
-0003cc10: 6f6e 0a20 2020 2020 2020 206f 7220 6773  on.        or gs
-0003cc20: 2e72 6f6f 6d5f 6163 7469 6f6e 0a20 2020  .room_action.   
-0003cc30: 2020 2020 206f 7220 6773 2e70 612e 6765       or gs.pa.ge
-0003cc40: 745f 6469 7370 6c61 795f 6e61 6d65 0a20  t_display_name. 
-0003cc50: 2020 2020 2020 206f 7220 6773 2e70 612e         or gs.pa.
-0003cc60: 6765 745f 7072 6573 656e 6365 0a20 2020  get_presence.   
-0003cc70: 2020 2020 206f 7220 6773 2e70 612e 6465       or gs.pa.de
-0003cc80: 6c65 7465 5f64 6576 6963 650a 2020 2020  lete_device.    
-0003cc90: 293a 0a20 2020 2020 2020 2074 203d 2028  ):.        t = (
-0003cca0: 0a20 2020 2020 2020 2020 2020 2022 4966  .            "If
-0003ccb0: 202d 2d75 7365 7220 6973 2073 7065 6369   --user is speci
-0003ccc0: 6669 6564 2c20 6f6e 6c79 2061 2073 656e  fied, only a sen
-0003ccd0: 6420 6163 7469 6f6e 2c20 6120 726f 6f6d  d action, a room
-0003cce0: 2061 6374 696f 6e2c 2022 0a20 2020 2020   action, ".     
-0003ccf0: 2020 2020 2020 2022 2d2d 6765 742d 6469         "--get-di
-0003cd00: 7370 6c61 792d 6e61 6d65 2c20 2d2d 6765  splay-name, --ge
-0003cd10: 742d 7072 6573 656e 6365 2c20 6f72 202d  t-presence, or -
-0003cd20: 2d64 656c 6574 652d 6465 7669 6365 2063  -delete-device c
-0003cd30: 616e 2062 6520 220a 2020 2020 2020 2020  an be ".        
-0003cd40: 2020 2020 2264 6f6e 652e 2041 646a 7573      "done. Adjus
-0003cd50: 7420 796f 7572 2061 7267 756d 656e 7473  t your arguments
-0003cd60: 2061 6363 6f72 6469 6e67 6c79 2e22 0a20   accordingly.". 
-0003cd70: 2020 2020 2020 2029 0a20 2020 2065 6c69         ).    eli
-0003cd80: 6620 2867 732e 7061 2e73 796e 6320 6973  f (gs.pa.sync is
-0003cd90: 206e 6f74 204e 6f6e 6529 2061 6e64 206e   not None) and n
-0003cda0: 6f74 2028 6773 2e73 656e 645f 6163 7469  ot (gs.send_acti
-0003cdb0: 6f6e 293a 0a20 2020 2020 2020 2074 203d  on):.        t =
-0003cdc0: 2028 0a20 2020 2020 2020 2020 2020 2022   (.            "
-0003cdd0: 4f6e 6c79 2069 6620 6120 7365 6e64 2061  Only if a send a
-0003cde0: 6374 696f 6e20 6973 2070 726f 7669 6465  ction is provide
-0003cdf0: 6420 6973 2069 7420 6d65 616e 696e 6766  d is it meaningf
-0003ce00: 756c 2074 6f20 7370 6563 6966 7920 220a  ul to specify ".
-0003ce10: 2020 2020 2020 2020 2020 2020 222d 2d73              "--s
-0003ce20: 796e 632e 2052 656d 6f76 6520 2d2d 7379  ync. Remove --sy
-0003ce30: 6e63 206f 7220 6164 6420 6120 7365 6e64  nc or add a send
-0003ce40: 2061 6374 696f 6e2e 2022 0a20 2020 2020   action. ".     
-0003ce50: 2020 2020 2020 2022 4164 6a75 7374 2079         "Adjust y
-0003ce60: 6f75 7220 6172 6775 6d65 6e74 7320 6163  our arguments ac
-0003ce70: 636f 7264 696e 676c 792e 220a 2020 2020  cordingly.".    
-0003ce80: 2020 2020 290a 2020 2020 656c 6966 2028      ).    elif (
-0003ce90: 6773 2e70 612e 7379 6e63 2069 7320 6e6f  gs.pa.sync is no
-0003cea0: 7420 4e6f 6e65 2920 616e 6420 6773 2e70  t None) and gs.p
-0003ceb0: 612e 7379 6e63 206e 6f74 2069 6e20 2853  a.sync not in (S
-0003cec0: 594e 435f 4655 4c4c 2c20 5359 4e43 5f4f  YNC_FULL, SYNC_O
-0003ced0: 4646 293a 0a20 2020 2020 2020 2074 203d  FF):.        t =
-0003cee0: 2028 0a20 2020 2020 2020 2020 2020 2022   (.            "
-0003cef0: 496e 636f 7272 6563 7420 7661 6c75 6520  Incorrect value 
-0003cf00: 6769 7665 6e20 666f 7220 2d2d 7379 6e63  given for --sync
-0003cf10: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
-0003cf20: 6622 4f6e 6c79 2027 7b53 594e 435f 4655  f"Only '{SYNC_FU
-0003cf30: 4c4c 7d27 2061 6e64 2027 7b53 594e 435f  LL}' and '{SYNC_
-0003cf40: 4f46 467d 2720 6172 6520 616c 6c6f 7765  OFF}' are allowe
-0003cf50: 642e 220a 2020 2020 2020 2020 290a 2020  d.".        ).  
-0003cf60: 2020 656c 6966 2067 732e 7061 2e6f 7574    elif gs.pa.out
-0003cf70: 7075 7420 6e6f 7420 696e 2028 0a20 2020  put not in (.   
-0003cf80: 2020 2020 204f 5554 5055 545f 5445 5854       OUTPUT_TEXT
-0003cf90: 2c0a 2020 2020 2020 2020 4f55 5450 5554  ,.        OUTPUT
-0003cfa0: 5f4a 534f 4e2c 0a20 2020 2020 2020 204f  _JSON,.        O
-0003cfb0: 5554 5055 545f 4a53 4f4e 5f53 5045 432c  UTPUT_JSON_SPEC,
-0003cfc0: 0a20 2020 2020 2020 204f 5554 5055 545f  .        OUTPUT_
-0003cfd0: 4a53 4f4e 5f4d 4158 2c0a 2020 2020 293a  JSON_MAX,.    ):
-0003cfe0: 0a20 2020 2020 2020 2074 203d 2028 0a20  .        t = (. 
-0003cff0: 2020 2020 2020 2020 2020 2022 496e 636f             "Inco
-0003d000: 7272 6563 7420 7661 6c75 6520 6769 7665  rrect value give
-0003d010: 6e20 666f 7220 2d2d 6f75 7470 7574 2e20  n for --output. 
-0003d020: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
-0003d030: 4f6e 6c79 2027 7b4f 5554 5055 545f 5445  Only '{OUTPUT_TE
-0003d040: 5854 7d27 2c20 277b 4f55 5450 5554 5f4a  XT}', '{OUTPUT_J
-0003d050: 534f 4e7d 272c 2022 0a20 2020 2020 2020  SON}', ".       
-0003d060: 2020 2020 2066 2227 7b4f 5554 5055 545f       f"'{OUTPUT_
-0003d070: 4a53 4f4e 5f53 5045 437d 2720 616e 6420  JSON_SPEC}' and 
-0003d080: 277b 4f55 5450 5554 5f4a 534f 4e5f 4d41  '{OUTPUT_JSON_MA
-0003d090: 587d 2720 6172 6520 616c 6c6f 7765 642e  X}' are allowed.
-0003d0a0: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
-0003d0b0: 656c 6966 206e 6f74 2067 732e 7061 2e75  elif not gs.pa.u
-0003d0c0: 7365 7220 616e 6420 280a 2020 2020 2020  ser and (.      
-0003d0d0: 2020 6773 2e70 612e 726f 6f6d 5f69 6e76    gs.pa.room_inv
-0003d0e0: 6974 650a 2020 2020 2020 2020 6f72 2067  ite.        or g
-0003d0f0: 732e 7061 2e72 6f6f 6d5f 6261 6e0a 2020  s.pa.room_ban.  
-0003d100: 2020 2020 2020 6f72 2067 732e 7061 2e72        or gs.pa.r
-0003d110: 6f6f 6d5f 756e 6261 6e0a 2020 2020 2020  oom_unban.      
-0003d120: 2020 6f72 2067 732e 7061 2e72 6f6f 6d5f    or gs.pa.room_
-0003d130: 6b69 636b 0a20 2020 2029 3a0a 2020 2020  kick.    ):.    
-0003d140: 2020 2020 7420 3d20 280a 2020 2020 2020      t = (.      
-0003d150: 2020 2020 2020 2255 7365 7220 6e6f 7420        "User not 
-0003d160: 7370 6563 6966 6965 6420 666f 7220 726f  specified for ro
-0003d170: 6f6d 2061 6374 696f 6e2e 2022 0a20 2020  om action. ".   
-0003d180: 2020 2020 2020 2020 2022 5573 6520 2d2d           "Use --
-0003d190: 7573 6572 206f 7074 696f 6e20 746f 2073  user option to s
-0003d1a0: 7065 6369 6679 2075 7365 7228 7329 2066  pecify user(s) f
-0003d1b0: 6f72 2067 6976 656e 2072 6f6f 6d20 6163  or given room ac
-0003d1c0: 7469 6f6e 2e22 0a20 2020 2020 2020 2029  tion.".        )
-0003d1d0: 0a20 2020 2065 6c69 6620 6773 2e70 612e  .    elif gs.pa.
-0003d1e0: 6c69 7374 656e 2069 6e20 284f 4e43 452c  listen in (ONCE,
-0003d1f0: 2046 4f52 4556 4552 2920 616e 6420 6773   FOREVER) and gs
-0003d200: 2e70 612e 726f 6f6d 3a0a 2020 2020 2020  .pa.room:.      
-0003d210: 2020 7420 3d20 280a 2020 2020 2020 2020    t = (.        
-0003d220: 2020 2020 2249 6620 2d2d 6c69 7374 656e      "If --listen
-0003d230: 206f 6e63 6520 6f72 202d 2d6c 6973 7465   once or --liste
-0003d240: 6e20 666f 7265 7665 7220 6172 6520 7370  n forever are sp
-0003d250: 6563 6966 6965 642c 2022 0a20 2020 2020  ecified, ".     
-0003d260: 2020 2020 2020 2022 2d2d 726f 6f6d 206d         "--room m
-0003d270: 7573 7420 6e6f 7420 6265 2073 7065 6369  ust not be speci
-0003d280: 6669 6564 2062 6563 6175 7365 2022 0a20  fied because ". 
-0003d290: 2020 2020 2020 2020 2020 2022 7468 6573             "thes
-0003d2a0: 6520 6f70 7469 6f6e 7320 6c69 7374 656e  e options listen
-0003d2b0: 2069 6e20 414c 4c20 726f 6f6d 732e 220a   in ALL rooms.".
-0003d2c0: 2020 2020 2020 2020 290a 2020 2020 656c          ).    el
-0003d2d0: 6966 2067 732e 7061 2e6c 6973 7465 6e20  if gs.pa.listen 
-0003d2e0: 6e6f 7420 696e 2028 4e45 5645 522c 2046  not in (NEVER, F
-0003d2f0: 4f52 4556 4552 2c20 4f4e 4345 2c20 5441  OREVER, ONCE, TA
-0003d300: 494c 2c20 414c 4c29 3a0a 2020 2020 2020  IL, ALL):.      
-0003d310: 2020 7420 3d20 280a 2020 2020 2020 2020    t = (.        
-0003d320: 2020 2020 2249 6620 2d2d 6c69 7374 656e      "If --listen
-0003d330: 2069 7320 7370 6563 6966 6965 642c 206f   is specified, o
-0003d340: 6e6c 7920 7468 6573 6520 6368 6f69 6365  nly these choice
-0003d350: 7320 6172 6520 220a 2020 2020 2020 2020  s are ".        
-0003d360: 2020 2020 6622 706f 7373 6962 6c65 3a20      f"possible: 
-0003d370: 7b4f 4e43 457d 2c20 7b4e 4556 4552 7d2c  {ONCE}, {NEVER},
-0003d380: 207b 464f 5245 5645 527d 2c20 7b54 4149   {FOREVER}, {TAI
-0003d390: 4c7d 206f 7220 7b41 4c4c 7d2e 2022 0a20  L} or {ALL}. ". 
-0003d3a0: 2020 2020 2020 2020 2020 2066 2746 6f75             f'Fou
-0003d3b0: 6e64 2022 7b67 732e 7061 2e6c 6973 7465  nd "{gs.pa.liste
-0003d3c0: 6e7d 222e 270a 2020 2020 2020 2020 290a  n}".'.        ).
-0003d3d0: 2020 2020 656c 6966 2067 732e 7061 2e6c      elif gs.pa.l
-0003d3e0: 6973 7465 6e20 3d3d 204e 4556 4552 2061  isten == NEVER a
-0003d3f0: 6e64 2067 732e 7061 2e6c 6973 7465 6e5f  nd gs.pa.listen_
-0003d400: 7365 6c66 3a0a 2020 2020 2020 2020 7420  self:.        t 
-0003d410: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-0003d420: 2249 6620 6e65 6974 6865 7220 2d2d 6c69  "If neither --li
-0003d430: 7374 656e 206e 6f72 202d 2d74 6169 6c20  sten nor --tail 
-0003d440: 6172 6520 7573 6564 2c20 220a 2020 2020  are used, ".    
-0003d450: 2020 2020 2020 2020 2274 6865 6e20 2d2d          "then --
-0003d460: 6c69 7374 656e 2d73 656c 6620 6d75 7374  listen-self must
-0003d470: 206e 6f74 2062 6520 7573 6564 2022 0a20   not be used ". 
-0003d480: 2020 2020 2020 2020 2020 2022 6569 7468             "eith
-0003d490: 6572 2e20 5370 6563 6966 7920 2d2d 6c69  er. Specify --li
-0003d4a0: 7374 656e 206f 7220 2d2d 7461 696c 2022  sten or --tail "
-0003d4b0: 0a20 2020 2020 2020 2020 2020 2022 616e  .            "an
-0003d4c0: 6420 7275 6e20 7072 6f67 7261 6d20 6167  d run program ag
-0003d4d0: 6169 6e2e 220a 2020 2020 2020 2020 290a  ain.".        ).
-0003d4e0: 2020 2020 656c 6966 2067 732e 7061 2e6c      elif gs.pa.l
-0003d4f0: 6973 7465 6e20 3d3d 204e 4556 4552 2061  isten == NEVER a
-0003d500: 6e64 2028 6773 2e70 612e 646f 776e 6c6f  nd (gs.pa.downlo
-0003d510: 6164 5f6d 6564 6961 2021 3d20 2222 293a  ad_media != ""):
-0003d520: 0a20 2020 2020 2020 2074 203d 2028 0a20  .        t = (. 
-0003d530: 2020 2020 2020 2020 2020 2022 4966 206e             "If n
-0003d540: 6569 7468 6572 202d 2d6c 6973 7465 6e20  either --listen 
-0003d550: 6e6f 7220 2d2d 7461 696c 2061 7265 2075  nor --tail are u
-0003d560: 7365 642c 2022 0a20 2020 2020 2020 2020  sed, ".         
-0003d570: 2020 2022 7468 656e 202d 2d64 6f77 6e6c     "then --downl
-0003d580: 6f61 642d 6d65 6469 6120 6d75 7374 206e  oad-media must n
-0003d590: 6f74 2062 6520 7573 6564 2022 0a20 2020  ot be used ".   
-0003d5a0: 2020 2020 2020 2020 2022 6569 7468 6572           "either
-0003d5b0: 2e20 5370 6563 6966 7920 2d2d 6c69 7374  . Specify --list
-0003d5c0: 656e 206f 7220 2d2d 7461 696c 2022 0a20  en or --tail ". 
-0003d5d0: 2020 2020 2020 2020 2020 2066 2261 6e64             f"and
-0003d5e0: 2072 756e 2070 726f 6772 616d 2061 6761   run program aga
-0003d5f0: 696e 2e20 287b 6773 2e70 612e 646f 776e  in. ({gs.pa.down
-0003d600: 6c6f 6164 5f6d 6564 6961 7d29 220a 2020  load_media})".  
-0003d610: 2020 2020 2020 290a 2020 2020 656c 6966        ).    elif
-0003d620: 2067 732e 7061 2e6c 6973 7465 6e20 3d3d   gs.pa.listen ==
-0003d630: 2054 4149 4c20 616e 6420 2867 732e 7061   TAIL and (gs.pa
-0003d640: 2e74 6169 6c20 3c3d 2030 293a 0a20 2020  .tail <= 0):.   
-0003d650: 2020 2020 2074 203d 2028 0a20 2020 2020       t = (.     
-0003d660: 2020 2020 2020 2022 416e 2069 6e74 6567         "An integ
-0003d670: 6572 2031 206f 7220 6c61 7267 6572 206d  er 1 or larger m
-0003d680: 7573 7420 6265 2073 7065 6369 6669 6564  ust be specified
-0003d690: 2077 6974 6820 2d2d 7461 696c 2022 0a20   with --tail ". 
-0003d6a0: 2020 2020 2020 2020 2020 2066 2228 7b67             f"({g
-0003d6b0: 732e 7061 2e74 6169 6c7d 292e 220a 2020  s.pa.tail}).".  
-0003d6c0: 2020 2020 2020 290a 2020 2020 656c 6966        ).    elif
-0003d6d0: 2067 732e 7061 2e70 726f 7879 2061 6e64   gs.pa.proxy and
-0003d6e0: 206e 6f74 2028 0a20 2020 2020 2020 2067   not (.        g
-0003d6f0: 732e 7061 2e70 726f 7879 2e73 7461 7274  s.pa.proxy.start
-0003d700: 7377 6974 6828 2268 7474 703a 2f2f 2229  swith("http://")
-0003d710: 0a20 2020 2020 2020 206f 7220 6773 2e70  .        or gs.p
-0003d720: 612e 7072 6f78 792e 7374 6172 7473 7769  a.proxy.startswi
-0003d730: 7468 2822 736f 636b 7334 3a2f 2f22 290a  th("socks4://").
-0003d740: 2020 2020 2020 2020 6f72 2067 732e 7061          or gs.pa
-0003d750: 2e70 726f 7879 2e73 7461 7274 7377 6974  .proxy.startswit
-0003d760: 6828 2273 6f63 6b73 353a 2f2f 2229 0a20  h("socks5://"). 
-0003d770: 2020 2029 3a0a 2020 2020 2020 2020 7420     ):.        t 
-0003d780: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-0003d790: 2250 726f 7879 2069 7320 6e6f 7420 636f  "Proxy is not co
-0003d7a0: 7272 6563 742e 2050 726f 7879 2073 686f  rrect. Proxy sho
-0003d7b0: 756c 6420 7374 6172 7420 7769 7468 2022  uld start with "
-0003d7c0: 0a20 2020 2020 2020 2020 2020 2027 2268  .            '"h
-0003d7d0: 7474 703a 2f2f 222c 2022 736f 636b 7334  ttp://", "socks4
-0003d7e0: 3a2f 2f22 206f 7220 2273 6f63 6b73 353a  ://" or "socks5:
-0003d7f0: 2f2f 222e 2027 0a20 2020 2020 2020 2020  //". '.         
-0003d800: 2020 2066 2720 596f 7572 2070 726f 7879     f' Your proxy
-0003d810: 2069 7320 7365 7420 746f 2022 7b67 732e   is set to "{gs.
-0003d820: 7061 2e70 726f 7879 7d22 2e27 0a20 2020  pa.proxy}".'.   
-0003d830: 2020 2020 2029 0a20 2020 2065 6c69 6620       ).    elif 
-0003d840: 5354 4449 4e5f 544f 5441 4c20 3e20 313a  STDIN_TOTAL > 1:
-0003d850: 0a20 2020 2020 2020 2074 203d 2028 0a20  .        t = (. 
-0003d860: 2020 2020 2020 2020 2020 2027 5468 6520             'The 
-0003d870: 6368 6172 6163 7465 7220 222d 2220 6973  character "-" is
-0003d880: 2075 7365 6420 6d6f 7265 2074 6861 6e20   used more than 
-0003d890: 6f6e 6365 2027 0a20 2020 2020 2020 2020  once '.         
-0003d8a0: 2020 2027 746f 2072 6570 7265 7365 6e74     'to represent
-0003d8b0: 2022 7374 6469 6e22 2066 6f72 2070 6970   "stdin" for pip
-0003d8c0: 696e 6720 696e 666f 726d 6174 696f 6e20  ing information 
-0003d8d0: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
-0003d8e0: 696e 746f 2022 7b50 524f 475f 5749 5448  into "{PROG_WITH
-0003d8f0: 4f55 545f 4558 547d 222e 2053 7464 696e  OUT_EXT}". Stdin
-0003d900: 2070 6970 6520 6361 6e20 270a 2020 2020   pipe can '.    
-0003d910: 2020 2020 2020 2020 2262 6520 7573 6564          "be used
-0003d920: 2061 7420 6d6f 7374 206f 6e63 652e 220a   at most once.".
-0003d930: 2020 2020 2020 2020 290a 2020 2020 656c          ).    el
-0003d940: 6966 2067 732e 7061 2e6e 6f5f 7373 6c20  if gs.pa.no_ssl 
-0003d950: 616e 6420 6773 2e70 612e 7373 6c5f 6365  and gs.pa.ssl_ce
-0003d960: 7274 6966 6963 6174 6520 213d 2053 534c  rtificate != SSL
-0003d970: 5f43 4552 5449 4649 4341 5445 5f44 4546  _CERTIFICATE_DEF
-0003d980: 4155 4c54 3a0a 2020 2020 2020 2020 7420  AULT:.        t 
-0003d990: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-0003d9a0: 224f 7074 696f 6e73 202d 2d6e 6f2d 7373  "Options --no-ss
-0003d9b0: 6c20 616e 6420 2d2d 7373 6c2d 6365 7274  l and --ssl-cert
-0003d9c0: 6966 6963 6174 6520 6361 6e6e 6f74 2062  ificate cannot b
-0003d9d0: 6520 7573 6564 2022 0a20 2020 2020 2020  e used ".       
-0003d9e0: 2020 2020 2022 746f 6765 7468 6572 2e20       "together. 
-0003d9f0: 5573 6520 6f6e 6520 6f72 2074 6865 206f  Use one or the o
-0003da00: 7468 6572 2e22 0a20 2020 2020 2020 2029  ther.".        )
-0003da10: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-0003da20: 2020 2069 6620 6773 2e70 612e 7379 6e63     if gs.pa.sync
-0003da30: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0003da40: 2020 2020 2020 6773 2e70 612e 7379 6e63        gs.pa.sync
-0003da50: 203d 2053 594e 435f 4445 4641 554c 540a   = SYNC_DEFAULT.
-0003da60: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-0003da70: 6562 7567 2866 224f 7074 696f 6e20 2d2d  ebug(f"Option --
-0003da80: 7379 6e63 2069 7320 7365 7420 746f 207b  sync is set to {
-0003da90: 6773 2e70 612e 7379 6e63 7d2e 2229 0a20  gs.pa.sync}."). 
-0003daa0: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-0003dab0: 6275 6728 2241 6c6c 2061 7267 756d 656e  bug("All argumen
-0003dac0: 7473 2061 7265 2076 616c 6964 2e20 416c  ts are valid. Al
-0003dad0: 6c20 6368 6563 6b73 2070 6173 7365 642e  l checks passed.
-0003dae0: 2229 0a20 2020 2020 2020 2072 6574 7572  ").        retur
-0003daf0: 6e20 2023 2061 6c6c 204f 4b0a 2020 2020  n  # all OK.    
-0003db00: 2320 6773 2e65 7272 5f63 6f75 6e74 202b  # gs.err_count +
-0003db10: 3d20 3120 2320 646f 206e 6f74 2069 6e63  = 1 # do not inc
-0003db20: 7265 6d65 6e74 2066 6f72 204d 6174 7269  rement for Matri
-0003db30: 7843 6f6d 6d61 6e64 6572 4572 726f 720a  xCommanderError.
-0003db40: 2020 2020 7261 6973 6520 4d61 7472 6978      raise Matrix
-0003db50: 436f 6d6d 616e 6465 7245 7272 6f72 2822  CommanderError("
-0003db60: 4532 3430 3a20 2220 2b20 7429 2066 726f  E240: " + t) fro
-0003db70: 6d20 4e6f 6e65 0a0a 0a63 6c61 7373 2063  m None...class c
-0003db80: 6f6c 6f72 733a 0a20 2020 2022 2222 436f  olors:.    """Co
-0003db90: 6c6f 7273 2063 6c61 7373 2e0a 0a20 2020  lors class...   
-0003dba0: 2072 6573 6574 2061 6c6c 2063 6f6c 6f72   reset all color
-0003dbb0: 7320 7769 7468 2063 6f6c 6f72 732e 7265  s with colors.re
-0003dbc0: 7365 742e 0a20 2020 2032 2073 7562 2063  set..    2 sub c
-0003dbd0: 6c61 7373 6573 3a20 6667 2066 6f72 2066  lasses: fg for f
-0003dbe0: 6f72 6567 726f 756e 6420 616e 6420 6267  oreground and bg
-0003dbf0: 2066 6f72 2062 6163 6b67 726f 756e 643b   for background;
-0003dc00: 0a20 2020 2075 7365 2061 7320 636f 6c6f  .    use as colo
-0003dc10: 7273 2e73 7562 636c 6173 732e 636f 6c6f  rs.subclass.colo
-0003dc20: 726e 616d 652e 0a20 2020 2069 2e65 2e20  rname..    i.e. 
-0003dc30: 636f 6c6f 7273 2e66 672e 7265 6420 6f72  colors.fg.red or
-0003dc40: 2063 6f6c 6f72 732e 6267 2e67 7265 656e   colors.bg.green
-0003dc50: 0a20 2020 2061 6c73 6f2c 2074 6865 2067  .    also, the g
-0003dc60: 656e 6572 6963 2062 6f6c 642c 2064 6973  eneric bold, dis
-0003dc70: 6162 6c65 2c20 756e 6465 726c 696e 652c  able, underline,
-0003dc80: 2072 6576 6572 7365 2c20 7374 7269 6b65   reverse, strike
-0003dc90: 2074 6872 6f75 6768 2c0a 2020 2020 616e   through,.    an
-0003dca0: 6420 696e 7669 7369 626c 6520 776f 726b  d invisible work
-0003dcb0: 2077 6974 6820 7468 6520 6d61 696e 2063   with the main c
-0003dcc0: 6c61 7373 2069 2e65 2e20 636f 6c6f 7273  lass i.e. colors
-0003dcd0: 2e62 6f6c 640a 0a20 2020 2075 7365 206c  .bold..    use l
-0003dce0: 696b 6520 7468 6973 3a0a 2020 2020 7072  ike this:.    pr
-0003dcf0: 696e 7428 636f 6c6f 7273 2e62 672e 6772  int(colors.bg.gr
-0003dd00: 6565 6e2c 2022 534b 6b22 2c20 636f 6c6f  een, "SKk", colo
-0003dd10: 7273 2e66 672e 7265 642c 2022 416d 6172  rs.fg.red, "Amar
-0003dd20: 7479 6122 290a 2020 2020 7072 696e 7428  tya").    print(
-0003dd30: 636f 6c6f 7273 2e62 672e 6c69 6768 7467  colors.bg.lightg
-0003dd40: 7265 792c 2022 534b 6b22 2c20 636f 6c6f  rey, "SKk", colo
-0003dd50: 7273 2e66 672e 7265 642c 2022 416d 6172  rs.fg.red, "Amar
-0003dd60: 7479 6122 290a 2020 2020 2222 220a 0a20  tya").    """.. 
-0003dd70: 2020 2072 6573 6574 203d 2022 5c30 3333     reset = "\033
-0003dd80: 5b30 6d22 0a20 2020 2062 6f6c 6420 3d20  [0m".    bold = 
-0003dd90: 225c 3033 335b 3031 6d22 0a20 2020 2064  "\033[01m".    d
-0003dda0: 6973 6162 6c65 203d 2022 5c30 3333 5b30  isable = "\033[0
-0003ddb0: 326d 220a 2020 2020 696e 7665 7273 6520  2m".    inverse 
-0003ddc0: 3d20 225c 3033 335b 3033 6d22 0a20 2020  = "\033[03m".   
-0003ddd0: 2075 6e64 6572 6c69 6e65 203d 2022 5c30   underline = "\0
-0003dde0: 3333 5b30 346d 220a 2020 2020 626c 696e  33[04m".    blin
-0003ddf0: 6b20 3d20 225c 3033 335b 3035 6d22 0a20  k = "\033[05m". 
-0003de00: 2020 2062 6c69 6e6b 3220 3d20 225c 3033     blink2 = "\03
-0003de10: 335b 3036 6d22 0a20 2020 2072 6576 6572  3[06m".    rever
-0003de20: 7365 203d 2022 5c30 3333 5b30 376d 220a  se = "\033[07m".
-0003de30: 2020 2020 696e 7669 7369 626c 6520 3d20      invisible = 
-0003de40: 225c 3033 335b 3038 6d22 0a20 2020 2073  "\033[08m".    s
-0003de50: 7472 696b 6574 6872 6f75 6768 203d 2022  trikethrough = "
-0003de60: 5c30 3333 5b30 396d 220a 0a20 2020 2063  \033[09m"..    c
-0003de70: 6c61 7373 2066 673a 0a20 2020 2020 2020  lass fg:.       
-0003de80: 2062 6c61 636b 203d 2022 5c30 3333 5b33   black = "\033[3
-0003de90: 306d 220a 2020 2020 2020 2020 7265 6420  0m".        red 
-0003dea0: 3d20 225c 3033 335b 3331 6d22 0a20 2020  = "\033[31m".   
-0003deb0: 2020 2020 2067 7265 656e 203d 2022 5c30       green = "\0
-0003dec0: 3333 5b33 326d 220a 2020 2020 2020 2020  33[32m".        
-0003ded0: 6f72 616e 6765 203d 2022 5c30 3333 5b33  orange = "\033[3
-0003dee0: 336d 220a 2020 2020 2020 2020 626c 7565  3m".        blue
-0003def0: 203d 2022 5c30 3333 5b33 346d 220a 2020   = "\033[34m".  
-0003df00: 2020 2020 2020 7075 7270 6c65 203d 2022        purple = "
-0003df10: 5c30 3333 5b33 356d 220a 2020 2020 2020  \033[35m".      
-0003df20: 2020 6379 616e 203d 2022 5c30 3333 5b33    cyan = "\033[3
-0003df30: 366d 220a 2020 2020 2020 2020 6c69 6768  6m".        ligh
-0003df40: 7467 7265 7920 3d20 225c 3033 335b 3337  tgrey = "\033[37
-0003df50: 6d22 0a20 2020 2020 2020 2064 6172 6b67  m".        darkg
-0003df60: 7265 7920 3d20 225c 3033 335b 3930 6d22  rey = "\033[90m"
-0003df70: 0a20 2020 2020 2020 206c 6967 6874 7265  .        lightre
-0003df80: 6420 3d20 225c 3033 335b 3931 6d22 0a20  d = "\033[91m". 
-0003df90: 2020 2020 2020 206c 6967 6874 6772 6565         lightgree
-0003dfa0: 6e20 3d20 225c 3033 335b 3932 6d22 0a20  n = "\033[92m". 
-0003dfb0: 2020 2020 2020 2079 656c 6c6f 7720 3d20         yellow = 
-0003dfc0: 225c 3033 335b 3933 6d22 0a20 2020 2020  "\033[93m".     
-0003dfd0: 2020 206c 6967 6874 626c 7565 203d 2022     lightblue = "
-0003dfe0: 5c30 3333 5b39 346d 220a 2020 2020 2020  \033[94m".      
-0003dff0: 2020 7069 6e6b 203d 2022 5c30 3333 5b39    pink = "\033[9
-0003e000: 356d 220a 2020 2020 2020 2020 6c69 6768  5m".        ligh
-0003e010: 7463 7961 6e20 3d20 225c 3033 335b 3936  tcyan = "\033[96
-0003e020: 6d22 0a0a 2020 2020 636c 6173 7320 6267  m"..    class bg
-0003e030: 3a0a 2020 2020 2020 2020 626c 6163 6b20  :.        black 
-0003e040: 3d20 225c 3033 335b 3430 6d22 0a20 2020  = "\033[40m".   
-0003e050: 2020 2020 2072 6564 203d 2022 5c30 3333       red = "\033
-0003e060: 5b34 316d 220a 2020 2020 2020 2020 6772  [41m".        gr
-0003e070: 6565 6e20 3d20 225c 3033 335b 3432 6d22  een = "\033[42m"
-0003e080: 0a20 2020 2020 2020 206f 7261 6e67 6520  .        orange 
-0003e090: 3d20 225c 3033 335b 3433 6d22 0a20 2020  = "\033[43m".   
-0003e0a0: 2020 2020 2062 6c75 6520 3d20 225c 3033       blue = "\03
-0003e0b0: 335b 3434 6d22 0a20 2020 2020 2020 2070  3[44m".        p
-0003e0c0: 7572 706c 6520 3d20 225c 3033 335b 3435  urple = "\033[45
-0003e0d0: 6d22 0a20 2020 2020 2020 2063 7961 6e20  m".        cyan 
-0003e0e0: 3d20 225c 3033 335b 3436 6d22 0a20 2020  = "\033[46m".   
-0003e0f0: 2020 2020 206c 6967 6874 6772 6579 203d       lightgrey =
-0003e100: 2022 5c30 3333 5b34 376d 220a 0a0a 2320   "\033[47m"...# 
-0003e110: 6163 636f 7264 696e 6720 746f 206c 696e  according to lin
-0003e120: 7465 723a 2066 756e 6374 696f 6e20 6973  ter: function is
-0003e130: 2074 6f6f 2063 6f6d 706c 6578 2c20 4339   too complex, C9
-0003e140: 3031 0a64 6566 206d 6169 6e5f 696e 6e65  01.def main_inne
-0003e150: 7228 0a20 2020 2061 7267 763a 2055 6e69  r(.    argv: Uni
-0003e160: 6f6e 5b4e 6f6e 652c 206c 6973 745d 203d  on[None, list] =
-0003e170: 204e 6f6e 650a 2920 2d3e 204e 6f6e 653a   None.) -> None:
-0003e180: 2020 2320 6e6f 7161 3a20 4339 3031 2023    # noqa: C901 #
-0003e190: 2069 676e 6f72 6520 6d63 6361 6265 2069   ignore mccabe i
-0003e1a0: 662d 746f 6f2d 636f 6d70 6c65 780a 2020  f-too-complex.  
-0003e1b0: 2020 2222 2252 756e 2074 6865 2070 726f    """Run the pro
-0003e1c0: 6772 616d 2e0a 0a20 2020 2046 756e 6374  gram...    Funct
-0003e1d0: 696f 6e20 7369 676e 6174 7572 6520 6964  ion signature id
-0003e1e0: 656e 7469 6361 6c20 746f 206d 6169 6e28  entical to main(
-0003e1f0: 292e 0a20 2020 2050 6c65 6173 6520 7365  )..    Please se
-0003e200: 6520 6d61 696e 2829 2e0a 0a20 2020 2052  e main()...    R
-0003e210: 6574 7572 6e73 204e 6f6e 652e 2052 6574  eturns None. Ret
-0003e220: 7572 6e73 206e 6f74 6869 6e67 2e0a 0a20  urns nothing... 
-0003e230: 2020 2052 6169 7365 7320 6578 6365 7074     Raises except
-0003e240: 696f 6e20 6966 2061 6e20 6572 726f 7220  ion if an error 
-0003e250: 6973 2064 6574 6563 7465 642e 204d 616e  is detected. Man
-0003e260: 7920 6578 6365 7074 696f 6e73 2061 7265  y exceptions are
-0003e270: 0a20 2020 2020 2020 2070 6f73 7369 626c  .        possibl
-0003e280: 652e 204f 6e65 206f 6620 7468 656d 2069  e. One of them i
-0003e290: 733a 204d 6174 7269 7843 6f6d 6d61 6e64  s: MatrixCommand
-0003e2a0: 6572 4572 726f 722e 0a20 2020 2020 2020  erError..       
-0003e2b0: 2053 6574 7320 676c 6f62 616c 2073 7461   Sets global sta
-0003e2c0: 7465 2074 6f20 636f 6d6d 756e 6963 6174  te to communicat
-0003e2d0: 6520 6572 726f 7273 2e0a 0a20 2020 2022  e errors...    "
-0003e2e0: 2222 0a20 2020 2069 6620 6172 6776 3a0a  "".    if argv:.
-0003e2f0: 2020 2020 2020 2020 7379 732e 6172 6776          sys.argv
-0003e300: 203d 2061 7267 760a 2020 2020 2320 7072   = argv.    # pr
-0003e310: 6570 6172 6520 7468 6520 676c 6f62 616c  epare the global
-0003e320: 2073 7461 7465 0a20 2020 2067 6c6f 6261   state.    globa
-0003e330: 6c20 6773 0a20 2020 2067 7320 3d20 476c  l gs.    gs = Gl
-0003e340: 6f62 616c 5374 6174 6528 290a 2020 2020  obalState().    
-0003e350: 676c 6f62 616c 2053 4550 0a20 2020 2023  global SEP.    #
-0003e360: 2043 6f6e 7374 7275 6374 2074 6865 2061   Construct the a
-0003e370: 7267 756d 656e 7420 7061 7273 6572 0a20  rgument parser. 
-0003e380: 2020 2061 7020 3d20 6172 6770 6172 7365     ap = argparse
-0003e390: 2e41 7267 756d 656e 7450 6172 7365 7228  .ArgumentParser(
-0003e3a0: 0a20 2020 2020 2020 2061 6464 5f68 656c  .        add_hel
-0003e3b0: 703d 4661 6c73 652c 0a20 2020 2020 2020  p=False,.       
-0003e3c0: 2064 6573 6372 6970 7469 6f6e 3d28 6622   description=(f"
-0003e3d0: 5765 6c63 6f6d 6520 746f 207b 5052 4f47  Welcome to {PROG
-0003e3e0: 5f57 4954 484f 5554 5f45 5854 7d2c 2061  _WITHOUT_EXT}, a
-0003e3f0: 204d 6174 7269 7820 434c 4920 636c 6965   Matrix CLI clie
-0003e400: 6e74 2e20 2229 2c0a 2020 2020 2020 2020  nt. "),.        
-0003e410: 6570 696c 6f67 3d22 596f 7520 6172 6520  epilog="You are 
-0003e420: 7275 6e6e 696e 6720 220a 2020 2020 2020  running ".      
-0003e430: 2020 6622 7665 7273 696f 6e20 7b56 4552    f"version {VER
-0003e440: 5349 4f4e 4e52 7d20 7b56 4552 5349 4f4e  SIONNR} {VERSION
-0003e450: 7d2e 2045 6e6a 6f79 2c20 7374 6172 206f  }. Enjoy, star o
-0003e460: 6e20 4769 7468 7562 2061 6e64 2022 0a20  n Github and ". 
-0003e470: 2020 2020 2020 2022 636f 6e74 7269 6275         "contribu
-0003e480: 7465 2062 7920 7375 626d 6974 7469 6e67  te by submitting
-0003e490: 2061 2050 756c 6c20 5265 7175 6573 742e   a Pull Request.
-0003e4a0: 2022 0a20 2020 2020 2020 2066 2241 6c73   ".        f"Als
-0003e4b0: 6f20 6861 7665 2061 206c 6f6f 6b20 6174  o have a look at
-0003e4c0: 207b 5052 4f47 5f57 4954 484f 5554 5f45   {PROG_WITHOUT_E
-0003e4d0: 5854 7d2d 7475 692e 2022 2c0a 2020 2020  XT}-tui. ",.    
-0003e4e0: 290a 2020 2020 2320 2d68 2c20 7365 6520  ).    # -h, see 
-0003e4f0: 6164 645f 6865 6c70 3d46 616c 7365 0a20  add_help=False. 
-0003e500: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
-0003e510: 6e74 280a 2020 2020 2020 2020 2320 7365  nt(.        # se
-0003e520: 6520 7363 7269 7074 2063 7265 6174 6520  e script create 
-0003e530: 6865 6c70 2e68 656c 702e 7478 740a 2020  help.help.txt.  
-0003e540: 2020 2020 2020 2320 6865 6c70 2073 7472        # help str
-0003e550: 696e 6720 7570 2074 6f20 6275 7420 6578  ing up to but ex
-0003e560: 636c 7564 696e 6720 2244 6574 6169 6c73  cluding "Details
-0003e570: 3a3a 2220 6973 2075 7365 6420 666f 720a  ::" is used for.
-0003e580: 2020 2020 2020 2020 2320 2873 686f 7274          # (short
-0003e590: 2920 602d 2d68 656c 7060 2e20 5468 6520  ) `--help`. The 
-0003e5a0: 6675 6c6c 2074 6578 7420 7769 6c6c 2062  full text will b
-0003e5b0: 6520 7573 6564 2066 6f72 206c 6f6e 6720  e used for long 
-0003e5c0: 602d 2d6d 616e 7561 6c60 2e0a 2020 2020  `--manual`..    
-0003e5d0: 2020 2020 222d 2d75 7361 6765 222c 0a20      "--usage",. 
-0003e5e0: 2020 2020 2020 2072 6571 7569 7265 643d         required=
-0003e5f0: 4661 6c73 652c 0a20 2020 2020 2020 2061  False,.        a
-0003e600: 6374 696f 6e3d 2273 746f 7265 5f74 7275  ction="store_tru
-0003e610: 6522 2c0a 2020 2020 2020 2020 6865 6c70  e",.        help
-0003e620: 3d22 5072 696e 7420 7573 6167 652e 2022  ="Print usage. "
-0003e630: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
-0003e640: 733a 3a20 5365 6520 616c 736f 202d 2d68  s:: See also --h
-0003e650: 656c 7020 666f 7220 7072 696e 7469 6e67  elp for printing
-0003e660: 2061 2062 6974 206d 6f72 6520 616e 6420   a bit more and 
-0003e670: 2d2d 6d61 6e75 616c 2022 0a20 2020 2020  --manual ".     
-0003e680: 2020 2022 666f 7220 7072 696e 7469 6e67     "for printing
-0003e690: 2061 206c 6f74 206d 6f72 6520 6465 7461   a lot more deta
-0003e6a0: 696c 6564 2069 6e66 6f72 6d61 7469 6f6e  iled information
-0003e6b0: 2e22 2c0a 2020 2020 290a 2020 2020 2320  .",.    ).    # 
-0003e6c0: 2d68 2c20 7365 6520 6164 645f 6865 6c70  -h, see add_help
-0003e6d0: 3d46 616c 7365 0a20 2020 2061 702e 6164  =False.    ap.ad
-0003e6e0: 645f 6172 6775 6d65 6e74 280a 2020 2020  d_argument(.    
-0003e6f0: 2020 2020 222d 6822 2c0a 2020 2020 2020      "-h",.      
-0003e700: 2020 222d 2d68 656c 7022 2c0a 2020 2020    "--help",.    
-0003e710: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
-0003e720: 7365 2c0a 2020 2020 2020 2020 6163 7469  se,.        acti
-0003e730: 6f6e 3d22 7374 6f72 655f 7472 7565 222c  on="store_true",
-0003e740: 0a20 2020 2020 2020 2068 656c 703d 2250  .        help="P
-0003e750: 7269 6e74 2068 656c 702e 2022 0a20 2020  rint help. ".   
-0003e760: 2020 2020 2022 4465 7461 696c 733a 3a20       "Details:: 
-0003e770: 5365 6520 616c 736f 202d 2d75 7361 6765  See also --usage
-0003e780: 2066 6f72 2070 7269 6e74 696e 6720 6576   for printing ev
-0003e790: 656e 206c 6573 7320 696e 666f 726d 6174  en less informat
-0003e7a0: 696f 6e2c 2022 0a20 2020 2020 2020 2022  ion, ".        "
-0003e7b0: 616e 6420 2d2d 6d61 6e75 616c 2066 6f72  and --manual for
-0003e7c0: 2070 7269 6e74 696e 6720 6d6f 7265 2064   printing more d
-0003e7d0: 6574 6169 6c65 6420 696e 666f 726d 6174  etailed informat
-0003e7e0: 696f 6e2e 222c 0a20 2020 2029 0a20 2020  ion.",.    ).   
-0003e7f0: 2023 2073 6565 202d 682c 2073 6565 2061   # see -h, see a
+00039c60: 6169 7420 696d 706c 6963 6974 5f6c 6f67  ait implicit_log
+00039c70: 696e 2829 0a20 2020 2020 2020 2069 6620  in().        if 
+00039c80: 6773 2e70 612e 7665 7269 6679 3a0a 2020  gs.pa.verify:.  
+00039c90: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+00039ca0: 6163 7469 6f6e 5f76 6572 6966 7928 290a  action_verify().
+00039cb0: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+00039cc0: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
+00039cd0: 2020 2020 2020 2020 2020 224b 6579 626f            "Keybo
+00039ce0: 6172 6420 696e 7465 7272 7570 7420 7265  ard interrupt re
+00039cf0: 6365 6976 6564 2061 6674 6572 2045 6d6f  ceived after Emo
+00039d00: 6a69 2076 6572 6966 6963 6174 696f 6e2e  ji verification.
+00039d10: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+00039d20: 2020 2020 2020 2020 726f 6f6d 735f 746f          rooms_to
+00039d30: 5f6c 6f6e 675f 726f 6f6d 5f6e 616d 6573  _long_room_names
+00039d40: 2829 2020 2320 636f 6d70 6c65 7465 2072  ()  # complete r
+00039d50: 6f6f 6d20 6e61 6d65 730a 2020 2020 2020  oom names.      
+00039d60: 2020 6966 2067 732e 726f 6f6d 5f61 6374    if gs.room_act
+00039d70: 696f 6e20 6f72 2067 732e 7365 7467 6574  ion or gs.setget
+00039d80: 5f61 6374 696f 6e3a 0a20 2020 2020 2020  _action:.       
+00039d90: 2020 2020 2061 7761 6974 2061 6374 696f       await actio
+00039da0: 6e5f 726f 6f6d 7365 7467 6574 2829 0a20  n_roomsetget(). 
+00039db0: 2020 2020 2020 2069 6620 6773 2e73 656e         if gs.sen
+00039dc0: 645f 6163 7469 6f6e 3a0a 2020 2020 2020  d_action:.      
+00039dd0: 2020 2020 2020 6177 6169 7420 6163 7469        await acti
+00039de0: 6f6e 5f73 656e 6428 290a 2020 2020 2020  on_send().      
+00039df0: 2020 6966 2067 732e 6c69 7374 656e 5f61    if gs.listen_a
+00039e00: 6374 696f 6e3a 0a20 2020 2020 2020 2020  ction:.         
+00039e10: 2020 2061 7761 6974 2061 6374 696f 6e5f     await action_
+00039e20: 6c69 7374 656e 2829 0a20 2020 2020 2020  listen().       
+00039e30: 2069 6620 6773 2e70 612e 6c6f 676f 7574   if gs.pa.logout
+00039e40: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
+00039e50: 6169 7420 6163 7469 6f6e 5f6c 6f67 6f75  ait action_logou
+00039e60: 7428 290a 2020 2020 6578 6365 7074 2045  t().    except E
+00039e70: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
+00039e80: 2020 7261 6973 650a 2020 2020 6669 6e61    raise.    fina
+00039e90: 6c6c 793a 0a20 2020 2020 2020 2069 6620  lly:.        if 
+00039ea0: 6773 2e63 6c69 656e 743a 0a20 2020 2020  gs.client:.     
+00039eb0: 2020 2020 2020 2061 7761 6974 2067 732e         await gs.
+00039ec0: 636c 6965 6e74 2e63 6c6f 7365 2829 0a0a  client.close()..
+00039ed0: 0a64 6566 2063 6865 636b 5f61 7267 5f66  .def check_arg_f
+00039ee0: 696c 6573 5f72 6561 6461 626c 6528 2920  iles_readable() 
+00039ef0: 2d3e 204e 6f6e 653a 0a20 2020 2022 2222  -> None:.    """
+00039f00: 4368 6563 6b20 6966 2066 696c 6573 2066  Check if files f
+00039f10: 726f 6d20 636f 6d6d 616e 6420 6c69 6e65  rom command line
+00039f20: 2061 7265 2072 6561 6461 626c 652e 2222   are readable.""
+00039f30: 220a 2020 2020 6172 675f 6669 6c65 7320  ".    arg_files 
+00039f40: 3d20 6773 2e70 612e 696d 6167 6520 6966  = gs.pa.image if
+00039f50: 2067 732e 7061 2e69 6d61 6765 2065 6c73   gs.pa.image els
+00039f60: 6520 5b5d 0a20 2020 2061 7267 5f66 696c  e [].    arg_fil
+00039f70: 6573 202b 3d20 6773 2e70 612e 6175 6469  es += gs.pa.audi
+00039f80: 6f20 6966 2067 732e 7061 2e61 7564 696f  o if gs.pa.audio
+00039f90: 2065 6c73 6520 5b5d 0a20 2020 2061 7267   else [].    arg
+00039fa0: 5f66 696c 6573 202b 3d20 6773 2e70 612e  _files += gs.pa.
+00039fb0: 6669 6c65 2069 6620 6773 2e70 612e 6669  file if gs.pa.fi
+00039fc0: 6c65 2065 6c73 6520 5b5d 0a20 2020 2061  le else [].    a
+00039fd0: 7267 5f66 696c 6573 202b 3d20 6773 2e70  rg_files += gs.p
+00039fe0: 612e 6576 656e 7420 6966 2067 732e 7061  a.event if gs.pa
+00039ff0: 2e65 7665 6e74 2065 6c73 6520 5b5d 0a20  .event else []. 
+0003a000: 2020 2072 203d 2054 7275 650a 2020 2020     r = True.    
+0003a010: 6572 7274 7874 203d 2028 0a20 2020 2020  errtxt = (.     
+0003a020: 2020 2022 4532 3336 3a20 220a 2020 2020     "E236: ".    
+0003a030: 2020 2020 2254 6865 7365 2066 696c 6573      "These files
+0003a040: 2073 7065 6369 6669 6564 2069 6e20 7468   specified in th
+0003a050: 6520 636f 6d6d 616e 6420 6c69 6e65 2077  e command line w
+0003a060: 6572 6520 6e6f 7420 666f 756e 6420 220a  ere not found ".
+0003a070: 2020 2020 2020 2020 226f 7220 6172 6520          "or are 
+0003a080: 6e6f 7420 7265 6164 6162 6c65 3a20 220a  not readable: ".
+0003a090: 2020 2020 290a 2020 2020 666f 7220 666e      ).    for fn
+0003a0a0: 2069 6e20 6172 675f 6669 6c65 733a 0a20   in arg_files:. 
+0003a0b0: 2020 2020 2020 2069 6620 2866 6e20 213d         if (fn !=
+0003a0c0: 2022 2d22 2920 616e 6420 6e6f 7420 2869   "-") and not (i
+0003a0d0: 7366 696c 6528 666e 2920 616e 6420 6163  sfile(fn) and ac
+0003a0e0: 6365 7373 2866 6e2c 2052 5f4f 4b29 293a  cess(fn, R_OK)):
+0003a0f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0003a100: 6e6f 7420 723a 0a20 2020 2020 2020 2020  not r:.         
+0003a110: 2020 2020 2020 2065 7272 7478 7420 2b3d         errtxt +=
+0003a120: 2022 2c20 220a 2020 2020 2020 2020 2020   ", ".          
+0003a130: 2020 6572 7274 7874 202b 3d20 6627 227b    errtxt += f'"{
+0003a140: 666e 7d22 270a 2020 2020 2020 2020 2020  fn}"'.          
+0003a150: 2020 7220 3d20 4661 6c73 650a 2020 2020    r = False.    
+0003a160: 2020 2020 2020 2020 6572 7266 696c 6520          errfile 
+0003a170: 3d20 666e 0a20 2020 2069 6620 6e6f 7420  = fn.    if not 
+0003a180: 723a 0a20 2020 2020 2020 2072 6169 7365  r:.        raise
+0003a190: 2046 696c 654e 6f74 466f 756e 6445 7272   FileNotFoundErr
+0003a1a0: 6f72 2865 7272 6e6f 2e45 4e4f 454e 542c  or(errno.ENOENT,
+0003a1b0: 2065 7272 7478 742c 2065 7272 6669 6c65   errtxt, errfile
+0003a1c0: 290a 0a0a 6465 6620 6368 6563 6b5f 646f  )...def check_do
+0003a1d0: 776e 6c6f 6164 5f6d 6564 6961 5f64 6972  wnload_media_dir
+0003a1e0: 2829 202d 3e20 4e6f 6e65 3a0a 2020 2020  () -> None:.    
+0003a1f0: 2222 2243 6865 636b 2069 6620 6d65 6469  """Check if medi
+0003a200: 6120 646f 776e 6c6f 6164 2064 6972 6563  a download direc
+0003a210: 746f 7279 2069 7320 636f 7272 6563 742e  tory is correct.
+0003a220: 2222 220a 2020 2020 6966 206e 6f74 2067  """.    if not g
+0003a230: 732e 7061 2e64 6f77 6e6c 6f61 645f 6d65  s.pa.download_me
+0003a240: 6469 613a 0a20 2020 2020 2020 2072 6574  dia:.        ret
+0003a250: 7572 6e20 2023 2022 223a 2074 6861 7420  urn  # "": that 
+0003a260: 6d65 616e 7320 6e6f 2064 6f77 6e6c 6f61  means no downloa
+0003a270: 6420 6f66 206d 6564 6961 2c20 7661 6c69  d of media, vali
+0003a280: 6420 7661 6c75 650a 2020 2020 2320 6e6f  d value.    # no
+0003a290: 726d 6169 6c7a 6564 2066 6f72 2068 756d  rmailzed for hum
+0003a2a0: 616e 730a 2020 2020 646c 203d 206f 732e  ans.    dl = os.
+0003a2b0: 7061 7468 2e6e 6f72 6d70 6174 6828 6773  path.normpath(gs
+0003a2c0: 2e70 612e 646f 776e 6c6f 6164 5f6d 6564  .pa.download_med
+0003a2d0: 6961 290a 2020 2020 6773 2e70 612e 646f  ia).    gs.pa.do
+0003a2e0: 776e 6c6f 6164 5f6d 6564 6961 203d 2064  wnload_media = d
+0003a2f0: 6c0a 2020 2020 6966 206f 732e 7061 7468  l.    if os.path
+0003a300: 2e69 7366 696c 6528 646c 293a 0a20 2020  .isfile(dl):.   
+0003a310: 2020 2020 2072 6169 7365 204e 6f74 4144       raise NotAD
+0003a320: 6972 6563 746f 7279 4572 726f 7228 0a20  irectoryError(. 
+0003a330: 2020 2020 2020 2020 2020 2065 7272 6e6f             errno
+0003a340: 2e45 4e4f 5444 4952 2c0a 2020 2020 2020  .ENOTDIR,.      
+0003a350: 2020 2020 2020 2245 3233 373a 2022 0a20        "E237: ". 
+0003a360: 2020 2020 2020 2020 2020 2066 2722 7b64             f'"{d
+0003a370: 6c7d 2220 6361 6e6e 6f74 2062 6520 7573  l}" cannot be us
+0003a380: 6564 2061 7320 6d65 6469 6120 6469 7265  ed as media dire
+0003a390: 6374 6f72 792c 2062 6563 6175 7365 2027  ctory, because '
+0003a3a0: 0a20 2020 2020 2020 2020 2020 2066 2722  .            f'"
+0003a3b0: 7b64 6c7d 2220 6973 2061 2066 696c 652e  {dl}" is a file.
+0003a3c0: 2053 7065 6369 6679 2061 2064 6966 6665   Specify a diffe
+0003a3d0: 7265 6e74 2064 6972 6563 746f 7279 2066  rent directory f
+0003a3e0: 6f72 2064 6f77 6e6c 6f61 6469 6e67 2027  or downloading '
+0003a3f0: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
+0003a400: 6469 612e 222c 0a20 2020 2020 2020 2020  dia.",.         
+0003a410: 2020 2064 6c2c 0a20 2020 2020 2020 2029     dl,.        )
+0003a420: 0a20 2020 2069 6620 6f73 2e70 6174 682e  .    if os.path.
+0003a430: 6973 6469 7228 646c 293a 0a20 2020 2020  isdir(dl):.     
+0003a440: 2020 2069 6620 6f73 2e61 6363 6573 7328     if os.access(
+0003a450: 646c 2c20 6f73 2e57 5f4f 4b29 3a20 2023  dl, os.W_OK):  #
+0003a460: 2043 6865 636b 2066 6f72 2077 7269 7465   Check for write
+0003a470: 2061 6363 6573 730a 2020 2020 2020 2020   access.        
+0003a480: 2020 2020 7265 7475 726e 2020 2320 616c      return  # al
+0003a490: 6c20 4f4b 0a20 2020 2020 2020 2065 6c73  l OK.        els
+0003a4a0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0003a4b0: 6169 7365 2050 6572 6d69 7373 696f 6e45  aise PermissionE
+0003a4c0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+0003a4d0: 2020 2020 2020 6572 726e 6f2e 4550 4552        errno.EPER
+0003a4e0: 4d2c 0a20 2020 2020 2020 2020 2020 2020  M,.             
+0003a4f0: 2020 2022 4532 3338 3a20 220a 2020 2020     "E238: ".    
+0003a500: 2020 2020 2020 2020 2020 2020 2246 6f75              "Fou
+0003a510: 6e64 2061 6e20 6578 6973 7469 6e67 206d  nd an existing m
+0003a520: 6564 6961 2064 6f77 6e6c 6f61 6420 6469  edia download di
+0003a530: 7265 6374 6f72 7920 220a 2020 2020 2020  rectory ".      
+0003a540: 2020 2020 2020 2020 2020 6627 227b 646c            f'"{dl
+0003a550: 7d22 2e20 4275 7420 7468 6973 2064 6972  }". But this dir
+0003a560: 6563 746f 7279 2069 7320 6c61 636b 696e  ectory is lackin
+0003a570: 6720 7772 6974 6520 270a 2020 2020 2020  g write '.      
+0003a580: 2020 2020 2020 2020 2020 2270 6572 6d69            "permi
+0003a590: 7373 696f 6e73 2e20 4164 6420 7772 6974  ssions. Add writ
+0003a5a0: 6520 7065 726d 6973 7369 6f6e 7320 746f  e permissions to
+0003a5b0: 2069 742e 222c 0a20 2020 2020 2020 2020   it.",.         
+0003a5c0: 2020 2020 2020 2064 6c2c 0a20 2020 2020         dl,.     
+0003a5d0: 2020 2020 2020 2029 0a20 2020 2065 6c73         ).    els
+0003a5e0: 653a 0a20 2020 2020 2020 2023 206e 6f74  e:.        # not
+0003a5f0: 2061 2066 696c 652c 206e 6f74 2061 2064   a file, not a d
+0003a600: 6972 6563 746f 7279 2c20 6372 6561 7465  irectory, create
+0003a610: 2064 6972 6563 746f 7279 0a20 2020 2020   directory.     
+0003a620: 2020 206d 6f64 6520 3d20 306f 3737 370a     mode = 0o777.
+0003a630: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0003a640: 2020 2020 2020 2020 206f 732e 6d6b 6469           os.mkdi
+0003a650: 7228 646c 2c20 6d6f 6465 290a 2020 2020  r(dl, mode).    
+0003a660: 2020 2020 6578 6365 7074 204f 5345 7272      except OSErr
+0003a670: 6f72 2061 7320 653a 0a20 2020 2020 2020  or as e:.       
+0003a680: 2020 2020 2072 6169 7365 204f 5345 7272       raise OSErr
+0003a690: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+0003a6a0: 2020 2020 652e 6572 726e 6f2c 0a20 2020      e.errno,.   
+0003a6b0: 2020 2020 2020 2020 2020 2020 2022 4532               "E2
+0003a6c0: 3339 3a20 220a 2020 2020 2020 2020 2020  39: ".          
+0003a6d0: 2020 2020 2020 2243 6f75 6c64 206e 6f74        "Could not
+0003a6e0: 2063 7265 6174 6520 6d65 6469 6120 646f   create media do
+0003a6f0: 776e 6c6f 6164 2064 6972 6563 746f 7279  wnload directory
+0003a700: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+0003a710: 2020 2066 227b 646c 7d20 666f 7220 796f     f"{dl} for yo
+0003a720: 752e 2028 7b65 7d29 222c 0a20 2020 2020  u. ({e})",.     
+0003a730: 2020 2020 2020 2020 2020 2064 6c2c 0a20             dl,. 
+0003a740: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0003a750: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
+0003a760: 6728 6627 4372 6561 7465 6420 6d65 6469  g(f'Created medi
+0003a770: 6120 646f 776e 6c6f 6164 2064 6972 6563  a download direc
+0003a780: 746f 7279 2022 7b64 6c7d 2220 666f 7220  tory "{dl}" for 
+0003a790: 796f 752e 2729 0a0a 0a64 6566 2063 6865  you.')...def che
+0003a7a0: 636b 5f76 6572 7369 6f6e 2829 202d 3e20  ck_version() -> 
+0003a7b0: 4e6f 6e65 3a0a 2020 2020 2222 2243 6865  None:.    """Che
+0003a7c0: 636b 2069 6620 6c61 7465 7374 2076 6572  ck if latest ver
+0003a7d0: 7369 6f6e 2e22 2222 0a20 2020 2070 6b67  sion.""".    pkg
+0003a7e0: 203d 2050 524f 475f 5749 5448 4f55 545f   = PROG_WITHOUT_
+0003a7f0: 4558 540a 2020 2020 7665 7220 3d20 5645  EXT.    ver = VE
+0003a800: 5253 494f 4e4e 5220 2023 2064 6566 6175  RSIONNR  # defau
+0003a810: 6c74 2c20 6661 6c6c 6261 636b 0a20 2020  lt, fallback.   
+0003a820: 2074 7279 3a0a 2020 2020 2020 2020 7665   try:.        ve
+0003a830: 7220 3d20 706b 675f 7265 736f 7572 6365  r = pkg_resource
+0003a840: 732e 6765 745f 6469 7374 7269 6275 7469  s.get_distributi
+0003a850: 6f6e 2870 6b67 292e 7665 7273 696f 6e0a  on(pkg).version.
+0003a860: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+0003a870: 7469 6f6e 3a0a 2020 2020 2020 2020 7061  tion:.        pa
+0003a880: 7373 2020 2320 6966 2069 6e73 7461 6c6c  ss  # if install
+0003a890: 6564 2076 6961 2067 6974 2063 6c6f 6e65  ed via git clone
+0003a8a0: 2c20 7061 636b 6167 6520 7769 6c6c 206e  , package will n
+0003a8b0: 6f74 2065 7869 7374 730a 0a20 2020 2069  ot exists..    i
+0003a8c0: 6e73 7461 6c6c 6564 5f76 6572 7369 6f6e  nstalled_version
+0003a8d0: 203d 204c 6f6f 7365 5665 7273 696f 6e28   = LooseVersion(
+0003a8e0: 7665 7229 0a20 2020 2023 2066 6574 6368  ver).    # fetch
+0003a8f0: 2070 6163 6b61 6765 206d 6574 6164 6174   package metadat
+0003a900: 6120 6672 6f6d 2050 7950 490a 2020 2020  a from PyPI.    
+0003a910: 7079 7069 5f75 726c 203d 2066 2268 7474  pypi_url = f"htt
+0003a920: 7073 3a2f 2f70 7970 692e 6f72 672f 7079  ps://pypi.org/py
+0003a930: 7069 2f7b 706b 677d 2f6a 736f 6e22 0a20  pi/{pkg}/json". 
+0003a940: 2020 2072 6573 706f 6e73 6520 3d20 7572     response = ur
+0003a950: 6c6c 6962 2e72 6571 7565 7374 2e75 726c  llib.request.url
+0003a960: 6f70 656e 2870 7970 695f 7572 6c29 2e72  open(pypi_url).r
+0003a970: 6561 6428 292e 6465 636f 6465 2829 0a20  ead().decode(). 
+0003a980: 2020 206c 6174 6573 745f 7665 7273 696f     latest_versio
+0003a990: 6e20 3d20 6d61 7828 0a20 2020 2020 2020  n = max(.       
+0003a9a0: 204c 6f6f 7365 5665 7273 696f 6e28 7329   LooseVersion(s)
+0003a9b0: 2066 6f72 2073 2069 6e20 6a73 6f6e 2e6c   for s in json.l
+0003a9c0: 6f61 6473 2872 6573 706f 6e73 6529 5b22  oads(response)["
+0003a9d0: 7265 6c65 6173 6573 225d 2e6b 6579 7328  releases"].keys(
+0003a9e0: 290a 2020 2020 290a 2020 2020 6966 2069  ).    ).    if i
+0003a9f0: 6e73 7461 6c6c 6564 5f76 6572 7369 6f6e  nstalled_version
+0003aa00: 203e 3d20 6c61 7465 7374 5f76 6572 7369   >= latest_versi
+0003aa10: 6f6e 3a0a 2020 2020 2020 2020 7574 6420  on:.        utd 
+0003aa20: 3d20 2259 6f75 2061 7265 2075 702d 746f  = "You are up-to
+0003aa30: 2d64 6174 6521 220a 2020 2020 656c 7365  -date!".    else
+0003aa40: 3a0a 2020 2020 2020 2020 7574 6420 3d20  :.        utd = 
+0003aa50: 2243 6f6e 7369 6465 7220 7570 6461 7469  "Consider updati
+0003aa60: 6e67 2122 0a20 2020 2076 6572 7369 6f6e  ng!".    version
+0003aa70: 5f69 6e66 6f20 3d20 280a 2020 2020 2020  _info = (.      
+0003aa80: 2020 6622 7061 636b 6167 653a 207b 706b    f"package: {pk
+0003aa90: 677d 2c20 696e 7374 616c 6c65 643a 207b  g}, installed: {
+0003aaa0: 696e 7374 616c 6c65 645f 7665 7273 696f  installed_versio
+0003aab0: 6e7d 2c20 220a 2020 2020 2020 2020 6622  n}, ".        f"
+0003aac0: 6c61 7465 7374 3a20 7b6c 6174 6573 745f  latest: {latest_
+0003aad0: 7665 7273 696f 6e7d 203d 3d3e 207b 7574  version} ==> {ut
+0003aae0: 647d 220a 2020 2020 290a 2020 2020 6773  d}".    ).    gs
+0003aaf0: 2e6c 6f67 2e64 6562 7567 2876 6572 7369  .log.debug(versi
+0003ab00: 6f6e 5f69 6e66 6f29 0a20 2020 2023 206f  on_info).    # o
+0003ab10: 7574 7075 7420 666f 726d 6174 2063 6f6e  utput format con
+0003ab20: 7472 6f6c 6c65 6420 7669 6120 2d2d 6f75  trolled via --ou
+0003ab30: 7470 7574 2066 6c61 670a 2020 2020 7465  tput flag.    te
+0003ab40: 7874 203d 2076 6572 7369 6f6e 5f69 6e66  xt = version_inf
+0003ab50: 6f0a 2020 2020 6a73 6f6e 5f6d 6178 203d  o.    json_max =
+0003ab60: 207b 0a20 2020 2020 2020 2022 7061 636b   {.        "pack
+0003ab70: 6167 6522 3a20 6622 7b70 6b67 7d22 2c0a  age": f"{pkg}",.
+0003ab80: 2020 2020 2020 2020 2276 6572 7369 6f6e          "version
+0003ab90: 5f69 6e73 7461 6c6c 6564 223a 2066 227b  _installed": f"{
+0003aba0: 696e 7374 616c 6c65 645f 7665 7273 696f  installed_versio
+0003abb0: 6e7d 222c 0a20 2020 2020 2020 2022 7665  n}",.        "ve
+0003abc0: 7273 696f 6e5f 6c61 7465 7374 223a 2066  rsion_latest": f
+0003abd0: 227b 6c61 7465 7374 5f76 6572 7369 6f6e  "{latest_version
+0003abe0: 7d22 2c0a 2020 2020 2020 2020 2263 6f6d  }",.        "com
+0003abf0: 6d65 6e74 223a 2066 227b 7574 647d 222c  ment": f"{utd}",
+0003ac00: 0a20 2020 207d 0a20 2020 2023 206a 736f  .    }.    # jso
+0003ac10: 6e5f 6d61 782e 7570 6461 7465 287b 226b  n_max.update({"k
+0003ac20: 6579 223a 2076 616c 7565 7d29 2020 2320  ey": value})  # 
+0003ac30: 6164 6420 6469 6374 2069 7465 6d73 0a20  add dict items. 
+0003ac40: 2020 206a 736f 6e5f 203d 206a 736f 6e5f     json_ = json_
+0003ac50: 6d61 782e 636f 7079 2829 0a20 2020 2023  max.copy().    #
+0003ac60: 206a 736f 6e5f 2e70 6f70 2822 6b65 7922   json_.pop("key"
+0003ac70: 290a 2020 2020 6a73 6f6e 5f73 7065 6320  ).    json_spec 
+0003ac80: 3d20 4e6f 6e65 0a20 2020 2070 7269 6e74  = None.    print
+0003ac90: 5f6f 7574 7075 7428 0a20 2020 2020 2020  _output(.       
+0003aca0: 2067 732e 7061 2e6f 7574 7075 742c 0a20   gs.pa.output,. 
+0003acb0: 2020 2020 2020 2074 6578 743d 7465 7874         text=text
+0003acc0: 2c0a 2020 2020 2020 2020 6a73 6f6e 5f3d  ,.        json_=
+0003acd0: 6a73 6f6e 5f2c 0a20 2020 2020 2020 206a  json_,.        j
+0003ace0: 736f 6e5f 6d61 783d 6a73 6f6e 5f6d 6178  son_max=json_max
+0003acf0: 2c0a 2020 2020 2020 2020 6a73 6f6e 5f73  ,.        json_s
+0003ad00: 7065 633d 6a73 6f6e 5f73 7065 632c 0a20  pec=json_spec,. 
+0003ad10: 2020 2029 0a0a 0a64 6566 2076 6572 7369     )...def versi
+0003ad20: 6f6e 2829 202d 3e20 4e6f 6e65 3a0a 2020  on() -> None:.  
+0003ad30: 2020 2222 2250 7269 6e74 2076 6572 7369    """Print versi
+0003ad40: 6f6e 2069 6e66 6f2e 2222 220a 2020 2020  on info.""".    
+0003ad50: 6e69 6f5f 7665 7273 696f 6e20 3d20 706b  nio_version = pk
+0003ad60: 675f 7265 736f 7572 6365 732e 6765 745f  g_resources.get_
+0003ad70: 6469 7374 7269 6275 7469 6f6e 2822 6d61  distribution("ma
+0003ad80: 7472 6978 2d6e 696f 2229 2e76 6572 7369  trix-nio").versi
+0003ad90: 6f6e 0a20 2020 2070 7974 686f 6e5f 7665  on.    python_ve
+0003ada0: 7273 696f 6e20 3d20 7379 732e 7665 7273  rsion = sys.vers
+0003adb0: 696f 6e0a 2020 2020 7079 7468 6f6e 5f76  ion.    python_v
+0003adc0: 6572 7369 6f6e 5f6e 7220 3d20 280a 2020  ersion_nr = (.  
+0003add0: 2020 2020 2020 7374 7228 7379 732e 7665        str(sys.ve
+0003ade0: 7273 696f 6e5f 696e 666f 2e6d 616a 6f72  rsion_info.major
+0003adf0: 290a 2020 2020 2020 2020 2b20 222e 220a  ).        + ".".
+0003ae00: 2020 2020 2020 2020 2b20 7374 7228 7379          + str(sy
+0003ae10: 732e 7665 7273 696f 6e5f 696e 666f 2e6d  s.version_info.m
+0003ae20: 696e 6f72 290a 2020 2020 2020 2020 2b20  inor).        + 
+0003ae30: 222e 220a 2020 2020 2020 2020 2b20 7374  ".".        + st
+0003ae40: 7228 7379 732e 7665 7273 696f 6e5f 696e  r(sys.version_in
+0003ae50: 666f 2e6d 6963 726f 290a 2020 2020 290a  fo.micro).    ).
+0003ae60: 2020 2020 7665 7273 696f 6e5f 696e 666f      version_info
+0003ae70: 203d 2028 0a20 2020 2020 2020 2022 5c6e   = (.        "\n
+0003ae80: 220a 2020 2020 2020 2020 6622 2020 5f7c  ".        f"  _|
+0003ae90: 2020 2020 2020 5f7c 2020 2020 2020 5f7c        _|      _|
+0003aea0: 5f7c 5f7c 2020 2020 5f7c 2020 2020 2020  _|_|    _|      
+0003aeb0: 207b 5052 4f47 5f57 4954 484f 5554 5f45   {PROG_WITHOUT_E
+0003aec0: 5854 7d3a 2022 0a20 2020 2020 2020 2066  XT}: ".        f
+0003aed0: 227b 5645 5253 494f 4e4e 527d 207b 5645  "{VERSIONNR} {VE
+0003aee0: 5253 494f 4e7d 5c6e 220a 2020 2020 2020  RSION}\n".      
+0003aef0: 2020 2220 205f 7c5f 7c20 205f 7c5f 7c20    "  _|_|  _|_| 
+0003af00: 2020 205f 7c20 2020 2020 2020 2020 2020     _|           
+0003af10: 205f 7c20 2020 2020 6120 4d61 7472 6978   _|     a Matrix
+0003af20: 2043 4c49 2063 6c69 656e 745c 6e22 0a20   CLI client\n". 
+0003af30: 2020 2020 2020 2022 2020 5f7c 2020 5f7c         "  _|  _|
+0003af40: 2020 5f7c 2020 2020 5f7c 2020 2020 2020    _|    _|      
+0003af50: 2020 2020 2020 2020 5f7c 2020 2065 6e6a          _|   enj
+0003af60: 6f79 2061 6e64 2073 7562 6d69 7420 5052  oy and submit PR
+0003af70: 735c 6e22 0a20 2020 2020 2020 2066 2220  s\n".        f" 
+0003af80: 205f 7c20 2020 2020 205f 7c20 2020 205f   _|      _|    _
+0003af90: 7c20 2020 2020 2020 2020 2020 205f 7c20  |            _| 
+0003afa0: 2020 2020 6d61 7472 6978 2d6e 696f 3a20      matrix-nio: 
+0003afb0: 7b6e 696f 5f76 6572 7369 6f6e 7d5c 6e22  {nio_version}\n"
+0003afc0: 0a20 2020 2020 2020 2066 2220 205f 7c20  .        f"  _| 
+0003afd0: 2020 2020 205f 7c20 2020 2020 205f 7c5f       _|      _|_
+0003afe0: 7c5f 7c20 2020 205f 7c20 2020 2020 2020  |_|    _|       
+0003aff0: 5079 7468 6f6e 3a20 7b70 7974 686f 6e5f  Python: {python_
+0003b000: 7665 7273 696f 6e5f 6e72 7d5c 6e22 0a20  version_nr}\n". 
+0003b010: 2020 2020 2020 2022 5c6e 220a 2020 2020         "\n".    
+0003b020: 290a 2020 2020 6773 2e6c 6f67 2e64 6562  ).    gs.log.deb
+0003b030: 7567 2876 6572 7369 6f6e 5f69 6e66 6f29  ug(version_info)
+0003b040: 0a20 2020 2023 206f 7574 7075 7420 666f  .    # output fo
+0003b050: 726d 6174 2063 6f6e 7472 6f6c 6c65 6420  rmat controlled 
+0003b060: 7669 6120 2d2d 6f75 7470 7574 2066 6c61  via --output fla
+0003b070: 670a 2020 2020 7465 7874 203d 2076 6572  g.    text = ver
+0003b080: 7369 6f6e 5f69 6e66 6f0a 2020 2020 6a73  sion_info.    js
+0003b090: 6f6e 5f6d 6178 203d 207b 0a20 2020 2020  on_max = {.     
+0003b0a0: 2020 2066 227b 5052 4f47 5f57 4954 484f     f"{PROG_WITHO
+0003b0b0: 5554 5f45 5854 7d22 3a20 7b0a 2020 2020  UT_EXT}": {.    
+0003b0c0: 2020 2020 2020 2020 2276 6572 7369 6f6e          "version
+0003b0d0: 223a 2066 227b 5645 5253 494f 4e4e 527d  ": f"{VERSIONNR}
+0003b0e0: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+0003b0f0: 6461 7465 223a 2066 227b 5645 5253 494f  date": f"{VERSIO
+0003b100: 4e7d 222c 0a20 2020 2020 2020 207d 2c0a  N}",.        },.
+0003b110: 2020 2020 2020 2020 226d 6174 7269 782d          "matrix-
+0003b120: 6e69 6f22 3a20 7b0a 2020 2020 2020 2020  nio": {.        
+0003b130: 2020 2020 2276 6572 7369 6f6e 223a 2066      "version": f
+0003b140: 227b 6e69 6f5f 7665 7273 696f 6e7d 222c  "{nio_version}",
+0003b150: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
+0003b160: 2020 2020 2270 7974 686f 6e22 3a20 7b0a      "python": {.
+0003b170: 2020 2020 2020 2020 2020 2020 2276 6572              "ver
+0003b180: 7369 6f6e 223a 2066 227b 7079 7468 6f6e  sion": f"{python
+0003b190: 5f76 6572 7369 6f6e 5f6e 727d 222c 0a20  _version_nr}",. 
+0003b1a0: 2020 2020 2020 2020 2020 2022 696e 666f             "info
+0003b1b0: 223a 2066 227b 7079 7468 6f6e 5f76 6572  ": f"{python_ver
+0003b1c0: 7369 6f6e 7d22 2c0a 2020 2020 2020 2020  sion}",.        
+0003b1d0: 7d2c 0a20 2020 207d 0a20 2020 2023 206a  },.    }.    # j
+0003b1e0: 736f 6e5f 6d61 782e 7570 6461 7465 287b  son_max.update({
+0003b1f0: 226b 6579 223a 2076 616c 7565 7d29 2020  "key": value})  
+0003b200: 2320 6164 6420 6469 6374 2069 7465 6d73  # add dict items
+0003b210: 0a20 2020 206a 736f 6e5f 203d 206a 736f  .    json_ = jso
+0003b220: 6e5f 6d61 782e 636f 7079 2829 0a20 2020  n_max.copy().   
+0003b230: 2023 206a 736f 6e5f 2e70 6f70 2822 6b65   # json_.pop("ke
+0003b240: 7922 290a 2020 2020 6a73 6f6e 5f73 7065  y").    json_spe
+0003b250: 6320 3d20 4e6f 6e65 0a20 2020 2070 7269  c = None.    pri
+0003b260: 6e74 5f6f 7574 7075 7428 0a20 2020 2020  nt_output(.     
+0003b270: 2020 2067 732e 7061 2e6f 7574 7075 742c     gs.pa.output,
+0003b280: 0a20 2020 2020 2020 2074 6578 743d 7465  .        text=te
+0003b290: 7874 2c0a 2020 2020 2020 2020 6a73 6f6e  xt,.        json
+0003b2a0: 5f3d 6a73 6f6e 5f2c 0a20 2020 2020 2020  _=json_,.       
+0003b2b0: 206a 736f 6e5f 6d61 783d 6a73 6f6e 5f6d   json_max=json_m
+0003b2c0: 6178 2c0a 2020 2020 2020 2020 6a73 6f6e  ax,.        json
+0003b2d0: 5f73 7065 633d 6a73 6f6e 5f73 7065 632c  _spec=json_spec,
+0003b2e0: 0a20 2020 2029 0a0a 0a64 6566 2069 6e69  .    )...def ini
+0003b2f0: 7469 616c 5f63 6865 636b 5f6f 665f 6c6f  tial_check_of_lo
+0003b300: 675f 6172 6773 2829 202d 3e20 4e6f 6e65  g_args() -> None
+0003b310: 3a0a 2020 2020 2222 2243 6865 636b 206c  :.    """Check l
+0003b320: 6f67 6769 6e67 2072 656c 6174 6564 2061  ogging related a
+0003b330: 7267 756d 656e 7473 2e0a 0a20 2020 2041  rguments...    A
+0003b340: 7267 756d 656e 7473 3a0a 2020 2020 2d2d  rguments:.    --
+0003b350: 2d2d 2d2d 2d2d 2d0a 2020 2020 4e6f 6e65  -------.    None
+0003b360: 0a0a 2020 2020 5265 7475 726e 733a 204e  ..    Returns: N
+0003b370: 6f6e 650a 0a20 2020 2052 6169 7365 7320  one..    Raises 
+0003b380: 6578 6365 7074 696f 6e20 6f6e 2065 7272  exception on err
+0003b390: 6f72 2e0a 2020 2020 2222 220a 2020 2020  or..    """.    
+0003b3a0: 6966 206e 6f74 2067 732e 7061 2e6c 6f67  if not gs.pa.log
+0003b3b0: 5f6c 6576 656c 3a0a 2020 2020 2020 2020  _level:.        
+0003b3c0: 7265 7475 726e 2020 2320 616c 6c20 4f4b  return  # all OK
+0003b3d0: 0a20 2020 2066 6f72 2069 2069 6e20 7261  .    for i in ra
+0003b3e0: 6e67 6528 6c65 6e28 6773 2e70 612e 6c6f  nge(len(gs.pa.lo
+0003b3f0: 675f 6c65 7665 6c29 293a 0a20 2020 2020  g_level)):.     
+0003b400: 2020 2075 7020 3d20 6773 2e70 612e 6c6f     up = gs.pa.lo
+0003b410: 675f 6c65 7665 6c5b 695d 2e75 7070 6572  g_level[i].upper
+0003b420: 2829 0a20 2020 2020 2020 2067 732e 7061  ().        gs.pa
+0003b430: 2e6c 6f67 5f6c 6576 656c 5b69 5d20 3d20  .log_level[i] = 
+0003b440: 7570 0a20 2020 2020 2020 2069 6620 7570  up.        if up
+0003b450: 206e 6f74 2069 6e20 5b22 4445 4255 4722   not in ["DEBUG"
+0003b460: 2c20 2249 4e46 4f22 2c20 2257 4152 4e49  , "INFO", "WARNI
+0003b470: 4e47 222c 2022 4552 524f 5222 2c20 2243  NG", "ERROR", "C
+0003b480: 5249 5449 4341 4c22 5d3a 0a20 2020 2020  RITICAL"]:.     
+0003b490: 2020 2020 2020 2023 2067 732e 6572 725f         # gs.err_
+0003b4a0: 636f 756e 7420 2b3d 2031 2020 2320 7772  count += 1  # wr
+0003b4b0: 6f6e 670a 2020 2020 2020 2020 2020 2020  ong.            
+0003b4c0: 7261 6973 6520 4d61 7472 6978 436f 6d6d  raise MatrixComm
+0003b4d0: 616e 6465 7245 7272 6f72 280a 2020 2020  anderError(.    
+0003b4e0: 2020 2020 2020 2020 2020 2020 2245 3234              "E24
+0003b4f0: 313a 2022 0a20 2020 2020 2020 2020 2020  1: ".           
+0003b500: 2020 2020 2027 2d2d 6c6f 672d 6c65 7665       '--log-leve
+0003b510: 6c20 6f6e 6c79 2061 6c6c 6f77 7320 7661  l only allows va
+0003b520: 6c75 6573 2022 4445 4255 4722 2c20 2249  lues "DEBUG", "I
+0003b530: 4e46 4f22 2c20 2257 4152 4e49 4e47 222c  NFO", "WARNING",
+0003b540: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0003b550: 2020 2027 2245 5252 4f52 222c 206f 7220     '"ERROR", or 
+0003b560: 2243 5249 5449 4341 4c22 2e20 2d2d 6c6f  "CRITICAL". --lo
+0003b570: 672d 6c65 7665 6c20 6172 6775 6d65 6e74  g-level argument
+0003b580: 2069 6e63 6f72 7265 6374 2e20 270a 2020   incorrect. '.  
+0003b590: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0003b5a0: 287b 7570 7d29 220a 2020 2020 2020 2020  ({up})".        
+0003b5b0: 2020 2020 2920 6672 6f6d 204e 6f6e 650a      ) from None.
+0003b5c0: 0a0a 2320 6163 636f 7264 696e 6720 746f  ..# according to
+0003b5d0: 2070 796c 616d 613a 2066 756e 6374 696f   pylama: functio
+0003b5e0: 6e20 746f 6f20 636f 6d70 6c65 783a 2043  n too complex: C
+0003b5f0: 3930 3120 2320 6e6f 7161 3a20 4339 3031  901 # noqa: C901
+0003b600: 0a64 6566 2069 6e69 7469 616c 5f63 6865  .def initial_che
+0003b610: 636b 5f6f 665f 6172 6773 2829 202d 3e20  ck_of_args() -> 
+0003b620: 4e6f 6e65 3a20 2023 206e 6f71 613a 2043  None:  # noqa: C
+0003b630: 3930 310a 2020 2020 2222 2243 6865 636b  901.    """Check
+0003b640: 2061 7267 756d 656e 7473 2e22 2222 0a20   arguments.""". 
+0003b650: 2020 2023 2046 6972 7374 2c20 7468 6520     # First, the 
+0003b660: 6164 6a75 7374 6d65 6e74 730a 2020 2020  adjustments.    
+0003b670: 6966 206e 6f74 2067 732e 7061 2e65 6e63  if not gs.pa.enc
+0003b680: 7279 7074 6564 3a0a 2020 2020 2020 2020  rypted:.        
+0003b690: 6773 2e70 612e 656e 6372 7970 7465 6420  gs.pa.encrypted 
+0003b6a0: 3d20 5472 7565 2020 2320 666f 7263 6520  = True  # force 
+0003b6b0: 6974 206f 6e0a 2020 2020 2020 2020 6773  it on.        gs
+0003b6c0: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
+0003b6d0: 2020 2020 2020 2020 2245 6e63 7279 7074          "Encrypt
+0003b6e0: 696f 6e20 6973 2061 6c77 6179 7320 656e  ion is always en
+0003b6f0: 6162 6c65 642e 2049 7420 6361 6e6e 6f74  abled. It cannot
+0003b700: 2062 6520 7475 726e 6564 206f 6666 2e20   be turned off. 
+0003b710: 220a 2020 2020 2020 2020 2020 2020 2255  ".            "U
+0003b720: 7365 202d 2d74 6169 6c20 746f 2064 6973  se --tail to dis
+0003b730: 6162 6c65 2069 7420 666f 7220 7370 6563  able it for spec
+0003b740: 6966 6963 2075 7365 2063 6173 6573 2e22  ific use cases."
+0003b750: 0a20 2020 2020 2020 2029 0a20 2020 2069  .        ).    i
+0003b760: 6620 6e6f 7420 6773 2e70 612e 656e 6372  f not gs.pa.encr
+0003b770: 7970 7465 643a 2020 2320 6a75 7374 2069  ypted:  # just i
+0003b780: 6e20 6361 7365 2077 6520 6576 6572 2067  n case we ever g
+0003b790: 6f20 6261 636b 2064 6973 6162 6c69 6e67  o back disabling
+0003b7a0: 2065 3265 0a20 2020 2020 2020 2067 732e   e2e.        gs.
+0003b7b0: 7061 2e73 746f 7265 203d 204e 6f6e 650a  pa.store = None.
+0003b7c0: 2020 2020 6966 2067 732e 7061 2e6c 6973      if gs.pa.lis
+0003b7d0: 7465 6e3a 0a20 2020 2020 2020 2067 732e  ten:.        gs.
+0003b7e0: 7061 2e6c 6973 7465 6e20 3d20 6773 2e70  pa.listen = gs.p
+0003b7f0: 612e 6c69 7374 656e 2e6c 6f77 6572 2829  a.listen.lower()
+0003b800: 0a20 2020 2069 6620 6773 2e70 612e 6c69  .    if gs.pa.li
+0003b810: 7374 656e 203d 3d20 4e45 5645 5220 616e  sten == NEVER an
+0003b820: 6420 6773 2e70 612e 7461 696c 2021 3d20  d gs.pa.tail != 
+0003b830: 303a 0a20 2020 2020 2020 2067 732e 7061  0:.        gs.pa
+0003b840: 2e6c 6973 7465 6e20 3d20 5441 494c 2020  .listen = TAIL  
+0003b850: 2320 2d2d 7461 696c 2074 7572 6e73 206f  # --tail turns o
+0003b860: 6e20 2d2d 6c69 7374 656e 2054 4149 4c0a  n --listen TAIL.
+0003b870: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+0003b880: 6562 7567 2827 2d2d 6c69 7374 656e 2073  ebug('--listen s
+0003b890: 6574 2074 6f20 2274 6169 6c22 2062 6563  et to "tail" bec
+0003b8a0: 6175 7365 2022 2d2d 7461 696c 2220 6973  ause "--tail" is
+0003b8b0: 2075 7365 642e 2729 0a20 2020 2069 6620   used.').    if 
+0003b8c0: 6773 2e70 612e 7379 6e63 2069 7320 6e6f  gs.pa.sync is no
+0003b8d0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0003b8e0: 6773 2e70 612e 7379 6e63 203d 2067 732e  gs.pa.sync = gs.
+0003b8f0: 7061 2e73 796e 632e 6c6f 7765 7228 290a  pa.sync.lower().
+0003b900: 2020 2020 6966 2067 732e 7061 2e6f 7574      if gs.pa.out
+0003b910: 7075 7420 6973 206e 6f74 204e 6f6e 653a  put is not None:
+0003b920: 0a20 2020 2020 2020 2067 732e 7061 2e6f  .        gs.pa.o
+0003b930: 7574 7075 7420 3d20 6773 2e70 612e 6f75  utput = gs.pa.ou
+0003b940: 7470 7574 2e6c 6f77 6572 2829 0a0a 2020  tput.lower()..  
+0003b950: 2020 6966 2028 0a20 2020 2020 2020 2067    if (.        g
+0003b960: 732e 7061 2e6d 6573 7361 6765 0a20 2020  s.pa.message.   
+0003b970: 2020 2020 206f 7220 6773 2e70 612e 696d       or gs.pa.im
+0003b980: 6167 650a 2020 2020 2020 2020 6f72 2067  age.        or g
+0003b990: 732e 7061 2e61 7564 696f 0a20 2020 2020  s.pa.audio.     
+0003b9a0: 2020 206f 7220 6773 2e70 612e 6669 6c65     or gs.pa.file
+0003b9b0: 0a20 2020 2020 2020 206f 7220 6773 2e70  .        or gs.p
+0003b9c0: 612e 6576 656e 740a 2020 2020 293a 0a20  a.event.    ):. 
+0003b9d0: 2020 2020 2020 2067 732e 7365 6e64 5f61         gs.send_a
+0003b9e0: 6374 696f 6e20 3d20 5472 7565 0a20 2020  ction = True.   
+0003b9f0: 2065 6c73 653a 0a20 2020 2020 2020 2067   else:.        g
+0003ba00: 732e 7365 6e64 5f61 6374 696f 6e20 3d20  s.send_action = 
+0003ba10: 4661 6c73 650a 0a20 2020 2069 6620 6773  False..    if gs
+0003ba20: 2e70 612e 6c69 7374 656e 2069 6e20 2846  .pa.listen in (F
+0003ba30: 4f52 4556 4552 2c20 4f4e 4345 2c20 5441  OREVER, ONCE, TA
+0003ba40: 494c 2c20 414c 4c29 3a0a 2020 2020 2020  IL, ALL):.      
+0003ba50: 2020 6773 2e6c 6973 7465 6e5f 6163 7469    gs.listen_acti
+0003ba60: 6f6e 203d 2054 7275 650a 2020 2020 656c  on = True.    el
+0003ba70: 7365 3a0a 2020 2020 2020 2020 6773 2e6c  se:.        gs.l
+0003ba80: 6973 7465 6e5f 6163 7469 6f6e 203d 2046  isten_action = F
+0003ba90: 616c 7365 0a0a 2020 2020 6966 2028 0a20  alse..    if (. 
+0003baa0: 2020 2020 2020 2023 2072 6f6f 6d20 7365         # room se
+0003bab0: 740a 2020 2020 2020 2020 6773 2e70 612e  t.        gs.pa.
+0003bac0: 726f 6f6d 5f63 7265 6174 650a 2020 2020  room_create.    
+0003bad0: 2020 2020 6f72 2067 732e 7061 2e72 6f6f      or gs.pa.roo
+0003bae0: 6d5f 646d 5f63 7265 6174 650a 2020 2020  m_dm_create.    
+0003baf0: 2020 2020 6f72 2067 732e 7061 2e72 6f6f      or gs.pa.roo
+0003bb00: 6d5f 6a6f 696e 0a20 2020 2020 2020 206f  m_join.        o
+0003bb10: 7220 6773 2e70 612e 726f 6f6d 5f6c 6561  r gs.pa.room_lea
+0003bb20: 7665 0a20 2020 2020 2020 206f 7220 6773  ve.        or gs
+0003bb30: 2e70 612e 726f 6f6d 5f66 6f72 6765 740a  .pa.room_forget.
+0003bb40: 2020 2020 2020 2020 6f72 2067 732e 7061          or gs.pa
+0003bb50: 2e72 6f6f 6d5f 696e 7669 7465 0a20 2020  .room_invite.   
+0003bb60: 2020 2020 206f 7220 6773 2e70 612e 726f       or gs.pa.ro
+0003bb70: 6f6d 5f62 616e 0a20 2020 2020 2020 206f  om_ban.        o
+0003bb80: 7220 6773 2e70 612e 726f 6f6d 5f75 6e62  r gs.pa.room_unb
+0003bb90: 616e 0a20 2020 2020 2020 206f 7220 6773  an.        or gs
+0003bba0: 2e70 612e 726f 6f6d 5f6b 6963 6b0a 2020  .pa.room_kick.  
+0003bbb0: 2020 2020 2020 6f72 2067 732e 7061 2e72        or gs.pa.r
+0003bbc0: 6f6f 6d5f 7265 6461 6374 0a20 2020 2020  oom_redact.     
+0003bbd0: 2020 206f 7220 6773 2e70 612e 726f 6f6d     or gs.pa.room
+0003bbe0: 5f73 6574 5f61 6c69 6173 0a20 2020 2020  _set_alias.     
+0003bbf0: 2020 206f 7220 6773 2e70 612e 726f 6f6d     or gs.pa.room
+0003bc00: 5f64 656c 6574 655f 616c 6961 730a 2020  _delete_alias.  
+0003bc10: 2020 2020 2020 2320 726f 6f6d 2067 6574        # room get
+0003bc20: 0a20 2020 2020 2020 206f 7220 6773 2e70  .        or gs.p
+0003bc30: 612e 726f 6f6d 5f67 6574 5f76 6973 6962  a.room_get_visib
+0003bc40: 696c 6974 7920 6973 206e 6f74 204e 6f6e  ility is not Non
+0003bc50: 6520 2023 2065 6d70 7479 206c 6973 7420  e  # empty list 
+0003bc60: 6d75 7374 2069 6e76 6f6b 6520 6675 6e63  must invoke func
+0003bc70: 0a20 2020 2020 2020 206f 7220 6773 2e70  .        or gs.p
+0003bc80: 612e 726f 6f6d 5f67 6574 5f73 7461 7465  a.room_get_state
+0003bc90: 2069 7320 6e6f 7420 4e6f 6e65 2020 2320   is not None  # 
+0003bca0: 656d 7074 7920 6c69 7374 206d 7573 7420  empty list must 
+0003bcb0: 696e 766f 6b65 2066 756e 630a 2020 2020  invoke func.    
+0003bcc0: 2020 2020 6f72 2067 732e 7061 2e72 6f6f      or gs.pa.roo
+0003bcd0: 6d5f 7265 736f 6c76 655f 616c 6961 730a  m_resolve_alias.
+0003bce0: 2020 2020 293a 0a20 2020 2020 2020 2067      ):.        g
+0003bcf0: 732e 726f 6f6d 5f61 6374 696f 6e20 3d20  s.room_action = 
+0003bd00: 5472 7565 0a20 2020 2065 6c73 653a 0a20  True.    else:. 
+0003bd10: 2020 2020 2020 2067 732e 726f 6f6d 5f61         gs.room_a
+0003bd20: 6374 696f 6e20 3d20 4661 6c73 650a 0a20  ction = False.. 
+0003bd30: 2020 2069 6620 280a 2020 2020 2020 2020     if (.        
+0003bd40: 6773 2e70 612e 7365 745f 6465 7669 6365  gs.pa.set_device
+0003bd50: 5f6e 616d 6520 2023 2073 6574 0a20 2020  _name  # set.   
+0003bd60: 2020 2020 206f 7220 6773 2e70 612e 7365       or gs.pa.se
+0003bd70: 745f 6469 7370 6c61 795f 6e61 6d65 0a20  t_display_name. 
+0003bd80: 2020 2020 2020 206f 7220 6773 2e70 612e         or gs.pa.
+0003bd90: 7365 745f 7072 6573 656e 6365 0a20 2020  set_presence.   
+0003bda0: 2020 2020 206f 7220 6773 2e70 612e 7570       or gs.pa.up
+0003bdb0: 6c6f 6164 0a20 2020 2020 2020 206f 7220  load.        or 
+0003bdc0: 6773 2e70 612e 6465 6c65 7465 5f6d 7863  gs.pa.delete_mxc
+0003bdd0: 0a20 2020 2020 2020 206f 7220 6773 2e70  .        or gs.p
+0003bde0: 612e 6465 6c65 7465 5f6d 7863 5f62 6566  a.delete_mxc_bef
+0003bdf0: 6f72 650a 2020 2020 2020 2020 6f72 2067  ore.        or g
+0003be00: 732e 7061 2e72 6573 740a 2020 2020 2020  s.pa.rest.      
+0003be10: 2020 6f72 2067 732e 7061 2e73 6574 5f61    or gs.pa.set_a
+0003be20: 7661 7461 720a 2020 2020 2020 2020 6f72  vatar.        or
+0003be30: 2067 732e 7061 2e69 6d70 6f72 745f 6b65   gs.pa.import_ke
+0003be40: 7973 0a20 2020 2020 2020 206f 7220 6773  ys.        or gs
+0003be50: 2e70 612e 6465 6c65 7465 5f64 6576 6963  .pa.delete_devic
+0003be60: 650a 2020 2020 293a 0a20 2020 2020 2020  e.    ):.       
+0003be70: 2067 732e 7365 745f 6163 7469 6f6e 203d   gs.set_action =
+0003be80: 2054 7275 650a 2020 2020 656c 7365 3a0a   True.    else:.
+0003be90: 2020 2020 2020 2020 6773 2e73 6574 5f61          gs.set_a
+0003bea0: 6374 696f 6e20 3d20 4661 6c73 650a 0a20  ction = False.. 
+0003beb0: 2020 2069 6620 280a 2020 2020 2020 2020     if (.        
+0003bec0: 6773 2e70 612e 6765 745f 6469 7370 6c61  gs.pa.get_displa
+0003bed0: 795f 6e61 6d65 2020 2320 6765 740a 2020  y_name  # get.  
+0003bee0: 2020 2020 2020 6f72 2067 732e 7061 2e67        or gs.pa.g
+0003bef0: 6574 5f70 7265 7365 6e63 650a 2020 2020  et_presence.    
+0003bf00: 2020 2020 6f72 2067 732e 7061 2e64 6f77      or gs.pa.dow
+0003bf10: 6e6c 6f61 640a 2020 2020 2020 2020 6f72  nload.        or
+0003bf20: 2067 732e 7061 2e6a 6f69 6e65 645f 726f   gs.pa.joined_ro
+0003bf30: 6f6d 730a 2020 2020 2020 2020 6f72 2067  oms.        or g
+0003bf40: 732e 7061 2e6a 6f69 6e65 645f 6d65 6d62  s.pa.joined_memb
+0003bf50: 6572 730a 2020 2020 2020 2020 6f72 2067  ers.        or g
+0003bf60: 732e 7061 2e6d 7863 5f74 6f5f 6874 7470  s.pa.mxc_to_http
+0003bf70: 0a20 2020 2020 2020 206f 7220 6773 2e70  .        or gs.p
+0003bf80: 612e 6465 7669 6365 730a 2020 2020 2020  a.devices.      
+0003bf90: 2020 6f72 2067 732e 7061 2e64 6973 636f    or gs.pa.disco
+0003bfa0: 7665 7279 5f69 6e66 6f0a 2020 2020 2020  very_info.      
+0003bfb0: 2020 6f72 2067 732e 7061 2e6c 6f67 696e    or gs.pa.login
+0003bfc0: 5f69 6e66 6f0a 2020 2020 2020 2020 6f72  _info.        or
+0003bfd0: 2067 732e 7061 2e63 6f6e 7465 6e74 5f72   gs.pa.content_r
+0003bfe0: 6570 6f73 6974 6f72 795f 636f 6e66 6967  epository_config
+0003bff0: 0a20 2020 2020 2020 206f 7220 6773 2e70  .        or gs.p
+0003c000: 612e 6765 745f 6176 6174 6172 2069 7320  a.get_avatar is 
+0003c010: 6e6f 7420 4e6f 6e65 2020 2320 656d 7074  not None  # empt
+0003c020: 7920 6c69 7374 206d 7573 7420 696e 766f  y list must invo
+0003c030: 6b65 2066 756e 6374 696f 6e0a 2020 2020  ke function.    
+0003c040: 2020 2020 6f72 2067 732e 7061 2e67 6574      or gs.pa.get
+0003c050: 5f70 726f 6669 6c65 2069 7320 6e6f 7420  _profile is not 
+0003c060: 4e6f 6e65 2020 2320 656d 7074 7920 6c69  None  # empty li
+0003c070: 7374 206d 7573 7420 696e 766f 6b65 2066  st must invoke f
+0003c080: 756e 6374 696f 6e0a 2020 2020 2020 2020  unction.        
+0003c090: 6f72 2067 732e 7061 2e67 6574 5f72 6f6f  or gs.pa.get_roo
+0003c0a0: 6d5f 696e 666f 2069 7320 6e6f 7420 4e6f  m_info is not No
+0003c0b0: 6e65 2020 2320 656d 7074 7920 6c69 7374  ne  # empty list
+0003c0c0: 206d 7573 7420 696e 766f 6b65 2066 756e   must invoke fun
+0003c0d0: 6374 696f 6e0a 2020 2020 2020 2020 6f72  ction.        or
+0003c0e0: 2067 732e 7061 2e67 6574 5f63 6c69 656e   gs.pa.get_clien
+0003c0f0: 745f 696e 666f 0a20 2020 2020 2020 206f  t_info.        o
+0003c100: 7220 6773 2e70 612e 6861 735f 7065 726d  r gs.pa.has_perm
+0003c110: 6973 7369 6f6e 0a20 2020 2020 2020 206f  ission.        o
+0003c120: 7220 6773 2e70 612e 6578 706f 7274 5f6b  r gs.pa.export_k
+0003c130: 6579 730a 2020 2020 2020 2020 6f72 2067  eys.        or g
+0003c140: 732e 7061 2e67 6574 5f6f 7065 6e69 645f  s.pa.get_openid_
+0003c150: 746f 6b65 6e20 6973 206e 6f74 204e 6f6e  token is not Non
+0003c160: 6520 2023 2065 6d70 7479 206c 6973 7420  e  # empty list 
+0003c170: 6d75 7374 2069 6e76 6f6b 6520 6675 6e63  must invoke func
+0003c180: 0a20 2020 2020 2020 206f 7220 6773 2e70  .        or gs.p
+0003c190: 612e 7768 6f61 6d69 0a20 2020 2029 3a0a  a.whoami.    ):.
+0003c1a0: 2020 2020 2020 2020 6773 2e67 6574 5f61          gs.get_a
+0003c1b0: 6374 696f 6e20 3d20 5472 7565 0a20 2020  ction = True.   
+0003c1c0: 2065 6c73 653a 0a20 2020 2020 2020 2067   else:.        g
+0003c1d0: 732e 6765 745f 6163 7469 6f6e 203d 2046  s.get_action = F
+0003c1e0: 616c 7365 0a0a 2020 2020 6966 2067 732e  alse..    if gs.
+0003c1f0: 7365 745f 6163 7469 6f6e 206f 7220 6773  set_action or gs
+0003c200: 2e67 6574 5f61 6374 696f 6e3a 0a20 2020  .get_action:.   
+0003c210: 2020 2020 2067 732e 7365 7467 6574 5f61       gs.setget_a
+0003c220: 6374 696f 6e20 3d20 5472 7565 0a20 2020  ction = True.   
+0003c230: 2065 6c73 653a 0a20 2020 2020 2020 2067   else:.        g
+0003c240: 732e 7365 7467 6574 5f61 6374 696f 6e20  s.setget_action 
+0003c250: 3d20 4661 6c73 650a 0a20 2020 2023 206f  = False..    # o
+0003c260: 6e6c 7920 3220 5353 4c20 7374 6174 6573  nly 2 SSL states
+0003c270: 2061 6c6c 6f77 6564 3a20 4e6f 6e65 2028   allowed: None (
+0003c280: 5353 4c20 6465 6661 756c 7420 6f6e 292c  SSL default on),
+0003c290: 2046 616c 7365 2028 5353 4c20 6f66 6629   False (SSL off)
+0003c2a0: 0a20 2020 2069 6620 6773 2e70 612e 6e6f  .    if gs.pa.no
+0003c2b0: 5f73 736c 2069 7320 6e6f 7420 5472 7565  _ssl is not True
+0003c2c0: 3a0a 2020 2020 2020 2020 6773 2e70 612e  :.        gs.pa.
+0003c2d0: 6e6f 5f73 736c 203d 204e 6f6e 650a 2020  no_ssl = None.  
+0003c2e0: 2020 6966 2067 732e 7061 2e70 726f 7879    if gs.pa.proxy
+0003c2f0: 203d 3d20 2222 3a0a 2020 2020 2020 2020   == "":.        
+0003c300: 6773 2e70 612e 7072 6f78 7920 3d20 4e6f  gs.pa.proxy = No
+0003c310: 6e65 0a0a 2020 2020 2320 686f 7720 6f66  ne..    # how of
+0003c320: 7465 6e20 6973 2022 2d22 2075 7365 6420  ten is "-" used 
+0003c330: 746f 2072 6570 7265 7365 6e74 2073 7464  to represent std
+0003c340: 696e 0a20 2020 2023 206d 7573 7420 6265  in.    # must be
+0003c350: 2030 206f 7220 313b 2063 616e 6e6f 7420   0 or 1; cannot 
+0003c360: 6265 2075 7365 6420 7477 6963 6520 6f72  be used twice or
+0003c370: 206d 6f72 650a 2020 2020 5354 4449 4e5f   more.    STDIN_
+0003c380: 4d45 5353 4147 4520 3d20 300a 2020 2020  MESSAGE = 0.    
+0003c390: 5354 4449 4e5f 494d 4147 4520 3d20 300a  STDIN_IMAGE = 0.
+0003c3a0: 2020 2020 5354 4449 4e5f 4155 4449 4f20      STDIN_AUDIO 
+0003c3b0: 3d20 300a 2020 2020 5354 4449 4e5f 4649  = 0.    STDIN_FI
+0003c3c0: 4c45 203d 2030 0a20 2020 2053 5444 494e  LE = 0.    STDIN
+0003c3d0: 5f45 5645 4e54 203d 2030 0a20 2020 2053  _EVENT = 0.    S
+0003c3e0: 5444 494e 5f54 4f54 414c 203d 2030 0a20  TDIN_TOTAL = 0. 
+0003c3f0: 2020 2069 6620 6773 2e70 612e 696d 6167     if gs.pa.imag
+0003c400: 653a 0a20 2020 2020 2020 2066 6f72 2069  e:.        for i
+0003c410: 6d61 6765 2069 6e20 6773 2e70 612e 696d  mage in gs.pa.im
+0003c420: 6167 653a 0a20 2020 2020 2020 2020 2020  age:.           
+0003c430: 2069 6620 696d 6167 6520 3d3d 2022 2d22   if image == "-"
+0003c440: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003c450: 2020 5354 4449 4e5f 494d 4147 4520 2b3d    STDIN_IMAGE +=
+0003c460: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
+0003c470: 2020 2067 732e 7374 6469 6e5f 7573 6520     gs.stdin_use 
+0003c480: 3d20 2269 6d61 6765 220a 2020 2020 6966  = "image".    if
+0003c490: 2067 732e 7061 2e61 7564 696f 3a0a 2020   gs.pa.audio:.  
+0003c4a0: 2020 2020 2020 666f 7220 6175 6469 6f20        for audio 
+0003c4b0: 696e 2067 732e 7061 2e61 7564 696f 3a0a  in gs.pa.audio:.
+0003c4c0: 2020 2020 2020 2020 2020 2020 6966 2061              if a
+0003c4d0: 7564 696f 203d 3d20 222d 223a 0a20 2020  udio == "-":.   
+0003c4e0: 2020 2020 2020 2020 2020 2020 2053 5444               STD
+0003c4f0: 494e 5f41 5544 494f 202b 3d20 310a 2020  IN_AUDIO += 1.  
+0003c500: 2020 2020 2020 2020 2020 2020 2020 6773                gs
+0003c510: 2e73 7464 696e 5f75 7365 203d 2022 6175  .stdin_use = "au
+0003c520: 6469 6f22 0a20 2020 2069 6620 6773 2e70  dio".    if gs.p
+0003c530: 612e 6669 6c65 3a0a 2020 2020 2020 2020  a.file:.        
+0003c540: 666f 7220 6669 6c65 2069 6e20 6773 2e70  for file in gs.p
+0003c550: 612e 6669 6c65 3a0a 2020 2020 2020 2020  a.file:.        
+0003c560: 2020 2020 6966 2066 696c 6520 3d3d 2022      if file == "
+0003c570: 2d22 3a0a 2020 2020 2020 2020 2020 2020  -":.            
+0003c580: 2020 2020 5354 4449 4e5f 4649 4c45 202b      STDIN_FILE +
+0003c590: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
+0003c5a0: 2020 2020 6773 2e73 7464 696e 5f75 7365      gs.stdin_use
+0003c5b0: 203d 2022 6669 6c65 220a 2020 2020 6966   = "file".    if
+0003c5c0: 2067 732e 7061 2e65 7665 6e74 3a0a 2020   gs.pa.event:.  
+0003c5d0: 2020 2020 2020 666f 7220 6576 656e 7420        for event 
+0003c5e0: 696e 2067 732e 7061 2e65 7665 6e74 3a0a  in gs.pa.event:.
+0003c5f0: 2020 2020 2020 2020 2020 2020 6966 2065              if e
+0003c600: 7665 6e74 203d 3d20 222d 223a 0a20 2020  vent == "-":.   
+0003c610: 2020 2020 2020 2020 2020 2020 2053 5444               STD
+0003c620: 494e 5f45 5645 4e54 202b 3d20 310a 2020  IN_EVENT += 1.  
+0003c630: 2020 2020 2020 2020 2020 2020 2020 6773                gs
+0003c640: 2e73 7464 696e 5f75 7365 203d 2022 6576  .stdin_use = "ev
+0003c650: 656e 7422 0a20 2020 2069 6620 6773 2e70  ent".    if gs.p
+0003c660: 612e 6d65 7373 6167 653a 0a20 2020 2020  a.message:.     
+0003c670: 2020 2066 6f72 206d 6573 7361 6765 2069     for message i
+0003c680: 6e20 6773 2e70 612e 6d65 7373 6167 653a  n gs.pa.message:
+0003c690: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0003c6a0: 6d65 7373 6167 6520 3d3d 2022 2d22 206f  message == "-" o
+0003c6b0: 7220 6d65 7373 6167 6520 3d3d 2022 5f22  r message == "_"
+0003c6c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003c6d0: 2020 5354 4449 4e5f 4d45 5353 4147 4520    STDIN_MESSAGE 
+0003c6e0: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
+0003c6f0: 2020 2020 2067 732e 7374 6469 6e5f 7573       gs.stdin_us
+0003c700: 6520 3d20 226d 6573 7361 6765 220a 2020  e = "message".  
+0003c710: 2020 5354 4449 4e5f 544f 5441 4c20 3d20    STDIN_TOTAL = 
+0003c720: 280a 2020 2020 2020 2020 5354 4449 4e5f  (.        STDIN_
+0003c730: 4d45 5353 4147 4520 2b20 5354 4449 4e5f  MESSAGE + STDIN_
+0003c740: 494d 4147 4520 2b20 5354 4449 4e5f 4155  IMAGE + STDIN_AU
+0003c750: 4449 4f20 2b20 5354 4449 4e5f 4649 4c45  DIO + STDIN_FILE
+0003c760: 202b 2053 5444 494e 5f45 5645 4e54 0a20   + STDIN_EVENT. 
+0003c770: 2020 2029 0a0a 2020 2020 2320 5365 636f     )..    # Seco
+0003c780: 6e64 6c79 2c20 7468 6520 6368 6563 6b73  ndly, the checks
+0003c790: 0a20 2020 2069 6620 6773 2e70 612e 636f  .    if gs.pa.co
+0003c7a0: 6e66 6967 3a0a 2020 2020 2020 2020 7420  nfig:.        t 
+0003c7b0: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+0003c7c0: 2254 6869 7320 6665 6174 7572 6520 6973  "This feature is
+0003c7d0: 206e 6f74 2069 6d70 6c65 6d65 6e74 6564   not implemented
+0003c7e0: 2079 6574 2061 6e64 2077 696c 6c20 6d6f   yet and will mo
+0003c7f0: 7374 206c 696b 656c 7920 220a 2020 2020  st likely ".    
+0003c800: 2020 2020 2020 2020 226e 6f74 2062 6520          "not be 
+0003c810: 696d 706c 656d 656e 7465 642e 2053 6565  implemented. See
+0003c820: 2049 7373 7565 2023 3334 206f 6e20 4769   Issue #34 on Gi
+0003c830: 7468 7562 2e22 0a20 2020 2020 2020 2029  thub.".        )
+0003c840: 0a20 2020 2065 6c69 6620 6773 2e70 612e  .    elif gs.pa.
+0003c850: 6c69 7374 656e 2069 6e20 2846 4f52 4556  listen in (FOREV
+0003c860: 4552 2c20 4f4e 4345 2c20 414c 4c29 2061  ER, ONCE, ALL) a
+0003c870: 6e64 2067 732e 7061 2e74 6169 6c20 213d  nd gs.pa.tail !=
+0003c880: 2030 3a0a 2020 2020 2020 2020 7420 3d20   0:.        t = 
+0003c890: 280a 2020 2020 2020 2020 2020 2020 2244  (.            "D
+0003c8a0: 6f6e 2774 2075 7365 202d 2d6c 6973 7465  on't use --liste
+0003c8b0: 6e20 666f 7265 7665 722c 202d 2d6c 6973  n forever, --lis
+0003c8c0: 7465 6e20 6f6e 6365 206f 7220 2d2d 6c69  ten once or --li
+0003c8d0: 7374 656e 2061 6c6c 2022 0a20 2020 2020  sten all ".     
+0003c8e0: 2020 2020 2020 2022 746f 6765 7468 6572         "together
+0003c8f0: 2077 6974 6820 2d2d 7461 696c 2e20 4974   with --tail. It
+0003c900: 2773 206f 6e65 206f 7220 7468 6520 6f74  's one or the ot
+0003c910: 6865 722e 220a 2020 2020 2020 2020 290a  her.".        ).
+0003c920: 2020 2020 2320 7468 6973 2069 7320 7365      # this is se
+0003c930: 7420 6279 2064 6566 6175 6c74 2061 6e79  t by default any
+0003c940: 7761 792c 206a 7573 7420 6465 6665 6e73  way, just defens
+0003c950: 6976 6520 7072 6f67 7261 6d6d 696e 670a  ive programming.
+0003c960: 2020 2020 656c 6966 2067 732e 7061 2e65      elif gs.pa.e
+0003c970: 6e63 7279 7074 6564 2061 6e64 2067 732e  ncrypted and gs.
+0003c980: 7061 2e73 746f 7265 2069 6e20 284e 6f6e  pa.store in (Non
+0003c990: 652c 2022 2229 3a0a 2020 2020 2020 2020  e, ""):.        
+0003c9a0: 7420 3d20 280a 2020 2020 2020 2020 2020  t = (.          
+0003c9b0: 2020 2249 6620 2d2d 656e 6372 7970 7465    "If --encrypte
+0003c9c0: 6420 6973 2075 7365 6420 2d2d 7374 6f72  d is used --stor
+0003c9d0: 6520 6d75 7374 2062 6520 7365 7420 746f  e must be set to
+0003c9e0: 6f2e 2022 0a20 2020 2020 2020 2020 2020  o. ".           
+0003c9f0: 2022 5370 6563 6966 7920 2d2d 7374 6f72   "Specify --stor
+0003ca00: 6520 616e 6420 7275 6e20 7072 6f67 7261  e and run progra
+0003ca10: 6d20 6167 6169 6e2e 220a 2020 2020 2020  m again.".      
+0003ca20: 2020 290a 2020 2020 656c 6966 2067 732e    ).    elif gs.
+0003ca30: 7061 2e76 6572 6966 7920 616e 6420 2867  pa.verify and (g
+0003ca40: 732e 7061 2e76 6572 6966 792e 6c6f 7765  s.pa.verify.lowe
+0003ca50: 7228 2920 213d 2045 4d4f 4a49 293a 0a20  r() != EMOJI):. 
+0003ca60: 2020 2020 2020 2074 203d 2066 2746 6f72         t = f'For
+0003ca70: 202d 2d76 6572 6966 7920 6375 7272 656e   --verify curren
+0003ca80: 746c 7920 6f6e 6c79 2022 7b45 4d4f 4a49  tly only "{EMOJI
+0003ca90: 7d22 2069 7320 616c 6c6f 7765 6420 6173  }" is allowed as
+0003caa0: 206b 6579 776f 7264 2e27 0a20 2020 2065   keyword.'.    e
+0003cab0: 6c69 6620 6773 2e70 612e 7665 7273 696f  lif gs.pa.versio
+0003cac0: 6e20 616e 6420 280a 2020 2020 2020 2020  n and (.        
+0003cad0: 6773 2e70 612e 7665 7273 696f 6e2e 6c6f  gs.pa.version.lo
+0003cae0: 7765 7228 2920 213d 2050 5249 4e54 2061  wer() != PRINT a
+0003caf0: 6e64 2067 732e 7061 2e76 6572 7369 6f6e  nd gs.pa.version
+0003cb00: 2e6c 6f77 6572 2829 2021 3d20 4348 4543  .lower() != CHEC
+0003cb10: 4b0a 2020 2020 293a 0a20 2020 2020 2020  K.    ):.       
+0003cb20: 2074 203d 2028 0a20 2020 2020 2020 2020   t = (.         
+0003cb30: 2020 2066 2746 6f72 202d 2d76 6572 7369     f'For --versi
+0003cb40: 6f6e 2063 7572 7265 6e74 6c79 206f 6e6c  on currently onl
+0003cb50: 7920 227b 5052 494e 547d 2220 270a 2020  y "{PRINT}" '.  
+0003cb60: 2020 2020 2020 2020 2020 6627 6f72 2022            f'or "
+0003cb70: 7b43 4845 434b 7d22 2069 7320 616c 6c6f  {CHECK}" is allo
+0003cb80: 7765 6420 6173 206b 6579 776f 7264 2e27  wed as keyword.'
+0003cb90: 0a20 2020 2020 2020 2029 0a20 2020 2023  .        ).    #
+0003cba0: 2061 6c6c 6f77 2076 6572 6966 7920 7769   allow verify wi
+0003cbb0: 7468 2065 7665 7279 7468 696e 670a 2020  th everything.  
+0003cbc0: 2020 2320 616c 6c6f 7720 7365 6e64 2077    # allow send w
+0003cbd0: 6974 6820 6576 6572 7974 6869 6e67 0a20  ith everything. 
+0003cbe0: 2020 2023 2061 6c6c 6f77 206c 6973 7465     # allow liste
+0003cbf0: 6e20 7769 7468 2065 7665 7279 7468 696e  n with everythin
+0003cc00: 670a 2020 2020 656c 6966 2067 732e 7061  g.    elif gs.pa
+0003cc10: 2e73 6574 5f64 6576 6963 655f 6e61 6d65  .set_device_name
+0003cc20: 2061 6e64 2028 6773 2e70 612e 7365 745f   and (gs.pa.set_
+0003cc30: 6465 7669 6365 5f6e 616d 652e 7374 7269  device_name.stri
+0003cc40: 7028 2920 3d3d 2022 2229 3a0a 2020 2020  p() == ""):.    
+0003cc50: 2020 2020 7420 3d20 2244 6f6e 2774 2075      t = "Don't u
+0003cc60: 7365 2061 6e20 656d 7074 7920 6e61 6d65  se an empty name
+0003cc70: 2066 6f72 202d 2d73 6574 2d64 6576 6963   for --set-devic
+0003cc80: 652d 6e61 6d65 2e22 0a20 2020 2065 6c69  e-name.".    eli
+0003cc90: 6620 6773 2e70 612e 7365 745f 6469 7370  f gs.pa.set_disp
+0003cca0: 6c61 795f 6e61 6d65 2061 6e64 2028 6773  lay_name and (gs
+0003ccb0: 2e70 612e 7365 745f 6469 7370 6c61 795f  .pa.set_display_
+0003ccc0: 6e61 6d65 2e73 7472 6970 2829 203d 3d20  name.strip() == 
+0003ccd0: 2222 293a 0a20 2020 2020 2020 2074 203d  ""):.        t =
+0003cce0: 2022 446f 6e27 7420 7573 6520 616e 2065   "Don't use an e
+0003ccf0: 6d70 7479 206e 616d 6520 666f 7220 2d2d  mpty name for --
+0003cd00: 7365 742d 6469 7370 6c61 792d 6e61 6d65  set-display-name
+0003cd10: 2e22 0a20 2020 2065 6c69 6620 2867 732e  .".    elif (gs.
+0003cd20: 7061 2e75 7365 7229 2061 6e64 206e 6f74  pa.user) and not
+0003cd30: 2028 0a20 2020 2020 2020 2067 732e 7365   (.        gs.se
+0003cd40: 6e64 5f61 6374 696f 6e0a 2020 2020 2020  nd_action.      
+0003cd50: 2020 6f72 2067 732e 726f 6f6d 5f61 6374    or gs.room_act
+0003cd60: 696f 6e0a 2020 2020 2020 2020 6f72 2067  ion.        or g
+0003cd70: 732e 7061 2e67 6574 5f64 6973 706c 6179  s.pa.get_display
+0003cd80: 5f6e 616d 650a 2020 2020 2020 2020 6f72  _name.        or
+0003cd90: 2067 732e 7061 2e67 6574 5f70 7265 7365   gs.pa.get_prese
+0003cda0: 6e63 650a 2020 2020 2020 2020 6f72 2067  nce.        or g
+0003cdb0: 732e 7061 2e64 656c 6574 655f 6465 7669  s.pa.delete_devi
+0003cdc0: 6365 0a20 2020 2029 3a0a 2020 2020 2020  ce.    ):.      
+0003cdd0: 2020 7420 3d20 280a 2020 2020 2020 2020    t = (.        
+0003cde0: 2020 2020 2249 6620 2d2d 7573 6572 2069      "If --user i
+0003cdf0: 7320 7370 6563 6966 6965 642c 206f 6e6c  s specified, onl
+0003ce00: 7920 6120 7365 6e64 2061 6374 696f 6e2c  y a send action,
+0003ce10: 2061 2072 6f6f 6d20 6163 7469 6f6e 2c20   a room action, 
+0003ce20: 220a 2020 2020 2020 2020 2020 2020 222d  ".            "-
+0003ce30: 2d67 6574 2d64 6973 706c 6179 2d6e 616d  -get-display-nam
+0003ce40: 652c 202d 2d67 6574 2d70 7265 7365 6e63  e, --get-presenc
+0003ce50: 652c 206f 7220 2d2d 6465 6c65 7465 2d64  e, or --delete-d
+0003ce60: 6576 6963 6520 6361 6e20 6265 2022 0a20  evice can be ". 
+0003ce70: 2020 2020 2020 2020 2020 2022 646f 6e65             "done
+0003ce80: 2e20 4164 6a75 7374 2079 6f75 7220 6172  . Adjust your ar
+0003ce90: 6775 6d65 6e74 7320 6163 636f 7264 696e  guments accordin
+0003cea0: 676c 792e 220a 2020 2020 2020 2020 290a  gly.".        ).
+0003ceb0: 2020 2020 656c 6966 2028 6773 2e70 612e      elif (gs.pa.
+0003cec0: 7379 6e63 2069 7320 6e6f 7420 4e6f 6e65  sync is not None
+0003ced0: 2920 616e 6420 6e6f 7420 2867 732e 7365  ) and not (gs.se
+0003cee0: 6e64 5f61 6374 696f 6e29 3a0a 2020 2020  nd_action):.    
+0003cef0: 2020 2020 7420 3d20 280a 2020 2020 2020      t = (.      
+0003cf00: 2020 2020 2020 224f 6e6c 7920 6966 2061        "Only if a
+0003cf10: 2073 656e 6420 6163 7469 6f6e 2069 7320   send action is 
+0003cf20: 7072 6f76 6964 6564 2069 7320 6974 206d  provided is it m
+0003cf30: 6561 6e69 6e67 6675 6c20 746f 2073 7065  eaningful to spe
+0003cf40: 6369 6679 2022 0a20 2020 2020 2020 2020  cify ".         
+0003cf50: 2020 2022 2d2d 7379 6e63 2e20 5265 6d6f     "--sync. Remo
+0003cf60: 7665 202d 2d73 796e 6320 6f72 2061 6464  ve --sync or add
+0003cf70: 2061 2073 656e 6420 6163 7469 6f6e 2e20   a send action. 
+0003cf80: 220a 2020 2020 2020 2020 2020 2020 2241  ".            "A
+0003cf90: 646a 7573 7420 796f 7572 2061 7267 756d  djust your argum
+0003cfa0: 656e 7473 2061 6363 6f72 6469 6e67 6c79  ents accordingly
+0003cfb0: 2e22 0a20 2020 2020 2020 2029 0a20 2020  .".        ).   
+0003cfc0: 2065 6c69 6620 2867 732e 7061 2e73 796e   elif (gs.pa.syn
+0003cfd0: 6320 6973 206e 6f74 204e 6f6e 6529 2061  c is not None) a
+0003cfe0: 6e64 2067 732e 7061 2e73 796e 6320 6e6f  nd gs.pa.sync no
+0003cff0: 7420 696e 2028 5359 4e43 5f46 554c 4c2c  t in (SYNC_FULL,
+0003d000: 2053 594e 435f 4f46 4629 3a0a 2020 2020   SYNC_OFF):.    
+0003d010: 2020 2020 7420 3d20 280a 2020 2020 2020      t = (.      
+0003d020: 2020 2020 2020 2249 6e63 6f72 7265 6374        "Incorrect
+0003d030: 2076 616c 7565 2067 6976 656e 2066 6f72   value given for
+0003d040: 202d 2d73 796e 632e 2022 0a20 2020 2020   --sync. ".     
+0003d050: 2020 2020 2020 2066 224f 6e6c 7920 277b         f"Only '{
+0003d060: 5359 4e43 5f46 554c 4c7d 2720 616e 6420  SYNC_FULL}' and 
+0003d070: 277b 5359 4e43 5f4f 4646 7d27 2061 7265  '{SYNC_OFF}' are
+0003d080: 2061 6c6c 6f77 6564 2e22 0a20 2020 2020   allowed.".     
+0003d090: 2020 2029 0a20 2020 2065 6c69 6620 6773     ).    elif gs
+0003d0a0: 2e70 612e 6f75 7470 7574 206e 6f74 2069  .pa.output not i
+0003d0b0: 6e20 280a 2020 2020 2020 2020 4f55 5450  n (.        OUTP
+0003d0c0: 5554 5f54 4558 542c 0a20 2020 2020 2020  UT_TEXT,.       
+0003d0d0: 204f 5554 5055 545f 4a53 4f4e 2c0a 2020   OUTPUT_JSON,.  
+0003d0e0: 2020 2020 2020 4f55 5450 5554 5f4a 534f        OUTPUT_JSO
+0003d0f0: 4e5f 5350 4543 2c0a 2020 2020 2020 2020  N_SPEC,.        
+0003d100: 4f55 5450 5554 5f4a 534f 4e5f 4d41 582c  OUTPUT_JSON_MAX,
+0003d110: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+0003d120: 7420 3d20 280a 2020 2020 2020 2020 2020  t = (.          
+0003d130: 2020 2249 6e63 6f72 7265 6374 2076 616c    "Incorrect val
+0003d140: 7565 2067 6976 656e 2066 6f72 202d 2d6f  ue given for --o
+0003d150: 7574 7075 742e 2022 0a20 2020 2020 2020  utput. ".       
+0003d160: 2020 2020 2066 224f 6e6c 7920 277b 4f55       f"Only '{OU
+0003d170: 5450 5554 5f54 4558 547d 272c 2027 7b4f  TPUT_TEXT}', '{O
+0003d180: 5554 5055 545f 4a53 4f4e 7d27 2c20 220a  UTPUT_JSON}', ".
+0003d190: 2020 2020 2020 2020 2020 2020 6622 277b              f"'{
+0003d1a0: 4f55 5450 5554 5f4a 534f 4e5f 5350 4543  OUTPUT_JSON_SPEC
+0003d1b0: 7d27 2061 6e64 2027 7b4f 5554 5055 545f  }' and '{OUTPUT_
+0003d1c0: 4a53 4f4e 5f4d 4158 7d27 2061 7265 2061  JSON_MAX}' are a
+0003d1d0: 6c6c 6f77 6564 2e22 0a20 2020 2020 2020  llowed.".       
+0003d1e0: 2029 0a20 2020 2065 6c69 6620 6e6f 7420   ).    elif not 
+0003d1f0: 6773 2e70 612e 7573 6572 2061 6e64 2028  gs.pa.user and (
+0003d200: 0a20 2020 2020 2020 2067 732e 7061 2e72  .        gs.pa.r
+0003d210: 6f6f 6d5f 696e 7669 7465 0a20 2020 2020  oom_invite.     
+0003d220: 2020 206f 7220 6773 2e70 612e 726f 6f6d     or gs.pa.room
+0003d230: 5f62 616e 0a20 2020 2020 2020 206f 7220  _ban.        or 
+0003d240: 6773 2e70 612e 726f 6f6d 5f75 6e62 616e  gs.pa.room_unban
+0003d250: 0a20 2020 2020 2020 206f 7220 6773 2e70  .        or gs.p
+0003d260: 612e 726f 6f6d 5f6b 6963 6b0a 2020 2020  a.room_kick.    
+0003d270: 293a 0a20 2020 2020 2020 2074 203d 2028  ):.        t = (
+0003d280: 0a20 2020 2020 2020 2020 2020 2022 5573  .            "Us
+0003d290: 6572 206e 6f74 2073 7065 6369 6669 6564  er not specified
+0003d2a0: 2066 6f72 2072 6f6f 6d20 6163 7469 6f6e   for room action
+0003d2b0: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
+0003d2c0: 2255 7365 202d 2d75 7365 7220 6f70 7469  "Use --user opti
+0003d2d0: 6f6e 2074 6f20 7370 6563 6966 7920 7573  on to specify us
+0003d2e0: 6572 2873 2920 666f 7220 6769 7665 6e20  er(s) for given 
+0003d2f0: 726f 6f6d 2061 6374 696f 6e2e 220a 2020  room action.".  
+0003d300: 2020 2020 2020 290a 2020 2020 656c 6966        ).    elif
+0003d310: 2067 732e 7061 2e6c 6973 7465 6e20 696e   gs.pa.listen in
+0003d320: 2028 4f4e 4345 2c20 464f 5245 5645 5229   (ONCE, FOREVER)
+0003d330: 2061 6e64 2067 732e 7061 2e72 6f6f 6d3a   and gs.pa.room:
+0003d340: 0a20 2020 2020 2020 2074 203d 2028 0a20  .        t = (. 
+0003d350: 2020 2020 2020 2020 2020 2022 4966 202d             "If -
+0003d360: 2d6c 6973 7465 6e20 6f6e 6365 206f 7220  -listen once or 
+0003d370: 2d2d 6c69 7374 656e 2066 6f72 6576 6572  --listen forever
+0003d380: 2061 7265 2073 7065 6369 6669 6564 2c20   are specified, 
+0003d390: 220a 2020 2020 2020 2020 2020 2020 222d  ".            "-
+0003d3a0: 2d72 6f6f 6d20 6d75 7374 206e 6f74 2062  -room must not b
+0003d3b0: 6520 7370 6563 6966 6965 6420 6265 6361  e specified beca
+0003d3c0: 7573 6520 220a 2020 2020 2020 2020 2020  use ".          
+0003d3d0: 2020 2274 6865 7365 206f 7074 696f 6e73    "these options
+0003d3e0: 206c 6973 7465 6e20 696e 2041 4c4c 2072   listen in ALL r
+0003d3f0: 6f6f 6d73 2e22 0a20 2020 2020 2020 2029  ooms.".        )
+0003d400: 0a20 2020 2065 6c69 6620 6773 2e70 612e  .    elif gs.pa.
+0003d410: 6c69 7374 656e 206e 6f74 2069 6e20 284e  listen not in (N
+0003d420: 4556 4552 2c20 464f 5245 5645 522c 204f  EVER, FOREVER, O
+0003d430: 4e43 452c 2054 4149 4c2c 2041 4c4c 293a  NCE, TAIL, ALL):
+0003d440: 0a20 2020 2020 2020 2074 203d 2028 0a20  .        t = (. 
+0003d450: 2020 2020 2020 2020 2020 2022 4966 202d             "If -
+0003d460: 2d6c 6973 7465 6e20 6973 2073 7065 6369  -listen is speci
+0003d470: 6669 6564 2c20 6f6e 6c79 2074 6865 7365  fied, only these
+0003d480: 2063 686f 6963 6573 2061 7265 2022 0a20   choices are ". 
+0003d490: 2020 2020 2020 2020 2020 2066 2270 6f73             f"pos
+0003d4a0: 7369 626c 653a 207b 4f4e 4345 7d2c 207b  sible: {ONCE}, {
+0003d4b0: 4e45 5645 527d 2c20 7b46 4f52 4556 4552  NEVER}, {FOREVER
+0003d4c0: 7d2c 207b 5441 494c 7d20 6f72 207b 414c  }, {TAIL} or {AL
+0003d4d0: 4c7d 2e20 220a 2020 2020 2020 2020 2020  L}. ".          
+0003d4e0: 2020 6627 466f 756e 6420 227b 6773 2e70    f'Found "{gs.p
+0003d4f0: 612e 6c69 7374 656e 7d22 2e27 0a20 2020  a.listen}".'.   
+0003d500: 2020 2020 2029 0a20 2020 2065 6c69 6620       ).    elif 
+0003d510: 6773 2e70 612e 6c69 7374 656e 203d 3d20  gs.pa.listen == 
+0003d520: 4e45 5645 5220 616e 6420 6773 2e70 612e  NEVER and gs.pa.
+0003d530: 6c69 7374 656e 5f73 656c 663a 0a20 2020  listen_self:.   
+0003d540: 2020 2020 2074 203d 2028 0a20 2020 2020       t = (.     
+0003d550: 2020 2020 2020 2022 4966 206e 6569 7468         "If neith
+0003d560: 6572 202d 2d6c 6973 7465 6e20 6e6f 7220  er --listen nor 
+0003d570: 2d2d 7461 696c 2061 7265 2075 7365 642c  --tail are used,
+0003d580: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
+0003d590: 7468 656e 202d 2d6c 6973 7465 6e2d 7365  then --listen-se
+0003d5a0: 6c66 206d 7573 7420 6e6f 7420 6265 2075  lf must not be u
+0003d5b0: 7365 6420 220a 2020 2020 2020 2020 2020  sed ".          
+0003d5c0: 2020 2265 6974 6865 722e 2053 7065 6369    "either. Speci
+0003d5d0: 6679 202d 2d6c 6973 7465 6e20 6f72 202d  fy --listen or -
+0003d5e0: 2d74 6169 6c20 220a 2020 2020 2020 2020  -tail ".        
+0003d5f0: 2020 2020 2261 6e64 2072 756e 2070 726f      "and run pro
+0003d600: 6772 616d 2061 6761 696e 2e22 0a20 2020  gram again.".   
+0003d610: 2020 2020 2029 0a20 2020 2065 6c69 6620       ).    elif 
+0003d620: 6773 2e70 612e 6c69 7374 656e 203d 3d20  gs.pa.listen == 
+0003d630: 4e45 5645 5220 616e 6420 2867 732e 7061  NEVER and (gs.pa
+0003d640: 2e64 6f77 6e6c 6f61 645f 6d65 6469 6120  .download_media 
+0003d650: 213d 2022 2229 3a0a 2020 2020 2020 2020  != ""):.        
+0003d660: 7420 3d20 280a 2020 2020 2020 2020 2020  t = (.          
+0003d670: 2020 2249 6620 6e65 6974 6865 7220 2d2d    "If neither --
+0003d680: 6c69 7374 656e 206e 6f72 202d 2d74 6169  listen nor --tai
+0003d690: 6c20 6172 6520 7573 6564 2c20 220a 2020  l are used, ".  
+0003d6a0: 2020 2020 2020 2020 2020 2274 6865 6e20            "then 
+0003d6b0: 2d2d 646f 776e 6c6f 6164 2d6d 6564 6961  --download-media
+0003d6c0: 206d 7573 7420 6e6f 7420 6265 2075 7365   must not be use
+0003d6d0: 6420 220a 2020 2020 2020 2020 2020 2020  d ".            
+0003d6e0: 2265 6974 6865 722e 2053 7065 6369 6679  "either. Specify
+0003d6f0: 202d 2d6c 6973 7465 6e20 6f72 202d 2d74   --listen or --t
+0003d700: 6169 6c20 220a 2020 2020 2020 2020 2020  ail ".          
+0003d710: 2020 6622 616e 6420 7275 6e20 7072 6f67    f"and run prog
+0003d720: 7261 6d20 6167 6169 6e2e 2028 7b67 732e  ram again. ({gs.
+0003d730: 7061 2e64 6f77 6e6c 6f61 645f 6d65 6469  pa.download_medi
+0003d740: 617d 2922 0a20 2020 2020 2020 2029 0a20  a})".        ). 
+0003d750: 2020 2065 6c69 6620 6773 2e70 612e 6c69     elif gs.pa.li
+0003d760: 7374 656e 203d 3d20 5441 494c 2061 6e64  sten == TAIL and
+0003d770: 2028 6773 2e70 612e 7461 696c 203c 3d20   (gs.pa.tail <= 
+0003d780: 3029 3a0a 2020 2020 2020 2020 7420 3d20  0):.        t = 
+0003d790: 280a 2020 2020 2020 2020 2020 2020 2241  (.            "A
+0003d7a0: 6e20 696e 7465 6765 7220 3120 6f72 206c  n integer 1 or l
+0003d7b0: 6172 6765 7220 6d75 7374 2062 6520 7370  arger must be sp
+0003d7c0: 6563 6966 6965 6420 7769 7468 202d 2d74  ecified with --t
+0003d7d0: 6169 6c20 220a 2020 2020 2020 2020 2020  ail ".          
+0003d7e0: 2020 6622 287b 6773 2e70 612e 7461 696c    f"({gs.pa.tail
+0003d7f0: 7d29 2e22 0a20 2020 2020 2020 2029 0a20  }).".        ). 
+0003d800: 2020 2065 6c69 6620 6773 2e70 612e 7072     elif gs.pa.pr
+0003d810: 6f78 7920 616e 6420 6e6f 7420 280a 2020  oxy and not (.  
+0003d820: 2020 2020 2020 6773 2e70 612e 7072 6f78        gs.pa.prox
+0003d830: 792e 7374 6172 7473 7769 7468 2822 6874  y.startswith("ht
+0003d840: 7470 3a2f 2f22 290a 2020 2020 2020 2020  tp://").        
+0003d850: 6f72 2067 732e 7061 2e70 726f 7879 2e73  or gs.pa.proxy.s
+0003d860: 7461 7274 7377 6974 6828 2273 6f63 6b73  tartswith("socks
+0003d870: 343a 2f2f 2229 0a20 2020 2020 2020 206f  4://").        o
+0003d880: 7220 6773 2e70 612e 7072 6f78 792e 7374  r gs.pa.proxy.st
+0003d890: 6172 7473 7769 7468 2822 736f 636b 7335  artswith("socks5
+0003d8a0: 3a2f 2f22 290a 2020 2020 293a 0a20 2020  ://").    ):.   
+0003d8b0: 2020 2020 2074 203d 2028 0a20 2020 2020       t = (.     
+0003d8c0: 2020 2020 2020 2022 5072 6f78 7920 6973         "Proxy is
+0003d8d0: 206e 6f74 2063 6f72 7265 6374 2e20 5072   not correct. Pr
+0003d8e0: 6f78 7920 7368 6f75 6c64 2073 7461 7274  oxy should start
+0003d8f0: 2077 6974 6820 220a 2020 2020 2020 2020   with ".        
+0003d900: 2020 2020 2722 6874 7470 3a2f 2f22 2c20      '"http://", 
+0003d910: 2273 6f63 6b73 343a 2f2f 2220 6f72 2022  "socks4://" or "
+0003d920: 736f 636b 7335 3a2f 2f22 2e20 270a 2020  socks5://". '.  
+0003d930: 2020 2020 2020 2020 2020 6627 2059 6f75            f' You
+0003d940: 7220 7072 6f78 7920 6973 2073 6574 2074  r proxy is set t
+0003d950: 6f20 227b 6773 2e70 612e 7072 6f78 797d  o "{gs.pa.proxy}
+0003d960: 222e 270a 2020 2020 2020 2020 290a 2020  ".'.        ).  
+0003d970: 2020 656c 6966 2053 5444 494e 5f54 4f54    elif STDIN_TOT
+0003d980: 414c 203e 2031 3a0a 2020 2020 2020 2020  AL > 1:.        
+0003d990: 7420 3d20 280a 2020 2020 2020 2020 2020  t = (.          
+0003d9a0: 2020 2754 6865 2063 6861 7261 6374 6572    'The character
+0003d9b0: 2022 2d22 2069 7320 7573 6564 206d 6f72   "-" is used mor
+0003d9c0: 6520 7468 616e 206f 6e63 6520 270a 2020  e than once '.  
+0003d9d0: 2020 2020 2020 2020 2020 2774 6f20 7265            'to re
+0003d9e0: 7072 6573 656e 7420 2273 7464 696e 2220  present "stdin" 
+0003d9f0: 666f 7220 7069 7069 6e67 2069 6e66 6f72  for piping infor
+0003da00: 6d61 7469 6f6e 2027 0a20 2020 2020 2020  mation '.       
+0003da10: 2020 2020 2066 2769 6e74 6f20 227b 5052       f'into "{PR
+0003da20: 4f47 5f57 4954 484f 5554 5f45 5854 7d22  OG_WITHOUT_EXT}"
+0003da30: 2e20 5374 6469 6e20 7069 7065 2063 616e  . Stdin pipe can
+0003da40: 2027 0a20 2020 2020 2020 2020 2020 2022   '.            "
+0003da50: 6265 2075 7365 6420 6174 206d 6f73 7420  be used at most 
+0003da60: 6f6e 6365 2e22 0a20 2020 2020 2020 2029  once.".        )
+0003da70: 0a20 2020 2065 6c69 6620 6773 2e70 612e  .    elif gs.pa.
+0003da80: 6e6f 5f73 736c 2061 6e64 2067 732e 7061  no_ssl and gs.pa
+0003da90: 2e73 736c 5f63 6572 7469 6669 6361 7465  .ssl_certificate
+0003daa0: 2021 3d20 5353 4c5f 4345 5254 4946 4943   != SSL_CERTIFIC
+0003dab0: 4154 455f 4445 4641 554c 543a 0a20 2020  ATE_DEFAULT:.   
+0003dac0: 2020 2020 2074 203d 2028 0a20 2020 2020       t = (.     
+0003dad0: 2020 2020 2020 2022 4f70 7469 6f6e 7320         "Options 
+0003dae0: 2d2d 6e6f 2d73 736c 2061 6e64 202d 2d73  --no-ssl and --s
+0003daf0: 736c 2d63 6572 7469 6669 6361 7465 2063  sl-certificate c
+0003db00: 616e 6e6f 7420 6265 2075 7365 6420 220a  annot be used ".
+0003db10: 2020 2020 2020 2020 2020 2020 2274 6f67              "tog
+0003db20: 6574 6865 722e 2055 7365 206f 6e65 206f  ether. Use one o
+0003db30: 7220 7468 6520 6f74 6865 722e 220a 2020  r the other.".  
+0003db40: 2020 2020 2020 290a 2020 2020 656c 7365        ).    else
+0003db50: 3a0a 2020 2020 2020 2020 6966 2067 732e  :.        if gs.
+0003db60: 7061 2e73 796e 6320 6973 204e 6f6e 653a  pa.sync is None:
+0003db70: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+0003db80: 7061 2e73 796e 6320 3d20 5359 4e43 5f44  pa.sync = SYNC_D
+0003db90: 4546 4155 4c54 0a20 2020 2020 2020 2067  EFAULT.        g
+0003dba0: 732e 6c6f 672e 6465 6275 6728 6622 4f70  s.log.debug(f"Op
+0003dbb0: 7469 6f6e 202d 2d73 796e 6320 6973 2073  tion --sync is s
+0003dbc0: 6574 2074 6f20 7b67 732e 7061 2e73 796e  et to {gs.pa.syn
+0003dbd0: 637d 2e22 290a 2020 2020 2020 2020 6773  c}.").        gs
+0003dbe0: 2e6c 6f67 2e64 6562 7567 2822 416c 6c20  .log.debug("All 
+0003dbf0: 6172 6775 6d65 6e74 7320 6172 6520 7661  arguments are va
+0003dc00: 6c69 642e 2041 6c6c 2063 6865 636b 7320  lid. All checks 
+0003dc10: 7061 7373 6564 2e22 290a 2020 2020 2020  passed.").      
+0003dc20: 2020 7265 7475 726e 2020 2320 616c 6c20    return  # all 
+0003dc30: 4f4b 0a20 2020 2023 2067 732e 6572 725f  OK.    # gs.err_
+0003dc40: 636f 756e 7420 2b3d 2031 2023 2064 6f20  count += 1 # do 
+0003dc50: 6e6f 7420 696e 6372 656d 656e 7420 666f  not increment fo
+0003dc60: 7220 4d61 7472 6978 436f 6d6d 616e 6465  r MatrixCommande
+0003dc70: 7245 7272 6f72 0a20 2020 2072 6169 7365  rError.    raise
+0003dc80: 204d 6174 7269 7843 6f6d 6d61 6e64 6572   MatrixCommander
+0003dc90: 4572 726f 7228 2245 3234 303a 2022 202b  Error("E240: " +
+0003dca0: 2074 2920 6672 6f6d 204e 6f6e 650a 0a0a   t) from None...
+0003dcb0: 636c 6173 7320 636f 6c6f 7273 3a0a 2020  class colors:.  
+0003dcc0: 2020 2222 2243 6f6c 6f72 7320 636c 6173    """Colors clas
+0003dcd0: 732e 0a0a 2020 2020 7265 7365 7420 616c  s...    reset al
+0003dce0: 6c20 636f 6c6f 7273 2077 6974 6820 636f  l colors with co
+0003dcf0: 6c6f 7273 2e72 6573 6574 2e0a 2020 2020  lors.reset..    
+0003dd00: 3220 7375 6220 636c 6173 7365 733a 2066  2 sub classes: f
+0003dd10: 6720 666f 7220 666f 7265 6772 6f75 6e64  g for foreground
+0003dd20: 2061 6e64 2062 6720 666f 7220 6261 636b   and bg for back
+0003dd30: 6772 6f75 6e64 3b0a 2020 2020 7573 6520  ground;.    use 
+0003dd40: 6173 2063 6f6c 6f72 732e 7375 6263 6c61  as colors.subcla
+0003dd50: 7373 2e63 6f6c 6f72 6e61 6d65 2e0a 2020  ss.colorname..  
+0003dd60: 2020 692e 652e 2063 6f6c 6f72 732e 6667    i.e. colors.fg
+0003dd70: 2e72 6564 206f 7220 636f 6c6f 7273 2e62  .red or colors.b
+0003dd80: 672e 6772 6565 6e0a 2020 2020 616c 736f  g.green.    also
+0003dd90: 2c20 7468 6520 6765 6e65 7269 6320 626f  , the generic bo
+0003dda0: 6c64 2c20 6469 7361 626c 652c 2075 6e64  ld, disable, und
+0003ddb0: 6572 6c69 6e65 2c20 7265 7665 7273 652c  erline, reverse,
+0003ddc0: 2073 7472 696b 6520 7468 726f 7567 682c   strike through,
+0003ddd0: 0a20 2020 2061 6e64 2069 6e76 6973 6962  .    and invisib
+0003dde0: 6c65 2077 6f72 6b20 7769 7468 2074 6865  le work with the
+0003ddf0: 206d 6169 6e20 636c 6173 7320 692e 652e   main class i.e.
+0003de00: 2063 6f6c 6f72 732e 626f 6c64 0a0a 2020   colors.bold..  
+0003de10: 2020 7573 6520 6c69 6b65 2074 6869 733a    use like this:
+0003de20: 0a20 2020 2070 7269 6e74 2863 6f6c 6f72  .    print(color
+0003de30: 732e 6267 2e67 7265 656e 2c20 2253 4b6b  s.bg.green, "SKk
+0003de40: 222c 2063 6f6c 6f72 732e 6667 2e72 6564  ", colors.fg.red
+0003de50: 2c20 2241 6d61 7274 7961 2229 0a20 2020  , "Amartya").   
+0003de60: 2070 7269 6e74 2863 6f6c 6f72 732e 6267   print(colors.bg
+0003de70: 2e6c 6967 6874 6772 6579 2c20 2253 4b6b  .lightgrey, "SKk
+0003de80: 222c 2063 6f6c 6f72 732e 6667 2e72 6564  ", colors.fg.red
+0003de90: 2c20 2241 6d61 7274 7961 2229 0a20 2020  , "Amartya").   
+0003dea0: 2022 2222 0a0a 2020 2020 7265 7365 7420   """..    reset 
+0003deb0: 3d20 225c 3033 335b 306d 220a 2020 2020  = "\033[0m".    
+0003dec0: 626f 6c64 203d 2022 5c30 3333 5b30 316d  bold = "\033[01m
+0003ded0: 220a 2020 2020 6469 7361 626c 6520 3d20  ".    disable = 
+0003dee0: 225c 3033 335b 3032 6d22 0a20 2020 2069  "\033[02m".    i
+0003def0: 6e76 6572 7365 203d 2022 5c30 3333 5b30  nverse = "\033[0
+0003df00: 336d 220a 2020 2020 756e 6465 726c 696e  3m".    underlin
+0003df10: 6520 3d20 225c 3033 335b 3034 6d22 0a20  e = "\033[04m". 
+0003df20: 2020 2062 6c69 6e6b 203d 2022 5c30 3333     blink = "\033
+0003df30: 5b30 356d 220a 2020 2020 626c 696e 6b32  [05m".    blink2
+0003df40: 203d 2022 5c30 3333 5b30 366d 220a 2020   = "\033[06m".  
+0003df50: 2020 7265 7665 7273 6520 3d20 225c 3033    reverse = "\03
+0003df60: 335b 3037 6d22 0a20 2020 2069 6e76 6973  3[07m".    invis
+0003df70: 6962 6c65 203d 2022 5c30 3333 5b30 386d  ible = "\033[08m
+0003df80: 220a 2020 2020 7374 7269 6b65 7468 726f  ".    strikethro
+0003df90: 7567 6820 3d20 225c 3033 335b 3039 6d22  ugh = "\033[09m"
+0003dfa0: 0a0a 2020 2020 636c 6173 7320 6667 3a0a  ..    class fg:.
+0003dfb0: 2020 2020 2020 2020 626c 6163 6b20 3d20          black = 
+0003dfc0: 225c 3033 335b 3330 6d22 0a20 2020 2020  "\033[30m".     
+0003dfd0: 2020 2072 6564 203d 2022 5c30 3333 5b33     red = "\033[3
+0003dfe0: 316d 220a 2020 2020 2020 2020 6772 6565  1m".        gree
+0003dff0: 6e20 3d20 225c 3033 335b 3332 6d22 0a20  n = "\033[32m". 
+0003e000: 2020 2020 2020 206f 7261 6e67 6520 3d20         orange = 
+0003e010: 225c 3033 335b 3333 6d22 0a20 2020 2020  "\033[33m".     
+0003e020: 2020 2062 6c75 6520 3d20 225c 3033 335b     blue = "\033[
+0003e030: 3334 6d22 0a20 2020 2020 2020 2070 7572  34m".        pur
+0003e040: 706c 6520 3d20 225c 3033 335b 3335 6d22  ple = "\033[35m"
+0003e050: 0a20 2020 2020 2020 2063 7961 6e20 3d20  .        cyan = 
+0003e060: 225c 3033 335b 3336 6d22 0a20 2020 2020  "\033[36m".     
+0003e070: 2020 206c 6967 6874 6772 6579 203d 2022     lightgrey = "
+0003e080: 5c30 3333 5b33 376d 220a 2020 2020 2020  \033[37m".      
+0003e090: 2020 6461 726b 6772 6579 203d 2022 5c30    darkgrey = "\0
+0003e0a0: 3333 5b39 306d 220a 2020 2020 2020 2020  33[90m".        
+0003e0b0: 6c69 6768 7472 6564 203d 2022 5c30 3333  lightred = "\033
+0003e0c0: 5b39 316d 220a 2020 2020 2020 2020 6c69  [91m".        li
+0003e0d0: 6768 7467 7265 656e 203d 2022 5c30 3333  ghtgreen = "\033
+0003e0e0: 5b39 326d 220a 2020 2020 2020 2020 7965  [92m".        ye
+0003e0f0: 6c6c 6f77 203d 2022 5c30 3333 5b39 336d  llow = "\033[93m
+0003e100: 220a 2020 2020 2020 2020 6c69 6768 7462  ".        lightb
+0003e110: 6c75 6520 3d20 225c 3033 335b 3934 6d22  lue = "\033[94m"
+0003e120: 0a20 2020 2020 2020 2070 696e 6b20 3d20  .        pink = 
+0003e130: 225c 3033 335b 3935 6d22 0a20 2020 2020  "\033[95m".     
+0003e140: 2020 206c 6967 6874 6379 616e 203d 2022     lightcyan = "
+0003e150: 5c30 3333 5b39 366d 220a 0a20 2020 2063  \033[96m"..    c
+0003e160: 6c61 7373 2062 673a 0a20 2020 2020 2020  lass bg:.       
+0003e170: 2062 6c61 636b 203d 2022 5c30 3333 5b34   black = "\033[4
+0003e180: 306d 220a 2020 2020 2020 2020 7265 6420  0m".        red 
+0003e190: 3d20 225c 3033 335b 3431 6d22 0a20 2020  = "\033[41m".   
+0003e1a0: 2020 2020 2067 7265 656e 203d 2022 5c30       green = "\0
+0003e1b0: 3333 5b34 326d 220a 2020 2020 2020 2020  33[42m".        
+0003e1c0: 6f72 616e 6765 203d 2022 5c30 3333 5b34  orange = "\033[4
+0003e1d0: 336d 220a 2020 2020 2020 2020 626c 7565  3m".        blue
+0003e1e0: 203d 2022 5c30 3333 5b34 346d 220a 2020   = "\033[44m".  
+0003e1f0: 2020 2020 2020 7075 7270 6c65 203d 2022        purple = "
+0003e200: 5c30 3333 5b34 356d 220a 2020 2020 2020  \033[45m".      
+0003e210: 2020 6379 616e 203d 2022 5c30 3333 5b34    cyan = "\033[4
+0003e220: 366d 220a 2020 2020 2020 2020 6c69 6768  6m".        ligh
+0003e230: 7467 7265 7920 3d20 225c 3033 335b 3437  tgrey = "\033[47
+0003e240: 6d22 0a0a 0a23 2061 6363 6f72 6469 6e67  m"...# according
+0003e250: 2074 6f20 6c69 6e74 6572 3a20 6675 6e63   to linter: func
+0003e260: 7469 6f6e 2069 7320 746f 6f20 636f 6d70  tion is too comp
+0003e270: 6c65 782c 2043 3930 310a 6465 6620 6d61  lex, C901.def ma
+0003e280: 696e 5f69 6e6e 6572 280a 2020 2020 6172  in_inner(.    ar
+0003e290: 6776 3a20 556e 696f 6e5b 4e6f 6e65 2c20  gv: Union[None, 
+0003e2a0: 6c69 7374 5d20 3d20 4e6f 6e65 0a29 202d  list] = None.) -
+0003e2b0: 3e20 4e6f 6e65 3a20 2023 206e 6f71 613a  > None:  # noqa:
+0003e2c0: 2043 3930 3120 2320 6967 6e6f 7265 206d   C901 # ignore m
+0003e2d0: 6363 6162 6520 6966 2d74 6f6f 2d63 6f6d  ccabe if-too-com
+0003e2e0: 706c 6578 0a20 2020 2022 2222 5275 6e20  plex.    """Run 
+0003e2f0: 7468 6520 7072 6f67 7261 6d2e 0a0a 2020  the program...  
+0003e300: 2020 4675 6e63 7469 6f6e 2073 6967 6e61    Function signa
+0003e310: 7475 7265 2069 6465 6e74 6963 616c 2074  ture identical t
+0003e320: 6f20 6d61 696e 2829 2e0a 2020 2020 506c  o main()..    Pl
+0003e330: 6561 7365 2073 6565 206d 6169 6e28 292e  ease see main().
+0003e340: 0a0a 2020 2020 5265 7475 726e 7320 4e6f  ..    Returns No
+0003e350: 6e65 2e20 5265 7475 726e 7320 6e6f 7468  ne. Returns noth
+0003e360: 696e 672e 0a0a 2020 2020 5261 6973 6573  ing...    Raises
+0003e370: 2065 7863 6570 7469 6f6e 2069 6620 616e   exception if an
+0003e380: 2065 7272 6f72 2069 7320 6465 7465 6374   error is detect
+0003e390: 6564 2e20 4d61 6e79 2065 7863 6570 7469  ed. Many excepti
+0003e3a0: 6f6e 7320 6172 650a 2020 2020 2020 2020  ons are.        
+0003e3b0: 706f 7373 6962 6c65 2e20 4f6e 6520 6f66  possible. One of
+0003e3c0: 2074 6865 6d20 6973 3a20 4d61 7472 6978   them is: Matrix
+0003e3d0: 436f 6d6d 616e 6465 7245 7272 6f72 2e0a  CommanderError..
+0003e3e0: 2020 2020 2020 2020 5365 7473 2067 6c6f          Sets glo
+0003e3f0: 6261 6c20 7374 6174 6520 746f 2063 6f6d  bal state to com
+0003e400: 6d75 6e69 6361 7465 2065 7272 6f72 732e  municate errors.
+0003e410: 0a0a 2020 2020 2222 220a 2020 2020 6966  ..    """.    if
+0003e420: 2061 7267 763a 0a20 2020 2020 2020 2073   argv:.        s
+0003e430: 7973 2e61 7267 7620 3d20 6172 6776 0a20  ys.argv = argv. 
+0003e440: 2020 2023 2070 7265 7061 7265 2074 6865     # prepare the
+0003e450: 2067 6c6f 6261 6c20 7374 6174 650a 2020   global state.  
+0003e460: 2020 676c 6f62 616c 2067 730a 2020 2020    global gs.    
+0003e470: 6773 203d 2047 6c6f 6261 6c53 7461 7465  gs = GlobalState
+0003e480: 2829 0a20 2020 2067 6c6f 6261 6c20 5345  ().    global SE
+0003e490: 500a 2020 2020 2320 436f 6e73 7472 7563  P.    # Construc
+0003e4a0: 7420 7468 6520 6172 6775 6d65 6e74 2070  t the argument p
+0003e4b0: 6172 7365 720a 2020 2020 6170 203d 2061  arser.    ap = a
+0003e4c0: 7267 7061 7273 652e 4172 6775 6d65 6e74  rgparse.Argument
+0003e4d0: 5061 7273 6572 280a 2020 2020 2020 2020  Parser(.        
+0003e4e0: 6164 645f 6865 6c70 3d46 616c 7365 2c0a  add_help=False,.
+0003e4f0: 2020 2020 2020 2020 6465 7363 7269 7074          descript
+0003e500: 696f 6e3d 2866 2257 656c 636f 6d65 2074  ion=(f"Welcome t
+0003e510: 6f20 7b50 524f 475f 5749 5448 4f55 545f  o {PROG_WITHOUT_
+0003e520: 4558 547d 2c20 6120 4d61 7472 6978 2043  EXT}, a Matrix C
+0003e530: 4c49 2063 6c69 656e 742e 2022 292c 0a20  LI client. "),. 
+0003e540: 2020 2020 2020 2065 7069 6c6f 673d 2259         epilog="Y
+0003e550: 6f75 2061 7265 2072 756e 6e69 6e67 2022  ou are running "
+0003e560: 0a20 2020 2020 2020 2066 2276 6572 7369  .        f"versi
+0003e570: 6f6e 207b 5645 5253 494f 4e4e 527d 207b  on {VERSIONNR} {
+0003e580: 5645 5253 494f 4e7d 2e20 456e 6a6f 792c  VERSION}. Enjoy,
+0003e590: 2073 7461 7220 6f6e 2047 6974 6875 6220   star on Github 
+0003e5a0: 616e 6420 220a 2020 2020 2020 2020 2263  and ".        "c
+0003e5b0: 6f6e 7472 6962 7574 6520 6279 2073 7562  ontribute by sub
+0003e5c0: 6d69 7474 696e 6720 6120 5075 6c6c 2052  mitting a Pull R
+0003e5d0: 6571 7565 7374 2e20 220a 2020 2020 2020  equest. ".      
+0003e5e0: 2020 6622 416c 736f 2068 6176 6520 6120    f"Also have a 
+0003e5f0: 6c6f 6f6b 2061 7420 7b50 524f 475f 5749  look at {PROG_WI
+0003e600: 5448 4f55 545f 4558 547d 2d74 7569 2e20  THOUT_EXT}-tui. 
+0003e610: 222c 0a20 2020 2029 0a20 2020 2023 202d  ",.    ).    # -
+0003e620: 682c 2073 6565 2061 6464 5f68 656c 703d  h, see add_help=
+0003e630: 4661 6c73 650a 2020 2020 6170 2e61 6464  False.    ap.add
+0003e640: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
+0003e650: 2020 2023 2073 6565 2073 6372 6970 7420     # see script 
+0003e660: 6372 6561 7465 2068 656c 702e 6865 6c70  create help.help
+0003e670: 2e74 7874 0a20 2020 2020 2020 2023 2068  .txt.        # h
+0003e680: 656c 7020 7374 7269 6e67 2075 7020 746f  elp string up to
+0003e690: 2062 7574 2065 7863 6c75 6469 6e67 2022   but excluding "
+0003e6a0: 4465 7461 696c 733a 3a22 2069 7320 7573  Details::" is us
+0003e6b0: 6564 2066 6f72 0a20 2020 2020 2020 2023  ed for.        #
+0003e6c0: 2028 7368 6f72 7429 2060 2d2d 6865 6c70   (short) `--help
+0003e6d0: 602e 2054 6865 2066 756c 6c20 7465 7874  `. The full text
+0003e6e0: 2077 696c 6c20 6265 2075 7365 6420 666f   will be used fo
+0003e6f0: 7220 6c6f 6e67 2060 2d2d 6d61 6e75 616c  r long `--manual
+0003e700: 602e 0a20 2020 2020 2020 2022 2d2d 7573  `..        "--us
+0003e710: 6167 6522 2c0a 2020 2020 2020 2020 7265  age",.        re
+0003e720: 7175 6972 6564 3d46 616c 7365 2c0a 2020  quired=False,.  
+0003e730: 2020 2020 2020 6163 7469 6f6e 3d22 7374        action="st
+0003e740: 6f72 655f 7472 7565 222c 0a20 2020 2020  ore_true",.     
+0003e750: 2020 2068 656c 703d 2250 7269 6e74 2075     help="Print u
+0003e760: 7361 6765 2e20 220a 2020 2020 2020 2020  sage. ".        
+0003e770: 2244 6574 6169 6c73 3a3a 2053 6565 2061  "Details:: See a
+0003e780: 6c73 6f20 2d2d 6865 6c70 2066 6f72 2070  lso --help for p
+0003e790: 7269 6e74 696e 6720 6120 6269 7420 6d6f  rinting a bit mo
+0003e7a0: 7265 2061 6e64 202d 2d6d 616e 7561 6c20  re and --manual 
+0003e7b0: 220a 2020 2020 2020 2020 2266 6f72 2070  ".        "for p
+0003e7c0: 7269 6e74 696e 6720 6120 6c6f 7420 6d6f  rinting a lot mo
+0003e7d0: 7265 2064 6574 6169 6c65 6420 696e 666f  re detailed info
+0003e7e0: 726d 6174 696f 6e2e 222c 0a20 2020 2029  rmation.",.    )
+0003e7f0: 0a20 2020 2023 202d 682c 2073 6565 2061  .    # -h, see a
 0003e800: 6464 5f68 656c 703d 4661 6c73 650a 2020  dd_help=False.  
 0003e810: 2020 6170 2e61 6464 5f61 7267 756d 656e    ap.add_argumen
-0003e820: 7428 0a20 2020 2020 2020 2022 2d2d 6d61  t(.        "--ma
-0003e830: 6e75 616c 222c 0a20 2020 2020 2020 2072  nual",.        r
-0003e840: 6571 7569 7265 643d 4661 6c73 652c 0a20  equired=False,. 
-0003e850: 2020 2020 2020 2061 6374 696f 6e3d 2273         action="s
-0003e860: 746f 7265 5f74 7275 6522 2c0a 2020 2020  tore_true",.    
-0003e870: 2020 2020 6865 6c70 3d22 5072 696e 7420      help="Print 
-0003e880: 6d61 6e75 616c 2e20 220a 2020 2020 2020  manual. ".      
-0003e890: 2020 2244 6574 6169 6c73 3a3a 2053 6565    "Details:: See
-0003e8a0: 2061 6c73 6f20 2d2d 7573 6167 6520 666f   also --usage fo
-0003e8b0: 7220 7072 696e 7469 6e67 2074 6865 2061  r printing the a
-0003e8c0: 6273 6f6c 7574 6520 6d69 6e69 6d75 6d2c  bsolute minimum,
-0003e8d0: 2022 0a20 2020 2020 2020 2022 616e 6420   ".        "and 
-0003e8e0: 2d2d 6865 6c70 2066 6f72 2070 7269 6e74  --help for print
-0003e8f0: 696e 6720 6c65 7373 2e22 2c0a 2020 2020  ing less.",.    
-0003e900: 290a 2020 2020 2320 7365 6520 2d68 2c20  ).    # see -h, 
-0003e910: 7365 6520 6164 645f 6865 6c70 3d46 616c  see add_help=Fal
-0003e920: 7365 0a20 2020 2061 702e 6164 645f 6172  se.    ap.add_ar
-0003e930: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
-0003e940: 222d 2d72 6561 646d 6522 2c0a 2020 2020  "--readme",.    
-0003e950: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
-0003e960: 7365 2c0a 2020 2020 2020 2020 6163 7469  se,.        acti
-0003e970: 6f6e 3d22 7374 6f72 655f 7472 7565 222c  on="store_true",
-0003e980: 0a20 2020 2020 2020 2068 656c 703d 2250  .        help="P
-0003e990: 7269 6e74 2052 4541 444d 452e 6d64 2066  rint README.md f
-0003e9a0: 696c 652e 2022 0a20 2020 2020 2020 2022  ile. ".        "
-0003e9b0: 4465 7461 696c 733a 3a20 5472 6965 7320  Details:: Tries 
-0003e9c0: 746f 2070 7269 6e74 2074 6865 206c 6f63  to print the loc
-0003e9d0: 616c 2052 4541 444d 452e 6d64 2066 696c  al README.md fil
-0003e9e0: 6520 6672 6f6d 2069 6e73 7461 6c6c 6174  e from installat
-0003e9f0: 696f 6e2e 2022 0a20 2020 2020 2020 2022  ion. ".        "
-0003ea00: 4966 206e 6f74 2066 6f75 6e64 2069 7420  If not found it 
-0003ea10: 7769 6c6c 2067 6574 2074 6865 2052 4541  will get the REA
-0003ea20: 444d 452e 6d64 2066 696c 6520 6672 6f6d  DME.md file from
-0003ea30: 2067 6974 6875 622e 636f 6d20 616e 6420   github.com and 
-0003ea40: 220a 2020 2020 2020 2020 2270 7269 6e74  ".        "print
-0003ea50: 2069 742e 2053 6565 2061 6c73 6f20 2d2d   it. See also --
-0003ea60: 7573 6167 652c 202d 2d68 656c 702c 2061  usage, --help, a
-0003ea70: 6e64 202d 2d6d 616e 7561 6c2e 222c 0a20  nd --manual.",. 
-0003ea80: 2020 2029 0a20 2020 2023 2041 6464 2074     ).    # Add t
-0003ea90: 6865 2061 7267 756d 656e 7473 2074 6f20  he arguments to 
-0003eaa0: 7468 6520 7061 7273 6572 0a20 2020 2061  the parser.    a
-0003eab0: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
-0003eac0: 2020 2020 2020 2020 222d 6422 2c0a 2020          "-d",.  
-0003ead0: 2020 2020 2020 222d 2d64 6562 7567 222c        "--debug",
-0003eae0: 0a20 2020 2020 2020 2061 6374 696f 6e3d  .        action=
-0003eaf0: 2263 6f75 6e74 222c 0a20 2020 2020 2020  "count",.       
-0003eb00: 2064 6566 6175 6c74 3d30 2c0a 2020 2020   default=0,.    
-0003eb10: 2020 2020 6865 6c70 3d22 5072 696e 7420      help="Print 
-0003eb20: 6465 6275 6720 696e 666f 726d 6174 696f  debug informatio
-0003eb30: 6e2e 2022 0a20 2020 2020 2020 2022 4465  n. ".        "De
-0003eb40: 7461 696c 733a 3a20 4966 2075 7365 6420  tails:: If used 
-0003eb50: 6f6e 6365 2c20 6f6e 6c79 2074 6865 206c  once, only the l
-0003eb60: 6f67 206c 6576 656c 206f 6620 220a 2020  og level of ".  
-0003eb70: 2020 2020 2020 6622 7b50 524f 475f 5749        f"{PROG_WI
-0003eb80: 5448 4f55 545f 4558 547d 2069 7320 7365  THOUT_EXT} is se
-0003eb90: 7420 746f 2044 4542 5547 2e20 220a 2020  t to DEBUG. ".  
-0003eba0: 2020 2020 2020 2749 6620 7573 6564 2074        'If used t
-0003ebb0: 7769 6365 2028 222d 6420 2d64 2220 6f72  wice ("-d -d" or
-0003ebc0: 2022 2d64 6422 2920 7468 656e 2027 0a20   "-dd") then '. 
-0003ebd0: 2020 2020 2020 2066 226c 6f67 206c 6576         f"log lev
-0003ebe0: 656c 7320 6f66 2062 6f74 6820 7b50 524f  els of both {PRO
-0003ebf0: 475f 5749 5448 4f55 545f 4558 547d 2061  G_WITHOUT_EXT} a
-0003ec00: 6e64 2075 6e64 6572 6c79 696e 6720 6d6f  nd underlying mo
-0003ec10: 6475 6c65 7320 6172 6520 220a 2020 2020  dules are ".    
-0003ec20: 2020 2020 2773 6574 2074 6f20 4445 4255      'set to DEBU
-0003ec30: 472e 2022 2d64 2220 6973 2061 2073 686f  G. "-d" is a sho
-0003ec40: 7274 6375 7420 666f 7220 222d 2d6c 6f67  rtcut for "--log
-0003ec50: 2d6c 6576 656c 2044 4542 5547 222e 2027  -level DEBUG". '
-0003ec60: 0a20 2020 2020 2020 2027 5365 6520 616c  .        'See al
-0003ec70: 736f 202d 2d6c 6f67 2d6c 6576 656c 2e20  so --log-level. 
-0003ec80: 222d 6422 2074 616b 6573 2070 7265 6365  "-d" takes prece
-0003ec90: 6465 6e63 6520 6f76 6572 2022 2d2d 6c6f  dence over "--lo
-0003eca0: 672d 6c65 7665 6c22 2e20 270a 2020 2020  g-level". '.    
-0003ecb0: 2020 2020 2741 6464 6974 696f 6e61 6c6c      'Additionall
-0003ecc0: 792c 2068 6176 6520 6120 6c6f 6f6b 2061  y, have a look a
-0003ecd0: 6c73 6f20 6174 2074 6865 206f 7074 696f  lso at the optio
-0003ece0: 6e20 222d 2d76 6572 626f 7365 222e 2027  n "--verbose". '
-0003ecf0: 2c0a 2020 2020 290a 2020 2020 6170 2e61  ,.    ).    ap.a
-0003ed00: 6464 5f61 7267 756d 656e 7428 0a20 2020  dd_argument(.   
-0003ed10: 2020 2020 2022 2d2d 6c6f 672d 6c65 7665       "--log-leve
-0003ed20: 6c22 2c0a 2020 2020 2020 2020 7265 7175  l",.        requ
-0003ed30: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
-0003ed40: 2020 2020 6163 7469 6f6e 3d22 6578 7465      action="exte
-0003ed50: 6e64 222c 0a20 2020 2020 2020 206e 6172  nd",.        nar
-0003ed60: 6773 3d22 2b22 2c0a 2020 2020 2020 2020  gs="+",.        
-0003ed70: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
-0003ed80: 2020 6d65 7461 7661 723d 2822 4445 4255    metavar=("DEBU
-0003ed90: 477c 494e 464f 7c57 4152 4e49 4e47 7c45  G|INFO|WARNING|E
-0003eda0: 5252 4f52 7c43 5249 5449 4341 4c22 292c  RROR|CRITICAL"),
-0003edb0: 0a20 2020 2020 2020 2068 656c 703d 2253  .        help="S
-0003edc0: 6574 2074 6865 206c 6f67 206c 6576 656c  et the log level
-0003edd0: 2873 292e 2022 0a20 2020 2020 2020 2022  (s). ".        "
-0003ede0: 4465 7461 696c 733a 3a20 506f 7373 6962  Details:: Possib
-0003edf0: 6c65 2076 616c 7565 7320 6172 6520 220a  le values are ".
-0003ee00: 2020 2020 2020 2020 2722 4445 4255 4722          '"DEBUG"
-0003ee10: 2c20 2249 4e46 4f22 2c20 2257 4152 4e49  , "INFO", "WARNI
-0003ee20: 4e47 222c 2022 4552 524f 5222 2c20 616e  NG", "ERROR", an
-0003ee30: 6420 2243 5249 5449 4341 4c22 2e20 270a  d "CRITICAL". '.
-0003ee40: 2020 2020 2020 2020 2249 6620 2d2d 6c6f          "If --lo
-0003ee50: 675f 6c65 7665 6c20 6973 2075 7365 6420  g_level is used 
-0003ee60: 7769 7468 206f 6e65 206c 6576 656c 2061  with one level a
-0003ee70: 7267 756d 656e 742c 206f 6e6c 7920 7468  rgument, only th
-0003ee80: 6520 6c6f 6720 6c65 7665 6c20 220a 2020  e log level ".  
-0003ee90: 2020 2020 2020 6622 6f66 207b 5052 4f47        f"of {PROG
-0003eea0: 5f57 4954 484f 5554 5f45 5854 7d20 6973  _WITHOUT_EXT} is
-0003eeb0: 2073 6574 2074 6f20 7468 6520 7370 6563   set to the spec
-0003eec0: 6966 6965 6420 7661 6c75 652e 2022 0a20  ified value. ". 
-0003eed0: 2020 2020 2020 2022 4966 202d 2d6c 6f67         "If --log
-0003eee0: 5f6c 6576 656c 2069 7320 7573 6564 2077  _level is used w
-0003eef0: 6974 6820 7477 6f20 6c65 7665 6c20 6172  ith two level ar
-0003ef00: 6775 6d65 6e74 2022 0a20 2020 2020 2020  gument ".       
-0003ef10: 2027 2865 2e67 2e20 222d 2d6c 6f67 2d6c   '(e.g. "--log-l
-0003ef20: 6576 656c 2057 4152 4e49 4e47 2045 5252  evel WARNING ERR
-0003ef30: 4f52 2229 2074 6865 6e20 270a 2020 2020  OR") then '.    
-0003ef40: 2020 2020 6622 6c6f 6720 6c65 7665 6c73      f"log levels
-0003ef50: 206f 6620 626f 7468 207b 5052 4f47 5f57   of both {PROG_W
-0003ef60: 4954 484f 5554 5f45 5854 7d20 616e 6420  ITHOUT_EXT} and 
-0003ef70: 756e 6465 726c 7969 6e67 206d 6f64 756c  underlying modul
-0003ef80: 6573 2061 7265 2022 0a20 2020 2020 2020  es are ".       
-0003ef90: 2022 7365 7420 746f 2074 6865 2073 7065   "set to the spe
-0003efa0: 6369 6669 6564 2076 616c 7565 732e 2022  cified values. "
-0003efb0: 0a20 2020 2020 2020 2022 5365 6520 616c  .        "See al
-0003efc0: 736f 202d 2d64 6562 7567 2e22 2c0a 2020  so --debug.",.  
-0003efd0: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
-0003efe0: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
-0003eff0: 2022 2d2d 7665 7262 6f73 6522 2c0a 2020   "--verbose",.  
-0003f000: 2020 2020 2020 6163 7469 6f6e 3d22 636f        action="co
-0003f010: 756e 7422 2c0a 2020 2020 2020 2020 6465  unt",.        de
-0003f020: 6661 756c 743d 302c 0a20 2020 2020 2020  fault=0,.       
-0003f030: 2068 656c 703d 2253 6574 2074 6865 2076   help="Set the v
-0003f040: 6572 626f 7369 7479 206c 6576 656c 2e20  erbosity level. 
-0003f050: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
-0003f060: 6c73 3a3a 2049 6620 6e6f 7420 7573 6564  ls:: If not used
-0003f070: 2c20 7468 656e 2076 6572 626f 7369 7479  , then verbosity
-0003f080: 2077 696c 6c20 6265 2022 0a20 2020 2020   will be ".     
-0003f090: 2020 2022 7365 7420 746f 206c 6f77 2e20     "set to low. 
-0003f0a0: 4966 2075 7365 6420 6f6e 6365 2c20 7665  If used once, ve
-0003f0b0: 7262 6f73 6974 7920 7769 6c6c 2062 6520  rbosity will be 
-0003f0c0: 6869 6768 2e20 220a 2020 2020 2020 2020  high. ".        
-0003f0d0: 2249 6620 7573 6564 206d 6f72 6520 7468  "If used more th
-0003f0e0: 616e 206f 6e63 652c 2076 6572 626f 7369  an once, verbosi
-0003f0f0: 7479 2077 696c 6c20 6265 2076 6572 7920  ty will be very 
-0003f100: 6869 6768 2e20 220a 2020 2020 2020 2020  high. ".        
-0003f110: 2256 6572 626f 7369 7479 206f 6e6c 7920  "Verbosity only 
-0003f120: 6166 6665 6374 7320 7468 6520 6465 6275  affects the debu
-0003f130: 6720 696e 666f 726d 6174 696f 6e2e 2022  g information. "
-0003f140: 0a20 2020 2020 2020 2022 536f 2c20 6966  .        "So, if
-0003f150: 2027 2d2d 6465 6275 6727 2069 7320 6e6f   '--debug' is no
-0003f160: 7420 7573 6564 2074 6865 6e20 272d 2d76  t used then '--v
-0003f170: 6572 626f 7365 2720 7769 6c6c 2062 6520  erbose' will be 
-0003f180: 6967 6e6f 7265 642e 222c 0a20 2020 2029  ignored.",.    )
-0003f190: 0a20 2020 2061 702e 6164 645f 6172 6775  .    ap.add_argu
-0003f1a0: 6d65 6e74 280a 2020 2020 2020 2020 222d  ment(.        "-
-0003f1b0: 2d6c 6f67 696e 222c 0a20 2020 2020 2020  -login",.       
-0003f1c0: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
-0003f1d0: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
-0003f1e0: 722c 2020 2320 6c6f 6769 6e20 6d65 7468  r,  # login meth
-0003f1f0: 6f64 3a20 7061 7373 776f 7264 2c20 7373  od: password, ss
-0003f200: 6f2c 2028 6163 6365 7373 2d74 6f6b 656e  o, (access-token
-0003f210: 290a 2020 2020 2020 2020 6d65 7461 7661  ).        metava
-0003f220: 723d 2250 4153 5357 4f52 447c 5353 4f22  r="PASSWORD|SSO"
-0003f230: 2c0a 2020 2020 2020 2020 6865 6c70 3d22  ,.        help="
-0003f240: 4c6f 6769 6e20 746f 2061 6e64 2061 7574  Login to and aut
-0003f250: 6865 6e74 6963 6174 6520 7769 7468 2074  henticate with t
-0003f260: 6865 204d 6174 7269 7820 686f 6d65 7365  he Matrix homese
-0003f270: 7276 6572 2e20 220a 2020 2020 2020 2020  rver. ".        
-0003f280: 2244 6574 6169 6c73 3a3a 2054 6869 7320  "Details:: This 
-0003f290: 7265 7175 6972 6573 2065 7861 6374 6c79  requires exactly
-0003f2a0: 206f 6e65 2061 7267 756d 656e 742c 2074   one argument, t
-0003f2b0: 6865 206c 6f67 696e 206d 6574 686f 642e  he login method.
-0003f2c0: 2022 0a20 2020 2020 2020 2022 4375 7272   ".        "Curr
-0003f2d0: 656e 746c 7920 7477 6f20 6368 6f69 6365  ently two choice
-0003f2e0: 7320 6172 6520 6f66 6665 7265 643a 2027  s are offered: '
-0003f2f0: 7061 7373 776f 7264 2720 616e 6420 2773  password' and 's
-0003f300: 736f 272e 2022 0a20 2020 2020 2020 2022  so'. ".        "
-0003f310: 5072 6f76 6964 6520 6f6e 6520 6f66 2074  Provide one of t
-0003f320: 6865 7365 206d 6574 686f 6473 2e20 220a  hese methods. ".
-0003f330: 2020 2020 2020 2020 2249 6620 796f 7520          "If you 
-0003f340: 6861 7665 2063 686f 7365 6e20 2770 6173  have chosen 'pas
-0003f350: 7377 6f72 6427 2c20 220a 2020 2020 2020  sword', ".      
-0003f360: 2020 2279 6f75 2077 696c 6c20 6175 7468    "you will auth
-0003f370: 656e 7469 6361 7465 2074 6872 6f75 6768  enticate through
-0003f380: 2079 6f75 7220 6163 636f 756e 7420 7061   your account pa
-0003f390: 7373 776f 7264 2e20 596f 7520 6361 6e20  ssword. You can 
-0003f3a0: 220a 2020 2020 2020 2020 226f 7074 696f  ".        "optio
-0003f3b0: 6e61 6c6c 7920 7072 6f76 6964 6520 7468  nally provide th
-0003f3c0: 6573 6520 6164 6469 7469 6f6e 616c 2061  ese additional a
-0003f3d0: 7267 756d 656e 7473 3a20 220a 2020 2020  rguments: ".    
-0003f3e0: 2020 2020 222d 2d68 6f6d 6573 6572 7665      "--homeserve
-0003f3f0: 7220 746f 2073 7065 6369 6679 2074 6865  r to specify the
-0003f400: 204d 6174 7269 7820 686f 6d65 7365 7276   Matrix homeserv
-0003f410: 6572 2c20 220a 2020 2020 2020 2020 222d  er, ".        "-
-0003f420: 2d75 7365 722d 6c6f 6769 6e20 746f 2073  -user-login to s
-0003f430: 7065 6369 6679 2074 6865 206c 6f67 2069  pecify the log i
-0003f440: 6e20 7573 6572 2069 642c 2022 0a20 2020  n user id, ".   
-0003f450: 2020 2020 2022 2d2d 7061 7373 776f 7264       "--password
-0003f460: 2074 6f20 7370 6563 6966 7920 7468 6520   to specify the 
-0003f470: 7061 7373 776f 7264 2c20 220a 2020 2020  password, ".    
-0003f480: 2020 2020 222d 2d64 6576 6963 6520 746f      "--device to
-0003f490: 2073 7065 6369 6679 2061 2064 6576 6963   specify a devic
-0003f4a0: 6520 6e61 6d65 2c20 220a 2020 2020 2020  e name, ".      
-0003f4b0: 2020 222d 2d72 6f6f 6d2d 6465 6661 756c    "--room-defaul
-0003f4c0: 7420 746f 2073 7065 6369 6679 2061 2064  t to specify a d
-0003f4d0: 6566 6175 6c74 2072 6f6f 6d20 666f 7220  efault room for 
-0003f4e0: 7365 6e64 696e 672f 6c69 7374 656e 696e  sending/listenin
-0003f4f0: 672e 2022 0a20 2020 2020 2020 2022 4966  g. ".        "If
-0003f500: 2079 6f75 2068 6176 6520 6368 6f73 656e   you have chosen
-0003f510: 2027 7373 6f27 2c20 220a 2020 2020 2020   'sso', ".      
-0003f520: 2020 2279 6f75 2077 696c 6c20 6175 7468    "you will auth
-0003f530: 656e 7469 6361 7465 2074 6872 6f75 6768  enticate through
-0003f540: 2053 696e 676c 6520 5369 676e 2d4f 6e2e   Single Sign-On.
-0003f550: 2041 2077 6562 2d62 726f 7773 6572 2077   A web-browser w
-0003f560: 696c 6c20 220a 2020 2020 2020 2020 2262  ill ".        "b
-0003f570: 6520 7374 6172 7465 6420 616e 6420 796f  e started and yo
-0003f580: 7520 6175 7468 656e 7469 6361 7465 206f  u authenticate o
-0003f590: 6e20 7468 6520 7765 6270 6167 652e 2059  n the webpage. Y
-0003f5a0: 6f75 2063 616e 2022 0a20 2020 2020 2020  ou can ".       
-0003f5b0: 2022 6f70 7469 6f6e 616c 6c79 2070 726f   "optionally pro
-0003f5c0: 7669 6465 2074 6865 7365 2061 6464 6974  vide these addit
-0003f5d0: 696f 6e61 6c20 6172 6775 6d65 6e74 733a  ional arguments:
-0003f5e0: 2022 0a20 2020 2020 2020 2022 2d2d 686f   ".        "--ho
-0003f5f0: 6d65 7365 7276 6572 2074 6f20 7370 6563  meserver to spec
-0003f600: 6966 7920 7468 6520 4d61 7472 6978 2068  ify the Matrix h
-0003f610: 6f6d 6573 6572 7665 722c 2022 0a20 2020  omeserver, ".   
-0003f620: 2020 2020 2022 2d2d 7573 6572 2d6c 6f67       "--user-log
-0003f630: 696e 2074 6f20 7370 6563 6966 7920 7468  in to specify th
-0003f640: 6520 6c6f 6720 696e 2075 7365 7220 6964  e log in user id
-0003f650: 2c20 220a 2020 2020 2020 2020 222d 2d64  , ".        "--d
-0003f660: 6576 6963 6520 746f 2073 7065 6369 6679  evice to specify
-0003f670: 2061 2064 6576 6963 6520 6e61 6d65 2c20   a device name, 
-0003f680: 220a 2020 2020 2020 2020 222d 2d72 6f6f  ".        "--roo
-0003f690: 6d2d 6465 6661 756c 7420 746f 2073 7065  m-default to spe
-0003f6a0: 6369 6679 2061 2064 6566 6175 6c74 2072  cify a default r
-0003f6b0: 6f6f 6d20 666f 7220 7365 6e64 696e 672f  oom for sending/
-0003f6c0: 6c69 7374 656e 696e 672e 2022 0a20 2020  listening. ".   
-0003f6d0: 2020 2020 2022 5365 6520 616c 6c20 7468       "See all th
-0003f6e0: 6520 6578 7472 6120 6172 6775 6d65 6e74  e extra argument
-0003f6f0: 7320 666f 7220 6675 7274 6865 7220 6578  s for further ex
-0003f700: 706c 616e 6174 696f 6e73 2e20 2d2d 2d2d  planations. ----
-0003f710: 2d20 220a 2020 2020 2020 2020 2253 534f  - ".        "SSO
-0003f720: 2028 5369 6e67 6c65 2053 6967 6e2d 4f6e   (Single Sign-On
-0003f730: 2920 7374 6172 7473 2061 2077 6562 2022  ) starts a web "
-0003f740: 0a20 2020 2020 2020 2022 6272 6f77 7365  .        "browse
-0003f750: 7220 616e 6420 636f 6e6e 6563 7473 2074  r and connects t
-0003f760: 6865 2075 7365 7220 746f 2061 2077 6562  he user to a web
-0003f770: 2070 6167 6520 6f6e 2074 6865 2022 0a20   page on the ". 
-0003f780: 2020 2020 2020 2022 7365 7276 6572 2066         "server f
-0003f790: 6f72 206c 6f67 696e 2e20 5353 4f20 7769  or login. SSO wi
-0003f7a0: 6c6c 206f 6e6c 7920 776f 726b 2069 6620  ll only work if 
-0003f7b0: 7468 6520 7365 7276 6572 2022 0a20 2020  the server ".   
-0003f7c0: 2020 2020 2022 7375 7070 6f72 7473 2069       "supports i
-0003f7d0: 7420 616e 6420 6966 2074 6865 7265 2069  t and if there i
-0003f7e0: 7320 6163 6365 7373 2074 6f20 6120 6272  s access to a br
-0003f7f0: 6f77 7365 722e 2053 6f2c 2064 6f6e 2774  owser. So, don't
-0003f800: 2075 7365 2053 534f 2022 0a20 2020 2020   use SSO ".     
-0003f810: 2020 2022 6f6e 2068 6561 646c 6573 7320     "on headless 
-0003f820: 686f 6d65 7365 7276 6572 7320 7768 6572  homeservers wher
-0003f830: 6520 7468 6572 6520 6973 206e 6f20 220a  e there is no ".
-0003f840: 2020 2020 2020 2020 2262 726f 7773 6572          "browser
-0003f850: 2069 6e73 7461 6c6c 6564 206f 7220 6163   installed or ac
-0003f860: 6365 7373 6962 6c65 2e22 2c0a 2020 2020  cessible.",.    
-0003f870: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
-0003f880: 756d 656e 7428 0a20 2020 2020 2020 2023  ument(.        #
-0003f890: 2022 2d76 222c 2023 2320 696e 636f 6d70   "-v", ## incomp
-0003f8a0: 6174 6962 6c65 2063 6861 6e67 652c 202d  atible change, -
-0003f8b0: 7620 6d6f 7665 6420 746f 202d 2d76 6572  v moved to --ver
-0003f8c0: 7369 6f6e 0a20 2020 2020 2020 2022 2d2d  sion.        "--
-0003f8d0: 7665 7269 6679 222c 0a20 2020 2020 2020  verify",.       
-0003f8e0: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
-0003f8f0: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
-0003f900: 722c 0a20 2020 2020 2020 2064 6566 6175  r,.        defau
-0003f910: 6c74 3d56 4552 4946 595f 554e 5553 4544  lt=VERIFY_UNUSED
-0003f920: 5f44 4546 4155 4c54 2c20 2023 2077 6865  _DEFAULT,  # whe
-0003f930: 6e20 2d74 2069 7320 6e6f 7420 7573 6564  n -t is not used
-0003f940: 0a20 2020 2020 2020 206e 6172 6773 3d22  .        nargs="
-0003f950: 3f22 2c20 2023 206d 616b 6573 2074 6865  ?",  # makes the
-0003f960: 2077 6f72 6420 6f70 7469 6f6e 616c 0a20   word optional. 
-0003f970: 2020 2020 2020 2023 2077 6865 6e20 2d76         # when -v
-0003f980: 2069 7320 7573 6564 2c20 6275 7420 7465   is used, but te
-0003f990: 7874 2069 7320 6e6f 7420 6164 6465 640a  xt is not added.
-0003f9a0: 2020 2020 2020 2020 636f 6e73 743d 5645          const=VE
-0003f9b0: 5249 4659 5f55 5345 445f 4445 4641 554c  RIFY_USED_DEFAUL
-0003f9c0: 542c 0a20 2020 2020 2020 206d 6574 6176  T,.        metav
-0003f9d0: 6172 3d22 454d 4f4a 4922 2c0a 2020 2020  ar="EMOJI",.    
-0003f9e0: 2020 2020 6865 6c70 3d22 5065 7266 6f72      help="Perfor
-0003f9f0: 6d20 7665 7269 6669 6361 7469 6f6e 2e20  m verification. 
-0003fa00: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
-0003fa10: 6c73 3a3a 2042 7920 6465 6661 756c 742c  ls:: By default,
-0003fa20: 206e 6f20 220a 2020 2020 2020 2020 2276   no ".        "v
-0003fa30: 6572 6966 6963 6174 696f 6e20 6973 2070  erification is p
-0003fa40: 6572 666f 726d 6564 2e20 220a 2020 2020  erformed. ".    
-0003fa50: 2020 2020 6627 506f 7373 6962 6c65 2076      f'Possible v
-0003fa60: 616c 7565 7320 6172 653a 2022 7b45 4d4f  alues are: "{EMO
-0003fa70: 4a49 7d22 2e20 270a 2020 2020 2020 2020  JI}". '.        
-0003fa80: 2249 6620 7665 7269 6669 6361 7469 6f6e  "If verification
-0003fa90: 2069 7320 6465 7369 7265 642c 2072 756e   is desired, run
-0003faa0: 2074 6869 7320 7072 6f67 7261 6d20 696e   this program in
-0003fab0: 2074 6865 2022 0a20 2020 2020 2020 2022   the ".        "
-0003fac0: 666f 7265 6772 6f75 6e64 2028 6e6f 7420  foreground (not 
-0003fad0: 6173 2061 2073 6572 7669 6365 2920 616e  as a service) an
-0003fae0: 6420 7769 7468 6f75 7420 6120 7069 7065  d without a pipe
-0003faf0: 2e20 220a 2020 2020 2020 2020 2257 6869  . ".        "Whi
-0003fb00: 6c65 2076 6572 6966 6963 6174 696f 6e20  le verification 
-0003fb10: 6973 206f 7074 696f 6e61 6c20 6974 2069  is optional it i
-0003fb20: 7320 6869 6768 6c79 2072 6563 6f6d 6d65  s highly recomme
-0003fb30: 6e64 6564 2c20 616e 6420 6974 2022 0a20  nded, and it ". 
-0003fb40: 2020 2020 2020 2022 6973 2072 6563 6f6d         "is recom
-0003fb50: 6d65 6e64 6564 2074 6f20 6265 2064 6f6e  mended to be don
-0003fb60: 6520 7269 6768 7420 6166 7465 7220 286f  e right after (o
-0003fb70: 7220 746f 6765 7468 6572 2077 6974 6829  r together with)
-0003fb80: 2074 6865 2022 0a20 2020 2020 2020 2022   the ".        "
-0003fb90: 2d2d 6c6f 6769 6e20 6163 7469 6f6e 2e20  --login action. 
-0003fba0: 5665 7269 6669 6361 7469 6f6e 2069 7320  Verification is 
-0003fbb0: 616c 7761 7973 2069 6e74 6572 6163 7469  always interacti
-0003fbc0: 7665 2c20 692e 652e 2069 7420 220a 2020  ve, i.e. it ".  
-0003fbd0: 2020 2020 2020 2272 6571 7569 7265 6420        "required 
-0003fbe0: 6b65 7962 6f61 7264 2069 6e70 7574 2e20  keyboard input. 
-0003fbf0: 220a 2020 2020 2020 2020 2256 6572 6966  ".        "Verif
-0003fc00: 6963 6174 696f 6e20 7175 6573 7469 6f6e  ication question
-0003fc10: 7320 220a 2020 2020 2020 2020 2277 696c  s ".        "wil
-0003fc20: 6c20 6265 2070 7269 6e74 6564 206f 6e20  l be printed on 
-0003fc30: 7374 646f 7574 2061 6e64 2074 6865 2075  stdout and the u
-0003fc40: 7365 7220 6861 7320 746f 2072 6573 706f  ser has to respo
-0003fc50: 6e64 2022 0a20 2020 2020 2020 2022 7669  nd ".        "vi
-0003fc60: 6120 7468 6520 6b65 7962 6f61 7264 2074  a the keyboard t
-0003fc70: 6f20 6163 6365 7074 206f 7220 7265 6a65  o accept or reje
-0003fc80: 6374 2076 6572 6966 6963 6174 696f 6e2e  ct verification.
-0003fc90: 2022 0a20 2020 2020 2020 2022 4f6e 6365   ".        "Once
-0003fca0: 2076 6572 6966 6963 6174 696f 6e20 6973   verification is
-0003fcb0: 2063 6f6d 706c 6574 652c 2074 6865 2070   complete, the p
-0003fcc0: 726f 6772 616d 206d 6179 2062 6520 220a  rogram may be ".
-0003fcd0: 2020 2020 2020 2020 2272 756e 2061 7320          "run as 
-0003fce0: 6120 7365 7276 6963 652e 2056 6572 6966  a service. Verif
-0003fcf0: 6963 6174 696f 6e20 6973 2062 6573 7420  ication is best 
-0003fd00: 646f 6e65 2061 7320 666f 6c6c 6f77 733a  done as follows:
-0003fd10: 2022 0a20 2020 2020 2020 2022 5065 7266   ".        "Perf
-0003fd20: 6f72 6d20 6120 6372 6f73 732d 6465 7669  orm a cross-devi
-0003fd30: 6365 2076 6572 6966 6963 6174 696f 6e2c  ce verification,
-0003fd40: 2074 6861 7420 6d65 616e 732c 2070 6572   that means, per
-0003fd50: 666f 726d 2061 2022 0a20 2020 2020 2020  form a ".       
-0003fd60: 2022 7665 7269 6669 6361 7469 6f6e 2062   "verification b
-0003fd70: 6574 7765 656e 2074 776f 2064 6576 6963  etween two devic
-0003fd80: 6573 206f 6620 7468 6520 2a73 616d 652a  es of the *same*
-0003fd90: 2075 7365 722e 2046 6f72 2074 6861 742c   user. For that,
-0003fda0: 2022 0a20 2020 2020 2020 2022 6f70 656e   ".        "open
-0003fdb0: 2028 652e 672e 2920 456c 656d 656e 7420   (e.g.) Element 
-0003fdc0: 696e 2061 2062 726f 7773 6572 2c20 6d61  in a browser, ma
-0003fdd0: 6b65 2073 7572 6520 456c 656d 656e 7420  ke sure Element 
-0003fde0: 6973 2075 7369 6e67 2074 6865 2022 0a20  is using the ". 
-0003fdf0: 2020 2020 2020 2066 2273 616d 6520 7573         f"same us
-0003fe00: 6572 2061 6363 6f75 6e74 2061 7320 7468  er account as th
-0003fe10: 6520 7b50 524f 475f 5749 5448 4f55 545f  e {PROG_WITHOUT_
-0003fe20: 4558 547d 2075 7365 7220 2873 7065 6369  EXT} user (speci
-0003fe30: 6669 6564 2077 6974 6820 220a 2020 2020  fied with ".    
-0003fe40: 2020 2020 222d 2d75 7365 722d 6c6f 6769      "--user-logi
-0003fe50: 6e20 6174 202d 2d6c 6f67 696e 292e 204e  n at --login). N
-0003fe60: 6f77 2069 6e20 7468 6520 456c 656d 656e  ow in the Elemen
-0003fe70: 7420 7765 6270 6167 6520 676f 2074 6f20  t webpage go to 
-0003fe80: 7468 6520 726f 6f6d 2022 0a20 2020 2020  the room ".     
-0003fe90: 2020 2066 2274 6861 7420 6973 2074 6865     f"that is the
-0003fea0: 207b 5052 4f47 5f57 4954 484f 5554 5f45   {PROG_WITHOUT_E
-0003feb0: 5854 7d20 6465 6661 756c 7420 726f 6f6d  XT} default room
-0003fec0: 2028 7370 6563 6966 6965 6420 7769 7468   (specified with
-0003fed0: 2022 0a20 2020 2020 2020 2022 2d2d 726f   ".        "--ro
-0003fee0: 6f6d 2d64 6566 6175 6c74 2061 7420 2d2d  om-default at --
-0003fef0: 6c6f 6769 6e29 2e20 4f4b 2c20 696e 2074  login). OK, in t
-0003ff00: 6865 2077 6562 2d62 726f 7773 6572 2079  he web-browser y
-0003ff10: 6f75 2061 7265 206e 6f77 2074 6865 2022  ou are now the "
-0003ff20: 0a20 2020 2020 2020 2066 2273 616d 6520  .        f"same 
-0003ff30: 7573 6572 2061 6e64 2069 6e20 7468 6520  user and in the 
-0003ff40: 7361 6d65 2072 6f6f 6d20 6173 207b 5052  same room as {PR
-0003ff50: 4f47 5f57 4954 484f 5554 5f45 5854 7d2e  OG_WITHOUT_EXT}.
-0003ff60: 2022 0a20 2020 2020 2020 2022 4e6f 7720   ".        "Now 
-0003ff70: 636c 6963 6b20 7468 6520 726f 756e 6420  click the round 
-0003ff80: 2769 2720 2752 6f6f 6d20 496e 666f 2720  'i' 'Room Info' 
-0003ff90: 6963 6f6e 2c20 7468 656e 2063 6c69 636b  icon, then click
-0003ffa0: 2027 5065 6f70 6c65 272c 2022 0a20 2020   'People', ".   
-0003ffb0: 2020 2020 2066 2263 6c69 636b 2074 6865       f"click the
-0003ffc0: 2061 7070 726f 7072 6961 7465 2075 7365   appropriate use
-0003ffd0: 7220 2874 6865 207b 5052 4f47 5f57 4954  r (the {PROG_WIT
-0003ffe0: 484f 5554 5f45 5854 7d20 7573 6572 292c  HOUT_EXT} user),
-0003fff0: 2022 0a20 2020 2020 2020 2022 636c 6963   ".        "clic
-00040000: 6b20 7265 6420 274e 6f74 2054 7275 7374  k red 'Not Trust
-00040010: 6564 2720 7465 7874 2022 0a20 2020 2020  ed' text ".     
-00040020: 2020 2022 7768 6963 6820 696e 6469 6361     "which indica
-00040030: 7465 6420 616e 2075 6e74 7275 7374 6564  ted an untrusted
-00040040: 2064 6576 6963 652c 2074 6865 6e20 636c   device, then cl
-00040050: 6963 6b20 7468 6520 7371 7561 7265 2022  ick the square "
-00040060: 0a20 2020 2020 2020 2022 2749 6e74 6572  .        "'Inter
-00040070: 6163 7469 7665 6c79 2076 6572 6966 7920  actively verify 
-00040080: 6279 2045 6d6f 6a69 2720 6275 7474 6f6e  by Emoji' button
-00040090: 2028 6f6e 6520 6f66 2033 2062 7574 746f   (one of 3 butto
-000400a0: 6e20 6368 6f69 6365 7329 2e20 220a 2020  n choices). ".  
-000400b0: 2020 2020 2020 6622 4174 2074 6869 7320        f"At this 
-000400c0: 706f 696e 7420 626f 7468 2077 6562 2d70  point both web-p
-000400d0: 6167 6520 616e 6420 7b50 524f 475f 5749  age and {PROG_WI
-000400e0: 5448 4f55 545f 4558 547d 2069 6e20 7465  THOUT_EXT} in te
-000400f0: 726d 696e 616c 2022 0a20 2020 2020 2020  rminal ".       
-00040100: 2022 7368 6f77 2061 2073 6574 206f 6620   "show a set of 
-00040110: 656d 6f6a 6920 6963 6f6e 7320 616e 6420  emoji icons and 
-00040120: 6e61 6d65 732e 2043 6f6d 7061 7265 2074  names. Compare t
-00040130: 6865 6d20 7669 7375 616c 6c79 2e20 220a  hem visually. ".
-00040140: 2020 2020 2020 2020 2243 6f6e 6669 726d          "Confirm
-00040150: 206f 6e20 626f 7468 2073 6964 6573 2028   on both sides (
-00040160: 5965 732c 2054 6865 7920 4d61 7463 682c  Yes, They Match,
-00040170: 2047 6f74 2069 7429 2c20 6669 6e61 6c6c   Got it), finall
-00040180: 7920 636c 6963 6b20 4f4b 2e20 220a 2020  y click OK. ".  
-00040190: 2020 2020 2020 2259 6f75 2073 686f 756c        "You shoul
-000401a0: 6420 7365 6520 6120 6772 6565 6e20 7368  d see a green sh
-000401b0: 6965 6c64 2061 6e64 2061 6c73 6f20 7365  ield and also se
-000401c0: 6520 7468 6174 2074 6865 2022 0a20 2020  e that the ".   
-000401d0: 2020 2020 2066 227b 5052 4f47 5f57 4954       f"{PROG_WIT
-000401e0: 484f 5554 5f45 5854 7d20 6465 7669 6365  HOUT_EXT} device
-000401f0: 2069 7320 6e6f 7720 6772 6565 6e20 616e   is now green an
-00040200: 6420 7665 7269 6669 6564 2069 6e20 7468  d verified in th
-00040210: 6520 7765 6270 6167 652e 2022 0a20 2020  e webpage. ".   
-00040220: 2020 2020 2022 496e 2074 6865 2074 6572       "In the ter
-00040230: 6d69 6e61 6c20 796f 7520 7368 6f75 6c64  minal you should
-00040240: 2073 6565 2061 2074 6578 7420 6d65 7373   see a text mess
-00040250: 6167 6520 696e 6469 6361 7469 6e67 2073  age indicating s
-00040260: 7563 6365 7373 2e20 220a 2020 2020 2020  uccess. ".      
-00040270: 2020 2259 6f75 2073 686f 756c 6420 6e6f    "You should no
-00040280: 7720 6265 2076 6572 6966 6965 6420 6163  w be verified ac
-00040290: 726f 7373 2061 6c6c 2064 6576 6963 6573  ross all devices
-000402a0: 2061 6e64 2061 6372 6f73 7320 616c 6c20   and across all 
-000402b0: 7573 6572 732e 222c 0a20 2020 2029 0a20  users.",.    ). 
-000402c0: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
-000402d0: 6e74 280a 2020 2020 2020 2020 222d 2d6c  nt(.        "--l
-000402e0: 6f67 6f75 7422 2c0a 2020 2020 2020 2020  ogout",.        
-000402f0: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
-00040300: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
-00040310: 2c20 2023 206c 6f67 6f75 7420 6f70 7469  ,  # logout opti
-00040320: 6f6e 733a 206d 6520 616e 6420 616c 6c0a  ons: me and all.
-00040330: 2020 2020 2020 2020 6d65 7461 7661 723d          metavar=
-00040340: 224d 457c 414c 4c22 2c0a 2020 2020 2020  "ME|ALL",.      
-00040350: 2020 6865 6c70 3d22 4c6f 676f 7574 2e20    help="Logout. 
-00040360: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
-00040370: 6c73 3a3a 204c 6f67 6f75 7420 7468 6973  ls:: Logout this
-00040380: 206f 7220 616c 6c20 6465 7669 6365 7320   or all devices 
-00040390: 6672 6f6d 2074 6865 204d 6174 7269 7820  from the Matrix 
-000403a0: 686f 6d65 7365 7276 6572 2e20 220a 2020  homeserver. ".  
-000403b0: 2020 2020 2020 2254 6869 7320 7265 7175        "This requ
-000403c0: 6972 6573 2065 7861 6374 6c79 206f 6e65  ires exactly one
-000403d0: 2061 7267 756d 656e 742e 2022 0a20 2020   argument. ".   
-000403e0: 2020 2020 2022 5477 6f20 6368 6f69 6365       "Two choice
-000403f0: 7320 6172 6520 6f66 6665 7265 643a 2027  s are offered: '
-00040400: 6d65 2720 616e 6420 2761 6c6c 272e 2022  me' and 'all'. "
-00040410: 0a20 2020 2020 2020 2022 5072 6f76 6964  .        "Provid
-00040420: 6520 6f6e 6520 6f66 2074 6865 7365 2063  e one of these c
-00040430: 686f 6963 6573 2e20 220a 2020 2020 2020  hoices. ".      
-00040440: 2020 6622 4966 2079 6f75 2063 686f 6f73    f"If you choos
-00040450: 6520 276d 6527 2c20 6f6e 6c79 2074 6865  e 'me', only the
-00040460: 206f 6e65 2064 6576 6963 6520 7b50 524f   one device {PRO
-00040470: 475f 5749 5448 4f55 545f 4558 547d 2022  G_WITHOUT_EXT} "
-00040480: 0a20 2020 2020 2020 2022 6973 2063 7572  .        "is cur
-00040490: 7265 6e74 6c79 2075 7369 6e67 2077 696c  rently using wil
-000404a0: 6c20 6265 206c 6f67 6765 6420 6f75 742e  l be logged out.
-000404b0: 2022 0a20 2020 2020 2020 2022 4966 2079   ".        "If y
-000404c0: 6f75 2063 686f 6f73 6520 2761 6c6c 272c  ou choose 'all',
-000404d0: 2061 6c6c 2064 6576 6963 6573 206f 6620   all devices of 
-000404e0: 7468 6520 7573 6572 2075 7365 6420 6279  the user used by
-000404f0: 2022 0a20 2020 2020 2020 2066 227b 5052   ".        f"{PR
-00040500: 4f47 5f57 4954 484f 5554 5f45 5854 7d20  OG_WITHOUT_EXT} 
-00040510: 7769 6c6c 2062 6520 6c6f 6767 6564 206f  will be logged o
-00040520: 7574 2e20 220a 2020 2020 2020 2020 2257  ut. ".        "W
-00040530: 6869 6c65 202d 2d6c 6f67 6f75 7420 6e65  hile --logout ne
-00040540: 6974 6865 7220 7265 6d6f 7665 7320 7468  ither removes th
-00040550: 6520 6372 6564 656e 7469 616c 7320 6e6f  e credentials no
-00040560: 7220 7468 6520 7374 6f72 652c 2074 6865  r the store, the
-00040570: 2022 0a20 2020 2020 2020 2022 6c6f 676f   ".        "logo
-00040580: 7574 2061 6374 696f 6e20 7265 6d6f 7665  ut action remove
-00040590: 7320 7468 6520 6465 7669 6365 2061 6e64  s the device and
-000405a0: 206d 616b 6573 2074 6865 2061 6363 6573   makes the acces
-000405b0: 732d 746f 6b65 6e20 7374 6f72 6564 2022  s-token stored "
-000405c0: 0a20 2020 2020 2020 2022 696e 2074 6865  .        "in the
-000405d0: 2063 7265 6465 6e74 6961 6c73 2069 6e76   credentials inv
-000405e0: 616c 6964 2e20 4865 6e63 652c 2061 6674  alid. Hence, aft
-000405f0: 6572 2061 202d 2d6c 6f67 6f75 742c 206f  er a --logout, o
-00040600: 6e65 206d 7573 7420 220a 2020 2020 2020  ne must ".      
-00040610: 2020 226d 616e 7561 6c6c 7920 7265 6d6f    "manually remo
-00040620: 7665 2063 7265 6465 6e74 6961 6c73 2061  ve credentials a
-00040630: 6e64 2073 746f 7265 2c20 616e 6420 7468  nd store, and th
-00040640: 656e 2070 6572 666f 726d 2061 206e 6577  en perform a new
-00040650: 2022 0a20 2020 2020 2020 2066 222d 2d6c   ".        f"--l
-00040660: 6f67 696e 2074 6f20 7573 6520 7b50 524f  ogin to use {PRO
-00040670: 475f 5749 5448 4f55 545f 4558 547d 2061  G_WITHOUT_EXT} a
-00040680: 6761 696e 2e20 220a 2020 2020 2020 2020  gain. ".        
-00040690: 2259 6f75 2063 616e 2070 6572 6665 6374  "You can perfect
-000406a0: 6c79 2075 7365 2022 0a20 2020 2020 2020  ly use ".       
-000406b0: 2066 227b 5052 4f47 5f57 4954 484f 5554   f"{PROG_WITHOUT
-000406c0: 5f45 5854 7d20 7769 7468 6f75 7420 6576  _EXT} without ev
-000406d0: 6572 206c 6f67 6769 6e67 206f 7574 2e20  er logging out. 
-000406e0: 2d2d 6c6f 676f 7574 2069 7320 6120 636c  --logout is a cl
-000406f0: 6561 6e75 7020 220a 2020 2020 2020 2020  eanup ".        
-00040700: 2269 6620 796f 7520 6861 7665 2064 6563  "if you have dec
-00040710: 6964 6564 206e 6f74 2074 6f20 7573 6520  ided not to use 
-00040720: 7468 6973 2028 6f72 2061 6c6c 2920 6465  this (or all) de
-00040730: 7669 6365 2873 2920 6576 6572 2061 6761  vice(s) ever aga
-00040740: 696e 2e22 2c0a 2020 2020 290a 2020 2020  in.",.    ).    
-00040750: 6170 2e61 6464 5f61 7267 756d 656e 7428  ap.add_argument(
-00040760: 0a20 2020 2020 2020 2022 2d63 222c 0a20  .        "-c",. 
-00040770: 2020 2020 2020 2022 2d2d 6372 6564 656e         "--creden
-00040780: 7469 616c 7322 2c0a 2020 2020 2020 2020  tials",.        
-00040790: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
-000407a0: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
-000407b0: 2c0a 2020 2020 2020 2020 6465 6661 756c  ,.        defaul
-000407c0: 743d 4352 4544 454e 5449 414c 535f 4649  t=CREDENTIALS_FI
-000407d0: 4c45 5f44 4546 4155 4c54 2c0a 2020 2020  LE_DEFAULT,.    
-000407e0: 2020 2020 6d65 7461 7661 723d 2243 5245      metavar="CRE
-000407f0: 4445 4e54 4941 4c53 5f46 494c 4522 2c0a  DENTIALS_FILE",.
-00040800: 2020 2020 2020 2020 6865 6c70 3d22 5370          help="Sp
-00040810: 6563 6966 7920 6c6f 6361 7469 6f6e 206f  ecify location o
-00040820: 6620 6372 6564 656e 7469 616c 7320 6669  f credentials fi
-00040830: 6c65 2e20 220a 2020 2020 2020 2020 2244  le. ".        "D
-00040840: 6574 6169 6c73 3a3a 204f 6e20 6669 7273  etails:: On firs
-00040850: 7420 7275 6e2c 2069 6e66 6f72 6d61 7469  t run, informati
-00040860: 6f6e 2061 626f 7574 2068 6f6d 6573 6572  on about homeser
-00040870: 7665 722c 2022 0a20 2020 2020 2020 2022  ver, ".        "
-00040880: 7573 6572 2c20 726f 6f6d 2069 642c 2065  user, room id, e
-00040890: 7463 2e20 7769 6c6c 2062 6520 7772 6974  tc. will be writ
-000408a0: 7465 6e20 746f 2061 2063 7265 6465 6e74  ten to a credent
-000408b0: 6961 6c73 2022 0a20 2020 2020 2020 2022  ials ".        "
-000408c0: 6669 6c65 2e20 4279 2064 6566 6175 6c74  file. By default
-000408d0: 2c20 7468 6973 2066 696c 6520 220a 2020  , this file ".  
-000408e0: 2020 2020 2020 6627 6973 2022 7b43 5245        f'is "{CRE
-000408f0: 4445 4e54 4941 4c53 5f46 494c 455f 4445  DENTIALS_FILE_DE
-00040900: 4641 554c 547d 222e 2027 0a20 2020 2020  FAULT}". '.     
-00040910: 2020 2022 4f6e 2066 7572 7468 6572 2072     "On further r
-00040920: 756e 7320 7468 6520 6372 6564 656e 7469  uns the credenti
-00040930: 616c 7320 6669 6c65 2069 7320 7265 6164  als file is read
-00040940: 2074 6f20 220a 2020 2020 2020 2020 2270   to ".        "p
-00040950: 6572 6d69 7420 6c6f 6767 696e 6720 696e  ermit logging in
-00040960: 746f 2074 6865 2063 6f72 7265 6374 204d  to the correct M
-00040970: 6174 7269 7820 6163 636f 756e 7420 220a  atrix account ".
-00040980: 2020 2020 2020 2020 2261 6e64 2073 656e          "and sen
-00040990: 6469 6e67 206d 6573 7361 6765 7320 746f  ding messages to
-000409a0: 2074 6865 2070 7265 636f 6e66 6967 7572   the preconfigur
-000409b0: 6564 2072 6f6f 6d2e 2022 0a20 2020 2020  ed room. ".     
-000409c0: 2020 2022 4966 2074 6869 7320 6f70 7469     "If this opti
-000409d0: 6f6e 2069 7320 7072 6f76 6964 6564 2c20  on is provided, 
-000409e0: 7468 6520 7072 6f76 6964 6564 2066 696c  the provided fil
-000409f0: 6520 6e61 6d65 2022 0a20 2020 2020 2020  e name ".       
-00040a00: 2022 7769 6c6c 2062 6520 7573 6564 2061   "will be used a
-00040a10: 7320 6372 6564 656e 7469 616c 7320 6669  s credentials fi
-00040a20: 6c65 2069 6e73 7465 6164 206f 6620 7468  le instead of th
-00040a30: 6520 220a 2020 2020 2020 2020 2264 6566  e ".        "def
-00040a40: 6175 6c74 206f 6e65 2e20 222c 0a20 2020  ault one. ",.   
-00040a50: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
-00040a60: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
-00040a70: 222d 7322 2c0a 2020 2020 2020 2020 222d  "-s",.        "-
-00040a80: 2d73 746f 7265 222c 0a20 2020 2020 2020  -store",.       
-00040a90: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
-00040aa0: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
-00040ab0: 722c 0a20 2020 2020 2020 2064 6566 6175  r,.        defau
-00040ac0: 6c74 3d53 544f 5245 5f44 4952 5f44 4546  lt=STORE_DIR_DEF
-00040ad0: 4155 4c54 2c0a 2020 2020 2020 2020 6d65  AULT,.        me
-00040ae0: 7461 7661 723d 2253 544f 5245 5f44 4952  tavar="STORE_DIR
-00040af0: 4543 544f 5259 222c 0a20 2020 2020 2020  ECTORY",.       
-00040b00: 2068 656c 703d 2253 7065 6369 6679 206c   help="Specify l
-00040b10: 6f63 6174 696f 6e20 6f66 2073 746f 7265  ocation of store
-00040b20: 2064 6972 6563 746f 7279 2e20 220a 2020   directory. ".  
-00040b30: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
-00040b40: 2050 6174 6820 746f 2064 6972 6563 746f   Path to directo
-00040b50: 7279 2074 6f20 6265 2022 0a20 2020 2020  ry to be ".     
-00040b60: 2020 2027 7573 6564 2061 7320 2273 746f     'used as "sto
-00040b70: 7265 2220 666f 7220 656e 6372 7970 7465  re" for encrypte
-00040b80: 6420 6d65 7373 6167 696e 672e 2027 0a20  d messaging. '. 
-00040b90: 2020 2020 2020 2022 4279 2064 6566 6175         "By defau
-00040ba0: 6c74 2c20 7468 6973 2064 6972 6563 746f  lt, this directo
-00040bb0: 7279 2022 0a20 2020 2020 2020 2066 2769  ry ".        f'i
-00040bc0: 7320 227b 5354 4f52 455f 4449 525f 4445  s "{STORE_DIR_DE
-00040bd0: 4641 554c 547d 222e 2027 0a20 2020 2020  FAULT}". '.     
-00040be0: 2020 2022 5369 6e63 6520 656e 6372 7970     "Since encryp
-00040bf0: 7469 6f6e 2069 7320 616c 7761 7973 2065  tion is always e
-00040c00: 6e61 626c 6564 2c20 6120 7374 6f72 6520  nabled, a store 
-00040c10: 6973 2022 0a20 2020 2020 2020 2022 616c  is ".        "al
-00040c20: 7761 7973 206e 6565 6465 642e 2022 0a20  ways needed. ". 
-00040c30: 2020 2020 2020 2022 5468 6520 7072 6f76         "The prov
-00040c40: 6964 6564 2064 6972 6563 746f 7279 206e  ided directory n
-00040c50: 616d 6520 220a 2020 2020 2020 2020 2277  ame ".        "w
-00040c60: 696c 6c20 6265 2075 7365 6420 6173 2070  ill be used as p
-00040c70: 6572 7369 7374 656e 7420 7374 6f72 6167  ersistent storag
-00040c80: 6520 6469 7265 6374 6f72 7920 696e 7374  e directory inst
-00040c90: 6561 6420 6f66 2022 0a20 2020 2020 2020  ead of ".       
-00040ca0: 2022 7468 6520 6465 6661 756c 7420 6f6e   "the default on
-00040cb0: 652e 2050 7265 6665 7261 626c 792c 2066  e. Preferably, f
-00040cc0: 6f72 206d 756c 7469 706c 6520 6578 6563  or multiple exec
-00040cd0: 7574 696f 6e73 2022 0a20 2020 2020 2020  utions ".       
-00040ce0: 2022 6f66 2074 6869 7320 7072 6f67 7261   "of this progra
-00040cf0: 6d20 7573 6520 7468 6520 7361 6d65 2073  m use the same s
-00040d00: 746f 7265 2066 6f72 2074 6865 2073 616d  tore for the sam
-00040d10: 6520 6465 7669 6365 2e20 220a 2020 2020  e device. ".    
-00040d20: 2020 2020 2254 6865 2073 746f 7265 2064      "The store d
-00040d30: 6972 6563 746f 7279 2063 616e 2062 6520  irectory can be 
-00040d40: 7368 6172 6564 2062 6574 7765 656e 206d  shared between m
-00040d50: 756c 7469 706c 6520 220a 2020 2020 2020  ultiple ".      
-00040d60: 2020 2264 6966 6665 7265 6e74 2064 6576    "different dev
-00040d70: 6963 6573 2061 6e64 2075 7365 7273 2e22  ices and users."
-00040d80: 2c0a 2020 2020 290a 2020 2020 6170 2e61  ,.    ).    ap.a
-00040d90: 6464 5f61 7267 756d 656e 7428 0a20 2020  dd_argument(.   
-00040da0: 2020 2020 2022 2d72 222c 0a20 2020 2020       "-r",.     
-00040db0: 2020 2022 2d2d 726f 6f6d 222c 0a20 2020     "--room",.   
-00040dc0: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
-00040dd0: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
-00040de0: 696f 6e3d 2265 7874 656e 6422 2c0a 2020  ion="extend",.  
-00040df0: 2020 2020 2020 6e61 7267 733d 222b 222c        nargs="+",
-00040e00: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
-00040e10: 722c 0a20 2020 2020 2020 206d 6574 6176  r,.        metav
-00040e20: 6172 3d22 524f 4f4d 222c 0a20 2020 2020  ar="ROOM",.     
-00040e30: 2020 2068 656c 703d 2253 7065 6369 6679     help="Specify
-00040e40: 206f 6e65 206f 7220 6d75 6c74 6970 6c65   one or multiple
-00040e50: 2072 6f6f 6d73 2e20 220a 2020 2020 2020   rooms. ".      
-00040e60: 2020 2244 6574 6169 6c73 3a3a 204f 7074    "Details:: Opt
-00040e70: 696f 6e61 6c6c 7920 7370 6563 6966 7920  ionally specify 
-00040e80: 6f6e 6520 6f72 206d 756c 7469 706c 6520  one or multiple 
-00040e90: 726f 6f6d 7320 7669 6120 726f 6f6d 2069  rooms via room i
-00040ea0: 6473 206f 7220 220a 2020 2020 2020 2020  ds or ".        
-00040eb0: 2272 6f6f 6d20 616c 6961 7365 732e 202d  "room aliases. -
-00040ec0: 2d72 6f6f 6d20 6973 2075 7365 6420 6279  -room is used by
-00040ed0: 2076 6172 696f 7573 2073 656e 6420 6163   various send ac
-00040ee0: 7469 6f6e 7320 616e 6420 220a 2020 2020  tions and ".    
-00040ef0: 2020 2020 2276 6172 696f 7573 206c 6973      "various lis
-00040f00: 7465 6e20 6163 7469 6f6e 732e 2022 0a20  ten actions. ". 
-00040f10: 2020 2020 2020 2022 5468 6520 6465 6661         "The defa
-00040f20: 756c 7420 726f 6f6d 2069 7320 7072 6f76  ult room is prov
-00040f30: 6964 6564 2022 0a20 2020 2020 2020 2022  ided ".        "
-00040f40: 696e 2074 6865 2063 7265 6465 6e74 6961  in the credentia
-00040f50: 6c73 2066 696c 6520 2873 7065 6369 6669  ls file (specifi
-00040f60: 6564 2061 7420 2d2d 6c6f 6769 6e20 7769  ed at --login wi
-00040f70: 7468 202d 2d72 6f6f 6d2d 6465 6661 756c  th --room-defaul
-00040f80: 7429 2e20 220a 2020 2020 2020 2020 2249  t). ".        "I
-00040f90: 6620 6120 726f 6f6d 2028 6f72 206d 756c  f a room (or mul
-00040fa0: 7469 706c 6520 6f6e 6573 2920 220a 2020  tiple ones) ".  
-00040fb0: 2020 2020 2020 2269 7320 286f 7220 6172        "is (or ar
-00040fc0: 6529 2070 726f 7669 6465 6420 696e 2074  e) provided in t
-00040fd0: 6865 202d 2d72 6f6f 6d20 6172 6775 6d65  he --room argume
-00040fe0: 6e74 732c 2074 6865 6e20 6974 2022 0a20  nts, then it ". 
-00040ff0: 2020 2020 2020 2022 286f 7220 7468 6579         "(or they
-00041000: 2920 7769 6c6c 2062 6520 7573 6564 2022  ) will be used "
-00041010: 0a20 2020 2020 2020 2022 696e 7374 6561  .        "instea
-00041020: 6420 6f66 2074 6865 206f 6e65 2066 726f  d of the one fro
-00041030: 6d20 7468 6520 6372 6564 656e 7469 616c  m the credential
-00041040: 7320 6669 6c65 2e20 220a 2020 2020 2020  s file. ".      
-00041050: 2020 2254 6865 2075 7365 7220 6d75 7374    "The user must
-00041060: 2068 6176 6520 6163 6365 7373 2074 6f20   have access to 
-00041070: 7468 6520 7370 6563 6966 6965 6420 726f  the specified ro
-00041080: 6f6d 2022 0a20 2020 2020 2020 2022 696e  om ".        "in
-00041090: 206f 7264 6572 2074 6f20 7365 6e64 206d   order to send m
-000410a0: 6573 7361 6765 7320 7468 6572 6520 6f72  essages there or
-000410b0: 206c 6973 7465 6e20 6f6e 2074 6865 2072   listen on the r
-000410c0: 6f6f 6d2e 2022 0a20 2020 2020 2020 2022  oom. ".        "
-000410d0: 4d65 7373 6167 6573 2063 616e 6e6f 7420  Messages cannot 
-000410e0: 220a 2020 2020 2020 2020 2262 6520 7365  ".        "be se
-000410f0: 6e74 2074 6f20 6172 6269 7472 6172 7920  nt to arbitrary 
-00041100: 726f 6f6d 732e 2057 6865 6e20 7370 6563  rooms. When spec
-00041110: 6966 7969 6e67 2074 6865 2022 0a20 2020  ifying the ".   
-00041120: 2020 2020 2022 726f 6f6d 2069 6420 736f       "room id so
-00041130: 6d65 2073 6865 6c6c 7320 7265 7175 6972  me shells requir
-00041140: 6520 7468 6520 6578 636c 616d 6174 696f  e the exclamatio
-00041150: 6e20 6d61 726b 2022 0a20 2020 2020 2020  n mark ".       
-00041160: 2022 746f 2062 6520 6573 6361 7065 6420   "to be escaped 
-00041170: 7769 7468 2061 2062 6163 6b73 6c61 7368  with a backslash
-00041180: 2e20 220a 2020 2020 2020 2020 2241 7320  . ".        "As 
-00041190: 616e 2061 6c74 6572 6e61 7469 7665 2074  an alternative t
-000411a0: 6f20 7370 6563 6966 7969 6e67 2061 2072  o specifying a r
-000411b0: 6f6f 6d20 6173 2064 6573 7469 6e61 7469  oom as destinati
-000411c0: 6f6e 2c20 220a 2020 2020 2020 2020 226f  on, ".        "o
-000411d0: 6e65 2063 616e 2073 7065 6369 6679 2061  ne can specify a
-000411e0: 2075 7365 7220 6173 2061 2064 6573 7469   user as a desti
-000411f0: 6e61 7469 6f6e 2077 6974 6820 7468 6520  nation with the 
-00041200: 272d 2d75 7365 7227 2022 0a20 2020 2020  '--user' ".     
-00041210: 2020 2022 6172 6775 6d65 6e74 2e20 5365     "argument. Se
-00041220: 6520 272d 2d75 7365 7227 2061 6e64 2074  e '--user' and t
-00041230: 6865 2074 6572 6d20 2744 4d20 2864 6972  he term 'DM (dir
-00041240: 6563 7420 6d65 7373 6167 696e 6729 2720  ect messaging)' 
-00041250: 220a 2020 2020 2020 2020 2266 6f72 2064  ".        "for d
-00041260: 6574 6169 6c73 2e20 5370 6563 6966 7969  etails. Specifyi
-00041270: 6e67 2061 2072 6f6f 6d20 6973 2061 6c77  ng a room is alw
-00041280: 6179 7320 6661 7374 6572 2061 6e64 206d  ays faster and m
-00041290: 6f72 6520 220a 2020 2020 2020 2020 2265  ore ".        "e
-000412a0: 6666 6963 6965 6e74 2074 6861 6e20 7370  fficient than sp
-000412b0: 6563 6966 7969 6e67 2061 2075 7365 722e  ecifying a user.
-000412c0: 204e 6f74 2061 6c6c 206c 6973 7465 6e20   Not all listen 
-000412d0: 6f70 6572 6174 696f 6e73 2022 0a20 2020  operations ".   
-000412e0: 2020 2020 2022 616c 6c6f 7720 7365 7474       "allow sett
-000412f0: 696e 6720 6120 726f 6f6d 2e20 5265 6164  ing a room. Read
-00041300: 206d 6f72 6520 756e 6465 7220 7468 6520   more under the 
-00041310: 2d2d 6c69 7374 656e 206f 7074 696f 6e73  --listen options
-00041320: 2022 0a20 2020 2020 2020 2022 616e 6420   ".        "and 
-00041330: 7369 6d69 6c61 722e 204d 6f73 7420 6163  similar. Most ac
-00041340: 7469 6f6e 7320 616c 736f 2073 7570 706f  tions also suppo
-00041350: 7274 2072 6f6f 6d20 616c 6961 7365 7320  rt room aliases 
-00041360: 696e 7374 6561 6420 6f66 2022 0a20 2020  instead of ".   
-00041370: 2020 2020 2022 726f 6f6d 2069 6473 2e20       "room ids. 
-00041380: 536f 6d65 2065 7665 6e20 7368 6f72 7420  Some even short 
-00041390: 726f 6f6d 2061 6c69 6173 6573 2e22 2c0a  room aliases.",.
-000413a0: 2020 2020 290a 2020 2020 6170 2e61 6464      ).    ap.add
-000413b0: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
-000413c0: 2020 2022 2d2d 726f 6f6d 2d64 6566 6175     "--room-defau
-000413d0: 6c74 222c 0a20 2020 2020 2020 2072 6571  lt",.        req
-000413e0: 7569 7265 643d 4661 6c73 652c 0a20 2020  uired=False,.   
-000413f0: 2020 2020 2074 7970 653d 7374 722c 0a20       type=str,. 
-00041400: 2020 2020 2020 206d 6574 6176 6172 3d22         metavar="
-00041410: 4445 4641 554c 545f 524f 4f4d 222c 0a20  DEFAULT_ROOM",. 
-00041420: 2020 2020 2020 2068 656c 703d 2253 7065         help="Spe
-00041430: 6369 6679 2074 6865 2064 6566 6175 6c74  cify the default
-00041440: 2072 6f6f 6d20 6174 202d 2d6c 6f67 696e   room at --login
-00041450: 2e20 220a 2020 2020 2020 2020 2244 6574  . ".        "Det
-00041460: 6169 6c73 3a3a 204f 7074 696f 6e61 6c6c  ails:: Optionall
-00041470: 7920 7370 6563 6966 7920 6120 726f 6f6d  y specify a room
-00041480: 2061 7320 7468 6520 220a 2020 2020 2020   as the ".      
-00041490: 2020 2264 6566 6175 6c74 2072 6f6f 6d20    "default room 
-000414a0: 666f 7220 6675 7475 7265 2061 6374 696f  for future actio
-000414b0: 6e73 2e20 4966 206e 6f74 2073 7065 6369  ns. If not speci
-000414c0: 6669 6564 2066 6f72 202d 2d6c 6f67 696e  fied for --login
-000414d0: 2c20 6974 2022 0a20 2020 2020 2020 2022  , it ".        "
-000414e0: 7769 6c6c 2062 6520 7175 6572 6965 6420  will be queried 
-000414f0: 7669 6120 7468 6520 6b65 7962 6f61 7264  via the keyboard
-00041500: 2e20 2d2d 6c6f 6769 6e20 7374 6f72 6573  . --login stores
-00041510: 2074 6865 2073 7065 6369 6669 6564 2072   the specified r
-00041520: 6f6f 6d20 220a 2020 2020 2020 2020 2261  oom ".        "a
-00041530: 7320 6465 6661 756c 7420 726f 6f6d 2069  s default room i
-00041540: 6e20 796f 7572 2063 7265 6465 6e74 6961  n your credentia
-00041550: 6c73 2066 696c 652e 2054 6869 7320 6f70  ls file. This op
-00041560: 7469 6f6e 2069 7320 6f6e 6c79 2075 7365  tion is only use
-00041570: 6420 220a 2020 2020 2020 2020 2269 6e20  d ".        "in 
-00041580: 636f 6d62 696e 6174 696f 6e20 7769 7468  combination with
-00041590: 202d 2d6c 6f67 696e 2e20 4120 6465 6661   --login. A defa
-000415a0: 756c 7420 726f 6f6d 2069 7320 6e65 6564  ult room is need
-000415b0: 6564 2e20 5370 6563 6966 7920 6120 220a  ed. Specify a ".
-000415c0: 2020 2020 2020 2020 2276 616c 6964 2072          "valid r
-000415d0: 6f6f 6d20 6569 7468 6572 2077 6974 6820  oom either with 
-000415e0: 2d2d 726f 6f6d 2d64 6566 6175 6c74 206f  --room-default o
-000415f0: 7220 7072 6f76 6964 6520 6974 2076 6961  r provide it via
-00041600: 206b 6579 626f 6172 642e 222c 0a20 2020   keyboard.",.   
-00041610: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
-00041620: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
-00041630: 222d 2d72 6f6f 6d2d 6372 6561 7465 222c  "--room-create",
-00041640: 0a20 2020 2020 2020 2072 6571 7569 7265  .        require
-00041650: 643d 4661 6c73 652c 0a20 2020 2020 2020  d=False,.       
-00041660: 2061 6374 696f 6e3d 2265 7874 656e 6422   action="extend"
-00041670: 2c0a 2020 2020 2020 2020 6e61 7267 733d  ,.        nargs=
-00041680: 222b 222c 0a20 2020 2020 2020 2074 7970  "+",.        typ
-00041690: 653d 7374 722c 0a20 2020 2020 2020 206d  e=str,.        m
-000416a0: 6574 6176 6172 3d22 524f 4f4d 5f41 4c49  etavar="ROOM_ALI
-000416b0: 4153 222c 0a20 2020 2020 2020 2068 656c  AS",.        hel
-000416c0: 703d 2243 7265 6174 6520 6f6e 6520 6f72  p="Create one or
-000416d0: 206d 756c 7469 706c 6520 726f 6f6d 7320   multiple rooms 
-000416e0: 666f 7220 6769 7665 6e20 616c 6961 7328  for given alias(
-000416f0: 6573 292e 2022 0a20 2020 2020 2020 2022  es). ".        "
-00041700: 4465 7461 696c 733a 3a20 4f6e 6520 6f72  Details:: One or
-00041710: 206d 756c 7469 706c 6520 220a 2020 2020   multiple ".    
-00041720: 2020 2020 2272 6f6f 6d20 616c 6961 7365      "room aliase
-00041730: 7320 6361 6e20 6265 2073 7065 6369 6669  s can be specifi
-00041740: 6564 2e20 220a 2020 2020 2020 2020 2246  ed. ".        "F
-00041750: 6f72 2065 6163 6820 616c 6961 7320 7370  or each alias sp
-00041760: 6563 6966 6965 6420 6120 726f 6f6d 2077  ecified a room w
-00041770: 696c 6c20 6265 2063 7265 6174 6564 2e20  ill be created. 
-00041780: 220a 2020 2020 2020 2020 2246 6f72 2065  ".        "For e
-00041790: 6163 6820 6372 6561 7465 6420 726f 6f6d  ach created room
-000417a0: 206f 6e65 206c 696e 6520 7769 7468 2072   one line with r
-000417b0: 6f6f 6d20 6964 2061 6e64 2061 6c69 6173  oom id and alias
-000417c0: 2022 0a20 2020 2020 2020 2022 7769 6c6c   ".        "will
-000417d0: 2062 6520 7072 696e 7465 6420 746f 2073   be printed to s
-000417e0: 7464 6f75 742e 2022 0a20 2020 2020 2020  tdout. ".       
-000417f0: 2022 4966 2079 6f75 2061 7265 206e 6f74   "If you are not
-00041800: 2069 6e74 6572 6573 7465 6420 696e 2061   interested in a
-00041810: 6e20 220a 2020 2020 2020 2020 2761 6c69  n ".        'ali
-00041820: 6173 2c20 7072 6f76 6964 6520 616e 2065  as, provide an e
-00041830: 6d70 7479 2073 7472 696e 6720 6c69 6b65  mpty string like
-00041840: 2022 222e 2027 0a20 2020 2020 2020 2022   "". '.        "
-00041850: 5468 6520 616c 6961 7320 7072 6f76 6964  The alias provid
-00041860: 6564 206d 7573 7420 6265 2069 6e20 6361  ed must be in ca
-00041870: 6e6f 6e69 6361 6c20 6c6f 6361 6c20 666f  nonical local fo
-00041880: 726d 2c20 692e 652e 2022 0a20 2020 2020  rm, i.e. ".     
-00041890: 2020 2022 6966 2079 6f75 2077 616e 7420     "if you want 
-000418a0: 6120 6669 6e61 6c20 6675 6c6c 2061 6c69  a final full ali
-000418b0: 6173 206c 696b 6520 220a 2020 2020 2020  as like ".      
-000418c0: 2020 2722 2353 6f6d 6552 6f6f 6d41 6c69    '"#SomeRoomAli
-000418d0: 6173 3a6d 6174 7269 782e 6578 616d 706c  as:matrix.exampl
-000418e0: 652e 636f 6d22 2027 0a20 2020 2020 2020  e.com" '.       
-000418f0: 2022 796f 7520 6d75 7374 2070 726f 7669   "you must provi
-00041900: 6465 2074 6865 2073 7472 696e 6720 2753  de the string 'S
-00041910: 6f6d 6552 6f6f 6d41 6c69 6173 272e 2022  omeRoomAlias'. "
-00041920: 0a20 2020 2020 2020 2022 5468 6520 7573  .        "The us
-00041930: 6572 206d 7573 7420 6265 2070 6572 6d69  er must be permi
-00041940: 7474 6564 2074 6f20 6372 6561 7465 2072  tted to create r
-00041950: 6f6f 6d73 2e20 220a 2020 2020 2020 2020  ooms. ".        
-00041960: 2243 6f6d 6269 6e65 202d 2d72 6f6f 6d2d  "Combine --room-
-00041970: 6372 6561 7465 2077 6974 6820 2d2d 6e61  create with --na
-00041980: 6d65 2061 6e64 202d 2d74 6f70 6963 2074  me and --topic t
-00041990: 6f20 6164 6420 220a 2020 2020 2020 2020  o add ".        
-000419a0: 226e 616d 6573 2061 6e64 2074 6f70 6963  "names and topic
-000419b0: 7320 746f 2074 6865 2072 6f6f 6d28 7329  s to the room(s)
-000419c0: 2074 6f20 6265 2063 7265 6174 6564 2e20   to be created. 
-000419d0: 220a 2020 2020 2020 2020 2252 6f6f 6d73  ".        "Rooms
-000419e0: 2061 7265 2062 7920 6465 6661 756c 7420   are by default 
-000419f0: 6372 6561 7465 6420 656e 6372 7970 7465  created encrypte
-00041a00: 643b 2022 0a20 2020 2020 2020 2022 746f  d; ".        "to
-00041a10: 206f 7665 7277 7269 7465 2074 6861 7420   overwrite that 
-00041a20: 616e 6420 746f 2063 7265 6174 6520 6120  and to create a 
-00041a30: 726f 6f6d 2077 6974 6820 656e 6372 7970  room with encryp
-00041a40: 7469 6f6e 2064 6973 6162 6c65 6420 220a  tion disabled ".
-00041a50: 2020 2020 2020 2020 2275 7365 2027 2d2d          "use '--
-00041a60: 706c 6169 6e27 2e20 220a 2020 2020 2020  plain'. ".      
-00041a70: 2020 2252 6f6f 6d20 6964 2c20 726f 6f6d    "Room id, room
-00041a80: 2061 6c69 6173 2c20 656e 6372 7970 7469   alias, encrypti
-00041a90: 6f6e 2061 6e64 206f 7468 6572 2066 6965  on and other fie
-00041aa0: 6c64 7320 220a 2020 2020 2020 2020 2261  lds ".        "a
-00041ab0: 7265 2070 7269 6e74 6564 2061 7320 6f75  re printed as ou
-00041ac0: 7470 7574 2c20 6f6e 6520 6c69 6e65 2070  tput, one line p
-00041ad0: 6572 2063 7265 6174 6564 2072 6f6f 6d2e  er created room.
-00041ae0: 222c 0a20 2020 2029 0a20 2020 2061 702e  ",.    ).    ap.
-00041af0: 6164 645f 6172 6775 6d65 6e74 280a 2020  add_argument(.  
-00041b00: 2020 2020 2020 222d 2d72 6f6f 6d2d 646d        "--room-dm
-00041b10: 2d63 7265 6174 6522 2c0a 2020 2020 2020  -create",.      
-00041b20: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
-00041b30: 2c0a 2020 2020 2020 2020 6163 7469 6f6e  ,.        action
-00041b40: 3d22 6578 7465 6e64 222c 0a20 2020 2020  ="extend",.     
-00041b50: 2020 206e 6172 6773 3d22 2b22 2c0a 2020     nargs="+",.  
-00041b60: 2020 2020 2020 7479 7065 3d73 7472 2c0a        type=str,.
-00041b70: 2020 2020 2020 2020 6d65 7461 7661 723d          metavar=
-00041b80: 2255 5345 5222 2c0a 2020 2020 2020 2020  "USER",.        
-00041b90: 6865 6c70 3d22 4372 6561 7465 206f 6e65  help="Create one
-00041ba0: 206f 7220 6d75 6c74 6970 6c65 2044 4d20   or multiple DM 
-00041bb0: 726f 6f6d 7320 7769 7468 2074 6865 2073  rooms with the s
-00041bc0: 7065 6369 6669 6564 2075 7365 7273 2e20  pecified users. 
-00041bd0: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
-00041be0: 6c73 3a3a 2046 6f72 2065 6163 6820 7573  ls:: For each us
-00041bf0: 6572 2073 7065 6369 6669 6564 2061 2044  er specified a D
-00041c00: 4d20 726f 6f6d 2077 696c 6c20 6265 2063  M room will be c
-00041c10: 7265 6174 6564 2061 6e64 2074 6865 2022  reated and the "
-00041c20: 0a20 2020 2020 2020 2022 7573 6572 2069  .        "user i
-00041c30: 6e76 6974 6564 2074 6f20 6974 2e20 466f  nvited to it. Fo
-00041c40: 7220 6561 6368 2063 7265 6174 6564 2072  r each created r
-00041c50: 6f6f 6d20 6f6e 6520 6c69 6e65 2077 6974  oom one line wit
-00041c60: 6820 220a 2020 2020 2020 2020 2272 6f6f  h ".        "roo
-00041c70: 6d20 6964 2061 6e64 2061 6c69 6173 2077  m id and alias w
-00041c80: 696c 6c20 6265 2070 7269 6e74 6564 2074  ill be printed t
-00041c90: 6f20 7374 646f 7574 2e20 5468 6520 7573  o stdout. The us
-00041ca0: 6572 2022 0a20 2020 2020 2020 2022 6d75  er ".        "mu
-00041cb0: 7374 2062 6520 7065 726d 6974 7465 6420  st be permitted 
-00041cc0: 746f 2063 7265 6174 6520 726f 6f6d 732e  to create rooms.
-00041cd0: 2043 6f6d 6269 6e65 202d 2d72 6f6f 6d2d   Combine --room-
-00041ce0: 646d 2d63 7265 6174 6520 220a 2020 2020  dm-create ".    
-00041cf0: 2020 2020 2277 6974 6820 2d2d 6e61 6d65      "with --name
-00041d00: 2c20 2d2d 746f 7069 632c 202d 2d61 6c69  , --topic, --ali
-00041d10: 6173 2074 6f20 6164 6420 6e61 6d65 732c  as to add names,
-00041d20: 2074 6f70 6963 7320 616e 6420 220a 2020   topics and ".  
-00041d30: 2020 2020 2020 2261 6c69 6173 6573 2074        "aliases t
-00041d40: 6f20 7468 6520 726f 6f6d 2873 2920 746f  o the room(s) to
-00041d50: 2062 6520 6372 6561 7465 642e 2022 0a20   be created. ". 
-00041d60: 2020 2020 2020 2022 444d 2072 6f6f 6d73         "DM rooms
-00041d70: 2061 7265 2062 7920 6465 6661 756c 7420   are by default 
-00041d80: 6372 6561 7465 6420 656e 6372 7970 7465  created encrypte
-00041d90: 643b 2022 0a20 2020 2020 2020 2022 746f  d; ".        "to
-00041da0: 206f 7665 7277 7269 7465 2074 6861 7420   overwrite that 
-00041db0: 616e 6420 746f 2063 7265 6174 6520 6120  and to create a 
-00041dc0: 726f 6f6d 2077 6974 6820 656e 6372 7970  room with encryp
-00041dd0: 7469 6f6e 2064 6973 6162 6c65 6420 220a  tion disabled ".
-00041de0: 2020 2020 2020 2020 2275 7365 2027 2d2d          "use '--
-00041df0: 706c 6169 6e27 2e20 220a 2020 2020 2020  plain'. ".      
-00041e00: 2020 2252 6f6f 6d20 6964 2c20 726f 6f6d    "Room id, room
-00041e10: 2061 6c69 6173 2c20 656e 6372 7970 7469   alias, encrypti
-00041e20: 6f6e 2061 6e64 206f 7468 6572 2066 6965  on and other fie
-00041e30: 6c64 7320 220a 2020 2020 2020 2020 2261  lds ".        "a
-00041e40: 7265 2070 7269 6e74 6564 2061 7320 6f75  re printed as ou
-00041e50: 7470 7574 2c20 6f6e 6520 6c69 6e65 2070  tput, one line p
-00041e60: 6572 2063 7265 6174 6564 2072 6f6f 6d2e  er created room.
-00041e70: 222c 0a20 2020 2029 0a20 2020 2061 702e  ",.    ).    ap.
-00041e80: 6164 645f 6172 6775 6d65 6e74 280a 2020  add_argument(.  
-00041e90: 2020 2020 2020 222d 2d72 6f6f 6d2d 6a6f        "--room-jo
-00041ea0: 696e 222c 0a20 2020 2020 2020 2072 6571  in",.        req
-00041eb0: 7569 7265 643d 4661 6c73 652c 0a20 2020  uired=False,.   
-00041ec0: 2020 2020 2061 6374 696f 6e3d 2265 7874       action="ext
-00041ed0: 656e 6422 2c0a 2020 2020 2020 2020 6e61  end",.        na
-00041ee0: 7267 733d 222b 222c 0a20 2020 2020 2020  rgs="+",.       
-00041ef0: 2074 7970 653d 7374 722c 0a20 2020 2020   type=str,.     
-00041f00: 2020 206d 6574 6176 6172 3d22 524f 4f4d     metavar="ROOM
-00041f10: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
-00041f20: 224a 6f69 6e20 6f6e 6520 726f 6f6d 206f  "Join one room o
-00041f30: 7220 6d75 6c74 6970 6c65 2072 6f6f 6d73  r multiple rooms
-00041f40: 2e20 220a 2020 2020 2020 2020 2244 6574  . ".        "Det
-00041f50: 6169 6c73 3a3a 204f 6e65 206f 7220 6d75  ails:: One or mu
-00041f60: 6c74 6970 6c65 2022 0a20 2020 2020 2020  ltiple ".       
-00041f70: 2022 726f 6f6d 2061 6c69 6173 6573 2063   "room aliases c
-00041f80: 616e 2062 6520 7370 6563 6966 6965 642e  an be specified.
-00041f90: 2054 6865 2072 6f6f 6d20 286f 7220 6d75   The room (or mu
-00041fa0: 6c74 6970 6c65 2022 0a20 2020 2020 2020  ltiple ".       
-00041fb0: 2022 6f6e 6573 2920 7072 6f76 6964 6564   "ones) provided
-00041fc0: 2069 6e20 7468 6520 6172 6775 6d65 6e74   in the argument
-00041fd0: 7320 7769 6c6c 2062 6520 6a6f 696e 6564  s will be joined
-00041fe0: 2e20 220a 2020 2020 2020 2020 2254 6865  . ".        "The
-00041ff0: 2075 7365 7220 6d75 7374 2068 6176 6520   user must have 
-00042000: 7065 726d 6973 7369 6f6e 7320 746f 206a  permissions to j
-00042010: 6f69 6e20 7468 6573 6520 726f 6f6d 732e  oin these rooms.
-00042020: 222c 0a20 2020 2029 0a20 2020 2061 702e  ",.    ).    ap.
-00042030: 6164 645f 6172 6775 6d65 6e74 280a 2020  add_argument(.  
-00042040: 2020 2020 2020 222d 2d72 6f6f 6d2d 6c65        "--room-le
-00042050: 6176 6522 2c0a 2020 2020 2020 2020 7265  ave",.        re
-00042060: 7175 6972 6564 3d46 616c 7365 2c0a 2020  quired=False,.  
-00042070: 2020 2020 2020 6163 7469 6f6e 3d22 6578        action="ex
-00042080: 7465 6e64 222c 0a20 2020 2020 2020 206e  tend",.        n
-00042090: 6172 6773 3d22 2b22 2c0a 2020 2020 2020  args="+",.      
-000420a0: 2020 7479 7065 3d73 7472 2c0a 2020 2020    type=str,.    
-000420b0: 2020 2020 6d65 7461 7661 723d 2252 4f4f      metavar="ROO
-000420c0: 4d22 2c0a 2020 2020 2020 2020 6865 6c70  M",.        help
-000420d0: 3d22 4c65 6176 6520 6f6e 6520 726f 6f6d  ="Leave one room
-000420e0: 206f 7220 6d75 6c74 6970 6c65 2072 6f6f   or multiple roo
-000420f0: 6d73 2e20 220a 2020 2020 2020 2020 2244  ms. ".        "D
-00042100: 6574 6169 6c73 3a3a 204f 6e65 206f 7220  etails:: One or 
-00042110: 6d75 6c74 6970 6c65 2022 0a20 2020 2020  multiple ".     
-00042120: 2020 2022 726f 6f6d 2061 6c69 6173 6573     "room aliases
-00042130: 2063 616e 2062 6520 7370 6563 6966 6965   can be specifie
-00042140: 642e 2054 6865 2072 6f6f 6d20 286f 7220  d. The room (or 
-00042150: 6d75 6c74 6970 6c65 2022 0a20 2020 2020  multiple ".     
-00042160: 2020 2022 6f6e 6573 2920 7072 6f76 6964     "ones) provid
-00042170: 6564 2069 6e20 7468 6520 6172 6775 6d65  ed in the argume
-00042180: 6e74 7320 7769 6c6c 2062 6520 6c65 6674  nts will be left
-00042190: 2e20 222c 0a20 2020 2029 0a20 2020 2061  . ",.    ).    a
-000421a0: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
-000421b0: 2020 2020 2020 2020 222d 2d72 6f6f 6d2d          "--room-
-000421c0: 666f 7267 6574 222c 0a20 2020 2020 2020  forget",.       
-000421d0: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
-000421e0: 0a20 2020 2020 2020 2061 6374 696f 6e3d  .        action=
-000421f0: 2265 7874 656e 6422 2c0a 2020 2020 2020  "extend",.      
-00042200: 2020 6e61 7267 733d 222b 222c 0a20 2020    nargs="+",.   
-00042210: 2020 2020 2074 7970 653d 7374 722c 0a20       type=str,. 
-00042220: 2020 2020 2020 206d 6574 6176 6172 3d22         metavar="
-00042230: 524f 4f4d 222c 0a20 2020 2020 2020 2068  ROOM",.        h
-00042240: 656c 703d 2246 6f72 6765 7420 6f6e 6520  elp="Forget one 
-00042250: 726f 6f6d 206f 7220 6d75 6c74 6970 6c65  room or multiple
-00042260: 2072 6f6f 6d73 2e20 220a 2020 2020 2020   rooms. ".      
-00042270: 2020 2244 6574 6169 6c73 3a3a 2041 6674    "Details:: Aft
-00042280: 6572 206c 6561 7669 6e67 2061 2072 6f6f  er leaving a roo
-00042290: 6d20 796f 7520 7368 6f75 6c64 2028 6d6f  m you should (mo
-000422a0: 7374 206c 696b 656c 7929 2066 6f72 6765  st likely) forge
-000422b0: 7420 7468 6520 220a 2020 2020 2020 2020  t the ".        
-000422c0: 2272 6f6f 6d2e 2046 6f72 6765 7474 696e  "room. Forgettin
-000422d0: 6720 6120 726f 6f6d 2072 656d 6f76 6573  g a room removes
-000422e0: 2074 6865 2075 7365 7273 2720 726f 6f6d   the users' room
-000422f0: 2068 6973 746f 7279 2e20 220a 2020 2020   history. ".    
-00042300: 2020 2020 224f 6e65 206f 7220 6d75 6c74      "One or mult
-00042310: 6970 6c65 2022 0a20 2020 2020 2020 2022  iple ".        "
-00042320: 726f 6f6d 2061 6c69 6173 6573 2063 616e  room aliases can
-00042330: 2062 6520 7370 6563 6966 6965 642e 2054   be specified. T
-00042340: 6865 2072 6f6f 6d20 286f 7220 6d75 6c74  he room (or mult
-00042350: 6970 6c65 2022 0a20 2020 2020 2020 2022  iple ".        "
-00042360: 6f6e 6573 2920 7072 6f76 6964 6564 2069  ones) provided i
-00042370: 6e20 7468 6520 6172 6775 6d65 6e74 7320  n the arguments 
-00042380: 7769 6c6c 2062 6520 666f 7267 6f74 7465  will be forgotte
-00042390: 6e2e 2022 0a20 2020 2020 2020 2022 4966  n. ".        "If
-000423a0: 2061 6c6c 2075 7365 7273 2066 6f72 6765   all users forge
-000423b0: 7420 6120 726f 6f6d 2c20 7468 6520 726f  t a room, the ro
-000423c0: 6f6d 2063 616e 2065 7665 6e74 7561 6c6c  om can eventuall
-000423d0: 7920 6265 2022 0a20 2020 2020 2020 2022  y be ".        "
-000423e0: 6465 6c65 7465 6420 6f6e 2074 6865 2073  deleted on the s
-000423f0: 6572 7665 722e 222c 0a20 2020 2029 0a20  erver.",.    ). 
-00042400: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
-00042410: 6e74 280a 2020 2020 2020 2020 222d 2d72  nt(.        "--r
-00042420: 6f6f 6d2d 696e 7669 7465 222c 0a20 2020  oom-invite",.   
-00042430: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
-00042440: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
-00042450: 696f 6e3d 2265 7874 656e 6422 2c0a 2020  ion="extend",.  
-00042460: 2020 2020 2020 6e61 7267 733d 222b 222c        nargs="+",
-00042470: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
-00042480: 722c 0a20 2020 2020 2020 206d 6574 6176  r,.        metav
-00042490: 6172 3d22 524f 4f4d 222c 0a20 2020 2020  ar="ROOM",.     
-000424a0: 2020 2068 656c 703d 2249 6e76 6974 6520     help="Invite 
-000424b0: 6f6e 6520 6f72 6520 6d6f 7265 2075 7365  one ore more use
-000424c0: 7273 2074 6f20 6a6f 696e 206f 6e65 206f  rs to join one o
-000424d0: 7220 6d6f 7265 2072 6f6f 6d73 2e20 220a  r more rooms. ".
-000424e0: 2020 2020 2020 2020 2244 6574 6169 6c73          "Details
-000424f0: 3a3a 2053 7065 6369 6679 2074 6865 2075  :: Specify the u
-00042500: 7365 7228 7329 2061 7320 6172 6775 6d65  ser(s) as argume
-00042510: 6e74 7320 746f 202d 2d75 7365 722e 2022  nts to --user. "
-00042520: 0a20 2020 2020 2020 2022 5370 6563 6966  .        "Specif
-00042530: 7920 7468 6520 726f 6f6d 7320 6173 2061  y the rooms as a
-00042540: 7267 756d 656e 7473 2074 6f20 7468 6973  rguments to this
-00042550: 206f 7074 696f 6e2c 2069 2e65 2e20 220a   option, i.e. ".
-00042560: 2020 2020 2020 2020 2261 7320 6172 6775          "as argu
-00042570: 6d65 6e74 7320 746f 202d 2d72 6f6f 6d2d  ments to --room-
-00042580: 696e 7669 7465 2e20 220a 2020 2020 2020  invite. ".      
-00042590: 2020 2254 6865 2075 7365 7220 6d75 7374    "The user must
-000425a0: 2068 6176 6520 7065 726d 6973 7369 6f6e   have permission
-000425b0: 7320 746f 2069 6e76 6974 6520 7573 6572  s to invite user
-000425c0: 732e 222c 0a20 2020 2029 0a20 2020 2061  s.",.    ).    a
-000425d0: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
-000425e0: 2020 2020 2020 2020 222d 2d72 6f6f 6d2d          "--room-
-000425f0: 6261 6e22 2c0a 2020 2020 2020 2020 7265  ban",.        re
-00042600: 7175 6972 6564 3d46 616c 7365 2c0a 2020  quired=False,.  
-00042610: 2020 2020 2020 6163 7469 6f6e 3d22 6578        action="ex
-00042620: 7465 6e64 222c 0a20 2020 2020 2020 206e  tend",.        n
-00042630: 6172 6773 3d22 2b22 2c0a 2020 2020 2020  args="+",.      
-00042640: 2020 7479 7065 3d73 7472 2c0a 2020 2020    type=str,.    
-00042650: 2020 2020 6d65 7461 7661 723d 2252 4f4f      metavar="ROO
-00042660: 4d22 2c0a 2020 2020 2020 2020 6865 6c70  M",.        help
-00042670: 3d22 4261 6e20 6f6e 6520 6f72 6520 6d6f  ="Ban one ore mo
-00042680: 7265 2075 7365 7273 2066 726f 6d20 6f6e  re users from on
-00042690: 6520 6f72 206d 6f72 6520 726f 6f6d 732e  e or more rooms.
-000426a0: 2022 0a20 2020 2020 2020 2022 4465 7461   ".        "Deta
-000426b0: 696c 733a 3a20 5370 6563 6966 7920 7468  ils:: Specify th
-000426c0: 6520 7573 6572 2873 2920 6173 2061 7267  e user(s) as arg
-000426d0: 756d 656e 7473 2074 6f20 2d2d 7573 6572  uments to --user
-000426e0: 2e20 220a 2020 2020 2020 2020 2253 7065  . ".        "Spe
-000426f0: 6369 6679 2074 6865 2072 6f6f 6d73 2061  cify the rooms a
-00042700: 7320 6172 6775 6d65 6e74 7320 746f 2074  s arguments to t
-00042710: 6869 7320 6f70 7469 6f6e 2c20 692e 652e  his option, i.e.
-00042720: 2022 0a20 2020 2020 2020 2022 6173 2061   ".        "as a
-00042730: 7267 756d 656e 7473 2074 6f20 2d2d 726f  rguments to --ro
-00042740: 6f6d 2d62 616e 2e20 220a 2020 2020 2020  om-ban. ".      
-00042750: 2020 2254 6865 2075 7365 7220 6d75 7374    "The user must
-00042760: 2068 6176 6520 7065 726d 6973 7369 6f6e   have permission
-00042770: 7320 746f 2062 616e 2075 7365 7273 2e22  s to ban users."
-00042780: 2c0a 2020 2020 290a 2020 2020 6170 2e61  ,.    ).    ap.a
-00042790: 6464 5f61 7267 756d 656e 7428 0a20 2020  dd_argument(.   
-000427a0: 2020 2020 2022 2d2d 726f 6f6d 2d75 6e62       "--room-unb
-000427b0: 616e 222c 0a20 2020 2020 2020 2072 6571  an",.        req
-000427c0: 7569 7265 643d 4661 6c73 652c 0a20 2020  uired=False,.   
-000427d0: 2020 2020 2061 6374 696f 6e3d 2265 7874       action="ext
-000427e0: 656e 6422 2c0a 2020 2020 2020 2020 6e61  end",.        na
-000427f0: 7267 733d 222b 222c 0a20 2020 2020 2020  rgs="+",.       
-00042800: 2074 7970 653d 7374 722c 0a20 2020 2020   type=str,.     
-00042810: 2020 206d 6574 6176 6172 3d22 524f 4f4d     metavar="ROOM
-00042820: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
-00042830: 2255 6e62 616e 206f 6e65 206f 7265 206d  "Unban one ore m
-00042840: 6f72 6520 7573 6572 7320 6672 6f6d 206f  ore users from o
-00042850: 6e65 206f 7220 6d6f 7265 2072 6f6f 6d73  ne or more rooms
-00042860: 2e20 220a 2020 2020 2020 2020 2244 6574  . ".        "Det
-00042870: 6169 6c73 3a3a 2053 7065 6369 6679 2074  ails:: Specify t
-00042880: 6865 2075 7365 7228 7329 2061 7320 6172  he user(s) as ar
-00042890: 6775 6d65 6e74 7320 746f 202d 2d75 7365  guments to --use
-000428a0: 722e 2022 0a20 2020 2020 2020 2022 5370  r. ".        "Sp
-000428b0: 6563 6966 7920 7468 6520 726f 6f6d 7320  ecify the rooms 
-000428c0: 6173 2061 7267 756d 656e 7473 2074 6f20  as arguments to 
-000428d0: 7468 6973 206f 7074 696f 6e2c 2069 2e65  this option, i.e
-000428e0: 2e20 220a 2020 2020 2020 2020 2261 7320  . ".        "as 
-000428f0: 6172 6775 6d65 6e74 7320 746f 202d 2d72  arguments to --r
-00042900: 6f6f 6d2d 756e 6261 6e2e 2022 0a20 2020  oom-unban. ".   
-00042910: 2020 2020 2022 5468 6520 7573 6572 206d       "The user m
-00042920: 7573 7420 6861 7665 2070 6572 6d69 7373  ust have permiss
-00042930: 696f 6e73 2074 6f20 756e 6261 6e20 7573  ions to unban us
-00042940: 6572 732e 222c 0a20 2020 2029 0a20 2020  ers.",.    ).   
-00042950: 2061 702e 6164 645f 6172 6775 6d65 6e74   ap.add_argument
-00042960: 280a 2020 2020 2020 2020 222d 2d72 6f6f  (.        "--roo
-00042970: 6d2d 6b69 636b 222c 0a20 2020 2020 2020  m-kick",.       
-00042980: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
-00042990: 0a20 2020 2020 2020 2061 6374 696f 6e3d  .        action=
-000429a0: 2265 7874 656e 6422 2c0a 2020 2020 2020  "extend",.      
-000429b0: 2020 6e61 7267 733d 222b 222c 0a20 2020    nargs="+",.   
-000429c0: 2020 2020 2074 7970 653d 7374 722c 0a20       type=str,. 
-000429d0: 2020 2020 2020 206d 6574 6176 6172 3d22         metavar="
-000429e0: 524f 4f4d 222c 0a20 2020 2020 2020 2068  ROOM",.        h
-000429f0: 656c 703d 224b 6963 6b20 6f6e 6520 6f72  elp="Kick one or
-00042a00: 6520 6d6f 7265 2075 7365 7273 2066 726f  e more users fro
-00042a10: 6d20 6f6e 6520 6f72 206d 6f72 6520 726f  m one or more ro
-00042a20: 6f6d 732e 2022 0a20 2020 2020 2020 2022  oms. ".        "
-00042a30: 4465 7461 696c 733a 3a20 5370 6563 6966  Details:: Specif
-00042a40: 7920 7468 6520 7573 6572 2873 2920 6173  y the user(s) as
-00042a50: 2061 7267 756d 656e 7473 2074 6f20 2d2d   arguments to --
-00042a60: 7573 6572 2e20 220a 2020 2020 2020 2020  user. ".        
-00042a70: 2253 7065 6369 6679 2074 6865 2072 6f6f  "Specify the roo
-00042a80: 6d73 2061 7320 6172 6775 6d65 6e74 7320  ms as arguments 
-00042a90: 746f 2074 6869 7320 6f70 7469 6f6e 2c20  to this option, 
-00042aa0: 692e 652e 2022 0a20 2020 2020 2020 2022  i.e. ".        "
-00042ab0: 6173 2061 7267 756d 656e 7473 2074 6f20  as arguments to 
-00042ac0: 2d2d 726f 6f6d 2d6b 6963 6b2e 2022 0a20  --room-kick. ". 
-00042ad0: 2020 2020 2020 2022 5468 6520 7573 6572         "The user
-00042ae0: 206d 7573 7420 6861 7665 2070 6572 6d69   must have permi
-00042af0: 7373 696f 6e73 2074 6f20 6b69 636b 2075  ssions to kick u
-00042b00: 7365 7273 2e22 2c0a 2020 2020 290a 2020  sers.",.    ).  
-00042b10: 2020 6170 2e61 6464 5f61 7267 756d 656e    ap.add_argumen
-00042b20: 7428 0a20 2020 2020 2020 2023 2073 7461  t(.        # sta
-00042b30: 7274 696e 6720 7769 7468 2076 6572 7369  rting with versi
-00042b40: 6f6e 2032 2e31 3920 222d 7522 2068 6173  on 2.19 "-u" has
-00042b50: 2062 6565 6e20 6d6f 7665 6420 6672 6f6d   been moved from
-00042b60: 0a20 2020 2020 2020 2023 202d 2d64 6f77  .        # --dow
-00042b70: 6e6c 6f61 642d 6d65 6469 6120 746f 202d  nload-media to -
-00042b80: 2d75 7365 7221 0a20 2020 2020 2020 2022  -user!.        "
-00042b90: 2d75 222c 0a20 2020 2020 2020 2022 2d2d  -u",.        "--
-00042ba0: 7573 6572 222c 0a20 2020 2020 2020 2072  user",.        r
-00042bb0: 6571 7569 7265 643d 4661 6c73 652c 0a20  equired=False,. 
-00042bc0: 2020 2020 2020 2061 6374 696f 6e3d 2265         action="e
-00042bd0: 7874 656e 6422 2c0a 2020 2020 2020 2020  xtend",.        
-00042be0: 6e61 7267 733d 222b 222c 0a20 2020 2020  nargs="+",.     
-00042bf0: 2020 2074 7970 653d 7374 722c 0a20 2020     type=str,.   
-00042c00: 2020 2020 206d 6574 6176 6172 3d22 5553       metavar="US
-00042c10: 4552 222c 0a20 2020 2020 2020 2068 656c  ER",.        hel
-00042c20: 703d 2253 7065 6369 6679 206f 6e65 206f  p="Specify one o
-00042c30: 7220 6d75 6c74 6970 6c65 2075 7365 7273  r multiple users
-00042c40: 2e20 220a 2020 2020 2020 2020 2244 6574  . ".        "Det
-00042c50: 6169 6c73 3a3a 2054 6869 7320 6f70 7469  ails:: This opti
-00042c60: 6f6e 2069 7320 6d65 616e 696e 6766 756c  on is meaningful
-00042c70: 2022 0a20 2020 2020 2020 2022 696e 2063   ".        "in c
-00042c80: 6f6d 6269 6e61 7469 6f6e 2077 6974 6820  ombination with 
-00042c90: 6129 2072 6f6f 6d20 6163 7469 6f6e 7320  a) room actions 
-00042ca0: 6c69 6b65 202d 2d72 6f6f 6d2d 696e 7669  like --room-invi
-00042cb0: 7465 2c20 2d2d 726f 6f6d 2d62 616e 2c20  te, --room-ban, 
-00042cc0: 220a 2020 2020 2020 2020 222d 2d72 6f6f  ".        "--roo
-00042cd0: 6d2d 756e 6261 6e2c 2065 7463 2e20 616e  m-unban, etc. an
-00042ce0: 6420 6229 2073 656e 6420 6163 7469 6f6e  d b) send action
-00042cf0: 7320 6c69 6b65 202d 6d2c 202d 692c 202d  s like -m, -i, -
-00042d00: 662c 2065 7463 2e20 220a 2020 2020 2020  f, etc. ".      
-00042d10: 2020 2263 2920 736f 6d65 206c 6973 7465    "c) some liste
-00042d20: 6e20 6163 7469 6f6e 7320 2d2d 6c69 7374  n actions --list
-00042d30: 656e 2c20 6173 2077 656c 6c20 6173 2064  en, as well as d
-00042d40: 2920 6163 7469 6f6e 7320 6c69 6b65 2022  ) actions like "
-00042d50: 0a20 2020 2020 2020 2022 2d2d 6465 6c65  .        "--dele
-00042d60: 7465 2d64 6576 6963 652e 2022 0a20 2020  te-device. ".   
-00042d70: 2020 2020 2022 496e 2063 6173 6520 6f66       "In case of
-00042d80: 2061 2920 7468 6973 206f 7074 696f 6e20   a) this option 
-00042d90: 2d2d 7573 6572 2073 7065 6369 6669 6573  --user specifies
-00042da0: 2074 6865 2075 7365 7273 2022 0a20 2020   the users ".   
-00042db0: 2020 2020 2022 746f 2062 6520 7573 6564       "to be used
-00042dc0: 2077 6974 6820 726f 6f6d 2063 6f6d 6d61   with room comma
-00042dd0: 6e64 7320 286c 696b 6520 696e 7669 7465  nds (like invite
-00042de0: 2c20 6261 6e2c 2065 7463 2e29 2e20 220a  , ban, etc.). ".
-00042df0: 2020 2020 2020 2020 2249 6e20 6361 7365          "In case
-00042e00: 206f 6620 6229 2074 6865 206f 7074 696f   of b) the optio
-00042e10: 6e20 2d2d 7573 6572 2063 616e 2062 6520  n --user can be 
-00042e20: 7573 6564 2061 7320 616e 2061 6c74 6572  used as an alter
-00042e30: 6e61 7469 7665 2022 0a20 2020 2020 2020  native ".       
-00042e40: 2022 746f 2073 7065 6369 6679 696e 6720   "to specifying 
-00042e50: 6120 726f 6f6d 2061 7320 6465 7374 696e  a room as destin
-00042e60: 6174 696f 6e20 666f 7220 7465 7874 2028  ation for text (
-00042e70: 2d6d 292c 2069 6d61 6765 7320 282d 6929  -m), images (-i)
-00042e80: 2c20 220a 2020 2020 2020 2020 2265 7463  , ".        "etc
-00042e90: 2e20 466f 7220 7365 6e64 2061 6374 696f  . For send actio
-00042ea0: 6e73 2027 2d2d 7573 6572 2720 6973 2070  ns '--user' is p
-00042eb0: 726f 7669 6469 6e67 2074 6865 2066 756e  roviding the fun
-00042ec0: 6374 696f 6e61 6c69 7479 206f 6620 220a  ctionality of ".
-00042ed0: 2020 2020 2020 2020 2227 444d 2028 6469          "'DM (di
-00042ee0: 7265 6374 206d 6573 7361 6769 6e67 2927  rect messaging)'
-00042ef0: 2e20 466f 7220 6329 2074 6869 7320 6f70  . For c) this op
-00042f00: 7469 6f6e 2061 6c6c 6f77 7320 616e 2061  tion allows an a
-00042f10: 6c74 6572 6e61 7469 7665 2022 0a20 2020  lternative ".   
-00042f20: 2020 2020 2022 746f 2073 7065 6369 6679       "to specify
-00042f30: 696e 6720 6120 726f 6f6d 2061 7320 6465  ing a room as de
-00042f40: 7374 696e 6174 696f 6e20 666f 7220 736f  stination for so
-00042f50: 6d65 202d 2d6c 6973 7465 6e20 6163 7469  me --listen acti
-00042f60: 6f6e 732e 2022 0a20 2020 2020 2020 2022  ons. ".        "
-00042f70: 466f 7220 6429 2074 6869 7320 6769 7665  For d) this give
-00042f80: 7320 7468 6520 6f70 7469 6f6e 2074 6f20  s the option to 
-00042f90: 6465 6c65 7465 2074 6865 2064 6576 6963  delete the devic
-00042fa0: 6520 6f66 2061 2064 6966 6665 7265 6e74  e of a different
-00042fb0: 2022 0a20 2020 2020 2020 2022 7573 6572   ".        "user
-00042fc0: 2e20 220a 2020 2020 2020 2020 6622 2d2d  . ".        f"--
-00042fd0: 2d2d 2d20 5768 6174 2069 7320 6120 444d  --- What is a DM
-00042fe0: 3f20 7b50 524f 475f 5749 5448 4f55 545f  ? {PROG_WITHOUT_
-00042ff0: 4558 547d 2074 7269 6573 2074 6f20 6669  EXT} tries to fi
-00043000: 6e64 2061 2022 0a20 2020 2020 2020 2022  nd a ".        "
-00043010: 726f 6f6d 2074 6861 7420 636f 6e74 6169  room that contai
-00043020: 6e73 206f 6e6c 7920 7468 6520 7365 6e64  ns only the send
-00043030: 6572 2061 6e64 2074 6865 2072 6563 6569  er and the recei
-00043040: 7665 722c 2068 656e 6365 2044 4d2e 2022  ver, hence DM. "
-00043050: 0a20 2020 2020 2020 2022 5468 6573 6520  .        "These 
-00043060: 726f 6f6d 7320 6861 7665 206e 6f74 6869  rooms have nothi
-00043070: 6e67 2073 7065 6369 616c 206f 7468 6572  ng special other
-00043080: 2074 6865 2066 6163 7420 7468 6174 2074   the fact that t
-00043090: 6865 7920 6f6e 6c79 2068 6176 6520 220a  hey only have ".
-000430a0: 2020 2020 2020 2020 2232 206d 656d 6265          "2 membe
-000430b0: 7273 2061 6e64 2074 6865 6d20 6265 696e  rs and them bein
-000430c0: 6720 7468 6520 7365 6e64 6572 2061 6e64  g the sender and
-000430d0: 2072 6563 6970 6965 6e74 2072 6573 7065   recipient respe
-000430e0: 6374 6976 656c 792e 2022 0a20 2020 2020  ctively. ".     
-000430f0: 2020 2022 4966 2073 7563 6820 6120 726f     "If such a ro
-00043100: 6f6d 2069 7320 666f 756e 642c 2074 6865  om is found, the
-00043110: 2066 6972 7374 206f 6e65 2066 6f75 6e64   first one found
-00043120: 2077 696c 6c20 6265 2075 7365 6420 6173   will be used as
-00043130: 2022 0a20 2020 2020 2020 2022 6465 7374   ".        "dest
-00043140: 696e 6174 696f 6e2e 2049 6620 6e6f 2073  ination. If no s
-00043150: 7563 6820 726f 6f6d 2069 7320 666f 756e  uch room is foun
-00043160: 642c 2074 6865 2073 656e 6420 6661 696c  d, the send fail
-00043170: 7320 616e 6420 7468 6520 7573 6572 2022  s and the user "
-00043180: 0a20 2020 2020 2020 2022 7368 6f75 6c64  .        "should
-00043190: 2064 6f20 6120 2d2d 726f 6f6d 2d63 7265   do a --room-cre
-000431a0: 6174 6520 616e 6420 2d2d 726f 6f6d 2d69  ate and --room-i
-000431b0: 6e76 6974 6520 6669 7273 742e 2049 6620  nvite first. If 
-000431c0: 6d75 6c74 6970 6c65 2022 0a20 2020 2020  multiple ".     
-000431d0: 2020 2022 7375 6368 2072 6f6f 6d73 2065     "such rooms e
-000431e0: 7869 7374 2c20 6f6e 6520 6f66 2074 6865  xist, one of the
-000431f0: 6d20 7769 6c6c 2062 6520 7573 6564 2028  m will be used (
-00043200: 6172 6269 7472 6172 696c 7929 2e20 220a  arbitrarily). ".
-00043210: 2020 2020 2020 2020 2246 6f72 2073 656e          "For sen
-00043220: 6469 6e67 2061 6e64 206c 6973 7465 6e69  ding and listeni
-00043230: 6e67 2c20 7370 6563 6966 7969 6e67 2061  ng, specifying a
-00043240: 2072 6f6f 6d20 6469 7265 6374 6c79 2069   room directly i
-00043250: 7320 616c 7761 7973 2022 0a20 2020 2020  s always ".     
-00043260: 2020 2022 6661 7374 6572 2061 6e64 206d     "faster and m
-00043270: 6f72 6520 6566 6669 6369 656e 7420 7468  ore efficient th
-00043280: 616e 2073 7065 6369 6679 696e 6720 6120  an specifying a 
-00043290: 7573 6572 2e20 536f 2c20 6966 2079 6f75  user. So, if you
-000432a0: 206b 6e6f 7720 220a 2020 2020 2020 2020   know ".        
-000432b0: 2274 6865 2072 6f6f 6d2c 2069 7420 6973  "the room, it is
-000432c0: 2070 7265 6665 7272 6564 2074 6f20 7573   preferred to us
-000432d0: 6520 2d2d 726f 6f6d 2069 6e73 7465 6164  e --room instead
-000432e0: 206f 6620 2d2d 7573 6572 2e20 220a 2020   of --user. ".  
-000432f0: 2020 2020 2020 2246 6f72 2062 2920 616e        "For b) an
-00043300: 6420 6329 202d 2d75 7365 7220 6361 6e20  d c) --user can 
-00043310: 6265 2073 7065 6369 6669 6564 2069 6e20  be specified in 
-00043320: 3320 7761 7973 3a20 3129 2066 756c 6c20  3 ways: 1) full 
-00043330: 7573 6572 2069 6420 220a 2020 2020 2020  user id ".      
-00043340: 2020 2261 7320 696e 2027 406a 6f68 6e3a    "as in '@john:
-00043350: 6578 616d 706c 652e 6f72 6727 2c20 3229  example.org', 2)
-00043360: 2070 6172 7469 616c 2075 7365 7220 6964   partial user id
-00043370: 2061 7320 696e 2027 406a 6f68 6e27 2077   as in '@john' w
-00043380: 6865 6e20 220a 2020 2020 2020 2020 2274  hen ".        "t
-00043390: 6865 2075 7365 7220 6973 206f 6e20 7468  he user is on th
-000433a0: 6520 7361 6d65 2068 6f6d 6573 6572 7665  e same homeserve
-000433b0: 7220 2865 7861 6d70 6c65 2e6f 7267 2077  r (example.org w
-000433c0: 696c 6c20 6265 2022 0a20 2020 2020 2020  ill be ".       
-000433d0: 2022 6175 746f 6d61 7469 6361 6c6c 7920   "automatically 
-000433e0: 6170 7065 6e64 6564 292c 206f 7220 3329  appended), or 3)
-000433f0: 2061 2064 6973 706c 6179 206e 616d 6520   a display name 
-00043400: 6173 2069 6e20 276a 6f68 6e27 2e20 220a  as in 'john'. ".
-00043410: 2020 2020 2020 2020 2242 6520 6361 7265          "Be care
-00043420: 6675 6c2c 2077 6865 6e20 220a 2020 2020  ful, when ".    
-00043430: 2020 2020 2275 7369 6e67 2064 6973 706c      "using displ
-00043440: 6179 206e 616d 6573 2061 7320 7468 6579  ay names as they
-00043450: 206d 6967 6874 206e 6f74 2062 6520 756e   might not be un
-00043460: 6971 7565 2c20 616e 6420 796f 7520 636f  ique, and you co
-00043470: 756c 6420 220a 2020 2020 2020 2020 2262  uld ".        "b
-00043480: 6520 7365 6e64 696e 6720 746f 2074 6865  e sending to the
-00043490: 2077 726f 6e67 2070 6572 736f 6e2e 2054   wrong person. T
-000434a0: 6f20 7365 6520 706f 7373 6962 6c65 2064  o see possible d
-000434b0: 6973 706c 6179 206e 616d 6573 2075 7365  isplay names use
-000434c0: 2022 0a20 2020 2020 2020 2022 7468 6520   ".        "the 
-000434d0: 2d2d 6a6f 696e 6564 2d6d 656d 6265 7273  --joined-members
-000434e0: 2027 2a27 206f 7074 696f 6e20 7768 6963   '*' option whic
-000434f0: 6820 7769 6c6c 2073 686f 7720 796f 7520  h will show you 
-00043500: 7468 6520 6469 7370 6c61 7920 220a 2020  the display ".  
-00043510: 2020 2020 2020 226e 616d 6573 2069 6e20        "names in 
-00043520: 7468 6520 6d69 6464 6c65 2063 6f6c 756d  the middle colum
-00043530: 6e2e 222c 0a20 2020 2029 0a20 2020 2061  n.",.    ).    a
-00043540: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
-00043550: 2020 2020 2020 2020 222d 2d75 7365 722d          "--user-
-00043560: 6c6f 6769 6e22 2c0a 2020 2020 2020 2020  login",.        
-00043570: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
-00043580: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
-00043590: 2c0a 2020 2020 2020 2020 2320 406a 6f68  ,.        # @joh
-000435a0: 6e3a 6578 616d 706c 652e 636f 6d20 616e  n:example.com an
-000435b0: 6420 406a 6f68 6e20 616e 6420 6a6f 686e  d @john and john
-000435c0: 2061 6363 6570 7465 640a 2020 2020 2020   accepted.      
-000435d0: 2020 6d65 7461 7661 723d 2255 5345 5222    metavar="USER"
-000435e0: 2c0a 2020 2020 2020 2020 6865 6c70 3d22  ,.        help="
-000435f0: 5370 6563 6966 7920 7573 6572 2066 6f72  Specify user for
-00043600: 202d 2d6c 6f67 696e 2e20 220a 2020 2020   --login. ".    
-00043610: 2020 2020 2244 6574 6169 6c73 3a3a 204f      "Details:: O
-00043620: 7074 696f 6e61 6c20 6172 6775 6d65 6e74  ptional argument
-00043630: 2074 6f20 7370 6563 6966 7920 7468 6520   to specify the 
-00043640: 7573 6572 2066 6f72 202d 2d6c 6f67 696e  user for --login
-00043650: 2e20 220a 2020 2020 2020 2020 2254 6869  . ".        "Thi
-00043660: 7320 6769 7665 7320 7468 6520 6f70 7469  s gives the opti
-00043670: 6f6e 2074 6f20 7370 6563 6966 7920 7468  on to specify th
-00043680: 6520 7573 6572 2069 6420 666f 7220 6c6f  e user id for lo
-00043690: 6769 6e2e 2022 0a20 2020 2020 2020 2022  gin. ".        "
-000436a0: 466f 7220 272d 2d6c 6f67 696e 2073 736f  For '--login sso
-000436b0: 2720 7468 6520 2d2d 7573 6572 2d6c 6f67  ' the --user-log
-000436c0: 696e 2069 7320 6e6f 7420 6e65 6564 6564  in is not needed
-000436d0: 2061 7320 7573 6572 2069 6420 6361 6e20   as user id can 
-000436e0: 6265 2022 0a20 2020 2020 2020 2022 6f62  be ".        "ob
-000436f0: 7461 696e 6564 2066 726f 6d20 7365 7276  tained from serv
-00043700: 6572 2076 6961 2053 534f 2e20 466f 7220  er via SSO. For 
-00043710: 272d 2d6c 6f67 696e 2070 6173 7377 6f72  '--login passwor
-00043720: 6427 2c20 6966 206e 6f74 2022 0a20 2020  d', if not ".   
-00043730: 2020 2020 2022 7072 6f76 6964 6564 2069       "provided i
-00043740: 7420 7769 6c6c 2062 6520 7175 6572 6965  t will be querie
-00043750: 6420 7669 6120 6b65 7962 6f61 7264 2e20  d via keyboard. 
-00043760: 4120 6675 6c6c 2075 7365 7220 6964 206c  A full user id l
-00043770: 696b 6520 220a 2020 2020 2020 2020 2227  ike ".        "'
-00043780: 406a 6f68 6e3a 6578 616d 706c 652e 636f  @john:example.co
-00043790: 6d27 2c20 6120 7061 7274 6961 6c20 7573  m', a partial us
-000437a0: 6572 206e 616d 6520 6c69 6b65 2027 406a  er name like '@j
-000437b0: 6f68 6e27 2c20 616e 6420 220a 2020 2020  ohn', and ".    
-000437c0: 2020 2020 2261 2073 686f 7274 2075 7365      "a short use
-000437d0: 7220 6e61 6d65 206c 696b 6520 276a 6f68  r name like 'joh
-000437e0: 6e27 2063 616e 2062 6520 6769 7665 6e2e  n' can be given.
-000437f0: 2022 0a20 2020 2020 2020 2022 2d2d 7573   ".        "--us
-00043800: 6572 2d6c 6f67 696e 2069 7320 6f6e 6c79  er-login is only
-00043810: 2075 7365 6420 6279 202d 2d6c 6f67 696e   used by --login
-00043820: 2061 6e64 2069 676e 6f72 6564 2062 7920   and ignored by 
-00043830: 616c 6c20 6f74 6865 7220 220a 2020 2020  all other ".    
-00043840: 2020 2020 2261 6374 696f 6e73 2e22 2c0a      "actions.",.
-00043850: 2020 2020 290a 2020 2020 6170 2e61 6464      ).    ap.add
-00043860: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
-00043870: 2020 2022 2d2d 6e61 6d65 222c 0a20 2020     "--name",.   
-00043880: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
-00043890: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
-000438a0: 696f 6e3d 2265 7874 656e 6422 2c0a 2020  ion="extend",.  
-000438b0: 2020 2020 2020 6e61 7267 733d 222b 222c        nargs="+",
-000438c0: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
-000438d0: 722c 0a20 2020 2020 2020 206d 6574 6176  r,.        metav
-000438e0: 6172 3d22 524f 4f4d 5f4e 414d 4522 2c0a  ar="ROOM_NAME",.
-000438f0: 2020 2020 2020 2020 6865 6c70 3d22 5370          help="Sp
-00043900: 6563 6966 7920 6f6e 6520 6f72 206d 756c  ecify one or mul
-00043910: 7469 706c 6520 726f 6f6d 206e 616d 6573  tiple room names
-00043920: 2e20 220a 2020 2020 2020 2020 2244 6574  . ".        "Det
-00043930: 6169 6c73 3a3a 2054 6869 7320 6f70 7469  ails:: This opti
-00043940: 6f6e 2069 7320 6f6e 6c79 206d 6561 6e69  on is only meani
-00043950: 6e67 6675 6c20 220a 2020 2020 2020 2020  ngful ".        
-00043960: 2269 6e20 636f 6d62 696e 6174 696f 6e20  "in combination 
-00043970: 7769 7468 206f 7074 696f 6e20 2d2d 726f  with option --ro
-00043980: 6f6d 2d63 7265 6174 652e 2022 0a20 2020  om-create. ".   
-00043990: 2020 2020 2022 5468 6973 206f 7074 696f       "This optio
-000439a0: 6e20 2d2d 6e61 6d65 2073 7065 6369 6669  n --name specifi
-000439b0: 6573 2074 6865 206e 616d 6573 2022 0a20  es the names ". 
-000439c0: 2020 2020 2020 2022 746f 2062 6520 7573         "to be us
-000439d0: 6564 2077 6974 6820 7468 6520 636f 6d6d  ed with the comm
-000439e0: 616e 6420 2d2d 726f 6f6d 2d63 7265 6174  and --room-creat
-000439f0: 652e 222c 0a20 2020 2029 0a20 2020 2061  e.",.    ).    a
-00043a00: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
-00043a10: 2020 2020 2020 2020 222d 2d74 6f70 6963          "--topic
-00043a20: 222c 0a20 2020 2020 2020 2072 6571 7569  ",.        requi
-00043a30: 7265 643d 4661 6c73 652c 0a20 2020 2020  red=False,.     
-00043a40: 2020 2061 6374 696f 6e3d 2265 7874 656e     action="exten
-00043a50: 6422 2c0a 2020 2020 2020 2020 6e61 7267  d",.        narg
-00043a60: 733d 222b 222c 0a20 2020 2020 2020 2074  s="+",.        t
-00043a70: 7970 653d 7374 722c 0a20 2020 2020 2020  ype=str,.       
-00043a80: 206d 6574 6176 6172 3d22 524f 4f4d 5f54   metavar="ROOM_T
-00043a90: 4f50 4943 222c 0a20 2020 2020 2020 2068  OPIC",.        h
-00043aa0: 656c 703d 2253 7065 6369 6679 206f 6e65  elp="Specify one
-00043ab0: 206f 7220 6d75 6c74 6970 6c65 2072 6f6f   or multiple roo
-00043ac0: 6d20 746f 7069 6373 2e20 220a 2020 2020  m topics. ".    
-00043ad0: 2020 2020 2244 6574 6169 6c73 3a3a 2054      "Details:: T
-00043ae0: 6869 7320 6f70 7469 6f6e 2069 7320 6f6e  his option is on
-00043af0: 6c79 206d 6561 6e69 6e67 6675 6c20 220a  ly meaningful ".
-00043b00: 2020 2020 2020 2020 2269 6e20 636f 6d62          "in comb
-00043b10: 696e 6174 696f 6e20 7769 7468 206f 7074  ination with opt
-00043b20: 696f 6e20 2d2d 726f 6f6d 2d63 7265 6174  ion --room-creat
-00043b30: 652e 2022 0a20 2020 2020 2020 2022 5468  e. ".        "Th
-00043b40: 6973 206f 7074 696f 6e20 2d2d 746f 7069  is option --topi
-00043b50: 6320 7370 6563 6966 6965 7320 7468 6520  c specifies the 
-00043b60: 746f 7069 6373 2022 0a20 2020 2020 2020  topics ".       
-00043b70: 2022 746f 2062 6520 7573 6564 2077 6974   "to be used wit
-00043b80: 6820 7468 6520 636f 6d6d 616e 6420 2d2d  h the command --
-00043b90: 726f 6f6d 2d63 7265 6174 652e 222c 0a20  room-create.",. 
-00043ba0: 2020 2029 0a20 2020 2061 702e 6164 645f     ).    ap.add_
-00043bb0: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
-00043bc0: 2020 222d 2d61 6c69 6173 222c 0a20 2020    "--alias",.   
-00043bd0: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
-00043be0: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
-00043bf0: 696f 6e3d 2265 7874 656e 6422 2c0a 2020  ion="extend",.  
-00043c00: 2020 2020 2020 6e61 7267 733d 222b 222c        nargs="+",
-00043c10: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
-00043c20: 722c 0a20 2020 2020 2020 206d 6574 6176  r,.        metav
-00043c30: 6172 3d22 524f 4f4d 5f41 4c49 4153 222c  ar="ROOM_ALIAS",
-00043c40: 0a20 2020 2020 2020 2068 656c 703d 2253  .        help="S
-00043c50: 7065 6369 6679 206f 6e65 206f 7220 6d75  pecify one or mu
-00043c60: 6c74 6970 6c65 2072 6f6f 6d20 616c 6961  ltiple room alia
-00043c70: 7365 732e 2022 0a20 2020 2020 2020 2022  ses. ".        "
-00043c80: 4465 7461 696c 733a 3a20 5468 6973 206f  Details:: This o
-00043c90: 7074 696f 6e20 6973 206f 6e6c 7920 220a  ption is only ".
-00043ca0: 2020 2020 2020 2020 226d 6561 6e69 6e67          "meaning
-00043cb0: 6675 6c20 696e 2063 6f6d 6269 6e61 7469  ful in combinati
-00043cc0: 6f6e 2077 6974 6820 6f70 7469 6f6e 202d  on with option -
-00043cd0: 2d72 6f6f 6d2d 646d 2d63 7265 6174 652e  -room-dm-create.
-00043ce0: 2022 0a20 2020 2020 2020 2022 5468 6973   ".        "This
-00043cf0: 206f 7074 696f 6e20 2d2d 616c 6961 7320   option --alias 
-00043d00: 7370 6563 6966 6965 7320 7468 6520 616c  specifies the al
-00043d10: 6961 7365 7320 746f 2062 6520 7573 6564  iases to be used
-00043d20: 2022 0a20 2020 2020 2020 2022 7769 7468   ".        "with
-00043d30: 2074 6865 2063 6f6d 6d61 6e64 202d 2d72   the command --r
-00043d40: 6f6f 6d2d 646d 2d63 7265 6174 652e 222c  oom-dm-create.",
-00043d50: 0a20 2020 2029 0a20 2020 2023 2061 6c6c  .    ).    # all
-00043d60: 6f77 206d 756c 7469 706c 6520 6d65 7373  ow multiple mess
-00043d70: 6167 6573 202c 2065 2e67 2e20 2d6d 2022  ages , e.g. -m "
-00043d80: 6d31 2220 226d 3222 206f 7220 2d6d 2022  m1" "m2" or -m "
-00043d90: 6d31 2220 2d6d 2022 6d32 220a 2020 2020  m1" -m "m2".    
-00043da0: 2320 6d65 7373 6167 6520 6973 2067 6f69  # message is goi
-00043db0: 6e67 2074 6f20 6265 2061 206c 6973 7420  ng to be a list 
-00043dc0: 6f66 2073 7472 696e 6773 0a20 2020 2023  of strings.    #
-00043dd0: 2065 2e67 2e20 6d65 7373 6167 653d 5b20   e.g. message=[ 
-00043de0: 276d 3127 2c20 276d 3227 205d 0a20 2020  'm1', 'm2' ].   
-00043df0: 2061 702e 6164 645f 6172 6775 6d65 6e74   ap.add_argument
-00043e00: 280a 2020 2020 2020 2020 222d 6d22 2c0a  (.        "-m",.
-00043e10: 2020 2020 2020 2020 222d 2d6d 6573 7361          "--messa
-00043e20: 6765 222c 0a20 2020 2020 2020 2072 6571  ge",.        req
-00043e30: 7569 7265 643d 4661 6c73 652c 0a20 2020  uired=False,.   
-00043e40: 2020 2020 2061 6374 696f 6e3d 2265 7874       action="ext
-00043e50: 656e 6422 2c0a 2020 2020 2020 2020 6e61  end",.        na
-00043e60: 7267 733d 222b 222c 0a20 2020 2020 2020  rgs="+",.       
-00043e70: 2074 7970 653d 7374 722c 0a20 2020 2020   type=str,.     
-00043e80: 2020 206d 6574 6176 6172 3d22 5445 5854     metavar="TEXT
-00043e90: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
-00043ea0: 2253 656e 6420 6f6e 6520 6f72 206d 756c  "Send one or mul
-00043eb0: 7469 706c 6520 7465 7874 206d 6573 7361  tiple text messa
-00043ec0: 6765 732e 2022 0a20 2020 2020 2020 2022  ges. ".        "
-00043ed0: 4465 7461 696c 733a 3a20 4d65 7373 6167  Details:: Messag
-00043ee0: 6520 6461 7461 206d 7573 7420 6e6f 7420  e data must not 
-00043ef0: 6265 2062 696e 6172 7920 6461 7461 2c20  be binary data, 
-00043f00: 6974 2022 0a20 2020 2020 2020 2022 6d75  it ".        "mu
-00043f10: 7374 2062 6520 7465 7874 2e20 4966 206e  st be text. If n
-00043f20: 6f20 272d 6d27 2069 7320 7573 6564 2061  o '-m' is used a
-00043f30: 6e64 206e 6f20 6f74 6865 7220 636f 6e66  nd no other conf
-00043f40: 6c69 6374 696e 6720 220a 2020 2020 2020  licting ".      
-00043f50: 2020 2261 7267 756d 656e 7473 2061 7265    "arguments are
-00043f60: 2070 726f 7669 6465 642c 2061 6e64 2069   provided, and i
-00043f70: 6e66 6f72 6d61 7469 6f6e 2069 7320 7069  nformation is pi
-00043f80: 7065 6420 696e 746f 2074 6865 2070 726f  ped into the pro
-00043f90: 6772 616d 2c20 220a 2020 2020 2020 2020  gram, ".        
-00043fa0: 2274 6865 6e20 7468 6520 7069 7065 6420  "then the piped 
-00043fb0: 6461 7461 2077 696c 6c20 6265 2075 7365  data will be use
-00043fc0: 6420 6173 206d 6573 7361 6765 2e20 220a  d as message. ".
-00043fd0: 2020 2020 2020 2020 2246 696e 616c 6c79          "Finally
-00043fe0: 2c20 6966 2074 6865 7265 2061 7265 206e  , if there are n
-00043ff0: 6f20 6f70 6572 6174 696f 6e73 2061 7420  o operations at 
-00044000: 616c 6c20 696e 2074 6865 2061 7267 756d  all in the argum
-00044010: 656e 7473 2c20 7468 656e 2022 0a20 2020  ents, then ".   
-00044020: 2020 2020 2022 6120 6d65 7373 6167 6520       "a message 
-00044030: 7769 6c6c 2062 6520 7265 6164 2066 726f  will be read fro
-00044040: 6d20 7374 6469 6e2c 2069 2e65 2e20 6672  m stdin, i.e. fr
-00044050: 6f6d 2074 6865 206b 6579 626f 6172 642e  om the keyboard.
-00044060: 2022 0a20 2020 2020 2020 2022 5468 6973   ".        "This
-00044070: 206f 7074 696f 6e20 6361 6e20 6265 2075   option can be u
-00044080: 7365 6420 6d75 6c74 6970 6c65 2074 696d  sed multiple tim
-00044090: 6573 2074 6f20 7365 6e64 2022 0a20 2020  es to send ".   
-000440a0: 2020 2020 2022 6d75 6c74 6970 6c65 206d       "multiple m
-000440b0: 6573 7361 6765 732e 2049 6620 7468 6572  essages. If ther
-000440c0: 6520 6973 2064 6174 6120 7069 7065 6420  e is data piped 
-000440d0: 220a 2020 2020 2020 2020 2269 6e74 6f20  ".        "into 
-000440e0: 7468 6973 2070 726f 6772 616d 2c20 7468  this program, th
-000440f0: 656e 2066 6972 7374 2064 6174 6120 6672  en first data fr
-00044100: 6f6d 2074 6865 2022 0a20 2020 2020 2020  om the ".       
-00044110: 2022 7069 7065 2069 7320 7075 626c 6973   "pipe is publis
-00044120: 6865 642c 2074 6865 6e20 6d65 7373 6167  hed, then messag
-00044130: 6573 2066 726f 6d20 7468 6973 2022 0a20  es from this ". 
-00044140: 2020 2020 2020 2022 6f70 7469 6f6e 2061         "option a
-00044150: 7265 2070 7562 6c69 7368 6564 2e20 4d65  re published. Me
-00044160: 7373 6167 6573 2077 696c 6c20 6265 2073  ssages will be s
-00044170: 656e 7420 6c61 7374 2c20 220a 2020 2020  ent last, ".    
-00044180: 2020 2020 2269 2e65 2e20 6166 7465 7220      "i.e. after 
-00044190: 6f62 6a65 6374 7320 6c69 6b65 2069 6d61  objects like ima
-000441a0: 6765 732c 2061 7564 696f 2c20 6669 6c65  ges, audio, file
-000441b0: 732c 2065 7665 6e74 732c 2065 7463 2e20  s, events, etc. 
-000441c0: 220a 2020 2020 2020 2020 2249 6e70 7574  ".        "Input
-000441d0: 2070 6970 6564 2076 6961 2073 7464 696e   piped via stdin
-000441e0: 2063 616e 2061 6464 6974 696f 6e61 6c6c   can additionall
-000441f0: 7920 6265 2073 7065 6369 6669 6564 2077  y be specified w
-00044200: 6974 6820 7468 6520 220a 2020 2020 2020  ith the ".      
-00044210: 2020 2273 7065 6369 616c 2063 6861 7261    "special chara
-00044220: 6374 6572 2027 2d27 2e20 220a 2020 2020  cter '-'. ".    
-00044230: 2020 2020 6622 4966 2079 6f75 2077 616e      f"If you wan
-00044240: 7420 746f 2066 6565 6420 6120 7465 7874  t to feed a text
-00044250: 206d 6573 7361 6765 2069 6e74 6f20 7b50   message into {P
-00044260: 524f 475f 5749 5448 4f55 545f 4558 547d  ROG_WITHOUT_EXT}
-00044270: 2022 0a20 2020 2020 2020 2022 7669 6120   ".        "via 
-00044280: 6120 7069 7065 2c20 7669 6120 7374 6469  a pipe, via stdi
-00044290: 6e2c 2074 6865 6e20 7370 6563 6966 7920  n, then specify 
-000442a0: 7468 6520 7370 6563 6961 6c20 220a 2020  the special ".  
-000442b0: 2020 2020 2020 2263 6861 7261 6374 6572        "character
-000442c0: 2027 2d27 2e20 4966 2027 2d27 2069 7320   '-'. If '-' is 
-000442d0: 7370 6563 6966 6965 6420 6173 206d 6573  specified as mes
-000442e0: 7361 6765 2c20 220a 2020 2020 2020 2020  sage, ".        
-000442f0: 2274 6865 6e20 7468 6520 7072 6f67 7261  "then the progra
-00044300: 6d20 7769 6c6c 2072 6561 6420 7468 6520  m will read the 
-00044310: 6d65 7373 6167 6520 6672 6f6d 2073 7464  message from std
-00044320: 696e 2e20 220a 2020 2020 2020 2020 2257  in. ".        "W
-00044330: 6974 6820 272d 2720 7468 6520 7768 6f6c  ith '-' the whol
-00044340: 6520 6d65 7373 6167 652c 2061 6c6c 206c  e message, all l
-00044350: 696e 6573 2c20 7769 6c6c 2062 6520 636f  ines, will be co
-00044360: 6e73 6964 6572 6564 2022 0a20 2020 2020  nsidered ".     
-00044370: 2020 2022 6120 7369 6e67 6c65 206d 6573     "a single mes
-00044380: 7361 6765 2061 6e64 2073 656e 7420 6173  sage and sent as
-00044390: 206f 6e65 206d 6573 7361 6765 2e20 220a   one message. ".
-000443a0: 2020 2020 2020 2020 2249 6620 796f 7572          "If your
-000443b0: 206d 6573 7361 6765 2069 7320 6c69 7465   message is lite
-000443c0: 7261 6c6c 7920 272d 2720 7468 656e 2075  rally '-' then u
-000443d0: 7365 2027 5c5c 2d27 2022 0a20 2020 2020  se '\\-' ".     
-000443e0: 2020 2022 6173 206d 6573 7361 6765 2069     "as message i
-000443f0: 6e20 7468 6520 6172 6775 6d65 6e74 2e20  n the argument. 
-00044400: 220a 2020 2020 2020 2020 2227 2d27 206d  ".        "'-' m
-00044410: 6179 2061 7070 6561 7220 696e 2061 6e79  ay appear in any
-00044420: 2070 6f73 6974 696f 6e2c 2069 2e65 2e20   position, i.e. 
-00044430: 272d 6d20 5c22 7374 6172 745c 2220 2d20  '-m \"start\" - 
-00044440: 5c22 656e 645c 2227 2022 0a20 2020 2020  \"end\"' ".     
-00044450: 2020 2022 7769 6c6c 2073 656e 6420 3320     "will send 3 
-00044460: 6d65 7373 6167 6573 206f 7574 206f 6620  messages out of 
-00044470: 7768 6963 6820 7468 6520 7365 636f 6e64  which the second
-00044480: 206f 6e65 2069 7320 7265 6164 2066 726f   one is read fro
-00044490: 6d20 7374 6469 6e2e 2022 0a20 2020 2020  m stdin. ".     
-000444a0: 2020 2022 272d 2720 6d61 7920 6170 7065     "'-' may appe
-000444b0: 6172 206f 6e6c 7920 6f6e 6365 206f 7665  ar only once ove
-000444c0: 7261 6c6c 2069 6e20 616c 6c20 6172 6775  rall in all argu
-000444d0: 6d65 6e74 732e 2022 0a20 2020 2020 2020  ments. ".       
-000444e0: 2022 5369 6d69 6c61 7220 746f 2027 2d27   "Similar to '-'
-000444f0: 2c20 616e 6f74 6865 7220 7368 6f72 7463  , another shortc
-00044500: 7574 2063 6861 7261 6374 6572 2069 7320  ut character is 
-00044510: 275f 272e 2054 6865 2022 0a20 2020 2020  '_'. The ".     
-00044520: 2020 2022 7370 6563 6961 6c20 6368 6172     "special char
-00044530: 6163 7465 7220 275f 2720 6973 2075 7365  acter '_' is use
-00044540: 6420 666f 7220 7374 7265 616d 696e 6720  d for streaming 
-00044550: 6461 7461 2076 6961 2022 0a20 2020 2020  data via ".     
-00044560: 2020 2022 6120 7069 7065 206f 6e20 7374     "a pipe on st
-00044570: 6469 6e2e 2057 6974 6820 275f 2720 7468  din. With '_' th
-00044580: 6520 7374 6469 6e20 7069 7065 2069 7320  e stdin pipe is 
-00044590: 7265 6164 206c 696e 652d 6279 2d6c 696e  read line-by-lin
-000445a0: 6520 220a 2020 2020 2020 2020 2261 6e64  e ".        "and
-000445b0: 2065 6163 6820 6c69 6e65 2069 7320 7472   each line is tr
-000445c0: 6561 7465 6420 6173 2061 2073 6570 6172  eated as a separ
-000445d0: 6174 6520 6d65 7373 6167 6520 616e 6420  ate message and 
-000445e0: 7365 6e74 2072 6967 6874 2022 0a20 2020  sent right ".   
-000445f0: 2020 2020 2022 6177 6179 2e20 5468 6520       "away. The 
-00044600: 7072 6f67 7261 6d20 7761 6974 7320 666f  program waits fo
-00044610: 7220 7069 7065 2069 6e70 7574 2075 6e74  r pipe input unt
-00044620: 696c 2074 6865 2070 6970 6520 6973 2022  il the pipe is "
-00044630: 0a20 2020 2020 2020 2022 636c 6f73 6564  .        "closed
-00044640: 2e20 452e 672e 2049 6d61 6769 6e65 2061  . E.g. Imagine a
-00044650: 2074 6f6f 6c20 7468 6174 2067 656e 6572   tool that gener
-00044660: 6174 6573 206f 7574 7075 7420 7370 6f72  ates output spor
-00044670: 6164 6963 616c 6c79 2022 0a20 2020 2020  adically ".     
-00044680: 2020 2066 2232 3478 372e 2049 7420 6361     f"24x7. It ca
-00044690: 6e20 6265 2070 6970 6564 2c20 692e 652e  n be piped, i.e.
-000446a0: 2073 7472 6561 6d65 642c 2069 6e74 6f20   streamed, into 
-000446b0: 7b50 524f 475f 5749 5448 4f55 545f 4558  {PROG_WITHOUT_EX
-000446c0: 547d 2c20 616e 6420 220a 2020 2020 2020  T}, and ".      
-000446d0: 2020 6622 7b50 524f 475f 5749 5448 4f55    f"{PROG_WITHOU
-000446e0: 545f 4558 547d 2073 7461 7973 2061 6374  T_EXT} stays act
-000446f0: 6976 652c 2073 656e 6469 6e67 2061 6c6c  ive, sending all
-00044700: 2069 6e70 7574 2069 6e73 7461 6e74 6c79   input instantly
-00044710: 2e20 220a 2020 2020 2020 2020 2249 6620  . ".        "If 
-00044720: 796f 7520 7761 6e74 2074 6f20 7365 6e64  you want to send
-00044730: 2074 6865 206c 6974 6572 616c 206c 6574   the literal let
-00044740: 7465 7220 275f 2720 7468 656e 2065 7363  ter '_' then esc
-00044750: 6170 6520 6974 2022 0a20 2020 2020 2020  ape it ".       
-00044760: 2022 616e 6420 7365 6e64 2027 5c5c 5f27   "and send '\\_'
-00044770: 2e20 220a 2020 2020 2020 2020 2227 5f27  . ".        "'_'
-00044780: 2063 616e 2062 6520 7573 6564 206f 6e6c   can be used onl
-00044790: 7920 6f6e 6365 2e20 416e 6420 6569 7468  y once. And eith
-000447a0: 6572 2027 2d27 206f 7220 275f 2720 6361  er '-' or '_' ca
-000447b0: 6e20 6265 2075 7365 642e 2022 2c0a 2020  n be used. ",.  
-000447c0: 2020 290a 2020 2020 2320 616c 6c6f 7720    ).    # allow 
-000447d0: 6d75 6c74 6970 6c65 206d 6573 7361 6765  multiple message
-000447e0: 7320 2c20 652e 672e 202d 6920 2269 312e  s , e.g. -i "i1.
-000447f0: 6a70 6722 2022 6932 2e67 6966 220a 2020  jpg" "i2.gif".  
-00044800: 2020 2320 6f72 202d 6920 2269 312e 706e    # or -i "i1.pn
-00044810: 6722 202d 6920 2269 322e 6a70 6567 220a  g" -i "i2.jpeg".
-00044820: 2020 2020 2320 696d 6167 6520 6973 2067      # image is g
-00044830: 6f69 6e67 2074 6f20 6265 2061 206c 6973  oing to be a lis
-00044840: 7420 6f66 2073 7472 696e 6773 0a20 2020  t of strings.   
-00044850: 2023 2065 2e67 2e20 696d 6167 653d 5b20   # e.g. image=[ 
-00044860: 2769 312e 6a70 6727 2c20 2769 322e 706e  'i1.jpg', 'i2.pn
-00044870: 6727 205d 0a20 2020 2061 702e 6164 645f  g' ].    ap.add_
-00044880: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
-00044890: 2020 222d 6922 2c0a 2020 2020 2020 2020    "-i",.        
-000448a0: 222d 2d69 6d61 6765 222c 0a20 2020 2020  "--image",.     
-000448b0: 2020 2072 6571 7569 7265 643d 4661 6c73     required=Fals
-000448c0: 652c 0a20 2020 2020 2020 2061 6374 696f  e,.        actio
-000448d0: 6e3d 2265 7874 656e 6422 2c0a 2020 2020  n="extend",.    
-000448e0: 2020 2020 6e61 7267 733d 222b 222c 0a20      nargs="+",. 
-000448f0: 2020 2020 2020 2074 7970 653d 7374 722c         type=str,
-00044900: 0a20 2020 2020 2020 206d 6574 6176 6172  .        metavar
-00044910: 3d22 494d 4147 455f 4649 4c45 222c 0a20  ="IMAGE_FILE",. 
-00044920: 2020 2020 2020 2068 656c 703d 2253 656e         help="Sen
-00044930: 6420 6f6e 6520 6f72 206d 756c 7469 706c  d one or multipl
-00044940: 6520 696d 6167 6520 6669 6c65 732e 2022  e image files. "
-00044950: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
-00044960: 733a 3a20 5468 6973 206f 7074 696f 6e20  s:: This option 
-00044970: 6361 6e20 6265 2075 7365 6420 6d75 6c74  can be used mult
-00044980: 6970 6c65 2074 696d 6573 2074 6f20 7365  iple times to se
-00044990: 6e64 2022 0a20 2020 2020 2020 2022 6d75  nd ".        "mu
-000449a0: 6c74 6970 6c65 2069 6d61 6765 732e 2046  ltiple images. F
-000449b0: 6972 7374 2069 6d61 6765 7320 6172 6520  irst images are 
-000449c0: 7365 6e74 2c20 220a 2020 2020 2020 2020  sent, ".        
-000449d0: 2274 6865 6e20 7465 7874 206d 6573 7361  "then text messa
-000449e0: 6765 7320 6172 6520 7365 6e74 2e20 220a  ges are sent. ".
-000449f0: 2020 2020 2020 2020 6622 4966 2079 6f75          f"If you
-00044a00: 2077 616e 7420 746f 2066 6565 6420 616e   want to feed an
-00044a10: 2069 6d61 6765 2069 6e74 6f20 7b50 524f   image into {PRO
-00044a20: 475f 5749 5448 4f55 545f 4558 547d 2022  G_WITHOUT_EXT} "
-00044a30: 0a20 2020 2020 2020 2022 7669 6120 6120  .        "via a 
-00044a40: 7069 7065 2c20 7669 6120 7374 6469 6e2c  pipe, via stdin,
-00044a50: 2074 6865 6e20 7370 6563 6966 7920 7468   then specify th
-00044a60: 6520 7370 6563 6961 6c20 220a 2020 2020  e special ".    
-00044a70: 2020 2020 2263 6861 7261 6374 6572 2027      "character '
-00044a80: 2d27 2e20 4966 2027 2d27 2069 7320 7370  -'. If '-' is sp
-00044a90: 6563 6966 6965 6420 6173 2069 6d61 6765  ecified as image
-00044aa0: 2066 696c 6520 6e61 6d65 2c20 220a 2020   file name, ".  
-00044ab0: 2020 2020 2020 2274 6865 6e20 7468 6520        "then the 
-00044ac0: 7072 6f67 7261 6d20 7769 6c6c 2072 6561  program will rea
-00044ad0: 6420 7468 6520 696d 6167 6520 6461 7461  d the image data
-00044ae0: 2066 726f 6d20 7374 6469 6e2e 2022 0a20   from stdin. ". 
-00044af0: 2020 2020 2020 2022 4966 2079 6f75 7220         "If your 
-00044b00: 696d 6167 6520 6669 6c65 2069 7320 6c69  image file is li
-00044b10: 7465 7261 6c6c 7920 6e61 6d65 6420 272d  terally named '-
-00044b20: 2720 7468 656e 2075 7365 2027 5c5c 2d27  ' then use '\\-'
-00044b30: 2022 0a20 2020 2020 2020 2022 6173 2066   ".        "as f
-00044b40: 696c 6520 6e61 6d65 2069 6e20 7468 6520  ile name in the 
-00044b50: 6172 6775 6d65 6e74 2e20 220a 2020 2020  argument. ".    
-00044b60: 2020 2020 2227 2d27 206d 6179 2061 7070      "'-' may app
-00044b70: 6561 7220 696e 2061 6e79 2070 6f73 6974  ear in any posit
-00044b80: 696f 6e2c 2069 2e65 2e20 272d 6920 696d  ion, i.e. '-i im
-00044b90: 6167 6531 2e6a 7067 202d 2069 6d61 6765  age1.jpg - image
-00044ba0: 332e 706e 6727 2022 0a20 2020 2020 2020  3.png' ".       
-00044bb0: 2022 7769 6c6c 2073 656e 6420 3320 696d   "will send 3 im
-00044bc0: 6167 6573 206f 7574 206f 6620 7768 6963  ages out of whic
-00044bd0: 6820 7468 6520 7365 636f 6e64 206f 6e65  h the second one
-00044be0: 2069 7320 7265 6164 2066 726f 6d20 7374   is read from st
-00044bf0: 6469 6e2e 2022 0a20 2020 2020 2020 2022  din. ".        "
-00044c00: 272d 2720 6d61 7920 6170 7065 6172 206f  '-' may appear o
-00044c10: 6e6c 7920 6f6e 6365 206f 7665 7261 6c6c  nly once overall
-00044c20: 2069 6e20 616c 6c20 6172 6775 6d65 6e74   in all argument
-00044c30: 732e 2022 0a20 2020 2020 2020 2022 4966  s. ".        "If
-00044c40: 2074 6865 2066 696c 6520 6578 6973 7473   the file exists
-00044c50: 2061 6c72 6561 6479 2c20 6974 2069 7320   already, it is 
-00044c60: 6d6f 7265 2065 6666 6963 6965 6e74 2074  more efficient t
-00044c70: 6f20 7370 6563 6966 7920 7468 6520 220a  o specify the ".
-00044c80: 2020 2020 2020 2020 2266 696c 6520 6e61          "file na
-00044c90: 6d65 2074 6861 6e20 746f 2070 6970 6520  me than to pipe 
-00044ca0: 7468 6520 6669 6c65 2074 6872 6f75 6768  the file through
-00044cb0: 2073 7464 696e 2e22 2c0a 2020 2020 290a   stdin.",.    ).
-00044cc0: 2020 2020 2320 616c 6c6f 7720 6d75 6c74      # allow mult
-00044cd0: 6970 6c65 2061 7564 696f 2066 696c 6573  iple audio files
-00044ce0: 202c 2065 2e67 2e20 2d69 2022 6131 2e6d   , e.g. -i "a1.m
-00044cf0: 7033 2220 2261 322e 7761 7622 0a20 2020  p3" "a2.wav".   
-00044d00: 2023 206f 7220 2d69 2022 6131 2e6d 7033   # or -i "a1.mp3
-00044d10: 2220 2d69 2022 6132 2e6d 3461 220a 2020  " -i "a2.m4a".  
-00044d20: 2020 2320 6175 6469 6f20 6973 2067 6f69    # audio is goi
-00044d30: 6e67 2074 6f20 6265 2061 206c 6973 7420  ng to be a list 
-00044d40: 6f66 2073 7472 696e 6773 0a20 2020 2023  of strings.    #
-00044d50: 2065 2e67 2e20 6175 6469 6f3d 5b20 2761   e.g. audio=[ 'a
-00044d60: 312e 6d70 3327 2c20 2761 322e 6d34 6127  1.mp3', 'a2.m4a'
-00044d70: 205d 0a20 2020 2061 702e 6164 645f 6172   ].    ap.add_ar
-00044d80: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
-00044d90: 222d 6122 2c0a 2020 2020 2020 2020 222d  "-a",.        "-
-00044da0: 2d61 7564 696f 222c 0a20 2020 2020 2020  -audio",.       
-00044db0: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
-00044dc0: 0a20 2020 2020 2020 2061 6374 696f 6e3d  .        action=
-00044dd0: 2265 7874 656e 6422 2c0a 2020 2020 2020  "extend",.      
-00044de0: 2020 6e61 7267 733d 222b 222c 0a20 2020    nargs="+",.   
-00044df0: 2020 2020 2074 7970 653d 7374 722c 0a20       type=str,. 
-00044e00: 2020 2020 2020 206d 6574 6176 6172 3d22         metavar="
-00044e10: 4155 4449 4f5f 4649 4c45 222c 0a20 2020  AUDIO_FILE",.   
-00044e20: 2020 2020 2068 656c 703d 2253 656e 6420       help="Send 
-00044e30: 6f6e 6520 6f72 206d 756c 7469 706c 6520  one or multiple 
-00044e40: 6175 6469 6f20 6669 6c65 732e 2022 0a20  audio files. ". 
-00044e50: 2020 2020 2020 2022 4465 7461 696c 733a         "Details:
-00044e60: 3a20 5468 6973 206f 7074 696f 6e20 6361  : This option ca
-00044e70: 6e20 6265 2075 7365 6420 6d75 6c74 6970  n be used multip
-00044e80: 6c65 2074 696d 6573 2074 6f20 7365 6e64  le times to send
-00044e90: 2022 0a20 2020 2020 2020 2022 6d75 6c74   ".        "mult
-00044ea0: 6970 6c65 2061 7564 696f 2066 696c 6573  iple audio files
-00044eb0: 2e20 4669 7273 7420 6175 6469 6f73 2061  . First audios a
-00044ec0: 7265 2073 656e 742c 2022 0a20 2020 2020  re sent, ".     
-00044ed0: 2020 2022 7468 656e 2074 6578 7420 6d65     "then text me
-00044ee0: 7373 6167 6573 2061 7265 2073 656e 742e  ssages are sent.
-00044ef0: 2022 0a20 2020 2020 2020 2066 2249 6620   ".        f"If 
-00044f00: 796f 7520 7761 6e74 2074 6f20 6665 6564  you want to feed
-00044f10: 2061 6e20 6175 6469 6f20 696e 746f 207b   an audio into {
-00044f20: 5052 4f47 5f57 4954 484f 5554 5f45 5854  PROG_WITHOUT_EXT
-00044f30: 7d20 220a 2020 2020 2020 2020 2276 6961  } ".        "via
-00044f40: 2061 2070 6970 652c 2076 6961 2073 7464   a pipe, via std
-00044f50: 696e 2c20 7468 656e 2073 7065 6369 6679  in, then specify
-00044f60: 2074 6865 2073 7065 6369 616c 2022 0a20   the special ". 
-00044f70: 2020 2020 2020 2022 6368 6172 6163 7465         "characte
-00044f80: 7220 272d 272e 2053 6565 2064 6573 6372  r '-'. See descr
-00044f90: 6970 7469 6f6e 206f 6620 272d 6927 2074  iption of '-i' t
-00044fa0: 6f20 7365 6520 686f 7720 272d 2720 6973  o see how '-' is
-00044fb0: 2068 616e 646c 6564 2e22 2c0a 2020 2020   handled.",.    
-00044fc0: 290a 2020 2020 2320 616c 6c6f 7720 6d75  ).    # allow mu
-00044fd0: 6c74 6970 6c65 2066 696c 6573 202c 2065  ltiple files , e
-00044fe0: 2e67 2e20 2d66 2022 6131 2e70 6466 2220  .g. -f "a1.pdf" 
-00044ff0: 2261 322e 646f 6322 0a20 2020 2023 206f  "a2.doc".    # o
-00045000: 7220 2d66 2022 6131 2e70 6466 2220 2d66  r -f "a1.pdf" -f
-00045010: 2022 6132 2e64 6f63 220a 2020 2020 2320   "a2.doc".    # 
-00045020: 6669 6c65 2069 7320 676f 696e 6720 746f  file is going to
-00045030: 2062 6520 6120 6c69 7374 206f 6620 7374   be a list of st
-00045040: 7269 6e67 730a 2020 2020 2320 652e 672e  rings.    # e.g.
-00045050: 2066 696c 653d 5b20 2761 312e 7064 6627   file=[ 'a1.pdf'
-00045060: 2c20 2761 322e 646f 6327 205d 0a20 2020  , 'a2.doc' ].   
-00045070: 2061 702e 6164 645f 6172 6775 6d65 6e74   ap.add_argument
-00045080: 280a 2020 2020 2020 2020 222d 6622 2c0a  (.        "-f",.
-00045090: 2020 2020 2020 2020 222d 2d66 696c 6522          "--file"
-000450a0: 2c0a 2020 2020 2020 2020 7265 7175 6972  ,.        requir
-000450b0: 6564 3d46 616c 7365 2c0a 2020 2020 2020  ed=False,.      
-000450c0: 2020 6163 7469 6f6e 3d22 6578 7465 6e64    action="extend
-000450d0: 222c 0a20 2020 2020 2020 206e 6172 6773  ",.        nargs
-000450e0: 3d22 2b22 2c0a 2020 2020 2020 2020 7479  ="+",.        ty
-000450f0: 7065 3d73 7472 2c0a 2020 2020 2020 2020  pe=str,.        
-00045100: 6d65 7461 7661 723d 2246 494c 4522 2c0a  metavar="FILE",.
-00045110: 2020 2020 2020 2020 6865 6c70 3d22 5365          help="Se
-00045120: 6e64 206f 6e65 206f 7220 6d75 6c74 6970  nd one or multip
-00045130: 6c65 2066 696c 6573 2028 652e 672e 2050  le files (e.g. P
-00045140: 4446 2c20 444f 432c 204d 5034 292e 2022  DF, DOC, MP4). "
-00045150: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
-00045160: 733a 3a20 5468 6973 206f 7074 696f 6e20  s:: This option 
-00045170: 6361 6e20 6265 2075 7365 6420 6d75 6c74  can be used mult
-00045180: 6970 6c65 2074 696d 6573 2074 6f20 7365  iple times to se
-00045190: 6e64 2022 0a20 2020 2020 2020 2022 6d75  nd ".        "mu
-000451a0: 6c74 6970 6c65 2066 696c 6573 2e20 4669  ltiple files. Fi
-000451b0: 7273 7420 6669 6c65 7320 6172 6520 7365  rst files are se
-000451c0: 6e74 2c20 220a 2020 2020 2020 2020 2274  nt, ".        "t
-000451d0: 6865 6e20 7465 7874 206d 6573 7361 6765  hen text message
-000451e0: 7320 6172 6520 7365 6e74 2e20 220a 2020  s are sent. ".  
-000451f0: 2020 2020 2020 6622 4966 2079 6f75 2077        f"If you w
-00045200: 616e 7420 746f 2066 6565 6420 6120 6669  ant to feed a fi
-00045210: 6c65 2069 6e74 6f20 7b50 524f 475f 5749  le into {PROG_WI
-00045220: 5448 4f55 545f 4558 547d 2022 0a20 2020  THOUT_EXT} ".   
-00045230: 2020 2020 2022 7669 6120 6120 7069 7065       "via a pipe
-00045240: 2c20 7669 6120 7374 6469 6e2c 2074 6865  , via stdin, the
-00045250: 6e20 7370 6563 6966 7920 7468 6520 7370  n specify the sp
-00045260: 6563 6961 6c20 220a 2020 2020 2020 2020  ecial ".        
-00045270: 2263 6861 7261 6374 6572 2027 2d27 2e20  "character '-'. 
-00045280: 5365 6520 6465 7363 7269 7074 696f 6e20  See description 
-00045290: 6f66 2027 2d69 2720 746f 2073 6565 2068  of '-i' to see h
-000452a0: 6f77 2027 2d27 2069 7320 6861 6e64 6c65  ow '-' is handle
-000452b0: 642e 222c 0a20 2020 2029 0a20 2020 2061  d.",.    ).    a
-000452c0: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
-000452d0: 2020 2020 2020 2020 222d 6522 2c0a 2020          "-e",.  
-000452e0: 2020 2020 2020 222d 2d65 7665 6e74 222c        "--event",
-000452f0: 0a20 2020 2020 2020 2072 6571 7569 7265  .        require
-00045300: 643d 4661 6c73 652c 0a20 2020 2020 2020  d=False,.       
-00045310: 2061 6374 696f 6e3d 2265 7874 656e 6422   action="extend"
-00045320: 2c0a 2020 2020 2020 2020 6e61 7267 733d  ,.        nargs=
-00045330: 222b 222c 0a20 2020 2020 2020 2074 7970  "+",.        typ
-00045340: 653d 7374 722c 0a20 2020 2020 2020 206d  e=str,.        m
-00045350: 6574 6176 6172 3d22 4d41 5452 4958 5f4a  etavar="MATRIX_J
-00045360: 534f 4e5f 4f42 4a45 4354 222c 0a20 2020  SON_OBJECT",.   
-00045370: 2020 2020 2068 656c 703d 2253 656e 6420       help="Send 
-00045380: 6120 4d61 7472 6978 204a 534f 4e20 6576  a Matrix JSON ev
-00045390: 656e 742e 2022 0a20 2020 2020 2020 2022  ent. ".        "
-000453a0: 4465 7461 696c 733a 3a20 5365 6e64 2061  Details:: Send a
-000453b0: 6e20 6576 656e 7420 7468 6174 2069 7320  n event that is 
-000453c0: 666f 726d 6174 7465 6420 6173 2061 204a  formatted as a J
-000453d0: 534f 4e20 6f62 6a65 6374 2061 7320 220a  SON object as ".
-000453e0: 2020 2020 2020 2020 2273 7065 6369 6669          "specifi
-000453f0: 6564 2062 7920 7468 6520 4d61 7472 6978  ed by the Matrix
-00045400: 2070 726f 746f 636f 6c2e 2054 6869 7320   protocol. This 
-00045410: 616c 6c6f 7773 2074 6865 2061 6476 616e  allows the advan
-00045420: 6365 6420 220a 2020 2020 2020 2020 2275  ced ".        "u
-00045430: 7365 7220 746f 2073 656e 6420 6164 6469  ser to send addi
-00045440: 7469 6f6e 616c 2074 7970 6573 206f 6620  tional types of 
-00045450: 6576 656e 7473 2073 7563 6820 6173 2072  events such as r
-00045460: 6561 6374 696f 6e73 2c20 220a 2020 2020  eactions, ".    
-00045470: 2020 2020 2273 656e 6420 7265 706c 6965      "send replie
-00045480: 7320 746f 2070 7265 7669 6f75 7320 6576  s to previous ev
-00045490: 656e 7473 2c20 6f72 2065 6469 7420 7072  ents, or edit pr
-000454a0: 6576 696f 7573 206d 6573 7361 6765 732e  evious messages.
-000454b0: 2022 0a20 2020 2020 2020 2022 5370 6563   ".        "Spec
-000454c0: 6966 6963 6174 696f 6e73 2066 6f72 2065  ifications for e
-000454d0: 7665 6e74 7320 6361 6e20 6265 2066 6f75  vents can be fou
-000454e0: 6e64 2022 0a20 2020 2020 2020 2022 6174  nd ".        "at
-000454f0: 2068 7474 7073 3a2f 2f73 7065 632e 6d61   https://spec.ma
-00045500: 7472 6978 2e6f 7267 2f75 6e73 7461 626c  trix.org/unstabl
-00045510: 652f 7072 6f70 6f73 616c 732f 2e20 220a  e/proposals/. ".
-00045520: 2020 2020 2020 2020 2254 6869 7320 6f70          "This op
-00045530: 7469 6f6e 2063 616e 2062 6520 7573 6564  tion can be used
-00045540: 206d 756c 7469 706c 6520 7469 6d65 7320   multiple times 
-00045550: 746f 2073 656e 6420 220a 2020 2020 2020  to send ".      
-00045560: 2020 226d 756c 7469 706c 6520 6576 656e    "multiple even
-00045570: 7473 2e20 4669 7273 7420 6576 656e 7473  ts. First events
-00045580: 2061 7265 2073 656e 742c 2022 0a20 2020   are sent, ".   
-00045590: 2020 2020 2022 7468 656e 2074 6578 7420       "then text 
-000455a0: 6d65 7373 6167 6573 2061 7265 2073 656e  messages are sen
-000455b0: 742e 2022 0a20 2020 2020 2020 2066 2249  t. ".        f"I
-000455c0: 6620 796f 7520 7761 6e74 2074 6f20 6665  f you want to fe
-000455d0: 6564 2061 6e20 6576 656e 7420 696e 746f  ed an event into
-000455e0: 207b 5052 4f47 5f57 4954 484f 5554 5f45   {PROG_WITHOUT_E
-000455f0: 5854 7d20 220a 2020 2020 2020 2020 2276  XT} ".        "v
-00045600: 6961 2061 2070 6970 652c 2076 6961 2073  ia a pipe, via s
-00045610: 7464 696e 2c20 7468 656e 2073 7065 6369  tdin, then speci
-00045620: 6679 2074 6865 2073 7065 6369 616c 2022  fy the special "
-00045630: 0a20 2020 2020 2020 2022 6368 6172 6163  .        "charac
-00045640: 7465 7220 272d 272e 2053 6565 2064 6573  ter '-'. See des
-00045650: 6372 6970 7469 6f6e 206f 6620 272d 6927  cription of '-i'
-00045660: 2074 6f20 7365 6520 686f 7720 272d 2720   to see how '-' 
-00045670: 6973 2068 616e 646c 6564 2e20 220a 2020  is handled. ".  
-00045680: 2020 2020 2020 2253 6565 2074 6573 7473        "See tests
-00045690: 2f74 6573 742d 6576 656e 742e 7368 2066  /test-event.sh f
-000456a0: 6f72 2065 7861 6d70 6c65 732e 222c 0a20  or examples.",. 
-000456b0: 2020 2029 0a20 2020 2023 202d 6820 616c     ).    # -h al
-000456c0: 7265 6164 7920 7573 6564 2066 6f72 202d  ready used for -
-000456d0: 2d68 656c 702c 202d 7720 666f 7220 2277  -help, -w for "w
-000456e0: 6562 220a 2020 2020 6170 2e61 6464 5f61  eb".    ap.add_a
-000456f0: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
-00045700: 2022 2d77 222c 0a20 2020 2020 2020 2022   "-w",.        "
-00045710: 2d2d 6874 6d6c 222c 0a20 2020 2020 2020  --html",.       
-00045720: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
-00045730: 0a20 2020 2020 2020 2061 6374 696f 6e3d  .        action=
-00045740: 2273 746f 7265 5f74 7275 6522 2c0a 2020  "store_true",.  
-00045750: 2020 2020 2020 6865 6c70 3d27 5365 6e64        help='Send
-00045760: 206d 6573 7361 6765 2061 7320 666f 726d   message as form
-00045770: 6174 2022 4854 4d4c 222e 2027 0a20 2020  at "HTML". '.   
-00045780: 2020 2020 2022 4465 7461 696c 733a 3a20       "Details:: 
-00045790: 4966 206e 6f74 2073 7065 6369 6669 6564  If not specified
-000457a0: 2c20 6d65 7373 6167 6520 7769 6c6c 2062  , message will b
-000457b0: 6520 7365 6e74 2022 0a20 2020 2020 2020  e sent ".       
-000457c0: 2027 6173 2066 6f72 6d61 7420 2254 4558   'as format "TEX
-000457d0: 5422 2e20 452e 672e 2074 6861 7420 616c  T". E.g. that al
-000457e0: 6c6f 7773 2073 6f6d 6520 7465 7874 2027  lows some text '
-000457f0: 0a20 2020 2020 2020 2022 746f 2062 6520  .        "to be 
-00045800: 626f 6c64 2c20 6574 632e 204f 6e6c 7920  bold, etc. Only 
-00045810: 6120 7375 6273 6574 206f 6620 4854 4d4c  a subset of HTML
-00045820: 2074 6167 7320 6172 6520 220a 2020 2020   tags are ".    
-00045830: 2020 2020 2261 6363 6570 7465 6420 6279      "accepted by
-00045840: 204d 6174 7269 782e 222c 0a20 2020 2029   Matrix.",.    )
-00045850: 0a20 2020 2023 202d 6d20 616c 7265 6164  .    # -m alread
-00045860: 7920 7573 6564 2066 6f72 202d 2d6d 6573  y used for --mes
-00045870: 7361 6765 2c20 2d7a 2062 6563 6175 7365  sage, -z because
-00045880: 2074 6865 7265 2077 6572 6520 6e6f 206c   there were no l
-00045890: 6574 7465 7273 206c 6566 740a 2020 2020  etters left.    
-000458a0: 6170 2e61 6464 5f61 7267 756d 656e 7428  ap.add_argument(
-000458b0: 0a20 2020 2020 2020 2022 2d7a 222c 0a20  .        "-z",. 
-000458c0: 2020 2020 2020 2022 2d2d 6d61 726b 646f         "--markdo
-000458d0: 776e 222c 0a20 2020 2020 2020 2072 6571  wn",.        req
-000458e0: 7569 7265 643d 4661 6c73 652c 0a20 2020  uired=False,.   
-000458f0: 2020 2020 2061 6374 696f 6e3d 2273 746f       action="sto
-00045900: 7265 5f74 7275 6522 2c0a 2020 2020 2020  re_true",.      
-00045910: 2020 6865 6c70 3d27 5365 6e64 206d 6573    help='Send mes
-00045920: 7361 6765 2061 7320 666f 726d 6174 2022  sage as format "
-00045930: 4d41 524b 444f 574e 222e 2027 0a20 2020  MARKDOWN". '.   
-00045940: 2020 2020 2022 4465 7461 696c 733a 3a20       "Details:: 
-00045950: 4966 206e 6f74 2073 7065 6369 6669 6564  If not specified
-00045960: 2c20 6d65 7373 6167 6520 7769 6c6c 2062  , message will b
-00045970: 6520 7365 6e74 2022 0a20 2020 2020 2020  e sent ".       
-00045980: 2027 6173 2066 6f72 6d61 7420 2254 4558   'as format "TEX
-00045990: 5422 2e20 452e 672e 2074 6861 7420 616c  T". E.g. that al
-000459a0: 6c6f 7773 2073 656e 6469 6e67 206f 6620  lows sending of 
-000459b0: 7465 7874 2027 0a20 2020 2020 2020 2022  text '.        "
-000459c0: 666f 726d 6174 7465 6420 696e 204d 6172  formatted in Mar
-000459d0: 6b44 6f77 6e20 6c61 6e67 7561 6765 2e22  kDown language."
-000459e0: 2c0a 2020 2020 290a 2020 2020 2320 202d  ,.    ).    #  -
-000459f0: 6320 6973 2061 6c72 6561 6479 2075 7365  c is already use
-00045a00: 6420 666f 7220 2d2d 6372 6564 656e 7469  d for --credenti
-00045a10: 616c 732c 202d 6b20 6173 2069 7420 736f  als, -k as it so
-00045a20: 756e 6473 206c 696b 6520 630a 2020 2020  unds like c.    
-00045a30: 6170 2e61 6464 5f61 7267 756d 656e 7428  ap.add_argument(
-00045a40: 0a20 2020 2020 2020 2022 2d6b 222c 0a20  .        "-k",. 
-00045a50: 2020 2020 2020 2022 2d2d 636f 6465 222c         "--code",
-00045a60: 0a20 2020 2020 2020 2072 6571 7569 7265  .        require
-00045a70: 643d 4661 6c73 652c 0a20 2020 2020 2020  d=False,.       
-00045a80: 2061 6374 696f 6e3d 2273 746f 7265 5f74   action="store_t
-00045a90: 7275 6522 2c0a 2020 2020 2020 2020 6865  rue",.        he
-00045aa0: 6c70 3d27 5365 6e64 206d 6573 7361 6765  lp='Send message
-00045ab0: 2061 7320 666f 726d 6174 2022 434f 4445   as format "CODE
-00045ac0: 222e 2027 0a20 2020 2020 2020 2022 4465  ". '.        "De
-00045ad0: 7461 696c 733a 3a20 4966 206e 6f74 2073  tails:: If not s
-00045ae0: 7065 6369 6669 6564 2c20 6d65 7373 6167  pecified, messag
-00045af0: 6520 7769 6c6c 2062 6520 7365 6e74 2022  e will be sent "
-00045b00: 0a20 2020 2020 2020 2027 6173 2066 6f72  .        'as for
-00045b10: 6d61 7420 2254 4558 5422 2e20 4966 2062  mat "TEXT". If b
-00045b20: 6f74 6820 2d2d 6874 6d6c 2061 6e64 202d  oth --html and -
-00045b30: 2d63 6f64 6520 6172 6520 270a 2020 2020  -code are '.    
-00045b40: 2020 2020 2273 7065 6369 6669 6564 2074      "specified t
-00045b50: 6865 6e20 2d2d 636f 6465 2074 616b 6573  hen --code takes
-00045b60: 2070 7269 6f72 6974 792e 2054 6869 7320   priority. This 
-00045b70: 6973 2022 0a20 2020 2020 2020 2022 7573  is ".        "us
-00045b80: 6566 756c 2066 6f72 2073 656e 6469 6e67  eful for sending
-00045b90: 2041 5343 4949 2d61 7274 206f 7220 7461   ASCII-art or ta
-00045ba0: 6262 6564 206f 7574 7075 7420 220a 2020  bbed output ".  
-00045bb0: 2020 2020 2020 226c 696b 6520 7461 626c        "like tabl
-00045bc0: 6573 2061 7320 6120 6669 7865 642d 7369  es as a fixed-si
-00045bd0: 7a65 6420 666f 6e74 2077 696c 6c20 6265  zed font will be
-00045be0: 2075 7365 6420 220a 2020 2020 2020 2020   used ".        
-00045bf0: 2266 6f72 2064 6973 706c 6179 2e22 2c0a  "for display.",.
-00045c00: 2020 2020 290a 2020 2020 2320 2d73 2069      ).    # -s i
-00045c10: 7320 616c 7265 6164 7920 7573 6564 2066  s already used f
-00045c20: 6f72 202d 2d73 746f 7265 2c20 2d69 2066  or --store, -i f
-00045c30: 6f72 2073 506c 6974 0a20 2020 2061 702e  or sPlit.    ap.
-00045c40: 6164 645f 6172 6775 6d65 6e74 280a 2020  add_argument(.  
-00045c50: 2020 2020 2020 222d 7022 2c0a 2020 2020        "-p",.    
-00045c60: 2020 2020 222d 2d73 706c 6974 222c 0a20      "--split",. 
-00045c70: 2020 2020 2020 2072 6571 7569 7265 643d         required=
-00045c80: 4661 6c73 652c 0a20 2020 2020 2020 2074  False,.        t
-00045c90: 7970 653d 7374 722c 0a20 2020 2020 2020  ype=str,.       
-00045ca0: 206d 6574 6176 6172 3d22 5345 5041 5241   metavar="SEPARA
-00045cb0: 544f 5222 2c0a 2020 2020 2020 2020 6865  TOR",.        he
-00045cc0: 6c70 3d22 5370 6c69 7420 6d65 7373 6167  lp="Split messag
-00045cd0: 6520 7465 7874 2069 6e74 6f20 6d75 6c74  e text into mult
-00045ce0: 6970 6c65 204d 6174 7269 7820 6d65 7373  iple Matrix mess
-00045cf0: 6167 6573 2e20 220a 2020 2020 2020 2020  ages. ".        
-00045d00: 2244 6574 6169 6c73 3a3a 2049 6620 7365  "Details:: If se
-00045d10: 742c 2073 706c 6974 2074 6865 206d 6573  t, split the mes
-00045d20: 7361 6765 2873 2920 696e 746f 206d 756c  sage(s) into mul
-00045d30: 7469 706c 6520 6d65 7373 6167 6573 2022  tiple messages "
-00045d40: 0a20 2020 2020 2020 2022 7768 6572 6576  .        "wherev
-00045d50: 6572 2074 6865 2073 7472 696e 6720 7370  er the string sp
-00045d60: 6563 6966 6965 6420 7769 7468 202d 2d73  ecified with --s
-00045d70: 706c 6974 206f 6363 7572 732e 2022 0a20  plit occurs. ". 
-00045d80: 2020 2020 2020 2022 452e 672e 204f 6e65         "E.g. One
-00045d90: 2070 6970 6573 2061 2073 7472 6561 6d20   pipes a stream 
-00045da0: 6f66 2052 5353 2061 7274 6963 6c65 7320  of RSS articles 
-00045db0: 696e 746f 2074 6865 2022 0a20 2020 2020  into the ".     
-00045dc0: 2020 2022 7072 6f67 7261 6d20 616e 6420     "program and 
-00045dd0: 7468 6520 6172 7469 636c 6573 2061 7265  the articles are
-00045de0: 2073 6570 6172 6174 6564 2062 7920 7468   separated by th
-00045df0: 7265 6520 220a 2020 2020 2020 2020 226e  ree ".        "n
-00045e00: 6577 6c69 6e65 732e 2022 0a20 2020 2020  ewlines. ".     
-00045e10: 2020 2027 5468 656e 2077 6974 6820 2d2d     'Then with --
-00045e20: 7370 6c69 7420 7365 7420 746f 2022 5c5c  split set to "\\
-00045e30: 6e5c 5c6e 5c5c 6e22 2065 6163 6820 6172  n\\n\\n" each ar
-00045e40: 7469 636c 6520 270a 2020 2020 2020 2020  ticle '.        
-00045e50: 2277 696c 6c20 6265 2070 7269 6e74 6564  "will be printed
-00045e60: 2069 6e20 6120 7365 7061 7261 7465 206d   in a separate m
-00045e70: 6573 7361 6765 2e20 220a 2020 2020 2020  essage. ".      
-00045e80: 2020 2242 7920 6465 6661 756c 742c 2069    "By default, i
-00045e90: 2e65 2e20 6966 206e 6f74 2073 6574 2c20  .e. if not set, 
-00045ea0: 6e6f 206d 6573 7361 6765 7320 7769 6c6c  no messages will
-00045eb0: 2062 6520 7370 6c69 742e 222c 0a20 2020   be split.",.   
-00045ec0: 2029 0a20 2020 2023 202d 6320 6973 2061   ).    # -c is a
-00045ed0: 6c72 6561 6479 2075 7365 6420 666f 7220  lready used for 
-00045ee0: 2d2d 6372 6564 656e 7469 616c 730a 2020  --credentials.  
-00045ef0: 2020 6170 2e61 6464 5f61 7267 756d 656e    ap.add_argumen
-00045f00: 7428 0a20 2020 2020 2020 2022 2d2d 636f  t(.        "--co
-00045f10: 6e66 6967 222c 0a20 2020 2020 2020 2072  nfig",.        r
-00045f20: 6571 7569 7265 643d 4661 6c73 652c 0a20  equired=False,. 
-00045f30: 2020 2020 2020 2074 7970 653d 7374 722c         type=str,
-00045f40: 0a20 2020 2020 2020 206d 6574 6176 6172  .        metavar
-00045f50: 3d22 434f 4e46 4947 5f46 494c 4522 2c0a  ="CONFIG_FILE",.
-00045f60: 2020 2020 2020 2020 6865 6c70 3d22 5370          help="Sp
-00045f70: 6563 6966 7920 7468 6520 6c6f 6361 7469  ecify the locati
-00045f80: 6f6e 206f 6620 6120 636f 6e66 6967 2066  on of a config f
-00045f90: 696c 652e 2022 0a20 2020 2020 2020 2022  ile. ".        "
-00045fa0: 4465 7461 696c 733a 3a20 4279 2064 6566  Details:: By def
-00045fb0: 6175 6c74 2c20 6e6f 2022 0a20 2020 2020  ault, no ".     
-00045fc0: 2020 2022 636f 6e66 6967 2066 696c 6520     "config file 
-00045fd0: 6973 2075 7365 642e 2022 0a20 2020 2020  is used. ".     
-00045fe0: 2020 2022 4966 2074 6869 7320 6f70 7469     "If this opti
-00045ff0: 6f6e 2069 7320 7072 6f76 6964 6564 2c20  on is provided, 
-00046000: 7468 6520 7072 6f76 6964 6564 2066 696c  the provided fil
-00046010: 6520 6e61 6d65 2022 0a20 2020 2020 2020  e name ".       
-00046020: 2022 7769 6c6c 2062 6520 7573 6564 2074   "will be used t
-00046030: 6f20 7265 6164 2063 6f6e 6669 6775 7261  o read configura
-00046040: 7469 6f6e 2066 726f 6d2e 204e 6f74 2069  tion from. Not i
-00046050: 6d70 6c65 6d65 6e74 6564 2e22 2c0a 2020  mplemented.",.  
-00046060: 2020 290a 2020 2020 2320 2d70 2069 7320    ).    # -p is 
-00046070: 616c 7265 6164 7920 7573 6564 2066 6f72  already used for
-00046080: 202d 2d73 706c 6974 0a20 2020 2061 702e   --split.    ap.
-00046090: 6164 645f 6172 6775 6d65 6e74 280a 2020  add_argument(.  
-000460a0: 2020 2020 2020 222d 2d70 726f 7879 222c        "--proxy",
-000460b0: 0a20 2020 2020 2020 2072 6571 7569 7265  .        require
-000460c0: 643d 4661 6c73 652c 0a20 2020 2020 2020  d=False,.       
-000460d0: 2074 7970 653d 7374 722c 0a20 2020 2020   type=str,.     
-000460e0: 2020 206d 6574 6176 6172 3d22 5052 4f58     metavar="PROX
-000460f0: 5922 2c0a 2020 2020 2020 2020 6865 6c70  Y",.        help
-00046100: 3d22 5370 6563 6966 7920 6120 7072 6f78  ="Specify a prox
-00046110: 7920 666f 7220 636f 6e6e 6563 7469 7669  y for connectivi
-00046120: 7479 2e20 220a 2020 2020 2020 2020 2244  ty. ".        "D
-00046130: 6574 6169 6c73 3a3a 2042 7920 6465 6661  etails:: By defa
-00046140: 756c 742c 2022 0a20 2020 2020 2020 2022  ult, ".        "
-00046150: 692e 652e 2069 6620 7468 6973 206f 7074  i.e. if this opt
-00046160: 696f 6e20 6973 206e 6f74 2073 6574 2c20  ion is not set, 
-00046170: 6e6f 2070 726f 7879 2069 7320 7573 6564  no proxy is used
-00046180: 2e20 220a 2020 2020 2020 2020 2249 6620  . ".        "If 
-00046190: 7468 6973 206f 7074 696f 6e20 6973 2075  this option is u
-000461a0: 7365 6420 6120 7072 6f78 7920 5552 4c20  sed a proxy URL 
-000461b0: 6d75 7374 2062 6520 7072 6f76 6964 6564  must be provided
-000461c0: 2e20 220a 2020 2020 2020 2020 2254 6865  . ".        "The
-000461d0: 2070 726f 7669 6465 6420 7072 6f78 7920   provided proxy 
-000461e0: 5552 4c20 220a 2020 2020 2020 2020 2277  URL ".        "w
-000461f0: 696c 6c20 6265 2075 7365 6420 666f 7220  ill be used for 
-00046200: 7468 6520 4854 5450 2063 6f6e 6e65 6374  the HTTP connect
-00046210: 696f 6e20 746f 2074 6865 2073 6572 7665  ion to the serve
-00046220: 722e 2022 0a20 2020 2020 2020 2022 5468  r. ".        "Th
-00046230: 6520 7072 6f78 7920 7375 7070 6f72 7473  e proxy supports
-00046240: 2053 4f43 4b53 3428 6129 2c20 534f 434b   SOCKS4(a), SOCK
-00046250: 5335 2c20 616e 6420 4854 5450 2028 7475  S5, and HTTP (tu
-00046260: 6e6e 656c 696e 6729 2e20 220a 2020 2020  nneling). ".    
-00046270: 2020 2020 2745 7861 6d70 6c65 7320 6f66      'Examples of
-00046280: 2076 616c 6964 2055 524c 7320 6172 6520   valid URLs are 
-00046290: 2268 7474 703a 2f2f 3130 2e31 302e 3130  "http://10.10.10
-000462a0: 2e31 303a 3831 3138 2220 270a 2020 2020  .10:8118" '.    
-000462b0: 2020 2020 276f 7220 2273 6f63 6b73 353a      'or "socks5:
-000462c0: 2f2f 7573 6572 3a70 6173 7377 6f72 6440  //user:password@
-000462d0: 3132 372e 302e 302e 313a 3130 3830 222e  127.0.0.1:1080".
-000462e0: 2027 0a20 2020 2020 2020 2027 5552 4c73   '.        'URLs
-000462f0: 2077 6974 6820 2268 7474 7073 2220 6f72   with "https" or
-00046300: 2022 736f 636b 7334 6122 2061 7265 206e   "socks4a" are n
-00046310: 6f74 2076 616c 6964 2e20 4f6e 6c79 2027  ot valid. Only '
-00046320: 0a20 2020 2020 2020 2027 2268 7474 7022  .        '"http"
-00046330: 2c20 2273 6f63 6b73 3422 2061 6e64 2022  , "socks4" and "
-00046340: 736f 636b 7335 2220 6172 6520 7661 6c69  socks5" are vali
-00046350: 642e 272c 0a20 2020 2029 0a20 2020 2061  d.',.    ).    a
-00046360: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
-00046370: 2020 2020 2020 2020 222d 6e22 2c0a 2020          "-n",.  
-00046380: 2020 2020 2020 222d 2d6e 6f74 6963 6522        "--notice"
-00046390: 2c0a 2020 2020 2020 2020 7265 7175 6972  ,.        requir
-000463a0: 6564 3d46 616c 7365 2c0a 2020 2020 2020  ed=False,.      
-000463b0: 2020 6163 7469 6f6e 3d22 7374 6f72 655f    action="store_
-000463c0: 7472 7565 222c 0a20 2020 2020 2020 2068  true",.        h
-000463d0: 656c 703d 2253 656e 6420 6d65 7373 6167  elp="Send messag
-000463e0: 6520 6173 206e 6f74 6963 652e 2022 0a20  e as notice. ". 
-000463f0: 2020 2020 2020 2022 4465 7461 696c 733a         "Details:
-00046400: 3a20 4966 206e 6f74 2073 7065 6369 6669  : If not specifi
-00046410: 6564 2c20 6d65 7373 6167 6520 7769 6c6c  ed, message will
-00046420: 2062 6520 7365 6e74 2061 7320 7465 7874   be sent as text
-00046430: 2e22 2c0a 2020 2020 290a 2020 2020 6170  .",.    ).    ap
-00046440: 2e61 6464 5f61 7267 756d 656e 7428 0a20  .add_argument(. 
-00046450: 2020 2020 2020 2023 206e 6f20 7369 6e67         # no sing
-00046460: 6c65 2063 6861 7220 666c 6167 0a20 2020  le char flag.   
-00046470: 2020 2020 2022 2d2d 656e 6372 7970 7465       "--encrypte
-00046480: 6422 2c0a 2020 2020 2020 2020 7265 7175  d",.        requ
-00046490: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
-000464a0: 2020 2020 6163 7469 6f6e 3d22 7374 6f72      action="stor
-000464b0: 655f 7472 7565 222c 0a20 2020 2020 2020  e_true",.       
-000464c0: 2068 656c 703d 2253 656e 6420 6d65 7373   help="Send mess
-000464d0: 6167 6520 656e 642d 746f 2d65 6e64 2065  age end-to-end e
-000464e0: 6e63 7279 7074 6564 2e20 220a 2020 2020  ncrypted. ".    
-000464f0: 2020 2020 2244 6574 6169 6c73 3a3a 2045      "Details:: E
-00046500: 6e63 7279 7074 696f 6e20 6973 2061 6c77  ncryption is alw
-00046510: 6179 7320 7475 726e 6564 206f 6e20 616e  ays turned on an
-00046520: 6420 220a 2020 2020 2020 2020 2277 696c  d ".        "wil
-00046530: 6c20 616c 7761 7973 2062 6520 7573 6564  l always be used
-00046540: 2077 6865 7265 2070 6f73 7369 626c 652e   where possible.
-00046550: 2022 0a20 2020 2020 2020 2022 4974 2063   ".        "It c
-00046560: 616e 6e6f 7420 6265 2074 7572 6e65 6420  annot be turned 
-00046570: 6f66 662e 2054 6869 7320 666c 6167 2064  off. This flag d
-00046580: 6f65 7320 6e6f 7468 696e 6720 220a 2020  oes nothing ".  
-00046590: 2020 2020 2020 2261 7320 656e 6372 7970        "as encryp
-000465a0: 7469 6f6e 2069 7320 7475 726e 6564 206f  tion is turned o
-000465b0: 6e20 7769 7468 206f 7220 7769 7468 6f75  n with or withou
-000465c0: 7420 7468 6973 2022 0a20 2020 2020 2020  t this ".       
-000465d0: 2022 6172 6775 6d65 6e74 2e20 5468 6973   "argument. This
-000465e0: 2066 6c61 6720 6578 6973 7473 206f 6e6c   flag exists onl
-000465f0: 7920 666f 7220 6869 7374 6f72 6963 2072  y for historic r
-00046600: 6561 736f 6e73 2e20 220a 2020 2020 2020  easons. ".      
-00046610: 2020 2249 6e20 736f 6d65 2073 7065 6369    "In some speci
-00046620: 6669 6320 6361 7365 2065 6e63 7279 7074  fic case encrypt
-00046630: 696f 6e20 220a 2020 2020 2020 2020 2263  ion ".        "c
-00046640: 616e 2062 6520 6469 7361 626c 6564 2c20  an be disabled, 
-00046650: 706c 6561 7365 2073 6565 202d 2d70 6c61  please see --pla
-00046660: 696e 2e22 2c0a 2020 2020 290a 2020 2020  in.",.    ).    
-00046670: 6170 2e61 6464 5f61 7267 756d 656e 7428  ap.add_argument(
-00046680: 0a20 2020 2020 2020 2022 2d6c 222c 0a20  .        "-l",. 
-00046690: 2020 2020 2020 2022 2d2d 6c69 7374 656e         "--listen
-000466a0: 222c 0a20 2020 2020 2020 2072 6571 7569  ",.        requi
-000466b0: 7265 643d 4661 6c73 652c 0a20 2020 2020  red=False,.     
-000466c0: 2020 2074 7970 653d 7374 722c 0a20 2020     type=str,.   
-000466d0: 2020 2020 2064 6566 6175 6c74 3d4c 4953       default=LIS
-000466e0: 5445 4e5f 4445 4641 554c 542c 2020 2320  TEN_DEFAULT,  # 
-000466f0: 7768 656e 202d 6c20 6973 206e 6f74 2075  when -l is not u
-00046700: 7365 640a 2020 2020 2020 2020 6e61 7267  sed.        narg
-00046710: 733d 223f 222c 2020 2320 6d61 6b65 7320  s="?",  # makes 
-00046720: 7468 6520 776f 7264 206f 7074 696f 6e61  the word optiona
-00046730: 6c0a 2020 2020 2020 2020 636f 6e73 743d  l.        const=
-00046740: 464f 5245 5645 522c 2020 2320 7768 656e  FOREVER,  # when
-00046750: 202d 6c20 6973 2075 7365 642c 2062 7574   -l is used, but
-00046760: 2046 4f52 4556 4552 2069 7320 6e6f 7420   FOREVER is not 
-00046770: 6164 6465 640a 2020 2020 2020 2020 6d65  added.        me
-00046780: 7461 7661 723d 224e 4556 4552 7c4f 4e43  tavar="NEVER|ONC
-00046790: 457c 464f 5245 5645 527c 5441 494c 7c41  E|FOREVER|TAIL|A
-000467a0: 4c4c 222c 0a20 2020 2020 2020 2068 656c  LL",.        hel
-000467b0: 703d 2250 7269 6e74 2072 6563 6569 7665  p="Print receive
-000467c0: 6420 6d65 7373 6167 6573 2061 6e64 206c  d messages and l
-000467d0: 6973 7465 6e20 746f 206d 6573 7361 6765  isten to message
-000467e0: 732e 2022 0a20 2020 2020 2020 2022 4465  s. ".        "De
-000467f0: 7461 696c 733a 3a20 5468 6520 2d2d 6c69  tails:: The --li
-00046800: 7374 656e 206f 7074 696f 6e20 7461 6b65  sten option take
-00046810: 7320 6f6e 6520 6172 6775 6d65 6e74 2e20  s one argument. 
-00046820: 5468 6572 6520 220a 2020 2020 2020 2020  There ".        
-00046830: 6627 6172 6520 7365 7665 7261 6c20 6368  f'are several ch
-00046840: 6f69 6365 733a 2022 7b4e 4556 4552 7d22  oices: "{NEVER}"
-00046850: 2c20 227b 4f4e 4345 7d22 2c20 270a 2020  , "{ONCE}", '.  
-00046860: 2020 2020 2020 6627 227b 464f 5245 5645        f'"{FOREVE
-00046870: 527d 222c 2022 7b54 4149 4c7d 222c 2061  R}", "{TAIL}", a
-00046880: 6e64 2022 7b41 4c4c 7d22 2e20 270a 2020  nd "{ALL}". '.  
-00046890: 2020 2020 2020 6627 4279 2064 6566 6175        f'By defau
-000468a0: 6c74 2c20 2d2d 6c69 7374 656e 2069 7320  lt, --listen is 
-000468b0: 7365 7420 746f 2022 7b4e 4556 4552 7d22  set to "{NEVER}"
-000468c0: 2e20 2053 6f2c 2062 7920 270a 2020 2020  .  So, by '.    
-000468d0: 2020 2020 2264 6566 6175 6c74 206e 6f20      "default no 
-000468e0: 6c69 7374 656e 696e 6720 7769 6c6c 2062  listening will b
-000468f0: 6520 646f 6e65 2e20 5365 7420 6974 2074  e done. Set it t
-00046900: 6f20 220a 2020 2020 2020 2020 6627 227b  o ".        f'"{
-00046910: 464f 5245 5645 527d 2220 746f 206c 6973  FOREVER}" to lis
-00046920: 7465 6e20 666f 7220 616e 6420 7072 696e  ten for and prin
-00046930: 7420 696e 636f 6d69 6e67 206d 6573 7361  t incoming messa
-00046940: 6765 7320 270a 2020 2020 2020 2020 2274  ges '.        "t
-00046950: 6f20 7374 646f 7574 2e20 220a 2020 2020  o stdout. ".    
-00046960: 2020 2020 6627 222d 2d6c 6973 7465 6e20      f'"--listen 
-00046970: 7b46 4f52 4556 4552 7d22 2077 696c 6c20  {FOREVER}" will 
-00046980: 6c69 7374 656e 2074 6f20 616c 6c20 6d65  listen to all me
-00046990: 7373 6167 6573 206f 6e20 270a 2020 2020  ssages on '.    
-000469a0: 2020 2020 2261 6c6c 2072 6f6f 6d73 2066      "all rooms f
-000469b0: 6f72 6576 6572 2e20 220a 2020 2020 2020  orever. ".      
-000469c0: 2020 6627 546f 2073 746f 7020 6c69 7374    f'To stop list
-000469d0: 656e 696e 6720 227b 464f 5245 5645 527d  ening "{FOREVER}
-000469e0: 222c 2075 7365 2043 6f6e 7472 6f6c 2d43  ", use Control-C
-000469f0: 206f 6e20 270a 2020 2020 2020 2020 2274   on '.        "t
-00046a00: 6865 206b 6579 626f 6172 6420 6f72 2073  he keyboard or s
-00046a10: 656e 6420 6120 7369 676e 616c 2074 6f20  end a signal to 
-00046a20: 7468 6520 7072 6f63 6573 7320 6f72 2073  the process or s
-00046a30: 6572 7669 6365 2e20 220a 2020 2020 2020  ervice. ".      
-00046a40: 2020 2254 6865 2050 4944 2066 6f72 2073    "The PID for s
-00046a50: 6967 6e61 6c69 6e67 2063 616e 2062 6520  ignaling can be 
-00046a60: 666f 756e 6420 696e 2061 2050 4944 2066  found in a PID f
-00046a70: 696c 6520 696e 2022 0a20 2020 2020 2020  ile in ".       
-00046a80: 2066 2764 6972 6563 746f 7279 2022 7b50   f'directory "{P
-00046a90: 4944 5f44 4952 5f44 4546 4155 4c54 7d22  ID_DIR_DEFAULT}"
-00046aa0: 2e20 270a 2020 2020 2020 2020 6627 222d  . '.        f'"-
-00046ab0: 2d6c 6973 7465 6e20 7b4f 4e43 457d 2220  -listen {ONCE}" 
-00046ac0: 7769 6c6c 2067 6574 2061 6c6c 2074 6865  will get all the
-00046ad0: 206d 6573 7361 6765 7320 6672 6f6d 2027   messages from '
-00046ae0: 0a20 2020 2020 2020 2022 616c 6c20 726f  .        "all ro
-00046af0: 6f6d 7320 7468 6174 2061 7265 2063 7572  oms that are cur
-00046b00: 7265 6e74 6c79 2071 7565 7565 6420 7570  rently queued up
-00046b10: 2e20 536f 2c20 7769 7468 2022 0a20 2020  . So, with ".   
-00046b20: 2020 2020 2066 2722 7b4f 4e43 457d 2220       f'"{ONCE}" 
-00046b30: 7468 6520 7072 6f67 7261 6d20 7769 6c6c  the program will
-00046b40: 2073 7461 7274 2c20 7072 696e 7420 7761   start, print wa
-00046b50: 6974 696e 6720 270a 2020 2020 2020 2020  iting '.        
-00046b60: 226d 6573 7361 6765 7320 2869 6620 616e  "messages (if an
-00046b70: 7929 2061 6e64 2074 6865 6e20 7374 6f70  y) and then stop
-00046b80: 2e20 5468 6520 7469 6d65 6f75 7420 666f  . The timeout fo
-00046b90: 7220 220a 2020 2020 2020 2020 6627 227b  r ".        f'"{
-00046ba0: 4f4e 4345 7d22 2069 7320 7365 7420 746f  ONCE}" is set to
-00046bb0: 2031 3020 7365 636f 6e64 732e 2053 6f2c   10 seconds. So,
-00046bc0: 2062 6520 7061 7469 656e 742c 2069 7420   be patient, it 
-00046bd0: 270a 2020 2020 2020 2020 226d 6967 6874  '.        "might
-00046be0: 2074 616b 6520 7570 2074 6f20 7468 6174   take up to that
-00046bf0: 2061 6d6f 756e 7420 6f66 2074 696d 652e   amount of time.
-00046c00: 2022 0a20 2020 2020 2020 2066 2722 7b54   ".        f'"{T
-00046c10: 4149 4c7d 2220 7265 6164 7320 616e 6420  AIL}" reads and 
-00046c20: 7072 696e 7473 2074 6865 206c 6173 7420  prints the last 
-00046c30: 4e20 270a 2020 2020 2020 2020 226d 6573  N '.        "mes
-00046c40: 7361 6765 7320 6672 6f6d 2074 6865 2073  sages from the s
-00046c50: 7065 6369 6669 6564 2072 6f6f 6d73 2c20  pecified rooms, 
-00046c60: 7468 656e 2071 7569 7473 2e20 5468 6520  then quits. The 
-00046c70: 220a 2020 2020 2020 2020 226e 756d 6265  ".        "numbe
-00046c80: 7220 4e20 6361 6e20 6265 2073 6574 2077  r N can be set w
-00046c90: 6974 6820 7468 6520 2d2d 7461 696c 206f  ith the --tail o
-00046ca0: 7074 696f 6e2e 2057 6974 6820 220a 2020  ption. With ".  
-00046cb0: 2020 2020 2020 6627 227b 5441 494c 7d22        f'"{TAIL}"
-00046cc0: 2073 6f6d 6520 6d65 7373 6167 6573 2072   some messages r
-00046cd0: 6561 6420 6d69 6768 7420 6265 206f 6c64  ead might be old
-00046ce0: 2c20 270a 2020 2020 2020 2020 2269 2e65  , '.        "i.e
-00046cf0: 2e20 616c 7265 6164 7920 7265 6164 2062  . already read b
-00046d00: 6566 6f72 652c 2073 6f6d 6520 6d69 6768  efore, some migh
-00046d10: 7420 6265 206e 6577 2c20 220a 2020 2020  t be new, ".    
-00046d20: 2020 2020 2269 2e65 2e20 6e65 7665 7220      "i.e. never 
-00046d30: 7265 6164 2062 6566 6f72 652e 2049 7420  read before. It 
-00046d40: 7072 696e 7473 2074 6865 206d 6573 7361  prints the messa
-00046d50: 6765 7320 616e 6420 7468 656e 2022 0a20  ges and then ". 
-00046d60: 2020 2020 2020 2066 2274 6865 2070 726f         f"the pro
-00046d70: 6772 616d 2073 746f 7073 2e20 220a 2020  gram stops. ".  
-00046d80: 2020 2020 2020 224d 6573 7361 6765 7320        "Messages 
-00046d90: 6172 6520 736f 7274 6564 2c20 6c61 7374  are sorted, last
-00046da0: 2d66 6972 7374 2e20 220a 2020 2020 2020  -first. ".      
-00046db0: 2020 224c 6f6f 6b20 6174 202d 2d74 6169    "Look at --tai
-00046dc0: 6c20 6173 2074 6861 7420 6f70 7469 6f6e  l as that option
-00046dd0: 2069 7320 7265 6c61 7465 6420 220a 2020   is related ".  
-00046de0: 2020 2020 2020 2274 6f20 2d2d 6c69 7374        "to --list
-00046df0: 656e 2074 6169 6c2e 2022 0a20 2020 2020  en tail. ".     
-00046e00: 2020 2066 2754 6865 206f 7074 696f 6e20     f'The option 
-00046e10: 227b 414c 4c7d 2220 6765 7473 2061 6c6c  "{ALL}" gets all
-00046e20: 206d 6573 7361 6765 7320 6176 6169 6c61   messages availa
-00046e30: 626c 652c 2027 0a20 2020 2020 2020 2022  ble, '.        "
-00046e40: 6f6c 6420 616e 6420 6e65 772e 2022 0a20  old and new. ". 
-00046e50: 2020 2020 2020 2066 2755 6e6c 696b 6520         f'Unlike 
-00046e60: 227b 4f4e 4345 7d22 2061 6e64 2027 0a20  "{ONCE}" and '. 
-00046e70: 2020 2020 2020 2066 2722 7b46 4f52 4556         f'"{FOREV
-00046e80: 4552 7d22 2074 6861 7420 6c69 7374 656e  ER}" that listen
-00046e90: 2069 6e20 414c 4c20 726f 6f6d 732c 2022   in ALL rooms, "
-00046ea0: 7b54 4149 4c7d 2220 270a 2020 2020 2020  {TAIL}" '.      
-00046eb0: 2020 6627 616e 6420 227b 414c 4c7d 2220    f'and "{ALL}" 
-00046ec0: 6c69 7374 656e 2027 0a20 2020 2020 2020  listen '.       
-00046ed0: 2022 6f6e 6c79 2074 6f20 7468 6520 726f   "only to the ro
-00046ee0: 6f6d 2073 7065 6369 6669 6564 2069 6e20  om specified in 
-00046ef0: 7468 6520 6372 6564 656e 7469 616c 7320  the credentials 
-00046f00: 220a 2020 2020 2020 2020 2266 696c 6520  ".        "file 
-00046f10: 6f72 2074 6865 202d 2d72 6f6f 6d20 6f70  or the --room op
-00046f20: 7469 6f6e 732e 2022 2c0a 2020 2020 290a  tions. ",.    ).
-00046f30: 2020 2020 6170 2e61 6464 5f61 7267 756d      ap.add_argum
-00046f40: 656e 7428 0a20 2020 2020 2020 2022 2d74  ent(.        "-t
-00046f50: 222c 0a20 2020 2020 2020 2022 2d2d 7461  ",.        "--ta
-00046f60: 696c 222c 0a20 2020 2020 2020 2072 6571  il",.        req
-00046f70: 7569 7265 643d 4661 6c73 652c 0a20 2020  uired=False,.   
-00046f80: 2020 2020 2074 7970 653d 696e 742c 0a20       type=int,. 
-00046f90: 2020 2020 2020 2064 6566 6175 6c74 3d54         default=T
-00046fa0: 4149 4c5f 554e 5553 4544 5f44 4546 4155  AIL_UNUSED_DEFAU
-00046fb0: 4c54 2c20 2023 2077 6865 6e20 2d74 2069  LT,  # when -t i
-00046fc0: 7320 6e6f 7420 7573 6564 0a20 2020 2020  s not used.     
-00046fd0: 2020 206e 6172 6773 3d22 3f22 2c20 2023     nargs="?",  #
-00046fe0: 206d 616b 6573 2074 6865 2077 6f72 6420   makes the word 
-00046ff0: 6f70 7469 6f6e 616c 0a20 2020 2020 2020  optional.       
-00047000: 2023 2077 6865 6e20 2d74 2069 7320 7573   # when -t is us
-00047010: 6564 2c20 6275 7420 6e75 6d62 6572 2069  ed, but number i
-00047020: 7320 6e6f 7420 6164 6465 640a 2020 2020  s not added.    
-00047030: 2020 2020 636f 6e73 743d 5441 494c 5f55      const=TAIL_U
-00047040: 5345 445f 4445 4641 554c 542c 0a20 2020  SED_DEFAULT,.   
-00047050: 2020 2020 206d 6574 6176 6172 3d22 4e55       metavar="NU
-00047060: 4d42 4552 222c 0a20 2020 2020 2020 2068  MBER",.        h
-00047070: 656c 703d 2250 7269 6e74 206c 6173 7420  elp="Print last 
-00047080: 6d65 7373 6167 6573 2e20 220a 2020 2020  messages. ".    
-00047090: 2020 2020 2244 6574 6169 6c73 3a3a 2054      "Details:: T
-000470a0: 6865 202d 2d74 6169 6c20 6f70 7469 6f6e  he --tail option
-000470b0: 2072 6561 6473 2061 6e64 2070 7269 6e74   reads and print
-000470c0: 7320 7570 2074 6f20 7468 6520 6c61 7374  s up to the last
-000470d0: 204e 2022 0a20 2020 2020 2020 2022 6d65   N ".        "me
-000470e0: 7373 6167 6573 2066 726f 6d20 7468 6520  ssages from the 
-000470f0: 7370 6563 6966 6965 6420 726f 6f6d 732c  specified rooms,
-00047100: 2074 6865 6e20 7175 6974 732e 2022 0a20   then quits. ". 
-00047110: 2020 2020 2020 2022 4974 2074 616b 6573         "It takes
-00047120: 206f 6e65 2022 0a20 2020 2020 2020 2022   one ".        "
-00047130: 6172 6775 6d65 6e74 2c20 616e 2069 6e74  argument, an int
-00047140: 6567 6572 2c20 220a 2020 2020 2020 2020  eger, ".        
-00047150: 2277 6869 6368 2077 6520 6361 6c6c 204e  "which we call N
-00047160: 2068 6572 652e 2049 6620 7468 6572 6520   here. If there 
-00047170: 6172 6520 6665 7765 7220 7468 616e 204e  are fewer than N
-00047180: 206d 6573 7361 6765 7320 220a 2020 2020   messages ".    
-00047190: 2020 2020 2269 6e20 6120 726f 6f6d 2c20      "in a room, 
-000471a0: 6974 2072 6561 6473 2061 6e64 2070 7269  it reads and pri
-000471b0: 6e74 7320 7570 2074 6f20 4e20 6d65 7373  nts up to N mess
-000471c0: 6167 6573 2e20 220a 2020 2020 2020 2020  ages. ".        
-000471d0: 2249 7420 6765 7473 2074 6865 206c 6173  "It gets the las
-000471e0: 7420 4e20 6d65 7373 6167 6573 2069 6e20  t N messages in 
-000471f0: 7265 7665 7273 6520 6f72 6465 722e 2022  reverse order. "
-00047200: 0a20 2020 2020 2020 2022 4974 2070 7269  .        "It pri
-00047210: 6e74 2074 6865 206e 6577 6573 7420 6d65  nt the newest me
-00047220: 7373 6167 6520 6669 7273 742c 2061 6e64  ssage first, and
-00047230: 2074 6865 2022 0a20 2020 2020 2020 2022   the ".        "
-00047240: 6f6c 6465 7374 206d 6573 7361 6765 206c  oldest message l
-00047250: 6173 742e 2022 0a20 2020 2020 2020 2022  ast. ".        "
-00047260: 4966 202d 2d6c 6973 7465 6e2d 7365 6c66  If --listen-self
-00047270: 2069 7320 6e6f 7420 7365 7420 6974 2077   is not set it w
-00047280: 696c 6c20 7072 696e 7420 6c65 7373 2074  ill print less t
-00047290: 6861 6e20 220a 2020 2020 2020 2020 224e  han ".        "N
-000472a0: 206d 6573 7361 6765 7320 696e 206d 616e   messages in man
-000472b0: 7920 6361 7365 7320 6265 6361 7573 6520  y cases because 
-000472c0: 4e20 6d65 7373 6167 6573 2061 7265 2022  N messages are "
-000472d0: 0a20 2020 2020 2020 2022 6f62 7461 696e  .        "obtain
-000472e0: 6564 2c20 6275 7420 736f 6d65 206f 6620  ed, but some of 
-000472f0: 7468 656d 2061 7265 2064 6973 6361 7264  them are discard
-00047300: 6564 2062 7920 6465 6661 756c 7420 6966  ed by default if
-00047310: 2022 0a20 2020 2020 2020 2022 7468 6579   ".        "they
-00047320: 2061 7265 2066 726f 6d20 7468 6520 7573   are from the us
-00047330: 6572 2069 7473 656c 662e 2022 0a20 2020  er itself. ".   
-00047340: 2020 2020 2022 4c6f 6f6b 2061 7420 2d2d       "Look at --
-00047350: 6c69 7374 656e 2061 7320 7468 6973 206f  listen as this o
-00047360: 7074 696f 6e20 6973 2072 656c 6174 6564  ption is related
-00047370: 2074 6f20 2d2d 7461 696c 2e22 2c0a 2020   to --tail.",.  
-00047380: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
-00047390: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
-000473a0: 2022 2d79 222c 0a20 2020 2020 2020 2022   "-y",.        "
-000473b0: 2d2d 6c69 7374 656e 2d73 656c 6622 2c0a  --listen-self",.
-000473c0: 2020 2020 2020 2020 7265 7175 6972 6564          required
-000473d0: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-000473e0: 6163 7469 6f6e 3d22 7374 6f72 655f 7472  action="store_tr
-000473f0: 7565 222c 0a20 2020 2020 2020 2068 656c  ue",.        hel
-00047400: 703d 2250 7269 6e74 2079 6f75 7220 6f77  p="Print your ow
-00047410: 6e20 6d65 7373 6167 6573 2061 7320 7765  n messages as we
-00047420: 6c6c 2e20 220a 2020 2020 2020 2020 2244  ll. ".        "D
-00047430: 6574 6169 6c73 3a3a 2049 6620 7365 7420  etails:: If set 
-00047440: 616e 6420 6c69 7374 656e 696e 672c 2022  and listening, "
-00047450: 0a20 2020 2020 2020 2022 7468 656e 2070  .        "then p
-00047460: 726f 6772 616d 2077 696c 6c20 6c69 7374  rogram will list
-00047470: 656e 2074 6f20 616e 6420 7072 696e 7420  en to and print 
-00047480: 616c 736f 2022 0a20 2020 2020 2020 2022  also ".        "
-00047490: 7468 6520 6d65 7373 6167 6573 2073 656e  the messages sen
-000474a0: 7420 6279 2069 7473 206f 776e 2075 7365  t by its own use
-000474b0: 722e 2022 0a20 2020 2020 2020 2022 4279  r. ".        "By
-000474c0: 2064 6566 6175 6c74 206d 6573 7361 6765   default message
-000474d0: 7320 6672 6f6d 206f 6e65 7365 6c66 2061  s from oneself a
-000474e0: 7265 206e 6f74 2070 7269 6e74 6564 2e22  re not printed."
-000474f0: 2c0a 2020 2020 290a 2020 2020 6170 2e61  ,.    ).    ap.a
-00047500: 6464 5f61 7267 756d 656e 7428 0a20 2020  dd_argument(.   
-00047510: 2020 2020 2023 206e 6f20 7369 6e67 6c65       # no single
-00047520: 2063 6861 7220 666c 6167 0a20 2020 2020   char flag.     
-00047530: 2020 2022 2d2d 7072 696e 742d 6576 656e     "--print-even
-00047540: 742d 6964 222c 0a20 2020 2020 2020 2072  t-id",.        r
-00047550: 6571 7569 7265 643d 4661 6c73 652c 0a20  equired=False,. 
-00047560: 2020 2020 2020 2061 6374 696f 6e3d 2273         action="s
-00047570: 746f 7265 5f74 7275 6522 2c0a 2020 2020  tore_true",.    
-00047580: 2020 2020 6865 6c70 3d22 5072 696e 7420      help="Print 
-00047590: 6576 656e 7420 6964 7320 6f66 2072 6563  event ids of rec
-000475a0: 6569 7665 6420 6d65 7373 6167 6573 2e20  eived messages. 
-000475b0: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
-000475c0: 6c73 3a3a 2049 6620 7365 7420 616e 6420  ls:: If set and 
-000475d0: 6c69 7374 656e 696e 672c 2022 0a20 2020  listening, ".   
-000475e0: 2020 2020 2066 2274 6865 6e20 277b 5052       f"then '{PR
-000475f0: 4f47 5f57 4954 484f 5554 5f45 5854 7d27  OG_WITHOUT_EXT}'
-00047600: 2077 696c 6c20 7072 696e 7420 616c 736f   will print also
-00047610: 2074 6865 2065 7665 6e74 2069 6420 666f   the event id fo
-00047620: 7220 220a 2020 2020 2020 2020 2265 6163  r ".        "eac
-00047630: 6820 7265 6365 6976 6564 206d 6573 7361  h received messa
-00047640: 6765 206f 7220 6f74 6865 7220 7265 6365  ge or other rece
-00047650: 6976 6564 2065 7665 6e74 2e20 4966 2073  ived event. If s
-00047660: 6574 2061 6e64 2022 0a20 2020 2020 2020  et and ".       
-00047670: 2066 2273 656e 6469 6e67 2c20 7468 656e   f"sending, then
-00047680: 2027 7b50 524f 475f 5749 5448 4f55 545f   '{PROG_WITHOUT_
-00047690: 4558 547d 2720 7769 6c6c 2070 7269 6e74  EXT}' will print
-000476a0: 2074 6865 2065 7665 6e74 2069 6420 220a   the event id ".
-000476b0: 2020 2020 2020 2020 226f 6620 7468 6520          "of the 
-000476c0: 7365 6e74 206d 6573 7361 6765 206f 7220  sent message or 
-000476d0: 7468 6520 7365 6e74 206f 626a 6563 7420  the sent object 
-000476e0: 2861 7564 696f 2c20 6669 6c65 2c20 6576  (audio, file, ev
-000476f0: 656e 7429 2074 6f20 220a 2020 2020 2020  ent) to ".      
-00047700: 2020 2273 7464 6f75 742e 204f 7468 6572    "stdout. Other
-00047710: 2069 6e66 6f72 6d61 7469 6f6e 206c 696b   information lik
-00047720: 6520 726f 6f6d 2069 6420 616e 6420 7265  e room id and re
-00047730: 6665 7265 6e63 6520 746f 2077 6861 7420  ference to what 
-00047740: 7761 7320 220a 2020 2020 2020 2020 2273  was ".        "s
-00047750: 656e 7420 7769 6c6c 2062 6520 7072 696e  ent will be prin
-00047760: 7465 6420 746f 6f2e 2046 6f72 2073 656e  ted too. For sen
-00047770: 6469 6e67 2074 6869 7320 6973 2075 7365  ding this is use
-00047780: 6675 6c2c 2022 0a20 2020 2020 2020 2022  ful, ".        "
-00047790: 6966 2061 6674 6572 2073 656e 6469 6e67  if after sending
-000477a0: 2074 6865 2075 7365 7220 220a 2020 2020   the user ".    
-000477b0: 2020 2020 2277 6973 6865 7320 746f 2070      "wishes to p
-000477c0: 6572 666f 726d 2066 7572 7468 6572 206f  erform further o
-000477d0: 7065 7261 7469 6f6e 7320 6f6e 2074 6865  perations on the
-000477e0: 2073 656e 7420 6f62 6a65 6374 2c20 220a   sent object, ".
-000477f0: 2020 2020 2020 2020 2265 2e67 2e20 7265          "e.g. re
-00047800: 6461 6374 696e 672f 6465 6c65 7469 6e67  dacting/deleting
-00047810: 2069 7420 6166 7465 7220 616e 2065 7870   it after an exp
-00047820: 6972 6174 696f 6e20 7469 6d65 2c20 6574  iration time, et
-00047830: 632e 222c 0a20 2020 2029 0a20 2020 2061  c.",.    ).    a
-00047840: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
-00047850: 2020 2020 2020 2020 2320 7374 6172 7469          # starti
-00047860: 6e67 2077 6974 6820 7665 7273 696f 6e20  ng with version 
-00047870: 322e 3139 2022 2d75 2220 6861 7320 6265  2.19 "-u" has be
-00047880: 656e 206d 6f76 6564 2074 6f20 2d2d 7573  en moved to --us
-00047890: 6572 210a 2020 2020 2020 2020 222d 2d64  er!.        "--d
-000478a0: 6f77 6e6c 6f61 642d 6d65 6469 6122 2c0a  ownload-media",.
-000478b0: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
-000478c0: 2c0a 2020 2020 2020 2020 6465 6661 756c  ,.        defaul
-000478d0: 743d 2222 2c20 2023 2069 6620 2d2d 646f  t="",  # if --do
-000478e0: 776e 6c6f 6164 2d6d 6564 6961 2069 7320  wnload-media is 
-000478f0: 6e6f 7420 7573 6564 0a20 2020 2020 2020  not used.       
-00047900: 2061 6374 696f 6e3d 2273 746f 7265 222c   action="store",
-00047910: 0a20 2020 2020 2020 206e 6172 6773 3d22  .        nargs="
-00047920: 3f22 2c20 2023 206d 616b 6573 2074 6865  ?",  # makes the
-00047930: 2077 6f72 6420 6f70 7469 6f6e 616c 0a20   word optional. 
-00047940: 2020 2020 2020 2063 6f6e 7374 3d4d 4544         const=MED
-00047950: 4941 5f44 4952 5f44 4546 4155 4c54 2c20  IA_DIR_DEFAULT, 
-00047960: 2023 2077 6865 6e20 6f70 7469 6f6e 2069   # when option i
-00047970: 7320 7573 6564 2c20 6275 7420 6e6f 2064  s used, but no d
-00047980: 6972 2061 6464 6564 0a20 2020 2020 2020  ir added.       
-00047990: 206d 6574 6176 6172 3d22 444f 574e 4c4f   metavar="DOWNLO
-000479a0: 4144 5f44 4952 4543 544f 5259 222c 0a20  AD_DIRECTORY",. 
-000479b0: 2020 2020 2020 2068 656c 703d 2244 6f77         help="Dow
-000479c0: 6e6c 6f61 6420 6d65 6469 6120 6669 6c65  nload media file
-000479d0: 7320 7768 696c 6520 6c69 7374 656e 696e  s while listenin
-000479e0: 672e 2022 0a20 2020 2020 2020 2022 4465  g. ".        "De
-000479f0: 7461 696c 733a 3a20 4966 2073 6574 2061  tails:: If set a
-00047a00: 6e64 206c 6973 7465 6e69 6e67 2c20 220a  nd listening, ".
-00047a10: 2020 2020 2020 2020 2274 6865 6e20 7072          "then pr
-00047a20: 6f67 7261 6d20 7769 6c6c 2064 6f77 6e6c  ogram will downl
-00047a30: 6f61 6420 220a 2020 2020 2020 2020 2272  oad ".        "r
-00047a40: 6563 6569 7665 6420 6d65 6469 6120 6669  eceived media fi
-00047a50: 6c65 7320 2865 2e67 2e20 696d 6167 652c  les (e.g. image,
-00047a60: 2061 7564 696f 2c20 7669 6465 6f2c 2074   audio, video, t
-00047a70: 6578 742c 2050 4446 2066 696c 6573 292e  ext, PDF files).
-00047a80: 2022 0a20 2020 2020 2020 2022 6d65 6469   ".        "medi
-00047a90: 6120 7769 6c6c 2062 6520 646f 776e 6c6f  a will be downlo
-00047aa0: 6164 6564 2074 6f20 6c6f 6361 6c20 6469  aded to local di
-00047ab0: 7265 6374 6f72 792e 2022 0a20 2020 2020  rectory. ".     
-00047ac0: 2020 2022 4279 2064 6566 6175 6c74 2c20     "By default, 
-00047ad0: 6d65 6469 6120 7769 6c6c 2062 6520 646f  media will be do
-00047ae0: 776e 6c6f 6164 6564 2074 6f20 220a 2020  wnloaded to ".  
-00047af0: 2020 2020 2020 6627 6973 2022 7b4d 4544        f'is "{MED
-00047b00: 4941 5f44 4952 5f44 4546 4155 4c54 7d22  IA_DIR_DEFAULT}"
-00047b10: 2e20 270a 2020 2020 2020 2020 2259 6f75  . '.        "You
-00047b20: 2063 616e 206f 7665 7277 7269 7465 2064   can overwrite d
-00047b30: 6566 6175 6c74 2077 6974 6820 796f 7572  efault with your
-00047b40: 2070 7265 6665 7272 6564 2064 6972 6563   preferred direc
-00047b50: 746f 7279 2e20 220a 2020 2020 2020 2020  tory. ".        
-00047b60: 2249 6620 6d65 6469 6120 6973 2065 6e63  "If media is enc
-00047b70: 7279 7074 6564 2069 7420 7769 6c6c 2062  rypted it will b
-00047b80: 6520 6465 6372 7970 7465 6420 616e 6420  e decrypted and 
-00047b90: 7374 6f72 6564 2064 6563 7279 7074 6564  stored decrypted
-00047ba0: 2e20 220a 2020 2020 2020 2020 2242 7920  . ".        "By 
-00047bb0: 6465 6661 756c 7420 6d65 6469 6120 6669  default media fi
-00047bc0: 6c65 7320 7769 6c6c 206e 6f74 2062 6520  les will not be 
-00047bd0: 646f 776e 6c6f 6164 6564 2e22 2c0a 2020  downloaded.",.  
-00047be0: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
-00047bf0: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
-00047c00: 2023 2022 2d6f 222c 2023 2069 6e63 6f6d   # "-o", # incom
-00047c10: 7061 7469 626c 6520 6368 616e 6765 2044  patible change D
-00047c20: 6563 2032 3032 322c 202d 6f20 6d6f 7665  ec 2022, -o move
-00047c30: 6420 746f 202d 2d6f 7574 7075 740a 2020  d to --output.  
-00047c40: 2020 2020 2020 222d 2d6f 732d 6e6f 7469        "--os-noti
-00047c50: 6679 222c 0a20 2020 2020 2020 2072 6571  fy",.        req
-00047c60: 7569 7265 643d 4661 6c73 652c 0a20 2020  uired=False,.   
-00047c70: 2020 2020 2061 6374 696f 6e3d 2273 746f       action="sto
-00047c80: 7265 5f74 7275 6522 2c0a 2020 2020 2020  re_true",.      
-00047c90: 2020 6865 6c70 3d22 4e6f 7469 6679 206d    help="Notify m
-00047ca0: 6520 6f66 2061 7272 6976 696e 6720 6d65  e of arriving me
-00047cb0: 7373 6167 6573 2e20 220a 2020 2020 2020  ssages. ".      
-00047cc0: 2020 2244 6574 6169 6c73 3a3a 2049 6620    "Details:: If 
-00047cd0: 7365 7420 616e 6420 6c69 7374 656e 696e  set and listenin
-00047ce0: 672c 2022 0a20 2020 2020 2020 2022 7468  g, ".        "th
-00047cf0: 656e 2070 726f 6772 616d 2077 696c 6c20  en program will 
-00047d00: 6174 7465 6d70 7420 746f 2076 6973 7561  attempt to visua
-00047d10: 6c6c 7920 6e6f 7469 6679 206f 6620 220a  lly notify of ".
-00047d20: 2020 2020 2020 2020 2261 7272 6976 696e          "arrivin
-00047d30: 6720 6d65 7373 6167 6573 2074 6872 6f75  g messages throu
-00047d40: 6768 2074 6865 206f 7065 7261 7469 6e67  gh the operating
-00047d50: 2073 7973 7465 6d2e 2022 0a20 2020 2020   system. ".     
-00047d60: 2020 2022 4279 2064 6566 6175 6c74 2074     "By default t
-00047d70: 6865 7265 2069 7320 6e6f 206e 6f74 6966  here is no notif
-00047d80: 6963 6174 696f 6e20 7669 6120 4f53 2e22  ication via OS."
-00047d90: 2c0a 2020 2020 290a 2020 2020 6170 2e61  ,.    ).    ap.a
-00047da0: 6464 5f61 7267 756d 656e 7428 0a20 2020  dd_argument(.   
-00047db0: 2020 2020 2023 2072 656d 6f76 6564 2022       # removed "
-00047dc0: 2d78 222c 2073 7461 7274 696e 6720 7632  -x", starting v2
-00047dd0: 2e32 3120 2d78 2069 7320 6e6f 206c 6f6e  .21 -x is no lon
-00047de0: 6765 7220 7375 7070 6f72 7465 640a 2020  ger supported.  
-00047df0: 2020 2020 2020 222d 2d73 6574 2d64 6576        "--set-dev
-00047e00: 6963 652d 6e61 6d65 222c 0a20 2020 2020  ice-name",.     
-00047e10: 2020 2072 6571 7569 7265 643d 4661 6c73     required=Fals
-00047e20: 652c 0a20 2020 2020 2020 2074 7970 653d  e,.        type=
-00047e30: 7374 722c 0a20 2020 2020 2020 2064 6566  str,.        def
-00047e40: 6175 6c74 3d53 4554 5f44 4556 4943 455f  ault=SET_DEVICE_
-00047e50: 4e41 4d45 5f55 4e55 5345 445f 4445 4641  NAME_UNUSED_DEFA
-00047e60: 554c 542c 2020 2320 7768 656e 206f 7074  ULT,  # when opt
-00047e70: 696f 6e20 6973 6e27 7420 7573 6564 0a20  ion isn't used. 
-00047e80: 2020 2020 2020 206d 6574 6176 6172 3d22         metavar="
-00047e90: 4445 5649 4345 5f4e 414d 4522 2c0a 2020  DEVICE_NAME",.  
-00047ea0: 2020 2020 2020 6865 6c70 3d22 5365 7420        help="Set 
-00047eb0: 6f72 2072 656e 616d 6520 7468 6520 6375  or rename the cu
-00047ec0: 7272 656e 7420 6465 7669 6365 2e20 220a  rrent device. ".
-00047ed0: 2020 2020 2020 2020 2244 6574 6169 6c73          "Details
-00047ee0: 3a3a 2053 6574 206f 7220 7265 6e61 6d65  :: Set or rename
-00047ef0: 2074 6865 2063 7572 7265 6e74 2064 6576   the current dev
-00047f00: 6963 6520 746f 2074 6865 2022 0a20 2020  ice to the ".   
-00047f10: 2020 2020 2022 6465 7669 6365 206e 616d       "device nam
-00047f20: 6520 7072 6f76 6964 6564 2e20 220a 2020  e provided. ".  
-00047f30: 2020 2020 2020 2253 656e 642c 206c 6973        "Send, lis
-00047f40: 7465 6e20 616e 6420 7665 7269 6679 206f  ten and verify o
-00047f50: 7065 7261 7469 6f6e 7320 6172 6520 616c  perations are al
-00047f60: 6c6f 7765 6420 7768 656e 2022 0a20 2020  lowed when ".   
-00047f70: 2020 2020 2022 7265 6e61 6d69 6e67 2074       "renaming t
-00047f80: 6865 2064 6576 6963 652e 222c 0a20 2020  he device.",.   
-00047f90: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
-00047fa0: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
-00047fb0: 222d 2d73 6574 2d64 6973 706c 6179 2d6e  "--set-display-n
-00047fc0: 616d 6522 2c0a 2020 2020 2020 2020 7265  ame",.        re
-00047fd0: 7175 6972 6564 3d46 616c 7365 2c0a 2020  quired=False,.  
-00047fe0: 2020 2020 2020 7479 7065 3d73 7472 2c0a        type=str,.
-00047ff0: 2020 2020 2020 2020 6465 6661 756c 743d          default=
-00048000: 5345 545f 4449 5350 4c41 595f 4e41 4d45  SET_DISPLAY_NAME
-00048010: 5f55 4e55 5345 445f 4445 4641 554c 542c  _UNUSED_DEFAULT,
-00048020: 2020 2320 7768 656e 206f 7074 696f 6e20    # when option 
-00048030: 6973 6e27 7420 7573 6564 0a20 2020 2020  isn't used.     
-00048040: 2020 206d 6574 6176 6172 3d22 4449 5350     metavar="DISP
-00048050: 4c41 595f 4e41 4d45 222c 0a20 2020 2020  LAY_NAME",.     
-00048060: 2020 2068 656c 703d 2253 6574 206f 7220     help="Set or 
-00048070: 7265 6e61 6d65 2074 6865 2064 6973 706c  rename the displ
-00048080: 6179 206e 616d 652e 2022 0a20 2020 2020  ay name. ".     
-00048090: 2020 2022 4465 7461 696c 733a 3a20 5365     "Details:: Se
-000480a0: 7420 6f72 2072 656e 616d 6520 7468 6520  t or rename the 
-000480b0: 6469 7370 6c61 7920 6e61 6d65 2022 0a20  display name ". 
-000480c0: 2020 2020 2020 2022 666f 7220 7468 6520         "for the 
-000480d0: 6375 7272 656e 7420 7573 6572 2074 6f20  current user to 
-000480e0: 7468 6520 220a 2020 2020 2020 2020 2264  the ".        "d
-000480f0: 6973 706c 6179 206e 616d 6520 7072 6f76  isplay name prov
-00048100: 6964 6564 2e20 220a 2020 2020 2020 2020  ided. ".        
-00048110: 2253 656e 642c 206c 6973 7465 6e20 616e  "Send, listen an
-00048120: 6420 7665 7269 6679 206f 7065 7261 7469  d verify operati
-00048130: 6f6e 7320 6172 6520 616c 6c6f 7765 6420  ons are allowed 
-00048140: 7768 656e 2022 0a20 2020 2020 2020 2022  when ".        "
-00048150: 7365 7474 696e 6720 7468 6520 6469 7370  setting the disp
-00048160: 6c61 7920 6e61 6d65 2e20 220a 2020 2020  lay name. ".    
-00048170: 2020 2020 2244 6f20 6e6f 7420 636f 6e66      "Do not conf
-00048180: 7573 6520 7468 6973 206f 7074 696f 6e20  use this option 
-00048190: 7769 7468 2074 6865 206f 7074 696f 6e20  with the option 
-000481a0: 272d 2d67 6574 2d72 6f6f 6d2d 696e 666f  '--get-room-info
-000481b0: 2720 220a 2020 2020 2020 2020 2277 6869  ' ".        "whi
-000481c0: 6368 2067 6574 7320 7468 6520 726f 6f6d  ch gets the room
-000481d0: 2064 6973 706c 6179 206e 616d 652c 206e   display name, n
-000481e0: 6f74 2074 6865 2075 7365 7220 6469 7370  ot the user disp
-000481f0: 6c61 7920 6e61 6d65 2e22 2c0a 2020 2020  lay name.",.    
-00048200: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
-00048210: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
-00048220: 2d2d 6765 742d 6469 7370 6c61 792d 6e61  --get-display-na
-00048230: 6d65 222c 0a20 2020 2020 2020 2072 6571  me",.        req
-00048240: 7569 7265 643d 4661 6c73 652c 0a20 2020  uired=False,.   
-00048250: 2020 2020 2061 6374 696f 6e3d 2273 746f       action="sto
-00048260: 7265 5f74 7275 6522 2c0a 2020 2020 2020  re_true",.      
-00048270: 2020 6865 6c70 3d22 4765 7420 7468 6520    help="Get the 
-00048280: 6469 7370 6c61 7920 6e61 6d65 206f 6620  display name of 
-00048290: 796f 7572 7365 6c66 2e20 220a 2020 2020  yourself. ".    
-000482a0: 2020 2020 2244 6574 6169 6c73 3a3a 2047      "Details:: G
-000482b0: 6574 2074 6865 2064 6973 706c 6179 206e  et the display n
-000482c0: 616d 6520 6f66 2022 0a20 2020 2020 2020  ame of ".       
-000482d0: 2066 227b 5052 4f47 5f57 4954 484f 5554   f"{PROG_WITHOUT
-000482e0: 5f45 5854 7d20 2869 7473 656c 6629 2c20  _EXT} (itself), 
-000482f0: 220a 2020 2020 2020 2020 226f 7220 6f66  ".        "or of
-00048300: 206f 6e65 206f 7220 6d75 6c74 6970 6c65   one or multiple
-00048310: 2075 7365 7273 2e20 5370 6563 6966 7920   users. Specify 
-00048320: 7573 6572 2873 2920 7769 7468 2074 6865  user(s) with the
-00048330: 2022 0a20 2020 2020 2020 2022 2d2d 7573   ".        "--us
-00048340: 6572 206f 7074 696f 6e2e 2049 6620 6e6f  er option. If no
-00048350: 2075 7365 7220 6973 2073 7065 6369 6669   user is specifi
-00048360: 6564 2067 6574 2074 6865 2064 6973 706c  ed get the displ
-00048370: 6179 206e 616d 6520 6f66 2022 0a20 2020  ay name of ".   
-00048380: 2020 2020 2022 6974 7365 6c66 2e20 220a       "itself. ".
-00048390: 2020 2020 2020 2020 2253 656e 642c 206c          "Send, l
-000483a0: 6973 7465 6e20 616e 6420 7665 7269 6679  isten and verify
-000483b0: 206f 7065 7261 7469 6f6e 7320 6172 6520   operations are 
-000483c0: 616c 6c6f 7765 6420 7768 656e 2022 0a20  allowed when ". 
-000483d0: 2020 2020 2020 2022 6765 7474 696e 6720         "getting 
-000483e0: 6469 7370 6c61 7920 6e61 6d65 2873 292e  display name(s).
-000483f0: 2022 0a20 2020 2020 2020 2022 446f 206e   ".        "Do n
-00048400: 6f74 2063 6f6e 6675 7365 2074 6869 7320  ot confuse this 
-00048410: 6f70 7469 6f6e 2077 6974 6820 7468 6520  option with the 
-00048420: 6f70 7469 6f6e 2027 2d2d 6765 742d 726f  option '--get-ro
-00048430: 6f6d 2d69 6e66 6f27 2022 0a20 2020 2020  om-info' ".     
-00048440: 2020 2022 7768 6963 6820 6765 7473 2074     "which gets t
-00048450: 6865 2072 6f6f 6d20 6469 7370 6c61 7920  he room display 
-00048460: 6e61 6d65 2c20 6e6f 7420 7468 6520 7573  name, not the us
-00048470: 6572 2064 6973 706c 6179 206e 616d 652e  er display name.
-00048480: 222c 0a20 2020 2029 0a20 2020 2061 702e  ",.    ).    ap.
-00048490: 6164 645f 6172 6775 6d65 6e74 280a 2020  add_argument(.  
-000484a0: 2020 2020 2020 222d 2d73 6574 2d70 7265        "--set-pre
-000484b0: 7365 6e63 6522 2c0a 2020 2020 2020 2020  sence",.        
-000484c0: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
-000484d0: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
-000484e0: 2c0a 2020 2020 2020 2020 2320 6465 6661  ,.        # defa
-000484f0: 756c 7473 2074 6f20 4e6f 6e65 2069 6620  ults to None if 
-00048500: 6e6f 7420 7573 6564 2c20 6973 2073 7472  not used, is str
-00048510: 2069 6620 7573 6564 0a20 2020 2020 2020   if used.       
-00048520: 206d 6574 6176 6172 3d22 4f4e 4c49 4e45   metavar="ONLINE
-00048530: 7c4f 4646 4c49 4e45 7c55 4e41 5641 494c  |OFFLINE|UNAVAIL
-00048540: 4142 4c45 222c 0a20 2020 2020 2020 2068  ABLE",.        h
-00048550: 656c 703d 2253 6574 2079 6f75 7220 7072  elp="Set your pr
-00048560: 6573 656e 6365 2e20 220a 2020 2020 2020  esence. ".      
-00048570: 2020 6622 4465 7461 696c 733a 3a20 5365    f"Details:: Se
-00048580: 7420 7072 6573 656e 6365 206f 6620 7b50  t presence of {P
-00048590: 524f 475f 5749 5448 4f55 545f 4558 547d  ROG_WITHOUT_EXT}
-000485a0: 2074 6f20 7468 6520 6769 7665 6e20 7661   to the given va
-000485b0: 6c75 652e 2022 0a20 2020 2020 2020 2022  lue. ".        "
-000485c0: 4d75 7374 2062 6520 6f6e 6520 6f66 2074  Must be one of t
-000485d0: 6865 7365 2076 616c 7565 733a 20e2 809c  hese values: ...
-000485e0: 6f6e 6c69 6e65 e280 9d2c 20e2 809c 6f66  online..., ...of
-000485f0: 666c 696e 65e2 809d 2c20 e280 9c75 6e61  fline..., ...una
-00048600: 7661 696c 6162 6c65 e280 9d2e 2022 0a20  vailable.... ". 
-00048610: 2020 2020 2020 2022 4f74 6865 7277 6973         "Otherwis
-00048620: 6520 616e 2065 7272 6f72 2077 696c 6c20  e an error will 
-00048630: 6265 2070 726f 6475 6365 642e 222c 0a20  be produced.",. 
-00048640: 2020 2029 0a20 2020 2061 702e 6164 645f     ).    ap.add_
-00048650: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
-00048660: 2020 222d 2d67 6574 2d70 7265 7365 6e63    "--get-presenc
-00048670: 6522 2c0a 2020 2020 2020 2020 7265 7175  e",.        requ
-00048680: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
-00048690: 2020 2020 6163 7469 6f6e 3d22 7374 6f72      action="stor
-000486a0: 655f 7472 7565 222c 0a20 2020 2020 2020  e_true",.       
-000486b0: 2023 2064 6566 6175 6c74 7320 746f 2046   # defaults to F
-000486c0: 616c 7365 2069 6620 6e6f 7420 7573 6564  alse if not used
-000486d0: 0a20 2020 2020 2020 2068 656c 703d 2247  .        help="G
-000486e0: 6574 2079 6f75 7220 7072 6573 656e 6365  et your presence
-000486f0: 2e20 220a 2020 2020 2020 2020 6622 4465  . ".        f"De
-00048700: 7461 696c 733a 3a20 4765 7420 7072 6573  tails:: Get pres
-00048710: 656e 6365 206f 6620 7b50 524f 475f 5749  ence of {PROG_WI
-00048720: 5448 4f55 545f 4558 547d 2028 6974 7365  THOUT_EXT} (itse
-00048730: 6c66 292c 2022 0a20 2020 2020 2020 2022  lf), ".        "
-00048740: 6f72 206f 6620 6f6e 6520 6f72 206d 756c  or of one or mul
-00048750: 7469 706c 6520 7573 6572 732e 2053 7065  tiple users. Spe
-00048760: 6369 6679 2075 7365 7228 7329 2077 6974  cify user(s) wit
-00048770: 6820 7468 6520 220a 2020 2020 2020 2020  h the ".        
-00048780: 222d 2d75 7365 7220 6f70 7469 6f6e 2e20  "--user option. 
-00048790: 4966 206e 6f20 7573 6572 2069 7320 7370  If no user is sp
-000487a0: 6563 6966 6965 6420 6765 7420 7468 6520  ecified get the 
-000487b0: 7072 6573 656e 6365 206f 6620 220a 2020  presence of ".  
-000487c0: 2020 2020 2020 2269 7473 656c 662e 2022        "itself. "
-000487d0: 0a20 2020 2020 2020 2022 5365 6e64 2c20  .        "Send, 
-000487e0: 6c69 7374 656e 2061 6e64 2076 6572 6966  listen and verif
-000487f0: 7920 6f70 6572 6174 696f 6e73 2061 7265  y operations are
-00048800: 2061 6c6c 6f77 6564 2077 6865 6e20 220a   allowed when ".
-00048810: 2020 2020 2020 2020 2267 6574 7469 6e67          "getting
-00048820: 2070 7265 7365 6e63 6528 7329 2e22 2c0a   presence(s).",.
-00048830: 2020 2020 290a 2020 2020 6170 2e61 6464      ).    ap.add
-00048840: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
-00048850: 2020 2022 2d2d 7570 6c6f 6164 222c 0a20     "--upload",. 
-00048860: 2020 2020 2020 2072 6571 7569 7265 643d         required=
-00048870: 4661 6c73 652c 0a20 2020 2020 2020 2061  False,.        a
-00048880: 6374 696f 6e3d 2265 7874 656e 6422 2c0a  ction="extend",.
-00048890: 2020 2020 2020 2020 6e61 7267 733d 222b          nargs="+
-000488a0: 222c 0a20 2020 2020 2020 2074 7970 653d  ",.        type=
-000488b0: 7374 722c 0a20 2020 2020 2020 206d 6574  str,.        met
-000488c0: 6176 6172 3d22 4649 4c45 222c 0a20 2020  avar="FILE",.   
-000488d0: 2020 2020 2068 656c 703d 2255 706c 6f61       help="Uploa
-000488e0: 6420 6f6e 6520 6f72 206d 756c 7469 706c  d one or multipl
-000488f0: 6520 6669 6c65 7320 746f 2074 6865 2063  e files to the c
-00048900: 6f6e 7465 6e74 2072 6570 6f73 6974 6f72  ontent repositor
-00048910: 792e 2022 0a20 2020 2020 2020 2022 4465  y. ".        "De
-00048920: 7461 696c 733a 3a20 220a 2020 2020 2020  tails:: ".      
-00048930: 2020 2254 6865 2066 696c 6573 2077 696c    "The files wil
-00048940: 6c20 6265 2067 6976 656e 2061 204d 6174  l be given a Mat
-00048950: 7269 7820 5552 4920 616e 6420 220a 2020  rix URI and ".  
-00048960: 2020 2020 2020 2273 746f 7265 6420 6f6e        "stored on
-00048970: 2074 6865 2073 6572 7665 722e 202d 2d75   the server. --u
-00048980: 706c 6f61 6420 616c 6c6f 7773 2074 6865  pload allows the
-00048990: 206f 7074 696f 6e61 6c20 6172 6775 6d65   optional argume
-000489a0: 6e74 2022 0a20 2020 2020 2020 2022 2d2d  nt ".        "--
-000489b0: 706c 6169 6e20 746f 2073 6b69 7020 656e  plain to skip en
-000489c0: 6372 7970 7469 6f6e 2066 6f72 2075 706c  cryption for upl
-000489d0: 6f61 642e 2022 0a20 2020 2020 2020 2022  oad. ".        "
-000489e0: 5365 6520 7465 7374 732f 7465 7374 2d75  See tests/test-u
-000489f0: 706c 6f61 642e 7368 2066 6f72 2061 6e20  pload.sh for an 
-00048a00: 6578 616d 706c 652e 222c 0a20 2020 2029  example.",.    )
-00048a10: 0a20 2020 2061 702e 6164 645f 6172 6775  .    ap.add_argu
-00048a20: 6d65 6e74 280a 2020 2020 2020 2020 222d  ment(.        "-
-00048a30: 2d64 6f77 6e6c 6f61 6422 2c0a 2020 2020  -download",.    
-00048a40: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
-00048a50: 7365 2c0a 2020 2020 2020 2020 6163 7469  se,.        acti
-00048a60: 6f6e 3d22 6578 7465 6e64 222c 0a20 2020  on="extend",.   
-00048a70: 2020 2020 206e 6172 6773 3d22 2b22 2c0a       nargs="+",.
-00048a80: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
-00048a90: 2c0a 2020 2020 2020 2020 6d65 7461 7661  ,.        metava
-00048aa0: 723d 224d 5843 5f55 5249 222c 0a20 2020  r="MXC_URI",.   
-00048ab0: 2020 2020 2068 656c 703d 2244 6f77 6e6c       help="Downl
-00048ac0: 6f61 6420 6f6e 6520 6f72 206d 756c 7469  oad one or multi
-00048ad0: 706c 6520 6669 6c65 7320 6672 6f6d 2074  ple files from t
-00048ae0: 6865 2063 6f6e 7465 6e74 2072 6570 6f73  he content repos
-00048af0: 6974 6f72 792e 2022 0a20 2020 2020 2020  itory. ".       
-00048b00: 2022 4465 7461 696c 733a 3a20 220a 2020   "Details:: ".  
-00048b10: 2020 2020 2020 2259 6f75 206d 7573 7420        "You must 
-00048b20: 7072 6f76 6964 6520 6f6e 6520 6f72 206d  provide one or m
-00048b30: 756c 7469 706c 6520 4d61 7472 6978 2055  ultiple Matrix U
-00048b40: 5249 7320 284d 5843 7329 2077 6869 6368  RIs (MXCs) which
-00048b50: 2061 7265 2022 0a20 2020 2020 2020 2022   are ".        "
-00048b60: 7374 7269 6e67 7320 6c69 6b65 2022 0a20  strings like ". 
-00048b70: 2020 2020 2020 2022 7468 6973 2027 6d78         "this 'mx
-00048b80: 633a 2f2f 6578 616d 706c 652e 636f 6d2f  c://example.com/
-00048b90: 536f 6d65 5374 7261 6e67 6555 7269 4b65  SomeStrangeUriKe
-00048ba0: 7927 2e20 4966 2066 6f75 6e64 2074 6865  y'. If found the
-00048bb0: 7920 7769 6c6c 2022 0a20 2020 2020 2020  y will ".       
-00048bc0: 2022 6265 2064 6f77 6e6c 6f61 6465 642c   "be downloaded,
-00048bd0: 2064 6563 7279 7074 6564 2c20 616e 6420   decrypted, and 
-00048be0: 7374 6f72 6564 2069 6e20 6c6f 6361 6c20  stored in local 
-00048bf0: 6669 6c65 732e 2022 0a20 2020 2020 2020  files. ".       
-00048c00: 2022 4966 2066 696c 6520 6e61 6d65 7320   "If file names 
-00048c10: 6172 6520 7370 6563 6966 6965 6420 7769  are specified wi
-00048c20: 7468 202d 2d66 696c 652d 6e61 6d65 2074  th --file-name t
-00048c30: 6865 2064 6f77 6e6c 6f61 6473 2022 0a20  he downloads ". 
-00048c40: 2020 2020 2020 2022 7769 6c6c 2062 6520         "will be 
-00048c50: 7361 7665 6420 7769 7468 2074 6865 7365  saved with these
-00048c60: 2066 696c 6520 6e61 6d65 732e 2049 6620   file names. If 
-00048c70: 2d2d 6669 6c65 2d6e 616d 6520 6973 206e  --file-name is n
-00048c80: 6f74 2022 0a20 2020 2020 2020 2022 7370  ot ".        "sp
-00048c90: 6563 6966 6965 6420 7468 6520 6f72 6967  ecified the orig
-00048ca0: 696e 616c 2066 696c 6520 6e61 6d65 2066  inal file name f
-00048cb0: 726f 6d20 7468 6520 7570 6c6f 6164 2077  rom the upload w
-00048cc0: 696c 6c20 6265 2075 7365 642e 2022 0a20  ill be used. ". 
-00048cd0: 2020 2020 2020 2022 4966 206e 6569 7468         "If neith
-00048ce0: 6572 2073 7065 6369 6669 6564 206e 6f72  er specified nor
-00048cf0: 2061 7661 696c 6162 6c65 206f 6e20 7365   available on se
-00048d00: 7276 6572 2c20 7468 656e 2074 6865 2066  rver, then the f
-00048d10: 696c 6520 220a 2020 2020 2020 2020 6622  ile ".        f"
-00048d20: 6e61 6d65 206f 6620 6c61 7374 2072 6573  name of last res
-00048d30: 6f72 7420 276d 7863 2d3c 6d78 632d 6964  ort 'mxc-<mxc-id
-00048d40: 3e27 2077 696c 6c20 6265 2075 7365 642e  >' will be used.
-00048d50: 2022 0a20 2020 2020 2020 2066 2249 6620   ".        f"If 
-00048d60: 6120 6669 6c65 206e 616d 6520 696e 202d  a file name in -
-00048d70: 2d66 696c 652d 6e61 6d65 2063 6f6e 7461  -file-name conta
-00048d80: 696e 7320 7468 6520 706c 6163 6568 6f6c  ins the placehol
-00048d90: 6465 7220 220a 2020 2020 2020 2020 6622  der ".        f"
-00048da0: 7b4d 5843 5f49 445f 504c 4143 4548 4f4c  {MXC_ID_PLACEHOL
-00048db0: 4445 527d 2c20 6974 2077 696c 6c20 6265  DER}, it will be
-00048dc0: 2072 6570 6c61 6365 6420 7769 7468 2074   replaced with t
-00048dd0: 6865 206d 7863 2d69 642e 2022 0a20 2020  he mxc-id. ".   
-00048de0: 2020 2020 2022 4966 2061 2066 696c 6520       "If a file 
-00048df0: 6e61 6d65 2069 7320 7370 6563 6966 6965  name is specifie
-00048e00: 6420 6173 2065 6d70 7479 2073 7472 696e  d as empty strin
-00048e10: 6720 696e 202d 2d66 696c 652d 6e61 6d65  g in --file-name
-00048e20: 2c20 7468 656e 2022 0a20 2020 2020 2020  , then ".       
-00048e30: 2022 616c 736f 2074 6865 206e 616d 6520   "also the name 
-00048e40: 276d 7863 2d3c 6d78 632d 6964 3e27 2077  'mxc-<mxc-id>' w
-00048e50: 696c 6c20 6265 2075 7365 642e 2022 0a20  ill be used. ". 
-00048e60: 2020 2020 2020 2022 4279 2064 6566 6175         "By defau
-00048e70: 6c74 2c20 7468 6520 7570 6c6f 6164 2077  lt, the upload w
-00048e80: 6173 2065 6e63 7279 7074 6564 2073 6f20  as encrypted so 
-00048e90: 6120 6465 6372 7970 7469 6f6e 2064 6963  a decryption dic
-00048ea0: 7469 6f6e 6172 7920 220a 2020 2020 2020  tionary ".      
-00048eb0: 2020 226d 7573 7420 6265 2070 726f 7669    "must be provi
-00048ec0: 6465 6420 746f 2064 6563 7279 7074 2074  ded to decrypt t
-00048ed0: 6865 2064 6174 612e 2053 7065 6369 6679  he data. Specify
-00048ee0: 206f 6e65 206f 7220 6d75 6c74 6970 6c65   one or multiple
-00048ef0: 2022 0a20 2020 2020 2020 2022 6465 6372   ".        "decr
-00048f00: 7970 7469 6f6e 206b 6579 7320 220a 2020  yption keys ".  
-00048f10: 2020 2020 2020 2277 6974 6820 2d2d 6b65        "with --ke
-00048f20: 792d 6469 6374 2e20 4966 202d 2d6b 6579  y-dict. If --key
-00048f30: 2d64 6963 7420 6973 206e 6f74 2073 6574  -dict is not set
-00048f40: 2c20 6e6f 7420 6465 6372 7970 7469 6f6e  , not decryption
-00048f50: 2069 7320 220a 2020 2020 2020 2020 2261   is ".        "a
-00048f60: 7474 656d 7074 6564 3b20 616e 6420 7468  ttempted; and th
-00048f70: 6520 6461 7461 206d 6967 6874 2062 6520  e data might be 
-00048f80: 7374 6f72 6564 2069 6e20 656e 6372 7970  stored in encryp
-00048f90: 7465 6420 6661 7368 696f 6e2c 2022 0a20  ted fashion, ". 
-00048fa0: 2020 2020 2020 2022 6f72 206d 6967 6874         "or might
-00048fb0: 2062 6520 706c 6169 6e2d 7465 7874 2069   be plain-text i
-00048fc0: 6620 7468 6520 2d2d 7570 6c6f 6164 2073  f the --upload s
-00048fd0: 6b69 7070 6564 2065 6e63 7279 7074 696f  kipped encryptio
-00048fe0: 6e20 7769 7468 2022 0a20 2020 2020 2020  n with ".       
-00048ff0: 2022 2d2d 706c 6169 6e2e 2022 0a20 2020   "--plain. ".   
-00049000: 2020 2020 2022 5365 6520 7465 7374 732f       "See tests/
-00049010: 7465 7374 2d75 706c 6f61 642e 7368 2066  test-upload.sh f
-00049020: 6f72 2061 6e20 6578 616d 706c 652e 222c  or an example.",
-00049030: 0a20 2020 2029 0a20 2020 2061 702e 6164  .    ).    ap.ad
-00049040: 645f 6172 6775 6d65 6e74 280a 2020 2020  d_argument(.    
-00049050: 2020 2020 222d 2d64 656c 6574 652d 6d78      "--delete-mx
-00049060: 6322 2c0a 2020 2020 2020 2020 7265 7175  c",.        requ
-00049070: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
-00049080: 2020 2020 6163 7469 6f6e 3d22 6578 7465      action="exte
-00049090: 6e64 222c 0a20 2020 2020 2020 206e 6172  nd",.        nar
-000490a0: 6773 3d22 2b22 2c0a 2020 2020 2020 2020  gs="+",.        
-000490b0: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
-000490c0: 2020 6d65 7461 7661 723d 224d 5843 5f55    metavar="MXC_U
-000490d0: 5249 222c 0a20 2020 2020 2020 2068 656c  RI",.        hel
-000490e0: 703d 2244 656c 6574 6520 6f6e 6520 6f72  p="Delete one or
-000490f0: 206d 756c 7469 706c 6520 6f62 6a65 6374   multiple object
-00049100: 7320 6672 6f6d 2074 6865 2063 6f6e 7465  s from the conte
-00049110: 6e74 2072 6570 6f73 6974 6f72 792e 2022  nt repository. "
-00049120: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
-00049130: 733a 3a20 596f 7520 6d75 7374 2070 726f  s:: You must pro
-00049140: 7669 6465 206f 6e65 206f 7220 6d75 6c74  vide one or mult
-00049150: 6970 6c65 204d 6174 7269 7820 5552 4973  iple Matrix URIs
-00049160: 2028 4d58 4329 2022 0a20 2020 2020 2020   (MXC) ".       
-00049170: 2022 7768 6963 6820 6172 6520 7374 7269   "which are stri
-00049180: 6e67 7320 6c69 6b65 2022 0a20 2020 2020  ngs like ".     
-00049190: 2020 2022 7468 6973 2027 6d78 633a 2f2f     "this 'mxc://
-000491a0: 6578 616d 706c 652e 636f 6d2f 536f 6d65  example.com/Some
-000491b0: 5374 7261 6e67 6555 7269 4b65 7927 2e20  StrangeUriKey'. 
-000491c0: 416c 7465 726e 6174 6976 656c 792c 2079  Alternatively, y
-000491d0: 6f75 2022 0a20 2020 2020 2020 2022 6361  ou ".        "ca
-000491e0: 6e20 6a75 7374 2070 726f 7669 6465 2074  n just provide t
-000491f0: 6865 204d 5843 2069 642c 2069 2e65 2e20  he MXC id, i.e. 
-00049200: 7468 6520 7061 7274 2061 6674 6572 2074  the part after t
-00049210: 6865 206c 6173 7420 736c 6173 682e 2022  he last slash. "
-00049220: 0a20 2020 2020 2020 2022 4966 2066 6f75  .        "If fou
-00049230: 6e64 2074 6865 7920 2869 2e65 2e20 7468  nd they (i.e. th
-00049240: 6520 6669 6c65 7320 7468 6579 2072 6570  e files they rep
-00049250: 7265 7365 6e74 2920 7769 6c6c 2022 0a20  resent) will ". 
-00049260: 2020 2020 2020 2022 6265 2064 656c 6574         "be delet
-00049270: 6564 2066 726f 6d20 7468 6520 7365 7276  ed from the serv
-00049280: 6572 2064 6174 6162 6173 652e 2049 6e20  er database. In 
-00049290: 6f72 6465 7220 746f 2064 656c 6574 6520  order to delete 
-000492a0: 6f62 6a65 6374 7320 220a 2020 2020 2020  objects ".      
-000492b0: 2020 226f 6e65 206d 7573 7420 6861 7665    "one must have
-000492c0: 2073 6572 7665 7220 6164 6d69 6e20 7065   server admin pe
-000492d0: 726d 6973 7369 6f6e 732e 2048 6176 696e  rmissions. Havin
-000492e0: 6720 6f6e 6c79 2072 6f6f 6d20 6164 6d69  g only room admi
-000492f0: 6e20 220a 2020 2020 2020 2020 2270 6572  n ".        "per
-00049300: 6d69 7373 696f 6e73 2069 7320 6e6f 7420  missions is not 
-00049310: 7375 6666 6963 6965 6e74 2061 6e64 2069  sufficient and i
-00049320: 7420 7769 6c6c 2066 6169 6c2e 2022 0a20  t will fail. ". 
-00049330: 2020 2020 2020 2022 5265 6164 2022 0a20         "Read ". 
-00049340: 2020 2020 2020 2022 6874 7470 733a 2f2f         "https://
-00049350: 6d61 7472 6978 2d6f 7267 2e67 6974 6875  matrix-org.githu
-00049360: 622e 696f 2f73 796e 6170 7365 2f22 0a20  b.io/synapse/". 
-00049370: 2020 2020 2020 2022 6c61 7465 7374 2f75         "latest/u
-00049380: 7361 6765 2f61 646d 696e 6973 7472 6174  sage/administrat
-00049390: 696f 6e2f 6164 6d69 6e5f 6170 692f 2022  ion/admin_api/ "
-000493a0: 0a20 2020 2020 2020 2022 666f 7220 6c65  .        "for le
-000493b0: 6172 6e69 6e67 2068 6f77 2074 6f20 7365  arning how to se
-000493c0: 7420 7365 7276 6572 2061 646d 696e 2070  t server admin p
-000493d0: 6572 6d69 7373 696f 6e73 206f 6e20 7468  ermissions on th
-000493e0: 6520 220a 2020 2020 2020 2020 2273 6572  e ".        "ser
-000493f0: 7665 722e 2041 6c74 6572 6e61 7469 7665  ver. Alternative
-00049400: 6c79 2c20 616e 6420 6f70 7469 6f6e 616c  ly, and optional
-00049410: 6c79 2c20 6f6e 6520 6361 6e20 7370 6563  ly, one can spec
-00049420: 6966 7920 220a 2020 2020 2020 2020 2261  ify ".        "a
-00049430: 6e20 6163 6365 7373 2074 6f6b 656e 2077  n access token w
-00049440: 6869 6368 2068 6173 2073 6572 7665 7220  hich has server 
-00049450: 6164 6d69 6e20 7065 726d 6973 7369 6f6e  admin permission
-00049460: 7320 7769 7468 2074 6865 2022 0a20 2020  s with the ".   
-00049470: 2020 2020 2022 2d2d 6163 6365 7373 2d74       "--access-t
-00049480: 6f6b 656e 2061 7267 756d 656e 742e 2022  oken argument. "
-00049490: 0a20 2020 2020 2020 2022 5365 6520 7465  .        "See te
-000494a0: 7374 732f 7465 7374 2d75 706c 6f61 642e  sts/test-upload.
-000494b0: 7368 2066 6f72 2061 6e20 6578 616d 706c  sh for an exampl
-000494c0: 652e 222c 0a20 2020 2029 0a20 2020 2061  e.",.    ).    a
-000494d0: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
-000494e0: 2020 2020 2020 2020 222d 2d64 656c 6574          "--delet
-000494f0: 652d 6d78 632d 6265 666f 7265 222c 0a20  e-mxc-before",. 
-00049500: 2020 2020 2020 2072 6571 7569 7265 643d         required=
-00049510: 4661 6c73 652c 0a20 2020 2020 2020 2061  False,.        a
-00049520: 6374 696f 6e3d 2265 7874 656e 6422 2c0a  ction="extend",.
-00049530: 2020 2020 2020 2020 6e61 7267 733d 222b          nargs="+
-00049540: 222c 0a20 2020 2020 2020 2074 7970 653d  ",.        type=
-00049550: 7374 722c 0a20 2020 2020 2020 206d 6574  str,.        met
-00049560: 6176 6172 3d22 5449 4d45 5354 414d 5022  avar="TIMESTAMP"
-00049570: 2c0a 2020 2020 2020 2020 6865 6c70 3d22  ,.        help="
-00049580: 4465 6c65 7465 206f 6c64 206f 626a 6563  Delete old objec
-00049590: 7473 2066 726f 6d20 7468 6520 636f 6e74  ts from the cont
-000495a0: 656e 7420 7265 706f 7369 746f 7279 220a  ent repository".
-000495b0: 2020 2020 2020 2020 2244 6574 6169 6c73          "Details
-000495c0: 3a3a 2044 656c 6574 6520 6669 6c65 7320  :: Delete files 
-000495d0: 6672 6f6d 2074 6865 2063 6f6e 7465 6e74  from the content
-000495e0: 2072 6570 6f73 6974 6f72 7920 220a 2020   repository ".  
-000495f0: 2020 2020 2020 2274 6861 7420 6172 6520        "that are 
-00049600: 6f6c 6465 7220 7468 616e 2061 2067 6976  older than a giv
-00049610: 656e 2074 696d 6573 7461 6d70 2e20 220a  en timestamp. ".
-00049620: 2020 2020 2020 2020 2249 7420 6973 2074          "It is t
-00049630: 6865 2074 696d 6573 7461 6d70 206f 6620  he timestamp of 
-00049640: 6c61 7374 2061 6363 6573 732c 206e 6f74  last access, not
-00049650: 2074 6865 2074 696d 6573 7461 6d70 2077   the timestamp w
-00049660: 6865 6e20 220a 2020 2020 2020 2020 2274  hen ".        "t
-00049670: 6865 2066 696c 6520 7761 7320 6372 6561  he file was crea
-00049680: 7465 642e 2022 0a20 2020 2020 2020 2022  ted. ".        "
-00049690: 4164 6469 7469 6f6e 616c 6c79 2079 6f75  Additionally you
-000496a0: 2063 616e 2073 7065 6369 6679 2061 2073   can specify a s
-000496b0: 697a 6520 696e 2062 7974 6573 2074 6f20  ize in bytes to 
-000496c0: 696e 6469 6361 7465 2022 0a20 2020 2020  indicate ".     
-000496d0: 2020 2022 7468 6174 206f 6e6c 7920 6669     "that only fi
-000496e0: 6c65 7320 6f6c 6465 7220 7468 616e 2074  les older than t
-000496f0: 696d 6573 7461 6d70 2061 6e64 206c 6172  imestamp and lar
-00049700: 6765 7220 7468 616e 2073 697a 6520 220a  ger than size ".
-00049710: 2020 2020 2020 2020 2277 696c 6c20 6265          "will be
-00049720: 2064 656c 6574 6564 2e20 220a 2020 2020   deleted. ".    
-00049730: 2020 2020 2259 6f75 206d 7573 7420 7072      "You must pr
-00049740: 6f76 6964 6520 6120 7469 6d65 7374 616d  ovide a timestam
-00049750: 7020 6f66 2074 6865 2066 6f6c 6c6f 7769  p of the followi
-00049760: 6e67 2066 6f72 6d61 743a 2022 0a20 2020  ng format: ".   
-00049770: 2020 2020 2022 2744 442e 4d4d 2e59 5959       "'DD.MM.YYY
-00049780: 5920 4848 3a4d 4d3a 5353 2720 6c69 6b65  Y HH:MM:SS' like
-00049790: 2027 3230 2e30 312e 3230 3232 2031 393a   '20.01.2022 19:
-000497a0: 3338 3a34 3227 2066 6f72 204a 616e 7561  38:42' for Janua
-000497b0: 7279 2032 302c 2022 0a20 2020 2020 2020  ry 20, ".       
-000497c0: 2022 3230 3232 2c20 3770 6d20 3338 6d69   "2022, 7pm 38mi
-000497d0: 6e20 3432 7365 632e 2022 0a20 2020 2020  n 42sec. ".     
-000497e0: 2020 2022 4669 6c65 7320 7468 6174 2061     "Files that a
-000497f0: 7265 2073 7469 6c6c 2075 7365 6420 696e  re still used in
-00049800: 2069 6d61 6765 2064 6174 6120 2865 2e67   image data (e.g
-00049810: 2075 7365 7220 7072 6f66 696c 652c 2022   user profile, "
-00049820: 0a20 2020 2020 2020 2022 726f 6f6d 2061  .        "room a
-00049830: 7661 7461 7229 2077 696c 6c20 6e6f 7420  vatar) will not 
-00049840: 6265 2064 656c 6574 6564 2066 726f 6d20  be deleted from 
-00049850: 7468 6520 7365 7276 6572 2064 6174 6162  the server datab
-00049860: 6173 652e 2022 0a20 2020 2020 2020 2022  ase. ".        "
-00049870: 496e 206f 7264 6572 2074 6f20 6465 6c65  In order to dele
-00049880: 7465 206f 626a 6563 7473 2022 0a20 2020  te objects ".   
-00049890: 2020 2020 2022 6f6e 6520 6d75 7374 2068       "one must h
-000498a0: 6176 6520 7365 7276 6572 2061 646d 696e  ave server admin
-000498b0: 2070 6572 6d69 7373 696f 6e73 2e20 4861   permissions. Ha
-000498c0: 7669 6e67 206f 6e6c 7920 726f 6f6d 2061  ving only room a
-000498d0: 646d 696e 2022 0a20 2020 2020 2020 2022  dmin ".        "
-000498e0: 7065 726d 6973 7369 6f6e 7320 6973 206e  permissions is n
-000498f0: 6f74 2073 7566 6669 6369 656e 7420 616e  ot sufficient an
-00049900: 6420 6974 2077 696c 6c20 6661 696c 2e20  d it will fail. 
-00049910: 220a 2020 2020 2020 2020 2252 6561 6420  ".        "Read 
-00049920: 220a 2020 2020 2020 2020 2268 7474 7073  ".        "https
-00049930: 3a2f 2f6d 6174 7269 782d 6f72 672e 6769  ://matrix-org.gi
-00049940: 7468 7562 2e69 6f2f 7379 6e61 7073 652f  thub.io/synapse/
-00049950: 220a 2020 2020 2020 2020 226c 6174 6573  ".        "lates
-00049960: 742f 7573 6167 652f 6164 6d69 6e69 7374  t/usage/administ
-00049970: 7261 7469 6f6e 2f61 646d 696e 5f61 7069  ration/admin_api
-00049980: 2f20 220a 2020 2020 2020 2020 2266 6f72  / ".        "for
-00049990: 206c 6561 726e 696e 6720 686f 7720 746f   learning how to
-000499a0: 2073 6574 2073 6572 7665 7220 6164 6d69   set server admi
-000499b0: 6e20 7065 726d 6973 7369 6f6e 7320 6f6e  n permissions on
-000499c0: 2074 6865 2022 0a20 2020 2020 2020 2022   the ".        "
-000499d0: 7365 7276 6572 2e20 416c 7465 726e 6174  server. Alternat
-000499e0: 6976 656c 792c 2061 6e64 206f 7074 696f  ively, and optio
-000499f0: 6e61 6c6c 792c 206f 6e65 2063 616e 2073  nally, one can s
-00049a00: 7065 6369 6679 2022 0a20 2020 2020 2020  pecify ".       
-00049a10: 2022 616e 2061 6363 6573 7320 746f 6b65   "an access toke
-00049a20: 6e20 7768 6963 6820 6861 7320 7365 7276  n which has serv
-00049a30: 6572 2061 646d 696e 2070 6572 6d69 7373  er admin permiss
-00049a40: 696f 6e73 2077 6974 6820 7468 6520 220a  ions with the ".
-00049a50: 2020 2020 2020 2020 222d 2d61 6363 6573          "--acces
-00049a60: 732d 746f 6b65 6e20 6172 6775 6d65 6e74  s-token argument
-00049a70: 2e20 220a 2020 2020 2020 2020 2253 6565  . ".        "See
-00049a80: 2074 6573 7473 2f74 6573 742d 7570 6c6f   tests/test-uplo
-00049a90: 6164 2e73 6820 666f 7220 616e 2065 7861  ad.sh for an exa
-00049aa0: 6d70 6c65 2e22 2c0a 2020 2020 290a 2020  mple.",.    ).  
-00049ab0: 2020 6170 2e61 6464 5f61 7267 756d 656e    ap.add_argumen
-00049ac0: 7428 0a20 2020 2020 2020 2023 206e 6f20  t(.        # no 
-00049ad0: 7369 6e67 6c65 2063 6861 7220 666c 6167  single char flag
-00049ae0: 0a20 2020 2020 2020 2022 2d2d 6a6f 696e  .        "--join
-00049af0: 6564 2d72 6f6f 6d73 222c 0a20 2020 2020  ed-rooms",.     
-00049b00: 2020 2072 6571 7569 7265 643d 4661 6c73     required=Fals
-00049b10: 652c 0a20 2020 2020 2020 2061 6374 696f  e,.        actio
-00049b20: 6e3d 2273 746f 7265 5f74 7275 6522 2c0a  n="store_true",.
-00049b30: 2020 2020 2020 2020 6865 6c70 3d22 5072          help="Pr
-00049b40: 696e 7420 7468 6520 6c69 7374 206f 6620  int the list of 
-00049b50: 6a6f 696e 6564 2072 6f6f 6d73 2e20 220a  joined rooms. ".
-00049b60: 2020 2020 2020 2020 2244 6574 6169 6c73          "Details
-00049b70: 3a3a 2041 6c6c 2072 6f6f 6d73 2074 6861  :: All rooms tha
-00049b80: 7420 796f 7520 6172 6520 6120 220a 2020  t you are a ".  
-00049b90: 2020 2020 2020 226d 656d 6265 7220 6f66        "member of
-00049ba0: 2077 696c 6c20 6265 2070 7269 6e74 6564   will be printed
-00049bb0: 2c20 6f6e 6520 726f 6f6d 2070 6572 206c  , one room per l
-00049bc0: 696e 652e 222c 0a20 2020 2029 0a20 2020  ine.",.    ).   
-00049bd0: 2061 702e 6164 645f 6172 6775 6d65 6e74   ap.add_argument
-00049be0: 280a 2020 2020 2020 2020 2320 6e6f 2073  (.        # no s
-00049bf0: 696e 676c 6520 6368 6172 2066 6c61 670a  ingle char flag.
-00049c00: 2020 2020 2020 2020 222d 2d6a 6f69 6e65          "--joine
-00049c10: 642d 6d65 6d62 6572 7322 2c0a 2020 2020  d-members",.    
-00049c20: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
-00049c30: 7365 2c0a 2020 2020 2020 2020 6163 7469  se,.        acti
-00049c40: 6f6e 3d22 6578 7465 6e64 222c 0a20 2020  on="extend",.   
-00049c50: 2020 2020 206e 6172 6773 3d22 2b22 2c0a       nargs="+",.
-00049c60: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
-00049c70: 2c0a 2020 2020 2020 2020 6d65 7461 7661  ,.        metava
-00049c80: 723d 2252 4f4f 4d22 2c0a 2020 2020 2020  r="ROOM",.      
-00049c90: 2020 6865 6c70 3d22 5072 696e 7420 7468    help="Print th
-00049ca0: 6520 6c69 7374 206f 6620 6a6f 696e 6564  e list of joined
-00049cb0: 206d 656d 6265 7273 2066 6f72 206f 6e65   members for one
-00049cc0: 206f 7220 6d75 6c74 6970 6c65 2072 6f6f   or multiple roo
-00049cd0: 6d73 2e20 220a 2020 2020 2020 2020 2244  ms. ".        "D
-00049ce0: 6574 6169 6c73 3a3a 2049 6620 796f 7520  etails:: If you 
-00049cf0: 7761 6e74 2074 6f20 7072 696e 7420 7468  want to print th
-00049d00: 6520 6a6f 696e 6564 206d 656d 6265 7273  e joined members
-00049d10: 206f 6620 616c 6c20 726f 6f6d 7320 7468   of all rooms th
-00049d20: 6174 2022 0a20 2020 2020 2020 2022 796f  at ".        "yo
-00049d30: 7520 6172 6520 6d65 6d62 6572 206f 662c  u are member of,
-00049d40: 2074 6865 6e20 7573 6520 7468 6520 7370   then use the sp
-00049d50: 6563 6961 6c20 6368 6172 6163 7465 7220  ecial character 
-00049d60: 272a 272e 222c 0a20 2020 2029 0a20 2020  '*'.",.    ).   
-00049d70: 2061 702e 6164 645f 6172 6775 6d65 6e74   ap.add_argument
-00049d80: 280a 2020 2020 2020 2020 222d 2d6d 7863  (.        "--mxc
-00049d90: 2d74 6f2d 6874 7470 222c 0a20 2020 2020  -to-http",.     
-00049da0: 2020 2072 6571 7569 7265 643d 4661 6c73     required=Fals
-00049db0: 652c 0a20 2020 2020 2020 2061 6374 696f  e,.        actio
-00049dc0: 6e3d 2265 7874 656e 6422 2c0a 2020 2020  n="extend",.    
-00049dd0: 2020 2020 6e61 7267 733d 222b 222c 0a20      nargs="+",. 
-00049de0: 2020 2020 2020 2074 7970 653d 7374 722c         type=str,
-00049df0: 0a20 2020 2020 2020 206d 6574 6176 6172  .        metavar
-00049e00: 3d22 4d58 435f 5552 4922 2c0a 2020 2020  ="MXC_URI",.    
-00049e10: 2020 2020 6865 6c70 3d22 436f 6e76 6572      help="Conver
-00049e20: 7420 4d58 4320 5552 4973 2074 6f20 4854  t MXC URIs to HT
-00049e30: 5450 2055 524c 732e 2022 0a20 2020 2020  TP URLs. ".     
-00049e40: 2020 2022 4465 7461 696c 733a 3a20 436f     "Details:: Co
-00049e50: 6e76 6572 7420 6f6e 6520 6f72 206d 6f72  nvert one or mor
-00049e60: 6520 6d61 7472 6978 2063 6f6e 7465 6e74  e matrix content
-00049e70: 2055 5249 7320 746f 2074 6865 2022 0a20   URIs to the ". 
-00049e80: 2020 2020 2020 2022 636f 7272 6573 706f         "correspo
-00049e90: 6e64 696e 6720 4854 5450 2055 524c 732e  nding HTTP URLs.
-00049ea0: 2054 6865 204d 5843 2055 5249 7320 220a   The MXC URIs ".
-00049eb0: 2020 2020 2020 2020 2274 6f20 7072 6f76          "to prov
-00049ec0: 6964 6520 6c6f 6f6b 2073 6f6d 6574 6869  ide look somethi
-00049ed0: 6e67 206c 696b 6520 7468 6973 2022 0a20  ng like this ". 
-00049ee0: 2020 2020 2020 2022 276d 7863 3a2f 2f65         "'mxc://e
-00049ef0: 7861 6d70 6c65 2e63 6f6d 2f53 6f6d 6553  xample.com/SomeS
-00049f00: 7472 616e 6765 5572 694b 6579 272e 2022  trangeUriKey'. "
-00049f10: 0a20 2020 2020 2020 2022 5365 6520 7465  .        "See te
-00049f20: 7374 732f 7465 7374 2d75 706c 6f61 642e  sts/test-upload.
-00049f30: 7368 2066 6f72 2061 6e20 6578 616d 706c  sh for an exampl
-00049f40: 652e 222c 0a20 2020 2029 0a20 2020 2061  e.",.    ).    a
-00049f50: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
-00049f60: 2020 2020 2020 2020 2320 6e6f 2073 696e          # no sin
-00049f70: 676c 6520 6368 6172 2066 6c61 670a 2020  gle char flag.  
-00049f80: 2020 2020 2020 222d 2d64 6576 6963 6573        "--devices
-00049f90: 222c 0a20 2020 2020 2020 2022 2d2d 6765  ",.        "--ge
-00049fa0: 742d 6465 7669 6365 7322 2c20 2023 2061  t-devices",  # a
-00049fb0: 6c69 6173 2c20 6361 7573 6520 2d2d 6465  lias, cause --de
-00049fc0: 7669 6365 6420 6973 2076 6572 7920 7369  viced is very si
-00049fd0: 6d69 6c61 7220 746f 202d 2d64 6576 6963  milar to --devic
-00049fe0: 650a 2020 2020 2020 2020 7265 7175 6972  e.        requir
-00049ff0: 6564 3d46 616c 7365 2c0a 2020 2020 2020  ed=False,.      
-0004a000: 2020 6163 7469 6f6e 3d22 7374 6f72 655f    action="store_
-0004a010: 7472 7565 222c 0a20 2020 2020 2020 2068  true",.        h
-0004a020: 656c 703d 2250 7269 6e74 2074 6865 206c  elp="Print the l
-0004a030: 6973 7420 6f66 2064 6576 6963 6573 2e20  ist of devices. 
-0004a040: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
-0004a050: 6c73 3a3a 2041 6c6c 2064 6576 6963 6520  ls:: All device 
-0004a060: 6f66 2074 6869 7320 220a 2020 2020 2020  of this ".      
-0004a070: 2020 2261 6363 6f75 6e74 2077 696c 6c20    "account will 
-0004a080: 6265 2070 7269 6e74 6564 2c20 6f6e 6520  be printed, one 
-0004a090: 6465 7669 6365 2070 6572 206c 696e 652e  device per line.
-0004a0a0: 222c 0a20 2020 2029 0a20 2020 2061 702e  ",.    ).    ap.
-0004a0b0: 6164 645f 6172 6775 6d65 6e74 280a 2020  add_argument(.  
-0004a0c0: 2020 2020 2020 2320 6e6f 2073 696e 676c        # no singl
-0004a0d0: 6520 6368 6172 2066 6c61 670a 2020 2020  e char flag.    
-0004a0e0: 2020 2020 222d 2d64 6973 636f 7665 7279      "--discovery
-0004a0f0: 2d69 6e66 6f22 2c0a 2020 2020 2020 2020  -info",.        
-0004a100: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
-0004a110: 2020 2020 2020 2020 6163 7469 6f6e 3d22          action="
-0004a120: 7374 6f72 655f 7472 7565 222c 0a20 2020  store_true",.   
-0004a130: 2020 2020 2068 656c 703d 2250 7269 6e74       help="Print
-0004a140: 2064 6973 636f 7665 7279 2069 6e66 6f72   discovery infor
-0004a150: 6d61 7469 6f6e 2061 626f 7574 2063 7572  mation about cur
-0004a160: 7265 6e74 2068 6f6d 6573 6572 7665 722e  rent homeserver.
-0004a170: 2022 0a20 2020 2020 2020 2022 4465 7461   ".        "Deta
-0004a180: 696c 733a 3a20 4e6f 7465 2074 6861 7420  ils:: Note that 
-0004a190: 6e6f 7420 616c 6c20 686f 6d65 7365 7276  not all homeserv
-0004a1a0: 6572 7320 7375 7070 6f72 7420 6469 7363  ers support disc
-0004a1b0: 6f76 6572 7920 616e 6420 616e 2022 0a20  overy and an ". 
-0004a1c0: 2020 2020 2020 2022 6572 726f 7220 6d69         "error mi
-0004a1d0: 6768 7420 6265 2072 6570 6f72 7465 642e  ght be reported.
-0004a1e0: 222c 0a20 2020 2029 0a20 2020 2061 702e  ",.    ).    ap.
-0004a1f0: 6164 645f 6172 6775 6d65 6e74 280a 2020  add_argument(.  
-0004a200: 2020 2020 2020 2320 6e6f 2073 696e 676c        # no singl
-0004a210: 6520 6368 6172 2066 6c61 670a 2020 2020  e char flag.    
-0004a220: 2020 2020 222d 2d6c 6f67 696e 2d69 6e66      "--login-inf
-0004a230: 6f22 2c0a 2020 2020 2020 2020 7265 7175  o",.        requ
-0004a240: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
-0004a250: 2020 2020 6163 7469 6f6e 3d22 7374 6f72      action="stor
-0004a260: 655f 7472 7565 222c 0a20 2020 2020 2020  e_true",.       
-0004a270: 2068 656c 703d 2250 7269 6e74 206c 6f67   help="Print log
-0004a280: 696e 206d 6574 686f 6473 2073 7570 706f  in methods suppo
-0004a290: 7274 6564 2062 7920 7468 6520 686f 6d65  rted by the home
-0004a2a0: 7365 7276 6572 2e20 220a 2020 2020 2020  server. ".      
-0004a2b0: 2020 2244 6574 6169 6c73 3a3a 2049 7420    "Details:: It 
-0004a2c0: 7072 696e 7473 206f 6e65 206c 6f67 696e  prints one login
-0004a2d0: 206d 6574 686f 6420 7065 7220 6c69 6e65   method per line
-0004a2e0: 2e22 2c0a 2020 2020 290a 2020 2020 6170  .",.    ).    ap
-0004a2f0: 2e61 6464 5f61 7267 756d 656e 7428 0a20  .add_argument(. 
-0004a300: 2020 2020 2020 2023 206e 6f20 7369 6e67         # no sing
-0004a310: 6c65 2063 6861 7220 666c 6167 0a20 2020  le char flag.   
-0004a320: 2020 2020 2022 2d2d 636f 6e74 656e 742d       "--content-
-0004a330: 7265 706f 7369 746f 7279 2d63 6f6e 6669  repository-confi
-0004a340: 6722 2c0a 2020 2020 2020 2020 7265 7175  g",.        requ
-0004a350: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
-0004a360: 2020 2020 6163 7469 6f6e 3d22 7374 6f72      action="stor
-0004a370: 655f 7472 7565 222c 0a20 2020 2020 2020  e_true",.       
-0004a380: 2068 656c 703d 2250 7269 6e74 2074 6865   help="Print the
-0004a390: 2063 6f6e 7465 6e74 2072 6570 6f73 6974   content reposit
-0004a3a0: 6f72 7920 636f 6e66 6967 7572 6174 696f  ory configuratio
-0004a3b0: 6e2e 2022 0a20 2020 2020 2020 2022 4465  n. ".        "De
-0004a3c0: 7461 696c 733a 3a20 5468 6973 2063 7572  tails:: This cur
-0004a3d0: 7265 6e74 6c79 206a 7573 7420 7072 696e  rently just prin
-0004a3e0: 7473 2022 0a20 2020 2020 2020 2022 7468  ts ".        "th
-0004a3f0: 6520 7570 6c6f 6164 2073 697a 6520 6c69  e upload size li
-0004a400: 6d69 7420 696e 2062 7974 6573 2e22 2c0a  mit in bytes.",.
-0004a410: 2020 2020 290a 2020 2020 6170 2e61 6464      ).    ap.add
-0004a420: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
-0004a430: 2020 2023 206e 6f20 7369 6e67 6c65 2063     # no single c
-0004a440: 6861 7220 666c 6167 0a20 2020 2020 2020  har flag.       
-0004a450: 2022 2d2d 7265 7374 222c 0a20 2020 2020   "--rest",.     
-0004a460: 2020 2072 6571 7569 7265 643d 4661 6c73     required=Fals
-0004a470: 652c 0a20 2020 2020 2020 2061 6374 696f  e,.        actio
-0004a480: 6e3d 2265 7874 656e 6422 2c0a 2020 2020  n="extend",.    
-0004a490: 2020 2020 6e61 7267 733d 222b 222c 0a20      nargs="+",. 
-0004a4a0: 2020 2020 2020 2074 7970 653d 7374 722c         type=str,
-0004a4b0: 0a20 2020 2020 2020 206d 6574 6176 6172  .        metavar
-0004a4c0: 3d22 5245 5354 5f4d 4554 484f 4420 4441  ="REST_METHOD DA
-0004a4d0: 5441 2055 524c 222c 0a20 2020 2020 2020  TA URL",.       
-0004a4e0: 2068 656c 703d 2255 7365 2074 6865 204d   help="Use the M
-0004a4f0: 6174 7269 7820 436c 6965 6e74 2052 4553  atrix Client RES
-0004a500: 5420 4150 492e 2022 0a20 2020 2020 2020  T API. ".       
-0004a510: 2022 4465 7461 696c 733a 3a20 4d61 7472   "Details:: Matr
-0004a520: 6978 2068 6173 2073 6576 6572 616c 2065  ix has several e
-0004a530: 7874 656e 7369 7665 2022 0a20 2020 2020  xtensive ".     
-0004a540: 2020 2022 5245 5354 2041 5049 732e 2057     "REST APIs. W
-0004a550: 6974 6820 7468 6520 2d2d 7265 7374 2061  ith the --rest a
-0004a560: 7267 756d 656e 7420 796f 7520 6361 6e20  rgument you can 
-0004a570: 696e 766f 6b65 2061 204d 6174 7269 7820  invoke a Matrix 
-0004a580: 5245 5354 2022 0a20 2020 2020 2020 2022  REST ".        "
-0004a590: 4150 4920 6361 6c6c 2e20 5468 6973 2061  API call. This a
-0004a5a0: 6c6c 6f77 7320 7468 6520 7573 6572 2074  llows the user t
-0004a5b0: 6f20 646f 2070 7265 7474 7920 6d75 6368  o do pretty much
-0004a5c0: 2061 6e79 7468 696e 672c 2061 7420 7468   anything, at th
-0004a5d0: 6520 220a 2020 2020 2020 2020 2270 7269  e ".        "pri
-0004a5e0: 6365 206f 6620 6e6f 7420 6265 696e 6720  ce of not being 
-0004a5f0: 7665 7279 2063 6f6e 7665 6e69 656e 742e  very convenient.
-0004a600: 2054 6865 2041 5049 7320 6172 6520 6465   The APIs are de
-0004a610: 7363 7269 6265 6420 696e 2022 0a20 2020  scribed in ".   
-0004a620: 2020 2020 2022 6874 7470 733a 2f2f 6d61       "https://ma
-0004a630: 7472 6978 2e6f 7267 2f64 6f63 732f 6170  trix.org/docs/ap
-0004a640: 692f 2c20 220a 2020 2020 2020 2020 2268  i/, ".        "h
-0004a650: 7474 7073 3a2f 2f73 7065 632e 6d61 7472  ttps://spec.matr
-0004a660: 6978 2e6f 7267 2f6c 6174 6573 742f 636c  ix.org/latest/cl
-0004a670: 6965 6e74 2d73 6572 7665 722d 6170 692f  ient-server-api/
-0004a680: 2c20 220a 2020 2020 2020 2020 2268 7474  , ".        "htt
-0004a690: 7073 3a2f 2f6d 6174 7269 782d 6f72 672e  ps://matrix-org.
-0004a6a0: 6769 7468 7562 2e69 6f2f 7379 6e61 7073  github.io/synaps
-0004a6b0: 652f 6c61 7465 7374 2f75 7361 6765 2f61  e/latest/usage/a
-0004a6c0: 646d 696e 6973 7472 6174 696f 6e2f 220a  dministration/".
-0004a6d0: 2020 2020 2020 2020 2261 646d 696e 5f61          "admin_a
-0004a6e0: 7069 2f2c 2065 7463 2e20 220a 2020 2020  pi/, etc. ".    
-0004a6f0: 2020 2020 2245 6163 6820 5245 5354 2063      "Each REST c
-0004a700: 616c 6c20 7265 7175 6972 6573 2065 7861  all requires exa
-0004a710: 6374 6c79 2033 2061 7267 756d 656e 7473  ctly 3 arguments
-0004a720: 2e20 220a 2020 2020 2020 2020 2253 6f2c  . ".        "So,
-0004a730: 2074 6865 2074 6f74 616c 206e 756d 6265   the total numbe
-0004a740: 7220 6f66 2061 7267 756d 656e 7473 2075  r of arguments u
-0004a750: 7365 6420 7769 7468 202d 2d72 6573 7420  sed with --rest 
-0004a760: 6d75 7374 2062 6520 6120 220a 2020 2020  must be a ".    
-0004a770: 2020 2020 226d 756c 7469 706c 6520 6f66      "multiple of
-0004a780: 2033 2e20 5468 6520 6172 6775 6d65 6e74   3. The argument
-0004a790: 2074 7269 706c 6573 2061 7265 3a20 220a   triples are: ".
-0004a7a0: 2020 2020 2020 2020 2228 6129 2074 6865          "(a) the
-0004a7b0: 206d 6574 686f 642c 2061 2073 7472 696e   method, a strin
-0004a7c0: 6720 6f66 2047 4554 2c20 504f 5354 2c20  g of GET, POST, 
-0004a7d0: 5055 542c 2044 454c 4554 452c 206f 7220  PUT, DELETE, or 
-0004a7e0: 4f50 5449 4f4e 532e 2022 0a20 2020 2020  OPTIONS. ".     
-0004a7f0: 2020 2022 2862 2920 6120 7374 7269 6e67     "(b) a string
-0004a800: 2063 6f6e 7461 696e 696e 6720 7468 6520   containing the 
-0004a810: 6461 7461 2028 6966 2061 6e79 2920 696e  data (if any) in
-0004a820: 204a 534f 4e20 666f 726d 6174 2e20 220a   JSON format. ".
-0004a830: 2020 2020 2020 2020 2228 6329 2061 2073          "(c) a s
-0004a840: 7472 696e 6720 636f 6e74 6169 6e69 6e67  tring containing
-0004a850: 2074 6865 2055 524c 2e20 416c 6c20 7374   the URL. All st
-0004a860: 7269 6e67 7320 6d75 7374 2062 6520 5554  rings must be UT
-0004a870: 462d 382e 2022 0a20 2020 2020 2020 2022  F-8. ".        "
-0004a880: 5468 6572 6520 6172 6520 6120 6665 7720  There are a few 
-0004a890: 706c 6163 6568 6f6c 6465 7273 2e20 5468  placeholders. Th
-0004a8a0: 6579 2061 7265 3a20 220a 2020 2020 2020  ey are: ".      
-0004a8b0: 2020 225f 5f68 6f6d 6573 6572 7665 725f    "__homeserver_
-0004a8c0: 5f20 286c 696b 6520 6874 7470 733a 2f2f  _ (like https://
-0004a8d0: 6d61 7472 6978 2e65 7861 6d70 6c65 2e6f  matrix.example.o
-0004a8e0: 7267 292c 2022 0a20 2020 2020 2020 2022  rg), ".        "
-0004a8f0: 5f5f 686f 7374 6e61 6d65 5f5f 2028 6c69  __hostname__ (li
-0004a900: 6b65 206d 6174 7269 782e 6578 616d 706c  ke matrix.exampl
-0004a910: 652e 6f72 6729 2c20 220a 2020 2020 2020  e.org), ".      
-0004a920: 2020 225f 5f61 6363 6573 735f 746f 6b65    "__access_toke
-0004a930: 6e5f 5f2c 205f 5f75 7365 725f 6964 5f5f  n__, __user_id__
-0004a940: 2028 6c69 6b65 2040 6d63 3a6d 6174 7269   (like @mc:matri
-0004a950: 782e 6578 616d 706c 652e 636f 6d29 2c20  x.example.com), 
-0004a960: 220a 2020 2020 2020 2020 225f 5f64 6576  ".        "__dev
-0004a970: 6963 655f 6964 5f5f 2c20 616e 6420 5f5f  ice_id__, and __
-0004a980: 726f 6f6d 5f69 645f 5f2e 2049 6620 6120  room_id__. If a 
-0004a990: 706c 6163 6568 6f6c 6465 7220 6973 2066  placeholder is f
-0004a9a0: 6f75 6e64 2069 7420 6973 2022 0a20 2020  ound it is ".   
-0004a9b0: 2020 2020 2022 7265 706c 6163 6564 2077       "replaced w
-0004a9c0: 6974 6820 7468 6520 7661 6c75 6520 6672  ith the value fr
-0004a9d0: 6f6d 2074 6865 206c 6f63 616c 2063 7265  om the local cre
-0004a9e0: 6465 6e74 6961 6c73 2066 696c 652e 2022  dentials file. "
-0004a9f0: 0a20 2020 2020 2020 2022 416e 2065 7861  .        "An exa
-0004aa00: 6d70 6c65 2077 6f75 6c64 2062 653a 2022  mple would be: "
-0004aa10: 0a20 2020 2020 2020 2022 2d2d 7265 7374  .        "--rest
-0004aa20: 2027 4745 5427 2027 2720 275f 5f68 6f6d   'GET' '' '__hom
-0004aa30: 6573 6572 7665 725f 5f2f 5f6d 6174 7269  eserver__/_matri
-0004aa40: 782f 636c 6965 6e74 2f76 6572 7369 6f6e  x/client/version
-0004aa50: 7327 2e20 220a 2020 2020 2020 2020 2249  s'. ".        "I
-0004aa60: 6620 7468 6572 6520 6973 206e 6f20 6461  f there is no da
-0004aa70: 7461 2c20 692e 652e 2064 6174 6120 2862  ta, i.e. data (b
-0004aa80: 2920 6973 2065 6d70 7479 2c20 7468 656e  ) is empty, then
-0004aa90: 2075 7365 2027 2720 666f 7220 6974 2e20   use '' for it. 
-0004aaa0: 220a 2020 2020 2020 2020 224f 7074 696f  ".        "Optio
-0004aab0: 6e61 6c6c 792c 202d 2d61 6363 6573 732d  nally, --access-
-0004aac0: 746f 6b65 6e20 6361 6e20 6265 2075 7365  token can be use
-0004aad0: 6420 746f 206f 7665 7277 7269 7465 2074  d to overwrite t
-0004aae0: 6865 2022 0a20 2020 2020 2020 2022 6163  he ".        "ac
-0004aaf0: 6365 7373 2074 6f6b 656e 2066 726f 6d20  cess token from 
-0004ab00: 6372 6564 656e 7469 616c 7320 2869 6620  credentials (if 
-0004ab10: 6e65 6564 6564 292e 2022 0a20 2020 2020  needed). ".     
-0004ab20: 2020 2022 5365 6520 7465 7374 732f 7465     "See tests/te
-0004ab30: 7374 2d72 6573 742e 7368 2066 6f72 2061  st-rest.sh for a
-0004ab40: 6e20 6578 616d 706c 652e 222c 0a20 2020  n example.",.   
-0004ab50: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
-0004ab60: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
-0004ab70: 222d 2d73 6574 2d61 7661 7461 7222 2c0a  "--set-avatar",.
-0004ab80: 2020 2020 2020 2020 7265 7175 6972 6564          required
-0004ab90: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-0004aba0: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
-0004abb0: 2020 6d65 7461 7661 723d 2241 5641 5441    metavar="AVATA
-0004abc0: 525f 4d58 435f 5552 4922 2c0a 2020 2020  R_MXC_URI",.    
-0004abd0: 2020 2020 2320 6465 6661 756c 7473 2074      # defaults t
-0004abe0: 6f20 4e6f 6e65 2069 6620 6e6f 7420 7573  o None if not us
-0004abf0: 6564 2c20 6973 2073 7472 2069 6620 7573  ed, is str if us
-0004ac00: 6564 0a20 2020 2020 2020 2068 656c 703d  ed.        help=
-0004ac10: 2253 6574 2079 6f75 7220 6176 6174 6172  "Set your avatar
-0004ac20: 2e20 220a 2020 2020 2020 2020 6622 4465  . ".        f"De
-0004ac30: 7461 696c 733a 3a20 5365 7420 7468 6520  tails:: Set the 
-0004ac40: 6176 6174 6172 204d 5843 2072 6573 6f75  avatar MXC resou
-0004ac50: 7263 6520 7573 6564 2062 7920 7b50 524f  rce used by {PRO
-0004ac60: 475f 5749 5448 4f55 545f 4558 547d 2e20  G_WITHOUT_EXT}. 
-0004ac70: 220a 2020 2020 2020 2020 2250 726f 7669  ".        "Provi
-0004ac80: 6465 206f 6e65 204d 5843 2055 5249 2074  de one MXC URI t
-0004ac90: 6861 7420 6c6f 6f6b 7320 6c69 6b65 2074  hat looks like t
-0004aca0: 6869 7320 220a 2020 2020 2020 2020 2227  his ".        "'
-0004acb0: 6d78 633a 2f2f 6578 616d 706c 652e 636f  mxc://example.co
-0004acc0: 6d2f 536f 6d65 5374 7261 6e67 6555 7269  m/SomeStrangeUri
-0004acd0: 4b65 7927 2e22 2c0a 2020 2020 290a 2020  Key'.",.    ).  
-0004ace0: 2020 6170 2e61 6464 5f61 7267 756d 656e    ap.add_argumen
-0004acf0: 7428 0a20 2020 2020 2020 2022 2d2d 6765  t(.        "--ge
-0004ad00: 742d 6176 6174 6172 222c 0a20 2020 2020  t-avatar",.     
-0004ad10: 2020 2072 6571 7569 7265 643d 4661 6c73     required=Fals
-0004ad20: 652c 0a20 2020 2020 2020 2061 6374 696f  e,.        actio
-0004ad30: 6e3d 2265 7874 656e 6422 2c0a 2020 2020  n="extend",.    
-0004ad40: 2020 2020 6e61 7267 733d 222a 222c 2020      nargs="*",  
-0004ad50: 2320 4e6f 6e65 2069 6620 6e6f 7420 7573  # None if not us
-0004ad60: 6564 2c20 5b5d 2069 7320 7573 6564 2077  ed, [] is used w
-0004ad70: 6974 686f 7574 2065 7874 7261 2061 7267  ithout extra arg
-0004ad80: 730a 2020 2020 2020 2020 7479 7065 3d73  s.        type=s
-0004ad90: 7472 2c0a 2020 2020 2020 2020 6d65 7461  tr,.        meta
-0004ada0: 7661 723d 2255 5345 5222 2c0a 2020 2020  var="USER",.    
-0004adb0: 2020 2020 6865 6c70 3d22 4765 7420 616e      help="Get an
-0004adc0: 2061 7661 7461 722e 2022 0a20 2020 2020   avatar. ".     
-0004add0: 2020 2066 2244 6574 6169 6c73 3a3a 2047     f"Details:: G
-0004ade0: 6574 2074 6865 2061 7661 7461 7220 4d58  et the avatar MX
-0004adf0: 4320 7265 736f 7572 6365 2075 7365 6420  C resource used 
-0004ae00: 6279 207b 5052 4f47 5f57 4954 484f 5554  by {PROG_WITHOUT
-0004ae10: 5f45 5854 7d2c 2022 0a20 2020 2020 2020  _EXT}, ".       
-0004ae20: 2022 6f72 206f 6e65 206f 7220 6d75 6c74   "or one or mult
-0004ae30: 6970 6c65 206f 7468 6572 2075 7365 7273  iple other users
-0004ae40: 2e20 5370 6563 6966 7920 7a65 726f 206f  . Specify zero o
-0004ae50: 7220 6d6f 7265 2075 7365 7220 6964 732e  r more user ids.
-0004ae60: 2022 0a20 2020 2020 2020 2066 2249 6620   ".        f"If 
-0004ae70: 6e6f 2075 7365 7220 6964 2069 7320 7370  no user id is sp
-0004ae80: 6563 6966 6965 642c 2074 6865 2061 7661  ecified, the ava
-0004ae90: 7461 7220 6f66 207b 5052 4f47 5f57 4954  tar of {PROG_WIT
-0004aea0: 484f 5554 5f45 5854 7d20 7769 6c6c 2022  HOUT_EXT} will "
-0004aeb0: 0a20 2020 2020 2020 2022 6265 2066 6574  .        "be fet
-0004aec0: 6368 6564 2e20 4966 206f 6e65 206f 7220  ched. If one or 
-0004aed0: 6d6f 7265 2075 7365 7220 6964 7320 6172  more user ids ar
-0004aee0: 6520 6769 7665 6e2c 2074 6865 2061 7661  e given, the ava
-0004aef0: 7461 7273 206f 6620 220a 2020 2020 2020  tars of ".      
-0004af00: 2020 2274 6865 7365 2075 7365 7273 2077    "these users w
-0004af10: 696c 6c20 6265 2066 6574 6368 6564 2e20  ill be fetched. 
-0004af20: 4173 2072 6573 706f 6e73 6520 626f 7468  As response both
-0004af30: 204d 5843 2055 5249 2061 7320 7765 6c6c   MXC URI as well
-0004af40: 2061 7320 5552 4c20 220a 2020 2020 2020   as URL ".      
-0004af50: 2020 2277 696c 6c20 6265 2070 7269 6e74    "will be print
-0004af60: 6564 2e22 2c0a 2020 2020 290a 2020 2020  ed.",.    ).    
-0004af70: 6170 2e61 6464 5f61 7267 756d 656e 7428  ap.add_argument(
-0004af80: 0a20 2020 2020 2020 2022 2d2d 6765 742d  .        "--get-
-0004af90: 7072 6f66 696c 6522 2c0a 2020 2020 2020  profile",.      
-0004afa0: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
-0004afb0: 2c0a 2020 2020 2020 2020 6163 7469 6f6e  ,.        action
-0004afc0: 3d22 6578 7465 6e64 222c 0a20 2020 2020  ="extend",.     
-0004afd0: 2020 206e 6172 6773 3d22 2a22 2c20 2023     nargs="*",  #
-0004afe0: 204e 6f6e 6520 6966 206e 6f74 2075 7365   None if not use
-0004aff0: 642c 205b 5d20 6973 2075 7365 6420 7769  d, [] is used wi
-0004b000: 7468 6f75 7420 6578 7472 6120 6172 6773  thout extra args
-0004b010: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
-0004b020: 722c 0a20 2020 2020 2020 206d 6574 6176  r,.        metav
-0004b030: 6172 3d22 5553 4552 222c 0a20 2020 2020  ar="USER",.     
-0004b040: 2020 2068 656c 703d 2247 6574 2061 2075     help="Get a u
-0004b050: 7365 7220 7072 6f66 696c 652e 2022 0a20  ser profile. ". 
-0004b060: 2020 2020 2020 2066 2244 6574 6169 6c73         f"Details
-0004b070: 3a3a 2047 6574 2074 6865 2075 7365 7220  :: Get the user 
-0004b080: 7072 6f66 696c 6520 7573 6564 2062 7920  profile used by 
-0004b090: 7b50 524f 475f 5749 5448 4f55 545f 4558  {PROG_WITHOUT_EX
-0004b0a0: 547d 2c20 6f72 2022 0a20 2020 2020 2020  T}, or ".       
-0004b0b0: 2022 6f6e 6520 6f72 206d 756c 7469 706c   "one or multipl
-0004b0c0: 6520 6f74 6865 7220 7573 6572 732e 2053  e other users. S
-0004b0d0: 7065 6369 6679 207a 6572 6f20 6f72 206d  pecify zero or m
-0004b0e0: 6f72 6520 7573 6572 2069 6473 2e20 220a  ore user ids. ".
-0004b0f0: 2020 2020 2020 2020 6622 4966 206e 6f20          f"If no 
-0004b100: 7573 6572 2069 6420 6973 2073 7065 6369  user id is speci
-0004b110: 6669 6564 2c20 7468 6520 7573 6572 2070  fied, the user p
-0004b120: 726f 6669 6c65 206f 6620 7b50 524f 475f  rofile of {PROG_
-0004b130: 5749 5448 4f55 545f 4558 547d 2022 0a20  WITHOUT_EXT} ". 
-0004b140: 2020 2020 2020 2022 7769 6c6c 2062 6520         "will be 
-0004b150: 6665 7463 6865 642e 2049 6620 6f6e 6520  fetched. If one 
-0004b160: 6f72 206d 6f72 6520 7573 6572 2069 6473  or more user ids
-0004b170: 2061 7265 2067 6976 656e 2c20 7468 6520   are given, the 
-0004b180: 7573 6572 2022 0a20 2020 2020 2020 2022  user ".        "
-0004b190: 7072 6f66 696c 6573 206f 6620 7468 6573  profiles of thes
-0004b1a0: 6520 7573 6572 7320 7769 6c6c 2062 6520  e users will be 
-0004b1b0: 6665 7463 6865 642e 2041 7320 7265 7370  fetched. As resp
-0004b1c0: 6f6e 7365 2022 0a20 2020 2020 2020 2022  onse ".        "
-0004b1d0: 6469 7370 6c61 7920 6e61 6d65 2061 6e64  display name and
-0004b1e0: 2061 7661 7461 7220 4d58 4320 5552 4920   avatar MXC URI 
-0004b1f0: 6173 2077 656c 6c20 6173 2070 6f73 7369  as well as possi
-0004b200: 626c 6520 6164 6469 7469 6f6e 616c 2022  ble additional "
-0004b210: 0a20 2020 2020 2020 2022 7072 6f66 696c  .        "profil
-0004b220: 6520 696e 666f 726d 6174 696f 6e20 2869  e information (i
-0004b230: 6620 7072 6573 656e 7429 2022 0a20 2020  f present) ".   
-0004b240: 2020 2020 2022 7769 6c6c 2062 6520 7072       "will be pr
-0004b250: 696e 7465 642e 204f 6e65 206c 696e 6520  inted. One line 
-0004b260: 7065 7220 7573 6572 2077 696c 6c20 6265  per user will be
-0004b270: 2070 7269 6e74 6564 2e22 2c0a 2020 2020   printed.",.    
-0004b280: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
-0004b290: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
-0004b2a0: 2d2d 6765 742d 726f 6f6d 2d69 6e66 6f22  --get-room-info"
-0004b2b0: 2c0a 2020 2020 2020 2020 7265 7175 6972  ,.        requir
-0004b2c0: 6564 3d46 616c 7365 2c0a 2020 2020 2020  ed=False,.      
-0004b2d0: 2020 6163 7469 6f6e 3d22 6578 7465 6e64    action="extend
-0004b2e0: 222c 0a20 2020 2020 2020 206e 6172 6773  ",.        nargs
-0004b2f0: 3d22 2a22 2c20 2023 204e 6f6e 6520 6966  ="*",  # None if
-0004b300: 206e 6f74 2075 7365 642c 205b 5d20 6973   not used, [] is
-0004b310: 2075 7365 6420 7769 7468 6f75 7420 6578   used without ex
-0004b320: 7472 6120 6172 6773 0a20 2020 2020 2020  tra args.       
-0004b330: 2074 7970 653d 7374 722c 0a20 2020 2020   type=str,.     
-0004b340: 2020 206d 6574 6176 6172 3d22 524f 4f4d     metavar="ROOM
-0004b350: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
-0004b360: 2247 6574 2074 6865 2072 6f6f 6d20 696e  "Get the room in
-0004b370: 666f 726d 6174 696f 6e2e 2022 0a20 2020  formation. ".   
-0004b380: 2020 2020 2022 4465 7461 696c 733a 3a20       "Details:: 
-0004b390: 4765 7420 7468 6520 726f 6f6d 2069 6e66  Get the room inf
-0004b3a0: 6f72 6d61 7469 6f6e 2073 7563 6820 6173  ormation such as
-0004b3b0: 2072 6f6f 6d20 6469 7370 6c61 7920 6e61   room display na
-0004b3c0: 6d65 2c20 220a 2020 2020 2020 2020 2272  me, ".        "r
-0004b3d0: 6f6f 6d20 616c 6961 732c 2072 6f6f 6d20  oom alias, room 
-0004b3e0: 6372 6561 746f 722c 2065 7463 2e20 666f  creator, etc. fo
-0004b3f0: 7220 220a 2020 2020 2020 2020 226f 6e65  r ".        "one
-0004b400: 206f 7220 6d75 6c74 6970 6c65 2073 7065   or multiple spe
-0004b410: 6369 6669 6564 2072 6f6f 6d73 2e20 5468  cified rooms. Th
-0004b420: 6520 696e 636c 7564 6564 2072 6f6f 6d20  e included room 
-0004b430: 2764 6973 706c 6179 206e 616d 6527 2069  'display name' i
-0004b440: 7320 220a 2020 2020 2020 2020 2261 6c73  s ".        "als
-0004b450: 6f20 7265 6665 7272 6564 2074 6f20 6173  o referred to as
-0004b460: 2027 726f 6f6d 206e 616d 6527 206f 7220   'room name' or 
-0004b470: 696e 636f 7272 6563 746c 7920 6576 656e  incorrectly even
-0004b480: 2061 7320 726f 6f6d 2074 6974 6c65 2e20   as room title. 
-0004b490: 220a 2020 2020 2020 2020 2249 6620 6f6e  ".        "If on
-0004b4a0: 6520 6f72 206d 6f72 6520 726f 6f6d 2061  e or more room a
-0004b4b0: 7265 2067 6976 656e 2c20 7468 6520 726f  re given, the ro
-0004b4c0: 6f6d 2022 0a20 2020 2020 2020 2022 696e  om ".        "in
-0004b4d0: 666f 726d 6174 696f 6e73 206f 6620 7468  formations of th
-0004b4e0: 6573 6520 726f 6f6d 7320 7769 6c6c 2062  ese rooms will b
-0004b4f0: 6520 6665 7463 6865 642e 2022 0a20 2020  e fetched. ".   
-0004b500: 2020 2020 2022 4966 206e 6f20 726f 6f6d       "If no room
-0004b510: 2069 7320 7370 6563 6966 6965 642c 2074   is specified, t
-0004b520: 6865 2072 6f6f 6d20 696e 666f 726d 6174  he room informat
-0004b530: 696f 6e20 666f 7220 7468 6520 220a 2020  ion for the ".  
-0004b540: 2020 2020 2020 6622 6465 6661 756c 7420        f"default 
-0004b550: 726f 6f6d 2063 6f6e 6669 6775 7265 6420  room configured 
-0004b560: 666f 7220 7b50 524f 475f 5749 5448 4f55  for {PROG_WITHOU
-0004b570: 545f 4558 547d 2069 7320 6665 7463 6865  T_EXT} is fetche
-0004b580: 642e 2022 0a20 2020 2020 2020 2022 526f  d. ".        "Ro
-0004b590: 6f6d 7320 6361 6e20 6265 2067 6976 656e  oms can be given
-0004b5a0: 2076 6961 2022 0a20 2020 2020 2020 2022   via ".        "
-0004b5b0: 726f 6f6d 2069 6420 2865 2e67 2e20 275c  room id (e.g. '\
-0004b5c0: 5c21 536f 6d65 526f 6f6d 4964 3a6d 6174  \!SomeRoomId:mat
-0004b5d0: 7269 782e 6578 616d 706c 652e 636f 6d27  rix.example.com'
-0004b5e0: 292c 2022 0a20 2020 2020 2020 2022 6361  ), ".        "ca
-0004b5f0: 6e6f 6e69 6361 6c20 2866 756c 6c29 2072  nonical (full) r
-0004b600: 6f6f 6d20 616c 6961 7320 220a 2020 2020  oom alias ".    
-0004b610: 2020 2020 2228 652e 672e 2027 2353 6f6d      "(e.g. '#Som
-0004b620: 6552 6f6f 6d41 6c69 6173 3a6d 6174 7269  eRoomAlias:matri
-0004b630: 782e 6578 616d 706c 652e 636f 6d27 292c  x.example.com'),
-0004b640: 2022 0a20 2020 2020 2020 2022 6f72 2073   ".        "or s
-0004b650: 686f 7274 2061 6c69 6173 2028 652e 672e  hort alias (e.g.
-0004b660: 2027 536f 6d65 526f 6f6d 416c 6961 7327   'SomeRoomAlias'
-0004b670: 206f 7220 2723 536f 6d65 526f 6f6d 416c   or '#SomeRoomAl
-0004b680: 6961 7327 292e 2022 0a20 2020 2020 2020  ias'). ".       
-0004b690: 2022 4173 2072 6573 706f 6e73 6520 220a   "As response ".
-0004b6a0: 2020 2020 2020 2020 2272 6f6f 6d20 6964          "room id
-0004b6b0: 2c20 726f 6f6d 2064 6973 706c 6179 206e  , room display n
-0004b6c0: 616d 652c 2072 6f6f 6d20 6361 6e6f 6e69  ame, room canoni
-0004b6d0: 6361 6c20 616c 6961 732c 2072 6f6f 6d20  cal alias, room 
-0004b6e0: 746f 7069 632c 2022 0a20 2020 2020 2020  topic, ".       
-0004b6f0: 2022 726f 6f6d 2063 7265 6174 6f72 2c20   "room creator, 
-0004b700: 616e 6420 726f 6f6d 2065 6e63 7279 7074  and room encrypt
-0004b710: 696f 6e20 220a 2020 2020 2020 2020 2261  ion ".        "a
-0004b720: 7265 2070 7269 6e74 6564 2e20 4f6e 6520  re printed. One 
-0004b730: 6c69 6e65 2070 6572 2072 6f6f 6d20 7769  line per room wi
-0004b740: 6c6c 2062 6520 7072 696e 7465 642e 2022  ll be printed. "
-0004b750: 0a20 2020 2020 2020 2022 5369 6e63 6520  .        "Since 
-0004b760: 6569 7468 6572 2072 6f6f 6d20 6964 206f  either room id o
-0004b770: 7220 726f 6f6d 2061 6c69 6173 2061 7265  r room alias are
-0004b780: 2061 6363 6570 7465 6420 6173 2069 6e70   accepted as inp
-0004b790: 7574 2061 6e64 2062 6f74 6820 220a 2020  ut and both ".  
-0004b7a0: 2020 2020 2020 2272 6f6f 6d20 6964 2061        "room id a
-0004b7b0: 6e64 2072 6f6f 6d20 616c 6961 7320 6172  nd room alias ar
-0004b7c0: 6520 6769 7665 6e20 6173 206f 7574 7075  e given as outpu
-0004b7d0: 742c 206f 6e65 2063 616e 2068 656e 6365  t, one can hence
-0004b7e0: 2075 7365 2074 6869 7320 220a 2020 2020   use this ".    
-0004b7f0: 2020 2020 226f 7074 696f 6e20 746f 206d      "option to m
-0004b800: 6170 2066 726f 6d20 726f 6f6d 2069 6420  ap from room id 
-0004b810: 746f 2072 6f6f 6d20 616c 6961 7320 220a  to room alias ".
-0004b820: 2020 2020 2020 2020 2261 7320 7765 6c6c          "as well
-0004b830: 2061 7320 7669 6365 2076 6572 7361 2066   as vice versa f
-0004b840: 726f 6d20 726f 6f6d 2061 6c69 6173 2074  rom room alias t
-0004b850: 6f20 726f 6f6d 2069 642e 2022 0a20 2020  o room id. ".   
-0004b860: 2020 2020 2022 446f 206e 6f74 2063 6f6e       "Do not con
-0004b870: 6675 7365 2074 6869 7320 6f70 7469 6f6e  fuse this option
-0004b880: 2077 6974 6820 7468 6520 6f70 7469 6f6e   with the option
-0004b890: 7320 272d 2d67 6574 2d64 6973 706c 6179  s '--get-display
-0004b8a0: 2d6e 616d 6527 2022 0a20 2020 2020 2020  -name' ".       
-0004b8b0: 2022 616e 6420 272d 2d73 6574 2d64 6973   "and '--set-dis
-0004b8c0: 706c 6179 2d6e 616d 6527 2c20 7768 6963  play-name', whic
-0004b8d0: 6820 6765 742f 7365 7420 7468 6520 7573  h get/set the us
-0004b8e0: 6572 2064 6973 706c 6179 206e 616d 652c  er display name,
-0004b8f0: 206e 6f74 2022 0a20 2020 2020 2020 2022   not ".        "
-0004b900: 7468 6520 726f 6f6d 2064 6973 706c 6179  the room display
-0004b910: 206e 616d 652e 222c 0a20 2020 2029 0a20   name.",.    ). 
-0004b920: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
-0004b930: 6e74 280a 2020 2020 2020 2020 222d 2d67  nt(.        "--g
-0004b940: 6574 2d63 6c69 656e 742d 696e 666f 222c  et-client-info",
-0004b950: 0a20 2020 2020 2020 2072 6571 7569 7265  .        require
-0004b960: 643d 4661 6c73 652c 0a20 2020 2020 2020  d=False,.       
-0004b970: 2061 6374 696f 6e3d 2273 746f 7265 5f74   action="store_t
-0004b980: 7275 6522 2c0a 2020 2020 2020 2020 6865  rue",.        he
-0004b990: 6c70 3d22 5072 696e 7420 636c 6965 6e74  lp="Print client
-0004b9a0: 2069 6e66 6f72 6d61 7469 6f6e 2e20 220a   information. ".
-0004b9b0: 2020 2020 2020 2020 2244 6574 6169 6c73          "Details
-0004b9c0: 3a3a 2050 7269 6e74 2069 6e66 6f72 6d61  :: Print informa
-0004b9d0: 7469 6f6e 206b 6570 7420 696e 2074 6865  tion kept in the
-0004b9e0: 2063 6c69 656e 742c 2069 2e65 2e20 220a   client, i.e. ".
-0004b9f0: 2020 2020 2020 2020 6622 7b50 524f 475f          f"{PROG_
-0004ba00: 5749 5448 4f55 545f 4558 547d 2e20 220a  WITHOUT_EXT}. ".
-0004ba10: 2020 2020 2020 2020 224f 7574 7075 7420          "Output 
-0004ba20: 6973 2070 7269 6e74 6564 2069 6e20 4a53  is printed in JS
-0004ba30: 4f4e 2066 6f72 6d61 742e 222c 0a20 2020  ON format.",.   
-0004ba40: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
-0004ba50: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
-0004ba60: 222d 2d68 6173 2d70 6572 6d69 7373 696f  "--has-permissio
-0004ba70: 6e22 2c0a 2020 2020 2020 2020 7265 7175  n",.        requ
-0004ba80: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
-0004ba90: 2020 2020 6163 7469 6f6e 3d22 6578 7465      action="exte
-0004baa0: 6e64 222c 0a20 2020 2020 2020 206e 6172  nd",.        nar
-0004bab0: 6773 3d22 2b22 2c0a 2020 2020 2020 2020  gs="+",.        
-0004bac0: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
-0004bad0: 2020 6d65 7461 7661 723d 2252 4f4f 4d20    metavar="ROOM 
-0004bae0: 4241 4e7c 494e 5649 5445 7c4b 4943 4b7c  BAN|INVITE|KICK|
-0004baf0: 4e4f 5449 4649 4341 5449 4f4e 537c 5245  NOTIFICATIONS|RE
-0004bb00: 4441 4354 7c65 7463 222c 0a20 2020 2020  DACT|etc",.     
-0004bb10: 2020 2068 656c 703d 2249 6e71 7569 7265     help="Inquire
-0004bb20: 2061 626f 7574 2070 6572 6d69 7373 696f   about permissio
-0004bb30: 6e73 2e20 220a 2020 2020 2020 2020 6622  ns. ".        f"
-0004bb40: 4465 7461 696c 733a 3a20 496e 7175 6972  Details:: Inquir
-0004bb50: 6520 6966 2075 7365 7220 7573 6564 2062  e if user used b
-0004bb60: 7920 7b50 524f 475f 5749 5448 4f55 545f  y {PROG_WITHOUT_
-0004bb70: 4558 547d 2068 6173 2022 0a20 2020 2020  EXT} has ".     
-0004bb80: 2020 2022 7065 726d 6973 7369 6f6e 2066     "permission f
-0004bb90: 6f72 206f 6e65 206f 7220 6d75 6c74 6970  or one or multip
-0004bba0: 6c65 2061 6374 696f 6e73 2069 6e20 6f6e  le actions in on
-0004bbb0: 6520 6f72 206d 756c 7469 706c 6520 726f  e or multiple ro
-0004bbc0: 6f6d 732e 2022 0a20 2020 2020 2020 2022  oms. ".        "
-0004bbd0: 4561 6368 2069 6e71 7569 7279 2072 6571  Each inquiry req
-0004bbe0: 7569 7265 7320 3220 7061 7261 6d65 7465  uires 2 paramete
-0004bbf0: 7273 3a20 7468 6520 726f 6f6d 2069 6420  rs: the room id 
-0004bc00: 616e 6420 7468 6520 7065 726d 6973 7369  and the permissi
-0004bc10: 6f6e 2022 0a20 2020 2020 2020 2022 7479  on ".        "ty
-0004bc20: 7065 2e20 4f6e 6520 6f72 206d 756c 7469  pe. One or multi
-0004bc30: 706c 6520 6f66 2074 6865 7365 2070 6172  ple of these par
-0004bc40: 616d 6574 6572 2070 6169 7273 206d 6179  ameter pairs may
-0004bc50: 2062 6520 7370 6563 6966 6965 642e 2022   be specified. "
-0004bc60: 0a20 2020 2020 2020 2022 466f 7220 6561  .        "For ea
-0004bc70: 6368 2070 6172 616d 6574 6572 2070 6169  ch parameter pai
-0004bc80: 7220 7468 6572 6520 7769 6c6c 2062 6520  r there will be 
-0004bc90: 6f6e 6520 6c69 6e65 2070 7269 6e74 6564  one line printed
-0004bca0: 2074 6f20 7374 646f 7574 2e20 220a 2020   to stdout. ".  
-0004bcb0: 2020 2020 2020 2256 616c 7565 7320 666f        "Values fo
-0004bcc0: 7220 7468 6520 7065 726d 6973 7369 6f6e  r the permission
-0004bcd0: 2074 7970 6520 6172 6520 2762 616e 272c   type are 'ban',
-0004bce0: 2022 0a20 2020 2020 2020 2022 2769 6e76   ".        "'inv
-0004bcf0: 6974 6527 2c20 276b 6963 6b27 2c20 276e  ite', 'kick', 'n
-0004bd00: 6f74 6966 6963 6174 696f 6e73 272c 2027  otifications', '
-0004bd10: 7265 6461 6374 272c 2065 7463 2e20 220a  redact', etc. ".
-0004bd20: 2020 2020 2020 2020 2253 6565 2068 7474          "See htt
-0004bd30: 7073 3a2f 2f73 7065 632e 6d61 7472 6978  ps://spec.matrix
-0004bd40: 2e6f 7267 2f76 312e 322f 636c 6965 6e74  .org/v1.2/client
-0004bd50: 2d73 6572 7665 722d 6170 692f 236d 726f  -server-api/#mro
-0004bd60: 6f6d 706f 7765 725f 6c65 7665 6c73 220a  ompower_levels".
-0004bd70: 2020 2020 2020 2020 222e 222c 0a20 2020          ".",.   
-0004bd80: 2020 2020 2023 2027 6576 656e 7473 272c       # 'events',
-0004bd90: 2027 6576 656e 7473 5f64 6566 6175 6c74   'events_default
-0004bda0: 272c 2027 7374 6174 655f 6465 6661 756c  ', 'state_defaul
-0004bdb0: 7427 3a20 7661 6c69 6420 7065 726d 6973  t': valid permis
-0004bdc0: 7369 6f6e 2074 7970 6573 3f0a 2020 2020  sion types?.    
-0004bdd0: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
-0004bde0: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
-0004bdf0: 2d2d 696d 706f 7274 2d6b 6579 7322 2c0a  --import-keys",.
-0004be00: 2020 2020 2020 2020 7265 7175 6972 6564          required
-0004be10: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-0004be20: 6163 7469 6f6e 3d22 6578 7465 6e64 222c  action="extend",
-0004be30: 0a20 2020 2020 2020 206e 6172 6773 3d32  .        nargs=2
-0004be40: 2c20 2023 2066 696c 656e 616d 6520 666f  ,  # filename fo
-0004be50: 7220 696d 706f 7274 2c20 7061 7373 7068  r import, passph
-0004be60: 7261 7365 0a20 2020 2020 2020 2074 7970  rase.        typ
-0004be70: 653d 7374 722c 0a20 2020 2020 2020 206d  e=str,.        m
-0004be80: 6574 6176 6172 3d22 4649 4c45 2050 4153  etavar="FILE PAS
-0004be90: 5350 4852 4153 4522 2c0a 2020 2020 2020  SPHRASE",.      
-0004bea0: 2020 6865 6c70 3d22 496d 706f 7274 204d    help="Import M
-0004beb0: 6567 6f6c 6d20 6465 6372 7970 7469 6f6e  egolm decryption
-0004bec0: 206b 6579 7320 6672 6f6d 2061 2066 696c   keys from a fil
-0004bed0: 652e 2022 0a20 2020 2020 2020 2022 4465  e. ".        "De
-0004bee0: 7461 696c 733a 3a20 5468 6973 2069 7320  tails:: This is 
-0004bef0: 616e 206f 7074 696f 6e61 6c20 6172 6775  an optional argu
-0004bf00: 6d65 6e74 2e20 4966 2075 7365 6420 6974  ment. If used it
-0004bf10: 206d 7573 7420 6265 2066 6f6c 6c6f 7765   must be followe
-0004bf20: 6420 220a 2020 2020 2020 2020 2262 7920  d ".        "by 
-0004bf30: 7477 6f20 7661 6c75 6573 2e20 2861 2920  two values. (a) 
-0004bf40: 6120 6669 6c65 206e 616d 6520 6672 6f6d  a file name from
-0004bf50: 2077 6869 6368 2074 6865 206b 6579 7320   which the keys 
-0004bf60: 7769 6c6c 2062 6520 7265 6164 2e20 220a  will be read. ".
-0004bf70: 2020 2020 2020 2020 2228 6229 2061 2070          "(b) a p
-0004bf80: 6173 7370 6872 6173 6520 7769 7468 2077  assphrase with w
-0004bf90: 6869 6368 2074 6865 2066 696c 6520 6361  hich the file ca
-0004bfa0: 6e20 6265 2064 6563 7279 7074 6564 2077  n be decrypted w
-0004bfb0: 6974 682e 2022 0a20 2020 2020 2020 2022  ith. ".        "
-0004bfc0: 5468 6520 6b65 7973 2077 696c 6c20 6265  The keys will be
-0004bfd0: 2061 6464 6564 2074 6f20 7468 6520 6375   added to the cu
-0004bfe0: 7272 656e 7420 696e 7374 616e 6365 2061  rrent instance a
-0004bff0: 7320 7765 6c6c 2061 7320 220a 2020 2020  s well as ".    
-0004c000: 2020 2020 2277 7269 7474 656e 2074 6f20      "written to 
-0004c010: 7468 6520 6461 7461 6261 7365 2e20 5365  the database. Se
-0004c020: 6520 616c 736f 202d 2d65 7870 6f72 742d  e also --export-
-0004c030: 6b65 7973 2e22 2c0a 2020 2020 290a 2020  keys.",.    ).  
-0004c040: 2020 6170 2e61 6464 5f61 7267 756d 656e    ap.add_argumen
-0004c050: 7428 0a20 2020 2020 2020 2022 2d2d 6578  t(.        "--ex
-0004c060: 706f 7274 2d6b 6579 7322 2c0a 2020 2020  port-keys",.    
-0004c070: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
-0004c080: 7365 2c0a 2020 2020 2020 2020 6163 7469  se,.        acti
-0004c090: 6f6e 3d22 6578 7465 6e64 222c 0a20 2020  on="extend",.   
-0004c0a0: 2020 2020 206e 6172 6773 3d32 2c20 2023       nargs=2,  #
-0004c0b0: 2066 696c 656e 616d 6520 666f 7220 6578   filename for ex
-0004c0c0: 706f 7274 2c20 7061 7373 7068 7261 7365  port, passphrase
-0004c0d0: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
-0004c0e0: 722c 0a20 2020 2020 2020 206d 6574 6176  r,.        metav
-0004c0f0: 6172 3d22 4649 4c45 2050 4153 5350 4852  ar="FILE PASSPHR
-0004c100: 4153 4522 2c0a 2020 2020 2020 2020 6865  ASE",.        he
-0004c110: 6c70 3d22 4578 706f 7274 2061 6c6c 2074  lp="Export all t
-0004c120: 6865 204d 6567 6f6c 6d20 6465 6372 7970  he Megolm decryp
-0004c130: 7469 6f6e 206b 6579 7320 6f66 2074 6869  tion keys of thi
-0004c140: 7320 6465 7669 6365 2e20 220a 2020 2020  s device. ".    
-0004c150: 2020 2020 2244 6574 6169 6c73 3a3a 2054      "Details:: T
-0004c160: 6869 7320 6973 2061 6e20 6f70 7469 6f6e  his is an option
-0004c170: 616c 2061 7267 756d 656e 742e 2049 6620  al argument. If 
-0004c180: 7573 6564 2069 7420 6d75 7374 2062 6520  used it must be 
-0004c190: 666f 6c6c 6f77 6564 2022 0a20 2020 2020  followed ".     
-0004c1a0: 2020 2022 6279 2074 776f 2076 616c 7565     "by two value
-0004c1b0: 732e 2028 6129 2061 2066 696c 6520 6e61  s. (a) a file na
-0004c1c0: 6d65 2074 6f20 7768 6963 6820 7468 6520  me to which the 
-0004c1d0: 6b65 7973 2077 696c 6c20 6265 2077 7269  keys will be wri
-0004c1e0: 7474 656e 2074 6f2e 2022 0a20 2020 2020  tten to. ".     
-0004c1f0: 2020 2022 2862 2920 6120 7061 7373 7068     "(b) a passph
-0004c200: 7261 7365 2077 6974 6820 7768 6963 6820  rase with which 
-0004c210: 7468 6520 6669 6c65 2077 696c 6c20 6265  the file will be
-0004c220: 2065 6e63 7279 7074 6564 2077 6974 682e   encrypted with.
-0004c230: 2022 0a20 2020 2020 2020 2022 4e6f 7465   ".        "Note
-0004c240: 2074 6861 7420 7468 6973 2064 6f65 7320   that this does 
-0004c250: 6e6f 7420 7361 7665 206f 7468 6572 2069  not save other i
-0004c260: 6e66 6f72 6d61 7469 6f6e 2073 7563 6820  nformation such 
-0004c270: 6173 2074 6865 2070 7269 7661 7465 2022  as the private "
-0004c280: 0a20 2020 2020 2020 2022 6964 656e 7469  .        "identi
-0004c290: 7479 206b 6579 7320 6f66 2074 6865 2064  ty keys of the d
-0004c2a0: 6576 6963 652e 222c 0a20 2020 2029 0a20  evice.",.    ). 
-0004c2b0: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
-0004c2c0: 6e74 280a 2020 2020 2020 2020 222d 2d72  nt(.        "--r
-0004c2d0: 6f6f 6d2d 7365 742d 616c 6961 7322 2c0a  oom-set-alias",.
-0004c2e0: 2020 2020 2020 2020 222d 2d72 6f6f 6d2d          "--room-
-0004c2f0: 7075 742d 616c 6961 7322 2c20 2023 206e  put-alias",  # n
-0004c300: 616d 6520 7573 6564 2062 7920 6e69 6f0a  ame used by nio.
-0004c310: 2020 2020 2020 2020 7265 7175 6972 6564          required
-0004c320: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-0004c330: 6163 7469 6f6e 3d22 6578 7465 6e64 222c  action="extend",
-0004c340: 0a20 2020 2020 2020 206e 6172 6773 3d22  .        nargs="
-0004c350: 2b22 2c0a 2020 2020 2020 2020 7479 7065  +",.        type
-0004c360: 3d73 7472 2c0a 2020 2020 2020 2020 6d65  =str,.        me
-0004c370: 7461 7661 723d 2252 4f4f 4d5f 414c 4941  tavar="ROOM_ALIA
-0004c380: 5320 524f 4f4d 222c 0a20 2020 2020 2020  S ROOM",.       
-0004c390: 2068 656c 703d 2241 6464 2061 6c69 6173   help="Add alias
-0004c3a0: 6573 2074 6f20 726f 6f6d 732e 2022 0a20  es to rooms. ". 
-0004c3b0: 2020 2020 2020 2022 4465 7461 696c 733a         "Details:
-0004c3c0: 3a20 4164 6420 616e 2061 6c69 6173 2074  : Add an alias t
-0004c3d0: 6f20 6120 726f 6f6d 2c20 6f72 2061 6c69  o a room, or ali
-0004c3e0: 6173 6573 2074 6f20 6d75 6c74 6970 6c65  ases to multiple
-0004c3f0: 2072 6f6f 6d73 2e20 220a 2020 2020 2020   rooms. ".      
-0004c400: 2020 2250 726f 7669 6465 2070 6169 7273    "Provide pairs
-0004c410: 206f 6620 6172 6775 6d65 6e74 732e 2049   of arguments. I
-0004c420: 6e20 6561 6368 2070 6169 722c 2074 6865  n each pair, the
-0004c430: 2066 6972 7374 2061 7267 756d 656e 7420   first argument 
-0004c440: 6d75 7374 2062 6520 220a 2020 2020 2020  must be ".      
-0004c450: 2020 2274 6865 2061 6c69 6173 2079 6f75    "the alias you
-0004c460: 2077 616e 7420 746f 2061 7373 6967 6e20   want to assign 
-0004c470: 746f 2074 6865 2072 6f6f 6d20 6769 7665  to the room give
-0004c480: 6e20 7669 6120 726f 6f6d 2069 6420 696e  n via room id in
-0004c490: 2074 6865 2022 0a20 2020 2020 2020 2022   the ".        "
-0004c4a0: 7365 636f 6e64 2061 7267 756d 656e 7420  second argument 
-0004c4b0: 6f66 2074 6865 2070 6169 722e 2045 2e67  of the pair. E.g
-0004c4c0: 2e20 7468 6520 3420 6172 6775 6d65 6e74  . the 4 argument
-0004c4d0: 7320 2761 3120 7231 2061 3220 7232 2720  s 'a1 r1 a2 r2' 
-0004c4e0: 220a 2020 2020 2020 2020 2277 6f75 6c64  ".        "would
-0004c4f0: 2061 7373 6967 6e20 7468 6520 616c 6961   assign the alia
-0004c500: 7320 2761 3127 2074 6f20 726f 6f6d 2027  s 'a1' to room '
-0004c510: 7231 2720 616e 6420 7468 6520 616c 6961  r1' and the alia
-0004c520: 7320 2761 3227 2074 6f20 726f 6f6d 2022  s 'a2' to room "
-0004c530: 0a20 2020 2020 2020 2022 2772 3227 2e20  .        "'r2'. 
-0004c540: 4966 2079 6f75 206a 7573 7420 6861 7665  If you just have
-0004c550: 206f 6e65 2073 696e 676c 6520 7061 6972   one single pair
-0004c560: 2074 6865 6e20 7468 6520 7365 636f 6e64   then the second
-0004c570: 2061 7267 756d 656e 7420 6973 2022 0a20   argument is ". 
-0004c580: 2020 2020 2020 2022 6f70 7469 6f6e 616c         "optional
-0004c590: 2e20 4966 206a 7573 7420 6120 7369 6e67  . If just a sing
-0004c5a0: 6c65 2076 616c 7565 2069 7320 6769 7665  le value is give
-0004c5b0: 6e20 2861 6e20 616c 6961 7329 2074 6865  n (an alias) the
-0004c5c0: 6e20 7468 6973 2022 0a20 2020 2020 2020  n this ".       
-0004c5d0: 2022 616c 6961 7320 6973 2061 7373 6967   "alias is assig
-0004c5e0: 6e65 6420 746f 2074 6865 2064 6566 6175  ned to the defau
-0004c5f0: 6c74 2072 6f6f 6d20 6f66 2022 0a20 2020  lt room of ".   
-0004c600: 2020 2020 2066 227b 5052 4f47 5f57 4954       f"{PROG_WIT
-0004c610: 484f 5554 5f45 5854 7d20 2861 7320 666f  HOUT_EXT} (as fo
-0004c620: 756e 6420 696e 2063 7265 6465 6e74 6961  und in credentia
-0004c630: 6c73 2066 696c 6529 2e20 496e 2073 686f  ls file). In sho
-0004c640: 7274 2c20 220a 2020 2020 2020 2020 2279  rt, ".        "y
-0004c650: 6f75 2063 616e 2068 6176 6520 6a75 7374  ou can have just
-0004c660: 2061 2073 696e 676c 6520 6172 6775 6d65   a single argume
-0004c670: 6e74 206f 7220 616e 2065 7665 6e20 6e75  nt or an even nu
-0004c680: 6d62 6572 206f 6620 6172 6775 6d65 6e74  mber of argument
-0004c690: 7320 220a 2020 2020 2020 2020 2266 6f72  s ".        "for
-0004c6a0: 6d69 6e67 2070 6169 7273 2e20 596f 7520  ming pairs. You 
-0004c6b0: 6361 6e20 6861 7665 206d 756c 7469 706c  can have multipl
-0004c6c0: 6520 726f 6f6d 2061 6c69 6173 6573 2070  e room aliases p
-0004c6d0: 6572 2072 6f6f 6d2e 2053 6f2c 2022 0a20  er room. So, ". 
-0004c6e0: 2020 2020 2020 2022 796f 7520 6d61 7920         "you may 
-0004c6f0: 6164 6420 6d75 6c74 6970 6c65 2061 6c69  add multiple ali
-0004c700: 6173 6573 2074 6f20 7468 6520 7361 6d65  ases to the same
-0004c710: 2072 6f6f 6d2e 2022 0a20 2020 2020 2020   room. ".       
-0004c720: 2022 4120 726f 6f6d 2061 6c69 6173 206c   "A room alias l
-0004c730: 6f6f 6b73 206c 696b 6520 7468 6973 3a20  ooks like this: 
-0004c740: 220a 2020 2020 2020 2020 2227 2373 6f6d  ".        "'#som
-0004c750: 6552 6f6f 6d41 6c69 6173 3a6d 6174 7269  eRoomAlias:matri
-0004c760: 782e 6578 616d 706c 652e 6f72 6727 2e20  x.example.org'. 
-0004c770: 5368 6f72 7420 616c 6961 7365 7320 6c69  Short aliases li
-0004c780: 6b65 2022 0a20 2020 2020 2020 2022 2773  ke ".        "'s
-0004c790: 6f6d 6552 6f6f 6d41 6c69 6173 2720 6f72  omeRoomAlias' or
-0004c7a0: 2027 2373 6f6d 6552 6f6f 6d41 6c69 6173   '#someRoomAlias
-0004c7b0: 2720 6172 6520 616c 736f 2061 6363 6570  ' are also accep
-0004c7c0: 7465 642e 2022 0a20 2020 2020 2020 2022  ted. ".        "
-0004c7d0: 496e 2063 6173 6520 6f66 2061 2073 686f  In case of a sho
-0004c7e0: 7274 2061 6c69 6173 2c20 220a 2020 2020  rt alias, ".    
-0004c7f0: 2020 2020 2269 7420 7769 6c6c 2062 6520      "it will be 
-0004c800: 6175 746f 6d61 7469 6361 6c6c 7920 7072  automatically pr
-0004c810: 6566 6978 6564 2077 6974 6820 2723 2720  efixed with '#' 
-0004c820: 616e 6420 7468 6520 220a 2020 2020 2020  and the ".      
-0004c830: 2020 2268 6f6d 6573 6572 7665 7220 7769    "homeserver wi
-0004c840: 6c6c 2062 6520 6175 746f 6d61 7469 6361  ll be automatica
-0004c850: 6c6c 7920 6170 7065 6e64 6564 2e20 220a  lly appended. ".
-0004c860: 2020 2020 2020 2020 2241 6464 696e 6720          "Adding 
-0004c870: 7468 6520 7361 6d65 2061 6c69 6173 2022  the same alias "
-0004c880: 0a20 2020 2020 2020 2022 6d75 6c74 6970  .        "multip
-0004c890: 6c65 2074 696d 6573 2074 6f20 7468 6520  le times to the 
-0004c8a0: 7361 6d65 2072 6f6f 6d20 7265 7375 6c74  same room result
-0004c8b0: 7320 696e 2061 6e20 6572 726f 722e 2022  s in an error. "
-0004c8c0: 0a20 2020 2020 2020 2022 2d2d 726f 6f6d  .        "--room
-0004c8d0: 2d70 7574 2d61 6c69 6173 2069 7320 6571  -put-alias is eq
-0004c8e0: 6976 616c 656e 7420 746f 202d 2d72 6f6f  ivalent to --roo
-0004c8f0: 6d2d 7365 742d 616c 6961 732e 222c 0a20  m-set-alias.",. 
-0004c900: 2020 2029 0a20 2020 2061 702e 6164 645f     ).    ap.add_
-0004c910: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
-0004c920: 2020 222d 2d72 6f6f 6d2d 7265 736f 6c76    "--room-resolv
-0004c930: 652d 616c 6961 7322 2c0a 2020 2020 2020  e-alias",.      
-0004c940: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
-0004c950: 2c0a 2020 2020 2020 2020 6163 7469 6f6e  ,.        action
-0004c960: 3d22 6578 7465 6e64 222c 0a20 2020 2020  ="extend",.     
-0004c970: 2020 206e 6172 6773 3d22 2b22 2c0a 2020     nargs="+",.  
-0004c980: 2020 2020 2020 7479 7065 3d73 7472 2c0a        type=str,.
-0004c990: 2020 2020 2020 2020 6d65 7461 7661 723d          metavar=
-0004c9a0: 2252 4f4f 4d5f 414c 4941 5322 2c0a 2020  "ROOM_ALIAS",.  
-0004c9b0: 2020 2020 2020 6865 6c70 3d22 5368 6f77        help="Show
-0004c9c0: 2072 6f6f 6d20 6964 7320 636f 7272 6573   room ids corres
-0004c9d0: 706f 6e64 696e 6720 746f 2072 6f6f 6d20  ponding to room 
-0004c9e0: 616c 6961 7365 732e 2022 0a20 2020 2020  aliases. ".     
-0004c9f0: 2020 2022 4465 7461 696c 733a 3a20 5265     "Details:: Re
-0004ca00: 736f 6c76 6573 2061 2072 6f6f 6d20 616c  solves a room al
-0004ca10: 6961 7320 746f 2074 6865 2063 6f72 7265  ias to the corre
-0004ca20: 7370 6f6e 6469 6e67 2072 6f6f 6d20 6964  sponding room id
-0004ca30: 2c20 220a 2020 2020 2020 2020 226f 7220  , ".        "or 
-0004ca40: 6d75 6c74 6970 6c65 2072 6f6f 6d20 616c  multiple room al
-0004ca50: 6961 7365 7320 746f 2074 6865 6972 2063  iases to their c
-0004ca60: 6f72 7265 7370 6f6e 6469 6e67 2072 6f6f  orresponding roo
-0004ca70: 6d20 6964 732e 2022 0a20 2020 2020 2020  m ids. ".       
-0004ca80: 2022 5072 6f76 6964 6520 6f6e 6520 6f72   "Provide one or
-0004ca90: 206d 756c 7469 706c 6520 726f 6f6d 2061   multiple room a
-0004caa0: 6c69 6173 6573 2e20 220a 2020 2020 2020  liases. ".      
-0004cab0: 2020 2241 2072 6f6f 6d20 616c 6961 7320    "A room alias 
-0004cac0: 6c6f 6f6b 7320 6c69 6b65 2074 6869 733a  looks like this:
-0004cad0: 2022 0a20 2020 2020 2020 2022 2723 736f   ".        "'#so
-0004cae0: 6d65 526f 6f6d 416c 6961 733a 6d61 7472  meRoomAlias:matr
-0004caf0: 6978 2e65 7861 6d70 6c65 2e6f 7267 272e  ix.example.org'.
-0004cb00: 2053 686f 7274 2061 6c69 6173 6573 206c   Short aliases l
-0004cb10: 696b 6520 220a 2020 2020 2020 2020 2227  ike ".        "'
-0004cb20: 736f 6d65 526f 6f6d 416c 6961 7327 206f  someRoomAlias' o
-0004cb30: 7220 2723 736f 6d65 526f 6f6d 416c 6961  r '#someRoomAlia
-0004cb40: 7327 2061 7265 2061 6c73 6f20 6163 6365  s' are also acce
-0004cb50: 7074 6564 2e20 220a 2020 2020 2020 2020  pted. ".        
-0004cb60: 2249 6e20 6361 7365 206f 6620 6120 7368  "In case of a sh
-0004cb70: 6f72 7420 616c 6961 732c 2022 0a20 2020  ort alias, ".   
-0004cb80: 2020 2020 2022 6974 2077 696c 6c20 6265       "it will be
-0004cb90: 2061 7574 6f6d 6174 6963 616c 6c79 2070   automatically p
-0004cba0: 7265 6669 7865 6420 7769 7468 2027 2327  refixed with '#'
-0004cbb0: 2061 6e64 2074 6865 2022 0a20 2020 2020   and the ".     
-0004cbc0: 2020 2066 2268 6f6d 6573 6572 7665 7220     f"homeserver 
-0004cbd0: 6672 6f6d 2074 6865 2064 6566 6175 6c74  from the default
-0004cbe0: 2072 6f6f 6d20 6f66 207b 5052 4f47 5f57   room of {PROG_W
-0004cbf0: 4954 484f 5554 5f45 5854 7d20 2861 7320  ITHOUT_EXT} (as 
-0004cc00: 666f 756e 6420 220a 2020 2020 2020 2020  found ".        
-0004cc10: 2269 6e20 6372 6564 656e 7469 616c 7320  "in credentials 
-0004cc20: 6669 6c65 2920 7769 6c6c 2062 6520 6175  file) will be au
-0004cc30: 746f 6d61 7469 6361 6c6c 7920 6170 7065  tomatically appe
-0004cc40: 6e64 6564 2e20 220a 2020 2020 2020 2020  nded. ".        
-0004cc50: 2252 6573 6f6c 7669 6e67 2061 6e20 616c  "Resolving an al
-0004cc60: 6961 7320 7468 6174 2064 6f65 7320 6e6f  ias that does no
-0004cc70: 7420 6578 6973 7420 7265 7375 6c74 7320  t exist results 
-0004cc80: 696e 2061 6e20 6572 726f 722e 2022 0a20  in an error. ". 
-0004cc90: 2020 2020 2020 2022 466f 7220 6561 6368         "For each
-0004cca0: 2072 6f6f 6d20 616c 6961 7320 6f6e 6520   room alias one 
-0004ccb0: 6c69 6e65 2077 696c 6c20 6265 2070 7269  line will be pri
-0004ccc0: 6e74 6564 2074 6f20 7374 646f 7574 2077  nted to stdout w
-0004ccd0: 6974 6820 7468 6520 220a 2020 2020 2020  ith the ".      
-0004cce0: 2020 2272 6573 756c 742e 222c 0a20 2020    "result.",.   
-0004ccf0: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
-0004cd00: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
-0004cd10: 222d 2d72 6f6f 6d2d 6465 6c65 7465 2d61  "--room-delete-a
-0004cd20: 6c69 6173 222c 0a20 2020 2020 2020 2072  lias",.        r
-0004cd30: 6571 7569 7265 643d 4661 6c73 652c 0a20  equired=False,. 
-0004cd40: 2020 2020 2020 2061 6374 696f 6e3d 2265         action="e
-0004cd50: 7874 656e 6422 2c0a 2020 2020 2020 2020  xtend",.        
-0004cd60: 6e61 7267 733d 222b 222c 0a20 2020 2020  nargs="+",.     
-0004cd70: 2020 2074 7970 653d 7374 722c 0a20 2020     type=str,.   
-0004cd80: 2020 2020 206d 6574 6176 6172 3d22 524f       metavar="RO
-0004cd90: 4f4d 5f41 4c49 4153 222c 0a20 2020 2020  OM_ALIAS",.     
-0004cda0: 2020 2068 656c 703d 2244 656c 6574 6520     help="Delete 
-0004cdb0: 6f6e 6520 6f72 206d 756c 7469 706c 6520  one or multiple 
-0004cdc0: 726f 6f6d 7320 616c 6961 7365 732e 2022  rooms aliases. "
-0004cdd0: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
-0004cde0: 733a 3a20 5072 6f76 6964 6520 6f6e 6520  s:: Provide one 
-0004cdf0: 6f72 206d 756c 7469 706c 6520 726f 6f6d  or multiple room
-0004ce00: 2061 6c69 6173 6573 2e20 220a 2020 2020   aliases. ".    
-0004ce10: 2020 2020 2259 6f75 2063 616e 2068 6176      "You can hav
-0004ce20: 6520 6d75 6c74 6970 6c65 2072 6f6f 6d20  e multiple room 
-0004ce30: 616c 6961 7365 7320 7065 7220 726f 6f6d  aliases per room
-0004ce40: 2e20 536f 2c20 220a 2020 2020 2020 2020  . So, ".        
-0004ce50: 2279 6f75 206d 6179 2064 656c 6574 6520  "you may delete 
-0004ce60: 6d75 6c74 6970 6c65 2061 6c69 6173 6573  multiple aliases
-0004ce70: 2066 726f 6d20 7468 6520 7361 6d65 2072   from the same r
-0004ce80: 6f6f 6d20 6f72 2066 726f 6d20 6469 6666  oom or from diff
-0004ce90: 6572 656e 7420 220a 2020 2020 2020 2020  erent ".        
-0004cea0: 2272 6f6f 6d73 2e20 220a 2020 2020 2020  "rooms. ".      
-0004ceb0: 2020 2241 2072 6f6f 6d20 616c 6961 7320    "A room alias 
-0004cec0: 6c6f 6f6b 7320 6c69 6b65 2074 6869 733a  looks like this:
-0004ced0: 2022 0a20 2020 2020 2020 2022 2723 736f   ".        "'#so
-0004cee0: 6d65 526f 6f6d 416c 6961 733a 6d61 7472  meRoomAlias:matr
-0004cef0: 6978 2e65 7861 6d70 6c65 2e6f 7267 272e  ix.example.org'.
-0004cf00: 2053 686f 7274 2061 6c69 6173 6573 206c   Short aliases l
-0004cf10: 696b 6520 220a 2020 2020 2020 2020 2227  ike ".        "'
-0004cf20: 736f 6d65 526f 6f6d 416c 6961 7327 206f  someRoomAlias' o
-0004cf30: 7220 2723 736f 6d65 526f 6f6d 416c 6961  r '#someRoomAlia
-0004cf40: 7327 2061 7265 2061 6c73 6f20 6163 6365  s' are also acce
-0004cf50: 7074 6564 2e20 220a 2020 2020 2020 2020  pted. ".        
-0004cf60: 2249 6e20 6361 7365 206f 6620 6120 7368  "In case of a sh
-0004cf70: 6f72 7420 616c 6961 732c 2022 0a20 2020  ort alias, ".   
-0004cf80: 2020 2020 2022 6974 2077 696c 6c20 6265       "it will be
-0004cf90: 2061 7574 6f6d 6174 6963 616c 6c79 2070   automatically p
-0004cfa0: 7265 6669 7865 6420 7769 7468 2027 2327  refixed with '#'
-0004cfb0: 2061 6e64 2074 6865 2022 0a20 2020 2020   and the ".     
-0004cfc0: 2020 2066 2268 6f6d 6573 6572 7665 7220     f"homeserver 
-0004cfd0: 6672 6f6d 2074 6865 2064 6566 6175 6c74  from the default
-0004cfe0: 2072 6f6f 6d20 6f66 207b 5052 4f47 5f57   room of {PROG_W
-0004cff0: 4954 484f 5554 5f45 5854 7d20 2861 7320  ITHOUT_EXT} (as 
-0004d000: 666f 756e 6420 220a 2020 2020 2020 2020  found ".        
-0004d010: 2269 6e20 6372 6564 656e 7469 616c 7320  "in credentials 
-0004d020: 6669 6c65 2920 7769 6c6c 2062 6520 6175  file) will be au
-0004d030: 746f 6d61 7469 6361 6c6c 7920 6170 7065  tomatically appe
-0004d040: 6e64 6564 2e20 220a 2020 2020 2020 2020  nded. ".        
-0004d050: 2244 656c 6574 696e 6720 616e 2061 6c69  "Deleting an ali
-0004d060: 6173 2074 6861 7420 646f 6573 206e 6f74  as that does not
-0004d070: 2065 7869 7374 2072 6573 756c 7473 2069   exist results i
-0004d080: 6e20 616e 2065 7272 6f72 2e22 2c0a 2020  n an error.",.  
-0004d090: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
-0004d0a0: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
-0004d0b0: 2022 2d2d 6765 742d 6f70 656e 6964 2d74   "--get-openid-t
-0004d0c0: 6f6b 656e 222c 0a20 2020 2020 2020 2072  oken",.        r
-0004d0d0: 6571 7569 7265 643d 4661 6c73 652c 0a20  equired=False,. 
-0004d0e0: 2020 2020 2020 2061 6374 696f 6e3d 2265         action="e
-0004d0f0: 7874 656e 6422 2c0a 2020 2020 2020 2020  xtend",.        
-0004d100: 6e61 7267 733d 222a 222c 2020 2320 4e6f  nargs="*",  # No
-0004d110: 6e65 2069 6620 6e6f 7420 7573 6564 2c20  ne if not used, 
-0004d120: 5b5d 2069 7320 7573 6564 2077 6974 686f  [] is used witho
-0004d130: 7574 2065 7874 7261 2061 7267 730a 2020  ut extra args.  
-0004d140: 2020 2020 2020 7479 7065 3d73 7472 2c0a        type=str,.
-0004d150: 2020 2020 2020 2020 6d65 7461 7661 723d          metavar=
-0004d160: 2255 5345 5222 2c0a 2020 2020 2020 2020  "USER",.        
-0004d170: 6865 6c70 3d22 4765 7420 616e 204f 7065  help="Get an Ope
-0004d180: 6e49 4420 746f 6b65 6e2e 2022 0a20 2020  nID token. ".   
-0004d190: 2020 2020 2066 2244 6574 6169 6c73 3a3a       f"Details::
-0004d1a0: 2047 6574 2061 6e20 4f70 656e 4944 2074   Get an OpenID t
-0004d1b0: 6f6b 656e 2066 6f72 207b 5052 4f47 5f57  oken for {PROG_W
-0004d1c0: 4954 484f 5554 5f45 5854 7d2c 206f 7220  ITHOUT_EXT}, or 
-0004d1d0: 666f 7220 220a 2020 2020 2020 2020 226f  for ".        "o
-0004d1e0: 6e65 206f 7220 6d75 6c74 6970 6c65 206f  ne or multiple o
-0004d1f0: 7468 6572 2075 7365 7273 2e20 4974 2070  ther users. It p
-0004d200: 7269 6e74 7320 616e 204f 7065 6e49 4420  rints an OpenID 
-0004d210: 746f 6b65 6e20 6f62 6a65 6374 2022 0a20  token object ". 
-0004d220: 2020 2020 2020 2022 7468 6174 2074 6865         "that the
-0004d230: 2072 6571 7565 7374 6572 206d 6179 2073   requester may s
-0004d240: 7570 706c 7920 746f 2061 6e6f 7468 6572  upply to another
-0004d250: 2073 6572 7669 6365 2074 6f20 7665 7269   service to veri
-0004d260: 6679 2074 6865 6972 2022 0a20 2020 2020  fy their ".     
-0004d270: 2020 2022 6964 656e 7469 7479 2069 6e20     "identity in 
-0004d280: 4d61 7472 6978 2e20 5365 6520 6874 7470  Matrix. See http
-0004d290: 3a2f 2f77 7777 2e6f 7065 6e69 642e 6e65  ://www.openid.ne
-0004d2a0: 742f 2e20 220a 2020 2020 2020 2020 2253  t/. ".        "S
-0004d2b0: 7065 6369 6679 207a 6572 6f20 6f72 206d  pecify zero or m
-0004d2c0: 6f72 6520 7573 6572 2069 6473 2e20 220a  ore user ids. ".
-0004d2d0: 2020 2020 2020 2020 6622 4966 206e 6f20          f"If no 
-0004d2e0: 7573 6572 2069 6420 6973 2073 7065 6369  user id is speci
-0004d2f0: 6669 6564 2c20 616e 204f 7065 6e49 4420  fied, an OpenID 
-0004d300: 666f 7220 7b50 524f 475f 5749 5448 4f55  for {PROG_WITHOU
-0004d310: 545f 4558 547d 2077 696c 6c20 220a 2020  T_EXT} will ".  
-0004d320: 2020 2020 2020 2262 6520 6665 7463 6865        "be fetche
-0004d330: 642e 2049 6620 6f6e 6520 6f72 206d 6f72  d. If one or mor
-0004d340: 6520 7573 6572 2069 6473 2061 7265 2067  e user ids are g
-0004d350: 6976 656e 2c20 7468 6520 4f70 656e 4944  iven, the OpenID
-0004d360: 206f 6620 220a 2020 2020 2020 2020 2274   of ".        "t
-0004d370: 6865 7365 2075 7365 7273 2077 696c 6c20  hese users will 
-0004d380: 6265 2066 6574 6368 6564 2e20 4173 2072  be fetched. As r
-0004d390: 6573 706f 6e73 6520 7468 6520 7573 6572  esponse the user
-0004d3a0: 2069 6428 7329 2061 6e64 2022 0a20 2020   id(s) and ".   
-0004d3b0: 2020 2020 2022 4f70 656e 4944 2873 2920       "OpenID(s) 
-0004d3c0: 7769 6c6c 2062 6520 7072 696e 7465 642e  will be printed.
-0004d3d0: 222c 0a20 2020 2029 0a20 2020 2061 702e  ",.    ).    ap.
-0004d3e0: 6164 645f 6172 6775 6d65 6e74 280a 2020  add_argument(.  
-0004d3f0: 2020 2020 2020 222d 2d72 6f6f 6d2d 6765        "--room-ge
-0004d400: 742d 7669 7369 6269 6c69 7479 222c 0a20  t-visibility",. 
-0004d410: 2020 2020 2020 2072 6571 7569 7265 643d         required=
-0004d420: 4661 6c73 652c 0a20 2020 2020 2020 2061  False,.        a
-0004d430: 6374 696f 6e3d 2265 7874 656e 6422 2c0a  ction="extend",.
-0004d440: 2020 2020 2020 2020 6e61 7267 733d 222a          nargs="*
-0004d450: 222c 2020 2320 4e6f 6e65 2069 6620 6e6f  ",  # None if no
-0004d460: 7420 7573 6564 2c20 5b5d 2069 7320 7573  t used, [] is us
-0004d470: 6564 2077 6974 686f 7574 2065 7874 7261  ed without extra
-0004d480: 2061 7267 730a 2020 2020 2020 2020 7479   args.        ty
-0004d490: 7065 3d73 7472 2c0a 2020 2020 2020 2020  pe=str,.        
-0004d4a0: 6d65 7461 7661 723d 2252 4f4f 4d22 2c0a  metavar="ROOM",.
-0004d4b0: 2020 2020 2020 2020 6865 6c70 3d22 4765          help="Ge
-0004d4c0: 7420 7468 6520 7669 7369 6269 6c69 7479  t the visibility
-0004d4d0: 206f 6620 6f6e 6520 6f72 206d 6f72 6520   of one or more 
-0004d4e0: 726f 6f6d 732e 2022 0a20 2020 2020 2020  rooms. ".       
-0004d4f0: 2022 4465 7461 696c 733a 3a20 5072 6f76   "Details:: Prov
-0004d500: 6964 6520 7a65 726f 206f 7220 6d6f 7265  ide zero or more
-0004d510: 2072 6f6f 6d20 6964 7320 6173 2061 7267   room ids as arg
-0004d520: 756d 656e 7473 2e20 220a 2020 2020 2020  uments. ".      
-0004d530: 2020 2249 6620 6e6f 2061 7267 756d 656e    "If no argumen
-0004d540: 7420 6973 2067 6976 656e 2c20 7468 656e  t is given, then
-0004d550: 2074 6865 2064 6566 6175 6c74 2072 6f6f   the default roo
-0004d560: 6d20 6f66 2022 0a20 2020 2020 2020 2066  m of ".        f
-0004d570: 227b 5052 4f47 5f57 4954 484f 5554 5f45  "{PROG_WITHOUT_E
-0004d580: 5854 7d20 2861 7320 666f 756e 6420 696e  XT} (as found in
-0004d590: 2063 7265 6465 6e74 6961 6c73 2066 696c   credentials fil
-0004d5a0: 6529 2077 696c 6c20 6265 2075 7365 642e  e) will be used.
-0004d5b0: 2022 0a20 2020 2020 2020 2022 466f 7220   ".        "For 
-0004d5c0: 6561 6368 2072 6f6f 6d20 7468 6520 7669  each room the vi
-0004d5d0: 7369 6269 6c69 7479 2077 696c 6c20 6265  sibility will be
-0004d5e0: 2070 7269 6e74 6564 2e20 4375 7272 656e   printed. Curren
-0004d5f0: 746c 792c 2074 6869 7320 220a 2020 2020  tly, this ".    
-0004d600: 2020 2020 2269 7320 6569 7468 6572 2074      "is either t
-0004d610: 6865 2073 7472 696e 6720 2770 7269 7661  he string 'priva
-0004d620: 7465 2720 6f72 2027 7075 626c 6963 272e  te' or 'public'.
-0004d630: 2022 0a20 2020 2020 2020 2022 4173 2072   ".        "As r
-0004d640: 6573 706f 6e73 6520 6f6e 6520 6c69 6e65  esponse one line
-0004d650: 2070 6572 2072 6f6f 6d20 7769 6c6c 2062   per room will b
-0004d660: 6520 7072 696e 7465 6420 746f 2073 7464  e printed to std
-0004d670: 6f75 742e 222c 0a20 2020 2029 0a20 2020  out.",.    ).   
-0004d680: 2061 702e 6164 645f 6172 6775 6d65 6e74   ap.add_argument
-0004d690: 280a 2020 2020 2020 2020 222d 2d72 6f6f  (.        "--roo
-0004d6a0: 6d2d 6765 742d 7374 6174 6522 2c0a 2020  m-get-state",.  
-0004d6b0: 2020 2020 2020 7265 7175 6972 6564 3d46        required=F
-0004d6c0: 616c 7365 2c0a 2020 2020 2020 2020 6163  alse,.        ac
-0004d6d0: 7469 6f6e 3d22 6578 7465 6e64 222c 0a20  tion="extend",. 
-0004d6e0: 2020 2020 2020 206e 6172 6773 3d22 2a22         nargs="*"
-0004d6f0: 2c20 2023 204e 6f6e 6520 6966 206e 6f74  ,  # None if not
-0004d700: 2075 7365 642c 205b 5d20 6973 2075 7365   used, [] is use
-0004d710: 6420 7769 7468 6f75 7420 6578 7472 6120  d without extra 
-0004d720: 6172 6773 0a20 2020 2020 2020 2074 7970  args.        typ
-0004d730: 653d 7374 722c 0a20 2020 2020 2020 206d  e=str,.        m
-0004d740: 6574 6176 6172 3d22 524f 4f4d 222c 0a20  etavar="ROOM",. 
-0004d750: 2020 2020 2020 2068 656c 703d 2247 6574         help="Get
-0004d760: 2074 6865 2073 7461 7465 206f 6620 6f6e   the state of on
-0004d770: 6520 6f72 206d 6f72 6520 726f 6f6d 732e  e or more rooms.
-0004d780: 2022 0a20 2020 2020 2020 2022 4465 7461   ".        "Deta
-0004d790: 696c 733a 3a50 726f 7669 6465 207a 6572  ils::Provide zer
-0004d7a0: 6f20 6f72 206d 6f72 6520 726f 6f6d 2069  o or more room i
-0004d7b0: 6473 2061 7320 6172 6775 6d65 6e74 732e  ds as arguments.
-0004d7c0: 2022 0a20 2020 2020 2020 2022 4966 206e   ".        "If n
-0004d7d0: 6f20 6172 6775 6d65 6e74 2069 7320 6769  o argument is gi
-0004d7e0: 7665 6e2c 2074 6865 6e20 7468 6520 6465  ven, then the de
-0004d7f0: 6661 756c 7420 726f 6f6d 206f 6620 220a  fault room of ".
-0004d800: 2020 2020 2020 2020 6622 7b50 524f 475f          f"{PROG_
-0004d810: 5749 5448 4f55 545f 4558 547d 2028 6173  WITHOUT_EXT} (as
-0004d820: 2066 6f75 6e64 2069 6e20 6372 6564 656e   found in creden
-0004d830: 7469 616c 7320 6669 6c65 2920 7769 6c6c  tials file) will
-0004d840: 2062 6520 7573 6564 2e20 220a 2020 2020   be used. ".    
-0004d850: 2020 2020 2246 6f72 2065 6163 6820 726f      "For each ro
-0004d860: 6f6d 2074 6865 2073 7461 7465 2077 696c  om the state wil
-0004d870: 6c20 6265 2070 7269 6e74 6564 2e20 5468  l be printed. Th
-0004d880: 6520 7374 6174 6520 6973 2061 206c 6f6e  e state is a lon
-0004d890: 6720 220a 2020 2020 2020 2020 226c 6973  g ".        "lis
-0004d8a0: 7420 6f66 2065 7665 6e74 7320 696e 636c  t of events incl
-0004d8b0: 7564 696e 6720 6576 656e 7473 206c 696b  uding events lik
-0004d8c0: 6520 276d 2e72 6f6f 6d2e 6372 6561 7465  e 'm.room.create
-0004d8d0: 272c 2022 0a20 2020 2020 2020 2022 276d  ', ".        "'m
-0004d8e0: 2e72 6f6f 6d2e 656e 6372 7970 7469 6f6e  .room.encryption
-0004d8f0: 272c 2027 6d2e 726f 6f6d 2e67 7565 7374  ', 'm.room.guest
-0004d900: 5f61 6363 6573 7327 2c20 220a 2020 2020  _access', ".    
-0004d910: 2020 2020 2227 6d2e 726f 6f6d 2e68 6973      "'m.room.his
-0004d920: 746f 7279 5f76 6973 6962 696c 6974 7927  tory_visibility'
-0004d930: 2c20 276d 2e72 6f6f 6d2e 6a6f 696e 5f72  , 'm.room.join_r
-0004d940: 756c 6573 272c 2022 0a20 2020 2020 2020  ules', ".       
-0004d950: 2022 276d 2e72 6f6f 6d2e 6d65 6d62 6572   "'m.room.member
-0004d960: 272c 2027 6d2e 726f 6f6d 2e70 6f77 6572  ', 'm.room.power
-0004d970: 5f6c 6576 656c 7327 2c20 6574 632e 2022  _levels', etc. "
-0004d980: 0a20 2020 2020 2020 2022 4173 2072 6573  .        "As res
-0004d990: 706f 6e73 6520 6f6e 6520 6c69 6e65 2070  ponse one line p
-0004d9a0: 6572 2072 6f6f 6d20 7769 6c6c 2062 6520  er room will be 
-0004d9b0: 7072 696e 7465 6420 746f 2073 7464 6f75  printed to stdou
-0004d9c0: 742e 2022 0a20 2020 2020 2020 2022 5468  t. ".        "Th
-0004d9d0: 6520 6c69 6e65 2063 616e 2062 6520 7665  e line can be ve
-0004d9e0: 7279 206c 6f6e 6720 6173 2074 6865 206c  ry long as the l
-0004d9f0: 6973 7420 6f66 2065 7665 6e74 7320 6361  ist of events ca
-0004da00: 6e20 6265 2076 6572 7920 6c61 7267 652e  n be very large.
-0004da10: 2022 0a20 2020 2020 2020 2022 546f 2067   ".        "To g
-0004da20: 6574 206f 7574 7075 7420 696e 746f 2061  et output into a
-0004da30: 2068 756d 616e 2072 6561 6461 626c 6520   human readable 
-0004da40: 666f 726d 2070 6970 6520 6f75 7470 7574  form pipe output
-0004da50: 2074 6872 6f75 6768 2073 6564 2022 0a20   through sed ". 
-0004da60: 2020 2020 2020 2022 616e 6420 6a71 2061         "and jq a
-0004da70: 7320 7368 6f77 6e20 696e 2061 6e20 6578  s shown in an ex
-0004da80: 616d 706c 6520 696e 2074 6573 7473 2f74  ample in tests/t
-0004da90: 6573 742d 7365 7467 6574 2e73 682e 222c  est-setget.sh.",
-0004daa0: 0a20 2020 2029 0a20 2020 2061 702e 6164  .    ).    ap.ad
-0004dab0: 645f 6172 6775 6d65 6e74 280a 2020 2020  d_argument(.    
-0004dac0: 2020 2020 222d 2d64 656c 6574 652d 6465      "--delete-de
-0004dad0: 7669 6365 222c 0a20 2020 2020 2020 2072  vice",.        r
-0004dae0: 6571 7569 7265 643d 4661 6c73 652c 0a20  equired=False,. 
-0004daf0: 2020 2020 2020 2061 6374 696f 6e3d 2265         action="e
-0004db00: 7874 656e 6422 2c0a 2020 2020 2020 2020  xtend",.        
-0004db10: 6e61 7267 733d 222b 222c 0a20 2020 2020  nargs="+",.     
-0004db20: 2020 2074 7970 653d 7374 722c 0a20 2020     type=str,.   
-0004db30: 2020 2020 206d 6574 6176 6172 3d22 4445       metavar="DE
-0004db40: 5649 4345 222c 0a20 2020 2020 2020 2068  VICE",.        h
-0004db50: 656c 703d 6622 4465 6c65 7465 206f 6e65  elp=f"Delete one
-0004db60: 206f 7220 6d75 6c74 6970 6c65 2064 6576   or multiple dev
-0004db70: 6963 6573 2e20 220a 2020 2020 2020 2020  ices. ".        
-0004db80: 2244 6574 6169 6c73 3a3a 2042 7920 6465  "Details:: By de
-0004db90: 6661 756c 7420 6465 7669 6365 7320 6265  fault devices be
-0004dba0: 6c6f 6e67 696e 6720 220a 2020 2020 2020  longing ".      
-0004dbb0: 2020 6622 746f 207b 5052 4f47 5f57 4954    f"to {PROG_WIT
-0004dbc0: 484f 5554 5f45 5854 7d20 7769 6c6c 2062  HOUT_EXT} will b
-0004dbd0: 6520 6465 6c65 7465 642e 2049 6620 7468  e deleted. If th
-0004dbe0: 6520 6465 7669 6365 7320 6265 6c6f 6e67  e devices belong
-0004dbf0: 2022 0a20 2020 2020 2020 2022 746f 2061   ".        "to a
-0004dc00: 2064 6966 6665 7265 6e74 2075 7365 722c   different user,
-0004dc10: 2075 7365 2074 6865 202d 2d75 7365 7220   use the --user 
-0004dc20: 6172 6775 6d65 6e74 2074 6f20 7370 6563  argument to spec
-0004dc30: 6966 7920 7468 6520 7573 6572 2c20 220a  ify the user, ".
-0004dc40: 2020 2020 2020 2020 2269 2e65 2e20 6f77          "i.e. ow
-0004dc50: 6e65 722e 204f 6e6c 7920 220a 2020 2020  ner. Only ".    
-0004dc60: 2020 2020 2265 7861 6374 6c79 206f 6e65      "exactly one
-0004dc70: 2075 7365 7220 6361 6e20 6265 2073 7065   user can be spe
-0004dc80: 6369 6669 6564 2077 6974 6820 7468 6520  cified with the 
-0004dc90: 6f70 7469 6f6e 616c 202d 2d75 7365 7220  optional --user 
-0004dca0: 6172 6775 6d65 6e74 2e20 220a 2020 2020  argument. ".    
-0004dcb0: 2020 2020 2244 6576 6963 6520 6465 6c65      "Device dele
-0004dcc0: 7469 6f6e 2072 6571 7569 7265 7320 7468  tion requires th
-0004dcd0: 6520 7573 6572 2070 6173 7377 6f72 642e  e user password.
-0004dce0: 2049 7420 6d75 7374 2062 6520 7370 6563   It must be spec
-0004dcf0: 6966 6965 6420 220a 2020 2020 2020 2020  ified ".        
-0004dd00: 2277 6974 6820 7468 6520 2d2d 7061 7373  "with the --pass
-0004dd10: 776f 7264 2061 7267 756d 656e 742e 2049  word argument. I
-0004dd20: 6620 7468 6520 7365 7276 6572 2075 7365  f the server use
-0004dd30: 7320 6f6e 6c79 2048 5454 5020 2861 6e64  s only HTTP (and
-0004dd40: 2022 0a20 2020 2020 2020 2022 6e6f 7420   ".        "not 
-0004dd50: 4854 5450 5329 2c20 7468 656e 2074 6865  HTTPS), then the
-0004dd60: 2070 6173 7377 6f72 6420 6361 6e20 6265   password can be
-0004dd70: 2076 6973 6962 6c65 2074 6f20 6174 7461   visible to atta
-0004dd80: 636b 6572 732e 2048 656e 6365 2c20 220a  ckers. Hence, ".
-0004dd90: 2020 2020 2020 2020 2269 6620 7468 6520          "if the 
-0004dda0: 7365 7276 6572 2064 6f65 7320 6e6f 7420  server does not 
-0004ddb0: 7375 7070 6f72 7420 4854 5450 5320 7468  support HTTPS th
-0004ddc0: 6973 206f 7065 7261 7469 6f6e 2069 7320  is operation is 
-0004ddd0: 6469 7363 6f75 7261 6765 642e 222c 0a20  discouraged.",. 
-0004dde0: 2020 2029 0a20 2020 2061 702e 6164 645f     ).    ap.add_
-0004ddf0: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
-0004de00: 2020 222d 2d72 6f6f 6d2d 7265 6461 6374    "--room-redact
-0004de10: 222c 0a20 2020 2020 2020 2022 2d2d 726f  ",.        "--ro
-0004de20: 6f6d 2d64 656c 6574 652d 636f 6e74 656e  om-delete-conten
-0004de30: 7422 2c0a 2020 2020 2020 2020 7265 7175  t",.        requ
-0004de40: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
-0004de50: 2020 2020 6163 7469 6f6e 3d22 6578 7465      action="exte
-0004de60: 6e64 222c 0a20 2020 2020 2020 206e 6172  nd",.        nar
-0004de70: 6773 3d22 2b22 2c0a 2020 2020 2020 2020  gs="+",.        
-0004de80: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
-0004de90: 2020 6d65 7461 7661 723d 2252 4f4f 4d5f    metavar="ROOM_
-0004dea0: 4944 2045 5645 4e54 5f49 4420 5245 4153  ID EVENT_ID REAS
-0004deb0: 4f4e 222c 0a20 2020 2020 2020 2068 656c  ON",.        hel
-0004dec0: 703d 2253 7472 6970 2069 6e66 6f72 6d61  p="Strip informa
-0004ded0: 7469 6f6e 206f 7574 206f 6620 6f6e 6520  tion out of one 
-0004dee0: 6f72 2073 6576 6572 616c 2065 7665 6e74  or several event
-0004def0: 732e 2022 0a20 2020 2020 2020 2022 4465  s. ".        "De
-0004df00: 7461 696c 733a 3a20 220a 2020 2020 2020  tails:: ".      
-0004df10: 2020 2253 7472 6970 2069 6e66 6f72 6d61    "Strip informa
-0004df20: 7469 6f6e 2066 726f 6d20 6576 656e 7473  tion from events
-0004df30: 2c20 652e 672e 206d 6573 7361 6765 732e  , e.g. messages.
-0004df40: 2022 0a20 2020 2020 2020 2022 5265 6461   ".        "Reda
-0004df50: 6374 2069 7320 7573 6564 2069 6e20 7468  ct is used in th
-0004df60: 6520 6d65 616e 696e 6720 6f66 2027 7374  e meaning of 'st
-0004df70: 7269 702c 2077 6970 652c 2062 6c61 636b  rip, wipe, black
-0004df80: 2d6f 7574 272c 206e 6f74 2022 0a20 2020  -out', not ".   
-0004df90: 2020 2020 2022 696e 2074 6865 206d 6561       "in the mea
-0004dfa0: 6e69 6e67 206f 6620 2765 6469 7427 2e20  ning of 'edit'. 
-0004dfb0: 5468 6973 2061 6374 696f 6e20 7265 6d6f  This action remo
-0004dfc0: 7665 732c 2064 656c 6574 6573 2074 6865  ves, deletes the
-0004dfd0: 2063 6f6e 7465 6e74 2022 0a20 2020 2020   content ".     
-0004dfe0: 2020 2022 6f66 2061 6e20 6576 656e 7420     "of an event 
-0004dff0: 7768 696c 6520 6e6f 7420 7265 6d6f 7669  while not removi
-0004e000: 6e67 2074 6865 2065 7665 6e74 2e20 596f  ng the event. Yo
-0004e010: 7520 6361 6e20 7769 7065 2074 6578 7420  u can wipe text 
-0004e020: 6672 6f6d 2061 2022 0a20 2020 2020 2020  from a ".       
-0004e030: 2022 7072 6576 696f 7573 206d 6573 7361   "previous messa
-0004e040: 6765 2c20 6574 632e 2054 7970 6963 616c  ge, etc. Typical
-0004e050: 204d 6174 7269 7820 636c 6965 6e74 7320   Matrix clients 
-0004e060: 6c69 6b65 2045 6c65 6d65 6e74 2077 696c  like Element wil
-0004e070: 6c20 220a 2020 2020 2020 2020 2264 656c  l ".        "del
-0004e080: 6574 6520 6d65 7373 6167 6573 2c20 696d  ete messages, im
-0004e090: 6167 6573 2061 6e64 206f 7468 6572 206f  ages and other o
-0004e0a0: 626a 6563 7473 2066 726f 6d20 7468 6520  bjects from the 
-0004e0b0: 4755 4920 6f6e 6365 2074 6865 7920 220a  GUI once they ".
-0004e0c0: 2020 2020 2020 2020 2268 6176 6520 6265          "have be
-0004e0d0: 656e 2072 6564 6163 7465 642e 2022 0a20  en redacted. ". 
-0004e0e0: 2020 2020 2020 2022 536f 2c20 2d2d 726f         "So, --ro
-0004e0f0: 6f6d 2d72 6564 6163 7420 6973 2061 2077  om-redact is a w
-0004e100: 6179 2074 6f20 6465 6c65 7465 2061 206d  ay to delete a m
-0004e110: 6573 7361 6765 2c20 696d 6167 6573 2c20  essage, images, 
-0004e120: 6574 632e 2022 0a20 2020 2020 2020 2022  etc. ".        "
-0004e130: 5468 6520 636f 6e74 656e 7420 6973 2022  The content is "
-0004e140: 0a20 2020 2020 2020 2022 7769 7065 642c  .        "wiped,
-0004e150: 2074 6865 2047 5549 2064 656c 6574 6573   the GUI deletes
-0004e160: 2074 6865 206d 6573 7361 6765 2c20 6275   the message, bu
-0004e170: 7420 7468 6520 7365 7276 6572 206b 6565  t the server kee
-0004e180: 7073 2074 6865 2065 7665 6e74 2022 0a20  ps the event ". 
-0004e190: 2020 2020 2020 2022 6869 7374 6f72 792e         "history.
-0004e1a0: 204e 6f74 652c 2077 6869 6c65 2074 6869   Note, while thi
-0004e1b0: 7320 6465 6c65 7465 7320 6672 6f6d 2074  s deletes from t
-0004e1c0: 6865 2063 6c69 656e 7420 2847 5549 2c20  he client (GUI, 
-0004e1d0: 652e 672e 2022 0a20 2020 2020 2020 2022  e.g. ".        "
-0004e1e0: 456c 656d 656e 7429 2c20 6974 2064 6f65  Element), it doe
-0004e1f0: 7320 6e6f 7420 6465 6c65 7465 2066 726f  s not delete fro
-0004e200: 6d20 7468 6520 6461 7461 6261 7365 206f  m the database o
-0004e210: 6e20 7468 6520 7365 7276 6572 2e20 220a  n the server. ".
-0004e220: 2020 2020 2020 2020 2253 6f2c 2074 6869          "So, thi
-0004e230: 7320 6361 6c6c 2069 7320 6e6f 7420 6120  s call is not a 
-0004e240: 7761 7920 746f 2063 6c65 616e 2075 7020  way to clean up 
-0004e250: 7468 6520 7365 7276 6572 2064 6174 6162  the server datab
-0004e260: 6173 652e 2022 0a20 2020 2020 2020 2022  ase. ".        "
-0004e270: 4561 6368 2072 6564 6163 7420 2877 6970  Each redact (wip
-0004e280: 652c 2073 7472 6970 2c20 6465 6c65 7465  e, strip, delete
-0004e290: 2920 6f70 6572 6174 696f 6e20 7265 7175  ) operation requ
-0004e2a0: 6972 6573 2065 7861 6374 6c79 2033 2022  ires exactly 3 "
-0004e2b0: 0a20 2020 2020 2020 2022 6172 6775 6d65  .        "argume
-0004e2c0: 6e74 732e 2022 0a20 2020 2020 2020 2022  nts. ".        "
-0004e2d0: 5468 6520 6172 6775 6d65 6e74 2074 7269  The argument tri
-0004e2e0: 706c 6573 2061 7265 3a20 220a 2020 2020  ples are: ".    
-0004e2f0: 2020 2020 2228 6129 2074 6865 2072 6f6f      "(a) the roo
-0004e300: 6d20 6964 2e20 220a 2020 2020 2020 2020  m id. ".        
-0004e310: 2228 6229 2074 6865 2069 6420 6f66 2074  "(b) the id of t
-0004e320: 6865 2065 7665 6e74 2074 6f20 6265 2072  he event to be r
-0004e330: 6564 6163 7465 642e 2022 0a20 2020 2020  edacted. ".     
-0004e340: 2020 2022 2863 2920 6120 7374 7269 6e67     "(c) a string
-0004e350: 2063 6f6e 7461 696e 696e 6720 7468 6520   containing the 
-0004e360: 7265 6173 6f6e 2066 6f72 2074 6865 2072  reason for the r
-0004e370: 6564 6163 7469 6f6e 2e20 5573 6520 2727  edaction. Use ''
-0004e380: 2069 6620 796f 7520 220a 2020 2020 2020   if you ".      
-0004e390: 2020 2264 6f20 6e6f 7420 7761 6e74 2074    "do not want t
-0004e3a0: 6f20 6769 7665 2061 2072 6561 736f 6e2e  o give a reason.
-0004e3b0: 2022 0a20 2020 2020 2020 2022 536f 2c20   ".        "So, 
-0004e3c0: 7468 6520 746f 7461 6c20 6e75 6d62 6572  the total number
-0004e3d0: 206f 6620 6172 6775 6d65 6e74 7320 7573   of arguments us
-0004e3e0: 6564 2077 6974 6820 2d2d 726f 6f6d 2d72  ed with --room-r
-0004e3f0: 6564 6163 7420 6d75 7374 2062 6520 6120  edact must be a 
-0004e400: 220a 2020 2020 2020 2020 226d 756c 7469  ".        "multi
-0004e410: 706c 6520 6f66 2033 2c20 6275 7420 7765  ple of 3, but we
-0004e420: 2061 6c73 6f20 6163 6365 7074 2032 2069   also accept 2 i
-0004e430: 6e20 7768 6963 6820 6361 7365 206f 6e6c  n which case onl
-0004e440: 7920 6f6e 6520 220a 2020 2020 2020 2020  y one ".        
-0004e450: 2272 6564 6163 7469 6f6e 2077 696c 6c20  "redaction will 
-0004e460: 6265 2064 6f6e 6520 7769 7468 6f75 7420  be done without 
-0004e470: 7370 6563 6966 7969 6e67 2061 2072 6561  specifying a rea
-0004e480: 736f 6e2e 2022 0a20 2020 2020 2020 2022  son. ".        "
-0004e490: 4576 656e 7420 6964 7320 7374 6172 7420  Event ids start 
-0004e4a0: 7769 7468 2074 6865 2064 6f6c 6c61 7220  with the dollar 
-0004e4b0: 7369 676e 2028 2429 2e20 4465 7065 6e64  sign ($). Depend
-0004e4c0: 696e 6720 6f6e 2079 6f75 7220 7368 656c  ing on your shel
-0004e4d0: 6c2c 2022 0a20 2020 2020 2020 2022 796f  l, ".        "yo
-0004e4e0: 7520 6d69 6768 7420 6861 7665 2074 6f20  u might have to 
-0004e4f0: 6573 6361 7065 2074 6865 2027 2427 2074  escape the '$' t
-0004e500: 6f20 275c 5c24 272e 202d 2d72 6f6f 6d2d  o '\\$'. --room-
-0004e510: 6465 6c65 7465 2d63 6f6e 7465 6e74 2069  delete-content i
-0004e520: 7320 220a 2020 2020 2020 2020 2261 6e20  s ".        "an 
-0004e530: 616c 6961 7320 666f 7220 2d2d 726f 6f6d  alias for --room
-0004e540: 2d72 6564 6163 742e 2054 6865 7920 6361  -redact. They ca
-0004e550: 6e20 6265 2075 7365 6420 696e 7465 7263  n be used interc
-0004e560: 6861 6e67 6561 626c 792e 222c 0a20 2020  hangeably.",.   
-0004e570: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
-0004e580: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
-0004e590: 2320 6e6f 2073 696e 676c 6520 6368 6172  # no single char
-0004e5a0: 2066 6c61 670a 2020 2020 2020 2020 222d   flag.        "-
-0004e5b0: 2d77 686f 616d 6922 2c0a 2020 2020 2020  -whoami",.      
-0004e5c0: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
-0004e5d0: 2c0a 2020 2020 2020 2020 6163 7469 6f6e  ,.        action
-0004e5e0: 3d22 7374 6f72 655f 7472 7565 222c 0a20  ="store_true",. 
-0004e5f0: 2020 2020 2020 2068 656c 703d 2250 7269         help="Pri
-0004e600: 6e74 2079 6f75 7220 7573 6572 2069 642e  nt your user id.
-0004e610: 2022 0a20 2020 2020 2020 2066 2244 6574   ".        f"Det
-0004e620: 6169 6c73 3a3a 2050 7269 6e74 2074 6865  ails:: Print the
-0004e630: 2075 7365 7220 6964 2075 7365 6420 6279   user id used by
-0004e640: 207b 5052 4f47 5f57 4954 484f 5554 5f45   {PROG_WITHOUT_E
-0004e650: 5854 7d20 2869 7473 656c 6629 2e20 220a  XT} (itself). ".
-0004e660: 2020 2020 2020 2020 224f 6e65 2063 616e          "One can
-0004e670: 2067 6574 2022 0a20 2020 2020 2020 2022   get ".        "
-0004e680: 7468 6973 2069 6e66 6f72 6d61 7469 6f6e  this information
-0004e690: 2061 6c73 6f20 6279 206c 6f6f 6b69 6e67   also by looking
-0004e6a0: 2061 7420 7468 6520 6372 6564 656e 7469   at the credenti
-0004e6b0: 616c 7320 6669 6c65 2e22 2c0a 2020 2020  als file.",.    
-0004e6c0: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
-0004e6d0: 756d 656e 7428 0a20 2020 2020 2020 2023  ument(.        #
-0004e6e0: 206e 6f20 7369 6e67 6c65 2063 6861 7220   no single char 
-0004e6f0: 666c 6167 0a20 2020 2020 2020 2022 2d2d  flag.        "--
-0004e700: 6e6f 2d73 736c 222c 0a20 2020 2020 2020  no-ssl",.       
-0004e710: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
-0004e720: 0a20 2020 2020 2020 2061 6374 696f 6e3d  .        action=
-0004e730: 2273 746f 7265 5f74 7275 6522 2c0a 2020  "store_true",.  
-0004e740: 2020 2020 2020 6465 6661 756c 743d 4e4f        default=NO
-0004e750: 5f53 534c 5f55 4e55 5345 445f 4445 4641  _SSL_UNUSED_DEFA
-0004e760: 554c 542c 2020 2320 7768 656e 206f 7074  ULT,  # when opt
-0004e770: 696f 6e20 6973 6e27 7420 7573 6564 0a20  ion isn't used. 
-0004e780: 2020 2020 2020 2068 656c 703d 2253 6b69         help="Ski
-0004e790: 7020 5353 4c20 7665 7269 6669 6361 7469  p SSL verificati
-0004e7a0: 6f6e 2e20 220a 2020 2020 2020 2020 2244  on. ".        "D
-0004e7b0: 6574 6169 6c73 3a3a 2042 7920 6465 6661  etails:: By defa
-0004e7c0: 756c 7420 2869 6620 7468 6973 206f 7074  ult (if this opt
-0004e7d0: 696f 6e20 6973 206e 6f74 2075 7365 6429  ion is not used)
-0004e7e0: 2022 0a20 2020 2020 2020 2022 7468 6520   ".        "the 
-0004e7f0: 5353 4c20 6365 7274 6966 6963 6174 6520  SSL certificate 
-0004e800: 6973 2076 616c 6964 6174 6564 2066 6f72  is validated for
-0004e810: 2074 6865 2063 6f6e 6e65 6374 696f 6e2e   the connection.
-0004e820: 2042 7574 2c20 6966 2074 6869 7320 220a   But, if this ".
-0004e830: 2020 2020 2020 2020 226f 7074 696f 6e20          "option 
-0004e840: 6973 2075 7365 642c 2074 6865 6e20 7468  is used, then th
-0004e850: 6520 5353 4c20 6365 7274 6966 6963 6174  e SSL certificat
-0004e860: 6520 7661 6c69 6461 7469 6f6e 2077 696c  e validation wil
-0004e870: 6c20 6265 2073 6b69 7070 6564 2e20 220a  l be skipped. ".
-0004e880: 2020 2020 2020 2020 2254 6869 7320 6973          "This is
-0004e890: 2075 7365 6675 6c20 666f 7220 686f 6d65   useful for home
-0004e8a0: 2d73 6572 7665 7273 2074 6861 7420 6861  -servers that ha
-0004e8b0: 7665 206e 6f20 5353 4c20 6365 7274 6966  ve no SSL certif
-0004e8c0: 6963 6174 652e 2022 0a20 2020 2020 2020  icate. ".       
-0004e8d0: 2027 4966 2075 7365 6420 746f 6765 7468   'If used togeth
-0004e8e0: 6572 2077 6974 6820 7468 6520 222d 2d73  er with the "--s
-0004e8f0: 736c 2d63 6572 7469 6669 6361 7465 2220  sl-certificate" 
-0004e900: 270a 2020 2020 2020 2020 2270 6172 616d  '.        "param
-0004e910: 6574 6572 2c20 7468 6973 206f 7074 696f  eter, this optio
-0004e920: 6e20 6973 206d 6561 6e69 6e67 6c65 7373  n is meaningless
-0004e930: 2061 6e64 2061 6e20 6572 726f 7220 7769   and an error wi
-0004e940: 6c6c 2062 6520 7261 6973 6564 2e22 2c0a  ll be raised.",.
-0004e950: 2020 2020 290a 2020 2020 6170 2e61 6464      ).    ap.add
-0004e960: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
-0004e970: 2020 2023 206e 6f20 7369 6e67 6c65 2063     # no single c
-0004e980: 6861 7220 666c 6167 0a20 2020 2020 2020  har flag.       
-0004e990: 2022 2d2d 7373 6c2d 6365 7274 6966 6963   "--ssl-certific
-0004e9a0: 6174 6522 2c0a 2020 2020 2020 2020 7265  ate",.        re
-0004e9b0: 7175 6972 6564 3d46 616c 7365 2c0a 2020  quired=False,.  
-0004e9c0: 2020 2020 2020 7479 7065 3d73 7472 2c0a        type=str,.
-0004e9d0: 2020 2020 2020 2020 6465 6661 756c 743d          default=
-0004e9e0: 5353 4c5f 4345 5254 4946 4943 4154 455f  SSL_CERTIFICATE_
-0004e9f0: 4445 4641 554c 542c 2020 2320 7768 656e  DEFAULT,  # when
-0004ea00: 206f 7074 696f 6e20 6973 6e27 7420 7573   option isn't us
-0004ea10: 6564 0a20 2020 2020 2020 206d 6574 6176  ed.        metav
-0004ea20: 6172 3d22 5353 4c5f 4345 5254 4946 4943  ar="SSL_CERTIFIC
-0004ea30: 4154 455f 4649 4c45 222c 0a20 2020 2020  ATE_FILE",.     
-0004ea40: 2020 2068 656c 703d 2255 7365 2079 6f75     help="Use you
-0004ea50: 7220 6f77 6e20 5353 4c20 6365 7274 6966  r own SSL certif
-0004ea60: 6963 6174 652e 2022 0a20 2020 2020 2020  icate. ".       
-0004ea70: 2022 4465 7461 696c 733a 3a20 5573 6520   "Details:: Use 
-0004ea80: 7468 6973 206f 7074 696f 6e20 746f 2075  this option to u
-0004ea90: 7365 2022 0a20 2020 2020 2020 2022 796f  se ".        "yo
-0004eaa0: 7572 206f 776e 206c 6f63 616c 2053 534c  ur own local SSL
-0004eab0: 2063 6572 7469 6669 6361 7465 2066 696c   certificate fil
-0004eac0: 652e 2022 0a20 2020 2020 2020 2022 5468  e. ".        "Th
-0004ead0: 6973 2069 7320 616e 206f 7074 696f 6e61  is is an optiona
-0004eae0: 6c20 7061 7261 6d65 7465 722e 2054 6869  l parameter. Thi
-0004eaf0: 7320 6973 2075 7365 6675 6c20 666f 7220  s is useful for 
-0004eb00: 686f 6d65 2073 6572 7665 7273 2074 6861  home servers tha
-0004eb10: 7420 220a 2020 2020 2020 2020 2268 6176  t ".        "hav
-0004eb20: 6520 7468 6569 7220 6f77 6e20 220a 2020  e their own ".  
-0004eb30: 2020 2020 2020 2253 534c 2063 6572 7469        "SSL certi
-0004eb40: 6669 6361 7465 2e20 5468 6973 2061 6c6c  ficate. This all
-0004eb50: 6f77 7320 796f 7520 746f 2075 7365 2048  ows you to use H
-0004eb60: 5454 5053 2f54 4c53 2066 6f72 2074 6865  TTPS/TLS for the
-0004eb70: 2063 6f6e 6e65 6374 696f 6e20 220a 2020   connection ".  
-0004eb80: 2020 2020 2020 2277 6869 6c65 2075 7369        "while usi
-0004eb90: 6e67 2079 6f75 7220 6f77 6e20 6c6f 6361  ng your own loca
-0004eba0: 6c20 5353 4c20 6365 7274 6966 6963 6174  l SSL certificat
-0004ebb0: 652e 2053 7065 6369 6679 2074 6865 2070  e. Specify the p
-0004ebc0: 6174 6820 616e 6420 220a 2020 2020 2020  ath and ".      
-0004ebd0: 2020 2766 696c 6520 746f 2079 6f75 7220    'file to your 
-0004ebe0: 5353 4c20 6365 7274 6966 6963 6174 652e  SSL certificate.
-0004ebf0: 2049 6620 7573 6564 2074 6f67 6574 6865   If used togethe
-0004ec00: 7220 7769 7468 2074 6865 2022 2d2d 6e6f  r with the "--no
-0004ec10: 2d73 736c 2220 270a 2020 2020 2020 2020  -ssl" '.        
-0004ec20: 2270 6172 616d 6574 6572 2c20 7468 6973  "parameter, this
-0004ec30: 206f 7074 696f 6e20 6973 206d 6561 6e69   option is meani
-0004ec40: 6e67 6c65 7373 2061 6e64 2061 6e20 6572  ngless and an er
-0004ec50: 726f 7220 7769 6c6c 2062 6520 7261 6973  ror will be rais
-0004ec60: 6564 2e22 2c0a 2020 2020 290a 2020 2020  ed.",.    ).    
-0004ec70: 6170 2e61 6464 5f61 7267 756d 656e 7428  ap.add_argument(
-0004ec80: 0a20 2020 2020 2020 2022 2d2d 6669 6c65  .        "--file
-0004ec90: 2d6e 616d 6522 2c0a 2020 2020 2020 2020  -name",.        
-0004eca0: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
-0004ecb0: 2020 2020 2020 2020 6163 7469 6f6e 3d22          action="
-0004ecc0: 6578 7465 6e64 222c 0a20 2020 2020 2020  extend",.       
-0004ecd0: 206e 6172 6773 3d22 2b22 2c0a 2020 2020   nargs="+",.    
-0004ece0: 2020 2020 7479 7065 3d73 7472 2c0a 2020      type=str,.  
-0004ecf0: 2020 2020 2020 6d65 7461 7661 723d 2246        metavar="F
-0004ed00: 494c 4522 2c0a 2020 2020 2020 2020 6865  ILE",.        he
-0004ed10: 6c70 3d22 5370 6563 6966 7920 6f6e 6520  lp="Specify one 
-0004ed20: 6f72 206d 756c 7469 706c 6520 6669 6c65  or multiple file
-0004ed30: 206e 616d 6573 2066 6f72 2073 6f6d 6520   names for some 
-0004ed40: 6163 7469 6f6e 732e 2022 0a20 2020 2020  actions. ".     
-0004ed50: 2020 2022 4465 7461 696c 733a 3a20 5468     "Details:: Th
-0004ed60: 6973 2069 7320 616e 206f 7074 696f 6e61  is is an optiona
-0004ed70: 6c20 6172 6775 6d65 6e74 2e20 5573 6520  l argument. Use 
-0004ed80: 7468 6973 206f 7074 696f 6e20 220a 2020  this option ".  
-0004ed90: 2020 2020 2020 2269 6e20 636f 6d62 696e        "in combin
-0004eda0: 6174 696f 6e20 7769 7468 206f 7074 696f  ation with optio
-0004edb0: 6e73 206c 696b 6520 2d2d 646f 776e 6c6f  ns like --downlo
-0004edc0: 6164 2074 6f20 7370 6563 6966 7920 6f6e  ad to specify on
-0004edd0: 6520 6f72 2022 0a20 2020 2020 2020 2022  e or ".        "
-0004ede0: 6d75 6c74 6970 6c65 2066 696c 6520 6e61  multiple file na
-0004edf0: 6d65 732e 2022 0a20 2020 2020 2020 2022  mes. ".        "
-0004ee00: 4967 6e6f 7265 6420 6966 2075 7365 6420  Ignored if used 
-0004ee10: 6279 2069 7473 656c 6620 7769 7468 6f75  by itself withou
-0004ee20: 7420 616e 2061 7070 726f 7072 6961 7465  t an appropriate
-0004ee30: 2063 6f72 7265 7370 6f6e 6469 6e67 2022   corresponding "
-0004ee40: 0a20 2020 2020 2020 2022 6163 7469 6f6e  .        "action
-0004ee50: 2e22 2c0a 2020 2020 290a 2020 2020 6170  .",.    ).    ap
-0004ee60: 2e61 6464 5f61 7267 756d 656e 7428 0a20  .add_argument(. 
-0004ee70: 2020 2020 2020 2022 2d2d 6b65 792d 6469         "--key-di
-0004ee80: 6374 222c 0a20 2020 2020 2020 2072 6571  ct",.        req
-0004ee90: 7569 7265 643d 4661 6c73 652c 0a20 2020  uired=False,.   
-0004eea0: 2020 2020 2061 6374 696f 6e3d 2265 7874       action="ext
-0004eeb0: 656e 6422 2c0a 2020 2020 2020 2020 6e61  end",.        na
-0004eec0: 7267 733d 222b 222c 0a20 2020 2020 2020  rgs="+",.       
-0004eed0: 2074 7970 653d 7374 722c 0a20 2020 2020   type=str,.     
-0004eee0: 2020 206d 6574 6176 6172 3d22 4b45 595f     metavar="KEY_
-0004eef0: 4449 4354 494f 4e41 5259 222c 0a20 2020  DICTIONARY",.   
-0004ef00: 2020 2020 2068 656c 703d 2253 7065 6369       help="Speci
-0004ef10: 6679 206f 6e65 206f 7220 6d75 6c74 6970  fy one or multip
-0004ef20: 6c65 206b 6579 2064 6963 7469 6f6e 6172  le key dictionar
-0004ef30: 6965 7320 666f 7220 6465 6372 7970 7469  ies for decrypti
-0004ef40: 6f6e 2e20 220a 2020 2020 2020 2020 2244  on. ".        "D
-0004ef50: 6574 6169 6c73 3a3a 204f 6e65 206f 7220  etails:: One or 
-0004ef60: 6d75 6c74 6970 6c65 2064 6563 7279 7074  multiple decrypt
-0004ef70: 696f 6e20 220a 2020 2020 2020 2020 2264  ion ".        "d
-0004ef80: 6963 7469 6f6e 6172 6965 7320 6172 6520  ictionaries are 
-0004ef90: 7072 6f76 6964 6564 2062 7920 7468 6520  provided by the 
-0004efa0: 2d2d 7570 6c6f 6164 2061 6374 696f 6e20  --upload action 
-0004efb0: 6173 2061 2072 6573 756c 742e 2022 0a20  as a result. ". 
-0004efc0: 2020 2020 2020 2022 4120 6465 6372 7970         "A decryp
-0004efd0: 7469 6f6e 2064 6963 7469 6f6e 6172 7920  tion dictionary 
-0004efe0: 6973 2061 2073 7472 696e 6720 6c69 6b65  is a string like
-0004eff0: 2074 6869 733a 2022 0a20 2020 2020 2020   this: ".       
-0004f000: 2022 5c22 7b27 7627 3a20 2776 3227 2c20   "\"{'v': 'v2', 
-0004f010: 276b 6579 273a 207b 276b 7479 273a 2027  'key': {'kty': '
-0004f020: 6f63 7427 2c20 2761 6c67 273a 2027 4132  oct', 'alg': 'A2
-0004f030: 3536 4354 5227 2c20 2765 7874 273a 2054  56CTR', 'ext': T
-0004f040: 7275 652c 2022 0a20 2020 2020 2020 2022  rue, ".        "
-0004f050: 276b 273a 2027 736f 6d65 6b65 7927 2c20  'k': 'somekey', 
-0004f060: 276b 6579 5f6f 7073 273a 205b 2765 6e63  'key_ops': ['enc
-0004f070: 7279 7074 272c 2027 6465 6372 7970 7427  rypt', 'decrypt'
-0004f080: 5d7d 2c20 220a 2020 2020 2020 2020 2227  ]}, ".        "'
-0004f090: 6976 273a 2027 736f 6d65 6976 272c 2027  iv': 'someiv', '
-0004f0a0: 6861 7368 6573 273a 207b 2773 6861 3235  hashes': {'sha25
-0004f0b0: 3627 3a20 2773 6f6d 6553 4841 277d 7d5c  6': 'someSHA'}}\
-0004f0c0: 222e 2049 6620 796f 7520 6861 7665 2061  ". If you have a
-0004f0d0: 2022 0a20 2020 2020 2020 2022 6c69 7374   ".        "list
-0004f0e0: 206f 6620 6b65 7920 6469 6374 696f 6e61   of key dictiona
-0004f0f0: 7269 6573 2061 6e64 2077 616e 7420 746f  ries and want to
-0004f100: 2073 6b69 7020 6f6e 652c 2075 7365 2074   skip one, use t
-0004f110: 6865 2065 6d70 7479 2073 7472 696e 672e  he empty string.
-0004f120: 222c 0a20 2020 2029 0a20 2020 2061 702e  ",.    ).    ap.
-0004f130: 6164 645f 6172 6775 6d65 6e74 280a 2020  add_argument(.  
-0004f140: 2020 2020 2020 222d 2d70 6c61 696e 222c        "--plain",
-0004f150: 0a20 2020 2020 2020 2072 6571 7569 7265  .        require
-0004f160: 643d 4661 6c73 652c 0a20 2020 2020 2020  d=False,.       
-0004f170: 2061 6374 696f 6e3d 2273 746f 7265 5f74   action="store_t
-0004f180: 7275 6522 2c0a 2020 2020 2020 2020 6865  rue",.        he
-0004f190: 6c70 3d22 4469 7361 626c 6520 656e 6372  lp="Disable encr
-0004f1a0: 7970 7469 6f6e 2066 6f72 2061 2073 7065  yption for a spe
-0004f1b0: 6369 6669 6320 6163 7469 6f6e 2e20 220a  cific action. ".
-0004f1c0: 2020 2020 2020 2020 2244 6574 6169 6c73          "Details
-0004f1d0: 3a3a 2042 7920 6465 6661 756c 742c 2022  :: By default, "
-0004f1e0: 0a20 2020 2020 2020 2022 6576 6572 7974  .        "everyt
-0004f1f0: 6869 6e67 2069 7320 616c 7761 7973 2065  hing is always e
-0004f200: 6e63 7279 7074 6564 2e20 220a 2020 2020  ncrypted. ".    
-0004f210: 2020 2020 2241 6374 696f 6e73 2074 6861      "Actions tha
-0004f220: 7420 7375 7070 6f72 7420 7468 6973 206f  t support this o
-0004f230: 7074 696f 6e20 6172 653a 202d 2d75 706c  ption are: --upl
-0004f240: 6f61 642c 202d 2d72 6f6f 6d2d 6372 6561  oad, --room-crea
-0004f250: 7465 2c20 220a 2020 2020 2020 2020 2261  te, ".        "a
-0004f260: 6e64 202d 2d72 6f6f 6d2d 646d 2d63 7265  nd --room-dm-cre
-0004f270: 6174 652e 2022 0a20 2020 2020 2020 2022  ate. ".        "
-0004f280: 526f 6f6d 7320 6172 6520 6279 2064 6566  Rooms are by def
-0004f290: 6175 6c74 2063 7265 6174 6564 2065 6e63  ault created enc
-0004f2a0: 7279 7074 6564 3b20 220a 2020 2020 2020  rypted; ".      
-0004f2b0: 2020 2274 6f20 6f76 6572 7772 6974 6520    "to overwrite 
-0004f2c0: 7468 6174 2061 6e64 2074 6f20 6372 6561  that and to crea
-0004f2d0: 7465 2061 2072 6f6f 6d20 7769 7468 2065  te a room with e
-0004f2e0: 6e63 7279 7074 696f 6e20 6469 7361 626c  ncryption disabl
-0004f2f0: 6564 2022 0a20 2020 2020 2020 2022 7573  ed ".        "us
-0004f300: 6520 272d 2d70 6c61 696e 272e 2053 6565  e '--plain'. See
-0004f310: 2074 6865 2069 6e64 6976 6964 7561 6c20   the individual 
-0004f320: 636f 6d6d 616e 6473 2e22 2c0a 2020 2020  commands.",.    
-0004f330: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
-0004f340: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
-0004f350: 2d2d 7365 7061 7261 746f 7222 2c0a 2020  --separator",.  
-0004f360: 2020 2020 2020 7265 7175 6972 6564 3d46        required=F
-0004f370: 616c 7365 2c0a 2020 2020 2020 2020 7479  alse,.        ty
-0004f380: 7065 3d73 7472 2c0a 2020 2020 2020 2020  pe=str,.        
-0004f390: 6465 6661 756c 743d 4445 4641 554c 545f  default=DEFAULT_
-0004f3a0: 5345 5041 5241 544f 522c 2020 2320 6465  SEPARATOR,  # de
-0004f3b0: 6661 756c 7473 2074 6f20 5345 5020 6966  faults to SEP if
-0004f3c0: 206e 6f74 2075 7365 640a 2020 2020 2020   not used.      
-0004f3d0: 2020 2320 5465 7874 2069 7320 7363 616e    # Text is scan
-0004f3e0: 6e65 6420 616e 6420 7265 7065 6174 6564  ned and repeated
-0004f3f0: 2073 7061 6365 7320 6172 6520 7265 6d6f   spaces are remo
-0004f400: 7665 732c 2073 6f20 2220 2020 2022 0a20  ves, so "    ". 
-0004f410: 2020 2020 2020 2023 206f 7220 7b44 4546         # or {DEF
-0004f420: 4155 4c54 5f53 4550 4152 4154 4f52 7d20  AULT_SEPARATOR} 
-0004f430: 7769 6c6c 2062 6520 7472 756e 6361 7465  will be truncate
-0004f440: 6420 746f 2022 2022 2e20 4865 6e63 6520  d to " ". Hence 
-0004f450: 2234 2073 7061 6365 7322 0a20 2020 2020  "4 spaces".     
-0004f460: 2020 206d 6574 6176 6172 3d22 5345 5041     metavar="SEPA
-0004f470: 5241 544f 5222 2c0a 2020 2020 2020 2020  RATOR",.        
-0004f480: 6865 6c70 3d22 5365 7420 6120 6375 7374  help="Set a cust
-0004f490: 6f6d 2073 6570 6172 6174 6f72 2075 7365  om separator use
-0004f4a0: 6420 666f 7220 6365 7274 6169 6e20 7072  d for certain pr
-0004f4b0: 696e 7420 6f75 7473 2e20 220a 2020 2020  int outs. ".    
-0004f4c0: 2020 2020 2244 6574 6169 6c73 3a3a 2042      "Details:: B
-0004f4d0: 7920 6465 6661 756c 742c 2069 2e65 2e20  y default, i.e. 
-0004f4e0: 6966 202d 2d73 6570 6172 6174 6f72 2069  if --separator i
-0004f4f0: 7320 6e6f 7420 7573 6564 2c20 220a 2020  s not used, ".  
-0004f500: 2020 2020 2020 2234 2073 7061 6365 7320        "4 spaces 
-0004f510: 6172 6520 7573 6564 2061 7320 220a 2020  are used as ".  
-0004f520: 2020 2020 2020 2273 6570 6172 6174 6f72        "separator
-0004f530: 2062 6574 7765 656e 2063 6f6c 756d 6e73   between columns
-0004f540: 2069 6e20 7072 696e 7420 7374 6174 656d   in print statem
-0004f550: 656e 7473 2e20 596f 7520 636f 756c 6420  ents. You could 
-0004f560: 7365 7420 220a 2020 2020 2020 2020 2269  set ".        "i
-0004f570: 7420 746f 2027 5c5c 7427 2069 6620 796f  t to '\\t' if yo
-0004f580: 7520 7072 6566 6572 2061 2074 6162 2c20  u prefer a tab, 
-0004f590: 6275 7420 7461 6273 2061 7265 2075 7375  but tabs are usu
-0004f5a0: 616c 6c79 2072 6570 6c61 6365 6420 220a  ally replaced ".
-0004f5b0: 2020 2020 2020 2020 2277 6974 6820 7370          "with sp
-0004f5c0: 6163 6573 2062 7920 7468 6520 7465 726d  aces by the term
-0004f5d0: 696e 616c 2e20 536f 2c20 7468 6174 206d  inal. So, that m
-0004f5e0: 6967 6874 206e 6f74 2067 6976 6520 796f  ight not give yo
-0004f5f0: 7520 7768 6174 2079 6f75 2022 0a20 2020  u what you ".   
-0004f600: 2020 2020 2022 7761 6e74 2e20 4d61 7962       "want. Mayb
-0004f610: 6520 2720 7c7c 2027 2069 7320 616e 2061  e ' || ' is an a
-0004f620: 6c74 6572 6e61 7469 7665 2063 686f 6963  lternative choic
-0004f630: 652e 222c 0a20 2020 2029 0a20 2020 2061  e.",.    ).    a
-0004f640: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
-0004f650: 2020 2020 2020 2020 222d 2d61 6363 6573          "--acces
-0004f660: 732d 746f 6b65 6e22 2c0a 2020 2020 2020  s-token",.      
-0004f670: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
-0004f680: 2c0a 2020 2020 2020 2020 7479 7065 3d73  ,.        type=s
-0004f690: 7472 2c0a 2020 2020 2020 2020 6d65 7461  tr,.        meta
-0004f6a0: 7661 723d 2241 4343 4553 535f 544f 4b45  var="ACCESS_TOKE
-0004f6b0: 4e22 2c0a 2020 2020 2020 2020 6865 6c70  N",.        help
-0004f6c0: 3d22 5365 7420 6120 6375 7374 6f6d 2061  ="Set a custom a
-0004f6d0: 6363 6573 7320 746f 6b65 6e20 666f 7220  ccess token for 
-0004f6e0: 7573 6520 6279 2063 6572 7461 696e 2061  use by certain a
-0004f6f0: 6374 696f 6e73 2e20 220a 2020 2020 2020  ctions. ".      
-0004f700: 2020 2244 6574 6169 6c73 3a3a 2049 7420    "Details:: It 
-0004f710: 6973 2061 6e20 6f70 7469 6f6e 616c 2061  is an optional a
-0004f720: 7267 756d 656e 742e 2022 0a20 2020 2020  rgument. ".     
-0004f730: 2020 2022 4279 2064 6566 6175 6c74 202d     "By default -
-0004f740: 2d61 6363 6573 732d 746f 6b65 6e20 6973  -access-token is
-0004f750: 2069 676e 6f72 6564 2061 6e64 206e 6f74   ignored and not
-0004f760: 2075 7365 642e 2022 0a20 2020 2020 2020   used. ".       
-0004f770: 2022 4974 2069 7320 7573 6564 2062 7920   "It is used by 
-0004f780: 7468 6520 2d2d 6465 6c65 7465 2d6d 7863  the --delete-mxc
-0004f790: 2c20 2d2d 6465 6c65 7465 2d6d 7863 2d62  , --delete-mxc-b
-0004f7a0: 6566 6f72 652c 2022 0a20 2020 2020 2020  efore, ".       
-0004f7b0: 2022 616e 6420 2d2d 7265 7374 2061 6374   "and --rest act
-0004f7c0: 696f 6e73 2e22 2c0a 2020 2020 290a 2020  ions.",.    ).  
-0004f7d0: 2020 6170 2e61 6464 5f61 7267 756d 656e    ap.add_argumen
-0004f7e0: 7428 0a20 2020 2020 2020 2022 2d2d 7061  t(.        "--pa
-0004f7f0: 7373 776f 7264 222c 0a20 2020 2020 2020  ssword",.       
-0004f800: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
-0004f810: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
-0004f820: 722c 0a20 2020 2020 2020 206d 6574 6176  r,.        metav
-0004f830: 6172 3d22 5041 5353 574f 5244 222c 0a20  ar="PASSWORD",. 
-0004f840: 2020 2020 2020 2068 656c 703d 2253 7065         help="Spe
-0004f850: 6369 6679 2061 2070 6173 7377 6f72 6420  cify a password 
-0004f860: 666f 7220 7573 6520 6279 2063 6572 7461  for use by certa
-0004f870: 696e 2061 6374 696f 6e73 2e20 220a 2020  in actions. ".  
-0004f880: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
-0004f890: 2049 7420 6973 2061 6e20 6f70 7469 6f6e   It is an option
-0004f8a0: 616c 2061 7267 756d 656e 742e 2022 0a20  al argument. ". 
-0004f8b0: 2020 2020 2020 2022 4279 2064 6566 6175         "By defau
-0004f8c0: 6c74 202d 2d70 6173 7377 6f72 6420 6973  lt --password is
-0004f8d0: 2069 676e 6f72 6564 2061 6e64 206e 6f74   ignored and not
-0004f8e0: 2075 7365 642e 2022 0a20 2020 2020 2020   used. ".       
-0004f8f0: 2022 4974 2069 7320 7573 6564 2062 7920   "It is used by 
-0004f900: 272d 2d6c 6f67 696e 2070 6173 7377 6f72  '--login passwor
-0004f910: 6427 2061 6e64 2027 2d2d 6465 6c65 7465  d' and '--delete
-0004f920: 2d64 6576 6963 6527 2022 0a20 2020 2020  -device' ".     
-0004f930: 2020 2022 6163 7469 6f6e 732e 2022 0a20     "actions. ". 
-0004f940: 2020 2020 2020 2022 4966 206e 6f74 2070         "If not p
-0004f950: 726f 7669 6465 6420 666f 7220 2d2d 6c6f  rovided for --lo
-0004f960: 6769 6e20 7468 6520 7573 6572 2077 696c  gin the user wil
-0004f970: 6c20 6265 2071 7565 7269 6564 2076 6961  l be queried via
-0004f980: 206b 6579 626f 6172 642e 222c 0a20 2020   keyboard.",.   
-0004f990: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
-0004f9a0: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
-0004f9b0: 222d 2d68 6f6d 6573 6572 7665 7222 2c0a  "--homeserver",.
-0004f9c0: 2020 2020 2020 2020 7265 7175 6972 6564          required
-0004f9d0: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-0004f9e0: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
-0004f9f0: 2020 6d65 7461 7661 723d 2248 4f4d 4553    metavar="HOMES
-0004fa00: 4552 5645 525f 5552 4c22 2c0a 2020 2020  ERVER_URL",.    
-0004fa10: 2020 2020 6865 6c70 3d22 5370 6563 6966      help="Specif
-0004fa20: 7920 6120 686f 6d65 7365 7276 6572 2066  y a homeserver f
-0004fa30: 6f72 2075 7365 2062 7920 6365 7274 6169  or use by certai
-0004fa40: 6e20 6163 7469 6f6e 732e 2022 0a20 2020  n actions. ".   
-0004fa50: 2020 2020 2022 4465 7461 696c 733a 3a20       "Details:: 
-0004fa60: 4974 2069 7320 616e 206f 7074 696f 6e61  It is an optiona
-0004fa70: 6c20 6172 6775 6d65 6e74 2e20 220a 2020  l argument. ".  
-0004fa80: 2020 2020 2020 2242 7920 6465 6661 756c        "By defaul
-0004fa90: 7420 2d2d 686f 6d65 7365 7276 6572 2069  t --homeserver i
-0004faa0: 7320 6967 6e6f 7265 6420 616e 6420 6e6f  s ignored and no
-0004fab0: 7420 7573 6564 2e20 220a 2020 2020 2020  t used. ".      
-0004fac0: 2020 2249 7420 6973 2075 7365 6420 6279    "It is used by
-0004fad0: 2027 2d2d 6c6f 6769 6e27 2061 6374 696f   '--login' actio
-0004fae0: 6e2e 2022 0a20 2020 2020 2020 2022 4966  n. ".        "If
-0004faf0: 206e 6f74 2070 726f 7669 6465 6420 666f   not provided fo
-0004fb00: 7220 2d2d 6c6f 6769 6e20 7468 6520 7573  r --login the us
-0004fb10: 6572 2077 696c 6c20 6265 2071 7565 7269  er will be queri
-0004fb20: 6564 2076 6961 206b 6579 626f 6172 642e  ed via keyboard.
-0004fb30: 222c 0a20 2020 2029 0a20 2020 2061 702e  ",.    ).    ap.
-0004fb40: 6164 645f 6172 6775 6d65 6e74 280a 2020  add_argument(.  
-0004fb50: 2020 2020 2020 222d 2d64 6576 6963 6522        "--device"
-0004fb60: 2c20 2023 2064 6f20 6e6f 7420 636f 6e66  ,  # do not conf
-0004fb70: 7573 6520 7769 7468 202d 2d64 6576 6963  use with --devic
-0004fb80: 6573 0a20 2020 2020 2020 2072 6571 7569  es.        requi
-0004fb90: 7265 643d 4661 6c73 652c 0a20 2020 2020  red=False,.     
-0004fba0: 2020 2074 7970 653d 7374 722c 2020 2320     type=str,  # 
-0004fbb0: 6465 7669 6365 2069 642c 2064 6576 6963  device id, devic
-0004fbc0: 6520 6e61 6d65 0a20 2020 2020 2020 206d  e name.        m
-0004fbd0: 6574 6176 6172 3d22 4445 5649 4345 5f4e  etavar="DEVICE_N
-0004fbe0: 414d 4522 2c0a 2020 2020 2020 2020 6865  AME",.        he
-0004fbf0: 6c70 3d22 5370 6563 6966 7920 6120 6465  lp="Specify a de
-0004fc00: 7669 6365 206e 616d 652c 2066 6f72 2075  vice name, for u
-0004fc10: 7365 2062 7920 6365 7274 6169 6e20 6163  se by certain ac
-0004fc20: 7469 6f6e 732e 2022 0a20 2020 2020 2020  tions. ".       
-0004fc30: 2022 4465 7461 696c 733a 3a20 4974 2069   "Details:: It i
-0004fc40: 7320 616e 206f 7074 696f 6e61 6c20 6172  s an optional ar
-0004fc50: 6775 6d65 6e74 2e20 220a 2020 2020 2020  gument. ".      
-0004fc60: 2020 2242 7920 6465 6661 756c 7420 2d2d    "By default --
-0004fc70: 6465 7669 6365 2069 7320 6967 6e6f 7265  device is ignore
-0004fc80: 6420 616e 6420 6e6f 7420 7573 6564 2e20  d and not used. 
-0004fc90: 220a 2020 2020 2020 2020 2249 7420 6973  ".        "It is
-0004fca0: 2075 7365 6420 6279 2027 2d2d 6c6f 6769   used by '--logi
-0004fcb0: 6e27 2061 6374 696f 6e2e 2022 0a20 2020  n' action. ".   
-0004fcc0: 2020 2020 2022 4966 206e 6f74 2070 726f       "If not pro
-0004fcd0: 7669 6465 6420 666f 7220 2d2d 6c6f 6769  vided for --logi
-0004fce0: 6e20 7468 6520 7573 6572 2077 696c 6c20  n the user will 
-0004fcf0: 6265 2071 7565 7269 6564 2076 6961 206b  be queried via k
-0004fd00: 6579 626f 6172 642e 2022 0a20 2020 2020  eyboard. ".     
-0004fd10: 2020 2022 4966 2079 6f75 2077 616e 7420     "If you want 
-0004fd20: 7468 6520 6465 6661 756c 7420 7661 6c75  the default valu
-0004fd30: 6520 7370 6563 6966 7920 2727 2e20 220a  e specify ''. ".
-0004fd40: 2020 2020 2020 2020 224d 756c 7469 706c          "Multipl
-0004fd50: 6520 6465 7669 6365 7320 2877 6974 6820  e devices (with 
-0004fd60: 6469 6666 6572 656e 7420 6465 7669 6365  different device
-0004fd70: 2069 6429 206d 6179 2068 6176 6520 7468   id) may have th
-0004fd80: 6520 7361 6d65 2064 6576 6963 6520 220a  e same device ".
-0004fd90: 2020 2020 2020 2020 226e 616d 652e 2049          "name. I
-0004fda0: 6e20 7368 6f72 742c 2074 6865 2073 616d  n short, the sam
-0004fdb0: 6520 6465 7669 6365 206e 616d 6520 6361  e device name ca
-0004fdc0: 6e20 6265 2061 7373 6967 6e65 6420 746f  n be assigned to
-0004fdd0: 206d 756c 7469 706c 6520 220a 2020 2020   multiple ".    
-0004fde0: 2020 2020 2264 6966 6665 7265 6e74 2064      "different d
-0004fdf0: 6576 6963 6573 2069 6620 6465 7369 7265  evices if desire
-0004fe00: 642e 222c 0a20 2020 2029 0a20 2020 2061  d.",.    ).    a
-0004fe10: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
-0004fe20: 2020 2020 2020 2020 222d 2d73 796e 6322          "--sync"
-0004fe30: 2c0a 2020 2020 2020 2020 7265 7175 6972  ,.        requir
-0004fe40: 6564 3d46 616c 7365 2c0a 2020 2020 2020  ed=False,.      
-0004fe50: 2020 7479 7065 3d73 7472 2c20 2023 2073    type=str,  # s
-0004fe60: 796e 6320 6d65 7468 6f64 3a20 6f66 662c  ync method: off,
-0004fe70: 2066 756c 6c2c 2028 7061 7274 6961 6c29   full, (partial)
-0004fe80: 0a20 2020 2020 2020 206d 6574 6176 6172  .        metavar
-0004fe90: 3d22 4655 4c4c 7c4f 4646 222c 0a20 2020  ="FULL|OFF",.   
-0004fea0: 2020 2020 2068 656c 703d 2243 686f 6f73       help="Choos
-0004feb0: 6520 7379 6e63 6872 6f6e 697a 6174 696f  e synchronizatio
-0004fec0: 6e20 6f70 7469 6f6e 732e 2022 0a20 2020  n options. ".   
-0004fed0: 2020 2020 2022 4465 7461 696c 733a 3a20       "Details:: 
-0004fee0: 5468 6973 206f 7074 696f 6e20 6465 6369  This option deci
-0004fef0: 6465 7320 6f6e 2077 6865 7468 6572 2074  des on whether t
-0004ff00: 6865 2070 726f 6772 616d 2022 0a20 2020  he program ".   
-0004ff10: 2020 2020 2022 7379 6e63 6872 6f6e 697a       "synchroniz
-0004ff20: 6573 2074 6865 2073 7461 7465 2077 6974  es the state wit
-0004ff30: 6820 7468 6520 7365 7276 6572 2062 6566  h the server bef
-0004ff40: 6f72 6520 6120 2773 656e 6427 2061 6374  ore a 'send' act
-0004ff50: 696f 6e2e 2022 0a20 2020 2020 2020 2066  ion. ".        f
-0004ff60: 2243 7572 7265 6e74 6c79 2074 776f 2063  "Currently two c
-0004ff70: 686f 6963 6573 2061 7265 206f 6666 6572  hoices are offer
-0004ff80: 6564 3a20 277b 5359 4e43 5f46 554c 4c7d  ed: '{SYNC_FULL}
-0004ff90: 2720 616e 6420 277b 5359 4e43 5f4f 4646  ' and '{SYNC_OFF
-0004ffa0: 7d27 2e20 220a 2020 2020 2020 2020 2250  }'. ".        "P
-0004ffb0: 726f 7669 6465 206f 6e65 206f 6620 7468  rovide one of th
-0004ffc0: 6573 6520 6368 6f69 6365 732e 2022 0a20  ese choices. ". 
-0004ffd0: 2020 2020 2020 2066 2254 6865 2064 6566         f"The def
-0004ffe0: 6175 6c74 2069 7320 277b 5359 4e43 5f44  ault is '{SYNC_D
-0004fff0: 4546 4155 4c54 7d27 2e20 4966 2079 6f75  EFAULT}'. If you
-00050000: 2077 616e 7420 746f 2075 7365 2074 6865   want to use the
-00050010: 2064 6566 6175 6c74 2c20 220a 2020 2020   default, ".    
-00050020: 2020 2020 2274 6865 6e20 7468 6572 6520      "then there 
-00050030: 6973 206e 6f20 6e65 6564 2074 6f20 7573  is no need to us
-00050040: 6520 7468 6973 206f 7074 696f 6e2e 2022  e this option. "
-00050050: 0a20 2020 2020 2020 2066 2249 6620 796f  .        f"If yo
-00050060: 7520 6861 7665 2063 686f 7365 6e20 277b  u have chosen '{
-00050070: 5359 4e43 5f46 554c 4c7d 272c 2022 0a20  SYNC_FULL}', ". 
-00050080: 2020 2020 2020 2022 7468 6520 6675 6c6c         "the full
-00050090: 2073 7461 7465 2c20 616c 6c20 7374 6174   state, all stat
-000500a0: 6520 6576 656e 7473 2077 696c 6c20 6265  e events will be
-000500b0: 2073 796e 6368 726f 6e69 7a65 6420 6265   synchronized be
-000500c0: 7477 6565 6e20 220a 2020 2020 2020 2020  tween ".        
-000500d0: 2274 6869 7320 7072 6f67 7261 6d20 616e  "this program an
-000500e0: 6420 7468 6520 7365 7276 6572 2062 6566  d the server bef
-000500f0: 6f72 6520 6120 2773 656e 6427 2e20 220a  ore a 'send'. ".
-00050100: 2020 2020 2020 2020 6622 4966 2079 6f75          f"If you
-00050110: 2068 6176 6520 6368 6f73 656e 2027 7b53   have chosen '{S
-00050120: 594e 435f 4f46 467d 272c 2022 0a20 2020  YNC_OFF}', ".   
-00050130: 2020 2020 2022 7379 6e63 6872 6f6e 697a       "synchroniz
-00050140: 6174 696f 6e20 7769 6c6c 2062 6520 736b  ation will be sk
-00050150: 6970 7065 6420 656e 7469 7265 6c79 2062  ipped entirely b
-00050160: 6566 6f72 6520 7468 6520 2773 656e 6427  efore the 'send'
-00050170: 2022 0a20 2020 2020 2020 2022 7768 6963   ".        "whic
-00050180: 6820 7769 6c6c 2069 6d70 726f 7665 2070  h will improve p
-00050190: 6572 666f 726d 616e 6365 2e22 2c0a 2020  erformance.",.  
-000501a0: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
-000501b0: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
-000501c0: 2022 2d6f 222c 2020 2320 696e 636f 6d70   "-o",  # incomp
-000501d0: 6174 6962 6c65 2063 6861 6e67 6520 4465  atible change De
-000501e0: 6320 3230 3232 2c20 2d6f 206d 6f76 6564  c 2022, -o moved
-000501f0: 2066 726f 6d20 2d2d 6f73 2d6e 6f74 6966   from --os-notif
-00050200: 790a 2020 2020 2020 2020 222d 2d6f 7574  y.        "--out
-00050210: 7075 7422 2c0a 2020 2020 2020 2020 7265  put",.        re
-00050220: 7175 6972 6564 3d46 616c 7365 2c0a 2020  quired=False,.  
-00050230: 2020 2020 2020 7479 7065 3d73 7472 2c20        type=str, 
-00050240: 2023 206f 7574 7075 7420 6d65 7468 6f64   # output method
-00050250: 3a20 7465 7874 2c20 6a73 6f6e 2c20 6a73  : text, json, js
-00050260: 6f6e 2d6d 6178 2c20 2e2e 2e0a 2020 2020  on-max, ....    
-00050270: 2020 2020 6465 6661 756c 743d 4f55 5450      default=OUTP
-00050280: 5554 5f44 4546 4155 4c54 2c20 2023 2077  UT_DEFAULT,  # w
-00050290: 6865 6e20 2d2d 6f75 7470 7574 2069 7320  hen --output is 
-000502a0: 6e6f 7420 7573 6564 0a20 2020 2020 2020  not used.       
-000502b0: 206d 6574 6176 6172 3d22 5445 5854 7c4a   metavar="TEXT|J
-000502c0: 534f 4e7c 4a53 4f4e 2d4d 4158 7c4a 534f  SON|JSON-MAX|JSO
-000502d0: 4e2d 5350 4543 222c 0a20 2020 2020 2020  N-SPEC",.       
-000502e0: 2068 656c 703d 2253 656c 6563 7420 616e   help="Select an
-000502f0: 206f 7574 7075 7420 666f 726d 6174 2e20   output format. 
-00050300: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
-00050310: 6c73 3a3a 2054 6869 7320 6f70 7469 6f6e  ls:: This option
-00050320: 2064 6563 6964 6573 206f 6e20 686f 7720   decides on how 
-00050330: 7468 6520 6f75 7470 7574 2069 7320 7072  the output is pr
-00050340: 6573 656e 7465 642e 2022 0a20 2020 2020  esented. ".     
-00050350: 2020 2066 2243 7572 7265 6e74 6c79 206f     f"Currently o
-00050360: 6666 6572 6564 2063 686f 6963 6573 2061  ffered choices a
-00050370: 7265 3a20 277b 4f55 5450 5554 5f54 4558  re: '{OUTPUT_TEX
-00050380: 547d 272c 2027 7b4f 5554 5055 545f 4a53  T}', '{OUTPUT_JS
-00050390: 4f4e 7d27 2c20 220a 2020 2020 2020 2020  ON}', ".        
-000503a0: 6622 277b 4f55 5450 5554 5f4a 534f 4e5f  f"'{OUTPUT_JSON_
-000503b0: 4d41 587d 272c 2061 6e64 2027 7b4f 5554  MAX}', and '{OUT
-000503c0: 5055 545f 4a53 4f4e 5f53 5045 437d 272e  PUT_JSON_SPEC}'.
-000503d0: 2022 0a20 2020 2020 2020 2022 5072 6f76   ".        "Prov
-000503e0: 6964 6520 6f6e 6520 6f66 2074 6865 7365  ide one of these
-000503f0: 2063 686f 6963 6573 2e20 220a 2020 2020   choices. ".    
-00050400: 2020 2020 6622 5468 6520 6465 6661 756c      f"The defaul
-00050410: 7420 6973 2027 7b4f 5554 5055 545f 4445  t is '{OUTPUT_DE
-00050420: 4641 554c 547d 272e 2049 6620 796f 7520  FAULT}'. If you 
-00050430: 7761 6e74 2074 6f20 7573 6520 7468 6520  want to use the 
-00050440: 6465 6661 756c 742c 2022 0a20 2020 2020  default, ".     
-00050450: 2020 2022 7468 656e 2074 6865 7265 2069     "then there i
-00050460: 7320 6e6f 206e 6565 6420 746f 2075 7365  s no need to use
-00050470: 2074 6869 7320 6f70 7469 6f6e 2e20 220a   this option. ".
-00050480: 2020 2020 2020 2020 6622 4966 2079 6f75          f"If you
-00050490: 2068 6176 6520 6368 6f73 656e 2027 7b4f   have chosen '{O
-000504a0: 5554 5055 545f 5445 5854 7d27 2c20 220a  UTPUT_TEXT}', ".
-000504b0: 2020 2020 2020 2020 2274 6865 206f 7574          "the out
-000504c0: 7075 7420 7769 6c6c 2062 6520 666f 726d  put will be form
-000504d0: 6174 7465 6420 7769 7468 2074 6865 2069  atted with the i
-000504e0: 6e74 656e 7469 6f6e 2074 6f20 6265 2022  ntention to be "
-000504f0: 0a20 2020 2020 2020 2022 636f 6e73 756d  .        "consum
-00050500: 6564 2062 7920 6875 6d61 6e73 2c20 692e  ed by humans, i.
-00050510: 652e 2072 6561 6461 626c 6520 7465 7874  e. readable text
-00050520: 2e20 220a 2020 2020 2020 2020 6622 4966  . ".        f"If
-00050530: 2079 6f75 2068 6176 6520 6368 6f73 656e   you have chosen
-00050540: 2027 7b4f 5554 5055 545f 4a53 4f4e 7d27   '{OUTPUT_JSON}'
-00050550: 2c20 220a 2020 2020 2020 2020 2274 6865  , ".        "the
-00050560: 206f 7574 7075 7420 7769 6c6c 2062 6520   output will be 
-00050570: 666f 726d 6174 7465 6420 6173 204a 534f  formatted as JSO
-00050580: 4e2e 2022 0a20 2020 2020 2020 2022 5468  N. ".        "Th
-00050590: 6520 636f 6e74 656e 7420 6f66 2074 6865  e content of the
-000505a0: 204a 534f 4e20 6f62 6a65 6374 206d 6174   JSON object mat
-000505b0: 6368 6573 2074 6865 2064 6174 6120 7072  ches the data pr
-000505c0: 6f76 6964 6564 2062 7920 7468 6520 220a  ovided by the ".
-000505d0: 2020 2020 2020 2020 226d 6174 7269 782d          "matrix-
-000505e0: 6e69 6f20 5344 4b2e 2049 6e20 736f 6d65  nio SDK. In some
-000505f0: 206f 6363 6173 696f 6e73 2074 6865 206f   occasions the o
-00050600: 7574 7075 7420 6973 2065 6e68 616e 6365  utput is enhance
-00050610: 6420 220a 2020 2020 2020 2020 2262 7920  d ".        "by 
-00050620: 6861 7669 6e67 2061 2066 6577 2065 7874  having a few ext
-00050630: 7261 2064 6174 6120 6974 656d 7320 6164  ra data items ad
-00050640: 6465 6420 666f 7220 636f 6e76 656e 6965  ded for convenie
-00050650: 6e63 652e 2022 0a20 2020 2020 2020 2022  nce. ".        "
-00050660: 496e 206d 6f73 7420 6361 7365 7320 7468  In most cases th
-00050670: 6520 6f75 7470 7574 2077 696c 6c20 6265  e output will be
-00050680: 2070 726f 6365 7373 6564 2062 7920 6f74   processed by ot
-00050690: 6865 7220 7072 6f67 7261 6d73 2022 0a20  her programs ". 
-000506a0: 2020 2020 2020 2022 7261 7468 6572 2074         "rather t
-000506b0: 6861 6e20 7265 6164 2062 7920 6875 6d61  han read by huma
-000506c0: 6e73 2e20 220a 2020 2020 2020 2020 6622  ns. ".        f"
-000506d0: 4f70 7469 6f6e 2027 7b4f 5554 5055 545f  Option '{OUTPUT_
-000506e0: 4a53 4f4e 5f4d 4158 7d27 2069 7320 7072  JSON_MAX}' is pr
-000506f0: 6163 7469 6361 6c6c 7920 7468 6520 7361  actically the sa
-00050700: 6d65 2061 7320 220a 2020 2020 2020 2020  me as ".        
-00050710: 6622 277b 4f55 5450 5554 5f4a 534f 4e7d  f"'{OUTPUT_JSON}
-00050720: 272c 2022 0a20 2020 2020 2020 2022 6275  ', ".        "bu
-00050730: 7420 7965 7420 616e 6f74 6865 7220 6164  t yet another ad
-00050740: 6469 7469 6f6e 616c 2066 6965 6c64 2069  ditional field i
-00050750: 7320 6164 6465 642e 2022 0a20 2020 2020  s added. ".     
-00050760: 2020 2022 5468 6520 6461 7461 2069 7465     "The data ite
-00050770: 6d20 2774 7261 6e73 706f 7274 5f72 6573  m 'transport_res
-00050780: 706f 6e73 6527 2077 6869 6368 2067 6976  ponse' which giv
-00050790: 6573 2069 6e66 6f72 6d61 7469 6f6e 206f  es information o
-000507a0: 6e20 220a 2020 2020 2020 2020 2268 6f77  n ".        "how
-000507b0: 2074 6865 2064 6174 6120 7761 7320 6f62   the data was ob
-000507c0: 7461 696e 6564 2061 6e64 2074 7261 6e73  tained and trans
-000507d0: 706f 7274 6564 2069 7320 616c 736f 2062  ported is also b
-000507e0: 6569 6e67 2061 6464 6564 2e20 220a 2020  eing added. ".  
-000507f0: 2020 2020 2020 2246 6f72 2027 2d2d 6c69        "For '--li
-00050800: 7374 656e 2720 6120 6665 7720 6d6f 7265  sten' a few more
-00050810: 2066 6965 6c64 7320 6172 6520 6164 6465   fields are adde
-00050820: 642e 2022 0a20 2020 2020 2020 2022 496e  d. ".        "In
-00050830: 206d 6f73 7420 6361 7365 7320 7468 6520   most cases the 
-00050840: 6f75 7470 7574 2077 696c 6c20 6265 2070  output will be p
-00050850: 726f 6365 7373 6564 2062 7920 6f74 6865  rocessed by othe
-00050860: 7220 7072 6f67 7261 6d73 2022 0a20 2020  r programs ".   
-00050870: 2020 2020 2022 7261 7468 6572 2074 6861       "rather tha
-00050880: 6e20 7265 6164 2062 7920 6875 6d61 6e73  n read by humans
-00050890: 2e20 220a 2020 2020 2020 2020 6622 4f70  . ".        f"Op
-000508a0: 7469 6f6e 2027 7b4f 5554 5055 545f 4a53  tion '{OUTPUT_JS
-000508b0: 4f4e 5f53 5045 437d 2720 6f6e 6c79 2070  ON_SPEC}' only p
-000508c0: 7269 6e74 7320 696e 666f 726d 6174 696f  rints informatio
-000508d0: 6e20 7468 6174 2061 6468 6572 6573 2022  n that adheres "
-000508e0: 0a20 2020 2020 2020 2022 312d 746f 2d31  .        "1-to-1
-000508f0: 2074 6f20 7468 6520 4d61 7472 6978 2053   to the Matrix S
-00050900: 7065 6369 6669 6361 7469 6f6e 2e20 4375  pecification. Cu
-00050910: 7272 656e 746c 7920 6f6e 6c79 2074 6865  rrently only the
-00050920: 2065 7665 6e74 7320 220a 2020 2020 2020   events ".      
-00050930: 2020 226f 6e20 272d 2d6c 6973 7465 6e27    "on '--listen'
-00050940: 2061 6e64 2027 2d2d 7461 696c 2720 7072   and '--tail' pr
-00050950: 6f76 6964 6520 6461 7461 2065 7861 6374  ovide data exact
-00050960: 6c79 2061 7320 696e 2074 6865 2022 0a20  ly as in the ". 
-00050970: 2020 2020 2020 2022 4d61 7472 6978 2053         "Matrix S
-00050980: 7065 6369 6669 6361 7469 6f6e 2e20 4966  pecification. If
-00050990: 206e 6f20 6461 7461 2069 7320 6176 6169   no data is avai
-000509a0: 6c61 626c 6520 7468 6174 2063 6f72 7265  lable that corre
-000509b0: 7370 6f6e 6473 2022 0a20 2020 2020 2020  sponds ".       
-000509c0: 2022 6578 6163 746c 7920 7769 7468 2074   "exactly with t
-000509d0: 6865 204d 6174 7269 7820 5370 6563 6966  he Matrix Specif
-000509e0: 6963 6174 696f 6e2c 206e 6f20 6461 7461  ication, no data
-000509f0: 2077 696c 6c20 6265 2070 7269 6e74 6564   will be printed
-00050a00: 2e20 220a 2020 2020 2020 2020 2249 6e20  . ".        "In 
-00050a10: 7368 6f72 742c 2063 7572 7265 6e74 6c79  short, currently
-00050a20: 2027 2d2d 6a73 6f6e 2d73 7065 6327 206f   '--json-spec' o
-00050a30: 6e6c 7920 7072 6f76 6964 6573 206f 7574  nly provides out
-00050a40: 7075 7473 2066 6f72 2022 0a20 2020 2020  puts for ".     
-00050a50: 2020 2022 272d 2d6c 6973 7465 6e27 2061     "'--listen' a
-00050a60: 6e64 2027 2d2d 7461 696c 272e 2041 6c6c  nd '--tail'. All
-00050a70: 206f 7468 6572 2061 7267 756d 656e 7473   other arguments
-00050a80: 206c 696b 6520 272d 2d67 6574 2d72 6f6f   like '--get-roo
-00050a90: 6d2d 696e 666f 2720 220a 2020 2020 2020  m-info' ".      
-00050aa0: 2020 2277 696c 6c20 7072 696e 7420 6e6f    "will print no
-00050ab0: 206f 7574 7075 742e 2022 2c0a 2020 2020   output. ",.    
-00050ac0: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
-00050ad0: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
-00050ae0: 2d76 222c 2020 2320 696e 636f 6d70 6174  -v",  # incompat
-00050af0: 6962 6c65 2063 6861 6e67 6520 4465 6320  ible change Dec 
-00050b00: 3230 3232 2c20 2d76 206d 6f76 6564 2068  2022, -v moved h
-00050b10: 6572 6520 6672 6f6d 202d 2d76 6572 6966  ere from --verif
-00050b20: 790a 2020 2020 2020 2020 222d 5622 2c20  y.        "-V", 
-00050b30: 2023 2065 7863 6570 7469 6f6e 2c20 616c   # exception, al
-00050b40: 6c6f 7720 616c 736f 2075 7070 6572 6361  low also upperca
-00050b50: 7365 2056 0a20 2020 2020 2020 2022 2d2d  se V.        "--
-00050b60: 7665 7273 696f 6e22 2c0a 2020 2020 2020  version",.      
-00050b70: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
-00050b80: 2c0a 2020 2020 2020 2020 7479 7065 3d73  ,.        type=s
-00050b90: 7472 2c0a 2020 2020 2020 2020 6465 6661  tr,.        defa
-00050ba0: 756c 743d 5645 5253 494f 4e5f 554e 5553  ult=VERSION_UNUS
-00050bb0: 4544 5f44 4546 4155 4c54 2c20 2023 2077  ED_DEFAULT,  # w
-00050bc0: 6865 6e20 2d74 2069 7320 6e6f 7420 7573  hen -t is not us
-00050bd0: 6564 0a20 2020 2020 2020 206e 6172 6773  ed.        nargs
-00050be0: 3d22 3f22 2c20 2023 206d 616b 6573 2074  ="?",  # makes t
-00050bf0: 6865 2077 6f72 6420 6f70 7469 6f6e 616c  he word optional
-00050c00: 0a20 2020 2020 2020 2023 2077 6865 6e20  .        # when 
-00050c10: 2d76 2069 7320 7573 6564 2c20 6275 7420  -v is used, but 
-00050c20: 7465 7874 2069 7320 6e6f 7420 6164 6465  text is not adde
-00050c30: 640a 2020 2020 2020 2020 636f 6e73 743d  d.        const=
-00050c40: 5645 5253 494f 4e5f 5553 4544 5f44 4546  VERSION_USED_DEF
-00050c50: 4155 4c54 2c0a 2020 2020 2020 2020 6d65  AULT,.        me
-00050c60: 7461 7661 723d 2250 5249 4e54 7c43 4845  tavar="PRINT|CHE
-00050c70: 434b 222c 0a20 2020 2020 2020 2068 656c  CK",.        hel
-00050c80: 703d 2250 7269 6e74 2076 6572 7369 6f6e  p="Print version
-00050c90: 2069 6e66 6f72 6d61 7469 6f6e 206f 7220   information or 
-00050ca0: 6368 6563 6b20 666f 7220 7570 6461 7465  check for update
-00050cb0: 732e 2022 0a20 2020 2020 2020 2022 4465  s. ".        "De
-00050cc0: 7461 696c 733a 3a20 5468 6973 206f 7074  tails:: This opt
-00050cd0: 696f 6e20 7461 6b65 7320 7a65 726f 206f  ion takes zero o
-00050ce0: 7220 6f6e 6520 6172 6775 6d65 6e74 2e20  r one argument. 
-00050cf0: 220a 2020 2020 2020 2020 6622 4966 206e  ".        f"If n
-00050d00: 6f20 6172 6775 6d65 6e74 2069 7320 6769  o argument is gi
-00050d10: 7665 6e2c 2027 7b50 5249 4e54 7d27 2069  ven, '{PRINT}' i
-00050d20: 7320 6173 7375 6d65 6420 7768 6963 6820  s assumed which 
-00050d30: 7769 6c6c 2022 0a20 2020 2020 2020 2066  will ".        f
-00050d40: 2270 7269 6e74 2074 6865 2076 6572 7369  "print the versi
-00050d50: 6f6e 206f 6620 7468 6520 6375 7272 656e  on of the curren
-00050d60: 746c 7920 696e 7374 616c 6c65 6420 2750  tly installed 'P
-00050d70: 524f 475f 5749 5448 4f55 545f 4558 5427  ROG_WITHOUT_EXT'
-00050d80: 2022 0a20 2020 2020 2020 2066 2270 6163   ".        f"pac
-00050d90: 6b61 6765 2e20 277b 4348 4543 4b7d 2720  kage. '{CHECK}' 
-00050da0: 6973 2074 6865 2061 6c74 6572 6e61 7469  is the alternati
-00050db0: 7665 2e20 220a 2020 2020 2020 2020 2227  ve. ".        "'
-00050dc0: 7b43 4845 434b 7d27 2063 6f6e 6e65 6374  {CHECK}' connect
-00050dd0: 7320 746f 2068 7474 7073 3a2f 2f70 7970  s to https://pyp
-00050de0: 692e 6f72 6720 616e 6420 6765 7473 2074  i.org and gets t
-00050df0: 6865 2076 6572 7369 6f6e 2022 0a20 2020  he version ".   
-00050e00: 2020 2020 2022 6e75 6d62 6572 206f 6620       "number of 
-00050e10: 6c61 7465 7374 2073 7461 626c 6520 7265  latest stable re
-00050e20: 6c65 6173 652e 2054 6865 7265 2069 7320  lease. There is 
-00050e30: 6e6f 2027 6361 6c6c 696e 6720 686f 6d65  no 'calling home
-00050e40: 2720 220a 2020 2020 2020 2020 226f 6e20  ' ".        "on 
-00050e50: 6576 6572 7920 7275 6e2c 206f 6e6c 7920  every run, only 
-00050e60: 6120 2763 6865 636b 2070 7970 692e 6f72  a 'check pypi.or
-00050e70: 6727 2075 706f 6e20 7265 7175 6573 742e  g' upon request.
-00050e80: 2059 6f75 7220 220a 2020 2020 2020 2020   Your ".        
-00050e90: 2270 7269 7661 6379 2069 7320 7072 6f74  "privacy is prot
-00050ea0: 6563 7465 642e 2054 6865 206e 6577 2072  ected. The new r
-00050eb0: 656c 6561 7365 2069 7320 6e65 6974 6865  elease is neithe
-00050ec0: 7220 646f 776e 6c6f 6164 6564 2c20 220a  r downloaded, ".
-00050ed0: 2020 2020 2020 2020 226e 6f72 2069 6e73          "nor ins
-00050ee0: 7461 6c6c 6564 2e20 4974 206a 7573 7420  talled. It just 
-00050ef0: 696e 666f 726d 7320 796f 752e 2022 0a20  informs you. ". 
-00050f00: 2020 2020 2020 2022 4166 7465 7220 7072         "After pr
-00050f10: 696e 7469 6e67 2076 6572 7369 6f6e 2069  inting version i
-00050f20: 6e66 6f72 6d61 7469 6f6e 2074 6865 2022  nformation the "
-00050f30: 0a20 2020 2020 2020 2022 7072 6f67 7261  .        "progra
-00050f40: 6d20 7769 6c6c 2063 6f6e 7469 6e75 6520  m will continue 
-00050f50: 746f 2072 756e 2e20 5468 6973 2069 7320  to run. This is 
-00050f60: 7573 6566 756c 2066 6f72 2068 6176 696e  useful for havin
-00050f70: 6720 7665 7273 696f 6e20 220a 2020 2020  g version ".    
-00050f80: 2020 2020 226e 756d 6265 7220 696e 2074      "number in t
-00050f90: 6865 206c 6f67 2066 696c 6573 2e22 2c0a  he log files.",.
-00050fa0: 2020 2020 290a 2020 2020 6773 2e70 6120      ).    gs.pa 
-00050fb0: 3d20 6170 2e70 6172 7365 5f61 7267 7328  = ap.parse_args(
-00050fc0: 290a 2020 2020 2320 7772 6170 2061 6e64  ).    # wrap and
-00050fd0: 2069 6e64 656e 743a 2068 7474 7073 3a2f   indent: https:/
-00050fe0: 2f74 6f77 6172 6473 6461 7461 7363 6965  /towardsdatascie
-00050ff0: 6e63 652e 636f 6d2f 362d 6661 6e63 792d  nce.com/6-fancy-
-00051000: 6275 696c 742d 696e 2d74 6578 742d 0a20  built-in-text-. 
-00051010: 2020 2023 2020 2020 2020 2020 2020 2020     #            
-00051020: 2020 2020 2020 7772 6170 7069 6e67 2d74        wrapping-t
-00051030: 6563 686e 6971 7565 732d 696e 2d70 7974  echniques-in-pyt
-00051040: 686f 6e2d 6137 3863 6335 3763 3235 3636  hon-a78cc57c2566
-00051050: 0a20 2020 2023 2069 6620 6f75 7470 7574  .    # if output
-00051060: 2069 7320 6e6f 7420 5454 592c 2074 6865   is not TTY, the
-00051070: 6e20 646f 6e27 7420 6164 6420 636f 6c6f  n don't add colo
-00051080: 7273 2c20 652e 672e 2077 6865 6e20 6f75  rs, e.g. when ou
-00051090: 7470 7574 2069 7320 7069 7065 640a 2020  tput is piped.  
-000510a0: 2020 6966 2073 7973 2e73 7464 6f75 742e    if sys.stdout.
-000510b0: 6973 6174 7479 2829 3a0a 2020 2020 2020  isatty():.      
-000510c0: 2020 2320 596f 7527 7265 2072 756e 6e69    # You're runni
-000510d0: 6e67 2069 6e20 6120 7265 616c 2074 6572  ng in a real ter
-000510e0: 6d69 6e61 6c0a 2020 2020 2020 2020 2320  minal.        # 
-000510f0: 636f 6c6f 7273 0a20 2020 2020 2020 2023  colors.        #
-00051100: 2061 6461 7074 2077 6964 7468 0a20 2020   adapt width.   
-00051110: 2020 2020 2074 6572 6d5f 7769 6474 6820       term_width 
-00051120: 3d20 6f73 2e67 6574 5f74 6572 6d69 6e61  = os.get_termina
-00051130: 6c5f 7369 7a65 2829 5b30 5d0a 2020 2020  l_size()[0].    
-00051140: 2020 2020 2320 7072 696e 7428 2274 6572      # print("ter
-00051150: 6d69 6e61 6c20 7769 6474 6820 222c 2074  minal width ", t
-00051160: 6572 6d5f 7769 6474 6829 0a20 2020 2020  erm_width).     
-00051170: 2020 2063 6f6e 203d 2063 6f6c 6f72 732e     con = colors.
-00051180: 6667 2e67 7265 656e 0a20 2020 2020 2020  fg.green.       
-00051190: 2063 6f66 6620 3d20 636f 6c6f 7273 2e72   coff = colors.r
-000511a0: 6573 6574 0a20 2020 2020 2020 2065 6f6e  eset.        eon
-000511b0: 203d 2063 6f6c 6f72 732e 626f 6c64 202b   = colors.bold +
-000511c0: 2063 6f6e 0a20 2020 2020 2020 2065 6f66   con.        eof
-000511d0: 6620 3d20 636f 6c6f 7273 2e72 6573 6574  f = colors.reset
-000511e0: 202b 2063 6f6e 0a20 2020 2065 6c73 653a   + con.    else:
-000511f0: 0a20 2020 2020 2020 2023 2059 6f75 2772  .        # You'r
-00051200: 6520 6265 696e 6720 7069 7065 6420 6f72  e being piped or
-00051210: 2072 6564 6972 6563 7465 640a 2020 2020   redirected.    
-00051220: 2020 2020 2320 6e6f 2043 6f6c 6f72 730a      # no Colors.
-00051230: 2020 2020 2020 2020 2320 7769 6474 6820          # width 
-00051240: 3d20 3830 0a20 2020 2020 2020 2074 6572  = 80.        ter
-00051250: 6d5f 7769 6474 6820 3d20 3830 0a20 2020  m_width = 80.   
-00051260: 2020 2020 2023 2070 7269 6e74 2822 6e6f       # print("no
-00051270: 7420 696e 2074 6572 6d69 6e61 6c2c 2075  t in terminal, u
-00051280: 7369 6e67 2064 6566 6175 6c74 2074 6572  sing default ter
-00051290: 6d69 6e61 6c20 7769 6474 6820 222c 2074  minal width ", t
-000512a0: 6572 6d5f 7769 6474 6829 0a20 2020 2020  erm_width).     
-000512b0: 2020 2063 6f6e 203d 2022 220a 2020 2020     con = "".    
-000512c0: 2020 2020 636f 6666 203d 2022 220a 2020      coff = "".  
-000512d0: 2020 2020 2020 656f 6e20 3d20 2222 0a20        eon = "". 
-000512e0: 2020 2020 2020 2065 6f66 6620 3d20 2222         eoff = ""
-000512f0: 0a20 2020 2069 6620 6773 2e70 612e 7573  .    if gs.pa.us
-00051300: 6167 653a 0a20 2020 2020 2020 2070 7269  age:.        pri
-00051310: 6e74 2874 6578 7477 7261 702e 6669 6c6c  nt(textwrap.fill
-00051320: 2861 702e 6465 7363 7269 7074 696f 6e2c  (ap.description,
-00051330: 2077 6964 7468 3d74 6572 6d5f 7769 6474   width=term_widt
-00051340: 6829 290a 2020 2020 2020 2020 7072 696e  h)).        prin
-00051350: 7428 2222 290a 2020 2020 2020 2020 6170  t("").        ap
-00051360: 2e70 7269 6e74 5f75 7361 6765 2829 0a20  .print_usage(). 
-00051370: 2020 2020 2020 2070 7269 6e74 2822 2229         print("")
-00051380: 0a20 2020 2020 2020 2070 7269 6e74 2874  .        print(t
-00051390: 6578 7477 7261 702e 6669 6c6c 2861 702e  extwrap.fill(ap.
-000513a0: 6570 696c 6f67 2c20 7769 6474 683d 7465  epilog, width=te
-000513b0: 726d 5f77 6964 7468 2929 0a20 2020 2020  rm_width)).     
-000513c0: 2020 2072 6574 7572 6e20 300a 2020 2020     return 0.    
-000513d0: 6966 2067 732e 7061 2e68 656c 703a 0a20  if gs.pa.help:. 
-000513e0: 2020 2020 2020 2070 7269 6e74 2874 6578         print(tex
-000513f0: 7477 7261 702e 6669 6c6c 2861 702e 6465  twrap.fill(ap.de
-00051400: 7363 7269 7074 696f 6e2c 2077 6964 7468  scription, width
-00051410: 3d74 6572 6d5f 7769 6474 6829 290a 2020  =term_width)).  
-00051420: 2020 2020 2020 7072 696e 7428 2222 290a        print("").
-00051430: 2020 2020 2020 2020 7072 696e 7428 0a20          print(. 
-00051440: 2020 2020 2020 2020 2020 2074 6578 7477             textw
-00051450: 7261 702e 6669 6c6c 280a 2020 2020 2020  rap.fill(.      
-00051460: 2020 2020 2020 2020 2020 6622 7b50 524f            f"{PRO
-00051470: 475f 5749 5448 4f55 545f 4558 547d 2073  G_WITHOUT_EXT} s
-00051480: 7570 706f 7274 7320 7468 6573 6520 6172  upports these ar
-00051490: 6775 6d65 6e74 733a 222c 0a20 2020 2020  guments:",.     
-000514a0: 2020 2020 2020 2020 2020 2077 6964 7468             width
-000514b0: 3d74 6572 6d5f 7769 6474 682c 0a20 2020  =term_width,.   
-000514c0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000514d0: 2020 2029 0a20 2020 2020 2020 2023 2070     ).        # p
-000514e0: 7269 6e74 2822 2229 0a20 2020 2020 2020  rint("").       
-000514f0: 2068 656c 705f 6865 6c70 5f70 7265 203d   help_help_pre =
-00051500: 2022 2222 0a3c 2d2d 7573 6167 653e 0a50   """.<--usage>.P
-00051510: 7269 6e74 2075 7361 6765 2e0a 3c2d 683e  rint usage..<-h>
-00051520: 2c20 3c2d 2d68 656c 703e 0a50 7269 6e74  , <--help>.Print
-00051530: 2068 656c 702e 0a3c 2d2d 6d61 6e75 616c   help..<--manual
-00051540: 3e0a 5072 696e 7420 6d61 6e75 616c 2e0a  >.Print manual..
-00051550: 3c2d 2d72 6561 646d 653e 0a50 7269 6e74  <--readme>.Print
-00051560: 2052 4541 444d 452e 6d64 2066 696c 652e   README.md file.
-00051570: 0a3c 2d64 3e2c 203c 2d2d 6465 6275 673e  .<-d>, <--debug>
-00051580: 0a50 7269 6e74 2064 6562 7567 2069 6e66  .Print debug inf
-00051590: 6f72 6d61 7469 6f6e 2e0a 3c2d 2d6c 6f67  ormation..<--log
-000515a0: 2d6c 6576 656c 3e20 4445 4255 477c 494e  -level> DEBUG|IN
-000515b0: 464f 7c57 4152 4e49 4e47 7c45 5252 4f52  FO|WARNING|ERROR
-000515c0: 7c43 5249 5449 4341 4c20 5b44 4542 5547  |CRITICAL [DEBUG
-000515d0: 7c49 4e46 4f7c 5741 524e 494e 477c 4552  |INFO|WARNING|ER
-000515e0: 524f 527c 4352 4954 4943 414c 202e 2e2e  ROR|CRITICAL ...
-000515f0: 5d0a 5365 7420 7468 6520 6c6f 6720 6c65  ].Set the log le
-00051600: 7665 6c28 7329 2e0a 3c2d 2d76 6572 626f  vel(s)..<--verbo
-00051610: 7365 3e0a 5365 7420 7468 6520 7665 7262  se>.Set the verb
-00051620: 6f73 6974 7920 6c65 7665 6c2e 0a3c 2d2d  osity level..<--
-00051630: 6c6f 6769 6e3e 2050 4153 5357 4f52 447c  login> PASSWORD|
-00051640: 5353 4f0a 4c6f 6769 6e20 746f 2061 6e64  SSO.Login to and
-00051650: 2061 7574 6865 6e74 6963 6174 6520 7769   authenticate wi
-00051660: 7468 2074 6865 204d 6174 7269 7820 686f  th the Matrix ho
-00051670: 6d65 7365 7276 6572 2e0a 3c2d 2d76 6572  meserver..<--ver
-00051680: 6966 793e 205b 454d 4f4a 495d 0a50 6572  ify> [EMOJI].Per
-00051690: 666f 726d 2076 6572 6966 6963 6174 696f  form verificatio
-000516a0: 6e2e 0a3c 2d2d 6c6f 676f 7574 3e20 4d45  n..<--logout> ME
-000516b0: 7c41 4c4c 0a4c 6f67 6f75 742e 0a3c 2d63  |ALL.Logout..<-c
-000516c0: 3e20 4352 4544 454e 5449 414c 535f 4649  > CREDENTIALS_FI
-000516d0: 4c45 2c20 3c2d 2d63 7265 6465 6e74 6961  LE, <--credentia
-000516e0: 6c73 3e20 4352 4544 454e 5449 414c 535f  ls> CREDENTIALS_
-000516f0: 4649 4c45 0a53 7065 6369 6679 206c 6f63  FILE.Specify loc
-00051700: 6174 696f 6e20 6f66 2063 7265 6465 6e74  ation of credent
-00051710: 6961 6c73 2066 696c 652e 0a3c 2d73 3e20  ials file..<-s> 
-00051720: 5354 4f52 455f 4449 5245 4354 4f52 592c  STORE_DIRECTORY,
-00051730: 203c 2d2d 7374 6f72 653e 2053 544f 5245   <--store> STORE
-00051740: 5f44 4952 4543 544f 5259 0a53 7065 6369  _DIRECTORY.Speci
-00051750: 6679 206c 6f63 6174 696f 6e20 6f66 2073  fy location of s
-00051760: 746f 7265 2064 6972 6563 746f 7279 2e0a  tore directory..
-00051770: 3c2d 723e 2052 4f4f 4d20 5b52 4f4f 4d20  <-r> ROOM [ROOM 
-00051780: 2e2e 2e5d 2c20 3c2d 2d72 6f6f 6d3e 2052  ...], <--room> R
-00051790: 4f4f 4d20 5b52 4f4f 4d20 2e2e 2e5d 0a53  OOM [ROOM ...].S
-000517a0: 7065 6369 6679 206f 6e65 206f 7220 6d75  pecify one or mu
-000517b0: 6c74 6970 6c65 2072 6f6f 6d73 2e0a 3c2d  ltiple rooms..<-
-000517c0: 2d72 6f6f 6d2d 6465 6661 756c 743e 2044  -room-default> D
-000517d0: 4546 4155 4c54 5f52 4f4f 4d0a 5370 6563  EFAULT_ROOM.Spec
-000517e0: 6966 7920 7468 6520 6465 6661 756c 7420  ify the default 
-000517f0: 726f 6f6d 2061 7420 2d2d 6c6f 6769 6e2e  room at --login.
-00051800: 0a3c 2d2d 726f 6f6d 2d63 7265 6174 653e  .<--room-create>
-00051810: 2052 4f4f 4d5f 414c 4941 5320 5b52 4f4f   ROOM_ALIAS [ROO
-00051820: 4d5f 414c 4941 5320 2e2e 2e5d 0a43 7265  M_ALIAS ...].Cre
-00051830: 6174 6520 6f6e 6520 6f72 206d 756c 7469  ate one or multi
-00051840: 706c 6520 726f 6f6d 7320 666f 7220 6769  ple rooms for gi
-00051850: 7665 6e20 616c 6961 7328 6573 292e 0a3c  ven alias(es)..<
-00051860: 2d2d 726f 6f6d 2d64 6d2d 6372 6561 7465  --room-dm-create
-00051870: 3e20 5553 4552 205b 5553 4552 202e 2e2e  > USER [USER ...
-00051880: 5d0a 4372 6561 7465 206f 6e65 206f 7220  ].Create one or 
-00051890: 6d75 6c74 6970 6c65 2044 4d20 726f 6f6d  multiple DM room
-000518a0: 7320 7769 7468 2074 6865 2073 7065 6369  s with the speci
-000518b0: 6669 6564 2075 7365 7273 2e0a 3c2d 2d72  fied users..<--r
-000518c0: 6f6f 6d2d 6a6f 696e 3e20 524f 4f4d 205b  oom-join> ROOM [
-000518d0: 524f 4f4d 202e 2e2e 5d0a 4a6f 696e 206f  ROOM ...].Join o
-000518e0: 6e65 2072 6f6f 6d20 6f72 206d 756c 7469  ne room or multi
-000518f0: 706c 6520 726f 6f6d 732e 0a3c 2d2d 726f  ple rooms..<--ro
-00051900: 6f6d 2d6c 6561 7665 3e20 524f 4f4d 205b  om-leave> ROOM [
-00051910: 524f 4f4d 202e 2e2e 5d0a 4c65 6176 6520  ROOM ...].Leave 
-00051920: 6f6e 6520 726f 6f6d 206f 7220 6d75 6c74  one room or mult
-00051930: 6970 6c65 2072 6f6f 6d73 2e0a 3c2d 2d72  iple rooms..<--r
-00051940: 6f6f 6d2d 666f 7267 6574 3e20 524f 4f4d  oom-forget> ROOM
-00051950: 205b 524f 4f4d 202e 2e2e 5d0a 466f 7267   [ROOM ...].Forg
-00051960: 6574 206f 6e65 2072 6f6f 6d20 6f72 206d  et one room or m
-00051970: 756c 7469 706c 6520 726f 6f6d 732e 0a3c  ultiple rooms..<
-00051980: 2d2d 726f 6f6d 2d69 6e76 6974 653e 2052  --room-invite> R
-00051990: 4f4f 4d20 5b52 4f4f 4d20 2e2e 2e5d 0a49  OOM [ROOM ...].I
-000519a0: 6e76 6974 6520 6f6e 6520 6f72 6520 6d6f  nvite one ore mo
-000519b0: 7265 2075 7365 7273 2074 6f20 6a6f 696e  re users to join
-000519c0: 206f 6e65 206f 7220 6d6f 7265 2072 6f6f   one or more roo
-000519d0: 6d73 2e0a 3c2d 2d72 6f6f 6d2d 6261 6e3e  ms..<--room-ban>
-000519e0: 2052 4f4f 4d20 5b52 4f4f 4d20 2e2e 2e5d   ROOM [ROOM ...]
-000519f0: 0a42 616e 206f 6e65 206f 7265 206d 6f72  .Ban one ore mor
-00051a00: 6520 7573 6572 7320 6672 6f6d 206f 6e65  e users from one
-00051a10: 206f 7220 6d6f 7265 2072 6f6f 6d73 2e0a   or more rooms..
-00051a20: 3c2d 2d72 6f6f 6d2d 756e 6261 6e3e 2052  <--room-unban> R
-00051a30: 4f4f 4d20 5b52 4f4f 4d20 2e2e 2e5d 0a55  OOM [ROOM ...].U
-00051a40: 6e62 616e 206f 6e65 206f 7265 206d 6f72  nban one ore mor
-00051a50: 6520 7573 6572 7320 6672 6f6d 206f 6e65  e users from one
-00051a60: 206f 7220 6d6f 7265 2072 6f6f 6d73 2e0a   or more rooms..
-00051a70: 3c2d 2d72 6f6f 6d2d 6b69 636b 3e20 524f  <--room-kick> RO
-00051a80: 4f4d 205b 524f 4f4d 202e 2e2e 5d0a 4b69  OM [ROOM ...].Ki
-00051a90: 636b 206f 6e65 206f 7265 206d 6f72 6520  ck one ore more 
-00051aa0: 7573 6572 7320 6672 6f6d 206f 6e65 206f  users from one o
-00051ab0: 7220 6d6f 7265 2072 6f6f 6d73 2e0a 3c2d  r more rooms..<-
-00051ac0: 753e 2055 5345 5220 5b55 5345 5220 2e2e  u> USER [USER ..
-00051ad0: 2e5d 2c20 3c2d 2d75 7365 723e 2055 5345  .], <--user> USE
-00051ae0: 5220 5b55 5345 5220 2e2e 2e5d 0a53 7065  R [USER ...].Spe
-00051af0: 6369 6679 206f 6e65 206f 7220 6d75 6c74  cify one or mult
-00051b00: 6970 6c65 2075 7365 7273 2e0a 3c2d 2d75  iple users..<--u
-00051b10: 7365 722d 6c6f 6769 6e3e 2055 5345 520a  ser-login> USER.
-00051b20: 5370 6563 6966 7920 7573 6572 2066 6f72  Specify user for
-00051b30: 202d 2d6c 6f67 696e 2e0a 3c2d 2d6e 616d   --login..<--nam
-00051b40: 653e 2052 4f4f 4d5f 4e41 4d45 205b 524f  e> ROOM_NAME [RO
-00051b50: 4f4d 5f4e 414d 4520 2e2e 2e5d 0a53 7065  OM_NAME ...].Spe
-00051b60: 6369 6679 206f 6e65 206f 7220 6d75 6c74  cify one or mult
-00051b70: 6970 6c65 2072 6f6f 6d20 6e61 6d65 732e  iple room names.
-00051b80: 0a3c 2d2d 746f 7069 633e 2052 4f4f 4d5f  .<--topic> ROOM_
-00051b90: 544f 5049 4320 5b52 4f4f 4d5f 544f 5049  TOPIC [ROOM_TOPI
-00051ba0: 4320 2e2e 2e5d 0a53 7065 6369 6679 206f  C ...].Specify o
-00051bb0: 6e65 206f 7220 6d75 6c74 6970 6c65 2072  ne or multiple r
-00051bc0: 6f6f 6d20 746f 7069 6373 2e0a 3c2d 2d61  oom topics..<--a
-00051bd0: 6c69 6173 3e20 524f 4f4d 5f41 4c49 4153  lias> ROOM_ALIAS
-00051be0: 205b 524f 4f4d 5f41 4c49 4153 202e 2e2e   [ROOM_ALIAS ...
-00051bf0: 5d0a 5370 6563 6966 7920 6f6e 6520 6f72  ].Specify one or
-00051c00: 206d 756c 7469 706c 6520 726f 6f6d 2061   multiple room a
-00051c10: 6c69 6173 6573 2e0a 3c2d 6d3e 2054 4558  liases..<-m> TEX
-00051c20: 5420 5b54 4558 5420 2e2e 2e5d 2c20 3c2d  T [TEXT ...], <-
-00051c30: 2d6d 6573 7361 6765 3e20 5445 5854 205b  -message> TEXT [
-00051c40: 5445 5854 202e 2e2e 5d0a 5365 6e64 206f  TEXT ...].Send o
-00051c50: 6e65 206f 7220 6d75 6c74 6970 6c65 2074  ne or multiple t
-00051c60: 6578 7420 6d65 7373 6167 6573 2e0a 3c2d  ext messages..<-
-00051c70: 693e 2049 4d41 4745 5f46 494c 4520 5b49  i> IMAGE_FILE [I
-00051c80: 4d41 4745 5f46 494c 4520 2e2e 2e5d 2c20  MAGE_FILE ...], 
-00051c90: 3c2d 2d69 6d61 6765 3e20 494d 4147 455f  <--image> IMAGE_
-00051ca0: 4649 4c45 205b 494d 4147 455f 4649 4c45  FILE [IMAGE_FILE
-00051cb0: 202e 2e2e 5d0a 5365 6e64 206f 6e65 206f   ...].Send one o
-00051cc0: 7220 6d75 6c74 6970 6c65 2069 6d61 6765  r multiple image
-00051cd0: 2066 696c 6573 2e0a 3c2d 613e 2041 5544   files..<-a> AUD
-00051ce0: 494f 5f46 494c 4520 5b41 5544 494f 5f46  IO_FILE [AUDIO_F
-00051cf0: 494c 4520 2e2e 2e5d 2c20 3c2d 2d61 7564  ILE ...], <--aud
-00051d00: 696f 3e20 4155 4449 4f5f 4649 4c45 205b  io> AUDIO_FILE [
-00051d10: 4155 4449 4f5f 4649 4c45 202e 2e2e 5d0a  AUDIO_FILE ...].
-00051d20: 5365 6e64 206f 6e65 206f 7220 6d75 6c74  Send one or mult
-00051d30: 6970 6c65 2061 7564 696f 2066 696c 6573  iple audio files
-00051d40: 2e0a 3c2d 663e 2046 494c 4520 5b46 494c  ..<-f> FILE [FIL
-00051d50: 4520 2e2e 2e5d 2c20 3c2d 2d66 696c 653e  E ...], <--file>
-00051d60: 2046 494c 4520 5b46 494c 4520 2e2e 2e5d   FILE [FILE ...]
-00051d70: 0a53 656e 6420 6f6e 6520 6f72 206d 756c  .Send one or mul
-00051d80: 7469 706c 6520 6669 6c65 7320 2865 2e67  tiple files (e.g
-00051d90: 2e20 5044 462c 2044 4f43 2c20 4d50 3429  . PDF, DOC, MP4)
-00051da0: 2e0a 3c2d 653e 204d 4154 5249 585f 4a53  ..<-e> MATRIX_JS
-00051db0: 4f4e 5f4f 424a 4543 5420 5b4d 4154 5249  ON_OBJECT [MATRI
-00051dc0: 585f 4a53 4f4e 5f4f 424a 4543 5420 2e2e  X_JSON_OBJECT ..
-00051dd0: 2e5d 2c20 3c2d 2d65 7665 6e74 3e20 4d41  .], <--event> MA
-00051de0: 5452 4958 5f4a 534f 4e5f 4f42 4a45 4354  TRIX_JSON_OBJECT
-00051df0: 205b 4d41 5452 4958 5f4a 534f 4e5f 4f42   [MATRIX_JSON_OB
-00051e00: 4a45 4354 202e 2e2e 5d0a 5365 6e64 2061  JECT ...].Send a
-00051e10: 204d 6174 7269 7820 4a53 4f4e 2065 7665   Matrix JSON eve
-00051e20: 6e74 2e0a 3c2d 773e 2c20 3c2d 2d68 746d  nt..<-w>, <--htm
-00051e30: 6c3e 0a53 656e 6420 6d65 7373 6167 6520  l>.Send message 
-00051e40: 6173 2066 6f72 6d61 7420 2248 544d 4c22  as format "HTML"
-00051e50: 2e0a 3c2d 7a3e 2c20 3c2d 2d6d 6172 6b64  ..<-z>, <--markd
-00051e60: 6f77 6e3e 0a53 656e 6420 6d65 7373 6167  own>.Send messag
-00051e70: 6520 6173 2066 6f72 6d61 7420 224d 4152  e as format "MAR
-00051e80: 4b44 4f57 4e22 2e0a 3c2d 6b3e 2c20 3c2d  KDOWN"..<-k>, <-
-00051e90: 2d63 6f64 653e 0a53 656e 6420 6d65 7373  -code>.Send mess
-00051ea0: 6167 6520 6173 2066 6f72 6d61 7420 2243  age as format "C
-00051eb0: 4f44 4522 2e0a 3c2d 703e 2053 4550 4152  ODE"..<-p> SEPAR
-00051ec0: 4154 4f52 2c20 3c2d 2d73 706c 6974 3e20  ATOR, <--split> 
-00051ed0: 5345 5041 5241 544f 520a 5370 6c69 7420  SEPARATOR.Split 
-00051ee0: 6d65 7373 6167 6520 7465 7874 2069 6e74  message text int
-00051ef0: 6f20 6d75 6c74 6970 6c65 204d 6174 7269  o multiple Matri
-00051f00: 7820 6d65 7373 6167 6573 2e0a 3c2d 2d63  x messages..<--c
-00051f10: 6f6e 6669 673e 2043 4f4e 4649 475f 4649  onfig> CONFIG_FI
-00051f20: 4c45 0a53 7065 6369 6679 2074 6865 206c  LE.Specify the l
-00051f30: 6f63 6174 696f 6e20 6f66 2061 2063 6f6e  ocation of a con
-00051f40: 6669 6720 6669 6c65 2e0a 3c2d 2d70 726f  fig file..<--pro
-00051f50: 7879 3e20 5052 4f58 590a 5370 6563 6966  xy> PROXY.Specif
-00051f60: 7920 6120 7072 6f78 7920 666f 7220 636f  y a proxy for co
-00051f70: 6e6e 6563 7469 7669 7479 2e0a 3c2d 6e3e  nnectivity..<-n>
-00051f80: 2c20 3c2d 2d6e 6f74 6963 653e 0a53 656e  , <--notice>.Sen
-00051f90: 6420 6d65 7373 6167 6520 6173 206e 6f74  d message as not
-00051fa0: 6963 652e 0a3c 2d2d 656e 6372 7970 7465  ice..<--encrypte
-00051fb0: 643e 0a53 656e 6420 6d65 7373 6167 6520  d>.Send message 
-00051fc0: 656e 642d 746f 2d65 6e64 2065 6e63 7279  end-to-end encry
-00051fd0: 7074 6564 2e0a 3c2d 6c3e 205b 4e45 5645  pted..<-l> [NEVE
-00051fe0: 527c 4f4e 4345 7c46 4f52 4556 4552 7c54  R|ONCE|FOREVER|T
-00051ff0: 4149 4c7c 414c 4c5d 2c20 3c2d 2d6c 6973  AIL|ALL], <--lis
-00052000: 7465 6e3e 205b 4e45 5645 527c 4f4e 4345  ten> [NEVER|ONCE
-00052010: 7c46 4f52 4556 4552 7c54 4149 4c7c 414c  |FOREVER|TAIL|AL
-00052020: 4c5d 0a50 7269 6e74 2072 6563 6569 7665  L].Print receive
-00052030: 6420 6d65 7373 6167 6573 2061 6e64 206c  d messages and l
-00052040: 6973 7465 6e20 746f 206d 6573 7361 6765  isten to message
-00052050: 732e 0a3c 2d74 3e20 5b4e 554d 4245 525d  s..<-t> [NUMBER]
-00052060: 2c20 3c2d 2d74 6169 6c3e 205b 4e55 4d42  , <--tail> [NUMB
-00052070: 4552 5d0a 5072 696e 7420 6c61 7374 206d  ER].Print last m
-00052080: 6573 7361 6765 732e 0a3c 2d79 3e2c 203c  essages..<-y>, <
-00052090: 2d2d 6c69 7374 656e 2d73 656c 663e 0a50  --listen-self>.P
-000520a0: 7269 6e74 2079 6f75 7220 6f77 6e20 6d65  rint your own me
-000520b0: 7373 6167 6573 2061 7320 7765 6c6c 2e0a  ssages as well..
-000520c0: 3c2d 2d70 7269 6e74 2d65 7665 6e74 2d69  <--print-event-i
-000520d0: 643e 0a50 7269 6e74 2065 7665 6e74 2069  d>.Print event i
-000520e0: 6473 206f 6620 7265 6365 6976 6564 206d  ds of received m
-000520f0: 6573 7361 6765 732e 0a3c 2d2d 646f 776e  essages..<--down
-00052100: 6c6f 6164 2d6d 6564 6961 3e20 5b44 4f57  load-media> [DOW
-00052110: 4e4c 4f41 445f 4449 5245 4354 4f52 595d  NLOAD_DIRECTORY]
-00052120: 0a44 6f77 6e6c 6f61 6420 6d65 6469 6120  .Download media 
-00052130: 6669 6c65 7320 7768 696c 6520 6c69 7374  files while list
-00052140: 656e 696e 672e 0a3c 2d2d 6f73 2d6e 6f74  ening..<--os-not
-00052150: 6966 793e 0a4e 6f74 6966 7920 6d65 206f  ify>.Notify me o
-00052160: 6620 6172 7269 7669 6e67 206d 6573 7361  f arriving messa
-00052170: 6765 732e 0a3c 2d2d 7365 742d 6465 7669  ges..<--set-devi
-00052180: 6365 2d6e 616d 653e 2044 4556 4943 455f  ce-name> DEVICE_
-00052190: 4e41 4d45 0a53 6574 206f 7220 7265 6e61  NAME.Set or rena
-000521a0: 6d65 2074 6865 2063 7572 7265 6e74 2064  me the current d
-000521b0: 6576 6963 652e 0a3c 2d2d 7365 742d 6469  evice..<--set-di
-000521c0: 7370 6c61 792d 6e61 6d65 3e20 4449 5350  splay-name> DISP
-000521d0: 4c41 595f 4e41 4d45 0a53 6574 206f 7220  LAY_NAME.Set or 
-000521e0: 7265 6e61 6d65 2074 6865 2064 6973 706c  rename the displ
-000521f0: 6179 206e 616d 652e 0a3c 2d2d 6765 742d  ay name..<--get-
-00052200: 6469 7370 6c61 792d 6e61 6d65 3e0a 4765  display-name>.Ge
-00052210: 7420 7468 6520 6469 7370 6c61 7920 6e61  t the display na
-00052220: 6d65 206f 6620 796f 7572 7365 6c66 2e0a  me of yourself..
-00052230: 3c2d 2d73 6574 2d70 7265 7365 6e63 653e  <--set-presence>
-00052240: 204f 4e4c 494e 457c 4f46 464c 494e 457c   ONLINE|OFFLINE|
-00052250: 554e 4156 4149 4c41 424c 450a 5365 7420  UNAVAILABLE.Set 
-00052260: 796f 7572 2070 7265 7365 6e63 652e 0a3c  your presence..<
-00052270: 2d2d 6765 742d 7072 6573 656e 6365 3e0a  --get-presence>.
-00052280: 4765 7420 796f 7572 2070 7265 7365 6e63  Get your presenc
-00052290: 652e 0a3c 2d2d 7570 6c6f 6164 3e20 4649  e..<--upload> FI
-000522a0: 4c45 205b 4649 4c45 202e 2e2e 5d0a 5570  LE [FILE ...].Up
-000522b0: 6c6f 6164 206f 6e65 206f 7220 6d75 6c74  load one or mult
-000522c0: 6970 6c65 2066 696c 6573 2074 6f20 7468  iple files to th
-000522d0: 6520 636f 6e74 656e 7420 7265 706f 7369  e content reposi
-000522e0: 746f 7279 2e0a 3c2d 2d64 6f77 6e6c 6f61  tory..<--downloa
-000522f0: 643e 204d 5843 5f55 5249 205b 4d58 435f  d> MXC_URI [MXC_
-00052300: 5552 4920 2e2e 2e5d 0a44 6f77 6e6c 6f61  URI ...].Downloa
-00052310: 6420 6f6e 6520 6f72 206d 756c 7469 706c  d one or multipl
-00052320: 6520 6669 6c65 7320 6672 6f6d 2074 6865  e files from the
-00052330: 2063 6f6e 7465 6e74 2072 6570 6f73 6974   content reposit
-00052340: 6f72 792e 0a3c 2d2d 6465 6c65 7465 2d6d  ory..<--delete-m
-00052350: 7863 3e20 4d58 435f 5552 4920 5b4d 5843  xc> MXC_URI [MXC
-00052360: 5f55 5249 202e 2e2e 5d0a 4465 6c65 7465  _URI ...].Delete
-00052370: 206f 6e65 206f 7220 6d75 6c74 6970 6c65   one or multiple
-00052380: 206f 626a 6563 7473 2066 726f 6d20 7468   objects from th
-00052390: 6520 636f 6e74 656e 7420 7265 706f 7369  e content reposi
-000523a0: 746f 7279 2e0a 3c2d 2d64 656c 6574 652d  tory..<--delete-
-000523b0: 6d78 632d 6265 666f 7265 3e20 5449 4d45  mxc-before> TIME
-000523c0: 5354 414d 5020 5b54 494d 4553 5441 4d50  STAMP [TIMESTAMP
-000523d0: 202e 2e2e 5d0a 4465 6c65 7465 206f 6c64   ...].Delete old
-000523e0: 206f 626a 6563 7473 2066 726f 6d20 7468   objects from th
-000523f0: 6520 636f 6e74 656e 7420 7265 706f 7369  e content reposi
-00052400: 746f 7279 0a3c 2d2d 6a6f 696e 6564 2d72  tory.<--joined-r
-00052410: 6f6f 6d73 3e0a 5072 696e 7420 7468 6520  ooms>.Print the 
-00052420: 6c69 7374 206f 6620 6a6f 696e 6564 2072  list of joined r
-00052430: 6f6f 6d73 2e0a 3c2d 2d6a 6f69 6e65 642d  ooms..<--joined-
-00052440: 6d65 6d62 6572 733e 2052 4f4f 4d20 5b52  members> ROOM [R
-00052450: 4f4f 4d20 2e2e 2e5d 0a50 7269 6e74 2074  OOM ...].Print t
-00052460: 6865 206c 6973 7420 6f66 206a 6f69 6e65  he list of joine
-00052470: 6420 6d65 6d62 6572 7320 666f 7220 6f6e  d members for on
-00052480: 6520 6f72 206d 756c 7469 706c 6520 726f  e or multiple ro
-00052490: 6f6d 732e 0a3c 2d2d 6d78 632d 746f 2d68  oms..<--mxc-to-h
-000524a0: 7474 703e 204d 5843 5f55 5249 205b 4d58  ttp> MXC_URI [MX
-000524b0: 435f 5552 4920 2e2e 2e5d 0a43 6f6e 7665  C_URI ...].Conve
-000524c0: 7274 204d 5843 2055 5249 7320 746f 2048  rt MXC URIs to H
-000524d0: 5454 5020 5552 4c73 2e0a 3c2d 2d64 6576  TTP URLs..<--dev
-000524e0: 6963 6573 2c3e 203c 2d2d 6765 742d 6465  ices,> <--get-de
-000524f0: 7669 6365 733e 0a50 7269 6e74 2074 6865  vices>.Print the
-00052500: 206c 6973 7420 6f66 2064 6576 6963 6573   list of devices
-00052510: 2e0a 3c2d 2d64 6973 636f 7665 7279 2d69  ..<--discovery-i
-00052520: 6e66 6f3e 0a50 7269 6e74 2064 6973 636f  nfo>.Print disco
-00052530: 7665 7279 2069 6e66 6f72 6d61 7469 6f6e  very information
-00052540: 2061 626f 7574 2063 7572 7265 6e74 2068   about current h
-00052550: 6f6d 6573 6572 7665 722e 0a3c 2d2d 6c6f  omeserver..<--lo
-00052560: 6769 6e2d 696e 666f 3e0a 5072 696e 7420  gin-info>.Print 
-00052570: 6c6f 6769 6e20 6d65 7468 6f64 7320 7375  login methods su
-00052580: 7070 6f72 7465 6420 6279 2074 6865 2068  pported by the h
-00052590: 6f6d 6573 6572 7665 722e 0a3c 2d2d 636f  omeserver..<--co
-000525a0: 6e74 656e 742d 7265 706f 7369 746f 7279  ntent-repository
-000525b0: 2d63 6f6e 6669 673e 0a50 7269 6e74 2074  -config>.Print t
-000525c0: 6865 2063 6f6e 7465 6e74 2072 6570 6f73  he content repos
-000525d0: 6974 6f72 7920 636f 6e66 6967 7572 6174  itory configurat
-000525e0: 696f 6e2e 0a3c 2d2d 7265 7374 3e20 5245  ion..<--rest> RE
-000525f0: 5354 5f4d 4554 484f 4420 4441 5441 2055  ST_METHOD DATA U
-00052600: 524c 205b 5245 5354 5f4d 4554 484f 4420  RL [REST_METHOD 
-00052610: 4441 5441 2055 524c 202e 2e2e 5d0a 5573  DATA URL ...].Us
-00052620: 6520 7468 6520 4d61 7472 6978 2043 6c69  e the Matrix Cli
-00052630: 656e 7420 5245 5354 2041 5049 2e0a 3c2d  ent REST API..<-
-00052640: 2d73 6574 2d61 7661 7461 723e 2041 5641  -set-avatar> AVA
-00052650: 5441 525f 4d58 435f 5552 490a 5365 7420  TAR_MXC_URI.Set 
-00052660: 796f 7572 2061 7661 7461 722e 0a3c 2d2d  your avatar..<--
-00052670: 6765 742d 6176 6174 6172 3e20 5b55 5345  get-avatar> [USE
-00052680: 5220 2e2e 2e5d 0a47 6574 2061 6e20 6176  R ...].Get an av
-00052690: 6174 6172 2e0a 3c2d 2d67 6574 2d70 726f  atar..<--get-pro
-000526a0: 6669 6c65 3e20 5b55 5345 5220 2e2e 2e5d  file> [USER ...]
-000526b0: 0a47 6574 2061 2075 7365 7220 7072 6f66  .Get a user prof
-000526c0: 696c 652e 0a3c 2d2d 6765 742d 726f 6f6d  ile..<--get-room
-000526d0: 2d69 6e66 6f3e 205b 524f 4f4d 202e 2e2e  -info> [ROOM ...
-000526e0: 5d0a 4765 7420 7468 6520 726f 6f6d 2069  ].Get the room i
-000526f0: 6e66 6f72 6d61 7469 6f6e 2e0a 3c2d 2d67  nformation..<--g
-00052700: 6574 2d63 6c69 656e 742d 696e 666f 3e0a  et-client-info>.
-00052710: 5072 696e 7420 636c 6965 6e74 2069 6e66  Print client inf
-00052720: 6f72 6d61 7469 6f6e 2e0a 3c2d 2d68 6173  ormation..<--has
-00052730: 2d70 6572 6d69 7373 696f 6e3e 2052 4f4f  -permission> ROO
-00052740: 4d20 4241 4e7c 494e 5649 5445 7c4b 4943  M BAN|INVITE|KIC
-00052750: 4b7c 4e4f 5449 4649 4341 5449 4f4e 537c  K|NOTIFICATIONS|
-00052760: 5245 4441 4354 7c65 7463 205b 524f 4f4d  REDACT|etc [ROOM
-00052770: 2042 414e 7c49 4e56 4954 457c 4b49 434b   BAN|INVITE|KICK
-00052780: 7c4e 4f54 4946 4943 4154 494f 4e53 7c52  |NOTIFICATIONS|R
-00052790: 4544 4143 547c 6574 6320 2e2e 2e5d 0a49  EDACT|etc ...].I
-000527a0: 6e71 7569 7265 2061 626f 7574 2070 6572  nquire about per
-000527b0: 6d69 7373 696f 6e73 2e0a 3c2d 2d69 6d70  missions..<--imp
-000527c0: 6f72 742d 6b65 7973 3e20 4649 4c45 2050  ort-keys> FILE P
-000527d0: 4153 5350 4852 4153 4520 4649 4c45 2050  ASSPHRASE FILE P
-000527e0: 4153 5350 4852 4153 450a 496d 706f 7274  ASSPHRASE.Import
-000527f0: 204d 6567 6f6c 6d20 6465 6372 7970 7469   Megolm decrypti
-00052800: 6f6e 206b 6579 7320 6672 6f6d 2061 2066  on keys from a f
-00052810: 696c 652e 0a3c 2d2d 6578 706f 7274 2d6b  ile..<--export-k
-00052820: 6579 733e 2046 494c 4520 5041 5353 5048  eys> FILE PASSPH
-00052830: 5241 5345 2046 494c 4520 5041 5353 5048  RASE FILE PASSPH
-00052840: 5241 5345 0a45 7870 6f72 7420 616c 6c20  RASE.Export all 
-00052850: 7468 6520 4d65 676f 6c6d 2064 6563 7279  the Megolm decry
-00052860: 7074 696f 6e20 6b65 7973 206f 6620 7468  ption keys of th
-00052870: 6973 2064 6576 6963 652e 0a3c 2d2d 726f  is device..<--ro
-00052880: 6f6d 2d73 6574 2d61 6c69 6173 3e20 524f  om-set-alias> RO
-00052890: 4f4d 5f41 4c49 4153 2052 4f4f 4d20 5b52  OM_ALIAS ROOM [R
-000528a0: 4f4f 4d5f 414c 4941 5320 524f 4f4d 202e  OOM_ALIAS ROOM .
-000528b0: 2e2e 5d2c 203c 2d2d 726f 6f6d 2d70 7574  ..], <--room-put
-000528c0: 2d61 6c69 6173 3e20 524f 4f4d 5f41 4c49  -alias> ROOM_ALI
-000528d0: 4153 2052 4f4f 4d20 5b52 4f4f 4d5f 414c  AS ROOM [ROOM_AL
-000528e0: 4941 5320 524f 4f4d 202e 2e2e 5d0a 4164  IAS ROOM ...].Ad
-000528f0: 6420 616c 6961 7365 7320 746f 2072 6f6f  d aliases to roo
-00052900: 6d73 2e0a 3c2d 2d72 6f6f 6d2d 7265 736f  ms..<--room-reso
-00052910: 6c76 652d 616c 6961 733e 2052 4f4f 4d5f  lve-alias> ROOM_
-00052920: 414c 4941 5320 5b52 4f4f 4d5f 414c 4941  ALIAS [ROOM_ALIA
-00052930: 5320 2e2e 2e5d 0a53 686f 7720 726f 6f6d  S ...].Show room
-00052940: 2069 6473 2063 6f72 7265 7370 6f6e 6469   ids correspondi
-00052950: 6e67 2074 6f20 726f 6f6d 2061 6c69 6173  ng to room alias
-00052960: 6573 2e0a 3c2d 2d72 6f6f 6d2d 6465 6c65  es..<--room-dele
-00052970: 7465 2d61 6c69 6173 3e20 524f 4f4d 5f41  te-alias> ROOM_A
-00052980: 4c49 4153 205b 524f 4f4d 5f41 4c49 4153  LIAS [ROOM_ALIAS
-00052990: 202e 2e2e 5d0a 4465 6c65 7465 206f 6e65   ...].Delete one
-000529a0: 206f 7220 6d75 6c74 6970 6c65 2072 6f6f   or multiple roo
-000529b0: 6d73 2061 6c69 6173 6573 2e0a 3c2d 2d67  ms aliases..<--g
-000529c0: 6574 2d6f 7065 6e69 642d 746f 6b65 6e3e  et-openid-token>
-000529d0: 205b 5553 4552 202e 2e2e 5d0a 4765 7420   [USER ...].Get 
-000529e0: 616e 204f 7065 6e49 4420 746f 6b65 6e2e  an OpenID token.
-000529f0: 0a3c 2d2d 726f 6f6d 2d67 6574 2d76 6973  .<--room-get-vis
-00052a00: 6962 696c 6974 793e 205b 524f 4f4d 202e  ibility> [ROOM .
-00052a10: 2e2e 5d0a 4765 7420 7468 6520 7669 7369  ..].Get the visi
-00052a20: 6269 6c69 7479 206f 6620 6f6e 6520 6f72  bility of one or
-00052a30: 206d 6f72 6520 726f 6f6d 732e 0a3c 2d2d   more rooms..<--
-00052a40: 726f 6f6d 2d67 6574 2d73 7461 7465 3e20  room-get-state> 
-00052a50: 5b52 4f4f 4d20 2e2e 2e5d 0a47 6574 2074  [ROOM ...].Get t
-00052a60: 6865 2073 7461 7465 206f 6620 6f6e 6520  he state of one 
-00052a70: 6f72 206d 6f72 6520 726f 6f6d 732e 0a3c  or more rooms..<
-00052a80: 2d2d 6465 6c65 7465 2d64 6576 6963 653e  --delete-device>
-00052a90: 2044 4556 4943 4520 5b44 4556 4943 4520   DEVICE [DEVICE 
-00052aa0: 2e2e 2e5d 0a44 656c 6574 6520 6f6e 6520  ...].Delete one 
-00052ab0: 6f72 206d 756c 7469 706c 6520 6465 7669  or multiple devi
-00052ac0: 6365 732e 0a3c 2d2d 726f 6f6d 2d72 6564  ces..<--room-red
-00052ad0: 6163 743e 2052 4f4f 4d5f 4944 2045 5645  act> ROOM_ID EVE
-00052ae0: 4e54 5f49 4420 5245 4153 4f4e 205b 524f  NT_ID REASON [RO
-00052af0: 4f4d 5f49 4420 4556 454e 545f 4944 2052  OM_ID EVENT_ID R
-00052b00: 4541 534f 4e20 2e2e 2e5d 2c20 3c2d 2d72  EASON ...], <--r
-00052b10: 6f6f 6d2d 6465 6c65 7465 2d63 6f6e 7465  oom-delete-conte
-00052b20: 6e74 3e20 524f 4f4d 5f49 4420 4556 454e  nt> ROOM_ID EVEN
-00052b30: 545f 4944 2052 4541 534f 4e20 5b52 4f4f  T_ID REASON [ROO
-00052b40: 4d5f 4944 2045 5645 4e54 5f49 4420 5245  M_ID EVENT_ID RE
-00052b50: 4153 4f4e 202e 2e2e 5d0a 5374 7269 7020  ASON ...].Strip 
-00052b60: 696e 666f 726d 6174 696f 6e20 6f75 7420  information out 
-00052b70: 6f66 206f 6e65 206f 7220 7365 7665 7261  of one or severa
-00052b80: 6c20 6576 656e 7473 2e0a 3c2d 2d77 686f  l events..<--who
-00052b90: 616d 693e 0a50 7269 6e74 2079 6f75 7220  ami>.Print your 
-00052ba0: 7573 6572 2069 642e 0a3c 2d2d 6e6f 2d73  user id..<--no-s
-00052bb0: 736c 3e0a 536b 6970 2053 534c 2076 6572  sl>.Skip SSL ver
-00052bc0: 6966 6963 6174 696f 6e2e 0a3c 2d2d 7373  ification..<--ss
-00052bd0: 6c2d 6365 7274 6966 6963 6174 653e 2053  l-certificate> S
-00052be0: 534c 5f43 4552 5449 4649 4341 5445 5f46  SL_CERTIFICATE_F
-00052bf0: 494c 450a 5573 6520 796f 7572 206f 776e  ILE.Use your own
-00052c00: 2053 534c 2063 6572 7469 6669 6361 7465   SSL certificate
-00052c10: 2e0a 3c2d 2d66 696c 652d 6e61 6d65 3e20  ..<--file-name> 
-00052c20: 4649 4c45 205b 4649 4c45 202e 2e2e 5d0a  FILE [FILE ...].
-00052c30: 5370 6563 6966 7920 6f6e 6520 6f72 206d  Specify one or m
-00052c40: 756c 7469 706c 6520 6669 6c65 206e 616d  ultiple file nam
-00052c50: 6573 2066 6f72 2073 6f6d 6520 6163 7469  es for some acti
-00052c60: 6f6e 732e 0a3c 2d2d 6b65 792d 6469 6374  ons..<--key-dict
-00052c70: 3e20 4b45 595f 4449 4354 494f 4e41 5259  > KEY_DICTIONARY
-00052c80: 205b 4b45 595f 4449 4354 494f 4e41 5259   [KEY_DICTIONARY
-00052c90: 202e 2e2e 5d0a 5370 6563 6966 7920 6f6e   ...].Specify on
-00052ca0: 6520 6f72 206d 756c 7469 706c 6520 6b65  e or multiple ke
-00052cb0: 7920 6469 6374 696f 6e61 7269 6573 2066  y dictionaries f
-00052cc0: 6f72 2064 6563 7279 7074 696f 6e2e 0a3c  or decryption..<
-00052cd0: 2d2d 706c 6169 6e3e 0a44 6973 6162 6c65  --plain>.Disable
-00052ce0: 2065 6e63 7279 7074 696f 6e20 666f 7220   encryption for 
-00052cf0: 6120 7370 6563 6966 6963 2061 6374 696f  a specific actio
-00052d00: 6e2e 0a3c 2d2d 7365 7061 7261 746f 723e  n..<--separator>
-00052d10: 2053 4550 4152 4154 4f52 0a53 6574 2061   SEPARATOR.Set a
-00052d20: 2063 7573 746f 6d20 7365 7061 7261 746f   custom separato
-00052d30: 7220 7573 6564 2066 6f72 2063 6572 7461  r used for certa
-00052d40: 696e 2070 7269 6e74 206f 7574 732e 0a3c  in print outs..<
-00052d50: 2d2d 6163 6365 7373 2d74 6f6b 656e 3e20  --access-token> 
-00052d60: 4143 4345 5353 5f54 4f4b 454e 0a53 6574  ACCESS_TOKEN.Set
-00052d70: 2061 2063 7573 746f 6d20 6163 6365 7373   a custom access
-00052d80: 2074 6f6b 656e 2066 6f72 2075 7365 2062   token for use b
-00052d90: 7920 6365 7274 6169 6e20 6163 7469 6f6e  y certain action
-00052da0: 732e 0a3c 2d2d 7061 7373 776f 7264 3e20  s..<--password> 
-00052db0: 5041 5353 574f 5244 0a53 7065 6369 6679  PASSWORD.Specify
-00052dc0: 2061 2070 6173 7377 6f72 6420 666f 7220   a password for 
-00052dd0: 7573 6520 6279 2063 6572 7461 696e 2061  use by certain a
-00052de0: 6374 696f 6e73 2e0a 3c2d 2d68 6f6d 6573  ctions..<--homes
-00052df0: 6572 7665 723e 2048 4f4d 4553 4552 5645  erver> HOMESERVE
-00052e00: 525f 5552 4c0a 5370 6563 6966 7920 6120  R_URL.Specify a 
-00052e10: 686f 6d65 7365 7276 6572 2066 6f72 2075  homeserver for u
-00052e20: 7365 2062 7920 6365 7274 6169 6e20 6163  se by certain ac
-00052e30: 7469 6f6e 732e 0a3c 2d2d 6465 7669 6365  tions..<--device
-00052e40: 3e20 4445 5649 4345 5f4e 414d 450a 5370  > DEVICE_NAME.Sp
-00052e50: 6563 6966 7920 6120 6465 7669 6365 206e  ecify a device n
-00052e60: 616d 652c 2066 6f72 2075 7365 2062 7920  ame, for use by 
-00052e70: 6365 7274 6169 6e20 6163 7469 6f6e 732e  certain actions.
-00052e80: 0a3c 2d2d 7379 6e63 3e20 4655 4c4c 7c4f  .<--sync> FULL|O
-00052e90: 4646 0a43 686f 6f73 6520 7379 6e63 6872  FF.Choose synchr
-00052ea0: 6f6e 697a 6174 696f 6e20 6f70 7469 6f6e  onization option
-00052eb0: 732e 0a3c 2d6f 3e20 5445 5854 7c4a 534f  s..<-o> TEXT|JSO
-00052ec0: 4e7c 4a53 4f4e 2d4d 4158 7c4a 534f 4e2d  N|JSON-MAX|JSON-
-00052ed0: 5350 4543 2c20 3c2d 2d6f 7574 7075 743e  SPEC, <--output>
-00052ee0: 2054 4558 547c 4a53 4f4e 7c4a 534f 4e2d   TEXT|JSON|JSON-
-00052ef0: 4d41 587c 4a53 4f4e 2d53 5045 430a 5365  MAX|JSON-SPEC.Se
-00052f00: 6c65 6374 2061 6e20 6f75 7470 7574 2066  lect an output f
-00052f10: 6f72 6d61 742e 0a3c 2d76 3e20 5b50 5249  ormat..<-v> [PRI
-00052f20: 4e54 7c43 4845 434b 5d2c 202d 5620 5b50  NT|CHECK], -V [P
-00052f30: 5249 4e54 7c43 4845 434b 5d2c 203c 2d2d  RINT|CHECK], <--
-00052f40: 7665 7273 696f 6e3e 205b 5052 494e 547c  version> [PRINT|
-00052f50: 4348 4543 4b5d 0a50 7269 6e74 2076 6572  CHECK].Print ver
-00052f60: 7369 6f6e 2069 6e66 6f72 6d61 7469 6f6e  sion information
-00052f70: 206f 7220 6368 6563 6b20 666f 7220 7570   or check for up
-00052f80: 6461 7465 732e 0a22 2222 2e72 6570 6c61  dates..""".repla
-00052f90: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
-00052fa0: 223c 222c 2065 6f6e 0a20 2020 2020 2020  "<", eon.       
-00052fb0: 2029 2e72 6570 6c61 6365 280a 2020 2020   ).replace(.    
-00052fc0: 2020 2020 2020 2020 223e 222c 2065 6f66          ">", eof
-00052fd0: 660a 2020 2020 2020 2020 290a 2020 2020  f.        ).    
-00052fe0: 2020 2020 6865 6164 6572 203d 2046 616c      header = Fal
-00052ff0: 7365 2020 2320 6669 7273 7420 6c69 6e65  se  # first line
-00053000: 2069 7320 6e65 776c 696e 650a 2020 2020   is newline.    
-00053010: 2020 2020 666f 7220 6c69 6e65 2069 6e20      for line in 
-00053020: 6865 6c70 5f68 656c 705f 7072 652e 7370  help_help_pre.sp
-00053030: 6c69 7428 225c 6e22 293a 0a20 2020 2020  lit("\n"):.     
-00053040: 2020 2020 2020 2069 6620 6865 6164 6572         if header
-00053050: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00053060: 2020 7072 696e 7428 0a20 2020 2020 2020    print(.       
-00053070: 2020 2020 2020 2020 2020 2020 2074 6578               tex
-00053080: 7477 7261 702e 6669 6c6c 2863 6f6e 202b  twrap.fill(con +
-00053090: 206c 696e 6520 2b20 636f 6666 2c20 7769   line + coff, wi
-000530a0: 6474 683d 7465 726d 5f77 6964 7468 292c  dth=term_width),
-000530b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000530c0: 2020 2020 2066 6c75 7368 3d54 7275 652c       flush=True,
-000530d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000530e0: 2029 0a20 2020 2020 2020 2020 2020 2065   ).            e
-000530f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00053100: 2020 2020 2070 7269 6e74 280a 2020 2020       print(.    
-00053110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053120: 7465 7874 7772 6170 2e69 6e64 656e 7428  textwrap.indent(
-00053130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00053140: 2020 2020 2020 2020 2074 6578 7477 7261           textwra
-00053150: 702e 6669 6c6c 286c 696e 652c 2077 6964  p.fill(line, wid
-00053160: 7468 3d74 6572 6d5f 7769 6474 6820 2d20  th=term_width - 
-00053170: 3229 2c20 2220 2022 0a20 2020 2020 2020  2), "  ".       
-00053180: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
-00053190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000531a0: 2020 2020 666c 7573 683d 5472 7565 2c0a      flush=True,.
-000531b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000531c0: 290a 0a20 2020 2020 2020 2020 2020 2068  )..            h
-000531d0: 6561 6465 7220 3d20 6e6f 7420 6865 6164  eader = not head
-000531e0: 6572 0a20 2020 2020 2020 2023 2070 7269  er.        # pri
-000531f0: 6e74 2822 2229 0a20 2020 2020 2020 2070  nt("").        p
-00053200: 7269 6e74 2874 6578 7477 7261 702e 6669  rint(textwrap.fi
-00053210: 6c6c 2861 702e 6570 696c 6f67 2c20 7769  ll(ap.epilog, wi
-00053220: 6474 683d 7465 726d 5f77 6964 7468 2929  dth=term_width))
-00053230: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00053240: 300a 2020 2020 6966 2067 732e 7061 2e6d  0.    if gs.pa.m
-00053250: 616e 7561 6c3a 0a20 2020 2020 2020 2064  anual:.        d
-00053260: 6573 6372 6970 7469 6f6e 203d 2028 0a20  escription = (. 
-00053270: 2020 2020 2020 2020 2020 2066 2257 656c             f"Wel
-00053280: 636f 6d65 2074 6f20 7b50 524f 475f 5749  come to {PROG_WI
-00053290: 5448 4f55 545f 4558 547d 2c20 6120 4d61  THOUT_EXT}, a Ma
-000532a0: 7472 6978 2043 4c49 2063 6c69 656e 742e  trix CLI client.
-000532b0: 20e2 9480 e294 80e2 9480 2022 0a20 2020   ......... ".   
-000532c0: 2020 2020 2020 2020 2022 4f6e 2066 6972           "On fir
-000532d0: 7374 2072 756e 2075 7365 202d 2d6c 6f67  st run use --log
-000532e0: 696e 2074 6f20 6c6f 6720 696e 2c20 746f  in to log in, to
-000532f0: 2061 7574 6865 6e74 6963 6174 652e 2022   authenticate. "
-00053300: 0a20 2020 2020 2020 2020 2020 2022 4f6e  .            "On
-00053310: 2073 6563 6f6e 6420 7275 6e20 7765 2073   second run we s
-00053320: 7567 6765 7374 2074 6f20 7573 6520 2d2d  uggest to use --
-00053330: 7665 7269 6679 2074 6f20 6765 7420 7665  verify to get ve
-00053340: 7269 6669 6564 2e20 220a 2020 2020 2020  rified. ".      
-00053350: 2020 2020 2020 2245 6d6f 6a69 2076 6572        "Emoji ver
-00053360: 6966 6963 6174 696f 6e20 6973 2062 7569  ification is bui
-00053370: 6c74 2d69 6e20 7768 6963 6820 6361 6e20  lt-in which can 
-00053380: 6265 2075 7365 6420 220a 2020 2020 2020  be used ".      
-00053390: 2020 2020 2020 2274 6f20 7665 7269 6679        "to verify
-000533a0: 2064 6576 6963 6573 2e20 220a 2020 2020   devices. ".    
-000533b0: 2020 2020 2020 2020 224f 6e20 6675 7274          "On furt
-000533c0: 6865 7220 7275 6e73 2074 6869 7320 7072  her runs this pr
-000533d0: 6f67 7261 6d20 696d 706c 656d 656e 7473  ogram implements
-000533e0: 2061 2073 696d 706c 6520 4d61 7472 6978   a simple Matrix
-000533f0: 2043 4c49 2022 0a20 2020 2020 2020 2020   CLI ".         
-00053400: 2020 2022 636c 6965 6e74 2074 6861 7420     "client that 
-00053410: 6361 6e20 7365 6e64 206d 6573 7361 6765  can send message
-00053420: 732c 206c 6973 7465 6e20 746f 206d 6573  s, listen to mes
-00053430: 7361 6765 732c 2076 6572 6966 7920 220a  sages, verify ".
-00053440: 2020 2020 2020 2020 2020 2020 2264 6576              "dev
-00053450: 6963 6573 2c20 6574 632e 2049 7420 6361  ices, etc. It ca
-00053460: 6e20 7365 6e64 206f 6e65 206f 7220 6d75  n send one or mu
-00053470: 6c74 6970 6c65 206d 6573 7361 6765 2074  ltiple message t
-00053480: 6f20 6f6e 6520 6f72 2022 0a20 2020 2020  o one or ".     
-00053490: 2020 2020 2020 2022 6d75 6c74 6970 6c65         "multiple
-000534a0: 204d 6174 7269 7820 726f 6f6d 7320 616e   Matrix rooms an
-000534b0: 642f 6f72 2075 7365 7273 2e20 5468 6520  d/or users. The 
-000534c0: 7465 7874 206d 6573 7361 6765 7320 6361  text messages ca
-000534d0: 6e20 6265 2022 0a20 2020 2020 2020 2020  n be ".         
-000534e0: 2020 2022 6f66 2076 6172 696f 7573 2022     "of various "
-000534f0: 0a20 2020 2020 2020 2020 2020 2027 666f  .            'fo
-00053500: 726d 6174 7320 7375 6368 2061 7320 2274  rmats such as "t
-00053510: 6578 7422 2c20 2268 746d 6c22 2c20 226d  ext", "html", "m
-00053520: 6172 6b64 6f77 6e22 206f 7220 2263 6f64  arkdown" or "cod
-00053530: 6522 2e20 270a 2020 2020 2020 2020 2020  e". '.          
-00053540: 2020 2249 6d61 6765 732c 2061 7564 696f    "Images, audio
-00053550: 2c20 6172 6269 7472 6172 7920 6669 6c65  , arbitrary file
-00053560: 732c 206f 7220 6576 656e 7473 2063 616e  s, or events can
-00053570: 2062 6520 7365 6e74 2061 7320 7765 6c6c   be sent as well
-00053580: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
-00053590: 2246 6f72 2072 6563 6569 7669 6e67 2074  "For receiving t
-000535a0: 6865 7265 2061 7265 2074 6872 6565 206d  here are three m
-000535b0: 6169 6e20 6f70 7469 6f6e 733a 206c 6973  ain options: lis
-000535c0: 7465 6e20 666f 7265 7665 722c 2022 0a20  ten forever, ". 
-000535d0: 2020 2020 2020 2020 2020 2022 6c69 7374             "list
-000535e0: 656e 206f 6e63 6520 616e 6420 7175 6974  en once and quit
-000535f0: 2c20 616e 6420 6765 7420 7468 6520 6c61  , and get the la
-00053600: 7374 204e 206d 6573 7361 6765 7320 220a  st N messages ".
-00053610: 2020 2020 2020 2020 2020 2020 2261 6e64              "and
-00053620: 2071 7569 742e 2045 6e64 2d74 6f2d 656e   quit. End-to-en
-00053630: 6420 656e 6372 7970 7469 6f6e 2069 7320  d encryption is 
-00053640: 656e 6162 6c65 6420 6279 2064 6566 6175  enabled by defau
-00053650: 6c74 2022 0a20 2020 2020 2020 2020 2020  lt ".           
-00053660: 2022 616e 6420 6361 6e6e 6f74 2062 6520   "and cannot be 
-00053670: 7475 726e 6564 206f 6666 2c20 6275 7420  turned off, but 
-00053680: 6974 2063 616e 2062 6520 6469 7361 626c  it can be disabl
-00053690: 6564 2066 6f72 2073 7065 6369 6669 6320  ed for specific 
-000536a0: 220a 2020 2020 2020 2020 2020 2020 2275  ".            "u
-000536b0: 7365 2063 6173 6573 2e20 20e2 9480 e294  se cases.  .....
-000536c0: 80e2 9480 2022 0a20 2020 2020 2020 2020  .... ".         
-000536d0: 2020 2022 4275 6e64 6c69 6e67 2073 6576     "Bundling sev
-000536e0: 6572 616c 2061 6374 696f 6e73 2074 6f67  eral actions tog
-000536f0: 6574 6865 7220 696e 746f 2061 2073 696e  ether into a sin
-00053700: 676c 6520 6361 6c6c 2074 6f20 220a 2020  gle call to ".  
-00053710: 2020 2020 2020 2020 2020 6622 7b50 524f            f"{PRO
-00053720: 475f 5749 5448 4f55 545f 4558 547d 2069  G_WITHOUT_EXT} i
-00053730: 7320 6661 7374 6572 2074 6861 6e20 6361  s faster than ca
-00053740: 6c6c 696e 6720 7b50 524f 475f 5749 5448  lling {PROG_WITH
-00053750: 4f55 545f 4558 547d 2022 0a20 2020 2020  OUT_EXT} ".     
-00053760: 2020 2020 2020 2022 6d75 6c74 6970 6c65         "multiple
-00053770: 2074 696d 6573 2077 6974 6820 6f6e 6c79   times with only
-00053780: 206f 6e65 2061 6374 696f 6e2e 2049 6620   one action. If 
-00053790: 7468 6572 6520 6172 6520 626f 7468 2027  there are both '
-000537a0: 7365 7427 2022 0a20 2020 2020 2020 2020  set' ".         
-000537b0: 2020 2022 616e 6420 2767 6574 2720 6163     "and 'get' ac
-000537c0: 7469 6f6e 7320 7072 6573 656e 7420 696e  tions present in
-000537d0: 2074 6865 2061 7267 756d 656e 7473 2c20   the arguments, 
-000537e0: 7468 656e 2074 6865 2027 7365 7427 2022  then the 'set' "
-000537f0: 0a20 2020 2020 2020 2020 2020 2022 6163  .            "ac
-00053800: 7469 6f6e 7320 7769 6c6c 2062 6520 7065  tions will be pe
-00053810: 7266 6f72 6d65 6420 6265 666f 7265 2074  rformed before t
-00053820: 6865 2027 6765 7427 2061 6374 696f 6e73  he 'get' actions
-00053830: 2e20 5468 656e 2022 0a20 2020 2020 2020  . Then ".       
-00053840: 2020 2020 2022 7365 6e64 2061 6374 696f       "send actio
-00053850: 6e73 2061 6e64 2061 7420 7468 6520 7665  ns and at the ve
-00053860: 7279 2065 6e64 206c 6973 7465 6e20 6163  ry end listen ac
-00053870: 7469 6f6e 7320 7769 6c6c 2062 6520 220a  tions will be ".
-00053880: 2020 2020 2020 2020 2020 2020 2270 6572              "per
-00053890: 666f 726d 6564 2e20 e294 80e2 9480 e294  formed. ........
-000538a0: 8020 220a 2020 2020 2020 2020 2020 2020  . ".            
-000538b0: 2246 6f72 2065 7665 6e20 6d6f 7265 2065  "For even more e
-000538c0: 7870 6c69 6361 7469 6f6e 7320 616e 6420  xplications and 
-000538d0: 6578 616d 706c 6573 2061 6c73 6f20 7265  examples also re
-000538e0: 6164 2074 6865 2022 0a20 2020 2020 2020  ad the ".       
-000538f0: 2020 2020 2022 646f 6375 6d65 6e74 6174       "documentat
-00053900: 696f 6e20 7072 6f76 6964 6564 2069 6e20  ion provided in 
-00053910: 7468 6520 6f6e 2d6c 696e 6520 4769 7468  the on-line Gith
-00053920: 7562 2052 4541 444d 452e 6d64 2066 696c  ub README.md fil
-00053930: 6520 220a 2020 2020 2020 2020 2020 2020  e ".            
-00053940: 226f 7220 7468 6520 5245 4144 4d45 2e6d  "or the README.m
-00053950: 6420 696e 2079 6f75 7220 6c6f 6361 6c20  d in your local 
-00053960: 696e 7374 616c 6c61 7469 6f6e 2e20 20e2  installation.  .
-00053970: 9480 e294 80e2 9480 2022 0a20 2020 2020  ........ ".     
-00053980: 2020 2020 2020 2022 466f 7220 6c65 7373         "For less
-00053990: 2069 6e66 6f72 6d61 7469 6f6e 206a 7573   information jus
-000539a0: 7420 7573 6520 2d2d 6865 6c70 2069 6e73  t use --help ins
-000539b0: 7465 6164 206f 6620 2d2d 6d61 6e75 616c  tead of --manual
-000539c0: 2e22 0a20 2020 2020 2020 2029 0a20 2020  .".        ).   
-000539d0: 2020 2020 2070 7269 6e74 2874 6578 7477       print(textw
-000539e0: 7261 702e 6669 6c6c 2864 6573 6372 6970  rap.fill(descrip
-000539f0: 7469 6f6e 2c20 7769 6474 683d 7465 726d  tion, width=term
-00053a00: 5f77 6964 7468 292c 2066 6c75 7368 3d54  _width), flush=T
-00053a10: 7275 6529 0a20 2020 2020 2020 2070 7269  rue).        pri
-00053a20: 6e74 2822 2229 0a20 2020 2020 2020 2061  nt("").        a
-00053a30: 702e 7072 696e 745f 6865 6c70 2866 696c  p.print_help(fil
-00053a40: 653d 4e6f 6e65 2920 2023 2061 702e 7072  e=None)  # ap.pr
-00053a50: 696e 745f 7573 6167 6528 2920 6973 2069  int_usage() is i
-00053a60: 6e63 6c75 6465 640a 2020 2020 2020 2020  ncluded.        
-00053a70: 7265 7475 726e 2030 0a20 2020 2069 6620  return 0.    if 
-00053a80: 6773 2e70 612e 7265 6164 6d65 3a0a 2020  gs.pa.readme:.  
-00053a90: 2020 2020 2020 2320 546f 646f 0a20 2020        # Todo.   
-00053aa0: 2020 2020 2065 7865 6469 7220 3d20 6f73       exedir = os
-00053ab0: 2e70 6174 682e 6469 726e 616d 6528 6f73  .path.dirname(os
-00053ac0: 2e70 6174 682e 7265 616c 7061 7468 285f  .path.realpath(_
-00053ad0: 5f66 696c 655f 5f29 290a 2020 2020 2020  _file__)).      
-00053ae0: 2020 7265 6164 6d65 203d 2065 7865 6469    readme = exedi
-00053af0: 7220 2b20 222f 2e2e 2f22 202b 2022 5245  r + "/../" + "RE
-00053b00: 4144 4d45 2e6d 6422 0a20 2020 2020 2020  ADME.md".       
-00053b10: 2072 6561 646d 655f 7072 696d 6172 7920   readme_primary 
-00053b20: 3d20 7265 6164 6d65 0a20 2020 2020 2020  = readme.       
-00053b30: 2066 6f75 6e64 7061 7468 203d 204e 6f6e   foundpath = Non
-00053b40: 650a 2020 2020 2020 2020 6966 206f 732e  e.        if os.
-00053b50: 7061 7468 2e65 7869 7374 7328 7265 6164  path.exists(read
-00053b60: 6d65 293a 0a20 2020 2020 2020 2020 2020  me):.           
-00053b70: 2066 6f75 6e64 7061 7468 203d 2072 6561   foundpath = rea
-00053b80: 646d 650a 2020 2020 2020 2020 2020 2020  dme.            
-00053b90: 7072 696e 7428 6622 466f 756e 6420 6c6f  print(f"Found lo
-00053ba0: 6361 6c20 5245 4144 4d45 2e6d 6420 6865  cal README.md he
-00053bb0: 7265 3a20 7b72 6561 646d 657d 2229 0a20  re: {readme}"). 
-00053bc0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00053bd0: 2020 2020 2020 2020 2072 6561 646d 6520           readme 
-00053be0: 3d20 6578 6564 6972 202b 2022 2f22 202b  = exedir + "/" +
-00053bf0: 2022 5245 4144 4d45 2e6d 6422 0a20 2020   "README.md".   
-00053c00: 2020 2020 2020 2020 2069 6620 6f73 2e70           if os.p
-00053c10: 6174 682e 6578 6973 7473 2872 6561 646d  ath.exists(readm
-00053c20: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-00053c30: 2020 2020 666f 756e 6470 6174 6820 3d20      foundpath = 
-00053c40: 7265 6164 6d65 0a20 2020 2020 2020 2020  readme.         
-00053c50: 2020 2020 2020 2070 7269 6e74 2866 2246         print(f"F
-00053c60: 6f75 6e64 206c 6f63 616c 2052 4541 444d  ound local READM
-00053c70: 452e 6d64 2068 6572 653a 207b 7265 6164  E.md here: {read
-00053c80: 6d65 7d22 290a 2020 2020 2020 2020 6966  me}").        if
-00053c90: 2066 6f75 6e64 7061 7468 2069 7320 4e6f   foundpath is No
-00053ca0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00053cb0: 7072 696e 7428 0a20 2020 2020 2020 2020  print(.         
-00053cc0: 2020 2020 2020 2022 536f 7272 792c 2052         "Sorry, R
-00053cd0: 4541 444d 452e 6d64 206e 6f74 2066 6f75  EADME.md not fou
-00053ce0: 6e64 206c 6f63 616c 6c79 2022 0a20 2020  nd locally ".   
-00053cf0: 2020 2020 2020 2020 2020 2020 2066 2269               f"i
-00053d00: 6e20 696e 7374 616c 6c61 7469 6f6e 2064  n installation d
-00053d10: 6972 6563 746f 7279 207b 7265 6164 6d65  irectory {readme
-00053d20: 5f70 7269 6d61 7279 7d2e 220a 2020 2020  _primary}.".    
-00053d30: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00053d40: 2020 2020 2020 7072 696e 7428 6622 4865        print(f"He
-00053d50: 6e63 6520 646f 776e 6c6f 6164 696e 6720  nce downloading 
-00053d60: 6974 2066 726f 6d20 7b52 4541 444d 455f  it from {README_
-00053d70: 4649 4c45 5f52 4157 5f55 524c 7d2e 2229  FILE_RAW_URL}.")
-00053d80: 0a20 2020 2020 2020 2020 2020 206e 6f74  .            not
-00053d90: 7573 6564 2c20 666f 756e 6470 6174 6820  used, foundpath 
-00053da0: 3d20 7465 6d70 6669 6c65 2e6d 6b73 7465  = tempfile.mkste
-00053db0: 6d70 2829 0a20 2020 2020 2020 2020 2020  mp().           
-00053dc0: 2075 726c 6c69 622e 7265 7175 6573 742e   urllib.request.
-00053dd0: 7572 6c72 6574 7269 6576 6528 5245 4144  urlretrieve(READ
-00053de0: 4d45 5f46 494c 455f 5241 575f 5552 4c2c  ME_FILE_RAW_URL,
-00053df0: 2066 6f75 6e64 7061 7468 290a 2020 2020   foundpath).    
-00053e00: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00053e10: 2020 2020 2077 6974 6820 6f70 656e 2866       with open(f
-00053e20: 6f75 6e64 7061 7468 2c20 2272 2b22 2920  oundpath, "r+") 
-00053e30: 6173 2066 3a0a 2020 2020 2020 2020 2020  as f:.          
-00053e40: 2020 2020 2020 7465 7874 203d 2066 2e72        text = f.r
-00053e50: 6561 6428 290a 2020 2020 2020 2020 2020  ead().          
-00053e60: 2020 7072 696e 7428 6622 7b74 6578 747d    print(f"{text}
-00053e70: 2229 0a20 2020 2020 2020 2065 7863 6570  ").        excep
-00053e80: 7420 4578 6365 7074 696f 6e3a 2020 2320  t Exception:  # 
-00053e90: 2842 726f 6b65 6e50 6970 6545 7272 6f72  (BrokenPipeError
-00053ea0: 2c20 494f 4572 726f 7229 3a0a 2020 2020  , IOError):.    
-00053eb0: 2020 2020 2020 2020 2320 7072 696e 7428          # print(
-00053ec0: 2242 726f 6b65 6e50 6970 6545 7272 6f72  "BrokenPipeError
-00053ed0: 2063 6175 6768 7422 2c20 6669 6c65 3d73   caught", file=s
-00053ee0: 7973 2e73 7464 6572 7229 0a20 2020 2020  ys.stderr).     
-00053ef0: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
-00053f00: 2020 2020 7265 7475 726e 2030 0a0a 2020      return 0..  
-00053f10: 2020 6c6f 6767 696e 672e 6261 7369 6343    logging.basicC
-00053f20: 6f6e 6669 6728 2020 2320 696e 6974 6961  onfig(  # initia
-00053f30: 6c69 7a65 2072 6f6f 7420 6c6f 6767 6572  lize root logger
-00053f40: 2c20 6120 6d75 7374 0a20 2020 2020 2020  , a must.       
-00053f50: 2066 6f72 6d61 743d 227b 6173 6374 696d   format="{asctim
-00053f60: 657d 3a20 7b6c 6576 656c 6e61 6d65 3a3e  e}: {levelname:>
-00053f70: 387d 3a20 7b6e 616d 653a 3e31 367d 3a20  8}: {name:>16}: 
-00053f80: 7b6d 6573 7361 6765 7d22 2c20 7374 796c  {message}", styl
-00053f90: 653d 227b 220a 2020 2020 290a 2020 2020  e="{".    ).    
-00053fa0: 2320 7365 7420 6c6f 6720 6c65 7665 6c20  # set log level 
-00053fb0: 6f6e 2072 6f6f 740a 2020 2020 6966 2022  on root.    if "
-00053fc0: 4445 4255 4722 2069 6e20 6f73 2e65 6e76  DEBUG" in os.env
-00053fd0: 6972 6f6e 3a0a 2020 2020 2020 2020 6c6f  iron:.        lo
-00053fe0: 6767 696e 672e 6765 744c 6f67 6765 7228  gging.getLogger(
-00053ff0: 292e 7365 744c 6576 656c 286c 6f67 6769  ).setLevel(loggi
-00054000: 6e67 2e44 4542 5547 290a 2020 2020 656c  ng.DEBUG).    el
-00054010: 7365 3a0a 2020 2020 2020 2020 6c6f 6767  se:.        logg
-00054020: 696e 672e 6765 744c 6f67 6765 7228 292e  ing.getLogger().
-00054030: 7365 744c 6576 656c 286c 6f67 6769 6e67  setLevel(logging
-00054040: 2e49 4e46 4f29 0a0a 2020 2020 6773 2e6c  .INFO)..    gs.l
-00054050: 6f67 203d 206c 6f67 6769 6e67 2e67 6574  og = logging.get
-00054060: 4c6f 6767 6572 2850 524f 475f 5749 5448  Logger(PROG_WITH
-00054070: 4f55 545f 4558 5429 0a0a 2020 2020 6966  OUT_EXT)..    if
-00054080: 2067 732e 7061 2e6c 6f67 5f6c 6576 656c   gs.pa.log_level
-00054090: 3a0a 2020 2020 2020 2020 696e 6974 6961  :.        initia
-000540a0: 6c5f 6368 6563 6b5f 6f66 5f6c 6f67 5f61  l_check_of_log_a
-000540b0: 7267 7328 290a 2020 2020 2020 2020 6966  rgs().        if
-000540c0: 206c 656e 2867 732e 7061 2e6c 6f67 5f6c   len(gs.pa.log_l
-000540d0: 6576 656c 2920 3e20 303a 0a20 2020 2020  evel) > 0:.     
-000540e0: 2020 2020 2020 2069 6620 6c65 6e28 6773         if len(gs
-000540f0: 2e70 612e 6c6f 675f 6c65 7665 6c29 203e  .pa.log_level) >
-00054100: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-00054110: 2020 2020 2320 7365 7420 6c6f 6720 6c65      # set log le
-00054120: 7665 6c20 666f 7220 4556 4552 5954 4849  vel for EVERYTHI
-00054130: 4e47 0a20 2020 2020 2020 2020 2020 2020  NG.             
-00054140: 2020 206c 6f67 6769 6e67 2e67 6574 4c6f     logging.getLo
-00054150: 6767 6572 2829 2e73 6574 4c65 7665 6c28  gger().setLevel(
-00054160: 6773 2e70 612e 6c6f 675f 6c65 7665 6c5b  gs.pa.log_level[
-00054170: 315d 290a 2020 2020 2020 2020 2020 2020  1]).            
-00054180: 2320 7365 7420 6c6f 6720 6c65 7665 6c20  # set log level 
-00054190: 666f 7220 6d61 7472 6978 2d63 6f6d 6d61  for matrix-comma
-000541a0: 6e64 6572 0a20 2020 2020 2020 2020 2020  nder.           
-000541b0: 2067 732e 6c6f 672e 7365 744c 6576 656c   gs.log.setLevel
-000541c0: 2867 732e 7061 2e6c 6f67 5f6c 6576 656c  (gs.pa.log_level
-000541d0: 5b30 5d29 0a20 2020 2020 2020 2020 2020  [0]).           
-000541e0: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
-000541f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00054200: 224c 6f67 206c 6576 656c 2069 7320 7365  "Log level is se
-00054210: 7420 666f 7220 6d6f 6475 6c65 207b 5052  t for module {PR
-00054220: 4f47 5f57 4954 484f 5554 5f45 5854 7d2e  OG_WITHOUT_EXT}.
-00054230: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00054240: 2020 2066 226c 6f67 5f6c 6576 656c 3d7b     f"log_level={
-00054250: 6773 2e70 612e 6c6f 675f 6c65 7665 6c5b  gs.pa.log_level[
-00054260: 305d 7d22 0a20 2020 2020 2020 2020 2020  0]}".           
-00054270: 2029 0a20 2020 2020 2020 2020 2020 2069   ).            i
-00054280: 6620 6c65 6e28 6773 2e70 612e 6c6f 675f  f len(gs.pa.log_
-00054290: 6c65 7665 6c29 203e 2031 3a0a 2020 2020  level) > 1:.    
-000542a0: 2020 2020 2020 2020 2020 2020 2320 6f6e              # on
-000542b0: 6c79 206e 6f77 2074 6861 7420 6c6f 6361  ly now that loca
-000542c0: 6c20 6c6f 6720 6c65 7665 6c20 6973 2073  l log level is s
-000542d0: 6574 2c20 7765 2063 616e 206c 6f67 2070  et, we can log p
-000542e0: 7265 762e 2069 6e66 6f0a 2020 2020 2020  rev. info.      
-000542f0: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-00054300: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-00054310: 2020 2020 2020 2020 2020 2020 6622 4c6f              f"Lo
-00054320: 6720 6c65 7665 6c20 6973 2073 6574 2066  g level is set f
-00054330: 6f72 206d 6f64 756c 6573 2062 656c 6f77  or modules below
-00054340: 207b 5052 4f47 5f57 4954 484f 5554 5f45   {PROG_WITHOUT_E
-00054350: 5854 7d2e 2022 0a20 2020 2020 2020 2020  XT}. ".         
-00054360: 2020 2020 2020 2020 2020 2066 226c 6f67             f"log
-00054370: 5f6c 6576 656c 3d7b 6773 2e70 612e 6c6f  _level={gs.pa.lo
-00054380: 675f 6c65 7665 6c5b 315d 7d22 0a20 2020  g_level[1]}".   
-00054390: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-000543a0: 2020 2069 6620 6773 2e70 612e 6465 6275     if gs.pa.debu
-000543b0: 6720 3e20 303a 0a20 2020 2020 2020 2069  g > 0:.        i
-000543c0: 6620 6773 2e70 612e 6465 6275 6720 3e20  f gs.pa.debug > 
-000543d0: 313a 0a20 2020 2020 2020 2020 2020 2023  1:.            #
-000543e0: 2074 7572 6e20 6f6e 2064 6562 7567 206c   turn on debug l
-000543f0: 6f67 6769 6e67 2066 6f72 2045 5645 5259  ogging for EVERY
-00054400: 5448 494e 470a 2020 2020 2020 2020 2020  THING.          
-00054410: 2020 6c6f 6767 696e 672e 6765 744c 6f67    logging.getLog
-00054420: 6765 7228 292e 7365 744c 6576 656c 286c  ger().setLevel(l
-00054430: 6f67 6769 6e67 2e44 4542 5547 290a 2020  ogging.DEBUG).  
-00054440: 2020 2020 2020 2320 7475 726e 206f 6e20        # turn on 
-00054450: 6465 6275 6720 6c6f 6767 696e 6720 666f  debug logging fo
-00054460: 7220 6d61 7472 6978 2d63 6f6d 6d61 6e64  r matrix-command
-00054470: 6572 0a20 2020 2020 2020 2067 732e 6c6f  er.        gs.lo
-00054480: 672e 7365 744c 6576 656c 286c 6f67 6769  g.setLevel(loggi
-00054490: 6e67 2e44 4542 5547 290a 2020 2020 2020  ng.DEBUG).      
-000544a0: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
-000544b0: 2244 6562 7567 2069 7320 7475 726e 6564  "Debug is turned
-000544c0: 206f 6e2e 2064 6562 7567 2063 6f75 6e74   on. debug count
-000544d0: 3d7b 6773 2e70 612e 6465 6275 677d 2229  ={gs.pa.debug}")
-000544e0: 0a20 2020 2020 2020 2069 6620 6773 2e70  .        if gs.p
-000544f0: 612e 6c6f 675f 6c65 7665 6c20 616e 6420  a.log_level and 
-00054500: 6c65 6e28 6773 2e70 612e 6c6f 675f 6c65  len(gs.pa.log_le
-00054510: 7665 6c29 203e 2030 3a0a 2020 2020 2020  vel) > 0:.      
-00054520: 2020 2020 2020 6773 2e6c 6f67 2e77 6172        gs.log.war
-00054530: 6e69 6e67 280a 2020 2020 2020 2020 2020  ning(.          
-00054540: 2020 2020 2020 2257 3131 313a 2022 2022        "W111: " "
-00054550: 4465 6275 6720 6f70 7469 6f6e 202d 6420  Debug option -d 
-00054560: 6f76 6572 7772 6f74 6520 6f70 7469 6f6e  overwrote option
-00054570: 202d 2d6c 6f67 2d6c 6576 656c 2e22 0a20   --log-level.". 
-00054580: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00054590: 2020 2020 2020 2020 2067 732e 7761 726e           gs.warn
-000545a0: 5f63 6f75 6e74 202b 3d20 310a 0a20 2020  _count += 1..   
-000545b0: 2053 4550 203d 2062 7974 6573 2867 732e   SEP = bytes(gs.
-000545c0: 7061 2e73 6570 6172 6174 6f72 2c20 2275  pa.separator, "u
-000545d0: 7466 2d38 2229 2e64 6563 6f64 6528 2275  tf-8").decode("u
-000545e0: 6e69 636f 6465 5f65 7363 6170 6522 290a  nicode_escape").
-000545f0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-00054600: 280a 2020 2020 2020 2020 6627 5365 7061  (.        f'Sepa
-00054610: 7261 746f 7220 6973 2073 6574 2074 6f20  rator is set to 
-00054620: 227b 5345 507d 2220 6f66 2027 0a20 2020  "{SEP}" of '.   
-00054630: 2020 2020 2066 226c 656e 6774 6820 7b6c       f"length {l
-00054640: 656e 2853 4550 297d 2e20 452e 672e 2043  en(SEP)}. E.g. C
-00054650: 6f6c 317b 5345 507d 436f 6c32 2e22 0a20  ol1{SEP}Col2.". 
-00054660: 2020 2029 0a20 2020 2069 6e69 7469 616c     ).    initial
-00054670: 5f63 6865 636b 5f6f 665f 6172 6773 2829  _check_of_args()
-00054680: 0a20 2020 2063 6865 636b 5f64 6f77 6e6c  .    check_downl
-00054690: 6f61 645f 6d65 6469 615f 6469 7228 290a  oad_media_dir().
-000546a0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-000546b0: 2063 6865 636b 5f61 7267 5f66 696c 6573   check_arg_files
-000546c0: 5f72 6561 6461 626c 6528 290a 2020 2020  _readable().    
-000546d0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-000546e0: 2061 7320 653a 0a20 2020 2020 2020 2067   as e:.        g
-000546f0: 732e 6c6f 672e 6572 726f 7228 6529 2020  s.log.error(e)  
-00054700: 2320 616c 7265 6164 7920 6861 7320 4578  # already has Ex
-00054710: 7878 3a20 756e 6971 7565 2065 7272 6f72  xx: unique error
-00054720: 206e 756d 6265 720a 2020 2020 2020 2020   number.        
-00054730: 7261 6973 6520 4d61 7472 6978 436f 6d6d  raise MatrixComm
-00054740: 616e 6465 7245 7272 6f72 280a 2020 2020  anderError(.    
-00054750: 2020 2020 2020 2020 6622 7b50 524f 475f          f"{PROG_
-00054760: 5749 5448 4f55 545f 4558 547d 2066 6f72  WITHOUT_EXT} for
-00054770: 6365 7320 616e 2065 6172 6c79 2061 626f  ces an early abo
-00054780: 7274 2e20 220a 2020 2020 2020 2020 2020  rt. ".          
-00054790: 2020 2254 6f20 6176 6f69 6420 7061 7274    "To avoid part
-000547a0: 6961 6c20 6578 6563 7574 696f 6e2c 206e  ial execution, n
-000547b0: 6f20 6163 7469 6f6e 2068 6173 2062 6565  o action has bee
-000547c0: 6e20 7065 7266 6f72 6d65 6420 6174 2061  n performed at a
-000547d0: 6c6c 2e20 220a 2020 2020 2020 2020 2020  ll. ".          
-000547e0: 2020 224e 6f74 6869 6e67 2068 6173 2062    "Nothing has b
-000547f0: 6565 6e20 7365 6e74 2e20 4669 7820 796f  een sent. Fix yo
-00054800: 7572 2061 7267 756d 656e 7473 2061 6e64  ur arguments and
-00054810: 2072 756e 2074 6865 2063 6f6d 6d61 6e64   run the command
-00054820: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-00054830: 6167 6169 6e2e 220a 2020 2020 2020 2020  again.".        
-00054840: 2920 6672 6f6d 204e 6f6e 650a 0a20 2020  ) from None..   
-00054850: 2069 6620 6773 2e70 612e 7665 7273 696f   if gs.pa.versio
-00054860: 6e3a 0a20 2020 2020 2020 2069 6620 6773  n:.        if gs
-00054870: 2e70 612e 7665 7273 696f 6e2e 6c6f 7765  .pa.version.lowe
-00054880: 7228 2920 3d3d 2050 5249 4e54 3a0a 2020  r() == PRINT:.  
-00054890: 2020 2020 2020 2020 2020 7665 7273 696f            versio
-000548a0: 6e28 2920 2023 2063 6f6e 7469 6e75 6520  n()  # continue 
-000548b0: 6578 6563 7574 696f 6e0a 2020 2020 2020  execution.      
-000548c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000548d0: 2020 2020 6368 6563 6b5f 7665 7273 696f      check_versio
-000548e0: 6e28 2920 2023 2063 6f6e 7469 6e75 6520  n()  # continue 
-000548f0: 6578 6563 7574 696f 6e0a 2020 2020 2020  execution.      
-00054900: 2020 6966 206e 6f74 2028 0a20 2020 2020    if not (.     
-00054910: 2020 2020 2020 2067 732e 7365 6e64 5f61         gs.send_a
-00054920: 6374 696f 6e0a 2020 2020 2020 2020 2020  ction.          
-00054930: 2020 6f72 2067 732e 726f 6f6d 5f61 6374    or gs.room_act
-00054940: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
-00054950: 6f72 2067 732e 7061 2e6c 6973 7465 6e20  or gs.pa.listen 
-00054960: 213d 204c 4953 5445 4e5f 4445 4641 554c  != LISTEN_DEFAUL
-00054970: 540a 2020 2020 2020 2020 2020 2020 6f72  T.            or
-00054980: 2067 732e 7061 2e74 6169 6c20 213d 2054   gs.pa.tail != T
-00054990: 4149 4c5f 554e 5553 4544 5f44 4546 4155  AIL_UNUSED_DEFAU
-000549a0: 4c54 0a20 2020 2020 2020 2020 2020 206f  LT.            o
-000549b0: 7220 6773 2e70 612e 7665 7269 6679 0a20  r gs.pa.verify. 
-000549c0: 2020 2020 2020 2020 2020 206f 7220 6773             or gs
-000549d0: 2e73 6574 6765 745f 6163 7469 6f6e 0a20  .setget_action. 
-000549e0: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
-000549f0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-00054a00: 7567 2822 4f6e 6c79 202d 2d76 6572 7369  ug("Only --versi
-00054a10: 6f6e 2e20 5072 696e 7420 616e 6420 7175  on. Print and qu
-00054a20: 6974 2e22 290a 2020 2020 2020 2020 2020  it.").          
-00054a30: 2020 7265 7475 726e 2020 2320 6a75 7374    return  # just
-00054a40: 2076 6572 7369 6f6e 2c20 7175 6974 0a0a   version, quit..
-00054a50: 2020 2020 6372 6561 7465 5f70 6964 5f66      create_pid_f
-00054a60: 696c 6528 290a 0a20 2020 2067 732e 6c6f  ile()..    gs.lo
-00054a70: 672e 6465 6275 6728 6627 5079 7468 6f6e  g.debug(f'Python
-00054a80: 2076 6572 7369 6f6e 2069 7320 227b 7379   version is "{sy
-00054a90: 732e 7665 7273 696f 6e7d 2227 290a 2020  s.version}"').  
-00054aa0: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
-00054ab0: 2753 7464 696e 2070 6970 6520 6973 2061  'Stdin pipe is a
-00054ac0: 7373 6967 6e65 6420 746f 2022 7b67 732e  ssigned to "{gs.
-00054ad0: 7374 6469 6e5f 7573 657d 222e 2729 0a20  stdin_use}".'). 
-00054ae0: 2020 2069 6620 6773 2e70 612e 7373 6c5f     if gs.pa.ssl_
-00054af0: 6365 7274 6966 6963 6174 6520 213d 2053  certificate != S
-00054b00: 534c 5f43 4552 5449 4649 4341 5445 5f44  SL_CERTIFICATE_D
-00054b10: 4546 4155 4c54 3a0a 2020 2020 2020 2020  EFAULT:.        
-00054b20: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
-00054b30: 2020 2020 2020 2020 2020 2253 534c 2077            "SSL w
-00054b40: 696c 6c20 6265 2075 7365 642e 2041 2063  ill be used. A c
-00054b50: 7573 746f 6d20 5353 4c20 6365 7274 6966  ustom SSL certif
-00054b60: 6963 6174 6520 7761 7320 7072 6f76 6964  icate was provid
-00054b70: 6564 2e20 220a 2020 2020 2020 2020 2020  ed. ".          
-00054b80: 2020 6627 4375 7374 6f6d 2063 6572 7469    f'Custom certi
-00054b90: 6669 6361 7465 2066 726f 6d20 6669 6c65  ficate from file
-00054ba0: 2022 7b67 732e 7061 2e73 736c 5f63 6572   "{gs.pa.ssl_cer
-00054bb0: 7469 6669 6361 7465 7d22 2077 696c 6c20  tificate}" will 
-00054bc0: 270a 2020 2020 2020 2020 2020 2020 2262  '.            "b
-00054bd0: 6520 7573 6564 2066 6f72 2074 6869 7320  e used for this 
-00054be0: 636f 6e6e 6563 7469 6f6e 2e22 0a20 2020  connection.".   
-00054bf0: 2020 2020 2029 0a20 2020 2020 2020 2074       ).        t
-00054c00: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00054c10: 2320 7479 7065 2053 534c 436f 6e74 6578  # type SSLContex
-00054c20: 740a 2020 2020 2020 2020 2020 2020 6773  t.            gs
-00054c30: 2e73 736c 203d 2073 736c 2e63 7265 6174  .ssl = ssl.creat
-00054c40: 655f 6465 6661 756c 745f 636f 6e74 6578  e_default_contex
-00054c50: 7428 6361 6669 6c65 3d67 732e 7061 2e73  t(cafile=gs.pa.s
-00054c60: 736c 5f63 6572 7469 6669 6361 7465 290a  sl_certificate).
-00054c70: 2020 2020 2020 2020 6578 6365 7074 2046          except F
-00054c80: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
-00054c90: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
-00054ca0: 2e65 7272 5f63 6f75 6e74 202b 3d20 310a  .err_count += 1.
-00054cb0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00054cc0: 6520 4d61 7472 6978 436f 6d6d 616e 6465  e MatrixCommande
-00054cd0: 7245 7272 6f72 280a 2020 2020 2020 2020  rError(.        
-00054ce0: 2020 2020 2020 2020 2245 3234 333a 2022          "E243: "
-00054cf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00054d00: 2066 2753 534c 2063 6572 7469 6669 6361   f'SSL certifica
-00054d10: 7465 2066 696c 6520 227b 6773 2e70 612e  te file "{gs.pa.
-00054d20: 7373 6c5f 6365 7274 6966 6963 6174 657d  ssl_certificate}
-00054d30: 2220 7761 7320 270a 2020 2020 2020 2020  " was '.        
-00054d40: 2020 2020 2020 2020 226e 6f74 2066 6f75          "not fou
-00054d50: 6e64 2e22 0a20 2020 2020 2020 2020 2020  nd.".           
-00054d60: 2029 2066 726f 6d20 4e6f 6e65 0a20 2020   ) from None.   
-00054d70: 2020 2020 2065 7863 6570 7420 5065 726d       except Perm
-00054d80: 6973 7369 6f6e 4572 726f 723a 0a20 2020  issionError:.   
-00054d90: 2020 2020 2020 2020 2067 732e 6572 725f           gs.err_
-00054da0: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
-00054db0: 2020 2020 2020 2072 6169 7365 204d 6174         raise Mat
-00054dc0: 7269 7843 6f6d 6d61 6e64 6572 4572 726f  rixCommanderErro
-00054dd0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-00054de0: 2020 2022 4532 3434 3a20 220a 2020 2020     "E244: ".    
-00054df0: 2020 2020 2020 2020 2020 2020 6627 5353              f'SS
-00054e00: 4c20 6365 7274 6966 6963 6174 6520 6669  L certificate fi
-00054e10: 6c65 2022 7b67 732e 7061 2e73 736c 5f63  le "{gs.pa.ssl_c
-00054e20: 6572 7469 6669 6361 7465 7d22 2064 6f65  ertificate}" doe
-00054e30: 7320 270a 2020 2020 2020 2020 2020 2020  s '.            
-00054e40: 2020 2020 226e 6f74 2068 6176 6520 7265      "not have re
-00054e50: 6164 2070 6572 6d69 7373 696f 6e73 2e22  ad permissions."
-00054e60: 0a20 2020 2020 2020 2020 2020 2029 2066  .            ) f
-00054e70: 726f 6d20 4e6f 6e65 0a20 2020 2020 2020  rom None.       
-00054e80: 2065 7863 6570 7420 7373 6c2e 5353 4c45   except ssl.SSLE
-00054e90: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
-00054ea0: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
-00054eb0: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-00054ec0: 7261 6973 6520 4d61 7472 6978 436f 6d6d  raise MatrixComm
-00054ed0: 616e 6465 7245 7272 6f72 280a 2020 2020  anderError(.    
-00054ee0: 2020 2020 2020 2020 2020 2020 2245 3234              "E24
-00054ef0: 353a 2022 0a20 2020 2020 2020 2020 2020  5: ".           
-00054f00: 2020 2020 2066 2753 534c 2063 6572 7469       f'SSL certi
-00054f10: 6669 6361 7465 2066 696c 6520 227b 6773  ficate file "{gs
-00054f20: 2e70 612e 7373 6c5f 6365 7274 6966 6963  .pa.ssl_certific
-00054f30: 6174 657d 2220 6861 7320 270a 2020 2020  ate}" has '.    
-00054f40: 2020 2020 2020 2020 2020 2020 2269 6e76              "inv
-00054f50: 616c 6964 2063 6f6e 7465 6e74 2e20 446f  alid content. Do
-00054f60: 6573 206e 6f74 2073 6565 6d20 746f 2062  es not seem to b
-00054f70: 6520 6120 6365 7274 6966 6963 6174 652e  e a certificate.
-00054f80: 220a 2020 2020 2020 2020 2020 2020 2920  ".            ) 
-00054f90: 6672 6f6d 204e 6f6e 650a 2020 2020 656c  from None.    el
-00054fa0: 6966 2067 732e 7061 2e6e 6f5f 7373 6c3a  if gs.pa.no_ssl:
-00054fb0: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
-00054fc0: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
-00054fd0: 2020 2022 5353 4c20 7769 6c6c 2062 6520     "SSL will be 
-00054fe0: 6e6f 7420 6265 2075 7365 642e 2054 6865  not be used. The
-00054ff0: 2053 534c 2063 6572 7469 6669 6361 7465   SSL certificate
-00055000: 2076 616c 6964 6174 696f 6e20 220a 2020   validation ".  
-00055010: 2020 2020 2020 2020 2020 2277 696c 6c20            "will 
-00055020: 6265 2073 6b69 7070 6564 2066 6f72 2074  be skipped for t
-00055030: 6869 7320 636f 6e6e 6563 7469 6f6e 2e22  his connection."
-00055040: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00055050: 2020 2067 732e 7373 6c20 3d20 4661 6c73     gs.ssl = Fals
-00055060: 650a 2020 2020 656c 7365 3a0a 2020 2020  e.    else:.    
-00055070: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-00055080: 280a 2020 2020 2020 2020 2020 2020 2253  (.            "S
-00055090: 534c 2077 696c 6c20 6265 2075 7365 642e  SL will be used.
-000550a0: 2044 6566 6175 6c74 2053 534c 2063 6572   Default SSL cer
-000550b0: 7469 6669 6361 7465 2076 616c 6964 6174  tificate validat
-000550c0: 696f 6e20 220a 2020 2020 2020 2020 2020  ion ".          
-000550d0: 2020 2277 696c 6c20 6265 2064 6f6e 6520    "will be done 
-000550e0: 666f 7220 7468 6973 2063 6f6e 6e65 6374  for this connect
-000550f0: 696f 6e2e 220a 2020 2020 2020 2020 290a  ion.".        ).
-00055100: 2020 2020 2020 2020 6773 2e73 736c 203d          gs.ssl =
-00055110: 204e 6f6e 650a 0a20 2020 2074 7279 3a0a   None..    try:.
-00055120: 2020 2020 2020 2020 6173 796e 6369 6f2e          asyncio.
-00055130: 7275 6e28 6173 796e 635f 6d61 696e 2829  run(async_main()
-00055140: 2920 2023 2064 6f20 6576 6572 7974 6869  )  # do everythi
-00055150: 6e67 2069 6e20 7468 6520 6576 656e 7420  ng in the event 
-00055160: 6c6f 6f70 0a20 2020 2020 2020 2023 2074  loop.        # t
-00055170: 6865 206e 6578 7420 6361 6e20 6265 2072  he next can be r
-00055180: 6561 6368 6564 206f 6e20 7375 6363 6573  eached on succes
-00055190: 7320 6f72 2066 6169 6c75 7265 0a20 2020  s or failure.   
-000551a0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-000551b0: 6728 6622 5468 6520 7072 6f67 7261 6d20  g(f"The program 
-000551c0: 7b50 524f 475f 5749 5448 5f45 5854 7d20  {PROG_WITH_EXT} 
-000551d0: 6c65 6674 2074 6865 2065 7665 6e74 206c  left the event l
-000551e0: 6f6f 702e 2229 0a20 2020 2065 7863 6570  oop.").    excep
-000551f0: 7420 5469 6d65 6f75 7445 7272 6f72 2061  t TimeoutError a
-00055200: 7320 653a 0a20 2020 2020 2020 2067 732e  s e:.        gs.
-00055210: 6572 725f 636f 756e 7420 2b3d 2031 0a20  err_count += 1. 
-00055220: 2020 2020 2020 2072 6169 7365 204d 6174         raise Mat
-00055230: 7269 7843 6f6d 6d61 6e64 6572 4572 726f  rixCommanderErro
-00055240: 7228 0a20 2020 2020 2020 2020 2020 2022  r(.            "
-00055250: 4532 3437 3a20 220a 2020 2020 2020 2020  E247: ".        
-00055260: 2020 2020 6622 5468 6520 7072 6f67 7261      f"The progra
-00055270: 6d20 7b50 524f 475f 5749 5448 5f45 5854  m {PROG_WITH_EXT
-00055280: 7d20 7261 6e20 696e 746f 2061 2074 696d  } ran into a tim
-00055290: 656f 7574 2e20 220a 2020 2020 2020 2020  eout. ".        
-000552a0: 2020 2020 224d 6f73 7420 6c69 6b65 6c79      "Most likely
-000552b0: 2063 6f6e 6e65 6374 6976 6974 7920 746f   connectivity to
-000552c0: 2069 6e74 6572 6e65 7420 7761 7320 6c6f   internet was lo
-000552d0: 7374 2e20 220a 2020 2020 2020 2020 2020  st. ".          
-000552e0: 2020 2249 6620 7468 6973 2068 6170 7065    "If this happe
-000552f0: 6e73 2066 7265 7175 656e 746c 7920 636f  ns frequently co
-00055300: 6e73 6964 6572 2072 756e 6e69 6e67 2074  nsider running t
-00055310: 6869 7320 220a 2020 2020 2020 2020 2020  his ".          
-00055320: 2020 2270 726f 6772 616d 2061 7320 6120    "program as a 
-00055330: 7365 7276 6963 6520 736f 2069 7420 7769  service so it wi
-00055340: 6c6c 2072 6573 7461 7274 2061 7574 6f6d  ll restart autom
-00055350: 6174 6963 616c 6c79 2e20 536f 7272 792e  atically. Sorry.
-00055360: 220a 2020 2020 2020 2020 2920 6672 6f6d  ".        ) from
-00055370: 2065 0a20 2020 2065 7863 6570 7420 4d61   e.    except Ma
-00055380: 7472 6978 436f 6d6d 616e 6465 7245 7272  trixCommanderErr
-00055390: 6f72 3a0a 2020 2020 2020 2020 7261 6973  or:.        rais
-000553a0: 650a 2020 2020 6578 6365 7074 204b 6579  e.    except Key
-000553b0: 626f 6172 6449 6e74 6572 7275 7074 3a0a  boardInterrupt:.
-000553c0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-000553d0: 6562 7567 2822 4b65 7962 6f61 7264 2069  ebug("Keyboard i
-000553e0: 6e74 6572 7275 7074 2072 6563 6569 7665  nterrupt receive
-000553f0: 642e 2229 0a20 2020 2065 7863 6570 7420  d.").    except 
-00055400: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
-00055410: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
-00055420: 2b3d 2031 0a20 2020 2020 2020 2067 732e  += 1.        gs.
-00055430: 6c6f 672e 6572 726f 7228 2245 3234 383a  log.error("E248:
-00055440: 2022 2066 2254 6865 2070 726f 6772 616d   " f"The program
-00055450: 207b 5052 4f47 5f57 4954 485f 4558 547d   {PROG_WITH_EXT}
-00055460: 2066 6169 6c65 642e 2053 6f72 7279 2e22   failed. Sorry."
-00055470: 290a 2020 2020 2020 2020 7261 6973 650a  ).        raise.
-00055480: 2020 2020 6669 6e61 6c6c 793a 0a20 2020      finally:.   
-00055490: 2020 2020 2063 6c65 616e 7570 2829 0a0a       cleanup()..
-000554a0: 0a64 6566 206d 6169 6e28 6172 6776 3a20  .def main(argv: 
-000554b0: 556e 696f 6e5b 4e6f 6e65 2c20 6c69 7374  Union[None, list
-000554c0: 5d20 3d20 4e6f 6e65 2920 2d3e 2069 6e74  ] = None) -> int
-000554d0: 3a0a 2020 2020 2222 2252 756e 2074 6865  :.    """Run the
-000554e0: 2070 726f 6772 616d 2e0a 0a20 2020 206d   program...    m
-000554f0: 6169 6e28 2920 6973 2061 6e20 656e 7472  ain() is an entr
-00055500: 7920 706f 696e 7420 616c 6c6f 7769 6e67  y point allowing
-00055510: 206f 7468 6572 2050 7974 686f 6e20 7072   other Python pr
-00055520: 6f67 7261 6d73 2074 6f0a 2020 2020 6561  ograms to.    ea
-00055530: 7369 6c79 2063 616c 6c20 6d61 7472 6978  sily call matrix
-00055540: 2d63 6f6d 6d61 6e64 6572 2e0a 0a20 2020  -commander...   
-00055550: 2041 7267 756d 656e 7473 3a0a 2020 2020   Arguments:.    
-00055560: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 6172  ---------.    ar
-00055570: 6776 203a 206c 6973 7420 6f66 2061 7267  gv : list of arg
-00055580: 756d 656e 7473 2061 7320 696e 2073 7973  uments as in sys
-00055590: 2e61 7267 763b 2066 6972 7374 2065 6c65  .argv; first ele
-000555a0: 6d65 6e74 2069 7320 7468 650a 2020 2020  ment is the.    
-000555b0: 2020 2020 7072 6f67 7261 6d20 6e61 6d65      program name
-000555c0: 2c20 6675 7274 6865 7220 656c 656d 656e  , further elemen
-000555d0: 7473 2061 7265 2074 6865 2061 7267 756d  ts are the argum
-000555e0: 656e 7473 3b20 6576 6572 790a 2020 2020  ents; every.    
-000555f0: 2020 2020 656c 656d 656e 7420 6d75 7374      element must
-00055600: 2062 6520 6f66 2074 7970 6520 2273 7472   be of type "str
-00055610: 222e 0a20 2020 2020 2020 2061 7267 7620  "..        argv 
-00055620: 6973 206f 7074 696f 6e61 6c20 616e 6420  is optional and 
-00055630: 6361 6e20 6265 204e 6f6e 652e 0a20 2020  can be None..   
-00055640: 2020 2020 2049 6620 6172 6776 2069 7320       If argv is 
-00055650: 7365 7420 7468 656e 2074 6865 7365 2061  set then these a
-00055660: 7267 756d 656e 7473 2077 696c 6c20 6265  rguments will be
-00055670: 2075 7365 6420 6173 2061 7267 756d 656e   used as argumen
-00055680: 7473 2066 6f72 0a20 2020 2020 2020 206d  ts for.        m
-00055690: 6174 7269 782d 636f 6d6d 616e 6465 722e  atrix-commander.
-000556a0: 2049 6620 6172 6776 2069 7320 6e6f 7420   If argv is not 
-000556b0: 7365 7420 284e 6f6e 6520 6f72 2065 6d70  set (None or emp
-000556c0: 7479 206c 6973 7429 2c20 7468 656e 0a20  ty list), then. 
-000556d0: 2020 2020 2020 2073 7973 2e61 7267 7620         sys.argv 
-000556e0: 7769 6c6c 2062 6520 7573 6564 2061 7320  will be used as 
-000556f0: 6172 6775 6d65 6e74 7320 666f 7220 6d61  arguments for ma
-00055700: 7472 6978 2d63 6f6d 6d61 6e64 6572 2e0a  trix-commander..
-00055710: 0a20 2020 2045 7861 6d70 6c65 2069 6e70  .    Example inp
-00055720: 7574 2061 7267 763a 205b 226d 6174 7269  ut argv: ["matri
-00055730: 782d 636f 6d6d 616e 6465 7222 5d0a 2020  x-commander"].  
-00055740: 2020 2020 2020 5b22 6d61 7472 6978 2d63        ["matrix-c
-00055750: 6f6d 6d61 6e64 6572 2220 222d 2d76 6572  ommander" "--ver
-00055760: 7369 6f6e 225d 0a20 2020 2020 2020 205b  sion"].        [
-00055770: 226d 6174 7269 782d 636f 6d6d 616e 6465  "matrix-commande
-00055780: 7222 2022 2d2d 6d65 7373 6167 6522 2022  r" "--message" "
-00055790: 4865 6c6c 6f22 202d 2d69 6d61 6765 2022  Hello" --image "
-000557a0: 7069 632e 6a70 6722 5d0a 0a20 2020 2052  pic.jpg"]..    R
-000557b0: 6574 7572 6e73 2069 6e74 2e20 3020 666f  eturns int. 0 fo
-000557c0: 7220 7375 6363 6573 732e 2050 6f73 6974  r success. Posit
-000557d0: 6976 6520 696e 7465 6765 7220 666f 7220  ive integer for 
-000557e0: 6661 696c 7572 652e 0a20 2020 2020 2020  failure..       
-000557f0: 2052 6574 7572 6e73 2074 6865 2074 6f74   Returns the tot
-00055800: 616c 206e 756d 6265 7220 6f66 2065 7272  al number of err
-00055810: 6f72 7320 656e 636f 756e 7465 7265 642e  ors encountered.
-00055820: 0a0a 2020 2020 5472 6965 7320 746f 2061  ..    Tries to a
-00055830: 766f 6964 2072 6169 7369 6e67 2065 7863  void raising exc
-00055840: 6570 7469 6f6e 732e 0a0a 2020 2020 2222  eptions...    ""
-00055850: 220a 2020 2020 7472 793a 0a20 2020 2020  ".    try:.     
-00055860: 2020 206d 6169 6e5f 696e 6e65 7228 6172     main_inner(ar
-00055870: 6776 290a 2020 2020 6578 6365 7074 2028  gv).    except (
-00055880: 4578 6365 7074 696f 6e2c 204d 6174 7269  Exception, Matri
-00055890: 7843 6f6d 6d61 6e64 6572 4572 726f 722c  xCommanderError,
-000558a0: 204d 6174 7269 7843 6f6d 6d61 6e64 6572   MatrixCommander
-000558b0: 5761 726e 696e 6729 2061 7320 653a 0a20  Warning) as e:. 
-000558c0: 2020 2020 2020 2069 6620 6520 6e6f 7420         if e not 
-000558d0: 696e 2028 4d61 7472 6978 436f 6d6d 616e  in (MatrixComman
-000558e0: 6465 7245 7272 6f72 2c20 4d61 7472 6978  derError, Matrix
-000558f0: 436f 6d6d 616e 6465 7257 6172 6e69 6e67  CommanderWarning
-00055900: 293a 0a20 2020 2020 2020 2020 2020 2067  ):.            g
-00055910: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
-00055920: 0a20 2020 2020 2020 2074 6220 3d20 2222  .        tb = ""
-00055930: 0a20 2020 2020 2020 2069 6620 6773 2e70  .        if gs.p
-00055940: 612e 6465 6275 6720 3e20 303a 0a20 2020  a.debug > 0:.   
-00055950: 2020 2020 2020 2020 2074 6220 3d20 6622           tb = f"
-00055960: 5c6e 4865 7265 2069 7320 7468 6520 7472  \nHere is the tr
-00055970: 6163 6562 6163 6b2e 5c6e 7b74 7261 6365  aceback.\n{trace
-00055980: 6261 636b 2e66 6f72 6d61 745f 6578 6328  back.format_exc(
-00055990: 297d 220a 2020 2020 2020 2020 6966 2065  )}".        if e
-000559a0: 203d 3d20 4d61 7472 6978 436f 6d6d 616e   == MatrixComman
-000559b0: 6465 7257 6172 6e69 6e67 3a0a 2020 2020  derWarning:.    
-000559c0: 2020 2020 2020 2020 6773 2e6c 6f67 2e77          gs.log.w
-000559d0: 6172 6e69 6e67 2866 227b 657d 7b74 627d  arning(f"{e}{tb}
-000559e0: 2229 0a20 2020 2020 2020 2065 6c73 653a  ").        else:
-000559f0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
-00055a00: 6c6f 672e 6572 726f 7228 6622 7b65 7d7b  log.error(f"{e}{
-00055a10: 7462 7d22 290a 2020 2020 6966 2067 732e  tb}").    if gs.
-00055a20: 6572 725f 636f 756e 7420 3e20 3020 6f72  err_count > 0 or
-00055a30: 2067 732e 7761 726e 5f63 6f75 6e74 203e   gs.warn_count >
-00055a40: 2030 3a0a 2020 2020 2020 2020 6773 2e6c   0:.        gs.l
-00055a50: 6f67 2e69 6e66 6f28 0a20 2020 2020 2020  og.info(.       
-00055a60: 2020 2020 2066 227b 6773 2e65 7272 5f63       f"{gs.err_c
-00055a70: 6f75 6e74 7d20 220a 2020 2020 2020 2020  ount} ".        
-00055a80: 2020 2020 6622 6572 726f 727b 2727 2069      f"error{'' i
-00055a90: 6620 6773 2e65 7272 5f63 6f75 6e74 203d  f gs.err_count =
-00055aa0: 3d20 3120 656c 7365 2027 7327 7d20 616e  = 1 else 's'} an
-00055ab0: 6420 220a 2020 2020 2020 2020 2020 2020  d ".            
-00055ac0: 6622 7b67 732e 7761 726e 5f63 6f75 6e74  f"{gs.warn_count
-00055ad0: 7d20 220a 2020 2020 2020 2020 2020 2020  } ".            
-00055ae0: 6622 7761 726e 696e 677b 2727 2069 6620  f"warning{'' if 
-00055af0: 6773 2e77 6172 6e5f 636f 756e 7420 3d3d  gs.warn_count ==
-00055b00: 2031 2065 6c73 6520 2773 277d 206f 6363   1 else 's'} occ
-00055b10: 7572 7265 642e 220a 2020 2020 2020 2020  urred.".        
-00055b20: 290a 2020 2020 7265 7475 726e 2067 732e  ).    return gs.
-00055b30: 6572 725f 636f 756e 7420 2023 2030 2066  err_count  # 0 f
-00055b40: 6f72 2073 7563 6365 7373 0a0a 0a69 6620  or success...if 
-00055b50: 5f5f 6e61 6d65 5f5f 203d 3d20 225f 5f6d  __name__ == "__m
-00055b60: 6169 6e5f 5f22 3a0a 2020 2020 7379 732e  ain__":.    sys.
-00055b70: 6578 6974 286d 6169 6e28 2929 0a23 2045  exit(main()).# E
-00055b80: 4f46 0a                                  OF.
+0003e820: 7428 0a20 2020 2020 2020 2022 2d68 222c  t(.        "-h",
+0003e830: 0a20 2020 2020 2020 2022 2d2d 6865 6c70  .        "--help
+0003e840: 222c 0a20 2020 2020 2020 2072 6571 7569  ",.        requi
+0003e850: 7265 643d 4661 6c73 652c 0a20 2020 2020  red=False,.     
+0003e860: 2020 2061 6374 696f 6e3d 2273 746f 7265     action="store
+0003e870: 5f74 7275 6522 2c0a 2020 2020 2020 2020  _true",.        
+0003e880: 6865 6c70 3d22 5072 696e 7420 6865 6c70  help="Print help
+0003e890: 2e20 220a 2020 2020 2020 2020 2244 6574  . ".        "Det
+0003e8a0: 6169 6c73 3a3a 2053 6565 2061 6c73 6f20  ails:: See also 
+0003e8b0: 2d2d 7573 6167 6520 666f 7220 7072 696e  --usage for prin
+0003e8c0: 7469 6e67 2065 7665 6e20 6c65 7373 2069  ting even less i
+0003e8d0: 6e66 6f72 6d61 7469 6f6e 2c20 220a 2020  nformation, ".  
+0003e8e0: 2020 2020 2020 2261 6e64 202d 2d6d 616e        "and --man
+0003e8f0: 7561 6c20 666f 7220 7072 696e 7469 6e67  ual for printing
+0003e900: 206d 6f72 6520 6465 7461 696c 6564 2069   more detailed i
+0003e910: 6e66 6f72 6d61 7469 6f6e 2e22 2c0a 2020  nformation.",.  
+0003e920: 2020 290a 2020 2020 2320 7365 6520 2d68    ).    # see -h
+0003e930: 2c20 7365 6520 6164 645f 6865 6c70 3d46  , see add_help=F
+0003e940: 616c 7365 0a20 2020 2061 702e 6164 645f  alse.    ap.add_
+0003e950: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
+0003e960: 2020 222d 2d6d 616e 7561 6c22 2c0a 2020    "--manual",.  
+0003e970: 2020 2020 2020 7265 7175 6972 6564 3d46        required=F
+0003e980: 616c 7365 2c0a 2020 2020 2020 2020 6163  alse,.        ac
+0003e990: 7469 6f6e 3d22 7374 6f72 655f 7472 7565  tion="store_true
+0003e9a0: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
+0003e9b0: 2250 7269 6e74 206d 616e 7561 6c2e 2022  "Print manual. "
+0003e9c0: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
+0003e9d0: 733a 3a20 5365 6520 616c 736f 202d 2d75  s:: See also --u
+0003e9e0: 7361 6765 2066 6f72 2070 7269 6e74 696e  sage for printin
+0003e9f0: 6720 7468 6520 6162 736f 6c75 7465 206d  g the absolute m
+0003ea00: 696e 696d 756d 2c20 220a 2020 2020 2020  inimum, ".      
+0003ea10: 2020 2261 6e64 202d 2d68 656c 7020 666f    "and --help fo
+0003ea20: 7220 7072 696e 7469 6e67 206c 6573 732e  r printing less.
+0003ea30: 222c 0a20 2020 2029 0a20 2020 2023 2073  ",.    ).    # s
+0003ea40: 6565 202d 682c 2073 6565 2061 6464 5f68  ee -h, see add_h
+0003ea50: 656c 703d 4661 6c73 650a 2020 2020 6170  elp=False.    ap
+0003ea60: 2e61 6464 5f61 7267 756d 656e 7428 0a20  .add_argument(. 
+0003ea70: 2020 2020 2020 2022 2d2d 7265 6164 6d65         "--readme
+0003ea80: 222c 0a20 2020 2020 2020 2072 6571 7569  ",.        requi
+0003ea90: 7265 643d 4661 6c73 652c 0a20 2020 2020  red=False,.     
+0003eaa0: 2020 2061 6374 696f 6e3d 2273 746f 7265     action="store
+0003eab0: 5f74 7275 6522 2c0a 2020 2020 2020 2020  _true",.        
+0003eac0: 6865 6c70 3d22 5072 696e 7420 5245 4144  help="Print READ
+0003ead0: 4d45 2e6d 6420 6669 6c65 2e20 220a 2020  ME.md file. ".  
+0003eae0: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
+0003eaf0: 2054 7269 6573 2074 6f20 7072 696e 7420   Tries to print 
+0003eb00: 7468 6520 6c6f 6361 6c20 5245 4144 4d45  the local README
+0003eb10: 2e6d 6420 6669 6c65 2066 726f 6d20 696e  .md file from in
+0003eb20: 7374 616c 6c61 7469 6f6e 2e20 220a 2020  stallation. ".  
+0003eb30: 2020 2020 2020 2249 6620 6e6f 7420 666f        "If not fo
+0003eb40: 756e 6420 6974 2077 696c 6c20 6765 7420  und it will get 
+0003eb50: 7468 6520 5245 4144 4d45 2e6d 6420 6669  the README.md fi
+0003eb60: 6c65 2066 726f 6d20 6769 7468 7562 2e63  le from github.c
+0003eb70: 6f6d 2061 6e64 2022 0a20 2020 2020 2020  om and ".       
+0003eb80: 2022 7072 696e 7420 6974 2e20 5365 6520   "print it. See 
+0003eb90: 616c 736f 202d 2d75 7361 6765 2c20 2d2d  also --usage, --
+0003eba0: 6865 6c70 2c20 616e 6420 2d2d 6d61 6e75  help, and --manu
+0003ebb0: 616c 2e22 2c0a 2020 2020 290a 2020 2020  al.",.    ).    
+0003ebc0: 2320 4164 6420 7468 6520 6172 6775 6d65  # Add the argume
+0003ebd0: 6e74 7320 746f 2074 6865 2070 6172 7365  nts to the parse
+0003ebe0: 720a 2020 2020 6170 2e61 6464 5f61 7267  r.    ap.add_arg
+0003ebf0: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
+0003ec00: 2d64 222c 0a20 2020 2020 2020 2022 2d2d  -d",.        "--
+0003ec10: 6465 6275 6722 2c0a 2020 2020 2020 2020  debug",.        
+0003ec20: 6163 7469 6f6e 3d22 636f 756e 7422 2c0a  action="count",.
+0003ec30: 2020 2020 2020 2020 6465 6661 756c 743d          default=
+0003ec40: 302c 0a20 2020 2020 2020 2068 656c 703d  0,.        help=
+0003ec50: 2250 7269 6e74 2064 6562 7567 2069 6e66  "Print debug inf
+0003ec60: 6f72 6d61 7469 6f6e 2e20 220a 2020 2020  ormation. ".    
+0003ec70: 2020 2020 2244 6574 6169 6c73 3a3a 2049      "Details:: I
+0003ec80: 6620 7573 6564 206f 6e63 652c 206f 6e6c  f used once, onl
+0003ec90: 7920 7468 6520 6c6f 6720 6c65 7665 6c20  y the log level 
+0003eca0: 6f66 2022 0a20 2020 2020 2020 2066 227b  of ".        f"{
+0003ecb0: 5052 4f47 5f57 4954 484f 5554 5f45 5854  PROG_WITHOUT_EXT
+0003ecc0: 7d20 6973 2073 6574 2074 6f20 4445 4255  } is set to DEBU
+0003ecd0: 472e 2022 0a20 2020 2020 2020 2027 4966  G. ".        'If
+0003ece0: 2075 7365 6420 7477 6963 6520 2822 2d64   used twice ("-d
+0003ecf0: 202d 6422 206f 7220 222d 6464 2229 2074   -d" or "-dd") t
+0003ed00: 6865 6e20 270a 2020 2020 2020 2020 6622  hen '.        f"
+0003ed10: 6c6f 6720 6c65 7665 6c73 206f 6620 626f  log levels of bo
+0003ed20: 7468 207b 5052 4f47 5f57 4954 484f 5554  th {PROG_WITHOUT
+0003ed30: 5f45 5854 7d20 616e 6420 756e 6465 726c  _EXT} and underl
+0003ed40: 7969 6e67 206d 6f64 756c 6573 2061 7265  ying modules are
+0003ed50: 2022 0a20 2020 2020 2020 2027 7365 7420   ".        'set 
+0003ed60: 746f 2044 4542 5547 2e20 222d 6422 2069  to DEBUG. "-d" i
+0003ed70: 7320 6120 7368 6f72 7463 7574 2066 6f72  s a shortcut for
+0003ed80: 2022 2d2d 6c6f 672d 6c65 7665 6c20 4445   "--log-level DE
+0003ed90: 4255 4722 2e20 270a 2020 2020 2020 2020  BUG". '.        
+0003eda0: 2753 6565 2061 6c73 6f20 2d2d 6c6f 672d  'See also --log-
+0003edb0: 6c65 7665 6c2e 2022 2d64 2220 7461 6b65  level. "-d" take
+0003edc0: 7320 7072 6563 6564 656e 6365 206f 7665  s precedence ove
+0003edd0: 7220 222d 2d6c 6f67 2d6c 6576 656c 222e  r "--log-level".
+0003ede0: 2027 0a20 2020 2020 2020 2027 4164 6469   '.        'Addi
+0003edf0: 7469 6f6e 616c 6c79 2c20 6861 7665 2061  tionally, have a
+0003ee00: 206c 6f6f 6b20 616c 736f 2061 7420 7468   look also at th
+0003ee10: 6520 6f70 7469 6f6e 2022 2d2d 7665 7262  e option "--verb
+0003ee20: 6f73 6522 2e20 272c 0a20 2020 2029 0a20  ose". ',.    ). 
+0003ee30: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
+0003ee40: 6e74 280a 2020 2020 2020 2020 222d 2d6c  nt(.        "--l
+0003ee50: 6f67 2d6c 6576 656c 222c 0a20 2020 2020  og-level",.     
+0003ee60: 2020 2072 6571 7569 7265 643d 4661 6c73     required=Fals
+0003ee70: 652c 0a20 2020 2020 2020 2061 6374 696f  e,.        actio
+0003ee80: 6e3d 2265 7874 656e 6422 2c0a 2020 2020  n="extend",.    
+0003ee90: 2020 2020 6e61 7267 733d 222b 222c 0a20      nargs="+",. 
+0003eea0: 2020 2020 2020 2074 7970 653d 7374 722c         type=str,
+0003eeb0: 0a20 2020 2020 2020 206d 6574 6176 6172  .        metavar
+0003eec0: 3d28 2244 4542 5547 7c49 4e46 4f7c 5741  =("DEBUG|INFO|WA
+0003eed0: 524e 494e 477c 4552 524f 527c 4352 4954  RNING|ERROR|CRIT
+0003eee0: 4943 414c 2229 2c0a 2020 2020 2020 2020  ICAL"),.        
+0003eef0: 6865 6c70 3d22 5365 7420 7468 6520 6c6f  help="Set the lo
+0003ef00: 6720 6c65 7665 6c28 7329 2e20 220a 2020  g level(s). ".  
+0003ef10: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
+0003ef20: 2050 6f73 7369 626c 6520 7661 6c75 6573   Possible values
+0003ef30: 2061 7265 2022 0a20 2020 2020 2020 2027   are ".        '
+0003ef40: 2244 4542 5547 222c 2022 494e 464f 222c  "DEBUG", "INFO",
+0003ef50: 2022 5741 524e 494e 4722 2c20 2245 5252   "WARNING", "ERR
+0003ef60: 4f52 222c 2061 6e64 2022 4352 4954 4943  OR", and "CRITIC
+0003ef70: 414c 222e 2027 0a20 2020 2020 2020 2022  AL". '.        "
+0003ef80: 4966 202d 2d6c 6f67 5f6c 6576 656c 2069  If --log_level i
+0003ef90: 7320 7573 6564 2077 6974 6820 6f6e 6520  s used with one 
+0003efa0: 6c65 7665 6c20 6172 6775 6d65 6e74 2c20  level argument, 
+0003efb0: 6f6e 6c79 2074 6865 206c 6f67 206c 6576  only the log lev
+0003efc0: 656c 2022 0a20 2020 2020 2020 2066 226f  el ".        f"o
+0003efd0: 6620 7b50 524f 475f 5749 5448 4f55 545f  f {PROG_WITHOUT_
+0003efe0: 4558 547d 2069 7320 7365 7420 746f 2074  EXT} is set to t
+0003eff0: 6865 2073 7065 6369 6669 6564 2076 616c  he specified val
+0003f000: 7565 2e20 220a 2020 2020 2020 2020 2249  ue. ".        "I
+0003f010: 6620 2d2d 6c6f 675f 6c65 7665 6c20 6973  f --log_level is
+0003f020: 2075 7365 6420 7769 7468 2074 776f 206c   used with two l
+0003f030: 6576 656c 2061 7267 756d 656e 7420 220a  evel argument ".
+0003f040: 2020 2020 2020 2020 2728 652e 672e 2022          '(e.g. "
+0003f050: 2d2d 6c6f 672d 6c65 7665 6c20 5741 524e  --log-level WARN
+0003f060: 494e 4720 4552 524f 5222 2920 7468 656e  ING ERROR") then
+0003f070: 2027 0a20 2020 2020 2020 2066 226c 6f67   '.        f"log
+0003f080: 206c 6576 656c 7320 6f66 2062 6f74 6820   levels of both 
+0003f090: 7b50 524f 475f 5749 5448 4f55 545f 4558  {PROG_WITHOUT_EX
+0003f0a0: 547d 2061 6e64 2075 6e64 6572 6c79 696e  T} and underlyin
+0003f0b0: 6720 6d6f 6475 6c65 7320 6172 6520 220a  g modules are ".
+0003f0c0: 2020 2020 2020 2020 2273 6574 2074 6f20          "set to 
+0003f0d0: 7468 6520 7370 6563 6966 6965 6420 7661  the specified va
+0003f0e0: 6c75 6573 2e20 220a 2020 2020 2020 2020  lues. ".        
+0003f0f0: 2253 6565 2061 6c73 6f20 2d2d 6465 6275  "See also --debu
+0003f100: 672e 222c 0a20 2020 2029 0a20 2020 2061  g.",.    ).    a
+0003f110: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
+0003f120: 2020 2020 2020 2020 222d 2d76 6572 626f          "--verbo
+0003f130: 7365 222c 0a20 2020 2020 2020 2061 6374  se",.        act
+0003f140: 696f 6e3d 2263 6f75 6e74 222c 0a20 2020  ion="count",.   
+0003f150: 2020 2020 2064 6566 6175 6c74 3d30 2c0a       default=0,.
+0003f160: 2020 2020 2020 2020 6865 6c70 3d22 5365          help="Se
+0003f170: 7420 7468 6520 7665 7262 6f73 6974 7920  t the verbosity 
+0003f180: 6c65 7665 6c2e 2022 0a20 2020 2020 2020  level. ".       
+0003f190: 2022 4465 7461 696c 733a 3a20 4966 206e   "Details:: If n
+0003f1a0: 6f74 2075 7365 642c 2074 6865 6e20 7665  ot used, then ve
+0003f1b0: 7262 6f73 6974 7920 7769 6c6c 2062 6520  rbosity will be 
+0003f1c0: 220a 2020 2020 2020 2020 2273 6574 2074  ".        "set t
+0003f1d0: 6f20 6c6f 772e 2049 6620 7573 6564 206f  o low. If used o
+0003f1e0: 6e63 652c 2076 6572 626f 7369 7479 2077  nce, verbosity w
+0003f1f0: 696c 6c20 6265 2068 6967 682e 2022 0a20  ill be high. ". 
+0003f200: 2020 2020 2020 2022 4966 2075 7365 6420         "If used 
+0003f210: 6d6f 7265 2074 6861 6e20 6f6e 6365 2c20  more than once, 
+0003f220: 7665 7262 6f73 6974 7920 7769 6c6c 2062  verbosity will b
+0003f230: 6520 7665 7279 2068 6967 682e 2022 0a20  e very high. ". 
+0003f240: 2020 2020 2020 2022 5665 7262 6f73 6974         "Verbosit
+0003f250: 7920 6f6e 6c79 2061 6666 6563 7473 2074  y only affects t
+0003f260: 6865 2064 6562 7567 2069 6e66 6f72 6d61  he debug informa
+0003f270: 7469 6f6e 2e20 220a 2020 2020 2020 2020  tion. ".        
+0003f280: 2253 6f2c 2069 6620 272d 2d64 6562 7567  "So, if '--debug
+0003f290: 2720 6973 206e 6f74 2075 7365 6420 7468  ' is not used th
+0003f2a0: 656e 2027 2d2d 7665 7262 6f73 6527 2077  en '--verbose' w
+0003f2b0: 696c 6c20 6265 2069 676e 6f72 6564 2e22  ill be ignored."
+0003f2c0: 2c0a 2020 2020 290a 2020 2020 6170 2e61  ,.    ).    ap.a
+0003f2d0: 6464 5f61 7267 756d 656e 7428 0a20 2020  dd_argument(.   
+0003f2e0: 2020 2020 2022 2d2d 6c6f 6769 6e22 2c0a       "--login",.
+0003f2f0: 2020 2020 2020 2020 7265 7175 6972 6564          required
+0003f300: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+0003f310: 7479 7065 3d73 7472 2c20 2023 206c 6f67  type=str,  # log
+0003f320: 696e 206d 6574 686f 643a 2070 6173 7377  in method: passw
+0003f330: 6f72 642c 2073 736f 2c20 2861 6363 6573  ord, sso, (acces
+0003f340: 732d 746f 6b65 6e29 0a20 2020 2020 2020  s-token).       
+0003f350: 206d 6574 6176 6172 3d22 5041 5353 574f   metavar="PASSWO
+0003f360: 5244 7c53 534f 222c 0a20 2020 2020 2020  RD|SSO",.       
+0003f370: 2068 656c 703d 224c 6f67 696e 2074 6f20   help="Login to 
+0003f380: 616e 6420 6175 7468 656e 7469 6361 7465  and authenticate
+0003f390: 2077 6974 6820 7468 6520 4d61 7472 6978   with the Matrix
+0003f3a0: 2068 6f6d 6573 6572 7665 722e 2022 0a20   homeserver. ". 
+0003f3b0: 2020 2020 2020 2022 4465 7461 696c 733a         "Details:
+0003f3c0: 3a20 5468 6973 2072 6571 7569 7265 7320  : This requires 
+0003f3d0: 6578 6163 746c 7920 6f6e 6520 6172 6775  exactly one argu
+0003f3e0: 6d65 6e74 2c20 7468 6520 6c6f 6769 6e20  ment, the login 
+0003f3f0: 6d65 7468 6f64 2e20 220a 2020 2020 2020  method. ".      
+0003f400: 2020 2243 7572 7265 6e74 6c79 2074 776f    "Currently two
+0003f410: 2063 686f 6963 6573 2061 7265 206f 6666   choices are off
+0003f420: 6572 6564 3a20 2770 6173 7377 6f72 6427  ered: 'password'
+0003f430: 2061 6e64 2027 7373 6f27 2e20 220a 2020   and 'sso'. ".  
+0003f440: 2020 2020 2020 2250 726f 7669 6465 206f        "Provide o
+0003f450: 6e65 206f 6620 7468 6573 6520 6d65 7468  ne of these meth
+0003f460: 6f64 732e 2022 0a20 2020 2020 2020 2022  ods. ".        "
+0003f470: 4966 2079 6f75 2068 6176 6520 6368 6f73  If you have chos
+0003f480: 656e 2027 7061 7373 776f 7264 272c 2022  en 'password', "
+0003f490: 0a20 2020 2020 2020 2022 796f 7520 7769  .        "you wi
+0003f4a0: 6c6c 2061 7574 6865 6e74 6963 6174 6520  ll authenticate 
+0003f4b0: 7468 726f 7567 6820 796f 7572 2061 6363  through your acc
+0003f4c0: 6f75 6e74 2070 6173 7377 6f72 642e 2059  ount password. Y
+0003f4d0: 6f75 2063 616e 2022 0a20 2020 2020 2020  ou can ".       
+0003f4e0: 2022 6f70 7469 6f6e 616c 6c79 2070 726f   "optionally pro
+0003f4f0: 7669 6465 2074 6865 7365 2061 6464 6974  vide these addit
+0003f500: 696f 6e61 6c20 6172 6775 6d65 6e74 733a  ional arguments:
+0003f510: 2022 0a20 2020 2020 2020 2022 2d2d 686f   ".        "--ho
+0003f520: 6d65 7365 7276 6572 2074 6f20 7370 6563  meserver to spec
+0003f530: 6966 7920 7468 6520 4d61 7472 6978 2068  ify the Matrix h
+0003f540: 6f6d 6573 6572 7665 722c 2022 0a20 2020  omeserver, ".   
+0003f550: 2020 2020 2022 2d2d 7573 6572 2d6c 6f67       "--user-log
+0003f560: 696e 2074 6f20 7370 6563 6966 7920 7468  in to specify th
+0003f570: 6520 6c6f 6720 696e 2075 7365 7220 6964  e log in user id
+0003f580: 2c20 220a 2020 2020 2020 2020 222d 2d70  , ".        "--p
+0003f590: 6173 7377 6f72 6420 746f 2073 7065 6369  assword to speci
+0003f5a0: 6679 2074 6865 2070 6173 7377 6f72 642c  fy the password,
+0003f5b0: 2022 0a20 2020 2020 2020 2022 2d2d 6465   ".        "--de
+0003f5c0: 7669 6365 2074 6f20 7370 6563 6966 7920  vice to specify 
+0003f5d0: 6120 6465 7669 6365 206e 616d 652c 2022  a device name, "
+0003f5e0: 0a20 2020 2020 2020 2022 2d2d 726f 6f6d  .        "--room
+0003f5f0: 2d64 6566 6175 6c74 2074 6f20 7370 6563  -default to spec
+0003f600: 6966 7920 6120 6465 6661 756c 7420 726f  ify a default ro
+0003f610: 6f6d 2066 6f72 2073 656e 6469 6e67 2f6c  om for sending/l
+0003f620: 6973 7465 6e69 6e67 2e20 220a 2020 2020  istening. ".    
+0003f630: 2020 2020 2249 6620 796f 7520 6861 7665      "If you have
+0003f640: 2063 686f 7365 6e20 2773 736f 272c 2022   chosen 'sso', "
+0003f650: 0a20 2020 2020 2020 2022 796f 7520 7769  .        "you wi
+0003f660: 6c6c 2061 7574 6865 6e74 6963 6174 6520  ll authenticate 
+0003f670: 7468 726f 7567 6820 5369 6e67 6c65 2053  through Single S
+0003f680: 6967 6e2d 4f6e 2e20 4120 7765 622d 6272  ign-On. A web-br
+0003f690: 6f77 7365 7220 7769 6c6c 2022 0a20 2020  owser will ".   
+0003f6a0: 2020 2020 2022 6265 2073 7461 7274 6564       "be started
+0003f6b0: 2061 6e64 2079 6f75 2061 7574 6865 6e74   and you authent
+0003f6c0: 6963 6174 6520 6f6e 2074 6865 2077 6562  icate on the web
+0003f6d0: 7061 6765 2e20 596f 7520 6361 6e20 220a  page. You can ".
+0003f6e0: 2020 2020 2020 2020 226f 7074 696f 6e61          "optiona
+0003f6f0: 6c6c 7920 7072 6f76 6964 6520 7468 6573  lly provide thes
+0003f700: 6520 6164 6469 7469 6f6e 616c 2061 7267  e additional arg
+0003f710: 756d 656e 7473 3a20 220a 2020 2020 2020  uments: ".      
+0003f720: 2020 222d 2d68 6f6d 6573 6572 7665 7220    "--homeserver 
+0003f730: 746f 2073 7065 6369 6679 2074 6865 204d  to specify the M
+0003f740: 6174 7269 7820 686f 6d65 7365 7276 6572  atrix homeserver
+0003f750: 2c20 220a 2020 2020 2020 2020 222d 2d75  , ".        "--u
+0003f760: 7365 722d 6c6f 6769 6e20 746f 2073 7065  ser-login to spe
+0003f770: 6369 6679 2074 6865 206c 6f67 2069 6e20  cify the log in 
+0003f780: 7573 6572 2069 642c 2022 0a20 2020 2020  user id, ".     
+0003f790: 2020 2022 2d2d 6465 7669 6365 2074 6f20     "--device to 
+0003f7a0: 7370 6563 6966 7920 6120 6465 7669 6365  specify a device
+0003f7b0: 206e 616d 652c 2022 0a20 2020 2020 2020   name, ".       
+0003f7c0: 2022 2d2d 726f 6f6d 2d64 6566 6175 6c74   "--room-default
+0003f7d0: 2074 6f20 7370 6563 6966 7920 6120 6465   to specify a de
+0003f7e0: 6661 756c 7420 726f 6f6d 2066 6f72 2073  fault room for s
+0003f7f0: 656e 6469 6e67 2f6c 6973 7465 6e69 6e67  ending/listening
+0003f800: 2e20 220a 2020 2020 2020 2020 2253 6565  . ".        "See
+0003f810: 2061 6c6c 2074 6865 2065 7874 7261 2061   all the extra a
+0003f820: 7267 756d 656e 7473 2066 6f72 2066 7572  rguments for fur
+0003f830: 7468 6572 2065 7870 6c61 6e61 7469 6f6e  ther explanation
+0003f840: 732e 202d 2d2d 2d2d 2022 0a20 2020 2020  s. ----- ".     
+0003f850: 2020 2022 5353 4f20 2853 696e 676c 6520     "SSO (Single 
+0003f860: 5369 676e 2d4f 6e29 2073 7461 7274 7320  Sign-On) starts 
+0003f870: 6120 7765 6220 220a 2020 2020 2020 2020  a web ".        
+0003f880: 2262 726f 7773 6572 2061 6e64 2063 6f6e  "browser and con
+0003f890: 6e65 6374 7320 7468 6520 7573 6572 2074  nects the user t
+0003f8a0: 6f20 6120 7765 6220 7061 6765 206f 6e20  o a web page on 
+0003f8b0: 7468 6520 220a 2020 2020 2020 2020 2273  the ".        "s
+0003f8c0: 6572 7665 7220 666f 7220 6c6f 6769 6e2e  erver for login.
+0003f8d0: 2053 534f 2077 696c 6c20 6f6e 6c79 2077   SSO will only w
+0003f8e0: 6f72 6b20 6966 2074 6865 2073 6572 7665  ork if the serve
+0003f8f0: 7220 220a 2020 2020 2020 2020 2273 7570  r ".        "sup
+0003f900: 706f 7274 7320 6974 2061 6e64 2069 6620  ports it and if 
+0003f910: 7468 6572 6520 6973 2061 6363 6573 7320  there is access 
+0003f920: 746f 2061 2062 726f 7773 6572 2e20 536f  to a browser. So
+0003f930: 2c20 646f 6e27 7420 7573 6520 5353 4f20  , don't use SSO 
+0003f940: 220a 2020 2020 2020 2020 226f 6e20 6865  ".        "on he
+0003f950: 6164 6c65 7373 2068 6f6d 6573 6572 7665  adless homeserve
+0003f960: 7273 2077 6865 7265 2074 6865 7265 2069  rs where there i
+0003f970: 7320 6e6f 2022 0a20 2020 2020 2020 2022  s no ".        "
+0003f980: 6272 6f77 7365 7220 696e 7374 616c 6c65  browser installe
+0003f990: 6420 6f72 2061 6363 6573 7369 626c 652e  d or accessible.
+0003f9a0: 222c 0a20 2020 2029 0a20 2020 2061 702e  ",.    ).    ap.
+0003f9b0: 6164 645f 6172 6775 6d65 6e74 280a 2020  add_argument(.  
+0003f9c0: 2020 2020 2020 2320 222d 7622 2c20 2323        # "-v", ##
+0003f9d0: 2069 6e63 6f6d 7061 7469 626c 6520 6368   incompatible ch
+0003f9e0: 616e 6765 2c20 2d76 206d 6f76 6564 2074  ange, -v moved t
+0003f9f0: 6f20 2d2d 7665 7273 696f 6e0a 2020 2020  o --version.    
+0003fa00: 2020 2020 222d 2d76 6572 6966 7922 2c0a      "--verify",.
+0003fa10: 2020 2020 2020 2020 7265 7175 6972 6564          required
+0003fa20: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+0003fa30: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
+0003fa40: 2020 6465 6661 756c 743d 5645 5249 4659    default=VERIFY
+0003fa50: 5f55 4e55 5345 445f 4445 4641 554c 542c  _UNUSED_DEFAULT,
+0003fa60: 2020 2320 7768 656e 202d 7420 6973 206e    # when -t is n
+0003fa70: 6f74 2075 7365 640a 2020 2020 2020 2020  ot used.        
+0003fa80: 6e61 7267 733d 223f 222c 2020 2320 6d61  nargs="?",  # ma
+0003fa90: 6b65 7320 7468 6520 776f 7264 206f 7074  kes the word opt
+0003faa0: 696f 6e61 6c0a 2020 2020 2020 2020 2320  ional.        # 
+0003fab0: 7768 656e 202d 7620 6973 2075 7365 642c  when -v is used,
+0003fac0: 2062 7574 2074 6578 7420 6973 206e 6f74   but text is not
+0003fad0: 2061 6464 6564 0a20 2020 2020 2020 2063   added.        c
+0003fae0: 6f6e 7374 3d56 4552 4946 595f 5553 4544  onst=VERIFY_USED
+0003faf0: 5f44 4546 4155 4c54 2c0a 2020 2020 2020  _DEFAULT,.      
+0003fb00: 2020 6d65 7461 7661 723d 2245 4d4f 4a49    metavar="EMOJI
+0003fb10: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
+0003fb20: 2250 6572 666f 726d 2076 6572 6966 6963  "Perform verific
+0003fb30: 6174 696f 6e2e 2022 0a20 2020 2020 2020  ation. ".       
+0003fb40: 2022 4465 7461 696c 733a 3a20 4279 2064   "Details:: By d
+0003fb50: 6566 6175 6c74 2c20 6e6f 2022 0a20 2020  efault, no ".   
+0003fb60: 2020 2020 2022 7665 7269 6669 6361 7469       "verificati
+0003fb70: 6f6e 2069 7320 7065 7266 6f72 6d65 642e  on is performed.
+0003fb80: 2022 0a20 2020 2020 2020 2066 2750 6f73   ".        f'Pos
+0003fb90: 7369 626c 6520 7661 6c75 6573 2061 7265  sible values are
+0003fba0: 3a20 227b 454d 4f4a 497d 222e 2027 0a20  : "{EMOJI}". '. 
+0003fbb0: 2020 2020 2020 2022 4966 2076 6572 6966         "If verif
+0003fbc0: 6963 6174 696f 6e20 6973 2064 6573 6972  ication is desir
+0003fbd0: 6564 2c20 7275 6e20 7468 6973 2070 726f  ed, run this pro
+0003fbe0: 6772 616d 2069 6e20 7468 6520 220a 2020  gram in the ".  
+0003fbf0: 2020 2020 2020 2266 6f72 6567 726f 756e        "foregroun
+0003fc00: 6420 286e 6f74 2061 7320 6120 7365 7276  d (not as a serv
+0003fc10: 6963 6529 2061 6e64 2077 6974 686f 7574  ice) and without
+0003fc20: 2061 2070 6970 652e 2022 0a20 2020 2020   a pipe. ".     
+0003fc30: 2020 2022 5768 696c 6520 7665 7269 6669     "While verifi
+0003fc40: 6361 7469 6f6e 2069 7320 6f70 7469 6f6e  cation is option
+0003fc50: 616c 2069 7420 6973 2068 6967 686c 7920  al it is highly 
+0003fc60: 7265 636f 6d6d 656e 6465 642c 2061 6e64  recommended, and
+0003fc70: 2069 7420 220a 2020 2020 2020 2020 2269   it ".        "i
+0003fc80: 7320 7265 636f 6d6d 656e 6465 6420 746f  s recommended to
+0003fc90: 2062 6520 646f 6e65 2072 6967 6874 2061   be done right a
+0003fca0: 6674 6572 2028 6f72 2074 6f67 6574 6865  fter (or togethe
+0003fcb0: 7220 7769 7468 2920 7468 6520 220a 2020  r with) the ".  
+0003fcc0: 2020 2020 2020 222d 2d6c 6f67 696e 2061        "--login a
+0003fcd0: 6374 696f 6e2e 2056 6572 6966 6963 6174  ction. Verificat
+0003fce0: 696f 6e20 6973 2061 6c77 6179 7320 696e  ion is always in
+0003fcf0: 7465 7261 6374 6976 652c 2069 2e65 2e20  teractive, i.e. 
+0003fd00: 6974 2022 0a20 2020 2020 2020 2022 7265  it ".        "re
+0003fd10: 7175 6972 6564 206b 6579 626f 6172 6420  quired keyboard 
+0003fd20: 696e 7075 742e 2022 0a20 2020 2020 2020  input. ".       
+0003fd30: 2022 5665 7269 6669 6361 7469 6f6e 2071   "Verification q
+0003fd40: 7565 7374 696f 6e73 2022 0a20 2020 2020  uestions ".     
+0003fd50: 2020 2022 7769 6c6c 2062 6520 7072 696e     "will be prin
+0003fd60: 7465 6420 6f6e 2073 7464 6f75 7420 616e  ted on stdout an
+0003fd70: 6420 7468 6520 7573 6572 2068 6173 2074  d the user has t
+0003fd80: 6f20 7265 7370 6f6e 6420 220a 2020 2020  o respond ".    
+0003fd90: 2020 2020 2276 6961 2074 6865 206b 6579      "via the key
+0003fda0: 626f 6172 6420 746f 2061 6363 6570 7420  board to accept 
+0003fdb0: 6f72 2072 656a 6563 7420 7665 7269 6669  or reject verifi
+0003fdc0: 6361 7469 6f6e 2e20 220a 2020 2020 2020  cation. ".      
+0003fdd0: 2020 224f 6e63 6520 7665 7269 6669 6361    "Once verifica
+0003fde0: 7469 6f6e 2069 7320 636f 6d70 6c65 7465  tion is complete
+0003fdf0: 2c20 7468 6520 7072 6f67 7261 6d20 6d61  , the program ma
+0003fe00: 7920 6265 2022 0a20 2020 2020 2020 2022  y be ".        "
+0003fe10: 7275 6e20 6173 2061 2073 6572 7669 6365  run as a service
+0003fe20: 2e20 5665 7269 6669 6361 7469 6f6e 2069  . Verification i
+0003fe30: 7320 6265 7374 2064 6f6e 6520 6173 2066  s best done as f
+0003fe40: 6f6c 6c6f 7773 3a20 220a 2020 2020 2020  ollows: ".      
+0003fe50: 2020 2250 6572 666f 726d 2061 2063 726f    "Perform a cro
+0003fe60: 7373 2d64 6576 6963 6520 7665 7269 6669  ss-device verifi
+0003fe70: 6361 7469 6f6e 2c20 7468 6174 206d 6561  cation, that mea
+0003fe80: 6e73 2c20 7065 7266 6f72 6d20 6120 220a  ns, perform a ".
+0003fe90: 2020 2020 2020 2020 2276 6572 6966 6963          "verific
+0003fea0: 6174 696f 6e20 6265 7477 6565 6e20 7477  ation between tw
+0003feb0: 6f20 6465 7669 6365 7320 6f66 2074 6865  o devices of the
+0003fec0: 202a 7361 6d65 2a20 7573 6572 2e20 466f   *same* user. Fo
+0003fed0: 7220 7468 6174 2c20 220a 2020 2020 2020  r that, ".      
+0003fee0: 2020 226f 7065 6e20 2865 2e67 2e29 2045    "open (e.g.) E
+0003fef0: 6c65 6d65 6e74 2069 6e20 6120 6272 6f77  lement in a brow
+0003ff00: 7365 722c 206d 616b 6520 7375 7265 2045  ser, make sure E
+0003ff10: 6c65 6d65 6e74 2069 7320 7573 696e 6720  lement is using 
+0003ff20: 7468 6520 220a 2020 2020 2020 2020 6622  the ".        f"
+0003ff30: 7361 6d65 2075 7365 7220 6163 636f 756e  same user accoun
+0003ff40: 7420 6173 2074 6865 207b 5052 4f47 5f57  t as the {PROG_W
+0003ff50: 4954 484f 5554 5f45 5854 7d20 7573 6572  ITHOUT_EXT} user
+0003ff60: 2028 7370 6563 6966 6965 6420 7769 7468   (specified with
+0003ff70: 2022 0a20 2020 2020 2020 2022 2d2d 7573   ".        "--us
+0003ff80: 6572 2d6c 6f67 696e 2061 7420 2d2d 6c6f  er-login at --lo
+0003ff90: 6769 6e29 2e20 4e6f 7720 696e 2074 6865  gin). Now in the
+0003ffa0: 2045 6c65 6d65 6e74 2077 6562 7061 6765   Element webpage
+0003ffb0: 2067 6f20 746f 2074 6865 2072 6f6f 6d20   go to the room 
+0003ffc0: 220a 2020 2020 2020 2020 6622 7468 6174  ".        f"that
+0003ffd0: 2069 7320 7468 6520 7b50 524f 475f 5749   is the {PROG_WI
+0003ffe0: 5448 4f55 545f 4558 547d 2064 6566 6175  THOUT_EXT} defau
+0003fff0: 6c74 2072 6f6f 6d20 2873 7065 6369 6669  lt room (specifi
+00040000: 6564 2077 6974 6820 220a 2020 2020 2020  ed with ".      
+00040010: 2020 222d 2d72 6f6f 6d2d 6465 6661 756c    "--room-defaul
+00040020: 7420 6174 202d 2d6c 6f67 696e 292e 204f  t at --login). O
+00040030: 4b2c 2069 6e20 7468 6520 7765 622d 6272  K, in the web-br
+00040040: 6f77 7365 7220 796f 7520 6172 6520 6e6f  owser you are no
+00040050: 7720 7468 6520 220a 2020 2020 2020 2020  w the ".        
+00040060: 6622 7361 6d65 2075 7365 7220 616e 6420  f"same user and 
+00040070: 696e 2074 6865 2073 616d 6520 726f 6f6d  in the same room
+00040080: 2061 7320 7b50 524f 475f 5749 5448 4f55   as {PROG_WITHOU
+00040090: 545f 4558 547d 2e20 220a 2020 2020 2020  T_EXT}. ".      
+000400a0: 2020 224e 6f77 2063 6c69 636b 2074 6865    "Now click the
+000400b0: 2072 6f75 6e64 2027 6927 2027 526f 6f6d   round 'i' 'Room
+000400c0: 2049 6e66 6f27 2069 636f 6e2c 2074 6865   Info' icon, the
+000400d0: 6e20 636c 6963 6b20 2750 656f 706c 6527  n click 'People'
+000400e0: 2c20 220a 2020 2020 2020 2020 6622 636c  , ".        f"cl
+000400f0: 6963 6b20 7468 6520 6170 7072 6f70 7269  ick the appropri
+00040100: 6174 6520 7573 6572 2028 7468 6520 7b50  ate user (the {P
+00040110: 524f 475f 5749 5448 4f55 545f 4558 547d  ROG_WITHOUT_EXT}
+00040120: 2075 7365 7229 2c20 220a 2020 2020 2020   user), ".      
+00040130: 2020 2263 6c69 636b 2072 6564 2027 4e6f    "click red 'No
+00040140: 7420 5472 7573 7465 6427 2074 6578 7420  t Trusted' text 
+00040150: 220a 2020 2020 2020 2020 2277 6869 6368  ".        "which
+00040160: 2069 6e64 6963 6174 6564 2061 6e20 756e   indicated an un
+00040170: 7472 7573 7465 6420 6465 7669 6365 2c20  trusted device, 
+00040180: 7468 656e 2063 6c69 636b 2074 6865 2073  then click the s
+00040190: 7175 6172 6520 220a 2020 2020 2020 2020  quare ".        
+000401a0: 2227 496e 7465 7261 6374 6976 656c 7920  "'Interactively 
+000401b0: 7665 7269 6679 2062 7920 456d 6f6a 6927  verify by Emoji'
+000401c0: 2062 7574 746f 6e20 286f 6e65 206f 6620   button (one of 
+000401d0: 3320 6275 7474 6f6e 2063 686f 6963 6573  3 button choices
+000401e0: 292e 2022 0a20 2020 2020 2020 2066 2241  ). ".        f"A
+000401f0: 7420 7468 6973 2070 6f69 6e74 2062 6f74  t this point bot
+00040200: 6820 7765 622d 7061 6765 2061 6e64 207b  h web-page and {
+00040210: 5052 4f47 5f57 4954 484f 5554 5f45 5854  PROG_WITHOUT_EXT
+00040220: 7d20 696e 2074 6572 6d69 6e61 6c20 220a  } in terminal ".
+00040230: 2020 2020 2020 2020 2273 686f 7720 6120          "show a 
+00040240: 7365 7420 6f66 2065 6d6f 6a69 2069 636f  set of emoji ico
+00040250: 6e73 2061 6e64 206e 616d 6573 2e20 436f  ns and names. Co
+00040260: 6d70 6172 6520 7468 656d 2076 6973 7561  mpare them visua
+00040270: 6c6c 792e 2022 0a20 2020 2020 2020 2022  lly. ".        "
+00040280: 436f 6e66 6972 6d20 6f6e 2062 6f74 6820  Confirm on both 
+00040290: 7369 6465 7320 2859 6573 2c20 5468 6579  sides (Yes, They
+000402a0: 204d 6174 6368 2c20 476f 7420 6974 292c   Match, Got it),
+000402b0: 2066 696e 616c 6c79 2063 6c69 636b 204f   finally click O
+000402c0: 4b2e 2022 0a20 2020 2020 2020 2022 596f  K. ".        "Yo
+000402d0: 7520 7368 6f75 6c64 2073 6565 2061 2067  u should see a g
+000402e0: 7265 656e 2073 6869 656c 6420 616e 6420  reen shield and 
+000402f0: 616c 736f 2073 6565 2074 6861 7420 7468  also see that th
+00040300: 6520 220a 2020 2020 2020 2020 6622 7b50  e ".        f"{P
+00040310: 524f 475f 5749 5448 4f55 545f 4558 547d  ROG_WITHOUT_EXT}
+00040320: 2064 6576 6963 6520 6973 206e 6f77 2067   device is now g
+00040330: 7265 656e 2061 6e64 2076 6572 6966 6965  reen and verifie
+00040340: 6420 696e 2074 6865 2077 6562 7061 6765  d in the webpage
+00040350: 2e20 220a 2020 2020 2020 2020 2249 6e20  . ".        "In 
+00040360: 7468 6520 7465 726d 696e 616c 2079 6f75  the terminal you
+00040370: 2073 686f 756c 6420 7365 6520 6120 7465   should see a te
+00040380: 7874 206d 6573 7361 6765 2069 6e64 6963  xt message indic
+00040390: 6174 696e 6720 7375 6363 6573 732e 2022  ating success. "
+000403a0: 0a20 2020 2020 2020 2022 596f 7520 7368  .        "You sh
+000403b0: 6f75 6c64 206e 6f77 2062 6520 7665 7269  ould now be veri
+000403c0: 6669 6564 2061 6372 6f73 7320 616c 6c20  fied across all 
+000403d0: 6465 7669 6365 7320 616e 6420 6163 726f  devices and acro
+000403e0: 7373 2061 6c6c 2075 7365 7273 2e22 2c0a  ss all users.",.
+000403f0: 2020 2020 290a 2020 2020 6170 2e61 6464      ).    ap.add
+00040400: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
+00040410: 2020 2022 2d2d 6c6f 676f 7574 222c 0a20     "--logout",. 
+00040420: 2020 2020 2020 2072 6571 7569 7265 643d         required=
+00040430: 4661 6c73 652c 0a20 2020 2020 2020 2074  False,.        t
+00040440: 7970 653d 7374 722c 2020 2320 6c6f 676f  ype=str,  # logo
+00040450: 7574 206f 7074 696f 6e73 3a20 6d65 2061  ut options: me a
+00040460: 6e64 2061 6c6c 0a20 2020 2020 2020 206d  nd all.        m
+00040470: 6574 6176 6172 3d22 4d45 7c41 4c4c 222c  etavar="ME|ALL",
+00040480: 0a20 2020 2020 2020 2068 656c 703d 224c  .        help="L
+00040490: 6f67 6f75 742e 2022 0a20 2020 2020 2020  ogout. ".       
+000404a0: 2022 4465 7461 696c 733a 3a20 4c6f 676f   "Details:: Logo
+000404b0: 7574 2074 6869 7320 6f72 2061 6c6c 2064  ut this or all d
+000404c0: 6576 6963 6573 2066 726f 6d20 7468 6520  evices from the 
+000404d0: 4d61 7472 6978 2068 6f6d 6573 6572 7665  Matrix homeserve
+000404e0: 722e 2022 0a20 2020 2020 2020 2022 5468  r. ".        "Th
+000404f0: 6973 2072 6571 7569 7265 7320 6578 6163  is requires exac
+00040500: 746c 7920 6f6e 6520 6172 6775 6d65 6e74  tly one argument
+00040510: 2e20 220a 2020 2020 2020 2020 2254 776f  . ".        "Two
+00040520: 2063 686f 6963 6573 2061 7265 206f 6666   choices are off
+00040530: 6572 6564 3a20 276d 6527 2061 6e64 2027  ered: 'me' and '
+00040540: 616c 6c27 2e20 220a 2020 2020 2020 2020  all'. ".        
+00040550: 2250 726f 7669 6465 206f 6e65 206f 6620  "Provide one of 
+00040560: 7468 6573 6520 6368 6f69 6365 732e 2022  these choices. "
+00040570: 0a20 2020 2020 2020 2066 2249 6620 796f  .        f"If yo
+00040580: 7520 6368 6f6f 7365 2027 6d65 272c 206f  u choose 'me', o
+00040590: 6e6c 7920 7468 6520 6f6e 6520 6465 7669  nly the one devi
+000405a0: 6365 207b 5052 4f47 5f57 4954 484f 5554  ce {PROG_WITHOUT
+000405b0: 5f45 5854 7d20 220a 2020 2020 2020 2020  _EXT} ".        
+000405c0: 2269 7320 6375 7272 656e 746c 7920 7573  "is currently us
+000405d0: 696e 6720 7769 6c6c 2062 6520 6c6f 6767  ing will be logg
+000405e0: 6564 206f 7574 2e20 220a 2020 2020 2020  ed out. ".      
+000405f0: 2020 2249 6620 796f 7520 6368 6f6f 7365    "If you choose
+00040600: 2027 616c 6c27 2c20 616c 6c20 6465 7669   'all', all devi
+00040610: 6365 7320 6f66 2074 6865 2075 7365 7220  ces of the user 
+00040620: 7573 6564 2062 7920 220a 2020 2020 2020  used by ".      
+00040630: 2020 6622 7b50 524f 475f 5749 5448 4f55    f"{PROG_WITHOU
+00040640: 545f 4558 547d 2077 696c 6c20 6265 206c  T_EXT} will be l
+00040650: 6f67 6765 6420 6f75 742e 2022 0a20 2020  ogged out. ".   
+00040660: 2020 2020 2022 5768 696c 6520 2d2d 6c6f       "While --lo
+00040670: 676f 7574 206e 6569 7468 6572 2072 656d  gout neither rem
+00040680: 6f76 6573 2074 6865 2063 7265 6465 6e74  oves the credent
+00040690: 6961 6c73 206e 6f72 2074 6865 2073 746f  ials nor the sto
+000406a0: 7265 2c20 7468 6520 220a 2020 2020 2020  re, the ".      
+000406b0: 2020 226c 6f67 6f75 7420 6163 7469 6f6e    "logout action
+000406c0: 2072 656d 6f76 6573 2074 6865 2064 6576   removes the dev
+000406d0: 6963 6520 616e 6420 6d61 6b65 7320 7468  ice and makes th
+000406e0: 6520 6163 6365 7373 2d74 6f6b 656e 2073  e access-token s
+000406f0: 746f 7265 6420 220a 2020 2020 2020 2020  tored ".        
+00040700: 2269 6e20 7468 6520 6372 6564 656e 7469  "in the credenti
+00040710: 616c 7320 696e 7661 6c69 642e 2048 656e  als invalid. Hen
+00040720: 6365 2c20 6166 7465 7220 6120 2d2d 6c6f  ce, after a --lo
+00040730: 676f 7574 2c20 6f6e 6520 6d75 7374 2022  gout, one must "
+00040740: 0a20 2020 2020 2020 2022 6d61 6e75 616c  .        "manual
+00040750: 6c79 2072 656d 6f76 6520 6372 6564 656e  ly remove creden
+00040760: 7469 616c 7320 616e 6420 7374 6f72 652c  tials and store,
+00040770: 2061 6e64 2074 6865 6e20 7065 7266 6f72   and then perfor
+00040780: 6d20 6120 6e65 7720 220a 2020 2020 2020  m a new ".      
+00040790: 2020 6622 2d2d 6c6f 6769 6e20 746f 2075    f"--login to u
+000407a0: 7365 207b 5052 4f47 5f57 4954 484f 5554  se {PROG_WITHOUT
+000407b0: 5f45 5854 7d20 6167 6169 6e2e 2022 0a20  _EXT} again. ". 
+000407c0: 2020 2020 2020 2022 596f 7520 6361 6e20         "You can 
+000407d0: 7065 7266 6563 746c 7920 7573 6520 220a  perfectly use ".
+000407e0: 2020 2020 2020 2020 6622 7b50 524f 475f          f"{PROG_
+000407f0: 5749 5448 4f55 545f 4558 547d 2077 6974  WITHOUT_EXT} wit
+00040800: 686f 7574 2065 7665 7220 6c6f 6767 696e  hout ever loggin
+00040810: 6720 6f75 742e 202d 2d6c 6f67 6f75 7420  g out. --logout 
+00040820: 6973 2061 2063 6c65 616e 7570 2022 0a20  is a cleanup ". 
+00040830: 2020 2020 2020 2022 6966 2079 6f75 2068         "if you h
+00040840: 6176 6520 6465 6369 6465 6420 6e6f 7420  ave decided not 
+00040850: 746f 2075 7365 2074 6869 7320 286f 7220  to use this (or 
+00040860: 616c 6c29 2064 6576 6963 6528 7329 2065  all) device(s) e
+00040870: 7665 7220 6167 6169 6e2e 222c 0a20 2020  ver again.",.   
+00040880: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
+00040890: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
+000408a0: 222d 6322 2c0a 2020 2020 2020 2020 222d  "-c",.        "-
+000408b0: 2d63 7265 6465 6e74 6961 6c73 222c 0a20  -credentials",. 
+000408c0: 2020 2020 2020 2072 6571 7569 7265 643d         required=
+000408d0: 4661 6c73 652c 0a20 2020 2020 2020 2074  False,.        t
+000408e0: 7970 653d 7374 722c 0a20 2020 2020 2020  ype=str,.       
+000408f0: 2064 6566 6175 6c74 3d43 5245 4445 4e54   default=CREDENT
+00040900: 4941 4c53 5f46 494c 455f 4445 4641 554c  IALS_FILE_DEFAUL
+00040910: 542c 0a20 2020 2020 2020 206d 6574 6176  T,.        metav
+00040920: 6172 3d22 4352 4544 454e 5449 414c 535f  ar="CREDENTIALS_
+00040930: 4649 4c45 222c 0a20 2020 2020 2020 2068  FILE",.        h
+00040940: 656c 703d 2253 7065 6369 6679 206c 6f63  elp="Specify loc
+00040950: 6174 696f 6e20 6f66 2063 7265 6465 6e74  ation of credent
+00040960: 6961 6c73 2066 696c 652e 2022 0a20 2020  ials file. ".   
+00040970: 2020 2020 2022 4465 7461 696c 733a 3a20       "Details:: 
+00040980: 4f6e 2066 6972 7374 2072 756e 2c20 696e  On first run, in
+00040990: 666f 726d 6174 696f 6e20 6162 6f75 7420  formation about 
+000409a0: 686f 6d65 7365 7276 6572 2c20 220a 2020  homeserver, ".  
+000409b0: 2020 2020 2020 2275 7365 722c 2072 6f6f        "user, roo
+000409c0: 6d20 6964 2c20 6574 632e 2077 696c 6c20  m id, etc. will 
+000409d0: 6265 2077 7269 7474 656e 2074 6f20 6120  be written to a 
+000409e0: 6372 6564 656e 7469 616c 7320 220a 2020  credentials ".  
+000409f0: 2020 2020 2020 2266 696c 652e 2042 7920        "file. By 
+00040a00: 6465 6661 756c 742c 2074 6869 7320 6669  default, this fi
+00040a10: 6c65 2022 0a20 2020 2020 2020 2066 2769  le ".        f'i
+00040a20: 7320 227b 4352 4544 454e 5449 414c 535f  s "{CREDENTIALS_
+00040a30: 4649 4c45 5f44 4546 4155 4c54 7d22 2e20  FILE_DEFAULT}". 
+00040a40: 270a 2020 2020 2020 2020 224f 6e20 6675  '.        "On fu
+00040a50: 7274 6865 7220 7275 6e73 2074 6865 2063  rther runs the c
+00040a60: 7265 6465 6e74 6961 6c73 2066 696c 6520  redentials file 
+00040a70: 6973 2072 6561 6420 746f 2022 0a20 2020  is read to ".   
+00040a80: 2020 2020 2022 7065 726d 6974 206c 6f67       "permit log
+00040a90: 6769 6e67 2069 6e74 6f20 7468 6520 636f  ging into the co
+00040aa0: 7272 6563 7420 4d61 7472 6978 2061 6363  rrect Matrix acc
+00040ab0: 6f75 6e74 2022 0a20 2020 2020 2020 2022  ount ".        "
+00040ac0: 616e 6420 7365 6e64 696e 6720 6d65 7373  and sending mess
+00040ad0: 6167 6573 2074 6f20 7468 6520 7072 6563  ages to the prec
+00040ae0: 6f6e 6669 6775 7265 6420 726f 6f6d 2e20  onfigured room. 
+00040af0: 220a 2020 2020 2020 2020 2249 6620 7468  ".        "If th
+00040b00: 6973 206f 7074 696f 6e20 6973 2070 726f  is option is pro
+00040b10: 7669 6465 642c 2074 6865 2070 726f 7669  vided, the provi
+00040b20: 6465 6420 6669 6c65 206e 616d 6520 220a  ded file name ".
+00040b30: 2020 2020 2020 2020 2277 696c 6c20 6265          "will be
+00040b40: 2075 7365 6420 6173 2063 7265 6465 6e74   used as credent
+00040b50: 6961 6c73 2066 696c 6520 696e 7374 6561  ials file instea
+00040b60: 6420 6f66 2074 6865 2022 0a20 2020 2020  d of the ".     
+00040b70: 2020 2022 6465 6661 756c 7420 6f6e 652e     "default one.
+00040b80: 2022 2c0a 2020 2020 290a 2020 2020 6170   ",.    ).    ap
+00040b90: 2e61 6464 5f61 7267 756d 656e 7428 0a20  .add_argument(. 
+00040ba0: 2020 2020 2020 2022 2d73 222c 0a20 2020         "-s",.   
+00040bb0: 2020 2020 2022 2d2d 7374 6f72 6522 2c0a       "--store",.
+00040bc0: 2020 2020 2020 2020 7265 7175 6972 6564          required
+00040bd0: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+00040be0: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
+00040bf0: 2020 6465 6661 756c 743d 5354 4f52 455f    default=STORE_
+00040c00: 4449 525f 4445 4641 554c 542c 0a20 2020  DIR_DEFAULT,.   
+00040c10: 2020 2020 206d 6574 6176 6172 3d22 5354       metavar="ST
+00040c20: 4f52 455f 4449 5245 4354 4f52 5922 2c0a  ORE_DIRECTORY",.
+00040c30: 2020 2020 2020 2020 6865 6c70 3d22 5370          help="Sp
+00040c40: 6563 6966 7920 6c6f 6361 7469 6f6e 206f  ecify location o
+00040c50: 6620 7374 6f72 6520 6469 7265 6374 6f72  f store director
+00040c60: 792e 2022 0a20 2020 2020 2020 2022 4465  y. ".        "De
+00040c70: 7461 696c 733a 3a20 5061 7468 2074 6f20  tails:: Path to 
+00040c80: 6469 7265 6374 6f72 7920 746f 2062 6520  directory to be 
+00040c90: 220a 2020 2020 2020 2020 2775 7365 6420  ".        'used 
+00040ca0: 6173 2022 7374 6f72 6522 2066 6f72 2065  as "store" for e
+00040cb0: 6e63 7279 7074 6564 206d 6573 7361 6769  ncrypted messagi
+00040cc0: 6e67 2e20 270a 2020 2020 2020 2020 2242  ng. '.        "B
+00040cd0: 7920 6465 6661 756c 742c 2074 6869 7320  y default, this 
+00040ce0: 6469 7265 6374 6f72 7920 220a 2020 2020  directory ".    
+00040cf0: 2020 2020 6627 6973 2022 7b53 544f 5245      f'is "{STORE
+00040d00: 5f44 4952 5f44 4546 4155 4c54 7d22 2e20  _DIR_DEFAULT}". 
+00040d10: 270a 2020 2020 2020 2020 2253 696e 6365  '.        "Since
+00040d20: 2065 6e63 7279 7074 696f 6e20 6973 2061   encryption is a
+00040d30: 6c77 6179 7320 656e 6162 6c65 642c 2061  lways enabled, a
+00040d40: 2073 746f 7265 2069 7320 220a 2020 2020   store is ".    
+00040d50: 2020 2020 2261 6c77 6179 7320 6e65 6564      "always need
+00040d60: 6564 2e20 220a 2020 2020 2020 2020 2254  ed. ".        "T
+00040d70: 6865 2070 726f 7669 6465 6420 6469 7265  he provided dire
+00040d80: 6374 6f72 7920 6e61 6d65 2022 0a20 2020  ctory name ".   
+00040d90: 2020 2020 2022 7769 6c6c 2062 6520 7573       "will be us
+00040da0: 6564 2061 7320 7065 7273 6973 7465 6e74  ed as persistent
+00040db0: 2073 746f 7261 6765 2064 6972 6563 746f   storage directo
+00040dc0: 7279 2069 6e73 7465 6164 206f 6620 220a  ry instead of ".
+00040dd0: 2020 2020 2020 2020 2274 6865 2064 6566          "the def
+00040de0: 6175 6c74 206f 6e65 2e20 5072 6566 6572  ault one. Prefer
+00040df0: 6162 6c79 2c20 666f 7220 6d75 6c74 6970  ably, for multip
+00040e00: 6c65 2065 7865 6375 7469 6f6e 7320 220a  le executions ".
+00040e10: 2020 2020 2020 2020 226f 6620 7468 6973          "of this
+00040e20: 2070 726f 6772 616d 2075 7365 2074 6865   program use the
+00040e30: 2073 616d 6520 7374 6f72 6520 666f 7220   same store for 
+00040e40: 7468 6520 7361 6d65 2064 6576 6963 652e  the same device.
+00040e50: 2022 0a20 2020 2020 2020 2022 5468 6520   ".        "The 
+00040e60: 7374 6f72 6520 6469 7265 6374 6f72 7920  store directory 
+00040e70: 6361 6e20 6265 2073 6861 7265 6420 6265  can be shared be
+00040e80: 7477 6565 6e20 6d75 6c74 6970 6c65 2022  tween multiple "
+00040e90: 0a20 2020 2020 2020 2022 6469 6666 6572  .        "differ
+00040ea0: 656e 7420 6465 7669 6365 7320 616e 6420  ent devices and 
+00040eb0: 7573 6572 732e 222c 0a20 2020 2029 0a20  users.",.    ). 
+00040ec0: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
+00040ed0: 6e74 280a 2020 2020 2020 2020 222d 7222  nt(.        "-r"
+00040ee0: 2c0a 2020 2020 2020 2020 222d 2d72 6f6f  ,.        "--roo
+00040ef0: 6d22 2c0a 2020 2020 2020 2020 7265 7175  m",.        requ
+00040f00: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
+00040f10: 2020 2020 6163 7469 6f6e 3d22 6578 7465      action="exte
+00040f20: 6e64 222c 0a20 2020 2020 2020 206e 6172  nd",.        nar
+00040f30: 6773 3d22 2b22 2c0a 2020 2020 2020 2020  gs="+",.        
+00040f40: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
+00040f50: 2020 6d65 7461 7661 723d 2252 4f4f 4d22    metavar="ROOM"
+00040f60: 2c0a 2020 2020 2020 2020 6865 6c70 3d22  ,.        help="
+00040f70: 5370 6563 6966 7920 6f6e 6520 6f72 206d  Specify one or m
+00040f80: 756c 7469 706c 6520 726f 6f6d 732e 2022  ultiple rooms. "
+00040f90: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
+00040fa0: 733a 3a20 4f70 7469 6f6e 616c 6c79 2073  s:: Optionally s
+00040fb0: 7065 6369 6679 206f 6e65 206f 7220 6d75  pecify one or mu
+00040fc0: 6c74 6970 6c65 2072 6f6f 6d73 2076 6961  ltiple rooms via
+00040fd0: 2072 6f6f 6d20 6964 7320 6f72 2022 0a20   room ids or ". 
+00040fe0: 2020 2020 2020 2022 726f 6f6d 2061 6c69         "room ali
+00040ff0: 6173 6573 2e20 2d2d 726f 6f6d 2069 7320  ases. --room is 
+00041000: 7573 6564 2062 7920 7661 7269 6f75 7320  used by various 
+00041010: 7365 6e64 2061 6374 696f 6e73 2061 6e64  send actions and
+00041020: 2022 0a20 2020 2020 2020 2022 7661 7269   ".        "vari
+00041030: 6f75 7320 6c69 7374 656e 2061 6374 696f  ous listen actio
+00041040: 6e73 2e20 220a 2020 2020 2020 2020 2254  ns. ".        "T
+00041050: 6865 2064 6566 6175 6c74 2072 6f6f 6d20  he default room 
+00041060: 6973 2070 726f 7669 6465 6420 220a 2020  is provided ".  
+00041070: 2020 2020 2020 2269 6e20 7468 6520 6372        "in the cr
+00041080: 6564 656e 7469 616c 7320 6669 6c65 2028  edentials file (
+00041090: 7370 6563 6966 6965 6420 6174 202d 2d6c  specified at --l
+000410a0: 6f67 696e 2077 6974 6820 2d2d 726f 6f6d  ogin with --room
+000410b0: 2d64 6566 6175 6c74 292e 2022 0a20 2020  -default). ".   
+000410c0: 2020 2020 2022 4966 2061 2072 6f6f 6d20       "If a room 
+000410d0: 286f 7220 6d75 6c74 6970 6c65 206f 6e65  (or multiple one
+000410e0: 7329 2022 0a20 2020 2020 2020 2022 6973  s) ".        "is
+000410f0: 2028 6f72 2061 7265 2920 7072 6f76 6964   (or are) provid
+00041100: 6564 2069 6e20 7468 6520 2d2d 726f 6f6d  ed in the --room
+00041110: 2061 7267 756d 656e 7473 2c20 7468 656e   arguments, then
+00041120: 2069 7420 220a 2020 2020 2020 2020 2228   it ".        "(
+00041130: 6f72 2074 6865 7929 2077 696c 6c20 6265  or they) will be
+00041140: 2075 7365 6420 220a 2020 2020 2020 2020   used ".        
+00041150: 2269 6e73 7465 6164 206f 6620 7468 6520  "instead of the 
+00041160: 6f6e 6520 6672 6f6d 2074 6865 2063 7265  one from the cre
+00041170: 6465 6e74 6961 6c73 2066 696c 652e 2022  dentials file. "
+00041180: 0a20 2020 2020 2020 2022 5468 6520 7573  .        "The us
+00041190: 6572 206d 7573 7420 6861 7665 2061 6363  er must have acc
+000411a0: 6573 7320 746f 2074 6865 2073 7065 6369  ess to the speci
+000411b0: 6669 6564 2072 6f6f 6d20 220a 2020 2020  fied room ".    
+000411c0: 2020 2020 2269 6e20 6f72 6465 7220 746f      "in order to
+000411d0: 2073 656e 6420 6d65 7373 6167 6573 2074   send messages t
+000411e0: 6865 7265 206f 7220 6c69 7374 656e 206f  here or listen o
+000411f0: 6e20 7468 6520 726f 6f6d 2e20 220a 2020  n the room. ".  
+00041200: 2020 2020 2020 224d 6573 7361 6765 7320        "Messages 
+00041210: 6361 6e6e 6f74 2022 0a20 2020 2020 2020  cannot ".       
+00041220: 2022 6265 2073 656e 7420 746f 2061 7262   "be sent to arb
+00041230: 6974 7261 7279 2072 6f6f 6d73 2e20 5768  itrary rooms. Wh
+00041240: 656e 2073 7065 6369 6679 696e 6720 7468  en specifying th
+00041250: 6520 220a 2020 2020 2020 2020 2272 6f6f  e ".        "roo
+00041260: 6d20 6964 2073 6f6d 6520 7368 656c 6c73  m id some shells
+00041270: 2072 6571 7569 7265 2074 6865 2065 7863   require the exc
+00041280: 6c61 6d61 7469 6f6e 206d 6172 6b20 220a  lamation mark ".
+00041290: 2020 2020 2020 2020 2274 6f20 6265 2065          "to be e
+000412a0: 7363 6170 6564 2077 6974 6820 6120 6261  scaped with a ba
+000412b0: 636b 736c 6173 682e 2022 0a20 2020 2020  ckslash. ".     
+000412c0: 2020 2022 4173 2061 6e20 616c 7465 726e     "As an altern
+000412d0: 6174 6976 6520 746f 2073 7065 6369 6679  ative to specify
+000412e0: 696e 6720 6120 726f 6f6d 2061 7320 6465  ing a room as de
+000412f0: 7374 696e 6174 696f 6e2c 2022 0a20 2020  stination, ".   
+00041300: 2020 2020 2022 6f6e 6520 6361 6e20 7370       "one can sp
+00041310: 6563 6966 7920 6120 7573 6572 2061 7320  ecify a user as 
+00041320: 6120 6465 7374 696e 6174 696f 6e20 7769  a destination wi
+00041330: 7468 2074 6865 2027 2d2d 7573 6572 2720  th the '--user' 
+00041340: 220a 2020 2020 2020 2020 2261 7267 756d  ".        "argum
+00041350: 656e 742e 2053 6565 2027 2d2d 7573 6572  ent. See '--user
+00041360: 2720 616e 6420 7468 6520 7465 726d 2027  ' and the term '
+00041370: 444d 2028 6469 7265 6374 206d 6573 7361  DM (direct messa
+00041380: 6769 6e67 2927 2022 0a20 2020 2020 2020  ging)' ".       
+00041390: 2022 666f 7220 6465 7461 696c 732e 2053   "for details. S
+000413a0: 7065 6369 6679 696e 6720 6120 726f 6f6d  pecifying a room
+000413b0: 2069 7320 616c 7761 7973 2066 6173 7465   is always faste
+000413c0: 7220 616e 6420 6d6f 7265 2022 0a20 2020  r and more ".   
+000413d0: 2020 2020 2022 6566 6669 6369 656e 7420       "efficient 
+000413e0: 7468 616e 2073 7065 6369 6679 696e 6720  than specifying 
+000413f0: 6120 7573 6572 2e20 4e6f 7420 616c 6c20  a user. Not all 
+00041400: 6c69 7374 656e 206f 7065 7261 7469 6f6e  listen operation
+00041410: 7320 220a 2020 2020 2020 2020 2261 6c6c  s ".        "all
+00041420: 6f77 2073 6574 7469 6e67 2061 2072 6f6f  ow setting a roo
+00041430: 6d2e 2052 6561 6420 6d6f 7265 2075 6e64  m. Read more und
+00041440: 6572 2074 6865 202d 2d6c 6973 7465 6e20  er the --listen 
+00041450: 6f70 7469 6f6e 7320 220a 2020 2020 2020  options ".      
+00041460: 2020 2261 6e64 2073 696d 696c 6172 2e20    "and similar. 
+00041470: 4d6f 7374 2061 6374 696f 6e73 2061 6c73  Most actions als
+00041480: 6f20 7375 7070 6f72 7420 726f 6f6d 2061  o support room a
+00041490: 6c69 6173 6573 2069 6e73 7465 6164 206f  liases instead o
+000414a0: 6620 220a 2020 2020 2020 2020 2272 6f6f  f ".        "roo
+000414b0: 6d20 6964 732e 2053 6f6d 6520 6576 656e  m ids. Some even
+000414c0: 2073 686f 7274 2072 6f6f 6d20 616c 6961   short room alia
+000414d0: 7365 732e 222c 0a20 2020 2029 0a20 2020  ses.",.    ).   
+000414e0: 2061 702e 6164 645f 6172 6775 6d65 6e74   ap.add_argument
+000414f0: 280a 2020 2020 2020 2020 222d 2d72 6f6f  (.        "--roo
+00041500: 6d2d 6465 6661 756c 7422 2c0a 2020 2020  m-default",.    
+00041510: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
+00041520: 7365 2c0a 2020 2020 2020 2020 7479 7065  se,.        type
+00041530: 3d73 7472 2c0a 2020 2020 2020 2020 6d65  =str,.        me
+00041540: 7461 7661 723d 2244 4546 4155 4c54 5f52  tavar="DEFAULT_R
+00041550: 4f4f 4d22 2c0a 2020 2020 2020 2020 6865  OOM",.        he
+00041560: 6c70 3d22 5370 6563 6966 7920 7468 6520  lp="Specify the 
+00041570: 6465 6661 756c 7420 726f 6f6d 2061 7420  default room at 
+00041580: 2d2d 6c6f 6769 6e2e 2022 0a20 2020 2020  --login. ".     
+00041590: 2020 2022 4465 7461 696c 733a 3a20 4f70     "Details:: Op
+000415a0: 7469 6f6e 616c 6c79 2073 7065 6369 6679  tionally specify
+000415b0: 2061 2072 6f6f 6d20 6173 2074 6865 2022   a room as the "
+000415c0: 0a20 2020 2020 2020 2022 6465 6661 756c  .        "defaul
+000415d0: 7420 726f 6f6d 2066 6f72 2066 7574 7572  t room for futur
+000415e0: 6520 6163 7469 6f6e 732e 2049 6620 6e6f  e actions. If no
+000415f0: 7420 7370 6563 6966 6965 6420 666f 7220  t specified for 
+00041600: 2d2d 6c6f 6769 6e2c 2069 7420 220a 2020  --login, it ".  
+00041610: 2020 2020 2020 2277 696c 6c20 6265 2071        "will be q
+00041620: 7565 7269 6564 2076 6961 2074 6865 206b  ueried via the k
+00041630: 6579 626f 6172 642e 202d 2d6c 6f67 696e  eyboard. --login
+00041640: 2073 746f 7265 7320 7468 6520 7370 6563   stores the spec
+00041650: 6966 6965 6420 726f 6f6d 2022 0a20 2020  ified room ".   
+00041660: 2020 2020 2022 6173 2064 6566 6175 6c74       "as default
+00041670: 2072 6f6f 6d20 696e 2079 6f75 7220 6372   room in your cr
+00041680: 6564 656e 7469 616c 7320 6669 6c65 2e20  edentials file. 
+00041690: 5468 6973 206f 7074 696f 6e20 6973 206f  This option is o
+000416a0: 6e6c 7920 7573 6564 2022 0a20 2020 2020  nly used ".     
+000416b0: 2020 2022 696e 2063 6f6d 6269 6e61 7469     "in combinati
+000416c0: 6f6e 2077 6974 6820 2d2d 6c6f 6769 6e2e  on with --login.
+000416d0: 2041 2064 6566 6175 6c74 2072 6f6f 6d20   A default room 
+000416e0: 6973 206e 6565 6465 642e 2053 7065 6369  is needed. Speci
+000416f0: 6679 2061 2022 0a20 2020 2020 2020 2022  fy a ".        "
+00041700: 7661 6c69 6420 726f 6f6d 2065 6974 6865  valid room eithe
+00041710: 7220 7769 7468 202d 2d72 6f6f 6d2d 6465  r with --room-de
+00041720: 6661 756c 7420 6f72 2070 726f 7669 6465  fault or provide
+00041730: 2069 7420 7669 6120 6b65 7962 6f61 7264   it via keyboard
+00041740: 2e22 2c0a 2020 2020 290a 2020 2020 6170  .",.    ).    ap
+00041750: 2e61 6464 5f61 7267 756d 656e 7428 0a20  .add_argument(. 
+00041760: 2020 2020 2020 2022 2d2d 726f 6f6d 2d63         "--room-c
+00041770: 7265 6174 6522 2c0a 2020 2020 2020 2020  reate",.        
+00041780: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
+00041790: 2020 2020 2020 2020 6163 7469 6f6e 3d22          action="
+000417a0: 6578 7465 6e64 222c 0a20 2020 2020 2020  extend",.       
+000417b0: 206e 6172 6773 3d22 2b22 2c0a 2020 2020   nargs="+",.    
+000417c0: 2020 2020 7479 7065 3d73 7472 2c0a 2020      type=str,.  
+000417d0: 2020 2020 2020 6d65 7461 7661 723d 2252        metavar="R
+000417e0: 4f4f 4d5f 414c 4941 5322 2c0a 2020 2020  OOM_ALIAS",.    
+000417f0: 2020 2020 6865 6c70 3d22 4372 6561 7465      help="Create
+00041800: 206f 6e65 206f 7220 6d75 6c74 6970 6c65   one or multiple
+00041810: 2072 6f6f 6d73 2066 6f72 2067 6976 656e   rooms for given
+00041820: 2061 6c69 6173 2865 7329 2e20 220a 2020   alias(es). ".  
+00041830: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
+00041840: 204f 6e65 206f 7220 6d75 6c74 6970 6c65   One or multiple
+00041850: 2022 0a20 2020 2020 2020 2022 726f 6f6d   ".        "room
+00041860: 2061 6c69 6173 6573 2063 616e 2062 6520   aliases can be 
+00041870: 7370 6563 6966 6965 642e 2022 0a20 2020  specified. ".   
+00041880: 2020 2020 2022 466f 7220 6561 6368 2061       "For each a
+00041890: 6c69 6173 2073 7065 6369 6669 6564 2061  lias specified a
+000418a0: 2072 6f6f 6d20 7769 6c6c 2062 6520 6372   room will be cr
+000418b0: 6561 7465 642e 2022 0a20 2020 2020 2020  eated. ".       
+000418c0: 2022 466f 7220 6561 6368 2063 7265 6174   "For each creat
+000418d0: 6564 2072 6f6f 6d20 6f6e 6520 6c69 6e65  ed room one line
+000418e0: 2077 6974 6820 726f 6f6d 2069 6420 616e   with room id an
+000418f0: 6420 616c 6961 7320 220a 2020 2020 2020  d alias ".      
+00041900: 2020 2277 696c 6c20 6265 2070 7269 6e74    "will be print
+00041910: 6564 2074 6f20 7374 646f 7574 2e20 220a  ed to stdout. ".
+00041920: 2020 2020 2020 2020 2249 6620 796f 7520          "If you 
+00041930: 6172 6520 6e6f 7420 696e 7465 7265 7374  are not interest
+00041940: 6564 2069 6e20 616e 2022 0a20 2020 2020  ed in an ".     
+00041950: 2020 2027 616c 6961 732c 2070 726f 7669     'alias, provi
+00041960: 6465 2061 6e20 656d 7074 7920 7374 7269  de an empty stri
+00041970: 6e67 206c 696b 6520 2222 2e20 270a 2020  ng like "". '.  
+00041980: 2020 2020 2020 2254 6865 2061 6c69 6173        "The alias
+00041990: 2070 726f 7669 6465 6420 6d75 7374 2062   provided must b
+000419a0: 6520 696e 2063 616e 6f6e 6963 616c 206c  e in canonical l
+000419b0: 6f63 616c 2066 6f72 6d2c 2069 2e65 2e20  ocal form, i.e. 
+000419c0: 220a 2020 2020 2020 2020 2269 6620 796f  ".        "if yo
+000419d0: 7520 7761 6e74 2061 2066 696e 616c 2066  u want a final f
+000419e0: 756c 6c20 616c 6961 7320 6c69 6b65 2022  ull alias like "
+000419f0: 0a20 2020 2020 2020 2027 2223 536f 6d65  .        '"#Some
+00041a00: 526f 6f6d 416c 6961 733a 6d61 7472 6978  RoomAlias:matrix
+00041a10: 2e65 7861 6d70 6c65 2e63 6f6d 2220 270a  .example.com" '.
+00041a20: 2020 2020 2020 2020 2279 6f75 206d 7573          "you mus
+00041a30: 7420 7072 6f76 6964 6520 7468 6520 7374  t provide the st
+00041a40: 7269 6e67 2027 536f 6d65 526f 6f6d 416c  ring 'SomeRoomAl
+00041a50: 6961 7327 2e20 220a 2020 2020 2020 2020  ias'. ".        
+00041a60: 2254 6865 2075 7365 7220 6d75 7374 2062  "The user must b
+00041a70: 6520 7065 726d 6974 7465 6420 746f 2063  e permitted to c
+00041a80: 7265 6174 6520 726f 6f6d 732e 2022 0a20  reate rooms. ". 
+00041a90: 2020 2020 2020 2022 436f 6d62 696e 6520         "Combine 
+00041aa0: 2d2d 726f 6f6d 2d63 7265 6174 6520 7769  --room-create wi
+00041ab0: 7468 202d 2d6e 616d 6520 616e 6420 2d2d  th --name and --
+00041ac0: 746f 7069 6320 746f 2061 6464 2022 0a20  topic to add ". 
+00041ad0: 2020 2020 2020 2022 6e61 6d65 7320 616e         "names an
+00041ae0: 6420 746f 7069 6373 2074 6f20 7468 6520  d topics to the 
+00041af0: 726f 6f6d 2873 2920 746f 2062 6520 6372  room(s) to be cr
+00041b00: 6561 7465 642e 2022 0a20 2020 2020 2020  eated. ".       
+00041b10: 2022 526f 6f6d 7320 6172 6520 6279 2064   "Rooms are by d
+00041b20: 6566 6175 6c74 2063 7265 6174 6564 2065  efault created e
+00041b30: 6e63 7279 7074 6564 3b20 220a 2020 2020  ncrypted; ".    
+00041b40: 2020 2020 2274 6f20 6f76 6572 7772 6974      "to overwrit
+00041b50: 6520 7468 6174 2061 6e64 2074 6f20 6372  e that and to cr
+00041b60: 6561 7465 2061 2072 6f6f 6d20 7769 7468  eate a room with
+00041b70: 2065 6e63 7279 7074 696f 6e20 6469 7361   encryption disa
+00041b80: 626c 6564 2022 0a20 2020 2020 2020 2022  bled ".        "
+00041b90: 7573 6520 272d 2d70 6c61 696e 272e 2022  use '--plain'. "
+00041ba0: 0a20 2020 2020 2020 2022 526f 6f6d 2069  .        "Room i
+00041bb0: 642c 2072 6f6f 6d20 616c 6961 732c 2065  d, room alias, e
+00041bc0: 6e63 7279 7074 696f 6e20 616e 6420 6f74  ncryption and ot
+00041bd0: 6865 7220 6669 656c 6473 2022 0a20 2020  her fields ".   
+00041be0: 2020 2020 2022 6172 6520 7072 696e 7465       "are printe
+00041bf0: 6420 6173 206f 7574 7075 742c 206f 6e65  d as output, one
+00041c00: 206c 696e 6520 7065 7220 6372 6561 7465   line per create
+00041c10: 6420 726f 6f6d 2e22 2c0a 2020 2020 290a  d room.",.    ).
+00041c20: 2020 2020 6170 2e61 6464 5f61 7267 756d      ap.add_argum
+00041c30: 656e 7428 0a20 2020 2020 2020 2022 2d2d  ent(.        "--
+00041c40: 726f 6f6d 2d64 6d2d 6372 6561 7465 222c  room-dm-create",
+00041c50: 0a20 2020 2020 2020 2072 6571 7569 7265  .        require
+00041c60: 643d 4661 6c73 652c 0a20 2020 2020 2020  d=False,.       
+00041c70: 2061 6374 696f 6e3d 2265 7874 656e 6422   action="extend"
+00041c80: 2c0a 2020 2020 2020 2020 6e61 7267 733d  ,.        nargs=
+00041c90: 222b 222c 0a20 2020 2020 2020 2074 7970  "+",.        typ
+00041ca0: 653d 7374 722c 0a20 2020 2020 2020 206d  e=str,.        m
+00041cb0: 6574 6176 6172 3d22 5553 4552 222c 0a20  etavar="USER",. 
+00041cc0: 2020 2020 2020 2068 656c 703d 2243 7265         help="Cre
+00041cd0: 6174 6520 6f6e 6520 6f72 206d 756c 7469  ate one or multi
+00041ce0: 706c 6520 444d 2072 6f6f 6d73 2077 6974  ple DM rooms wit
+00041cf0: 6820 7468 6520 7370 6563 6966 6965 6420  h the specified 
+00041d00: 7573 6572 732e 2022 0a20 2020 2020 2020  users. ".       
+00041d10: 2022 4465 7461 696c 733a 3a20 466f 7220   "Details:: For 
+00041d20: 6561 6368 2075 7365 7220 7370 6563 6966  each user specif
+00041d30: 6965 6420 6120 444d 2072 6f6f 6d20 7769  ied a DM room wi
+00041d40: 6c6c 2062 6520 6372 6561 7465 6420 616e  ll be created an
+00041d50: 6420 7468 6520 220a 2020 2020 2020 2020  d the ".        
+00041d60: 2275 7365 7220 696e 7669 7465 6420 746f  "user invited to
+00041d70: 2069 742e 2046 6f72 2065 6163 6820 6372   it. For each cr
+00041d80: 6561 7465 6420 726f 6f6d 206f 6e65 206c  eated room one l
+00041d90: 696e 6520 7769 7468 2022 0a20 2020 2020  ine with ".     
+00041da0: 2020 2022 726f 6f6d 2069 6420 616e 6420     "room id and 
+00041db0: 616c 6961 7320 7769 6c6c 2062 6520 7072  alias will be pr
+00041dc0: 696e 7465 6420 746f 2073 7464 6f75 742e  inted to stdout.
+00041dd0: 2054 6865 2075 7365 7220 220a 2020 2020   The user ".    
+00041de0: 2020 2020 226d 7573 7420 6265 2070 6572      "must be per
+00041df0: 6d69 7474 6564 2074 6f20 6372 6561 7465  mitted to create
+00041e00: 2072 6f6f 6d73 2e20 436f 6d62 696e 6520   rooms. Combine 
+00041e10: 2d2d 726f 6f6d 2d64 6d2d 6372 6561 7465  --room-dm-create
+00041e20: 2022 0a20 2020 2020 2020 2022 7769 7468   ".        "with
+00041e30: 202d 2d6e 616d 652c 202d 2d74 6f70 6963   --name, --topic
+00041e40: 2c20 2d2d 616c 6961 7320 746f 2061 6464  , --alias to add
+00041e50: 206e 616d 6573 2c20 746f 7069 6373 2061   names, topics a
+00041e60: 6e64 2022 0a20 2020 2020 2020 2022 616c  nd ".        "al
+00041e70: 6961 7365 7320 746f 2074 6865 2072 6f6f  iases to the roo
+00041e80: 6d28 7329 2074 6f20 6265 2063 7265 6174  m(s) to be creat
+00041e90: 6564 2e20 220a 2020 2020 2020 2020 2244  ed. ".        "D
+00041ea0: 4d20 726f 6f6d 7320 6172 6520 6279 2064  M rooms are by d
+00041eb0: 6566 6175 6c74 2063 7265 6174 6564 2065  efault created e
+00041ec0: 6e63 7279 7074 6564 3b20 220a 2020 2020  ncrypted; ".    
+00041ed0: 2020 2020 2274 6f20 6f76 6572 7772 6974      "to overwrit
+00041ee0: 6520 7468 6174 2061 6e64 2074 6f20 6372  e that and to cr
+00041ef0: 6561 7465 2061 2072 6f6f 6d20 7769 7468  eate a room with
+00041f00: 2065 6e63 7279 7074 696f 6e20 6469 7361   encryption disa
+00041f10: 626c 6564 2022 0a20 2020 2020 2020 2022  bled ".        "
+00041f20: 7573 6520 272d 2d70 6c61 696e 272e 2022  use '--plain'. "
+00041f30: 0a20 2020 2020 2020 2022 526f 6f6d 2069  .        "Room i
+00041f40: 642c 2072 6f6f 6d20 616c 6961 732c 2065  d, room alias, e
+00041f50: 6e63 7279 7074 696f 6e20 616e 6420 6f74  ncryption and ot
+00041f60: 6865 7220 6669 656c 6473 2022 0a20 2020  her fields ".   
+00041f70: 2020 2020 2022 6172 6520 7072 696e 7465       "are printe
+00041f80: 6420 6173 206f 7574 7075 742c 206f 6e65  d as output, one
+00041f90: 206c 696e 6520 7065 7220 6372 6561 7465   line per create
+00041fa0: 6420 726f 6f6d 2e22 2c0a 2020 2020 290a  d room.",.    ).
+00041fb0: 2020 2020 6170 2e61 6464 5f61 7267 756d      ap.add_argum
+00041fc0: 656e 7428 0a20 2020 2020 2020 2022 2d2d  ent(.        "--
+00041fd0: 726f 6f6d 2d6a 6f69 6e22 2c0a 2020 2020  room-join",.    
+00041fe0: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
+00041ff0: 7365 2c0a 2020 2020 2020 2020 6163 7469  se,.        acti
+00042000: 6f6e 3d22 6578 7465 6e64 222c 0a20 2020  on="extend",.   
+00042010: 2020 2020 206e 6172 6773 3d22 2b22 2c0a       nargs="+",.
+00042020: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
+00042030: 2c0a 2020 2020 2020 2020 6d65 7461 7661  ,.        metava
+00042040: 723d 2252 4f4f 4d22 2c0a 2020 2020 2020  r="ROOM",.      
+00042050: 2020 6865 6c70 3d22 4a6f 696e 206f 6e65    help="Join one
+00042060: 2072 6f6f 6d20 6f72 206d 756c 7469 706c   room or multipl
+00042070: 6520 726f 6f6d 732e 2022 0a20 2020 2020  e rooms. ".     
+00042080: 2020 2022 4465 7461 696c 733a 3a20 4f6e     "Details:: On
+00042090: 6520 6f72 206d 756c 7469 706c 6520 220a  e or multiple ".
+000420a0: 2020 2020 2020 2020 2272 6f6f 6d20 616c          "room al
+000420b0: 6961 7365 7320 6361 6e20 6265 2073 7065  iases can be spe
+000420c0: 6369 6669 6564 2e20 5468 6520 726f 6f6d  cified. The room
+000420d0: 2028 6f72 206d 756c 7469 706c 6520 220a   (or multiple ".
+000420e0: 2020 2020 2020 2020 226f 6e65 7329 2070          "ones) p
+000420f0: 726f 7669 6465 6420 696e 2074 6865 2061  rovided in the a
+00042100: 7267 756d 656e 7473 2077 696c 6c20 6265  rguments will be
+00042110: 206a 6f69 6e65 642e 2022 0a20 2020 2020   joined. ".     
+00042120: 2020 2022 5468 6520 7573 6572 206d 7573     "The user mus
+00042130: 7420 6861 7665 2070 6572 6d69 7373 696f  t have permissio
+00042140: 6e73 2074 6f20 6a6f 696e 2074 6865 7365  ns to join these
+00042150: 2072 6f6f 6d73 2e22 2c0a 2020 2020 290a   rooms.",.    ).
+00042160: 2020 2020 6170 2e61 6464 5f61 7267 756d      ap.add_argum
+00042170: 656e 7428 0a20 2020 2020 2020 2022 2d2d  ent(.        "--
+00042180: 726f 6f6d 2d6c 6561 7665 222c 0a20 2020  room-leave",.   
+00042190: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
+000421a0: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
+000421b0: 696f 6e3d 2265 7874 656e 6422 2c0a 2020  ion="extend",.  
+000421c0: 2020 2020 2020 6e61 7267 733d 222b 222c        nargs="+",
+000421d0: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
+000421e0: 722c 0a20 2020 2020 2020 206d 6574 6176  r,.        metav
+000421f0: 6172 3d22 524f 4f4d 222c 0a20 2020 2020  ar="ROOM",.     
+00042200: 2020 2068 656c 703d 224c 6561 7665 206f     help="Leave o
+00042210: 6e65 2072 6f6f 6d20 6f72 206d 756c 7469  ne room or multi
+00042220: 706c 6520 726f 6f6d 732e 2022 0a20 2020  ple rooms. ".   
+00042230: 2020 2020 2022 4465 7461 696c 733a 3a20       "Details:: 
+00042240: 4f6e 6520 6f72 206d 756c 7469 706c 6520  One or multiple 
+00042250: 220a 2020 2020 2020 2020 2272 6f6f 6d20  ".        "room 
+00042260: 616c 6961 7365 7320 6361 6e20 6265 2073  aliases can be s
+00042270: 7065 6369 6669 6564 2e20 5468 6520 726f  pecified. The ro
+00042280: 6f6d 2028 6f72 206d 756c 7469 706c 6520  om (or multiple 
+00042290: 220a 2020 2020 2020 2020 226f 6e65 7329  ".        "ones)
+000422a0: 2070 726f 7669 6465 6420 696e 2074 6865   provided in the
+000422b0: 2061 7267 756d 656e 7473 2077 696c 6c20   arguments will 
+000422c0: 6265 206c 6566 742e 2022 2c0a 2020 2020  be left. ",.    
+000422d0: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
+000422e0: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
+000422f0: 2d2d 726f 6f6d 2d66 6f72 6765 7422 2c0a  --room-forget",.
+00042300: 2020 2020 2020 2020 7265 7175 6972 6564          required
+00042310: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+00042320: 6163 7469 6f6e 3d22 6578 7465 6e64 222c  action="extend",
+00042330: 0a20 2020 2020 2020 206e 6172 6773 3d22  .        nargs="
+00042340: 2b22 2c0a 2020 2020 2020 2020 7479 7065  +",.        type
+00042350: 3d73 7472 2c0a 2020 2020 2020 2020 6d65  =str,.        me
+00042360: 7461 7661 723d 2252 4f4f 4d22 2c0a 2020  tavar="ROOM",.  
+00042370: 2020 2020 2020 6865 6c70 3d22 466f 7267        help="Forg
+00042380: 6574 206f 6e65 2072 6f6f 6d20 6f72 206d  et one room or m
+00042390: 756c 7469 706c 6520 726f 6f6d 732e 2022  ultiple rooms. "
+000423a0: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
+000423b0: 733a 3a20 4166 7465 7220 6c65 6176 696e  s:: After leavin
+000423c0: 6720 6120 726f 6f6d 2079 6f75 2073 686f  g a room you sho
+000423d0: 756c 6420 286d 6f73 7420 6c69 6b65 6c79  uld (most likely
+000423e0: 2920 666f 7267 6574 2074 6865 2022 0a20  ) forget the ". 
+000423f0: 2020 2020 2020 2022 726f 6f6d 2e20 466f         "room. Fo
+00042400: 7267 6574 7469 6e67 2061 2072 6f6f 6d20  rgetting a room 
+00042410: 7265 6d6f 7665 7320 7468 6520 7573 6572  removes the user
+00042420: 7327 2072 6f6f 6d20 6869 7374 6f72 792e  s' room history.
+00042430: 2022 0a20 2020 2020 2020 2022 4f6e 6520   ".        "One 
+00042440: 6f72 206d 756c 7469 706c 6520 220a 2020  or multiple ".  
+00042450: 2020 2020 2020 2272 6f6f 6d20 616c 6961        "room alia
+00042460: 7365 7320 6361 6e20 6265 2073 7065 6369  ses can be speci
+00042470: 6669 6564 2e20 5468 6520 726f 6f6d 2028  fied. The room (
+00042480: 6f72 206d 756c 7469 706c 6520 220a 2020  or multiple ".  
+00042490: 2020 2020 2020 226f 6e65 7329 2070 726f        "ones) pro
+000424a0: 7669 6465 6420 696e 2074 6865 2061 7267  vided in the arg
+000424b0: 756d 656e 7473 2077 696c 6c20 6265 2066  uments will be f
+000424c0: 6f72 676f 7474 656e 2e20 220a 2020 2020  orgotten. ".    
+000424d0: 2020 2020 2249 6620 616c 6c20 7573 6572      "If all user
+000424e0: 7320 666f 7267 6574 2061 2072 6f6f 6d2c  s forget a room,
+000424f0: 2074 6865 2072 6f6f 6d20 6361 6e20 6576   the room can ev
+00042500: 656e 7475 616c 6c79 2062 6520 220a 2020  entually be ".  
+00042510: 2020 2020 2020 2264 656c 6574 6564 206f        "deleted o
+00042520: 6e20 7468 6520 7365 7276 6572 2e22 2c0a  n the server.",.
+00042530: 2020 2020 290a 2020 2020 6170 2e61 6464      ).    ap.add
+00042540: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
+00042550: 2020 2022 2d2d 726f 6f6d 2d69 6e76 6974     "--room-invit
+00042560: 6522 2c0a 2020 2020 2020 2020 7265 7175  e",.        requ
+00042570: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
+00042580: 2020 2020 6163 7469 6f6e 3d22 6578 7465      action="exte
+00042590: 6e64 222c 0a20 2020 2020 2020 206e 6172  nd",.        nar
+000425a0: 6773 3d22 2b22 2c0a 2020 2020 2020 2020  gs="+",.        
+000425b0: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
+000425c0: 2020 6d65 7461 7661 723d 2252 4f4f 4d22    metavar="ROOM"
+000425d0: 2c0a 2020 2020 2020 2020 6865 6c70 3d22  ,.        help="
+000425e0: 496e 7669 7465 206f 6e65 206f 7265 206d  Invite one ore m
+000425f0: 6f72 6520 7573 6572 7320 746f 206a 6f69  ore users to joi
+00042600: 6e20 6f6e 6520 6f72 206d 6f72 6520 726f  n one or more ro
+00042610: 6f6d 732e 2022 0a20 2020 2020 2020 2022  oms. ".        "
+00042620: 4465 7461 696c 733a 3a20 5370 6563 6966  Details:: Specif
+00042630: 7920 7468 6520 7573 6572 2873 2920 6173  y the user(s) as
+00042640: 2061 7267 756d 656e 7473 2074 6f20 2d2d   arguments to --
+00042650: 7573 6572 2e20 220a 2020 2020 2020 2020  user. ".        
+00042660: 2253 7065 6369 6679 2074 6865 2072 6f6f  "Specify the roo
+00042670: 6d73 2061 7320 6172 6775 6d65 6e74 7320  ms as arguments 
+00042680: 746f 2074 6869 7320 6f70 7469 6f6e 2c20  to this option, 
+00042690: 692e 652e 2022 0a20 2020 2020 2020 2022  i.e. ".        "
+000426a0: 6173 2061 7267 756d 656e 7473 2074 6f20  as arguments to 
+000426b0: 2d2d 726f 6f6d 2d69 6e76 6974 652e 2022  --room-invite. "
+000426c0: 0a20 2020 2020 2020 2022 5468 6520 7573  .        "The us
+000426d0: 6572 206d 7573 7420 6861 7665 2070 6572  er must have per
+000426e0: 6d69 7373 696f 6e73 2074 6f20 696e 7669  missions to invi
+000426f0: 7465 2075 7365 7273 2e22 2c0a 2020 2020  te users.",.    
+00042700: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
+00042710: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
+00042720: 2d2d 726f 6f6d 2d62 616e 222c 0a20 2020  --room-ban",.   
+00042730: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
+00042740: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
+00042750: 696f 6e3d 2265 7874 656e 6422 2c0a 2020  ion="extend",.  
+00042760: 2020 2020 2020 6e61 7267 733d 222b 222c        nargs="+",
+00042770: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
+00042780: 722c 0a20 2020 2020 2020 206d 6574 6176  r,.        metav
+00042790: 6172 3d22 524f 4f4d 222c 0a20 2020 2020  ar="ROOM",.     
+000427a0: 2020 2068 656c 703d 2242 616e 206f 6e65     help="Ban one
+000427b0: 206f 7265 206d 6f72 6520 7573 6572 7320   ore more users 
+000427c0: 6672 6f6d 206f 6e65 206f 7220 6d6f 7265  from one or more
+000427d0: 2072 6f6f 6d73 2e20 220a 2020 2020 2020   rooms. ".      
+000427e0: 2020 2244 6574 6169 6c73 3a3a 2053 7065    "Details:: Spe
+000427f0: 6369 6679 2074 6865 2075 7365 7228 7329  cify the user(s)
+00042800: 2061 7320 6172 6775 6d65 6e74 7320 746f   as arguments to
+00042810: 202d 2d75 7365 722e 2022 0a20 2020 2020   --user. ".     
+00042820: 2020 2022 5370 6563 6966 7920 7468 6520     "Specify the 
+00042830: 726f 6f6d 7320 6173 2061 7267 756d 656e  rooms as argumen
+00042840: 7473 2074 6f20 7468 6973 206f 7074 696f  ts to this optio
+00042850: 6e2c 2069 2e65 2e20 220a 2020 2020 2020  n, i.e. ".      
+00042860: 2020 2261 7320 6172 6775 6d65 6e74 7320    "as arguments 
+00042870: 746f 202d 2d72 6f6f 6d2d 6261 6e2e 2022  to --room-ban. "
+00042880: 0a20 2020 2020 2020 2022 5468 6520 7573  .        "The us
+00042890: 6572 206d 7573 7420 6861 7665 2070 6572  er must have per
+000428a0: 6d69 7373 696f 6e73 2074 6f20 6261 6e20  missions to ban 
+000428b0: 7573 6572 732e 222c 0a20 2020 2029 0a20  users.",.    ). 
+000428c0: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
+000428d0: 6e74 280a 2020 2020 2020 2020 222d 2d72  nt(.        "--r
+000428e0: 6f6f 6d2d 756e 6261 6e22 2c0a 2020 2020  oom-unban",.    
+000428f0: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
+00042900: 7365 2c0a 2020 2020 2020 2020 6163 7469  se,.        acti
+00042910: 6f6e 3d22 6578 7465 6e64 222c 0a20 2020  on="extend",.   
+00042920: 2020 2020 206e 6172 6773 3d22 2b22 2c0a       nargs="+",.
+00042930: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
+00042940: 2c0a 2020 2020 2020 2020 6d65 7461 7661  ,.        metava
+00042950: 723d 2252 4f4f 4d22 2c0a 2020 2020 2020  r="ROOM",.      
+00042960: 2020 6865 6c70 3d22 556e 6261 6e20 6f6e    help="Unban on
+00042970: 6520 6f72 6520 6d6f 7265 2075 7365 7273  e ore more users
+00042980: 2066 726f 6d20 6f6e 6520 6f72 206d 6f72   from one or mor
+00042990: 6520 726f 6f6d 732e 2022 0a20 2020 2020  e rooms. ".     
+000429a0: 2020 2022 4465 7461 696c 733a 3a20 5370     "Details:: Sp
+000429b0: 6563 6966 7920 7468 6520 7573 6572 2873  ecify the user(s
+000429c0: 2920 6173 2061 7267 756d 656e 7473 2074  ) as arguments t
+000429d0: 6f20 2d2d 7573 6572 2e20 220a 2020 2020  o --user. ".    
+000429e0: 2020 2020 2253 7065 6369 6679 2074 6865      "Specify the
+000429f0: 2072 6f6f 6d73 2061 7320 6172 6775 6d65   rooms as argume
+00042a00: 6e74 7320 746f 2074 6869 7320 6f70 7469  nts to this opti
+00042a10: 6f6e 2c20 692e 652e 2022 0a20 2020 2020  on, i.e. ".     
+00042a20: 2020 2022 6173 2061 7267 756d 656e 7473     "as arguments
+00042a30: 2074 6f20 2d2d 726f 6f6d 2d75 6e62 616e   to --room-unban
+00042a40: 2e20 220a 2020 2020 2020 2020 2254 6865  . ".        "The
+00042a50: 2075 7365 7220 6d75 7374 2068 6176 6520   user must have 
+00042a60: 7065 726d 6973 7369 6f6e 7320 746f 2075  permissions to u
+00042a70: 6e62 616e 2075 7365 7273 2e22 2c0a 2020  nban users.",.  
+00042a80: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
+00042a90: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
+00042aa0: 2022 2d2d 726f 6f6d 2d6b 6963 6b22 2c0a   "--room-kick",.
+00042ab0: 2020 2020 2020 2020 7265 7175 6972 6564          required
+00042ac0: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+00042ad0: 6163 7469 6f6e 3d22 6578 7465 6e64 222c  action="extend",
+00042ae0: 0a20 2020 2020 2020 206e 6172 6773 3d22  .        nargs="
+00042af0: 2b22 2c0a 2020 2020 2020 2020 7479 7065  +",.        type
+00042b00: 3d73 7472 2c0a 2020 2020 2020 2020 6d65  =str,.        me
+00042b10: 7461 7661 723d 2252 4f4f 4d22 2c0a 2020  tavar="ROOM",.  
+00042b20: 2020 2020 2020 6865 6c70 3d22 4b69 636b        help="Kick
+00042b30: 206f 6e65 206f 7265 206d 6f72 6520 7573   one ore more us
+00042b40: 6572 7320 6672 6f6d 206f 6e65 206f 7220  ers from one or 
+00042b50: 6d6f 7265 2072 6f6f 6d73 2e20 220a 2020  more rooms. ".  
+00042b60: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
+00042b70: 2053 7065 6369 6679 2074 6865 2075 7365   Specify the use
+00042b80: 7228 7329 2061 7320 6172 6775 6d65 6e74  r(s) as argument
+00042b90: 7320 746f 202d 2d75 7365 722e 2022 0a20  s to --user. ". 
+00042ba0: 2020 2020 2020 2022 5370 6563 6966 7920         "Specify 
+00042bb0: 7468 6520 726f 6f6d 7320 6173 2061 7267  the rooms as arg
+00042bc0: 756d 656e 7473 2074 6f20 7468 6973 206f  uments to this o
+00042bd0: 7074 696f 6e2c 2069 2e65 2e20 220a 2020  ption, i.e. ".  
+00042be0: 2020 2020 2020 2261 7320 6172 6775 6d65        "as argume
+00042bf0: 6e74 7320 746f 202d 2d72 6f6f 6d2d 6b69  nts to --room-ki
+00042c00: 636b 2e20 220a 2020 2020 2020 2020 2254  ck. ".        "T
+00042c10: 6865 2075 7365 7220 6d75 7374 2068 6176  he user must hav
+00042c20: 6520 7065 726d 6973 7369 6f6e 7320 746f  e permissions to
+00042c30: 206b 6963 6b20 7573 6572 732e 222c 0a20   kick users.",. 
+00042c40: 2020 2029 0a20 2020 2061 702e 6164 645f     ).    ap.add_
+00042c50: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
+00042c60: 2020 2320 7374 6172 7469 6e67 2077 6974    # starting wit
+00042c70: 6820 7665 7273 696f 6e20 322e 3139 2022  h version 2.19 "
+00042c80: 2d75 2220 6861 7320 6265 656e 206d 6f76  -u" has been mov
+00042c90: 6564 2066 726f 6d0a 2020 2020 2020 2020  ed from.        
+00042ca0: 2320 2d2d 646f 776e 6c6f 6164 2d6d 6564  # --download-med
+00042cb0: 6961 2074 6f20 2d2d 7573 6572 210a 2020  ia to --user!.  
+00042cc0: 2020 2020 2020 222d 7522 2c0a 2020 2020        "-u",.    
+00042cd0: 2020 2020 222d 2d75 7365 7222 2c0a 2020      "--user",.  
+00042ce0: 2020 2020 2020 7265 7175 6972 6564 3d46        required=F
+00042cf0: 616c 7365 2c0a 2020 2020 2020 2020 6163  alse,.        ac
+00042d00: 7469 6f6e 3d22 6578 7465 6e64 222c 0a20  tion="extend",. 
+00042d10: 2020 2020 2020 206e 6172 6773 3d22 2b22         nargs="+"
+00042d20: 2c0a 2020 2020 2020 2020 7479 7065 3d73  ,.        type=s
+00042d30: 7472 2c0a 2020 2020 2020 2020 6d65 7461  tr,.        meta
+00042d40: 7661 723d 2255 5345 5222 2c0a 2020 2020  var="USER",.    
+00042d50: 2020 2020 6865 6c70 3d22 5370 6563 6966      help="Specif
+00042d60: 7920 6f6e 6520 6f72 206d 756c 7469 706c  y one or multipl
+00042d70: 6520 7573 6572 732e 2022 0a20 2020 2020  e users. ".     
+00042d80: 2020 2022 4465 7461 696c 733a 3a20 5468     "Details:: Th
+00042d90: 6973 206f 7074 696f 6e20 6973 206d 6561  is option is mea
+00042da0: 6e69 6e67 6675 6c20 220a 2020 2020 2020  ningful ".      
+00042db0: 2020 2269 6e20 636f 6d62 696e 6174 696f    "in combinatio
+00042dc0: 6e20 7769 7468 2061 2920 726f 6f6d 2061  n with a) room a
+00042dd0: 6374 696f 6e73 206c 696b 6520 2d2d 726f  ctions like --ro
+00042de0: 6f6d 2d69 6e76 6974 652c 202d 2d72 6f6f  om-invite, --roo
+00042df0: 6d2d 6261 6e2c 2022 0a20 2020 2020 2020  m-ban, ".       
+00042e00: 2022 2d2d 726f 6f6d 2d75 6e62 616e 2c20   "--room-unban, 
+00042e10: 6574 632e 2061 6e64 2062 2920 7365 6e64  etc. and b) send
+00042e20: 2061 6374 696f 6e73 206c 696b 6520 2d6d   actions like -m
+00042e30: 2c20 2d69 2c20 2d66 2c20 6574 632e 2022  , -i, -f, etc. "
+00042e40: 0a20 2020 2020 2020 2022 6329 2073 6f6d  .        "c) som
+00042e50: 6520 6c69 7374 656e 2061 6374 696f 6e73  e listen actions
+00042e60: 202d 2d6c 6973 7465 6e2c 2061 7320 7765   --listen, as we
+00042e70: 6c6c 2061 7320 6429 2061 6374 696f 6e73  ll as d) actions
+00042e80: 206c 696b 6520 220a 2020 2020 2020 2020   like ".        
+00042e90: 222d 2d64 656c 6574 652d 6465 7669 6365  "--delete-device
+00042ea0: 2e20 220a 2020 2020 2020 2020 2249 6e20  . ".        "In 
+00042eb0: 6361 7365 206f 6620 6129 2074 6869 7320  case of a) this 
+00042ec0: 6f70 7469 6f6e 202d 2d75 7365 7220 7370  option --user sp
+00042ed0: 6563 6966 6965 7320 7468 6520 7573 6572  ecifies the user
+00042ee0: 7320 220a 2020 2020 2020 2020 2274 6f20  s ".        "to 
+00042ef0: 6265 2075 7365 6420 7769 7468 2072 6f6f  be used with roo
+00042f00: 6d20 636f 6d6d 616e 6473 2028 6c69 6b65  m commands (like
+00042f10: 2069 6e76 6974 652c 2062 616e 2c20 6574   invite, ban, et
+00042f20: 632e 292e 2022 0a20 2020 2020 2020 2022  c.). ".        "
+00042f30: 496e 2063 6173 6520 6f66 2062 2920 7468  In case of b) th
+00042f40: 6520 6f70 7469 6f6e 202d 2d75 7365 7220  e option --user 
+00042f50: 6361 6e20 6265 2075 7365 6420 6173 2061  can be used as a
+00042f60: 6e20 616c 7465 726e 6174 6976 6520 220a  n alternative ".
+00042f70: 2020 2020 2020 2020 2274 6f20 7370 6563          "to spec
+00042f80: 6966 7969 6e67 2061 2072 6f6f 6d20 6173  ifying a room as
+00042f90: 2064 6573 7469 6e61 7469 6f6e 2066 6f72   destination for
+00042fa0: 2074 6578 7420 282d 6d29 2c20 696d 6167   text (-m), imag
+00042fb0: 6573 2028 2d69 292c 2022 0a20 2020 2020  es (-i), ".     
+00042fc0: 2020 2022 6574 632e 2046 6f72 2073 656e     "etc. For sen
+00042fd0: 6420 6163 7469 6f6e 7320 272d 2d75 7365  d actions '--use
+00042fe0: 7227 2069 7320 7072 6f76 6964 696e 6720  r' is providing 
+00042ff0: 7468 6520 6675 6e63 7469 6f6e 616c 6974  the functionalit
+00043000: 7920 6f66 2022 0a20 2020 2020 2020 2022  y of ".        "
+00043010: 2744 4d20 2864 6972 6563 7420 6d65 7373  'DM (direct mess
+00043020: 6167 696e 6729 272e 2046 6f72 2063 2920  aging)'. For c) 
+00043030: 7468 6973 206f 7074 696f 6e20 616c 6c6f  this option allo
+00043040: 7773 2061 6e20 616c 7465 726e 6174 6976  ws an alternativ
+00043050: 6520 220a 2020 2020 2020 2020 2274 6f20  e ".        "to 
+00043060: 7370 6563 6966 7969 6e67 2061 2072 6f6f  specifying a roo
+00043070: 6d20 6173 2064 6573 7469 6e61 7469 6f6e  m as destination
+00043080: 2066 6f72 2073 6f6d 6520 2d2d 6c69 7374   for some --list
+00043090: 656e 2061 6374 696f 6e73 2e20 220a 2020  en actions. ".  
+000430a0: 2020 2020 2020 2246 6f72 2064 2920 7468        "For d) th
+000430b0: 6973 2067 6976 6573 2074 6865 206f 7074  is gives the opt
+000430c0: 696f 6e20 746f 2064 656c 6574 6520 7468  ion to delete th
+000430d0: 6520 6465 7669 6365 206f 6620 6120 6469  e device of a di
+000430e0: 6666 6572 656e 7420 220a 2020 2020 2020  fferent ".      
+000430f0: 2020 2275 7365 722e 2022 0a20 2020 2020    "user. ".     
+00043100: 2020 2066 222d 2d2d 2d2d 2057 6861 7420     f"----- What 
+00043110: 6973 2061 2044 4d3f 207b 5052 4f47 5f57  is a DM? {PROG_W
+00043120: 4954 484f 5554 5f45 5854 7d20 7472 6965  ITHOUT_EXT} trie
+00043130: 7320 746f 2066 696e 6420 6120 220a 2020  s to find a ".  
+00043140: 2020 2020 2020 2272 6f6f 6d20 7468 6174        "room that
+00043150: 2063 6f6e 7461 696e 7320 6f6e 6c79 2074   contains only t
+00043160: 6865 2073 656e 6465 7220 616e 6420 7468  he sender and th
+00043170: 6520 7265 6365 6976 6572 2c20 6865 6e63  e receiver, henc
+00043180: 6520 444d 2e20 220a 2020 2020 2020 2020  e DM. ".        
+00043190: 2254 6865 7365 2072 6f6f 6d73 2068 6176  "These rooms hav
+000431a0: 6520 6e6f 7468 696e 6720 7370 6563 6961  e nothing specia
+000431b0: 6c20 6f74 6865 7220 7468 6520 6661 6374  l other the fact
+000431c0: 2074 6861 7420 7468 6579 206f 6e6c 7920   that they only 
+000431d0: 6861 7665 2022 0a20 2020 2020 2020 2022  have ".        "
+000431e0: 3220 6d65 6d62 6572 7320 616e 6420 7468  2 members and th
+000431f0: 656d 2062 6569 6e67 2074 6865 2073 656e  em being the sen
+00043200: 6465 7220 616e 6420 7265 6369 7069 656e  der and recipien
+00043210: 7420 7265 7370 6563 7469 7665 6c79 2e20  t respectively. 
+00043220: 220a 2020 2020 2020 2020 2249 6620 7375  ".        "If su
+00043230: 6368 2061 2072 6f6f 6d20 6973 2066 6f75  ch a room is fou
+00043240: 6e64 2c20 7468 6520 6669 7273 7420 6f6e  nd, the first on
+00043250: 6520 666f 756e 6420 7769 6c6c 2062 6520  e found will be 
+00043260: 7573 6564 2061 7320 220a 2020 2020 2020  used as ".      
+00043270: 2020 2264 6573 7469 6e61 7469 6f6e 2e20    "destination. 
+00043280: 4966 206e 6f20 7375 6368 2072 6f6f 6d20  If no such room 
+00043290: 6973 2066 6f75 6e64 2c20 7468 6520 7365  is found, the se
+000432a0: 6e64 2066 6169 6c73 2061 6e64 2074 6865  nd fails and the
+000432b0: 2075 7365 7220 220a 2020 2020 2020 2020   user ".        
+000432c0: 2273 686f 756c 6420 646f 2061 202d 2d72  "should do a --r
+000432d0: 6f6f 6d2d 6372 6561 7465 2061 6e64 202d  oom-create and -
+000432e0: 2d72 6f6f 6d2d 696e 7669 7465 2066 6972  -room-invite fir
+000432f0: 7374 2e20 4966 206d 756c 7469 706c 6520  st. If multiple 
+00043300: 220a 2020 2020 2020 2020 2273 7563 6820  ".        "such 
+00043310: 726f 6f6d 7320 6578 6973 742c 206f 6e65  rooms exist, one
+00043320: 206f 6620 7468 656d 2077 696c 6c20 6265   of them will be
+00043330: 2075 7365 6420 2861 7262 6974 7261 7269   used (arbitrari
+00043340: 6c79 292e 2022 0a20 2020 2020 2020 2022  ly). ".        "
+00043350: 466f 7220 7365 6e64 696e 6720 616e 6420  For sending and 
+00043360: 6c69 7374 656e 696e 672c 2073 7065 6369  listening, speci
+00043370: 6679 696e 6720 6120 726f 6f6d 2064 6972  fying a room dir
+00043380: 6563 746c 7920 6973 2061 6c77 6179 7320  ectly is always 
+00043390: 220a 2020 2020 2020 2020 2266 6173 7465  ".        "faste
+000433a0: 7220 616e 6420 6d6f 7265 2065 6666 6963  r and more effic
+000433b0: 6965 6e74 2074 6861 6e20 7370 6563 6966  ient than specif
+000433c0: 7969 6e67 2061 2075 7365 722e 2053 6f2c  ying a user. So,
+000433d0: 2069 6620 796f 7520 6b6e 6f77 2022 0a20   if you know ". 
+000433e0: 2020 2020 2020 2022 7468 6520 726f 6f6d         "the room
+000433f0: 2c20 6974 2069 7320 7072 6566 6572 7265  , it is preferre
+00043400: 6420 746f 2075 7365 202d 2d72 6f6f 6d20  d to use --room 
+00043410: 696e 7374 6561 6420 6f66 202d 2d75 7365  instead of --use
+00043420: 722e 2022 0a20 2020 2020 2020 2022 466f  r. ".        "Fo
+00043430: 7220 6229 2061 6e64 2063 2920 2d2d 7573  r b) and c) --us
+00043440: 6572 2063 616e 2062 6520 7370 6563 6966  er can be specif
+00043450: 6965 6420 696e 2033 2077 6179 733a 2031  ied in 3 ways: 1
+00043460: 2920 6675 6c6c 2075 7365 7220 6964 2022  ) full user id "
+00043470: 0a20 2020 2020 2020 2022 6173 2069 6e20  .        "as in 
+00043480: 2740 6a6f 686e 3a65 7861 6d70 6c65 2e6f  '@john:example.o
+00043490: 7267 272c 2032 2920 7061 7274 6961 6c20  rg', 2) partial 
+000434a0: 7573 6572 2069 6420 6173 2069 6e20 2740  user id as in '@
+000434b0: 6a6f 686e 2720 7768 656e 2022 0a20 2020  john' when ".   
+000434c0: 2020 2020 2022 7468 6520 7573 6572 2069       "the user i
+000434d0: 7320 6f6e 2074 6865 2073 616d 6520 686f  s on the same ho
+000434e0: 6d65 7365 7276 6572 2028 6578 616d 706c  meserver (exampl
+000434f0: 652e 6f72 6720 7769 6c6c 2062 6520 220a  e.org will be ".
+00043500: 2020 2020 2020 2020 2261 7574 6f6d 6174          "automat
+00043510: 6963 616c 6c79 2061 7070 656e 6465 6429  ically appended)
+00043520: 2c20 6f72 2033 2920 6120 6469 7370 6c61  , or 3) a displa
+00043530: 7920 6e61 6d65 2061 7320 696e 2027 6a6f  y name as in 'jo
+00043540: 686e 272e 2022 0a20 2020 2020 2020 2022  hn'. ".        "
+00043550: 4265 2063 6172 6566 756c 2c20 7768 656e  Be careful, when
+00043560: 2022 0a20 2020 2020 2020 2022 7573 696e   ".        "usin
+00043570: 6720 6469 7370 6c61 7920 6e61 6d65 7320  g display names 
+00043580: 6173 2074 6865 7920 6d69 6768 7420 6e6f  as they might no
+00043590: 7420 6265 2075 6e69 7175 652c 2061 6e64  t be unique, and
+000435a0: 2079 6f75 2063 6f75 6c64 2022 0a20 2020   you could ".   
+000435b0: 2020 2020 2022 6265 2073 656e 6469 6e67       "be sending
+000435c0: 2074 6f20 7468 6520 7772 6f6e 6720 7065   to the wrong pe
+000435d0: 7273 6f6e 2e20 546f 2073 6565 2070 6f73  rson. To see pos
+000435e0: 7369 626c 6520 6469 7370 6c61 7920 6e61  sible display na
+000435f0: 6d65 7320 7573 6520 220a 2020 2020 2020  mes use ".      
+00043600: 2020 2274 6865 202d 2d6a 6f69 6e65 642d    "the --joined-
+00043610: 6d65 6d62 6572 7320 272a 2720 6f70 7469  members '*' opti
+00043620: 6f6e 2077 6869 6368 2077 696c 6c20 7368  on which will sh
+00043630: 6f77 2079 6f75 2074 6865 2064 6973 706c  ow you the displ
+00043640: 6179 2022 0a20 2020 2020 2020 2022 6e61  ay ".        "na
+00043650: 6d65 7320 696e 2074 6865 206d 6964 646c  mes in the middl
+00043660: 6520 636f 6c75 6d6e 2e22 2c0a 2020 2020  e column.",.    
+00043670: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
+00043680: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
+00043690: 2d2d 7573 6572 2d6c 6f67 696e 222c 0a20  --user-login",. 
+000436a0: 2020 2020 2020 2072 6571 7569 7265 643d         required=
+000436b0: 4661 6c73 652c 0a20 2020 2020 2020 2074  False,.        t
+000436c0: 7970 653d 7374 722c 0a20 2020 2020 2020  ype=str,.       
+000436d0: 2023 2040 6a6f 686e 3a65 7861 6d70 6c65   # @john:example
+000436e0: 2e63 6f6d 2061 6e64 2040 6a6f 686e 2061  .com and @john a
+000436f0: 6e64 206a 6f68 6e20 6163 6365 7074 6564  nd john accepted
+00043700: 0a20 2020 2020 2020 206d 6574 6176 6172  .        metavar
+00043710: 3d22 5553 4552 222c 0a20 2020 2020 2020  ="USER",.       
+00043720: 2068 656c 703d 2253 7065 6369 6679 2075   help="Specify u
+00043730: 7365 7220 666f 7220 2d2d 6c6f 6769 6e2e  ser for --login.
+00043740: 2022 0a20 2020 2020 2020 2022 4465 7461   ".        "Deta
+00043750: 696c 733a 3a20 4f70 7469 6f6e 616c 2061  ils:: Optional a
+00043760: 7267 756d 656e 7420 746f 2073 7065 6369  rgument to speci
+00043770: 6679 2074 6865 2075 7365 7220 666f 7220  fy the user for 
+00043780: 2d2d 6c6f 6769 6e2e 2022 0a20 2020 2020  --login. ".     
+00043790: 2020 2022 5468 6973 2067 6976 6573 2074     "This gives t
+000437a0: 6865 206f 7074 696f 6e20 746f 2073 7065  he option to spe
+000437b0: 6369 6679 2074 6865 2075 7365 7220 6964  cify the user id
+000437c0: 2066 6f72 206c 6f67 696e 2e20 220a 2020   for login. ".  
+000437d0: 2020 2020 2020 2246 6f72 2027 2d2d 6c6f        "For '--lo
+000437e0: 6769 6e20 7373 6f27 2074 6865 202d 2d75  gin sso' the --u
+000437f0: 7365 722d 6c6f 6769 6e20 6973 206e 6f74  ser-login is not
+00043800: 206e 6565 6465 6420 6173 2075 7365 7220   needed as user 
+00043810: 6964 2063 616e 2062 6520 220a 2020 2020  id can be ".    
+00043820: 2020 2020 226f 6274 6169 6e65 6420 6672      "obtained fr
+00043830: 6f6d 2073 6572 7665 7220 7669 6120 5353  om server via SS
+00043840: 4f2e 2046 6f72 2027 2d2d 6c6f 6769 6e20  O. For '--login 
+00043850: 7061 7373 776f 7264 272c 2069 6620 6e6f  password', if no
+00043860: 7420 220a 2020 2020 2020 2020 2270 726f  t ".        "pro
+00043870: 7669 6465 6420 6974 2077 696c 6c20 6265  vided it will be
+00043880: 2071 7565 7269 6564 2076 6961 206b 6579   queried via key
+00043890: 626f 6172 642e 2041 2066 756c 6c20 7573  board. A full us
+000438a0: 6572 2069 6420 6c69 6b65 2022 0a20 2020  er id like ".   
+000438b0: 2020 2020 2022 2740 6a6f 686e 3a65 7861       "'@john:exa
+000438c0: 6d70 6c65 2e63 6f6d 272c 2061 2070 6172  mple.com', a par
+000438d0: 7469 616c 2075 7365 7220 6e61 6d65 206c  tial user name l
+000438e0: 696b 6520 2740 6a6f 686e 272c 2061 6e64  ike '@john', and
+000438f0: 2022 0a20 2020 2020 2020 2022 6120 7368   ".        "a sh
+00043900: 6f72 7420 7573 6572 206e 616d 6520 6c69  ort user name li
+00043910: 6b65 2027 6a6f 686e 2720 6361 6e20 6265  ke 'john' can be
+00043920: 2067 6976 656e 2e20 220a 2020 2020 2020   given. ".      
+00043930: 2020 222d 2d75 7365 722d 6c6f 6769 6e20    "--user-login 
+00043940: 6973 206f 6e6c 7920 7573 6564 2062 7920  is only used by 
+00043950: 2d2d 6c6f 6769 6e20 616e 6420 6967 6e6f  --login and igno
+00043960: 7265 6420 6279 2061 6c6c 206f 7468 6572  red by all other
+00043970: 2022 0a20 2020 2020 2020 2022 6163 7469   ".        "acti
+00043980: 6f6e 732e 222c 0a20 2020 2029 0a20 2020  ons.",.    ).   
+00043990: 2061 702e 6164 645f 6172 6775 6d65 6e74   ap.add_argument
+000439a0: 280a 2020 2020 2020 2020 222d 2d6e 616d  (.        "--nam
+000439b0: 6522 2c0a 2020 2020 2020 2020 7265 7175  e",.        requ
+000439c0: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
+000439d0: 2020 2020 6163 7469 6f6e 3d22 6578 7465      action="exte
+000439e0: 6e64 222c 0a20 2020 2020 2020 206e 6172  nd",.        nar
+000439f0: 6773 3d22 2b22 2c0a 2020 2020 2020 2020  gs="+",.        
+00043a00: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
+00043a10: 2020 6d65 7461 7661 723d 2252 4f4f 4d5f    metavar="ROOM_
+00043a20: 4e41 4d45 222c 0a20 2020 2020 2020 2068  NAME",.        h
+00043a30: 656c 703d 2253 7065 6369 6679 206f 6e65  elp="Specify one
+00043a40: 206f 7220 6d75 6c74 6970 6c65 2072 6f6f   or multiple roo
+00043a50: 6d20 6e61 6d65 732e 2022 0a20 2020 2020  m names. ".     
+00043a60: 2020 2022 4465 7461 696c 733a 3a20 5468     "Details:: Th
+00043a70: 6973 206f 7074 696f 6e20 6973 206f 6e6c  is option is onl
+00043a80: 7920 6d65 616e 696e 6766 756c 2022 0a20  y meaningful ". 
+00043a90: 2020 2020 2020 2022 696e 2063 6f6d 6269         "in combi
+00043aa0: 6e61 7469 6f6e 2077 6974 6820 6f70 7469  nation with opti
+00043ab0: 6f6e 202d 2d72 6f6f 6d2d 6372 6561 7465  on --room-create
+00043ac0: 2e20 220a 2020 2020 2020 2020 2254 6869  . ".        "Thi
+00043ad0: 7320 6f70 7469 6f6e 202d 2d6e 616d 6520  s option --name 
+00043ae0: 7370 6563 6966 6965 7320 7468 6520 6e61  specifies the na
+00043af0: 6d65 7320 220a 2020 2020 2020 2020 2274  mes ".        "t
+00043b00: 6f20 6265 2075 7365 6420 7769 7468 2074  o be used with t
+00043b10: 6865 2063 6f6d 6d61 6e64 202d 2d72 6f6f  he command --roo
+00043b20: 6d2d 6372 6561 7465 2e22 2c0a 2020 2020  m-create.",.    
+00043b30: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
+00043b40: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
+00043b50: 2d2d 746f 7069 6322 2c0a 2020 2020 2020  --topic",.      
+00043b60: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
+00043b70: 2c0a 2020 2020 2020 2020 6163 7469 6f6e  ,.        action
+00043b80: 3d22 6578 7465 6e64 222c 0a20 2020 2020  ="extend",.     
+00043b90: 2020 206e 6172 6773 3d22 2b22 2c0a 2020     nargs="+",.  
+00043ba0: 2020 2020 2020 7479 7065 3d73 7472 2c0a        type=str,.
+00043bb0: 2020 2020 2020 2020 6d65 7461 7661 723d          metavar=
+00043bc0: 2252 4f4f 4d5f 544f 5049 4322 2c0a 2020  "ROOM_TOPIC",.  
+00043bd0: 2020 2020 2020 6865 6c70 3d22 5370 6563        help="Spec
+00043be0: 6966 7920 6f6e 6520 6f72 206d 756c 7469  ify one or multi
+00043bf0: 706c 6520 726f 6f6d 2074 6f70 6963 732e  ple room topics.
+00043c00: 2022 0a20 2020 2020 2020 2022 4465 7461   ".        "Deta
+00043c10: 696c 733a 3a20 5468 6973 206f 7074 696f  ils:: This optio
+00043c20: 6e20 6973 206f 6e6c 7920 6d65 616e 696e  n is only meanin
+00043c30: 6766 756c 2022 0a20 2020 2020 2020 2022  gful ".        "
+00043c40: 696e 2063 6f6d 6269 6e61 7469 6f6e 2077  in combination w
+00043c50: 6974 6820 6f70 7469 6f6e 202d 2d72 6f6f  ith option --roo
+00043c60: 6d2d 6372 6561 7465 2e20 220a 2020 2020  m-create. ".    
+00043c70: 2020 2020 2254 6869 7320 6f70 7469 6f6e      "This option
+00043c80: 202d 2d74 6f70 6963 2073 7065 6369 6669   --topic specifi
+00043c90: 6573 2074 6865 2074 6f70 6963 7320 220a  es the topics ".
+00043ca0: 2020 2020 2020 2020 2274 6f20 6265 2075          "to be u
+00043cb0: 7365 6420 7769 7468 2074 6865 2063 6f6d  sed with the com
+00043cc0: 6d61 6e64 202d 2d72 6f6f 6d2d 6372 6561  mand --room-crea
+00043cd0: 7465 2e22 2c0a 2020 2020 290a 2020 2020  te.",.    ).    
+00043ce0: 6170 2e61 6464 5f61 7267 756d 656e 7428  ap.add_argument(
+00043cf0: 0a20 2020 2020 2020 2022 2d2d 616c 6961  .        "--alia
+00043d00: 7322 2c0a 2020 2020 2020 2020 7265 7175  s",.        requ
+00043d10: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
+00043d20: 2020 2020 6163 7469 6f6e 3d22 6578 7465      action="exte
+00043d30: 6e64 222c 0a20 2020 2020 2020 206e 6172  nd",.        nar
+00043d40: 6773 3d22 2b22 2c0a 2020 2020 2020 2020  gs="+",.        
+00043d50: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
+00043d60: 2020 6d65 7461 7661 723d 2252 4f4f 4d5f    metavar="ROOM_
+00043d70: 414c 4941 5322 2c0a 2020 2020 2020 2020  ALIAS",.        
+00043d80: 6865 6c70 3d22 5370 6563 6966 7920 6f6e  help="Specify on
+00043d90: 6520 6f72 206d 756c 7469 706c 6520 726f  e or multiple ro
+00043da0: 6f6d 2061 6c69 6173 6573 2e20 220a 2020  om aliases. ".  
+00043db0: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
+00043dc0: 2054 6869 7320 6f70 7469 6f6e 2069 7320   This option is 
+00043dd0: 6f6e 6c79 2022 0a20 2020 2020 2020 2022  only ".        "
+00043de0: 6d65 616e 696e 6766 756c 2069 6e20 636f  meaningful in co
+00043df0: 6d62 696e 6174 696f 6e20 7769 7468 206f  mbination with o
+00043e00: 7074 696f 6e20 2d2d 726f 6f6d 2d64 6d2d  ption --room-dm-
+00043e10: 6372 6561 7465 2e20 220a 2020 2020 2020  create. ".      
+00043e20: 2020 2254 6869 7320 6f70 7469 6f6e 202d    "This option -
+00043e30: 2d61 6c69 6173 2073 7065 6369 6669 6573  -alias specifies
+00043e40: 2074 6865 2061 6c69 6173 6573 2074 6f20   the aliases to 
+00043e50: 6265 2075 7365 6420 220a 2020 2020 2020  be used ".      
+00043e60: 2020 2277 6974 6820 7468 6520 636f 6d6d    "with the comm
+00043e70: 616e 6420 2d2d 726f 6f6d 2d64 6d2d 6372  and --room-dm-cr
+00043e80: 6561 7465 2e22 2c0a 2020 2020 290a 2020  eate.",.    ).  
+00043e90: 2020 2320 616c 6c6f 7720 6d75 6c74 6970    # allow multip
+00043ea0: 6c65 206d 6573 7361 6765 7320 2c20 652e  le messages , e.
+00043eb0: 672e 202d 6d20 226d 3122 2022 6d32 2220  g. -m "m1" "m2" 
+00043ec0: 6f72 202d 6d20 226d 3122 202d 6d20 226d  or -m "m1" -m "m
+00043ed0: 3222 0a20 2020 2023 206d 6573 7361 6765  2".    # message
+00043ee0: 2069 7320 676f 696e 6720 746f 2062 6520   is going to be 
+00043ef0: 6120 6c69 7374 206f 6620 7374 7269 6e67  a list of string
+00043f00: 730a 2020 2020 2320 652e 672e 206d 6573  s.    # e.g. mes
+00043f10: 7361 6765 3d5b 2027 6d31 272c 2027 6d32  sage=[ 'm1', 'm2
+00043f20: 2720 5d0a 2020 2020 6170 2e61 6464 5f61  ' ].    ap.add_a
+00043f30: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
+00043f40: 2022 2d6d 222c 0a20 2020 2020 2020 2022   "-m",.        "
+00043f50: 2d2d 6d65 7373 6167 6522 2c0a 2020 2020  --message",.    
+00043f60: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
+00043f70: 7365 2c0a 2020 2020 2020 2020 6163 7469  se,.        acti
+00043f80: 6f6e 3d22 6578 7465 6e64 222c 0a20 2020  on="extend",.   
+00043f90: 2020 2020 206e 6172 6773 3d22 2b22 2c0a       nargs="+",.
+00043fa0: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
+00043fb0: 2c0a 2020 2020 2020 2020 6d65 7461 7661  ,.        metava
+00043fc0: 723d 2254 4558 5422 2c0a 2020 2020 2020  r="TEXT",.      
+00043fd0: 2020 6865 6c70 3d22 5365 6e64 206f 6e65    help="Send one
+00043fe0: 206f 7220 6d75 6c74 6970 6c65 2074 6578   or multiple tex
+00043ff0: 7420 6d65 7373 6167 6573 2e20 220a 2020  t messages. ".  
+00044000: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
+00044010: 204d 6573 7361 6765 2064 6174 6120 6d75   Message data mu
+00044020: 7374 206e 6f74 2062 6520 6269 6e61 7279  st not be binary
+00044030: 2064 6174 612c 2069 7420 220a 2020 2020   data, it ".    
+00044040: 2020 2020 226d 7573 7420 6265 2074 6578      "must be tex
+00044050: 742e 2049 6620 6e6f 2027 2d6d 2720 6973  t. If no '-m' is
+00044060: 2075 7365 6420 616e 6420 6e6f 206f 7468   used and no oth
+00044070: 6572 2063 6f6e 666c 6963 7469 6e67 2022  er conflicting "
+00044080: 0a20 2020 2020 2020 2022 6172 6775 6d65  .        "argume
+00044090: 6e74 7320 6172 6520 7072 6f76 6964 6564  nts are provided
+000440a0: 2c20 616e 6420 696e 666f 726d 6174 696f  , and informatio
+000440b0: 6e20 6973 2070 6970 6564 2069 6e74 6f20  n is piped into 
+000440c0: 7468 6520 7072 6f67 7261 6d2c 2022 0a20  the program, ". 
+000440d0: 2020 2020 2020 2022 7468 656e 2074 6865         "then the
+000440e0: 2070 6970 6564 2064 6174 6120 7769 6c6c   piped data will
+000440f0: 2062 6520 7573 6564 2061 7320 6d65 7373   be used as mess
+00044100: 6167 652e 2022 0a20 2020 2020 2020 2022  age. ".        "
+00044110: 4669 6e61 6c6c 792c 2069 6620 7468 6572  Finally, if ther
+00044120: 6520 6172 6520 6e6f 206f 7065 7261 7469  e are no operati
+00044130: 6f6e 7320 6174 2061 6c6c 2069 6e20 7468  ons at all in th
+00044140: 6520 6172 6775 6d65 6e74 732c 2074 6865  e arguments, the
+00044150: 6e20 220a 2020 2020 2020 2020 2261 206d  n ".        "a m
+00044160: 6573 7361 6765 2077 696c 6c20 6265 2072  essage will be r
+00044170: 6561 6420 6672 6f6d 2073 7464 696e 2c20  ead from stdin, 
+00044180: 692e 652e 2066 726f 6d20 7468 6520 6b65  i.e. from the ke
+00044190: 7962 6f61 7264 2e20 220a 2020 2020 2020  yboard. ".      
+000441a0: 2020 2254 6869 7320 6f70 7469 6f6e 2063    "This option c
+000441b0: 616e 2062 6520 7573 6564 206d 756c 7469  an be used multi
+000441c0: 706c 6520 7469 6d65 7320 746f 2073 656e  ple times to sen
+000441d0: 6420 220a 2020 2020 2020 2020 226d 756c  d ".        "mul
+000441e0: 7469 706c 6520 6d65 7373 6167 6573 2e20  tiple messages. 
+000441f0: 4966 2074 6865 7265 2069 7320 6461 7461  If there is data
+00044200: 2070 6970 6564 2022 0a20 2020 2020 2020   piped ".       
+00044210: 2022 696e 746f 2074 6869 7320 7072 6f67   "into this prog
+00044220: 7261 6d2c 2074 6865 6e20 6669 7273 7420  ram, then first 
+00044230: 6461 7461 2066 726f 6d20 7468 6520 220a  data from the ".
+00044240: 2020 2020 2020 2020 2270 6970 6520 6973          "pipe is
+00044250: 2070 7562 6c69 7368 6564 2c20 7468 656e   published, then
+00044260: 206d 6573 7361 6765 7320 6672 6f6d 2074   messages from t
+00044270: 6869 7320 220a 2020 2020 2020 2020 226f  his ".        "o
+00044280: 7074 696f 6e20 6172 6520 7075 626c 6973  ption are publis
+00044290: 6865 642e 204d 6573 7361 6765 7320 7769  hed. Messages wi
+000442a0: 6c6c 2062 6520 7365 6e74 206c 6173 742c  ll be sent last,
+000442b0: 2022 0a20 2020 2020 2020 2022 692e 652e   ".        "i.e.
+000442c0: 2061 6674 6572 206f 626a 6563 7473 206c   after objects l
+000442d0: 696b 6520 696d 6167 6573 2c20 6175 6469  ike images, audi
+000442e0: 6f2c 2066 696c 6573 2c20 6576 656e 7473  o, files, events
+000442f0: 2c20 6574 632e 2022 0a20 2020 2020 2020  , etc. ".       
+00044300: 2022 496e 7075 7420 7069 7065 6420 7669   "Input piped vi
+00044310: 6120 7374 6469 6e20 6361 6e20 6164 6469  a stdin can addi
+00044320: 7469 6f6e 616c 6c79 2062 6520 7370 6563  tionally be spec
+00044330: 6966 6965 6420 7769 7468 2074 6865 2022  ified with the "
+00044340: 0a20 2020 2020 2020 2022 7370 6563 6961  .        "specia
+00044350: 6c20 6368 6172 6163 7465 7220 272d 272e  l character '-'.
+00044360: 2022 0a20 2020 2020 2020 2066 2249 6620   ".        f"If 
+00044370: 796f 7520 7761 6e74 2074 6f20 6665 6564  you want to feed
+00044380: 2061 2074 6578 7420 6d65 7373 6167 6520   a text message 
+00044390: 696e 746f 207b 5052 4f47 5f57 4954 484f  into {PROG_WITHO
+000443a0: 5554 5f45 5854 7d20 220a 2020 2020 2020  UT_EXT} ".      
+000443b0: 2020 2276 6961 2061 2070 6970 652c 2076    "via a pipe, v
+000443c0: 6961 2073 7464 696e 2c20 7468 656e 2073  ia stdin, then s
+000443d0: 7065 6369 6679 2074 6865 2073 7065 6369  pecify the speci
+000443e0: 616c 2022 0a20 2020 2020 2020 2022 6368  al ".        "ch
+000443f0: 6172 6163 7465 7220 272d 272e 2049 6620  aracter '-'. If 
+00044400: 272d 2720 6973 2073 7065 6369 6669 6564  '-' is specified
+00044410: 2061 7320 6d65 7373 6167 652c 2022 0a20   as message, ". 
+00044420: 2020 2020 2020 2022 7468 656e 2074 6865         "then the
+00044430: 2070 726f 6772 616d 2077 696c 6c20 7265   program will re
+00044440: 6164 2074 6865 206d 6573 7361 6765 2066  ad the message f
+00044450: 726f 6d20 7374 6469 6e2e 2022 0a20 2020  rom stdin. ".   
+00044460: 2020 2020 2022 5769 7468 2027 2d27 2074       "With '-' t
+00044470: 6865 2077 686f 6c65 206d 6573 7361 6765  he whole message
+00044480: 2c20 616c 6c20 6c69 6e65 732c 2077 696c  , all lines, wil
+00044490: 6c20 6265 2063 6f6e 7369 6465 7265 6420  l be considered 
+000444a0: 220a 2020 2020 2020 2020 2261 2073 696e  ".        "a sin
+000444b0: 676c 6520 6d65 7373 6167 6520 616e 6420  gle message and 
+000444c0: 7365 6e74 2061 7320 6f6e 6520 6d65 7373  sent as one mess
+000444d0: 6167 652e 2022 0a20 2020 2020 2020 2022  age. ".        "
+000444e0: 4966 2079 6f75 7220 6d65 7373 6167 6520  If your message 
+000444f0: 6973 206c 6974 6572 616c 6c79 2027 2d27  is literally '-'
+00044500: 2074 6865 6e20 7573 6520 275c 5c2d 2720   then use '\\-' 
+00044510: 220a 2020 2020 2020 2020 2261 7320 6d65  ".        "as me
+00044520: 7373 6167 6520 696e 2074 6865 2061 7267  ssage in the arg
+00044530: 756d 656e 742e 2022 0a20 2020 2020 2020  ument. ".       
+00044540: 2022 272d 2720 6d61 7920 6170 7065 6172   "'-' may appear
+00044550: 2069 6e20 616e 7920 706f 7369 7469 6f6e   in any position
+00044560: 2c20 692e 652e 2027 2d6d 205c 2273 7461  , i.e. '-m \"sta
+00044570: 7274 5c22 202d 205c 2265 6e64 5c22 2720  rt\" - \"end\"' 
+00044580: 220a 2020 2020 2020 2020 2277 696c 6c20  ".        "will 
+00044590: 7365 6e64 2033 206d 6573 7361 6765 7320  send 3 messages 
+000445a0: 6f75 7420 6f66 2077 6869 6368 2074 6865  out of which the
+000445b0: 2073 6563 6f6e 6420 6f6e 6520 6973 2072   second one is r
+000445c0: 6561 6420 6672 6f6d 2073 7464 696e 2e20  ead from stdin. 
+000445d0: 220a 2020 2020 2020 2020 2227 2d27 206d  ".        "'-' m
+000445e0: 6179 2061 7070 6561 7220 6f6e 6c79 206f  ay appear only o
+000445f0: 6e63 6520 6f76 6572 616c 6c20 696e 2061  nce overall in a
+00044600: 6c6c 2061 7267 756d 656e 7473 2e20 220a  ll arguments. ".
+00044610: 2020 2020 2020 2020 2253 696d 696c 6172          "Similar
+00044620: 2074 6f20 272d 272c 2061 6e6f 7468 6572   to '-', another
+00044630: 2073 686f 7274 6375 7420 6368 6172 6163   shortcut charac
+00044640: 7465 7220 6973 2027 5f27 2e20 5468 6520  ter is '_'. The 
+00044650: 220a 2020 2020 2020 2020 2273 7065 6369  ".        "speci
+00044660: 616c 2063 6861 7261 6374 6572 2027 5f27  al character '_'
+00044670: 2069 7320 7573 6564 2066 6f72 2073 7472   is used for str
+00044680: 6561 6d69 6e67 2064 6174 6120 7669 6120  eaming data via 
+00044690: 220a 2020 2020 2020 2020 2261 2070 6970  ".        "a pip
+000446a0: 6520 6f6e 2073 7464 696e 2e20 5769 7468  e on stdin. With
+000446b0: 2027 5f27 2074 6865 2073 7464 696e 2070   '_' the stdin p
+000446c0: 6970 6520 6973 2072 6561 6420 6c69 6e65  ipe is read line
+000446d0: 2d62 792d 6c69 6e65 2022 0a20 2020 2020  -by-line ".     
+000446e0: 2020 2022 616e 6420 6561 6368 206c 696e     "and each lin
+000446f0: 6520 6973 2074 7265 6174 6564 2061 7320  e is treated as 
+00044700: 6120 7365 7061 7261 7465 206d 6573 7361  a separate messa
+00044710: 6765 2061 6e64 2073 656e 7420 7269 6768  ge and sent righ
+00044720: 7420 220a 2020 2020 2020 2020 2261 7761  t ".        "awa
+00044730: 792e 2054 6865 2070 726f 6772 616d 2077  y. The program w
+00044740: 6169 7473 2066 6f72 2070 6970 6520 696e  aits for pipe in
+00044750: 7075 7420 756e 7469 6c20 7468 6520 7069  put until the pi
+00044760: 7065 2069 7320 220a 2020 2020 2020 2020  pe is ".        
+00044770: 2263 6c6f 7365 642e 2045 2e67 2e20 496d  "closed. E.g. Im
+00044780: 6167 696e 6520 6120 746f 6f6c 2074 6861  agine a tool tha
+00044790: 7420 6765 6e65 7261 7465 7320 6f75 7470  t generates outp
+000447a0: 7574 2073 706f 7261 6469 6361 6c6c 7920  ut sporadically 
+000447b0: 220a 2020 2020 2020 2020 6622 3234 7837  ".        f"24x7
+000447c0: 2e20 4974 2063 616e 2062 6520 7069 7065  . It can be pipe
+000447d0: 642c 2069 2e65 2e20 7374 7265 616d 6564  d, i.e. streamed
+000447e0: 2c20 696e 746f 207b 5052 4f47 5f57 4954  , into {PROG_WIT
+000447f0: 484f 5554 5f45 5854 7d2c 2061 6e64 2022  HOUT_EXT}, and "
+00044800: 0a20 2020 2020 2020 2066 227b 5052 4f47  .        f"{PROG
+00044810: 5f57 4954 484f 5554 5f45 5854 7d20 7374  _WITHOUT_EXT} st
+00044820: 6179 7320 6163 7469 7665 2c20 7365 6e64  ays active, send
+00044830: 696e 6720 616c 6c20 696e 7075 7420 696e  ing all input in
+00044840: 7374 616e 746c 792e 2022 0a20 2020 2020  stantly. ".     
+00044850: 2020 2022 4966 2079 6f75 2077 616e 7420     "If you want 
+00044860: 746f 2073 656e 6420 7468 6520 6c69 7465  to send the lite
+00044870: 7261 6c20 6c65 7474 6572 2027 5f27 2074  ral letter '_' t
+00044880: 6865 6e20 6573 6361 7065 2069 7420 220a  hen escape it ".
+00044890: 2020 2020 2020 2020 2261 6e64 2073 656e          "and sen
+000448a0: 6420 275c 5c5f 272e 2022 0a20 2020 2020  d '\\_'. ".     
+000448b0: 2020 2022 275f 2720 6361 6e20 6265 2075     "'_' can be u
+000448c0: 7365 6420 6f6e 6c79 206f 6e63 652e 2041  sed only once. A
+000448d0: 6e64 2065 6974 6865 7220 272d 2720 6f72  nd either '-' or
+000448e0: 2027 5f27 2063 616e 2062 6520 7573 6564   '_' can be used
+000448f0: 2e20 222c 0a20 2020 2029 0a20 2020 2023  . ",.    ).    #
+00044900: 2061 6c6c 6f77 206d 756c 7469 706c 6520   allow multiple 
+00044910: 6d65 7373 6167 6573 202c 2065 2e67 2e20  messages , e.g. 
+00044920: 2d69 2022 6931 2e6a 7067 2220 2269 322e  -i "i1.jpg" "i2.
+00044930: 6769 6622 0a20 2020 2023 206f 7220 2d69  gif".    # or -i
+00044940: 2022 6931 2e70 6e67 2220 2d69 2022 6932   "i1.png" -i "i2
+00044950: 2e6a 7065 6722 0a20 2020 2023 2069 6d61  .jpeg".    # ima
+00044960: 6765 2069 7320 676f 696e 6720 746f 2062  ge is going to b
+00044970: 6520 6120 6c69 7374 206f 6620 7374 7269  e a list of stri
+00044980: 6e67 730a 2020 2020 2320 652e 672e 2069  ngs.    # e.g. i
+00044990: 6d61 6765 3d5b 2027 6931 2e6a 7067 272c  mage=[ 'i1.jpg',
+000449a0: 2027 6932 2e70 6e67 2720 5d0a 2020 2020   'i2.png' ].    
+000449b0: 6170 2e61 6464 5f61 7267 756d 656e 7428  ap.add_argument(
+000449c0: 0a20 2020 2020 2020 2022 2d69 222c 0a20  .        "-i",. 
+000449d0: 2020 2020 2020 2022 2d2d 696d 6167 6522         "--image"
+000449e0: 2c0a 2020 2020 2020 2020 7265 7175 6972  ,.        requir
+000449f0: 6564 3d46 616c 7365 2c0a 2020 2020 2020  ed=False,.      
+00044a00: 2020 6163 7469 6f6e 3d22 6578 7465 6e64    action="extend
+00044a10: 222c 0a20 2020 2020 2020 206e 6172 6773  ",.        nargs
+00044a20: 3d22 2b22 2c0a 2020 2020 2020 2020 7479  ="+",.        ty
+00044a30: 7065 3d73 7472 2c0a 2020 2020 2020 2020  pe=str,.        
+00044a40: 6d65 7461 7661 723d 2249 4d41 4745 5f46  metavar="IMAGE_F
+00044a50: 494c 4522 2c0a 2020 2020 2020 2020 6865  ILE",.        he
+00044a60: 6c70 3d22 5365 6e64 206f 6e65 206f 7220  lp="Send one or 
+00044a70: 6d75 6c74 6970 6c65 2069 6d61 6765 2066  multiple image f
+00044a80: 696c 6573 2e20 220a 2020 2020 2020 2020  iles. ".        
+00044a90: 2244 6574 6169 6c73 3a3a 2054 6869 7320  "Details:: This 
+00044aa0: 6f70 7469 6f6e 2063 616e 2062 6520 7573  option can be us
+00044ab0: 6564 206d 756c 7469 706c 6520 7469 6d65  ed multiple time
+00044ac0: 7320 746f 2073 656e 6420 220a 2020 2020  s to send ".    
+00044ad0: 2020 2020 226d 756c 7469 706c 6520 696d      "multiple im
+00044ae0: 6167 6573 2e20 4669 7273 7420 696d 6167  ages. First imag
+00044af0: 6573 2061 7265 2073 656e 742c 2022 0a20  es are sent, ". 
+00044b00: 2020 2020 2020 2022 7468 656e 2074 6578         "then tex
+00044b10: 7420 6d65 7373 6167 6573 2061 7265 2073  t messages are s
+00044b20: 656e 742e 2022 0a20 2020 2020 2020 2066  ent. ".        f
+00044b30: 2249 6620 796f 7520 7761 6e74 2074 6f20  "If you want to 
+00044b40: 6665 6564 2061 6e20 696d 6167 6520 696e  feed an image in
+00044b50: 746f 207b 5052 4f47 5f57 4954 484f 5554  to {PROG_WITHOUT
+00044b60: 5f45 5854 7d20 220a 2020 2020 2020 2020  _EXT} ".        
+00044b70: 2276 6961 2061 2070 6970 652c 2076 6961  "via a pipe, via
+00044b80: 2073 7464 696e 2c20 7468 656e 2073 7065   stdin, then spe
+00044b90: 6369 6679 2074 6865 2073 7065 6369 616c  cify the special
+00044ba0: 2022 0a20 2020 2020 2020 2022 6368 6172   ".        "char
+00044bb0: 6163 7465 7220 272d 272e 2049 6620 272d  acter '-'. If '-
+00044bc0: 2720 6973 2073 7065 6369 6669 6564 2061  ' is specified a
+00044bd0: 7320 696d 6167 6520 6669 6c65 206e 616d  s image file nam
+00044be0: 652c 2022 0a20 2020 2020 2020 2022 7468  e, ".        "th
+00044bf0: 656e 2074 6865 2070 726f 6772 616d 2077  en the program w
+00044c00: 696c 6c20 7265 6164 2074 6865 2069 6d61  ill read the ima
+00044c10: 6765 2064 6174 6120 6672 6f6d 2073 7464  ge data from std
+00044c20: 696e 2e20 220a 2020 2020 2020 2020 2249  in. ".        "I
+00044c30: 6620 796f 7572 2069 6d61 6765 2066 696c  f your image fil
+00044c40: 6520 6973 206c 6974 6572 616c 6c79 206e  e is literally n
+00044c50: 616d 6564 2027 2d27 2074 6865 6e20 7573  amed '-' then us
+00044c60: 6520 275c 5c2d 2720 220a 2020 2020 2020  e '\\-' ".      
+00044c70: 2020 2261 7320 6669 6c65 206e 616d 6520    "as file name 
+00044c80: 696e 2074 6865 2061 7267 756d 656e 742e  in the argument.
+00044c90: 2022 0a20 2020 2020 2020 2022 272d 2720   ".        "'-' 
+00044ca0: 6d61 7920 6170 7065 6172 2069 6e20 616e  may appear in an
+00044cb0: 7920 706f 7369 7469 6f6e 2c20 692e 652e  y position, i.e.
+00044cc0: 2027 2d69 2069 6d61 6765 312e 6a70 6720   '-i image1.jpg 
+00044cd0: 2d20 696d 6167 6533 2e70 6e67 2720 220a  - image3.png' ".
+00044ce0: 2020 2020 2020 2020 2277 696c 6c20 7365          "will se
+00044cf0: 6e64 2033 2069 6d61 6765 7320 6f75 7420  nd 3 images out 
+00044d00: 6f66 2077 6869 6368 2074 6865 2073 6563  of which the sec
+00044d10: 6f6e 6420 6f6e 6520 6973 2072 6561 6420  ond one is read 
+00044d20: 6672 6f6d 2073 7464 696e 2e20 220a 2020  from stdin. ".  
+00044d30: 2020 2020 2020 2227 2d27 206d 6179 2061        "'-' may a
+00044d40: 7070 6561 7220 6f6e 6c79 206f 6e63 6520  ppear only once 
+00044d50: 6f76 6572 616c 6c20 696e 2061 6c6c 2061  overall in all a
+00044d60: 7267 756d 656e 7473 2e20 220a 2020 2020  rguments. ".    
+00044d70: 2020 2020 2249 6620 7468 6520 6669 6c65      "If the file
+00044d80: 2065 7869 7374 7320 616c 7265 6164 792c   exists already,
+00044d90: 2069 7420 6973 206d 6f72 6520 6566 6669   it is more effi
+00044da0: 6369 656e 7420 746f 2073 7065 6369 6679  cient to specify
+00044db0: 2074 6865 2022 0a20 2020 2020 2020 2022   the ".        "
+00044dc0: 6669 6c65 206e 616d 6520 7468 616e 2074  file name than t
+00044dd0: 6f20 7069 7065 2074 6865 2066 696c 6520  o pipe the file 
+00044de0: 7468 726f 7567 6820 7374 6469 6e2e 222c  through stdin.",
+00044df0: 0a20 2020 2029 0a20 2020 2023 2061 6c6c  .    ).    # all
+00044e00: 6f77 206d 756c 7469 706c 6520 6175 6469  ow multiple audi
+00044e10: 6f20 6669 6c65 7320 2c20 652e 672e 202d  o files , e.g. -
+00044e20: 6920 2261 312e 6d70 3322 2022 6132 2e77  i "a1.mp3" "a2.w
+00044e30: 6176 220a 2020 2020 2320 6f72 202d 6920  av".    # or -i 
+00044e40: 2261 312e 6d70 3322 202d 6920 2261 322e  "a1.mp3" -i "a2.
+00044e50: 6d34 6122 0a20 2020 2023 2061 7564 696f  m4a".    # audio
+00044e60: 2069 7320 676f 696e 6720 746f 2062 6520   is going to be 
+00044e70: 6120 6c69 7374 206f 6620 7374 7269 6e67  a list of string
+00044e80: 730a 2020 2020 2320 652e 672e 2061 7564  s.    # e.g. aud
+00044e90: 696f 3d5b 2027 6131 2e6d 7033 272c 2027  io=[ 'a1.mp3', '
+00044ea0: 6132 2e6d 3461 2720 5d0a 2020 2020 6170  a2.m4a' ].    ap
+00044eb0: 2e61 6464 5f61 7267 756d 656e 7428 0a20  .add_argument(. 
+00044ec0: 2020 2020 2020 2022 2d61 222c 0a20 2020         "-a",.   
+00044ed0: 2020 2020 2022 2d2d 6175 6469 6f22 2c0a       "--audio",.
+00044ee0: 2020 2020 2020 2020 7265 7175 6972 6564          required
+00044ef0: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+00044f00: 6163 7469 6f6e 3d22 6578 7465 6e64 222c  action="extend",
+00044f10: 0a20 2020 2020 2020 206e 6172 6773 3d22  .        nargs="
+00044f20: 2b22 2c0a 2020 2020 2020 2020 7479 7065  +",.        type
+00044f30: 3d73 7472 2c0a 2020 2020 2020 2020 6d65  =str,.        me
+00044f40: 7461 7661 723d 2241 5544 494f 5f46 494c  tavar="AUDIO_FIL
+00044f50: 4522 2c0a 2020 2020 2020 2020 6865 6c70  E",.        help
+00044f60: 3d22 5365 6e64 206f 6e65 206f 7220 6d75  ="Send one or mu
+00044f70: 6c74 6970 6c65 2061 7564 696f 2066 696c  ltiple audio fil
+00044f80: 6573 2e20 220a 2020 2020 2020 2020 2244  es. ".        "D
+00044f90: 6574 6169 6c73 3a3a 2054 6869 7320 6f70  etails:: This op
+00044fa0: 7469 6f6e 2063 616e 2062 6520 7573 6564  tion can be used
+00044fb0: 206d 756c 7469 706c 6520 7469 6d65 7320   multiple times 
+00044fc0: 746f 2073 656e 6420 220a 2020 2020 2020  to send ".      
+00044fd0: 2020 226d 756c 7469 706c 6520 6175 6469    "multiple audi
+00044fe0: 6f20 6669 6c65 732e 2046 6972 7374 2061  o files. First a
+00044ff0: 7564 696f 7320 6172 6520 7365 6e74 2c20  udios are sent, 
+00045000: 220a 2020 2020 2020 2020 2274 6865 6e20  ".        "then 
+00045010: 7465 7874 206d 6573 7361 6765 7320 6172  text messages ar
+00045020: 6520 7365 6e74 2e20 220a 2020 2020 2020  e sent. ".      
+00045030: 2020 6622 4966 2079 6f75 2077 616e 7420    f"If you want 
+00045040: 746f 2066 6565 6420 616e 2061 7564 696f  to feed an audio
+00045050: 2069 6e74 6f20 7b50 524f 475f 5749 5448   into {PROG_WITH
+00045060: 4f55 545f 4558 547d 2022 0a20 2020 2020  OUT_EXT} ".     
+00045070: 2020 2022 7669 6120 6120 7069 7065 2c20     "via a pipe, 
+00045080: 7669 6120 7374 6469 6e2c 2074 6865 6e20  via stdin, then 
+00045090: 7370 6563 6966 7920 7468 6520 7370 6563  specify the spec
+000450a0: 6961 6c20 220a 2020 2020 2020 2020 2263  ial ".        "c
+000450b0: 6861 7261 6374 6572 2027 2d27 2e20 5365  haracter '-'. Se
+000450c0: 6520 6465 7363 7269 7074 696f 6e20 6f66  e description of
+000450d0: 2027 2d69 2720 746f 2073 6565 2068 6f77   '-i' to see how
+000450e0: 2027 2d27 2069 7320 6861 6e64 6c65 642e   '-' is handled.
+000450f0: 222c 0a20 2020 2029 0a20 2020 2023 2061  ",.    ).    # a
+00045100: 6c6c 6f77 206d 756c 7469 706c 6520 6669  llow multiple fi
+00045110: 6c65 7320 2c20 652e 672e 202d 6620 2261  les , e.g. -f "a
+00045120: 312e 7064 6622 2022 6132 2e64 6f63 220a  1.pdf" "a2.doc".
+00045130: 2020 2020 2320 6f72 202d 6620 2261 312e      # or -f "a1.
+00045140: 7064 6622 202d 6620 2261 322e 646f 6322  pdf" -f "a2.doc"
+00045150: 0a20 2020 2023 2066 696c 6520 6973 2067  .    # file is g
+00045160: 6f69 6e67 2074 6f20 6265 2061 206c 6973  oing to be a lis
+00045170: 7420 6f66 2073 7472 696e 6773 0a20 2020  t of strings.   
+00045180: 2023 2065 2e67 2e20 6669 6c65 3d5b 2027   # e.g. file=[ '
+00045190: 6131 2e70 6466 272c 2027 6132 2e64 6f63  a1.pdf', 'a2.doc
+000451a0: 2720 5d0a 2020 2020 6170 2e61 6464 5f61  ' ].    ap.add_a
+000451b0: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
+000451c0: 2022 2d66 222c 0a20 2020 2020 2020 2022   "-f",.        "
+000451d0: 2d2d 6669 6c65 222c 0a20 2020 2020 2020  --file",.       
+000451e0: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
+000451f0: 0a20 2020 2020 2020 2061 6374 696f 6e3d  .        action=
+00045200: 2265 7874 656e 6422 2c0a 2020 2020 2020  "extend",.      
+00045210: 2020 6e61 7267 733d 222b 222c 0a20 2020    nargs="+",.   
+00045220: 2020 2020 2074 7970 653d 7374 722c 0a20       type=str,. 
+00045230: 2020 2020 2020 206d 6574 6176 6172 3d22         metavar="
+00045240: 4649 4c45 222c 0a20 2020 2020 2020 2068  FILE",.        h
+00045250: 656c 703d 2253 656e 6420 6f6e 6520 6f72  elp="Send one or
+00045260: 206d 756c 7469 706c 6520 6669 6c65 7320   multiple files 
+00045270: 2865 2e67 2e20 5044 462c 2044 4f43 2c20  (e.g. PDF, DOC, 
+00045280: 4d50 3429 2e20 220a 2020 2020 2020 2020  MP4). ".        
+00045290: 2244 6574 6169 6c73 3a3a 2054 6869 7320  "Details:: This 
+000452a0: 6f70 7469 6f6e 2063 616e 2062 6520 7573  option can be us
+000452b0: 6564 206d 756c 7469 706c 6520 7469 6d65  ed multiple time
+000452c0: 7320 746f 2073 656e 6420 220a 2020 2020  s to send ".    
+000452d0: 2020 2020 226d 756c 7469 706c 6520 6669      "multiple fi
+000452e0: 6c65 732e 2046 6972 7374 2066 696c 6573  les. First files
+000452f0: 2061 7265 2073 656e 742c 2022 0a20 2020   are sent, ".   
+00045300: 2020 2020 2022 7468 656e 2074 6578 7420       "then text 
+00045310: 6d65 7373 6167 6573 2061 7265 2073 656e  messages are sen
+00045320: 742e 2022 0a20 2020 2020 2020 2066 2249  t. ".        f"I
+00045330: 6620 796f 7520 7761 6e74 2074 6f20 6665  f you want to fe
+00045340: 6564 2061 2066 696c 6520 696e 746f 207b  ed a file into {
+00045350: 5052 4f47 5f57 4954 484f 5554 5f45 5854  PROG_WITHOUT_EXT
+00045360: 7d20 220a 2020 2020 2020 2020 2276 6961  } ".        "via
+00045370: 2061 2070 6970 652c 2076 6961 2073 7464   a pipe, via std
+00045380: 696e 2c20 7468 656e 2073 7065 6369 6679  in, then specify
+00045390: 2074 6865 2073 7065 6369 616c 2022 0a20   the special ". 
+000453a0: 2020 2020 2020 2022 6368 6172 6163 7465         "characte
+000453b0: 7220 272d 272e 2053 6565 2064 6573 6372  r '-'. See descr
+000453c0: 6970 7469 6f6e 206f 6620 272d 6927 2074  iption of '-i' t
+000453d0: 6f20 7365 6520 686f 7720 272d 2720 6973  o see how '-' is
+000453e0: 2068 616e 646c 6564 2e22 2c0a 2020 2020   handled.",.    
+000453f0: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
+00045400: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
+00045410: 2d65 222c 0a20 2020 2020 2020 2022 2d2d  -e",.        "--
+00045420: 6576 656e 7422 2c0a 2020 2020 2020 2020  event",.        
+00045430: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
+00045440: 2020 2020 2020 2020 6163 7469 6f6e 3d22          action="
+00045450: 6578 7465 6e64 222c 0a20 2020 2020 2020  extend",.       
+00045460: 206e 6172 6773 3d22 2b22 2c0a 2020 2020   nargs="+",.    
+00045470: 2020 2020 7479 7065 3d73 7472 2c0a 2020      type=str,.  
+00045480: 2020 2020 2020 6d65 7461 7661 723d 224d        metavar="M
+00045490: 4154 5249 585f 4a53 4f4e 5f4f 424a 4543  ATRIX_JSON_OBJEC
+000454a0: 5422 2c0a 2020 2020 2020 2020 6865 6c70  T",.        help
+000454b0: 3d22 5365 6e64 2061 204d 6174 7269 7820  ="Send a Matrix 
+000454c0: 4a53 4f4e 2065 7665 6e74 2e20 220a 2020  JSON event. ".  
+000454d0: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
+000454e0: 2053 656e 6420 616e 2065 7665 6e74 2074   Send an event t
+000454f0: 6861 7420 6973 2066 6f72 6d61 7474 6564  hat is formatted
+00045500: 2061 7320 6120 4a53 4f4e 206f 626a 6563   as a JSON objec
+00045510: 7420 6173 2022 0a20 2020 2020 2020 2022  t as ".        "
+00045520: 7370 6563 6966 6965 6420 6279 2074 6865  specified by the
+00045530: 204d 6174 7269 7820 7072 6f74 6f63 6f6c   Matrix protocol
+00045540: 2e20 5468 6973 2061 6c6c 6f77 7320 7468  . This allows th
+00045550: 6520 6164 7661 6e63 6564 2022 0a20 2020  e advanced ".   
+00045560: 2020 2020 2022 7573 6572 2074 6f20 7365       "user to se
+00045570: 6e64 2061 6464 6974 696f 6e61 6c20 7479  nd additional ty
+00045580: 7065 7320 6f66 2065 7665 6e74 7320 7375  pes of events su
+00045590: 6368 2061 7320 7265 6163 7469 6f6e 732c  ch as reactions,
+000455a0: 2022 0a20 2020 2020 2020 2022 7365 6e64   ".        "send
+000455b0: 2072 6570 6c69 6573 2074 6f20 7072 6576   replies to prev
+000455c0: 696f 7573 2065 7665 6e74 732c 206f 7220  ious events, or 
+000455d0: 6564 6974 2070 7265 7669 6f75 7320 6d65  edit previous me
+000455e0: 7373 6167 6573 2e20 220a 2020 2020 2020  ssages. ".      
+000455f0: 2020 2253 7065 6369 6669 6361 7469 6f6e    "Specification
+00045600: 7320 666f 7220 6576 656e 7473 2063 616e  s for events can
+00045610: 2062 6520 666f 756e 6420 220a 2020 2020   be found ".    
+00045620: 2020 2020 2261 7420 6874 7470 733a 2f2f      "at https://
+00045630: 7370 6563 2e6d 6174 7269 782e 6f72 672f  spec.matrix.org/
+00045640: 756e 7374 6162 6c65 2f70 726f 706f 7361  unstable/proposa
+00045650: 6c73 2f2e 2022 0a20 2020 2020 2020 2022  ls/. ".        "
+00045660: 5468 6973 206f 7074 696f 6e20 6361 6e20  This option can 
+00045670: 6265 2075 7365 6420 6d75 6c74 6970 6c65  be used multiple
+00045680: 2074 696d 6573 2074 6f20 7365 6e64 2022   times to send "
+00045690: 0a20 2020 2020 2020 2022 6d75 6c74 6970  .        "multip
+000456a0: 6c65 2065 7665 6e74 732e 2046 6972 7374  le events. First
+000456b0: 2065 7665 6e74 7320 6172 6520 7365 6e74   events are sent
+000456c0: 2c20 220a 2020 2020 2020 2020 2274 6865  , ".        "the
+000456d0: 6e20 7465 7874 206d 6573 7361 6765 7320  n text messages 
+000456e0: 6172 6520 7365 6e74 2e20 220a 2020 2020  are sent. ".    
+000456f0: 2020 2020 6622 4966 2079 6f75 2077 616e      f"If you wan
+00045700: 7420 746f 2066 6565 6420 616e 2065 7665  t to feed an eve
+00045710: 6e74 2069 6e74 6f20 7b50 524f 475f 5749  nt into {PROG_WI
+00045720: 5448 4f55 545f 4558 547d 2022 0a20 2020  THOUT_EXT} ".   
+00045730: 2020 2020 2022 7669 6120 6120 7069 7065       "via a pipe
+00045740: 2c20 7669 6120 7374 6469 6e2c 2074 6865  , via stdin, the
+00045750: 6e20 7370 6563 6966 7920 7468 6520 7370  n specify the sp
+00045760: 6563 6961 6c20 220a 2020 2020 2020 2020  ecial ".        
+00045770: 2263 6861 7261 6374 6572 2027 2d27 2e20  "character '-'. 
+00045780: 5365 6520 6465 7363 7269 7074 696f 6e20  See description 
+00045790: 6f66 2027 2d69 2720 746f 2073 6565 2068  of '-i' to see h
+000457a0: 6f77 2027 2d27 2069 7320 6861 6e64 6c65  ow '-' is handle
+000457b0: 642e 2022 0a20 2020 2020 2020 2022 5365  d. ".        "Se
+000457c0: 6520 7465 7374 732f 7465 7374 2d65 7665  e tests/test-eve
+000457d0: 6e74 2e73 6820 666f 7220 6578 616d 706c  nt.sh for exampl
+000457e0: 6573 2e22 2c0a 2020 2020 290a 2020 2020  es.",.    ).    
+000457f0: 2320 2d68 2061 6c72 6561 6479 2075 7365  # -h already use
+00045800: 6420 666f 7220 2d2d 6865 6c70 2c20 2d77  d for --help, -w
+00045810: 2066 6f72 2022 7765 6222 0a20 2020 2061   for "web".    a
+00045820: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
+00045830: 2020 2020 2020 2020 222d 7722 2c0a 2020          "-w",.  
+00045840: 2020 2020 2020 222d 2d68 746d 6c22 2c0a        "--html",.
+00045850: 2020 2020 2020 2020 7265 7175 6972 6564          required
+00045860: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+00045870: 6163 7469 6f6e 3d22 7374 6f72 655f 7472  action="store_tr
+00045880: 7565 222c 0a20 2020 2020 2020 2068 656c  ue",.        hel
+00045890: 703d 2753 656e 6420 6d65 7373 6167 6520  p='Send message 
+000458a0: 6173 2066 6f72 6d61 7420 2248 544d 4c22  as format "HTML"
+000458b0: 2e20 270a 2020 2020 2020 2020 2244 6574  . '.        "Det
+000458c0: 6169 6c73 3a3a 2049 6620 6e6f 7420 7370  ails:: If not sp
+000458d0: 6563 6966 6965 642c 206d 6573 7361 6765  ecified, message
+000458e0: 2077 696c 6c20 6265 2073 656e 7420 220a   will be sent ".
+000458f0: 2020 2020 2020 2020 2761 7320 666f 726d          'as form
+00045900: 6174 2022 5445 5854 222e 2045 2e67 2e20  at "TEXT". E.g. 
+00045910: 7468 6174 2061 6c6c 6f77 7320 736f 6d65  that allows some
+00045920: 2074 6578 7420 270a 2020 2020 2020 2020   text '.        
+00045930: 2274 6f20 6265 2062 6f6c 642c 2065 7463  "to be bold, etc
+00045940: 2e20 4f6e 6c79 2061 2073 7562 7365 7420  . Only a subset 
+00045950: 6f66 2048 544d 4c20 7461 6773 2061 7265  of HTML tags are
+00045960: 2022 0a20 2020 2020 2020 2022 6163 6365   ".        "acce
+00045970: 7074 6564 2062 7920 4d61 7472 6978 2e22  pted by Matrix."
+00045980: 2c0a 2020 2020 290a 2020 2020 2320 2d6d  ,.    ).    # -m
+00045990: 2061 6c72 6561 6479 2075 7365 6420 666f   already used fo
+000459a0: 7220 2d2d 6d65 7373 6167 652c 202d 7a20  r --message, -z 
+000459b0: 6265 6361 7573 6520 7468 6572 6520 7765  because there we
+000459c0: 7265 206e 6f20 6c65 7474 6572 7320 6c65  re no letters le
+000459d0: 6674 0a20 2020 2061 702e 6164 645f 6172  ft.    ap.add_ar
+000459e0: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
+000459f0: 222d 7a22 2c0a 2020 2020 2020 2020 222d  "-z",.        "-
+00045a00: 2d6d 6172 6b64 6f77 6e22 2c0a 2020 2020  -markdown",.    
+00045a10: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
+00045a20: 7365 2c0a 2020 2020 2020 2020 6163 7469  se,.        acti
+00045a30: 6f6e 3d22 7374 6f72 655f 7472 7565 222c  on="store_true",
+00045a40: 0a20 2020 2020 2020 2068 656c 703d 2753  .        help='S
+00045a50: 656e 6420 6d65 7373 6167 6520 6173 2066  end message as f
+00045a60: 6f72 6d61 7420 224d 4152 4b44 4f57 4e22  ormat "MARKDOWN"
+00045a70: 2e20 270a 2020 2020 2020 2020 2244 6574  . '.        "Det
+00045a80: 6169 6c73 3a3a 2049 6620 6e6f 7420 7370  ails:: If not sp
+00045a90: 6563 6966 6965 642c 206d 6573 7361 6765  ecified, message
+00045aa0: 2077 696c 6c20 6265 2073 656e 7420 220a   will be sent ".
+00045ab0: 2020 2020 2020 2020 2761 7320 666f 726d          'as form
+00045ac0: 6174 2022 5445 5854 222e 2045 2e67 2e20  at "TEXT". E.g. 
+00045ad0: 7468 6174 2061 6c6c 6f77 7320 7365 6e64  that allows send
+00045ae0: 696e 6720 6f66 2074 6578 7420 270a 2020  ing of text '.  
+00045af0: 2020 2020 2020 2266 6f72 6d61 7474 6564        "formatted
+00045b00: 2069 6e20 4d61 726b 446f 776e 206c 616e   in MarkDown lan
+00045b10: 6775 6167 652e 222c 0a20 2020 2029 0a20  guage.",.    ). 
+00045b20: 2020 2023 2020 2d63 2069 7320 616c 7265     #  -c is alre
+00045b30: 6164 7920 7573 6564 2066 6f72 202d 2d63  ady used for --c
+00045b40: 7265 6465 6e74 6961 6c73 2c20 2d6b 2061  redentials, -k a
+00045b50: 7320 6974 2073 6f75 6e64 7320 6c69 6b65  s it sounds like
+00045b60: 2063 0a20 2020 2061 702e 6164 645f 6172   c.    ap.add_ar
+00045b70: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
+00045b80: 222d 6b22 2c0a 2020 2020 2020 2020 222d  "-k",.        "-
+00045b90: 2d63 6f64 6522 2c0a 2020 2020 2020 2020  -code",.        
+00045ba0: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
+00045bb0: 2020 2020 2020 2020 6163 7469 6f6e 3d22          action="
+00045bc0: 7374 6f72 655f 7472 7565 222c 0a20 2020  store_true",.   
+00045bd0: 2020 2020 2068 656c 703d 2753 656e 6420       help='Send 
+00045be0: 6d65 7373 6167 6520 6173 2066 6f72 6d61  message as forma
+00045bf0: 7420 2243 4f44 4522 2e20 270a 2020 2020  t "CODE". '.    
+00045c00: 2020 2020 2244 6574 6169 6c73 3a3a 2049      "Details:: I
+00045c10: 6620 6e6f 7420 7370 6563 6966 6965 642c  f not specified,
+00045c20: 206d 6573 7361 6765 2077 696c 6c20 6265   message will be
+00045c30: 2073 656e 7420 220a 2020 2020 2020 2020   sent ".        
+00045c40: 2761 7320 666f 726d 6174 2022 5445 5854  'as format "TEXT
+00045c50: 222e 2049 6620 626f 7468 202d 2d68 746d  ". If both --htm
+00045c60: 6c20 616e 6420 2d2d 636f 6465 2061 7265  l and --code are
+00045c70: 2027 0a20 2020 2020 2020 2022 7370 6563   '.        "spec
+00045c80: 6966 6965 6420 7468 656e 202d 2d63 6f64  ified then --cod
+00045c90: 6520 7461 6b65 7320 7072 696f 7269 7479  e takes priority
+00045ca0: 2e20 5468 6973 2069 7320 220a 2020 2020  . This is ".    
+00045cb0: 2020 2020 2275 7365 6675 6c20 666f 7220      "useful for 
+00045cc0: 7365 6e64 696e 6720 4153 4349 492d 6172  sending ASCII-ar
+00045cd0: 7420 6f72 2074 6162 6265 6420 6f75 7470  t or tabbed outp
+00045ce0: 7574 2022 0a20 2020 2020 2020 2022 6c69  ut ".        "li
+00045cf0: 6b65 2074 6162 6c65 7320 6173 2061 2066  ke tables as a f
+00045d00: 6978 6564 2d73 697a 6564 2066 6f6e 7420  ixed-sized font 
+00045d10: 7769 6c6c 2062 6520 7573 6564 2022 0a20  will be used ". 
+00045d20: 2020 2020 2020 2022 666f 7220 6469 7370         "for disp
+00045d30: 6c61 792e 222c 0a20 2020 2029 0a20 2020  lay.",.    ).   
+00045d40: 2023 2020 2d6a 2066 6f72 2065 6d6f 4a69   #  -j for emoJi
+00045d50: 7a65 0a20 2020 2061 702e 6164 645f 6172  ze.    ap.add_ar
+00045d60: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
+00045d70: 222d 6a22 2c0a 2020 2020 2020 2020 222d  "-j",.        "-
+00045d80: 2d65 6d6f 6a69 7a65 222c 0a20 2020 2020  -emojize",.     
+00045d90: 2020 2072 6571 7569 7265 643d 4661 6c73     required=Fals
+00045da0: 652c 0a20 2020 2020 2020 2061 6374 696f  e,.        actio
+00045db0: 6e3d 2273 746f 7265 5f74 7275 6522 2c0a  n="store_true",.
+00045dc0: 2020 2020 2020 2020 6865 6c70 3d27 5365          help='Se
+00045dd0: 6e64 206d 6573 7361 6765 2061 6674 6572  nd message after
+00045de0: 2065 6d6f 6a69 7a69 6e67 2e20 270a 2020   emojizing. '.  
+00045df0: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
+00045e00: 2049 6620 6e6f 7420 7370 6563 6966 6965   If not specifie
+00045e10: 642c 206d 6573 7361 6765 2077 696c 6c20  d, message will 
+00045e20: 6265 2073 656e 7420 220a 2020 2020 2020  be sent ".      
+00045e30: 2020 2761 7320 666f 726d 6174 2022 5445    'as format "TE
+00045e40: 5854 222e 2049 6620 626f 7468 202d 2d63  XT". If both --c
+00045e50: 6f64 6520 616e 6420 2d2d 656d 6f6a 697a  ode and --emojiz
+00045e60: 6520 6172 6520 270a 2020 2020 2020 2020  e are '.        
+00045e70: 2273 7065 6369 6669 6564 2074 6865 6e20  "specified then 
+00045e80: 2d2d 636f 6465 2074 616b 6573 2070 7269  --code takes pri
+00045e90: 6f72 6974 792e 2054 6869 7320 6973 2022  ority. This is "
+00045ea0: 0a20 2020 2020 2020 2022 7573 6566 756c  .        "useful
+00045eb0: 2066 6f72 2073 656e 6469 6e67 2065 6d6f   for sending emo
+00045ec0: 6a69 7320 696e 2073 686f 7274 636f 6465  jis in shortcode
+00045ed0: 2066 6f72 6d20 3a63 6f6c 6c69 7369 6f6e   form :collision
+00045ee0: 3a2e 222c 0a20 2020 2029 0a0a 2020 2020  :.",.    )..    
+00045ef0: 2320 2d73 2069 7320 616c 7265 6164 7920  # -s is already 
+00045f00: 7573 6564 2066 6f72 202d 2d73 746f 7265  used for --store
+00045f10: 2c20 2d69 2066 6f72 2073 506c 6974 0a20  , -i for sPlit. 
+00045f20: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
+00045f30: 6e74 280a 2020 2020 2020 2020 222d 7022  nt(.        "-p"
+00045f40: 2c0a 2020 2020 2020 2020 222d 2d73 706c  ,.        "--spl
+00045f50: 6974 222c 0a20 2020 2020 2020 2072 6571  it",.        req
+00045f60: 7569 7265 643d 4661 6c73 652c 0a20 2020  uired=False,.   
+00045f70: 2020 2020 2074 7970 653d 7374 722c 0a20       type=str,. 
+00045f80: 2020 2020 2020 206d 6574 6176 6172 3d22         metavar="
+00045f90: 5345 5041 5241 544f 5222 2c0a 2020 2020  SEPARATOR",.    
+00045fa0: 2020 2020 6865 6c70 3d22 5370 6c69 7420      help="Split 
+00045fb0: 6d65 7373 6167 6520 7465 7874 2069 6e74  message text int
+00045fc0: 6f20 6d75 6c74 6970 6c65 204d 6174 7269  o multiple Matri
+00045fd0: 7820 6d65 7373 6167 6573 2e20 220a 2020  x messages. ".  
+00045fe0: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
+00045ff0: 2049 6620 7365 742c 2073 706c 6974 2074   If set, split t
+00046000: 6865 206d 6573 7361 6765 2873 2920 696e  he message(s) in
+00046010: 746f 206d 756c 7469 706c 6520 6d65 7373  to multiple mess
+00046020: 6167 6573 2022 0a20 2020 2020 2020 2022  ages ".        "
+00046030: 7768 6572 6576 6572 2074 6865 2073 7472  wherever the str
+00046040: 696e 6720 7370 6563 6966 6965 6420 7769  ing specified wi
+00046050: 7468 202d 2d73 706c 6974 206f 6363 7572  th --split occur
+00046060: 732e 2022 0a20 2020 2020 2020 2022 452e  s. ".        "E.
+00046070: 672e 204f 6e65 2070 6970 6573 2061 2073  g. One pipes a s
+00046080: 7472 6561 6d20 6f66 2052 5353 2061 7274  tream of RSS art
+00046090: 6963 6c65 7320 696e 746f 2074 6865 2022  icles into the "
+000460a0: 0a20 2020 2020 2020 2022 7072 6f67 7261  .        "progra
+000460b0: 6d20 616e 6420 7468 6520 6172 7469 636c  m and the articl
+000460c0: 6573 2061 7265 2073 6570 6172 6174 6564  es are separated
+000460d0: 2062 7920 7468 7265 6520 220a 2020 2020   by three ".    
+000460e0: 2020 2020 226e 6577 6c69 6e65 732e 2022      "newlines. "
+000460f0: 0a20 2020 2020 2020 2027 5468 656e 2077  .        'Then w
+00046100: 6974 6820 2d2d 7370 6c69 7420 7365 7420  ith --split set 
+00046110: 746f 2022 5c5c 6e5c 5c6e 5c5c 6e22 2065  to "\\n\\n\\n" e
+00046120: 6163 6820 6172 7469 636c 6520 270a 2020  ach article '.  
+00046130: 2020 2020 2020 2277 696c 6c20 6265 2070        "will be p
+00046140: 7269 6e74 6564 2069 6e20 6120 7365 7061  rinted in a sepa
+00046150: 7261 7465 206d 6573 7361 6765 2e20 220a  rate message. ".
+00046160: 2020 2020 2020 2020 2242 7920 6465 6661          "By defa
+00046170: 756c 742c 2069 2e65 2e20 6966 206e 6f74  ult, i.e. if not
+00046180: 2073 6574 2c20 6e6f 206d 6573 7361 6765   set, no message
+00046190: 7320 7769 6c6c 2062 6520 7370 6c69 742e  s will be split.
+000461a0: 222c 0a20 2020 2029 0a20 2020 2023 202d  ",.    ).    # -
+000461b0: 6320 6973 2061 6c72 6561 6479 2075 7365  c is already use
+000461c0: 6420 666f 7220 2d2d 6372 6564 656e 7469  d for --credenti
+000461d0: 616c 730a 2020 2020 6170 2e61 6464 5f61  als.    ap.add_a
+000461e0: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
+000461f0: 2022 2d2d 636f 6e66 6967 222c 0a20 2020   "--config",.   
+00046200: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
+00046210: 6c73 652c 0a20 2020 2020 2020 2074 7970  lse,.        typ
+00046220: 653d 7374 722c 0a20 2020 2020 2020 206d  e=str,.        m
+00046230: 6574 6176 6172 3d22 434f 4e46 4947 5f46  etavar="CONFIG_F
+00046240: 494c 4522 2c0a 2020 2020 2020 2020 6865  ILE",.        he
+00046250: 6c70 3d22 5370 6563 6966 7920 7468 6520  lp="Specify the 
+00046260: 6c6f 6361 7469 6f6e 206f 6620 6120 636f  location of a co
+00046270: 6e66 6967 2066 696c 652e 2022 0a20 2020  nfig file. ".   
+00046280: 2020 2020 2022 4465 7461 696c 733a 3a20       "Details:: 
+00046290: 4279 2064 6566 6175 6c74 2c20 6e6f 2022  By default, no "
+000462a0: 0a20 2020 2020 2020 2022 636f 6e66 6967  .        "config
+000462b0: 2066 696c 6520 6973 2075 7365 642e 2022   file is used. "
+000462c0: 0a20 2020 2020 2020 2022 4966 2074 6869  .        "If thi
+000462d0: 7320 6f70 7469 6f6e 2069 7320 7072 6f76  s option is prov
+000462e0: 6964 6564 2c20 7468 6520 7072 6f76 6964  ided, the provid
+000462f0: 6564 2066 696c 6520 6e61 6d65 2022 0a20  ed file name ". 
+00046300: 2020 2020 2020 2022 7769 6c6c 2062 6520         "will be 
+00046310: 7573 6564 2074 6f20 7265 6164 2063 6f6e  used to read con
+00046320: 6669 6775 7261 7469 6f6e 2066 726f 6d2e  figuration from.
+00046330: 204e 6f74 2069 6d70 6c65 6d65 6e74 6564   Not implemented
+00046340: 2e22 2c0a 2020 2020 290a 2020 2020 2320  .",.    ).    # 
+00046350: 2d70 2069 7320 616c 7265 6164 7920 7573  -p is already us
+00046360: 6564 2066 6f72 202d 2d73 706c 6974 0a20  ed for --split. 
+00046370: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
+00046380: 6e74 280a 2020 2020 2020 2020 222d 2d70  nt(.        "--p
+00046390: 726f 7879 222c 0a20 2020 2020 2020 2072  roxy",.        r
+000463a0: 6571 7569 7265 643d 4661 6c73 652c 0a20  equired=False,. 
+000463b0: 2020 2020 2020 2074 7970 653d 7374 722c         type=str,
+000463c0: 0a20 2020 2020 2020 206d 6574 6176 6172  .        metavar
+000463d0: 3d22 5052 4f58 5922 2c0a 2020 2020 2020  ="PROXY",.      
+000463e0: 2020 6865 6c70 3d22 5370 6563 6966 7920    help="Specify 
+000463f0: 6120 7072 6f78 7920 666f 7220 636f 6e6e  a proxy for conn
+00046400: 6563 7469 7669 7479 2e20 220a 2020 2020  ectivity. ".    
+00046410: 2020 2020 2244 6574 6169 6c73 3a3a 2042      "Details:: B
+00046420: 7920 6465 6661 756c 742c 2022 0a20 2020  y default, ".   
+00046430: 2020 2020 2022 692e 652e 2069 6620 7468       "i.e. if th
+00046440: 6973 206f 7074 696f 6e20 6973 206e 6f74  is option is not
+00046450: 2073 6574 2c20 6e6f 2070 726f 7879 2069   set, no proxy i
+00046460: 7320 7573 6564 2e20 220a 2020 2020 2020  s used. ".      
+00046470: 2020 2249 6620 7468 6973 206f 7074 696f    "If this optio
+00046480: 6e20 6973 2075 7365 6420 6120 7072 6f78  n is used a prox
+00046490: 7920 5552 4c20 6d75 7374 2062 6520 7072  y URL must be pr
+000464a0: 6f76 6964 6564 2e20 220a 2020 2020 2020  ovided. ".      
+000464b0: 2020 2254 6865 2070 726f 7669 6465 6420    "The provided 
+000464c0: 7072 6f78 7920 5552 4c20 220a 2020 2020  proxy URL ".    
+000464d0: 2020 2020 2277 696c 6c20 6265 2075 7365      "will be use
+000464e0: 6420 666f 7220 7468 6520 4854 5450 2063  d for the HTTP c
+000464f0: 6f6e 6e65 6374 696f 6e20 746f 2074 6865  onnection to the
+00046500: 2073 6572 7665 722e 2022 0a20 2020 2020   server. ".     
+00046510: 2020 2022 5468 6520 7072 6f78 7920 7375     "The proxy su
+00046520: 7070 6f72 7473 2053 4f43 4b53 3428 6129  pports SOCKS4(a)
+00046530: 2c20 534f 434b 5335 2c20 616e 6420 4854  , SOCKS5, and HT
+00046540: 5450 2028 7475 6e6e 656c 696e 6729 2e20  TP (tunneling). 
+00046550: 220a 2020 2020 2020 2020 2745 7861 6d70  ".        'Examp
+00046560: 6c65 7320 6f66 2076 616c 6964 2055 524c  les of valid URL
+00046570: 7320 6172 6520 2268 7474 703a 2f2f 3130  s are "http://10
+00046580: 2e31 302e 3130 2e31 303a 3831 3138 2220  .10.10.10:8118" 
+00046590: 270a 2020 2020 2020 2020 276f 7220 2273  '.        'or "s
+000465a0: 6f63 6b73 353a 2f2f 7573 6572 3a70 6173  ocks5://user:pas
+000465b0: 7377 6f72 6440 3132 372e 302e 302e 313a  sword@127.0.0.1:
+000465c0: 3130 3830 222e 2027 0a20 2020 2020 2020  1080". '.       
+000465d0: 2027 5552 4c73 2077 6974 6820 2268 7474   'URLs with "htt
+000465e0: 7073 2220 6f72 2022 736f 636b 7334 6122  ps" or "socks4a"
+000465f0: 2061 7265 206e 6f74 2076 616c 6964 2e20   are not valid. 
+00046600: 4f6e 6c79 2027 0a20 2020 2020 2020 2027  Only '.        '
+00046610: 2268 7474 7022 2c20 2273 6f63 6b73 3422  "http", "socks4"
+00046620: 2061 6e64 2022 736f 636b 7335 2220 6172   and "socks5" ar
+00046630: 6520 7661 6c69 642e 272c 0a20 2020 2029  e valid.',.    )
+00046640: 0a20 2020 2061 702e 6164 645f 6172 6775  .    ap.add_argu
+00046650: 6d65 6e74 280a 2020 2020 2020 2020 222d  ment(.        "-
+00046660: 6e22 2c0a 2020 2020 2020 2020 222d 2d6e  n",.        "--n
+00046670: 6f74 6963 6522 2c0a 2020 2020 2020 2020  otice",.        
+00046680: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
+00046690: 2020 2020 2020 2020 6163 7469 6f6e 3d22          action="
+000466a0: 7374 6f72 655f 7472 7565 222c 0a20 2020  store_true",.   
+000466b0: 2020 2020 2068 656c 703d 2253 656e 6420       help="Send 
+000466c0: 6d65 7373 6167 6520 6173 206e 6f74 6963  message as notic
+000466d0: 652e 2022 0a20 2020 2020 2020 2022 4465  e. ".        "De
+000466e0: 7461 696c 733a 3a20 4966 206e 6f74 2073  tails:: If not s
+000466f0: 7065 6369 6669 6564 2c20 6d65 7373 6167  pecified, messag
+00046700: 6520 7769 6c6c 2062 6520 7365 6e74 2061  e will be sent a
+00046710: 7320 7465 7874 2e22 2c0a 2020 2020 290a  s text.",.    ).
+00046720: 2020 2020 6170 2e61 6464 5f61 7267 756d      ap.add_argum
+00046730: 656e 7428 0a20 2020 2020 2020 2023 206e  ent(.        # n
+00046740: 6f20 7369 6e67 6c65 2063 6861 7220 666c  o single char fl
+00046750: 6167 0a20 2020 2020 2020 2022 2d2d 656e  ag.        "--en
+00046760: 6372 7970 7465 6422 2c0a 2020 2020 2020  crypted",.      
+00046770: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
+00046780: 2c0a 2020 2020 2020 2020 6163 7469 6f6e  ,.        action
+00046790: 3d22 7374 6f72 655f 7472 7565 222c 0a20  ="store_true",. 
+000467a0: 2020 2020 2020 2068 656c 703d 2253 656e         help="Sen
+000467b0: 6420 6d65 7373 6167 6520 656e 642d 746f  d message end-to
+000467c0: 2d65 6e64 2065 6e63 7279 7074 6564 2e20  -end encrypted. 
+000467d0: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
+000467e0: 6c73 3a3a 2045 6e63 7279 7074 696f 6e20  ls:: Encryption 
+000467f0: 6973 2061 6c77 6179 7320 7475 726e 6564  is always turned
+00046800: 206f 6e20 616e 6420 220a 2020 2020 2020   on and ".      
+00046810: 2020 2277 696c 6c20 616c 7761 7973 2062    "will always b
+00046820: 6520 7573 6564 2077 6865 7265 2070 6f73  e used where pos
+00046830: 7369 626c 652e 2022 0a20 2020 2020 2020  sible. ".       
+00046840: 2022 4974 2063 616e 6e6f 7420 6265 2074   "It cannot be t
+00046850: 7572 6e65 6420 6f66 662e 2054 6869 7320  urned off. This 
+00046860: 666c 6167 2064 6f65 7320 6e6f 7468 696e  flag does nothin
+00046870: 6720 220a 2020 2020 2020 2020 2261 7320  g ".        "as 
+00046880: 656e 6372 7970 7469 6f6e 2069 7320 7475  encryption is tu
+00046890: 726e 6564 206f 6e20 7769 7468 206f 7220  rned on with or 
+000468a0: 7769 7468 6f75 7420 7468 6973 2022 0a20  without this ". 
+000468b0: 2020 2020 2020 2022 6172 6775 6d65 6e74         "argument
+000468c0: 2e20 5468 6973 2066 6c61 6720 6578 6973  . This flag exis
+000468d0: 7473 206f 6e6c 7920 666f 7220 6869 7374  ts only for hist
+000468e0: 6f72 6963 2072 6561 736f 6e73 2e20 220a  oric reasons. ".
+000468f0: 2020 2020 2020 2020 2249 6e20 736f 6d65          "In some
+00046900: 2073 7065 6369 6669 6320 6361 7365 2065   specific case e
+00046910: 6e63 7279 7074 696f 6e20 220a 2020 2020  ncryption ".    
+00046920: 2020 2020 2263 616e 2062 6520 6469 7361      "can be disa
+00046930: 626c 6564 2c20 706c 6561 7365 2073 6565  bled, please see
+00046940: 202d 2d70 6c61 696e 2e22 2c0a 2020 2020   --plain.",.    
+00046950: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
+00046960: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
+00046970: 2d6c 222c 0a20 2020 2020 2020 2022 2d2d  -l",.        "--
+00046980: 6c69 7374 656e 222c 0a20 2020 2020 2020  listen",.       
+00046990: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
+000469a0: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
+000469b0: 722c 0a20 2020 2020 2020 2064 6566 6175  r,.        defau
+000469c0: 6c74 3d4c 4953 5445 4e5f 4445 4641 554c  lt=LISTEN_DEFAUL
+000469d0: 542c 2020 2320 7768 656e 202d 6c20 6973  T,  # when -l is
+000469e0: 206e 6f74 2075 7365 640a 2020 2020 2020   not used.      
+000469f0: 2020 6e61 7267 733d 223f 222c 2020 2320    nargs="?",  # 
+00046a00: 6d61 6b65 7320 7468 6520 776f 7264 206f  makes the word o
+00046a10: 7074 696f 6e61 6c0a 2020 2020 2020 2020  ptional.        
+00046a20: 636f 6e73 743d 464f 5245 5645 522c 2020  const=FOREVER,  
+00046a30: 2320 7768 656e 202d 6c20 6973 2075 7365  # when -l is use
+00046a40: 642c 2062 7574 2046 4f52 4556 4552 2069  d, but FOREVER i
+00046a50: 7320 6e6f 7420 6164 6465 640a 2020 2020  s not added.    
+00046a60: 2020 2020 6d65 7461 7661 723d 224e 4556      metavar="NEV
+00046a70: 4552 7c4f 4e43 457c 464f 5245 5645 527c  ER|ONCE|FOREVER|
+00046a80: 5441 494c 7c41 4c4c 222c 0a20 2020 2020  TAIL|ALL",.     
+00046a90: 2020 2068 656c 703d 2250 7269 6e74 2072     help="Print r
+00046aa0: 6563 6569 7665 6420 6d65 7373 6167 6573  eceived messages
+00046ab0: 2061 6e64 206c 6973 7465 6e20 746f 206d   and listen to m
+00046ac0: 6573 7361 6765 732e 2022 0a20 2020 2020  essages. ".     
+00046ad0: 2020 2022 4465 7461 696c 733a 3a20 5468     "Details:: Th
+00046ae0: 6520 2d2d 6c69 7374 656e 206f 7074 696f  e --listen optio
+00046af0: 6e20 7461 6b65 7320 6f6e 6520 6172 6775  n takes one argu
+00046b00: 6d65 6e74 2e20 5468 6572 6520 220a 2020  ment. There ".  
+00046b10: 2020 2020 2020 6627 6172 6520 7365 7665        f'are seve
+00046b20: 7261 6c20 6368 6f69 6365 733a 2022 7b4e  ral choices: "{N
+00046b30: 4556 4552 7d22 2c20 227b 4f4e 4345 7d22  EVER}", "{ONCE}"
+00046b40: 2c20 270a 2020 2020 2020 2020 6627 227b  , '.        f'"{
+00046b50: 464f 5245 5645 527d 222c 2022 7b54 4149  FOREVER}", "{TAI
+00046b60: 4c7d 222c 2061 6e64 2022 7b41 4c4c 7d22  L}", and "{ALL}"
+00046b70: 2e20 270a 2020 2020 2020 2020 6627 4279  . '.        f'By
+00046b80: 2064 6566 6175 6c74 2c20 2d2d 6c69 7374   default, --list
+00046b90: 656e 2069 7320 7365 7420 746f 2022 7b4e  en is set to "{N
+00046ba0: 4556 4552 7d22 2e20 2053 6f2c 2062 7920  EVER}".  So, by 
+00046bb0: 270a 2020 2020 2020 2020 2264 6566 6175  '.        "defau
+00046bc0: 6c74 206e 6f20 6c69 7374 656e 696e 6720  lt no listening 
+00046bd0: 7769 6c6c 2062 6520 646f 6e65 2e20 5365  will be done. Se
+00046be0: 7420 6974 2074 6f20 220a 2020 2020 2020  t it to ".      
+00046bf0: 2020 6627 227b 464f 5245 5645 527d 2220    f'"{FOREVER}" 
+00046c00: 746f 206c 6973 7465 6e20 666f 7220 616e  to listen for an
+00046c10: 6420 7072 696e 7420 696e 636f 6d69 6e67  d print incoming
+00046c20: 206d 6573 7361 6765 7320 270a 2020 2020   messages '.    
+00046c30: 2020 2020 2274 6f20 7374 646f 7574 2e20      "to stdout. 
+00046c40: 220a 2020 2020 2020 2020 6627 222d 2d6c  ".        f'"--l
+00046c50: 6973 7465 6e20 7b46 4f52 4556 4552 7d22  isten {FOREVER}"
+00046c60: 2077 696c 6c20 6c69 7374 656e 2074 6f20   will listen to 
+00046c70: 616c 6c20 6d65 7373 6167 6573 206f 6e20  all messages on 
+00046c80: 270a 2020 2020 2020 2020 2261 6c6c 2072  '.        "all r
+00046c90: 6f6f 6d73 2066 6f72 6576 6572 2e20 220a  ooms forever. ".
+00046ca0: 2020 2020 2020 2020 6627 546f 2073 746f          f'To sto
+00046cb0: 7020 6c69 7374 656e 696e 6720 227b 464f  p listening "{FO
+00046cc0: 5245 5645 527d 222c 2075 7365 2043 6f6e  REVER}", use Con
+00046cd0: 7472 6f6c 2d43 206f 6e20 270a 2020 2020  trol-C on '.    
+00046ce0: 2020 2020 2274 6865 206b 6579 626f 6172      "the keyboar
+00046cf0: 6420 6f72 2073 656e 6420 6120 7369 676e  d or send a sign
+00046d00: 616c 2074 6f20 7468 6520 7072 6f63 6573  al to the proces
+00046d10: 7320 6f72 2073 6572 7669 6365 2e20 220a  s or service. ".
+00046d20: 2020 2020 2020 2020 2254 6865 2050 4944          "The PID
+00046d30: 2066 6f72 2073 6967 6e61 6c69 6e67 2063   for signaling c
+00046d40: 616e 2062 6520 666f 756e 6420 696e 2061  an be found in a
+00046d50: 2050 4944 2066 696c 6520 696e 2022 0a20   PID file in ". 
+00046d60: 2020 2020 2020 2066 2764 6972 6563 746f         f'directo
+00046d70: 7279 2022 7b50 4944 5f44 4952 5f44 4546  ry "{PID_DIR_DEF
+00046d80: 4155 4c54 7d22 2e20 270a 2020 2020 2020  AULT}". '.      
+00046d90: 2020 6627 222d 2d6c 6973 7465 6e20 7b4f    f'"--listen {O
+00046da0: 4e43 457d 2220 7769 6c6c 2067 6574 2061  NCE}" will get a
+00046db0: 6c6c 2074 6865 206d 6573 7361 6765 7320  ll the messages 
+00046dc0: 6672 6f6d 2027 0a20 2020 2020 2020 2022  from '.        "
+00046dd0: 616c 6c20 726f 6f6d 7320 7468 6174 2061  all rooms that a
+00046de0: 7265 2063 7572 7265 6e74 6c79 2071 7565  re currently que
+00046df0: 7565 6420 7570 2e20 536f 2c20 7769 7468  ued up. So, with
+00046e00: 2022 0a20 2020 2020 2020 2066 2722 7b4f   ".        f'"{O
+00046e10: 4e43 457d 2220 7468 6520 7072 6f67 7261  NCE}" the progra
+00046e20: 6d20 7769 6c6c 2073 7461 7274 2c20 7072  m will start, pr
+00046e30: 696e 7420 7761 6974 696e 6720 270a 2020  int waiting '.  
+00046e40: 2020 2020 2020 226d 6573 7361 6765 7320        "messages 
+00046e50: 2869 6620 616e 7929 2061 6e64 2074 6865  (if any) and the
+00046e60: 6e20 7374 6f70 2e20 5468 6520 7469 6d65  n stop. The time
+00046e70: 6f75 7420 666f 7220 220a 2020 2020 2020  out for ".      
+00046e80: 2020 6627 227b 4f4e 4345 7d22 2069 7320    f'"{ONCE}" is 
+00046e90: 7365 7420 746f 2031 3020 7365 636f 6e64  set to 10 second
+00046ea0: 732e 2053 6f2c 2062 6520 7061 7469 656e  s. So, be patien
+00046eb0: 742c 2069 7420 270a 2020 2020 2020 2020  t, it '.        
+00046ec0: 226d 6967 6874 2074 616b 6520 7570 2074  "might take up t
+00046ed0: 6f20 7468 6174 2061 6d6f 756e 7420 6f66  o that amount of
+00046ee0: 2074 696d 652e 2022 0a20 2020 2020 2020   time. ".       
+00046ef0: 2066 2722 7b54 4149 4c7d 2220 7265 6164   f'"{TAIL}" read
+00046f00: 7320 616e 6420 7072 696e 7473 2074 6865  s and prints the
+00046f10: 206c 6173 7420 4e20 270a 2020 2020 2020   last N '.      
+00046f20: 2020 226d 6573 7361 6765 7320 6672 6f6d    "messages from
+00046f30: 2074 6865 2073 7065 6369 6669 6564 2072   the specified r
+00046f40: 6f6f 6d73 2c20 7468 656e 2071 7569 7473  ooms, then quits
+00046f50: 2e20 5468 6520 220a 2020 2020 2020 2020  . The ".        
+00046f60: 226e 756d 6265 7220 4e20 6361 6e20 6265  "number N can be
+00046f70: 2073 6574 2077 6974 6820 7468 6520 2d2d   set with the --
+00046f80: 7461 696c 206f 7074 696f 6e2e 2057 6974  tail option. Wit
+00046f90: 6820 220a 2020 2020 2020 2020 6627 227b  h ".        f'"{
+00046fa0: 5441 494c 7d22 2073 6f6d 6520 6d65 7373  TAIL}" some mess
+00046fb0: 6167 6573 2072 6561 6420 6d69 6768 7420  ages read might 
+00046fc0: 6265 206f 6c64 2c20 270a 2020 2020 2020  be old, '.      
+00046fd0: 2020 2269 2e65 2e20 616c 7265 6164 7920    "i.e. already 
+00046fe0: 7265 6164 2062 6566 6f72 652c 2073 6f6d  read before, som
+00046ff0: 6520 6d69 6768 7420 6265 206e 6577 2c20  e might be new, 
+00047000: 220a 2020 2020 2020 2020 2269 2e65 2e20  ".        "i.e. 
+00047010: 6e65 7665 7220 7265 6164 2062 6566 6f72  never read befor
+00047020: 652e 2049 7420 7072 696e 7473 2074 6865  e. It prints the
+00047030: 206d 6573 7361 6765 7320 616e 6420 7468   messages and th
+00047040: 656e 2022 0a20 2020 2020 2020 2066 2274  en ".        f"t
+00047050: 6865 2070 726f 6772 616d 2073 746f 7073  he program stops
+00047060: 2e20 220a 2020 2020 2020 2020 224d 6573  . ".        "Mes
+00047070: 7361 6765 7320 6172 6520 736f 7274 6564  sages are sorted
+00047080: 2c20 6c61 7374 2d66 6972 7374 2e20 220a  , last-first. ".
+00047090: 2020 2020 2020 2020 224c 6f6f 6b20 6174          "Look at
+000470a0: 202d 2d74 6169 6c20 6173 2074 6861 7420   --tail as that 
+000470b0: 6f70 7469 6f6e 2069 7320 7265 6c61 7465  option is relate
+000470c0: 6420 220a 2020 2020 2020 2020 2274 6f20  d ".        "to 
+000470d0: 2d2d 6c69 7374 656e 2074 6169 6c2e 2022  --listen tail. "
+000470e0: 0a20 2020 2020 2020 2066 2754 6865 206f  .        f'The o
+000470f0: 7074 696f 6e20 227b 414c 4c7d 2220 6765  ption "{ALL}" ge
+00047100: 7473 2061 6c6c 206d 6573 7361 6765 7320  ts all messages 
+00047110: 6176 6169 6c61 626c 652c 2027 0a20 2020  available, '.   
+00047120: 2020 2020 2022 6f6c 6420 616e 6420 6e65       "old and ne
+00047130: 772e 2022 0a20 2020 2020 2020 2066 2755  w. ".        f'U
+00047140: 6e6c 696b 6520 227b 4f4e 4345 7d22 2061  nlike "{ONCE}" a
+00047150: 6e64 2027 0a20 2020 2020 2020 2066 2722  nd '.        f'"
+00047160: 7b46 4f52 4556 4552 7d22 2074 6861 7420  {FOREVER}" that 
+00047170: 6c69 7374 656e 2069 6e20 414c 4c20 726f  listen in ALL ro
+00047180: 6f6d 732c 2022 7b54 4149 4c7d 2220 270a  oms, "{TAIL}" '.
+00047190: 2020 2020 2020 2020 6627 616e 6420 227b          f'and "{
+000471a0: 414c 4c7d 2220 6c69 7374 656e 2027 0a20  ALL}" listen '. 
+000471b0: 2020 2020 2020 2022 6f6e 6c79 2074 6f20         "only to 
+000471c0: 7468 6520 726f 6f6d 2073 7065 6369 6669  the room specifi
+000471d0: 6564 2069 6e20 7468 6520 6372 6564 656e  ed in the creden
+000471e0: 7469 616c 7320 220a 2020 2020 2020 2020  tials ".        
+000471f0: 2266 696c 6520 6f72 2074 6865 202d 2d72  "file or the --r
+00047200: 6f6f 6d20 6f70 7469 6f6e 732e 2022 2c0a  oom options. ",.
+00047210: 2020 2020 290a 2020 2020 6170 2e61 6464      ).    ap.add
+00047220: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
+00047230: 2020 2022 2d74 222c 0a20 2020 2020 2020     "-t",.       
+00047240: 2022 2d2d 7461 696c 222c 0a20 2020 2020   "--tail",.     
+00047250: 2020 2072 6571 7569 7265 643d 4661 6c73     required=Fals
+00047260: 652c 0a20 2020 2020 2020 2074 7970 653d  e,.        type=
+00047270: 696e 742c 0a20 2020 2020 2020 2064 6566  int,.        def
+00047280: 6175 6c74 3d54 4149 4c5f 554e 5553 4544  ault=TAIL_UNUSED
+00047290: 5f44 4546 4155 4c54 2c20 2023 2077 6865  _DEFAULT,  # whe
+000472a0: 6e20 2d74 2069 7320 6e6f 7420 7573 6564  n -t is not used
+000472b0: 0a20 2020 2020 2020 206e 6172 6773 3d22  .        nargs="
+000472c0: 3f22 2c20 2023 206d 616b 6573 2074 6865  ?",  # makes the
+000472d0: 2077 6f72 6420 6f70 7469 6f6e 616c 0a20   word optional. 
+000472e0: 2020 2020 2020 2023 2077 6865 6e20 2d74         # when -t
+000472f0: 2069 7320 7573 6564 2c20 6275 7420 6e75   is used, but nu
+00047300: 6d62 6572 2069 7320 6e6f 7420 6164 6465  mber is not adde
+00047310: 640a 2020 2020 2020 2020 636f 6e73 743d  d.        const=
+00047320: 5441 494c 5f55 5345 445f 4445 4641 554c  TAIL_USED_DEFAUL
+00047330: 542c 0a20 2020 2020 2020 206d 6574 6176  T,.        metav
+00047340: 6172 3d22 4e55 4d42 4552 222c 0a20 2020  ar="NUMBER",.   
+00047350: 2020 2020 2068 656c 703d 2250 7269 6e74       help="Print
+00047360: 206c 6173 7420 6d65 7373 6167 6573 2e20   last messages. 
+00047370: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
+00047380: 6c73 3a3a 2054 6865 202d 2d74 6169 6c20  ls:: The --tail 
+00047390: 6f70 7469 6f6e 2072 6561 6473 2061 6e64  option reads and
+000473a0: 2070 7269 6e74 7320 7570 2074 6f20 7468   prints up to th
+000473b0: 6520 6c61 7374 204e 2022 0a20 2020 2020  e last N ".     
+000473c0: 2020 2022 6d65 7373 6167 6573 2066 726f     "messages fro
+000473d0: 6d20 7468 6520 7370 6563 6966 6965 6420  m the specified 
+000473e0: 726f 6f6d 732c 2074 6865 6e20 7175 6974  rooms, then quit
+000473f0: 732e 2022 0a20 2020 2020 2020 2022 4974  s. ".        "It
+00047400: 2074 616b 6573 206f 6e65 2022 0a20 2020   takes one ".   
+00047410: 2020 2020 2022 6172 6775 6d65 6e74 2c20       "argument, 
+00047420: 616e 2069 6e74 6567 6572 2c20 220a 2020  an integer, ".  
+00047430: 2020 2020 2020 2277 6869 6368 2077 6520        "which we 
+00047440: 6361 6c6c 204e 2068 6572 652e 2049 6620  call N here. If 
+00047450: 7468 6572 6520 6172 6520 6665 7765 7220  there are fewer 
+00047460: 7468 616e 204e 206d 6573 7361 6765 7320  than N messages 
+00047470: 220a 2020 2020 2020 2020 2269 6e20 6120  ".        "in a 
+00047480: 726f 6f6d 2c20 6974 2072 6561 6473 2061  room, it reads a
+00047490: 6e64 2070 7269 6e74 7320 7570 2074 6f20  nd prints up to 
+000474a0: 4e20 6d65 7373 6167 6573 2e20 220a 2020  N messages. ".  
+000474b0: 2020 2020 2020 2249 7420 6765 7473 2074        "It gets t
+000474c0: 6865 206c 6173 7420 4e20 6d65 7373 6167  he last N messag
+000474d0: 6573 2069 6e20 7265 7665 7273 6520 6f72  es in reverse or
+000474e0: 6465 722e 2022 0a20 2020 2020 2020 2022  der. ".        "
+000474f0: 4974 2070 7269 6e74 2074 6865 206e 6577  It print the new
+00047500: 6573 7420 6d65 7373 6167 6520 6669 7273  est message firs
+00047510: 742c 2061 6e64 2074 6865 2022 0a20 2020  t, and the ".   
+00047520: 2020 2020 2022 6f6c 6465 7374 206d 6573       "oldest mes
+00047530: 7361 6765 206c 6173 742e 2022 0a20 2020  sage last. ".   
+00047540: 2020 2020 2022 4966 202d 2d6c 6973 7465       "If --liste
+00047550: 6e2d 7365 6c66 2069 7320 6e6f 7420 7365  n-self is not se
+00047560: 7420 6974 2077 696c 6c20 7072 696e 7420  t it will print 
+00047570: 6c65 7373 2074 6861 6e20 220a 2020 2020  less than ".    
+00047580: 2020 2020 224e 206d 6573 7361 6765 7320      "N messages 
+00047590: 696e 206d 616e 7920 6361 7365 7320 6265  in many cases be
+000475a0: 6361 7573 6520 4e20 6d65 7373 6167 6573  cause N messages
+000475b0: 2061 7265 2022 0a20 2020 2020 2020 2022   are ".        "
+000475c0: 6f62 7461 696e 6564 2c20 6275 7420 736f  obtained, but so
+000475d0: 6d65 206f 6620 7468 656d 2061 7265 2064  me of them are d
+000475e0: 6973 6361 7264 6564 2062 7920 6465 6661  iscarded by defa
+000475f0: 756c 7420 6966 2022 0a20 2020 2020 2020  ult if ".       
+00047600: 2022 7468 6579 2061 7265 2066 726f 6d20   "they are from 
+00047610: 7468 6520 7573 6572 2069 7473 656c 662e  the user itself.
+00047620: 2022 0a20 2020 2020 2020 2022 4c6f 6f6b   ".        "Look
+00047630: 2061 7420 2d2d 6c69 7374 656e 2061 7320   at --listen as 
+00047640: 7468 6973 206f 7074 696f 6e20 6973 2072  this option is r
+00047650: 656c 6174 6564 2074 6f20 2d2d 7461 696c  elated to --tail
+00047660: 2e22 2c0a 2020 2020 290a 2020 2020 6170  .",.    ).    ap
+00047670: 2e61 6464 5f61 7267 756d 656e 7428 0a20  .add_argument(. 
+00047680: 2020 2020 2020 2022 2d79 222c 0a20 2020         "-y",.   
+00047690: 2020 2020 2022 2d2d 6c69 7374 656e 2d73       "--listen-s
+000476a0: 656c 6622 2c0a 2020 2020 2020 2020 7265  elf",.        re
+000476b0: 7175 6972 6564 3d46 616c 7365 2c0a 2020  quired=False,.  
+000476c0: 2020 2020 2020 6163 7469 6f6e 3d22 7374        action="st
+000476d0: 6f72 655f 7472 7565 222c 0a20 2020 2020  ore_true",.     
+000476e0: 2020 2068 656c 703d 2250 7269 6e74 2079     help="Print y
+000476f0: 6f75 7220 6f77 6e20 6d65 7373 6167 6573  our own messages
+00047700: 2061 7320 7765 6c6c 2e20 220a 2020 2020   as well. ".    
+00047710: 2020 2020 2244 6574 6169 6c73 3a3a 2049      "Details:: I
+00047720: 6620 7365 7420 616e 6420 6c69 7374 656e  f set and listen
+00047730: 696e 672c 2022 0a20 2020 2020 2020 2022  ing, ".        "
+00047740: 7468 656e 2070 726f 6772 616d 2077 696c  then program wil
+00047750: 6c20 6c69 7374 656e 2074 6f20 616e 6420  l listen to and 
+00047760: 7072 696e 7420 616c 736f 2022 0a20 2020  print also ".   
+00047770: 2020 2020 2022 7468 6520 6d65 7373 6167       "the messag
+00047780: 6573 2073 656e 7420 6279 2069 7473 206f  es sent by its o
+00047790: 776e 2075 7365 722e 2022 0a20 2020 2020  wn user. ".     
+000477a0: 2020 2022 4279 2064 6566 6175 6c74 206d     "By default m
+000477b0: 6573 7361 6765 7320 6672 6f6d 206f 6e65  essages from one
+000477c0: 7365 6c66 2061 7265 206e 6f74 2070 7269  self are not pri
+000477d0: 6e74 6564 2e22 2c0a 2020 2020 290a 2020  nted.",.    ).  
+000477e0: 2020 6170 2e61 6464 5f61 7267 756d 656e    ap.add_argumen
+000477f0: 7428 0a20 2020 2020 2020 2023 206e 6f20  t(.        # no 
+00047800: 7369 6e67 6c65 2063 6861 7220 666c 6167  single char flag
+00047810: 0a20 2020 2020 2020 2022 2d2d 7072 696e  .        "--prin
+00047820: 742d 6576 656e 742d 6964 222c 0a20 2020  t-event-id",.   
+00047830: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
+00047840: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
+00047850: 696f 6e3d 2273 746f 7265 5f74 7275 6522  ion="store_true"
+00047860: 2c0a 2020 2020 2020 2020 6865 6c70 3d22  ,.        help="
+00047870: 5072 696e 7420 6576 656e 7420 6964 7320  Print event ids 
+00047880: 6f66 2072 6563 6569 7665 6420 6d65 7373  of received mess
+00047890: 6167 6573 2e20 220a 2020 2020 2020 2020  ages. ".        
+000478a0: 2244 6574 6169 6c73 3a3a 2049 6620 7365  "Details:: If se
+000478b0: 7420 616e 6420 6c69 7374 656e 696e 672c  t and listening,
+000478c0: 2022 0a20 2020 2020 2020 2066 2274 6865   ".        f"the
+000478d0: 6e20 277b 5052 4f47 5f57 4954 484f 5554  n '{PROG_WITHOUT
+000478e0: 5f45 5854 7d27 2077 696c 6c20 7072 696e  _EXT}' will prin
+000478f0: 7420 616c 736f 2074 6865 2065 7665 6e74  t also the event
+00047900: 2069 6420 666f 7220 220a 2020 2020 2020   id for ".      
+00047910: 2020 2265 6163 6820 7265 6365 6976 6564    "each received
+00047920: 206d 6573 7361 6765 206f 7220 6f74 6865   message or othe
+00047930: 7220 7265 6365 6976 6564 2065 7665 6e74  r received event
+00047940: 2e20 4966 2073 6574 2061 6e64 2022 0a20  . If set and ". 
+00047950: 2020 2020 2020 2066 2273 656e 6469 6e67         f"sending
+00047960: 2c20 7468 656e 2027 7b50 524f 475f 5749  , then '{PROG_WI
+00047970: 5448 4f55 545f 4558 547d 2720 7769 6c6c  THOUT_EXT}' will
+00047980: 2070 7269 6e74 2074 6865 2065 7665 6e74   print the event
+00047990: 2069 6420 220a 2020 2020 2020 2020 226f   id ".        "o
+000479a0: 6620 7468 6520 7365 6e74 206d 6573 7361  f the sent messa
+000479b0: 6765 206f 7220 7468 6520 7365 6e74 206f  ge or the sent o
+000479c0: 626a 6563 7420 2861 7564 696f 2c20 6669  bject (audio, fi
+000479d0: 6c65 2c20 6576 656e 7429 2074 6f20 220a  le, event) to ".
+000479e0: 2020 2020 2020 2020 2273 7464 6f75 742e          "stdout.
+000479f0: 204f 7468 6572 2069 6e66 6f72 6d61 7469   Other informati
+00047a00: 6f6e 206c 696b 6520 726f 6f6d 2069 6420  on like room id 
+00047a10: 616e 6420 7265 6665 7265 6e63 6520 746f  and reference to
+00047a20: 2077 6861 7420 7761 7320 220a 2020 2020   what was ".    
+00047a30: 2020 2020 2273 656e 7420 7769 6c6c 2062      "sent will b
+00047a40: 6520 7072 696e 7465 6420 746f 6f2e 2046  e printed too. F
+00047a50: 6f72 2073 656e 6469 6e67 2074 6869 7320  or sending this 
+00047a60: 6973 2075 7365 6675 6c2c 2022 0a20 2020  is useful, ".   
+00047a70: 2020 2020 2022 6966 2061 6674 6572 2073       "if after s
+00047a80: 656e 6469 6e67 2074 6865 2075 7365 7220  ending the user 
+00047a90: 220a 2020 2020 2020 2020 2277 6973 6865  ".        "wishe
+00047aa0: 7320 746f 2070 6572 666f 726d 2066 7572  s to perform fur
+00047ab0: 7468 6572 206f 7065 7261 7469 6f6e 7320  ther operations 
+00047ac0: 6f6e 2074 6865 2073 656e 7420 6f62 6a65  on the sent obje
+00047ad0: 6374 2c20 220a 2020 2020 2020 2020 2265  ct, ".        "e
+00047ae0: 2e67 2e20 7265 6461 6374 696e 672f 6465  .g. redacting/de
+00047af0: 6c65 7469 6e67 2069 7420 6166 7465 7220  leting it after 
+00047b00: 616e 2065 7870 6972 6174 696f 6e20 7469  an expiration ti
+00047b10: 6d65 2c20 6574 632e 222c 0a20 2020 2029  me, etc.",.    )
+00047b20: 0a20 2020 2061 702e 6164 645f 6172 6775  .    ap.add_argu
+00047b30: 6d65 6e74 280a 2020 2020 2020 2020 2320  ment(.        # 
+00047b40: 7374 6172 7469 6e67 2077 6974 6820 7665  starting with ve
+00047b50: 7273 696f 6e20 322e 3139 2022 2d75 2220  rsion 2.19 "-u" 
+00047b60: 6861 7320 6265 656e 206d 6f76 6564 2074  has been moved t
+00047b70: 6f20 2d2d 7573 6572 210a 2020 2020 2020  o --user!.      
+00047b80: 2020 222d 2d64 6f77 6e6c 6f61 642d 6d65    "--download-me
+00047b90: 6469 6122 2c0a 2020 2020 2020 2020 7479  dia",.        ty
+00047ba0: 7065 3d73 7472 2c0a 2020 2020 2020 2020  pe=str,.        
+00047bb0: 6465 6661 756c 743d 2222 2c20 2023 2069  default="",  # i
+00047bc0: 6620 2d2d 646f 776e 6c6f 6164 2d6d 6564  f --download-med
+00047bd0: 6961 2069 7320 6e6f 7420 7573 6564 0a20  ia is not used. 
+00047be0: 2020 2020 2020 2061 6374 696f 6e3d 2273         action="s
+00047bf0: 746f 7265 222c 0a20 2020 2020 2020 206e  tore",.        n
+00047c00: 6172 6773 3d22 3f22 2c20 2023 206d 616b  args="?",  # mak
+00047c10: 6573 2074 6865 2077 6f72 6420 6f70 7469  es the word opti
+00047c20: 6f6e 616c 0a20 2020 2020 2020 2063 6f6e  onal.        con
+00047c30: 7374 3d4d 4544 4941 5f44 4952 5f44 4546  st=MEDIA_DIR_DEF
+00047c40: 4155 4c54 2c20 2023 2077 6865 6e20 6f70  AULT,  # when op
+00047c50: 7469 6f6e 2069 7320 7573 6564 2c20 6275  tion is used, bu
+00047c60: 7420 6e6f 2064 6972 2061 6464 6564 0a20  t no dir added. 
+00047c70: 2020 2020 2020 206d 6574 6176 6172 3d22         metavar="
+00047c80: 444f 574e 4c4f 4144 5f44 4952 4543 544f  DOWNLOAD_DIRECTO
+00047c90: 5259 222c 0a20 2020 2020 2020 2068 656c  RY",.        hel
+00047ca0: 703d 2244 6f77 6e6c 6f61 6420 6d65 6469  p="Download medi
+00047cb0: 6120 6669 6c65 7320 7768 696c 6520 6c69  a files while li
+00047cc0: 7374 656e 696e 672e 2022 0a20 2020 2020  stening. ".     
+00047cd0: 2020 2022 4465 7461 696c 733a 3a20 4966     "Details:: If
+00047ce0: 2073 6574 2061 6e64 206c 6973 7465 6e69   set and listeni
+00047cf0: 6e67 2c20 220a 2020 2020 2020 2020 2274  ng, ".        "t
+00047d00: 6865 6e20 7072 6f67 7261 6d20 7769 6c6c  hen program will
+00047d10: 2064 6f77 6e6c 6f61 6420 220a 2020 2020   download ".    
+00047d20: 2020 2020 2272 6563 6569 7665 6420 6d65      "received me
+00047d30: 6469 6120 6669 6c65 7320 2865 2e67 2e20  dia files (e.g. 
+00047d40: 696d 6167 652c 2061 7564 696f 2c20 7669  image, audio, vi
+00047d50: 6465 6f2c 2074 6578 742c 2050 4446 2066  deo, text, PDF f
+00047d60: 696c 6573 292e 2022 0a20 2020 2020 2020  iles). ".       
+00047d70: 2022 6d65 6469 6120 7769 6c6c 2062 6520   "media will be 
+00047d80: 646f 776e 6c6f 6164 6564 2074 6f20 6c6f  downloaded to lo
+00047d90: 6361 6c20 6469 7265 6374 6f72 792e 2022  cal directory. "
+00047da0: 0a20 2020 2020 2020 2022 4279 2064 6566  .        "By def
+00047db0: 6175 6c74 2c20 6d65 6469 6120 7769 6c6c  ault, media will
+00047dc0: 2062 6520 646f 776e 6c6f 6164 6564 2074   be downloaded t
+00047dd0: 6f20 220a 2020 2020 2020 2020 6627 6973  o ".        f'is
+00047de0: 2022 7b4d 4544 4941 5f44 4952 5f44 4546   "{MEDIA_DIR_DEF
+00047df0: 4155 4c54 7d22 2e20 270a 2020 2020 2020  AULT}". '.      
+00047e00: 2020 2259 6f75 2063 616e 206f 7665 7277    "You can overw
+00047e10: 7269 7465 2064 6566 6175 6c74 2077 6974  rite default wit
+00047e20: 6820 796f 7572 2070 7265 6665 7272 6564  h your preferred
+00047e30: 2064 6972 6563 746f 7279 2e20 220a 2020   directory. ".  
+00047e40: 2020 2020 2020 2249 6620 6d65 6469 6120        "If media 
+00047e50: 6973 2065 6e63 7279 7074 6564 2069 7420  is encrypted it 
+00047e60: 7769 6c6c 2062 6520 6465 6372 7970 7465  will be decrypte
+00047e70: 6420 616e 6420 7374 6f72 6564 2064 6563  d and stored dec
+00047e80: 7279 7074 6564 2e20 220a 2020 2020 2020  rypted. ".      
+00047e90: 2020 2242 7920 6465 6661 756c 7420 6d65    "By default me
+00047ea0: 6469 6120 6669 6c65 7320 7769 6c6c 206e  dia files will n
+00047eb0: 6f74 2062 6520 646f 776e 6c6f 6164 6564  ot be downloaded
+00047ec0: 2e22 2c0a 2020 2020 290a 2020 2020 6170  .",.    ).    ap
+00047ed0: 2e61 6464 5f61 7267 756d 656e 7428 0a20  .add_argument(. 
+00047ee0: 2020 2020 2020 2023 2022 2d6f 222c 2023         # "-o", #
+00047ef0: 2069 6e63 6f6d 7061 7469 626c 6520 6368   incompatible ch
+00047f00: 616e 6765 2044 6563 2032 3032 322c 202d  ange Dec 2022, -
+00047f10: 6f20 6d6f 7665 6420 746f 202d 2d6f 7574  o moved to --out
+00047f20: 7075 740a 2020 2020 2020 2020 222d 2d6f  put.        "--o
+00047f30: 732d 6e6f 7469 6679 222c 0a20 2020 2020  s-notify",.     
+00047f40: 2020 2072 6571 7569 7265 643d 4661 6c73     required=Fals
+00047f50: 652c 0a20 2020 2020 2020 2061 6374 696f  e,.        actio
+00047f60: 6e3d 2273 746f 7265 5f74 7275 6522 2c0a  n="store_true",.
+00047f70: 2020 2020 2020 2020 6865 6c70 3d22 4e6f          help="No
+00047f80: 7469 6679 206d 6520 6f66 2061 7272 6976  tify me of arriv
+00047f90: 696e 6720 6d65 7373 6167 6573 2e20 220a  ing messages. ".
+00047fa0: 2020 2020 2020 2020 2244 6574 6169 6c73          "Details
+00047fb0: 3a3a 2049 6620 7365 7420 616e 6420 6c69  :: If set and li
+00047fc0: 7374 656e 696e 672c 2022 0a20 2020 2020  stening, ".     
+00047fd0: 2020 2022 7468 656e 2070 726f 6772 616d     "then program
+00047fe0: 2077 696c 6c20 6174 7465 6d70 7420 746f   will attempt to
+00047ff0: 2076 6973 7561 6c6c 7920 6e6f 7469 6679   visually notify
+00048000: 206f 6620 220a 2020 2020 2020 2020 2261   of ".        "a
+00048010: 7272 6976 696e 6720 6d65 7373 6167 6573  rriving messages
+00048020: 2074 6872 6f75 6768 2074 6865 206f 7065   through the ope
+00048030: 7261 7469 6e67 2073 7973 7465 6d2e 2022  rating system. "
+00048040: 0a20 2020 2020 2020 2022 4279 2064 6566  .        "By def
+00048050: 6175 6c74 2074 6865 7265 2069 7320 6e6f  ault there is no
+00048060: 206e 6f74 6966 6963 6174 696f 6e20 7669   notification vi
+00048070: 6120 4f53 2e22 2c0a 2020 2020 290a 2020  a OS.",.    ).  
+00048080: 2020 6170 2e61 6464 5f61 7267 756d 656e    ap.add_argumen
+00048090: 7428 0a20 2020 2020 2020 2023 2072 656d  t(.        # rem
+000480a0: 6f76 6564 2022 2d78 222c 2073 7461 7274  oved "-x", start
+000480b0: 696e 6720 7632 2e32 3120 2d78 2069 7320  ing v2.21 -x is 
+000480c0: 6e6f 206c 6f6e 6765 7220 7375 7070 6f72  no longer suppor
+000480d0: 7465 640a 2020 2020 2020 2020 222d 2d73  ted.        "--s
+000480e0: 6574 2d64 6576 6963 652d 6e61 6d65 222c  et-device-name",
+000480f0: 0a20 2020 2020 2020 2072 6571 7569 7265  .        require
+00048100: 643d 4661 6c73 652c 0a20 2020 2020 2020  d=False,.       
+00048110: 2074 7970 653d 7374 722c 0a20 2020 2020   type=str,.     
+00048120: 2020 2064 6566 6175 6c74 3d53 4554 5f44     default=SET_D
+00048130: 4556 4943 455f 4e41 4d45 5f55 4e55 5345  EVICE_NAME_UNUSE
+00048140: 445f 4445 4641 554c 542c 2020 2320 7768  D_DEFAULT,  # wh
+00048150: 656e 206f 7074 696f 6e20 6973 6e27 7420  en option isn't 
+00048160: 7573 6564 0a20 2020 2020 2020 206d 6574  used.        met
+00048170: 6176 6172 3d22 4445 5649 4345 5f4e 414d  avar="DEVICE_NAM
+00048180: 4522 2c0a 2020 2020 2020 2020 6865 6c70  E",.        help
+00048190: 3d22 5365 7420 6f72 2072 656e 616d 6520  ="Set or rename 
+000481a0: 7468 6520 6375 7272 656e 7420 6465 7669  the current devi
+000481b0: 6365 2e20 220a 2020 2020 2020 2020 2244  ce. ".        "D
+000481c0: 6574 6169 6c73 3a3a 2053 6574 206f 7220  etails:: Set or 
+000481d0: 7265 6e61 6d65 2074 6865 2063 7572 7265  rename the curre
+000481e0: 6e74 2064 6576 6963 6520 746f 2074 6865  nt device to the
+000481f0: 2022 0a20 2020 2020 2020 2022 6465 7669   ".        "devi
+00048200: 6365 206e 616d 6520 7072 6f76 6964 6564  ce name provided
+00048210: 2e20 220a 2020 2020 2020 2020 2253 656e  . ".        "Sen
+00048220: 642c 206c 6973 7465 6e20 616e 6420 7665  d, listen and ve
+00048230: 7269 6679 206f 7065 7261 7469 6f6e 7320  rify operations 
+00048240: 6172 6520 616c 6c6f 7765 6420 7768 656e  are allowed when
+00048250: 2022 0a20 2020 2020 2020 2022 7265 6e61   ".        "rena
+00048260: 6d69 6e67 2074 6865 2064 6576 6963 652e  ming the device.
+00048270: 222c 0a20 2020 2029 0a20 2020 2061 702e  ",.    ).    ap.
+00048280: 6164 645f 6172 6775 6d65 6e74 280a 2020  add_argument(.  
+00048290: 2020 2020 2020 222d 2d73 6574 2d64 6973        "--set-dis
+000482a0: 706c 6179 2d6e 616d 6522 2c0a 2020 2020  play-name",.    
+000482b0: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
+000482c0: 7365 2c0a 2020 2020 2020 2020 7479 7065  se,.        type
+000482d0: 3d73 7472 2c0a 2020 2020 2020 2020 6465  =str,.        de
+000482e0: 6661 756c 743d 5345 545f 4449 5350 4c41  fault=SET_DISPLA
+000482f0: 595f 4e41 4d45 5f55 4e55 5345 445f 4445  Y_NAME_UNUSED_DE
+00048300: 4641 554c 542c 2020 2320 7768 656e 206f  FAULT,  # when o
+00048310: 7074 696f 6e20 6973 6e27 7420 7573 6564  ption isn't used
+00048320: 0a20 2020 2020 2020 206d 6574 6176 6172  .        metavar
+00048330: 3d22 4449 5350 4c41 595f 4e41 4d45 222c  ="DISPLAY_NAME",
+00048340: 0a20 2020 2020 2020 2068 656c 703d 2253  .        help="S
+00048350: 6574 206f 7220 7265 6e61 6d65 2074 6865  et or rename the
+00048360: 2064 6973 706c 6179 206e 616d 652e 2022   display name. "
+00048370: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
+00048380: 733a 3a20 5365 7420 6f72 2072 656e 616d  s:: Set or renam
+00048390: 6520 7468 6520 6469 7370 6c61 7920 6e61  e the display na
+000483a0: 6d65 2022 0a20 2020 2020 2020 2022 666f  me ".        "fo
+000483b0: 7220 7468 6520 6375 7272 656e 7420 7573  r the current us
+000483c0: 6572 2074 6f20 7468 6520 220a 2020 2020  er to the ".    
+000483d0: 2020 2020 2264 6973 706c 6179 206e 616d      "display nam
+000483e0: 6520 7072 6f76 6964 6564 2e20 220a 2020  e provided. ".  
+000483f0: 2020 2020 2020 2253 656e 642c 206c 6973        "Send, lis
+00048400: 7465 6e20 616e 6420 7665 7269 6679 206f  ten and verify o
+00048410: 7065 7261 7469 6f6e 7320 6172 6520 616c  perations are al
+00048420: 6c6f 7765 6420 7768 656e 2022 0a20 2020  lowed when ".   
+00048430: 2020 2020 2022 7365 7474 696e 6720 7468       "setting th
+00048440: 6520 6469 7370 6c61 7920 6e61 6d65 2e20  e display name. 
+00048450: 220a 2020 2020 2020 2020 2244 6f20 6e6f  ".        "Do no
+00048460: 7420 636f 6e66 7573 6520 7468 6973 206f  t confuse this o
+00048470: 7074 696f 6e20 7769 7468 2074 6865 206f  ption with the o
+00048480: 7074 696f 6e20 272d 2d67 6574 2d72 6f6f  ption '--get-roo
+00048490: 6d2d 696e 666f 2720 220a 2020 2020 2020  m-info' ".      
+000484a0: 2020 2277 6869 6368 2067 6574 7320 7468    "which gets th
+000484b0: 6520 726f 6f6d 2064 6973 706c 6179 206e  e room display n
+000484c0: 616d 652c 206e 6f74 2074 6865 2075 7365  ame, not the use
+000484d0: 7220 6469 7370 6c61 7920 6e61 6d65 2e22  r display name."
+000484e0: 2c0a 2020 2020 290a 2020 2020 6170 2e61  ,.    ).    ap.a
+000484f0: 6464 5f61 7267 756d 656e 7428 0a20 2020  dd_argument(.   
+00048500: 2020 2020 2022 2d2d 6765 742d 6469 7370       "--get-disp
+00048510: 6c61 792d 6e61 6d65 222c 0a20 2020 2020  lay-name",.     
+00048520: 2020 2072 6571 7569 7265 643d 4661 6c73     required=Fals
+00048530: 652c 0a20 2020 2020 2020 2061 6374 696f  e,.        actio
+00048540: 6e3d 2273 746f 7265 5f74 7275 6522 2c0a  n="store_true",.
+00048550: 2020 2020 2020 2020 6865 6c70 3d22 4765          help="Ge
+00048560: 7420 7468 6520 6469 7370 6c61 7920 6e61  t the display na
+00048570: 6d65 206f 6620 796f 7572 7365 6c66 2e20  me of yourself. 
+00048580: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
+00048590: 6c73 3a3a 2047 6574 2074 6865 2064 6973  ls:: Get the dis
+000485a0: 706c 6179 206e 616d 6520 6f66 2022 0a20  play name of ". 
+000485b0: 2020 2020 2020 2066 227b 5052 4f47 5f57         f"{PROG_W
+000485c0: 4954 484f 5554 5f45 5854 7d20 2869 7473  ITHOUT_EXT} (its
+000485d0: 656c 6629 2c20 220a 2020 2020 2020 2020  elf), ".        
+000485e0: 226f 7220 6f66 206f 6e65 206f 7220 6d75  "or of one or mu
+000485f0: 6c74 6970 6c65 2075 7365 7273 2e20 5370  ltiple users. Sp
+00048600: 6563 6966 7920 7573 6572 2873 2920 7769  ecify user(s) wi
+00048610: 7468 2074 6865 2022 0a20 2020 2020 2020  th the ".       
+00048620: 2022 2d2d 7573 6572 206f 7074 696f 6e2e   "--user option.
+00048630: 2049 6620 6e6f 2075 7365 7220 6973 2073   If no user is s
+00048640: 7065 6369 6669 6564 2067 6574 2074 6865  pecified get the
+00048650: 2064 6973 706c 6179 206e 616d 6520 6f66   display name of
+00048660: 2022 0a20 2020 2020 2020 2022 6974 7365   ".        "itse
+00048670: 6c66 2e20 220a 2020 2020 2020 2020 2253  lf. ".        "S
+00048680: 656e 642c 206c 6973 7465 6e20 616e 6420  end, listen and 
+00048690: 7665 7269 6679 206f 7065 7261 7469 6f6e  verify operation
+000486a0: 7320 6172 6520 616c 6c6f 7765 6420 7768  s are allowed wh
+000486b0: 656e 2022 0a20 2020 2020 2020 2022 6765  en ".        "ge
+000486c0: 7474 696e 6720 6469 7370 6c61 7920 6e61  tting display na
+000486d0: 6d65 2873 292e 2022 0a20 2020 2020 2020  me(s). ".       
+000486e0: 2022 446f 206e 6f74 2063 6f6e 6675 7365   "Do not confuse
+000486f0: 2074 6869 7320 6f70 7469 6f6e 2077 6974   this option wit
+00048700: 6820 7468 6520 6f70 7469 6f6e 2027 2d2d  h the option '--
+00048710: 6765 742d 726f 6f6d 2d69 6e66 6f27 2022  get-room-info' "
+00048720: 0a20 2020 2020 2020 2022 7768 6963 6820  .        "which 
+00048730: 6765 7473 2074 6865 2072 6f6f 6d20 6469  gets the room di
+00048740: 7370 6c61 7920 6e61 6d65 2c20 6e6f 7420  splay name, not 
+00048750: 7468 6520 7573 6572 2064 6973 706c 6179  the user display
+00048760: 206e 616d 652e 222c 0a20 2020 2029 0a20   name.",.    ). 
+00048770: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
+00048780: 6e74 280a 2020 2020 2020 2020 222d 2d73  nt(.        "--s
+00048790: 6574 2d70 7265 7365 6e63 6522 2c0a 2020  et-presence",.  
+000487a0: 2020 2020 2020 7265 7175 6972 6564 3d46        required=F
+000487b0: 616c 7365 2c0a 2020 2020 2020 2020 7479  alse,.        ty
+000487c0: 7065 3d73 7472 2c0a 2020 2020 2020 2020  pe=str,.        
+000487d0: 2320 6465 6661 756c 7473 2074 6f20 4e6f  # defaults to No
+000487e0: 6e65 2069 6620 6e6f 7420 7573 6564 2c20  ne if not used, 
+000487f0: 6973 2073 7472 2069 6620 7573 6564 0a20  is str if used. 
+00048800: 2020 2020 2020 206d 6574 6176 6172 3d22         metavar="
+00048810: 4f4e 4c49 4e45 7c4f 4646 4c49 4e45 7c55  ONLINE|OFFLINE|U
+00048820: 4e41 5641 494c 4142 4c45 222c 0a20 2020  NAVAILABLE",.   
+00048830: 2020 2020 2068 656c 703d 2253 6574 2079       help="Set y
+00048840: 6f75 7220 7072 6573 656e 6365 2e20 220a  our presence. ".
+00048850: 2020 2020 2020 2020 6622 4465 7461 696c          f"Detail
+00048860: 733a 3a20 5365 7420 7072 6573 656e 6365  s:: Set presence
+00048870: 206f 6620 7b50 524f 475f 5749 5448 4f55   of {PROG_WITHOU
+00048880: 545f 4558 547d 2074 6f20 7468 6520 6769  T_EXT} to the gi
+00048890: 7665 6e20 7661 6c75 652e 2022 0a20 2020  ven value. ".   
+000488a0: 2020 2020 2022 4d75 7374 2062 6520 6f6e       "Must be on
+000488b0: 6520 6f66 2074 6865 7365 2076 616c 7565  e of these value
+000488c0: 733a 20e2 809c 6f6e 6c69 6e65 e280 9d2c  s: ...online...,
+000488d0: 20e2 809c 6f66 666c 696e 65e2 809d 2c20   ...offline..., 
+000488e0: e280 9c75 6e61 7661 696c 6162 6c65 e280  ...unavailable..
+000488f0: 9d2e 2022 0a20 2020 2020 2020 2022 4f74  .. ".        "Ot
+00048900: 6865 7277 6973 6520 616e 2065 7272 6f72  herwise an error
+00048910: 2077 696c 6c20 6265 2070 726f 6475 6365   will be produce
+00048920: 642e 222c 0a20 2020 2029 0a20 2020 2061  d.",.    ).    a
+00048930: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
+00048940: 2020 2020 2020 2020 222d 2d67 6574 2d70          "--get-p
+00048950: 7265 7365 6e63 6522 2c0a 2020 2020 2020  resence",.      
+00048960: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
+00048970: 2c0a 2020 2020 2020 2020 6163 7469 6f6e  ,.        action
+00048980: 3d22 7374 6f72 655f 7472 7565 222c 0a20  ="store_true",. 
+00048990: 2020 2020 2020 2023 2064 6566 6175 6c74         # default
+000489a0: 7320 746f 2046 616c 7365 2069 6620 6e6f  s to False if no
+000489b0: 7420 7573 6564 0a20 2020 2020 2020 2068  t used.        h
+000489c0: 656c 703d 2247 6574 2079 6f75 7220 7072  elp="Get your pr
+000489d0: 6573 656e 6365 2e20 220a 2020 2020 2020  esence. ".      
+000489e0: 2020 6622 4465 7461 696c 733a 3a20 4765    f"Details:: Ge
+000489f0: 7420 7072 6573 656e 6365 206f 6620 7b50  t presence of {P
+00048a00: 524f 475f 5749 5448 4f55 545f 4558 547d  ROG_WITHOUT_EXT}
+00048a10: 2028 6974 7365 6c66 292c 2022 0a20 2020   (itself), ".   
+00048a20: 2020 2020 2022 6f72 206f 6620 6f6e 6520       "or of one 
+00048a30: 6f72 206d 756c 7469 706c 6520 7573 6572  or multiple user
+00048a40: 732e 2053 7065 6369 6679 2075 7365 7228  s. Specify user(
+00048a50: 7329 2077 6974 6820 7468 6520 220a 2020  s) with the ".  
+00048a60: 2020 2020 2020 222d 2d75 7365 7220 6f70        "--user op
+00048a70: 7469 6f6e 2e20 4966 206e 6f20 7573 6572  tion. If no user
+00048a80: 2069 7320 7370 6563 6966 6965 6420 6765   is specified ge
+00048a90: 7420 7468 6520 7072 6573 656e 6365 206f  t the presence o
+00048aa0: 6620 220a 2020 2020 2020 2020 2269 7473  f ".        "its
+00048ab0: 656c 662e 2022 0a20 2020 2020 2020 2022  elf. ".        "
+00048ac0: 5365 6e64 2c20 6c69 7374 656e 2061 6e64  Send, listen and
+00048ad0: 2076 6572 6966 7920 6f70 6572 6174 696f   verify operatio
+00048ae0: 6e73 2061 7265 2061 6c6c 6f77 6564 2077  ns are allowed w
+00048af0: 6865 6e20 220a 2020 2020 2020 2020 2267  hen ".        "g
+00048b00: 6574 7469 6e67 2070 7265 7365 6e63 6528  etting presence(
+00048b10: 7329 2e22 2c0a 2020 2020 290a 2020 2020  s).",.    ).    
+00048b20: 6170 2e61 6464 5f61 7267 756d 656e 7428  ap.add_argument(
+00048b30: 0a20 2020 2020 2020 2022 2d2d 7570 6c6f  .        "--uplo
+00048b40: 6164 222c 0a20 2020 2020 2020 2072 6571  ad",.        req
+00048b50: 7569 7265 643d 4661 6c73 652c 0a20 2020  uired=False,.   
+00048b60: 2020 2020 2061 6374 696f 6e3d 2265 7874       action="ext
+00048b70: 656e 6422 2c0a 2020 2020 2020 2020 6e61  end",.        na
+00048b80: 7267 733d 222b 222c 0a20 2020 2020 2020  rgs="+",.       
+00048b90: 2074 7970 653d 7374 722c 0a20 2020 2020   type=str,.     
+00048ba0: 2020 206d 6574 6176 6172 3d22 4649 4c45     metavar="FILE
+00048bb0: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
+00048bc0: 2255 706c 6f61 6420 6f6e 6520 6f72 206d  "Upload one or m
+00048bd0: 756c 7469 706c 6520 6669 6c65 7320 746f  ultiple files to
+00048be0: 2074 6865 2063 6f6e 7465 6e74 2072 6570   the content rep
+00048bf0: 6f73 6974 6f72 792e 2022 0a20 2020 2020  ository. ".     
+00048c00: 2020 2022 4465 7461 696c 733a 3a20 220a     "Details:: ".
+00048c10: 2020 2020 2020 2020 2254 6865 2066 696c          "The fil
+00048c20: 6573 2077 696c 6c20 6265 2067 6976 656e  es will be given
+00048c30: 2061 204d 6174 7269 7820 5552 4920 616e   a Matrix URI an
+00048c40: 6420 220a 2020 2020 2020 2020 2273 746f  d ".        "sto
+00048c50: 7265 6420 6f6e 2074 6865 2073 6572 7665  red on the serve
+00048c60: 722e 202d 2d75 706c 6f61 6420 616c 6c6f  r. --upload allo
+00048c70: 7773 2074 6865 206f 7074 696f 6e61 6c20  ws the optional 
+00048c80: 6172 6775 6d65 6e74 2022 0a20 2020 2020  argument ".     
+00048c90: 2020 2022 2d2d 706c 6169 6e20 746f 2073     "--plain to s
+00048ca0: 6b69 7020 656e 6372 7970 7469 6f6e 2066  kip encryption f
+00048cb0: 6f72 2075 706c 6f61 642e 2022 0a20 2020  or upload. ".   
+00048cc0: 2020 2020 2022 5365 6520 7465 7374 732f       "See tests/
+00048cd0: 7465 7374 2d75 706c 6f61 642e 7368 2066  test-upload.sh f
+00048ce0: 6f72 2061 6e20 6578 616d 706c 652e 222c  or an example.",
+00048cf0: 0a20 2020 2029 0a20 2020 2061 702e 6164  .    ).    ap.ad
+00048d00: 645f 6172 6775 6d65 6e74 280a 2020 2020  d_argument(.    
+00048d10: 2020 2020 222d 2d64 6f77 6e6c 6f61 6422      "--download"
+00048d20: 2c0a 2020 2020 2020 2020 7265 7175 6972  ,.        requir
+00048d30: 6564 3d46 616c 7365 2c0a 2020 2020 2020  ed=False,.      
+00048d40: 2020 6163 7469 6f6e 3d22 6578 7465 6e64    action="extend
+00048d50: 222c 0a20 2020 2020 2020 206e 6172 6773  ",.        nargs
+00048d60: 3d22 2b22 2c0a 2020 2020 2020 2020 7479  ="+",.        ty
+00048d70: 7065 3d73 7472 2c0a 2020 2020 2020 2020  pe=str,.        
+00048d80: 6d65 7461 7661 723d 224d 5843 5f55 5249  metavar="MXC_URI
+00048d90: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
+00048da0: 2244 6f77 6e6c 6f61 6420 6f6e 6520 6f72  "Download one or
+00048db0: 206d 756c 7469 706c 6520 6669 6c65 7320   multiple files 
+00048dc0: 6672 6f6d 2074 6865 2063 6f6e 7465 6e74  from the content
+00048dd0: 2072 6570 6f73 6974 6f72 792e 2022 0a20   repository. ". 
+00048de0: 2020 2020 2020 2022 4465 7461 696c 733a         "Details:
+00048df0: 3a20 220a 2020 2020 2020 2020 2259 6f75  : ".        "You
+00048e00: 206d 7573 7420 7072 6f76 6964 6520 6f6e   must provide on
+00048e10: 6520 6f72 206d 756c 7469 706c 6520 4d61  e or multiple Ma
+00048e20: 7472 6978 2055 5249 7320 284d 5843 7329  trix URIs (MXCs)
+00048e30: 2077 6869 6368 2061 7265 2022 0a20 2020   which are ".   
+00048e40: 2020 2020 2022 7374 7269 6e67 7320 6c69       "strings li
+00048e50: 6b65 2022 0a20 2020 2020 2020 2022 7468  ke ".        "th
+00048e60: 6973 2027 6d78 633a 2f2f 6578 616d 706c  is 'mxc://exampl
+00048e70: 652e 636f 6d2f 536f 6d65 5374 7261 6e67  e.com/SomeStrang
+00048e80: 6555 7269 4b65 7927 2e20 4966 2066 6f75  eUriKey'. If fou
+00048e90: 6e64 2074 6865 7920 7769 6c6c 2022 0a20  nd they will ". 
+00048ea0: 2020 2020 2020 2022 6265 2064 6f77 6e6c         "be downl
+00048eb0: 6f61 6465 642c 2064 6563 7279 7074 6564  oaded, decrypted
+00048ec0: 2c20 616e 6420 7374 6f72 6564 2069 6e20  , and stored in 
+00048ed0: 6c6f 6361 6c20 6669 6c65 732e 2022 0a20  local files. ". 
+00048ee0: 2020 2020 2020 2022 4966 2066 696c 6520         "If file 
+00048ef0: 6e61 6d65 7320 6172 6520 7370 6563 6966  names are specif
+00048f00: 6965 6420 7769 7468 202d 2d66 696c 652d  ied with --file-
+00048f10: 6e61 6d65 2074 6865 2064 6f77 6e6c 6f61  name the downloa
+00048f20: 6473 2022 0a20 2020 2020 2020 2022 7769  ds ".        "wi
+00048f30: 6c6c 2062 6520 7361 7665 6420 7769 7468  ll be saved with
+00048f40: 2074 6865 7365 2066 696c 6520 6e61 6d65   these file name
+00048f50: 732e 2049 6620 2d2d 6669 6c65 2d6e 616d  s. If --file-nam
+00048f60: 6520 6973 206e 6f74 2022 0a20 2020 2020  e is not ".     
+00048f70: 2020 2022 7370 6563 6966 6965 6420 7468     "specified th
+00048f80: 6520 6f72 6967 696e 616c 2066 696c 6520  e original file 
+00048f90: 6e61 6d65 2066 726f 6d20 7468 6520 7570  name from the up
+00048fa0: 6c6f 6164 2077 696c 6c20 6265 2075 7365  load will be use
+00048fb0: 642e 2022 0a20 2020 2020 2020 2022 4966  d. ".        "If
+00048fc0: 206e 6569 7468 6572 2073 7065 6369 6669   neither specifi
+00048fd0: 6564 206e 6f72 2061 7661 696c 6162 6c65  ed nor available
+00048fe0: 206f 6e20 7365 7276 6572 2c20 7468 656e   on server, then
+00048ff0: 2074 6865 2066 696c 6520 220a 2020 2020   the file ".    
+00049000: 2020 2020 6622 6e61 6d65 206f 6620 6c61      f"name of la
+00049010: 7374 2072 6573 6f72 7420 276d 7863 2d3c  st resort 'mxc-<
+00049020: 6d78 632d 6964 3e27 2077 696c 6c20 6265  mxc-id>' will be
+00049030: 2075 7365 642e 2022 0a20 2020 2020 2020   used. ".       
+00049040: 2066 2249 6620 6120 6669 6c65 206e 616d   f"If a file nam
+00049050: 6520 696e 202d 2d66 696c 652d 6e61 6d65  e in --file-name
+00049060: 2063 6f6e 7461 696e 7320 7468 6520 706c   contains the pl
+00049070: 6163 6568 6f6c 6465 7220 220a 2020 2020  aceholder ".    
+00049080: 2020 2020 6622 7b4d 5843 5f49 445f 504c      f"{MXC_ID_PL
+00049090: 4143 4548 4f4c 4445 527d 2c20 6974 2077  ACEHOLDER}, it w
+000490a0: 696c 6c20 6265 2072 6570 6c61 6365 6420  ill be replaced 
+000490b0: 7769 7468 2074 6865 206d 7863 2d69 642e  with the mxc-id.
+000490c0: 2022 0a20 2020 2020 2020 2022 4966 2061   ".        "If a
+000490d0: 2066 696c 6520 6e61 6d65 2069 7320 7370   file name is sp
+000490e0: 6563 6966 6965 6420 6173 2065 6d70 7479  ecified as empty
+000490f0: 2073 7472 696e 6720 696e 202d 2d66 696c   string in --fil
+00049100: 652d 6e61 6d65 2c20 7468 656e 2022 0a20  e-name, then ". 
+00049110: 2020 2020 2020 2022 616c 736f 2074 6865         "also the
+00049120: 206e 616d 6520 276d 7863 2d3c 6d78 632d   name 'mxc-<mxc-
+00049130: 6964 3e27 2077 696c 6c20 6265 2075 7365  id>' will be use
+00049140: 642e 2022 0a20 2020 2020 2020 2022 4279  d. ".        "By
+00049150: 2064 6566 6175 6c74 2c20 7468 6520 7570   default, the up
+00049160: 6c6f 6164 2077 6173 2065 6e63 7279 7074  load was encrypt
+00049170: 6564 2073 6f20 6120 6465 6372 7970 7469  ed so a decrypti
+00049180: 6f6e 2064 6963 7469 6f6e 6172 7920 220a  on dictionary ".
+00049190: 2020 2020 2020 2020 226d 7573 7420 6265          "must be
+000491a0: 2070 726f 7669 6465 6420 746f 2064 6563   provided to dec
+000491b0: 7279 7074 2074 6865 2064 6174 612e 2053  rypt the data. S
+000491c0: 7065 6369 6679 206f 6e65 206f 7220 6d75  pecify one or mu
+000491d0: 6c74 6970 6c65 2022 0a20 2020 2020 2020  ltiple ".       
+000491e0: 2022 6465 6372 7970 7469 6f6e 206b 6579   "decryption key
+000491f0: 7320 220a 2020 2020 2020 2020 2277 6974  s ".        "wit
+00049200: 6820 2d2d 6b65 792d 6469 6374 2e20 4966  h --key-dict. If
+00049210: 202d 2d6b 6579 2d64 6963 7420 6973 206e   --key-dict is n
+00049220: 6f74 2073 6574 2c20 6e6f 7420 6465 6372  ot set, not decr
+00049230: 7970 7469 6f6e 2069 7320 220a 2020 2020  yption is ".    
+00049240: 2020 2020 2261 7474 656d 7074 6564 3b20      "attempted; 
+00049250: 616e 6420 7468 6520 6461 7461 206d 6967  and the data mig
+00049260: 6874 2062 6520 7374 6f72 6564 2069 6e20  ht be stored in 
+00049270: 656e 6372 7970 7465 6420 6661 7368 696f  encrypted fashio
+00049280: 6e2c 2022 0a20 2020 2020 2020 2022 6f72  n, ".        "or
+00049290: 206d 6967 6874 2062 6520 706c 6169 6e2d   might be plain-
+000492a0: 7465 7874 2069 6620 7468 6520 2d2d 7570  text if the --up
+000492b0: 6c6f 6164 2073 6b69 7070 6564 2065 6e63  load skipped enc
+000492c0: 7279 7074 696f 6e20 7769 7468 2022 0a20  ryption with ". 
+000492d0: 2020 2020 2020 2022 2d2d 706c 6169 6e2e         "--plain.
+000492e0: 2022 0a20 2020 2020 2020 2022 5365 6520   ".        "See 
+000492f0: 7465 7374 732f 7465 7374 2d75 706c 6f61  tests/test-uploa
+00049300: 642e 7368 2066 6f72 2061 6e20 6578 616d  d.sh for an exam
+00049310: 706c 652e 222c 0a20 2020 2029 0a20 2020  ple.",.    ).   
+00049320: 2061 702e 6164 645f 6172 6775 6d65 6e74   ap.add_argument
+00049330: 280a 2020 2020 2020 2020 222d 2d64 656c  (.        "--del
+00049340: 6574 652d 6d78 6322 2c0a 2020 2020 2020  ete-mxc",.      
+00049350: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
+00049360: 2c0a 2020 2020 2020 2020 6163 7469 6f6e  ,.        action
+00049370: 3d22 6578 7465 6e64 222c 0a20 2020 2020  ="extend",.     
+00049380: 2020 206e 6172 6773 3d22 2b22 2c0a 2020     nargs="+",.  
+00049390: 2020 2020 2020 7479 7065 3d73 7472 2c0a        type=str,.
+000493a0: 2020 2020 2020 2020 6d65 7461 7661 723d          metavar=
+000493b0: 224d 5843 5f55 5249 222c 0a20 2020 2020  "MXC_URI",.     
+000493c0: 2020 2068 656c 703d 2244 656c 6574 6520     help="Delete 
+000493d0: 6f6e 6520 6f72 206d 756c 7469 706c 6520  one or multiple 
+000493e0: 6f62 6a65 6374 7320 6672 6f6d 2074 6865  objects from the
+000493f0: 2063 6f6e 7465 6e74 2072 6570 6f73 6974   content reposit
+00049400: 6f72 792e 2022 0a20 2020 2020 2020 2022  ory. ".        "
+00049410: 4465 7461 696c 733a 3a20 596f 7520 6d75  Details:: You mu
+00049420: 7374 2070 726f 7669 6465 206f 6e65 206f  st provide one o
+00049430: 7220 6d75 6c74 6970 6c65 204d 6174 7269  r multiple Matri
+00049440: 7820 5552 4973 2028 4d58 4329 2022 0a20  x URIs (MXC) ". 
+00049450: 2020 2020 2020 2022 7768 6963 6820 6172         "which ar
+00049460: 6520 7374 7269 6e67 7320 6c69 6b65 2022  e strings like "
+00049470: 0a20 2020 2020 2020 2022 7468 6973 2027  .        "this '
+00049480: 6d78 633a 2f2f 6578 616d 706c 652e 636f  mxc://example.co
+00049490: 6d2f 536f 6d65 5374 7261 6e67 6555 7269  m/SomeStrangeUri
+000494a0: 4b65 7927 2e20 416c 7465 726e 6174 6976  Key'. Alternativ
+000494b0: 656c 792c 2079 6f75 2022 0a20 2020 2020  ely, you ".     
+000494c0: 2020 2022 6361 6e20 6a75 7374 2070 726f     "can just pro
+000494d0: 7669 6465 2074 6865 204d 5843 2069 642c  vide the MXC id,
+000494e0: 2069 2e65 2e20 7468 6520 7061 7274 2061   i.e. the part a
+000494f0: 6674 6572 2074 6865 206c 6173 7420 736c  fter the last sl
+00049500: 6173 682e 2022 0a20 2020 2020 2020 2022  ash. ".        "
+00049510: 4966 2066 6f75 6e64 2074 6865 7920 2869  If found they (i
+00049520: 2e65 2e20 7468 6520 6669 6c65 7320 7468  .e. the files th
+00049530: 6579 2072 6570 7265 7365 6e74 2920 7769  ey represent) wi
+00049540: 6c6c 2022 0a20 2020 2020 2020 2022 6265  ll ".        "be
+00049550: 2064 656c 6574 6564 2066 726f 6d20 7468   deleted from th
+00049560: 6520 7365 7276 6572 2064 6174 6162 6173  e server databas
+00049570: 652e 2049 6e20 6f72 6465 7220 746f 2064  e. In order to d
+00049580: 656c 6574 6520 6f62 6a65 6374 7320 220a  elete objects ".
+00049590: 2020 2020 2020 2020 226f 6e65 206d 7573          "one mus
+000495a0: 7420 6861 7665 2073 6572 7665 7220 6164  t have server ad
+000495b0: 6d69 6e20 7065 726d 6973 7369 6f6e 732e  min permissions.
+000495c0: 2048 6176 696e 6720 6f6e 6c79 2072 6f6f   Having only roo
+000495d0: 6d20 6164 6d69 6e20 220a 2020 2020 2020  m admin ".      
+000495e0: 2020 2270 6572 6d69 7373 696f 6e73 2069    "permissions i
+000495f0: 7320 6e6f 7420 7375 6666 6963 6965 6e74  s not sufficient
+00049600: 2061 6e64 2069 7420 7769 6c6c 2066 6169   and it will fai
+00049610: 6c2e 2022 0a20 2020 2020 2020 2022 5265  l. ".        "Re
+00049620: 6164 2022 0a20 2020 2020 2020 2022 6874  ad ".        "ht
+00049630: 7470 733a 2f2f 6d61 7472 6978 2d6f 7267  tps://matrix-org
+00049640: 2e67 6974 6875 622e 696f 2f73 796e 6170  .github.io/synap
+00049650: 7365 2f22 0a20 2020 2020 2020 2022 6c61  se/".        "la
+00049660: 7465 7374 2f75 7361 6765 2f61 646d 696e  test/usage/admin
+00049670: 6973 7472 6174 696f 6e2f 6164 6d69 6e5f  istration/admin_
+00049680: 6170 692f 2022 0a20 2020 2020 2020 2022  api/ ".        "
+00049690: 666f 7220 6c65 6172 6e69 6e67 2068 6f77  for learning how
+000496a0: 2074 6f20 7365 7420 7365 7276 6572 2061   to set server a
+000496b0: 646d 696e 2070 6572 6d69 7373 696f 6e73  dmin permissions
+000496c0: 206f 6e20 7468 6520 220a 2020 2020 2020   on the ".      
+000496d0: 2020 2273 6572 7665 722e 2041 6c74 6572    "server. Alter
+000496e0: 6e61 7469 7665 6c79 2c20 616e 6420 6f70  natively, and op
+000496f0: 7469 6f6e 616c 6c79 2c20 6f6e 6520 6361  tionally, one ca
+00049700: 6e20 7370 6563 6966 7920 220a 2020 2020  n specify ".    
+00049710: 2020 2020 2261 6e20 6163 6365 7373 2074      "an access t
+00049720: 6f6b 656e 2077 6869 6368 2068 6173 2073  oken which has s
+00049730: 6572 7665 7220 6164 6d69 6e20 7065 726d  erver admin perm
+00049740: 6973 7369 6f6e 7320 7769 7468 2074 6865  issions with the
+00049750: 2022 0a20 2020 2020 2020 2022 2d2d 6163   ".        "--ac
+00049760: 6365 7373 2d74 6f6b 656e 2061 7267 756d  cess-token argum
+00049770: 656e 742e 2022 0a20 2020 2020 2020 2022  ent. ".        "
+00049780: 5365 6520 7465 7374 732f 7465 7374 2d75  See tests/test-u
+00049790: 706c 6f61 642e 7368 2066 6f72 2061 6e20  pload.sh for an 
+000497a0: 6578 616d 706c 652e 222c 0a20 2020 2029  example.",.    )
+000497b0: 0a20 2020 2061 702e 6164 645f 6172 6775  .    ap.add_argu
+000497c0: 6d65 6e74 280a 2020 2020 2020 2020 222d  ment(.        "-
+000497d0: 2d64 656c 6574 652d 6d78 632d 6265 666f  -delete-mxc-befo
+000497e0: 7265 222c 0a20 2020 2020 2020 2072 6571  re",.        req
+000497f0: 7569 7265 643d 4661 6c73 652c 0a20 2020  uired=False,.   
+00049800: 2020 2020 2061 6374 696f 6e3d 2265 7874       action="ext
+00049810: 656e 6422 2c0a 2020 2020 2020 2020 6e61  end",.        na
+00049820: 7267 733d 222b 222c 0a20 2020 2020 2020  rgs="+",.       
+00049830: 2074 7970 653d 7374 722c 0a20 2020 2020   type=str,.     
+00049840: 2020 206d 6574 6176 6172 3d22 5449 4d45     metavar="TIME
+00049850: 5354 414d 5022 2c0a 2020 2020 2020 2020  STAMP",.        
+00049860: 6865 6c70 3d22 4465 6c65 7465 206f 6c64  help="Delete old
+00049870: 206f 626a 6563 7473 2066 726f 6d20 7468   objects from th
+00049880: 6520 636f 6e74 656e 7420 7265 706f 7369  e content reposi
+00049890: 746f 7279 220a 2020 2020 2020 2020 2244  tory".        "D
+000498a0: 6574 6169 6c73 3a3a 2044 656c 6574 6520  etails:: Delete 
+000498b0: 6669 6c65 7320 6672 6f6d 2074 6865 2063  files from the c
+000498c0: 6f6e 7465 6e74 2072 6570 6f73 6974 6f72  ontent repositor
+000498d0: 7920 220a 2020 2020 2020 2020 2274 6861  y ".        "tha
+000498e0: 7420 6172 6520 6f6c 6465 7220 7468 616e  t are older than
+000498f0: 2061 2067 6976 656e 2074 696d 6573 7461   a given timesta
+00049900: 6d70 2e20 220a 2020 2020 2020 2020 2249  mp. ".        "I
+00049910: 7420 6973 2074 6865 2074 696d 6573 7461  t is the timesta
+00049920: 6d70 206f 6620 6c61 7374 2061 6363 6573  mp of last acces
+00049930: 732c 206e 6f74 2074 6865 2074 696d 6573  s, not the times
+00049940: 7461 6d70 2077 6865 6e20 220a 2020 2020  tamp when ".    
+00049950: 2020 2020 2274 6865 2066 696c 6520 7761      "the file wa
+00049960: 7320 6372 6561 7465 642e 2022 0a20 2020  s created. ".   
+00049970: 2020 2020 2022 4164 6469 7469 6f6e 616c       "Additional
+00049980: 6c79 2079 6f75 2063 616e 2073 7065 6369  ly you can speci
+00049990: 6679 2061 2073 697a 6520 696e 2062 7974  fy a size in byt
+000499a0: 6573 2074 6f20 696e 6469 6361 7465 2022  es to indicate "
+000499b0: 0a20 2020 2020 2020 2022 7468 6174 206f  .        "that o
+000499c0: 6e6c 7920 6669 6c65 7320 6f6c 6465 7220  nly files older 
+000499d0: 7468 616e 2074 696d 6573 7461 6d70 2061  than timestamp a
+000499e0: 6e64 206c 6172 6765 7220 7468 616e 2073  nd larger than s
+000499f0: 697a 6520 220a 2020 2020 2020 2020 2277  ize ".        "w
+00049a00: 696c 6c20 6265 2064 656c 6574 6564 2e20  ill be deleted. 
+00049a10: 220a 2020 2020 2020 2020 2259 6f75 206d  ".        "You m
+00049a20: 7573 7420 7072 6f76 6964 6520 6120 7469  ust provide a ti
+00049a30: 6d65 7374 616d 7020 6f66 2074 6865 2066  mestamp of the f
+00049a40: 6f6c 6c6f 7769 6e67 2066 6f72 6d61 743a  ollowing format:
+00049a50: 2022 0a20 2020 2020 2020 2022 2744 442e   ".        "'DD.
+00049a60: 4d4d 2e59 5959 5920 4848 3a4d 4d3a 5353  MM.YYYY HH:MM:SS
+00049a70: 2720 6c69 6b65 2027 3230 2e30 312e 3230  ' like '20.01.20
+00049a80: 3232 2031 393a 3338 3a34 3227 2066 6f72  22 19:38:42' for
+00049a90: 204a 616e 7561 7279 2032 302c 2022 0a20   January 20, ". 
+00049aa0: 2020 2020 2020 2022 3230 3232 2c20 3770         "2022, 7p
+00049ab0: 6d20 3338 6d69 6e20 3432 7365 632e 2022  m 38min 42sec. "
+00049ac0: 0a20 2020 2020 2020 2022 4669 6c65 7320  .        "Files 
+00049ad0: 7468 6174 2061 7265 2073 7469 6c6c 2075  that are still u
+00049ae0: 7365 6420 696e 2069 6d61 6765 2064 6174  sed in image dat
+00049af0: 6120 2865 2e67 2075 7365 7220 7072 6f66  a (e.g user prof
+00049b00: 696c 652c 2022 0a20 2020 2020 2020 2022  ile, ".        "
+00049b10: 726f 6f6d 2061 7661 7461 7229 2077 696c  room avatar) wil
+00049b20: 6c20 6e6f 7420 6265 2064 656c 6574 6564  l not be deleted
+00049b30: 2066 726f 6d20 7468 6520 7365 7276 6572   from the server
+00049b40: 2064 6174 6162 6173 652e 2022 0a20 2020   database. ".   
+00049b50: 2020 2020 2022 496e 206f 7264 6572 2074       "In order t
+00049b60: 6f20 6465 6c65 7465 206f 626a 6563 7473  o delete objects
+00049b70: 2022 0a20 2020 2020 2020 2022 6f6e 6520   ".        "one 
+00049b80: 6d75 7374 2068 6176 6520 7365 7276 6572  must have server
+00049b90: 2061 646d 696e 2070 6572 6d69 7373 696f   admin permissio
+00049ba0: 6e73 2e20 4861 7669 6e67 206f 6e6c 7920  ns. Having only 
+00049bb0: 726f 6f6d 2061 646d 696e 2022 0a20 2020  room admin ".   
+00049bc0: 2020 2020 2022 7065 726d 6973 7369 6f6e       "permission
+00049bd0: 7320 6973 206e 6f74 2073 7566 6669 6369  s is not suffici
+00049be0: 656e 7420 616e 6420 6974 2077 696c 6c20  ent and it will 
+00049bf0: 6661 696c 2e20 220a 2020 2020 2020 2020  fail. ".        
+00049c00: 2252 6561 6420 220a 2020 2020 2020 2020  "Read ".        
+00049c10: 2268 7474 7073 3a2f 2f6d 6174 7269 782d  "https://matrix-
+00049c20: 6f72 672e 6769 7468 7562 2e69 6f2f 7379  org.github.io/sy
+00049c30: 6e61 7073 652f 220a 2020 2020 2020 2020  napse/".        
+00049c40: 226c 6174 6573 742f 7573 6167 652f 6164  "latest/usage/ad
+00049c50: 6d69 6e69 7374 7261 7469 6f6e 2f61 646d  ministration/adm
+00049c60: 696e 5f61 7069 2f20 220a 2020 2020 2020  in_api/ ".      
+00049c70: 2020 2266 6f72 206c 6561 726e 696e 6720    "for learning 
+00049c80: 686f 7720 746f 2073 6574 2073 6572 7665  how to set serve
+00049c90: 7220 6164 6d69 6e20 7065 726d 6973 7369  r admin permissi
+00049ca0: 6f6e 7320 6f6e 2074 6865 2022 0a20 2020  ons on the ".   
+00049cb0: 2020 2020 2022 7365 7276 6572 2e20 416c       "server. Al
+00049cc0: 7465 726e 6174 6976 656c 792c 2061 6e64  ternatively, and
+00049cd0: 206f 7074 696f 6e61 6c6c 792c 206f 6e65   optionally, one
+00049ce0: 2063 616e 2073 7065 6369 6679 2022 0a20   can specify ". 
+00049cf0: 2020 2020 2020 2022 616e 2061 6363 6573         "an acces
+00049d00: 7320 746f 6b65 6e20 7768 6963 6820 6861  s token which ha
+00049d10: 7320 7365 7276 6572 2061 646d 696e 2070  s server admin p
+00049d20: 6572 6d69 7373 696f 6e73 2077 6974 6820  ermissions with 
+00049d30: 7468 6520 220a 2020 2020 2020 2020 222d  the ".        "-
+00049d40: 2d61 6363 6573 732d 746f 6b65 6e20 6172  -access-token ar
+00049d50: 6775 6d65 6e74 2e20 220a 2020 2020 2020  gument. ".      
+00049d60: 2020 2253 6565 2074 6573 7473 2f74 6573    "See tests/tes
+00049d70: 742d 7570 6c6f 6164 2e73 6820 666f 7220  t-upload.sh for 
+00049d80: 616e 2065 7861 6d70 6c65 2e22 2c0a 2020  an example.",.  
+00049d90: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
+00049da0: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
+00049db0: 2023 206e 6f20 7369 6e67 6c65 2063 6861   # no single cha
+00049dc0: 7220 666c 6167 0a20 2020 2020 2020 2022  r flag.        "
+00049dd0: 2d2d 6a6f 696e 6564 2d72 6f6f 6d73 222c  --joined-rooms",
+00049de0: 0a20 2020 2020 2020 2072 6571 7569 7265  .        require
+00049df0: 643d 4661 6c73 652c 0a20 2020 2020 2020  d=False,.       
+00049e00: 2061 6374 696f 6e3d 2273 746f 7265 5f74   action="store_t
+00049e10: 7275 6522 2c0a 2020 2020 2020 2020 6865  rue",.        he
+00049e20: 6c70 3d22 5072 696e 7420 7468 6520 6c69  lp="Print the li
+00049e30: 7374 206f 6620 6a6f 696e 6564 2072 6f6f  st of joined roo
+00049e40: 6d73 2e20 220a 2020 2020 2020 2020 2244  ms. ".        "D
+00049e50: 6574 6169 6c73 3a3a 2041 6c6c 2072 6f6f  etails:: All roo
+00049e60: 6d73 2074 6861 7420 796f 7520 6172 6520  ms that you are 
+00049e70: 6120 220a 2020 2020 2020 2020 226d 656d  a ".        "mem
+00049e80: 6265 7220 6f66 2077 696c 6c20 6265 2070  ber of will be p
+00049e90: 7269 6e74 6564 2c20 6f6e 6520 726f 6f6d  rinted, one room
+00049ea0: 2070 6572 206c 696e 652e 222c 0a20 2020   per line.",.   
+00049eb0: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
+00049ec0: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
+00049ed0: 2320 6e6f 2073 696e 676c 6520 6368 6172  # no single char
+00049ee0: 2066 6c61 670a 2020 2020 2020 2020 222d   flag.        "-
+00049ef0: 2d6a 6f69 6e65 642d 6d65 6d62 6572 7322  -joined-members"
+00049f00: 2c0a 2020 2020 2020 2020 7265 7175 6972  ,.        requir
+00049f10: 6564 3d46 616c 7365 2c0a 2020 2020 2020  ed=False,.      
+00049f20: 2020 6163 7469 6f6e 3d22 6578 7465 6e64    action="extend
+00049f30: 222c 0a20 2020 2020 2020 206e 6172 6773  ",.        nargs
+00049f40: 3d22 2b22 2c0a 2020 2020 2020 2020 7479  ="+",.        ty
+00049f50: 7065 3d73 7472 2c0a 2020 2020 2020 2020  pe=str,.        
+00049f60: 6d65 7461 7661 723d 2252 4f4f 4d22 2c0a  metavar="ROOM",.
+00049f70: 2020 2020 2020 2020 6865 6c70 3d22 5072          help="Pr
+00049f80: 696e 7420 7468 6520 6c69 7374 206f 6620  int the list of 
+00049f90: 6a6f 696e 6564 206d 656d 6265 7273 2066  joined members f
+00049fa0: 6f72 206f 6e65 206f 7220 6d75 6c74 6970  or one or multip
+00049fb0: 6c65 2072 6f6f 6d73 2e20 220a 2020 2020  le rooms. ".    
+00049fc0: 2020 2020 2244 6574 6169 6c73 3a3a 2049      "Details:: I
+00049fd0: 6620 796f 7520 7761 6e74 2074 6f20 7072  f you want to pr
+00049fe0: 696e 7420 7468 6520 6a6f 696e 6564 206d  int the joined m
+00049ff0: 656d 6265 7273 206f 6620 616c 6c20 726f  embers of all ro
+0004a000: 6f6d 7320 7468 6174 2022 0a20 2020 2020  oms that ".     
+0004a010: 2020 2022 796f 7520 6172 6520 6d65 6d62     "you are memb
+0004a020: 6572 206f 662c 2074 6865 6e20 7573 6520  er of, then use 
+0004a030: 7468 6520 7370 6563 6961 6c20 6368 6172  the special char
+0004a040: 6163 7465 7220 272a 272e 222c 0a20 2020  acter '*'.",.   
+0004a050: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
+0004a060: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
+0004a070: 222d 2d6d 7863 2d74 6f2d 6874 7470 222c  "--mxc-to-http",
+0004a080: 0a20 2020 2020 2020 2072 6571 7569 7265  .        require
+0004a090: 643d 4661 6c73 652c 0a20 2020 2020 2020  d=False,.       
+0004a0a0: 2061 6374 696f 6e3d 2265 7874 656e 6422   action="extend"
+0004a0b0: 2c0a 2020 2020 2020 2020 6e61 7267 733d  ,.        nargs=
+0004a0c0: 222b 222c 0a20 2020 2020 2020 2074 7970  "+",.        typ
+0004a0d0: 653d 7374 722c 0a20 2020 2020 2020 206d  e=str,.        m
+0004a0e0: 6574 6176 6172 3d22 4d58 435f 5552 4922  etavar="MXC_URI"
+0004a0f0: 2c0a 2020 2020 2020 2020 6865 6c70 3d22  ,.        help="
+0004a100: 436f 6e76 6572 7420 4d58 4320 5552 4973  Convert MXC URIs
+0004a110: 2074 6f20 4854 5450 2055 524c 732e 2022   to HTTP URLs. "
+0004a120: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
+0004a130: 733a 3a20 436f 6e76 6572 7420 6f6e 6520  s:: Convert one 
+0004a140: 6f72 206d 6f72 6520 6d61 7472 6978 2063  or more matrix c
+0004a150: 6f6e 7465 6e74 2055 5249 7320 746f 2074  ontent URIs to t
+0004a160: 6865 2022 0a20 2020 2020 2020 2022 636f  he ".        "co
+0004a170: 7272 6573 706f 6e64 696e 6720 4854 5450  rresponding HTTP
+0004a180: 2055 524c 732e 2054 6865 204d 5843 2055   URLs. The MXC U
+0004a190: 5249 7320 220a 2020 2020 2020 2020 2274  RIs ".        "t
+0004a1a0: 6f20 7072 6f76 6964 6520 6c6f 6f6b 2073  o provide look s
+0004a1b0: 6f6d 6574 6869 6e67 206c 696b 6520 7468  omething like th
+0004a1c0: 6973 2022 0a20 2020 2020 2020 2022 276d  is ".        "'m
+0004a1d0: 7863 3a2f 2f65 7861 6d70 6c65 2e63 6f6d  xc://example.com
+0004a1e0: 2f53 6f6d 6553 7472 616e 6765 5572 694b  /SomeStrangeUriK
+0004a1f0: 6579 272e 2022 0a20 2020 2020 2020 2022  ey'. ".        "
+0004a200: 5365 6520 7465 7374 732f 7465 7374 2d75  See tests/test-u
+0004a210: 706c 6f61 642e 7368 2066 6f72 2061 6e20  pload.sh for an 
+0004a220: 6578 616d 706c 652e 222c 0a20 2020 2029  example.",.    )
+0004a230: 0a20 2020 2061 702e 6164 645f 6172 6775  .    ap.add_argu
+0004a240: 6d65 6e74 280a 2020 2020 2020 2020 2320  ment(.        # 
+0004a250: 6e6f 2073 696e 676c 6520 6368 6172 2066  no single char f
+0004a260: 6c61 670a 2020 2020 2020 2020 222d 2d64  lag.        "--d
+0004a270: 6576 6963 6573 222c 0a20 2020 2020 2020  evices",.       
+0004a280: 2022 2d2d 6765 742d 6465 7669 6365 7322   "--get-devices"
+0004a290: 2c20 2023 2061 6c69 6173 2c20 6361 7573  ,  # alias, caus
+0004a2a0: 6520 2d2d 6465 7669 6365 6420 6973 2076  e --deviced is v
+0004a2b0: 6572 7920 7369 6d69 6c61 7220 746f 202d  ery similar to -
+0004a2c0: 2d64 6576 6963 650a 2020 2020 2020 2020  -device.        
+0004a2d0: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
+0004a2e0: 2020 2020 2020 2020 6163 7469 6f6e 3d22          action="
+0004a2f0: 7374 6f72 655f 7472 7565 222c 0a20 2020  store_true",.   
+0004a300: 2020 2020 2068 656c 703d 2250 7269 6e74       help="Print
+0004a310: 2074 6865 206c 6973 7420 6f66 2064 6576   the list of dev
+0004a320: 6963 6573 2e20 220a 2020 2020 2020 2020  ices. ".        
+0004a330: 2244 6574 6169 6c73 3a3a 2041 6c6c 2064  "Details:: All d
+0004a340: 6576 6963 6520 6f66 2074 6869 7320 220a  evice of this ".
+0004a350: 2020 2020 2020 2020 2261 6363 6f75 6e74          "account
+0004a360: 2077 696c 6c20 6265 2070 7269 6e74 6564   will be printed
+0004a370: 2c20 6f6e 6520 6465 7669 6365 2070 6572  , one device per
+0004a380: 206c 696e 652e 222c 0a20 2020 2029 0a20   line.",.    ). 
+0004a390: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
+0004a3a0: 6e74 280a 2020 2020 2020 2020 2320 6e6f  nt(.        # no
+0004a3b0: 2073 696e 676c 6520 6368 6172 2066 6c61   single char fla
+0004a3c0: 670a 2020 2020 2020 2020 222d 2d64 6973  g.        "--dis
+0004a3d0: 636f 7665 7279 2d69 6e66 6f22 2c0a 2020  covery-info",.  
+0004a3e0: 2020 2020 2020 7265 7175 6972 6564 3d46        required=F
+0004a3f0: 616c 7365 2c0a 2020 2020 2020 2020 6163  alse,.        ac
+0004a400: 7469 6f6e 3d22 7374 6f72 655f 7472 7565  tion="store_true
+0004a410: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
+0004a420: 2250 7269 6e74 2064 6973 636f 7665 7279  "Print discovery
+0004a430: 2069 6e66 6f72 6d61 7469 6f6e 2061 626f   information abo
+0004a440: 7574 2063 7572 7265 6e74 2068 6f6d 6573  ut current homes
+0004a450: 6572 7665 722e 2022 0a20 2020 2020 2020  erver. ".       
+0004a460: 2022 4465 7461 696c 733a 3a20 4e6f 7465   "Details:: Note
+0004a470: 2074 6861 7420 6e6f 7420 616c 6c20 686f   that not all ho
+0004a480: 6d65 7365 7276 6572 7320 7375 7070 6f72  meservers suppor
+0004a490: 7420 6469 7363 6f76 6572 7920 616e 6420  t discovery and 
+0004a4a0: 616e 2022 0a20 2020 2020 2020 2022 6572  an ".        "er
+0004a4b0: 726f 7220 6d69 6768 7420 6265 2072 6570  ror might be rep
+0004a4c0: 6f72 7465 642e 222c 0a20 2020 2029 0a20  orted.",.    ). 
+0004a4d0: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
+0004a4e0: 6e74 280a 2020 2020 2020 2020 2320 6e6f  nt(.        # no
+0004a4f0: 2073 696e 676c 6520 6368 6172 2066 6c61   single char fla
+0004a500: 670a 2020 2020 2020 2020 222d 2d6c 6f67  g.        "--log
+0004a510: 696e 2d69 6e66 6f22 2c0a 2020 2020 2020  in-info",.      
+0004a520: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
+0004a530: 2c0a 2020 2020 2020 2020 6163 7469 6f6e  ,.        action
+0004a540: 3d22 7374 6f72 655f 7472 7565 222c 0a20  ="store_true",. 
+0004a550: 2020 2020 2020 2068 656c 703d 2250 7269         help="Pri
+0004a560: 6e74 206c 6f67 696e 206d 6574 686f 6473  nt login methods
+0004a570: 2073 7570 706f 7274 6564 2062 7920 7468   supported by th
+0004a580: 6520 686f 6d65 7365 7276 6572 2e20 220a  e homeserver. ".
+0004a590: 2020 2020 2020 2020 2244 6574 6169 6c73          "Details
+0004a5a0: 3a3a 2049 7420 7072 696e 7473 206f 6e65  :: It prints one
+0004a5b0: 206c 6f67 696e 206d 6574 686f 6420 7065   login method pe
+0004a5c0: 7220 6c69 6e65 2e22 2c0a 2020 2020 290a  r line.",.    ).
+0004a5d0: 2020 2020 6170 2e61 6464 5f61 7267 756d      ap.add_argum
+0004a5e0: 656e 7428 0a20 2020 2020 2020 2023 206e  ent(.        # n
+0004a5f0: 6f20 7369 6e67 6c65 2063 6861 7220 666c  o single char fl
+0004a600: 6167 0a20 2020 2020 2020 2022 2d2d 636f  ag.        "--co
+0004a610: 6e74 656e 742d 7265 706f 7369 746f 7279  ntent-repository
+0004a620: 2d63 6f6e 6669 6722 2c0a 2020 2020 2020  -config",.      
+0004a630: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
+0004a640: 2c0a 2020 2020 2020 2020 6163 7469 6f6e  ,.        action
+0004a650: 3d22 7374 6f72 655f 7472 7565 222c 0a20  ="store_true",. 
+0004a660: 2020 2020 2020 2068 656c 703d 2250 7269         help="Pri
+0004a670: 6e74 2074 6865 2063 6f6e 7465 6e74 2072  nt the content r
+0004a680: 6570 6f73 6974 6f72 7920 636f 6e66 6967  epository config
+0004a690: 7572 6174 696f 6e2e 2022 0a20 2020 2020  uration. ".     
+0004a6a0: 2020 2022 4465 7461 696c 733a 3a20 5468     "Details:: Th
+0004a6b0: 6973 2063 7572 7265 6e74 6c79 206a 7573  is currently jus
+0004a6c0: 7420 7072 696e 7473 2022 0a20 2020 2020  t prints ".     
+0004a6d0: 2020 2022 7468 6520 7570 6c6f 6164 2073     "the upload s
+0004a6e0: 697a 6520 6c69 6d69 7420 696e 2062 7974  ize limit in byt
+0004a6f0: 6573 2e22 2c0a 2020 2020 290a 2020 2020  es.",.    ).    
+0004a700: 6170 2e61 6464 5f61 7267 756d 656e 7428  ap.add_argument(
+0004a710: 0a20 2020 2020 2020 2023 206e 6f20 7369  .        # no si
+0004a720: 6e67 6c65 2063 6861 7220 666c 6167 0a20  ngle char flag. 
+0004a730: 2020 2020 2020 2022 2d2d 7265 7374 222c         "--rest",
+0004a740: 0a20 2020 2020 2020 2072 6571 7569 7265  .        require
+0004a750: 643d 4661 6c73 652c 0a20 2020 2020 2020  d=False,.       
+0004a760: 2061 6374 696f 6e3d 2265 7874 656e 6422   action="extend"
+0004a770: 2c0a 2020 2020 2020 2020 6e61 7267 733d  ,.        nargs=
+0004a780: 222b 222c 0a20 2020 2020 2020 2074 7970  "+",.        typ
+0004a790: 653d 7374 722c 0a20 2020 2020 2020 206d  e=str,.        m
+0004a7a0: 6574 6176 6172 3d22 5245 5354 5f4d 4554  etavar="REST_MET
+0004a7b0: 484f 4420 4441 5441 2055 524c 222c 0a20  HOD DATA URL",. 
+0004a7c0: 2020 2020 2020 2068 656c 703d 2255 7365         help="Use
+0004a7d0: 2074 6865 204d 6174 7269 7820 436c 6965   the Matrix Clie
+0004a7e0: 6e74 2052 4553 5420 4150 492e 2022 0a20  nt REST API. ". 
+0004a7f0: 2020 2020 2020 2022 4465 7461 696c 733a         "Details:
+0004a800: 3a20 4d61 7472 6978 2068 6173 2073 6576  : Matrix has sev
+0004a810: 6572 616c 2065 7874 656e 7369 7665 2022  eral extensive "
+0004a820: 0a20 2020 2020 2020 2022 5245 5354 2041  .        "REST A
+0004a830: 5049 732e 2057 6974 6820 7468 6520 2d2d  PIs. With the --
+0004a840: 7265 7374 2061 7267 756d 656e 7420 796f  rest argument yo
+0004a850: 7520 6361 6e20 696e 766f 6b65 2061 204d  u can invoke a M
+0004a860: 6174 7269 7820 5245 5354 2022 0a20 2020  atrix REST ".   
+0004a870: 2020 2020 2022 4150 4920 6361 6c6c 2e20       "API call. 
+0004a880: 5468 6973 2061 6c6c 6f77 7320 7468 6520  This allows the 
+0004a890: 7573 6572 2074 6f20 646f 2070 7265 7474  user to do prett
+0004a8a0: 7920 6d75 6368 2061 6e79 7468 696e 672c  y much anything,
+0004a8b0: 2061 7420 7468 6520 220a 2020 2020 2020   at the ".      
+0004a8c0: 2020 2270 7269 6365 206f 6620 6e6f 7420    "price of not 
+0004a8d0: 6265 696e 6720 7665 7279 2063 6f6e 7665  being very conve
+0004a8e0: 6e69 656e 742e 2054 6865 2041 5049 7320  nient. The APIs 
+0004a8f0: 6172 6520 6465 7363 7269 6265 6420 696e  are described in
+0004a900: 2022 0a20 2020 2020 2020 2022 6874 7470   ".        "http
+0004a910: 733a 2f2f 6d61 7472 6978 2e6f 7267 2f64  s://matrix.org/d
+0004a920: 6f63 732f 6170 692f 2c20 220a 2020 2020  ocs/api/, ".    
+0004a930: 2020 2020 2268 7474 7073 3a2f 2f73 7065      "https://spe
+0004a940: 632e 6d61 7472 6978 2e6f 7267 2f6c 6174  c.matrix.org/lat
+0004a950: 6573 742f 636c 6965 6e74 2d73 6572 7665  est/client-serve
+0004a960: 722d 6170 692f 2c20 220a 2020 2020 2020  r-api/, ".      
+0004a970: 2020 2268 7474 7073 3a2f 2f6d 6174 7269    "https://matri
+0004a980: 782d 6f72 672e 6769 7468 7562 2e69 6f2f  x-org.github.io/
+0004a990: 7379 6e61 7073 652f 6c61 7465 7374 2f75  synapse/latest/u
+0004a9a0: 7361 6765 2f61 646d 696e 6973 7472 6174  sage/administrat
+0004a9b0: 696f 6e2f 220a 2020 2020 2020 2020 2261  ion/".        "a
+0004a9c0: 646d 696e 5f61 7069 2f2c 2065 7463 2e20  dmin_api/, etc. 
+0004a9d0: 220a 2020 2020 2020 2020 2245 6163 6820  ".        "Each 
+0004a9e0: 5245 5354 2063 616c 6c20 7265 7175 6972  REST call requir
+0004a9f0: 6573 2065 7861 6374 6c79 2033 2061 7267  es exactly 3 arg
+0004aa00: 756d 656e 7473 2e20 220a 2020 2020 2020  uments. ".      
+0004aa10: 2020 2253 6f2c 2074 6865 2074 6f74 616c    "So, the total
+0004aa20: 206e 756d 6265 7220 6f66 2061 7267 756d   number of argum
+0004aa30: 656e 7473 2075 7365 6420 7769 7468 202d  ents used with -
+0004aa40: 2d72 6573 7420 6d75 7374 2062 6520 6120  -rest must be a 
+0004aa50: 220a 2020 2020 2020 2020 226d 756c 7469  ".        "multi
+0004aa60: 706c 6520 6f66 2033 2e20 5468 6520 6172  ple of 3. The ar
+0004aa70: 6775 6d65 6e74 2074 7269 706c 6573 2061  gument triples a
+0004aa80: 7265 3a20 220a 2020 2020 2020 2020 2228  re: ".        "(
+0004aa90: 6129 2074 6865 206d 6574 686f 642c 2061  a) the method, a
+0004aaa0: 2073 7472 696e 6720 6f66 2047 4554 2c20   string of GET, 
+0004aab0: 504f 5354 2c20 5055 542c 2044 454c 4554  POST, PUT, DELET
+0004aac0: 452c 206f 7220 4f50 5449 4f4e 532e 2022  E, or OPTIONS. "
+0004aad0: 0a20 2020 2020 2020 2022 2862 2920 6120  .        "(b) a 
+0004aae0: 7374 7269 6e67 2063 6f6e 7461 696e 696e  string containin
+0004aaf0: 6720 7468 6520 6461 7461 2028 6966 2061  g the data (if a
+0004ab00: 6e79 2920 696e 204a 534f 4e20 666f 726d  ny) in JSON form
+0004ab10: 6174 2e20 220a 2020 2020 2020 2020 2228  at. ".        "(
+0004ab20: 6329 2061 2073 7472 696e 6720 636f 6e74  c) a string cont
+0004ab30: 6169 6e69 6e67 2074 6865 2055 524c 2e20  aining the URL. 
+0004ab40: 416c 6c20 7374 7269 6e67 7320 6d75 7374  All strings must
+0004ab50: 2062 6520 5554 462d 382e 2022 0a20 2020   be UTF-8. ".   
+0004ab60: 2020 2020 2022 5468 6572 6520 6172 6520       "There are 
+0004ab70: 6120 6665 7720 706c 6163 6568 6f6c 6465  a few placeholde
+0004ab80: 7273 2e20 5468 6579 2061 7265 3a20 220a  rs. They are: ".
+0004ab90: 2020 2020 2020 2020 225f 5f68 6f6d 6573          "__homes
+0004aba0: 6572 7665 725f 5f20 286c 696b 6520 6874  erver__ (like ht
+0004abb0: 7470 733a 2f2f 6d61 7472 6978 2e65 7861  tps://matrix.exa
+0004abc0: 6d70 6c65 2e6f 7267 292c 2022 0a20 2020  mple.org), ".   
+0004abd0: 2020 2020 2022 5f5f 686f 7374 6e61 6d65       "__hostname
+0004abe0: 5f5f 2028 6c69 6b65 206d 6174 7269 782e  __ (like matrix.
+0004abf0: 6578 616d 706c 652e 6f72 6729 2c20 220a  example.org), ".
+0004ac00: 2020 2020 2020 2020 225f 5f61 6363 6573          "__acces
+0004ac10: 735f 746f 6b65 6e5f 5f2c 205f 5f75 7365  s_token__, __use
+0004ac20: 725f 6964 5f5f 2028 6c69 6b65 2040 6d63  r_id__ (like @mc
+0004ac30: 3a6d 6174 7269 782e 6578 616d 706c 652e  :matrix.example.
+0004ac40: 636f 6d29 2c20 220a 2020 2020 2020 2020  com), ".        
+0004ac50: 225f 5f64 6576 6963 655f 6964 5f5f 2c20  "__device_id__, 
+0004ac60: 616e 6420 5f5f 726f 6f6d 5f69 645f 5f2e  and __room_id__.
+0004ac70: 2049 6620 6120 706c 6163 6568 6f6c 6465   If a placeholde
+0004ac80: 7220 6973 2066 6f75 6e64 2069 7420 6973  r is found it is
+0004ac90: 2022 0a20 2020 2020 2020 2022 7265 706c   ".        "repl
+0004aca0: 6163 6564 2077 6974 6820 7468 6520 7661  aced with the va
+0004acb0: 6c75 6520 6672 6f6d 2074 6865 206c 6f63  lue from the loc
+0004acc0: 616c 2063 7265 6465 6e74 6961 6c73 2066  al credentials f
+0004acd0: 696c 652e 2022 0a20 2020 2020 2020 2022  ile. ".        "
+0004ace0: 416e 2065 7861 6d70 6c65 2077 6f75 6c64  An example would
+0004acf0: 2062 653a 2022 0a20 2020 2020 2020 2022   be: ".        "
+0004ad00: 2d2d 7265 7374 2027 4745 5427 2027 2720  --rest 'GET' '' 
+0004ad10: 275f 5f68 6f6d 6573 6572 7665 725f 5f2f  '__homeserver__/
+0004ad20: 5f6d 6174 7269 782f 636c 6965 6e74 2f76  _matrix/client/v
+0004ad30: 6572 7369 6f6e 7327 2e20 220a 2020 2020  ersions'. ".    
+0004ad40: 2020 2020 2249 6620 7468 6572 6520 6973      "If there is
+0004ad50: 206e 6f20 6461 7461 2c20 692e 652e 2064   no data, i.e. d
+0004ad60: 6174 6120 2862 2920 6973 2065 6d70 7479  ata (b) is empty
+0004ad70: 2c20 7468 656e 2075 7365 2027 2720 666f  , then use '' fo
+0004ad80: 7220 6974 2e20 220a 2020 2020 2020 2020  r it. ".        
+0004ad90: 224f 7074 696f 6e61 6c6c 792c 202d 2d61  "Optionally, --a
+0004ada0: 6363 6573 732d 746f 6b65 6e20 6361 6e20  ccess-token can 
+0004adb0: 6265 2075 7365 6420 746f 206f 7665 7277  be used to overw
+0004adc0: 7269 7465 2074 6865 2022 0a20 2020 2020  rite the ".     
+0004add0: 2020 2022 6163 6365 7373 2074 6f6b 656e     "access token
+0004ade0: 2066 726f 6d20 6372 6564 656e 7469 616c   from credential
+0004adf0: 7320 2869 6620 6e65 6564 6564 292e 2022  s (if needed). "
+0004ae00: 0a20 2020 2020 2020 2022 5365 6520 7465  .        "See te
+0004ae10: 7374 732f 7465 7374 2d72 6573 742e 7368  sts/test-rest.sh
+0004ae20: 2066 6f72 2061 6e20 6578 616d 706c 652e   for an example.
+0004ae30: 222c 0a20 2020 2029 0a20 2020 2061 702e  ",.    ).    ap.
+0004ae40: 6164 645f 6172 6775 6d65 6e74 280a 2020  add_argument(.  
+0004ae50: 2020 2020 2020 222d 2d73 6574 2d61 7661        "--set-ava
+0004ae60: 7461 7222 2c0a 2020 2020 2020 2020 7265  tar",.        re
+0004ae70: 7175 6972 6564 3d46 616c 7365 2c0a 2020  quired=False,.  
+0004ae80: 2020 2020 2020 7479 7065 3d73 7472 2c0a        type=str,.
+0004ae90: 2020 2020 2020 2020 6d65 7461 7661 723d          metavar=
+0004aea0: 2241 5641 5441 525f 4d58 435f 5552 4922  "AVATAR_MXC_URI"
+0004aeb0: 2c0a 2020 2020 2020 2020 2320 6465 6661  ,.        # defa
+0004aec0: 756c 7473 2074 6f20 4e6f 6e65 2069 6620  ults to None if 
+0004aed0: 6e6f 7420 7573 6564 2c20 6973 2073 7472  not used, is str
+0004aee0: 2069 6620 7573 6564 0a20 2020 2020 2020   if used.       
+0004aef0: 2068 656c 703d 2253 6574 2079 6f75 7220   help="Set your 
+0004af00: 6176 6174 6172 2e20 220a 2020 2020 2020  avatar. ".      
+0004af10: 2020 6622 4465 7461 696c 733a 3a20 5365    f"Details:: Se
+0004af20: 7420 7468 6520 6176 6174 6172 204d 5843  t the avatar MXC
+0004af30: 2072 6573 6f75 7263 6520 7573 6564 2062   resource used b
+0004af40: 7920 7b50 524f 475f 5749 5448 4f55 545f  y {PROG_WITHOUT_
+0004af50: 4558 547d 2e20 220a 2020 2020 2020 2020  EXT}. ".        
+0004af60: 2250 726f 7669 6465 206f 6e65 204d 5843  "Provide one MXC
+0004af70: 2055 5249 2074 6861 7420 6c6f 6f6b 7320   URI that looks 
+0004af80: 6c69 6b65 2074 6869 7320 220a 2020 2020  like this ".    
+0004af90: 2020 2020 2227 6d78 633a 2f2f 6578 616d      "'mxc://exam
+0004afa0: 706c 652e 636f 6d2f 536f 6d65 5374 7261  ple.com/SomeStra
+0004afb0: 6e67 6555 7269 4b65 7927 2e22 2c0a 2020  ngeUriKey'.",.  
+0004afc0: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
+0004afd0: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
+0004afe0: 2022 2d2d 6765 742d 6176 6174 6172 222c   "--get-avatar",
+0004aff0: 0a20 2020 2020 2020 2072 6571 7569 7265  .        require
+0004b000: 643d 4661 6c73 652c 0a20 2020 2020 2020  d=False,.       
+0004b010: 2061 6374 696f 6e3d 2265 7874 656e 6422   action="extend"
+0004b020: 2c0a 2020 2020 2020 2020 6e61 7267 733d  ,.        nargs=
+0004b030: 222a 222c 2020 2320 4e6f 6e65 2069 6620  "*",  # None if 
+0004b040: 6e6f 7420 7573 6564 2c20 5b5d 2069 7320  not used, [] is 
+0004b050: 7573 6564 2077 6974 686f 7574 2065 7874  used without ext
+0004b060: 7261 2061 7267 730a 2020 2020 2020 2020  ra args.        
+0004b070: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
+0004b080: 2020 6d65 7461 7661 723d 2255 5345 5222    metavar="USER"
+0004b090: 2c0a 2020 2020 2020 2020 6865 6c70 3d22  ,.        help="
+0004b0a0: 4765 7420 616e 2061 7661 7461 722e 2022  Get an avatar. "
+0004b0b0: 0a20 2020 2020 2020 2066 2244 6574 6169  .        f"Detai
+0004b0c0: 6c73 3a3a 2047 6574 2074 6865 2061 7661  ls:: Get the ava
+0004b0d0: 7461 7220 4d58 4320 7265 736f 7572 6365  tar MXC resource
+0004b0e0: 2075 7365 6420 6279 207b 5052 4f47 5f57   used by {PROG_W
+0004b0f0: 4954 484f 5554 5f45 5854 7d2c 2022 0a20  ITHOUT_EXT}, ". 
+0004b100: 2020 2020 2020 2022 6f72 206f 6e65 206f         "or one o
+0004b110: 7220 6d75 6c74 6970 6c65 206f 7468 6572  r multiple other
+0004b120: 2075 7365 7273 2e20 5370 6563 6966 7920   users. Specify 
+0004b130: 7a65 726f 206f 7220 6d6f 7265 2075 7365  zero or more use
+0004b140: 7220 6964 732e 2022 0a20 2020 2020 2020  r ids. ".       
+0004b150: 2066 2249 6620 6e6f 2075 7365 7220 6964   f"If no user id
+0004b160: 2069 7320 7370 6563 6966 6965 642c 2074   is specified, t
+0004b170: 6865 2061 7661 7461 7220 6f66 207b 5052  he avatar of {PR
+0004b180: 4f47 5f57 4954 484f 5554 5f45 5854 7d20  OG_WITHOUT_EXT} 
+0004b190: 7769 6c6c 2022 0a20 2020 2020 2020 2022  will ".        "
+0004b1a0: 6265 2066 6574 6368 6564 2e20 4966 206f  be fetched. If o
+0004b1b0: 6e65 206f 7220 6d6f 7265 2075 7365 7220  ne or more user 
+0004b1c0: 6964 7320 6172 6520 6769 7665 6e2c 2074  ids are given, t
+0004b1d0: 6865 2061 7661 7461 7273 206f 6620 220a  he avatars of ".
+0004b1e0: 2020 2020 2020 2020 2274 6865 7365 2075          "these u
+0004b1f0: 7365 7273 2077 696c 6c20 6265 2066 6574  sers will be fet
+0004b200: 6368 6564 2e20 4173 2072 6573 706f 6e73  ched. As respons
+0004b210: 6520 626f 7468 204d 5843 2055 5249 2061  e both MXC URI a
+0004b220: 7320 7765 6c6c 2061 7320 5552 4c20 220a  s well as URL ".
+0004b230: 2020 2020 2020 2020 2277 696c 6c20 6265          "will be
+0004b240: 2070 7269 6e74 6564 2e22 2c0a 2020 2020   printed.",.    
+0004b250: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
+0004b260: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
+0004b270: 2d2d 6765 742d 7072 6f66 696c 6522 2c0a  --get-profile",.
+0004b280: 2020 2020 2020 2020 7265 7175 6972 6564          required
+0004b290: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+0004b2a0: 6163 7469 6f6e 3d22 6578 7465 6e64 222c  action="extend",
+0004b2b0: 0a20 2020 2020 2020 206e 6172 6773 3d22  .        nargs="
+0004b2c0: 2a22 2c20 2023 204e 6f6e 6520 6966 206e  *",  # None if n
+0004b2d0: 6f74 2075 7365 642c 205b 5d20 6973 2075  ot used, [] is u
+0004b2e0: 7365 6420 7769 7468 6f75 7420 6578 7472  sed without extr
+0004b2f0: 6120 6172 6773 0a20 2020 2020 2020 2074  a args.        t
+0004b300: 7970 653d 7374 722c 0a20 2020 2020 2020  ype=str,.       
+0004b310: 206d 6574 6176 6172 3d22 5553 4552 222c   metavar="USER",
+0004b320: 0a20 2020 2020 2020 2068 656c 703d 2247  .        help="G
+0004b330: 6574 2061 2075 7365 7220 7072 6f66 696c  et a user profil
+0004b340: 652e 2022 0a20 2020 2020 2020 2066 2244  e. ".        f"D
+0004b350: 6574 6169 6c73 3a3a 2047 6574 2074 6865  etails:: Get the
+0004b360: 2075 7365 7220 7072 6f66 696c 6520 7573   user profile us
+0004b370: 6564 2062 7920 7b50 524f 475f 5749 5448  ed by {PROG_WITH
+0004b380: 4f55 545f 4558 547d 2c20 6f72 2022 0a20  OUT_EXT}, or ". 
+0004b390: 2020 2020 2020 2022 6f6e 6520 6f72 206d         "one or m
+0004b3a0: 756c 7469 706c 6520 6f74 6865 7220 7573  ultiple other us
+0004b3b0: 6572 732e 2053 7065 6369 6679 207a 6572  ers. Specify zer
+0004b3c0: 6f20 6f72 206d 6f72 6520 7573 6572 2069  o or more user i
+0004b3d0: 6473 2e20 220a 2020 2020 2020 2020 6622  ds. ".        f"
+0004b3e0: 4966 206e 6f20 7573 6572 2069 6420 6973  If no user id is
+0004b3f0: 2073 7065 6369 6669 6564 2c20 7468 6520   specified, the 
+0004b400: 7573 6572 2070 726f 6669 6c65 206f 6620  user profile of 
+0004b410: 7b50 524f 475f 5749 5448 4f55 545f 4558  {PROG_WITHOUT_EX
+0004b420: 547d 2022 0a20 2020 2020 2020 2022 7769  T} ".        "wi
+0004b430: 6c6c 2062 6520 6665 7463 6865 642e 2049  ll be fetched. I
+0004b440: 6620 6f6e 6520 6f72 206d 6f72 6520 7573  f one or more us
+0004b450: 6572 2069 6473 2061 7265 2067 6976 656e  er ids are given
+0004b460: 2c20 7468 6520 7573 6572 2022 0a20 2020  , the user ".   
+0004b470: 2020 2020 2022 7072 6f66 696c 6573 206f       "profiles o
+0004b480: 6620 7468 6573 6520 7573 6572 7320 7769  f these users wi
+0004b490: 6c6c 2062 6520 6665 7463 6865 642e 2041  ll be fetched. A
+0004b4a0: 7320 7265 7370 6f6e 7365 2022 0a20 2020  s response ".   
+0004b4b0: 2020 2020 2022 6469 7370 6c61 7920 6e61       "display na
+0004b4c0: 6d65 2061 6e64 2061 7661 7461 7220 4d58  me and avatar MX
+0004b4d0: 4320 5552 4920 6173 2077 656c 6c20 6173  C URI as well as
+0004b4e0: 2070 6f73 7369 626c 6520 6164 6469 7469   possible additi
+0004b4f0: 6f6e 616c 2022 0a20 2020 2020 2020 2022  onal ".        "
+0004b500: 7072 6f66 696c 6520 696e 666f 726d 6174  profile informat
+0004b510: 696f 6e20 2869 6620 7072 6573 656e 7429  ion (if present)
+0004b520: 2022 0a20 2020 2020 2020 2022 7769 6c6c   ".        "will
+0004b530: 2062 6520 7072 696e 7465 642e 204f 6e65   be printed. One
+0004b540: 206c 696e 6520 7065 7220 7573 6572 2077   line per user w
+0004b550: 696c 6c20 6265 2070 7269 6e74 6564 2e22  ill be printed."
+0004b560: 2c0a 2020 2020 290a 2020 2020 6170 2e61  ,.    ).    ap.a
+0004b570: 6464 5f61 7267 756d 656e 7428 0a20 2020  dd_argument(.   
+0004b580: 2020 2020 2022 2d2d 6765 742d 726f 6f6d       "--get-room
+0004b590: 2d69 6e66 6f22 2c0a 2020 2020 2020 2020  -info",.        
+0004b5a0: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
+0004b5b0: 2020 2020 2020 2020 6163 7469 6f6e 3d22          action="
+0004b5c0: 6578 7465 6e64 222c 0a20 2020 2020 2020  extend",.       
+0004b5d0: 206e 6172 6773 3d22 2a22 2c20 2023 204e   nargs="*",  # N
+0004b5e0: 6f6e 6520 6966 206e 6f74 2075 7365 642c  one if not used,
+0004b5f0: 205b 5d20 6973 2075 7365 6420 7769 7468   [] is used with
+0004b600: 6f75 7420 6578 7472 6120 6172 6773 0a20  out extra args. 
+0004b610: 2020 2020 2020 2074 7970 653d 7374 722c         type=str,
+0004b620: 0a20 2020 2020 2020 206d 6574 6176 6172  .        metavar
+0004b630: 3d22 524f 4f4d 222c 0a20 2020 2020 2020  ="ROOM",.       
+0004b640: 2068 656c 703d 2247 6574 2074 6865 2072   help="Get the r
+0004b650: 6f6f 6d20 696e 666f 726d 6174 696f 6e2e  oom information.
+0004b660: 2022 0a20 2020 2020 2020 2022 4465 7461   ".        "Deta
+0004b670: 696c 733a 3a20 4765 7420 7468 6520 726f  ils:: Get the ro
+0004b680: 6f6d 2069 6e66 6f72 6d61 7469 6f6e 2073  om information s
+0004b690: 7563 6820 6173 2072 6f6f 6d20 6469 7370  uch as room disp
+0004b6a0: 6c61 7920 6e61 6d65 2c20 220a 2020 2020  lay name, ".    
+0004b6b0: 2020 2020 2272 6f6f 6d20 616c 6961 732c      "room alias,
+0004b6c0: 2072 6f6f 6d20 6372 6561 746f 722c 2065   room creator, e
+0004b6d0: 7463 2e20 666f 7220 220a 2020 2020 2020  tc. for ".      
+0004b6e0: 2020 226f 6e65 206f 7220 6d75 6c74 6970    "one or multip
+0004b6f0: 6c65 2073 7065 6369 6669 6564 2072 6f6f  le specified roo
+0004b700: 6d73 2e20 5468 6520 696e 636c 7564 6564  ms. The included
+0004b710: 2072 6f6f 6d20 2764 6973 706c 6179 206e   room 'display n
+0004b720: 616d 6527 2069 7320 220a 2020 2020 2020  ame' is ".      
+0004b730: 2020 2261 6c73 6f20 7265 6665 7272 6564    "also referred
+0004b740: 2074 6f20 6173 2027 726f 6f6d 206e 616d   to as 'room nam
+0004b750: 6527 206f 7220 696e 636f 7272 6563 746c  e' or incorrectl
+0004b760: 7920 6576 656e 2061 7320 726f 6f6d 2074  y even as room t
+0004b770: 6974 6c65 2e20 220a 2020 2020 2020 2020  itle. ".        
+0004b780: 2249 6620 6f6e 6520 6f72 206d 6f72 6520  "If one or more 
+0004b790: 726f 6f6d 2061 7265 2067 6976 656e 2c20  room are given, 
+0004b7a0: 7468 6520 726f 6f6d 2022 0a20 2020 2020  the room ".     
+0004b7b0: 2020 2022 696e 666f 726d 6174 696f 6e73     "informations
+0004b7c0: 206f 6620 7468 6573 6520 726f 6f6d 7320   of these rooms 
+0004b7d0: 7769 6c6c 2062 6520 6665 7463 6865 642e  will be fetched.
+0004b7e0: 2022 0a20 2020 2020 2020 2022 4966 206e   ".        "If n
+0004b7f0: 6f20 726f 6f6d 2069 7320 7370 6563 6966  o room is specif
+0004b800: 6965 642c 2074 6865 2072 6f6f 6d20 696e  ied, the room in
+0004b810: 666f 726d 6174 696f 6e20 666f 7220 7468  formation for th
+0004b820: 6520 220a 2020 2020 2020 2020 6622 6465  e ".        f"de
+0004b830: 6661 756c 7420 726f 6f6d 2063 6f6e 6669  fault room confi
+0004b840: 6775 7265 6420 666f 7220 7b50 524f 475f  gured for {PROG_
+0004b850: 5749 5448 4f55 545f 4558 547d 2069 7320  WITHOUT_EXT} is 
+0004b860: 6665 7463 6865 642e 2022 0a20 2020 2020  fetched. ".     
+0004b870: 2020 2022 526f 6f6d 7320 6361 6e20 6265     "Rooms can be
+0004b880: 2067 6976 656e 2076 6961 2022 0a20 2020   given via ".   
+0004b890: 2020 2020 2022 726f 6f6d 2069 6420 2865       "room id (e
+0004b8a0: 2e67 2e20 275c 5c21 536f 6d65 526f 6f6d  .g. '\\!SomeRoom
+0004b8b0: 4964 3a6d 6174 7269 782e 6578 616d 706c  Id:matrix.exampl
+0004b8c0: 652e 636f 6d27 292c 2022 0a20 2020 2020  e.com'), ".     
+0004b8d0: 2020 2022 6361 6e6f 6e69 6361 6c20 2866     "canonical (f
+0004b8e0: 756c 6c29 2072 6f6f 6d20 616c 6961 7320  ull) room alias 
+0004b8f0: 220a 2020 2020 2020 2020 2228 652e 672e  ".        "(e.g.
+0004b900: 2027 2353 6f6d 6552 6f6f 6d41 6c69 6173   '#SomeRoomAlias
+0004b910: 3a6d 6174 7269 782e 6578 616d 706c 652e  :matrix.example.
+0004b920: 636f 6d27 292c 2022 0a20 2020 2020 2020  com'), ".       
+0004b930: 2022 6f72 2073 686f 7274 2061 6c69 6173   "or short alias
+0004b940: 2028 652e 672e 2027 536f 6d65 526f 6f6d   (e.g. 'SomeRoom
+0004b950: 416c 6961 7327 206f 7220 2723 536f 6d65  Alias' or '#Some
+0004b960: 526f 6f6d 416c 6961 7327 292e 2022 0a20  RoomAlias'). ". 
+0004b970: 2020 2020 2020 2022 4173 2072 6573 706f         "As respo
+0004b980: 6e73 6520 220a 2020 2020 2020 2020 2272  nse ".        "r
+0004b990: 6f6f 6d20 6964 2c20 726f 6f6d 2064 6973  oom id, room dis
+0004b9a0: 706c 6179 206e 616d 652c 2072 6f6f 6d20  play name, room 
+0004b9b0: 6361 6e6f 6e69 6361 6c20 616c 6961 732c  canonical alias,
+0004b9c0: 2072 6f6f 6d20 746f 7069 632c 2022 0a20   room topic, ". 
+0004b9d0: 2020 2020 2020 2022 726f 6f6d 2063 7265         "room cre
+0004b9e0: 6174 6f72 2c20 616e 6420 726f 6f6d 2065  ator, and room e
+0004b9f0: 6e63 7279 7074 696f 6e20 220a 2020 2020  ncryption ".    
+0004ba00: 2020 2020 2261 7265 2070 7269 6e74 6564      "are printed
+0004ba10: 2e20 4f6e 6520 6c69 6e65 2070 6572 2072  . One line per r
+0004ba20: 6f6f 6d20 7769 6c6c 2062 6520 7072 696e  oom will be prin
+0004ba30: 7465 642e 2022 0a20 2020 2020 2020 2022  ted. ".        "
+0004ba40: 5369 6e63 6520 6569 7468 6572 2072 6f6f  Since either roo
+0004ba50: 6d20 6964 206f 7220 726f 6f6d 2061 6c69  m id or room ali
+0004ba60: 6173 2061 7265 2061 6363 6570 7465 6420  as are accepted 
+0004ba70: 6173 2069 6e70 7574 2061 6e64 2062 6f74  as input and bot
+0004ba80: 6820 220a 2020 2020 2020 2020 2272 6f6f  h ".        "roo
+0004ba90: 6d20 6964 2061 6e64 2072 6f6f 6d20 616c  m id and room al
+0004baa0: 6961 7320 6172 6520 6769 7665 6e20 6173  ias are given as
+0004bab0: 206f 7574 7075 742c 206f 6e65 2063 616e   output, one can
+0004bac0: 2068 656e 6365 2075 7365 2074 6869 7320   hence use this 
+0004bad0: 220a 2020 2020 2020 2020 226f 7074 696f  ".        "optio
+0004bae0: 6e20 746f 206d 6170 2066 726f 6d20 726f  n to map from ro
+0004baf0: 6f6d 2069 6420 746f 2072 6f6f 6d20 616c  om id to room al
+0004bb00: 6961 7320 220a 2020 2020 2020 2020 2261  ias ".        "a
+0004bb10: 7320 7765 6c6c 2061 7320 7669 6365 2076  s well as vice v
+0004bb20: 6572 7361 2066 726f 6d20 726f 6f6d 2061  ersa from room a
+0004bb30: 6c69 6173 2074 6f20 726f 6f6d 2069 642e  lias to room id.
+0004bb40: 2022 0a20 2020 2020 2020 2022 446f 206e   ".        "Do n
+0004bb50: 6f74 2063 6f6e 6675 7365 2074 6869 7320  ot confuse this 
+0004bb60: 6f70 7469 6f6e 2077 6974 6820 7468 6520  option with the 
+0004bb70: 6f70 7469 6f6e 7320 272d 2d67 6574 2d64  options '--get-d
+0004bb80: 6973 706c 6179 2d6e 616d 6527 2022 0a20  isplay-name' ". 
+0004bb90: 2020 2020 2020 2022 616e 6420 272d 2d73         "and '--s
+0004bba0: 6574 2d64 6973 706c 6179 2d6e 616d 6527  et-display-name'
+0004bbb0: 2c20 7768 6963 6820 6765 742f 7365 7420  , which get/set 
+0004bbc0: 7468 6520 7573 6572 2064 6973 706c 6179  the user display
+0004bbd0: 206e 616d 652c 206e 6f74 2022 0a20 2020   name, not ".   
+0004bbe0: 2020 2020 2022 7468 6520 726f 6f6d 2064       "the room d
+0004bbf0: 6973 706c 6179 206e 616d 652e 222c 0a20  isplay name.",. 
+0004bc00: 2020 2029 0a20 2020 2061 702e 6164 645f     ).    ap.add_
+0004bc10: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
+0004bc20: 2020 222d 2d67 6574 2d63 6c69 656e 742d    "--get-client-
+0004bc30: 696e 666f 222c 0a20 2020 2020 2020 2072  info",.        r
+0004bc40: 6571 7569 7265 643d 4661 6c73 652c 0a20  equired=False,. 
+0004bc50: 2020 2020 2020 2061 6374 696f 6e3d 2273         action="s
+0004bc60: 746f 7265 5f74 7275 6522 2c0a 2020 2020  tore_true",.    
+0004bc70: 2020 2020 6865 6c70 3d22 5072 696e 7420      help="Print 
+0004bc80: 636c 6965 6e74 2069 6e66 6f72 6d61 7469  client informati
+0004bc90: 6f6e 2e20 220a 2020 2020 2020 2020 2244  on. ".        "D
+0004bca0: 6574 6169 6c73 3a3a 2050 7269 6e74 2069  etails:: Print i
+0004bcb0: 6e66 6f72 6d61 7469 6f6e 206b 6570 7420  nformation kept 
+0004bcc0: 696e 2074 6865 2063 6c69 656e 742c 2069  in the client, i
+0004bcd0: 2e65 2e20 220a 2020 2020 2020 2020 6622  .e. ".        f"
+0004bce0: 7b50 524f 475f 5749 5448 4f55 545f 4558  {PROG_WITHOUT_EX
+0004bcf0: 547d 2e20 220a 2020 2020 2020 2020 224f  T}. ".        "O
+0004bd00: 7574 7075 7420 6973 2070 7269 6e74 6564  utput is printed
+0004bd10: 2069 6e20 4a53 4f4e 2066 6f72 6d61 742e   in JSON format.
+0004bd20: 222c 0a20 2020 2029 0a20 2020 2061 702e  ",.    ).    ap.
+0004bd30: 6164 645f 6172 6775 6d65 6e74 280a 2020  add_argument(.  
+0004bd40: 2020 2020 2020 222d 2d68 6173 2d70 6572        "--has-per
+0004bd50: 6d69 7373 696f 6e22 2c0a 2020 2020 2020  mission",.      
+0004bd60: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
+0004bd70: 2c0a 2020 2020 2020 2020 6163 7469 6f6e  ,.        action
+0004bd80: 3d22 6578 7465 6e64 222c 0a20 2020 2020  ="extend",.     
+0004bd90: 2020 206e 6172 6773 3d22 2b22 2c0a 2020     nargs="+",.  
+0004bda0: 2020 2020 2020 7479 7065 3d73 7472 2c0a        type=str,.
+0004bdb0: 2020 2020 2020 2020 6d65 7461 7661 723d          metavar=
+0004bdc0: 2252 4f4f 4d20 4241 4e7c 494e 5649 5445  "ROOM BAN|INVITE
+0004bdd0: 7c4b 4943 4b7c 4e4f 5449 4649 4341 5449  |KICK|NOTIFICATI
+0004bde0: 4f4e 537c 5245 4441 4354 7c65 7463 222c  ONS|REDACT|etc",
+0004bdf0: 0a20 2020 2020 2020 2068 656c 703d 2249  .        help="I
+0004be00: 6e71 7569 7265 2061 626f 7574 2070 6572  nquire about per
+0004be10: 6d69 7373 696f 6e73 2e20 220a 2020 2020  missions. ".    
+0004be20: 2020 2020 6622 4465 7461 696c 733a 3a20      f"Details:: 
+0004be30: 496e 7175 6972 6520 6966 2075 7365 7220  Inquire if user 
+0004be40: 7573 6564 2062 7920 7b50 524f 475f 5749  used by {PROG_WI
+0004be50: 5448 4f55 545f 4558 547d 2068 6173 2022  THOUT_EXT} has "
+0004be60: 0a20 2020 2020 2020 2022 7065 726d 6973  .        "permis
+0004be70: 7369 6f6e 2066 6f72 206f 6e65 206f 7220  sion for one or 
+0004be80: 6d75 6c74 6970 6c65 2061 6374 696f 6e73  multiple actions
+0004be90: 2069 6e20 6f6e 6520 6f72 206d 756c 7469   in one or multi
+0004bea0: 706c 6520 726f 6f6d 732e 2022 0a20 2020  ple rooms. ".   
+0004beb0: 2020 2020 2022 4561 6368 2069 6e71 7569       "Each inqui
+0004bec0: 7279 2072 6571 7569 7265 7320 3220 7061  ry requires 2 pa
+0004bed0: 7261 6d65 7465 7273 3a20 7468 6520 726f  rameters: the ro
+0004bee0: 6f6d 2069 6420 616e 6420 7468 6520 7065  om id and the pe
+0004bef0: 726d 6973 7369 6f6e 2022 0a20 2020 2020  rmission ".     
+0004bf00: 2020 2022 7479 7065 2e20 4f6e 6520 6f72     "type. One or
+0004bf10: 206d 756c 7469 706c 6520 6f66 2074 6865   multiple of the
+0004bf20: 7365 2070 6172 616d 6574 6572 2070 6169  se parameter pai
+0004bf30: 7273 206d 6179 2062 6520 7370 6563 6966  rs may be specif
+0004bf40: 6965 642e 2022 0a20 2020 2020 2020 2022  ied. ".        "
+0004bf50: 466f 7220 6561 6368 2070 6172 616d 6574  For each paramet
+0004bf60: 6572 2070 6169 7220 7468 6572 6520 7769  er pair there wi
+0004bf70: 6c6c 2062 6520 6f6e 6520 6c69 6e65 2070  ll be one line p
+0004bf80: 7269 6e74 6564 2074 6f20 7374 646f 7574  rinted to stdout
+0004bf90: 2e20 220a 2020 2020 2020 2020 2256 616c  . ".        "Val
+0004bfa0: 7565 7320 666f 7220 7468 6520 7065 726d  ues for the perm
+0004bfb0: 6973 7369 6f6e 2074 7970 6520 6172 6520  ission type are 
+0004bfc0: 2762 616e 272c 2022 0a20 2020 2020 2020  'ban', ".       
+0004bfd0: 2022 2769 6e76 6974 6527 2c20 276b 6963   "'invite', 'kic
+0004bfe0: 6b27 2c20 276e 6f74 6966 6963 6174 696f  k', 'notificatio
+0004bff0: 6e73 272c 2027 7265 6461 6374 272c 2065  ns', 'redact', e
+0004c000: 7463 2e20 220a 2020 2020 2020 2020 2253  tc. ".        "S
+0004c010: 6565 2068 7474 7073 3a2f 2f73 7065 632e  ee https://spec.
+0004c020: 6d61 7472 6978 2e6f 7267 2f76 312e 322f  matrix.org/v1.2/
+0004c030: 636c 6965 6e74 2d73 6572 7665 722d 6170  client-server-ap
+0004c040: 692f 236d 726f 6f6d 706f 7765 725f 6c65  i/#mroompower_le
+0004c050: 7665 6c73 220a 2020 2020 2020 2020 222e  vels".        ".
+0004c060: 222c 0a20 2020 2020 2020 2023 2027 6576  ",.        # 'ev
+0004c070: 656e 7473 272c 2027 6576 656e 7473 5f64  ents', 'events_d
+0004c080: 6566 6175 6c74 272c 2027 7374 6174 655f  efault', 'state_
+0004c090: 6465 6661 756c 7427 3a20 7661 6c69 6420  default': valid 
+0004c0a0: 7065 726d 6973 7369 6f6e 2074 7970 6573  permission types
+0004c0b0: 3f0a 2020 2020 290a 2020 2020 6170 2e61  ?.    ).    ap.a
+0004c0c0: 6464 5f61 7267 756d 656e 7428 0a20 2020  dd_argument(.   
+0004c0d0: 2020 2020 2022 2d2d 696d 706f 7274 2d6b       "--import-k
+0004c0e0: 6579 7322 2c0a 2020 2020 2020 2020 7265  eys",.        re
+0004c0f0: 7175 6972 6564 3d46 616c 7365 2c0a 2020  quired=False,.  
+0004c100: 2020 2020 2020 6163 7469 6f6e 3d22 6578        action="ex
+0004c110: 7465 6e64 222c 0a20 2020 2020 2020 206e  tend",.        n
+0004c120: 6172 6773 3d32 2c20 2023 2066 696c 656e  args=2,  # filen
+0004c130: 616d 6520 666f 7220 696d 706f 7274 2c20  ame for import, 
+0004c140: 7061 7373 7068 7261 7365 0a20 2020 2020  passphrase.     
+0004c150: 2020 2074 7970 653d 7374 722c 0a20 2020     type=str,.   
+0004c160: 2020 2020 206d 6574 6176 6172 3d22 4649       metavar="FI
+0004c170: 4c45 2050 4153 5350 4852 4153 4522 2c0a  LE PASSPHRASE",.
+0004c180: 2020 2020 2020 2020 6865 6c70 3d22 496d          help="Im
+0004c190: 706f 7274 204d 6567 6f6c 6d20 6465 6372  port Megolm decr
+0004c1a0: 7970 7469 6f6e 206b 6579 7320 6672 6f6d  yption keys from
+0004c1b0: 2061 2066 696c 652e 2022 0a20 2020 2020   a file. ".     
+0004c1c0: 2020 2022 4465 7461 696c 733a 3a20 5468     "Details:: Th
+0004c1d0: 6973 2069 7320 616e 206f 7074 696f 6e61  is is an optiona
+0004c1e0: 6c20 6172 6775 6d65 6e74 2e20 4966 2075  l argument. If u
+0004c1f0: 7365 6420 6974 206d 7573 7420 6265 2066  sed it must be f
+0004c200: 6f6c 6c6f 7765 6420 220a 2020 2020 2020  ollowed ".      
+0004c210: 2020 2262 7920 7477 6f20 7661 6c75 6573    "by two values
+0004c220: 2e20 2861 2920 6120 6669 6c65 206e 616d  . (a) a file nam
+0004c230: 6520 6672 6f6d 2077 6869 6368 2074 6865  e from which the
+0004c240: 206b 6579 7320 7769 6c6c 2062 6520 7265   keys will be re
+0004c250: 6164 2e20 220a 2020 2020 2020 2020 2228  ad. ".        "(
+0004c260: 6229 2061 2070 6173 7370 6872 6173 6520  b) a passphrase 
+0004c270: 7769 7468 2077 6869 6368 2074 6865 2066  with which the f
+0004c280: 696c 6520 6361 6e20 6265 2064 6563 7279  ile can be decry
+0004c290: 7074 6564 2077 6974 682e 2022 0a20 2020  pted with. ".   
+0004c2a0: 2020 2020 2022 5468 6520 6b65 7973 2077       "The keys w
+0004c2b0: 696c 6c20 6265 2061 6464 6564 2074 6f20  ill be added to 
+0004c2c0: 7468 6520 6375 7272 656e 7420 696e 7374  the current inst
+0004c2d0: 616e 6365 2061 7320 7765 6c6c 2061 7320  ance as well as 
+0004c2e0: 220a 2020 2020 2020 2020 2277 7269 7474  ".        "writt
+0004c2f0: 656e 2074 6f20 7468 6520 6461 7461 6261  en to the databa
+0004c300: 7365 2e20 5365 6520 616c 736f 202d 2d65  se. See also --e
+0004c310: 7870 6f72 742d 6b65 7973 2e22 2c0a 2020  xport-keys.",.  
+0004c320: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
+0004c330: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
+0004c340: 2022 2d2d 6578 706f 7274 2d6b 6579 7322   "--export-keys"
+0004c350: 2c0a 2020 2020 2020 2020 7265 7175 6972  ,.        requir
+0004c360: 6564 3d46 616c 7365 2c0a 2020 2020 2020  ed=False,.      
+0004c370: 2020 6163 7469 6f6e 3d22 6578 7465 6e64    action="extend
+0004c380: 222c 0a20 2020 2020 2020 206e 6172 6773  ",.        nargs
+0004c390: 3d32 2c20 2023 2066 696c 656e 616d 6520  =2,  # filename 
+0004c3a0: 666f 7220 6578 706f 7274 2c20 7061 7373  for export, pass
+0004c3b0: 7068 7261 7365 0a20 2020 2020 2020 2074  phrase.        t
+0004c3c0: 7970 653d 7374 722c 0a20 2020 2020 2020  ype=str,.       
+0004c3d0: 206d 6574 6176 6172 3d22 4649 4c45 2050   metavar="FILE P
+0004c3e0: 4153 5350 4852 4153 4522 2c0a 2020 2020  ASSPHRASE",.    
+0004c3f0: 2020 2020 6865 6c70 3d22 4578 706f 7274      help="Export
+0004c400: 2061 6c6c 2074 6865 204d 6567 6f6c 6d20   all the Megolm 
+0004c410: 6465 6372 7970 7469 6f6e 206b 6579 7320  decryption keys 
+0004c420: 6f66 2074 6869 7320 6465 7669 6365 2e20  of this device. 
+0004c430: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
+0004c440: 6c73 3a3a 2054 6869 7320 6973 2061 6e20  ls:: This is an 
+0004c450: 6f70 7469 6f6e 616c 2061 7267 756d 656e  optional argumen
+0004c460: 742e 2049 6620 7573 6564 2069 7420 6d75  t. If used it mu
+0004c470: 7374 2062 6520 666f 6c6c 6f77 6564 2022  st be followed "
+0004c480: 0a20 2020 2020 2020 2022 6279 2074 776f  .        "by two
+0004c490: 2076 616c 7565 732e 2028 6129 2061 2066   values. (a) a f
+0004c4a0: 696c 6520 6e61 6d65 2074 6f20 7768 6963  ile name to whic
+0004c4b0: 6820 7468 6520 6b65 7973 2077 696c 6c20  h the keys will 
+0004c4c0: 6265 2077 7269 7474 656e 2074 6f2e 2022  be written to. "
+0004c4d0: 0a20 2020 2020 2020 2022 2862 2920 6120  .        "(b) a 
+0004c4e0: 7061 7373 7068 7261 7365 2077 6974 6820  passphrase with 
+0004c4f0: 7768 6963 6820 7468 6520 6669 6c65 2077  which the file w
+0004c500: 696c 6c20 6265 2065 6e63 7279 7074 6564  ill be encrypted
+0004c510: 2077 6974 682e 2022 0a20 2020 2020 2020   with. ".       
+0004c520: 2022 4e6f 7465 2074 6861 7420 7468 6973   "Note that this
+0004c530: 2064 6f65 7320 6e6f 7420 7361 7665 206f   does not save o
+0004c540: 7468 6572 2069 6e66 6f72 6d61 7469 6f6e  ther information
+0004c550: 2073 7563 6820 6173 2074 6865 2070 7269   such as the pri
+0004c560: 7661 7465 2022 0a20 2020 2020 2020 2022  vate ".        "
+0004c570: 6964 656e 7469 7479 206b 6579 7320 6f66  identity keys of
+0004c580: 2074 6865 2064 6576 6963 652e 222c 0a20   the device.",. 
+0004c590: 2020 2029 0a20 2020 2061 702e 6164 645f     ).    ap.add_
+0004c5a0: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
+0004c5b0: 2020 222d 2d72 6f6f 6d2d 7365 742d 616c    "--room-set-al
+0004c5c0: 6961 7322 2c0a 2020 2020 2020 2020 222d  ias",.        "-
+0004c5d0: 2d72 6f6f 6d2d 7075 742d 616c 6961 7322  -room-put-alias"
+0004c5e0: 2c20 2023 206e 616d 6520 7573 6564 2062  ,  # name used b
+0004c5f0: 7920 6e69 6f0a 2020 2020 2020 2020 7265  y nio.        re
+0004c600: 7175 6972 6564 3d46 616c 7365 2c0a 2020  quired=False,.  
+0004c610: 2020 2020 2020 6163 7469 6f6e 3d22 6578        action="ex
+0004c620: 7465 6e64 222c 0a20 2020 2020 2020 206e  tend",.        n
+0004c630: 6172 6773 3d22 2b22 2c0a 2020 2020 2020  args="+",.      
+0004c640: 2020 7479 7065 3d73 7472 2c0a 2020 2020    type=str,.    
+0004c650: 2020 2020 6d65 7461 7661 723d 2252 4f4f      metavar="ROO
+0004c660: 4d5f 414c 4941 5320 524f 4f4d 222c 0a20  M_ALIAS ROOM",. 
+0004c670: 2020 2020 2020 2068 656c 703d 2241 6464         help="Add
+0004c680: 2061 6c69 6173 6573 2074 6f20 726f 6f6d   aliases to room
+0004c690: 732e 2022 0a20 2020 2020 2020 2022 4465  s. ".        "De
+0004c6a0: 7461 696c 733a 3a20 4164 6420 616e 2061  tails:: Add an a
+0004c6b0: 6c69 6173 2074 6f20 6120 726f 6f6d 2c20  lias to a room, 
+0004c6c0: 6f72 2061 6c69 6173 6573 2074 6f20 6d75  or aliases to mu
+0004c6d0: 6c74 6970 6c65 2072 6f6f 6d73 2e20 220a  ltiple rooms. ".
+0004c6e0: 2020 2020 2020 2020 2250 726f 7669 6465          "Provide
+0004c6f0: 2070 6169 7273 206f 6620 6172 6775 6d65   pairs of argume
+0004c700: 6e74 732e 2049 6e20 6561 6368 2070 6169  nts. In each pai
+0004c710: 722c 2074 6865 2066 6972 7374 2061 7267  r, the first arg
+0004c720: 756d 656e 7420 6d75 7374 2062 6520 220a  ument must be ".
+0004c730: 2020 2020 2020 2020 2274 6865 2061 6c69          "the ali
+0004c740: 6173 2079 6f75 2077 616e 7420 746f 2061  as you want to a
+0004c750: 7373 6967 6e20 746f 2074 6865 2072 6f6f  ssign to the roo
+0004c760: 6d20 6769 7665 6e20 7669 6120 726f 6f6d  m given via room
+0004c770: 2069 6420 696e 2074 6865 2022 0a20 2020   id in the ".   
+0004c780: 2020 2020 2022 7365 636f 6e64 2061 7267       "second arg
+0004c790: 756d 656e 7420 6f66 2074 6865 2070 6169  ument of the pai
+0004c7a0: 722e 2045 2e67 2e20 7468 6520 3420 6172  r. E.g. the 4 ar
+0004c7b0: 6775 6d65 6e74 7320 2761 3120 7231 2061  guments 'a1 r1 a
+0004c7c0: 3220 7232 2720 220a 2020 2020 2020 2020  2 r2' ".        
+0004c7d0: 2277 6f75 6c64 2061 7373 6967 6e20 7468  "would assign th
+0004c7e0: 6520 616c 6961 7320 2761 3127 2074 6f20  e alias 'a1' to 
+0004c7f0: 726f 6f6d 2027 7231 2720 616e 6420 7468  room 'r1' and th
+0004c800: 6520 616c 6961 7320 2761 3227 2074 6f20  e alias 'a2' to 
+0004c810: 726f 6f6d 2022 0a20 2020 2020 2020 2022  room ".        "
+0004c820: 2772 3227 2e20 4966 2079 6f75 206a 7573  'r2'. If you jus
+0004c830: 7420 6861 7665 206f 6e65 2073 696e 676c  t have one singl
+0004c840: 6520 7061 6972 2074 6865 6e20 7468 6520  e pair then the 
+0004c850: 7365 636f 6e64 2061 7267 756d 656e 7420  second argument 
+0004c860: 6973 2022 0a20 2020 2020 2020 2022 6f70  is ".        "op
+0004c870: 7469 6f6e 616c 2e20 4966 206a 7573 7420  tional. If just 
+0004c880: 6120 7369 6e67 6c65 2076 616c 7565 2069  a single value i
+0004c890: 7320 6769 7665 6e20 2861 6e20 616c 6961  s given (an alia
+0004c8a0: 7329 2074 6865 6e20 7468 6973 2022 0a20  s) then this ". 
+0004c8b0: 2020 2020 2020 2022 616c 6961 7320 6973         "alias is
+0004c8c0: 2061 7373 6967 6e65 6420 746f 2074 6865   assigned to the
+0004c8d0: 2064 6566 6175 6c74 2072 6f6f 6d20 6f66   default room of
+0004c8e0: 2022 0a20 2020 2020 2020 2066 227b 5052   ".        f"{PR
+0004c8f0: 4f47 5f57 4954 484f 5554 5f45 5854 7d20  OG_WITHOUT_EXT} 
+0004c900: 2861 7320 666f 756e 6420 696e 2063 7265  (as found in cre
+0004c910: 6465 6e74 6961 6c73 2066 696c 6529 2e20  dentials file). 
+0004c920: 496e 2073 686f 7274 2c20 220a 2020 2020  In short, ".    
+0004c930: 2020 2020 2279 6f75 2063 616e 2068 6176      "you can hav
+0004c940: 6520 6a75 7374 2061 2073 696e 676c 6520  e just a single 
+0004c950: 6172 6775 6d65 6e74 206f 7220 616e 2065  argument or an e
+0004c960: 7665 6e20 6e75 6d62 6572 206f 6620 6172  ven number of ar
+0004c970: 6775 6d65 6e74 7320 220a 2020 2020 2020  guments ".      
+0004c980: 2020 2266 6f72 6d69 6e67 2070 6169 7273    "forming pairs
+0004c990: 2e20 596f 7520 6361 6e20 6861 7665 206d  . You can have m
+0004c9a0: 756c 7469 706c 6520 726f 6f6d 2061 6c69  ultiple room ali
+0004c9b0: 6173 6573 2070 6572 2072 6f6f 6d2e 2053  ases per room. S
+0004c9c0: 6f2c 2022 0a20 2020 2020 2020 2022 796f  o, ".        "yo
+0004c9d0: 7520 6d61 7920 6164 6420 6d75 6c74 6970  u may add multip
+0004c9e0: 6c65 2061 6c69 6173 6573 2074 6f20 7468  le aliases to th
+0004c9f0: 6520 7361 6d65 2072 6f6f 6d2e 2022 0a20  e same room. ". 
+0004ca00: 2020 2020 2020 2022 4120 726f 6f6d 2061         "A room a
+0004ca10: 6c69 6173 206c 6f6f 6b73 206c 696b 6520  lias looks like 
+0004ca20: 7468 6973 3a20 220a 2020 2020 2020 2020  this: ".        
+0004ca30: 2227 2373 6f6d 6552 6f6f 6d41 6c69 6173  "'#someRoomAlias
+0004ca40: 3a6d 6174 7269 782e 6578 616d 706c 652e  :matrix.example.
+0004ca50: 6f72 6727 2e20 5368 6f72 7420 616c 6961  org'. Short alia
+0004ca60: 7365 7320 6c69 6b65 2022 0a20 2020 2020  ses like ".     
+0004ca70: 2020 2022 2773 6f6d 6552 6f6f 6d41 6c69     "'someRoomAli
+0004ca80: 6173 2720 6f72 2027 2373 6f6d 6552 6f6f  as' or '#someRoo
+0004ca90: 6d41 6c69 6173 2720 6172 6520 616c 736f  mAlias' are also
+0004caa0: 2061 6363 6570 7465 642e 2022 0a20 2020   accepted. ".   
+0004cab0: 2020 2020 2022 496e 2063 6173 6520 6f66       "In case of
+0004cac0: 2061 2073 686f 7274 2061 6c69 6173 2c20   a short alias, 
+0004cad0: 220a 2020 2020 2020 2020 2269 7420 7769  ".        "it wi
+0004cae0: 6c6c 2062 6520 6175 746f 6d61 7469 6361  ll be automatica
+0004caf0: 6c6c 7920 7072 6566 6978 6564 2077 6974  lly prefixed wit
+0004cb00: 6820 2723 2720 616e 6420 7468 6520 220a  h '#' and the ".
+0004cb10: 2020 2020 2020 2020 2268 6f6d 6573 6572          "homeser
+0004cb20: 7665 7220 7769 6c6c 2062 6520 6175 746f  ver will be auto
+0004cb30: 6d61 7469 6361 6c6c 7920 6170 7065 6e64  matically append
+0004cb40: 6564 2e20 220a 2020 2020 2020 2020 2241  ed. ".        "A
+0004cb50: 6464 696e 6720 7468 6520 7361 6d65 2061  dding the same a
+0004cb60: 6c69 6173 2022 0a20 2020 2020 2020 2022  lias ".        "
+0004cb70: 6d75 6c74 6970 6c65 2074 696d 6573 2074  multiple times t
+0004cb80: 6f20 7468 6520 7361 6d65 2072 6f6f 6d20  o the same room 
+0004cb90: 7265 7375 6c74 7320 696e 2061 6e20 6572  results in an er
+0004cba0: 726f 722e 2022 0a20 2020 2020 2020 2022  ror. ".        "
+0004cbb0: 2d2d 726f 6f6d 2d70 7574 2d61 6c69 6173  --room-put-alias
+0004cbc0: 2069 7320 6571 6976 616c 656e 7420 746f   is eqivalent to
+0004cbd0: 202d 2d72 6f6f 6d2d 7365 742d 616c 6961   --room-set-alia
+0004cbe0: 732e 222c 0a20 2020 2029 0a20 2020 2061  s.",.    ).    a
+0004cbf0: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
+0004cc00: 2020 2020 2020 2020 222d 2d72 6f6f 6d2d          "--room-
+0004cc10: 7265 736f 6c76 652d 616c 6961 7322 2c0a  resolve-alias",.
+0004cc20: 2020 2020 2020 2020 7265 7175 6972 6564          required
+0004cc30: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+0004cc40: 6163 7469 6f6e 3d22 6578 7465 6e64 222c  action="extend",
+0004cc50: 0a20 2020 2020 2020 206e 6172 6773 3d22  .        nargs="
+0004cc60: 2b22 2c0a 2020 2020 2020 2020 7479 7065  +",.        type
+0004cc70: 3d73 7472 2c0a 2020 2020 2020 2020 6d65  =str,.        me
+0004cc80: 7461 7661 723d 2252 4f4f 4d5f 414c 4941  tavar="ROOM_ALIA
+0004cc90: 5322 2c0a 2020 2020 2020 2020 6865 6c70  S",.        help
+0004cca0: 3d22 5368 6f77 2072 6f6f 6d20 6964 7320  ="Show room ids 
+0004ccb0: 636f 7272 6573 706f 6e64 696e 6720 746f  corresponding to
+0004ccc0: 2072 6f6f 6d20 616c 6961 7365 732e 2022   room aliases. "
+0004ccd0: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
+0004cce0: 733a 3a20 5265 736f 6c76 6573 2061 2072  s:: Resolves a r
+0004ccf0: 6f6f 6d20 616c 6961 7320 746f 2074 6865  oom alias to the
+0004cd00: 2063 6f72 7265 7370 6f6e 6469 6e67 2072   corresponding r
+0004cd10: 6f6f 6d20 6964 2c20 220a 2020 2020 2020  oom id, ".      
+0004cd20: 2020 226f 7220 6d75 6c74 6970 6c65 2072    "or multiple r
+0004cd30: 6f6f 6d20 616c 6961 7365 7320 746f 2074  oom aliases to t
+0004cd40: 6865 6972 2063 6f72 7265 7370 6f6e 6469  heir correspondi
+0004cd50: 6e67 2072 6f6f 6d20 6964 732e 2022 0a20  ng room ids. ". 
+0004cd60: 2020 2020 2020 2022 5072 6f76 6964 6520         "Provide 
+0004cd70: 6f6e 6520 6f72 206d 756c 7469 706c 6520  one or multiple 
+0004cd80: 726f 6f6d 2061 6c69 6173 6573 2e20 220a  room aliases. ".
+0004cd90: 2020 2020 2020 2020 2241 2072 6f6f 6d20          "A room 
+0004cda0: 616c 6961 7320 6c6f 6f6b 7320 6c69 6b65  alias looks like
+0004cdb0: 2074 6869 733a 2022 0a20 2020 2020 2020   this: ".       
+0004cdc0: 2022 2723 736f 6d65 526f 6f6d 416c 6961   "'#someRoomAlia
+0004cdd0: 733a 6d61 7472 6978 2e65 7861 6d70 6c65  s:matrix.example
+0004cde0: 2e6f 7267 272e 2053 686f 7274 2061 6c69  .org'. Short ali
+0004cdf0: 6173 6573 206c 696b 6520 220a 2020 2020  ases like ".    
+0004ce00: 2020 2020 2227 736f 6d65 526f 6f6d 416c      "'someRoomAl
+0004ce10: 6961 7327 206f 7220 2723 736f 6d65 526f  ias' or '#someRo
+0004ce20: 6f6d 416c 6961 7327 2061 7265 2061 6c73  omAlias' are als
+0004ce30: 6f20 6163 6365 7074 6564 2e20 220a 2020  o accepted. ".  
+0004ce40: 2020 2020 2020 2249 6e20 6361 7365 206f        "In case o
+0004ce50: 6620 6120 7368 6f72 7420 616c 6961 732c  f a short alias,
+0004ce60: 2022 0a20 2020 2020 2020 2022 6974 2077   ".        "it w
+0004ce70: 696c 6c20 6265 2061 7574 6f6d 6174 6963  ill be automatic
+0004ce80: 616c 6c79 2070 7265 6669 7865 6420 7769  ally prefixed wi
+0004ce90: 7468 2027 2327 2061 6e64 2074 6865 2022  th '#' and the "
+0004cea0: 0a20 2020 2020 2020 2066 2268 6f6d 6573  .        f"homes
+0004ceb0: 6572 7665 7220 6672 6f6d 2074 6865 2064  erver from the d
+0004cec0: 6566 6175 6c74 2072 6f6f 6d20 6f66 207b  efault room of {
+0004ced0: 5052 4f47 5f57 4954 484f 5554 5f45 5854  PROG_WITHOUT_EXT
+0004cee0: 7d20 2861 7320 666f 756e 6420 220a 2020  } (as found ".  
+0004cef0: 2020 2020 2020 2269 6e20 6372 6564 656e        "in creden
+0004cf00: 7469 616c 7320 6669 6c65 2920 7769 6c6c  tials file) will
+0004cf10: 2062 6520 6175 746f 6d61 7469 6361 6c6c   be automaticall
+0004cf20: 7920 6170 7065 6e64 6564 2e20 220a 2020  y appended. ".  
+0004cf30: 2020 2020 2020 2252 6573 6f6c 7669 6e67        "Resolving
+0004cf40: 2061 6e20 616c 6961 7320 7468 6174 2064   an alias that d
+0004cf50: 6f65 7320 6e6f 7420 6578 6973 7420 7265  oes not exist re
+0004cf60: 7375 6c74 7320 696e 2061 6e20 6572 726f  sults in an erro
+0004cf70: 722e 2022 0a20 2020 2020 2020 2022 466f  r. ".        "Fo
+0004cf80: 7220 6561 6368 2072 6f6f 6d20 616c 6961  r each room alia
+0004cf90: 7320 6f6e 6520 6c69 6e65 2077 696c 6c20  s one line will 
+0004cfa0: 6265 2070 7269 6e74 6564 2074 6f20 7374  be printed to st
+0004cfb0: 646f 7574 2077 6974 6820 7468 6520 220a  dout with the ".
+0004cfc0: 2020 2020 2020 2020 2272 6573 756c 742e          "result.
+0004cfd0: 222c 0a20 2020 2029 0a20 2020 2061 702e  ",.    ).    ap.
+0004cfe0: 6164 645f 6172 6775 6d65 6e74 280a 2020  add_argument(.  
+0004cff0: 2020 2020 2020 222d 2d72 6f6f 6d2d 6465        "--room-de
+0004d000: 6c65 7465 2d61 6c69 6173 222c 0a20 2020  lete-alias",.   
+0004d010: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
+0004d020: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
+0004d030: 696f 6e3d 2265 7874 656e 6422 2c0a 2020  ion="extend",.  
+0004d040: 2020 2020 2020 6e61 7267 733d 222b 222c        nargs="+",
+0004d050: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
+0004d060: 722c 0a20 2020 2020 2020 206d 6574 6176  r,.        metav
+0004d070: 6172 3d22 524f 4f4d 5f41 4c49 4153 222c  ar="ROOM_ALIAS",
+0004d080: 0a20 2020 2020 2020 2068 656c 703d 2244  .        help="D
+0004d090: 656c 6574 6520 6f6e 6520 6f72 206d 756c  elete one or mul
+0004d0a0: 7469 706c 6520 726f 6f6d 7320 616c 6961  tiple rooms alia
+0004d0b0: 7365 732e 2022 0a20 2020 2020 2020 2022  ses. ".        "
+0004d0c0: 4465 7461 696c 733a 3a20 5072 6f76 6964  Details:: Provid
+0004d0d0: 6520 6f6e 6520 6f72 206d 756c 7469 706c  e one or multipl
+0004d0e0: 6520 726f 6f6d 2061 6c69 6173 6573 2e20  e room aliases. 
+0004d0f0: 220a 2020 2020 2020 2020 2259 6f75 2063  ".        "You c
+0004d100: 616e 2068 6176 6520 6d75 6c74 6970 6c65  an have multiple
+0004d110: 2072 6f6f 6d20 616c 6961 7365 7320 7065   room aliases pe
+0004d120: 7220 726f 6f6d 2e20 536f 2c20 220a 2020  r room. So, ".  
+0004d130: 2020 2020 2020 2279 6f75 206d 6179 2064        "you may d
+0004d140: 656c 6574 6520 6d75 6c74 6970 6c65 2061  elete multiple a
+0004d150: 6c69 6173 6573 2066 726f 6d20 7468 6520  liases from the 
+0004d160: 7361 6d65 2072 6f6f 6d20 6f72 2066 726f  same room or fro
+0004d170: 6d20 6469 6666 6572 656e 7420 220a 2020  m different ".  
+0004d180: 2020 2020 2020 2272 6f6f 6d73 2e20 220a        "rooms. ".
+0004d190: 2020 2020 2020 2020 2241 2072 6f6f 6d20          "A room 
+0004d1a0: 616c 6961 7320 6c6f 6f6b 7320 6c69 6b65  alias looks like
+0004d1b0: 2074 6869 733a 2022 0a20 2020 2020 2020   this: ".       
+0004d1c0: 2022 2723 736f 6d65 526f 6f6d 416c 6961   "'#someRoomAlia
+0004d1d0: 733a 6d61 7472 6978 2e65 7861 6d70 6c65  s:matrix.example
+0004d1e0: 2e6f 7267 272e 2053 686f 7274 2061 6c69  .org'. Short ali
+0004d1f0: 6173 6573 206c 696b 6520 220a 2020 2020  ases like ".    
+0004d200: 2020 2020 2227 736f 6d65 526f 6f6d 416c      "'someRoomAl
+0004d210: 6961 7327 206f 7220 2723 736f 6d65 526f  ias' or '#someRo
+0004d220: 6f6d 416c 6961 7327 2061 7265 2061 6c73  omAlias' are als
+0004d230: 6f20 6163 6365 7074 6564 2e20 220a 2020  o accepted. ".  
+0004d240: 2020 2020 2020 2249 6e20 6361 7365 206f        "In case o
+0004d250: 6620 6120 7368 6f72 7420 616c 6961 732c  f a short alias,
+0004d260: 2022 0a20 2020 2020 2020 2022 6974 2077   ".        "it w
+0004d270: 696c 6c20 6265 2061 7574 6f6d 6174 6963  ill be automatic
+0004d280: 616c 6c79 2070 7265 6669 7865 6420 7769  ally prefixed wi
+0004d290: 7468 2027 2327 2061 6e64 2074 6865 2022  th '#' and the "
+0004d2a0: 0a20 2020 2020 2020 2066 2268 6f6d 6573  .        f"homes
+0004d2b0: 6572 7665 7220 6672 6f6d 2074 6865 2064  erver from the d
+0004d2c0: 6566 6175 6c74 2072 6f6f 6d20 6f66 207b  efault room of {
+0004d2d0: 5052 4f47 5f57 4954 484f 5554 5f45 5854  PROG_WITHOUT_EXT
+0004d2e0: 7d20 2861 7320 666f 756e 6420 220a 2020  } (as found ".  
+0004d2f0: 2020 2020 2020 2269 6e20 6372 6564 656e        "in creden
+0004d300: 7469 616c 7320 6669 6c65 2920 7769 6c6c  tials file) will
+0004d310: 2062 6520 6175 746f 6d61 7469 6361 6c6c   be automaticall
+0004d320: 7920 6170 7065 6e64 6564 2e20 220a 2020  y appended. ".  
+0004d330: 2020 2020 2020 2244 656c 6574 696e 6720        "Deleting 
+0004d340: 616e 2061 6c69 6173 2074 6861 7420 646f  an alias that do
+0004d350: 6573 206e 6f74 2065 7869 7374 2072 6573  es not exist res
+0004d360: 756c 7473 2069 6e20 616e 2065 7272 6f72  ults in an error
+0004d370: 2e22 2c0a 2020 2020 290a 2020 2020 6170  .",.    ).    ap
+0004d380: 2e61 6464 5f61 7267 756d 656e 7428 0a20  .add_argument(. 
+0004d390: 2020 2020 2020 2022 2d2d 6765 742d 6f70         "--get-op
+0004d3a0: 656e 6964 2d74 6f6b 656e 222c 0a20 2020  enid-token",.   
+0004d3b0: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
+0004d3c0: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
+0004d3d0: 696f 6e3d 2265 7874 656e 6422 2c0a 2020  ion="extend",.  
+0004d3e0: 2020 2020 2020 6e61 7267 733d 222a 222c        nargs="*",
+0004d3f0: 2020 2320 4e6f 6e65 2069 6620 6e6f 7420    # None if not 
+0004d400: 7573 6564 2c20 5b5d 2069 7320 7573 6564  used, [] is used
+0004d410: 2077 6974 686f 7574 2065 7874 7261 2061   without extra a
+0004d420: 7267 730a 2020 2020 2020 2020 7479 7065  rgs.        type
+0004d430: 3d73 7472 2c0a 2020 2020 2020 2020 6d65  =str,.        me
+0004d440: 7461 7661 723d 2255 5345 5222 2c0a 2020  tavar="USER",.  
+0004d450: 2020 2020 2020 6865 6c70 3d22 4765 7420        help="Get 
+0004d460: 616e 204f 7065 6e49 4420 746f 6b65 6e2e  an OpenID token.
+0004d470: 2022 0a20 2020 2020 2020 2066 2244 6574   ".        f"Det
+0004d480: 6169 6c73 3a3a 2047 6574 2061 6e20 4f70  ails:: Get an Op
+0004d490: 656e 4944 2074 6f6b 656e 2066 6f72 207b  enID token for {
+0004d4a0: 5052 4f47 5f57 4954 484f 5554 5f45 5854  PROG_WITHOUT_EXT
+0004d4b0: 7d2c 206f 7220 666f 7220 220a 2020 2020  }, or for ".    
+0004d4c0: 2020 2020 226f 6e65 206f 7220 6d75 6c74      "one or mult
+0004d4d0: 6970 6c65 206f 7468 6572 2075 7365 7273  iple other users
+0004d4e0: 2e20 4974 2070 7269 6e74 7320 616e 204f  . It prints an O
+0004d4f0: 7065 6e49 4420 746f 6b65 6e20 6f62 6a65  penID token obje
+0004d500: 6374 2022 0a20 2020 2020 2020 2022 7468  ct ".        "th
+0004d510: 6174 2074 6865 2072 6571 7565 7374 6572  at the requester
+0004d520: 206d 6179 2073 7570 706c 7920 746f 2061   may supply to a
+0004d530: 6e6f 7468 6572 2073 6572 7669 6365 2074  nother service t
+0004d540: 6f20 7665 7269 6679 2074 6865 6972 2022  o verify their "
+0004d550: 0a20 2020 2020 2020 2022 6964 656e 7469  .        "identi
+0004d560: 7479 2069 6e20 4d61 7472 6978 2e20 5365  ty in Matrix. Se
+0004d570: 6520 6874 7470 3a2f 2f77 7777 2e6f 7065  e http://www.ope
+0004d580: 6e69 642e 6e65 742f 2e20 220a 2020 2020  nid.net/. ".    
+0004d590: 2020 2020 2253 7065 6369 6679 207a 6572      "Specify zer
+0004d5a0: 6f20 6f72 206d 6f72 6520 7573 6572 2069  o or more user i
+0004d5b0: 6473 2e20 220a 2020 2020 2020 2020 6622  ds. ".        f"
+0004d5c0: 4966 206e 6f20 7573 6572 2069 6420 6973  If no user id is
+0004d5d0: 2073 7065 6369 6669 6564 2c20 616e 204f   specified, an O
+0004d5e0: 7065 6e49 4420 666f 7220 7b50 524f 475f  penID for {PROG_
+0004d5f0: 5749 5448 4f55 545f 4558 547d 2077 696c  WITHOUT_EXT} wil
+0004d600: 6c20 220a 2020 2020 2020 2020 2262 6520  l ".        "be 
+0004d610: 6665 7463 6865 642e 2049 6620 6f6e 6520  fetched. If one 
+0004d620: 6f72 206d 6f72 6520 7573 6572 2069 6473  or more user ids
+0004d630: 2061 7265 2067 6976 656e 2c20 7468 6520   are given, the 
+0004d640: 4f70 656e 4944 206f 6620 220a 2020 2020  OpenID of ".    
+0004d650: 2020 2020 2274 6865 7365 2075 7365 7273      "these users
+0004d660: 2077 696c 6c20 6265 2066 6574 6368 6564   will be fetched
+0004d670: 2e20 4173 2072 6573 706f 6e73 6520 7468  . As response th
+0004d680: 6520 7573 6572 2069 6428 7329 2061 6e64  e user id(s) and
+0004d690: 2022 0a20 2020 2020 2020 2022 4f70 656e   ".        "Open
+0004d6a0: 4944 2873 2920 7769 6c6c 2062 6520 7072  ID(s) will be pr
+0004d6b0: 696e 7465 642e 222c 0a20 2020 2029 0a20  inted.",.    ). 
+0004d6c0: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
+0004d6d0: 6e74 280a 2020 2020 2020 2020 222d 2d72  nt(.        "--r
+0004d6e0: 6f6f 6d2d 6765 742d 7669 7369 6269 6c69  oom-get-visibili
+0004d6f0: 7479 222c 0a20 2020 2020 2020 2072 6571  ty",.        req
+0004d700: 7569 7265 643d 4661 6c73 652c 0a20 2020  uired=False,.   
+0004d710: 2020 2020 2061 6374 696f 6e3d 2265 7874       action="ext
+0004d720: 656e 6422 2c0a 2020 2020 2020 2020 6e61  end",.        na
+0004d730: 7267 733d 222a 222c 2020 2320 4e6f 6e65  rgs="*",  # None
+0004d740: 2069 6620 6e6f 7420 7573 6564 2c20 5b5d   if not used, []
+0004d750: 2069 7320 7573 6564 2077 6974 686f 7574   is used without
+0004d760: 2065 7874 7261 2061 7267 730a 2020 2020   extra args.    
+0004d770: 2020 2020 7479 7065 3d73 7472 2c0a 2020      type=str,.  
+0004d780: 2020 2020 2020 6d65 7461 7661 723d 2252        metavar="R
+0004d790: 4f4f 4d22 2c0a 2020 2020 2020 2020 6865  OOM",.        he
+0004d7a0: 6c70 3d22 4765 7420 7468 6520 7669 7369  lp="Get the visi
+0004d7b0: 6269 6c69 7479 206f 6620 6f6e 6520 6f72  bility of one or
+0004d7c0: 206d 6f72 6520 726f 6f6d 732e 2022 0a20   more rooms. ". 
+0004d7d0: 2020 2020 2020 2022 4465 7461 696c 733a         "Details:
+0004d7e0: 3a20 5072 6f76 6964 6520 7a65 726f 206f  : Provide zero o
+0004d7f0: 7220 6d6f 7265 2072 6f6f 6d20 6964 7320  r more room ids 
+0004d800: 6173 2061 7267 756d 656e 7473 2e20 220a  as arguments. ".
+0004d810: 2020 2020 2020 2020 2249 6620 6e6f 2061          "If no a
+0004d820: 7267 756d 656e 7420 6973 2067 6976 656e  rgument is given
+0004d830: 2c20 7468 656e 2074 6865 2064 6566 6175  , then the defau
+0004d840: 6c74 2072 6f6f 6d20 6f66 2022 0a20 2020  lt room of ".   
+0004d850: 2020 2020 2066 227b 5052 4f47 5f57 4954       f"{PROG_WIT
+0004d860: 484f 5554 5f45 5854 7d20 2861 7320 666f  HOUT_EXT} (as fo
+0004d870: 756e 6420 696e 2063 7265 6465 6e74 6961  und in credentia
+0004d880: 6c73 2066 696c 6529 2077 696c 6c20 6265  ls file) will be
+0004d890: 2075 7365 642e 2022 0a20 2020 2020 2020   used. ".       
+0004d8a0: 2022 466f 7220 6561 6368 2072 6f6f 6d20   "For each room 
+0004d8b0: 7468 6520 7669 7369 6269 6c69 7479 2077  the visibility w
+0004d8c0: 696c 6c20 6265 2070 7269 6e74 6564 2e20  ill be printed. 
+0004d8d0: 4375 7272 656e 746c 792c 2074 6869 7320  Currently, this 
+0004d8e0: 220a 2020 2020 2020 2020 2269 7320 6569  ".        "is ei
+0004d8f0: 7468 6572 2074 6865 2073 7472 696e 6720  ther the string 
+0004d900: 2770 7269 7661 7465 2720 6f72 2027 7075  'private' or 'pu
+0004d910: 626c 6963 272e 2022 0a20 2020 2020 2020  blic'. ".       
+0004d920: 2022 4173 2072 6573 706f 6e73 6520 6f6e   "As response on
+0004d930: 6520 6c69 6e65 2070 6572 2072 6f6f 6d20  e line per room 
+0004d940: 7769 6c6c 2062 6520 7072 696e 7465 6420  will be printed 
+0004d950: 746f 2073 7464 6f75 742e 222c 0a20 2020  to stdout.",.   
+0004d960: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
+0004d970: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
+0004d980: 222d 2d72 6f6f 6d2d 6765 742d 7374 6174  "--room-get-stat
+0004d990: 6522 2c0a 2020 2020 2020 2020 7265 7175  e",.        requ
+0004d9a0: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
+0004d9b0: 2020 2020 6163 7469 6f6e 3d22 6578 7465      action="exte
+0004d9c0: 6e64 222c 0a20 2020 2020 2020 206e 6172  nd",.        nar
+0004d9d0: 6773 3d22 2a22 2c20 2023 204e 6f6e 6520  gs="*",  # None 
+0004d9e0: 6966 206e 6f74 2075 7365 642c 205b 5d20  if not used, [] 
+0004d9f0: 6973 2075 7365 6420 7769 7468 6f75 7420  is used without 
+0004da00: 6578 7472 6120 6172 6773 0a20 2020 2020  extra args.     
+0004da10: 2020 2074 7970 653d 7374 722c 0a20 2020     type=str,.   
+0004da20: 2020 2020 206d 6574 6176 6172 3d22 524f       metavar="RO
+0004da30: 4f4d 222c 0a20 2020 2020 2020 2068 656c  OM",.        hel
+0004da40: 703d 2247 6574 2074 6865 2073 7461 7465  p="Get the state
+0004da50: 206f 6620 6f6e 6520 6f72 206d 6f72 6520   of one or more 
+0004da60: 726f 6f6d 732e 2022 0a20 2020 2020 2020  rooms. ".       
+0004da70: 2022 4465 7461 696c 733a 3a50 726f 7669   "Details::Provi
+0004da80: 6465 207a 6572 6f20 6f72 206d 6f72 6520  de zero or more 
+0004da90: 726f 6f6d 2069 6473 2061 7320 6172 6775  room ids as argu
+0004daa0: 6d65 6e74 732e 2022 0a20 2020 2020 2020  ments. ".       
+0004dab0: 2022 4966 206e 6f20 6172 6775 6d65 6e74   "If no argument
+0004dac0: 2069 7320 6769 7665 6e2c 2074 6865 6e20   is given, then 
+0004dad0: 7468 6520 6465 6661 756c 7420 726f 6f6d  the default room
+0004dae0: 206f 6620 220a 2020 2020 2020 2020 6622   of ".        f"
+0004daf0: 7b50 524f 475f 5749 5448 4f55 545f 4558  {PROG_WITHOUT_EX
+0004db00: 547d 2028 6173 2066 6f75 6e64 2069 6e20  T} (as found in 
+0004db10: 6372 6564 656e 7469 616c 7320 6669 6c65  credentials file
+0004db20: 2920 7769 6c6c 2062 6520 7573 6564 2e20  ) will be used. 
+0004db30: 220a 2020 2020 2020 2020 2246 6f72 2065  ".        "For e
+0004db40: 6163 6820 726f 6f6d 2074 6865 2073 7461  ach room the sta
+0004db50: 7465 2077 696c 6c20 6265 2070 7269 6e74  te will be print
+0004db60: 6564 2e20 5468 6520 7374 6174 6520 6973  ed. The state is
+0004db70: 2061 206c 6f6e 6720 220a 2020 2020 2020   a long ".      
+0004db80: 2020 226c 6973 7420 6f66 2065 7665 6e74    "list of event
+0004db90: 7320 696e 636c 7564 696e 6720 6576 656e  s including even
+0004dba0: 7473 206c 696b 6520 276d 2e72 6f6f 6d2e  ts like 'm.room.
+0004dbb0: 6372 6561 7465 272c 2022 0a20 2020 2020  create', ".     
+0004dbc0: 2020 2022 276d 2e72 6f6f 6d2e 656e 6372     "'m.room.encr
+0004dbd0: 7970 7469 6f6e 272c 2027 6d2e 726f 6f6d  yption', 'm.room
+0004dbe0: 2e67 7565 7374 5f61 6363 6573 7327 2c20  .guest_access', 
+0004dbf0: 220a 2020 2020 2020 2020 2227 6d2e 726f  ".        "'m.ro
+0004dc00: 6f6d 2e68 6973 746f 7279 5f76 6973 6962  om.history_visib
+0004dc10: 696c 6974 7927 2c20 276d 2e72 6f6f 6d2e  ility', 'm.room.
+0004dc20: 6a6f 696e 5f72 756c 6573 272c 2022 0a20  join_rules', ". 
+0004dc30: 2020 2020 2020 2022 276d 2e72 6f6f 6d2e         "'m.room.
+0004dc40: 6d65 6d62 6572 272c 2027 6d2e 726f 6f6d  member', 'm.room
+0004dc50: 2e70 6f77 6572 5f6c 6576 656c 7327 2c20  .power_levels', 
+0004dc60: 6574 632e 2022 0a20 2020 2020 2020 2022  etc. ".        "
+0004dc70: 4173 2072 6573 706f 6e73 6520 6f6e 6520  As response one 
+0004dc80: 6c69 6e65 2070 6572 2072 6f6f 6d20 7769  line per room wi
+0004dc90: 6c6c 2062 6520 7072 696e 7465 6420 746f  ll be printed to
+0004dca0: 2073 7464 6f75 742e 2022 0a20 2020 2020   stdout. ".     
+0004dcb0: 2020 2022 5468 6520 6c69 6e65 2063 616e     "The line can
+0004dcc0: 2062 6520 7665 7279 206c 6f6e 6720 6173   be very long as
+0004dcd0: 2074 6865 206c 6973 7420 6f66 2065 7665   the list of eve
+0004dce0: 6e74 7320 6361 6e20 6265 2076 6572 7920  nts can be very 
+0004dcf0: 6c61 7267 652e 2022 0a20 2020 2020 2020  large. ".       
+0004dd00: 2022 546f 2067 6574 206f 7574 7075 7420   "To get output 
+0004dd10: 696e 746f 2061 2068 756d 616e 2072 6561  into a human rea
+0004dd20: 6461 626c 6520 666f 726d 2070 6970 6520  dable form pipe 
+0004dd30: 6f75 7470 7574 2074 6872 6f75 6768 2073  output through s
+0004dd40: 6564 2022 0a20 2020 2020 2020 2022 616e  ed ".        "an
+0004dd50: 6420 6a71 2061 7320 7368 6f77 6e20 696e  d jq as shown in
+0004dd60: 2061 6e20 6578 616d 706c 6520 696e 2074   an example in t
+0004dd70: 6573 7473 2f74 6573 742d 7365 7467 6574  ests/test-setget
+0004dd80: 2e73 682e 222c 0a20 2020 2029 0a20 2020  .sh.",.    ).   
+0004dd90: 2061 702e 6164 645f 6172 6775 6d65 6e74   ap.add_argument
+0004dda0: 280a 2020 2020 2020 2020 222d 2d64 656c  (.        "--del
+0004ddb0: 6574 652d 6465 7669 6365 222c 0a20 2020  ete-device",.   
+0004ddc0: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
+0004ddd0: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
+0004dde0: 696f 6e3d 2265 7874 656e 6422 2c0a 2020  ion="extend",.  
+0004ddf0: 2020 2020 2020 6e61 7267 733d 222b 222c        nargs="+",
+0004de00: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
+0004de10: 722c 0a20 2020 2020 2020 206d 6574 6176  r,.        metav
+0004de20: 6172 3d22 4445 5649 4345 222c 0a20 2020  ar="DEVICE",.   
+0004de30: 2020 2020 2068 656c 703d 6622 4465 6c65       help=f"Dele
+0004de40: 7465 206f 6e65 206f 7220 6d75 6c74 6970  te one or multip
+0004de50: 6c65 2064 6576 6963 6573 2e20 220a 2020  le devices. ".  
+0004de60: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
+0004de70: 2042 7920 6465 6661 756c 7420 6465 7669   By default devi
+0004de80: 6365 7320 6265 6c6f 6e67 696e 6720 220a  ces belonging ".
+0004de90: 2020 2020 2020 2020 6622 746f 207b 5052          f"to {PR
+0004dea0: 4f47 5f57 4954 484f 5554 5f45 5854 7d20  OG_WITHOUT_EXT} 
+0004deb0: 7769 6c6c 2062 6520 6465 6c65 7465 642e  will be deleted.
+0004dec0: 2049 6620 7468 6520 6465 7669 6365 7320   If the devices 
+0004ded0: 6265 6c6f 6e67 2022 0a20 2020 2020 2020  belong ".       
+0004dee0: 2022 746f 2061 2064 6966 6665 7265 6e74   "to a different
+0004def0: 2075 7365 722c 2075 7365 2074 6865 202d   user, use the -
+0004df00: 2d75 7365 7220 6172 6775 6d65 6e74 2074  -user argument t
+0004df10: 6f20 7370 6563 6966 7920 7468 6520 7573  o specify the us
+0004df20: 6572 2c20 220a 2020 2020 2020 2020 2269  er, ".        "i
+0004df30: 2e65 2e20 6f77 6e65 722e 204f 6e6c 7920  .e. owner. Only 
+0004df40: 220a 2020 2020 2020 2020 2265 7861 6374  ".        "exact
+0004df50: 6c79 206f 6e65 2075 7365 7220 6361 6e20  ly one user can 
+0004df60: 6265 2073 7065 6369 6669 6564 2077 6974  be specified wit
+0004df70: 6820 7468 6520 6f70 7469 6f6e 616c 202d  h the optional -
+0004df80: 2d75 7365 7220 6172 6775 6d65 6e74 2e20  -user argument. 
+0004df90: 220a 2020 2020 2020 2020 2244 6576 6963  ".        "Devic
+0004dfa0: 6520 6465 6c65 7469 6f6e 2072 6571 7569  e deletion requi
+0004dfb0: 7265 7320 7468 6520 7573 6572 2070 6173  res the user pas
+0004dfc0: 7377 6f72 642e 2049 7420 6d75 7374 2062  sword. It must b
+0004dfd0: 6520 7370 6563 6966 6965 6420 220a 2020  e specified ".  
+0004dfe0: 2020 2020 2020 2277 6974 6820 7468 6520        "with the 
+0004dff0: 2d2d 7061 7373 776f 7264 2061 7267 756d  --password argum
+0004e000: 656e 742e 2049 6620 7468 6520 7365 7276  ent. If the serv
+0004e010: 6572 2075 7365 7320 6f6e 6c79 2048 5454  er uses only HTT
+0004e020: 5020 2861 6e64 2022 0a20 2020 2020 2020  P (and ".       
+0004e030: 2022 6e6f 7420 4854 5450 5329 2c20 7468   "not HTTPS), th
+0004e040: 656e 2074 6865 2070 6173 7377 6f72 6420  en the password 
+0004e050: 6361 6e20 6265 2076 6973 6962 6c65 2074  can be visible t
+0004e060: 6f20 6174 7461 636b 6572 732e 2048 656e  o attackers. Hen
+0004e070: 6365 2c20 220a 2020 2020 2020 2020 2269  ce, ".        "i
+0004e080: 6620 7468 6520 7365 7276 6572 2064 6f65  f the server doe
+0004e090: 7320 6e6f 7420 7375 7070 6f72 7420 4854  s not support HT
+0004e0a0: 5450 5320 7468 6973 206f 7065 7261 7469  TPS this operati
+0004e0b0: 6f6e 2069 7320 6469 7363 6f75 7261 6765  on is discourage
+0004e0c0: 642e 222c 0a20 2020 2029 0a20 2020 2061  d.",.    ).    a
+0004e0d0: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
+0004e0e0: 2020 2020 2020 2020 222d 2d72 6f6f 6d2d          "--room-
+0004e0f0: 7265 6461 6374 222c 0a20 2020 2020 2020  redact",.       
+0004e100: 2022 2d2d 726f 6f6d 2d64 656c 6574 652d   "--room-delete-
+0004e110: 636f 6e74 656e 7422 2c0a 2020 2020 2020  content",.      
+0004e120: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
+0004e130: 2c0a 2020 2020 2020 2020 6163 7469 6f6e  ,.        action
+0004e140: 3d22 6578 7465 6e64 222c 0a20 2020 2020  ="extend",.     
+0004e150: 2020 206e 6172 6773 3d22 2b22 2c0a 2020     nargs="+",.  
+0004e160: 2020 2020 2020 7479 7065 3d73 7472 2c0a        type=str,.
+0004e170: 2020 2020 2020 2020 6d65 7461 7661 723d          metavar=
+0004e180: 2252 4f4f 4d5f 4944 2045 5645 4e54 5f49  "ROOM_ID EVENT_I
+0004e190: 4420 5245 4153 4f4e 222c 0a20 2020 2020  D REASON",.     
+0004e1a0: 2020 2068 656c 703d 2253 7472 6970 2069     help="Strip i
+0004e1b0: 6e66 6f72 6d61 7469 6f6e 206f 7574 206f  nformation out o
+0004e1c0: 6620 6f6e 6520 6f72 2073 6576 6572 616c  f one or several
+0004e1d0: 2065 7665 6e74 732e 2022 0a20 2020 2020   events. ".     
+0004e1e0: 2020 2022 4465 7461 696c 733a 3a20 220a     "Details:: ".
+0004e1f0: 2020 2020 2020 2020 2253 7472 6970 2069          "Strip i
+0004e200: 6e66 6f72 6d61 7469 6f6e 2066 726f 6d20  nformation from 
+0004e210: 6576 656e 7473 2c20 652e 672e 206d 6573  events, e.g. mes
+0004e220: 7361 6765 732e 2022 0a20 2020 2020 2020  sages. ".       
+0004e230: 2022 5265 6461 6374 2069 7320 7573 6564   "Redact is used
+0004e240: 2069 6e20 7468 6520 6d65 616e 696e 6720   in the meaning 
+0004e250: 6f66 2027 7374 7269 702c 2077 6970 652c  of 'strip, wipe,
+0004e260: 2062 6c61 636b 2d6f 7574 272c 206e 6f74   black-out', not
+0004e270: 2022 0a20 2020 2020 2020 2022 696e 2074   ".        "in t
+0004e280: 6865 206d 6561 6e69 6e67 206f 6620 2765  he meaning of 'e
+0004e290: 6469 7427 2e20 5468 6973 2061 6374 696f  dit'. This actio
+0004e2a0: 6e20 7265 6d6f 7665 732c 2064 656c 6574  n removes, delet
+0004e2b0: 6573 2074 6865 2063 6f6e 7465 6e74 2022  es the content "
+0004e2c0: 0a20 2020 2020 2020 2022 6f66 2061 6e20  .        "of an 
+0004e2d0: 6576 656e 7420 7768 696c 6520 6e6f 7420  event while not 
+0004e2e0: 7265 6d6f 7669 6e67 2074 6865 2065 7665  removing the eve
+0004e2f0: 6e74 2e20 596f 7520 6361 6e20 7769 7065  nt. You can wipe
+0004e300: 2074 6578 7420 6672 6f6d 2061 2022 0a20   text from a ". 
+0004e310: 2020 2020 2020 2022 7072 6576 696f 7573         "previous
+0004e320: 206d 6573 7361 6765 2c20 6574 632e 2054   message, etc. T
+0004e330: 7970 6963 616c 204d 6174 7269 7820 636c  ypical Matrix cl
+0004e340: 6965 6e74 7320 6c69 6b65 2045 6c65 6d65  ients like Eleme
+0004e350: 6e74 2077 696c 6c20 220a 2020 2020 2020  nt will ".      
+0004e360: 2020 2264 656c 6574 6520 6d65 7373 6167    "delete messag
+0004e370: 6573 2c20 696d 6167 6573 2061 6e64 206f  es, images and o
+0004e380: 7468 6572 206f 626a 6563 7473 2066 726f  ther objects fro
+0004e390: 6d20 7468 6520 4755 4920 6f6e 6365 2074  m the GUI once t
+0004e3a0: 6865 7920 220a 2020 2020 2020 2020 2268  hey ".        "h
+0004e3b0: 6176 6520 6265 656e 2072 6564 6163 7465  ave been redacte
+0004e3c0: 642e 2022 0a20 2020 2020 2020 2022 536f  d. ".        "So
+0004e3d0: 2c20 2d2d 726f 6f6d 2d72 6564 6163 7420  , --room-redact 
+0004e3e0: 6973 2061 2077 6179 2074 6f20 6465 6c65  is a way to dele
+0004e3f0: 7465 2061 206d 6573 7361 6765 2c20 696d  te a message, im
+0004e400: 6167 6573 2c20 6574 632e 2022 0a20 2020  ages, etc. ".   
+0004e410: 2020 2020 2022 5468 6520 636f 6e74 656e       "The conten
+0004e420: 7420 6973 2022 0a20 2020 2020 2020 2022  t is ".        "
+0004e430: 7769 7065 642c 2074 6865 2047 5549 2064  wiped, the GUI d
+0004e440: 656c 6574 6573 2074 6865 206d 6573 7361  eletes the messa
+0004e450: 6765 2c20 6275 7420 7468 6520 7365 7276  ge, but the serv
+0004e460: 6572 206b 6565 7073 2074 6865 2065 7665  er keeps the eve
+0004e470: 6e74 2022 0a20 2020 2020 2020 2022 6869  nt ".        "hi
+0004e480: 7374 6f72 792e 204e 6f74 652c 2077 6869  story. Note, whi
+0004e490: 6c65 2074 6869 7320 6465 6c65 7465 7320  le this deletes 
+0004e4a0: 6672 6f6d 2074 6865 2063 6c69 656e 7420  from the client 
+0004e4b0: 2847 5549 2c20 652e 672e 2022 0a20 2020  (GUI, e.g. ".   
+0004e4c0: 2020 2020 2022 456c 656d 656e 7429 2c20       "Element), 
+0004e4d0: 6974 2064 6f65 7320 6e6f 7420 6465 6c65  it does not dele
+0004e4e0: 7465 2066 726f 6d20 7468 6520 6461 7461  te from the data
+0004e4f0: 6261 7365 206f 6e20 7468 6520 7365 7276  base on the serv
+0004e500: 6572 2e20 220a 2020 2020 2020 2020 2253  er. ".        "S
+0004e510: 6f2c 2074 6869 7320 6361 6c6c 2069 7320  o, this call is 
+0004e520: 6e6f 7420 6120 7761 7920 746f 2063 6c65  not a way to cle
+0004e530: 616e 2075 7020 7468 6520 7365 7276 6572  an up the server
+0004e540: 2064 6174 6162 6173 652e 2022 0a20 2020   database. ".   
+0004e550: 2020 2020 2022 4561 6368 2072 6564 6163       "Each redac
+0004e560: 7420 2877 6970 652c 2073 7472 6970 2c20  t (wipe, strip, 
+0004e570: 6465 6c65 7465 2920 6f70 6572 6174 696f  delete) operatio
+0004e580: 6e20 7265 7175 6972 6573 2065 7861 6374  n requires exact
+0004e590: 6c79 2033 2022 0a20 2020 2020 2020 2022  ly 3 ".        "
+0004e5a0: 6172 6775 6d65 6e74 732e 2022 0a20 2020  arguments. ".   
+0004e5b0: 2020 2020 2022 5468 6520 6172 6775 6d65       "The argume
+0004e5c0: 6e74 2074 7269 706c 6573 2061 7265 3a20  nt triples are: 
+0004e5d0: 220a 2020 2020 2020 2020 2228 6129 2074  ".        "(a) t
+0004e5e0: 6865 2072 6f6f 6d20 6964 2e20 220a 2020  he room id. ".  
+0004e5f0: 2020 2020 2020 2228 6229 2074 6865 2069        "(b) the i
+0004e600: 6420 6f66 2074 6865 2065 7665 6e74 2074  d of the event t
+0004e610: 6f20 6265 2072 6564 6163 7465 642e 2022  o be redacted. "
+0004e620: 0a20 2020 2020 2020 2022 2863 2920 6120  .        "(c) a 
+0004e630: 7374 7269 6e67 2063 6f6e 7461 696e 696e  string containin
+0004e640: 6720 7468 6520 7265 6173 6f6e 2066 6f72  g the reason for
+0004e650: 2074 6865 2072 6564 6163 7469 6f6e 2e20   the redaction. 
+0004e660: 5573 6520 2727 2069 6620 796f 7520 220a  Use '' if you ".
+0004e670: 2020 2020 2020 2020 2264 6f20 6e6f 7420          "do not 
+0004e680: 7761 6e74 2074 6f20 6769 7665 2061 2072  want to give a r
+0004e690: 6561 736f 6e2e 2022 0a20 2020 2020 2020  eason. ".       
+0004e6a0: 2022 536f 2c20 7468 6520 746f 7461 6c20   "So, the total 
+0004e6b0: 6e75 6d62 6572 206f 6620 6172 6775 6d65  number of argume
+0004e6c0: 6e74 7320 7573 6564 2077 6974 6820 2d2d  nts used with --
+0004e6d0: 726f 6f6d 2d72 6564 6163 7420 6d75 7374  room-redact must
+0004e6e0: 2062 6520 6120 220a 2020 2020 2020 2020   be a ".        
+0004e6f0: 226d 756c 7469 706c 6520 6f66 2033 2c20  "multiple of 3, 
+0004e700: 6275 7420 7765 2061 6c73 6f20 6163 6365  but we also acce
+0004e710: 7074 2032 2069 6e20 7768 6963 6820 6361  pt 2 in which ca
+0004e720: 7365 206f 6e6c 7920 6f6e 6520 220a 2020  se only one ".  
+0004e730: 2020 2020 2020 2272 6564 6163 7469 6f6e        "redaction
+0004e740: 2077 696c 6c20 6265 2064 6f6e 6520 7769   will be done wi
+0004e750: 7468 6f75 7420 7370 6563 6966 7969 6e67  thout specifying
+0004e760: 2061 2072 6561 736f 6e2e 2022 0a20 2020   a reason. ".   
+0004e770: 2020 2020 2022 4576 656e 7420 6964 7320       "Event ids 
+0004e780: 7374 6172 7420 7769 7468 2074 6865 2064  start with the d
+0004e790: 6f6c 6c61 7220 7369 676e 2028 2429 2e20  ollar sign ($). 
+0004e7a0: 4465 7065 6e64 696e 6720 6f6e 2079 6f75  Depending on you
+0004e7b0: 7220 7368 656c 6c2c 2022 0a20 2020 2020  r shell, ".     
+0004e7c0: 2020 2022 796f 7520 6d69 6768 7420 6861     "you might ha
+0004e7d0: 7665 2074 6f20 6573 6361 7065 2074 6865  ve to escape the
+0004e7e0: 2027 2427 2074 6f20 275c 5c24 272e 202d   '$' to '\\$'. -
+0004e7f0: 2d72 6f6f 6d2d 6465 6c65 7465 2d63 6f6e  -room-delete-con
+0004e800: 7465 6e74 2069 7320 220a 2020 2020 2020  tent is ".      
+0004e810: 2020 2261 6e20 616c 6961 7320 666f 7220    "an alias for 
+0004e820: 2d2d 726f 6f6d 2d72 6564 6163 742e 2054  --room-redact. T
+0004e830: 6865 7920 6361 6e20 6265 2075 7365 6420  hey can be used 
+0004e840: 696e 7465 7263 6861 6e67 6561 626c 792e  interchangeably.
+0004e850: 222c 0a20 2020 2029 0a20 2020 2061 702e  ",.    ).    ap.
+0004e860: 6164 645f 6172 6775 6d65 6e74 280a 2020  add_argument(.  
+0004e870: 2020 2020 2020 2320 6e6f 2073 696e 676c        # no singl
+0004e880: 6520 6368 6172 2066 6c61 670a 2020 2020  e char flag.    
+0004e890: 2020 2020 222d 2d77 686f 616d 6922 2c0a      "--whoami",.
+0004e8a0: 2020 2020 2020 2020 7265 7175 6972 6564          required
+0004e8b0: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+0004e8c0: 6163 7469 6f6e 3d22 7374 6f72 655f 7472  action="store_tr
+0004e8d0: 7565 222c 0a20 2020 2020 2020 2068 656c  ue",.        hel
+0004e8e0: 703d 2250 7269 6e74 2079 6f75 7220 7573  p="Print your us
+0004e8f0: 6572 2069 642e 2022 0a20 2020 2020 2020  er id. ".       
+0004e900: 2066 2244 6574 6169 6c73 3a3a 2050 7269   f"Details:: Pri
+0004e910: 6e74 2074 6865 2075 7365 7220 6964 2075  nt the user id u
+0004e920: 7365 6420 6279 207b 5052 4f47 5f57 4954  sed by {PROG_WIT
+0004e930: 484f 5554 5f45 5854 7d20 2869 7473 656c  HOUT_EXT} (itsel
+0004e940: 6629 2e20 220a 2020 2020 2020 2020 224f  f). ".        "O
+0004e950: 6e65 2063 616e 2067 6574 2022 0a20 2020  ne can get ".   
+0004e960: 2020 2020 2022 7468 6973 2069 6e66 6f72       "this infor
+0004e970: 6d61 7469 6f6e 2061 6c73 6f20 6279 206c  mation also by l
+0004e980: 6f6f 6b69 6e67 2061 7420 7468 6520 6372  ooking at the cr
+0004e990: 6564 656e 7469 616c 7320 6669 6c65 2e22  edentials file."
+0004e9a0: 2c0a 2020 2020 290a 2020 2020 6170 2e61  ,.    ).    ap.a
+0004e9b0: 6464 5f61 7267 756d 656e 7428 0a20 2020  dd_argument(.   
+0004e9c0: 2020 2020 2023 206e 6f20 7369 6e67 6c65       # no single
+0004e9d0: 2063 6861 7220 666c 6167 0a20 2020 2020   char flag.     
+0004e9e0: 2020 2022 2d2d 6e6f 2d73 736c 222c 0a20     "--no-ssl",. 
+0004e9f0: 2020 2020 2020 2072 6571 7569 7265 643d         required=
+0004ea00: 4661 6c73 652c 0a20 2020 2020 2020 2061  False,.        a
+0004ea10: 6374 696f 6e3d 2273 746f 7265 5f74 7275  ction="store_tru
+0004ea20: 6522 2c0a 2020 2020 2020 2020 6465 6661  e",.        defa
+0004ea30: 756c 743d 4e4f 5f53 534c 5f55 4e55 5345  ult=NO_SSL_UNUSE
+0004ea40: 445f 4445 4641 554c 542c 2020 2320 7768  D_DEFAULT,  # wh
+0004ea50: 656e 206f 7074 696f 6e20 6973 6e27 7420  en option isn't 
+0004ea60: 7573 6564 0a20 2020 2020 2020 2068 656c  used.        hel
+0004ea70: 703d 2253 6b69 7020 5353 4c20 7665 7269  p="Skip SSL veri
+0004ea80: 6669 6361 7469 6f6e 2e20 220a 2020 2020  fication. ".    
+0004ea90: 2020 2020 2244 6574 6169 6c73 3a3a 2042      "Details:: B
+0004eaa0: 7920 6465 6661 756c 7420 2869 6620 7468  y default (if th
+0004eab0: 6973 206f 7074 696f 6e20 6973 206e 6f74  is option is not
+0004eac0: 2075 7365 6429 2022 0a20 2020 2020 2020   used) ".       
+0004ead0: 2022 7468 6520 5353 4c20 6365 7274 6966   "the SSL certif
+0004eae0: 6963 6174 6520 6973 2076 616c 6964 6174  icate is validat
+0004eaf0: 6564 2066 6f72 2074 6865 2063 6f6e 6e65  ed for the conne
+0004eb00: 6374 696f 6e2e 2042 7574 2c20 6966 2074  ction. But, if t
+0004eb10: 6869 7320 220a 2020 2020 2020 2020 226f  his ".        "o
+0004eb20: 7074 696f 6e20 6973 2075 7365 642c 2074  ption is used, t
+0004eb30: 6865 6e20 7468 6520 5353 4c20 6365 7274  hen the SSL cert
+0004eb40: 6966 6963 6174 6520 7661 6c69 6461 7469  ificate validati
+0004eb50: 6f6e 2077 696c 6c20 6265 2073 6b69 7070  on will be skipp
+0004eb60: 6564 2e20 220a 2020 2020 2020 2020 2254  ed. ".        "T
+0004eb70: 6869 7320 6973 2075 7365 6675 6c20 666f  his is useful fo
+0004eb80: 7220 686f 6d65 2d73 6572 7665 7273 2074  r home-servers t
+0004eb90: 6861 7420 6861 7665 206e 6f20 5353 4c20  hat have no SSL 
+0004eba0: 6365 7274 6966 6963 6174 652e 2022 0a20  certificate. ". 
+0004ebb0: 2020 2020 2020 2027 4966 2075 7365 6420         'If used 
+0004ebc0: 746f 6765 7468 6572 2077 6974 6820 7468  together with th
+0004ebd0: 6520 222d 2d73 736c 2d63 6572 7469 6669  e "--ssl-certifi
+0004ebe0: 6361 7465 2220 270a 2020 2020 2020 2020  cate" '.        
+0004ebf0: 2270 6172 616d 6574 6572 2c20 7468 6973  "parameter, this
+0004ec00: 206f 7074 696f 6e20 6973 206d 6561 6e69   option is meani
+0004ec10: 6e67 6c65 7373 2061 6e64 2061 6e20 6572  ngless and an er
+0004ec20: 726f 7220 7769 6c6c 2062 6520 7261 6973  ror will be rais
+0004ec30: 6564 2e22 2c0a 2020 2020 290a 2020 2020  ed.",.    ).    
+0004ec40: 6170 2e61 6464 5f61 7267 756d 656e 7428  ap.add_argument(
+0004ec50: 0a20 2020 2020 2020 2023 206e 6f20 7369  .        # no si
+0004ec60: 6e67 6c65 2063 6861 7220 666c 6167 0a20  ngle char flag. 
+0004ec70: 2020 2020 2020 2022 2d2d 7373 6c2d 6365         "--ssl-ce
+0004ec80: 7274 6966 6963 6174 6522 2c0a 2020 2020  rtificate",.    
+0004ec90: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
+0004eca0: 7365 2c0a 2020 2020 2020 2020 7479 7065  se,.        type
+0004ecb0: 3d73 7472 2c0a 2020 2020 2020 2020 6465  =str,.        de
+0004ecc0: 6661 756c 743d 5353 4c5f 4345 5254 4946  fault=SSL_CERTIF
+0004ecd0: 4943 4154 455f 4445 4641 554c 542c 2020  ICATE_DEFAULT,  
+0004ece0: 2320 7768 656e 206f 7074 696f 6e20 6973  # when option is
+0004ecf0: 6e27 7420 7573 6564 0a20 2020 2020 2020  n't used.       
+0004ed00: 206d 6574 6176 6172 3d22 5353 4c5f 4345   metavar="SSL_CE
+0004ed10: 5254 4946 4943 4154 455f 4649 4c45 222c  RTIFICATE_FILE",
+0004ed20: 0a20 2020 2020 2020 2068 656c 703d 2255  .        help="U
+0004ed30: 7365 2079 6f75 7220 6f77 6e20 5353 4c20  se your own SSL 
+0004ed40: 6365 7274 6966 6963 6174 652e 2022 0a20  certificate. ". 
+0004ed50: 2020 2020 2020 2022 4465 7461 696c 733a         "Details:
+0004ed60: 3a20 5573 6520 7468 6973 206f 7074 696f  : Use this optio
+0004ed70: 6e20 746f 2075 7365 2022 0a20 2020 2020  n to use ".     
+0004ed80: 2020 2022 796f 7572 206f 776e 206c 6f63     "your own loc
+0004ed90: 616c 2053 534c 2063 6572 7469 6669 6361  al SSL certifica
+0004eda0: 7465 2066 696c 652e 2022 0a20 2020 2020  te file. ".     
+0004edb0: 2020 2022 5468 6973 2069 7320 616e 206f     "This is an o
+0004edc0: 7074 696f 6e61 6c20 7061 7261 6d65 7465  ptional paramete
+0004edd0: 722e 2054 6869 7320 6973 2075 7365 6675  r. This is usefu
+0004ede0: 6c20 666f 7220 686f 6d65 2073 6572 7665  l for home serve
+0004edf0: 7273 2074 6861 7420 220a 2020 2020 2020  rs that ".      
+0004ee00: 2020 2268 6176 6520 7468 6569 7220 6f77    "have their ow
+0004ee10: 6e20 220a 2020 2020 2020 2020 2253 534c  n ".        "SSL
+0004ee20: 2063 6572 7469 6669 6361 7465 2e20 5468   certificate. Th
+0004ee30: 6973 2061 6c6c 6f77 7320 796f 7520 746f  is allows you to
+0004ee40: 2075 7365 2048 5454 5053 2f54 4c53 2066   use HTTPS/TLS f
+0004ee50: 6f72 2074 6865 2063 6f6e 6e65 6374 696f  or the connectio
+0004ee60: 6e20 220a 2020 2020 2020 2020 2277 6869  n ".        "whi
+0004ee70: 6c65 2075 7369 6e67 2079 6f75 7220 6f77  le using your ow
+0004ee80: 6e20 6c6f 6361 6c20 5353 4c20 6365 7274  n local SSL cert
+0004ee90: 6966 6963 6174 652e 2053 7065 6369 6679  ificate. Specify
+0004eea0: 2074 6865 2070 6174 6820 616e 6420 220a   the path and ".
+0004eeb0: 2020 2020 2020 2020 2766 696c 6520 746f          'file to
+0004eec0: 2079 6f75 7220 5353 4c20 6365 7274 6966   your SSL certif
+0004eed0: 6963 6174 652e 2049 6620 7573 6564 2074  icate. If used t
+0004eee0: 6f67 6574 6865 7220 7769 7468 2074 6865  ogether with the
+0004eef0: 2022 2d2d 6e6f 2d73 736c 2220 270a 2020   "--no-ssl" '.  
+0004ef00: 2020 2020 2020 2270 6172 616d 6574 6572        "parameter
+0004ef10: 2c20 7468 6973 206f 7074 696f 6e20 6973  , this option is
+0004ef20: 206d 6561 6e69 6e67 6c65 7373 2061 6e64   meaningless and
+0004ef30: 2061 6e20 6572 726f 7220 7769 6c6c 2062   an error will b
+0004ef40: 6520 7261 6973 6564 2e22 2c0a 2020 2020  e raised.",.    
+0004ef50: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
+0004ef60: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
+0004ef70: 2d2d 6669 6c65 2d6e 616d 6522 2c0a 2020  --file-name",.  
+0004ef80: 2020 2020 2020 7265 7175 6972 6564 3d46        required=F
+0004ef90: 616c 7365 2c0a 2020 2020 2020 2020 6163  alse,.        ac
+0004efa0: 7469 6f6e 3d22 6578 7465 6e64 222c 0a20  tion="extend",. 
+0004efb0: 2020 2020 2020 206e 6172 6773 3d22 2b22         nargs="+"
+0004efc0: 2c0a 2020 2020 2020 2020 7479 7065 3d73  ,.        type=s
+0004efd0: 7472 2c0a 2020 2020 2020 2020 6d65 7461  tr,.        meta
+0004efe0: 7661 723d 2246 494c 4522 2c0a 2020 2020  var="FILE",.    
+0004eff0: 2020 2020 6865 6c70 3d22 5370 6563 6966      help="Specif
+0004f000: 7920 6f6e 6520 6f72 206d 756c 7469 706c  y one or multipl
+0004f010: 6520 6669 6c65 206e 616d 6573 2066 6f72  e file names for
+0004f020: 2073 6f6d 6520 6163 7469 6f6e 732e 2022   some actions. "
+0004f030: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
+0004f040: 733a 3a20 5468 6973 2069 7320 616e 206f  s:: This is an o
+0004f050: 7074 696f 6e61 6c20 6172 6775 6d65 6e74  ptional argument
+0004f060: 2e20 5573 6520 7468 6973 206f 7074 696f  . Use this optio
+0004f070: 6e20 220a 2020 2020 2020 2020 2269 6e20  n ".        "in 
+0004f080: 636f 6d62 696e 6174 696f 6e20 7769 7468  combination with
+0004f090: 206f 7074 696f 6e73 206c 696b 6520 2d2d   options like --
+0004f0a0: 646f 776e 6c6f 6164 2074 6f20 7370 6563  download to spec
+0004f0b0: 6966 7920 6f6e 6520 6f72 2022 0a20 2020  ify one or ".   
+0004f0c0: 2020 2020 2022 6d75 6c74 6970 6c65 2066       "multiple f
+0004f0d0: 696c 6520 6e61 6d65 732e 2022 0a20 2020  ile names. ".   
+0004f0e0: 2020 2020 2022 4967 6e6f 7265 6420 6966       "Ignored if
+0004f0f0: 2075 7365 6420 6279 2069 7473 656c 6620   used by itself 
+0004f100: 7769 7468 6f75 7420 616e 2061 7070 726f  without an appro
+0004f110: 7072 6961 7465 2063 6f72 7265 7370 6f6e  priate correspon
+0004f120: 6469 6e67 2022 0a20 2020 2020 2020 2022  ding ".        "
+0004f130: 6163 7469 6f6e 2e22 2c0a 2020 2020 290a  action.",.    ).
+0004f140: 2020 2020 6170 2e61 6464 5f61 7267 756d      ap.add_argum
+0004f150: 656e 7428 0a20 2020 2020 2020 2022 2d2d  ent(.        "--
+0004f160: 6b65 792d 6469 6374 222c 0a20 2020 2020  key-dict",.     
+0004f170: 2020 2072 6571 7569 7265 643d 4661 6c73     required=Fals
+0004f180: 652c 0a20 2020 2020 2020 2061 6374 696f  e,.        actio
+0004f190: 6e3d 2265 7874 656e 6422 2c0a 2020 2020  n="extend",.    
+0004f1a0: 2020 2020 6e61 7267 733d 222b 222c 0a20      nargs="+",. 
+0004f1b0: 2020 2020 2020 2074 7970 653d 7374 722c         type=str,
+0004f1c0: 0a20 2020 2020 2020 206d 6574 6176 6172  .        metavar
+0004f1d0: 3d22 4b45 595f 4449 4354 494f 4e41 5259  ="KEY_DICTIONARY
+0004f1e0: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
+0004f1f0: 2253 7065 6369 6679 206f 6e65 206f 7220  "Specify one or 
+0004f200: 6d75 6c74 6970 6c65 206b 6579 2064 6963  multiple key dic
+0004f210: 7469 6f6e 6172 6965 7320 666f 7220 6465  tionaries for de
+0004f220: 6372 7970 7469 6f6e 2e20 220a 2020 2020  cryption. ".    
+0004f230: 2020 2020 2244 6574 6169 6c73 3a3a 204f      "Details:: O
+0004f240: 6e65 206f 7220 6d75 6c74 6970 6c65 2064  ne or multiple d
+0004f250: 6563 7279 7074 696f 6e20 220a 2020 2020  ecryption ".    
+0004f260: 2020 2020 2264 6963 7469 6f6e 6172 6965      "dictionarie
+0004f270: 7320 6172 6520 7072 6f76 6964 6564 2062  s are provided b
+0004f280: 7920 7468 6520 2d2d 7570 6c6f 6164 2061  y the --upload a
+0004f290: 6374 696f 6e20 6173 2061 2072 6573 756c  ction as a resul
+0004f2a0: 742e 2022 0a20 2020 2020 2020 2022 4120  t. ".        "A 
+0004f2b0: 6465 6372 7970 7469 6f6e 2064 6963 7469  decryption dicti
+0004f2c0: 6f6e 6172 7920 6973 2061 2073 7472 696e  onary is a strin
+0004f2d0: 6720 6c69 6b65 2074 6869 733a 2022 0a20  g like this: ". 
+0004f2e0: 2020 2020 2020 2022 5c22 7b27 7627 3a20         "\"{'v': 
+0004f2f0: 2776 3227 2c20 276b 6579 273a 207b 276b  'v2', 'key': {'k
+0004f300: 7479 273a 2027 6f63 7427 2c20 2761 6c67  ty': 'oct', 'alg
+0004f310: 273a 2027 4132 3536 4354 5227 2c20 2765  ': 'A256CTR', 'e
+0004f320: 7874 273a 2054 7275 652c 2022 0a20 2020  xt': True, ".   
+0004f330: 2020 2020 2022 276b 273a 2027 736f 6d65       "'k': 'some
+0004f340: 6b65 7927 2c20 276b 6579 5f6f 7073 273a  key', 'key_ops':
+0004f350: 205b 2765 6e63 7279 7074 272c 2027 6465   ['encrypt', 'de
+0004f360: 6372 7970 7427 5d7d 2c20 220a 2020 2020  crypt']}, ".    
+0004f370: 2020 2020 2227 6976 273a 2027 736f 6d65      "'iv': 'some
+0004f380: 6976 272c 2027 6861 7368 6573 273a 207b  iv', 'hashes': {
+0004f390: 2773 6861 3235 3627 3a20 2773 6f6d 6553  'sha256': 'someS
+0004f3a0: 4841 277d 7d5c 222e 2049 6620 796f 7520  HA'}}\". If you 
+0004f3b0: 6861 7665 2061 2022 0a20 2020 2020 2020  have a ".       
+0004f3c0: 2022 6c69 7374 206f 6620 6b65 7920 6469   "list of key di
+0004f3d0: 6374 696f 6e61 7269 6573 2061 6e64 2077  ctionaries and w
+0004f3e0: 616e 7420 746f 2073 6b69 7020 6f6e 652c  ant to skip one,
+0004f3f0: 2075 7365 2074 6865 2065 6d70 7479 2073   use the empty s
+0004f400: 7472 696e 672e 222c 0a20 2020 2029 0a20  tring.",.    ). 
+0004f410: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
+0004f420: 6e74 280a 2020 2020 2020 2020 222d 2d70  nt(.        "--p
+0004f430: 6c61 696e 222c 0a20 2020 2020 2020 2072  lain",.        r
+0004f440: 6571 7569 7265 643d 4661 6c73 652c 0a20  equired=False,. 
+0004f450: 2020 2020 2020 2061 6374 696f 6e3d 2273         action="s
+0004f460: 746f 7265 5f74 7275 6522 2c0a 2020 2020  tore_true",.    
+0004f470: 2020 2020 6865 6c70 3d22 4469 7361 626c      help="Disabl
+0004f480: 6520 656e 6372 7970 7469 6f6e 2066 6f72  e encryption for
+0004f490: 2061 2073 7065 6369 6669 6320 6163 7469   a specific acti
+0004f4a0: 6f6e 2e20 220a 2020 2020 2020 2020 2244  on. ".        "D
+0004f4b0: 6574 6169 6c73 3a3a 2042 7920 6465 6661  etails:: By defa
+0004f4c0: 756c 742c 2022 0a20 2020 2020 2020 2022  ult, ".        "
+0004f4d0: 6576 6572 7974 6869 6e67 2069 7320 616c  everything is al
+0004f4e0: 7761 7973 2065 6e63 7279 7074 6564 2e20  ways encrypted. 
+0004f4f0: 220a 2020 2020 2020 2020 2241 6374 696f  ".        "Actio
+0004f500: 6e73 2074 6861 7420 7375 7070 6f72 7420  ns that support 
+0004f510: 7468 6973 206f 7074 696f 6e20 6172 653a  this option are:
+0004f520: 202d 2d75 706c 6f61 642c 202d 2d72 6f6f   --upload, --roo
+0004f530: 6d2d 6372 6561 7465 2c20 220a 2020 2020  m-create, ".    
+0004f540: 2020 2020 2261 6e64 202d 2d72 6f6f 6d2d      "and --room-
+0004f550: 646d 2d63 7265 6174 652e 2022 0a20 2020  dm-create. ".   
+0004f560: 2020 2020 2022 526f 6f6d 7320 6172 6520       "Rooms are 
+0004f570: 6279 2064 6566 6175 6c74 2063 7265 6174  by default creat
+0004f580: 6564 2065 6e63 7279 7074 6564 3b20 220a  ed encrypted; ".
+0004f590: 2020 2020 2020 2020 2274 6f20 6f76 6572          "to over
+0004f5a0: 7772 6974 6520 7468 6174 2061 6e64 2074  write that and t
+0004f5b0: 6f20 6372 6561 7465 2061 2072 6f6f 6d20  o create a room 
+0004f5c0: 7769 7468 2065 6e63 7279 7074 696f 6e20  with encryption 
+0004f5d0: 6469 7361 626c 6564 2022 0a20 2020 2020  disabled ".     
+0004f5e0: 2020 2022 7573 6520 272d 2d70 6c61 696e     "use '--plain
+0004f5f0: 272e 2053 6565 2074 6865 2069 6e64 6976  '. See the indiv
+0004f600: 6964 7561 6c20 636f 6d6d 616e 6473 2e22  idual commands."
+0004f610: 2c0a 2020 2020 290a 2020 2020 6170 2e61  ,.    ).    ap.a
+0004f620: 6464 5f61 7267 756d 656e 7428 0a20 2020  dd_argument(.   
+0004f630: 2020 2020 2022 2d2d 7365 7061 7261 746f       "--separato
+0004f640: 7222 2c0a 2020 2020 2020 2020 7265 7175  r",.        requ
+0004f650: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
+0004f660: 2020 2020 7479 7065 3d73 7472 2c0a 2020      type=str,.  
+0004f670: 2020 2020 2020 6465 6661 756c 743d 4445        default=DE
+0004f680: 4641 554c 545f 5345 5041 5241 544f 522c  FAULT_SEPARATOR,
+0004f690: 2020 2320 6465 6661 756c 7473 2074 6f20    # defaults to 
+0004f6a0: 5345 5020 6966 206e 6f74 2075 7365 640a  SEP if not used.
+0004f6b0: 2020 2020 2020 2020 2320 5465 7874 2069          # Text i
+0004f6c0: 7320 7363 616e 6e65 6420 616e 6420 7265  s scanned and re
+0004f6d0: 7065 6174 6564 2073 7061 6365 7320 6172  peated spaces ar
+0004f6e0: 6520 7265 6d6f 7665 732c 2073 6f20 2220  e removes, so " 
+0004f6f0: 2020 2022 0a20 2020 2020 2020 2023 206f     ".        # o
+0004f700: 7220 7b44 4546 4155 4c54 5f53 4550 4152  r {DEFAULT_SEPAR
+0004f710: 4154 4f52 7d20 7769 6c6c 2062 6520 7472  ATOR} will be tr
+0004f720: 756e 6361 7465 6420 746f 2022 2022 2e20  uncated to " ". 
+0004f730: 4865 6e63 6520 2234 2073 7061 6365 7322  Hence "4 spaces"
+0004f740: 0a20 2020 2020 2020 206d 6574 6176 6172  .        metavar
+0004f750: 3d22 5345 5041 5241 544f 5222 2c0a 2020  ="SEPARATOR",.  
+0004f760: 2020 2020 2020 6865 6c70 3d22 5365 7420        help="Set 
+0004f770: 6120 6375 7374 6f6d 2073 6570 6172 6174  a custom separat
+0004f780: 6f72 2075 7365 6420 666f 7220 6365 7274  or used for cert
+0004f790: 6169 6e20 7072 696e 7420 6f75 7473 2e20  ain print outs. 
+0004f7a0: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
+0004f7b0: 6c73 3a3a 2042 7920 6465 6661 756c 742c  ls:: By default,
+0004f7c0: 2069 2e65 2e20 6966 202d 2d73 6570 6172   i.e. if --separ
+0004f7d0: 6174 6f72 2069 7320 6e6f 7420 7573 6564  ator is not used
+0004f7e0: 2c20 220a 2020 2020 2020 2020 2234 2073  , ".        "4 s
+0004f7f0: 7061 6365 7320 6172 6520 7573 6564 2061  paces are used a
+0004f800: 7320 220a 2020 2020 2020 2020 2273 6570  s ".        "sep
+0004f810: 6172 6174 6f72 2062 6574 7765 656e 2063  arator between c
+0004f820: 6f6c 756d 6e73 2069 6e20 7072 696e 7420  olumns in print 
+0004f830: 7374 6174 656d 656e 7473 2e20 596f 7520  statements. You 
+0004f840: 636f 756c 6420 7365 7420 220a 2020 2020  could set ".    
+0004f850: 2020 2020 2269 7420 746f 2027 5c5c 7427      "it to '\\t'
+0004f860: 2069 6620 796f 7520 7072 6566 6572 2061   if you prefer a
+0004f870: 2074 6162 2c20 6275 7420 7461 6273 2061   tab, but tabs a
+0004f880: 7265 2075 7375 616c 6c79 2072 6570 6c61  re usually repla
+0004f890: 6365 6420 220a 2020 2020 2020 2020 2277  ced ".        "w
+0004f8a0: 6974 6820 7370 6163 6573 2062 7920 7468  ith spaces by th
+0004f8b0: 6520 7465 726d 696e 616c 2e20 536f 2c20  e terminal. So, 
+0004f8c0: 7468 6174 206d 6967 6874 206e 6f74 2067  that might not g
+0004f8d0: 6976 6520 796f 7520 7768 6174 2079 6f75  ive you what you
+0004f8e0: 2022 0a20 2020 2020 2020 2022 7761 6e74   ".        "want
+0004f8f0: 2e20 4d61 7962 6520 2720 7c7c 2027 2069  . Maybe ' || ' i
+0004f900: 7320 616e 2061 6c74 6572 6e61 7469 7665  s an alternative
+0004f910: 2063 686f 6963 652e 222c 0a20 2020 2029   choice.",.    )
+0004f920: 0a20 2020 2061 702e 6164 645f 6172 6775  .    ap.add_argu
+0004f930: 6d65 6e74 280a 2020 2020 2020 2020 222d  ment(.        "-
+0004f940: 2d61 6363 6573 732d 746f 6b65 6e22 2c0a  -access-token",.
+0004f950: 2020 2020 2020 2020 7265 7175 6972 6564          required
+0004f960: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+0004f970: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
+0004f980: 2020 6d65 7461 7661 723d 2241 4343 4553    metavar="ACCES
+0004f990: 535f 544f 4b45 4e22 2c0a 2020 2020 2020  S_TOKEN",.      
+0004f9a0: 2020 6865 6c70 3d22 5365 7420 6120 6375    help="Set a cu
+0004f9b0: 7374 6f6d 2061 6363 6573 7320 746f 6b65  stom access toke
+0004f9c0: 6e20 666f 7220 7573 6520 6279 2063 6572  n for use by cer
+0004f9d0: 7461 696e 2061 6374 696f 6e73 2e20 220a  tain actions. ".
+0004f9e0: 2020 2020 2020 2020 2244 6574 6169 6c73          "Details
+0004f9f0: 3a3a 2049 7420 6973 2061 6e20 6f70 7469  :: It is an opti
+0004fa00: 6f6e 616c 2061 7267 756d 656e 742e 2022  onal argument. "
+0004fa10: 0a20 2020 2020 2020 2022 4279 2064 6566  .        "By def
+0004fa20: 6175 6c74 202d 2d61 6363 6573 732d 746f  ault --access-to
+0004fa30: 6b65 6e20 6973 2069 676e 6f72 6564 2061  ken is ignored a
+0004fa40: 6e64 206e 6f74 2075 7365 642e 2022 0a20  nd not used. ". 
+0004fa50: 2020 2020 2020 2022 4974 2069 7320 7573         "It is us
+0004fa60: 6564 2062 7920 7468 6520 2d2d 6465 6c65  ed by the --dele
+0004fa70: 7465 2d6d 7863 2c20 2d2d 6465 6c65 7465  te-mxc, --delete
+0004fa80: 2d6d 7863 2d62 6566 6f72 652c 2022 0a20  -mxc-before, ". 
+0004fa90: 2020 2020 2020 2022 616e 6420 2d2d 7265         "and --re
+0004faa0: 7374 2061 6374 696f 6e73 2e22 2c0a 2020  st actions.",.  
+0004fab0: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
+0004fac0: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
+0004fad0: 2022 2d2d 7061 7373 776f 7264 222c 0a20   "--password",. 
+0004fae0: 2020 2020 2020 2072 6571 7569 7265 643d         required=
+0004faf0: 4661 6c73 652c 0a20 2020 2020 2020 2074  False,.        t
+0004fb00: 7970 653d 7374 722c 0a20 2020 2020 2020  ype=str,.       
+0004fb10: 206d 6574 6176 6172 3d22 5041 5353 574f   metavar="PASSWO
+0004fb20: 5244 222c 0a20 2020 2020 2020 2068 656c  RD",.        hel
+0004fb30: 703d 2253 7065 6369 6679 2061 2070 6173  p="Specify a pas
+0004fb40: 7377 6f72 6420 666f 7220 7573 6520 6279  sword for use by
+0004fb50: 2063 6572 7461 696e 2061 6374 696f 6e73   certain actions
+0004fb60: 2e20 220a 2020 2020 2020 2020 2244 6574  . ".        "Det
+0004fb70: 6169 6c73 3a3a 2049 7420 6973 2061 6e20  ails:: It is an 
+0004fb80: 6f70 7469 6f6e 616c 2061 7267 756d 656e  optional argumen
+0004fb90: 742e 2022 0a20 2020 2020 2020 2022 4279  t. ".        "By
+0004fba0: 2064 6566 6175 6c74 202d 2d70 6173 7377   default --passw
+0004fbb0: 6f72 6420 6973 2069 676e 6f72 6564 2061  ord is ignored a
+0004fbc0: 6e64 206e 6f74 2075 7365 642e 2022 0a20  nd not used. ". 
+0004fbd0: 2020 2020 2020 2022 4974 2069 7320 7573         "It is us
+0004fbe0: 6564 2062 7920 272d 2d6c 6f67 696e 2070  ed by '--login p
+0004fbf0: 6173 7377 6f72 6427 2061 6e64 2027 2d2d  assword' and '--
+0004fc00: 6465 6c65 7465 2d64 6576 6963 6527 2022  delete-device' "
+0004fc10: 0a20 2020 2020 2020 2022 6163 7469 6f6e  .        "action
+0004fc20: 732e 2022 0a20 2020 2020 2020 2022 4966  s. ".        "If
+0004fc30: 206e 6f74 2070 726f 7669 6465 6420 666f   not provided fo
+0004fc40: 7220 2d2d 6c6f 6769 6e20 7468 6520 7573  r --login the us
+0004fc50: 6572 2077 696c 6c20 6265 2071 7565 7269  er will be queri
+0004fc60: 6564 2076 6961 206b 6579 626f 6172 642e  ed via keyboard.
+0004fc70: 222c 0a20 2020 2029 0a20 2020 2061 702e  ",.    ).    ap.
+0004fc80: 6164 645f 6172 6775 6d65 6e74 280a 2020  add_argument(.  
+0004fc90: 2020 2020 2020 222d 2d68 6f6d 6573 6572        "--homeser
+0004fca0: 7665 7222 2c0a 2020 2020 2020 2020 7265  ver",.        re
+0004fcb0: 7175 6972 6564 3d46 616c 7365 2c0a 2020  quired=False,.  
+0004fcc0: 2020 2020 2020 7479 7065 3d73 7472 2c0a        type=str,.
+0004fcd0: 2020 2020 2020 2020 6d65 7461 7661 723d          metavar=
+0004fce0: 2248 4f4d 4553 4552 5645 525f 5552 4c22  "HOMESERVER_URL"
+0004fcf0: 2c0a 2020 2020 2020 2020 6865 6c70 3d22  ,.        help="
+0004fd00: 5370 6563 6966 7920 6120 686f 6d65 7365  Specify a homese
+0004fd10: 7276 6572 2066 6f72 2075 7365 2062 7920  rver for use by 
+0004fd20: 6365 7274 6169 6e20 6163 7469 6f6e 732e  certain actions.
+0004fd30: 2022 0a20 2020 2020 2020 2022 4465 7461   ".        "Deta
+0004fd40: 696c 733a 3a20 4974 2069 7320 616e 206f  ils:: It is an o
+0004fd50: 7074 696f 6e61 6c20 6172 6775 6d65 6e74  ptional argument
+0004fd60: 2e20 220a 2020 2020 2020 2020 2242 7920  . ".        "By 
+0004fd70: 6465 6661 756c 7420 2d2d 686f 6d65 7365  default --homese
+0004fd80: 7276 6572 2069 7320 6967 6e6f 7265 6420  rver is ignored 
+0004fd90: 616e 6420 6e6f 7420 7573 6564 2e20 220a  and not used. ".
+0004fda0: 2020 2020 2020 2020 2249 7420 6973 2075          "It is u
+0004fdb0: 7365 6420 6279 2027 2d2d 6c6f 6769 6e27  sed by '--login'
+0004fdc0: 2061 6374 696f 6e2e 2022 0a20 2020 2020   action. ".     
+0004fdd0: 2020 2022 4966 206e 6f74 2070 726f 7669     "If not provi
+0004fde0: 6465 6420 666f 7220 2d2d 6c6f 6769 6e20  ded for --login 
+0004fdf0: 7468 6520 7573 6572 2077 696c 6c20 6265  the user will be
+0004fe00: 2071 7565 7269 6564 2076 6961 206b 6579   queried via key
+0004fe10: 626f 6172 642e 222c 0a20 2020 2029 0a20  board.",.    ). 
+0004fe20: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
+0004fe30: 6e74 280a 2020 2020 2020 2020 222d 2d64  nt(.        "--d
+0004fe40: 6576 6963 6522 2c20 2023 2064 6f20 6e6f  evice",  # do no
+0004fe50: 7420 636f 6e66 7573 6520 7769 7468 202d  t confuse with -
+0004fe60: 2d64 6576 6963 6573 0a20 2020 2020 2020  -devices.       
+0004fe70: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
+0004fe80: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
+0004fe90: 722c 2020 2320 6465 7669 6365 2069 642c  r,  # device id,
+0004fea0: 2064 6576 6963 6520 6e61 6d65 0a20 2020   device name.   
+0004feb0: 2020 2020 206d 6574 6176 6172 3d22 4445       metavar="DE
+0004fec0: 5649 4345 5f4e 414d 4522 2c0a 2020 2020  VICE_NAME",.    
+0004fed0: 2020 2020 6865 6c70 3d22 5370 6563 6966      help="Specif
+0004fee0: 7920 6120 6465 7669 6365 206e 616d 652c  y a device name,
+0004fef0: 2066 6f72 2075 7365 2062 7920 6365 7274   for use by cert
+0004ff00: 6169 6e20 6163 7469 6f6e 732e 2022 0a20  ain actions. ". 
+0004ff10: 2020 2020 2020 2022 4465 7461 696c 733a         "Details:
+0004ff20: 3a20 4974 2069 7320 616e 206f 7074 696f  : It is an optio
+0004ff30: 6e61 6c20 6172 6775 6d65 6e74 2e20 220a  nal argument. ".
+0004ff40: 2020 2020 2020 2020 2242 7920 6465 6661          "By defa
+0004ff50: 756c 7420 2d2d 6465 7669 6365 2069 7320  ult --device is 
+0004ff60: 6967 6e6f 7265 6420 616e 6420 6e6f 7420  ignored and not 
+0004ff70: 7573 6564 2e20 220a 2020 2020 2020 2020  used. ".        
+0004ff80: 2249 7420 6973 2075 7365 6420 6279 2027  "It is used by '
+0004ff90: 2d2d 6c6f 6769 6e27 2061 6374 696f 6e2e  --login' action.
+0004ffa0: 2022 0a20 2020 2020 2020 2022 4966 206e   ".        "If n
+0004ffb0: 6f74 2070 726f 7669 6465 6420 666f 7220  ot provided for 
+0004ffc0: 2d2d 6c6f 6769 6e20 7468 6520 7573 6572  --login the user
+0004ffd0: 2077 696c 6c20 6265 2071 7565 7269 6564   will be queried
+0004ffe0: 2076 6961 206b 6579 626f 6172 642e 2022   via keyboard. "
+0004fff0: 0a20 2020 2020 2020 2022 4966 2079 6f75  .        "If you
+00050000: 2077 616e 7420 7468 6520 6465 6661 756c   want the defaul
+00050010: 7420 7661 6c75 6520 7370 6563 6966 7920  t value specify 
+00050020: 2727 2e20 220a 2020 2020 2020 2020 224d  ''. ".        "M
+00050030: 756c 7469 706c 6520 6465 7669 6365 7320  ultiple devices 
+00050040: 2877 6974 6820 6469 6666 6572 656e 7420  (with different 
+00050050: 6465 7669 6365 2069 6429 206d 6179 2068  device id) may h
+00050060: 6176 6520 7468 6520 7361 6d65 2064 6576  ave the same dev
+00050070: 6963 6520 220a 2020 2020 2020 2020 226e  ice ".        "n
+00050080: 616d 652e 2049 6e20 7368 6f72 742c 2074  ame. In short, t
+00050090: 6865 2073 616d 6520 6465 7669 6365 206e  he same device n
+000500a0: 616d 6520 6361 6e20 6265 2061 7373 6967  ame can be assig
+000500b0: 6e65 6420 746f 206d 756c 7469 706c 6520  ned to multiple 
+000500c0: 220a 2020 2020 2020 2020 2264 6966 6665  ".        "diffe
+000500d0: 7265 6e74 2064 6576 6963 6573 2069 6620  rent devices if 
+000500e0: 6465 7369 7265 642e 222c 0a20 2020 2029  desired.",.    )
+000500f0: 0a20 2020 2061 702e 6164 645f 6172 6775  .    ap.add_argu
+00050100: 6d65 6e74 280a 2020 2020 2020 2020 222d  ment(.        "-
+00050110: 2d73 796e 6322 2c0a 2020 2020 2020 2020  -sync",.        
+00050120: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
+00050130: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
+00050140: 2c20 2023 2073 796e 6320 6d65 7468 6f64  ,  # sync method
+00050150: 3a20 6f66 662c 2066 756c 6c2c 2028 7061  : off, full, (pa
+00050160: 7274 6961 6c29 0a20 2020 2020 2020 206d  rtial).        m
+00050170: 6574 6176 6172 3d22 4655 4c4c 7c4f 4646  etavar="FULL|OFF
+00050180: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
+00050190: 2243 686f 6f73 6520 7379 6e63 6872 6f6e  "Choose synchron
+000501a0: 697a 6174 696f 6e20 6f70 7469 6f6e 732e  ization options.
+000501b0: 2022 0a20 2020 2020 2020 2022 4465 7461   ".        "Deta
+000501c0: 696c 733a 3a20 5468 6973 206f 7074 696f  ils:: This optio
+000501d0: 6e20 6465 6369 6465 7320 6f6e 2077 6865  n decides on whe
+000501e0: 7468 6572 2074 6865 2070 726f 6772 616d  ther the program
+000501f0: 2022 0a20 2020 2020 2020 2022 7379 6e63   ".        "sync
+00050200: 6872 6f6e 697a 6573 2074 6865 2073 7461  hronizes the sta
+00050210: 7465 2077 6974 6820 7468 6520 7365 7276  te with the serv
+00050220: 6572 2062 6566 6f72 6520 6120 2773 656e  er before a 'sen
+00050230: 6427 2061 6374 696f 6e2e 2022 0a20 2020  d' action. ".   
+00050240: 2020 2020 2066 2243 7572 7265 6e74 6c79       f"Currently
+00050250: 2074 776f 2063 686f 6963 6573 2061 7265   two choices are
+00050260: 206f 6666 6572 6564 3a20 277b 5359 4e43   offered: '{SYNC
+00050270: 5f46 554c 4c7d 2720 616e 6420 277b 5359  _FULL}' and '{SY
+00050280: 4e43 5f4f 4646 7d27 2e20 220a 2020 2020  NC_OFF}'. ".    
+00050290: 2020 2020 2250 726f 7669 6465 206f 6e65      "Provide one
+000502a0: 206f 6620 7468 6573 6520 6368 6f69 6365   of these choice
+000502b0: 732e 2022 0a20 2020 2020 2020 2066 2254  s. ".        f"T
+000502c0: 6865 2064 6566 6175 6c74 2069 7320 277b  he default is '{
+000502d0: 5359 4e43 5f44 4546 4155 4c54 7d27 2e20  SYNC_DEFAULT}'. 
+000502e0: 4966 2079 6f75 2077 616e 7420 746f 2075  If you want to u
+000502f0: 7365 2074 6865 2064 6566 6175 6c74 2c20  se the default, 
+00050300: 220a 2020 2020 2020 2020 2274 6865 6e20  ".        "then 
+00050310: 7468 6572 6520 6973 206e 6f20 6e65 6564  there is no need
+00050320: 2074 6f20 7573 6520 7468 6973 206f 7074   to use this opt
+00050330: 696f 6e2e 2022 0a20 2020 2020 2020 2066  ion. ".        f
+00050340: 2249 6620 796f 7520 6861 7665 2063 686f  "If you have cho
+00050350: 7365 6e20 277b 5359 4e43 5f46 554c 4c7d  sen '{SYNC_FULL}
+00050360: 272c 2022 0a20 2020 2020 2020 2022 7468  ', ".        "th
+00050370: 6520 6675 6c6c 2073 7461 7465 2c20 616c  e full state, al
+00050380: 6c20 7374 6174 6520 6576 656e 7473 2077  l state events w
+00050390: 696c 6c20 6265 2073 796e 6368 726f 6e69  ill be synchroni
+000503a0: 7a65 6420 6265 7477 6565 6e20 220a 2020  zed between ".  
+000503b0: 2020 2020 2020 2274 6869 7320 7072 6f67        "this prog
+000503c0: 7261 6d20 616e 6420 7468 6520 7365 7276  ram and the serv
+000503d0: 6572 2062 6566 6f72 6520 6120 2773 656e  er before a 'sen
+000503e0: 6427 2e20 220a 2020 2020 2020 2020 6622  d'. ".        f"
+000503f0: 4966 2079 6f75 2068 6176 6520 6368 6f73  If you have chos
+00050400: 656e 2027 7b53 594e 435f 4f46 467d 272c  en '{SYNC_OFF}',
+00050410: 2022 0a20 2020 2020 2020 2022 7379 6e63   ".        "sync
+00050420: 6872 6f6e 697a 6174 696f 6e20 7769 6c6c  hronization will
+00050430: 2062 6520 736b 6970 7065 6420 656e 7469   be skipped enti
+00050440: 7265 6c79 2062 6566 6f72 6520 7468 6520  rely before the 
+00050450: 2773 656e 6427 2022 0a20 2020 2020 2020  'send' ".       
+00050460: 2022 7768 6963 6820 7769 6c6c 2069 6d70   "which will imp
+00050470: 726f 7665 2070 6572 666f 726d 616e 6365  rove performance
+00050480: 2e22 2c0a 2020 2020 290a 2020 2020 6170  .",.    ).    ap
+00050490: 2e61 6464 5f61 7267 756d 656e 7428 0a20  .add_argument(. 
+000504a0: 2020 2020 2020 2022 2d6f 222c 2020 2320         "-o",  # 
+000504b0: 696e 636f 6d70 6174 6962 6c65 2063 6861  incompatible cha
+000504c0: 6e67 6520 4465 6320 3230 3232 2c20 2d6f  nge Dec 2022, -o
+000504d0: 206d 6f76 6564 2066 726f 6d20 2d2d 6f73   moved from --os
+000504e0: 2d6e 6f74 6966 790a 2020 2020 2020 2020  -notify.        
+000504f0: 222d 2d6f 7574 7075 7422 2c0a 2020 2020  "--output",.    
+00050500: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
+00050510: 7365 2c0a 2020 2020 2020 2020 7479 7065  se,.        type
+00050520: 3d73 7472 2c20 2023 206f 7574 7075 7420  =str,  # output 
+00050530: 6d65 7468 6f64 3a20 7465 7874 2c20 6a73  method: text, js
+00050540: 6f6e 2c20 6a73 6f6e 2d6d 6178 2c20 2e2e  on, json-max, ..
+00050550: 2e0a 2020 2020 2020 2020 6465 6661 756c  ..        defaul
+00050560: 743d 4f55 5450 5554 5f44 4546 4155 4c54  t=OUTPUT_DEFAULT
+00050570: 2c20 2023 2077 6865 6e20 2d2d 6f75 7470  ,  # when --outp
+00050580: 7574 2069 7320 6e6f 7420 7573 6564 0a20  ut is not used. 
+00050590: 2020 2020 2020 206d 6574 6176 6172 3d22         metavar="
+000505a0: 5445 5854 7c4a 534f 4e7c 4a53 4f4e 2d4d  TEXT|JSON|JSON-M
+000505b0: 4158 7c4a 534f 4e2d 5350 4543 222c 0a20  AX|JSON-SPEC",. 
+000505c0: 2020 2020 2020 2068 656c 703d 2253 656c         help="Sel
+000505d0: 6563 7420 616e 206f 7574 7075 7420 666f  ect an output fo
+000505e0: 726d 6174 2e20 220a 2020 2020 2020 2020  rmat. ".        
+000505f0: 2244 6574 6169 6c73 3a3a 2054 6869 7320  "Details:: This 
+00050600: 6f70 7469 6f6e 2064 6563 6964 6573 206f  option decides o
+00050610: 6e20 686f 7720 7468 6520 6f75 7470 7574  n how the output
+00050620: 2069 7320 7072 6573 656e 7465 642e 2022   is presented. "
+00050630: 0a20 2020 2020 2020 2066 2243 7572 7265  .        f"Curre
+00050640: 6e74 6c79 206f 6666 6572 6564 2063 686f  ntly offered cho
+00050650: 6963 6573 2061 7265 3a20 277b 4f55 5450  ices are: '{OUTP
+00050660: 5554 5f54 4558 547d 272c 2027 7b4f 5554  UT_TEXT}', '{OUT
+00050670: 5055 545f 4a53 4f4e 7d27 2c20 220a 2020  PUT_JSON}', ".  
+00050680: 2020 2020 2020 6622 277b 4f55 5450 5554        f"'{OUTPUT
+00050690: 5f4a 534f 4e5f 4d41 587d 272c 2061 6e64  _JSON_MAX}', and
+000506a0: 2027 7b4f 5554 5055 545f 4a53 4f4e 5f53   '{OUTPUT_JSON_S
+000506b0: 5045 437d 272e 2022 0a20 2020 2020 2020  PEC}'. ".       
+000506c0: 2022 5072 6f76 6964 6520 6f6e 6520 6f66   "Provide one of
+000506d0: 2074 6865 7365 2063 686f 6963 6573 2e20   these choices. 
+000506e0: 220a 2020 2020 2020 2020 6622 5468 6520  ".        f"The 
+000506f0: 6465 6661 756c 7420 6973 2027 7b4f 5554  default is '{OUT
+00050700: 5055 545f 4445 4641 554c 547d 272e 2049  PUT_DEFAULT}'. I
+00050710: 6620 796f 7520 7761 6e74 2074 6f20 7573  f you want to us
+00050720: 6520 7468 6520 6465 6661 756c 742c 2022  e the default, "
+00050730: 0a20 2020 2020 2020 2022 7468 656e 2074  .        "then t
+00050740: 6865 7265 2069 7320 6e6f 206e 6565 6420  here is no need 
+00050750: 746f 2075 7365 2074 6869 7320 6f70 7469  to use this opti
+00050760: 6f6e 2e20 220a 2020 2020 2020 2020 6622  on. ".        f"
+00050770: 4966 2079 6f75 2068 6176 6520 6368 6f73  If you have chos
+00050780: 656e 2027 7b4f 5554 5055 545f 5445 5854  en '{OUTPUT_TEXT
+00050790: 7d27 2c20 220a 2020 2020 2020 2020 2274  }', ".        "t
+000507a0: 6865 206f 7574 7075 7420 7769 6c6c 2062  he output will b
+000507b0: 6520 666f 726d 6174 7465 6420 7769 7468  e formatted with
+000507c0: 2074 6865 2069 6e74 656e 7469 6f6e 2074   the intention t
+000507d0: 6f20 6265 2022 0a20 2020 2020 2020 2022  o be ".        "
+000507e0: 636f 6e73 756d 6564 2062 7920 6875 6d61  consumed by huma
+000507f0: 6e73 2c20 692e 652e 2072 6561 6461 626c  ns, i.e. readabl
+00050800: 6520 7465 7874 2e20 220a 2020 2020 2020  e text. ".      
+00050810: 2020 6622 4966 2079 6f75 2068 6176 6520    f"If you have 
+00050820: 6368 6f73 656e 2027 7b4f 5554 5055 545f  chosen '{OUTPUT_
+00050830: 4a53 4f4e 7d27 2c20 220a 2020 2020 2020  JSON}', ".      
+00050840: 2020 2274 6865 206f 7574 7075 7420 7769    "the output wi
+00050850: 6c6c 2062 6520 666f 726d 6174 7465 6420  ll be formatted 
+00050860: 6173 204a 534f 4e2e 2022 0a20 2020 2020  as JSON. ".     
+00050870: 2020 2022 5468 6520 636f 6e74 656e 7420     "The content 
+00050880: 6f66 2074 6865 204a 534f 4e20 6f62 6a65  of the JSON obje
+00050890: 6374 206d 6174 6368 6573 2074 6865 2064  ct matches the d
+000508a0: 6174 6120 7072 6f76 6964 6564 2062 7920  ata provided by 
+000508b0: 7468 6520 220a 2020 2020 2020 2020 226d  the ".        "m
+000508c0: 6174 7269 782d 6e69 6f20 5344 4b2e 2049  atrix-nio SDK. I
+000508d0: 6e20 736f 6d65 206f 6363 6173 696f 6e73  n some occasions
+000508e0: 2074 6865 206f 7574 7075 7420 6973 2065   the output is e
+000508f0: 6e68 616e 6365 6420 220a 2020 2020 2020  nhanced ".      
+00050900: 2020 2262 7920 6861 7669 6e67 2061 2066    "by having a f
+00050910: 6577 2065 7874 7261 2064 6174 6120 6974  ew extra data it
+00050920: 656d 7320 6164 6465 6420 666f 7220 636f  ems added for co
+00050930: 6e76 656e 6965 6e63 652e 2022 0a20 2020  nvenience. ".   
+00050940: 2020 2020 2022 496e 206d 6f73 7420 6361       "In most ca
+00050950: 7365 7320 7468 6520 6f75 7470 7574 2077  ses the output w
+00050960: 696c 6c20 6265 2070 726f 6365 7373 6564  ill be processed
+00050970: 2062 7920 6f74 6865 7220 7072 6f67 7261   by other progra
+00050980: 6d73 2022 0a20 2020 2020 2020 2022 7261  ms ".        "ra
+00050990: 7468 6572 2074 6861 6e20 7265 6164 2062  ther than read b
+000509a0: 7920 6875 6d61 6e73 2e20 220a 2020 2020  y humans. ".    
+000509b0: 2020 2020 6622 4f70 7469 6f6e 2027 7b4f      f"Option '{O
+000509c0: 5554 5055 545f 4a53 4f4e 5f4d 4158 7d27  UTPUT_JSON_MAX}'
+000509d0: 2069 7320 7072 6163 7469 6361 6c6c 7920   is practically 
+000509e0: 7468 6520 7361 6d65 2061 7320 220a 2020  the same as ".  
+000509f0: 2020 2020 2020 6622 277b 4f55 5450 5554        f"'{OUTPUT
+00050a00: 5f4a 534f 4e7d 272c 2022 0a20 2020 2020  _JSON}', ".     
+00050a10: 2020 2022 6275 7420 7965 7420 616e 6f74     "but yet anot
+00050a20: 6865 7220 6164 6469 7469 6f6e 616c 2066  her additional f
+00050a30: 6965 6c64 2069 7320 6164 6465 642e 2022  ield is added. "
+00050a40: 0a20 2020 2020 2020 2022 5468 6520 6461  .        "The da
+00050a50: 7461 2069 7465 6d20 2774 7261 6e73 706f  ta item 'transpo
+00050a60: 7274 5f72 6573 706f 6e73 6527 2077 6869  rt_response' whi
+00050a70: 6368 2067 6976 6573 2069 6e66 6f72 6d61  ch gives informa
+00050a80: 7469 6f6e 206f 6e20 220a 2020 2020 2020  tion on ".      
+00050a90: 2020 2268 6f77 2074 6865 2064 6174 6120    "how the data 
+00050aa0: 7761 7320 6f62 7461 696e 6564 2061 6e64  was obtained and
+00050ab0: 2074 7261 6e73 706f 7274 6564 2069 7320   transported is 
+00050ac0: 616c 736f 2062 6569 6e67 2061 6464 6564  also being added
+00050ad0: 2e20 220a 2020 2020 2020 2020 2246 6f72  . ".        "For
+00050ae0: 2027 2d2d 6c69 7374 656e 2720 6120 6665   '--listen' a fe
+00050af0: 7720 6d6f 7265 2066 6965 6c64 7320 6172  w more fields ar
+00050b00: 6520 6164 6465 642e 2022 0a20 2020 2020  e added. ".     
+00050b10: 2020 2022 496e 206d 6f73 7420 6361 7365     "In most case
+00050b20: 7320 7468 6520 6f75 7470 7574 2077 696c  s the output wil
+00050b30: 6c20 6265 2070 726f 6365 7373 6564 2062  l be processed b
+00050b40: 7920 6f74 6865 7220 7072 6f67 7261 6d73  y other programs
+00050b50: 2022 0a20 2020 2020 2020 2022 7261 7468   ".        "rath
+00050b60: 6572 2074 6861 6e20 7265 6164 2062 7920  er than read by 
+00050b70: 6875 6d61 6e73 2e20 220a 2020 2020 2020  humans. ".      
+00050b80: 2020 6622 4f70 7469 6f6e 2027 7b4f 5554    f"Option '{OUT
+00050b90: 5055 545f 4a53 4f4e 5f53 5045 437d 2720  PUT_JSON_SPEC}' 
+00050ba0: 6f6e 6c79 2070 7269 6e74 7320 696e 666f  only prints info
+00050bb0: 726d 6174 696f 6e20 7468 6174 2061 6468  rmation that adh
+00050bc0: 6572 6573 2022 0a20 2020 2020 2020 2022  eres ".        "
+00050bd0: 312d 746f 2d31 2074 6f20 7468 6520 4d61  1-to-1 to the Ma
+00050be0: 7472 6978 2053 7065 6369 6669 6361 7469  trix Specificati
+00050bf0: 6f6e 2e20 4375 7272 656e 746c 7920 6f6e  on. Currently on
+00050c00: 6c79 2074 6865 2065 7665 6e74 7320 220a  ly the events ".
+00050c10: 2020 2020 2020 2020 226f 6e20 272d 2d6c          "on '--l
+00050c20: 6973 7465 6e27 2061 6e64 2027 2d2d 7461  isten' and '--ta
+00050c30: 696c 2720 7072 6f76 6964 6520 6461 7461  il' provide data
+00050c40: 2065 7861 6374 6c79 2061 7320 696e 2074   exactly as in t
+00050c50: 6865 2022 0a20 2020 2020 2020 2022 4d61  he ".        "Ma
+00050c60: 7472 6978 2053 7065 6369 6669 6361 7469  trix Specificati
+00050c70: 6f6e 2e20 4966 206e 6f20 6461 7461 2069  on. If no data i
+00050c80: 7320 6176 6169 6c61 626c 6520 7468 6174  s available that
+00050c90: 2063 6f72 7265 7370 6f6e 6473 2022 0a20   corresponds ". 
+00050ca0: 2020 2020 2020 2022 6578 6163 746c 7920         "exactly 
+00050cb0: 7769 7468 2074 6865 204d 6174 7269 7820  with the Matrix 
+00050cc0: 5370 6563 6966 6963 6174 696f 6e2c 206e  Specification, n
+00050cd0: 6f20 6461 7461 2077 696c 6c20 6265 2070  o data will be p
+00050ce0: 7269 6e74 6564 2e20 220a 2020 2020 2020  rinted. ".      
+00050cf0: 2020 2249 6e20 7368 6f72 742c 2063 7572    "In short, cur
+00050d00: 7265 6e74 6c79 2027 2d2d 6a73 6f6e 2d73  rently '--json-s
+00050d10: 7065 6327 206f 6e6c 7920 7072 6f76 6964  pec' only provid
+00050d20: 6573 206f 7574 7075 7473 2066 6f72 2022  es outputs for "
+00050d30: 0a20 2020 2020 2020 2022 272d 2d6c 6973  .        "'--lis
+00050d40: 7465 6e27 2061 6e64 2027 2d2d 7461 696c  ten' and '--tail
+00050d50: 272e 2041 6c6c 206f 7468 6572 2061 7267  '. All other arg
+00050d60: 756d 656e 7473 206c 696b 6520 272d 2d67  uments like '--g
+00050d70: 6574 2d72 6f6f 6d2d 696e 666f 2720 220a  et-room-info' ".
+00050d80: 2020 2020 2020 2020 2277 696c 6c20 7072          "will pr
+00050d90: 696e 7420 6e6f 206f 7574 7075 742e 2022  int no output. "
+00050da0: 2c0a 2020 2020 290a 2020 2020 6170 2e61  ,.    ).    ap.a
+00050db0: 6464 5f61 7267 756d 656e 7428 0a20 2020  dd_argument(.   
+00050dc0: 2020 2020 2022 2d76 222c 2020 2320 696e       "-v",  # in
+00050dd0: 636f 6d70 6174 6962 6c65 2063 6861 6e67  compatible chang
+00050de0: 6520 4465 6320 3230 3232 2c20 2d76 206d  e Dec 2022, -v m
+00050df0: 6f76 6564 2068 6572 6520 6672 6f6d 202d  oved here from -
+00050e00: 2d76 6572 6966 790a 2020 2020 2020 2020  -verify.        
+00050e10: 222d 5622 2c20 2023 2065 7863 6570 7469  "-V",  # excepti
+00050e20: 6f6e 2c20 616c 6c6f 7720 616c 736f 2075  on, allow also u
+00050e30: 7070 6572 6361 7365 2056 0a20 2020 2020  ppercase V.     
+00050e40: 2020 2022 2d2d 7665 7273 696f 6e22 2c0a     "--version",.
+00050e50: 2020 2020 2020 2020 7265 7175 6972 6564          required
+00050e60: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+00050e70: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
+00050e80: 2020 6465 6661 756c 743d 5645 5253 494f    default=VERSIO
+00050e90: 4e5f 554e 5553 4544 5f44 4546 4155 4c54  N_UNUSED_DEFAULT
+00050ea0: 2c20 2023 2077 6865 6e20 2d74 2069 7320  ,  # when -t is 
+00050eb0: 6e6f 7420 7573 6564 0a20 2020 2020 2020  not used.       
+00050ec0: 206e 6172 6773 3d22 3f22 2c20 2023 206d   nargs="?",  # m
+00050ed0: 616b 6573 2074 6865 2077 6f72 6420 6f70  akes the word op
+00050ee0: 7469 6f6e 616c 0a20 2020 2020 2020 2023  tional.        #
+00050ef0: 2077 6865 6e20 2d76 2069 7320 7573 6564   when -v is used
+00050f00: 2c20 6275 7420 7465 7874 2069 7320 6e6f  , but text is no
+00050f10: 7420 6164 6465 640a 2020 2020 2020 2020  t added.        
+00050f20: 636f 6e73 743d 5645 5253 494f 4e5f 5553  const=VERSION_US
+00050f30: 4544 5f44 4546 4155 4c54 2c0a 2020 2020  ED_DEFAULT,.    
+00050f40: 2020 2020 6d65 7461 7661 723d 2250 5249      metavar="PRI
+00050f50: 4e54 7c43 4845 434b 222c 0a20 2020 2020  NT|CHECK",.     
+00050f60: 2020 2068 656c 703d 2250 7269 6e74 2076     help="Print v
+00050f70: 6572 7369 6f6e 2069 6e66 6f72 6d61 7469  ersion informati
+00050f80: 6f6e 206f 7220 6368 6563 6b20 666f 7220  on or check for 
+00050f90: 7570 6461 7465 732e 2022 0a20 2020 2020  updates. ".     
+00050fa0: 2020 2022 4465 7461 696c 733a 3a20 5468     "Details:: Th
+00050fb0: 6973 206f 7074 696f 6e20 7461 6b65 7320  is option takes 
+00050fc0: 7a65 726f 206f 7220 6f6e 6520 6172 6775  zero or one argu
+00050fd0: 6d65 6e74 2e20 220a 2020 2020 2020 2020  ment. ".        
+00050fe0: 6622 4966 206e 6f20 6172 6775 6d65 6e74  f"If no argument
+00050ff0: 2069 7320 6769 7665 6e2c 2027 7b50 5249   is given, '{PRI
+00051000: 4e54 7d27 2069 7320 6173 7375 6d65 6420  NT}' is assumed 
+00051010: 7768 6963 6820 7769 6c6c 2022 0a20 2020  which will ".   
+00051020: 2020 2020 2066 2270 7269 6e74 2074 6865       f"print the
+00051030: 2076 6572 7369 6f6e 206f 6620 7468 6520   version of the 
+00051040: 6375 7272 656e 746c 7920 696e 7374 616c  currently instal
+00051050: 6c65 6420 2750 524f 475f 5749 5448 4f55  led 'PROG_WITHOU
+00051060: 545f 4558 5427 2022 0a20 2020 2020 2020  T_EXT' ".       
+00051070: 2066 2270 6163 6b61 6765 2e20 277b 4348   f"package. '{CH
+00051080: 4543 4b7d 2720 6973 2074 6865 2061 6c74  ECK}' is the alt
+00051090: 6572 6e61 7469 7665 2e20 220a 2020 2020  ernative. ".    
+000510a0: 2020 2020 2227 7b43 4845 434b 7d27 2063      "'{CHECK}' c
+000510b0: 6f6e 6e65 6374 7320 746f 2068 7474 7073  onnects to https
+000510c0: 3a2f 2f70 7970 692e 6f72 6720 616e 6420  ://pypi.org and 
+000510d0: 6765 7473 2074 6865 2076 6572 7369 6f6e  gets the version
+000510e0: 2022 0a20 2020 2020 2020 2022 6e75 6d62   ".        "numb
+000510f0: 6572 206f 6620 6c61 7465 7374 2073 7461  er of latest sta
+00051100: 626c 6520 7265 6c65 6173 652e 2054 6865  ble release. The
+00051110: 7265 2069 7320 6e6f 2027 6361 6c6c 696e  re is no 'callin
+00051120: 6720 686f 6d65 2720 220a 2020 2020 2020  g home' ".      
+00051130: 2020 226f 6e20 6576 6572 7920 7275 6e2c    "on every run,
+00051140: 206f 6e6c 7920 6120 2763 6865 636b 2070   only a 'check p
+00051150: 7970 692e 6f72 6727 2075 706f 6e20 7265  ypi.org' upon re
+00051160: 7175 6573 742e 2059 6f75 7220 220a 2020  quest. Your ".  
+00051170: 2020 2020 2020 2270 7269 7661 6379 2069        "privacy i
+00051180: 7320 7072 6f74 6563 7465 642e 2054 6865  s protected. The
+00051190: 206e 6577 2072 656c 6561 7365 2069 7320   new release is 
+000511a0: 6e65 6974 6865 7220 646f 776e 6c6f 6164  neither download
+000511b0: 6564 2c20 220a 2020 2020 2020 2020 226e  ed, ".        "n
+000511c0: 6f72 2069 6e73 7461 6c6c 6564 2e20 4974  or installed. It
+000511d0: 206a 7573 7420 696e 666f 726d 7320 796f   just informs yo
+000511e0: 752e 2022 0a20 2020 2020 2020 2022 4166  u. ".        "Af
+000511f0: 7465 7220 7072 696e 7469 6e67 2076 6572  ter printing ver
+00051200: 7369 6f6e 2069 6e66 6f72 6d61 7469 6f6e  sion information
+00051210: 2074 6865 2022 0a20 2020 2020 2020 2022   the ".        "
+00051220: 7072 6f67 7261 6d20 7769 6c6c 2063 6f6e  program will con
+00051230: 7469 6e75 6520 746f 2072 756e 2e20 5468  tinue to run. Th
+00051240: 6973 2069 7320 7573 6566 756c 2066 6f72  is is useful for
+00051250: 2068 6176 696e 6720 7665 7273 696f 6e20   having version 
+00051260: 220a 2020 2020 2020 2020 226e 756d 6265  ".        "numbe
+00051270: 7220 696e 2074 6865 206c 6f67 2066 696c  r in the log fil
+00051280: 6573 2e22 2c0a 2020 2020 290a 2020 2020  es.",.    ).    
+00051290: 6773 2e70 6120 3d20 6170 2e70 6172 7365  gs.pa = ap.parse
+000512a0: 5f61 7267 7328 290a 2020 2020 2320 7772  _args().    # wr
+000512b0: 6170 2061 6e64 2069 6e64 656e 743a 2068  ap and indent: h
+000512c0: 7474 7073 3a2f 2f74 6f77 6172 6473 6461  ttps://towardsda
+000512d0: 7461 7363 6965 6e63 652e 636f 6d2f 362d  tascience.com/6-
+000512e0: 6661 6e63 792d 6275 696c 742d 696e 2d74  fancy-built-in-t
+000512f0: 6578 742d 0a20 2020 2023 2020 2020 2020  ext-.    #      
+00051300: 2020 2020 2020 2020 2020 2020 7772 6170              wrap
+00051310: 7069 6e67 2d74 6563 686e 6971 7565 732d  ping-techniques-
+00051320: 696e 2d70 7974 686f 6e2d 6137 3863 6335  in-python-a78cc5
+00051330: 3763 3235 3636 0a20 2020 2023 2069 6620  7c2566.    # if 
+00051340: 6f75 7470 7574 2069 7320 6e6f 7420 5454  output is not TT
+00051350: 592c 2074 6865 6e20 646f 6e27 7420 6164  Y, then don't ad
+00051360: 6420 636f 6c6f 7273 2c20 652e 672e 2077  d colors, e.g. w
+00051370: 6865 6e20 6f75 7470 7574 2069 7320 7069  hen output is pi
+00051380: 7065 640a 2020 2020 6966 2073 7973 2e73  ped.    if sys.s
+00051390: 7464 6f75 742e 6973 6174 7479 2829 3a0a  tdout.isatty():.
+000513a0: 2020 2020 2020 2020 2320 596f 7527 7265          # You're
+000513b0: 2072 756e 6e69 6e67 2069 6e20 6120 7265   running in a re
+000513c0: 616c 2074 6572 6d69 6e61 6c0a 2020 2020  al terminal.    
+000513d0: 2020 2020 2320 636f 6c6f 7273 0a20 2020      # colors.   
+000513e0: 2020 2020 2023 2061 6461 7074 2077 6964       # adapt wid
+000513f0: 7468 0a20 2020 2020 2020 2074 6572 6d5f  th.        term_
+00051400: 7769 6474 6820 3d20 6f73 2e67 6574 5f74  width = os.get_t
+00051410: 6572 6d69 6e61 6c5f 7369 7a65 2829 5b30  erminal_size()[0
+00051420: 5d0a 2020 2020 2020 2020 2320 7072 696e  ].        # prin
+00051430: 7428 2274 6572 6d69 6e61 6c20 7769 6474  t("terminal widt
+00051440: 6820 222c 2074 6572 6d5f 7769 6474 6829  h ", term_width)
+00051450: 0a20 2020 2020 2020 2063 6f6e 203d 2063  .        con = c
+00051460: 6f6c 6f72 732e 6667 2e67 7265 656e 0a20  olors.fg.green. 
+00051470: 2020 2020 2020 2063 6f66 6620 3d20 636f         coff = co
+00051480: 6c6f 7273 2e72 6573 6574 0a20 2020 2020  lors.reset.     
+00051490: 2020 2065 6f6e 203d 2063 6f6c 6f72 732e     eon = colors.
+000514a0: 626f 6c64 202b 2063 6f6e 0a20 2020 2020  bold + con.     
+000514b0: 2020 2065 6f66 6620 3d20 636f 6c6f 7273     eoff = colors
+000514c0: 2e72 6573 6574 202b 2063 6f6e 0a20 2020  .reset + con.   
+000514d0: 2065 6c73 653a 0a20 2020 2020 2020 2023   else:.        #
+000514e0: 2059 6f75 2772 6520 6265 696e 6720 7069   You're being pi
+000514f0: 7065 6420 6f72 2072 6564 6972 6563 7465  ped or redirecte
+00051500: 640a 2020 2020 2020 2020 2320 6e6f 2043  d.        # no C
+00051510: 6f6c 6f72 730a 2020 2020 2020 2020 2320  olors.        # 
+00051520: 7769 6474 6820 3d20 3830 0a20 2020 2020  width = 80.     
+00051530: 2020 2074 6572 6d5f 7769 6474 6820 3d20     term_width = 
+00051540: 3830 0a20 2020 2020 2020 2023 2070 7269  80.        # pri
+00051550: 6e74 2822 6e6f 7420 696e 2074 6572 6d69  nt("not in termi
+00051560: 6e61 6c2c 2075 7369 6e67 2064 6566 6175  nal, using defau
+00051570: 6c74 2074 6572 6d69 6e61 6c20 7769 6474  lt terminal widt
+00051580: 6820 222c 2074 6572 6d5f 7769 6474 6829  h ", term_width)
+00051590: 0a20 2020 2020 2020 2063 6f6e 203d 2022  .        con = "
+000515a0: 220a 2020 2020 2020 2020 636f 6666 203d  ".        coff =
+000515b0: 2022 220a 2020 2020 2020 2020 656f 6e20   "".        eon 
+000515c0: 3d20 2222 0a20 2020 2020 2020 2065 6f66  = "".        eof
+000515d0: 6620 3d20 2222 0a20 2020 2069 6620 6773  f = "".    if gs
+000515e0: 2e70 612e 7573 6167 653a 0a20 2020 2020  .pa.usage:.     
+000515f0: 2020 2070 7269 6e74 2874 6578 7477 7261     print(textwra
+00051600: 702e 6669 6c6c 2861 702e 6465 7363 7269  p.fill(ap.descri
+00051610: 7074 696f 6e2c 2077 6964 7468 3d74 6572  ption, width=ter
+00051620: 6d5f 7769 6474 6829 290a 2020 2020 2020  m_width)).      
+00051630: 2020 7072 696e 7428 2222 290a 2020 2020    print("").    
+00051640: 2020 2020 6170 2e70 7269 6e74 5f75 7361      ap.print_usa
+00051650: 6765 2829 0a20 2020 2020 2020 2070 7269  ge().        pri
+00051660: 6e74 2822 2229 0a20 2020 2020 2020 2070  nt("").        p
+00051670: 7269 6e74 2874 6578 7477 7261 702e 6669  rint(textwrap.fi
+00051680: 6c6c 2861 702e 6570 696c 6f67 2c20 7769  ll(ap.epilog, wi
+00051690: 6474 683d 7465 726d 5f77 6964 7468 2929  dth=term_width))
+000516a0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000516b0: 300a 2020 2020 6966 2067 732e 7061 2e68  0.    if gs.pa.h
+000516c0: 656c 703a 0a20 2020 2020 2020 2070 7269  elp:.        pri
+000516d0: 6e74 2874 6578 7477 7261 702e 6669 6c6c  nt(textwrap.fill
+000516e0: 2861 702e 6465 7363 7269 7074 696f 6e2c  (ap.description,
+000516f0: 2077 6964 7468 3d74 6572 6d5f 7769 6474   width=term_widt
+00051700: 6829 290a 2020 2020 2020 2020 7072 696e  h)).        prin
+00051710: 7428 2222 290a 2020 2020 2020 2020 7072  t("").        pr
+00051720: 696e 7428 0a20 2020 2020 2020 2020 2020  int(.           
+00051730: 2074 6578 7477 7261 702e 6669 6c6c 280a   textwrap.fill(.
+00051740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051750: 6622 7b50 524f 475f 5749 5448 4f55 545f  f"{PROG_WITHOUT_
+00051760: 4558 547d 2073 7570 706f 7274 7320 7468  EXT} supports th
+00051770: 6573 6520 6172 6775 6d65 6e74 733a 222c  ese arguments:",
+00051780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00051790: 2077 6964 7468 3d74 6572 6d5f 7769 6474   width=term_widt
+000517a0: 682c 0a20 2020 2020 2020 2020 2020 2029  h,.            )
+000517b0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+000517c0: 2020 2023 2070 7269 6e74 2822 2229 0a20     # print(""). 
+000517d0: 2020 2020 2020 2068 656c 705f 6865 6c70         help_help
+000517e0: 5f70 7265 203d 2022 2222 0a3c 2d2d 7573  _pre = """.<--us
+000517f0: 6167 653e 0a50 7269 6e74 2075 7361 6765  age>.Print usage
+00051800: 2e0a 3c2d 683e 2c20 3c2d 2d68 656c 703e  ..<-h>, <--help>
+00051810: 0a50 7269 6e74 2068 656c 702e 0a3c 2d2d  .Print help..<--
+00051820: 6d61 6e75 616c 3e0a 5072 696e 7420 6d61  manual>.Print ma
+00051830: 6e75 616c 2e0a 3c2d 2d72 6561 646d 653e  nual..<--readme>
+00051840: 0a50 7269 6e74 2052 4541 444d 452e 6d64  .Print README.md
+00051850: 2066 696c 652e 0a3c 2d64 3e2c 203c 2d2d   file..<-d>, <--
+00051860: 6465 6275 673e 0a50 7269 6e74 2064 6562  debug>.Print deb
+00051870: 7567 2069 6e66 6f72 6d61 7469 6f6e 2e0a  ug information..
+00051880: 3c2d 2d6c 6f67 2d6c 6576 656c 3e20 4445  <--log-level> DE
+00051890: 4255 477c 494e 464f 7c57 4152 4e49 4e47  BUG|INFO|WARNING
+000518a0: 7c45 5252 4f52 7c43 5249 5449 4341 4c20  |ERROR|CRITICAL 
+000518b0: 5b44 4542 5547 7c49 4e46 4f7c 5741 524e  [DEBUG|INFO|WARN
+000518c0: 494e 477c 4552 524f 527c 4352 4954 4943  ING|ERROR|CRITIC
+000518d0: 414c 202e 2e2e 5d0a 5365 7420 7468 6520  AL ...].Set the 
+000518e0: 6c6f 6720 6c65 7665 6c28 7329 2e0a 3c2d  log level(s)..<-
+000518f0: 2d76 6572 626f 7365 3e0a 5365 7420 7468  -verbose>.Set th
+00051900: 6520 7665 7262 6f73 6974 7920 6c65 7665  e verbosity leve
+00051910: 6c2e 0a3c 2d2d 6c6f 6769 6e3e 2050 4153  l..<--login> PAS
+00051920: 5357 4f52 447c 5353 4f0a 4c6f 6769 6e20  SWORD|SSO.Login 
+00051930: 746f 2061 6e64 2061 7574 6865 6e74 6963  to and authentic
+00051940: 6174 6520 7769 7468 2074 6865 204d 6174  ate with the Mat
+00051950: 7269 7820 686f 6d65 7365 7276 6572 2e0a  rix homeserver..
+00051960: 3c2d 2d76 6572 6966 793e 205b 454d 4f4a  <--verify> [EMOJ
+00051970: 495d 0a50 6572 666f 726d 2076 6572 6966  I].Perform verif
+00051980: 6963 6174 696f 6e2e 0a3c 2d2d 6c6f 676f  ication..<--logo
+00051990: 7574 3e20 4d45 7c41 4c4c 0a4c 6f67 6f75  ut> ME|ALL.Logou
+000519a0: 742e 0a3c 2d63 3e20 4352 4544 454e 5449  t..<-c> CREDENTI
+000519b0: 414c 535f 4649 4c45 2c20 3c2d 2d63 7265  ALS_FILE, <--cre
+000519c0: 6465 6e74 6961 6c73 3e20 4352 4544 454e  dentials> CREDEN
+000519d0: 5449 414c 535f 4649 4c45 0a53 7065 6369  TIALS_FILE.Speci
+000519e0: 6679 206c 6f63 6174 696f 6e20 6f66 2063  fy location of c
+000519f0: 7265 6465 6e74 6961 6c73 2066 696c 652e  redentials file.
+00051a00: 0a3c 2d73 3e20 5354 4f52 455f 4449 5245  .<-s> STORE_DIRE
+00051a10: 4354 4f52 592c 203c 2d2d 7374 6f72 653e  CTORY, <--store>
+00051a20: 2053 544f 5245 5f44 4952 4543 544f 5259   STORE_DIRECTORY
+00051a30: 0a53 7065 6369 6679 206c 6f63 6174 696f  .Specify locatio
+00051a40: 6e20 6f66 2073 746f 7265 2064 6972 6563  n of store direc
+00051a50: 746f 7279 2e0a 3c2d 723e 2052 4f4f 4d20  tory..<-r> ROOM 
+00051a60: 5b52 4f4f 4d20 2e2e 2e5d 2c20 3c2d 2d72  [ROOM ...], <--r
+00051a70: 6f6f 6d3e 2052 4f4f 4d20 5b52 4f4f 4d20  oom> ROOM [ROOM 
+00051a80: 2e2e 2e5d 0a53 7065 6369 6679 206f 6e65  ...].Specify one
+00051a90: 206f 7220 6d75 6c74 6970 6c65 2072 6f6f   or multiple roo
+00051aa0: 6d73 2e0a 3c2d 2d72 6f6f 6d2d 6465 6661  ms..<--room-defa
+00051ab0: 756c 743e 2044 4546 4155 4c54 5f52 4f4f  ult> DEFAULT_ROO
+00051ac0: 4d0a 5370 6563 6966 7920 7468 6520 6465  M.Specify the de
+00051ad0: 6661 756c 7420 726f 6f6d 2061 7420 2d2d  fault room at --
+00051ae0: 6c6f 6769 6e2e 0a3c 2d2d 726f 6f6d 2d63  login..<--room-c
+00051af0: 7265 6174 653e 2052 4f4f 4d5f 414c 4941  reate> ROOM_ALIA
+00051b00: 5320 5b52 4f4f 4d5f 414c 4941 5320 2e2e  S [ROOM_ALIAS ..
+00051b10: 2e5d 0a43 7265 6174 6520 6f6e 6520 6f72  .].Create one or
+00051b20: 206d 756c 7469 706c 6520 726f 6f6d 7320   multiple rooms 
+00051b30: 666f 7220 6769 7665 6e20 616c 6961 7328  for given alias(
+00051b40: 6573 292e 0a3c 2d2d 726f 6f6d 2d64 6d2d  es)..<--room-dm-
+00051b50: 6372 6561 7465 3e20 5553 4552 205b 5553  create> USER [US
+00051b60: 4552 202e 2e2e 5d0a 4372 6561 7465 206f  ER ...].Create o
+00051b70: 6e65 206f 7220 6d75 6c74 6970 6c65 2044  ne or multiple D
+00051b80: 4d20 726f 6f6d 7320 7769 7468 2074 6865  M rooms with the
+00051b90: 2073 7065 6369 6669 6564 2075 7365 7273   specified users
+00051ba0: 2e0a 3c2d 2d72 6f6f 6d2d 6a6f 696e 3e20  ..<--room-join> 
+00051bb0: 524f 4f4d 205b 524f 4f4d 202e 2e2e 5d0a  ROOM [ROOM ...].
+00051bc0: 4a6f 696e 206f 6e65 2072 6f6f 6d20 6f72  Join one room or
+00051bd0: 206d 756c 7469 706c 6520 726f 6f6d 732e   multiple rooms.
+00051be0: 0a3c 2d2d 726f 6f6d 2d6c 6561 7665 3e20  .<--room-leave> 
+00051bf0: 524f 4f4d 205b 524f 4f4d 202e 2e2e 5d0a  ROOM [ROOM ...].
+00051c00: 4c65 6176 6520 6f6e 6520 726f 6f6d 206f  Leave one room o
+00051c10: 7220 6d75 6c74 6970 6c65 2072 6f6f 6d73  r multiple rooms
+00051c20: 2e0a 3c2d 2d72 6f6f 6d2d 666f 7267 6574  ..<--room-forget
+00051c30: 3e20 524f 4f4d 205b 524f 4f4d 202e 2e2e  > ROOM [ROOM ...
+00051c40: 5d0a 466f 7267 6574 206f 6e65 2072 6f6f  ].Forget one roo
+00051c50: 6d20 6f72 206d 756c 7469 706c 6520 726f  m or multiple ro
+00051c60: 6f6d 732e 0a3c 2d2d 726f 6f6d 2d69 6e76  oms..<--room-inv
+00051c70: 6974 653e 2052 4f4f 4d20 5b52 4f4f 4d20  ite> ROOM [ROOM 
+00051c80: 2e2e 2e5d 0a49 6e76 6974 6520 6f6e 6520  ...].Invite one 
+00051c90: 6f72 6520 6d6f 7265 2075 7365 7273 2074  ore more users t
+00051ca0: 6f20 6a6f 696e 206f 6e65 206f 7220 6d6f  o join one or mo
+00051cb0: 7265 2072 6f6f 6d73 2e0a 3c2d 2d72 6f6f  re rooms..<--roo
+00051cc0: 6d2d 6261 6e3e 2052 4f4f 4d20 5b52 4f4f  m-ban> ROOM [ROO
+00051cd0: 4d20 2e2e 2e5d 0a42 616e 206f 6e65 206f  M ...].Ban one o
+00051ce0: 7265 206d 6f72 6520 7573 6572 7320 6672  re more users fr
+00051cf0: 6f6d 206f 6e65 206f 7220 6d6f 7265 2072  om one or more r
+00051d00: 6f6f 6d73 2e0a 3c2d 2d72 6f6f 6d2d 756e  ooms..<--room-un
+00051d10: 6261 6e3e 2052 4f4f 4d20 5b52 4f4f 4d20  ban> ROOM [ROOM 
+00051d20: 2e2e 2e5d 0a55 6e62 616e 206f 6e65 206f  ...].Unban one o
+00051d30: 7265 206d 6f72 6520 7573 6572 7320 6672  re more users fr
+00051d40: 6f6d 206f 6e65 206f 7220 6d6f 7265 2072  om one or more r
+00051d50: 6f6f 6d73 2e0a 3c2d 2d72 6f6f 6d2d 6b69  ooms..<--room-ki
+00051d60: 636b 3e20 524f 4f4d 205b 524f 4f4d 202e  ck> ROOM [ROOM .
+00051d70: 2e2e 5d0a 4b69 636b 206f 6e65 206f 7265  ..].Kick one ore
+00051d80: 206d 6f72 6520 7573 6572 7320 6672 6f6d   more users from
+00051d90: 206f 6e65 206f 7220 6d6f 7265 2072 6f6f   one or more roo
+00051da0: 6d73 2e0a 3c2d 753e 2055 5345 5220 5b55  ms..<-u> USER [U
+00051db0: 5345 5220 2e2e 2e5d 2c20 3c2d 2d75 7365  SER ...], <--use
+00051dc0: 723e 2055 5345 5220 5b55 5345 5220 2e2e  r> USER [USER ..
+00051dd0: 2e5d 0a53 7065 6369 6679 206f 6e65 206f  .].Specify one o
+00051de0: 7220 6d75 6c74 6970 6c65 2075 7365 7273  r multiple users
+00051df0: 2e0a 3c2d 2d75 7365 722d 6c6f 6769 6e3e  ..<--user-login>
+00051e00: 2055 5345 520a 5370 6563 6966 7920 7573   USER.Specify us
+00051e10: 6572 2066 6f72 202d 2d6c 6f67 696e 2e0a  er for --login..
+00051e20: 3c2d 2d6e 616d 653e 2052 4f4f 4d5f 4e41  <--name> ROOM_NA
+00051e30: 4d45 205b 524f 4f4d 5f4e 414d 4520 2e2e  ME [ROOM_NAME ..
+00051e40: 2e5d 0a53 7065 6369 6679 206f 6e65 206f  .].Specify one o
+00051e50: 7220 6d75 6c74 6970 6c65 2072 6f6f 6d20  r multiple room 
+00051e60: 6e61 6d65 732e 0a3c 2d2d 746f 7069 633e  names..<--topic>
+00051e70: 2052 4f4f 4d5f 544f 5049 4320 5b52 4f4f   ROOM_TOPIC [ROO
+00051e80: 4d5f 544f 5049 4320 2e2e 2e5d 0a53 7065  M_TOPIC ...].Spe
+00051e90: 6369 6679 206f 6e65 206f 7220 6d75 6c74  cify one or mult
+00051ea0: 6970 6c65 2072 6f6f 6d20 746f 7069 6373  iple room topics
+00051eb0: 2e0a 3c2d 2d61 6c69 6173 3e20 524f 4f4d  ..<--alias> ROOM
+00051ec0: 5f41 4c49 4153 205b 524f 4f4d 5f41 4c49  _ALIAS [ROOM_ALI
+00051ed0: 4153 202e 2e2e 5d0a 5370 6563 6966 7920  AS ...].Specify 
+00051ee0: 6f6e 6520 6f72 206d 756c 7469 706c 6520  one or multiple 
+00051ef0: 726f 6f6d 2061 6c69 6173 6573 2e0a 3c2d  room aliases..<-
+00051f00: 6d3e 2054 4558 5420 5b54 4558 5420 2e2e  m> TEXT [TEXT ..
+00051f10: 2e5d 2c20 3c2d 2d6d 6573 7361 6765 3e20  .], <--message> 
+00051f20: 5445 5854 205b 5445 5854 202e 2e2e 5d0a  TEXT [TEXT ...].
+00051f30: 5365 6e64 206f 6e65 206f 7220 6d75 6c74  Send one or mult
+00051f40: 6970 6c65 2074 6578 7420 6d65 7373 6167  iple text messag
+00051f50: 6573 2e0a 3c2d 693e 2049 4d41 4745 5f46  es..<-i> IMAGE_F
+00051f60: 494c 4520 5b49 4d41 4745 5f46 494c 4520  ILE [IMAGE_FILE 
+00051f70: 2e2e 2e5d 2c20 3c2d 2d69 6d61 6765 3e20  ...], <--image> 
+00051f80: 494d 4147 455f 4649 4c45 205b 494d 4147  IMAGE_FILE [IMAG
+00051f90: 455f 4649 4c45 202e 2e2e 5d0a 5365 6e64  E_FILE ...].Send
+00051fa0: 206f 6e65 206f 7220 6d75 6c74 6970 6c65   one or multiple
+00051fb0: 2069 6d61 6765 2066 696c 6573 2e0a 3c2d   image files..<-
+00051fc0: 613e 2041 5544 494f 5f46 494c 4520 5b41  a> AUDIO_FILE [A
+00051fd0: 5544 494f 5f46 494c 4520 2e2e 2e5d 2c20  UDIO_FILE ...], 
+00051fe0: 3c2d 2d61 7564 696f 3e20 4155 4449 4f5f  <--audio> AUDIO_
+00051ff0: 4649 4c45 205b 4155 4449 4f5f 4649 4c45  FILE [AUDIO_FILE
+00052000: 202e 2e2e 5d0a 5365 6e64 206f 6e65 206f   ...].Send one o
+00052010: 7220 6d75 6c74 6970 6c65 2061 7564 696f  r multiple audio
+00052020: 2066 696c 6573 2e0a 3c2d 663e 2046 494c   files..<-f> FIL
+00052030: 4520 5b46 494c 4520 2e2e 2e5d 2c20 3c2d  E [FILE ...], <-
+00052040: 2d66 696c 653e 2046 494c 4520 5b46 494c  -file> FILE [FIL
+00052050: 4520 2e2e 2e5d 0a53 656e 6420 6f6e 6520  E ...].Send one 
+00052060: 6f72 206d 756c 7469 706c 6520 6669 6c65  or multiple file
+00052070: 7320 2865 2e67 2e20 5044 462c 2044 4f43  s (e.g. PDF, DOC
+00052080: 2c20 4d50 3429 2e0a 3c2d 653e 204d 4154  , MP4)..<-e> MAT
+00052090: 5249 585f 4a53 4f4e 5f4f 424a 4543 5420  RIX_JSON_OBJECT 
+000520a0: 5b4d 4154 5249 585f 4a53 4f4e 5f4f 424a  [MATRIX_JSON_OBJ
+000520b0: 4543 5420 2e2e 2e5d 2c20 3c2d 2d65 7665  ECT ...], <--eve
+000520c0: 6e74 3e20 4d41 5452 4958 5f4a 534f 4e5f  nt> MATRIX_JSON_
+000520d0: 4f42 4a45 4354 205b 4d41 5452 4958 5f4a  OBJECT [MATRIX_J
+000520e0: 534f 4e5f 4f42 4a45 4354 202e 2e2e 5d0a  SON_OBJECT ...].
+000520f0: 5365 6e64 2061 204d 6174 7269 7820 4a53  Send a Matrix JS
+00052100: 4f4e 2065 7665 6e74 2e0a 3c2d 773e 2c20  ON event..<-w>, 
+00052110: 3c2d 2d68 746d 6c3e 0a53 656e 6420 6d65  <--html>.Send me
+00052120: 7373 6167 6520 6173 2066 6f72 6d61 7420  ssage as format 
+00052130: 2248 544d 4c22 2e0a 3c2d 7a3e 2c20 3c2d  "HTML"..<-z>, <-
+00052140: 2d6d 6172 6b64 6f77 6e3e 0a53 656e 6420  -markdown>.Send 
+00052150: 6d65 7373 6167 6520 6173 2066 6f72 6d61  message as forma
+00052160: 7420 224d 4152 4b44 4f57 4e22 2e0a 3c2d  t "MARKDOWN"..<-
+00052170: 6b3e 2c20 3c2d 2d63 6f64 653e 0a53 656e  k>, <--code>.Sen
+00052180: 6420 6d65 7373 6167 6520 6173 2066 6f72  d message as for
+00052190: 6d61 7420 2243 4f44 4522 2e0a 3c2d 6a3e  mat "CODE"..<-j>
+000521a0: 2c20 3c2d 2d65 6d6f 6a69 7a65 3e0a 5365  , <--emojize>.Se
+000521b0: 6e64 206d 6573 7361 6765 2061 6674 6572  nd message after
+000521c0: 2065 6d6f 6a69 7a69 6e67 2e0a 3c2d 703e   emojizing..<-p>
+000521d0: 2053 4550 4152 4154 4f52 2c20 3c2d 2d73   SEPARATOR, <--s
+000521e0: 706c 6974 3e20 5345 5041 5241 544f 520a  plit> SEPARATOR.
+000521f0: 5370 6c69 7420 6d65 7373 6167 6520 7465  Split message te
+00052200: 7874 2069 6e74 6f20 6d75 6c74 6970 6c65  xt into multiple
+00052210: 204d 6174 7269 7820 6d65 7373 6167 6573   Matrix messages
+00052220: 2e0a 3c2d 2d63 6f6e 6669 673e 2043 4f4e  ..<--config> CON
+00052230: 4649 475f 4649 4c45 0a53 7065 6369 6679  FIG_FILE.Specify
+00052240: 2074 6865 206c 6f63 6174 696f 6e20 6f66   the location of
+00052250: 2061 2063 6f6e 6669 6720 6669 6c65 2e0a   a config file..
+00052260: 3c2d 2d70 726f 7879 3e20 5052 4f58 590a  <--proxy> PROXY.
+00052270: 5370 6563 6966 7920 6120 7072 6f78 7920  Specify a proxy 
+00052280: 666f 7220 636f 6e6e 6563 7469 7669 7479  for connectivity
+00052290: 2e0a 3c2d 6e3e 2c20 3c2d 2d6e 6f74 6963  ..<-n>, <--notic
+000522a0: 653e 0a53 656e 6420 6d65 7373 6167 6520  e>.Send message 
+000522b0: 6173 206e 6f74 6963 652e 0a3c 2d2d 656e  as notice..<--en
+000522c0: 6372 7970 7465 643e 0a53 656e 6420 6d65  crypted>.Send me
+000522d0: 7373 6167 6520 656e 642d 746f 2d65 6e64  ssage end-to-end
+000522e0: 2065 6e63 7279 7074 6564 2e0a 3c2d 6c3e   encrypted..<-l>
+000522f0: 205b 4e45 5645 527c 4f4e 4345 7c46 4f52   [NEVER|ONCE|FOR
+00052300: 4556 4552 7c54 4149 4c7c 414c 4c5d 2c20  EVER|TAIL|ALL], 
+00052310: 3c2d 2d6c 6973 7465 6e3e 205b 4e45 5645  <--listen> [NEVE
+00052320: 527c 4f4e 4345 7c46 4f52 4556 4552 7c54  R|ONCE|FOREVER|T
+00052330: 4149 4c7c 414c 4c5d 0a50 7269 6e74 2072  AIL|ALL].Print r
+00052340: 6563 6569 7665 6420 6d65 7373 6167 6573  eceived messages
+00052350: 2061 6e64 206c 6973 7465 6e20 746f 206d   and listen to m
+00052360: 6573 7361 6765 732e 0a3c 2d74 3e20 5b4e  essages..<-t> [N
+00052370: 554d 4245 525d 2c20 3c2d 2d74 6169 6c3e  UMBER], <--tail>
+00052380: 205b 4e55 4d42 4552 5d0a 5072 696e 7420   [NUMBER].Print 
+00052390: 6c61 7374 206d 6573 7361 6765 732e 0a3c  last messages..<
+000523a0: 2d79 3e2c 203c 2d2d 6c69 7374 656e 2d73  -y>, <--listen-s
+000523b0: 656c 663e 0a50 7269 6e74 2079 6f75 7220  elf>.Print your 
+000523c0: 6f77 6e20 6d65 7373 6167 6573 2061 7320  own messages as 
+000523d0: 7765 6c6c 2e0a 3c2d 2d70 7269 6e74 2d65  well..<--print-e
+000523e0: 7665 6e74 2d69 643e 0a50 7269 6e74 2065  vent-id>.Print e
+000523f0: 7665 6e74 2069 6473 206f 6620 7265 6365  vent ids of rece
+00052400: 6976 6564 206d 6573 7361 6765 732e 0a3c  ived messages..<
+00052410: 2d2d 646f 776e 6c6f 6164 2d6d 6564 6961  --download-media
+00052420: 3e20 5b44 4f57 4e4c 4f41 445f 4449 5245  > [DOWNLOAD_DIRE
+00052430: 4354 4f52 595d 0a44 6f77 6e6c 6f61 6420  CTORY].Download 
+00052440: 6d65 6469 6120 6669 6c65 7320 7768 696c  media files whil
+00052450: 6520 6c69 7374 656e 696e 672e 0a3c 2d2d  e listening..<--
+00052460: 6f73 2d6e 6f74 6966 793e 0a4e 6f74 6966  os-notify>.Notif
+00052470: 7920 6d65 206f 6620 6172 7269 7669 6e67  y me of arriving
+00052480: 206d 6573 7361 6765 732e 0a3c 2d2d 7365   messages..<--se
+00052490: 742d 6465 7669 6365 2d6e 616d 653e 2044  t-device-name> D
+000524a0: 4556 4943 455f 4e41 4d45 0a53 6574 206f  EVICE_NAME.Set o
+000524b0: 7220 7265 6e61 6d65 2074 6865 2063 7572  r rename the cur
+000524c0: 7265 6e74 2064 6576 6963 652e 0a3c 2d2d  rent device..<--
+000524d0: 7365 742d 6469 7370 6c61 792d 6e61 6d65  set-display-name
+000524e0: 3e20 4449 5350 4c41 595f 4e41 4d45 0a53  > DISPLAY_NAME.S
+000524f0: 6574 206f 7220 7265 6e61 6d65 2074 6865  et or rename the
+00052500: 2064 6973 706c 6179 206e 616d 652e 0a3c   display name..<
+00052510: 2d2d 6765 742d 6469 7370 6c61 792d 6e61  --get-display-na
+00052520: 6d65 3e0a 4765 7420 7468 6520 6469 7370  me>.Get the disp
+00052530: 6c61 7920 6e61 6d65 206f 6620 796f 7572  lay name of your
+00052540: 7365 6c66 2e0a 3c2d 2d73 6574 2d70 7265  self..<--set-pre
+00052550: 7365 6e63 653e 204f 4e4c 494e 457c 4f46  sence> ONLINE|OF
+00052560: 464c 494e 457c 554e 4156 4149 4c41 424c  FLINE|UNAVAILABL
+00052570: 450a 5365 7420 796f 7572 2070 7265 7365  E.Set your prese
+00052580: 6e63 652e 0a3c 2d2d 6765 742d 7072 6573  nce..<--get-pres
+00052590: 656e 6365 3e0a 4765 7420 796f 7572 2070  ence>.Get your p
+000525a0: 7265 7365 6e63 652e 0a3c 2d2d 7570 6c6f  resence..<--uplo
+000525b0: 6164 3e20 4649 4c45 205b 4649 4c45 202e  ad> FILE [FILE .
+000525c0: 2e2e 5d0a 5570 6c6f 6164 206f 6e65 206f  ..].Upload one o
+000525d0: 7220 6d75 6c74 6970 6c65 2066 696c 6573  r multiple files
+000525e0: 2074 6f20 7468 6520 636f 6e74 656e 7420   to the content 
+000525f0: 7265 706f 7369 746f 7279 2e0a 3c2d 2d64  repository..<--d
+00052600: 6f77 6e6c 6f61 643e 204d 5843 5f55 5249  ownload> MXC_URI
+00052610: 205b 4d58 435f 5552 4920 2e2e 2e5d 0a44   [MXC_URI ...].D
+00052620: 6f77 6e6c 6f61 6420 6f6e 6520 6f72 206d  ownload one or m
+00052630: 756c 7469 706c 6520 6669 6c65 7320 6672  ultiple files fr
+00052640: 6f6d 2074 6865 2063 6f6e 7465 6e74 2072  om the content r
+00052650: 6570 6f73 6974 6f72 792e 0a3c 2d2d 6465  epository..<--de
+00052660: 6c65 7465 2d6d 7863 3e20 4d58 435f 5552  lete-mxc> MXC_UR
+00052670: 4920 5b4d 5843 5f55 5249 202e 2e2e 5d0a  I [MXC_URI ...].
+00052680: 4465 6c65 7465 206f 6e65 206f 7220 6d75  Delete one or mu
+00052690: 6c74 6970 6c65 206f 626a 6563 7473 2066  ltiple objects f
+000526a0: 726f 6d20 7468 6520 636f 6e74 656e 7420  rom the content 
+000526b0: 7265 706f 7369 746f 7279 2e0a 3c2d 2d64  repository..<--d
+000526c0: 656c 6574 652d 6d78 632d 6265 666f 7265  elete-mxc-before
+000526d0: 3e20 5449 4d45 5354 414d 5020 5b54 494d  > TIMESTAMP [TIM
+000526e0: 4553 5441 4d50 202e 2e2e 5d0a 4465 6c65  ESTAMP ...].Dele
+000526f0: 7465 206f 6c64 206f 626a 6563 7473 2066  te old objects f
+00052700: 726f 6d20 7468 6520 636f 6e74 656e 7420  rom the content 
+00052710: 7265 706f 7369 746f 7279 0a3c 2d2d 6a6f  repository.<--jo
+00052720: 696e 6564 2d72 6f6f 6d73 3e0a 5072 696e  ined-rooms>.Prin
+00052730: 7420 7468 6520 6c69 7374 206f 6620 6a6f  t the list of jo
+00052740: 696e 6564 2072 6f6f 6d73 2e0a 3c2d 2d6a  ined rooms..<--j
+00052750: 6f69 6e65 642d 6d65 6d62 6572 733e 2052  oined-members> R
+00052760: 4f4f 4d20 5b52 4f4f 4d20 2e2e 2e5d 0a50  OOM [ROOM ...].P
+00052770: 7269 6e74 2074 6865 206c 6973 7420 6f66  rint the list of
+00052780: 206a 6f69 6e65 6420 6d65 6d62 6572 7320   joined members 
+00052790: 666f 7220 6f6e 6520 6f72 206d 756c 7469  for one or multi
+000527a0: 706c 6520 726f 6f6d 732e 0a3c 2d2d 6d78  ple rooms..<--mx
+000527b0: 632d 746f 2d68 7474 703e 204d 5843 5f55  c-to-http> MXC_U
+000527c0: 5249 205b 4d58 435f 5552 4920 2e2e 2e5d  RI [MXC_URI ...]
+000527d0: 0a43 6f6e 7665 7274 204d 5843 2055 5249  .Convert MXC URI
+000527e0: 7320 746f 2048 5454 5020 5552 4c73 2e0a  s to HTTP URLs..
+000527f0: 3c2d 2d64 6576 6963 6573 2c3e 203c 2d2d  <--devices,> <--
+00052800: 6765 742d 6465 7669 6365 733e 0a50 7269  get-devices>.Pri
+00052810: 6e74 2074 6865 206c 6973 7420 6f66 2064  nt the list of d
+00052820: 6576 6963 6573 2e0a 3c2d 2d64 6973 636f  evices..<--disco
+00052830: 7665 7279 2d69 6e66 6f3e 0a50 7269 6e74  very-info>.Print
+00052840: 2064 6973 636f 7665 7279 2069 6e66 6f72   discovery infor
+00052850: 6d61 7469 6f6e 2061 626f 7574 2063 7572  mation about cur
+00052860: 7265 6e74 2068 6f6d 6573 6572 7665 722e  rent homeserver.
+00052870: 0a3c 2d2d 6c6f 6769 6e2d 696e 666f 3e0a  .<--login-info>.
+00052880: 5072 696e 7420 6c6f 6769 6e20 6d65 7468  Print login meth
+00052890: 6f64 7320 7375 7070 6f72 7465 6420 6279  ods supported by
+000528a0: 2074 6865 2068 6f6d 6573 6572 7665 722e   the homeserver.
+000528b0: 0a3c 2d2d 636f 6e74 656e 742d 7265 706f  .<--content-repo
+000528c0: 7369 746f 7279 2d63 6f6e 6669 673e 0a50  sitory-config>.P
+000528d0: 7269 6e74 2074 6865 2063 6f6e 7465 6e74  rint the content
+000528e0: 2072 6570 6f73 6974 6f72 7920 636f 6e66   repository conf
+000528f0: 6967 7572 6174 696f 6e2e 0a3c 2d2d 7265  iguration..<--re
+00052900: 7374 3e20 5245 5354 5f4d 4554 484f 4420  st> REST_METHOD 
+00052910: 4441 5441 2055 524c 205b 5245 5354 5f4d  DATA URL [REST_M
+00052920: 4554 484f 4420 4441 5441 2055 524c 202e  ETHOD DATA URL .
+00052930: 2e2e 5d0a 5573 6520 7468 6520 4d61 7472  ..].Use the Matr
+00052940: 6978 2043 6c69 656e 7420 5245 5354 2041  ix Client REST A
+00052950: 5049 2e0a 3c2d 2d73 6574 2d61 7661 7461  PI..<--set-avata
+00052960: 723e 2041 5641 5441 525f 4d58 435f 5552  r> AVATAR_MXC_UR
+00052970: 490a 5365 7420 796f 7572 2061 7661 7461  I.Set your avata
+00052980: 722e 0a3c 2d2d 6765 742d 6176 6174 6172  r..<--get-avatar
+00052990: 3e20 5b55 5345 5220 2e2e 2e5d 0a47 6574  > [USER ...].Get
+000529a0: 2061 6e20 6176 6174 6172 2e0a 3c2d 2d67   an avatar..<--g
+000529b0: 6574 2d70 726f 6669 6c65 3e20 5b55 5345  et-profile> [USE
+000529c0: 5220 2e2e 2e5d 0a47 6574 2061 2075 7365  R ...].Get a use
+000529d0: 7220 7072 6f66 696c 652e 0a3c 2d2d 6765  r profile..<--ge
+000529e0: 742d 726f 6f6d 2d69 6e66 6f3e 205b 524f  t-room-info> [RO
+000529f0: 4f4d 202e 2e2e 5d0a 4765 7420 7468 6520  OM ...].Get the 
+00052a00: 726f 6f6d 2069 6e66 6f72 6d61 7469 6f6e  room information
+00052a10: 2e0a 3c2d 2d67 6574 2d63 6c69 656e 742d  ..<--get-client-
+00052a20: 696e 666f 3e0a 5072 696e 7420 636c 6965  info>.Print clie
+00052a30: 6e74 2069 6e66 6f72 6d61 7469 6f6e 2e0a  nt information..
+00052a40: 3c2d 2d68 6173 2d70 6572 6d69 7373 696f  <--has-permissio
+00052a50: 6e3e 2052 4f4f 4d20 4241 4e7c 494e 5649  n> ROOM BAN|INVI
+00052a60: 5445 7c4b 4943 4b7c 4e4f 5449 4649 4341  TE|KICK|NOTIFICA
+00052a70: 5449 4f4e 537c 5245 4441 4354 7c65 7463  TIONS|REDACT|etc
+00052a80: 205b 524f 4f4d 2042 414e 7c49 4e56 4954   [ROOM BAN|INVIT
+00052a90: 457c 4b49 434b 7c4e 4f54 4946 4943 4154  E|KICK|NOTIFICAT
+00052aa0: 494f 4e53 7c52 4544 4143 547c 6574 6320  IONS|REDACT|etc 
+00052ab0: 2e2e 2e5d 0a49 6e71 7569 7265 2061 626f  ...].Inquire abo
+00052ac0: 7574 2070 6572 6d69 7373 696f 6e73 2e0a  ut permissions..
+00052ad0: 3c2d 2d69 6d70 6f72 742d 6b65 7973 3e20  <--import-keys> 
+00052ae0: 4649 4c45 2050 4153 5350 4852 4153 4520  FILE PASSPHRASE 
+00052af0: 4649 4c45 2050 4153 5350 4852 4153 450a  FILE PASSPHRASE.
+00052b00: 496d 706f 7274 204d 6567 6f6c 6d20 6465  Import Megolm de
+00052b10: 6372 7970 7469 6f6e 206b 6579 7320 6672  cryption keys fr
+00052b20: 6f6d 2061 2066 696c 652e 0a3c 2d2d 6578  om a file..<--ex
+00052b30: 706f 7274 2d6b 6579 733e 2046 494c 4520  port-keys> FILE 
+00052b40: 5041 5353 5048 5241 5345 2046 494c 4520  PASSPHRASE FILE 
+00052b50: 5041 5353 5048 5241 5345 0a45 7870 6f72  PASSPHRASE.Expor
+00052b60: 7420 616c 6c20 7468 6520 4d65 676f 6c6d  t all the Megolm
+00052b70: 2064 6563 7279 7074 696f 6e20 6b65 7973   decryption keys
+00052b80: 206f 6620 7468 6973 2064 6576 6963 652e   of this device.
+00052b90: 0a3c 2d2d 726f 6f6d 2d73 6574 2d61 6c69  .<--room-set-ali
+00052ba0: 6173 3e20 524f 4f4d 5f41 4c49 4153 2052  as> ROOM_ALIAS R
+00052bb0: 4f4f 4d20 5b52 4f4f 4d5f 414c 4941 5320  OOM [ROOM_ALIAS 
+00052bc0: 524f 4f4d 202e 2e2e 5d2c 203c 2d2d 726f  ROOM ...], <--ro
+00052bd0: 6f6d 2d70 7574 2d61 6c69 6173 3e20 524f  om-put-alias> RO
+00052be0: 4f4d 5f41 4c49 4153 2052 4f4f 4d20 5b52  OM_ALIAS ROOM [R
+00052bf0: 4f4f 4d5f 414c 4941 5320 524f 4f4d 202e  OOM_ALIAS ROOM .
+00052c00: 2e2e 5d0a 4164 6420 616c 6961 7365 7320  ..].Add aliases 
+00052c10: 746f 2072 6f6f 6d73 2e0a 3c2d 2d72 6f6f  to rooms..<--roo
+00052c20: 6d2d 7265 736f 6c76 652d 616c 6961 733e  m-resolve-alias>
+00052c30: 2052 4f4f 4d5f 414c 4941 5320 5b52 4f4f   ROOM_ALIAS [ROO
+00052c40: 4d5f 414c 4941 5320 2e2e 2e5d 0a53 686f  M_ALIAS ...].Sho
+00052c50: 7720 726f 6f6d 2069 6473 2063 6f72 7265  w room ids corre
+00052c60: 7370 6f6e 6469 6e67 2074 6f20 726f 6f6d  sponding to room
+00052c70: 2061 6c69 6173 6573 2e0a 3c2d 2d72 6f6f   aliases..<--roo
+00052c80: 6d2d 6465 6c65 7465 2d61 6c69 6173 3e20  m-delete-alias> 
+00052c90: 524f 4f4d 5f41 4c49 4153 205b 524f 4f4d  ROOM_ALIAS [ROOM
+00052ca0: 5f41 4c49 4153 202e 2e2e 5d0a 4465 6c65  _ALIAS ...].Dele
+00052cb0: 7465 206f 6e65 206f 7220 6d75 6c74 6970  te one or multip
+00052cc0: 6c65 2072 6f6f 6d73 2061 6c69 6173 6573  le rooms aliases
+00052cd0: 2e0a 3c2d 2d67 6574 2d6f 7065 6e69 642d  ..<--get-openid-
+00052ce0: 746f 6b65 6e3e 205b 5553 4552 202e 2e2e  token> [USER ...
+00052cf0: 5d0a 4765 7420 616e 204f 7065 6e49 4420  ].Get an OpenID 
+00052d00: 746f 6b65 6e2e 0a3c 2d2d 726f 6f6d 2d67  token..<--room-g
+00052d10: 6574 2d76 6973 6962 696c 6974 793e 205b  et-visibility> [
+00052d20: 524f 4f4d 202e 2e2e 5d0a 4765 7420 7468  ROOM ...].Get th
+00052d30: 6520 7669 7369 6269 6c69 7479 206f 6620  e visibility of 
+00052d40: 6f6e 6520 6f72 206d 6f72 6520 726f 6f6d  one or more room
+00052d50: 732e 0a3c 2d2d 726f 6f6d 2d67 6574 2d73  s..<--room-get-s
+00052d60: 7461 7465 3e20 5b52 4f4f 4d20 2e2e 2e5d  tate> [ROOM ...]
+00052d70: 0a47 6574 2074 6865 2073 7461 7465 206f  .Get the state o
+00052d80: 6620 6f6e 6520 6f72 206d 6f72 6520 726f  f one or more ro
+00052d90: 6f6d 732e 0a3c 2d2d 6465 6c65 7465 2d64  oms..<--delete-d
+00052da0: 6576 6963 653e 2044 4556 4943 4520 5b44  evice> DEVICE [D
+00052db0: 4556 4943 4520 2e2e 2e5d 0a44 656c 6574  EVICE ...].Delet
+00052dc0: 6520 6f6e 6520 6f72 206d 756c 7469 706c  e one or multipl
+00052dd0: 6520 6465 7669 6365 732e 0a3c 2d2d 726f  e devices..<--ro
+00052de0: 6f6d 2d72 6564 6163 743e 2052 4f4f 4d5f  om-redact> ROOM_
+00052df0: 4944 2045 5645 4e54 5f49 4420 5245 4153  ID EVENT_ID REAS
+00052e00: 4f4e 205b 524f 4f4d 5f49 4420 4556 454e  ON [ROOM_ID EVEN
+00052e10: 545f 4944 2052 4541 534f 4e20 2e2e 2e5d  T_ID REASON ...]
+00052e20: 2c20 3c2d 2d72 6f6f 6d2d 6465 6c65 7465  , <--room-delete
+00052e30: 2d63 6f6e 7465 6e74 3e20 524f 4f4d 5f49  -content> ROOM_I
+00052e40: 4420 4556 454e 545f 4944 2052 4541 534f  D EVENT_ID REASO
+00052e50: 4e20 5b52 4f4f 4d5f 4944 2045 5645 4e54  N [ROOM_ID EVENT
+00052e60: 5f49 4420 5245 4153 4f4e 202e 2e2e 5d0a  _ID REASON ...].
+00052e70: 5374 7269 7020 696e 666f 726d 6174 696f  Strip informatio
+00052e80: 6e20 6f75 7420 6f66 206f 6e65 206f 7220  n out of one or 
+00052e90: 7365 7665 7261 6c20 6576 656e 7473 2e0a  several events..
+00052ea0: 3c2d 2d77 686f 616d 693e 0a50 7269 6e74  <--whoami>.Print
+00052eb0: 2079 6f75 7220 7573 6572 2069 642e 0a3c   your user id..<
+00052ec0: 2d2d 6e6f 2d73 736c 3e0a 536b 6970 2053  --no-ssl>.Skip S
+00052ed0: 534c 2076 6572 6966 6963 6174 696f 6e2e  SL verification.
+00052ee0: 0a3c 2d2d 7373 6c2d 6365 7274 6966 6963  .<--ssl-certific
+00052ef0: 6174 653e 2053 534c 5f43 4552 5449 4649  ate> SSL_CERTIFI
+00052f00: 4341 5445 5f46 494c 450a 5573 6520 796f  CATE_FILE.Use yo
+00052f10: 7572 206f 776e 2053 534c 2063 6572 7469  ur own SSL certi
+00052f20: 6669 6361 7465 2e0a 3c2d 2d66 696c 652d  ficate..<--file-
+00052f30: 6e61 6d65 3e20 4649 4c45 205b 4649 4c45  name> FILE [FILE
+00052f40: 202e 2e2e 5d0a 5370 6563 6966 7920 6f6e   ...].Specify on
+00052f50: 6520 6f72 206d 756c 7469 706c 6520 6669  e or multiple fi
+00052f60: 6c65 206e 616d 6573 2066 6f72 2073 6f6d  le names for som
+00052f70: 6520 6163 7469 6f6e 732e 0a3c 2d2d 6b65  e actions..<--ke
+00052f80: 792d 6469 6374 3e20 4b45 595f 4449 4354  y-dict> KEY_DICT
+00052f90: 494f 4e41 5259 205b 4b45 595f 4449 4354  IONARY [KEY_DICT
+00052fa0: 494f 4e41 5259 202e 2e2e 5d0a 5370 6563  IONARY ...].Spec
+00052fb0: 6966 7920 6f6e 6520 6f72 206d 756c 7469  ify one or multi
+00052fc0: 706c 6520 6b65 7920 6469 6374 696f 6e61  ple key dictiona
+00052fd0: 7269 6573 2066 6f72 2064 6563 7279 7074  ries for decrypt
+00052fe0: 696f 6e2e 0a3c 2d2d 706c 6169 6e3e 0a44  ion..<--plain>.D
+00052ff0: 6973 6162 6c65 2065 6e63 7279 7074 696f  isable encryptio
+00053000: 6e20 666f 7220 6120 7370 6563 6966 6963  n for a specific
+00053010: 2061 6374 696f 6e2e 0a3c 2d2d 7365 7061   action..<--sepa
+00053020: 7261 746f 723e 2053 4550 4152 4154 4f52  rator> SEPARATOR
+00053030: 0a53 6574 2061 2063 7573 746f 6d20 7365  .Set a custom se
+00053040: 7061 7261 746f 7220 7573 6564 2066 6f72  parator used for
+00053050: 2063 6572 7461 696e 2070 7269 6e74 206f   certain print o
+00053060: 7574 732e 0a3c 2d2d 6163 6365 7373 2d74  uts..<--access-t
+00053070: 6f6b 656e 3e20 4143 4345 5353 5f54 4f4b  oken> ACCESS_TOK
+00053080: 454e 0a53 6574 2061 2063 7573 746f 6d20  EN.Set a custom 
+00053090: 6163 6365 7373 2074 6f6b 656e 2066 6f72  access token for
+000530a0: 2075 7365 2062 7920 6365 7274 6169 6e20   use by certain 
+000530b0: 6163 7469 6f6e 732e 0a3c 2d2d 7061 7373  actions..<--pass
+000530c0: 776f 7264 3e20 5041 5353 574f 5244 0a53  word> PASSWORD.S
+000530d0: 7065 6369 6679 2061 2070 6173 7377 6f72  pecify a passwor
+000530e0: 6420 666f 7220 7573 6520 6279 2063 6572  d for use by cer
+000530f0: 7461 696e 2061 6374 696f 6e73 2e0a 3c2d  tain actions..<-
+00053100: 2d68 6f6d 6573 6572 7665 723e 2048 4f4d  -homeserver> HOM
+00053110: 4553 4552 5645 525f 5552 4c0a 5370 6563  ESERVER_URL.Spec
+00053120: 6966 7920 6120 686f 6d65 7365 7276 6572  ify a homeserver
+00053130: 2066 6f72 2075 7365 2062 7920 6365 7274   for use by cert
+00053140: 6169 6e20 6163 7469 6f6e 732e 0a3c 2d2d  ain actions..<--
+00053150: 6465 7669 6365 3e20 4445 5649 4345 5f4e  device> DEVICE_N
+00053160: 414d 450a 5370 6563 6966 7920 6120 6465  AME.Specify a de
+00053170: 7669 6365 206e 616d 652c 2066 6f72 2075  vice name, for u
+00053180: 7365 2062 7920 6365 7274 6169 6e20 6163  se by certain ac
+00053190: 7469 6f6e 732e 0a3c 2d2d 7379 6e63 3e20  tions..<--sync> 
+000531a0: 4655 4c4c 7c4f 4646 0a43 686f 6f73 6520  FULL|OFF.Choose 
+000531b0: 7379 6e63 6872 6f6e 697a 6174 696f 6e20  synchronization 
+000531c0: 6f70 7469 6f6e 732e 0a3c 2d6f 3e20 5445  options..<-o> TE
+000531d0: 5854 7c4a 534f 4e7c 4a53 4f4e 2d4d 4158  XT|JSON|JSON-MAX
+000531e0: 7c4a 534f 4e2d 5350 4543 2c20 3c2d 2d6f  |JSON-SPEC, <--o
+000531f0: 7574 7075 743e 2054 4558 547c 4a53 4f4e  utput> TEXT|JSON
+00053200: 7c4a 534f 4e2d 4d41 587c 4a53 4f4e 2d53  |JSON-MAX|JSON-S
+00053210: 5045 430a 5365 6c65 6374 2061 6e20 6f75  PEC.Select an ou
+00053220: 7470 7574 2066 6f72 6d61 742e 0a3c 2d76  tput format..<-v
+00053230: 3e20 5b50 5249 4e54 7c43 4845 434b 5d2c  > [PRINT|CHECK],
+00053240: 202d 5620 5b50 5249 4e54 7c43 4845 434b   -V [PRINT|CHECK
+00053250: 5d2c 203c 2d2d 7665 7273 696f 6e3e 205b  ], <--version> [
+00053260: 5052 494e 547c 4348 4543 4b5d 0a50 7269  PRINT|CHECK].Pri
+00053270: 6e74 2076 6572 7369 6f6e 2069 6e66 6f72  nt version infor
+00053280: 6d61 7469 6f6e 206f 7220 6368 6563 6b20  mation or check 
+00053290: 666f 7220 7570 6461 7465 732e 0a22 2222  for updates.."""
+000532a0: 2e72 6570 6c61 6365 280a 2020 2020 2020  .replace(.      
+000532b0: 2020 2020 2020 223c 222c 2065 6f6e 0a20        "<", eon. 
+000532c0: 2020 2020 2020 2029 2e72 6570 6c61 6365         ).replace
+000532d0: 280a 2020 2020 2020 2020 2020 2020 223e  (.            ">
+000532e0: 222c 2065 6f66 660a 2020 2020 2020 2020  ", eoff.        
+000532f0: 290a 2020 2020 2020 2020 6865 6164 6572  ).        header
+00053300: 203d 2046 616c 7365 2020 2320 6669 7273   = False  # firs
+00053310: 7420 6c69 6e65 2069 7320 6e65 776c 696e  t line is newlin
+00053320: 650a 2020 2020 2020 2020 666f 7220 6c69  e.        for li
+00053330: 6e65 2069 6e20 6865 6c70 5f68 656c 705f  ne in help_help_
+00053340: 7072 652e 7370 6c69 7428 225c 6e22 293a  pre.split("\n"):
+00053350: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00053360: 6865 6164 6572 3a0a 2020 2020 2020 2020  header:.        
+00053370: 2020 2020 2020 2020 7072 696e 7428 0a20          print(. 
+00053380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053390: 2020 2074 6578 7477 7261 702e 6669 6c6c     textwrap.fill
+000533a0: 2863 6f6e 202b 206c 696e 6520 2b20 636f  (con + line + co
+000533b0: 6666 2c20 7769 6474 683d 7465 726d 5f77  ff, width=term_w
+000533c0: 6964 7468 292c 0a20 2020 2020 2020 2020  idth),.         
+000533d0: 2020 2020 2020 2020 2020 2066 6c75 7368             flush
+000533e0: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
+000533f0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00053400: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00053410: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00053420: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00053430: 2020 2020 2020 7465 7874 7772 6170 2e69        textwrap.i
+00053440: 6e64 656e 7428 0a20 2020 2020 2020 2020  ndent(.         
+00053450: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00053460: 6578 7477 7261 702e 6669 6c6c 286c 696e  extwrap.fill(lin
+00053470: 652c 2077 6964 7468 3d74 6572 6d5f 7769  e, width=term_wi
+00053480: 6474 6820 2d20 3229 2c20 2220 2022 0a20  dth - 2), "  ". 
+00053490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000534a0: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
+000534b0: 2020 2020 2020 2020 2020 666c 7573 683d            flush=
+000534c0: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+000534d0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+000534e0: 2020 2020 2068 6561 6465 7220 3d20 6e6f       header = no
+000534f0: 7420 6865 6164 6572 0a20 2020 2020 2020  t header.       
+00053500: 2023 2070 7269 6e74 2822 2229 0a20 2020   # print("").   
+00053510: 2020 2020 2070 7269 6e74 2874 6578 7477       print(textw
+00053520: 7261 702e 6669 6c6c 2861 702e 6570 696c  rap.fill(ap.epil
+00053530: 6f67 2c20 7769 6474 683d 7465 726d 5f77  og, width=term_w
+00053540: 6964 7468 2929 0a20 2020 2020 2020 2072  idth)).        r
+00053550: 6574 7572 6e20 300a 2020 2020 6966 2067  eturn 0.    if g
+00053560: 732e 7061 2e6d 616e 7561 6c3a 0a20 2020  s.pa.manual:.   
+00053570: 2020 2020 2064 6573 6372 6970 7469 6f6e       description
+00053580: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+00053590: 2066 2257 656c 636f 6d65 2074 6f20 7b50   f"Welcome to {P
+000535a0: 524f 475f 5749 5448 4f55 545f 4558 547d  ROG_WITHOUT_EXT}
+000535b0: 2c20 6120 4d61 7472 6978 2043 4c49 2063  , a Matrix CLI c
+000535c0: 6c69 656e 742e 20e2 9480 e294 80e2 9480  lient. .........
+000535d0: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
+000535e0: 4f6e 2066 6972 7374 2072 756e 2075 7365  On first run use
+000535f0: 202d 2d6c 6f67 696e 2074 6f20 6c6f 6720   --login to log 
+00053600: 696e 2c20 746f 2061 7574 6865 6e74 6963  in, to authentic
+00053610: 6174 652e 2022 0a20 2020 2020 2020 2020  ate. ".         
+00053620: 2020 2022 4f6e 2073 6563 6f6e 6420 7275     "On second ru
+00053630: 6e20 7765 2073 7567 6765 7374 2074 6f20  n we suggest to 
+00053640: 7573 6520 2d2d 7665 7269 6679 2074 6f20  use --verify to 
+00053650: 6765 7420 7665 7269 6669 6564 2e20 220a  get verified. ".
+00053660: 2020 2020 2020 2020 2020 2020 2245 6d6f              "Emo
+00053670: 6a69 2076 6572 6966 6963 6174 696f 6e20  ji verification 
+00053680: 6973 2062 7569 6c74 2d69 6e20 7768 6963  is built-in whic
+00053690: 6820 6361 6e20 6265 2075 7365 6420 220a  h can be used ".
+000536a0: 2020 2020 2020 2020 2020 2020 2274 6f20              "to 
+000536b0: 7665 7269 6679 2064 6576 6963 6573 2e20  verify devices. 
+000536c0: 220a 2020 2020 2020 2020 2020 2020 224f  ".            "O
+000536d0: 6e20 6675 7274 6865 7220 7275 6e73 2074  n further runs t
+000536e0: 6869 7320 7072 6f67 7261 6d20 696d 706c  his program impl
+000536f0: 656d 656e 7473 2061 2073 696d 706c 6520  ements a simple 
+00053700: 4d61 7472 6978 2043 4c49 2022 0a20 2020  Matrix CLI ".   
+00053710: 2020 2020 2020 2020 2022 636c 6965 6e74           "client
+00053720: 2074 6861 7420 6361 6e20 7365 6e64 206d   that can send m
+00053730: 6573 7361 6765 732c 206c 6973 7465 6e20  essages, listen 
+00053740: 746f 206d 6573 7361 6765 732c 2076 6572  to messages, ver
+00053750: 6966 7920 220a 2020 2020 2020 2020 2020  ify ".          
+00053760: 2020 2264 6576 6963 6573 2c20 6574 632e    "devices, etc.
+00053770: 2049 7420 6361 6e20 7365 6e64 206f 6e65   It can send one
+00053780: 206f 7220 6d75 6c74 6970 6c65 206d 6573   or multiple mes
+00053790: 7361 6765 2074 6f20 6f6e 6520 6f72 2022  sage to one or "
+000537a0: 0a20 2020 2020 2020 2020 2020 2022 6d75  .            "mu
+000537b0: 6c74 6970 6c65 204d 6174 7269 7820 726f  ltiple Matrix ro
+000537c0: 6f6d 7320 616e 642f 6f72 2075 7365 7273  oms and/or users
+000537d0: 2e20 5468 6520 7465 7874 206d 6573 7361  . The text messa
+000537e0: 6765 7320 6361 6e20 6265 2022 0a20 2020  ges can be ".   
+000537f0: 2020 2020 2020 2020 2022 6f66 2076 6172           "of var
+00053800: 696f 7573 2022 0a20 2020 2020 2020 2020  ious ".         
+00053810: 2020 2027 666f 726d 6174 7320 7375 6368     'formats such
+00053820: 2061 7320 2274 6578 7422 2c20 2268 746d   as "text", "htm
+00053830: 6c22 2c20 226d 6172 6b64 6f77 6e22 206f  l", "markdown" o
+00053840: 7220 2263 6f64 6522 2e20 270a 2020 2020  r "code". '.    
+00053850: 2020 2020 2020 2020 2249 6d61 6765 732c          "Images,
+00053860: 2061 7564 696f 2c20 6172 6269 7472 6172   audio, arbitrar
+00053870: 7920 6669 6c65 732c 206f 7220 6576 656e  y files, or even
+00053880: 7473 2063 616e 2062 6520 7365 6e74 2061  ts can be sent a
+00053890: 7320 7765 6c6c 2e20 220a 2020 2020 2020  s well. ".      
+000538a0: 2020 2020 2020 2246 6f72 2072 6563 6569        "For recei
+000538b0: 7669 6e67 2074 6865 7265 2061 7265 2074  ving there are t
+000538c0: 6872 6565 206d 6169 6e20 6f70 7469 6f6e  hree main option
+000538d0: 733a 206c 6973 7465 6e20 666f 7265 7665  s: listen foreve
+000538e0: 722c 2022 0a20 2020 2020 2020 2020 2020  r, ".           
+000538f0: 2022 6c69 7374 656e 206f 6e63 6520 616e   "listen once an
+00053900: 6420 7175 6974 2c20 616e 6420 6765 7420  d quit, and get 
+00053910: 7468 6520 6c61 7374 204e 206d 6573 7361  the last N messa
+00053920: 6765 7320 220a 2020 2020 2020 2020 2020  ges ".          
+00053930: 2020 2261 6e64 2071 7569 742e 2045 6e64    "and quit. End
+00053940: 2d74 6f2d 656e 6420 656e 6372 7970 7469  -to-end encrypti
+00053950: 6f6e 2069 7320 656e 6162 6c65 6420 6279  on is enabled by
+00053960: 2064 6566 6175 6c74 2022 0a20 2020 2020   default ".     
+00053970: 2020 2020 2020 2022 616e 6420 6361 6e6e         "and cann
+00053980: 6f74 2062 6520 7475 726e 6564 206f 6666  ot be turned off
+00053990: 2c20 6275 7420 6974 2063 616e 2062 6520  , but it can be 
+000539a0: 6469 7361 626c 6564 2066 6f72 2073 7065  disabled for spe
+000539b0: 6369 6669 6320 220a 2020 2020 2020 2020  cific ".        
+000539c0: 2020 2020 2275 7365 2063 6173 6573 2e20      "use cases. 
+000539d0: 20e2 9480 e294 80e2 9480 2022 0a20 2020   ......... ".   
+000539e0: 2020 2020 2020 2020 2022 4275 6e64 6c69           "Bundli
+000539f0: 6e67 2073 6576 6572 616c 2061 6374 696f  ng several actio
+00053a00: 6e73 2074 6f67 6574 6865 7220 696e 746f  ns together into
+00053a10: 2061 2073 696e 676c 6520 6361 6c6c 2074   a single call t
+00053a20: 6f20 220a 2020 2020 2020 2020 2020 2020  o ".            
+00053a30: 6622 7b50 524f 475f 5749 5448 4f55 545f  f"{PROG_WITHOUT_
+00053a40: 4558 547d 2069 7320 6661 7374 6572 2074  EXT} is faster t
+00053a50: 6861 6e20 6361 6c6c 696e 6720 7b50 524f  han calling {PRO
+00053a60: 475f 5749 5448 4f55 545f 4558 547d 2022  G_WITHOUT_EXT} "
+00053a70: 0a20 2020 2020 2020 2020 2020 2022 6d75  .            "mu
+00053a80: 6c74 6970 6c65 2074 696d 6573 2077 6974  ltiple times wit
+00053a90: 6820 6f6e 6c79 206f 6e65 2061 6374 696f  h only one actio
+00053aa0: 6e2e 2049 6620 7468 6572 6520 6172 6520  n. If there are 
+00053ab0: 626f 7468 2027 7365 7427 2022 0a20 2020  both 'set' ".   
+00053ac0: 2020 2020 2020 2020 2022 616e 6420 2767           "and 'g
+00053ad0: 6574 2720 6163 7469 6f6e 7320 7072 6573  et' actions pres
+00053ae0: 656e 7420 696e 2074 6865 2061 7267 756d  ent in the argum
+00053af0: 656e 7473 2c20 7468 656e 2074 6865 2027  ents, then the '
+00053b00: 7365 7427 2022 0a20 2020 2020 2020 2020  set' ".         
+00053b10: 2020 2022 6163 7469 6f6e 7320 7769 6c6c     "actions will
+00053b20: 2062 6520 7065 7266 6f72 6d65 6420 6265   be performed be
+00053b30: 666f 7265 2074 6865 2027 6765 7427 2061  fore the 'get' a
+00053b40: 6374 696f 6e73 2e20 5468 656e 2022 0a20  ctions. Then ". 
+00053b50: 2020 2020 2020 2020 2020 2022 7365 6e64             "send
+00053b60: 2061 6374 696f 6e73 2061 6e64 2061 7420   actions and at 
+00053b70: 7468 6520 7665 7279 2065 6e64 206c 6973  the very end lis
+00053b80: 7465 6e20 6163 7469 6f6e 7320 7769 6c6c  ten actions will
+00053b90: 2062 6520 220a 2020 2020 2020 2020 2020   be ".          
+00053ba0: 2020 2270 6572 666f 726d 6564 2e20 e294    "performed. ..
+00053bb0: 80e2 9480 e294 8020 220a 2020 2020 2020  ....... ".      
+00053bc0: 2020 2020 2020 2246 6f72 2065 7665 6e20        "For even 
+00053bd0: 6d6f 7265 2065 7870 6c69 6361 7469 6f6e  more explication
+00053be0: 7320 616e 6420 6578 616d 706c 6573 2061  s and examples a
+00053bf0: 6c73 6f20 7265 6164 2074 6865 2022 0a20  lso read the ". 
+00053c00: 2020 2020 2020 2020 2020 2022 646f 6375             "docu
+00053c10: 6d65 6e74 6174 696f 6e20 7072 6f76 6964  mentation provid
+00053c20: 6564 2069 6e20 7468 6520 6f6e 2d6c 696e  ed in the on-lin
+00053c30: 6520 4769 7468 7562 2052 4541 444d 452e  e Github README.
+00053c40: 6d64 2066 696c 6520 220a 2020 2020 2020  md file ".      
+00053c50: 2020 2020 2020 226f 7220 7468 6520 5245        "or the RE
+00053c60: 4144 4d45 2e6d 6420 696e 2079 6f75 7220  ADME.md in your 
+00053c70: 6c6f 6361 6c20 696e 7374 616c 6c61 7469  local installati
+00053c80: 6f6e 2e20 20e2 9480 e294 80e2 9480 2022  on.  ......... "
+00053c90: 0a20 2020 2020 2020 2020 2020 2022 466f  .            "Fo
+00053ca0: 7220 6c65 7373 2069 6e66 6f72 6d61 7469  r less informati
+00053cb0: 6f6e 206a 7573 7420 7573 6520 2d2d 6865  on just use --he
+00053cc0: 6c70 2069 6e73 7465 6164 206f 6620 2d2d  lp instead of --
+00053cd0: 6d61 6e75 616c 2e22 0a20 2020 2020 2020  manual.".       
+00053ce0: 2029 0a20 2020 2020 2020 2070 7269 6e74   ).        print
+00053cf0: 2874 6578 7477 7261 702e 6669 6c6c 2864  (textwrap.fill(d
+00053d00: 6573 6372 6970 7469 6f6e 2c20 7769 6474  escription, widt
+00053d10: 683d 7465 726d 5f77 6964 7468 292c 2066  h=term_width), f
+00053d20: 6c75 7368 3d54 7275 6529 0a20 2020 2020  lush=True).     
+00053d30: 2020 2070 7269 6e74 2822 2229 0a20 2020     print("").   
+00053d40: 2020 2020 2061 702e 7072 696e 745f 6865       ap.print_he
+00053d50: 6c70 2866 696c 653d 4e6f 6e65 2920 2023  lp(file=None)  #
+00053d60: 2061 702e 7072 696e 745f 7573 6167 6528   ap.print_usage(
+00053d70: 2920 6973 2069 6e63 6c75 6465 640a 2020  ) is included.  
+00053d80: 2020 2020 2020 7265 7475 726e 2030 0a20        return 0. 
+00053d90: 2020 2069 6620 6773 2e70 612e 7265 6164     if gs.pa.read
+00053da0: 6d65 3a0a 2020 2020 2020 2020 2320 546f  me:.        # To
+00053db0: 646f 0a20 2020 2020 2020 2065 7865 6469  do.        exedi
+00053dc0: 7220 3d20 6f73 2e70 6174 682e 6469 726e  r = os.path.dirn
+00053dd0: 616d 6528 6f73 2e70 6174 682e 7265 616c  ame(os.path.real
+00053de0: 7061 7468 285f 5f66 696c 655f 5f29 290a  path(__file__)).
+00053df0: 2020 2020 2020 2020 7265 6164 6d65 203d          readme =
+00053e00: 2065 7865 6469 7220 2b20 222f 2e2e 2f22   exedir + "/../"
+00053e10: 202b 2022 5245 4144 4d45 2e6d 6422 0a20   + "README.md". 
+00053e20: 2020 2020 2020 2072 6561 646d 655f 7072         readme_pr
+00053e30: 696d 6172 7920 3d20 7265 6164 6d65 0a20  imary = readme. 
+00053e40: 2020 2020 2020 2066 6f75 6e64 7061 7468         foundpath
+00053e50: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+00053e60: 6966 206f 732e 7061 7468 2e65 7869 7374  if os.path.exist
+00053e70: 7328 7265 6164 6d65 293a 0a20 2020 2020  s(readme):.     
+00053e80: 2020 2020 2020 2066 6f75 6e64 7061 7468         foundpath
+00053e90: 203d 2072 6561 646d 650a 2020 2020 2020   = readme.      
+00053ea0: 2020 2020 2020 7072 696e 7428 6622 466f        print(f"Fo
+00053eb0: 756e 6420 6c6f 6361 6c20 5245 4144 4d45  und local README
+00053ec0: 2e6d 6420 6865 7265 3a20 7b72 6561 646d  .md here: {readm
+00053ed0: 657d 2229 0a20 2020 2020 2020 2065 6c73  e}").        els
+00053ee0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00053ef0: 6561 646d 6520 3d20 6578 6564 6972 202b  eadme = exedir +
+00053f00: 2022 2f22 202b 2022 5245 4144 4d45 2e6d   "/" + "README.m
+00053f10: 6422 0a20 2020 2020 2020 2020 2020 2069  d".            i
+00053f20: 6620 6f73 2e70 6174 682e 6578 6973 7473  f os.path.exists
+00053f30: 2872 6561 646d 6529 3a0a 2020 2020 2020  (readme):.      
+00053f40: 2020 2020 2020 2020 2020 666f 756e 6470            foundp
+00053f50: 6174 6820 3d20 7265 6164 6d65 0a20 2020  ath = readme.   
+00053f60: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00053f70: 6e74 2866 2246 6f75 6e64 206c 6f63 616c  nt(f"Found local
+00053f80: 2052 4541 444d 452e 6d64 2068 6572 653a   README.md here:
+00053f90: 207b 7265 6164 6d65 7d22 290a 2020 2020   {readme}").    
+00053fa0: 2020 2020 6966 2066 6f75 6e64 7061 7468      if foundpath
+00053fb0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00053fc0: 2020 2020 2020 7072 696e 7428 0a20 2020        print(.   
+00053fd0: 2020 2020 2020 2020 2020 2020 2022 536f               "So
+00053fe0: 7272 792c 2052 4541 444d 452e 6d64 206e  rry, README.md n
+00053ff0: 6f74 2066 6f75 6e64 206c 6f63 616c 6c79  ot found locally
+00054000: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00054010: 2020 2066 2269 6e20 696e 7374 616c 6c61     f"in installa
+00054020: 7469 6f6e 2064 6972 6563 746f 7279 207b  tion directory {
+00054030: 7265 6164 6d65 5f70 7269 6d61 7279 7d2e  readme_primary}.
+00054040: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+00054050: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00054060: 7428 6622 4865 6e63 6520 646f 776e 6c6f  t(f"Hence downlo
+00054070: 6164 696e 6720 6974 2066 726f 6d20 7b52  ading it from {R
+00054080: 4541 444d 455f 4649 4c45 5f52 4157 5f55  EADME_FILE_RAW_U
+00054090: 524c 7d2e 2229 0a20 2020 2020 2020 2020  RL}.").         
+000540a0: 2020 206e 6f74 7573 6564 2c20 666f 756e     notused, foun
+000540b0: 6470 6174 6820 3d20 7465 6d70 6669 6c65  dpath = tempfile
+000540c0: 2e6d 6b73 7465 6d70 2829 0a20 2020 2020  .mkstemp().     
+000540d0: 2020 2020 2020 2075 726c 6c69 622e 7265         urllib.re
+000540e0: 7175 6573 742e 7572 6c72 6574 7269 6576  quest.urlretriev
+000540f0: 6528 5245 4144 4d45 5f46 494c 455f 5241  e(README_FILE_RA
+00054100: 575f 5552 4c2c 2066 6f75 6e64 7061 7468  W_URL, foundpath
+00054110: 290a 2020 2020 2020 2020 7472 793a 0a20  ).        try:. 
+00054120: 2020 2020 2020 2020 2020 2077 6974 6820             with 
+00054130: 6f70 656e 2866 6f75 6e64 7061 7468 2c20  open(foundpath, 
+00054140: 2272 2b22 2920 6173 2066 3a0a 2020 2020  "r+") as f:.    
+00054150: 2020 2020 2020 2020 2020 2020 7465 7874              text
+00054160: 203d 2066 2e72 6561 6428 290a 2020 2020   = f.read().    
+00054170: 2020 2020 2020 2020 7072 696e 7428 6622          print(f"
+00054180: 7b74 6578 747d 2229 0a20 2020 2020 2020  {text}").       
+00054190: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+000541a0: 6e3a 2020 2320 2842 726f 6b65 6e50 6970  n:  # (BrokenPip
+000541b0: 6545 7272 6f72 2c20 494f 4572 726f 7229  eError, IOError)
+000541c0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+000541d0: 7072 696e 7428 2242 726f 6b65 6e50 6970  print("BrokenPip
+000541e0: 6545 7272 6f72 2063 6175 6768 7422 2c20  eError caught", 
+000541f0: 6669 6c65 3d73 7973 2e73 7464 6572 7229  file=sys.stderr)
+00054200: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
+00054210: 730a 2020 2020 2020 2020 7265 7475 726e  s.        return
+00054220: 2030 0a0a 2020 2020 6c6f 6767 696e 672e   0..    logging.
+00054230: 6261 7369 6343 6f6e 6669 6728 2020 2320  basicConfig(  # 
+00054240: 696e 6974 6961 6c69 7a65 2072 6f6f 7420  initialize root 
+00054250: 6c6f 6767 6572 2c20 6120 6d75 7374 0a20  logger, a must. 
+00054260: 2020 2020 2020 2066 6f72 6d61 743d 227b         format="{
+00054270: 6173 6374 696d 657d 3a20 7b6c 6576 656c  asctime}: {level
+00054280: 6e61 6d65 3a3e 387d 3a20 7b6e 616d 653a  name:>8}: {name:
+00054290: 3e31 367d 3a20 7b6d 6573 7361 6765 7d22  >16}: {message}"
+000542a0: 2c20 7374 796c 653d 227b 220a 2020 2020  , style="{".    
+000542b0: 290a 2020 2020 2320 7365 7420 6c6f 6720  ).    # set log 
+000542c0: 6c65 7665 6c20 6f6e 2072 6f6f 740a 2020  level on root.  
+000542d0: 2020 6966 2022 4445 4255 4722 2069 6e20    if "DEBUG" in 
+000542e0: 6f73 2e65 6e76 6972 6f6e 3a0a 2020 2020  os.environ:.    
+000542f0: 2020 2020 6c6f 6767 696e 672e 6765 744c      logging.getL
+00054300: 6f67 6765 7228 292e 7365 744c 6576 656c  ogger().setLevel
+00054310: 286c 6f67 6769 6e67 2e44 4542 5547 290a  (logging.DEBUG).
+00054320: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00054330: 2020 6c6f 6767 696e 672e 6765 744c 6f67    logging.getLog
+00054340: 6765 7228 292e 7365 744c 6576 656c 286c  ger().setLevel(l
+00054350: 6f67 6769 6e67 2e49 4e46 4f29 0a0a 2020  ogging.INFO)..  
+00054360: 2020 6773 2e6c 6f67 203d 206c 6f67 6769    gs.log = loggi
+00054370: 6e67 2e67 6574 4c6f 6767 6572 2850 524f  ng.getLogger(PRO
+00054380: 475f 5749 5448 4f55 545f 4558 5429 0a0a  G_WITHOUT_EXT)..
+00054390: 2020 2020 6966 2067 732e 7061 2e6c 6f67      if gs.pa.log
+000543a0: 5f6c 6576 656c 3a0a 2020 2020 2020 2020  _level:.        
+000543b0: 696e 6974 6961 6c5f 6368 6563 6b5f 6f66  initial_check_of
+000543c0: 5f6c 6f67 5f61 7267 7328 290a 2020 2020  _log_args().    
+000543d0: 2020 2020 6966 206c 656e 2867 732e 7061      if len(gs.pa
+000543e0: 2e6c 6f67 5f6c 6576 656c 2920 3e20 303a  .log_level) > 0:
+000543f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00054400: 6c65 6e28 6773 2e70 612e 6c6f 675f 6c65  len(gs.pa.log_le
+00054410: 7665 6c29 203e 2031 3a0a 2020 2020 2020  vel) > 1:.      
+00054420: 2020 2020 2020 2020 2020 2320 7365 7420            # set 
+00054430: 6c6f 6720 6c65 7665 6c20 666f 7220 4556  log level for EV
+00054440: 4552 5954 4849 4e47 0a20 2020 2020 2020  ERYTHING.       
+00054450: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
+00054460: 2e67 6574 4c6f 6767 6572 2829 2e73 6574  .getLogger().set
+00054470: 4c65 7665 6c28 6773 2e70 612e 6c6f 675f  Level(gs.pa.log_
+00054480: 6c65 7665 6c5b 315d 290a 2020 2020 2020  level[1]).      
+00054490: 2020 2020 2020 2320 7365 7420 6c6f 6720        # set log 
+000544a0: 6c65 7665 6c20 666f 7220 6d61 7472 6978  level for matrix
+000544b0: 2d63 6f6d 6d61 6e64 6572 0a20 2020 2020  -commander.     
+000544c0: 2020 2020 2020 2067 732e 6c6f 672e 7365         gs.log.se
+000544d0: 744c 6576 656c 2867 732e 7061 2e6c 6f67  tLevel(gs.pa.log
+000544e0: 5f6c 6576 656c 5b30 5d29 0a20 2020 2020  _level[0]).     
+000544f0: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+00054500: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
+00054510: 2020 2020 2066 224c 6f67 206c 6576 656c       f"Log level
+00054520: 2069 7320 7365 7420 666f 7220 6d6f 6475   is set for modu
+00054530: 6c65 207b 5052 4f47 5f57 4954 484f 5554  le {PROG_WITHOUT
+00054540: 5f45 5854 7d2e 2022 0a20 2020 2020 2020  _EXT}. ".       
+00054550: 2020 2020 2020 2020 2066 226c 6f67 5f6c           f"log_l
+00054560: 6576 656c 3d7b 6773 2e70 612e 6c6f 675f  evel={gs.pa.log_
+00054570: 6c65 7665 6c5b 305d 7d22 0a20 2020 2020  level[0]}".     
+00054580: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00054590: 2020 2020 2069 6620 6c65 6e28 6773 2e70       if len(gs.p
+000545a0: 612e 6c6f 675f 6c65 7665 6c29 203e 2031  a.log_level) > 1
+000545b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000545c0: 2020 2320 6f6e 6c79 206e 6f77 2074 6861    # only now tha
+000545d0: 7420 6c6f 6361 6c20 6c6f 6720 6c65 7665  t local log leve
+000545e0: 6c20 6973 2073 6574 2c20 7765 2063 616e  l is set, we can
+000545f0: 206c 6f67 2070 7265 762e 2069 6e66 6f0a   log prev. info.
+00054600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054610: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
+00054620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054630: 2020 6622 4c6f 6720 6c65 7665 6c20 6973    f"Log level is
+00054640: 2073 6574 2066 6f72 206d 6f64 756c 6573   set for modules
+00054650: 2062 656c 6f77 207b 5052 4f47 5f57 4954   below {PROG_WIT
+00054660: 484f 5554 5f45 5854 7d2e 2022 0a20 2020  HOUT_EXT}. ".   
+00054670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054680: 2066 226c 6f67 5f6c 6576 656c 3d7b 6773   f"log_level={gs
+00054690: 2e70 612e 6c6f 675f 6c65 7665 6c5b 315d  .pa.log_level[1]
+000546a0: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
+000546b0: 2020 2029 0a20 2020 2069 6620 6773 2e70     ).    if gs.p
+000546c0: 612e 6465 6275 6720 3e20 303a 0a20 2020  a.debug > 0:.   
+000546d0: 2020 2020 2069 6620 6773 2e70 612e 6465       if gs.pa.de
+000546e0: 6275 6720 3e20 313a 0a20 2020 2020 2020  bug > 1:.       
+000546f0: 2020 2020 2023 2074 7572 6e20 6f6e 2064       # turn on d
+00054700: 6562 7567 206c 6f67 6769 6e67 2066 6f72  ebug logging for
+00054710: 2045 5645 5259 5448 494e 470a 2020 2020   EVERYTHING.    
+00054720: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00054730: 6765 744c 6f67 6765 7228 292e 7365 744c  getLogger().setL
+00054740: 6576 656c 286c 6f67 6769 6e67 2e44 4542  evel(logging.DEB
+00054750: 5547 290a 2020 2020 2020 2020 2320 7475  UG).        # tu
+00054760: 726e 206f 6e20 6465 6275 6720 6c6f 6767  rn on debug logg
+00054770: 696e 6720 666f 7220 6d61 7472 6978 2d63  ing for matrix-c
+00054780: 6f6d 6d61 6e64 6572 0a20 2020 2020 2020  ommander.       
+00054790: 2067 732e 6c6f 672e 7365 744c 6576 656c   gs.log.setLevel
+000547a0: 286c 6f67 6769 6e67 2e44 4542 5547 290a  (logging.DEBUG).
+000547b0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+000547c0: 6562 7567 2866 2244 6562 7567 2069 7320  ebug(f"Debug is 
+000547d0: 7475 726e 6564 206f 6e2e 2064 6562 7567  turned on. debug
+000547e0: 2063 6f75 6e74 3d7b 6773 2e70 612e 6465   count={gs.pa.de
+000547f0: 6275 677d 2229 0a20 2020 2020 2020 2069  bug}").        i
+00054800: 6620 6773 2e70 612e 6c6f 675f 6c65 7665  f gs.pa.log_leve
+00054810: 6c20 616e 6420 6c65 6e28 6773 2e70 612e  l and len(gs.pa.
+00054820: 6c6f 675f 6c65 7665 6c29 203e 2030 3a0a  log_level) > 0:.
+00054830: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+00054840: 6f67 2e77 6172 6e69 6e67 280a 2020 2020  og.warning(.    
+00054850: 2020 2020 2020 2020 2020 2020 2257 3131              "W11
+00054860: 313a 2022 2022 4465 6275 6720 6f70 7469  1: " "Debug opti
+00054870: 6f6e 202d 6420 6f76 6572 7772 6f74 6520  on -d overwrote 
+00054880: 6f70 7469 6f6e 202d 2d6c 6f67 2d6c 6576  option --log-lev
+00054890: 656c 2e22 0a20 2020 2020 2020 2020 2020  el.".           
+000548a0: 2029 0a20 2020 2020 2020 2020 2020 2067   ).            g
+000548b0: 732e 7761 726e 5f63 6f75 6e74 202b 3d20  s.warn_count += 
+000548c0: 310a 0a20 2020 2053 4550 203d 2062 7974  1..    SEP = byt
+000548d0: 6573 2867 732e 7061 2e73 6570 6172 6174  es(gs.pa.separat
+000548e0: 6f72 2c20 2275 7466 2d38 2229 2e64 6563  or, "utf-8").dec
+000548f0: 6f64 6528 2275 6e69 636f 6465 5f65 7363  ode("unicode_esc
+00054900: 6170 6522 290a 2020 2020 6773 2e6c 6f67  ape").    gs.log
+00054910: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+00054920: 6627 5365 7061 7261 746f 7220 6973 2073  f'Separator is s
+00054930: 6574 2074 6f20 227b 5345 507d 2220 6f66  et to "{SEP}" of
+00054940: 2027 0a20 2020 2020 2020 2066 226c 656e   '.        f"len
+00054950: 6774 6820 7b6c 656e 2853 4550 297d 2e20  gth {len(SEP)}. 
+00054960: 452e 672e 2043 6f6c 317b 5345 507d 436f  E.g. Col1{SEP}Co
+00054970: 6c32 2e22 0a20 2020 2029 0a20 2020 2069  l2.".    ).    i
+00054980: 6e69 7469 616c 5f63 6865 636b 5f6f 665f  nitial_check_of_
+00054990: 6172 6773 2829 0a20 2020 2063 6865 636b  args().    check
+000549a0: 5f64 6f77 6e6c 6f61 645f 6d65 6469 615f  _download_media_
+000549b0: 6469 7228 290a 2020 2020 7472 793a 0a20  dir().    try:. 
+000549c0: 2020 2020 2020 2063 6865 636b 5f61 7267         check_arg
+000549d0: 5f66 696c 6573 5f72 6561 6461 626c 6528  _files_readable(
+000549e0: 290a 2020 2020 6578 6365 7074 2045 7863  ).    except Exc
+000549f0: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
+00054a00: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
+00054a10: 7228 6529 2020 2320 616c 7265 6164 7920  r(e)  # already 
+00054a20: 6861 7320 4578 7878 3a20 756e 6971 7565  has Exxx: unique
+00054a30: 2065 7272 6f72 206e 756d 6265 720a 2020   error number.  
+00054a40: 2020 2020 2020 7261 6973 6520 4d61 7472        raise Matr
+00054a50: 6978 436f 6d6d 616e 6465 7245 7272 6f72  ixCommanderError
+00054a60: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
+00054a70: 7b50 524f 475f 5749 5448 4f55 545f 4558  {PROG_WITHOUT_EX
+00054a80: 547d 2066 6f72 6365 7320 616e 2065 6172  T} forces an ear
+00054a90: 6c79 2061 626f 7274 2e20 220a 2020 2020  ly abort. ".    
+00054aa0: 2020 2020 2020 2020 2254 6f20 6176 6f69          "To avoi
+00054ab0: 6420 7061 7274 6961 6c20 6578 6563 7574  d partial execut
+00054ac0: 696f 6e2c 206e 6f20 6163 7469 6f6e 2068  ion, no action h
+00054ad0: 6173 2062 6565 6e20 7065 7266 6f72 6d65  as been performe
+00054ae0: 6420 6174 2061 6c6c 2e20 220a 2020 2020  d at all. ".    
+00054af0: 2020 2020 2020 2020 224e 6f74 6869 6e67          "Nothing
+00054b00: 2068 6173 2062 6565 6e20 7365 6e74 2e20   has been sent. 
+00054b10: 4669 7820 796f 7572 2061 7267 756d 656e  Fix your argumen
+00054b20: 7473 2061 6e64 2072 756e 2074 6865 2063  ts and run the c
+00054b30: 6f6d 6d61 6e64 2022 0a20 2020 2020 2020  ommand ".       
+00054b40: 2020 2020 2022 6167 6169 6e2e 220a 2020       "again.".  
+00054b50: 2020 2020 2020 2920 6672 6f6d 204e 6f6e        ) from Non
+00054b60: 650a 0a20 2020 2069 6620 6773 2e70 612e  e..    if gs.pa.
+00054b70: 7665 7273 696f 6e3a 0a20 2020 2020 2020  version:.       
+00054b80: 2069 6620 6773 2e70 612e 7665 7273 696f   if gs.pa.versio
+00054b90: 6e2e 6c6f 7765 7228 2920 3d3d 2050 5249  n.lower() == PRI
+00054ba0: 4e54 3a0a 2020 2020 2020 2020 2020 2020  NT:.            
+00054bb0: 7665 7273 696f 6e28 2920 2023 2063 6f6e  version()  # con
+00054bc0: 7469 6e75 6520 6578 6563 7574 696f 6e0a  tinue execution.
+00054bd0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00054be0: 2020 2020 2020 2020 2020 6368 6563 6b5f            check_
+00054bf0: 7665 7273 696f 6e28 2920 2023 2063 6f6e  version()  # con
+00054c00: 7469 6e75 6520 6578 6563 7574 696f 6e0a  tinue execution.
+00054c10: 2020 2020 2020 2020 6966 206e 6f74 2028          if not (
+00054c20: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+00054c30: 7365 6e64 5f61 6374 696f 6e0a 2020 2020  send_action.    
+00054c40: 2020 2020 2020 2020 6f72 2067 732e 726f          or gs.ro
+00054c50: 6f6d 5f61 6374 696f 6e0a 2020 2020 2020  om_action.      
+00054c60: 2020 2020 2020 6f72 2067 732e 7061 2e6c        or gs.pa.l
+00054c70: 6973 7465 6e20 213d 204c 4953 5445 4e5f  isten != LISTEN_
+00054c80: 4445 4641 554c 540a 2020 2020 2020 2020  DEFAULT.        
+00054c90: 2020 2020 6f72 2067 732e 7061 2e74 6169      or gs.pa.tai
+00054ca0: 6c20 213d 2054 4149 4c5f 554e 5553 4544  l != TAIL_UNUSED
+00054cb0: 5f44 4546 4155 4c54 0a20 2020 2020 2020  _DEFAULT.       
+00054cc0: 2020 2020 206f 7220 6773 2e70 612e 7665       or gs.pa.ve
+00054cd0: 7269 6679 0a20 2020 2020 2020 2020 2020  rify.           
+00054ce0: 206f 7220 6773 2e73 6574 6765 745f 6163   or gs.setget_ac
+00054cf0: 7469 6f6e 0a20 2020 2020 2020 2029 3a0a  tion.        ):.
+00054d00: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+00054d10: 6f67 2e64 6562 7567 2822 4f6e 6c79 202d  og.debug("Only -
+00054d20: 2d76 6572 7369 6f6e 2e20 5072 696e 7420  -version. Print 
+00054d30: 616e 6420 7175 6974 2e22 290a 2020 2020  and quit.").    
+00054d40: 2020 2020 2020 2020 7265 7475 726e 2020          return  
+00054d50: 2320 6a75 7374 2076 6572 7369 6f6e 2c20  # just version, 
+00054d60: 7175 6974 0a0a 2020 2020 6372 6561 7465  quit..    create
+00054d70: 5f70 6964 5f66 696c 6528 290a 0a20 2020  _pid_file()..   
+00054d80: 2067 732e 6c6f 672e 6465 6275 6728 6627   gs.log.debug(f'
+00054d90: 5079 7468 6f6e 2076 6572 7369 6f6e 2069  Python version i
+00054da0: 7320 227b 7379 732e 7665 7273 696f 6e7d  s "{sys.version}
+00054db0: 2227 290a 2020 2020 6773 2e6c 6f67 2e64  "').    gs.log.d
+00054dc0: 6562 7567 2866 2753 7464 696e 2070 6970  ebug(f'Stdin pip
+00054dd0: 6520 6973 2061 7373 6967 6e65 6420 746f  e is assigned to
+00054de0: 2022 7b67 732e 7374 6469 6e5f 7573 657d   "{gs.stdin_use}
+00054df0: 222e 2729 0a20 2020 2069 6620 6773 2e70  ".').    if gs.p
+00054e00: 612e 7373 6c5f 6365 7274 6966 6963 6174  a.ssl_certificat
+00054e10: 6520 213d 2053 534c 5f43 4552 5449 4649  e != SSL_CERTIFI
+00054e20: 4341 5445 5f44 4546 4155 4c54 3a0a 2020  CATE_DEFAULT:.  
+00054e30: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+00054e40: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+00054e50: 2253 534c 2077 696c 6c20 6265 2075 7365  "SSL will be use
+00054e60: 642e 2041 2063 7573 746f 6d20 5353 4c20  d. A custom SSL 
+00054e70: 6365 7274 6966 6963 6174 6520 7761 7320  certificate was 
+00054e80: 7072 6f76 6964 6564 2e20 220a 2020 2020  provided. ".    
+00054e90: 2020 2020 2020 2020 6627 4375 7374 6f6d          f'Custom
+00054ea0: 2063 6572 7469 6669 6361 7465 2066 726f   certificate fro
+00054eb0: 6d20 6669 6c65 2022 7b67 732e 7061 2e73  m file "{gs.pa.s
+00054ec0: 736c 5f63 6572 7469 6669 6361 7465 7d22  sl_certificate}"
+00054ed0: 2077 696c 6c20 270a 2020 2020 2020 2020   will '.        
+00054ee0: 2020 2020 2262 6520 7573 6564 2066 6f72      "be used for
+00054ef0: 2074 6869 7320 636f 6e6e 6563 7469 6f6e   this connection
+00054f00: 2e22 0a20 2020 2020 2020 2029 0a20 2020  .".        ).   
+00054f10: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00054f20: 2020 2020 2020 2320 7479 7065 2053 534c        # type SSL
+00054f30: 436f 6e74 6578 740a 2020 2020 2020 2020  Context.        
+00054f40: 2020 2020 6773 2e73 736c 203d 2073 736c      gs.ssl = ssl
+00054f50: 2e63 7265 6174 655f 6465 6661 756c 745f  .create_default_
+00054f60: 636f 6e74 6578 7428 6361 6669 6c65 3d67  context(cafile=g
+00054f70: 732e 7061 2e73 736c 5f63 6572 7469 6669  s.pa.ssl_certifi
+00054f80: 6361 7465 290a 2020 2020 2020 2020 6578  cate).        ex
+00054f90: 6365 7074 2046 696c 654e 6f74 466f 756e  cept FileNotFoun
+00054fa0: 6445 7272 6f72 3a0a 2020 2020 2020 2020  dError:.        
+00054fb0: 2020 2020 6773 2e65 7272 5f63 6f75 6e74      gs.err_count
+00054fc0: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
+00054fd0: 2020 7261 6973 6520 4d61 7472 6978 436f    raise MatrixCo
+00054fe0: 6d6d 616e 6465 7245 7272 6f72 280a 2020  mmanderError(.  
+00054ff0: 2020 2020 2020 2020 2020 2020 2020 2245                "E
+00055000: 3234 333a 2022 0a20 2020 2020 2020 2020  243: ".         
+00055010: 2020 2020 2020 2066 2753 534c 2063 6572         f'SSL cer
+00055020: 7469 6669 6361 7465 2066 696c 6520 227b  tificate file "{
+00055030: 6773 2e70 612e 7373 6c5f 6365 7274 6966  gs.pa.ssl_certif
+00055040: 6963 6174 657d 2220 7761 7320 270a 2020  icate}" was '.  
+00055050: 2020 2020 2020 2020 2020 2020 2020 226e                "n
+00055060: 6f74 2066 6f75 6e64 2e22 0a20 2020 2020  ot found.".     
+00055070: 2020 2020 2020 2029 2066 726f 6d20 4e6f         ) from No
+00055080: 6e65 0a20 2020 2020 2020 2065 7863 6570  ne.        excep
+00055090: 7420 5065 726d 6973 7369 6f6e 4572 726f  t PermissionErro
+000550a0: 723a 0a20 2020 2020 2020 2020 2020 2067  r:.            g
+000550b0: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
+000550c0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+000550d0: 7365 204d 6174 7269 7843 6f6d 6d61 6e64  se MatrixCommand
+000550e0: 6572 4572 726f 7228 0a20 2020 2020 2020  erError(.       
+000550f0: 2020 2020 2020 2020 2022 4532 3434 3a20           "E244: 
+00055100: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00055110: 2020 6627 5353 4c20 6365 7274 6966 6963    f'SSL certific
+00055120: 6174 6520 6669 6c65 2022 7b67 732e 7061  ate file "{gs.pa
+00055130: 2e73 736c 5f63 6572 7469 6669 6361 7465  .ssl_certificate
+00055140: 7d22 2064 6f65 7320 270a 2020 2020 2020  }" does '.      
+00055150: 2020 2020 2020 2020 2020 226e 6f74 2068            "not h
+00055160: 6176 6520 7265 6164 2070 6572 6d69 7373  ave read permiss
+00055170: 696f 6e73 2e22 0a20 2020 2020 2020 2020  ions.".         
+00055180: 2020 2029 2066 726f 6d20 4e6f 6e65 0a20     ) from None. 
+00055190: 2020 2020 2020 2065 7863 6570 7420 7373         except ss
+000551a0: 6c2e 5353 4c45 7272 6f72 3a0a 2020 2020  l.SSLError:.    
+000551b0: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
+000551c0: 6f75 6e74 202b 3d20 310a 2020 2020 2020  ount += 1.      
+000551d0: 2020 2020 2020 7261 6973 6520 4d61 7472        raise Matr
+000551e0: 6978 436f 6d6d 616e 6465 7245 7272 6f72  ixCommanderError
+000551f0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00055200: 2020 2245 3234 353a 2022 0a20 2020 2020    "E245: ".     
+00055210: 2020 2020 2020 2020 2020 2066 2753 534c             f'SSL
+00055220: 2063 6572 7469 6669 6361 7465 2066 696c   certificate fil
+00055230: 6520 227b 6773 2e70 612e 7373 6c5f 6365  e "{gs.pa.ssl_ce
+00055240: 7274 6966 6963 6174 657d 2220 6861 7320  rtificate}" has 
+00055250: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00055260: 2020 2269 6e76 616c 6964 2063 6f6e 7465    "invalid conte
+00055270: 6e74 2e20 446f 6573 206e 6f74 2073 6565  nt. Does not see
+00055280: 6d20 746f 2062 6520 6120 6365 7274 6966  m to be a certif
+00055290: 6963 6174 652e 220a 2020 2020 2020 2020  icate.".        
+000552a0: 2020 2020 2920 6672 6f6d 204e 6f6e 650a      ) from None.
+000552b0: 2020 2020 656c 6966 2067 732e 7061 2e6e      elif gs.pa.n
+000552c0: 6f5f 7373 6c3a 0a20 2020 2020 2020 2067  o_ssl:.        g
+000552d0: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
+000552e0: 2020 2020 2020 2020 2022 5353 4c20 7769           "SSL wi
+000552f0: 6c6c 2062 6520 6e6f 7420 6265 2075 7365  ll be not be use
+00055300: 642e 2054 6865 2053 534c 2063 6572 7469  d. The SSL certi
+00055310: 6669 6361 7465 2076 616c 6964 6174 696f  ficate validatio
+00055320: 6e20 220a 2020 2020 2020 2020 2020 2020  n ".            
+00055330: 2277 696c 6c20 6265 2073 6b69 7070 6564  "will be skipped
+00055340: 2066 6f72 2074 6869 7320 636f 6e6e 6563   for this connec
+00055350: 7469 6f6e 2e22 0a20 2020 2020 2020 2029  tion.".        )
+00055360: 0a20 2020 2020 2020 2067 732e 7373 6c20  .        gs.ssl 
+00055370: 3d20 4661 6c73 650a 2020 2020 656c 7365  = False.    else
+00055380: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
+00055390: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+000553a0: 2020 2020 2253 534c 2077 696c 6c20 6265      "SSL will be
+000553b0: 2075 7365 642e 2044 6566 6175 6c74 2053   used. Default S
+000553c0: 534c 2063 6572 7469 6669 6361 7465 2076  SL certificate v
+000553d0: 616c 6964 6174 696f 6e20 220a 2020 2020  alidation ".    
+000553e0: 2020 2020 2020 2020 2277 696c 6c20 6265          "will be
+000553f0: 2064 6f6e 6520 666f 7220 7468 6973 2063   done for this c
+00055400: 6f6e 6e65 6374 696f 6e2e 220a 2020 2020  onnection.".    
+00055410: 2020 2020 290a 2020 2020 2020 2020 6773      ).        gs
+00055420: 2e73 736c 203d 204e 6f6e 650a 0a20 2020  .ssl = None..   
+00055430: 2074 7279 3a0a 2020 2020 2020 2020 6173   try:.        as
+00055440: 796e 6369 6f2e 7275 6e28 6173 796e 635f  yncio.run(async_
+00055450: 6d61 696e 2829 2920 2023 2064 6f20 6576  main())  # do ev
+00055460: 6572 7974 6869 6e67 2069 6e20 7468 6520  erything in the 
+00055470: 6576 656e 7420 6c6f 6f70 0a20 2020 2020  event loop.     
+00055480: 2020 2023 2074 6865 206e 6578 7420 6361     # the next ca
+00055490: 6e20 6265 2072 6561 6368 6564 206f 6e20  n be reached on 
+000554a0: 7375 6363 6573 7320 6f72 2066 6169 6c75  success or failu
+000554b0: 7265 0a20 2020 2020 2020 2067 732e 6c6f  re.        gs.lo
+000554c0: 672e 6465 6275 6728 6622 5468 6520 7072  g.debug(f"The pr
+000554d0: 6f67 7261 6d20 7b50 524f 475f 5749 5448  ogram {PROG_WITH
+000554e0: 5f45 5854 7d20 6c65 6674 2074 6865 2065  _EXT} left the e
+000554f0: 7665 6e74 206c 6f6f 702e 2229 0a20 2020  vent loop.").   
+00055500: 2065 7863 6570 7420 5469 6d65 6f75 7445   except TimeoutE
+00055510: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
+00055520: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
+00055530: 2b3d 2031 0a20 2020 2020 2020 2072 6169  += 1.        rai
+00055540: 7365 204d 6174 7269 7843 6f6d 6d61 6e64  se MatrixCommand
+00055550: 6572 4572 726f 7228 0a20 2020 2020 2020  erError(.       
+00055560: 2020 2020 2022 4532 3437 3a20 220a 2020       "E247: ".  
+00055570: 2020 2020 2020 2020 2020 6622 5468 6520            f"The 
+00055580: 7072 6f67 7261 6d20 7b50 524f 475f 5749  program {PROG_WI
+00055590: 5448 5f45 5854 7d20 7261 6e20 696e 746f  TH_EXT} ran into
+000555a0: 2061 2074 696d 656f 7574 2e20 220a 2020   a timeout. ".  
+000555b0: 2020 2020 2020 2020 2020 224d 6f73 7420            "Most 
+000555c0: 6c69 6b65 6c79 2063 6f6e 6e65 6374 6976  likely connectiv
+000555d0: 6974 7920 746f 2069 6e74 6572 6e65 7420  ity to internet 
+000555e0: 7761 7320 6c6f 7374 2e20 220a 2020 2020  was lost. ".    
+000555f0: 2020 2020 2020 2020 2249 6620 7468 6973          "If this
+00055600: 2068 6170 7065 6e73 2066 7265 7175 656e   happens frequen
+00055610: 746c 7920 636f 6e73 6964 6572 2072 756e  tly consider run
+00055620: 6e69 6e67 2074 6869 7320 220a 2020 2020  ning this ".    
+00055630: 2020 2020 2020 2020 2270 726f 6772 616d          "program
+00055640: 2061 7320 6120 7365 7276 6963 6520 736f   as a service so
+00055650: 2069 7420 7769 6c6c 2072 6573 7461 7274   it will restart
+00055660: 2061 7574 6f6d 6174 6963 616c 6c79 2e20   automatically. 
+00055670: 536f 7272 792e 220a 2020 2020 2020 2020  Sorry.".        
+00055680: 2920 6672 6f6d 2065 0a20 2020 2065 7863  ) from e.    exc
+00055690: 6570 7420 4d61 7472 6978 436f 6d6d 616e  ept MatrixComman
+000556a0: 6465 7245 7272 6f72 3a0a 2020 2020 2020  derError:.      
+000556b0: 2020 7261 6973 650a 2020 2020 6578 6365    raise.    exce
+000556c0: 7074 204b 6579 626f 6172 6449 6e74 6572  pt KeyboardInter
+000556d0: 7275 7074 3a0a 2020 2020 2020 2020 6773  rupt:.        gs
+000556e0: 2e6c 6f67 2e64 6562 7567 2822 4b65 7962  .log.debug("Keyb
+000556f0: 6f61 7264 2069 6e74 6572 7275 7074 2072  oard interrupt r
+00055700: 6563 6569 7665 642e 2229 0a20 2020 2065  eceived.").    e
+00055710: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
+00055720: 0a20 2020 2020 2020 2067 732e 6572 725f  .        gs.err_
+00055730: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
+00055740: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
+00055750: 2245 3234 383a 2022 2066 2254 6865 2070  "E248: " f"The p
+00055760: 726f 6772 616d 207b 5052 4f47 5f57 4954  rogram {PROG_WIT
+00055770: 485f 4558 547d 2066 6169 6c65 642e 2053  H_EXT} failed. S
+00055780: 6f72 7279 2e22 290a 2020 2020 2020 2020  orry.").        
+00055790: 7261 6973 650a 2020 2020 6669 6e61 6c6c  raise.    finall
+000557a0: 793a 0a20 2020 2020 2020 2063 6c65 616e  y:.        clean
+000557b0: 7570 2829 0a0a 0a64 6566 206d 6169 6e28  up()...def main(
+000557c0: 6172 6776 3a20 556e 696f 6e5b 4e6f 6e65  argv: Union[None
+000557d0: 2c20 6c69 7374 5d20 3d20 4e6f 6e65 2920  , list] = None) 
+000557e0: 2d3e 2069 6e74 3a0a 2020 2020 2222 2252  -> int:.    """R
+000557f0: 756e 2074 6865 2070 726f 6772 616d 2e0a  un the program..
+00055800: 0a20 2020 206d 6169 6e28 2920 6973 2061  .    main() is a
+00055810: 6e20 656e 7472 7920 706f 696e 7420 616c  n entry point al
+00055820: 6c6f 7769 6e67 206f 7468 6572 2050 7974  lowing other Pyt
+00055830: 686f 6e20 7072 6f67 7261 6d73 2074 6f0a  hon programs to.
+00055840: 2020 2020 6561 7369 6c79 2063 616c 6c20      easily call 
+00055850: 6d61 7472 6978 2d63 6f6d 6d61 6e64 6572  matrix-commander
+00055860: 2e0a 0a20 2020 2041 7267 756d 656e 7473  ...    Arguments
+00055870: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d0a  :.    ---------.
+00055880: 2020 2020 6172 6776 203a 206c 6973 7420      argv : list 
+00055890: 6f66 2061 7267 756d 656e 7473 2061 7320  of arguments as 
+000558a0: 696e 2073 7973 2e61 7267 763b 2066 6972  in sys.argv; fir
+000558b0: 7374 2065 6c65 6d65 6e74 2069 7320 7468  st element is th
+000558c0: 650a 2020 2020 2020 2020 7072 6f67 7261  e.        progra
+000558d0: 6d20 6e61 6d65 2c20 6675 7274 6865 7220  m name, further 
+000558e0: 656c 656d 656e 7473 2061 7265 2074 6865  elements are the
+000558f0: 2061 7267 756d 656e 7473 3b20 6576 6572   arguments; ever
+00055900: 790a 2020 2020 2020 2020 656c 656d 656e  y.        elemen
+00055910: 7420 6d75 7374 2062 6520 6f66 2074 7970  t must be of typ
+00055920: 6520 2273 7472 222e 0a20 2020 2020 2020  e "str"..       
+00055930: 2061 7267 7620 6973 206f 7074 696f 6e61   argv is optiona
+00055940: 6c20 616e 6420 6361 6e20 6265 204e 6f6e  l and can be Non
+00055950: 652e 0a20 2020 2020 2020 2049 6620 6172  e..        If ar
+00055960: 6776 2069 7320 7365 7420 7468 656e 2074  gv is set then t
+00055970: 6865 7365 2061 7267 756d 656e 7473 2077  hese arguments w
+00055980: 696c 6c20 6265 2075 7365 6420 6173 2061  ill be used as a
+00055990: 7267 756d 656e 7473 2066 6f72 0a20 2020  rguments for.   
+000559a0: 2020 2020 206d 6174 7269 782d 636f 6d6d       matrix-comm
+000559b0: 616e 6465 722e 2049 6620 6172 6776 2069  ander. If argv i
+000559c0: 7320 6e6f 7420 7365 7420 284e 6f6e 6520  s not set (None 
+000559d0: 6f72 2065 6d70 7479 206c 6973 7429 2c20  or empty list), 
+000559e0: 7468 656e 0a20 2020 2020 2020 2073 7973  then.        sys
+000559f0: 2e61 7267 7620 7769 6c6c 2062 6520 7573  .argv will be us
+00055a00: 6564 2061 7320 6172 6775 6d65 6e74 7320  ed as arguments 
+00055a10: 666f 7220 6d61 7472 6978 2d63 6f6d 6d61  for matrix-comma
+00055a20: 6e64 6572 2e0a 0a20 2020 2045 7861 6d70  nder...    Examp
+00055a30: 6c65 2069 6e70 7574 2061 7267 763a 205b  le input argv: [
+00055a40: 226d 6174 7269 782d 636f 6d6d 616e 6465  "matrix-commande
+00055a50: 7222 5d0a 2020 2020 2020 2020 5b22 6d61  r"].        ["ma
+00055a60: 7472 6978 2d63 6f6d 6d61 6e64 6572 2220  trix-commander" 
+00055a70: 222d 2d76 6572 7369 6f6e 225d 0a20 2020  "--version"].   
+00055a80: 2020 2020 205b 226d 6174 7269 782d 636f       ["matrix-co
+00055a90: 6d6d 616e 6465 7222 2022 2d2d 6d65 7373  mmander" "--mess
+00055aa0: 6167 6522 2022 4865 6c6c 6f22 202d 2d69  age" "Hello" --i
+00055ab0: 6d61 6765 2022 7069 632e 6a70 6722 5d0a  mage "pic.jpg"].
+00055ac0: 0a20 2020 2052 6574 7572 6e73 2069 6e74  .    Returns int
+00055ad0: 2e20 3020 666f 7220 7375 6363 6573 732e  . 0 for success.
+00055ae0: 2050 6f73 6974 6976 6520 696e 7465 6765   Positive intege
+00055af0: 7220 666f 7220 6661 696c 7572 652e 0a20  r for failure.. 
+00055b00: 2020 2020 2020 2052 6574 7572 6e73 2074         Returns t
+00055b10: 6865 2074 6f74 616c 206e 756d 6265 7220  he total number 
+00055b20: 6f66 2065 7272 6f72 7320 656e 636f 756e  of errors encoun
+00055b30: 7465 7265 642e 0a0a 2020 2020 5472 6965  tered...    Trie
+00055b40: 7320 746f 2061 766f 6964 2072 6169 7369  s to avoid raisi
+00055b50: 6e67 2065 7863 6570 7469 6f6e 732e 0a0a  ng exceptions...
+00055b60: 2020 2020 2222 220a 2020 2020 7472 793a      """.    try:
+00055b70: 0a20 2020 2020 2020 206d 6169 6e5f 696e  .        main_in
+00055b80: 6e65 7228 6172 6776 290a 2020 2020 6578  ner(argv).    ex
+00055b90: 6365 7074 2028 4578 6365 7074 696f 6e2c  cept (Exception,
+00055ba0: 204d 6174 7269 7843 6f6d 6d61 6e64 6572   MatrixCommander
+00055bb0: 4572 726f 722c 204d 6174 7269 7843 6f6d  Error, MatrixCom
+00055bc0: 6d61 6e64 6572 5761 726e 696e 6729 2061  manderWarning) a
+00055bd0: 7320 653a 0a20 2020 2020 2020 2069 6620  s e:.        if 
+00055be0: 6520 6e6f 7420 696e 2028 4d61 7472 6978  e not in (Matrix
+00055bf0: 436f 6d6d 616e 6465 7245 7272 6f72 2c20  CommanderError, 
+00055c00: 4d61 7472 6978 436f 6d6d 616e 6465 7257  MatrixCommanderW
+00055c10: 6172 6e69 6e67 293a 0a20 2020 2020 2020  arning):.       
+00055c20: 2020 2020 2067 732e 6572 725f 636f 756e       gs.err_coun
+00055c30: 7420 2b3d 2031 0a20 2020 2020 2020 2074  t += 1.        t
+00055c40: 6220 3d20 2222 0a20 2020 2020 2020 2069  b = "".        i
+00055c50: 6620 6773 2e70 612e 6465 6275 6720 3e20  f gs.pa.debug > 
+00055c60: 303a 0a20 2020 2020 2020 2020 2020 2074  0:.            t
+00055c70: 6220 3d20 6622 5c6e 4865 7265 2069 7320  b = f"\nHere is 
+00055c80: 7468 6520 7472 6163 6562 6163 6b2e 5c6e  the traceback.\n
+00055c90: 7b74 7261 6365 6261 636b 2e66 6f72 6d61  {traceback.forma
+00055ca0: 745f 6578 6328 297d 220a 2020 2020 2020  t_exc()}".      
+00055cb0: 2020 6966 2065 203d 3d20 4d61 7472 6978    if e == Matrix
+00055cc0: 436f 6d6d 616e 6465 7257 6172 6e69 6e67  CommanderWarning
+00055cd0: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
+00055ce0: 2e6c 6f67 2e77 6172 6e69 6e67 2866 227b  .log.warning(f"{
+00055cf0: 657d 7b74 627d 2229 0a20 2020 2020 2020  e}{tb}").       
+00055d00: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00055d10: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
+00055d20: 6622 7b65 7d7b 7462 7d22 290a 2020 2020  f"{e}{tb}").    
+00055d30: 6966 2067 732e 6572 725f 636f 756e 7420  if gs.err_count 
+00055d40: 3e20 3020 6f72 2067 732e 7761 726e 5f63  > 0 or gs.warn_c
+00055d50: 6f75 6e74 203e 2030 3a0a 2020 2020 2020  ount > 0:.      
+00055d60: 2020 6773 2e6c 6f67 2e69 6e66 6f28 0a20    gs.log.info(. 
+00055d70: 2020 2020 2020 2020 2020 2066 227b 6773             f"{gs
+00055d80: 2e65 7272 5f63 6f75 6e74 7d20 220a 2020  .err_count} ".  
+00055d90: 2020 2020 2020 2020 2020 6622 6572 726f            f"erro
+00055da0: 727b 2727 2069 6620 6773 2e65 7272 5f63  r{'' if gs.err_c
+00055db0: 6f75 6e74 203d 3d20 3120 656c 7365 2027  ount == 1 else '
+00055dc0: 7327 7d20 616e 6420 220a 2020 2020 2020  s'} and ".      
+00055dd0: 2020 2020 2020 6622 7b67 732e 7761 726e        f"{gs.warn
+00055de0: 5f63 6f75 6e74 7d20 220a 2020 2020 2020  _count} ".      
+00055df0: 2020 2020 2020 6622 7761 726e 696e 677b        f"warning{
+00055e00: 2727 2069 6620 6773 2e77 6172 6e5f 636f  '' if gs.warn_co
+00055e10: 756e 7420 3d3d 2031 2065 6c73 6520 2773  unt == 1 else 's
+00055e20: 277d 206f 6363 7572 7265 642e 220a 2020  '} occurred.".  
+00055e30: 2020 2020 2020 290a 2020 2020 7265 7475        ).    retu
+00055e40: 726e 2067 732e 6572 725f 636f 756e 7420  rn gs.err_count 
+00055e50: 2023 2030 2066 6f72 2073 7563 6365 7373   # 0 for success
+00055e60: 0a0a 0a69 6620 5f5f 6e61 6d65 5f5f 203d  ...if __name__ =
+00055e70: 3d20 225f 5f6d 6169 6e5f 5f22 3a0a 2020  = "__main__":.  
+00055e80: 2020 7379 732e 6578 6974 286d 6169 6e28    sys.exit(main(
+00055e90: 2929 0a23 2045 4f46 0a                   )).# EOF.
```

### Comparing `matrix-commander-6.0.2/matrix_commander.egg-info/PKG-INFO` & `matrix-commander-7.0.0/matrix_commander.egg-info/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: matrix-commander
-Version: 6.0.2
+Version: 7.0.0
 Summary: A simple command-line Matrix client
 Home-page: https://github.com/8go/matrix-commander
 Author: 8go
 Project-URL: Bug Tracker, https://github.com/8go/matrix-commander/issues
 Project-URL: repository, https://github.com/8go/matrix-commander
 Keywords: Matrix,chat,messaging
 Classifier: Programming Language :: Python :: 3.8
@@ -91,15 +91,15 @@
 
 <p>
 <a href="https://matrix.org/docs/projects/client/matrix-commander">
 <img src="https://matrix.org/docs/projects/images/made-for-matrix.png"
 alt="made for Matrix" height="100"></a>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 <a href="https://pypi.org/project/matrix-commander/">
-<img src="https://pypi.org/static/images/logo-large.6bdbb439.svg"
+<img src="https://pypi.org/static/images/logo-large.9f732b5f.svg"
 alt="get it on PyPi" height="100"></a>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 <a href="https://hub.docker.com/r/matrixcommander/matrix-commander">
 <img src="https://www.unixtutorial.org/images/software/docker-hub.png"
 alt="get it on Docker Hub" height="100"></a>
 </p>
 
@@ -235,14 +235,15 @@
 - Supports SSO (Single Sign-On)
 - Sending messages
 - Sending notices
 - Sending formatted messages
 - Sending MarkDown messages
 - Message splitting before sending
 - Sending Code-formatted messages
+- Sending emojis in messages via shorthand
 - Sending to one room
 - Sending to multiple rooms
 - Sending image files (photos, etc.)
 - Sending of media files (music, videos, etc.)
 - Sending of arbitrary files (PDF, xls, doc, txt, etc.)
 - Sending events such as emoji reactions, or replies as threads
 - Using events to edit sent messages
@@ -461,14 +462,16 @@
     - Python 3.8 or higher installed (3.7 will NOT work)
     - libolm-dev must be installed as it is required by matrix-nio
       - libolm-dev on Debian/Ubuntu, libolm-devel on Fedora, libolm on MacOS
     - matrix-nio must be installed, see https://github.com/poljar/matrix-nio
       - pip3 install --user --upgrade matrix-nio[e2e]
     - python3 package markdown must be installed to support MarkDown format
       - pip3 install --user --upgrade markdown
+    - python3 package emoji must be installed to support emojis in text messages
+      - pip3 install --user --upgrade emoji
     - python3 package python_magic must be installed to support image sending
       - pip3 install --user --upgrade python_magic
     - if (and only if) you want OS notification support, then the python3
       package notify2 and dbus-python should be installed
       - pip3 install --user --upgrade dbus-python # optional
       - pip3 install --user --upgrade notify2 # optional
     - python3 package urllib must be installed to support media download
@@ -566,14 +569,17 @@
 $ matrix-commander --message "Hello World!" # sends provided message
 $ echo "Hello World" | matrix-commander # pipe input msg into program
 $ matrix-commander -m msg1 -m msg2 # sends 2 messages
 $ matrix-commander -m msg1 msg2 msg3 # sends 3 messages
 $ df -h | matrix-commander --code # formatting for code/tables
 $ matrix-commander -m "<b>BOLD</b> and <i>ITALIC</i>" --html
 $ matrix-commander -m "- bullet1" --markdown
+$ matrix-commander -m "I :red_heart: you" --emojize
+$ matrix-commander -m "Well done :clapping_hands:" --emojize
+# See https://unicode.org/emoji/charts/full-emoji-list.html for emoji list
 $ # take input from an RSS feed and split large RSS entries into multiple
 $ # Matrix messages wherever the pattern "\n\n\n" is found
 $ rssfeed | matrix-commander --split "\n\n\n"
 $ matrix-commander --credentials usr1room2.json # select credentials file
 $ matrix-commander --store /var/storage/ # select store directory
 $ # Send to a specific room
 $ matrix-commander -m "hi" --room '!YourRoomId:example.com'
@@ -845,15 +851,15 @@
                         [--room-kick ROOM [ROOM ...]] [-u USER [USER ...]]
                         [--user-login USER] [--name ROOM_NAME [ROOM_NAME ...]]
                         [--topic ROOM_TOPIC [ROOM_TOPIC ...]]
                         [--alias ROOM_ALIAS [ROOM_ALIAS ...]]
                         [-m TEXT [TEXT ...]] [-i IMAGE_FILE [IMAGE_FILE ...]]
                         [-a AUDIO_FILE [AUDIO_FILE ...]] [-f FILE [FILE ...]]
                         [-e MATRIX_JSON_OBJECT [MATRIX_JSON_OBJECT ...]] [-w]
-                        [-z] [-k] [-p SEPARATOR] [--config CONFIG_FILE]
+                        [-z] [-k] [-j] [-p SEPARATOR] [--config CONFIG_FILE]
                         [--proxy PROXY] [-n] [--encrypted]
                         [-l [NEVER|ONCE|FOREVER|TAIL|ALL]] [-t [NUMBER]] [-y]
                         [--print-event-id]
                         [--download-media [DOWNLOAD_DIRECTORY]] [--os-notify]
                         [--set-device-name DEVICE_NAME]
                         [--set-display-name DISPLAY_NAME] [--get-display-name]
                         [--set-presence ONLINE|OFFLINE|UNAVAILABLE]
@@ -1293,14 +1299,19 @@
                         language.
   -k, --code            Send message as format "CODE". Details:: If not
                         specified, message will be sent as format "TEXT". If
                         both --html and --code are specified then --code takes
                         priority. This is useful for sending ASCII-art or
                         tabbed output like tables as a fixed-sized font will
                         be used for display.
+  -j, --emojize         Send message after emojizing. Details:: If not
+                        specified, message will be sent as format "TEXT". If
+                        both --code and --emojize are specified then --code
+                        takes priority. This is useful for sending emojis in
+                        shortcode form :collision:.
   -p SEPARATOR, --split SEPARATOR
                         Split message text into multiple Matrix messages.
                         Details:: If set, split the message(s) into multiple
                         messages wherever the string specified with --split
                         occurs. E.g. One pipes a stream of RSS articles into
                         the program and the articles are separated by three
                         newlines. Then with --split set to "\n\n\n" each
@@ -1891,15 +1902,15 @@
                         There is no 'calling home' on every run, only a 'check
                         pypi.org' upon request. Your privacy is protected. The
                         new release is neither downloaded, nor installed. It
                         just informs you. After printing version information
                         the program will continue to run. This is useful for
                         having version number in the log files.
 
-You are running version 6.0.2 2023-04-04. Enjoy, star on Github and contribute
+You are running version 7.0.0 2023-04-12. Enjoy, star on Github and contribute
 by submitting a Pull Request. Also have a look at matrix-commander-tui.
 ```
 
 # Autocompletion
 
 Tab completion is provided for shells (e.g. bash), courtesy of @mizlan).
 
@@ -2003,10 +2014,10 @@
 
 # Final Remarks
 
 - Thanks to all of you who already have contributed! So appreciated!
   - :heart: and :thumbsup: to @fyfe, @berlincount, @ezwen, @Scriptkiddi,
     @pelzvieh, @mizlan, @edwinsage, @jschwartzentruber, @nirgal, @benneti,
     @opk12, @pataquets, @KizzyCode, @murlock1000, @Benjamin-Loison,
-    @barathrm, etc.
+    @barathrm, @jonathandmoore, etc.
 - Enjoy!
 - Give it a :star: star on GitHub! Pull requests are welcome  :heart:
```

### Comparing `matrix-commander-6.0.2/setup.cfg` & `matrix-commander-7.0.0/setup.cfg`

 * *Files 8% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 [metadata]
 name = matrix-commander
-version = 6.0.2
+version = 7.0.0
 author = 8go
 description = A simple command-line Matrix client
 long_description = file: PyPi-Instructions.md, README.md
 long_description_content_type = text/markdown
 keywords = Matrix, chat, messaging
 url = https://github.com/8go/matrix-commander
 project_urls = 
@@ -30,14 +30,15 @@
 python_requires = >=3.8
 install_requires = 
 	aiohttp
 	aiofiles>=0.6.0
 	argparse
 	asyncio
 	datetime
+	emoji
 	markdown
 	matrix-nio[e2e]>=0.14.1
 	notify2
 	Pillow
 	python_magic
 	pyxdg
 	uuid
```

### Comparing `matrix-commander-6.0.2/tests/test-send.py` & `matrix-commander-7.0.0/tests/test-send.py`

 * *Files identical despite different names*

